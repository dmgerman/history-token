macro_line|#include &lt;netinet/in.h&gt;
macro_line|#ifdef __sun__
macro_line|#include &lt;inttypes.h&gt;
macro_line|#else
macro_line|#include &lt;stdint.h&gt;
macro_line|#endif
macro_line|#include &lt;ctype.h&gt;
macro_line|#include &lt;errno.h&gt;
macro_line|#include &lt;string.h&gt;
macro_line|#include &quot;modpost.h&quot;
multiline_comment|/*&n; * Stolen form Cryptographic API.&n; *&n; * MD4 Message Digest Algorithm (RFC1320).&n; *&n; * Implementation derived from Andrew Tridgell and Steve French&squot;s&n; * CIFS MD4 implementation, and the cryptoapi implementation&n; * originally based on the public domain implementation written&n; * by Colin Plumb in 1993.&n; *&n; * Copyright (c) Andrew Tridgell 1997-1998.&n; * Modified by Steve French (sfrench@us.ibm.com) 2002&n; * Copyright (c) Cryptoapi developers.&n; * Copyright (c) 2002 David S. Miller (davem@redhat.com)&n; * Copyright (c) 2002 James Morris &lt;jmorris@intercode.com.au&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; */
DECL|macro|MD4_DIGEST_SIZE
mdefine_line|#define MD4_DIGEST_SIZE&t;&t;16
DECL|macro|MD4_HMAC_BLOCK_SIZE
mdefine_line|#define MD4_HMAC_BLOCK_SIZE&t;64
DECL|macro|MD4_BLOCK_WORDS
mdefine_line|#define MD4_BLOCK_WORDS&t;&t;16
DECL|macro|MD4_HASH_WORDS
mdefine_line|#define MD4_HASH_WORDS&t;&t;4
DECL|struct|md4_ctx
r_struct
id|md4_ctx
(brace
DECL|member|hash
r_uint32
id|hash
(braket
id|MD4_HASH_WORDS
)braket
suffix:semicolon
DECL|member|block
r_uint32
id|block
(braket
id|MD4_BLOCK_WORDS
)braket
suffix:semicolon
DECL|member|byte_count
r_uint64
id|byte_count
suffix:semicolon
)brace
suffix:semicolon
DECL|function|lshift
r_static
r_inline
r_uint32
id|lshift
c_func
(paren
r_uint32
id|x
comma
r_int
r_int
id|s
)paren
(brace
id|x
op_and_assign
l_int|0xFFFFFFFF
suffix:semicolon
r_return
(paren
(paren
id|x
op_lshift
id|s
)paren
op_amp
l_int|0xFFFFFFFF
)paren
op_or
(paren
id|x
op_rshift
(paren
l_int|32
op_minus
id|s
)paren
)paren
suffix:semicolon
)brace
DECL|function|F
r_static
r_inline
r_uint32
id|F
c_func
(paren
r_uint32
id|x
comma
r_uint32
id|y
comma
r_uint32
id|z
)paren
(brace
r_return
(paren
id|x
op_amp
id|y
)paren
op_or
(paren
(paren
op_complement
id|x
)paren
op_amp
id|z
)paren
suffix:semicolon
)brace
DECL|function|G
r_static
r_inline
r_uint32
id|G
c_func
(paren
r_uint32
id|x
comma
r_uint32
id|y
comma
r_uint32
id|z
)paren
(brace
r_return
(paren
id|x
op_amp
id|y
)paren
op_or
(paren
id|x
op_amp
id|z
)paren
op_or
(paren
id|y
op_amp
id|z
)paren
suffix:semicolon
)brace
DECL|function|H
r_static
r_inline
r_uint32
id|H
c_func
(paren
r_uint32
id|x
comma
r_uint32
id|y
comma
r_uint32
id|z
)paren
(brace
r_return
id|x
op_xor
id|y
op_xor
id|z
suffix:semicolon
)brace
DECL|macro|ROUND1
mdefine_line|#define ROUND1(a,b,c,d,k,s) (a = lshift(a + F(b,c,d) + k, s))
DECL|macro|ROUND2
mdefine_line|#define ROUND2(a,b,c,d,k,s) (a = lshift(a + G(b,c,d) + k + (uint32_t)0x5A827999,s))
DECL|macro|ROUND3
mdefine_line|#define ROUND3(a,b,c,d,k,s) (a = lshift(a + H(b,c,d) + k + (uint32_t)0x6ED9EBA1,s))
multiline_comment|/* XXX: this stuff can be optimized */
DECL|function|le32_to_cpu_array
r_static
r_inline
r_void
id|le32_to_cpu_array
c_func
(paren
r_uint32
op_star
id|buf
comma
r_int
r_int
id|words
)paren
(brace
r_while
c_loop
(paren
id|words
op_decrement
)paren
(brace
op_star
id|buf
op_assign
id|ntohl
c_func
(paren
op_star
id|buf
)paren
suffix:semicolon
id|buf
op_increment
suffix:semicolon
)brace
)brace
DECL|function|cpu_to_le32_array
r_static
r_inline
r_void
id|cpu_to_le32_array
c_func
(paren
r_uint32
op_star
id|buf
comma
r_int
r_int
id|words
)paren
(brace
r_while
c_loop
(paren
id|words
op_decrement
)paren
(brace
op_star
id|buf
op_assign
id|htonl
c_func
(paren
op_star
id|buf
)paren
suffix:semicolon
id|buf
op_increment
suffix:semicolon
)brace
)brace
DECL|function|md4_transform
r_static
r_void
id|md4_transform
c_func
(paren
r_uint32
op_star
id|hash
comma
r_uint32
r_const
op_star
id|in
)paren
(brace
r_uint32
id|a
comma
id|b
comma
id|c
comma
id|d
suffix:semicolon
id|a
op_assign
id|hash
(braket
l_int|0
)braket
suffix:semicolon
id|b
op_assign
id|hash
(braket
l_int|1
)braket
suffix:semicolon
id|c
op_assign
id|hash
(braket
l_int|2
)braket
suffix:semicolon
id|d
op_assign
id|hash
(braket
l_int|3
)braket
suffix:semicolon
id|ROUND1
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|0
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|1
)braket
comma
l_int|7
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|2
)braket
comma
l_int|11
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|3
)braket
comma
l_int|19
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|4
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|5
)braket
comma
l_int|7
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|6
)braket
comma
l_int|11
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|7
)braket
comma
l_int|19
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|8
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|9
)braket
comma
l_int|7
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|10
)braket
comma
l_int|11
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|11
)braket
comma
l_int|19
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|12
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|13
)braket
comma
l_int|7
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|14
)braket
comma
l_int|11
)paren
suffix:semicolon
id|ROUND1
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|15
)braket
comma
l_int|19
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|0
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|4
)braket
comma
l_int|5
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|8
)braket
comma
l_int|9
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|12
)braket
comma
l_int|13
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|1
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|5
)braket
comma
l_int|5
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|9
)braket
comma
l_int|9
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|13
)braket
comma
l_int|13
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|2
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|6
)braket
comma
l_int|5
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|10
)braket
comma
l_int|9
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|14
)braket
comma
l_int|13
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|3
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|7
)braket
comma
l_int|5
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|11
)braket
comma
l_int|9
)paren
suffix:semicolon
id|ROUND2
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|15
)braket
comma
l_int|13
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|0
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|8
)braket
comma
l_int|9
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|4
)braket
comma
l_int|11
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|12
)braket
comma
l_int|15
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|2
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|10
)braket
comma
l_int|9
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|6
)braket
comma
l_int|11
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|14
)braket
comma
l_int|15
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|1
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|9
)braket
comma
l_int|9
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|5
)braket
comma
l_int|11
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|13
)braket
comma
l_int|15
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|a
comma
id|b
comma
id|c
comma
id|d
comma
id|in
(braket
l_int|3
)braket
comma
l_int|3
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|d
comma
id|a
comma
id|b
comma
id|c
comma
id|in
(braket
l_int|11
)braket
comma
l_int|9
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|c
comma
id|d
comma
id|a
comma
id|b
comma
id|in
(braket
l_int|7
)braket
comma
l_int|11
)paren
suffix:semicolon
id|ROUND3
c_func
(paren
id|b
comma
id|c
comma
id|d
comma
id|a
comma
id|in
(braket
l_int|15
)braket
comma
l_int|15
)paren
suffix:semicolon
id|hash
(braket
l_int|0
)braket
op_add_assign
id|a
suffix:semicolon
id|hash
(braket
l_int|1
)braket
op_add_assign
id|b
suffix:semicolon
id|hash
(braket
l_int|2
)braket
op_add_assign
id|c
suffix:semicolon
id|hash
(braket
l_int|3
)braket
op_add_assign
id|d
suffix:semicolon
)brace
DECL|function|md4_transform_helper
r_static
r_inline
r_void
id|md4_transform_helper
c_func
(paren
r_struct
id|md4_ctx
op_star
id|ctx
)paren
(brace
id|le32_to_cpu_array
c_func
(paren
id|ctx-&gt;block
comma
r_sizeof
(paren
id|ctx-&gt;block
)paren
op_div
r_sizeof
(paren
r_uint32
)paren
)paren
suffix:semicolon
id|md4_transform
c_func
(paren
id|ctx-&gt;hash
comma
id|ctx-&gt;block
)paren
suffix:semicolon
)brace
DECL|function|md4_init
r_static
r_void
id|md4_init
c_func
(paren
r_struct
id|md4_ctx
op_star
id|mctx
)paren
(brace
id|mctx-&gt;hash
(braket
l_int|0
)braket
op_assign
l_int|0x67452301
suffix:semicolon
id|mctx-&gt;hash
(braket
l_int|1
)braket
op_assign
l_int|0xefcdab89
suffix:semicolon
id|mctx-&gt;hash
(braket
l_int|2
)braket
op_assign
l_int|0x98badcfe
suffix:semicolon
id|mctx-&gt;hash
(braket
l_int|3
)braket
op_assign
l_int|0x10325476
suffix:semicolon
id|mctx-&gt;byte_count
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|md4_update
r_static
r_void
id|md4_update
c_func
(paren
r_struct
id|md4_ctx
op_star
id|mctx
comma
r_const
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|len
)paren
(brace
r_const
r_uint32
id|avail
op_assign
r_sizeof
(paren
id|mctx-&gt;block
)paren
op_minus
(paren
id|mctx-&gt;byte_count
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|mctx-&gt;byte_count
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|avail
OG
id|len
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|mctx-&gt;block
op_plus
(paren
r_sizeof
(paren
id|mctx-&gt;block
)paren
op_minus
id|avail
)paren
comma
id|data
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|mctx-&gt;block
op_plus
(paren
r_sizeof
(paren
id|mctx-&gt;block
)paren
op_minus
id|avail
)paren
comma
id|data
comma
id|avail
)paren
suffix:semicolon
id|md4_transform_helper
c_func
(paren
id|mctx
)paren
suffix:semicolon
id|data
op_add_assign
id|avail
suffix:semicolon
id|len
op_sub_assign
id|avail
suffix:semicolon
r_while
c_loop
(paren
id|len
op_ge
r_sizeof
(paren
id|mctx-&gt;block
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|mctx-&gt;block
comma
id|data
comma
r_sizeof
(paren
id|mctx-&gt;block
)paren
)paren
suffix:semicolon
id|md4_transform_helper
c_func
(paren
id|mctx
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
id|mctx-&gt;block
)paren
suffix:semicolon
id|len
op_sub_assign
r_sizeof
(paren
id|mctx-&gt;block
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|mctx-&gt;block
comma
id|data
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|md4_final_ascii
r_static
r_void
id|md4_final_ascii
c_func
(paren
r_struct
id|md4_ctx
op_star
id|mctx
comma
r_char
op_star
id|out
comma
r_int
r_int
id|len
)paren
(brace
r_const
r_int
r_int
id|offset
op_assign
id|mctx-&gt;byte_count
op_amp
l_int|0x3f
suffix:semicolon
r_char
op_star
id|p
op_assign
(paren
r_char
op_star
)paren
id|mctx-&gt;block
op_plus
id|offset
suffix:semicolon
r_int
id|padding
op_assign
l_int|56
op_minus
(paren
id|offset
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|padding
OL
l_int|0
)paren
(brace
id|memset
c_func
(paren
id|p
comma
l_int|0x00
comma
id|padding
op_plus
r_sizeof
(paren
r_uint64
)paren
)paren
suffix:semicolon
id|md4_transform_helper
c_func
(paren
id|mctx
)paren
suffix:semicolon
id|p
op_assign
(paren
r_char
op_star
)paren
id|mctx-&gt;block
suffix:semicolon
id|padding
op_assign
l_int|56
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
id|padding
)paren
suffix:semicolon
id|mctx-&gt;block
(braket
l_int|14
)braket
op_assign
id|mctx-&gt;byte_count
op_lshift
l_int|3
suffix:semicolon
id|mctx-&gt;block
(braket
l_int|15
)braket
op_assign
id|mctx-&gt;byte_count
op_rshift
l_int|29
suffix:semicolon
id|le32_to_cpu_array
c_func
(paren
id|mctx-&gt;block
comma
(paren
r_sizeof
(paren
id|mctx-&gt;block
)paren
op_minus
r_sizeof
(paren
r_uint64
)paren
)paren
op_div
r_sizeof
(paren
r_uint32
)paren
)paren
suffix:semicolon
id|md4_transform
c_func
(paren
id|mctx-&gt;hash
comma
id|mctx-&gt;block
)paren
suffix:semicolon
id|cpu_to_le32_array
c_func
(paren
id|mctx-&gt;hash
comma
r_sizeof
(paren
id|mctx-&gt;hash
)paren
op_div
r_sizeof
(paren
r_uint32
)paren
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|out
comma
id|len
comma
l_string|&quot;%08X%08X%08X%08X&quot;
comma
id|mctx-&gt;hash
(braket
l_int|0
)braket
comma
id|mctx-&gt;hash
(braket
l_int|1
)braket
comma
id|mctx-&gt;hash
(braket
l_int|2
)braket
comma
id|mctx-&gt;hash
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
DECL|function|add_char
r_static
r_inline
r_void
id|add_char
c_func
(paren
r_int
r_char
id|c
comma
r_struct
id|md4_ctx
op_star
id|md
)paren
(brace
id|md4_update
c_func
(paren
id|md
comma
op_amp
id|c
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|parse_string
r_static
r_int
id|parse_string
c_func
(paren
r_const
r_char
op_star
id|file
comma
r_int
r_int
id|len
comma
r_struct
id|md4_ctx
op_star
id|md
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
id|add_char
c_func
(paren
id|file
(braket
l_int|0
)braket
comma
id|md
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|add_char
c_func
(paren
id|file
(braket
id|i
)braket
comma
id|md
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file
(braket
id|i
)braket
op_eq
l_char|&squot;&quot;&squot;
op_logical_and
id|file
(braket
id|i
op_minus
l_int|1
)braket
op_ne
l_char|&squot;&bslash;&bslash;&squot;
)paren
r_break
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
DECL|function|parse_comment
r_static
r_int
id|parse_comment
c_func
(paren
r_const
r_char
op_star
id|file
comma
r_int
r_int
id|len
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|file
(braket
id|i
op_minus
l_int|1
)braket
op_eq
l_char|&squot;*&squot;
op_logical_and
id|file
(braket
id|i
)braket
op_eq
l_char|&squot;/&squot;
)paren
r_break
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* FIXME: Handle .s files differently (eg. # starts comments) --RR */
DECL|function|parse_file
r_static
r_int
id|parse_file
c_func
(paren
r_const
r_int
r_char
op_star
id|fname
comma
r_struct
id|md4_ctx
op_star
id|md
)paren
(brace
r_int
r_char
op_star
id|file
suffix:semicolon
r_int
r_int
id|i
comma
id|len
suffix:semicolon
id|file
op_assign
id|grab_file
c_func
(paren
id|fname
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Collapse and ignore &bslash; and CR. */
r_if
c_cond
(paren
id|file
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;&bslash;&squot;
op_logical_and
(paren
id|i
op_plus
l_int|1
OL
id|len
)paren
op_logical_and
id|file
(braket
id|i
op_plus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|i
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Ignore whitespace */
r_if
c_cond
(paren
id|isspace
c_func
(paren
id|file
(braket
id|i
)braket
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Handle strings as whole units */
r_if
c_cond
(paren
id|file
(braket
id|i
)braket
op_eq
l_char|&squot;&quot;&squot;
)paren
(brace
id|i
op_add_assign
id|parse_string
c_func
(paren
id|file
op_plus
id|i
comma
id|len
op_minus
id|i
comma
id|md
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Comments: ignore */
r_if
c_cond
(paren
id|file
(braket
id|i
)braket
op_eq
l_char|&squot;/&squot;
op_logical_and
id|file
(braket
id|i
op_plus
l_int|1
)braket
op_eq
l_char|&squot;*&squot;
)paren
(brace
id|i
op_add_assign
id|parse_comment
c_func
(paren
id|file
op_plus
id|i
comma
id|len
op_minus
id|i
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|add_char
c_func
(paren
id|file
(braket
id|i
)braket
comma
id|md
)paren
suffix:semicolon
)brace
id|release_file
c_func
(paren
id|file
comma
id|len
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* We have dir/file.o.  Open dir/.file.o.cmd, look for deps_ line to&n; * figure out source file. */
DECL|function|parse_source_files
r_static
r_int
id|parse_source_files
c_func
(paren
r_const
r_char
op_star
id|objfile
comma
r_struct
id|md4_ctx
op_star
id|md
)paren
(brace
r_char
op_star
id|cmd
comma
op_star
id|file
comma
op_star
id|line
comma
op_star
id|dir
suffix:semicolon
r_const
r_char
op_star
id|base
suffix:semicolon
r_int
r_int
id|flen
comma
id|pos
op_assign
l_int|0
suffix:semicolon
r_int
id|dirlen
comma
id|ret
op_assign
l_int|0
comma
id|check_files
op_assign
l_int|0
suffix:semicolon
id|cmd
op_assign
id|NOFAIL
c_func
(paren
id|malloc
c_func
(paren
id|strlen
c_func
(paren
id|objfile
)paren
op_plus
r_sizeof
(paren
l_string|&quot;..cmd&quot;
)paren
)paren
)paren
suffix:semicolon
id|base
op_assign
id|strrchr
c_func
(paren
id|objfile
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
)paren
(brace
id|base
op_increment
suffix:semicolon
id|dirlen
op_assign
id|base
op_minus
id|objfile
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd
comma
l_string|&quot;%.*s.%s.cmd&quot;
comma
id|dirlen
comma
id|objfile
comma
id|base
)paren
suffix:semicolon
)brace
r_else
(brace
id|dirlen
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|cmd
comma
l_string|&quot;.%s.cmd&quot;
comma
id|objfile
)paren
suffix:semicolon
)brace
id|dir
op_assign
id|NOFAIL
c_func
(paren
id|malloc
c_func
(paren
id|dirlen
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|dir
comma
id|objfile
comma
id|dirlen
)paren
suffix:semicolon
id|dir
(braket
id|dirlen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|file
op_assign
id|grab_file
c_func
(paren
id|cmd
comma
op_amp
id|flen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: could not find %s for %s&bslash;n&quot;
comma
id|cmd
comma
id|objfile
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* There will be a line like so:&n;&t;&t;deps_drivers/net/dummy.o := &bslash;&n;&t;&t;  drivers/net/dummy.c &bslash;&n;&t;&t;    $(wildcard include/config/net/fastroute.h) &bslash;&n;&t;&t;  include/linux/config.h &bslash;&n;&t;&t;    $(wildcard include/config/h.h) &bslash;&n;&t;&t;  include/linux/module.h &bslash;&n;&n;&t;   Sum all files in the same dir or subdirs.&n;&t;*/
r_while
c_loop
(paren
(paren
id|line
op_assign
id|get_next_line
c_func
(paren
op_amp
id|pos
comma
id|file
comma
id|flen
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
id|line
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|line
comma
l_string|&quot;deps_&quot;
comma
r_sizeof
(paren
l_string|&quot;deps_&quot;
)paren
op_minus
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|check_files
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|check_files
)paren
r_continue
suffix:semicolon
multiline_comment|/* Continue until line does not end with &squot;&bslash;&squot; */
r_if
c_cond
(paren
op_star
(paren
id|p
op_plus
id|strlen
c_func
(paren
id|p
)paren
op_minus
l_int|1
)paren
op_ne
l_char|&squot;&bslash;&bslash;&squot;
)paren
r_break
suffix:semicolon
multiline_comment|/* Terminate line at first space, to get rid of final &squot; &bslash;&squot; */
r_while
c_loop
(paren
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
id|isspace
c_func
(paren
op_star
id|p
)paren
)paren
(brace
op_star
id|p
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p
op_increment
suffix:semicolon
)brace
multiline_comment|/* Check if this file is in same dir as objfile */
r_if
c_cond
(paren
(paren
id|strstr
c_func
(paren
id|line
comma
id|dir
)paren
op_plus
id|strlen
c_func
(paren
id|dir
)paren
op_minus
l_int|1
)paren
op_eq
id|strrchr
c_func
(paren
id|line
comma
l_char|&squot;/&squot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parse_file
c_func
(paren
id|line
comma
id|md
)paren
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: could not open %s: %s&bslash;n&quot;
comma
id|line
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_goto
id|out_file
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Everyone parsed OK */
id|ret
op_assign
l_int|1
suffix:semicolon
id|out_file
suffix:colon
id|release_file
c_func
(paren
id|file
comma
id|flen
)paren
suffix:semicolon
id|out
suffix:colon
id|free
c_func
(paren
id|dir
)paren
suffix:semicolon
id|free
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Calc and record src checksum. */
DECL|function|get_src_version
r_void
id|get_src_version
c_func
(paren
r_const
r_char
op_star
id|modname
comma
r_char
id|sum
(braket
)braket
comma
r_int
id|sumlen
)paren
(brace
r_void
op_star
id|file
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_struct
id|md4_ctx
id|md
suffix:semicolon
r_char
op_star
id|sources
comma
op_star
id|end
comma
op_star
id|fname
suffix:semicolon
r_const
r_char
op_star
id|basename
suffix:semicolon
r_char
id|filelist
(braket
id|strlen
c_func
(paren
id|getenv
c_func
(paren
l_string|&quot;MODVERDIR&quot;
)paren
)paren
op_plus
id|strlen
c_func
(paren
l_string|&quot;/&quot;
)paren
op_plus
id|strlen
c_func
(paren
id|modname
)paren
op_minus
id|strlen
c_func
(paren
l_string|&quot;.o&quot;
)paren
op_plus
id|strlen
c_func
(paren
l_string|&quot;.mod&quot;
)paren
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Source files for module are in .tmp_versions/modname.mod,&n;&t;   after the first line. */
r_if
c_cond
(paren
id|strrchr
c_func
(paren
id|modname
comma
l_char|&squot;/&squot;
)paren
)paren
id|basename
op_assign
id|strrchr
c_func
(paren
id|modname
comma
l_char|&squot;/&squot;
)paren
op_plus
l_int|1
suffix:semicolon
r_else
id|basename
op_assign
id|modname
suffix:semicolon
id|sprintf
c_func
(paren
id|filelist
comma
l_string|&quot;%s/%.*s.mod&quot;
comma
id|getenv
c_func
(paren
l_string|&quot;MODVERDIR&quot;
)paren
comma
(paren
r_int
)paren
id|strlen
c_func
(paren
id|basename
)paren
op_minus
l_int|2
comma
id|basename
)paren
suffix:semicolon
id|file
op_assign
id|grab_file
c_func
(paren
id|filelist
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: could not find versions for %s&bslash;n&quot;
comma
id|filelist
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sources
op_assign
id|strchr
c_func
(paren
id|file
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sources
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: malformed versions file for %s&bslash;n&quot;
comma
id|modname
)paren
suffix:semicolon
r_goto
id|release
suffix:semicolon
)brace
id|sources
op_increment
suffix:semicolon
id|end
op_assign
id|strchr
c_func
(paren
id|sources
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|end
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: bad ending versions file for %s&bslash;n&quot;
comma
id|modname
)paren
suffix:semicolon
r_goto
id|release
suffix:semicolon
)brace
op_star
id|end
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|md4_init
c_func
(paren
op_amp
id|md
)paren
suffix:semicolon
r_for
c_loop
(paren
id|fname
op_assign
id|strtok
c_func
(paren
id|sources
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|fname
suffix:semicolon
id|fname
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot; &quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parse_source_files
c_func
(paren
id|fname
comma
op_amp
id|md
)paren
)paren
r_goto
id|release
suffix:semicolon
)brace
id|md4_final_ascii
c_func
(paren
op_amp
id|md
comma
id|sum
comma
id|sumlen
)paren
suffix:semicolon
id|release
suffix:colon
id|release_file
c_func
(paren
id|file
comma
id|len
)paren
suffix:semicolon
)brace
DECL|function|write_version
r_static
r_void
id|write_version
c_func
(paren
r_const
r_char
op_star
id|filename
comma
r_const
r_char
op_star
id|sum
comma
r_int
r_int
id|offset
)paren
(brace
r_int
id|fd
suffix:semicolon
id|fd
op_assign
id|open
c_func
(paren
id|filename
comma
id|O_RDWR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: changing sum in %s failed: %s&bslash;n&quot;
comma
id|filename
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lseek
c_func
(paren
id|fd
comma
id|offset
comma
id|SEEK_SET
)paren
op_eq
(paren
id|off_t
)paren
op_minus
l_int|1
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: changing sum in %s:%lu failed: %s&bslash;n&quot;
comma
id|filename
comma
id|offset
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|write
c_func
(paren
id|fd
comma
id|sum
comma
id|strlen
c_func
(paren
id|sum
)paren
op_plus
l_int|1
)paren
op_ne
id|strlen
c_func
(paren
id|sum
)paren
op_plus
l_int|1
)paren
(brace
id|fprintf
c_func
(paren
id|stderr
comma
l_string|&quot;Warning: writing sum in %s failed: %s&bslash;n&quot;
comma
id|filename
comma
id|strerror
c_func
(paren
id|errno
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
id|close
c_func
(paren
id|fd
)paren
suffix:semicolon
)brace
DECL|function|strip_rcs_crap
r_static
r_int
id|strip_rcs_crap
c_func
(paren
r_int
r_char
op_star
id|version
)paren
(brace
r_int
r_int
id|len
comma
id|full_len
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|version
comma
l_string|&quot;$Revision&quot;
comma
id|strlen
c_func
(paren
l_string|&quot;$Revision&quot;
)paren
)paren
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Space for version string follows. */
id|full_len
op_assign
id|strlen
c_func
(paren
id|version
)paren
op_plus
id|strlen
c_func
(paren
id|version
op_plus
id|strlen
c_func
(paren
id|version
)paren
op_plus
l_int|1
)paren
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* Move string to start with version number: prefix will be&n;&t; * $Revision$ or $Revision: */
id|len
op_assign
id|strlen
c_func
(paren
l_string|&quot;$Revision&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|version
(braket
id|len
)braket
op_eq
l_char|&squot;:&squot;
op_logical_or
id|version
(braket
id|len
)braket
op_eq
l_char|&squot;$&squot;
)paren
id|len
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|isspace
c_func
(paren
id|version
(braket
id|len
)braket
)paren
)paren
id|len
op_increment
suffix:semicolon
id|memmove
c_func
(paren
id|version
comma
id|version
op_plus
id|len
comma
id|full_len
op_minus
id|len
)paren
suffix:semicolon
id|full_len
op_sub_assign
id|len
suffix:semicolon
multiline_comment|/* Preserve up to next whitespace. */
id|len
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|version
(braket
id|len
)braket
op_logical_and
op_logical_neg
id|isspace
c_func
(paren
id|version
(braket
id|len
)braket
)paren
)paren
id|len
op_increment
suffix:semicolon
id|memmove
c_func
(paren
id|version
op_plus
id|len
comma
id|version
op_plus
id|strlen
c_func
(paren
id|version
)paren
comma
id|full_len
op_minus
id|strlen
c_func
(paren
id|version
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Clean up RCS-style version numbers. */
DECL|function|maybe_frob_rcs_version
r_void
id|maybe_frob_rcs_version
c_func
(paren
r_const
r_char
op_star
id|modfilename
comma
r_char
op_star
id|version
comma
r_void
op_star
id|modinfo
comma
r_int
r_int
id|version_offset
)paren
(brace
r_if
c_cond
(paren
id|strip_rcs_crap
c_func
(paren
id|version
)paren
)paren
id|write_version
c_func
(paren
id|modfilename
comma
id|version
comma
id|version_offset
)paren
suffix:semicolon
)brace
eof
