multiline_comment|/*&n; &t;drivers/sound/harmony.c &n;&n;&t;This is a sound driver for ASP&squot;s and Lasi&squot;s Harmony sound chip&n;&t;and is unlikely to be used for anything other than on a HP PA-RISC.&n;&n;&t;Harmony is found in HP 712s, 715/new and many other GSC based machines.&n;&t;On older 715 machines you&squot;ll find the technically identical chip &n;&t;called &squot;Vivace&squot;. Both Harmony and Vicace are supported by this driver.&n;&n;&t;Copyright 2000 (c) Linuxcare Canada, Alex deVries &lt;alex@linuxcare.com&gt;&n;&t;Copyright 2000-2002 (c) Helge Deller &lt;deller@gmx.de&gt;&n;&t;Copyright 2001 (c) Matthieu Delahaye &lt;delahaym@esiee.fr&gt;&n;&t;Copyright 2001 (c) Jean-Christophe Vaugeois &lt;vaugeoij@esiee.fr&gt;&n;&n;&t;&t;&t;&t;&n;TODO:&n;&t;- fix SNDCTL_DSP_GETOSPACE and SNDCTL_DSP_GETISPACE ioctls to&n;&t;&t;return the real values&n;&t;- add private ioctl for selecting line- or microphone input&n;&t;&t;(only one of them is available at the same time)&n;&t;- add module parameters&n;&t;- implement mmap functionality&n;&t;- implement gain meter ?&n;&t;- ...&n;*/
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/gsc.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgalloc.h&gt;
macro_line|#include &quot;sound_config.h&quot;
DECL|macro|PFX
mdefine_line|#define PFX &quot;harmony: &quot;
DECL|macro|HARMONY_VERSION
mdefine_line|#define HARMONY_VERSION &quot;V0.9a&quot;
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#ifdef DEBUG
DECL|macro|DPRINTK
macro_line|# define DPRINTK printk 
macro_line|#else
DECL|macro|DPRINTK
macro_line|# define DPRINTK(x,...)
macro_line|#endif
DECL|macro|MAX_BUFS
mdefine_line|#define MAX_BUFS 10&t;&t;/* maximum number of rotating buffers */
DECL|macro|HARMONY_BUF_SIZE
mdefine_line|#define HARMONY_BUF_SIZE 4096&t;/* needs to be a multiple of PAGE_SIZE (4096)! */
DECL|macro|CNTL_C
mdefine_line|#define CNTL_C&t;&t;0x80000000
DECL|macro|CNTL_ST
mdefine_line|#define&t;CNTL_ST&t;&t;0x00000020
DECL|macro|CNTL_44100
mdefine_line|#define CNTL_44100&t;0x00000015&t;/* HARMONY_SR_44KHZ */
DECL|macro|CNTL_8000
mdefine_line|#define CNTL_8000&t;0x00000008&t;/* HARMONY_SR_8KHZ */
DECL|macro|GAINCTL_HE
mdefine_line|#define GAINCTL_HE&t;0x08000000
DECL|macro|GAINCTL_LE
mdefine_line|#define GAINCTL_LE&t;0x04000000
DECL|macro|GAINCTL_SE
mdefine_line|#define GAINCTL_SE&t;0x02000000
DECL|macro|DSTATUS_PN
mdefine_line|#define DSTATUS_PN&t;0x00000200
DECL|macro|DSTATUS_RN
mdefine_line|#define DSTATUS_RN&t;0x00000002
DECL|macro|DSTATUS_IE
mdefine_line|#define DSTATUS_IE&t;0x80000000
DECL|macro|HARMONY_DF_16BIT_LINEAR
mdefine_line|#define HARMONY_DF_16BIT_LINEAR&t;0
DECL|macro|HARMONY_DF_8BIT_ULAW
mdefine_line|#define HARMONY_DF_8BIT_ULAW&t;1
DECL|macro|HARMONY_DF_8BIT_ALAW
mdefine_line|#define HARMONY_DF_8BIT_ALAW&t;2
DECL|macro|HARMONY_SS_MONO
mdefine_line|#define HARMONY_SS_MONO&t;&t;0
DECL|macro|HARMONY_SS_STEREO
mdefine_line|#define HARMONY_SS_STEREO&t;1
DECL|macro|HARMONY_SR_8KHZ
mdefine_line|#define HARMONY_SR_8KHZ&t;&t;0x08
DECL|macro|HARMONY_SR_16KHZ
mdefine_line|#define HARMONY_SR_16KHZ&t;0x09
DECL|macro|HARMONY_SR_27KHZ
mdefine_line|#define HARMONY_SR_27KHZ&t;0x0A
DECL|macro|HARMONY_SR_32KHZ
mdefine_line|#define HARMONY_SR_32KHZ&t;0x0B
DECL|macro|HARMONY_SR_48KHZ
mdefine_line|#define HARMONY_SR_48KHZ&t;0x0E
DECL|macro|HARMONY_SR_9KHZ
mdefine_line|#define HARMONY_SR_9KHZ&t;&t;0x0F
DECL|macro|HARMONY_SR_5KHZ
mdefine_line|#define HARMONY_SR_5KHZ&t;&t;0x10
DECL|macro|HARMONY_SR_11KHZ
mdefine_line|#define HARMONY_SR_11KHZ&t;0x11
DECL|macro|HARMONY_SR_18KHZ
mdefine_line|#define HARMONY_SR_18KHZ&t;0x12
DECL|macro|HARMONY_SR_22KHZ
mdefine_line|#define HARMONY_SR_22KHZ&t;0x13
DECL|macro|HARMONY_SR_37KHZ
mdefine_line|#define HARMONY_SR_37KHZ&t;0x14
DECL|macro|HARMONY_SR_44KHZ
mdefine_line|#define HARMONY_SR_44KHZ&t;0x15
DECL|macro|HARMONY_SR_33KHZ
mdefine_line|#define HARMONY_SR_33KHZ&t;0x16
DECL|macro|HARMONY_SR_6KHZ
mdefine_line|#define HARMONY_SR_6KHZ&t;&t;0x17
multiline_comment|/*&n; * Some magics numbers used to auto-detect file formats&n; */
DECL|macro|HARMONY_MAGIC_8B_ULAW
mdefine_line|#define HARMONY_MAGIC_8B_ULAW&t;1
DECL|macro|HARMONY_MAGIC_8B_ALAW
mdefine_line|#define HARMONY_MAGIC_8B_ALAW&t;27
DECL|macro|HARMONY_MAGIC_16B_LINEAR
mdefine_line|#define HARMONY_MAGIC_16B_LINEAR 3
DECL|macro|HARMONY_MAGIC_MONO
mdefine_line|#define HARMONY_MAGIC_MONO&t;1
DECL|macro|HARMONY_MAGIC_STEREO
mdefine_line|#define HARMONY_MAGIC_STEREO&t;2
multiline_comment|/*&n; * Channels Positions in mixer register&n; */
DECL|macro|GAIN_HE_SHIFT
mdefine_line|#define GAIN_HE_SHIFT   27
DECL|macro|GAIN_HE_MASK
mdefine_line|#define GAIN_HE_MASK    ( 1 &lt;&lt; GAIN_HE_SHIFT) 
DECL|macro|GAIN_LE_SHIFT
mdefine_line|#define GAIN_LE_SHIFT   26
DECL|macro|GAIN_LE_MASK
mdefine_line|#define GAIN_LE_MASK    ( 1 &lt;&lt; GAIN_LE_SHIFT) 
DECL|macro|GAIN_SE_SHIFT
mdefine_line|#define GAIN_SE_SHIFT   25
DECL|macro|GAIN_SE_MASK
mdefine_line|#define GAIN_SE_MASK    ( 1 &lt;&lt; GAIN_SE_SHIFT) 
DECL|macro|GAIN_IS_SHIFT
mdefine_line|#define GAIN_IS_SHIFT   24
DECL|macro|GAIN_IS_MASK
mdefine_line|#define GAIN_IS_MASK    ( 1 &lt;&lt; GAIN_IS_SHIFT) 
DECL|macro|GAIN_MA_SHIFT
mdefine_line|#define GAIN_MA_SHIFT   20
DECL|macro|GAIN_MA_MASK
mdefine_line|#define GAIN_MA_MASK    ( 0x0f &lt;&lt; GAIN_MA_SHIFT) 
DECL|macro|GAIN_LI_SHIFT
mdefine_line|#define GAIN_LI_SHIFT   16
DECL|macro|GAIN_LI_MASK
mdefine_line|#define GAIN_LI_MASK    ( 0x0f &lt;&lt; GAIN_LI_SHIFT) 
DECL|macro|GAIN_RI_SHIFT
mdefine_line|#define GAIN_RI_SHIFT   12
DECL|macro|GAIN_RI_MASK
mdefine_line|#define GAIN_RI_MASK    ( 0x0f &lt;&lt; GAIN_RI_SHIFT) 
DECL|macro|GAIN_LO_SHIFT
mdefine_line|#define GAIN_LO_SHIFT   6
DECL|macro|GAIN_LO_MASK
mdefine_line|#define GAIN_LO_MASK    ( 0x3f &lt;&lt; GAIN_LO_SHIFT) 
DECL|macro|GAIN_RO_SHIFT
mdefine_line|#define GAIN_RO_SHIFT   0
DECL|macro|GAIN_RO_MASK
mdefine_line|#define GAIN_RO_MASK    ( 0x3f &lt;&lt; GAIN_RO_SHIFT) 
DECL|macro|MAX_OUTPUT_LEVEL
mdefine_line|#define MAX_OUTPUT_LEVEL (GAIN_RO_MASK &gt;&gt; GAIN_RO_SHIFT)
DECL|macro|MAX_INPUT_LEVEL
mdefine_line|#define MAX_INPUT_LEVEL  (GAIN_RI_MASK &gt;&gt; GAIN_RI_SHIFT)
DECL|macro|MAX_VOLUME_LEVEL
mdefine_line|#define MAX_VOLUME_LEVEL (GAIN_MA_MASK &gt;&gt; GAIN_MA_SHIFT)
multiline_comment|/*&n; * Channels Mask in mixer register&n; */
DECL|macro|GAIN_TOTAL_SILENCE
mdefine_line|#define GAIN_TOTAL_SILENCE 0x00F00FFF
DECL|macro|GAIN_DEFAULT
mdefine_line|#define GAIN_DEFAULT       0x0FF00000
DECL|struct|harmony_hpa
r_struct
id|harmony_hpa
(brace
DECL|member|unused000
id|u8
id|unused000
suffix:semicolon
DECL|member|id
id|u8
id|id
suffix:semicolon
DECL|member|teleshare_id
id|u8
id|teleshare_id
suffix:semicolon
DECL|member|unused003
id|u8
id|unused003
suffix:semicolon
DECL|member|reset
id|u32
id|reset
suffix:semicolon
DECL|member|cntl
id|u32
id|cntl
suffix:semicolon
DECL|member|gainctl
id|u32
id|gainctl
suffix:semicolon
DECL|member|pnxtadd
id|u32
id|pnxtadd
suffix:semicolon
DECL|member|pcuradd
id|u32
id|pcuradd
suffix:semicolon
DECL|member|rnxtadd
id|u32
id|rnxtadd
suffix:semicolon
DECL|member|rcuradd
id|u32
id|rcuradd
suffix:semicolon
DECL|member|dstatus
id|u32
id|dstatus
suffix:semicolon
DECL|member|ov
id|u32
id|ov
suffix:semicolon
DECL|member|pio
id|u32
id|pio
suffix:semicolon
DECL|member|unused02c
id|u32
id|unused02c
suffix:semicolon
DECL|member|unused030
id|u32
id|unused030
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|diag
id|u32
id|diag
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|harmony_dev
r_struct
id|harmony_dev
(brace
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|hpa
r_struct
id|harmony_hpa
op_star
id|hpa
suffix:semicolon
DECL|member|current_gain
id|u32
id|current_gain
suffix:semicolon
DECL|member|data_format
id|u8
id|data_format
suffix:semicolon
multiline_comment|/* HARMONY_DF_xx_BIT_xxx */
DECL|member|sample_rate
id|u8
id|sample_rate
suffix:semicolon
multiline_comment|/* HARMONY_SR_xx_KHZ */
DECL|member|stereo_select
id|u8
id|stereo_select
suffix:semicolon
multiline_comment|/* HARMONY_SS_MONO or HARMONY_SS_STEREO */
DECL|member|format_initialized
r_int
id|format_initialized
suffix:semicolon
DECL|member|dac_rate
id|u32
id|dac_rate
suffix:semicolon
multiline_comment|/* 8000 ... 48000 (Hz) */
DECL|member|suspended_playing
r_int
id|suspended_playing
suffix:semicolon
DECL|member|suspended_recording
r_int
id|suspended_recording
suffix:semicolon
DECL|member|blocked_playing
r_int
id|blocked_playing
suffix:semicolon
DECL|member|blocked_recording
r_int
id|blocked_recording
suffix:semicolon
DECL|member|wq_play
DECL|member|wq_record
id|wait_queue_head_t
id|wq_play
comma
id|wq_record
suffix:semicolon
DECL|member|first_filled_play
r_int
id|first_filled_play
suffix:semicolon
multiline_comment|/* first buffer containing data (next to play) */
DECL|member|nb_filled_play
r_int
id|nb_filled_play
suffix:semicolon
DECL|member|play_offset
r_int
id|play_offset
suffix:semicolon
DECL|member|first_filled_record
r_int
id|first_filled_record
suffix:semicolon
DECL|member|nb_filled_record
r_int
id|nb_filled_record
suffix:semicolon
DECL|member|audio_open
DECL|member|mixer_open
r_int
id|audio_open
comma
id|mixer_open
suffix:semicolon
DECL|member|dsp_unit
DECL|member|mixer_unit
r_int
id|dsp_unit
comma
id|mixer_unit
suffix:semicolon
DECL|member|fake_pci_dev
r_struct
id|pci_dev
op_star
id|fake_pci_dev
suffix:semicolon
multiline_comment|/* The fake pci_dev needed for &n;&t;&t;&t;&t;&t;pci_* functions under ccio. */
)brace
suffix:semicolon
DECL|variable|harmony
r_static
r_struct
id|harmony_dev
id|harmony
suffix:semicolon
multiline_comment|/*&n; * Dynamic sound buffer allocation and DMA memory&n; */
DECL|struct|harmony_buffer
r_struct
id|harmony_buffer
(brace
DECL|member|addr
r_int
r_char
op_star
id|addr
suffix:semicolon
DECL|member|dma_handle
id|dma_addr_t
id|dma_handle
suffix:semicolon
DECL|member|dma_consistent
r_int
id|dma_consistent
suffix:semicolon
multiline_comment|/* Zero if pci_alloc_consistent() fails */
DECL|member|len
r_int
id|len
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Harmony memory buffers&n; */
DECL|variable|played_buf
DECL|variable|recorded_buf
DECL|variable|silent
DECL|variable|graveyard
r_static
r_struct
id|harmony_buffer
id|played_buf
comma
id|recorded_buf
comma
id|silent
comma
id|graveyard
suffix:semicolon
DECL|macro|CHECK_WBACK_INV_OFFSET
mdefine_line|#define CHECK_WBACK_INV_OFFSET(b,offset,len) &bslash;&n;        do { if (!b.dma_consistent) &bslash;&n;&t;&t;dma_cache_wback_inv((unsigned long)b.addr+offset,len); &bslash;&n;&t;} while (0) 
DECL|function|harmony_alloc_buffer
r_static
r_int
id|__init
id|harmony_alloc_buffer
c_func
(paren
r_struct
id|harmony_buffer
op_star
id|b
comma
r_int
id|buffer_count
)paren
(brace
id|b-&gt;len
op_assign
id|buffer_count
op_star
id|HARMONY_BUF_SIZE
suffix:semicolon
id|b-&gt;addr
op_assign
id|pci_alloc_consistent
c_func
(paren
id|harmony.fake_pci_dev
comma
id|b-&gt;len
comma
op_amp
id|b-&gt;dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b-&gt;addr
op_logical_and
id|b-&gt;dma_handle
)paren
(brace
id|b-&gt;dma_consistent
op_assign
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;consistent memory: 0x%lx, played_buf: 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|b-&gt;dma_handle
comma
(paren
r_int
r_int
)paren
id|b-&gt;addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|b-&gt;dma_consistent
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* kmalloc()ed memory will HPMC on ccio machines ! */
id|b-&gt;addr
op_assign
id|kmalloc
c_func
(paren
id|b-&gt;len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b-&gt;addr
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;couldn&squot;t allocate memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|b-&gt;dma_handle
op_assign
id|__pa
c_func
(paren
id|b-&gt;addr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|harmony_free_buffer
r_static
r_void
id|__exit
id|harmony_free_buffer
c_func
(paren
r_struct
id|harmony_buffer
op_star
id|b
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|b-&gt;addr
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|b-&gt;dma_consistent
)paren
id|pci_free_consistent
c_func
(paren
id|harmony.fake_pci_dev
comma
id|b-&gt;len
comma
id|b-&gt;addr
comma
id|b-&gt;dma_handle
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|b-&gt;addr
)paren
suffix:semicolon
id|memset
c_func
(paren
id|b
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|b
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Low-Level sound-chip programming&n; */
DECL|function|harmony_wait_CNTL
r_static
r_void
id|__inline__
id|harmony_wait_CNTL
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Wait until we&squot;re out of control mode */
r_while
c_loop
(paren
id|gsc_readl
c_func
(paren
op_amp
id|harmony.hpa-&gt;cntl
)paren
op_amp
id|CNTL_C
)paren
multiline_comment|/* wait */
suffix:semicolon
)brace
DECL|function|harmony_update_control
r_static
r_void
id|harmony_update_control
c_func
(paren
r_void
)paren
(brace
id|u32
id|default_cntl
suffix:semicolon
multiline_comment|/* Set CNTL */
id|default_cntl
op_assign
(paren
id|CNTL_C
op_or
multiline_comment|/* The C bit */
(paren
id|harmony.data_format
op_lshift
l_int|6
)paren
op_or
multiline_comment|/* Set the data format */
(paren
id|harmony.stereo_select
op_lshift
l_int|5
)paren
op_or
multiline_comment|/* Stereo select */
(paren
id|harmony.sample_rate
)paren
)paren
suffix:semicolon
multiline_comment|/* Set sample rate */
id|harmony.format_initialized
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* initialize CNTL */
id|gsc_writel
c_func
(paren
id|default_cntl
comma
op_amp
id|harmony.hpa-&gt;cntl
)paren
suffix:semicolon
)brace
DECL|function|harmony_set_control
r_static
r_void
id|harmony_set_control
c_func
(paren
id|u8
id|data_format
comma
id|u8
id|sample_rate
comma
id|u8
id|stereo_select
)paren
(brace
id|harmony.sample_rate
op_assign
id|sample_rate
suffix:semicolon
id|harmony.data_format
op_assign
id|data_format
suffix:semicolon
id|harmony.stereo_select
op_assign
id|stereo_select
suffix:semicolon
id|harmony_update_control
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|harmony_set_rate
r_static
r_void
id|harmony_set_rate
c_func
(paren
id|u8
id|data_rate
)paren
(brace
id|harmony.sample_rate
op_assign
id|data_rate
suffix:semicolon
id|harmony_update_control
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|harmony_detect_rate
r_static
r_int
id|harmony_detect_rate
c_func
(paren
r_int
op_star
id|freq
)paren
(brace
r_int
id|newrate
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|freq
)paren
(brace
r_case
l_int|8000
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_8KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16000
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_16KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|27428
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_27KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32000
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_32KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|48000
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_48KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_9KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5125
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_5KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|11025
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_11KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|18900
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_18KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|22050
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_22KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|37800
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_37KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|44100
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_44KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|33075
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_33KHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6615
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_6KHZ
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|newrate
op_assign
id|HARMONY_SR_8KHZ
suffix:semicolon
op_star
id|freq
op_assign
l_int|8000
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|newrate
suffix:semicolon
)brace
DECL|function|harmony_set_format
r_static
r_void
id|harmony_set_format
c_func
(paren
id|u8
id|data_format
)paren
(brace
id|harmony.data_format
op_assign
id|data_format
suffix:semicolon
id|harmony_update_control
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|harmony_set_stereo
r_static
r_void
id|harmony_set_stereo
c_func
(paren
id|u8
id|stereo_select
)paren
(brace
id|harmony.stereo_select
op_assign
id|stereo_select
suffix:semicolon
id|harmony_update_control
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|harmony_disable_interrupts
r_static
r_void
id|harmony_disable_interrupts
c_func
(paren
r_void
)paren
(brace
id|harmony_wait_CNTL
c_func
(paren
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
l_int|0
comma
op_amp
id|harmony.hpa-&gt;dstatus
)paren
suffix:semicolon
)brace
DECL|function|harmony_enable_interrupts
r_static
r_void
id|harmony_enable_interrupts
c_func
(paren
r_void
)paren
(brace
id|harmony_wait_CNTL
c_func
(paren
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
id|DSTATUS_IE
comma
op_amp
id|harmony.hpa-&gt;dstatus
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * harmony_silence()&n; *&n; * This subroutine fills in a buffer starting at location start and&n; * silences for length bytes.  This references the current&n; * configuration of the audio format.&n; *&n; */
DECL|function|harmony_silence
r_static
r_void
id|harmony_silence
c_func
(paren
r_struct
id|harmony_buffer
op_star
id|buffer
comma
r_int
id|start
comma
r_int
id|length
)paren
(brace
id|u8
id|silence_char
suffix:semicolon
multiline_comment|/* Despite what you hear, silence is different in&n;&t;   different audio formats.  */
r_switch
c_cond
(paren
id|harmony.data_format
)paren
(brace
r_case
id|HARMONY_DF_8BIT_ULAW
suffix:colon
id|silence_char
op_assign
l_int|0x55
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_DF_8BIT_ALAW
suffix:colon
id|silence_char
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_DF_16BIT_LINEAR
suffix:colon
multiline_comment|/* fall through */
r_default
suffix:colon
id|silence_char
op_assign
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buffer-&gt;addr
op_plus
id|start
comma
id|silence_char
comma
id|length
)paren
suffix:semicolon
)brace
DECL|function|harmony_audio_open
r_static
r_int
id|harmony_audio_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|harmony.audio_open
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|harmony.audio_open
op_increment
suffix:semicolon
id|harmony.suspended_playing
op_assign
id|harmony.suspended_recording
op_assign
l_int|1
suffix:semicolon
id|harmony.blocked_playing
op_assign
id|harmony.blocked_recording
op_assign
l_int|0
suffix:semicolon
id|harmony.first_filled_play
op_assign
id|harmony.first_filled_record
op_assign
l_int|0
suffix:semicolon
id|harmony.nb_filled_play
op_assign
id|harmony.nb_filled_record
op_assign
l_int|0
suffix:semicolon
id|harmony.play_offset
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|harmony.wq_play
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|harmony.wq_record
)paren
suffix:semicolon
multiline_comment|/* Start off in a balanced mode. */
id|harmony_set_control
c_func
(paren
id|HARMONY_DF_8BIT_ULAW
comma
id|HARMONY_SR_8KHZ
comma
id|HARMONY_SS_MONO
)paren
suffix:semicolon
id|harmony_update_control
c_func
(paren
)paren
suffix:semicolon
id|harmony.format_initialized
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear out all the buffers and flush to cache */
id|harmony_silence
c_func
(paren
op_amp
id|played_buf
comma
l_int|0
comma
id|HARMONY_BUF_SIZE
op_star
id|MAX_BUFS
)paren
suffix:semicolon
id|CHECK_WBACK_INV_OFFSET
c_func
(paren
id|played_buf
comma
l_int|0
comma
id|HARMONY_BUF_SIZE
op_star
id|MAX_BUFS
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Release (close) the audio device.&n; */
DECL|function|harmony_audio_release
r_static
r_int
id|harmony_audio_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|harmony.audio_open
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|harmony.audio_open
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Read recorded data off the audio device.&n; */
DECL|function|harmony_audio_read
r_static
id|ssize_t
id|harmony_audio_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|size_count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|total_count
op_assign
(paren
r_int
)paren
id|size_count
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|buf_to_read
suffix:semicolon
r_while
c_loop
(paren
id|count
OL
id|total_count
)paren
(brace
multiline_comment|/* Wait until we&squot;re out of control mode */
id|harmony_wait_CNTL
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Figure out which buffer to fill in */
r_if
c_cond
(paren
id|harmony.nb_filled_record
op_le
l_int|2
)paren
(brace
id|harmony.blocked_recording
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|harmony.suspended_recording
)paren
(brace
id|harmony.suspended_recording
op_assign
l_int|0
suffix:semicolon
id|harmony_enable_interrupts
c_func
(paren
)paren
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|harmony.wq_record
)paren
suffix:semicolon
id|harmony.blocked_recording
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|harmony.nb_filled_record
OL
l_int|2
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|buf_to_read
op_assign
id|harmony.first_filled_record
suffix:semicolon
multiline_comment|/* Copy the page to an aligned buffer */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
op_plus
id|count
comma
id|recorded_buf.addr
op_plus
(paren
id|HARMONY_BUF_SIZE
op_star
id|buf_to_read
)paren
comma
id|HARMONY_BUF_SIZE
)paren
)paren
(brace
id|count
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|harmony.nb_filled_record
op_decrement
suffix:semicolon
id|harmony.first_filled_record
op_increment
suffix:semicolon
id|harmony.first_filled_record
op_mod_assign
id|MAX_BUFS
suffix:semicolon
id|count
op_add_assign
id|HARMONY_BUF_SIZE
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Here is the place where we try to recognize file format.&n; * Sun/NeXT .au files begin with the string .snd&n; * At offset 12 is specified the encoding.&n; * At offset 16 is specified speed rate&n; * At Offset 20 is specified the numbers of voices&n; */
DECL|macro|four_bytes_to_u32
mdefine_line|#define four_bytes_to_u32(start) (file_header[start] &lt;&lt; 24)|&bslash;&n;                                  (file_header[start+1] &lt;&lt; 16)|&bslash;&n;                                  (file_header[start+2] &lt;&lt; 8)|&bslash;&n;                                  (file_header[start+3]);
DECL|macro|test_rate
mdefine_line|#define test_rate(tested,real_value,harmony_value) if ((tested)&lt;=(real_value))&bslash;&n;                                                    
DECL|function|harmony_format_auto_detect
r_static
r_int
id|harmony_format_auto_detect
c_func
(paren
r_const
r_char
op_star
id|buffer
comma
r_int
id|block_size
)paren
(brace
id|u8
id|file_header
(braket
l_int|24
)braket
suffix:semicolon
id|u32
id|start_string
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|block_size
OG
l_int|24
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|file_header
comma
id|buffer
comma
r_sizeof
(paren
id|file_header
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|start_string
op_assign
id|four_bytes_to_u32
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file_header
(braket
l_int|4
)braket
op_eq
l_int|0
)paren
op_logical_and
(paren
id|start_string
op_eq
l_int|0x2E736E64
)paren
)paren
(brace
id|u32
id|format
suffix:semicolon
id|u32
id|nb_voices
suffix:semicolon
id|u32
id|speed
suffix:semicolon
id|format
op_assign
id|four_bytes_to_u32
c_func
(paren
l_int|12
)paren
suffix:semicolon
id|nb_voices
op_assign
id|four_bytes_to_u32
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|speed
op_assign
id|four_bytes_to_u32
c_func
(paren
l_int|16
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|format
)paren
(brace
r_case
id|HARMONY_MAGIC_8B_ULAW
suffix:colon
id|harmony.data_format
op_assign
id|HARMONY_DF_8BIT_ULAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_MAGIC_8B_ALAW
suffix:colon
id|harmony.data_format
op_assign
id|HARMONY_DF_8BIT_ALAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_MAGIC_16B_LINEAR
suffix:colon
id|harmony.data_format
op_assign
id|HARMONY_DF_16BIT_LINEAR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|harmony_set_control
c_func
(paren
id|HARMONY_DF_16BIT_LINEAR
comma
id|HARMONY_SR_44KHZ
comma
id|HARMONY_SS_STEREO
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|nb_voices
)paren
(brace
r_case
id|HARMONY_MAGIC_MONO
suffix:colon
id|harmony.stereo_select
op_assign
id|HARMONY_SS_MONO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_MAGIC_STEREO
suffix:colon
id|harmony.stereo_select
op_assign
id|HARMONY_SS_STEREO
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|harmony.stereo_select
op_assign
id|HARMONY_SS_MONO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|harmony_set_rate
c_func
(paren
id|harmony_detect_rate
c_func
(paren
op_amp
id|speed
)paren
)paren
suffix:semicolon
id|harmony.dac_rate
op_assign
id|speed
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|harmony_set_control
c_func
(paren
id|HARMONY_DF_8BIT_ULAW
comma
id|HARMONY_SR_8KHZ
comma
id|HARMONY_SS_MONO
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|macro|four_bytes_to_u32
macro_line|#undef four_bytes_to_u32
DECL|function|harmony_audio_write
r_static
id|ssize_t
id|harmony_audio_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|size_count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|total_count
op_assign
(paren
r_int
)paren
id|size_count
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_int
id|frame_size
suffix:semicolon
r_int
id|buf_to_fill
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|harmony.format_initialized
)paren
(brace
r_if
c_cond
(paren
id|harmony_format_auto_detect
c_func
(paren
id|buffer
comma
id|total_count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OL
id|total_count
)paren
(brace
multiline_comment|/* Wait until we&squot;re out of control mode */
id|harmony_wait_CNTL
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Figure out which buffer to fill in */
r_if
c_cond
(paren
id|harmony.nb_filled_play
op_plus
l_int|2
op_ge
id|MAX_BUFS
op_logical_and
op_logical_neg
id|harmony.play_offset
)paren
(brace
id|harmony.blocked_playing
op_assign
l_int|1
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|harmony.wq_play
)paren
suffix:semicolon
id|harmony.blocked_playing
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|harmony.nb_filled_play
op_plus
l_int|2
op_ge
id|MAX_BUFS
op_logical_and
op_logical_neg
id|harmony.play_offset
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|buf_to_fill
op_assign
(paren
id|harmony.first_filled_play
op_plus
id|harmony.nb_filled_play
)paren
suffix:semicolon
r_if
c_cond
(paren
id|harmony.play_offset
)paren
id|buf_to_fill
op_decrement
suffix:semicolon
id|buf_to_fill
op_mod_assign
id|MAX_BUFS
suffix:semicolon
multiline_comment|/* Figure out the size of the frame */
r_if
c_cond
(paren
(paren
id|total_count
op_minus
id|count
)paren
OG
id|HARMONY_BUF_SIZE
op_minus
id|harmony.play_offset
)paren
(brace
id|frame_size
op_assign
id|HARMONY_BUF_SIZE
op_minus
id|harmony.play_offset
suffix:semicolon
)brace
r_else
(brace
id|frame_size
op_assign
id|total_count
op_minus
id|count
suffix:semicolon
multiline_comment|/* Clear out the buffer, since there we&squot;ll only be &n;&t;&t;&t;   overlaying part of the old buffer with the new one */
id|harmony_silence
c_func
(paren
op_amp
id|played_buf
comma
id|HARMONY_BUF_SIZE
op_star
id|buf_to_fill
op_plus
id|frame_size
op_plus
id|harmony.play_offset
comma
id|HARMONY_BUF_SIZE
op_minus
id|frame_size
op_minus
id|harmony.play_offset
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy the page to an aligned buffer */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|played_buf.addr
op_plus
(paren
id|HARMONY_BUF_SIZE
op_star
id|buf_to_fill
)paren
op_plus
id|harmony.play_offset
comma
id|buffer
op_plus
id|count
comma
id|frame_size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|CHECK_WBACK_INV_OFFSET
c_func
(paren
id|played_buf
comma
(paren
id|HARMONY_BUF_SIZE
op_star
id|buf_to_fill
op_plus
id|harmony.play_offset
)paren
comma
id|frame_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|harmony.play_offset
)paren
id|harmony.nb_filled_play
op_increment
suffix:semicolon
id|count
op_add_assign
id|frame_size
suffix:semicolon
id|harmony.play_offset
op_add_assign
id|frame_size
suffix:semicolon
id|harmony.play_offset
op_mod_assign
id|HARMONY_BUF_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|harmony.suspended_playing
op_logical_and
(paren
id|harmony.nb_filled_play
op_ge
l_int|4
)paren
)paren
id|harmony_enable_interrupts
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|harmony_audio_poll
r_static
r_int
r_int
id|harmony_audio_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|harmony.suspended_recording
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|harmony.wq_record
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|harmony.nb_filled_record
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|harmony.suspended_playing
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|harmony.wq_play
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|harmony.nb_filled_play
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_return
id|mask
suffix:semicolon
)brace
DECL|function|harmony_audio_ioctl
r_static
r_int
id|harmony_audio_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ival
comma
id|new_format
suffix:semicolon
r_int
id|frag_size
comma
id|frag_buf
suffix:semicolon
r_struct
id|audio_buf_info
id|info
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
id|ival
op_assign
id|DSP_CAP_DUPLEX
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
id|ival
op_assign
(paren
id|AFMT_S16_BE
op_or
id|AFMT_MU_LAW
op_or
id|AFMT_A_LAW
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ival
op_ne
id|AFMT_QUERY
)paren
(brace
r_switch
c_cond
(paren
id|ival
)paren
(brace
r_case
id|AFMT_MU_LAW
suffix:colon
id|new_format
op_assign
id|HARMONY_DF_8BIT_ULAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_A_LAW
suffix:colon
id|new_format
op_assign
id|HARMONY_DF_8BIT_ALAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_LE
suffix:colon
multiline_comment|/* fall through, but not really supported */
r_case
id|AFMT_S16_BE
suffix:colon
id|new_format
op_assign
id|HARMONY_DF_16BIT_LINEAR
suffix:semicolon
id|ival
op_assign
id|AFMT_S16_BE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
(brace
id|DPRINTK
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;unsupported sound format 0x%04x requested.&bslash;n&quot;
comma
id|ival
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|harmony_set_format
c_func
(paren
id|new_format
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|harmony.data_format
)paren
(brace
r_case
id|HARMONY_DF_8BIT_ULAW
suffix:colon
id|ival
op_assign
id|AFMT_MU_LAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_DF_8BIT_ALAW
suffix:colon
id|ival
op_assign
id|AFMT_A_LAW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_DF_16BIT_LINEAR
suffix:colon
id|ival
op_assign
id|AFMT_U16_BE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ival
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
id|ival
op_assign
id|harmony.dac_rate
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|harmony_set_rate
c_func
(paren
id|harmony_detect_rate
c_func
(paren
op_amp
id|ival
)paren
)paren
suffix:semicolon
id|harmony.dac_rate
op_assign
id|ival
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|ival
op_ne
l_int|0
op_logical_and
id|ival
op_ne
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|harmony_set_stereo
c_func
(paren
id|ival
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
id|ival
op_assign
id|HARMONY_BUF_SIZE
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|harmony.suspended_recording
)paren
(brace
multiline_comment|/* TODO: stop_recording() */
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|frag_size
op_assign
id|ival
op_amp
l_int|0xffff
suffix:semicolon
id|frag_buf
op_assign
(paren
id|ival
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/* TODO: We use hardcoded fragment sizes and numbers for now */
id|frag_size
op_assign
l_int|12
suffix:semicolon
multiline_comment|/* 4096 == 2^12 */
id|frag_buf
op_assign
id|MAX_BUFS
suffix:semicolon
id|ival
op_assign
(paren
id|frag_buf
op_lshift
l_int|16
)paren
op_plus
id|frag_size
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|ival
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info.fragstotal
op_assign
id|MAX_BUFS
suffix:semicolon
id|info.fragments
op_assign
id|MAX_BUFS
op_minus
id|harmony.nb_filled_play
suffix:semicolon
id|info.fragsize
op_assign
id|HARMONY_BUF_SIZE
suffix:semicolon
id|info.bytes
op_assign
id|info.fragments
op_star
id|info.fragsize
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info.fragstotal
op_assign
id|MAX_BUFS
suffix:semicolon
id|info.fragments
op_assign
multiline_comment|/*MAX_BUFS-*/
id|harmony.nb_filled_record
suffix:semicolon
id|info.fragsize
op_assign
id|HARMONY_BUF_SIZE
suffix:semicolon
id|info.bytes
op_assign
id|info.fragments
op_star
id|info.fragsize
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * harmony_interrupt()&n; *&n; * harmony interruption service routine&n; * &n; */
DECL|function|harmony_interrupt
r_static
id|irqreturn_t
id|harmony_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|dstatus
suffix:semicolon
r_struct
id|harmony_hpa
op_star
id|hpa
suffix:semicolon
multiline_comment|/* Setup the hpa */
id|hpa
op_assign
(paren
(paren
r_struct
id|harmony_dev
op_star
)paren
id|dev
)paren
op_member_access_from_pointer
id|hpa
suffix:semicolon
id|harmony_wait_CNTL
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Read dstatus and pcuradd (the current address) */
id|dstatus
op_assign
id|gsc_readl
c_func
(paren
op_amp
id|hpa-&gt;dstatus
)paren
suffix:semicolon
multiline_comment|/* Turn off interrupts */
id|harmony_disable_interrupts
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Check if this is a request to get the next play buffer */
r_if
c_cond
(paren
id|dstatus
op_amp
id|DSTATUS_PN
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|harmony.nb_filled_play
)paren
(brace
id|harmony.suspended_playing
op_assign
l_int|1
suffix:semicolon
id|gsc_writel
c_func
(paren
(paren
r_int
r_int
)paren
id|silent.dma_handle
comma
op_amp
id|hpa-&gt;pnxtadd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|harmony.suspended_recording
)paren
id|harmony_enable_interrupts
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|harmony.suspended_playing
op_assign
l_int|0
suffix:semicolon
id|gsc_writel
c_func
(paren
(paren
r_int
r_int
)paren
id|played_buf.dma_handle
op_plus
(paren
id|HARMONY_BUF_SIZE
op_star
id|harmony.first_filled_play
)paren
comma
op_amp
id|hpa-&gt;pnxtadd
)paren
suffix:semicolon
id|harmony.first_filled_play
op_increment
suffix:semicolon
id|harmony.first_filled_play
op_mod_assign
id|MAX_BUFS
suffix:semicolon
id|harmony.nb_filled_play
op_decrement
suffix:semicolon
id|harmony_enable_interrupts
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|harmony.blocked_playing
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|harmony.wq_play
)paren
suffix:semicolon
)brace
multiline_comment|/* Check if we&squot;re being asked to fill in a recording buffer */
r_if
c_cond
(paren
id|dstatus
op_amp
id|DSTATUS_RN
)paren
(brace
r_if
c_cond
(paren
(paren
id|harmony.nb_filled_record
op_plus
l_int|2
op_ge
id|MAX_BUFS
)paren
op_logical_or
id|harmony.suspended_recording
)paren
(brace
id|harmony.nb_filled_record
op_assign
l_int|0
suffix:semicolon
id|harmony.first_filled_record
op_assign
l_int|0
suffix:semicolon
id|harmony.suspended_recording
op_assign
l_int|1
suffix:semicolon
id|gsc_writel
c_func
(paren
(paren
r_int
r_int
)paren
id|graveyard.dma_handle
comma
op_amp
id|hpa-&gt;rnxtadd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|harmony.suspended_playing
)paren
id|harmony_enable_interrupts
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|buf_to_fill
suffix:semicolon
id|buf_to_fill
op_assign
(paren
id|harmony.first_filled_record
op_plus
id|harmony.nb_filled_record
)paren
op_mod
id|MAX_BUFS
suffix:semicolon
id|CHECK_WBACK_INV_OFFSET
c_func
(paren
id|recorded_buf
comma
id|HARMONY_BUF_SIZE
op_star
id|buf_to_fill
comma
id|HARMONY_BUF_SIZE
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
(paren
r_int
r_int
)paren
id|recorded_buf.dma_handle
op_plus
id|HARMONY_BUF_SIZE
op_star
id|buf_to_fill
comma
op_amp
id|hpa-&gt;rnxtadd
)paren
suffix:semicolon
id|harmony.nb_filled_record
op_increment
suffix:semicolon
id|harmony_enable_interrupts
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|harmony.blocked_recording
op_logical_and
id|harmony.nb_filled_record
OG
l_int|3
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|harmony.wq_record
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * Sound playing functions&n; */
DECL|variable|harmony_audio_fops
r_static
r_struct
id|file_operations
id|harmony_audio_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
id|no_llseek
comma
id|read
suffix:colon
id|harmony_audio_read
comma
id|write
suffix:colon
id|harmony_audio_write
comma
id|poll
suffix:colon
id|harmony_audio_poll
comma
id|ioctl
suffix:colon
id|harmony_audio_ioctl
comma
id|open
suffix:colon
id|harmony_audio_open
comma
id|release
suffix:colon
id|harmony_audio_release
comma
)brace
suffix:semicolon
DECL|function|harmony_audio_init
r_static
r_int
id|harmony_audio_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Request that IRQ */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|harmony.irq
comma
id|harmony_interrupt
comma
l_int|0
comma
l_string|&quot;harmony&quot;
comma
op_amp
id|harmony
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Error requesting irq %d.&bslash;n&quot;
comma
id|harmony.irq
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|harmony.dsp_unit
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|harmony_audio_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|harmony.dsp_unit
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Error registering dsp&bslash;n&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|harmony.irq
comma
op_amp
id|harmony
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* Clear the buffers so you don&squot;t end up with crap in the buffers. */
id|harmony_silence
c_func
(paren
op_amp
id|played_buf
comma
l_int|0
comma
id|HARMONY_BUF_SIZE
op_star
id|MAX_BUFS
)paren
suffix:semicolon
multiline_comment|/* Make sure this makes it to cache */
id|CHECK_WBACK_INV_OFFSET
c_func
(paren
id|played_buf
comma
l_int|0
comma
id|HARMONY_BUF_SIZE
op_star
id|MAX_BUFS
)paren
suffix:semicolon
multiline_comment|/* Clear out the silent buffer and flush to cache */
id|harmony_silence
c_func
(paren
op_amp
id|silent
comma
l_int|0
comma
id|HARMONY_BUF_SIZE
)paren
suffix:semicolon
id|CHECK_WBACK_INV_OFFSET
c_func
(paren
id|silent
comma
l_int|0
comma
id|HARMONY_BUF_SIZE
)paren
suffix:semicolon
id|harmony.audio_open
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * mixer functions &n; */
DECL|function|harmony_mixer_set_gain
r_static
r_void
id|harmony_mixer_set_gain
c_func
(paren
r_void
)paren
(brace
id|harmony_wait_CNTL
c_func
(paren
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
id|harmony.current_gain
comma
op_amp
id|harmony.hpa-&gt;gainctl
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; *  Read gain of selected channel.&n; *  The OSS rate is from 0 (silent) to 100 -&gt; need some conversions&n; *&n; *  The harmony gain are attenuation for output and monitor gain.&n; *                   is amplifaction for input gain&n; */
DECL|macro|to_harmony_level
mdefine_line|#define to_harmony_level(level,max) ((level)*max/100)
DECL|macro|to_oss_level
mdefine_line|#define to_oss_level(level,max) ((level)*100/max)
DECL|function|harmony_mixer_get_level
r_static
r_int
id|harmony_mixer_get_level
c_func
(paren
r_int
id|channel
)paren
(brace
r_int
id|left_level
suffix:semicolon
r_int
id|right_level
suffix:semicolon
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
id|SOUND_MIXER_OGAIN
suffix:colon
id|left_level
op_assign
(paren
id|harmony.current_gain
op_amp
id|GAIN_LO_MASK
)paren
op_rshift
id|GAIN_LO_SHIFT
suffix:semicolon
id|right_level
op_assign
(paren
id|harmony.current_gain
op_amp
id|GAIN_RO_MASK
)paren
op_rshift
id|GAIN_RO_SHIFT
suffix:semicolon
id|left_level
op_assign
id|to_oss_level
c_func
(paren
id|MAX_OUTPUT_LEVEL
op_minus
id|left_level
comma
id|MAX_OUTPUT_LEVEL
)paren
suffix:semicolon
id|right_level
op_assign
id|to_oss_level
c_func
(paren
id|MAX_OUTPUT_LEVEL
op_minus
id|right_level
comma
id|MAX_OUTPUT_LEVEL
)paren
suffix:semicolon
r_return
(paren
id|right_level
op_lshift
l_int|8
)paren
op_plus
id|left_level
suffix:semicolon
r_case
id|SOUND_MIXER_IGAIN
suffix:colon
id|left_level
op_assign
(paren
id|harmony.current_gain
op_amp
id|GAIN_LI_MASK
)paren
op_rshift
id|GAIN_LI_SHIFT
suffix:semicolon
id|right_level
op_assign
(paren
id|harmony.current_gain
op_amp
id|GAIN_RI_MASK
)paren
op_rshift
id|GAIN_RI_SHIFT
suffix:semicolon
id|left_level
op_assign
id|to_oss_level
c_func
(paren
id|left_level
comma
id|MAX_INPUT_LEVEL
)paren
suffix:semicolon
id|right_level
op_assign
id|to_oss_level
c_func
(paren
id|right_level
comma
id|MAX_INPUT_LEVEL
)paren
suffix:semicolon
r_return
(paren
id|right_level
op_lshift
l_int|8
)paren
op_plus
id|left_level
suffix:semicolon
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
id|left_level
op_assign
(paren
id|harmony.current_gain
op_amp
id|GAIN_MA_MASK
)paren
op_rshift
id|GAIN_MA_SHIFT
suffix:semicolon
id|left_level
op_assign
id|to_oss_level
c_func
(paren
id|MAX_VOLUME_LEVEL
op_minus
id|left_level
comma
id|MAX_VOLUME_LEVEL
)paren
suffix:semicolon
r_return
id|left_level
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * Some conversions for the same reasons.&n; * We give back the new real value(s) due to&n; * the rescale.&n; */
DECL|function|harmony_mixer_set_level
r_static
r_int
id|harmony_mixer_set_level
c_func
(paren
r_int
id|channel
comma
r_int
id|value
)paren
(brace
r_int
id|left_level
suffix:semicolon
r_int
id|right_level
suffix:semicolon
r_int
id|new_left_level
suffix:semicolon
r_int
id|new_right_level
suffix:semicolon
id|right_level
op_assign
(paren
id|value
op_amp
l_int|0x0000ff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|left_level
op_assign
id|value
op_amp
l_int|0x000000ff
suffix:semicolon
r_switch
c_cond
(paren
id|channel
)paren
(brace
r_case
id|SOUND_MIXER_OGAIN
suffix:colon
id|right_level
op_assign
id|to_harmony_level
c_func
(paren
l_int|100
op_minus
id|right_level
comma
id|MAX_OUTPUT_LEVEL
)paren
suffix:semicolon
id|left_level
op_assign
id|to_harmony_level
c_func
(paren
l_int|100
op_minus
id|left_level
comma
id|MAX_OUTPUT_LEVEL
)paren
suffix:semicolon
id|new_right_level
op_assign
id|to_oss_level
c_func
(paren
id|MAX_OUTPUT_LEVEL
op_minus
id|right_level
comma
id|MAX_OUTPUT_LEVEL
)paren
suffix:semicolon
id|new_left_level
op_assign
id|to_oss_level
c_func
(paren
id|MAX_OUTPUT_LEVEL
op_minus
id|left_level
comma
id|MAX_OUTPUT_LEVEL
)paren
suffix:semicolon
id|harmony.current_gain
op_assign
(paren
id|harmony.current_gain
op_amp
op_complement
(paren
id|GAIN_LO_MASK
op_or
id|GAIN_RO_MASK
)paren
)paren
op_or
(paren
id|left_level
op_lshift
id|GAIN_LO_SHIFT
)paren
op_or
(paren
id|right_level
op_lshift
id|GAIN_RO_SHIFT
)paren
suffix:semicolon
id|harmony_mixer_set_gain
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|new_right_level
op_lshift
l_int|8
)paren
op_plus
id|new_left_level
suffix:semicolon
r_case
id|SOUND_MIXER_IGAIN
suffix:colon
id|right_level
op_assign
id|to_harmony_level
c_func
(paren
id|right_level
comma
id|MAX_INPUT_LEVEL
)paren
suffix:semicolon
id|left_level
op_assign
id|to_harmony_level
c_func
(paren
id|left_level
comma
id|MAX_INPUT_LEVEL
)paren
suffix:semicolon
id|new_right_level
op_assign
id|to_oss_level
c_func
(paren
id|right_level
comma
id|MAX_INPUT_LEVEL
)paren
suffix:semicolon
id|new_left_level
op_assign
id|to_oss_level
c_func
(paren
id|left_level
comma
id|MAX_INPUT_LEVEL
)paren
suffix:semicolon
id|harmony.current_gain
op_assign
(paren
id|harmony.current_gain
op_amp
op_complement
(paren
id|GAIN_LI_MASK
op_or
id|GAIN_RI_MASK
)paren
)paren
op_or
(paren
id|left_level
op_lshift
id|GAIN_LI_SHIFT
)paren
op_or
(paren
id|right_level
op_lshift
id|GAIN_RI_SHIFT
)paren
suffix:semicolon
id|harmony_mixer_set_gain
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|new_right_level
op_lshift
l_int|8
)paren
op_plus
id|new_left_level
suffix:semicolon
r_case
id|SOUND_MIXER_VOLUME
suffix:colon
id|left_level
op_assign
id|to_harmony_level
c_func
(paren
l_int|100
op_minus
id|left_level
comma
id|MAX_VOLUME_LEVEL
)paren
suffix:semicolon
id|new_left_level
op_assign
id|to_oss_level
c_func
(paren
id|MAX_VOLUME_LEVEL
op_minus
id|left_level
comma
id|MAX_VOLUME_LEVEL
)paren
suffix:semicolon
id|harmony.current_gain
op_assign
(paren
id|harmony.current_gain
op_amp
op_complement
id|GAIN_MA_MASK
)paren
op_or
(paren
id|left_level
op_lshift
id|GAIN_MA_SHIFT
)paren
suffix:semicolon
id|harmony_mixer_set_gain
c_func
(paren
)paren
suffix:semicolon
r_return
id|new_left_level
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|macro|to_harmony_level
macro_line|#undef to_harmony_level
DECL|macro|to_oss_level
macro_line|#undef to_oss_level
multiline_comment|/* &n; * Return the selected input device (mic or line)&n; */
DECL|function|harmony_mixer_get_recmask
r_static
r_int
id|harmony_mixer_get_recmask
c_func
(paren
r_void
)paren
(brace
r_int
id|current_input_line
suffix:semicolon
id|current_input_line
op_assign
(paren
id|harmony.current_gain
op_amp
id|GAIN_IS_MASK
)paren
op_rshift
id|GAIN_IS_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|current_input_line
)paren
r_return
id|SOUND_MASK_MIC
suffix:semicolon
r_return
id|SOUND_MASK_LINE
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the input (only one at time, arbitrary priority to line in)&n; */
DECL|function|harmony_mixer_set_recmask
r_static
r_int
id|harmony_mixer_set_recmask
c_func
(paren
r_int
id|recmask
)paren
(brace
r_int
id|new_input_line
suffix:semicolon
r_int
id|new_input_mask
suffix:semicolon
r_if
c_cond
(paren
(paren
id|recmask
op_amp
id|SOUND_MASK_LINE
)paren
)paren
(brace
id|new_input_line
op_assign
l_int|0
suffix:semicolon
id|new_input_mask
op_assign
id|SOUND_MASK_LINE
suffix:semicolon
)brace
r_else
(brace
id|new_input_line
op_assign
l_int|1
suffix:semicolon
id|new_input_mask
op_assign
id|SOUND_MASK_MIC
suffix:semicolon
)brace
id|harmony.current_gain
op_assign
(paren
(paren
id|harmony.current_gain
op_amp
op_complement
id|GAIN_IS_MASK
)paren
op_or
(paren
id|new_input_line
op_lshift
id|GAIN_IS_SHIFT
)paren
)paren
suffix:semicolon
id|harmony_mixer_set_gain
c_func
(paren
)paren
suffix:semicolon
r_return
id|new_input_mask
suffix:semicolon
)brace
multiline_comment|/* &n; * give the active outlines&n; */
DECL|function|harmony_mixer_get_outmask
r_static
r_int
id|harmony_mixer_get_outmask
c_func
(paren
r_void
)paren
(brace
r_int
id|outmask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|harmony.current_gain
op_amp
id|GAIN_HE_MASK
)paren
id|outmask
op_or_assign
id|SOUND_MASK_PHONEOUT
suffix:semicolon
r_if
c_cond
(paren
id|harmony.current_gain
op_amp
id|GAIN_LE_MASK
)paren
id|outmask
op_or_assign
id|SOUND_MASK_LINE
suffix:semicolon
r_if
c_cond
(paren
id|harmony.current_gain
op_amp
id|GAIN_SE_MASK
)paren
id|outmask
op_or_assign
id|SOUND_MASK_SPEAKER
suffix:semicolon
r_return
id|outmask
suffix:semicolon
)brace
DECL|function|harmony_mixer_set_outmask
r_static
r_int
id|harmony_mixer_set_outmask
c_func
(paren
r_int
id|outmask
)paren
(brace
r_if
c_cond
(paren
id|outmask
op_amp
id|SOUND_MASK_PHONEOUT
)paren
id|harmony.current_gain
op_or_assign
id|GAIN_HE_MASK
suffix:semicolon
r_else
id|harmony.current_gain
op_and_assign
op_complement
id|GAIN_HE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|outmask
op_amp
id|SOUND_MASK_LINE
)paren
id|harmony.current_gain
op_or_assign
id|GAIN_LE_MASK
suffix:semicolon
r_else
id|harmony.current_gain
op_and_assign
op_complement
id|GAIN_LE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|outmask
op_amp
id|SOUND_MASK_SPEAKER
)paren
id|harmony.current_gain
op_or_assign
id|GAIN_SE_MASK
suffix:semicolon
r_else
id|harmony.current_gain
op_and_assign
op_complement
id|GAIN_SE_MASK
suffix:semicolon
id|harmony_mixer_set_gain
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|outmask
op_amp
(paren
id|SOUND_MASK_PHONEOUT
op_or
id|SOUND_MASK_LINE
op_or
id|SOUND_MASK_SPEAKER
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This code is inspired from sb_mixer.c&n; */
DECL|function|harmony_mixer_ioctl
r_static
r_int
id|harmony_mixer_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|val
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_INFO
)paren
(brace
id|mixer_info
id|info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.id
comma
l_string|&quot;harmony&quot;
comma
r_sizeof
(paren
id|info.id
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|info.name
comma
l_string|&quot;Harmony audio&quot;
comma
r_sizeof
(paren
id|info.name
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|info.modify_counter
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* ? */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|OSS_GETVERSION
)paren
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
multiline_comment|/* read */
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|_SIOC_DIR
c_func
(paren
id|cmd
)paren
op_amp
id|_SIOC_WRITE
)paren
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_CAPS
)paren
suffix:colon
id|ret
op_assign
id|SOUND_CAP_EXCL_INPUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_STEREODEVS
)paren
suffix:colon
id|ret
op_assign
id|SOUND_MASK_IGAIN
op_or
id|SOUND_MASK_OGAIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_RECMASK
)paren
suffix:colon
id|ret
op_assign
id|SOUND_MASK_MIC
op_or
id|SOUND_MASK_LINE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_DEVMASK
)paren
suffix:colon
id|ret
op_assign
id|SOUND_MASK_OGAIN
op_or
id|SOUND_MASK_IGAIN
op_or
id|SOUND_MASK_VOLUME
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_OUTMASK
)paren
suffix:colon
id|ret
op_assign
id|SOUND_MASK_SPEAKER
op_or
id|SOUND_MASK_LINE
op_or
id|SOUND_MASK_PHONEOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_RECSRC
)paren
suffix:colon
id|ret
op_assign
id|harmony_mixer_set_recmask
c_func
(paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_RECSRC
)paren
suffix:colon
id|ret
op_assign
id|harmony_mixer_get_recmask
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_OUTSRC
)paren
suffix:colon
id|ret
op_assign
id|harmony_mixer_set_outmask
c_func
(paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_OUTSRC
)paren
suffix:colon
id|ret
op_assign
id|harmony_mixer_get_outmask
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_OGAIN
)paren
suffix:colon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_IGAIN
)paren
suffix:colon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_VOLUME
)paren
suffix:colon
id|ret
op_assign
id|harmony_mixer_set_level
c_func
(paren
id|cmd
op_amp
l_int|0xff
comma
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_OGAIN
)paren
suffix:colon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_IGAIN
)paren
suffix:colon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_VOLUME
)paren
suffix:colon
id|ret
op_assign
id|harmony_mixer_get_level
c_func
(paren
id|cmd
op_amp
l_int|0xff
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|ret
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|harmony_mixer_open
r_static
r_int
id|harmony_mixer_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|harmony.mixer_open
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|harmony.mixer_open
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|harmony_mixer_release
r_static
r_int
id|harmony_mixer_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|harmony.mixer_open
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|harmony.mixer_open
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|harmony_mixer_fops
r_static
r_struct
id|file_operations
id|harmony_mixer_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
id|no_llseek
comma
id|open
suffix:colon
id|harmony_mixer_open
comma
id|release
suffix:colon
id|harmony_mixer_release
comma
id|ioctl
suffix:colon
id|harmony_mixer_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Mute all the output and reset Harmony.&n; */
DECL|function|harmony_mixer_reset
r_static
r_void
id|__init
id|harmony_mixer_reset
c_func
(paren
r_void
)paren
(brace
id|harmony.current_gain
op_assign
id|GAIN_TOTAL_SILENCE
suffix:semicolon
id|harmony_mixer_set_gain
c_func
(paren
)paren
suffix:semicolon
id|harmony_wait_CNTL
c_func
(paren
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
l_int|1
comma
op_amp
id|harmony.hpa-&gt;reset
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* wait 50 ms */
id|gsc_writel
c_func
(paren
l_int|0
comma
op_amp
id|harmony.hpa-&gt;reset
)paren
suffix:semicolon
id|harmony.current_gain
op_assign
id|GAIN_DEFAULT
suffix:semicolon
id|harmony_mixer_set_gain
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|harmony_mixer_init
r_static
r_int
id|__init
id|harmony_mixer_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Register the device file operations */
id|harmony.mixer_unit
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|harmony_mixer_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|harmony.mixer_unit
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;Error Registering Mixer Driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|harmony_mixer_reset
c_func
(paren
)paren
suffix:semicolon
id|harmony.mixer_open
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * This is the callback that&squot;s called by the inventory hardware code &n; * if it finds a match to the registered driver. &n; */
r_static
r_int
id|__init
DECL|function|harmony_driver_callback
id|harmony_driver_callback
c_func
(paren
r_struct
id|parisc_device
op_star
id|dev
)paren
(brace
id|u8
id|id
suffix:semicolon
id|u8
id|rev
suffix:semicolon
id|u32
id|cntl
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|harmony.hpa
)paren
(brace
multiline_comment|/* We only support one Harmony at this time */
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;driver already registered&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Set the HPA of harmony */
id|harmony.hpa
op_assign
(paren
r_struct
id|harmony_hpa
op_star
)paren
id|dev-&gt;hpa
suffix:semicolon
id|harmony.irq
op_assign
id|dev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|harmony.irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;no irq found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Grab the ID and revision from the device */
id|id
op_assign
id|gsc_readb
c_func
(paren
op_amp
id|harmony.hpa-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id
op_or
l_int|1
)paren
op_ne
l_int|0x15
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;wrong harmony id 0x%02x&bslash;n&quot;
comma
id|id
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|cntl
op_assign
id|gsc_readl
c_func
(paren
op_amp
id|harmony.hpa-&gt;cntl
)paren
suffix:semicolon
id|rev
op_assign
(paren
id|cntl
op_rshift
l_int|20
)paren
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Lasi Harmony Audio driver &quot;
id|HARMONY_VERSION
l_string|&quot;, &quot;
l_string|&quot;h/w id %i, rev. %i at 0x%lx, IRQ %i&bslash;n&quot;
comma
id|id
comma
id|rev
comma
id|dev-&gt;hpa
comma
id|harmony.irq
)paren
suffix:semicolon
multiline_comment|/* Make sure the control bit isn&squot;t set, although I don&squot;t think it &n;&t;   ever is. */
r_if
c_cond
(paren
id|cntl
op_amp
id|CNTL_C
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;CNTL busy&bslash;n&quot;
)paren
suffix:semicolon
id|harmony.hpa
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* a fake pci_dev is needed for pci_* functions under ccio */
id|harmony.fake_pci_dev
op_assign
id|ccio_get_fake
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Initialize the memory buffers */
r_if
c_cond
(paren
id|harmony_alloc_buffer
c_func
(paren
op_amp
id|played_buf
comma
id|MAX_BUFS
)paren
op_logical_or
id|harmony_alloc_buffer
c_func
(paren
op_amp
id|recorded_buf
comma
id|MAX_BUFS
)paren
op_logical_or
id|harmony_alloc_buffer
c_func
(paren
op_amp
id|graveyard
comma
l_int|1
)paren
op_logical_or
id|harmony_alloc_buffer
c_func
(paren
op_amp
id|silent
comma
l_int|1
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
multiline_comment|/* Initialize /dev/mixer and /dev/audio  */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|harmony_mixer_init
c_func
(paren
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|harmony_audio_init
c_func
(paren
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
id|harmony.hpa
op_assign
l_int|0
suffix:semicolon
id|harmony_free_buffer
c_func
(paren
op_amp
id|played_buf
)paren
suffix:semicolon
id|harmony_free_buffer
c_func
(paren
op_amp
id|recorded_buf
)paren
suffix:semicolon
id|harmony_free_buffer
c_func
(paren
op_amp
id|graveyard
)paren
suffix:semicolon
id|harmony_free_buffer
c_func
(paren
op_amp
id|silent
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|harmony_tbl
r_static
r_struct
id|parisc_device_id
id|harmony_tbl
(braket
)braket
op_assign
(brace
multiline_comment|/* { HPHW_FIO, HVERSION_REV_ANY_ID, HVERSION_ANY_ID, 0x0007A }, Bushmaster/Flounder */
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x0007B
)brace
comma
multiline_comment|/* 712/715 Audio */
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x0007E
)brace
comma
multiline_comment|/* Pace Audio */
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x0007F
)brace
comma
multiline_comment|/* Outfield / Coral II */
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|parisc
comma
id|harmony_tbl
)paren
suffix:semicolon
DECL|variable|harmony_driver
r_static
r_struct
id|parisc_driver
id|harmony_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;Lasi Harmony&quot;
comma
id|id_table
suffix:colon
id|harmony_tbl
comma
id|probe
suffix:colon
id|harmony_driver_callback
comma
)brace
suffix:semicolon
DECL|function|init_harmony
r_static
r_int
id|__init
id|init_harmony
c_func
(paren
r_void
)paren
(brace
r_return
id|register_parisc_driver
c_func
(paren
op_amp
id|harmony_driver
)paren
suffix:semicolon
)brace
DECL|function|cleanup_harmony
r_static
r_void
id|__exit
id|cleanup_harmony
c_func
(paren
r_void
)paren
(brace
id|free_irq
c_func
(paren
id|harmony.irq
comma
op_amp
id|harmony
)paren
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|harmony.mixer_unit
)paren
suffix:semicolon
id|unregister_sound_dsp
c_func
(paren
id|harmony.dsp_unit
)paren
suffix:semicolon
id|harmony_free_buffer
c_func
(paren
op_amp
id|played_buf
)paren
suffix:semicolon
id|harmony_free_buffer
c_func
(paren
op_amp
id|recorded_buf
)paren
suffix:semicolon
id|harmony_free_buffer
c_func
(paren
op_amp
id|graveyard
)paren
suffix:semicolon
id|harmony_free_buffer
c_func
(paren
op_amp
id|silent
)paren
suffix:semicolon
id|unregister_parisc_driver
c_func
(paren
op_amp
id|harmony_driver
)paren
suffix:semicolon
)brace
id|EXPORT_NO_SYMBOLS
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alex DeVries &lt;alex@linuxcare.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Harmony sound driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|init_harmony
id|module_init
c_func
(paren
id|init_harmony
)paren
suffix:semicolon
DECL|variable|cleanup_harmony
id|module_exit
c_func
(paren
id|cleanup_harmony
)paren
suffix:semicolon
eof
