multiline_comment|/* (C) 2000 Guenter Geiger &lt;geiger@debian.org&gt;&n;   with copy/pastes from the driver of Winfried Ritsch &lt;ritsch@iem.kug.ac.at&gt;&n;   based on es1370.c&n;&n;&n;&n;   *  10 Jan 2001: 0.1 initial version&n;   *  19 Jan 2001: 0.2 fixed bug in select()&n;   *  27 Apr 2001: 0.3 more than one card usable&n;   *  11 May 2001: 0.4 fixed for SMP, included into kernel source tree&n;   *  17 May 2001: 0.5 draining code didn&squot;t work on new cards&n;   *  18 May 2001: 0.6 remove synchronize_irq() call &n;&n;TODO:&n;   - test more than one card --- done&n;   - check for pci IOREGION (see es1370) in rme96xx_probe ??&n;   - error detection&n;   - mmap interface&n;   - mixer mmap interface&n;   - mixer ioctl&n;   - get rid of noise upon first open (why ??)&n;   - allow multiple open(at least for read)&n;   - allow multiple open for non overlapping regions&n;   - recheck the multiple devices part (offsets of different devices, etc)&n;   - do decent draining in _release --- done&n;   - SMP support&n;*/
macro_line|#ifndef RMEVERSION
DECL|macro|RMEVERSION
mdefine_line|#define RMEVERSION &quot;0.6&quot;
macro_line|#endif
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &quot;rme96xx.h&quot;
DECL|macro|NR_DEVICE
mdefine_line|#define NR_DEVICE 2
DECL|variable|devices
r_static
r_int
id|devices
op_assign
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|devices
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NR_DEVICE
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|devices
comma
l_string|&quot;number of dsp devices allocated by the driver&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Guenter Geiger, geiger@debian.org&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;RME9652/36 &bslash;&quot;Hammerfall&bslash;&quot; Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
DECL|macro|DBG
mdefine_line|#define DBG(x) printk(&quot;RME_DEBUG:&quot;);x
DECL|macro|COMM
mdefine_line|#define COMM(x) printk(&quot;RME_COMM: &quot; x &quot;&bslash;n&quot;);
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(x) while (0) {}
DECL|macro|COMM
mdefine_line|#define COMM(x)
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------------- &n;                        Preporcessor Macros and Definitions&n; --------------------------------------------------------------------------*/
DECL|macro|RME96xx_MAGIC
mdefine_line|#define RME96xx_MAGIC 0x6473
multiline_comment|/* Registers-Space in offsets from base address with 16MByte size */
DECL|macro|RME96xx_IO_EXTENT
mdefine_line|#define RME96xx_IO_EXTENT     16l*1024l*1024l
DECL|macro|RME96xx_CHANNELS_PER_CARD
mdefine_line|#define RME96xx_CHANNELS_PER_CARD 26
multiline_comment|/*                  Write - Register */
multiline_comment|/* 0,4,8,12,16,20,24,28 ... hardware init (erasing fifo-pointer intern) */
DECL|macro|RME96xx_num_of_init_regs
mdefine_line|#define RME96xx_num_of_init_regs   8
DECL|macro|RME96xx_init_buffer
mdefine_line|#define RME96xx_init_buffer       (0/4)
DECL|macro|RME96xx_play_buffer
mdefine_line|#define RME96xx_play_buffer       (32/4)  /* pointer to 26x64kBit RAM from mainboard */
DECL|macro|RME96xx_rec_buffer
mdefine_line|#define RME96xx_rec_buffer        (36/4)  /* pointer to 26x64kBit RAM from mainboard */
DECL|macro|RME96xx_control_register
mdefine_line|#define RME96xx_control_register  (64/4)  /* exact meaning see below */
DECL|macro|RME96xx_irq_clear
mdefine_line|#define RME96xx_irq_clear         (96/4)  /* irq acknowledge */
DECL|macro|RME96xx_time_code
mdefine_line|#define RME96xx_time_code         (100/4) /* if used with alesis adat */
DECL|macro|RME96xx_thru_base
mdefine_line|#define RME96xx_thru_base         (128/4) /* 132...228 Thru for 26 channels */
DECL|macro|RME96xx_thru_channels
mdefine_line|#define RME96xx_thru_channels     RME96xx_CHANNELS_PER_CARD
multiline_comment|/*                     Read Register */
DECL|macro|RME96xx_status_register
mdefine_line|#define RME96xx_status_register    0     /* meaning see below */
multiline_comment|/* Status Register: */
multiline_comment|/* ------------------------------------------------------------------------ */
DECL|macro|RME96xx_IRQ
mdefine_line|#define RME96xx_IRQ          0x0000001 /* IRQ is High if not reset by RMExx_irq_clear */
DECL|macro|RME96xx_lock_2
mdefine_line|#define RME96xx_lock_2       0x0000002 /* ADAT 3-PLL: 1=locked, 0=unlocked */
DECL|macro|RME96xx_lock_1
mdefine_line|#define RME96xx_lock_1       0x0000004 /* ADAT 2-PLL: 1=locked, 0=unlocked */
DECL|macro|RME96xx_lock_0
mdefine_line|#define RME96xx_lock_0       0x0000008 /* ADAT 1-PLL: 1=locked, 0=unlocked */
DECL|macro|RME96xx_fs48
mdefine_line|#define RME96xx_fs48         0x0000010 /* sample rate 0 ...44.1/88.2,  1 ... 48/96 Khz */
DECL|macro|RME96xx_wsel_rd
mdefine_line|#define RME96xx_wsel_rd      0x0000020 /* if Word-Clock is used and valid then 1 */
DECL|macro|RME96xx_buf_pos1
mdefine_line|#define RME96xx_buf_pos1     0x0000040 /* Bit 6..15 : Position of buffer-pointer in 64Bytes-blocks */
DECL|macro|RME96xx_buf_pos2
mdefine_line|#define RME96xx_buf_pos2     0x0000080 /* resolution +/- 1 64Byte/block (since 64Bytes bursts) */
DECL|macro|RME96xx_buf_pos3
mdefine_line|#define RME96xx_buf_pos3     0x0000100 /* 10 bits = 1024 values */
DECL|macro|RME96xx_buf_pos4
mdefine_line|#define RME96xx_buf_pos4     0x0000200 /* if we mask off the first 6 bits, we can take the status */
DECL|macro|RME96xx_buf_pos5
mdefine_line|#define RME96xx_buf_pos5     0x0000400 /* register as sample counter in the hardware buffer */
DECL|macro|RME96xx_buf_pos6
mdefine_line|#define RME96xx_buf_pos6     0x0000800 
DECL|macro|RME96xx_buf_pos7
mdefine_line|#define RME96xx_buf_pos7     0x0001000 
DECL|macro|RME96xx_buf_pos8
mdefine_line|#define RME96xx_buf_pos8     0x0002000 
DECL|macro|RME96xx_buf_pos9
mdefine_line|#define RME96xx_buf_pos9     0x0004000
DECL|macro|RME96xx_buf_pos10
mdefine_line|#define RME96xx_buf_pos10    0x0008000 
DECL|macro|RME96xx_sync_2
mdefine_line|#define RME96xx_sync_2       0x0010000 /* if ADAT-IN3 synced to system clock */
DECL|macro|RME96xx_sync_1
mdefine_line|#define RME96xx_sync_1       0x0020000 /* if ADAT-IN2 synced to system clock */
DECL|macro|RME96xx_sync_0
mdefine_line|#define RME96xx_sync_0       0x0040000 /* if ADAT-IN1 synced to system clock */
DECL|macro|RME96xx_DS_rd
mdefine_line|#define RME96xx_DS_rd        0x0080000 /* 1=Double Speed, 0=Normal Speed */
DECL|macro|RME96xx_tc_busy
mdefine_line|#define RME96xx_tc_busy      0x0100000 /* 1=time-code copy in progress (960ms) */
DECL|macro|RME96xx_tc_out
mdefine_line|#define RME96xx_tc_out       0x0200000 /* time-code out bit */
DECL|macro|RME96xx_F_0
mdefine_line|#define RME96xx_F_0          0x0400000 /*  000=64kHz, 100=88.2kHz, 011=96kHz  */
DECL|macro|RME96xx_F_1
mdefine_line|#define RME96xx_F_1          0x0800000 /*  111=32kHz, 110=44.1kHz, 101=48kHz, */
DECL|macro|RME96xx_F_2
mdefine_line|#define RME96xx_F_2          0x1000000 /*  od external Crystal Chip if ERF=1*/
DECL|macro|RME96xx_ERF
mdefine_line|#define RME96xx_ERF          0x2000000 /* Error-Flag of SDPIF Receiver (1=No Lock)*/
DECL|macro|RME96xx_buffer_id
mdefine_line|#define RME96xx_buffer_id    0x4000000 /* toggles by each interrupt on rec/play */
DECL|macro|RME96xx_tc_valid
mdefine_line|#define RME96xx_tc_valid     0x8000000 /* 1 = a signal is detected on time-code input */
multiline_comment|/* Status Register Fields */
DECL|macro|RME96xx_lock
mdefine_line|#define RME96xx_lock            (RME96xx_lock_0|RME96xx_lock_1|RME96xx_lock_2)
DECL|macro|RME96xx_buf_pos
mdefine_line|#define RME96xx_buf_pos          0x000FFC0 
DECL|macro|RME96xx_sync
mdefine_line|#define RME96xx_sync            (RME96xx_sync_0|RME96xx_sync_1|RME96xx_sync_2)
DECL|macro|RME96xx_F
mdefine_line|#define RME96xx_F               (RME96xx_F_0|RME96xx_F_1|RME96xx_F_2)
multiline_comment|/* Control-Register: */
multiline_comment|/*--------------------------------------------------------------------------------*/
DECL|macro|RME96xx_start_bit
mdefine_line|#define RME96xx_start_bit&t;   0x0001    /* start record/play */
DECL|macro|RME96xx_latency0
mdefine_line|#define RME96xx_latency0&t;   0x0002    /* Bit 0 -  Buffer size or latency */
DECL|macro|RME96xx_latency1
mdefine_line|#define RME96xx_latency1&t;   0x0004    /* Bit 1 - Buffer size or latency */
DECL|macro|RME96xx_latency2
mdefine_line|#define RME96xx_latency2&t;   0x0008    /* Bit 2 - Buffer size or latency */
DECL|macro|RME96xx_Master
mdefine_line|#define RME96xx_Master&t;&t;   0x0010   /* Clock Mode Master=1,Slave/Auto=0 */
DECL|macro|RME96xx_IE
mdefine_line|#define RME96xx_IE&t;&t;   0x0020   /* Interupt Enable */
DECL|macro|RME96xx_freq
mdefine_line|#define RME96xx_freq&t;&t;   0x0040   /* samplerate 0=44.1/88.2, 1=48/96 kHz*/
DECL|macro|RME96xx_DS
mdefine_line|#define RME96xx_DS                 0x0100   /* Doule Speed 0=44.1/48, 1=88.2/96 Khz */
DECL|macro|RME96xx_PRO
mdefine_line|#define RME96xx_PRO&t;&t;   0x0200    /* spdif 0=consumer, 1=professional Mode*/
DECL|macro|RME96xx_EMP
mdefine_line|#define RME96xx_EMP&t;&t;   0x0400    /* spdif Emphasis 0=None, 1=ON */
DECL|macro|RME96xx_Dolby
mdefine_line|#define RME96xx_Dolby&t;&t;   0x0800    /* spdif Non-audio bit 1=set, 0=unset */
DECL|macro|RME96xx_opt_out
mdefine_line|#define RME96xx_opt_out&t;           0x1000  /* Use 1st optical OUT as SPDIF: 1=yes,0=no */
DECL|macro|RME96xx_wsel
mdefine_line|#define RME96xx_wsel               0x2000  /* use Wordclock as sync (overwrites master)*/
DECL|macro|RME96xx_inp_0
mdefine_line|#define RME96xx_inp_0              0x4000  /* SPDIF-IN: 00=optical (ADAT1),     */
DECL|macro|RME96xx_inp_1
mdefine_line|#define RME96xx_inp_1              0x8000  /* 01=koaxial (Cinch), 10=Internal CDROM*/
DECL|macro|RME96xx_SyncRef0
mdefine_line|#define RME96xx_SyncRef0           0x10000  /* preferred sync-source in autosync */
DECL|macro|RME96xx_SyncRef1
mdefine_line|#define RME96xx_SyncRef1           0x20000  /* 00=ADAT1,01=ADAT2,10=ADAT3,11=SPDIF */
DECL|macro|RME96xx_ctrl_init
mdefine_line|#define RME96xx_ctrl_init            (RME96xx_latency0 |&bslash;&n;                                     RME96xx_Master |&bslash;&n;                                     RME96xx_inp_1)
multiline_comment|/* Control register fields and shortcuts */
DECL|macro|RME96xx_latency
mdefine_line|#define RME96xx_latency (RME96xx_latency0|RME96xx_latency1|RME96xx_latency2)
DECL|macro|RME96xx_inp
mdefine_line|#define RME96xx_inp         (RME96xx_inp_0|RME96xx_inp_1)
DECL|macro|RME96xx_SyncRef
mdefine_line|#define RME96xx_SyncRef    (RME96xx_SyncRef0|RME96xx_SyncRef1)
multiline_comment|/* latency = 512Bytes * 2^n, where n is made from Bit3 ... Bit0 */
DECL|macro|RME96xx_SET_LATENCY
mdefine_line|#define RME96xx_SET_LATENCY(x)   (((x)&amp;0x7)&lt;&lt;1)
DECL|macro|RME96xx_GET_LATENCY
mdefine_line|#define RME96xx_GET_LATENCY(x)   (((x)&gt;&gt;1)&amp;0x7)
DECL|macro|RME96xx_SET_inp
mdefine_line|#define RME96xx_SET_inp(x) (((x)&amp;0x3)&lt;&lt;14)
DECL|macro|RME96xx_GET_inp
mdefine_line|#define RME96xx_GET_inp(x)   (((x)&gt;&gt;14)&amp;0x3)
DECL|macro|RME96xx_SET_SyncRef
mdefine_line|#define RME96xx_SET_SyncRef(x) (((x)&amp;0x3)&lt;&lt;17)
DECL|macro|RME96xx_GET_SyncRef
mdefine_line|#define RME96xx_GET_SyncRef(x)   (((x)&gt;&gt;17)&amp;0x3)
multiline_comment|/* buffer sizes */
DECL|macro|RME96xx_BYTES_PER_SAMPLE
mdefine_line|#define RME96xx_BYTES_PER_SAMPLE  4 /* sizeof(u32) */
DECL|macro|RME_16K
mdefine_line|#define RME_16K 16*1024
DECL|macro|RME96xx_DMA_MAX_SAMPLES
mdefine_line|#define RME96xx_DMA_MAX_SAMPLES  (RME_16K)
DECL|macro|RME96xx_DMA_MAX_SIZE
mdefine_line|#define RME96xx_DMA_MAX_SIZE     (RME_16K * RME96xx_BYTES_PER_SAMPLE)
DECL|macro|RME96xx_DMA_MAX_SIZE_ALL
mdefine_line|#define RME96xx_DMA_MAX_SIZE_ALL (RME96xx_DMA_MAX_SIZE * RME96xx_CHANNELS_PER_CARD)
DECL|macro|RME96xx_NUM_OF_FRAGMENTS
mdefine_line|#define RME96xx_NUM_OF_FRAGMENTS     2
DECL|macro|RME96xx_FRAGMENT_MAX_SIZE
mdefine_line|#define RME96xx_FRAGMENT_MAX_SIZE    (RME96xx_DMA_MAX_SIZE/2)
DECL|macro|RME96xx_FRAGMENT_MAX_SAMPLES
mdefine_line|#define RME96xx_FRAGMENT_MAX_SAMPLES (RME96xx_DMA_MAX_SAMPLES/2)
DECL|macro|RME96xx_MAX_LATENCY
mdefine_line|#define RME96xx_MAX_LATENCY       7   /* 16k samples */
DECL|macro|RME96xx_MAX_DEVS
mdefine_line|#define RME96xx_MAX_DEVS 4 /* we provide some OSS stereodevs */
DECL|macro|RME_MESS
mdefine_line|#define RME_MESS &quot;rme96xx:&quot;
multiline_comment|/*------------------------------------------------------------------------ &n;                  Types, struct and function declarations &n; ------------------------------------------------------------------------*/
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|invalid_magic
r_static
r_const
r_char
id|invalid_magic
(braket
)braket
op_assign
id|KERN_CRIT
id|RME_MESS
l_string|&quot; invalid magic value&bslash;n&quot;
suffix:semicolon
DECL|macro|VALIDATE_STATE
mdefine_line|#define VALIDATE_STATE(s)                         &bslash;&n;({                                                &bslash;&n;&t;if (!(s) || (s)-&gt;magic != RME96xx_MAGIC) { &bslash;&n;&t;&t;printk(invalid_magic);            &bslash;&n;&t;&t;return -ENXIO;                    &bslash;&n;&t;}                                         &bslash;&n;})
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|rme96xx_audio_fops
r_static
r_struct
id|file_operations
id|rme96xx_audio_fops
suffix:semicolon
DECL|variable|rme96xx_mixer_fops
r_static
r_struct
id|file_operations
id|rme96xx_mixer_fops
suffix:semicolon
DECL|variable|numcards
r_static
r_int
id|numcards
suffix:semicolon
DECL|typedef|raw_sample_t
r_typedef
r_int32
id|raw_sample_t
suffix:semicolon
DECL|struct|_rme96xx_info
r_typedef
r_struct
id|_rme96xx_info
(brace
multiline_comment|/* hardware settings */
DECL|member|magic
r_int
id|magic
suffix:semicolon
DECL|member|pcidev
r_struct
id|pci_dev
op_star
id|pcidev
suffix:semicolon
multiline_comment|/* pci_dev structure */
DECL|member|iobase
r_int
r_int
op_star
id|iobase
suffix:semicolon
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
multiline_comment|/* list of rme96xx devices */
DECL|member|devs
r_struct
id|list_head
id|devs
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|recbuf
id|u32
op_star
id|recbuf
suffix:semicolon
multiline_comment|/* memory for rec buffer */
DECL|member|playbuf
id|u32
op_star
id|playbuf
suffix:semicolon
multiline_comment|/* memory for play buffer */
DECL|member|control_register
id|u32
id|control_register
suffix:semicolon
DECL|member|thru_bits
id|u32
id|thru_bits
suffix:semicolon
multiline_comment|/* thru 1=on, 0=off channel 1=Bit1... channel 26= Bit26 */
DECL|member|open_count
r_int
id|open_count
suffix:semicolon
DECL|member|rate
r_int
id|rate
suffix:semicolon
DECL|member|latency
r_int
id|latency
suffix:semicolon
DECL|member|fragsize
r_int
r_int
id|fragsize
suffix:semicolon
DECL|member|started
r_int
id|started
suffix:semicolon
DECL|member|hwptr
r_int
id|hwptr
suffix:semicolon
multiline_comment|/* can be negativ because of pci burst offset  */
DECL|member|hwbufid
r_int
r_int
id|hwbufid
suffix:semicolon
multiline_comment|/* set by interrupt, buffer which is written/read now */
DECL|struct|dmabuf
r_struct
id|dmabuf
(brace
DECL|member|format
r_int
r_int
id|format
suffix:semicolon
DECL|member|formatshift
r_int
id|formatshift
suffix:semicolon
DECL|member|inchannels
r_int
id|inchannels
suffix:semicolon
multiline_comment|/* number of channels for device */
DECL|member|outchannels
r_int
id|outchannels
suffix:semicolon
multiline_comment|/* number of channels for device */
DECL|member|mono
r_int
id|mono
suffix:semicolon
multiline_comment|/* if true, we play mono on 2 channels */
DECL|member|inoffset
r_int
id|inoffset
suffix:semicolon
multiline_comment|/* which channel is considered the first one */
DECL|member|outoffset
r_int
id|outoffset
suffix:semicolon
multiline_comment|/* state */
DECL|member|opened
r_int
id|opened
suffix:semicolon
multiline_comment|/* open() made */
DECL|member|started
r_int
id|started
suffix:semicolon
multiline_comment|/* first write/read */
DECL|member|mmapped
r_int
id|mmapped
suffix:semicolon
multiline_comment|/* mmap */
DECL|member|open_mode
r_int
id|open_mode
suffix:semicolon
DECL|member|s
r_struct
id|_rme96xx_info
op_star
id|s
suffix:semicolon
multiline_comment|/* pointer to read/write position in buffer */
DECL|member|readptr
r_int
id|readptr
suffix:semicolon
DECL|member|writeptr
r_int
id|writeptr
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
multiline_comment|/* over/underruns cleared on sync again */
multiline_comment|/* waiting and locking */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
DECL|member|open_wait
id|wait_queue_head_t
id|open_wait
suffix:semicolon
DECL|member|dma
)brace
id|dma
(braket
id|RME96xx_MAX_DEVS
)braket
suffix:semicolon
DECL|member|dspnum
r_int
id|dspnum
(braket
id|RME96xx_MAX_DEVS
)braket
suffix:semicolon
multiline_comment|/* register with sound subsystem */
DECL|member|mixer
r_int
id|mixer
suffix:semicolon
multiline_comment|/* register with sound subsystem */
DECL|typedef|rme96xx_info
)brace
id|rme96xx_info
suffix:semicolon
multiline_comment|/* fiddling with the card (first level hardware control) */
DECL|function|rme96xx_set_ctrl
r_inline
r_void
id|rme96xx_set_ctrl
c_func
(paren
id|rme96xx_info
op_star
id|s
comma
r_int
id|mask
)paren
(brace
id|s-&gt;control_register
op_or_assign
id|mask
suffix:semicolon
id|writel
c_func
(paren
id|s-&gt;control_register
comma
id|s-&gt;iobase
op_plus
id|RME96xx_control_register
)paren
suffix:semicolon
)brace
DECL|function|rme96xx_unset_ctrl
r_inline
r_void
id|rme96xx_unset_ctrl
c_func
(paren
id|rme96xx_info
op_star
id|s
comma
r_int
id|mask
)paren
(brace
id|s-&gt;control_register
op_and_assign
(paren
op_complement
id|mask
)paren
suffix:semicolon
id|writel
c_func
(paren
id|s-&gt;control_register
comma
id|s-&gt;iobase
op_plus
id|RME96xx_control_register
)paren
suffix:semicolon
)brace
multiline_comment|/* the hwbuf in the status register seems to have some jitter, to get rid of&n;   it, we first only let the numbers grow, to be on the secure side we &n;   subtract a certain amount RME96xx_BURSTBYTES from the resulting number */
multiline_comment|/* the function returns the hardware pointer in bytes */
DECL|macro|RME96xx_BURSTBYTES
mdefine_line|#define RME96xx_BURSTBYTES -64  /* bytes by which hwptr could be off */
DECL|function|rme96xx_gethwptr
r_inline
r_int
id|rme96xx_gethwptr
c_func
(paren
id|rme96xx_info
op_star
id|s
comma
r_int
id|exact
)paren
(brace
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|exact
)paren
(brace
r_int
r_int
id|hwp
suffix:semicolon
multiline_comment|/* the hwptr seems to be rather unreliable :(, so we don&squot;t use it */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hwp
op_assign
id|readl
c_func
(paren
id|s-&gt;iobase
op_plus
id|RME96xx_status_register
)paren
op_amp
l_int|0xffc0
suffix:semicolon
id|s-&gt;hwptr
op_assign
(paren
id|hwp
OL
id|s-&gt;hwptr
)paren
ques
c_cond
id|s-&gt;hwptr
suffix:colon
id|hwp
suffix:semicolon
singleline_comment|//&t;&t;s-&gt;hwptr = hwp;
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|s-&gt;hwptr
op_plus
id|RME96xx_BURSTBYTES
)paren
op_amp
(paren
(paren
id|s-&gt;fragsize
op_lshift
l_int|1
)paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
(paren
id|s-&gt;hwbufid
ques
c_cond
id|s-&gt;fragsize
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|rme96xx_setlatency
r_inline
r_void
id|rme96xx_setlatency
c_func
(paren
id|rme96xx_info
op_star
id|s
comma
r_int
id|l
)paren
(brace
id|s-&gt;latency
op_assign
id|l
suffix:semicolon
id|s-&gt;fragsize
op_assign
l_int|1
op_lshift
(paren
l_int|8
op_plus
id|l
)paren
suffix:semicolon
id|rme96xx_unset_ctrl
c_func
(paren
id|s
comma
id|RME96xx_latency
)paren
suffix:semicolon
id|rme96xx_set_ctrl
c_func
(paren
id|s
comma
id|RME96xx_SET_LATENCY
c_func
(paren
id|l
)paren
)paren
suffix:semicolon
)brace
DECL|function|rme96xx_clearbufs
r_static
r_void
id|rme96xx_clearbufs
c_func
(paren
r_struct
id|dmabuf
op_star
id|dma
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* clear dmabufs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devices
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|dma-&gt;outchannels
op_plus
id|dma-&gt;mono
suffix:semicolon
id|j
op_increment
)paren
id|memset
c_func
(paren
op_amp
id|dma-&gt;s-&gt;playbuf
(braket
(paren
id|dma-&gt;outoffset
op_plus
id|j
)paren
op_star
id|RME96xx_DMA_MAX_SAMPLES
)braket
comma
l_int|0
comma
id|RME96xx_DMA_MAX_SIZE
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dma-&gt;s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dma-&gt;writeptr
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;readptr
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dma-&gt;s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|rme96xx_startcard
r_static
r_int
id|rme96xx_startcard
c_func
(paren
id|rme96xx_info
op_star
id|s
comma
r_int
id|stop
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|COMM
(paren
l_string|&quot;startcard&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;control_register
op_amp
id|RME96xx_IE
)paren
(brace
multiline_comment|/* disable interrupt first */
id|rme96xx_unset_ctrl
c_func
(paren
id|s
comma
id|RME96xx_start_bit
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|rme96xx_unset_ctrl
c_func
(paren
id|s
comma
id|RME96xx_IE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* timing is critical */
id|s-&gt;started
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stop
)paren
(brace
id|COMM
c_func
(paren
l_string|&quot;Sound card stopped&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
id|COMM
(paren
l_string|&quot;interupt disabled&quot;
)paren
suffix:semicolon
multiline_comment|/* first initialize all pointers on card */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RME96xx_num_of_init_regs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writel
c_func
(paren
l_int|0
comma
id|s-&gt;iobase
op_plus
id|i
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* ?? */
)brace
id|COMM
(paren
l_string|&quot;regs cleaned&quot;
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* timing is critical */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|s-&gt;started
op_assign
l_int|1
suffix:semicolon
id|s-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rme96xx_set_ctrl
c_func
(paren
id|s
comma
id|RME96xx_IE
op_or
id|RME96xx_start_bit
)paren
suffix:semicolon
id|COMM
c_func
(paren
l_string|&quot;Sound card started&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|rme96xx_getospace
r_inline
r_int
id|rme96xx_getospace
c_func
(paren
r_struct
id|dmabuf
op_star
id|dma
comma
r_int
r_int
id|hwp
)paren
(brace
r_int
id|cnt
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dma-&gt;s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|swptr
op_assign
id|dma-&gt;writeptr
suffix:semicolon
id|cnt
op_assign
(paren
id|hwp
op_minus
id|swptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
l_int|0
)paren
(brace
id|cnt
op_assign
(paren
(paren
id|dma-&gt;s-&gt;fragsize
op_lshift
l_int|1
)paren
op_minus
id|swptr
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dma-&gt;s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|cnt
suffix:semicolon
)brace
DECL|function|rme96xx_getispace
r_inline
r_int
id|rme96xx_getispace
c_func
(paren
r_struct
id|dmabuf
op_star
id|dma
comma
r_int
r_int
id|hwp
)paren
(brace
r_int
id|cnt
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dma-&gt;s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|swptr
op_assign
id|dma-&gt;readptr
suffix:semicolon
id|cnt
op_assign
(paren
id|hwp
op_minus
id|swptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
l_int|0
)paren
(brace
id|cnt
op_assign
(paren
(paren
id|dma-&gt;s-&gt;fragsize
op_lshift
l_int|1
)paren
op_minus
id|swptr
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dma-&gt;s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|cnt
suffix:semicolon
)brace
DECL|function|rme96xx_copyfromuser
r_inline
r_int
id|rme96xx_copyfromuser
c_func
(paren
r_struct
id|dmabuf
op_star
id|dma
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
r_int
id|hop
)paren
(brace
r_int
id|swptr
op_assign
id|dma-&gt;writeptr
suffix:semicolon
r_switch
c_cond
(paren
id|dma-&gt;format
)paren
(brace
r_case
id|AFMT_S32_BLOCKED
suffix:colon
(brace
r_char
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|buffer
suffix:semicolon
r_int
id|cnt
op_assign
id|count
op_div
id|dma-&gt;outchannels
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;outchannels
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|hwbuf
op_assign
(paren
r_char
op_star
)paren
op_amp
id|dma-&gt;s-&gt;playbuf
(braket
(paren
id|dma-&gt;outoffset
op_plus
id|i
)paren
op_star
id|RME96xx_DMA_MAX_SAMPLES
)braket
suffix:semicolon
id|hwbuf
op_add_assign
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|hwbuf
comma
id|buf
comma
id|cnt
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|buf
op_add_assign
id|hop
suffix:semicolon
)brace
id|swptr
op_add_assign
id|cnt
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|AFMT_S16_LE
suffix:colon
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|cnt
op_assign
id|count
op_div
id|dma-&gt;outchannels
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;outchannels
op_plus
id|dma-&gt;mono
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
op_star
id|sbuf
op_assign
(paren
r_int
op_star
)paren
id|buffer
op_plus
id|i
op_star
(paren
op_logical_neg
id|dma-&gt;mono
)paren
suffix:semicolon
r_int
op_star
id|hwbuf
op_assign
(paren
r_int
op_star
)paren
op_amp
id|dma-&gt;s-&gt;playbuf
(braket
(paren
id|dma-&gt;outoffset
op_plus
id|i
)paren
op_star
id|RME96xx_DMA_MAX_SAMPLES
)braket
suffix:semicolon
id|hwbuf
op_add_assign
(paren
id|swptr
op_rshift
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|cnt
op_rshift
l_int|1
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
id|hwbuf
op_increment
suffix:semicolon
multiline_comment|/* skip the low 16 bits */
id|__get_user
c_func
(paren
op_star
id|hwbuf
op_increment
comma
id|sbuf
op_increment
)paren
suffix:semicolon
id|sbuf
op_add_assign
(paren
id|dma-&gt;outchannels
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|swptr
op_add_assign
(paren
id|cnt
op_lshift
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
c_func
(paren
id|RME_MESS
l_string|&quot; unsupported format&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* switch */
id|swptr
op_and_assign
(paren
(paren
id|dma-&gt;s-&gt;fragsize
op_lshift
l_int|1
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|dma-&gt;writeptr
op_assign
id|swptr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The count argument is the number of bytes */
DECL|function|rme96xx_copytouser
r_inline
r_int
id|rme96xx_copytouser
c_func
(paren
r_struct
id|dmabuf
op_star
id|dma
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
r_int
id|hop
)paren
(brace
r_int
id|swptr
op_assign
id|dma-&gt;readptr
suffix:semicolon
r_switch
c_cond
(paren
id|dma-&gt;format
)paren
(brace
r_case
id|AFMT_S32_BLOCKED
suffix:colon
(brace
r_char
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|buffer
suffix:semicolon
r_int
id|cnt
op_assign
id|count
op_div
id|dma-&gt;inchannels
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;inchannels
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|hwbuf
op_assign
(paren
r_char
op_star
)paren
op_amp
id|dma-&gt;s-&gt;recbuf
(braket
(paren
id|dma-&gt;inoffset
op_plus
id|i
)paren
op_star
id|RME96xx_DMA_MAX_SAMPLES
)braket
suffix:semicolon
id|hwbuf
op_add_assign
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|hwbuf
comma
id|cnt
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|buf
op_add_assign
id|hop
suffix:semicolon
)brace
id|swptr
op_add_assign
id|cnt
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|AFMT_S16_LE
suffix:colon
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_int
id|cnt
op_assign
id|count
op_div
id|dma-&gt;inchannels
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;inchannels
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
op_star
id|sbuf
op_assign
(paren
r_int
op_star
)paren
id|buffer
op_plus
id|i
suffix:semicolon
r_int
op_star
id|hwbuf
op_assign
(paren
r_int
op_star
)paren
op_amp
id|dma-&gt;s-&gt;recbuf
(braket
(paren
id|dma-&gt;inoffset
op_plus
id|i
)paren
op_star
id|RME96xx_DMA_MAX_SAMPLES
)braket
suffix:semicolon
id|hwbuf
op_add_assign
(paren
id|swptr
op_rshift
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|cnt
op_rshift
l_int|1
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
id|hwbuf
op_increment
suffix:semicolon
id|__put_user
c_func
(paren
op_star
id|hwbuf
op_increment
comma
id|sbuf
op_increment
)paren
suffix:semicolon
id|sbuf
op_add_assign
(paren
id|dma-&gt;inchannels
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|swptr
op_add_assign
(paren
id|cnt
op_lshift
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|printk
c_func
(paren
id|RME_MESS
l_string|&quot; unsupported format&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* switch */
id|swptr
op_and_assign
(paren
(paren
id|dma-&gt;s-&gt;fragsize
op_lshift
l_int|1
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|dma-&gt;readptr
op_assign
id|swptr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rme96xx_interrupt
r_static
r_void
id|rme96xx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
id|rme96xx_info
op_star
id|s
op_assign
(paren
id|rme96xx_info
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|dmabuf
op_star
id|db
suffix:semicolon
id|u32
id|status
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|status
op_assign
id|readl
c_func
(paren
id|s-&gt;iobase
op_plus
id|RME96xx_status_register
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|RME96xx_IRQ
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|s-&gt;iobase
op_plus
id|RME96xx_irq_clear
)paren
suffix:semicolon
id|s-&gt;hwbufid
op_assign
(paren
id|status
op_amp
id|RME96xx_buffer_id
)paren
op_rshift
l_int|26
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xffc0
)paren
op_le
l_int|256
)paren
id|s-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|db
op_assign
op_amp
(paren
id|s-&gt;dma
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;started
OG
l_int|0
)paren
(brace
id|wake_up
c_func
(paren
op_amp
(paren
id|db-&gt;wait
)paren
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------- &n; PCI detection and module initialization stuff &n; ----------------------------------------------------------------------------*/
DECL|function|busmaster_malloc
r_void
op_star
id|busmaster_malloc
c_func
(paren
r_int
id|size
)paren
(brace
r_int
id|pg
suffix:semicolon
multiline_comment|/* 2 s exponent of memory size */
r_char
op_star
id|buf
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;kernel malloc pages ..&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pg
op_assign
l_int|0
suffix:semicolon
id|PAGE_SIZE
op_star
(paren
l_int|1
op_lshift
id|pg
)paren
OL
id|size
suffix:semicolon
id|pg
op_increment
)paren
suffix:semicolon
id|buf
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
id|pg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
(brace
r_struct
id|page
op_star
id|page
comma
op_star
id|last_page
suffix:semicolon
id|page
op_assign
id|virt_to_page
c_func
(paren
id|buf
)paren
suffix:semicolon
id|last_page
op_assign
id|virt_to_page
c_func
(paren
id|buf
op_plus
(paren
l_int|1
op_lshift
id|pg
)paren
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;setting reserved bit&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|page
OL
id|last_page
)paren
(brace
id|SetPageReserved
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_increment
suffix:semicolon
)brace
r_return
id|buf
suffix:semicolon
)brace
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;allocated %ld&quot;
comma
(paren
r_int
)paren
id|buf
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|busmaster_free
r_void
id|busmaster_free
c_func
(paren
r_void
op_star
id|ptr
comma
r_int
id|size
)paren
(brace
r_int
id|pg
suffix:semicolon
r_struct
id|page
op_star
id|page
comma
op_star
id|last_page
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|pg
op_assign
l_int|0
suffix:semicolon
id|PAGE_SIZE
op_star
(paren
l_int|1
op_lshift
id|pg
)paren
OL
id|size
suffix:semicolon
id|pg
op_increment
)paren
suffix:semicolon
id|page
op_assign
id|virt_to_page
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|last_page
op_assign
id|page
op_plus
(paren
l_int|1
op_lshift
id|pg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|page
OL
id|last_page
)paren
(brace
id|ClearPageReserved
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_increment
suffix:semicolon
)brace
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;freeing pages&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ptr
comma
id|pg
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize those parts of the info structure which are not pci detectable resources */
DECL|function|rme96xx_dmabuf_init
r_static
r_int
id|rme96xx_dmabuf_init
c_func
(paren
id|rme96xx_info
op_star
id|s
comma
r_struct
id|dmabuf
op_star
id|dma
comma
r_int
id|ioffset
comma
r_int
id|ooffset
)paren
(brace
id|init_MUTEX
c_func
(paren
op_amp
id|dma-&gt;open_sem
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dma-&gt;open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dma-&gt;wait
)paren
suffix:semicolon
id|dma-&gt;s
op_assign
id|s
suffix:semicolon
id|dma-&gt;error
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;format
op_assign
id|AFMT_S32_BLOCKED
suffix:semicolon
id|dma-&gt;formatshift
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;inchannels
op_assign
id|dma-&gt;outchannels
op_assign
l_int|1
suffix:semicolon
id|dma-&gt;inoffset
op_assign
id|ioffset
suffix:semicolon
id|dma-&gt;outoffset
op_assign
id|ooffset
suffix:semicolon
id|dma-&gt;opened
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;started
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;mmapped
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;open_mode
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;mono
op_assign
l_int|0
suffix:semicolon
id|rme96xx_clearbufs
c_func
(paren
id|dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rme96xx_init
r_int
id|rme96xx_init
c_func
(paren
id|rme96xx_info
op_star
id|s
)paren
(brace
r_int
id|i
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|numcards
op_increment
suffix:semicolon
id|s-&gt;magic
op_assign
id|RME96xx_MAGIC
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|s-&gt;lock
)paren
suffix:semicolon
id|COMM
(paren
l_string|&quot;setup busmaster memory&quot;
)paren
id|s-&gt;recbuf
op_assign
id|busmaster_malloc
c_func
(paren
id|RME96xx_DMA_MAX_SIZE_ALL
)paren
suffix:semicolon
id|s-&gt;playbuf
op_assign
id|busmaster_malloc
c_func
(paren
id|RME96xx_DMA_MAX_SIZE_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;recbuf
op_logical_or
op_logical_neg
id|s-&gt;playbuf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|RME_MESS
l_string|&quot; Unable to allocate busmaster memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|COMM
(paren
l_string|&quot;setting rec and playbuffers&quot;
)paren
id|writel
c_func
(paren
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|s-&gt;recbuf
)paren
comma
id|s-&gt;iobase
op_plus
id|RME96xx_rec_buffer
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|u32
)paren
id|virt_to_bus
c_func
(paren
id|s-&gt;playbuf
)paren
comma
id|s-&gt;iobase
op_plus
id|RME96xx_play_buffer
)paren
suffix:semicolon
id|COMM
(paren
l_string|&quot;initializing control register&quot;
)paren
id|rme96xx_unset_ctrl
c_func
(paren
id|s
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|rme96xx_set_ctrl
c_func
(paren
id|s
comma
id|RME96xx_ctrl_init
)paren
suffix:semicolon
id|COMM
(paren
l_string|&quot;setup devices&quot;
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devices
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dmabuf
op_star
id|dma
op_assign
op_amp
id|s-&gt;dma
(braket
id|i
)braket
suffix:semicolon
id|rme96xx_dmabuf_init
c_func
(paren
id|s
comma
id|dma
comma
l_int|2
op_star
id|i
comma
l_int|2
op_star
id|i
)paren
suffix:semicolon
)brace
id|s-&gt;started
op_assign
l_int|0
suffix:semicolon
id|rme96xx_setlatency
c_func
(paren
id|s
comma
l_int|7
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|RME_MESS
l_string|&quot; card %d initialized&bslash;n&quot;
comma
id|numcards
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* open uses this to figure out which device was opened .. this seems to be &n;   unnecessary complex */
r_static
id|LIST_HEAD
c_func
(paren
id|devs
)paren
suffix:semicolon
DECL|function|rme96xx_probe
r_static
r_int
id|__devinit
id|rme96xx_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pciid
)paren
(brace
r_int
id|i
suffix:semicolon
id|rme96xx_info
op_star
id|s
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcidev-&gt;irq
op_eq
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_dma_supported
c_func
(paren
id|pcidev
comma
l_int|0xffffffff
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|RME_MESS
l_string|&quot; architecture does not support 32bit PCI busmaster DMA&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|rme96xx_info
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|RME_MESS
l_string|&quot; out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|s
comma
l_int|0
comma
r_sizeof
(paren
id|rme96xx_info
)paren
)paren
suffix:semicolon
id|s-&gt;pcidev
op_assign
id|pcidev
suffix:semicolon
id|s-&gt;iobase
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pcidev
comma
l_int|0
)paren
comma
id|RME96xx_IO_EXTENT
)paren
suffix:semicolon
id|s-&gt;irq
op_assign
id|pcidev-&gt;irq
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;remapped iobase: %lx irq %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|s-&gt;iobase
comma
id|s-&gt;irq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pcidev
)paren
)paren
r_goto
id|err_irq
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|s-&gt;irq
comma
id|rme96xx_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;es1370&quot;
comma
id|s
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|RME_MESS
l_string|&quot; irq %u in use&bslash;n&quot;
comma
id|s-&gt;irq
)paren
suffix:semicolon
r_goto
id|err_irq
suffix:semicolon
)brace
multiline_comment|/* initialize the card */
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rme96xx_init
c_func
(paren
id|s
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|RME_MESS
l_string|&quot; initialization failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_devices
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devices
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|s-&gt;dspnum
(braket
id|i
)braket
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|rme96xx_audio_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_goto
id|err_devices
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|s-&gt;mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|rme96xx_mixer_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_goto
id|err_devices
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pcidev
comma
id|s
)paren
suffix:semicolon
id|pcidev-&gt;dma_mask
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* ????? */
multiline_comment|/* put it into driver list */
id|list_add_tail
c_func
(paren
op_amp
id|s-&gt;devs
comma
op_amp
id|devs
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;initialization successful&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* error handler */
id|err_devices
suffix:colon
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|unregister_sound_dsp
c_func
(paren
id|s-&gt;dspnum
(braket
id|i
)braket
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|s-&gt;irq
comma
id|s
)paren
suffix:semicolon
id|err_irq
suffix:colon
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|rme96xx_remove
r_static
r_void
id|__devinit
id|rme96xx_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
id|rme96xx_info
op_star
id|s
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;device structure not valid&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;started
)paren
id|rme96xx_startcard
c_func
(paren
id|s
comma
l_int|0
)paren
suffix:semicolon
id|i
op_assign
id|devices
suffix:semicolon
r_while
c_loop
(paren
id|i
)paren
(brace
id|i
op_decrement
suffix:semicolon
id|unregister_sound_dsp
c_func
(paren
id|s-&gt;dspnum
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|unregister_sound_mixer
c_func
(paren
id|s-&gt;mixer
)paren
suffix:semicolon
multiline_comment|/*&t;synchronize_irq(); This call got lost somehow ? */
id|free_irq
c_func
(paren
id|s-&gt;irq
comma
id|s
)paren
suffix:semicolon
id|busmaster_free
c_func
(paren
id|s-&gt;recbuf
comma
id|RME96xx_DMA_MAX_SIZE_ALL
)paren
suffix:semicolon
id|busmaster_free
c_func
(paren
id|s-&gt;playbuf
comma
id|RME96xx_DMA_MAX_SIZE_ALL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
macro_line|#ifndef PCI_VENDOR_ID_RME 
DECL|macro|PCI_VENDOR_ID_RME
mdefine_line|#define PCI_VENDOR_ID_RME 0x10ee
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_RME9652
DECL|macro|PCI_DEVICE_ID_RME9652
mdefine_line|#define PCI_DEVICE_ID_RME9652 0x3fc4
macro_line|#endif
macro_line|#ifndef PCI_ANY_ID
DECL|macro|PCI_ANY_ID
mdefine_line|#define PCI_ANY_ID 0
macro_line|#endif
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|id_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_RME
comma
id|PCI_DEVICE_ID_RME9652
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|id_table
)paren
suffix:semicolon
DECL|variable|rme96xx_driver
r_static
r_struct
id|pci_driver
id|rme96xx_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;rme96xx&quot;
comma
id|id_table
suffix:colon
id|id_table
comma
id|probe
suffix:colon
id|rme96xx_probe
comma
id|remove
suffix:colon
id|rme96xx_remove
)brace
suffix:semicolon
DECL|function|init_rme96xx
r_static
r_int
id|__init
id|init_rme96xx
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* No PCI bus in this machine! */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|RME_MESS
l_string|&quot; version &quot;
id|RMEVERSION
l_string|&quot; time &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|RME_MESS
l_string|&quot; reserving %d dsp device(s)&bslash;n&quot;
comma
id|devices
)paren
suffix:semicolon
id|numcards
op_assign
l_int|0
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|rme96xx_driver
)paren
suffix:semicolon
)brace
DECL|function|cleanup_rme96xx
r_static
r_void
id|__exit
id|cleanup_rme96xx
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|RME_MESS
l_string|&quot; unloading&bslash;n&quot;
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|rme96xx_driver
)paren
suffix:semicolon
)brace
DECL|variable|init_rme96xx
id|module_init
c_func
(paren
id|init_rme96xx
)paren
suffix:semicolon
DECL|variable|cleanup_rme96xx
id|module_exit
c_func
(paren
id|cleanup_rme96xx
)paren
suffix:semicolon
multiline_comment|/*-------------------------------------------------------------------------- &n;   Implementation of file operations &n;---------------------------------------------------------------------------*/
DECL|macro|RME96xx_FMT
mdefine_line|#define RME96xx_FMT (AFMT_S16_LE|AFMT_U8|AFMT_S32_BLOCKED)
DECL|function|rme96xx_ioctl
r_static
r_int
id|rme96xx_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|in
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|dmabuf
op_star
id|dma
op_assign
(paren
r_struct
id|dmabuf
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|rme96xx_info
op_star
id|s
op_assign
id|dma-&gt;s
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|abinfo
suffix:semicolon
id|count_info
id|cinfo
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|val
op_assign
l_int|0
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;ioctl %ud&bslash;n&quot;
comma
id|cmd
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
macro_line|#if 0
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|drain_dac2
c_func
(paren
id|s
comma
l_int|0
multiline_comment|/*file-&gt;f_flags &amp; O_NONBLOCK*/
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
id|DSP_CAP_DUPLEX
op_or
id|DSP_CAP_REALTIME
op_or
id|DSP_CAP_TRIGGER
op_or
id|DSP_CAP_MMAP
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
singleline_comment|//&t;&t;rme96xx_clearbufs(dma);
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|0
)paren
(brace
multiline_comment|/* generally it&squot;s not a problem if we change the speed &n;&t;&t;&t;if (dma-&gt;open_mode &amp; (~file-&gt;f_mode) &amp; (FMODE_READ|FMODE_WRITE))&n;&t;&t;&t;&t;return -EINVAL;&n;*/
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
l_int|44100
suffix:colon
r_case
l_int|88200
suffix:colon
id|rme96xx_unset_ctrl
c_func
(paren
id|s
comma
id|RME96xx_freq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|48000
suffix:colon
r_case
l_int|96000
suffix:colon
id|rme96xx_set_ctrl
c_func
(paren
id|s
comma
id|RME96xx_freq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rme96xx_unset_ctrl
c_func
(paren
id|s
comma
id|RME96xx_freq
)paren
suffix:semicolon
id|val
op_assign
l_int|44100
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
OG
l_int|50000
)paren
id|rme96xx_set_ctrl
c_func
(paren
id|s
comma
id|RME96xx_DS
)paren
suffix:semicolon
r_else
id|rme96xx_unset_ctrl
c_func
(paren
id|s
comma
id|RME96xx_DS
)paren
suffix:semicolon
id|s-&gt;rate
op_assign
id|val
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;speed set to %d&bslash;n&quot;
comma
id|val
)paren
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
multiline_comment|/* this plays a mono file on two channels */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
(brace
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;setting to mono&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dma-&gt;mono
op_assign
l_int|1
suffix:semicolon
id|dma-&gt;inchannels
op_assign
l_int|1
suffix:semicolon
id|dma-&gt;outchannels
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;setting to stereo&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|dma-&gt;mono
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;inchannels
op_assign
l_int|2
suffix:semicolon
id|dma-&gt;outchannels
op_assign
l_int|2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
multiline_comment|/* remember to check for resonable offset/channel pairs here */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|val
OG
l_int|0
op_logical_and
(paren
id|dma-&gt;outoffset
op_plus
id|val
)paren
op_le
id|RME96xx_CHANNELS_PER_CARD
)paren
id|dma-&gt;outchannels
op_assign
id|val
suffix:semicolon
r_else
id|dma-&gt;outchannels
op_assign
id|val
op_assign
l_int|2
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;setting to outchannels %d&bslash;n&quot;
comma
id|val
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|val
OG
l_int|0
op_logical_and
(paren
id|dma-&gt;inoffset
op_plus
id|val
)paren
op_le
id|RME96xx_CHANNELS_PER_CARD
)paren
id|dma-&gt;inchannels
op_assign
id|val
suffix:semicolon
r_else
id|dma-&gt;inchannels
op_assign
id|val
op_assign
l_int|2
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;setting to inchannels %d&bslash;n&quot;
comma
id|val
)paren
)paren
suffix:semicolon
)brace
id|dma-&gt;mono
op_assign
l_int|0
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask */
r_return
id|put_user
c_func
(paren
id|RME96xx_FMT
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Selects ONE fmt*/
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;setting to format %x&bslash;n&quot;
comma
id|val
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|RME96xx_FMT
)paren
id|dma-&gt;format
op_assign
id|val
suffix:semicolon
r_switch
c_cond
(paren
id|dma-&gt;format
)paren
(brace
r_case
id|AFMT_S16_LE
suffix:colon
id|dma-&gt;formatshift
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S32_BLOCKED
suffix:colon
id|dma-&gt;formatshift
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|put_user
c_func
(paren
id|dma-&gt;format
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|s-&gt;ctrl
op_amp
id|CTRL_ADC_EN
)paren
id|val
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|s-&gt;ctrl
op_amp
id|CTRL_DAC2_EN
)paren
id|val
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
macro_line|#endif
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_INPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf_adc
c_func
(paren
id|s
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_OUTPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_dac2.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf_dac2
c_func
(paren
id|s
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_dac2
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
id|stop_dac2
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|val
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
id|count
op_assign
id|rme96xx_getospace
c_func
(paren
id|dma
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;started
)paren
id|count
op_assign
id|s-&gt;fragsize
op_star
l_int|2
suffix:semicolon
id|abinfo.fragsize
op_assign
(paren
id|s-&gt;fragsize
op_star
id|dma-&gt;outchannels
)paren
op_rshift
id|dma-&gt;formatshift
suffix:semicolon
id|abinfo.bytes
op_assign
(paren
id|count
op_star
id|dma-&gt;outchannels
)paren
op_rshift
id|dma-&gt;formatshift
suffix:semicolon
id|abinfo.fragstotal
op_assign
l_int|2
suffix:semicolon
id|abinfo.fragments
op_assign
(paren
id|count
OG
id|s-&gt;fragsize
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|val
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
id|count
op_assign
id|rme96xx_getispace
c_func
(paren
id|dma
comma
id|val
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
(paren
id|s-&gt;fragsize
op_star
id|dma-&gt;inchannels
)paren
op_rshift
id|dma-&gt;formatshift
suffix:semicolon
id|abinfo.bytes
op_assign
(paren
id|count
op_star
id|dma-&gt;inchannels
)paren
op_rshift
id|dma-&gt;formatshift
suffix:semicolon
suffix:semicolon
id|abinfo.fragstotal
op_assign
l_int|2
suffix:semicolon
id|abinfo.fragments
op_assign
id|count
OG
id|s-&gt;fragsize
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
multiline_comment|/* What shold this exactly do ? , &n;&t;&t;&t;&t;      ATM it is just abinfo.bytes */
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|val
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
id|count
op_assign
id|val
op_minus
id|dma-&gt;readptr
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
id|count
op_add_assign
id|s-&gt;fragsize
op_lshift
l_int|1
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|count
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
multiline_comment|/* check out how to use mmaped mode (can only be blocked !!!) */
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|val
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|s-&gt;fragsize
op_lshift
l_int|1
suffix:semicolon
suffix:semicolon
id|count
op_assign
id|val
op_minus
id|dma-&gt;readptr
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
id|count
op_add_assign
id|s-&gt;fragsize
op_lshift
l_int|1
suffix:semicolon
id|cinfo.blocks
op_assign
(paren
id|count
OG
id|s-&gt;fragsize
)paren
suffix:semicolon
id|cinfo.ptr
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;mmapped
)paren
id|dma-&gt;readptr
op_and_assign
id|s-&gt;fragsize
op_lshift
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|val
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|s-&gt;fragsize
op_lshift
l_int|1
suffix:semicolon
suffix:semicolon
id|count
op_assign
id|val
op_minus
id|dma-&gt;writeptr
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
id|count
op_add_assign
id|s-&gt;fragsize
op_lshift
l_int|1
suffix:semicolon
id|cinfo.blocks
op_assign
(paren
id|count
OG
id|s-&gt;fragsize
)paren
suffix:semicolon
id|cinfo.ptr
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;mmapped
)paren
id|dma-&gt;writeptr
op_and_assign
id|s-&gt;fragsize
op_lshift
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_return
id|put_user
c_func
(paren
id|s-&gt;fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_and_assign
l_int|0xffff
suffix:semicolon
id|val
op_sub_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
l_int|7
)paren
id|val
op_assign
l_int|7
suffix:semicolon
id|rme96xx_setlatency
c_func
(paren
id|s
comma
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|s-&gt;dma_adc.subdivision
)paren
op_logical_or
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|s-&gt;dma_dac2.subdivision
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|1
op_logical_and
id|val
op_ne
l_int|2
op_logical_and
id|val
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|s-&gt;dma_adc.subdivision
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|s-&gt;dma_dac2.subdivision
op_assign
id|val
suffix:semicolon
macro_line|#endif&t;&t;
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_return
id|put_user
c_func
(paren
id|s-&gt;rate
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_return
id|put_user
c_func
(paren
id|dma-&gt;outchannels
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_switch
c_cond
(paren
id|dma-&gt;format
)paren
(brace
r_case
id|AFMT_S32_BLOCKED
suffix:colon
id|val
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_LE
suffix:colon
id|val
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SNDCTL_DSP_SETSYNCRO
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|rme96xx_open
r_static
r_int
id|rme96xx_open
c_func
(paren
r_struct
id|inode
op_star
id|in
comma
r_struct
id|file
op_star
id|f
)paren
(brace
r_int
id|minor
op_assign
id|minor
c_func
(paren
id|in-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
r_int
id|devnum
op_assign
(paren
(paren
id|minor
op_minus
l_int|3
)paren
op_div
l_int|16
)paren
op_mod
id|devices
suffix:semicolon
multiline_comment|/* default = 0 */
id|rme96xx_info
op_star
id|s
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dma
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;device num %d open&bslash;n&quot;
comma
id|devnum
)paren
)paren
suffix:semicolon
multiline_comment|/* ??? */
r_for
c_loop
(paren
id|list
op_assign
id|devs.next
suffix:semicolon
suffix:semicolon
id|list
op_assign
id|list-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|list
op_eq
op_amp
id|devs
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|s
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|rme96xx_info
comma
id|devs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|s-&gt;dspnum
(braket
id|devnum
)braket
op_xor
id|minor
)paren
op_amp
op_complement
l_int|0xf
)paren
)paren
r_break
suffix:semicolon
)brace
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
multiline_comment|/* ??? */
id|dma
op_assign
op_amp
id|s-&gt;dma
(braket
id|devnum
)braket
suffix:semicolon
id|f-&gt;private_data
op_assign
id|dma
suffix:semicolon
multiline_comment|/* wait for device to become free */
id|down
c_func
(paren
op_amp
id|s-&gt;dma
(braket
id|devnum
)braket
dot
id|open_sem
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dma-&gt;open_mode
op_amp
id|f-&gt;f_mode
)paren
(brace
r_if
c_cond
(paren
id|f-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|up
c_func
(paren
op_amp
id|dma-&gt;open_sem
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|add_wait_queue
c_func
(paren
op_amp
id|dma-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|__set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dma-&gt;open_sem
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dma-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dma-&gt;open_sem
)paren
suffix:semicolon
)brace
id|COMM
(paren
l_string|&quot;hardware open&quot;
)paren
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma
(braket
id|devnum
)braket
dot
id|opened
)paren
id|rme96xx_dmabuf_init
c_func
(paren
id|dma-&gt;s
comma
id|dma
comma
id|dma-&gt;inoffset
comma
id|dma-&gt;outoffset
)paren
suffix:semicolon
id|s-&gt;dma
(braket
id|devnum
)braket
dot
id|open_mode
op_or_assign
(paren
id|f-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
)paren
suffix:semicolon
id|s-&gt;dma
(braket
id|devnum
)braket
dot
id|opened
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|s-&gt;dma
(braket
id|devnum
)braket
dot
id|open_sem
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;device num %d open finished&bslash;n&quot;
comma
id|devnum
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rme96xx_release
r_static
r_int
id|rme96xx_release
c_func
(paren
r_struct
id|inode
op_star
id|in
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|dmabuf
op_star
id|dma
op_assign
(paren
r_struct
id|dmabuf
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
id|hwp
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|COMM
(paren
l_string|&quot;draining&quot;
)paren
r_if
c_cond
(paren
id|dma-&gt;open_mode
op_amp
id|FMODE_WRITE
)paren
(brace
macro_line|#if 0 /* Why doesn&squot;t this work with some cards ?? */
id|hwp
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rme96xx_getospace
c_func
(paren
id|dma
comma
id|hwp
)paren
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
(paren
id|dma-&gt;wait
)paren
)paren
suffix:semicolon
id|hwp
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
id|rme96xx_clearbufs
c_func
(paren
id|dma
)paren
suffix:semicolon
)brace
id|dma-&gt;open_mode
op_and_assign
(paren
op_complement
id|file-&gt;f_mode
)paren
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dma-&gt;open_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
)paren
)paren
(brace
id|dma-&gt;opened
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;s-&gt;started
)paren
id|rme96xx_startcard
c_func
(paren
id|dma-&gt;s
comma
l_int|1
)paren
suffix:semicolon
)brace
id|wake_up
c_func
(paren
op_amp
id|dma-&gt;open_wait
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dma-&gt;open_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rme96xx_write
r_static
id|ssize_t
id|rme96xx_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|dmabuf
op_star
id|dma
op_assign
(paren
r_struct
id|dmabuf
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
multiline_comment|/* number of bytes from &quot;buffer&quot; that will/can be used */
r_int
id|hop
op_assign
id|count
op_div
id|dma-&gt;outchannels
suffix:semicolon
r_int
id|hwp
suffix:semicolon
r_int
id|exact
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma
op_eq
l_int|NULL
op_logical_or
(paren
id|dma-&gt;s
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;mmapped
op_logical_or
op_logical_neg
id|dma-&gt;opened
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dma-&gt;open_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma-&gt;s-&gt;started
)paren
id|rme96xx_startcard
c_func
(paren
id|dma-&gt;s
comma
id|exact
)paren
suffix:semicolon
id|hwp
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dma-&gt;started
)paren
)paren
(brace
id|COMM
(paren
l_string|&quot;first write&quot;
)paren
id|dma-&gt;readptr
op_assign
id|hwp
suffix:semicolon
id|dma-&gt;writeptr
op_assign
id|hwp
suffix:semicolon
id|dma-&gt;started
op_assign
l_int|1
suffix:semicolon
id|COMM
(paren
l_string|&quot;first write done&quot;
)paren
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|cnt
op_assign
id|rme96xx_getospace
c_func
(paren
id|dma
comma
id|hwp
)paren
suffix:semicolon
id|cnt
op_rshift_assign
id|dma-&gt;formatshift
suffix:semicolon
id|cnt
op_mul_assign
id|dma-&gt;outchannels
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rme96xx_copyfromuser
c_func
(paren
id|dma
comma
id|buffer
comma
id|cnt
comma
id|hop
)paren
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EFAULT
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hwp
op_minus
id|dma-&gt;writeptr
)paren
op_le
l_int|0
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
(paren
id|dma-&gt;wait
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|hwp
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
id|exact
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* count &gt; 0 */
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rme96xx_read
r_static
id|ssize_t
id|rme96xx_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|dmabuf
op_star
id|dma
op_assign
(paren
r_struct
id|dmabuf
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
id|hop
op_assign
id|count
op_div
id|dma-&gt;inchannels
suffix:semicolon
r_int
id|hwp
suffix:semicolon
r_int
id|exact
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma
op_eq
l_int|NULL
op_logical_or
(paren
id|dma-&gt;s
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;mmapped
op_logical_or
op_logical_neg
id|dma-&gt;opened
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dma-&gt;open_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
(paren
(paren
id|dma-&gt;s-&gt;fragsize
op_star
id|dma-&gt;inchannels
)paren
op_rshift
id|dma-&gt;formatshift
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dma-&gt;s-&gt;started
)paren
id|rme96xx_startcard
c_func
(paren
id|dma-&gt;s
comma
id|exact
)paren
suffix:semicolon
id|hwp
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dma-&gt;started
)paren
)paren
(brace
id|COMM
(paren
l_string|&quot;first read&quot;
)paren
id|dma-&gt;writeptr
op_assign
id|hwp
suffix:semicolon
id|dma-&gt;readptr
op_assign
id|hwp
suffix:semicolon
id|dma-&gt;started
op_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|cnt
op_assign
id|rme96xx_getispace
c_func
(paren
id|dma
comma
id|hwp
)paren
suffix:semicolon
id|cnt
op_rshift_assign
id|dma-&gt;formatshift
suffix:semicolon
id|cnt
op_mul_assign
id|dma-&gt;inchannels
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rme96xx_copytouser
c_func
(paren
id|dma
comma
id|buffer
comma
id|cnt
comma
id|hop
)paren
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EFAULT
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hwp
op_minus
id|dma-&gt;readptr
)paren
op_le
l_int|0
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
(paren
id|dma-&gt;wait
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|hwp
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
id|exact
)paren
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* count &gt; 0 */
r_return
id|ret
suffix:semicolon
)brace
DECL|function|rm96xx_mmap
r_static
r_int
id|rm96xx_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|dmabuf
op_star
id|dma
op_assign
(paren
r_struct
id|dmabuf
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|rme96xx_info
op_star
id|s
op_assign
id|dma-&gt;s
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
op_ne
l_int|0
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|RME96xx_DMA_MAX_SIZE
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;started
)paren
id|rme96xx_startcard
c_func
(paren
id|s
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma
comma
id|vma-&gt;vm_start
comma
id|virt_to_phys
c_func
(paren
id|s-&gt;playbuf
op_plus
id|dma-&gt;outoffset
op_star
id|RME96xx_DMA_MAX_SIZE
)paren
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;started
)paren
id|rme96xx_startcard
c_func
(paren
id|s
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma
comma
id|vma-&gt;vm_start
comma
id|virt_to_phys
c_func
(paren
id|s-&gt;playbuf
op_plus
id|dma-&gt;inoffset
op_star
id|RME96xx_DMA_MAX_SIZE
)paren
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_else
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* this is the mapping */
id|dma-&gt;mmapped
op_assign
l_int|1
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rme96xx_poll
r_static
r_int
r_int
id|rme96xx_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|dmabuf
op_star
id|dma
op_assign
(paren
r_struct
id|dmabuf
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|rme96xx_info
op_star
id|s
op_assign
id|dma-&gt;s
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|hwp
comma
id|cnt
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;rme96xx poll_wait ...&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;started
)paren
(brace
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dma-&gt;wait
comma
id|wait
)paren
suffix:semicolon
id|hwp
op_assign
id|rme96xx_gethwptr
c_func
(paren
id|dma-&gt;s
comma
l_int|0
)paren
suffix:semicolon
id|DBG
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;rme96xx poll: ..cnt %d &gt; %d&bslash;n&quot;
comma
id|cnt
comma
id|s-&gt;fragsize
)paren
)paren
suffix:semicolon
id|cnt
op_assign
id|rme96xx_getispace
c_func
(paren
id|dma
comma
id|hwp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
r_if
c_cond
(paren
id|cnt
OG
l_int|0
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
id|cnt
op_assign
id|rme96xx_getospace
c_func
(paren
id|dma
comma
id|hwp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_if
c_cond
(paren
id|cnt
OG
l_int|0
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
singleline_comment|//        printk(&quot;rme96xx poll_wait ...%d &gt; %d&bslash;n&quot;,rme96xx_getospace(dma,hwp),rme96xx_getispace(dma,hwp));
r_return
id|mask
suffix:semicolon
)brace
DECL|variable|rme96xx_audio_fops
r_static
r_struct
id|file_operations
id|rme96xx_audio_fops
op_assign
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|owner
suffix:colon
id|THIS_MODULE
comma
macro_line|#endif
id|read
suffix:colon
id|rme96xx_read
comma
id|write
suffix:colon
id|rme96xx_write
comma
id|poll
suffix:colon
id|rme96xx_poll
comma
id|ioctl
suffix:colon
id|rme96xx_ioctl
comma
id|mmap
suffix:colon
id|rm96xx_mmap
comma
id|open
suffix:colon
id|rme96xx_open
comma
id|release
suffix:colon
id|rme96xx_release
)brace
suffix:semicolon
DECL|function|rme96xx_mixer_open
r_static
r_int
id|rme96xx_mixer_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|minor
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
id|rme96xx_info
op_star
id|s
suffix:semicolon
id|COMM
(paren
l_string|&quot;mixer open&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|list
op_assign
id|devs.next
suffix:semicolon
suffix:semicolon
id|list
op_assign
id|list-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|list
op_eq
op_amp
id|devs
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|s
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|rme96xx_info
comma
id|devs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;mixer
op_eq
id|minor
)paren
r_break
suffix:semicolon
)brace
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|s
suffix:semicolon
id|COMM
(paren
l_string|&quot;mixer opened&quot;
)paren
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rme96xx_mixer_ioctl
r_static
r_int
id|rme96xx_mixer_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|rme96xx_info
op_star
id|s
op_assign
(paren
id|rme96xx_info
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|u32
id|status
suffix:semicolon
id|status
op_assign
id|readl
c_func
(paren
id|s-&gt;iobase
op_plus
id|RME96xx_status_register
)paren
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_PRIVATE1
)paren
(brace
id|rme_mixer
id|mixer
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|mixer
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|mixer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|s-&gt;dma
(braket
id|mixer.devnr
)braket
dot
id|outoffset
op_assign
id|mixer.o_offset
suffix:semicolon
id|s-&gt;dma
(braket
id|mixer.devnr
)braket
dot
id|inoffset
op_assign
id|mixer.i_offset
suffix:semicolon
)brace
id|mixer.o_offset
op_assign
id|s-&gt;dma
(braket
id|mixer.devnr
)braket
dot
id|outoffset
suffix:semicolon
id|mixer.i_offset
op_assign
id|s-&gt;dma
(braket
id|mixer.devnr
)braket
dot
id|inoffset
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|mixer
comma
r_sizeof
(paren
id|mixer
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_PRIVATE2
)paren
(brace
r_return
id|put_user
c_func
(paren
id|status
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_PRIVATE3
)paren
(brace
id|u32
id|control
suffix:semicolon
id|copy_from_user
c_func
(paren
op_amp
id|control
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|control
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|s-&gt;control_register
op_assign
id|control
suffix:semicolon
id|writel
c_func
(paren
id|control
comma
id|s-&gt;iobase
op_plus
id|RME96xx_control_register
)paren
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|s-&gt;control_register
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|rme96xx_mixer_release
r_static
r_int
id|rme96xx_mixer_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|rme96xx_mixer_fops
r_static
multiline_comment|/*const*/
r_struct
id|file_operations
id|rme96xx_mixer_fops
op_assign
(brace
macro_line|#if LINUX_VERSION_CODE &gt;= KERNEL_VERSION(2,4,0)
id|owner
suffix:colon
id|THIS_MODULE
comma
macro_line|#endif
id|ioctl
suffix:colon
id|rme96xx_mixer_ioctl
comma
id|open
suffix:colon
id|rme96xx_mixer_open
comma
id|release
suffix:colon
id|rme96xx_mixer_release
comma
)brace
suffix:semicolon
eof
