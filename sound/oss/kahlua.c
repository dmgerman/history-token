multiline_comment|/*&n; *&t;Initialisation code for Cyrix/NatSemi VSA1 softaudio&n; *&n; *&t;(C) Copyright 2003 Red Hat Inc &lt;alan@redhat.com&gt;&n; *&n; * XpressAudio(tm) is used on the Cyrix MediaGX (now NatSemi Geode) systems.&n; * The older version (VSA1) provides fairly good soundblaster emulation&n; * although there are a couple of bugs: large DMA buffers break record,&n; * and the MPU event handling seems suspect. VSA2 allows the native driver&n; * to control the AC97 audio engine directly and requires a different driver.&n; *&n; * Thanks to National Semiconductor for providing the needed information&n; * on the XpressAudio(tm) internals.&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2, or (at your option) any&n; * later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; * TO DO:&n; *&t;Investigate whether we can portably support Cognac (5520) in the&n; *&t;same manner.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &quot;sound_config.h&quot;
macro_line|#include &quot;sb.h&quot;
multiline_comment|/*&n; *&t;Read a soundblaster compatible mixer register.&n; *&t;In this case we are actually reading an SMI trap&n; *&t;not real hardware.&n; */
DECL|function|mixer_read
r_static
id|u8
id|__devinit
id|mixer_read
c_func
(paren
r_int
r_int
id|io
comma
id|u8
id|reg
)paren
(brace
id|outb
c_func
(paren
id|reg
comma
id|io
op_plus
l_int|4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|reg
op_assign
id|inb
c_func
(paren
id|io
op_plus
l_int|5
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_return
id|reg
suffix:semicolon
)brace
DECL|function|probe_one
r_static
r_int
id|__devinit
id|probe_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|address_info
op_star
id|hw_config
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|io
suffix:semicolon
id|u16
id|map
suffix:semicolon
id|u8
id|irq
comma
id|dma8
comma
id|dma16
suffix:semicolon
r_int
id|oldquiet
suffix:semicolon
r_extern
r_int
id|sb_be_quiet
suffix:semicolon
id|base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
op_eq
l_int|0UL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|mem
op_assign
id|ioremap
c_func
(paren
id|base
comma
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0UL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|map
op_assign
id|readw
c_func
(paren
id|mem
op_plus
l_int|0x18
)paren
suffix:semicolon
multiline_comment|/* Read the SMI enables */
id|iounmap
c_func
(paren
id|mem
)paren
suffix:semicolon
multiline_comment|/* Map bits&n;&t;&t;0:1&t;* 0x20 + 0x200 = sb base&n;&t;&t;2&t;sb enable&n;&t;&t;3&t;adlib enable&n;&t;&t;5&t;MPU enable 0x330&n;&t;&t;6&t;MPU enable 0x300&n;&t;&t;&n;&t;   The other bits may be used internally so must be masked */
id|io
op_assign
l_int|0x220
op_plus
l_int|0x20
op_star
(paren
id|map
op_amp
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map
op_amp
(paren
l_int|1
op_lshift
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kahlua: XpressAudio at 0x%lx&bslash;n&quot;
comma
id|io
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|map
op_amp
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kahlua: MPU at 0x300&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|map
op_amp
(paren
l_int|1
op_lshift
l_int|6
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kahlua: MPU at 0x330&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|mixer_read
c_func
(paren
id|io
comma
l_int|0x80
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|dma8
op_assign
id|mixer_read
c_func
(paren
id|io
comma
l_int|0x81
)paren
suffix:semicolon
singleline_comment|// printk(&quot;IRQ=%x MAP=%x DMA=%x&bslash;n&quot;, irq, map, dma8);
r_if
c_cond
(paren
id|dma8
op_amp
l_int|0x20
)paren
(brace
id|dma16
op_assign
l_int|5
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dma8
op_amp
l_int|0x40
)paren
(brace
id|dma16
op_assign
l_int|6
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dma8
op_amp
l_int|0x80
)paren
(brace
id|dma16
op_assign
l_int|7
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kahlua: No 16bit DMA enabled.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma8
op_amp
l_int|0x01
)paren
(brace
id|dma8
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dma8
op_amp
l_int|0x02
)paren
(brace
id|dma8
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dma8
op_amp
l_int|0x08
)paren
(brace
id|dma8
op_assign
l_int|3
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kahlua: No 8bit DMA enabled.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
op_amp
l_int|1
)paren
(brace
id|irq
op_assign
l_int|9
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq
op_amp
l_int|2
)paren
(brace
id|irq
op_assign
l_int|5
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq
op_amp
l_int|4
)paren
(brace
id|irq
op_assign
l_int|7
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|irq
op_amp
l_int|8
)paren
(brace
id|irq
op_assign
l_int|10
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kahlua: SB IRQ not set.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;kahlua: XpressAudio on IRQ %d, DMA %d, %d&bslash;n&quot;
comma
id|irq
comma
id|dma8
comma
id|dma16
)paren
suffix:semicolon
id|hw_config
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|address_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hw_config
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kahlua: out of memory.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hw_config
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hw_config
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|hw_config
)paren
suffix:semicolon
id|hw_config-&gt;io_base
op_assign
id|io
suffix:semicolon
id|hw_config-&gt;irq
op_assign
id|irq
suffix:semicolon
id|hw_config-&gt;dma
op_assign
id|dma8
suffix:semicolon
id|hw_config-&gt;dma2
op_assign
id|dma16
suffix:semicolon
id|hw_config-&gt;name
op_assign
l_string|&quot;Cyrix XpressAudio&quot;
suffix:semicolon
id|hw_config-&gt;driver_use_1
op_assign
id|SB_NO_MIDI
op_or
id|SB_PCI_IRQ
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_detect
c_func
(paren
id|hw_config
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;kahlua: audio not responding.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|oldquiet
op_assign
id|sb_be_quiet
suffix:semicolon
id|sb_be_quiet
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sb_dsp_init
c_func
(paren
id|hw_config
comma
id|THIS_MODULE
)paren
)paren
(brace
id|sb_be_quiet
op_assign
id|oldquiet
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hw_config
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|sb_be_quiet
op_assign
id|oldquiet
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|remove_one
r_static
r_void
id|__devexit
id|remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|address_info
op_star
id|hw_config
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|sb_dsp_unload
c_func
(paren
id|hw_config
comma
l_int|0
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hw_config
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alan Cox&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Kahlua VSA1 PCI Audio&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;5530 only. The 5510/5520 decode is different.&n; */
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|id_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_CYRIX
comma
id|PCI_DEVICE_ID_CYRIX_5530_AUDIO
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|id_tbl
)paren
suffix:semicolon
DECL|variable|kahlua_driver
r_static
r_struct
id|pci_driver
id|kahlua_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;kahlua&quot;
comma
id|id_table
suffix:colon
id|id_tbl
comma
id|probe
suffix:colon
id|probe_one
comma
id|remove
suffix:colon
id|__devexit_p
c_func
(paren
id|remove_one
)paren
comma
)brace
suffix:semicolon
DECL|function|kahlua_init_module
r_static
r_int
id|__init
id|kahlua_init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Cyrix Kahlua VSA1 XpressAudio support (c) Copyright 2003 Red Hat Inc&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|kahlua_driver
)paren
suffix:semicolon
)brace
DECL|function|kahlua_cleanup_module
r_static
r_void
id|__devexit
id|kahlua_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_unregister_driver
c_func
(paren
op_amp
id|kahlua_driver
)paren
suffix:semicolon
)brace
DECL|variable|kahlua_init_module
id|module_init
c_func
(paren
id|kahlua_init_module
)paren
suffix:semicolon
DECL|variable|kahlua_cleanup_module
id|module_exit
c_func
(paren
id|kahlua_cleanup_module
)paren
suffix:semicolon
eof
