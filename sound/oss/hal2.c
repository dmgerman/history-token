multiline_comment|/*&n; *  Driver for A2 audio system used in SGI machines&n; *  Copyright (c) 2001, 2002, 2003 Ladislav Michl &lt;ladis@linux-mips.org&gt;&n; *  &n; *  Based on Ulf Carlsson&squot;s code.&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License version 2 as &n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Supported devices:&n; *  /dev/dsp    standard dsp device, (mostly) OSS compatible&n; *  /dev/mixer&t;standard mixer device, (mostly) OSS compatible&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/sgi/hpc3.h&gt;
macro_line|#include &lt;asm/sgi/ip22.h&gt;
macro_line|#include &quot;hal2.h&quot;
macro_line|#if 0
mdefine_line|#define DEBUG(args...)&t;&t;printk(args)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(args...)
macro_line|#endif
macro_line|#if 0 
mdefine_line|#define DEBUG_MIX(args...)&t;printk(args)
macro_line|#else
DECL|macro|DEBUG_MIX
mdefine_line|#define DEBUG_MIX(args...)
macro_line|#endif
multiline_comment|/*&n; * Before touching these look how it works. It is a bit unusual I know,&n; * but it helps to keep things simple. This driver is considered complete&n; * and I won&squot;t add any new features although hardware has many cool&n; * capabilities.&n; * (Historical note: HAL2 driver was first written by Ulf Carlsson - ALSA&n; * 0.3 running with 2.2.x kernel. Then ALSA changed completely and it&n; * seemed easier to me to write OSS driver from scratch - this one. Now&n; * when ALSA is official part of 2.6 kernel it&squot;s time to write ALSA driver&n; * using (hopefully) final version of ALSA interface)&n; */
DECL|macro|H2_BLOCK_SIZE
mdefine_line|#define H2_BLOCK_SIZE&t;1024
DECL|macro|H2_ADC_BUFSIZE
mdefine_line|#define H2_ADC_BUFSIZE&t;8192
DECL|macro|H2_DAC_BUFSIZE
mdefine_line|#define H2_DAC_BUFSIZE&t;16834
DECL|struct|hal2_pbus
r_struct
id|hal2_pbus
(brace
DECL|member|pbus
r_struct
id|hpc3_pbus_dmacregs
op_star
id|pbus
suffix:semicolon
DECL|member|pbusnr
r_int
id|pbusnr
suffix:semicolon
DECL|member|ctrl
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Current state of pbus-&gt;pbdma_ctrl */
)brace
suffix:semicolon
DECL|struct|hal2_desc
r_struct
id|hal2_desc
(brace
DECL|member|desc
r_struct
id|hpc_dma_desc
id|desc
suffix:semicolon
DECL|member|cnt
id|u32
id|cnt
suffix:semicolon
multiline_comment|/* don&squot;t touch, it is also padding */
)brace
suffix:semicolon
DECL|struct|hal2_codec
r_struct
id|hal2_codec
(brace
DECL|member|buffer
r_int
r_char
op_star
id|buffer
suffix:semicolon
DECL|member|desc
r_struct
id|hal2_desc
op_star
id|desc
suffix:semicolon
DECL|member|desc_count
r_int
id|desc_count
suffix:semicolon
DECL|member|tail
DECL|member|head
r_int
id|tail
comma
id|head
suffix:semicolon
multiline_comment|/* tail index, head index */
DECL|member|pbus
r_struct
id|hal2_pbus
id|pbus
suffix:semicolon
DECL|member|format
r_int
r_int
id|format
suffix:semicolon
multiline_comment|/* Audio data format */
DECL|member|voices
r_int
id|voices
suffix:semicolon
multiline_comment|/* mono/stereo */
DECL|member|sample_rate
r_int
r_int
id|sample_rate
suffix:semicolon
DECL|member|master
r_int
r_int
id|master
suffix:semicolon
multiline_comment|/* Master frequency */
DECL|member|mod
r_int
r_int
id|mod
suffix:semicolon
multiline_comment|/* MOD value */
DECL|member|inc
r_int
r_int
id|inc
suffix:semicolon
multiline_comment|/* INC value */
DECL|member|dma_wait
id|wait_queue_head_t
id|dma_wait
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
DECL|member|usecount
r_int
id|usecount
suffix:semicolon
multiline_comment|/* recording and playback are&n;&t;&t;&t;&t;&t; * independent */
)brace
suffix:semicolon
DECL|macro|H2_MIX_OUTPUT_ATT
mdefine_line|#define H2_MIX_OUTPUT_ATT&t;0
DECL|macro|H2_MIX_INPUT_GAIN
mdefine_line|#define H2_MIX_INPUT_GAIN&t;1
DECL|macro|H2_MIXERS
mdefine_line|#define H2_MIXERS&t;&t;2
DECL|struct|hal2_mixer
r_struct
id|hal2_mixer
(brace
DECL|member|modcnt
r_int
id|modcnt
suffix:semicolon
DECL|member|master
r_int
r_int
id|master
suffix:semicolon
DECL|member|volume
r_int
r_int
id|volume
(braket
id|H2_MIXERS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|hal2_card
r_struct
id|hal2_card
(brace
DECL|member|dev_dsp
r_int
id|dev_dsp
suffix:semicolon
multiline_comment|/* audio device */
DECL|member|dev_mixer
r_int
id|dev_mixer
suffix:semicolon
multiline_comment|/* mixer device */
DECL|member|dev_midi
r_int
id|dev_midi
suffix:semicolon
multiline_comment|/* midi device */
DECL|member|ctl_regs
r_struct
id|hal2_ctl_regs
op_star
id|ctl_regs
suffix:semicolon
multiline_comment|/* HAL2 ctl registers */
DECL|member|aes_regs
r_struct
id|hal2_aes_regs
op_star
id|aes_regs
suffix:semicolon
multiline_comment|/* HAL2 aes registers */
DECL|member|vol_regs
r_struct
id|hal2_vol_regs
op_star
id|vol_regs
suffix:semicolon
multiline_comment|/* HAL2 vol registers */
DECL|member|syn_regs
r_struct
id|hal2_syn_regs
op_star
id|syn_regs
suffix:semicolon
multiline_comment|/* HAL2 syn registers */
DECL|member|dac
r_struct
id|hal2_codec
id|dac
suffix:semicolon
DECL|member|adc
r_struct
id|hal2_codec
id|adc
suffix:semicolon
DECL|member|mixer
r_struct
id|hal2_mixer
id|mixer
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|H2_INDIRECT_WAIT
mdefine_line|#define H2_INDIRECT_WAIT(regs)&t;while (regs-&gt;isr &amp; H2_ISR_TSTATUS);
DECL|macro|H2_READ_ADDR
mdefine_line|#define H2_READ_ADDR(addr)&t;(addr | (1&lt;&lt;7))
DECL|macro|H2_WRITE_ADDR
mdefine_line|#define H2_WRITE_ADDR(addr)&t;(addr)
DECL|variable|hal2str
r_static
r_char
op_star
id|hal2str
op_assign
l_string|&quot;HAL2&quot;
suffix:semicolon
multiline_comment|/*&n; * I doubt anyone has a machine with two HAL2 cards. It&squot;s possible to&n; * have two HPC&squot;s, so it is probably possible to have two HAL2 cards.&n; * Try to deal with it, but note that it is not tested.&n; */
DECL|macro|MAXCARDS
mdefine_line|#define MAXCARDS&t;2
DECL|variable|hal2_card
r_static
r_struct
id|hal2_card
op_star
id|hal2_card
(braket
id|MAXCARDS
)braket
suffix:semicolon
r_static
r_const
r_struct
(brace
DECL|member|idx
DECL|member|avail
r_int
r_char
id|idx
suffix:colon
l_int|4
comma
id|avail
suffix:colon
l_int|1
suffix:semicolon
DECL|variable|mixtable
)brace
id|mixtable
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_PCM
)braket
op_assign
(brace
id|H2_MIX_OUTPUT_ATT
comma
l_int|1
)brace
comma
multiline_comment|/* voice */
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
(brace
id|H2_MIX_INPUT_GAIN
comma
l_int|1
)brace
comma
multiline_comment|/* mic */
)brace
suffix:semicolon
DECL|macro|H2_SUPPORTED_FORMATS
mdefine_line|#define H2_SUPPORTED_FORMATS&t;(AFMT_S16_LE | AFMT_S16_BE)
DECL|function|hal2_isr_write
r_static
r_inline
r_void
id|hal2_isr_write
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|val
)paren
(brace
id|hal2-&gt;ctl_regs-&gt;isr
op_assign
id|val
suffix:semicolon
)brace
DECL|function|hal2_isr_look
r_static
r_inline
id|u16
id|hal2_isr_look
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_return
id|hal2-&gt;ctl_regs-&gt;isr
suffix:semicolon
)brace
DECL|function|hal2_rev_look
r_static
r_inline
id|u16
id|hal2_rev_look
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_return
id|hal2-&gt;ctl_regs-&gt;rev
suffix:semicolon
)brace
macro_line|#ifdef HAL2_DUMP_REGS
DECL|function|hal2_i_look16
r_static
id|u16
id|hal2_i_look16
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|addr
)paren
(brace
r_struct
id|hal2_ctl_regs
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
r_return
id|regs-&gt;idr0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|hal2_i_look32
r_static
id|u32
id|hal2_i_look32
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|addr
)paren
(brace
id|u32
id|ret
suffix:semicolon
r_struct
id|hal2_ctl_regs
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|ret
op_assign
id|regs-&gt;idr0
op_amp
l_int|0xffff
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
op_or
l_int|0x1
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|regs-&gt;idr0
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hal2_i_write16
r_static
r_void
id|hal2_i_write16
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|addr
comma
id|u16
id|val
)paren
(brace
r_struct
id|hal2_ctl_regs
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|val
suffix:semicolon
id|regs-&gt;idr1
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|hal2_i_write32
r_static
r_void
id|hal2_i_write32
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|addr
comma
id|u32
id|val
)paren
(brace
r_struct
id|hal2_ctl_regs
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|regs-&gt;idr1
op_assign
id|val
op_rshift
l_int|16
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|hal2_i_setbit16
r_static
r_void
id|hal2_i_setbit16
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|addr
comma
id|u16
id|bit
)paren
(brace
r_struct
id|hal2_ctl_regs
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|regs-&gt;idr0
op_assign
(paren
id|regs-&gt;idr0
op_amp
l_int|0xffff
)paren
op_or
id|bit
suffix:semicolon
id|regs-&gt;idr1
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|hal2_i_setbit32
r_static
r_void
id|hal2_i_setbit32
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|addr
comma
id|u32
id|bit
)paren
(brace
id|u32
id|tmp
suffix:semicolon
r_struct
id|hal2_ctl_regs
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|regs-&gt;idr0
op_amp
l_int|0xffff
)paren
op_or
(paren
id|regs-&gt;idr1
op_lshift
l_int|16
)paren
op_or
id|bit
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|tmp
op_amp
l_int|0xffff
suffix:semicolon
id|regs-&gt;idr1
op_assign
id|tmp
op_rshift
l_int|16
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|hal2_i_clearbit16
r_static
r_void
id|hal2_i_clearbit16
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|addr
comma
id|u16
id|bit
)paren
(brace
r_struct
id|hal2_ctl_regs
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|regs-&gt;idr0
op_assign
(paren
id|regs-&gt;idr0
op_amp
l_int|0xffff
)paren
op_amp
op_complement
id|bit
suffix:semicolon
id|regs-&gt;idr1
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|hal2_i_clearbit32
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
id|u16
id|addr
comma
id|u32
id|bit
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|tmp
op_assign
(paren
(paren
id|regs-&gt;idr0
op_amp
l_int|0xffff
)paren
op_or
(paren
id|regs-&gt;idr1
op_lshift
l_int|16
)paren
)paren
op_amp
op_complement
id|bit
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|tmp
op_amp
l_int|0xffff
suffix:semicolon
id|regs-&gt;idr1
op_assign
id|tmp
op_rshift
l_int|16
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef HAL2_DUMP_REGS
DECL|function|hal2_dump_regs
r_static
r_void
id|hal2_dump_regs
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;isr: %08hx &quot;
comma
id|hal2_isr_look
c_func
(paren
id|hal2
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;rev: %08hx&bslash;n&quot;
comma
id|hal2_rev_look
c_func
(paren
id|hal2
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;relay: %04hx&bslash;n&quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_RELAY_C
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;port en: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;dma end: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;dma drv: %04hx&bslash;n&quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_DMA_DRV
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;syn ctl: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_SYNTH_C
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;aesrx ctl: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_AESRX_C
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;aestx ctl: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_AESTX_C
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;dac ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_ADC_C1
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;dac ctl2: %08x &quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_ADC_C2
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;adc ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_DAC_C1
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;adc ctl2: %08x &quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;syn map: %04hx&bslash;n&quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_SYNTH_MAP_C
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;bres1 ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_BRES1_C1
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;bres1 ctl2: %04x &quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_BRES1_C2
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;bres2 ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_BRES2_C1
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;bres2 ctl2: %04x &quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_BRES2_C2
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;bres3 ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_BRES3_C1
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;bres3 ctl2: %04x&bslash;n&quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_BRES3_C2
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|hal2_dsp_find_card
r_static
r_struct
id|hal2_card
op_star
id|hal2_dsp_find_card
c_func
(paren
r_int
id|minor
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hal2_card
(braket
id|i
)braket
op_ne
l_int|NULL
op_logical_and
id|hal2_card
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_dsp
op_eq
id|minor
)paren
r_return
id|hal2_card
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|hal2_mixer_find_card
r_static
r_struct
id|hal2_card
op_star
id|hal2_mixer_find_card
c_func
(paren
r_int
id|minor
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hal2_card
(braket
id|i
)braket
op_ne
l_int|NULL
op_logical_and
id|hal2_card
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
op_eq
id|minor
)paren
r_return
id|hal2_card
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|hal2_inc_head
r_static
r_void
id|hal2_inc_head
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
)paren
(brace
id|codec-&gt;head
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;head
op_eq
id|codec-&gt;desc_count
)paren
id|codec-&gt;head
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_inc_tail
r_static
r_void
id|hal2_inc_tail
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
)paren
(brace
id|codec-&gt;tail
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;tail
op_eq
id|codec-&gt;desc_count
)paren
id|codec-&gt;tail
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_dac_interrupt
r_static
r_void
id|hal2_dac_interrupt
c_func
(paren
r_struct
id|hal2_codec
op_star
id|dac
)paren
(brace
r_int
id|running
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dac-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* if tail buffer contains zero samples DMA stream was already&n;&t; * stopped */
id|running
op_assign
id|dac-&gt;desc
(braket
id|dac-&gt;tail
)braket
dot
id|cnt
suffix:semicolon
id|dac-&gt;desc
(braket
id|dac-&gt;tail
)braket
dot
id|cnt
op_assign
l_int|0
suffix:semicolon
id|dac-&gt;desc
(braket
id|dac-&gt;tail
)braket
dot
id|desc.cntinfo
op_assign
id|HPCDMA_XIE
op_or
id|HPCDMA_EOX
suffix:semicolon
multiline_comment|/* we just proccessed empty buffer, don&squot;t update tail pointer */
r_if
c_cond
(paren
id|running
)paren
id|hal2_inc_tail
c_func
(paren
id|dac
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dac-&gt;lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dac-&gt;dma_wait
)paren
suffix:semicolon
)brace
DECL|function|hal2_adc_interrupt
r_static
r_void
id|hal2_adc_interrupt
c_func
(paren
r_struct
id|hal2_codec
op_star
id|adc
)paren
(brace
r_int
id|running
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|adc-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* if head buffer contains nonzero samples DMA stream was already&n;&t; * stopped */
id|running
op_assign
op_logical_neg
id|adc-&gt;desc
(braket
id|adc-&gt;head
)braket
dot
id|cnt
suffix:semicolon
id|adc-&gt;desc
(braket
id|adc-&gt;head
)braket
dot
id|cnt
op_assign
id|H2_BLOCK_SIZE
suffix:semicolon
id|adc-&gt;desc
(braket
id|adc-&gt;head
)braket
dot
id|desc.cntinfo
op_assign
id|HPCDMA_XIE
op_or
id|HPCDMA_EOR
suffix:semicolon
multiline_comment|/* we just proccessed empty buffer, don&squot;t update head pointer */
r_if
c_cond
(paren
id|running
)paren
id|hal2_inc_head
c_func
(paren
id|adc
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|adc-&gt;lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|adc-&gt;dma_wait
)paren
suffix:semicolon
)brace
DECL|function|hal2_interrupt
r_static
id|irqreturn_t
id|hal2_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|hal2_card
op_star
id|hal2
op_assign
(paren
r_struct
id|hal2_card
op_star
)paren
id|dev_id
suffix:semicolon
id|irqreturn_t
id|ret
op_assign
id|IRQ_NONE
suffix:semicolon
multiline_comment|/* decide what caused this interrupt */
r_if
c_cond
(paren
id|hal2-&gt;dac.pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_INT
)paren
(brace
id|hal2_dac_interrupt
c_func
(paren
op_amp
id|hal2-&gt;dac
)paren
suffix:semicolon
id|ret
op_assign
id|IRQ_HANDLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hal2-&gt;adc.pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_INT
)paren
(brace
id|hal2_adc_interrupt
c_func
(paren
op_amp
id|hal2-&gt;adc
)paren
suffix:semicolon
id|ret
op_assign
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hal2_compute_rate
r_static
r_int
id|hal2_compute_rate
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
comma
r_int
r_int
id|rate
)paren
(brace
r_int
r_int
id|mod
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;rate: %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
l_int|44100
op_mod
id|rate
OL
l_int|48000
op_mod
id|rate
)paren
(brace
id|mod
op_assign
l_int|4
op_star
l_int|44100
op_div
id|rate
suffix:semicolon
id|codec-&gt;master
op_assign
l_int|44100
suffix:semicolon
)brace
r_else
(brace
id|mod
op_assign
l_int|4
op_star
l_int|48000
op_div
id|rate
suffix:semicolon
id|codec-&gt;master
op_assign
l_int|48000
suffix:semicolon
)brace
id|codec-&gt;inc
op_assign
l_int|4
suffix:semicolon
id|codec-&gt;mod
op_assign
id|mod
suffix:semicolon
id|rate
op_assign
l_int|4
op_star
id|codec-&gt;master
op_div
id|mod
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;real_rate: %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
r_return
id|rate
suffix:semicolon
)brace
DECL|function|hal2_set_dac_rate
r_static
r_void
id|hal2_set_dac_rate
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_int
r_int
id|master
op_assign
id|hal2-&gt;dac.master
suffix:semicolon
r_int
id|inc
op_assign
id|hal2-&gt;dac.inc
suffix:semicolon
r_int
id|mod
op_assign
id|hal2-&gt;dac.mod
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;master: %d inc: %d mod: %d&bslash;n&quot;
comma
id|master
comma
id|inc
comma
id|mod
)paren
suffix:semicolon
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_BRES1_C1
comma
(paren
id|master
op_eq
l_int|44100
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_BRES1_C2
comma
(paren
(paren
l_int|0xffff
op_amp
(paren
id|inc
op_minus
id|mod
op_minus
l_int|1
)paren
)paren
op_lshift
l_int|16
)paren
op_or
id|inc
)paren
suffix:semicolon
)brace
DECL|function|hal2_set_adc_rate
r_static
r_void
id|hal2_set_adc_rate
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_int
r_int
id|master
op_assign
id|hal2-&gt;adc.master
suffix:semicolon
r_int
id|inc
op_assign
id|hal2-&gt;adc.inc
suffix:semicolon
r_int
id|mod
op_assign
id|hal2-&gt;adc.mod
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;master: %d inc: %d mod: %d&bslash;n&quot;
comma
id|master
comma
id|inc
comma
id|mod
)paren
suffix:semicolon
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_BRES2_C1
comma
(paren
id|master
op_eq
l_int|44100
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_BRES2_C2
comma
(paren
(paren
l_int|0xffff
op_amp
(paren
id|inc
op_minus
id|mod
op_minus
l_int|1
)paren
)paren
op_lshift
l_int|16
)paren
op_or
id|inc
)paren
suffix:semicolon
)brace
DECL|function|hal2_setup_dac
r_static
r_void
id|hal2_setup_dac
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_int
r_int
id|fifobeg
comma
id|fifoend
comma
id|highwater
comma
id|sample_size
suffix:semicolon
r_struct
id|hal2_pbus
op_star
id|pbus
op_assign
op_amp
id|hal2-&gt;dac.pbus
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;hal2_setup_dac&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Now we set up some PBUS information. The PBUS needs information about&n;&t; * what portion of the fifo it will use. If it&squot;s receiving or&n;&t; * transmitting, and finally whether the stream is little endian or big&n;&t; * endian. The information is written later, on the start call.&n;&t; */
id|sample_size
op_assign
l_int|2
op_star
id|hal2-&gt;dac.voices
suffix:semicolon
multiline_comment|/* Fifo should be set to hold exactly four samples. Highwater mark&n;&t; * should be set to two samples. */
id|highwater
op_assign
(paren
id|sample_size
op_star
l_int|2
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* halfwords */
id|fifobeg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* playback is first */
id|fifoend
op_assign
(paren
id|sample_size
op_star
l_int|4
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* doublewords */
id|pbus-&gt;ctrl
op_assign
id|HPC3_PDMACTRL_RT
op_or
id|HPC3_PDMACTRL_LD
op_or
(paren
id|highwater
op_lshift
l_int|8
)paren
op_or
(paren
id|fifobeg
op_lshift
l_int|16
)paren
op_or
(paren
id|fifoend
op_lshift
l_int|24
)paren
op_or
(paren
id|hal2-&gt;dac.format
op_amp
id|AFMT_S16_LE
ques
c_cond
id|HPC3_PDMACTRL_SEL
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* We disable everything before we do anything at all */
id|pbus-&gt;pbus-&gt;pbdma_ctrl
op_assign
id|HPC3_PDMACTRL_LD
suffix:semicolon
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
comma
id|H2I_DMA_PORT_EN_CODECTX
)paren
suffix:semicolon
multiline_comment|/* Setup the HAL2 for playback */
id|hal2_set_dac_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
multiline_comment|/* Set endianess */
r_if
c_cond
(paren
id|hal2-&gt;dac.format
op_amp
id|AFMT_S16_LE
)paren
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
comma
id|H2I_DMA_END_CODECTX
)paren
suffix:semicolon
r_else
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
comma
id|H2I_DMA_END_CODECTX
)paren
suffix:semicolon
multiline_comment|/* Set DMA bus */
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_DRV
comma
(paren
l_int|1
op_lshift
id|pbus-&gt;pbusnr
)paren
)paren
suffix:semicolon
multiline_comment|/* We are using 1st Bresenham clock generator for playback */
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_DAC_C1
comma
(paren
id|pbus-&gt;pbusnr
op_lshift
id|H2I_C1_DMA_SHIFT
)paren
op_or
(paren
l_int|1
op_lshift
id|H2I_C1_CLKID_SHIFT
)paren
op_or
(paren
id|hal2-&gt;dac.voices
op_lshift
id|H2I_C1_DATAT_SHIFT
)paren
)paren
suffix:semicolon
)brace
DECL|function|hal2_setup_adc
r_static
r_void
id|hal2_setup_adc
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_int
r_int
id|fifobeg
comma
id|fifoend
comma
id|highwater
comma
id|sample_size
suffix:semicolon
r_struct
id|hal2_pbus
op_star
id|pbus
op_assign
op_amp
id|hal2-&gt;adc.pbus
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;hal2_setup_adc&bslash;n&quot;
)paren
suffix:semicolon
id|sample_size
op_assign
l_int|2
op_star
id|hal2-&gt;adc.voices
suffix:semicolon
id|highwater
op_assign
(paren
id|sample_size
op_star
l_int|2
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* halfwords */
id|fifobeg
op_assign
(paren
l_int|4
op_star
l_int|4
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* record is second */
id|fifoend
op_assign
(paren
l_int|4
op_star
l_int|4
op_plus
id|sample_size
op_star
l_int|4
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* doublewords */
id|pbus-&gt;ctrl
op_assign
id|HPC3_PDMACTRL_RT
op_or
id|HPC3_PDMACTRL_RCV
op_or
id|HPC3_PDMACTRL_LD
op_or
(paren
id|highwater
op_lshift
l_int|8
)paren
op_or
(paren
id|fifobeg
op_lshift
l_int|16
)paren
op_or
(paren
id|fifoend
op_lshift
l_int|24
)paren
op_or
(paren
id|hal2-&gt;adc.format
op_amp
id|AFMT_S16_LE
ques
c_cond
id|HPC3_PDMACTRL_SEL
suffix:colon
l_int|0
)paren
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_ctrl
op_assign
id|HPC3_PDMACTRL_LD
suffix:semicolon
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
comma
id|H2I_DMA_PORT_EN_CODECR
)paren
suffix:semicolon
multiline_comment|/* Setup the HAL2 for record */
id|hal2_set_adc_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
multiline_comment|/* Set endianess */
r_if
c_cond
(paren
id|hal2-&gt;adc.format
op_amp
id|AFMT_S16_LE
)paren
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
comma
id|H2I_DMA_END_CODECR
)paren
suffix:semicolon
r_else
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
comma
id|H2I_DMA_END_CODECR
)paren
suffix:semicolon
multiline_comment|/* Set DMA bus */
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_DRV
comma
(paren
l_int|1
op_lshift
id|pbus-&gt;pbusnr
)paren
)paren
suffix:semicolon
multiline_comment|/* We are using 2nd Bresenham clock generator for record */
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_ADC_C1
comma
(paren
id|pbus-&gt;pbusnr
op_lshift
id|H2I_C1_DMA_SHIFT
)paren
op_or
(paren
l_int|2
op_lshift
id|H2I_C1_CLKID_SHIFT
)paren
op_or
(paren
id|hal2-&gt;adc.voices
op_lshift
id|H2I_C1_DATAT_SHIFT
)paren
)paren
suffix:semicolon
)brace
DECL|function|hal2_desc_addr
r_static
id|dma_addr_t
id|hal2_desc_addr
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
comma
r_int
id|i
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|i
OL
l_int|0
)paren
id|i
op_assign
id|codec-&gt;desc_count
op_minus
l_int|1
suffix:semicolon
r_return
id|codec-&gt;desc
(braket
id|i
)braket
dot
id|desc.pnext
suffix:semicolon
)brace
DECL|function|hal2_start_dac
r_static
r_void
id|hal2_start_dac
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_struct
id|hal2_codec
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
r_struct
id|hal2_pbus
op_star
id|pbus
op_assign
op_amp
id|dac-&gt;pbus
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_dptr
op_assign
id|hal2_desc_addr
c_func
(paren
id|dac
comma
id|dac-&gt;tail
)paren
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_ctrl
op_assign
id|pbus-&gt;ctrl
op_or
id|HPC3_PDMACTRL_ACT
suffix:semicolon
multiline_comment|/* enable DAC */
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
comma
id|H2I_DMA_PORT_EN_CODECTX
)paren
suffix:semicolon
)brace
DECL|function|hal2_start_adc
r_static
r_void
id|hal2_start_adc
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_struct
id|hal2_codec
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
r_struct
id|hal2_pbus
op_star
id|pbus
op_assign
op_amp
id|adc-&gt;pbus
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_dptr
op_assign
id|hal2_desc_addr
c_func
(paren
id|adc
comma
id|adc-&gt;head
)paren
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_ctrl
op_assign
id|pbus-&gt;ctrl
op_or
id|HPC3_PDMACTRL_ACT
suffix:semicolon
multiline_comment|/* enable ADC */
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
comma
id|H2I_DMA_PORT_EN_CODECR
)paren
suffix:semicolon
)brace
DECL|function|hal2_stop_dac
r_static
r_inline
r_void
id|hal2_stop_dac
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
id|hal2-&gt;dac.pbus.pbus-&gt;pbdma_ctrl
op_assign
id|HPC3_PDMACTRL_LD
suffix:semicolon
multiline_comment|/* The HAL2 itself may remain enabled safely */
)brace
DECL|function|hal2_stop_adc
r_static
r_inline
r_void
id|hal2_stop_adc
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
id|hal2-&gt;adc.pbus.pbus-&gt;pbdma_ctrl
op_assign
id|HPC3_PDMACTRL_LD
suffix:semicolon
)brace
DECL|function|hal2_alloc_dmabuf
r_static
r_int
id|hal2_alloc_dmabuf
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
comma
r_int
id|size
comma
r_int
id|count
comma
r_int
id|cntinfo
comma
r_int
id|dir
)paren
(brace
r_struct
id|hal2_desc
op_star
id|desc
comma
op_star
id|dma_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;allocating %dk DMA buffer.&bslash;n&quot;
comma
id|size
op_div
l_int|1024
)paren
suffix:semicolon
id|codec-&gt;buffer
op_assign
(paren
r_int
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|codec-&gt;buffer
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|desc
op_assign
id|dma_alloc_coherent
c_func
(paren
l_int|NULL
comma
id|count
op_star
r_sizeof
(paren
r_struct
id|hal2_desc
)paren
comma
(paren
id|dma_addr_t
op_star
)paren
op_amp
id|dma_addr
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|desc
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|codec-&gt;buffer
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|codec-&gt;desc
op_assign
id|desc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|desc-&gt;desc.pbuf
op_assign
id|dma_map_single
c_func
(paren
l_int|NULL
comma
(paren
r_void
op_star
)paren
(paren
id|codec-&gt;buffer
op_plus
id|i
op_star
id|H2_BLOCK_SIZE
)paren
comma
id|H2_BLOCK_SIZE
comma
id|dir
)paren
suffix:semicolon
id|desc-&gt;desc.cntinfo
op_assign
id|cntinfo
suffix:semicolon
id|desc-&gt;desc.pnext
op_assign
(paren
id|i
op_eq
id|count
op_minus
l_int|1
)paren
ques
c_cond
(paren
id|u32
)paren
id|dma_addr
suffix:colon
(paren
id|u32
)paren
(paren
id|dma_addr
op_plus
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|desc-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|desc
op_increment
suffix:semicolon
)brace
id|codec-&gt;desc_count
op_assign
id|count
suffix:semicolon
id|codec-&gt;head
op_assign
id|codec-&gt;tail
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_alloc_dac_dmabuf
r_static
r_int
id|hal2_alloc_dac_dmabuf
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
)paren
(brace
r_return
id|hal2_alloc_dmabuf
c_func
(paren
id|codec
comma
id|H2_DAC_BUFSIZE
comma
id|H2_DAC_BUFSIZE
op_div
id|H2_BLOCK_SIZE
comma
id|HPCDMA_XIE
op_or
id|HPCDMA_EOX
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
)brace
DECL|function|hal2_alloc_adc_dmabuf
r_static
r_int
id|hal2_alloc_adc_dmabuf
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
)paren
(brace
r_return
id|hal2_alloc_dmabuf
c_func
(paren
id|codec
comma
id|H2_ADC_BUFSIZE
comma
id|H2_ADC_BUFSIZE
op_div
id|H2_BLOCK_SIZE
comma
id|HPCDMA_XIE
op_or
id|H2_BLOCK_SIZE
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
)brace
DECL|function|hal2_free_dmabuf
r_static
r_void
id|hal2_free_dmabuf
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
comma
r_int
id|size
comma
r_int
id|dir
)paren
(brace
id|dma_addr_t
id|dma_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dma_addr
op_assign
id|codec-&gt;desc
(braket
id|codec-&gt;desc_count
op_minus
l_int|1
)braket
dot
id|desc.pnext
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|codec-&gt;desc_count
suffix:semicolon
id|i
op_increment
)paren
id|dma_unmap_single
c_func
(paren
l_int|NULL
comma
id|codec-&gt;desc
(braket
id|i
)braket
dot
id|desc.pbuf
comma
id|H2_BLOCK_SIZE
comma
id|dir
)paren
suffix:semicolon
id|dma_free_coherent
c_func
(paren
l_int|NULL
comma
id|codec-&gt;desc_count
op_star
r_sizeof
(paren
r_struct
id|hal2_desc
)paren
comma
(paren
r_void
op_star
)paren
id|codec-&gt;desc
comma
id|dma_addr
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|codec-&gt;buffer
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
)brace
DECL|function|hal2_free_dac_dmabuf
r_static
r_void
id|hal2_free_dac_dmabuf
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
)paren
(brace
r_return
id|hal2_free_dmabuf
c_func
(paren
id|codec
comma
id|H2_DAC_BUFSIZE
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
)brace
DECL|function|hal2_free_adc_dmabuf
r_static
r_void
id|hal2_free_adc_dmabuf
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
)paren
(brace
r_return
id|hal2_free_dmabuf
c_func
(paren
id|codec
comma
id|H2_ADC_BUFSIZE
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Add &squot;count&squot; bytes to &squot;buffer&squot; from DMA ring buffers. Return number of&n; * bytes added or -EFAULT if copy_from_user failed.&n; */
DECL|function|hal2_get_buffer
r_static
r_int
id|hal2_get_buffer
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|size
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_struct
id|hal2_desc
op_star
id|tail
suffix:semicolon
r_struct
id|hal2_codec
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;getting %d bytes &quot;
comma
id|count
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tail
op_assign
op_amp
id|adc-&gt;desc
(braket
id|adc-&gt;tail
)braket
suffix:semicolon
multiline_comment|/* enable DMA stream if there are no data */
r_if
c_cond
(paren
op_logical_neg
id|tail-&gt;cnt
op_logical_and
op_logical_neg
(paren
id|adc-&gt;pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_ISACT
)paren
)paren
id|hal2_start_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
r_while
c_loop
(paren
id|tail-&gt;cnt
OG
l_int|0
op_logical_and
id|count
OG
l_int|0
)paren
(brace
id|size
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
id|tail-&gt;cnt
comma
id|count
)paren
suffix:semicolon
id|buf
op_assign
op_amp
id|adc-&gt;buffer
(braket
(paren
id|adc-&gt;tail
op_plus
l_int|1
)paren
op_star
id|H2_BLOCK_SIZE
op_minus
id|tail-&gt;cnt
)braket
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dma_sync_single
c_func
(paren
l_int|NULL
comma
id|tail-&gt;desc.pbuf
comma
id|size
comma
id|DMA_FROM_DEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|buf
comma
id|size
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tail-&gt;cnt
op_sub_assign
id|size
suffix:semicolon
multiline_comment|/* buffer is empty, update tail pointer */
r_if
c_cond
(paren
id|tail-&gt;cnt
op_eq
l_int|0
)paren
(brace
id|tail-&gt;desc.cntinfo
op_assign
id|HPCDMA_XIE
op_or
id|H2_BLOCK_SIZE
suffix:semicolon
id|hal2_inc_tail
c_func
(paren
id|adc
)paren
suffix:semicolon
id|tail
op_assign
op_amp
id|adc-&gt;desc
(braket
id|adc-&gt;tail
)braket
suffix:semicolon
multiline_comment|/* enable DMA stream again if needed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|adc-&gt;pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_ISACT
)paren
)paren
id|hal2_start_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
id|buffer
op_add_assign
id|size
suffix:semicolon
id|ret
op_add_assign
id|size
suffix:semicolon
id|count
op_sub_assign
id|size
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;(%d) &quot;
comma
id|size
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
id|DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* &n; * Add &squot;count&squot; bytes from &squot;buffer&squot; to DMA ring buffers. Return number of&n; * bytes added or -EFAULT if copy_from_user failed.&n; */
DECL|function|hal2_add_buffer
r_static
r_int
id|hal2_add_buffer
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
id|size
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|hal2_desc
op_star
id|head
suffix:semicolon
r_struct
id|hal2_codec
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;adding %d bytes &quot;
comma
id|count
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|head
op_assign
op_amp
id|dac-&gt;desc
(braket
id|dac-&gt;head
)braket
suffix:semicolon
r_while
c_loop
(paren
id|head-&gt;cnt
op_eq
l_int|0
op_logical_and
id|count
OG
l_int|0
)paren
(brace
id|size
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
id|H2_BLOCK_SIZE
comma
id|count
)paren
suffix:semicolon
id|buf
op_assign
op_amp
id|dac-&gt;buffer
(braket
id|dac-&gt;head
op_star
id|H2_BLOCK_SIZE
)braket
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf
comma
id|buffer
comma
id|size
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dma_sync_single
c_func
(paren
l_int|NULL
comma
id|head-&gt;desc.pbuf
comma
id|size
comma
id|DMA_TO_DEVICE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|head-&gt;desc.cntinfo
op_assign
id|size
op_or
id|HPCDMA_XIE
suffix:semicolon
id|head-&gt;cnt
op_assign
id|size
suffix:semicolon
id|buffer
op_add_assign
id|size
suffix:semicolon
id|ret
op_add_assign
id|size
suffix:semicolon
id|count
op_sub_assign
id|size
suffix:semicolon
id|hal2_inc_head
c_func
(paren
id|dac
)paren
suffix:semicolon
id|head
op_assign
op_amp
id|dac-&gt;desc
(braket
id|dac-&gt;head
)braket
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;(%d) &quot;
comma
id|size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dac-&gt;pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_ISACT
)paren
op_logical_and
id|ret
OG
l_int|0
)paren
id|hal2_start_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
id|DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|macro|hal2_reset_dac_pointer
mdefine_line|#define hal2_reset_dac_pointer(hal2)&t;hal2_reset_pointer(hal2, 1)
DECL|macro|hal2_reset_adc_pointer
mdefine_line|#define hal2_reset_adc_pointer(hal2)&t;hal2_reset_pointer(hal2, 0)
DECL|function|hal2_reset_pointer
r_static
r_void
id|hal2_reset_pointer
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
r_int
id|is_dac
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|hal2_codec
op_star
id|codec
op_assign
(paren
id|is_dac
)paren
ques
c_cond
op_amp
id|hal2-&gt;dac
suffix:colon
op_amp
id|hal2-&gt;adc
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;hal2_reset_pointer&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|codec-&gt;desc_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|codec-&gt;desc
(braket
id|i
)braket
dot
id|cnt
op_assign
l_int|0
suffix:semicolon
id|codec-&gt;desc
(braket
id|i
)braket
dot
id|desc.cntinfo
op_assign
id|HPCDMA_XIE
op_or
(paren
id|is_dac
)paren
ques
c_cond
id|HPCDMA_EOX
suffix:colon
id|H2_BLOCK_SIZE
suffix:semicolon
)brace
id|codec-&gt;head
op_assign
id|codec-&gt;tail
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_sync_dac
r_static
r_int
id|hal2_sync_dac
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|hal2_codec
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|timeout
op_assign
l_int|1000
op_star
id|H2_BLOCK_SIZE
op_star
l_int|2
op_star
id|dac-&gt;voices
op_star
id|HZ
op_div
id|dac-&gt;sample_rate
op_div
l_int|900
suffix:semicolon
r_while
c_loop
(paren
id|dac-&gt;pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_ISACT
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|dac-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dac-&gt;desc
(braket
id|dac-&gt;tail
)braket
dot
id|cnt
)paren
id|ret
op_assign
op_minus
id|ETIME
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_dac_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dac-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hal2_write_mixer
r_static
r_int
id|hal2_write_mixer
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
r_int
id|index
comma
r_int
id|vol
)paren
(brace
r_int
r_int
id|l
comma
id|r
comma
id|tmp
suffix:semicolon
id|DEBUG_MIX
c_func
(paren
l_string|&quot;mixer %d write&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_ge
id|SOUND_MIXER_NRDEVICES
op_logical_or
op_logical_neg
id|mixtable
(braket
id|index
)braket
dot
id|avail
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|r
op_assign
(paren
id|vol
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|r
OG
l_int|100
)paren
id|r
op_assign
l_int|100
suffix:semicolon
id|l
op_assign
id|vol
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|l
OG
l_int|100
)paren
id|l
op_assign
l_int|100
suffix:semicolon
id|hal2-&gt;mixer.volume
(braket
id|mixtable
(braket
id|index
)braket
dot
id|idx
)braket
op_assign
id|l
op_or
(paren
id|r
op_lshift
l_int|8
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mixtable
(braket
id|index
)braket
dot
id|idx
)paren
(brace
r_case
id|H2_MIX_OUTPUT_ATT
suffix:colon
id|DEBUG_MIX
c_func
(paren
l_string|&quot;output attenuator %d,%d&bslash;n&quot;
comma
id|l
comma
id|r
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_or
id|l
)paren
(brace
id|tmp
op_assign
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|H2I_C2_L_ATT_M
op_or
id|H2I_C2_R_ATT_M
op_or
id|H2I_C2_MUTE
)paren
suffix:semicolon
multiline_comment|/* Attenuator has five bits */
id|l
op_assign
l_int|31
op_star
(paren
l_int|100
op_minus
id|l
)paren
op_div
l_int|99
suffix:semicolon
id|r
op_assign
l_int|31
op_star
(paren
l_int|100
op_minus
id|r
)paren
op_div
l_int|99
suffix:semicolon
id|DEBUG_MIX
c_func
(paren
l_string|&quot;left: %d, right %d&bslash;n&quot;
comma
id|l
comma
id|r
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|l
op_lshift
id|H2I_C2_L_ATT_SHIFT
)paren
op_amp
id|H2I_C2_L_ATT_M
suffix:semicolon
id|tmp
op_or_assign
(paren
id|r
op_lshift
id|H2I_C2_R_ATT_SHIFT
)paren
op_amp
id|H2I_C2_R_ATT_M
suffix:semicolon
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
comma
id|tmp
)paren
suffix:semicolon
)brace
r_else
id|hal2_i_setbit32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
comma
id|H2I_C2_MUTE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|H2_MIX_INPUT_GAIN
suffix:colon
id|DEBUG_MIX
c_func
(paren
l_string|&quot;input gain %d,%d&bslash;n&quot;
comma
id|l
comma
id|r
)paren
suffix:semicolon
id|tmp
op_assign
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_ADC_C2
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|H2I_C2_L_GAIN_M
op_or
id|H2I_C2_R_GAIN_M
)paren
suffix:semicolon
multiline_comment|/* Gain control has four bits */
id|l
op_assign
l_int|16
op_star
id|l
op_div
l_int|100
suffix:semicolon
id|r
op_assign
l_int|16
op_star
id|r
op_div
l_int|100
suffix:semicolon
id|DEBUG_MIX
c_func
(paren
l_string|&quot;left: %d, right %d&bslash;n&quot;
comma
id|l
comma
id|r
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|l
op_lshift
id|H2I_C2_L_GAIN_SHIFT
)paren
op_amp
id|H2I_C2_L_GAIN_M
suffix:semicolon
id|tmp
op_or_assign
(paren
id|r
op_lshift
id|H2I_C2_R_GAIN_SHIFT
)paren
op_amp
id|H2I_C2_R_GAIN_M
suffix:semicolon
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_ADC_C2
comma
id|tmp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_init_mixer
r_static
r_void
id|hal2_init_mixer
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mixtable
(braket
id|i
)braket
dot
id|avail
)paren
id|hal2-&gt;mixer.volume
(braket
id|mixtable
(braket
id|i
)braket
dot
id|idx
)braket
op_assign
l_int|100
op_or
(paren
l_int|100
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* disable attenuator */
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set max input gain */
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_ADC_C2
comma
id|H2I_C2_MUTE
op_or
(paren
id|H2I_C2_L_GAIN_M
op_lshift
id|H2I_C2_L_GAIN_SHIFT
)paren
op_or
(paren
id|H2I_C2_R_GAIN_M
op_lshift
id|H2I_C2_R_GAIN_SHIFT
)paren
)paren
suffix:semicolon
multiline_comment|/* set max volume */
id|hal2-&gt;mixer.master
op_assign
l_int|0xff
suffix:semicolon
id|hal2-&gt;vol_regs-&gt;left
op_assign
l_int|0xff
suffix:semicolon
id|hal2-&gt;vol_regs-&gt;right
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/*&n; * XXX: later i&squot;ll implement mixer for main volume which will be disabled&n; * by default. enabling it users will be allowed to have master volume level&n; * control on panel in their favourite X desktop&n; */
DECL|function|hal2_volume_control
r_static
r_void
id|hal2_volume_control
c_func
(paren
r_int
id|direction
)paren
(brace
r_int
r_int
id|master
op_assign
id|hal2_card
(braket
l_int|0
)braket
op_member_access_from_pointer
id|mixer.master
suffix:semicolon
r_struct
id|hal2_vol_regs
op_star
id|vol
op_assign
id|hal2_card
(braket
l_int|0
)braket
op_member_access_from_pointer
id|vol_regs
suffix:semicolon
multiline_comment|/* volume up */
r_if
c_cond
(paren
id|direction
OG
l_int|0
op_logical_and
id|master
OL
l_int|0xff
)paren
id|master
op_increment
suffix:semicolon
multiline_comment|/* volume down */
r_else
r_if
c_cond
(paren
id|direction
template_param
l_int|0
)paren
id|master
op_decrement
suffix:semicolon
multiline_comment|/* TODO: mute/unmute */
id|vol-&gt;left
op_assign
id|master
suffix:semicolon
id|vol-&gt;right
op_assign
id|master
suffix:semicolon
id|hal2_card
(braket
l_int|0
)braket
op_member_access_from_pointer
id|mixer.master
op_assign
id|master
suffix:semicolon
)brace
DECL|function|hal2_mixer_ioctl
r_static
r_int
id|hal2_mixer_ioctl
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_INFO
)paren
(brace
id|mixer_info
id|info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.id
comma
id|hal2str
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.name
comma
id|hal2str
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|info.modify_counter
op_assign
id|hal2-&gt;mixer.modcnt
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_OLD_MIXER_INFO
)paren
(brace
id|_old_mixer_info
id|info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.id
comma
id|hal2str
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.name
comma
id|hal2str
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|OSS_GETVERSION
)paren
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
l_char|&squot;M&squot;
op_logical_or
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
op_ne
r_sizeof
(paren
r_int
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
id|_IOC_READ
)paren
(brace
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
multiline_comment|/* Give the current record source */
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME */
r_break
suffix:semicolon
multiline_comment|/* Give the supported mixers, all of them support stereo */
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|val
op_assign
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mixtable
(braket
id|i
)braket
dot
id|avail
)paren
id|val
op_or_assign
l_int|1
op_lshift
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Arg contains a bit for each supported recording source */
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Read a specific mixer */
r_default
suffix:colon
(brace
)brace
(brace
r_int
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|SOUND_MIXER_NRDEVICES
op_logical_or
op_logical_neg
id|mixtable
(braket
id|i
)braket
dot
id|avail
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|val
op_assign
id|hal2-&gt;mixer.volume
(braket
id|mixtable
(braket
id|i
)braket
dot
id|idx
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_ne
(paren
id|_IOC_WRITE
op_or
id|_IOC_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hal2-&gt;mixer.modcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
multiline_comment|/* Arg contains a bit for each recording source */
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* FIXME */
r_default
suffix:colon
r_return
id|hal2_write_mixer
c_func
(paren
id|hal2
comma
id|_IOC_NR
c_func
(paren
id|cmd
)paren
comma
id|val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_open_mixdev
r_static
r_int
id|hal2_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hal2_card
op_star
id|hal2
op_assign
id|hal2_mixer_find_card
c_func
(paren
id|iminor
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hal2
)paren
(brace
id|file-&gt;private_data
op_assign
id|hal2
suffix:semicolon
r_return
id|nonseekable_open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|hal2_release_mixdev
r_static
r_int
id|hal2_release_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_ioctl_mixdev
r_static
r_int
id|hal2_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
id|hal2_mixer_ioctl
c_func
(paren
(paren
r_struct
id|hal2_card
op_star
)paren
id|file-&gt;private_data
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|hal2_ioctl
r_static
r_int
id|hal2_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|val
suffix:semicolon
r_struct
id|hal2_card
op_star
id|hal2
op_assign
(paren
r_struct
id|hal2_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|hal2_sync_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
id|DSP_CAP_DUPLEX
op_or
id|DSP_CAP_MULTI
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_adc_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_dac_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|val
op_assign
id|hal2_compute_rate
c_func
(paren
op_amp
id|hal2-&gt;adc
comma
id|val
)paren
suffix:semicolon
id|hal2-&gt;adc.sample_rate
op_assign
id|val
suffix:semicolon
id|hal2_set_adc_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|val
op_assign
id|hal2_compute_rate
c_func
(paren
op_amp
id|hal2-&gt;dac
comma
id|val
)paren
suffix:semicolon
id|hal2-&gt;dac.sample_rate
op_assign
id|val
suffix:semicolon
id|hal2_set_dac_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;adc.voices
op_assign
(paren
id|val
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|hal2_setup_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dac.voices
op_assign
(paren
id|val
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|hal2_setup_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;adc.voices
op_assign
(paren
id|val
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
id|hal2_setup_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dac.voices
op_assign
(paren
id|val
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
id|hal2_setup_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
)brace
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|val
op_assign
id|hal2-&gt;adc.voices
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|val
op_assign
id|hal2-&gt;dac.voices
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask */
r_return
id|put_user
c_func
(paren
id|H2_SUPPORTED_FORMATS
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Selects ONE fmt*/
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|H2_SUPPORTED_FORMATS
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;adc.format
op_assign
id|val
suffix:semicolon
id|hal2_setup_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dac.format
op_assign
id|val
suffix:semicolon
id|hal2_setup_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|val
op_assign
id|hal2-&gt;adc.format
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|val
op_assign
id|hal2-&gt;dac.format
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
(brace
id|audio_buf_info
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|hal2_codec
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info.fragments
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dac-&gt;desc_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dac-&gt;desc
(braket
id|i
)braket
dot
id|cnt
op_eq
l_int|0
)paren
id|info.fragments
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info.fragstotal
op_assign
id|dac-&gt;desc_count
suffix:semicolon
id|info.fragsize
op_assign
id|H2_BLOCK_SIZE
suffix:semicolon
id|info.bytes
op_assign
id|info.fragsize
op_star
id|info.fragments
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
(brace
id|audio_buf_info
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|hal2_codec
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info.fragments
op_assign
l_int|0
suffix:semicolon
id|info.bytes
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|adc-&gt;desc_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|adc-&gt;desc
(braket
id|i
)braket
dot
id|cnt
OG
l_int|0
)paren
(brace
id|info.fragments
op_increment
suffix:semicolon
id|info.bytes
op_add_assign
id|adc-&gt;desc
(braket
id|i
)braket
dot
id|cnt
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info.fragstotal
op_assign
id|adc-&gt;desc_count
suffix:semicolon
id|info.fragsize
op_assign
id|H2_BLOCK_SIZE
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_return
id|put_user
c_func
(paren
id|H2_BLOCK_SIZE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|val
op_assign
id|hal2-&gt;adc.sample_rate
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|val
op_assign
id|hal2-&gt;dac.sample_rate
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|val
op_assign
id|hal2-&gt;adc.voices
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|val
op_assign
id|hal2-&gt;dac.voices
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_return
id|put_user
c_func
(paren
l_int|16
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_return
id|hal2_mixer_ioctl
c_func
(paren
id|hal2
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|hal2_read
r_static
id|ssize_t
id|hal2_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|err
suffix:semicolon
r_struct
id|hal2_card
op_star
id|hal2
op_assign
(paren
r_struct
id|hal2_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|hal2_codec
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|adc-&gt;sem
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|err
op_assign
id|hal2_get_buffer
c_func
(paren
id|hal2
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
id|err
op_assign
id|err
op_eq
l_int|0
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
id|err
suffix:semicolon
)brace
r_else
(brace
r_do
(brace
multiline_comment|/* ~10% longer */
r_int
r_int
id|timeout
op_assign
l_int|1000
op_star
id|H2_BLOCK_SIZE
op_star
l_int|2
op_star
id|adc-&gt;voices
op_star
id|HZ
op_div
id|adc-&gt;sample_rate
op_div
l_int|900
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|ssize_t
id|cnt
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|hal2_get_buffer
c_func
(paren
id|hal2
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
id|count
op_sub_assign
id|err
suffix:semicolon
id|cnt
op_add_assign
id|err
suffix:semicolon
id|buffer
op_add_assign
id|err
suffix:semicolon
id|err
op_assign
id|cnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
l_int|0
op_logical_and
id|err
op_ge
l_int|0
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|adc-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adc-&gt;desc
(braket
id|adc-&gt;tail
)braket
dot
id|cnt
)paren
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|err
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|adc-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_adc_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
op_logical_and
id|err
op_ge
l_int|0
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|adc-&gt;sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|hal2_write
r_static
id|ssize_t
id|hal2_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|err
suffix:semicolon
r_char
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|buffer
suffix:semicolon
r_struct
id|hal2_card
op_star
id|hal2
op_assign
(paren
r_struct
id|hal2_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|hal2_codec
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|dac-&gt;sem
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|err
op_assign
id|hal2_add_buffer
c_func
(paren
id|hal2
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|err
op_assign
id|err
op_eq
l_int|0
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
id|err
suffix:semicolon
)brace
r_else
(brace
r_do
(brace
multiline_comment|/* ~10% longer */
r_int
r_int
id|timeout
op_assign
l_int|1000
op_star
id|H2_BLOCK_SIZE
op_star
l_int|2
op_star
id|dac-&gt;voices
op_star
id|HZ
op_div
id|dac-&gt;sample_rate
op_div
l_int|900
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|ssize_t
id|cnt
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|hal2_add_buffer
c_func
(paren
id|hal2
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
id|count
op_sub_assign
id|err
suffix:semicolon
id|cnt
op_add_assign
id|err
suffix:semicolon
id|buf
op_add_assign
id|err
suffix:semicolon
id|err
op_assign
id|cnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
l_int|0
op_logical_and
id|err
op_ge
l_int|0
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|dac-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dac-&gt;desc
(braket
id|dac-&gt;head
)braket
dot
id|cnt
)paren
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|err
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dac-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_dac_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
op_logical_and
id|err
op_ge
l_int|0
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dac-&gt;sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|hal2_poll
r_static
r_int
r_int
id|hal2_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_struct
id|hal2_card
op_star
id|hal2
op_assign
(paren
r_struct
id|hal2_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_struct
id|hal2_codec
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|adc-&gt;dma_wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adc-&gt;desc
(braket
id|adc-&gt;tail
)braket
dot
id|cnt
OG
l_int|0
)paren
id|mask
op_or_assign
id|POLLIN
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_struct
id|hal2_codec
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dac-&gt;dma_wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dac-&gt;desc
(braket
id|dac-&gt;head
)braket
dot
id|cnt
op_eq
l_int|0
)paren
id|mask
op_or_assign
id|POLLOUT
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|mask
suffix:semicolon
)brace
DECL|function|hal2_open
r_static
r_int
id|hal2_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|hal2_card
op_star
id|hal2
op_assign
id|hal2_dsp_find_card
c_func
(paren
id|iminor
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hal2
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|file-&gt;private_data
op_assign
id|hal2
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_struct
id|hal2_codec
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
r_if
c_cond
(paren
id|adc-&gt;usecount
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* OSS spec wanted us to use 8 bit, 8 kHz mono by default,&n;&t;&t; * but HAL2 can&squot;t do 8bit audio */
id|adc-&gt;format
op_assign
id|AFMT_S16_BE
suffix:semicolon
id|adc-&gt;voices
op_assign
l_int|1
suffix:semicolon
id|adc-&gt;sample_rate
op_assign
id|hal2_compute_rate
c_func
(paren
id|adc
comma
l_int|8000
)paren
suffix:semicolon
id|hal2_set_adc_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|err
op_assign
id|hal2_alloc_adc_dmabuf
c_func
(paren
id|adc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|hal2_setup_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|adc-&gt;usecount
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_struct
id|hal2_codec
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
r_if
c_cond
(paren
id|dac-&gt;usecount
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|dac-&gt;format
op_assign
id|AFMT_S16_BE
suffix:semicolon
id|dac-&gt;voices
op_assign
l_int|1
suffix:semicolon
id|dac-&gt;sample_rate
op_assign
id|hal2_compute_rate
c_func
(paren
id|dac
comma
l_int|8000
)paren
suffix:semicolon
id|hal2_set_dac_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|err
op_assign
id|hal2_alloc_dac_dmabuf
c_func
(paren
id|dac
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|hal2_setup_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|dac-&gt;usecount
op_increment
suffix:semicolon
)brace
r_return
id|nonseekable_open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
DECL|function|hal2_release
r_static
r_int
id|hal2_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hal2_card
op_star
id|hal2
op_assign
(paren
r_struct
id|hal2_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_struct
id|hal2_codec
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|adc-&gt;sem
)paren
suffix:semicolon
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_free_adc_dmabuf
c_func
(paren
id|adc
)paren
suffix:semicolon
id|adc-&gt;usecount
op_decrement
suffix:semicolon
id|up
c_func
(paren
op_amp
id|adc-&gt;sem
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_struct
id|hal2_codec
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dac-&gt;sem
)paren
suffix:semicolon
id|hal2_sync_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_free_dac_dmabuf
c_func
(paren
id|dac
)paren
suffix:semicolon
id|dac-&gt;usecount
op_decrement
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dac-&gt;sem
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hal2_audio_fops
r_static
r_struct
id|file_operations
id|hal2_audio_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|hal2_read
comma
dot
id|write
op_assign
id|hal2_write
comma
dot
id|poll
op_assign
id|hal2_poll
comma
dot
id|ioctl
op_assign
id|hal2_ioctl
comma
dot
id|open
op_assign
id|hal2_open
comma
dot
id|release
op_assign
id|hal2_release
comma
)brace
suffix:semicolon
DECL|variable|hal2_mixer_fops
r_static
r_struct
id|file_operations
id|hal2_mixer_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|ioctl
op_assign
id|hal2_ioctl_mixdev
comma
dot
id|open
op_assign
id|hal2_open_mixdev
comma
dot
id|release
op_assign
id|hal2_release_mixdev
comma
)brace
suffix:semicolon
DECL|function|hal2_init_codec
r_static
r_void
id|hal2_init_codec
c_func
(paren
r_struct
id|hal2_codec
op_star
id|codec
comma
r_struct
id|hpc3_regs
op_star
id|hpc3
comma
r_int
id|index
)paren
(brace
id|codec-&gt;pbus.pbusnr
op_assign
id|index
suffix:semicolon
id|codec-&gt;pbus.pbus
op_assign
op_amp
id|hpc3-&gt;pbdma
(braket
id|index
)braket
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|codec-&gt;dma_wait
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|codec-&gt;sem
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|codec-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|hal2_detect
r_static
r_int
id|hal2_detect
c_func
(paren
r_struct
id|hal2_card
op_star
id|hal2
)paren
(brace
r_int
r_int
id|board
comma
id|major
comma
id|minor
suffix:semicolon
r_int
r_int
id|rev
suffix:semicolon
multiline_comment|/* reset HAL2 */
id|hal2_isr_write
c_func
(paren
id|hal2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* release reset */
id|hal2_isr_write
c_func
(paren
id|hal2
comma
id|H2_ISR_GLOBAL_RESET_N
op_or
id|H2_ISR_CODEC_RESET_N
)paren
suffix:semicolon
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_RELAY_C
comma
id|H2I_RELAY_C_STATE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rev
op_assign
id|hal2_rev_look
c_func
(paren
id|hal2
)paren
)paren
op_amp
id|H2_REV_AUDIO_PRESENT
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|board
op_assign
(paren
id|rev
op_amp
id|H2_REV_BOARD_M
)paren
op_rshift
l_int|12
suffix:semicolon
id|major
op_assign
(paren
id|rev
op_amp
id|H2_REV_MAJOR_CHIP_M
)paren
op_rshift
l_int|4
suffix:semicolon
id|minor
op_assign
(paren
id|rev
op_amp
id|H2_REV_MINOR_CHIP_M
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SGI HAL2 revision %i.%i.%i&bslash;n&quot;
comma
id|board
comma
id|major
comma
id|minor
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_init_card
r_static
r_int
id|hal2_init_card
c_func
(paren
r_struct
id|hal2_card
op_star
op_star
id|phal2
comma
r_struct
id|hpc3_regs
op_star
id|hpc3
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|hal2_card
op_star
id|hal2
suffix:semicolon
id|hal2
op_assign
(paren
r_struct
id|hal2_card
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hal2_card
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hal2
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|hal2
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hal2_card
)paren
)paren
suffix:semicolon
id|hal2-&gt;ctl_regs
op_assign
(paren
r_struct
id|hal2_ctl_regs
op_star
)paren
id|hpc3-&gt;pbus_extregs
(braket
l_int|0
)braket
suffix:semicolon
id|hal2-&gt;aes_regs
op_assign
(paren
r_struct
id|hal2_aes_regs
op_star
)paren
id|hpc3-&gt;pbus_extregs
(braket
l_int|1
)braket
suffix:semicolon
id|hal2-&gt;vol_regs
op_assign
(paren
r_struct
id|hal2_vol_regs
op_star
)paren
id|hpc3-&gt;pbus_extregs
(braket
l_int|2
)braket
suffix:semicolon
id|hal2-&gt;syn_regs
op_assign
(paren
r_struct
id|hal2_syn_regs
op_star
)paren
id|hpc3-&gt;pbus_extregs
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hal2_detect
c_func
(paren
id|hal2
)paren
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_card
suffix:semicolon
)brace
id|hal2_init_codec
c_func
(paren
op_amp
id|hal2-&gt;dac
comma
id|hpc3
comma
l_int|0
)paren
suffix:semicolon
id|hal2_init_codec
c_func
(paren
op_amp
id|hal2-&gt;adc
comma
id|hpc3
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * All DMA channel interfaces in HAL2 are designed to operate with&n;&t; * PBUS programmed for 2 cycles in D3, 2 cycles in D4 and 2 cycles&n;&t; * in D5. HAL2 is a 16-bit device which can accept both big and little&n;&t; * endian format. It assumes that even address bytes are on high&n;&t; * portion of PBUS (15:8) and assumes that HPC3 is programmed to&n;&t; * accept a live (unsynchronized) version of P_DREQ_N from HAL2.&n;&t; */
DECL|macro|HAL2_PBUS_DMACFG
mdefine_line|#define HAL2_PBUS_DMACFG ((0 &lt;&lt; HPC3_DMACFG_D3R_SHIFT) | &bslash;&n;&t;&t;&t;  (2 &lt;&lt; HPC3_DMACFG_D4R_SHIFT) | &bslash;&n;&t;&t;&t;  (2 &lt;&lt; HPC3_DMACFG_D5R_SHIFT) | &bslash;&n;&t;&t;&t;  (0 &lt;&lt; HPC3_DMACFG_D3W_SHIFT) | &bslash;&n;&t;&t;&t;  (2 &lt;&lt; HPC3_DMACFG_D4W_SHIFT) | &bslash;&n;&t;&t;&t;  (2 &lt;&lt; HPC3_DMACFG_D5W_SHIFT) | &bslash;&n;&t;&t;&t;&t;HPC3_DMACFG_DS16 | &bslash;&n;&t;&t;&t;&t;HPC3_DMACFG_EVENHI | &bslash;&n;&t;&t;&t;&t;HPC3_DMACFG_RTIME | &bslash;&n;&t;&t;&t;  (8 &lt;&lt; HPC3_DMACFG_BURST_SHIFT) | &bslash;&n;&t;&t;&t;&t;HPC3_DMACFG_DRQLIVE)
multiline_comment|/*&n;&t; * Ignore what&squot;s mentioned in the specification and write value which&n;&t; * works in The Real World (TM)&n;&t; */
id|hpc3-&gt;pbus_dmacfg
(braket
id|hal2-&gt;dac.pbus.pbusnr
)braket
(braket
l_int|0
)braket
op_assign
l_int|0x8208844
suffix:semicolon
id|hpc3-&gt;pbus_dmacfg
(braket
id|hal2-&gt;adc.pbus.pbusnr
)braket
(braket
l_int|0
)braket
op_assign
l_int|0x8208844
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|SGI_HPCDMA_IRQ
comma
id|hal2_interrupt
comma
id|SA_SHIRQ
comma
id|hal2str
comma
id|hal2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HAL2: Can&squot;t get irq %d&bslash;n&quot;
comma
id|SGI_HPCDMA_IRQ
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|free_card
suffix:semicolon
)brace
id|hal2-&gt;dev_dsp
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|hal2_audio_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hal2-&gt;dev_dsp
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|hal2-&gt;dev_dsp
suffix:semicolon
r_goto
id|free_irq
suffix:semicolon
)brace
id|hal2-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|hal2_mixer_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hal2-&gt;dev_mixer
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|hal2-&gt;dev_mixer
suffix:semicolon
r_goto
id|unregister_dsp
suffix:semicolon
)brace
id|hal2_init_mixer
c_func
(paren
id|hal2
)paren
suffix:semicolon
op_star
id|phal2
op_assign
id|hal2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|unregister_dsp
suffix:colon
id|unregister_sound_dsp
c_func
(paren
id|hal2-&gt;dev_dsp
)paren
suffix:semicolon
id|free_irq
suffix:colon
id|free_irq
c_func
(paren
id|SGI_HPCDMA_IRQ
comma
id|hal2
)paren
suffix:semicolon
id|free_card
suffix:colon
id|kfree
c_func
(paren
id|hal2
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_extern
r_void
(paren
op_star
id|indy_volume_button
)paren
(paren
r_int
)paren
suffix:semicolon
multiline_comment|/* &n; * Assuming only one HAL2 card. Mail me if you ever meet machine with&n; * more than one.&n; */
DECL|function|init_hal2
r_static
r_int
id|__init
id|init_hal2
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|error
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCARDS
suffix:semicolon
id|i
op_increment
)paren
id|hal2_card
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|error
op_assign
id|hal2_init_card
c_func
(paren
op_amp
id|hal2_card
(braket
l_int|0
)braket
comma
id|hpc3c0
)paren
suffix:semicolon
multiline_comment|/* let Indy&squot;s volume buttons work */
r_if
c_cond
(paren
op_logical_neg
id|error
op_logical_and
op_logical_neg
id|ip22_is_fullhouse
c_func
(paren
)paren
)paren
id|indy_volume_button
op_assign
id|hal2_volume_control
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|exit_hal2
r_static
r_void
id|__exit
id|exit_hal2
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* unregister volume butons callback function */
id|indy_volume_button
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hal2_card
(braket
id|i
)braket
)paren
(brace
id|free_irq
c_func
(paren
id|SGI_HPCDMA_IRQ
comma
id|hal2_card
(braket
id|i
)braket
)paren
suffix:semicolon
id|unregister_sound_dsp
c_func
(paren
id|hal2_card
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_dsp
)paren
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|hal2_card
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hal2_card
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init_hal2
id|module_init
c_func
(paren
id|init_hal2
)paren
suffix:semicolon
DECL|variable|exit_hal2
id|module_exit
c_func
(paren
id|exit_hal2
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;OSS compatible driver for SGI HAL2 audio&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ladislav Michl&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
