multiline_comment|/*&n; *  Driver for HAL2 sound processors&n; *  Copyright (c) 2001, 2002 Ladislav Michl &lt;ladis@psi.cz&gt;&n; *  &n; *  Based on Ulf Carlsson&squot;s code.&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License version 2 as &n; *  published by the Free Software Foundation.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Supported devices:&n; *  /dev/dsp    standard dsp device, (mostly) OSS compatible&n; *  /dev/mixer&t;standard mixer device, (mostly) OSS compatible&n; *&n; *  BUGS:&n; *  + Driver currently supports indigo mode only.&n; *  + Recording doesn&squot;t work. I guess that it is caused by PBUS channel&n; *    misconfiguration, but until I get relevant info I&squot;m unable to fix it.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/sgi/sgint23.h&gt;
macro_line|#include &quot;hal2.h&quot;
macro_line|#if 0
mdefine_line|#define DEBUG(args...)&t;&t;printk(args)
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(args...)
macro_line|#endif
macro_line|#if 0 
mdefine_line|#define DEBUG_MIX(args...)&t;printk(args)
macro_line|#else
DECL|macro|DEBUG_MIX
mdefine_line|#define DEBUG_MIX(args...)
macro_line|#endif
DECL|macro|H2_INDIRECT_WAIT
mdefine_line|#define H2_INDIRECT_WAIT(regs)&t;while (regs-&gt;isr &amp; H2_ISR_TSTATUS);
DECL|macro|H2_READ_ADDR
mdefine_line|#define H2_READ_ADDR(addr)&t;(addr | (1&lt;&lt;7))
DECL|macro|H2_WRITE_ADDR
mdefine_line|#define H2_WRITE_ADDR(addr)&t;(addr)
DECL|variable|hal2str
r_static
r_char
op_star
id|hal2str
op_assign
l_string|&quot;HAL2 audio&quot;
suffix:semicolon
DECL|variable|ibuffers
r_static
r_int
id|ibuffers
op_assign
l_int|32
suffix:semicolon
DECL|variable|obuffers
r_static
r_int
id|obuffers
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* I doubt anyone has a machine with two HAL2 cards. It&squot;s possible to&n; * have two HPC&squot;s, so it is probably possible to have two HAL2 cards.&n; * Try to deal with it, but note that it is not tested.&n; */
DECL|macro|MAXCARDS
mdefine_line|#define MAXCARDS&t;2
DECL|variable|hal2_card
r_static
id|hal2_card_t
op_star
id|hal2_card
(braket
id|MAXCARDS
)braket
suffix:semicolon
r_static
r_const
r_struct
(brace
DECL|member|idx
DECL|member|avail
r_int
r_char
id|idx
suffix:colon
l_int|4
comma
id|avail
suffix:colon
l_int|1
suffix:semicolon
DECL|variable|mixtable
)brace
id|mixtable
(braket
id|SOUND_MIXER_NRDEVICES
)braket
op_assign
(brace
(braket
id|SOUND_MIXER_PCM
)braket
op_assign
(brace
id|H2_MIX_OUTPUT_ATT
comma
l_int|1
)brace
comma
multiline_comment|/* voice */
(braket
id|SOUND_MIXER_MIC
)braket
op_assign
(brace
id|H2_MIX_INPUT_GAIN
comma
l_int|1
)brace
comma
multiline_comment|/* mic */
)brace
suffix:semicolon
DECL|macro|H2_SUPPORTED_FORMATS
mdefine_line|#define H2_SUPPORTED_FORMATS&t;(AFMT_S16_LE | AFMT_S16_BE)
DECL|function|hal2_isr_write
r_static
r_inline
r_void
id|hal2_isr_write
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|val
)paren
(brace
id|hal2-&gt;ctl_regs-&gt;isr
op_assign
id|val
suffix:semicolon
)brace
DECL|function|hal2_isr_look
r_static
r_inline
id|u32
id|hal2_isr_look
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
r_return
id|hal2-&gt;ctl_regs-&gt;isr
suffix:semicolon
)brace
DECL|function|hal2_rev_look
r_static
r_inline
id|u32
id|hal2_rev_look
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
r_return
id|hal2-&gt;ctl_regs-&gt;rev
suffix:semicolon
)brace
macro_line|#if 0
r_static
id|u16
id|hal2_i_look16
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|addr
)paren
(brace
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
r_return
(paren
id|regs-&gt;idr0
op_amp
l_int|0xffff
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|hal2_i_look32
r_static
id|u32
id|hal2_i_look32
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|addr
)paren
(brace
id|u32
id|ret
suffix:semicolon
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|ret
op_assign
id|regs-&gt;idr0
op_amp
l_int|0xffff
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
op_or
l_int|0x1
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|ret
op_or_assign
(paren
id|regs-&gt;idr0
op_amp
l_int|0xffff
)paren
op_lshift
l_int|16
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hal2_i_write16
r_static
r_void
id|hal2_i_write16
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|addr
comma
id|u16
id|val
)paren
(brace
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|val
suffix:semicolon
id|regs-&gt;idr1
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|hal2_i_write32
r_static
r_void
id|hal2_i_write32
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|addr
comma
id|u32
id|val
)paren
(brace
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|regs-&gt;idr1
op_assign
id|val
op_rshift
l_int|16
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|hal2_i_setbit16
r_static
r_void
id|hal2_i_setbit16
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|addr
comma
id|u16
id|bit
)paren
(brace
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|regs-&gt;idr0
op_or
id|bit
suffix:semicolon
id|regs-&gt;idr1
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|hal2_i_setbit32
r_static
r_void
id|hal2_i_setbit32
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|addr
comma
id|u32
id|bit
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|tmp
op_assign
id|regs-&gt;idr0
op_or
(paren
id|regs-&gt;idr1
op_lshift
l_int|16
)paren
op_or
id|bit
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|tmp
op_amp
l_int|0xffff
suffix:semicolon
id|regs-&gt;idr1
op_assign
id|tmp
op_rshift
l_int|16
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
DECL|function|hal2_i_clearbit16
r_static
r_void
id|hal2_i_clearbit16
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|addr
comma
id|u16
id|bit
)paren
(brace
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|regs-&gt;idr0
op_amp
op_complement
id|bit
suffix:semicolon
id|regs-&gt;idr1
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|hal2_i_clearbit32
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
id|u32
id|addr
comma
id|u32
id|bit
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|hal2_ctl_regs_t
op_star
id|regs
op_assign
id|hal2-&gt;ctl_regs
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_READ_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|regs-&gt;idr0
op_or
(paren
id|regs-&gt;idr1
op_lshift
l_int|16
)paren
)paren
op_amp
op_complement
id|bit
suffix:semicolon
id|regs-&gt;idr0
op_assign
id|tmp
op_amp
l_int|0xffff
suffix:semicolon
id|regs-&gt;idr1
op_assign
id|tmp
op_rshift
l_int|16
suffix:semicolon
id|regs-&gt;idr2
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;idr3
op_assign
l_int|0
suffix:semicolon
id|regs-&gt;iar
op_assign
id|H2_WRITE_ADDR
c_func
(paren
id|addr
)paren
suffix:semicolon
id|H2_INDIRECT_WAIT
c_func
(paren
id|regs
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef HAL2_DEBUG
DECL|function|hal2_dump_regs
r_static
r_void
id|hal2_dump_regs
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;isr: %08hx &quot;
comma
id|hal2_isr_look
c_func
(paren
id|hal2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;rev: %08hx&bslash;n&quot;
comma
id|hal2_rev_look
c_func
(paren
id|hal2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;relay: %04hx&bslash;n&quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_RELAY_C
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;port en: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dma end: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dma drv: %04hx&bslash;n&quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_DMA_DRV
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;syn ctl: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_SYNTH_C
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aesrx ctl: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_AESRX_C
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;aestx ctl: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_AESTX_C
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dac ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_ADC_C1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dac ctl2: %08lx &quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_ADC_C2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;adc ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_DAC_C1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;adc ctl2: %08lx &quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;syn map: %04hx&bslash;n&quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_SYNTH_MAP_C
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bres1 ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_BRES1_C1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bres1 ctl2: %04lx &quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_BRES1_C2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bres2 ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_BRES2_C1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bres2 ctl2: %04lx &quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_BRES2_C2
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bres3 ctl1: %04hx &quot;
comma
id|hal2_i_look16
c_func
(paren
id|hal2
comma
id|H2I_BRES3_C1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bres3 ctl2: %04lx&bslash;n&quot;
comma
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_BRES3_C2
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|hal2_dsp_find_card
r_static
id|hal2_card_t
op_star
id|hal2_dsp_find_card
c_func
(paren
r_int
id|minor
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hal2_card
(braket
id|i
)braket
op_ne
l_int|NULL
op_logical_and
id|hal2_card
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_dsp
op_eq
id|minor
)paren
r_return
id|hal2_card
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|hal2_mixer_find_card
r_static
id|hal2_card_t
op_star
id|hal2_mixer_find_card
c_func
(paren
r_int
id|minor
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hal2_card
(braket
id|i
)braket
op_ne
l_int|NULL
op_logical_and
id|hal2_card
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
op_eq
id|minor
)paren
r_return
id|hal2_card
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|hal2_dac_interrupt
r_static
r_void
id|hal2_dac_interrupt
c_func
(paren
id|hal2_codec_t
op_star
id|dac
)paren
(brace
r_int
id|running
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dac-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* if tail buffer contains zero samples DMA stream was already&n;&t; * stopped */
id|running
op_assign
id|dac-&gt;tail-&gt;info.cnt
suffix:semicolon
id|dac-&gt;tail-&gt;info.cnt
op_assign
l_int|0
suffix:semicolon
id|dac-&gt;tail-&gt;info.desc.cntinfo
op_assign
id|HPCDMA_XIE
op_or
id|HPCDMA_EOX
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|dac-&gt;tail
comma
r_sizeof
(paren
r_struct
id|hpc_dma_desc
)paren
)paren
suffix:semicolon
multiline_comment|/* we just proccessed empty buffer, don&squot;t update tail pointer */
r_if
c_cond
(paren
id|running
)paren
id|dac-&gt;tail
op_assign
id|dac-&gt;tail-&gt;info.next
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dac-&gt;lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dac-&gt;dma_wait
)paren
suffix:semicolon
)brace
DECL|function|hal2_adc_interrupt
r_static
r_void
id|hal2_adc_interrupt
c_func
(paren
id|hal2_codec_t
op_star
id|adc
)paren
(brace
r_int
id|running
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|adc-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* if head buffer contains nonzero samples DMA stream was already&n;&t; * stopped */
id|running
op_assign
op_logical_neg
id|adc-&gt;head-&gt;info.cnt
suffix:semicolon
id|adc-&gt;head-&gt;info.cnt
op_assign
id|H2_BUFFER_SIZE
suffix:semicolon
id|adc-&gt;head-&gt;info.desc.cntinfo
op_assign
id|HPCDMA_XIE
op_or
id|HPCDMA_EOX
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|adc-&gt;head
comma
r_sizeof
(paren
r_struct
id|hpc_dma_desc
)paren
)paren
suffix:semicolon
multiline_comment|/* we just proccessed empty buffer, don&squot;t update head pointer */
r_if
c_cond
(paren
id|running
)paren
(brace
id|dma_cache_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|adc-&gt;head-&gt;data
comma
id|H2_BUFFER_SIZE
)paren
suffix:semicolon
id|adc-&gt;head
op_assign
id|adc-&gt;head-&gt;info.next
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|adc-&gt;lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|adc-&gt;dma_wait
)paren
suffix:semicolon
)brace
DECL|function|hal2_interrupt
r_static
id|irqreturn_t
id|hal2_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|hal2_card_t
op_star
id|hal2
op_assign
(paren
id|hal2_card_t
op_star
)paren
id|dev_id
suffix:semicolon
multiline_comment|/* decide what caused this interrupt */
r_if
c_cond
(paren
id|hal2-&gt;dac.pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_INT
)paren
id|hal2_dac_interrupt
c_func
(paren
op_amp
id|hal2-&gt;dac
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hal2-&gt;adc.pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_INT
)paren
id|hal2_adc_interrupt
c_func
(paren
op_amp
id|hal2-&gt;adc
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|hal2_compute_rate
r_static
r_int
id|hal2_compute_rate
c_func
(paren
id|hal2_codec_t
op_star
id|codec
comma
r_int
r_int
id|rate
)paren
(brace
r_int
r_int
id|inc
suffix:semicolon
multiline_comment|/* We default to 44.1 kHz and if it isn&squot;t possible to fall back to&n;&t; * 48.0 kHz with the needed adjustments of real_rate.&n;&t; */
id|DEBUG
c_func
(paren
l_string|&quot;rate: %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
multiline_comment|/* Refer to CS4216 data sheet */
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|50000
)paren
id|rate
op_assign
l_int|50000
suffix:semicolon
multiline_comment|/* Note: This is NOT the way they set up the bresenham clock generators&n;&t; * in the specification. I&squot;ve tried to implement that method but it&n;&t; * doesn&squot;t work. It&squot;s probably another silly bug in the spec.&n;&t; *&n;&t; * I accidently discovered this method while I was testing and it seems&n;&t; * to work very well with all frequencies, and thee shall follow rule #1&n;&t; * of programming :-)&n;&t; */
r_if
c_cond
(paren
l_int|44100
op_mod
id|rate
op_eq
l_int|0
)paren
(brace
id|inc
op_assign
l_int|44100
op_div
id|rate
suffix:semicolon
r_if
c_cond
(paren
id|inc
OL
l_int|1
)paren
id|inc
op_assign
l_int|1
suffix:semicolon
id|codec-&gt;master
op_assign
l_int|44100
suffix:semicolon
)brace
r_else
(brace
id|inc
op_assign
l_int|48000
op_div
id|rate
suffix:semicolon
r_if
c_cond
(paren
id|inc
OL
l_int|1
)paren
id|inc
op_assign
l_int|1
suffix:semicolon
id|rate
op_assign
l_int|48000
op_div
id|inc
suffix:semicolon
id|codec-&gt;master
op_assign
l_int|48000
suffix:semicolon
)brace
id|codec-&gt;inc
op_assign
id|inc
suffix:semicolon
id|codec-&gt;mod
op_assign
l_int|1
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;real_rate: %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
r_return
id|rate
suffix:semicolon
)brace
DECL|function|hal2_set_dac_rate
r_static
r_void
id|hal2_set_dac_rate
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
r_int
r_int
id|master
op_assign
id|hal2-&gt;dac.master
suffix:semicolon
r_int
id|inc
op_assign
id|hal2-&gt;dac.inc
suffix:semicolon
r_int
id|mod
op_assign
id|hal2-&gt;dac.mod
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;master: %d inc: %d mod: %d&bslash;n&quot;
comma
id|master
comma
id|inc
comma
id|mod
)paren
suffix:semicolon
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_BRES1_C1
comma
(paren
id|master
op_eq
l_int|44100
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_BRES1_C2
comma
(paren
(paren
l_int|0xffff
op_amp
(paren
id|mod
op_minus
id|inc
op_minus
l_int|1
)paren
)paren
op_lshift
l_int|16
)paren
op_or
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|hal2_set_adc_rate
r_static
r_void
id|hal2_set_adc_rate
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
r_int
r_int
id|master
op_assign
id|hal2-&gt;adc.master
suffix:semicolon
r_int
id|inc
op_assign
id|hal2-&gt;adc.inc
suffix:semicolon
r_int
id|mod
op_assign
id|hal2-&gt;adc.mod
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;master: %d inc: %d mod: %d&bslash;n&quot;
comma
id|master
comma
id|inc
comma
id|mod
)paren
suffix:semicolon
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_BRES2_C1
comma
(paren
id|master
op_eq
l_int|44100
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_BRES2_C2
comma
(paren
(paren
l_int|0xffff
op_amp
(paren
id|mod
op_minus
id|inc
op_minus
l_int|1
)paren
)paren
op_lshift
l_int|16
)paren
op_or
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|hal2_setup_dac
r_static
r_void
id|hal2_setup_dac
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
r_int
r_int
id|fifobeg
comma
id|fifoend
comma
id|highwater
comma
id|sample_size
suffix:semicolon
id|hal2_pbus_t
op_star
id|pbus
op_assign
op_amp
id|hal2-&gt;dac.pbus
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;hal2_setup_dac&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Now we set up some PBUS information. The PBUS needs information about&n;&t; * what portion of the fifo it will use. If it&squot;s receiving or&n;&t; * transmitting, and finally whether the stream is little endian or big&n;&t; * endian. The information is written later, on the start call.&n;&t; */
id|sample_size
op_assign
l_int|2
op_star
id|hal2-&gt;dac.voices
suffix:semicolon
multiline_comment|/* Fifo should be set to hold exactly four samples. Highwater mark&n;&t; * should be set to two samples. */
id|highwater
op_assign
(paren
id|sample_size
op_star
l_int|2
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* halfwords */
id|fifobeg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* playback is first */
id|fifoend
op_assign
(paren
id|sample_size
op_star
l_int|4
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* doublewords */
id|pbus-&gt;ctrl
op_assign
id|HPC3_PDMACTRL_RT
op_or
id|HPC3_PDMACTRL_LD
op_or
(paren
id|highwater
op_lshift
l_int|8
)paren
op_or
(paren
id|fifobeg
op_lshift
l_int|16
)paren
op_or
(paren
id|fifoend
op_lshift
l_int|24
)paren
suffix:semicolon
multiline_comment|/* We disable everything before we do anything at all */
id|pbus-&gt;pbus-&gt;pbdma_ctrl
op_assign
id|HPC3_PDMACTRL_LD
suffix:semicolon
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
comma
id|H2I_DMA_PORT_EN_CODECTX
)paren
suffix:semicolon
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_DRV
comma
(paren
l_int|1
op_lshift
id|pbus-&gt;pbusnr
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup the HAL2 for playback */
id|hal2_set_dac_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
multiline_comment|/* We are using 1st Bresenham clock generator for playback */
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_DAC_C1
comma
(paren
id|pbus-&gt;pbusnr
op_lshift
id|H2I_C1_DMA_SHIFT
)paren
op_or
(paren
l_int|1
op_lshift
id|H2I_C1_CLKID_SHIFT
)paren
op_or
(paren
id|hal2-&gt;dac.voices
op_lshift
id|H2I_C1_DATAT_SHIFT
)paren
)paren
suffix:semicolon
)brace
DECL|function|hal2_setup_adc
r_static
r_void
id|hal2_setup_adc
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
r_int
r_int
id|fifobeg
comma
id|fifoend
comma
id|highwater
comma
id|sample_size
suffix:semicolon
id|hal2_pbus_t
op_star
id|pbus
op_assign
op_amp
id|hal2-&gt;adc.pbus
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;hal2_setup_adc&bslash;n&quot;
)paren
suffix:semicolon
id|sample_size
op_assign
l_int|2
op_star
id|hal2-&gt;adc.voices
suffix:semicolon
id|highwater
op_assign
(paren
id|sample_size
op_star
l_int|2
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* halfwords */
id|fifobeg
op_assign
(paren
l_int|4
op_star
l_int|4
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* record is second */
id|fifoend
op_assign
(paren
l_int|4
op_star
l_int|4
op_plus
id|sample_size
op_star
l_int|4
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* doublewords */
id|pbus-&gt;ctrl
op_assign
id|HPC3_PDMACTRL_RT
op_or
id|HPC3_PDMACTRL_RCV
op_or
id|HPC3_PDMACTRL_LD
op_or
(paren
id|highwater
op_lshift
l_int|8
)paren
op_or
(paren
id|fifobeg
op_lshift
l_int|16
)paren
op_or
(paren
id|fifoend
op_lshift
l_int|24
)paren
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_ctrl
op_assign
id|HPC3_PDMACTRL_LD
suffix:semicolon
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
comma
id|H2I_DMA_PORT_EN_CODECR
)paren
suffix:semicolon
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_DRV
comma
(paren
l_int|1
op_lshift
id|pbus-&gt;pbusnr
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup the HAL2 for record */
id|hal2_set_adc_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
multiline_comment|/* We are using 2nd Bresenham clock generator for record */
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_ADC_C1
comma
(paren
id|pbus-&gt;pbusnr
op_lshift
id|H2I_C1_DMA_SHIFT
)paren
op_or
(paren
l_int|2
op_lshift
id|H2I_C1_CLKID_SHIFT
)paren
op_or
(paren
id|hal2-&gt;adc.voices
op_lshift
id|H2I_C1_DATAT_SHIFT
)paren
)paren
suffix:semicolon
)brace
DECL|function|hal2_start_dac
r_static
r_void
id|hal2_start_dac
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
id|hal2_pbus_t
op_star
id|pbus
op_assign
op_amp
id|hal2-&gt;dac.pbus
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;hal2_start_dac&bslash;n&quot;
)paren
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_dptr
op_assign
id|PHYSADDR
c_func
(paren
id|hal2-&gt;dac.tail
)paren
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_ctrl
op_assign
id|pbus-&gt;ctrl
op_or
id|HPC3_PDMACTRL_ACT
suffix:semicolon
multiline_comment|/* set endianess */
r_if
c_cond
(paren
id|hal2-&gt;dac.format
op_amp
id|AFMT_S16_LE
)paren
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
comma
id|H2I_DMA_END_CODECTX
)paren
suffix:semicolon
r_else
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
comma
id|H2I_DMA_END_CODECTX
)paren
suffix:semicolon
multiline_comment|/* set DMA bus */
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_DRV
comma
(paren
l_int|1
op_lshift
id|pbus-&gt;pbusnr
)paren
)paren
suffix:semicolon
multiline_comment|/* enable DAC */
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
comma
id|H2I_DMA_PORT_EN_CODECTX
)paren
suffix:semicolon
)brace
DECL|function|hal2_start_adc
r_static
r_void
id|hal2_start_adc
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
id|hal2_pbus_t
op_star
id|pbus
op_assign
op_amp
id|hal2-&gt;adc.pbus
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;hal2_start_adc&bslash;n&quot;
)paren
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_dptr
op_assign
id|PHYSADDR
c_func
(paren
id|hal2-&gt;adc.head
)paren
suffix:semicolon
id|pbus-&gt;pbus-&gt;pbdma_ctrl
op_assign
id|pbus-&gt;ctrl
op_or
id|HPC3_PDMACTRL_ACT
suffix:semicolon
multiline_comment|/* set endianess */
r_if
c_cond
(paren
id|hal2-&gt;adc.format
op_amp
id|AFMT_S16_LE
)paren
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
comma
id|H2I_DMA_END_CODECR
)paren
suffix:semicolon
r_else
id|hal2_i_clearbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_END
comma
id|H2I_DMA_END_CODECR
)paren
suffix:semicolon
multiline_comment|/* set DMA bus */
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_DRV
comma
(paren
l_int|1
op_lshift
id|pbus-&gt;pbusnr
)paren
)paren
suffix:semicolon
multiline_comment|/* enable ADC */
id|hal2_i_setbit16
c_func
(paren
id|hal2
comma
id|H2I_DMA_PORT_EN
comma
id|H2I_DMA_PORT_EN_CODECR
)paren
suffix:semicolon
)brace
DECL|function|hal2_stop_dac
r_static
r_inline
r_void
id|hal2_stop_dac
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;hal2_stop_dac&bslash;n&quot;
)paren
suffix:semicolon
id|hal2-&gt;dac.pbus.pbus-&gt;pbdma_ctrl
op_assign
id|HPC3_PDMACTRL_LD
suffix:semicolon
multiline_comment|/* The HAL2 itself may remain enabled safely */
)brace
DECL|function|hal2_stop_adc
r_static
r_inline
r_void
id|hal2_stop_adc
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;hal2_stop_adc&bslash;n&quot;
)paren
suffix:semicolon
id|hal2-&gt;adc.pbus.pbus-&gt;pbdma_ctrl
op_assign
id|HPC3_PDMACTRL_LD
suffix:semicolon
)brace
DECL|macro|hal2_alloc_dac_dmabuf
mdefine_line|#define hal2_alloc_dac_dmabuf(hal2)&t;hal2_alloc_dmabuf(hal2, 1)
DECL|macro|hal2_alloc_adc_dmabuf
mdefine_line|#define hal2_alloc_adc_dmabuf(hal2)&t;hal2_alloc_dmabuf(hal2, 0)
DECL|function|hal2_alloc_dmabuf
r_static
r_int
id|hal2_alloc_dmabuf
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_int
id|is_dac
)paren
(brace
r_int
id|buffers
comma
id|cntinfo
suffix:semicolon
id|hal2_buf_t
op_star
id|buf
comma
op_star
id|prev
suffix:semicolon
id|hal2_codec_t
op_star
id|codec
suffix:semicolon
r_if
c_cond
(paren
id|is_dac
)paren
(brace
id|codec
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
id|buffers
op_assign
id|obuffers
suffix:semicolon
id|cntinfo
op_assign
id|HPCDMA_XIE
op_or
id|HPCDMA_EOX
suffix:semicolon
)brace
r_else
(brace
id|codec
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
id|buffers
op_assign
id|ibuffers
suffix:semicolon
id|cntinfo
op_assign
id|HPCDMA_XIE
op_or
id|H2_BUFFER_SIZE
suffix:semicolon
)brace
id|DEBUG
c_func
(paren
l_string|&quot;allocating %d DMA buffers.&bslash;n&quot;
comma
id|buffers
)paren
suffix:semicolon
id|buf
op_assign
(paren
id|hal2_buf_t
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|codec-&gt;head
op_assign
id|buf
suffix:semicolon
id|codec-&gt;tail
op_assign
id|buf
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|buffers
)paren
(brace
id|buf-&gt;info.desc.pbuf
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|buf-&gt;data
)paren
suffix:semicolon
id|buf-&gt;info.desc.cntinfo
op_assign
id|cntinfo
suffix:semicolon
id|buf-&gt;info.cnt
op_assign
l_int|0
suffix:semicolon
id|prev
op_assign
id|buf
suffix:semicolon
id|buf
op_assign
(paren
id|hal2_buf_t
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HAL2: Not enough memory for DMA buffer.&bslash;n&quot;
)paren
suffix:semicolon
id|buf
op_assign
id|codec-&gt;head
suffix:semicolon
r_while
c_loop
(paren
id|buf
)paren
(brace
id|prev
op_assign
id|buf
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|buf
)paren
suffix:semicolon
id|buf
op_assign
id|prev-&gt;info.next
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|prev-&gt;info.next
op_assign
id|buf
suffix:semicolon
id|prev-&gt;info.desc.pnext
op_assign
id|PHYSADDR
c_func
(paren
id|buf
)paren
suffix:semicolon
multiline_comment|/* The PBUS can prolly not read this stuff when it&squot;s in&n;&t;&t; * the cache so we have to flush it back to main memory&n;&t;&t; */
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|prev
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
id|buf-&gt;info.desc.pbuf
op_assign
id|PHYSADDR
c_func
(paren
op_amp
id|buf-&gt;data
)paren
suffix:semicolon
id|buf-&gt;info.desc.cntinfo
op_assign
id|cntinfo
suffix:semicolon
id|buf-&gt;info.cnt
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;info.next
op_assign
id|codec-&gt;head
suffix:semicolon
id|buf-&gt;info.desc.pnext
op_assign
id|PHYSADDR
c_func
(paren
id|codec-&gt;head
)paren
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|buf
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|hal2_free_dac_dmabuf
mdefine_line|#define hal2_free_dac_dmabuf(hal2)&t;hal2_free_dmabuf(hal2, 1)
DECL|macro|hal2_free_adc_dmabuf
mdefine_line|#define hal2_free_adc_dmabuf(hal2)&t;hal2_free_dmabuf(hal2, 0)
DECL|function|hal2_free_dmabuf
r_static
r_void
id|hal2_free_dmabuf
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_int
id|is_dac
)paren
(brace
id|hal2_buf_t
op_star
id|buf
comma
op_star
id|next
suffix:semicolon
id|hal2_codec_t
op_star
id|codec
op_assign
(paren
id|is_dac
)paren
ques
c_cond
op_amp
id|hal2-&gt;dac
suffix:colon
op_amp
id|hal2-&gt;adc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|codec-&gt;head
)paren
r_return
suffix:semicolon
id|buf
op_assign
id|codec-&gt;head-&gt;info.next
suffix:semicolon
id|codec-&gt;head-&gt;info.next
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|buf
)paren
(brace
id|next
op_assign
id|buf-&gt;info.next
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|buf
)paren
suffix:semicolon
id|buf
op_assign
id|next
suffix:semicolon
)brace
id|codec-&gt;head
op_assign
id|codec-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* &n; * Add &squot;count&squot; bytes to &squot;buffer&squot; from DMA ring buffers. Return number of&n; * bytes added or -EFAULT if copy_from_user failed.&n; */
DECL|function|hal2_get_buffer
r_static
r_int
id|hal2_get_buffer
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|size
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|hal2_codec_t
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;getting %d bytes &quot;
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* enable DMA stream if there are no data */
r_if
c_cond
(paren
op_logical_neg
(paren
id|adc-&gt;pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_ISACT
)paren
op_logical_and
id|adc-&gt;tail-&gt;info.cnt
op_eq
l_int|0
)paren
id|hal2_start_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;... &quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|adc-&gt;tail-&gt;info.cnt
OG
l_int|0
op_logical_and
id|count
OG
l_int|0
)paren
(brace
id|size
op_assign
id|min
c_func
(paren
id|adc-&gt;tail-&gt;info.cnt
comma
id|count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
op_amp
id|adc-&gt;tail-&gt;data
(braket
id|H2_BUFFER_SIZE
op_minus
id|size
)braket
comma
id|size
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|adc-&gt;tail-&gt;info.cnt
op_sub_assign
id|size
suffix:semicolon
multiline_comment|/* buffer is empty, update tail pointer */
r_if
c_cond
(paren
id|adc-&gt;tail-&gt;info.cnt
op_eq
l_int|0
)paren
(brace
id|adc-&gt;tail-&gt;info.desc.cntinfo
op_assign
id|HPCDMA_XIE
op_or
id|H2_BUFFER_SIZE
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|adc-&gt;tail
comma
r_sizeof
(paren
r_struct
id|hpc_dma_desc
)paren
)paren
suffix:semicolon
id|adc-&gt;tail
op_assign
id|adc-&gt;tail-&gt;info.next
suffix:semicolon
multiline_comment|/* enable DMA stream again if needed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|adc-&gt;pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_ISACT
)paren
)paren
id|hal2_start_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
id|buffer
op_add_assign
id|size
suffix:semicolon
id|ret
op_add_assign
id|size
suffix:semicolon
id|count
op_sub_assign
id|size
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;(%d) &quot;
comma
id|size
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
id|DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* &n; * Add &squot;count&squot; bytes from &squot;buffer&squot; to DMA ring buffers. Return number of&n; * bytes added or -EFAULT if copy_from_user failed.&n; */
DECL|function|hal2_add_buffer
r_static
r_int
id|hal2_add_buffer
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|size
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|hal2_codec_t
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;adding %d bytes &quot;
comma
id|count
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dac-&gt;head-&gt;info.cnt
op_eq
l_int|0
op_logical_and
id|count
OG
l_int|0
)paren
(brace
id|size
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
id|H2_BUFFER_SIZE
comma
id|count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dac-&gt;head-&gt;data
comma
id|buffer
comma
id|size
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dac-&gt;head-&gt;info.desc.cntinfo
op_assign
id|size
op_or
id|HPCDMA_XIE
suffix:semicolon
id|dac-&gt;head-&gt;info.cnt
op_assign
id|size
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|dac-&gt;head
comma
id|size
op_plus
id|PAGE_SIZE
op_minus
id|H2_BUFFER_SIZE
)paren
suffix:semicolon
id|buffer
op_add_assign
id|size
suffix:semicolon
id|ret
op_add_assign
id|size
suffix:semicolon
id|count
op_sub_assign
id|size
suffix:semicolon
id|dac-&gt;head
op_assign
id|dac-&gt;head-&gt;info.next
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;(%d) &quot;
comma
id|size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dac-&gt;pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_ISACT
)paren
op_logical_and
id|ret
OG
l_int|0
)paren
id|hal2_start_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
id|DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|macro|hal2_reset_dac_pointer
mdefine_line|#define hal2_reset_dac_pointer(hal2)&t;hal2_reset_pointer(hal2, 1)
DECL|macro|hal2_reset_adc_pointer
mdefine_line|#define hal2_reset_adc_pointer(hal2)&t;hal2_reset_pointer(hal2, 0)
DECL|function|hal2_reset_pointer
r_static
r_void
id|hal2_reset_pointer
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_int
id|is_dac
)paren
(brace
id|hal2_codec_t
op_star
id|codec
op_assign
(paren
id|is_dac
)paren
ques
c_cond
op_amp
id|hal2-&gt;dac
suffix:colon
op_amp
id|hal2-&gt;adc
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;hal2_reset_pointer&bslash;n&quot;
)paren
suffix:semicolon
id|codec-&gt;tail
op_assign
id|codec-&gt;head
suffix:semicolon
r_do
(brace
id|codec-&gt;tail-&gt;info.desc.cntinfo
op_assign
id|HPCDMA_XIE
op_or
(paren
id|is_dac
)paren
ques
c_cond
id|HPCDMA_EOX
suffix:colon
id|H2_BUFFER_SIZE
suffix:semicolon
id|codec-&gt;tail-&gt;info.cnt
op_assign
l_int|0
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
(paren
r_int
r_int
)paren
id|codec-&gt;tail
comma
r_sizeof
(paren
r_struct
id|hpc_dma_desc
)paren
)paren
suffix:semicolon
id|codec-&gt;tail
op_assign
id|codec-&gt;tail-&gt;info.next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|codec-&gt;tail
op_ne
id|codec-&gt;head
)paren
suffix:semicolon
)brace
DECL|function|hal2_sync_dac
r_static
r_int
id|hal2_sync_dac
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|hal2_codec_t
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|timeout
op_assign
l_int|1000
op_star
id|H2_BUFFER_SIZE
op_star
l_int|2
op_star
id|dac-&gt;voices
op_star
id|HZ
op_div
id|dac-&gt;sample_rate
op_div
l_int|900
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dac-&gt;sem
)paren
suffix:semicolon
r_while
c_loop
(paren
id|dac-&gt;pbus.pbus-&gt;pbdma_ctrl
op_amp
id|HPC3_PDMACTRL_ISACT
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|dac-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|timeout
)paren
)paren
multiline_comment|/* We may get bogus timeout when system is &n;&t;&t;&t; * heavily loaded */
r_if
c_cond
(paren
id|dac-&gt;tail-&gt;info.cnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HAL2: timeout...&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ETIME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_dac_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dac-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dac-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hal2_write_mixer
r_static
r_int
id|hal2_write_mixer
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_int
id|index
comma
r_int
id|vol
)paren
(brace
r_int
r_int
id|l
comma
id|r
suffix:semicolon
id|DEBUG_MIX
c_func
(paren
l_string|&quot;mixer %d write&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_ge
id|SOUND_MIXER_NRDEVICES
op_logical_or
op_logical_neg
id|mixtable
(braket
id|index
)braket
dot
id|avail
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|r
op_assign
(paren
id|vol
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|r
OG
l_int|100
)paren
id|r
op_assign
l_int|100
suffix:semicolon
id|l
op_assign
id|vol
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|l
OG
l_int|100
)paren
id|l
op_assign
l_int|100
suffix:semicolon
id|hal2-&gt;mixer.volume
(braket
id|mixtable
(braket
id|index
)braket
dot
id|idx
)braket
op_assign
id|l
op_or
(paren
id|r
op_lshift
l_int|8
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mixtable
(braket
id|index
)braket
dot
id|idx
)paren
(brace
r_case
id|H2_MIX_OUTPUT_ATT
suffix:colon
(brace
id|DEBUG_MIX
c_func
(paren
l_string|&quot;output attenuator %d,%d&bslash;n&quot;
comma
id|l
comma
id|r
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_or
id|l
)paren
(brace
r_int
r_int
id|tmp
op_assign
id|hal2_i_look32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
(paren
id|H2I_C2_L_ATT_M
op_or
id|H2I_C2_R_ATT_M
op_or
id|H2I_C2_MUTE
)paren
suffix:semicolon
multiline_comment|/* Attenuator has five bits */
id|l
op_assign
(paren
l_int|31
op_star
(paren
l_int|100
op_minus
id|l
)paren
op_div
l_int|99
)paren
suffix:semicolon
id|r
op_assign
(paren
l_int|31
op_star
(paren
l_int|100
op_minus
id|r
)paren
op_div
l_int|99
)paren
suffix:semicolon
id|DEBUG_MIX
c_func
(paren
l_string|&quot;left: %d, right %d&bslash;n&quot;
comma
id|l
comma
id|r
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|l
op_lshift
id|H2I_C2_L_ATT_SHIFT
)paren
op_amp
id|H2I_C2_L_ATT_M
suffix:semicolon
id|tmp
op_or_assign
(paren
id|r
op_lshift
id|H2I_C2_R_ATT_SHIFT
)paren
op_amp
id|H2I_C2_R_ATT_M
suffix:semicolon
id|hal2_i_write32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
comma
id|tmp
)paren
suffix:semicolon
)brace
r_else
id|hal2_i_setbit32
c_func
(paren
id|hal2
comma
id|H2I_DAC_C2
comma
id|H2I_C2_MUTE
)paren
suffix:semicolon
)brace
r_case
id|H2_MIX_INPUT_GAIN
suffix:colon
(brace
multiline_comment|/* TODO */
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_init_mixer
r_static
r_void
id|hal2_init_mixer
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
id|hal2_write_mixer
c_func
(paren
id|hal2
comma
id|i
comma
l_int|100
op_or
(paren
l_int|100
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
)brace
DECL|function|hal2_mixer_ioctl
r_static
r_int
id|hal2_mixer_ioctl
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_MIXER_INFO
)paren
(brace
id|mixer_info
id|info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.id
comma
id|hal2str
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.name
comma
id|hal2str
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|info.modify_counter
op_assign
id|hal2-&gt;mixer.modcnt
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|SOUND_OLD_MIXER_INFO
)paren
(brace
id|_old_mixer_info
id|info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.id
comma
id|hal2str
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.name
comma
id|hal2str
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|OSS_GETVERSION
)paren
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
l_char|&squot;M&squot;
op_logical_or
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
op_ne
r_sizeof
(paren
r_int
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
id|_IOC_READ
)paren
(brace
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
multiline_comment|/* Give the current record source */
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME */
r_break
suffix:semicolon
multiline_comment|/* Give the supported mixers, all of them support stereo */
r_case
id|SOUND_MIXER_DEVMASK
suffix:colon
r_case
id|SOUND_MIXER_STEREODEVS
suffix:colon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|val
op_assign
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mixtable
(braket
id|i
)braket
dot
id|avail
)paren
id|val
op_or_assign
l_int|1
op_lshift
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Arg contains a bit for each supported recording source */
r_case
id|SOUND_MIXER_RECMASK
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_MIXER_CAPS
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Read a specific mixer */
r_default
suffix:colon
(brace
)brace
(brace
r_int
id|i
op_assign
id|_IOC_NR
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|SOUND_MIXER_NRDEVICES
op_logical_or
op_logical_neg
id|mixtable
(braket
id|i
)braket
dot
id|avail
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|val
op_assign
id|hal2-&gt;mixer.volume
(braket
id|mixtable
(braket
id|i
)braket
dot
id|idx
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_ne
(paren
id|_IOC_WRITE
op_or
id|_IOC_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hal2-&gt;mixer.modcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
(brace
multiline_comment|/* Arg contains a bit for each recording source */
r_case
id|SOUND_MIXER_RECSRC
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* FIXME */
r_default
suffix:colon
r_return
id|hal2_write_mixer
c_func
(paren
id|hal2
comma
id|_IOC_NR
c_func
(paren
id|cmd
)paren
comma
id|val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_open_mixdev
r_static
r_int
id|hal2_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|hal2_card_t
op_star
id|hal2
op_assign
id|hal2_mixer_find_card
c_func
(paren
id|iminor
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hal2
)paren
(brace
id|file-&gt;private_data
op_assign
id|hal2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|hal2_release_mixdev
r_static
r_int
id|hal2_release_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_ioctl_mixdev
r_static
r_int
id|hal2_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
id|hal2_mixer_ioctl
c_func
(paren
(paren
id|hal2_card_t
op_star
)paren
id|file-&gt;private_data
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|hal2_ioctl
r_static
r_int
id|hal2_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|val
suffix:semicolon
id|hal2_card_t
op_star
id|hal2
op_assign
(paren
id|hal2_card_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|hal2_sync_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
id|DSP_CAP_DUPLEX
op_or
id|DSP_CAP_MULTI
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_adc_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_dac_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|val
op_assign
id|hal2_compute_rate
c_func
(paren
op_amp
id|hal2-&gt;adc
comma
id|val
)paren
suffix:semicolon
id|hal2-&gt;adc.sample_rate
op_assign
id|val
suffix:semicolon
id|hal2_set_adc_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|val
op_assign
id|hal2_compute_rate
c_func
(paren
op_amp
id|hal2-&gt;dac
comma
id|val
)paren
suffix:semicolon
id|hal2-&gt;dac.sample_rate
op_assign
id|val
suffix:semicolon
id|hal2_set_dac_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;adc.voices
op_assign
(paren
id|val
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|hal2_setup_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dac.voices
op_assign
(paren
id|val
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
id|hal2_setup_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;adc.voices
op_assign
(paren
id|val
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
id|hal2_setup_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dac.voices
op_assign
(paren
id|val
op_eq
l_int|1
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
id|hal2_setup_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
)brace
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|val
op_assign
id|hal2-&gt;adc.voices
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|val
op_assign
id|hal2-&gt;dac.voices
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask */
r_return
id|put_user
c_func
(paren
id|H2_SUPPORTED_FORMATS
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Selects ONE fmt*/
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|H2_SUPPORTED_FORMATS
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;adc.format
op_assign
id|val
suffix:semicolon
id|hal2_setup_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dac.format
op_assign
id|val
suffix:semicolon
id|hal2_setup_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|val
op_assign
id|hal2-&gt;adc.format
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|val
op_assign
id|hal2-&gt;dac.format
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
(brace
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|info
suffix:semicolon
id|hal2_buf_t
op_star
id|buf
suffix:semicolon
id|hal2_codec_t
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info.fragments
op_assign
l_int|0
suffix:semicolon
id|buf
op_assign
id|dac-&gt;head
suffix:semicolon
r_while
c_loop
(paren
id|buf-&gt;info.cnt
op_eq
l_int|0
op_logical_and
id|buf
op_ne
id|dac-&gt;tail
)paren
(brace
id|info.fragments
op_increment
suffix:semicolon
id|buf
op_assign
id|buf-&gt;info.next
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info.fragstotal
op_assign
id|obuffers
suffix:semicolon
id|info.fragsize
op_assign
id|H2_BUFFER_SIZE
suffix:semicolon
id|info.bytes
op_assign
id|info.fragsize
op_star
id|info.fragments
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
(brace
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|info
suffix:semicolon
id|hal2_buf_t
op_star
id|buf
suffix:semicolon
id|hal2_codec_t
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info.fragments
op_assign
l_int|0
suffix:semicolon
id|info.bytes
op_assign
l_int|0
suffix:semicolon
id|buf
op_assign
id|adc-&gt;tail
suffix:semicolon
r_while
c_loop
(paren
id|buf-&gt;info.cnt
OG
l_int|0
op_logical_and
id|buf
op_ne
id|adc-&gt;head
)paren
(brace
id|info.fragments
op_increment
suffix:semicolon
id|info.bytes
op_add_assign
id|buf-&gt;info.cnt
suffix:semicolon
id|buf
op_assign
id|buf-&gt;info.next
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info.fragstotal
op_assign
id|ibuffers
suffix:semicolon
id|info.fragsize
op_assign
id|H2_BUFFER_SIZE
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_return
id|put_user
c_func
(paren
id|H2_BUFFER_SIZE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|val
op_assign
id|hal2-&gt;adc.sample_rate
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|val
op_assign
id|hal2-&gt;dac.sample_rate
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
id|val
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|val
op_assign
id|hal2-&gt;adc.voices
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|val
op_assign
id|hal2-&gt;dac.voices
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
id|val
op_assign
l_int|16
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_return
id|hal2_mixer_ioctl
c_func
(paren
id|hal2
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|hal2_read
r_static
id|ssize_t
id|hal2_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|err
suffix:semicolon
id|hal2_card_t
op_star
id|hal2
op_assign
(paren
id|hal2_card_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|hal2_codec_t
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
id|down
c_func
(paren
op_amp
id|adc-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|err
op_assign
id|hal2_get_buffer
c_func
(paren
id|hal2
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
id|err
op_assign
id|err
op_eq
l_int|0
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
id|err
suffix:semicolon
)brace
r_else
(brace
r_do
(brace
multiline_comment|/* ~10% longer */
r_int
r_int
id|timeout
op_assign
l_int|1000
op_star
id|H2_BUFFER_SIZE
op_star
l_int|2
op_star
id|adc-&gt;voices
op_star
id|HZ
op_div
id|adc-&gt;sample_rate
op_div
l_int|900
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|ssize_t
id|cnt
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|hal2_get_buffer
c_func
(paren
id|hal2
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
id|count
op_sub_assign
id|err
suffix:semicolon
id|cnt
op_add_assign
id|err
suffix:semicolon
id|buffer
op_add_assign
id|err
suffix:semicolon
id|err
op_assign
id|cnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
l_int|0
op_logical_and
id|err
op_ge
l_int|0
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|adc-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
multiline_comment|/* Well, it is possible, that interrupt already&n;&t;&t;&t;&t; * arrived. Hmm, shit happens, we have one more&n;&t;&t;&t;&t; * buffer filled ;) */
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|timeout
)paren
)paren
multiline_comment|/* We may get bogus timeout when system&n;&t;&t;&t;&t;&t; * is heavily loaded */
r_if
c_cond
(paren
op_logical_neg
id|adc-&gt;tail-&gt;info.cnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HAL2: timeout...&bslash;n&quot;
)paren
suffix:semicolon
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_adc_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|err
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|adc-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
op_logical_and
id|err
op_ge
l_int|0
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|adc-&gt;sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|hal2_write
r_static
id|ssize_t
id|hal2_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|err
suffix:semicolon
r_char
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|buffer
suffix:semicolon
id|hal2_card_t
op_star
id|hal2
op_assign
(paren
id|hal2_card_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|hal2_codec_t
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dac-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|err
op_assign
id|hal2_add_buffer
c_func
(paren
id|hal2
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|err
op_assign
id|err
op_eq
l_int|0
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
id|err
suffix:semicolon
)brace
r_else
(brace
r_do
(brace
multiline_comment|/* ~10% longer */
r_int
r_int
id|timeout
op_assign
l_int|1000
op_star
id|H2_BUFFER_SIZE
op_star
l_int|2
op_star
id|dac-&gt;voices
op_star
id|HZ
op_div
id|dac-&gt;sample_rate
op_div
l_int|900
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|ssize_t
id|cnt
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|hal2_add_buffer
c_func
(paren
id|hal2
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
id|count
op_sub_assign
id|err
suffix:semicolon
id|cnt
op_add_assign
id|err
suffix:semicolon
id|buf
op_add_assign
id|err
suffix:semicolon
id|err
op_assign
id|cnt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
l_int|0
op_logical_and
id|err
op_ge
l_int|0
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|dac-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
multiline_comment|/* Well, it is possible, that interrupt already&n;&t;&t;&t;&t; * arrived. Hmm, shit happens, we have one more&n;&t;&t;&t;&t; * buffer free ;) */
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|timeout
)paren
)paren
multiline_comment|/* We may get bogus timeout when system&n;&t;&t;&t;&t;&t; * is heavily loaded */
r_if
c_cond
(paren
id|dac-&gt;head-&gt;info.cnt
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HAL2: timeout...&bslash;n&quot;
)paren
suffix:semicolon
id|hal2_stop_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_reset_dac_pointer
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|err
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dac-&gt;dma_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
op_logical_and
id|err
op_ge
l_int|0
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dac-&gt;sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|hal2_poll
r_static
r_int
r_int
id|hal2_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|hal2_card_t
op_star
id|hal2
op_assign
(paren
id|hal2_card_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_codec_t
op_star
id|adc
op_assign
op_amp
id|hal2-&gt;adc
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|hal2-&gt;adc.dma_wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adc-&gt;tail-&gt;info.cnt
OG
l_int|0
)paren
id|mask
op_or_assign
id|POLLIN
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adc-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_codec_t
op_star
id|dac
op_assign
op_amp
id|hal2-&gt;dac
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dac-&gt;dma_wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dac-&gt;head-&gt;info.cnt
op_eq
l_int|0
)paren
id|mask
op_or_assign
id|POLLOUT
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dac-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|mask
suffix:semicolon
)brace
DECL|function|hal2_open
r_static
r_int
id|hal2_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|err
suffix:semicolon
id|hal2_card_t
op_star
id|hal2
op_assign
id|hal2_dsp_find_card
c_func
(paren
id|iminor
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
id|DEBUG
c_func
(paren
l_string|&quot;opening audio device.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hal2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HAL2: Whee?! Open door and go away!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|file-&gt;private_data
op_assign
id|hal2
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|hal2-&gt;adc.usecount
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* OSS spec wanted us to use 8 bit, 8 kHz mono by default,&n;&t;&t; * but HAL2 can&squot;t do 8bit audio */
id|hal2-&gt;adc.format
op_assign
id|AFMT_S16_BE
suffix:semicolon
id|hal2-&gt;adc.voices
op_assign
l_int|1
suffix:semicolon
id|hal2-&gt;adc.sample_rate
op_assign
id|hal2_compute_rate
c_func
(paren
op_amp
id|hal2-&gt;adc
comma
l_int|8000
)paren
suffix:semicolon
id|hal2_set_adc_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
multiline_comment|/* alloc DMA buffers */
id|err
op_assign
id|hal2_alloc_adc_dmabuf
c_func
(paren
id|hal2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|hal2_setup_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;adc.usecount
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|hal2-&gt;dac.usecount
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|hal2-&gt;dac.format
op_assign
id|AFMT_S16_BE
suffix:semicolon
id|hal2-&gt;dac.voices
op_assign
l_int|1
suffix:semicolon
id|hal2-&gt;dac.sample_rate
op_assign
id|hal2_compute_rate
c_func
(paren
op_amp
id|hal2-&gt;dac
comma
l_int|8000
)paren
suffix:semicolon
id|hal2_set_dac_rate
c_func
(paren
id|hal2
)paren
suffix:semicolon
multiline_comment|/* alloc DMA buffers */
id|err
op_assign
id|hal2_alloc_dac_dmabuf
c_func
(paren
id|hal2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|hal2_setup_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dac.usecount
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_release
r_static
r_int
id|hal2_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|hal2_card_t
op_star
id|hal2
op_assign
(paren
id|hal2_card_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|hal2_stop_adc
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_free_adc_dmabuf
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;adc.usecount
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|hal2_sync_dac
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2_free_dac_dmabuf
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dac.usecount
op_decrement
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hal2_audio_fops
r_static
r_struct
id|file_operations
id|hal2_audio_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|hal2_read
comma
dot
id|write
op_assign
id|hal2_write
comma
dot
id|poll
op_assign
id|hal2_poll
comma
dot
id|ioctl
op_assign
id|hal2_ioctl
comma
dot
id|open
op_assign
id|hal2_open
comma
dot
id|release
op_assign
id|hal2_release
comma
)brace
suffix:semicolon
DECL|variable|hal2_mixer_fops
r_static
r_struct
id|file_operations
id|hal2_mixer_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|ioctl
op_assign
id|hal2_ioctl_mixdev
comma
dot
id|open
op_assign
id|hal2_open_mixdev
comma
dot
id|release
op_assign
id|hal2_release_mixdev
comma
)brace
suffix:semicolon
DECL|function|hal2_request_irq
r_static
r_int
id|hal2_request_irq
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_int
id|irq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|hal2_interrupt
comma
id|SA_SHIRQ
comma
id|hal2str
comma
id|hal2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HAL2: Can&squot;t get irq %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hal2_alloc_resources
r_static
r_int
id|hal2_alloc_resources
c_func
(paren
id|hal2_card_t
op_star
id|hal2
comma
r_struct
id|hpc3_regs
op_star
id|hpc3
)paren
(brace
id|hal2_pbus_t
op_star
id|pbus
suffix:semicolon
id|pbus
op_assign
op_amp
id|hal2-&gt;dac.pbus
suffix:semicolon
id|pbus-&gt;pbusnr
op_assign
l_int|0
suffix:semicolon
id|pbus-&gt;pbus
op_assign
op_amp
id|hpc3-&gt;pbdma
(braket
id|pbus-&gt;pbusnr
)braket
suffix:semicolon
multiline_comment|/* The spec says that we should write 0x08248844 but that&squot;s WRONG. HAL2&n;&t; * does 8 bit DMA, not 16 bit even if it generates 16 bit audio. */
id|hpc3-&gt;pbus_dmacfgs
(braket
id|pbus-&gt;pbusnr
)braket
(braket
l_int|0
)braket
op_assign
l_int|0x08208844
suffix:semicolon
multiline_comment|/* Magic :-) */
id|pbus
op_assign
op_amp
id|hal2-&gt;adc.pbus
suffix:semicolon
id|pbus-&gt;pbusnr
op_assign
l_int|1
suffix:semicolon
id|pbus-&gt;pbus
op_assign
op_amp
id|hpc3-&gt;pbdma
(braket
id|pbus-&gt;pbusnr
)braket
suffix:semicolon
id|hpc3-&gt;pbus_dmacfgs
(braket
id|pbus-&gt;pbusnr
)braket
(braket
l_int|0
)braket
op_assign
l_int|0x08208844
suffix:semicolon
multiline_comment|/* Magic :-) */
r_return
id|hal2_request_irq
c_func
(paren
id|hal2
comma
id|SGI_HPCDMA_IRQ
)paren
suffix:semicolon
)brace
DECL|function|hal2_init_codec
r_static
r_void
id|hal2_init_codec
c_func
(paren
id|hal2_codec_t
op_star
id|codec
)paren
(brace
id|init_waitqueue_head
c_func
(paren
op_amp
id|codec-&gt;dma_wait
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|codec-&gt;sem
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|codec-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|hal2_free_resources
r_static
r_void
id|hal2_free_resources
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
id|free_irq
c_func
(paren
id|SGI_HPCDMA_IRQ
comma
id|hal2
)paren
suffix:semicolon
)brace
DECL|function|hal2_detect
r_static
r_int
id|hal2_detect
c_func
(paren
id|hal2_card_t
op_star
id|hal2
)paren
(brace
r_int
r_int
id|board
comma
id|major
comma
id|minor
suffix:semicolon
r_int
r_int
id|rev
suffix:semicolon
multiline_comment|/* reset HAL2 */
id|hal2_isr_write
c_func
(paren
id|hal2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* release reset */
id|hal2_isr_write
c_func
(paren
id|hal2
comma
id|H2_ISR_GLOBAL_RESET_N
op_or
id|H2_ISR_CODEC_RESET_N
)paren
suffix:semicolon
id|hal2_i_write16
c_func
(paren
id|hal2
comma
id|H2I_RELAY_C
comma
id|H2I_RELAY_C_STATE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rev
op_assign
id|hal2_rev_look
c_func
(paren
id|hal2
)paren
)paren
op_amp
id|H2_REV_AUDIO_PRESENT
)paren
(brace
id|DEBUG
c_func
(paren
l_string|&quot;HAL2: no device detected, rev: 0x%04hx&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|board
op_assign
(paren
id|rev
op_amp
id|H2_REV_BOARD_M
)paren
op_rshift
l_int|12
suffix:semicolon
id|major
op_assign
(paren
id|rev
op_amp
id|H2_REV_MAJOR_CHIP_M
)paren
op_rshift
l_int|4
suffix:semicolon
id|minor
op_assign
(paren
id|rev
op_amp
id|H2_REV_MINOR_CHIP_M
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SGI HAL2 Processor revision %i.%i.%i detected&bslash;n&quot;
comma
id|board
comma
id|major
comma
id|minor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|board
op_ne
l_int|4
op_logical_or
id|major
op_ne
l_int|1
op_logical_or
id|minor
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;Other revision than 4.1.0 detected. &quot;
l_string|&quot;Your card is probably unsupported&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hal2_init_card
r_static
r_int
id|hal2_init_card
c_func
(paren
id|hal2_card_t
op_star
op_star
id|phal2
comma
r_struct
id|hpc3_regs
op_star
id|hpc3
comma
r_int
r_int
id|hpc3_base
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|hal2_card_t
op_star
id|hal2
suffix:semicolon
id|hal2
op_assign
(paren
id|hal2_card_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|hal2_card_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hal2
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|hal2
comma
l_int|0
comma
r_sizeof
(paren
id|hal2_card_t
)paren
)paren
suffix:semicolon
id|hal2-&gt;ctl_regs
op_assign
(paren
id|hal2_ctl_regs_t
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|hpc3_base
op_plus
id|H2_CTL_PIO
)paren
suffix:semicolon
id|hal2-&gt;aes_regs
op_assign
(paren
id|hal2_aes_regs_t
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|hpc3_base
op_plus
id|H2_AES_PIO
)paren
suffix:semicolon
id|hal2-&gt;vol_regs
op_assign
(paren
id|hal2_vol_regs_t
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|hpc3_base
op_plus
id|H2_VOL_PIO
)paren
suffix:semicolon
id|hal2-&gt;syn_regs
op_assign
(paren
id|hal2_syn_regs_t
op_star
)paren
id|KSEG1ADDR
c_func
(paren
id|hpc3_base
op_plus
id|H2_SYN_PIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hal2_detect
c_func
(paren
id|hal2
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HAL2 audio processor not found&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|fail1
suffix:semicolon
)brace
id|hal2_init_codec
c_func
(paren
op_amp
id|hal2-&gt;dac
)paren
suffix:semicolon
id|hal2_init_codec
c_func
(paren
op_amp
id|hal2-&gt;adc
)paren
suffix:semicolon
id|ret
op_assign
id|hal2_alloc_resources
c_func
(paren
id|hal2
comma
id|hpc3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|fail1
suffix:semicolon
id|hal2_init_mixer
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|hal2-&gt;dev_dsp
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|hal2_audio_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hal2-&gt;dev_dsp
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|hal2-&gt;dev_dsp
suffix:semicolon
r_goto
id|fail2
suffix:semicolon
)brace
id|hal2-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|hal2_mixer_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hal2-&gt;dev_mixer
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|hal2-&gt;dev_mixer
suffix:semicolon
r_goto
id|fail3
suffix:semicolon
)brace
op_star
id|phal2
op_assign
id|hal2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail3
suffix:colon
id|unregister_sound_dsp
c_func
(paren
id|hal2-&gt;dev_dsp
)paren
suffix:semicolon
id|fail2
suffix:colon
id|hal2_free_resources
c_func
(paren
id|hal2
)paren
suffix:semicolon
id|fail1
suffix:colon
id|kfree
c_func
(paren
id|hal2
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* &n; * We are assuming only one HAL2 card. If you ever meet machine with more than&n; * one, tell immediately about it to someone. Preferably to me. --ladis&n; */
DECL|function|init_hal2
r_static
r_int
id|__init
id|init_hal2
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCARDS
suffix:semicolon
id|i
op_increment
)paren
id|hal2_card
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|hal2_init_card
c_func
(paren
op_amp
id|hal2_card
(braket
l_int|0
)braket
comma
id|hpc3c0
comma
id|HPC3_CHIP0_PBASE
)paren
suffix:semicolon
)brace
DECL|function|exit_hal2
r_static
r_void
id|__exit
id|exit_hal2
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXCARDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hal2_card
(braket
id|i
)braket
)paren
(brace
id|hal2_free_resources
c_func
(paren
id|hal2_card
(braket
id|i
)braket
)paren
suffix:semicolon
id|unregister_sound_dsp
c_func
(paren
id|hal2_card
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_dsp
)paren
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|hal2_card
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hal2_card
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init_hal2
id|module_init
c_func
(paren
id|init_hal2
)paren
suffix:semicolon
DECL|variable|exit_hal2
id|module_exit
c_func
(paren
id|exit_hal2
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;OSS compatible driver for SGI HAL2 audio&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ladislav Michl&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
