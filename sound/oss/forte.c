multiline_comment|/*&n; * forte.c - ForteMedia FM801 OSS Driver&n; *&n; * Written by Martin K. Petersen &lt;mkp@mkp.net&gt;&n; * Copyright (C) 2002 Hewlett-Packard Company&n; * Portions Copyright (C) 2003 Martin K. Petersen&n; *&n; * Latest version: http://mkp.net/forte/&n; *&n; * Based upon the ALSA FM801 driver by Jaroslav Kysela and OSS drivers&n; * by Thomas Sailer, Alan Cox, Zach Brown, and Jeff Garzik.  Thanks&n; * guys!&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License version&n; * 2 as published by the Free Software Foundation.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307&n; * USA&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/ac97_codec.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|DRIVER_NAME
mdefine_line|#define DRIVER_NAME&t;&quot;forte&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &t;&quot;$Id: forte.c,v 1.63 2003/03/01 05:32:42 mkp Exp $&quot;
DECL|macro|PFX
mdefine_line|#define PFX &t;&t;DRIVER_NAME &quot;: &quot;
DECL|macro|M_DEBUG
macro_line|#undef M_DEBUG
macro_line|#ifdef M_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(args...) printk(KERN_WARNING args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(args...)
macro_line|#endif
multiline_comment|/* Card capabilities */
DECL|macro|FORTE_CAPS
mdefine_line|#define FORTE_CAPS              (DSP_CAP_MMAP | DSP_CAP_TRIGGER)
multiline_comment|/* Supported audio formats */
DECL|macro|FORTE_FMTS
mdefine_line|#define FORTE_FMTS&t;&t;(AFMT_U8 | AFMT_S16_LE)
multiline_comment|/* Buffers */
DECL|macro|FORTE_MIN_FRAG_SIZE
mdefine_line|#define FORTE_MIN_FRAG_SIZE     256
DECL|macro|FORTE_MAX_FRAG_SIZE
mdefine_line|#define FORTE_MAX_FRAG_SIZE     PAGE_SIZE
DECL|macro|FORTE_DEF_FRAG_SIZE
mdefine_line|#define FORTE_DEF_FRAG_SIZE     256
DECL|macro|FORTE_MIN_FRAGMENTS
mdefine_line|#define FORTE_MIN_FRAGMENTS     2
DECL|macro|FORTE_MAX_FRAGMENTS
mdefine_line|#define FORTE_MAX_FRAGMENTS     256
DECL|macro|FORTE_DEF_FRAGMENTS
mdefine_line|#define FORTE_DEF_FRAGMENTS     2
DECL|macro|FORTE_MIN_BUF_MSECS
mdefine_line|#define FORTE_MIN_BUF_MSECS     500
DECL|macro|FORTE_MAX_BUF_MSECS
mdefine_line|#define FORTE_MAX_BUF_MSECS     1000
multiline_comment|/* PCI BARs */
DECL|macro|FORTE_PCM_VOL
mdefine_line|#define FORTE_PCM_VOL           0x00    /* PCM Output Volume */
DECL|macro|FORTE_FM_VOL
mdefine_line|#define FORTE_FM_VOL            0x02    /* FM Output Volume */
DECL|macro|FORTE_I2S_VOL
mdefine_line|#define FORTE_I2S_VOL           0x04    /* I2S Volume */
DECL|macro|FORTE_REC_SRC
mdefine_line|#define FORTE_REC_SRC           0x06    /* Record Source */
DECL|macro|FORTE_PLY_CTRL
mdefine_line|#define FORTE_PLY_CTRL          0x08    /* Playback Control */
DECL|macro|FORTE_PLY_COUNT
mdefine_line|#define FORTE_PLY_COUNT         0x0a    /* Playback Count */
DECL|macro|FORTE_PLY_BUF1
mdefine_line|#define FORTE_PLY_BUF1          0x0c    /* Playback Buffer I */
DECL|macro|FORTE_PLY_BUF2
mdefine_line|#define FORTE_PLY_BUF2          0x10    /* Playback Buffer II */
DECL|macro|FORTE_CAP_CTRL
mdefine_line|#define FORTE_CAP_CTRL          0x14    /* Capture Control */
DECL|macro|FORTE_CAP_COUNT
mdefine_line|#define FORTE_CAP_COUNT         0x16    /* Capture Count */
DECL|macro|FORTE_CAP_BUF1
mdefine_line|#define FORTE_CAP_BUF1          0x18    /* Capture Buffer I */
DECL|macro|FORTE_CAP_BUF2
mdefine_line|#define FORTE_CAP_BUF2          0x1c    /* Capture Buffer II */
DECL|macro|FORTE_CODEC_CTRL
mdefine_line|#define FORTE_CODEC_CTRL        0x22    /* Codec Control */
DECL|macro|FORTE_I2S_MODE
mdefine_line|#define FORTE_I2S_MODE          0x24    /* I2S Mode Control */
DECL|macro|FORTE_VOLUME
mdefine_line|#define FORTE_VOLUME            0x26    /* Volume Up/Down/Mute Status */
DECL|macro|FORTE_I2C_CTRL
mdefine_line|#define FORTE_I2C_CTRL          0x29    /* I2C Control */
DECL|macro|FORTE_AC97_CMD
mdefine_line|#define FORTE_AC97_CMD          0x2a    /* AC&squot;97 Command */
DECL|macro|FORTE_AC97_DATA
mdefine_line|#define FORTE_AC97_DATA         0x2c    /* AC&squot;97 Data */
DECL|macro|FORTE_MPU401_DATA
mdefine_line|#define FORTE_MPU401_DATA       0x30    /* MPU401 Data */
DECL|macro|FORTE_MPU401_CMD
mdefine_line|#define FORTE_MPU401_CMD        0x31    /* MPU401 Command */
DECL|macro|FORTE_GPIO_CTRL
mdefine_line|#define FORTE_GPIO_CTRL         0x52    /* General Purpose I/O Control */
DECL|macro|FORTE_GEN_CTRL
mdefine_line|#define FORTE_GEN_CTRL          0x54    /* General Control */
DECL|macro|FORTE_IRQ_MASK
mdefine_line|#define FORTE_IRQ_MASK          0x56    /* Interrupt Mask */
DECL|macro|FORTE_IRQ_STATUS
mdefine_line|#define FORTE_IRQ_STATUS        0x5a    /* Interrupt Status */
DECL|macro|FORTE_OPL3_BANK0
mdefine_line|#define FORTE_OPL3_BANK0        0x68    /* OPL3 Status Read / Bank 0 Write */
DECL|macro|FORTE_OPL3_DATA0
mdefine_line|#define FORTE_OPL3_DATA0        0x69    /* OPL3 Data 0 Write */
DECL|macro|FORTE_OPL3_BANK1
mdefine_line|#define FORTE_OPL3_BANK1        0x6a    /* OPL3 Bank 1 Write */
DECL|macro|FORTE_OPL3_DATA1
mdefine_line|#define FORTE_OPL3_DATA1        0x6b    /* OPL3 Bank 1 Write */
DECL|macro|FORTE_POWERDOWN
mdefine_line|#define FORTE_POWERDOWN         0x70    /* Blocks Power Down Control */
DECL|macro|FORTE_CAP_OFFSET
mdefine_line|#define FORTE_CAP_OFFSET        FORTE_CAP_CTRL - FORTE_PLY_CTRL
DECL|macro|FORTE_AC97_ADDR_SHIFT
mdefine_line|#define FORTE_AC97_ADDR_SHIFT   10
multiline_comment|/* Playback and record control register bits */
DECL|macro|FORTE_BUF1_LAST
mdefine_line|#define FORTE_BUF1_LAST         (1&lt;&lt;1)
DECL|macro|FORTE_BUF2_LAST
mdefine_line|#define FORTE_BUF2_LAST         (1&lt;&lt;2)
DECL|macro|FORTE_START
mdefine_line|#define FORTE_START             (1&lt;&lt;5)
DECL|macro|FORTE_PAUSE
mdefine_line|#define FORTE_PAUSE             (1&lt;&lt;6)
DECL|macro|FORTE_IMMED_STOP
mdefine_line|#define FORTE_IMMED_STOP        (1&lt;&lt;7)
DECL|macro|FORTE_RATE_SHIFT
mdefine_line|#define FORTE_RATE_SHIFT        8
DECL|macro|FORTE_RATE_MASK
mdefine_line|#define FORTE_RATE_MASK         (15 &lt;&lt; FORTE_RATE_SHIFT)
DECL|macro|FORTE_CHANNELS_4
mdefine_line|#define FORTE_CHANNELS_4        (1&lt;&lt;12) /* Playback only */
DECL|macro|FORTE_CHANNELS_6
mdefine_line|#define FORTE_CHANNELS_6        (2&lt;&lt;12) /* Playback only */
DECL|macro|FORTE_CHANNELS_6MS
mdefine_line|#define FORTE_CHANNELS_6MS      (3&lt;&lt;12) /* Playback only */
DECL|macro|FORTE_CHANNELS_MASK
mdefine_line|#define FORTE_CHANNELS_MASK     (3&lt;&lt;12)
DECL|macro|FORTE_16BIT
mdefine_line|#define FORTE_16BIT             (1&lt;&lt;14)
DECL|macro|FORTE_STEREO
mdefine_line|#define FORTE_STEREO            (1&lt;&lt;15)
multiline_comment|/* IRQ status bits */
DECL|macro|FORTE_IRQ_PLAYBACK
mdefine_line|#define FORTE_IRQ_PLAYBACK      (1&lt;&lt;8)
DECL|macro|FORTE_IRQ_CAPTURE
mdefine_line|#define FORTE_IRQ_CAPTURE       (1&lt;&lt;9)
DECL|macro|FORTE_IRQ_VOLUME
mdefine_line|#define FORTE_IRQ_VOLUME        (1&lt;&lt;14)
DECL|macro|FORTE_IRQ_MPU
mdefine_line|#define FORTE_IRQ_MPU           (1&lt;&lt;15)
multiline_comment|/* CODEC control */
DECL|macro|FORTE_CC_CODEC_RESET
mdefine_line|#define FORTE_CC_CODEC_RESET    (1&lt;&lt;5)
DECL|macro|FORTE_CC_AC97_RESET
mdefine_line|#define FORTE_CC_AC97_RESET     (1&lt;&lt;6)
multiline_comment|/* AC97 cmd */
DECL|macro|FORTE_AC97_WRITE
mdefine_line|#define FORTE_AC97_WRITE        (0&lt;&lt;7)
DECL|macro|FORTE_AC97_READ
mdefine_line|#define FORTE_AC97_READ         (1&lt;&lt;7)
DECL|macro|FORTE_AC97_DP_INVALID
mdefine_line|#define FORTE_AC97_DP_INVALID   (0&lt;&lt;8)
DECL|macro|FORTE_AC97_DP_VALID
mdefine_line|#define FORTE_AC97_DP_VALID     (1&lt;&lt;8)
DECL|macro|FORTE_AC97_PORT_RDY
mdefine_line|#define FORTE_AC97_PORT_RDY     (0&lt;&lt;9)
DECL|macro|FORTE_AC97_PORT_BSY
mdefine_line|#define FORTE_AC97_PORT_BSY     (1&lt;&lt;9)
DECL|struct|forte_channel
r_struct
id|forte_channel
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|ctrl
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Ctrl BAR contents */
DECL|member|iobase
r_int
r_int
id|iobase
suffix:semicolon
multiline_comment|/* Ctrl BAR address */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|buf
r_void
op_star
id|buf
suffix:semicolon
multiline_comment|/* Buffer */
DECL|member|buf_handle
id|dma_addr_t
id|buf_handle
suffix:semicolon
multiline_comment|/* Buffer handle */
DECL|member|record
r_int
r_int
id|record
suffix:semicolon
DECL|member|format
r_int
r_int
id|format
suffix:semicolon
DECL|member|rate
r_int
r_int
id|rate
suffix:semicolon
DECL|member|stereo
r_int
r_int
id|stereo
suffix:semicolon
DECL|member|frag_sz
r_int
r_int
id|frag_sz
suffix:semicolon
multiline_comment|/* Current fragment size */
DECL|member|frag_num
r_int
r_int
id|frag_num
suffix:semicolon
multiline_comment|/* Current # of fragments */
DECL|member|frag_msecs
r_int
r_int
id|frag_msecs
suffix:semicolon
multiline_comment|/* Milliseconds per frag */
DECL|member|buf_sz
r_int
r_int
id|buf_sz
suffix:semicolon
multiline_comment|/* Current buffer size */
DECL|member|hwptr
r_int
r_int
id|hwptr
suffix:semicolon
multiline_comment|/* Tail */
DECL|member|swptr
r_int
r_int
id|swptr
suffix:semicolon
multiline_comment|/* Head */
DECL|member|filled_frags
r_int
r_int
id|filled_frags
suffix:semicolon
multiline_comment|/* Fragments currently full */
DECL|member|next_buf
r_int
r_int
id|next_buf
suffix:semicolon
multiline_comment|/* Index of next buffer */
DECL|member|active
r_int
r_int
id|active
suffix:semicolon
multiline_comment|/* Channel currently in use */
DECL|member|mapped
r_int
r_int
id|mapped
suffix:semicolon
multiline_comment|/* mmap */
DECL|member|buf_pages
r_int
r_int
id|buf_pages
suffix:semicolon
multiline_comment|/* Real size of buffer */
DECL|member|nr_irqs
r_int
r_int
id|nr_irqs
suffix:semicolon
multiline_comment|/* Number of interrupts */
DECL|member|bytes
r_int
r_int
id|bytes
suffix:semicolon
multiline_comment|/* Total bytes */
DECL|member|residue
r_int
r_int
id|residue
suffix:semicolon
multiline_comment|/* Partial fragment */
)brace
suffix:semicolon
DECL|struct|forte_chip
r_struct
id|forte_chip
(brace
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|iobase
r_int
r_int
id|iobase
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
multiline_comment|/* Device access */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* State */
DECL|member|ac97_lock
id|spinlock_t
id|ac97_lock
suffix:semicolon
DECL|member|ac97
r_struct
id|ac97_codec
op_star
id|ac97
suffix:semicolon
DECL|member|multichannel
r_int
id|multichannel
suffix:semicolon
DECL|member|dsp
r_int
id|dsp
suffix:semicolon
multiline_comment|/* OSS handle */
DECL|member|trigger
r_int
id|trigger
suffix:semicolon
multiline_comment|/* mmap I/O trigger */
DECL|member|play
r_struct
id|forte_channel
id|play
suffix:semicolon
DECL|member|rec
r_struct
id|forte_channel
id|rec
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|channels
r_static
r_int
id|channels
(braket
)braket
op_assign
(brace
l_int|2
comma
l_int|4
comma
l_int|6
comma
)brace
suffix:semicolon
DECL|variable|rates
r_static
r_int
id|rates
(braket
)braket
op_assign
(brace
l_int|5500
comma
l_int|8000
comma
l_int|9600
comma
l_int|11025
comma
l_int|16000
comma
l_int|19200
comma
l_int|22050
comma
l_int|32000
comma
l_int|38400
comma
l_int|44100
comma
l_int|48000
comma
)brace
suffix:semicolon
DECL|variable|forte
r_static
r_struct
id|forte_chip
op_star
id|forte
suffix:semicolon
DECL|variable|found
r_static
r_int
id|found
suffix:semicolon
multiline_comment|/* AC97 Codec -------------------------------------------------------------- */
multiline_comment|/** &n; * forte_ac97_wait:&n; * @chip:&t;fm801 instance whose AC97 codec to wait on&n; *&n; * FIXME:&n; *&t;&t;Stop busy-waiting&n; */
r_static
r_inline
r_int
DECL|function|forte_ac97_wait
id|forte_ac97_wait
(paren
r_struct
id|forte_chip
op_star
id|chip
)paren
(brace
r_int
id|i
op_assign
l_int|10000
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inw
(paren
id|chip-&gt;iobase
op_plus
id|FORTE_AC97_CMD
)paren
op_amp
id|FORTE_AC97_PORT_BSY
)paren
op_logical_and
id|i
op_decrement
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
r_return
id|i
op_eq
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_ac97_read:&n; * @codec:&t;AC97 codec to read from&n; * @reg:&t;register to read&n; */
id|u16
DECL|function|forte_ac97_read
id|forte_ac97_read
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
(brace
id|u16
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|forte_chip
op_star
id|chip
op_assign
id|codec-&gt;private_data
suffix:semicolon
id|spin_lock
(paren
op_amp
id|chip-&gt;ac97_lock
)paren
suffix:semicolon
multiline_comment|/* Knock, knock */
r_if
c_cond
(paren
id|forte_ac97_wait
(paren
id|chip
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ac97_read: Serial bus busy&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Send read command */
id|outw
(paren
id|reg
op_or
(paren
l_int|1
op_lshift
l_int|7
)paren
comma
id|chip-&gt;iobase
op_plus
id|FORTE_AC97_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|forte_ac97_wait
(paren
id|chip
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ac97_read: Bus busy reading reg 0x%x&bslash;n&quot;
comma
id|reg
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Sanity checking */
r_if
c_cond
(paren
id|inw
(paren
id|chip-&gt;iobase
op_plus
id|FORTE_AC97_CMD
)paren
op_amp
id|FORTE_AC97_DP_INVALID
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ac97_read: Invalid data port&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Fetch result */
id|ret
op_assign
id|inw
(paren
id|chip-&gt;iobase
op_plus
id|FORTE_AC97_DATA
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
(paren
op_amp
id|chip-&gt;ac97_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_ac97_write:&n; * @codec:&t;AC97 codec to send command to&n; * @reg:&t;register to write&n; * @val:&t;value to write&n; */
r_void
DECL|function|forte_ac97_write
id|forte_ac97_write
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
op_assign
id|codec-&gt;private_data
suffix:semicolon
id|spin_lock
(paren
op_amp
id|chip-&gt;ac97_lock
)paren
suffix:semicolon
multiline_comment|/* Knock, knock */
r_if
c_cond
(paren
id|forte_ac97_wait
(paren
id|chip
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ac97_write: Serial bus busy&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|outw
(paren
id|val
comma
id|chip-&gt;iobase
op_plus
id|FORTE_AC97_DATA
)paren
suffix:semicolon
id|outb
(paren
id|reg
op_or
id|FORTE_AC97_WRITE
comma
id|chip-&gt;iobase
op_plus
id|FORTE_AC97_CMD
)paren
suffix:semicolon
multiline_comment|/* Wait for completion */
r_if
c_cond
(paren
id|forte_ac97_wait
(paren
id|chip
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;ac97_write: Bus busy after write&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock
(paren
op_amp
id|chip-&gt;ac97_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Mixer ------------------------------------------------------------------- */
multiline_comment|/**&n; * forte_mixer_open:&n; * @inode:&t;&t;&n; * @file:&t;&t;&n; */
r_static
r_int
DECL|function|forte_mixer_open
id|forte_mixer_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
op_assign
id|forte
suffix:semicolon
id|file-&gt;private_data
op_assign
id|chip-&gt;ac97
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_mixer_release:&n; * @inode:&t;&t;&n; * @file:&t;&t;&n; */
r_static
r_int
DECL|function|forte_mixer_release
id|forte_mixer_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/* We will welease Wodewick */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_mixer_ioctl:&n; * @inode:&t;&t;&n; * @file:&t;&t;&n; */
r_static
r_int
DECL|function|forte_mixer_ioctl
id|forte_mixer_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
op_assign
(paren
r_struct
id|ac97_codec
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_return
id|codec-&gt;mixer_ioctl
(paren
id|codec
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|forte_mixer_fops
r_static
r_struct
id|file_operations
id|forte_mixer_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|ioctl
op_assign
id|forte_mixer_ioctl
comma
dot
id|open
op_assign
id|forte_mixer_open
comma
dot
id|release
op_assign
id|forte_mixer_release
comma
)brace
suffix:semicolon
multiline_comment|/* Channel ----------------------------------------------------------------- */
multiline_comment|/** &n; * forte_channel_reset:&n; * @channel:&t;Channel to reset&n; * &n; * Locking:&t;Must be called with lock held.&n; */
r_static
r_void
DECL|function|forte_channel_reset
id|forte_channel_reset
(paren
r_struct
id|forte_channel
op_star
id|channel
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|channel
op_logical_or
op_logical_neg
id|channel-&gt;iobase
)paren
r_return
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: channel = %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;name
)paren
suffix:semicolon
id|channel-&gt;ctrl
op_and_assign
op_complement
id|FORTE_START
suffix:semicolon
id|outw
(paren
id|channel-&gt;ctrl
comma
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_CTRL
)paren
suffix:semicolon
multiline_comment|/* We always play at least two fragments, hence these defaults */
id|channel-&gt;hwptr
op_assign
id|channel-&gt;frag_sz
suffix:semicolon
id|channel-&gt;next_buf
op_assign
l_int|1
suffix:semicolon
id|channel-&gt;swptr
op_assign
l_int|0
suffix:semicolon
id|channel-&gt;filled_frags
op_assign
l_int|0
suffix:semicolon
id|channel-&gt;active
op_assign
l_int|0
suffix:semicolon
id|channel-&gt;bytes
op_assign
l_int|0
suffix:semicolon
id|channel-&gt;nr_irqs
op_assign
l_int|0
suffix:semicolon
id|channel-&gt;mapped
op_assign
l_int|0
suffix:semicolon
id|channel-&gt;residue
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_start:&n; * @channel: &t;Channel to start (record/playback)&n; *&n; * Locking:&t;Must be called with lock held.&n; */
r_static
r_void
r_inline
DECL|function|forte_channel_start
id|forte_channel_start
(paren
r_struct
id|forte_channel
op_star
id|channel
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|channel
op_logical_or
op_logical_neg
id|channel-&gt;iobase
op_logical_or
id|channel-&gt;active
)paren
r_return
suffix:semicolon
id|channel-&gt;ctrl
op_and_assign
op_complement
(paren
id|FORTE_PAUSE
op_or
id|FORTE_BUF1_LAST
op_or
id|FORTE_BUF2_LAST
op_or
id|FORTE_IMMED_STOP
)paren
suffix:semicolon
id|channel-&gt;ctrl
op_or_assign
id|FORTE_START
suffix:semicolon
id|channel-&gt;active
op_assign
l_int|1
suffix:semicolon
id|outw
(paren
id|channel-&gt;ctrl
comma
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_CTRL
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_stop:&n; * @channel: &t;Channel to stop&n; *&n; * Locking:&t;Must be called with lock held.&n; */
r_static
r_void
r_inline
DECL|function|forte_channel_stop
id|forte_channel_stop
(paren
r_struct
id|forte_channel
op_star
id|channel
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|channel
op_logical_or
op_logical_neg
id|channel-&gt;iobase
)paren
r_return
suffix:semicolon
id|channel-&gt;ctrl
op_and_assign
op_complement
(paren
id|FORTE_START
op_or
id|FORTE_PAUSE
)paren
suffix:semicolon
id|channel-&gt;ctrl
op_or_assign
id|FORTE_IMMED_STOP
suffix:semicolon
id|channel-&gt;active
op_assign
l_int|0
suffix:semicolon
id|outw
(paren
id|channel-&gt;ctrl
comma
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_CTRL
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_pause:&n; * @channel: &t;Channel to pause&n; *&n; * Locking:&t;Must be called with lock held.&n; */
r_static
r_void
r_inline
DECL|function|forte_channel_pause
id|forte_channel_pause
(paren
r_struct
id|forte_channel
op_star
id|channel
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|channel
op_logical_or
op_logical_neg
id|channel-&gt;iobase
)paren
r_return
suffix:semicolon
id|channel-&gt;ctrl
op_or_assign
id|FORTE_PAUSE
suffix:semicolon
id|channel-&gt;active
op_assign
l_int|0
suffix:semicolon
id|outw
(paren
id|channel-&gt;ctrl
comma
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_CTRL
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_rate:&n; * @channel: &t;Channel whose rate to set.  Playback and record are&n; *           &t;independent.&n; * @rate:    &t;Channel rate in Hz&n; *&n; * Locking:&t;Must be called with lock held.&n; */
r_static
r_int
DECL|function|forte_channel_rate
id|forte_channel_rate
(paren
r_struct
id|forte_channel
op_star
id|channel
comma
r_int
r_int
id|rate
)paren
(brace
r_int
id|new_rate
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|channel
op_logical_or
op_logical_neg
id|channel-&gt;iobase
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* The FM801 only supports a handful of fixed frequencies.&n;&t; * We find the value closest to what userland requested.&n;&t; */
r_if
c_cond
(paren
id|rate
op_le
l_int|6250
)paren
(brace
id|rate
op_assign
l_int|5500
suffix:semicolon
id|new_rate
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|8800
)paren
(brace
id|rate
op_assign
l_int|8000
suffix:semicolon
id|new_rate
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|10312
)paren
(brace
id|rate
op_assign
l_int|9600
suffix:semicolon
id|new_rate
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|13512
)paren
(brace
id|rate
op_assign
l_int|11025
suffix:semicolon
id|new_rate
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|17600
)paren
(brace
id|rate
op_assign
l_int|16000
suffix:semicolon
id|new_rate
op_assign
l_int|4
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|20625
)paren
(brace
id|rate
op_assign
l_int|19200
suffix:semicolon
id|new_rate
op_assign
l_int|5
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|27025
)paren
(brace
id|rate
op_assign
l_int|22050
suffix:semicolon
id|new_rate
op_assign
l_int|6
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|35200
)paren
(brace
id|rate
op_assign
l_int|32000
suffix:semicolon
id|new_rate
op_assign
l_int|7
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|41250
)paren
(brace
id|rate
op_assign
l_int|38400
suffix:semicolon
id|new_rate
op_assign
l_int|8
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rate
op_le
l_int|46050
)paren
(brace
id|rate
op_assign
l_int|44100
suffix:semicolon
id|new_rate
op_assign
l_int|9
suffix:semicolon
)brace
r_else
(brace
id|rate
op_assign
l_int|48000
suffix:semicolon
id|new_rate
op_assign
l_int|10
suffix:semicolon
)brace
id|channel-&gt;ctrl
op_and_assign
op_complement
id|FORTE_RATE_MASK
suffix:semicolon
id|channel-&gt;ctrl
op_or_assign
id|new_rate
op_lshift
id|FORTE_RATE_SHIFT
suffix:semicolon
id|channel-&gt;rate
op_assign
id|rate
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: %s rate = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;name
comma
id|rate
)paren
suffix:semicolon
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_format:&n; * @channel: &t;Channel whose audio format to set&n; * @format:  &t;OSS format ID&n; *&n; * Locking:&t;Must be called with lock held.&n; */
r_static
r_int
DECL|function|forte_channel_format
id|forte_channel_format
(paren
r_struct
id|forte_channel
op_star
id|channel
comma
r_int
id|format
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|channel
op_logical_or
op_logical_neg
id|channel-&gt;iobase
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|format
)paren
(brace
r_case
id|AFMT_QUERY
suffix:colon
r_break
suffix:semicolon
r_case
id|AFMT_U8
suffix:colon
id|channel-&gt;ctrl
op_and_assign
op_complement
id|FORTE_16BIT
suffix:semicolon
id|channel-&gt;format
op_assign
id|AFMT_U8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_S16_LE
suffix:colon
r_default
suffix:colon
id|channel-&gt;ctrl
op_or_assign
id|FORTE_16BIT
suffix:semicolon
id|channel-&gt;format
op_assign
id|AFMT_S16_LE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|DPRINTK
(paren
l_string|&quot;%s: %s want %d format, got %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;name
comma
id|format
comma
id|channel-&gt;format
)paren
suffix:semicolon
r_return
id|channel-&gt;format
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_stereo:&n; * @channel: &t;Channel to toggle&n; * @stereo:  &t;0 for Mono, 1 for Stereo&n; *&n; * Locking:&t;Must be called with lock held.&n; */
r_static
r_int
DECL|function|forte_channel_stereo
id|forte_channel_stereo
(paren
r_struct
id|forte_channel
op_star
id|channel
comma
r_int
r_int
id|stereo
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|channel
op_logical_or
op_logical_neg
id|channel-&gt;iobase
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: %s stereo = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;name
comma
id|stereo
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|stereo
)paren
(brace
r_case
l_int|0
suffix:colon
id|channel-&gt;ctrl
op_and_assign
op_complement
(paren
id|FORTE_STEREO
op_or
id|FORTE_CHANNELS_MASK
)paren
suffix:semicolon
id|channel
op_member_access_from_pointer
id|stereo
op_assign
id|stereo
suffix:semicolon
id|ret
op_assign
id|stereo
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|channel-&gt;ctrl
op_and_assign
op_complement
id|FORTE_CHANNELS_MASK
suffix:semicolon
id|channel-&gt;ctrl
op_or_assign
id|FORTE_STEREO
suffix:semicolon
id|channel
op_member_access_from_pointer
id|stereo
op_assign
id|stereo
suffix:semicolon
id|ret
op_assign
id|stereo
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
(paren
l_string|&quot;Unsupported channel format&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_buffer:&n; * @channel:&t;Channel whose buffer to set up&n; *&n; * Locking:&t;Must be called with lock held.&n; */
r_static
r_void
DECL|function|forte_channel_buffer
id|forte_channel_buffer
(paren
r_struct
id|forte_channel
op_star
id|channel
comma
r_int
id|sz
comma
r_int
id|num
)paren
(brace
r_int
r_int
id|msecs
comma
id|shift
suffix:semicolon
multiline_comment|/* Go away, I&squot;m busy */
r_if
c_cond
(paren
id|channel-&gt;filled_frags
op_logical_or
id|channel-&gt;bytes
)paren
r_return
suffix:semicolon
multiline_comment|/* Fragment size must be a power of 2 */
id|shift
op_assign
l_int|0
suffix:semicolon
id|sz
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|sz
op_rshift_assign
l_int|1
)paren
id|shift
op_increment
suffix:semicolon
id|channel-&gt;frag_sz
op_assign
l_int|1
op_lshift
id|shift
suffix:semicolon
multiline_comment|/* Round fragment size to something reasonable */
r_if
c_cond
(paren
id|channel-&gt;frag_sz
OL
id|FORTE_MIN_FRAG_SIZE
)paren
id|channel-&gt;frag_sz
op_assign
id|FORTE_MIN_FRAG_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;frag_sz
OG
id|FORTE_MAX_FRAG_SIZE
)paren
id|channel-&gt;frag_sz
op_assign
id|FORTE_MAX_FRAG_SIZE
suffix:semicolon
multiline_comment|/* Find fragment length in milliseconds */
id|msecs
op_assign
id|channel-&gt;frag_sz
op_div
(paren
id|channel-&gt;format
op_eq
id|AFMT_S16_LE
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
op_div
(paren
id|channel-&gt;stereo
ques
c_cond
l_int|2
suffix:colon
l_int|1
)paren
op_div
(paren
id|channel-&gt;rate
op_div
l_int|1000
)paren
suffix:semicolon
id|channel-&gt;frag_msecs
op_assign
id|msecs
suffix:semicolon
multiline_comment|/* Pick a suitable number of fragments */
r_if
c_cond
(paren
id|msecs
op_star
id|num
OL
id|FORTE_MIN_BUF_MSECS
)paren
id|num
op_assign
id|FORTE_MIN_BUF_MSECS
op_div
id|msecs
suffix:semicolon
r_if
c_cond
(paren
id|msecs
op_star
id|num
OG
id|FORTE_MAX_BUF_MSECS
)paren
id|num
op_assign
id|FORTE_MAX_BUF_MSECS
op_div
id|msecs
suffix:semicolon
multiline_comment|/* Fragment number must be a power of 2 */
id|shift
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|num
op_rshift_assign
l_int|1
)paren
id|shift
op_increment
suffix:semicolon
id|channel-&gt;frag_num
op_assign
l_int|1
op_lshift
(paren
id|shift
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Round fragment number to something reasonable */
r_if
c_cond
(paren
id|channel-&gt;frag_num
OL
id|FORTE_MIN_FRAGMENTS
)paren
id|channel-&gt;frag_num
op_assign
id|FORTE_MIN_FRAGMENTS
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;frag_num
OG
id|FORTE_MAX_FRAGMENTS
)paren
id|channel-&gt;frag_num
op_assign
id|FORTE_MAX_FRAGMENTS
suffix:semicolon
id|channel-&gt;buf_sz
op_assign
id|channel-&gt;frag_sz
op_star
id|channel-&gt;frag_num
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: %s frag_sz = %d, frag_num = %d, buf_sz = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;name
comma
id|channel-&gt;frag_sz
comma
id|channel-&gt;frag_num
comma
id|channel-&gt;buf_sz
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_prep:&n; * @channel:&t;Channel whose buffer to prepare&n; *&n; * Locking:&t;Lock held.&n; */
r_static
r_void
DECL|function|forte_channel_prep
id|forte_channel_prep
(paren
r_struct
id|forte_channel
op_star
id|channel
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;buf
)paren
r_return
suffix:semicolon
id|forte_channel_buffer
(paren
id|channel
comma
id|channel-&gt;frag_sz
comma
id|channel-&gt;frag_num
)paren
suffix:semicolon
id|channel-&gt;buf_pages
op_assign
id|channel-&gt;buf_sz
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;buf_sz
op_mod
id|PAGE_SIZE
)paren
id|channel-&gt;buf_pages
op_increment
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: %s frag_sz = %d, frag_num = %d, buf_sz = %d, pg = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;name
comma
id|channel-&gt;frag_sz
comma
id|channel-&gt;frag_num
comma
id|channel-&gt;buf_sz
comma
id|channel-&gt;buf_pages
)paren
suffix:semicolon
multiline_comment|/* DMA buffer */
id|channel-&gt;buf
op_assign
id|pci_alloc_consistent
(paren
id|forte-&gt;pci_dev
comma
id|channel-&gt;buf_pages
op_star
id|PAGE_SIZE
comma
op_amp
id|channel-&gt;buf_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|channel-&gt;buf
op_logical_or
op_logical_neg
id|channel-&gt;buf_handle
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|page
op_assign
id|virt_to_page
(paren
id|channel-&gt;buf
)paren
suffix:semicolon
multiline_comment|/* FIXME: can this go away ? */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|channel-&gt;buf_pages
suffix:semicolon
id|i
op_increment
)paren
id|SetPageReserved
c_func
(paren
id|page
op_increment
)paren
suffix:semicolon
multiline_comment|/* Prep buffer registers */
id|outw
(paren
id|channel-&gt;frag_sz
op_minus
l_int|1
comma
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_COUNT
)paren
suffix:semicolon
id|outl
(paren
id|channel-&gt;buf_handle
comma
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_BUF1
)paren
suffix:semicolon
id|outl
(paren
id|channel-&gt;buf_handle
op_plus
id|channel-&gt;frag_sz
comma
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_BUF2
)paren
suffix:semicolon
multiline_comment|/* Reset hwptr */
id|channel-&gt;hwptr
op_assign
id|channel-&gt;frag_sz
suffix:semicolon
id|channel-&gt;next_buf
op_assign
l_int|1
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: %s buffer @ %p (%p)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;name
comma
id|channel-&gt;buf
comma
id|channel-&gt;buf_handle
)paren
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_drain:&n; * @chip:&t;&n; * @channel:&t;&n; *&n; * Locking:&t;Don&squot;t hold the lock.&n; */
r_static
r_inline
r_int
DECL|function|forte_channel_drain
id|forte_channel_drain
(paren
r_struct
id|forte_channel
op_star
id|channel
)paren
(brace
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;mapped
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|forte-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|forte_channel_stop
(paren
id|channel
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|forte-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|forte-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|add_wait_queue
(paren
op_amp
id|channel-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|channel-&gt;active
op_eq
l_int|0
op_logical_or
id|channel-&gt;filled_frags
op_eq
l_int|1
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|forte-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__set_current_state
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|forte-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|forte_channel_stop
(paren
id|channel
)paren
suffix:semicolon
id|forte_channel_reset
(paren
id|channel
)paren
suffix:semicolon
id|set_current_state
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
(paren
op_amp
id|channel-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|forte-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_init:&n; * @chip: &t;Forte chip instance the channel hangs off&n; * @channel: &t;Channel to initialize&n; *&n; * Description:&n; *&t;        Initializes a channel, sets defaults, and allocates&n; *&t;        buffers.&n; *&n; * Locking:&t;No lock held.&n; */
r_static
r_int
DECL|function|forte_channel_init
id|forte_channel_init
(paren
r_struct
id|forte_chip
op_star
id|chip
comma
r_struct
id|forte_channel
op_star
id|channel
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%s: chip iobase @ %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_void
op_star
)paren
id|chip-&gt;iobase
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
id|memset
(paren
id|channel
comma
l_int|0x0
comma
r_sizeof
(paren
op_star
id|channel
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_eq
op_amp
id|chip-&gt;play
)paren
(brace
id|channel-&gt;name
op_assign
l_string|&quot;PCM_OUT&quot;
suffix:semicolon
id|channel-&gt;iobase
op_assign
id|chip-&gt;iobase
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: PCM-OUT iobase @ %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_void
op_star
)paren
id|channel-&gt;iobase
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|channel
op_eq
op_amp
id|chip-&gt;rec
)paren
(brace
id|channel-&gt;name
op_assign
l_string|&quot;PCM_IN&quot;
suffix:semicolon
id|channel-&gt;iobase
op_assign
id|chip-&gt;iobase
op_plus
id|FORTE_CAP_OFFSET
suffix:semicolon
id|channel-&gt;record
op_assign
l_int|1
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: PCM-IN iobase @ %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_void
op_star
)paren
id|channel-&gt;iobase
)paren
suffix:semicolon
)brace
r_else
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|channel-&gt;wait
)paren
suffix:semicolon
multiline_comment|/* Defaults: 48kHz, 16-bit, stereo */
id|channel-&gt;ctrl
op_assign
id|inw
(paren
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_CTRL
)paren
suffix:semicolon
id|forte_channel_reset
(paren
id|channel
)paren
suffix:semicolon
id|forte_channel_stereo
(paren
id|channel
comma
l_int|1
)paren
suffix:semicolon
id|forte_channel_format
(paren
id|channel
comma
id|AFMT_S16_LE
)paren
suffix:semicolon
id|forte_channel_rate
(paren
id|channel
comma
l_int|48000
)paren
suffix:semicolon
id|channel-&gt;frag_sz
op_assign
id|FORTE_DEF_FRAG_SIZE
suffix:semicolon
id|channel-&gt;frag_num
op_assign
id|FORTE_DEF_FRAGMENTS
suffix:semicolon
id|chip-&gt;trigger
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/** &n; * forte_channel_free:&n; * @chip:&t;Chip this channel hangs off&n; * @channel:&t;Channel to nuke &n; *&n; * Description:&n; * &t;&t;Resets channel and frees buffers.&n; *&n; * Locking:&t;Hold your horses.&n; */
r_static
r_void
DECL|function|forte_channel_free
id|forte_channel_free
(paren
r_struct
id|forte_chip
op_star
id|chip
comma
r_struct
id|forte_channel
op_star
id|channel
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|channel-&gt;buf_handle
)paren
r_return
suffix:semicolon
id|pci_free_consistent
(paren
id|chip-&gt;pci_dev
comma
id|channel-&gt;buf_pages
op_star
id|PAGE_SIZE
comma
id|channel-&gt;buf
comma
id|channel-&gt;buf_handle
)paren
suffix:semicolon
id|memset
(paren
id|channel
comma
l_int|0x0
comma
r_sizeof
(paren
op_star
id|channel
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* DSP --------------------------------------------------------------------- */
multiline_comment|/**&n; * forte_dsp_ioctl:&n; */
r_static
r_int
DECL|function|forte_dsp_ioctl
id|forte_dsp_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ival
op_assign
l_int|0
comma
id|ret
comma
id|rval
op_assign
l_int|0
comma
id|rd
comma
id|wr
comma
id|count
suffix:semicolon
r_struct
id|forte_chip
op_star
id|chip
suffix:semicolon
r_struct
id|audio_buf_info
id|abi
suffix:semicolon
r_struct
id|count_info
id|cinfo
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|__user
op_star
id|p
op_assign
id|argp
suffix:semicolon
id|chip
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|wr
op_assign
l_int|1
suffix:semicolon
r_else
id|wr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|rd
op_assign
l_int|1
suffix:semicolon
r_else
id|rd
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
(paren
id|SOUND_VERSION
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: GETCAPS&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ival
op_assign
id|FORTE_CAPS
suffix:semicolon
multiline_comment|/* DUPLEX */
r_return
id|put_user
(paren
id|ival
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: GETFMTS&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ival
op_assign
id|FORTE_FMTS
suffix:semicolon
multiline_comment|/* U8, 16LE */
r_return
id|put_user
(paren
id|ival
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* U8, 16LE */
id|DPRINTK
(paren
l_string|&quot;%s: SETFMT&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|ival
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
(brace
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|rval
op_assign
id|forte_channel_format
(paren
op_amp
id|chip-&gt;rec
comma
id|ival
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wr
)paren
(brace
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|rval
op_assign
id|forte_channel_format
(paren
op_amp
id|chip-&gt;play
comma
id|ival
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|rval
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
multiline_comment|/* 0 - mono, 1 - stereo */
id|DPRINTK
(paren
l_string|&quot;%s: STEREO&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|ival
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
(brace
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|rval
op_assign
id|forte_channel_stereo
(paren
op_amp
id|chip-&gt;rec
comma
id|ival
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wr
)paren
(brace
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|rval
op_assign
id|forte_channel_stereo
(paren
op_amp
id|chip-&gt;play
comma
id|ival
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|rval
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
multiline_comment|/* 1 - mono, 2 - stereo */
id|DPRINTK
(paren
l_string|&quot;%s: CHANNELS&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|ival
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
(brace
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|rval
op_assign
id|forte_channel_stereo
(paren
op_amp
id|chip-&gt;rec
comma
id|ival
op_minus
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wr
)paren
(brace
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
id|rval
op_assign
id|forte_channel_stereo
(paren
op_amp
id|chip-&gt;play
comma
id|ival
op_minus
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|rval
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: SPEED&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|ival
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
(brace
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|rval
op_assign
id|forte_channel_rate
(paren
op_amp
id|chip-&gt;rec
comma
id|ival
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wr
)paren
(brace
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
id|rval
op_assign
id|forte_channel_rate
(paren
op_amp
id|chip-&gt;play
comma
id|ival
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|rval
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: GETBLKSIZE&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
id|ival
op_assign
id|chip-&gt;rec.frag_sz
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
id|ival
op_assign
id|chip-&gt;play.frag_sz
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|ival
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: RESET&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
id|forte_channel_reset
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
id|forte_channel_reset
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: SYNC&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
id|ret
op_assign
id|forte_channel_drain
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: POST&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
(brace
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;play.filled_frags
)paren
id|forte_channel_start
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: SETFRAGMENT&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|ival
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
(brace
id|forte_channel_buffer
(paren
op_amp
id|chip-&gt;rec
comma
id|ival
op_amp
l_int|0xffff
comma
(paren
id|ival
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|ival
op_assign
(paren
id|chip-&gt;rec.frag_num
op_lshift
l_int|16
)paren
op_plus
id|chip-&gt;rec.frag_sz
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wr
)paren
(brace
id|forte_channel_buffer
(paren
op_amp
id|chip-&gt;play
comma
id|ival
op_amp
l_int|0xffff
comma
(paren
id|ival
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|ival
op_assign
(paren
id|chip-&gt;play.frag_num
op_lshift
l_int|16
)paren
op_plus
id|chip-&gt;play.frag_sz
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|ival
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: GETISPACE&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rd
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
id|abi.fragstotal
op_assign
id|chip-&gt;rec.frag_num
suffix:semicolon
id|abi.fragsize
op_assign
id|chip-&gt;rec.frag_sz
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;rec.mapped
)paren
(brace
id|abi.fragments
op_assign
id|chip-&gt;rec.frag_num
op_minus
l_int|2
suffix:semicolon
id|abi.bytes
op_assign
id|abi.fragments
op_star
id|abi.fragsize
suffix:semicolon
)brace
r_else
(brace
id|abi.fragments
op_assign
id|chip-&gt;rec.filled_frags
suffix:semicolon
id|abi.bytes
op_assign
id|abi.fragments
op_star
id|abi.fragsize
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|copy_to_user
(paren
id|argp
comma
op_amp
id|abi
comma
r_sizeof
(paren
id|abi
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: GETIPTR&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rd
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;rec.active
)paren
id|cinfo.ptr
op_assign
id|chip-&gt;rec.hwptr
suffix:semicolon
r_else
id|cinfo.ptr
op_assign
l_int|0
suffix:semicolon
id|cinfo.bytes
op_assign
id|chip-&gt;rec.bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|chip-&gt;rec.nr_irqs
suffix:semicolon
id|chip-&gt;rec.nr_irqs
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|copy_to_user
(paren
id|argp
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
id|abi.fragstotal
op_assign
id|chip-&gt;play.frag_num
suffix:semicolon
id|abi.fragsize
op_assign
id|chip-&gt;play.frag_sz
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;play.mapped
)paren
(brace
id|abi.fragments
op_assign
id|chip-&gt;play.frag_num
op_minus
l_int|2
suffix:semicolon
id|abi.bytes
op_assign
id|chip-&gt;play.buf_sz
suffix:semicolon
)brace
r_else
(brace
id|abi.fragments
op_assign
id|chip-&gt;play.frag_num
op_minus
id|chip-&gt;play.filled_frags
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;play.residue
)paren
id|abi.fragments
op_decrement
suffix:semicolon
id|abi.bytes
op_assign
id|abi.fragments
op_star
id|abi.fragsize
op_plus
id|chip-&gt;play.residue
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|copy_to_user
(paren
id|argp
comma
op_amp
id|abi
comma
r_sizeof
(paren
id|abi
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;play.active
)paren
id|cinfo.ptr
op_assign
id|chip-&gt;play.hwptr
suffix:semicolon
r_else
id|cinfo.ptr
op_assign
l_int|0
suffix:semicolon
id|cinfo.bytes
op_assign
id|chip-&gt;play.bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|chip-&gt;play.nr_irqs
suffix:semicolon
id|chip-&gt;play.nr_irqs
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|copy_to_user
(paren
id|argp
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|wr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;play.active
)paren
(brace
id|ival
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chip-&gt;play.mapped
)paren
(brace
id|count
op_assign
id|inw
(paren
id|chip-&gt;play.iobase
op_plus
id|FORTE_PLY_COUNT
)paren
op_plus
l_int|1
suffix:semicolon
id|ival
op_assign
id|chip-&gt;play.frag_sz
op_minus
id|count
suffix:semicolon
)brace
r_else
(brace
id|ival
op_assign
id|chip-&gt;play.filled_frags
op_star
id|chip-&gt;play.frag_sz
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;play.residue
)paren
id|ival
op_add_assign
id|chip-&gt;play.frag_sz
op_minus
id|chip-&gt;play.residue
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|ival
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: SETDUPLEX&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: GETTRIGGER&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|chip-&gt;trigger
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
r_if
c_cond
(paren
id|get_user
(paren
id|ival
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: SETTRIGGER %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ival
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wr
)paren
(brace
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ival
op_amp
id|PCM_ENABLE_OUTPUT
)paren
id|forte_channel_start
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
r_else
(brace
id|chip-&gt;trigger
op_assign
l_int|1
suffix:semicolon
id|forte_channel_prep
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rd
)paren
(brace
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ival
op_amp
id|PCM_ENABLE_INPUT
)paren
id|forte_channel_start
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
r_else
(brace
id|chip-&gt;trigger
op_assign
l_int|1
suffix:semicolon
id|forte_channel_prep
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: PCM_READ_RATE&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|chip-&gt;play.rate
comma
id|p
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: PCM_READ_CHANNELS&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|chip-&gt;play.stereo
comma
id|p
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: PCM_READ_BITS&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|put_user
(paren
id|chip-&gt;play.format
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|DPRINTK
(paren
l_string|&quot;%s: DSP_NONBLOCK&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|DPRINTK
(paren
l_string|&quot;Unsupported ioctl: %x (%p)&bslash;n&quot;
comma
id|cmd
comma
id|argp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_dsp_open:&n; */
r_static
r_int
DECL|function|forte_dsp_open
id|forte_dsp_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
op_assign
id|forte
suffix:semicolon
multiline_comment|/* FIXME: HACK FROM HELL! */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
(paren
op_amp
id|chip-&gt;open_sem
)paren
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%s: returning -EAGAIN&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
(paren
op_amp
id|chip-&gt;open_sem
)paren
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%s: returning -ERESTARTSYS&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
id|file-&gt;private_data
op_assign
id|forte
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: dsp opened by %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|current-&gt;pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|forte_channel_init
(paren
id|forte
comma
op_amp
id|forte-&gt;play
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|forte_channel_init
(paren
id|forte
comma
op_amp
id|forte-&gt;rec
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_dsp_release:&n; */
r_static
r_int
DECL|function|forte_dsp_release
id|forte_dsp_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: chip @ %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|forte_channel_drain
(paren
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
id|forte_channel_free
(paren
id|chip
comma
op_amp
id|chip-&gt;play
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_while
c_loop
(paren
id|chip-&gt;rec.filled_frags
OG
l_int|0
)paren
id|interruptible_sleep_on
(paren
op_amp
id|chip-&gt;rec.wait
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
id|forte_channel_stop
(paren
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|forte_channel_free
(paren
id|chip
comma
op_amp
id|chip-&gt;rec
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
)brace
id|up
(paren
op_amp
id|chip-&gt;open_sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_dsp_poll:&n; *&n; */
r_static
r_int
r_int
DECL|function|forte_dsp_poll
id|forte_dsp_poll
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
suffix:semicolon
r_struct
id|forte_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|chip
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|channel
op_assign
op_amp
id|chip-&gt;play
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;active
)paren
id|poll_wait
(paren
id|file
comma
op_amp
id|channel-&gt;wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;frag_num
op_minus
id|channel-&gt;filled_frags
OG
l_int|0
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|channel
op_assign
op_amp
id|chip-&gt;rec
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;active
)paren
id|poll_wait
(paren
id|file
comma
op_amp
id|channel-&gt;wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;filled_frags
OG
l_int|0
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
)brace
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_dsp_mmap:&n; */
r_static
r_int
DECL|function|forte_dsp_mmap
id|forte_dsp_mmap
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
suffix:semicolon
r_struct
id|forte_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|chip
op_assign
id|file-&gt;private_data
suffix:semicolon
id|DPRINTK
(paren
l_string|&quot;%s: start %lXh, size %ld, pgoff %ld&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_pgoff
)paren
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
op_logical_and
id|chip-&gt;play.active
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
op_logical_and
id|chip-&gt;rec.active
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|channel
op_assign
op_amp
id|chip-&gt;play
suffix:semicolon
r_else
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|channel
op_assign
op_amp
id|chip-&gt;rec
suffix:semicolon
r_else
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|forte_channel_prep
(paren
id|channel
)paren
suffix:semicolon
id|channel-&gt;mapped
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
op_ne
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|channel-&gt;buf_pages
op_star
id|PAGE_SIZE
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%s: size (%ld) &gt; buf_sz (%d) &bslash;n&quot;
comma
id|__FUNCTION__
comma
id|size
comma
id|channel-&gt;buf_sz
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|remap_page_range
(paren
id|vma
comma
id|vma-&gt;vm_start
comma
id|virt_to_phys
(paren
id|channel-&gt;buf
)paren
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%s: remap el a no worko&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irq
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_dsp_write:&n; */
r_static
id|ssize_t
DECL|function|forte_dsp_write
id|forte_dsp_write
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|bytes
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
suffix:semicolon
r_struct
id|forte_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|i
op_assign
id|bytes
comma
id|sz
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|bytes
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|chip
op_assign
(paren
r_struct
id|forte_chip
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|channel
op_assign
op_amp
id|chip-&gt;play
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|channel
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Set up buffers with the right fragment size */
id|forte_channel_prep
(paren
id|channel
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
)paren
(brace
multiline_comment|/* All fragment buffers in use -&gt; wait */
r_if
c_cond
(paren
id|channel-&gt;frag_num
op_minus
id|channel-&gt;filled_frags
op_eq
l_int|0
)paren
(brace
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
multiline_comment|/* For trigger or non-blocking operation, get out */
r_if
c_cond
(paren
id|chip-&gt;trigger
op_logical_or
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* Otherwise wait for buffers */
id|add_wait_queue
(paren
op_amp
id|channel-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;frag_num
op_minus
id|channel-&gt;filled_frags
)paren
r_break
suffix:semicolon
)brace
id|remove_wait_queue
(paren
op_amp
id|channel-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|channel-&gt;residue
)paren
id|sz
op_assign
id|channel-&gt;residue
suffix:semicolon
r_else
r_if
c_cond
(paren
id|i
OG
id|channel-&gt;frag_sz
)paren
id|sz
op_assign
id|channel-&gt;frag_sz
suffix:semicolon
r_else
id|sz
op_assign
id|i
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
(paren
r_void
op_star
)paren
id|channel-&gt;buf
op_plus
id|channel-&gt;swptr
comma
id|buffer
comma
id|sz
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Advance software pointer */
id|buffer
op_add_assign
id|sz
suffix:semicolon
id|channel-&gt;swptr
op_add_assign
id|sz
suffix:semicolon
id|channel-&gt;swptr
op_mod_assign
id|channel-&gt;buf_sz
suffix:semicolon
id|i
op_sub_assign
id|sz
suffix:semicolon
multiline_comment|/* Only bump filled_frags if a full fragment has been written */
r_if
c_cond
(paren
id|channel-&gt;swptr
op_mod
id|channel-&gt;frag_sz
op_eq
l_int|0
)paren
(brace
id|channel-&gt;filled_frags
op_increment
suffix:semicolon
id|channel-&gt;residue
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|channel-&gt;residue
op_assign
id|channel-&gt;frag_sz
op_minus
id|sz
suffix:semicolon
multiline_comment|/* If playback isn&squot;t active, start it */
r_if
c_cond
(paren
id|channel-&gt;active
op_eq
l_int|0
op_logical_and
id|chip-&gt;trigger
op_eq
l_int|0
)paren
id|forte_channel_start
(paren
id|channel
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|bytes
op_minus
id|i
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_dsp_read:&n; */
r_static
id|ssize_t
DECL|function|forte_dsp_read
id|forte_dsp_read
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buffer
comma
r_int
id|bytes
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
suffix:semicolon
r_struct
id|forte_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|i
op_assign
id|bytes
comma
id|sz
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|bytes
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|chip
op_assign
(paren
r_struct
id|forte_chip
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|channel
op_assign
op_amp
id|chip-&gt;rec
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|channel
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Set up buffers with the right fragment size */
id|forte_channel_prep
(paren
id|channel
)paren
suffix:semicolon
multiline_comment|/* Start recording */
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;trigger
)paren
id|forte_channel_start
(paren
id|channel
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
)paren
(brace
multiline_comment|/* No fragment buffers in use -&gt; wait */
r_if
c_cond
(paren
id|channel-&gt;filled_frags
op_eq
l_int|0
)paren
(brace
id|DECLARE_WAITQUEUE
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
multiline_comment|/* For trigger mode operation, get out */
r_if
c_cond
(paren
id|chip-&gt;trigger
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|add_wait_queue
(paren
op_amp
id|channel-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|channel-&gt;active
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;filled_frags
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_current_state
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|set_current_state
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
(paren
op_amp
id|channel-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OG
id|channel-&gt;frag_sz
)paren
id|sz
op_assign
id|channel-&gt;frag_sz
suffix:semicolon
r_else
id|sz
op_assign
id|i
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|buffer
comma
(paren
r_void
op_star
)paren
id|channel-&gt;buf
op_plus
id|channel-&gt;swptr
comma
id|sz
)paren
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%s: copy_to_user failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Advance software pointer */
id|buffer
op_add_assign
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;filled_frags
OG
l_int|0
)paren
id|channel-&gt;filled_frags
op_decrement
suffix:semicolon
id|channel-&gt;swptr
op_add_assign
id|channel-&gt;frag_sz
suffix:semicolon
id|channel-&gt;swptr
op_mod_assign
id|channel-&gt;buf_sz
suffix:semicolon
id|i
op_sub_assign
id|sz
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|bytes
op_minus
id|i
suffix:semicolon
)brace
DECL|variable|forte_dsp_fops
r_static
r_struct
id|file_operations
id|forte_dsp_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
op_amp
id|no_llseek
comma
dot
id|read
op_assign
op_amp
id|forte_dsp_read
comma
dot
id|write
op_assign
op_amp
id|forte_dsp_write
comma
dot
id|poll
op_assign
op_amp
id|forte_dsp_poll
comma
dot
id|ioctl
op_assign
op_amp
id|forte_dsp_ioctl
comma
dot
id|open
op_assign
op_amp
id|forte_dsp_open
comma
dot
id|release
op_assign
op_amp
id|forte_dsp_release
comma
dot
id|mmap
op_assign
op_amp
id|forte_dsp_mmap
comma
)brace
suffix:semicolon
multiline_comment|/* Common ------------------------------------------------------------------ */
multiline_comment|/**&n; * forte_interrupt:&n; */
r_static
id|irqreturn_t
DECL|function|forte_interrupt
id|forte_interrupt
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
op_assign
id|dev_id
suffix:semicolon
r_struct
id|forte_channel
op_star
id|channel
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|status
comma
id|count
suffix:semicolon
id|status
op_assign
id|inw
(paren
id|chip-&gt;iobase
op_plus
id|FORTE_IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* If this is not for us, get outta here ASAP */
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
id|FORTE_IRQ_PLAYBACK
op_or
id|FORTE_IRQ_CAPTURE
)paren
)paren
op_eq
l_int|0
)paren
r_return
id|IRQ_NONE
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|FORTE_IRQ_PLAYBACK
)paren
(brace
id|channel
op_assign
op_amp
id|chip-&gt;play
suffix:semicolon
id|spin_lock
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;frag_sz
op_eq
l_int|0
)paren
r_goto
id|pack
suffix:semicolon
multiline_comment|/* Declare a fragment done */
r_if
c_cond
(paren
id|channel-&gt;filled_frags
OG
l_int|0
)paren
id|channel-&gt;filled_frags
op_decrement
suffix:semicolon
id|channel-&gt;bytes
op_add_assign
id|channel-&gt;frag_sz
suffix:semicolon
id|channel-&gt;nr_irqs
op_increment
suffix:semicolon
multiline_comment|/* Flip-flop between buffer I and II */
id|channel-&gt;next_buf
op_xor_assign
l_int|1
suffix:semicolon
multiline_comment|/* Advance hardware pointer by fragment size and wrap around */
id|channel-&gt;hwptr
op_add_assign
id|channel-&gt;frag_sz
suffix:semicolon
id|channel-&gt;hwptr
op_mod_assign
id|channel-&gt;buf_sz
suffix:semicolon
multiline_comment|/* Buffer I or buffer II BAR */
id|outl
(paren
id|channel-&gt;buf_handle
op_plus
id|channel-&gt;hwptr
comma
id|channel-&gt;next_buf
op_eq
l_int|0
ques
c_cond
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_BUF1
suffix:colon
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_BUF2
)paren
suffix:semicolon
multiline_comment|/* If the currently playing fragment is last, schedule pause */
r_if
c_cond
(paren
id|channel-&gt;filled_frags
op_eq
l_int|1
)paren
id|forte_channel_pause
(paren
id|channel
)paren
suffix:semicolon
id|pack
suffix:colon
multiline_comment|/* Acknowledge interrupt */
id|outw
(paren
id|FORTE_IRQ_PLAYBACK
comma
id|chip-&gt;iobase
op_plus
id|FORTE_IRQ_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
(paren
op_amp
id|channel-&gt;wait
)paren
)paren
id|wake_up_all
(paren
op_amp
id|channel-&gt;wait
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|FORTE_IRQ_CAPTURE
)paren
(brace
id|channel
op_assign
op_amp
id|chip-&gt;rec
suffix:semicolon
id|spin_lock
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* One fragment filled */
id|channel-&gt;filled_frags
op_increment
suffix:semicolon
multiline_comment|/* Get # of completed bytes */
id|count
op_assign
id|inw
(paren
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_COUNT
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|DPRINTK
(paren
l_string|&quot;%s: last, filled_frags = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|channel-&gt;filled_frags
)paren
suffix:semicolon
id|channel-&gt;filled_frags
op_assign
l_int|0
suffix:semicolon
r_goto
id|rack
suffix:semicolon
)brace
multiline_comment|/* Buffer I or buffer II BAR */
id|outl
(paren
id|channel-&gt;buf_handle
op_plus
id|channel-&gt;hwptr
comma
id|channel-&gt;next_buf
op_eq
l_int|0
ques
c_cond
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_BUF1
suffix:colon
id|channel-&gt;iobase
op_plus
id|FORTE_PLY_BUF2
)paren
suffix:semicolon
multiline_comment|/* Flip-flop between buffer I and II */
id|channel-&gt;next_buf
op_xor_assign
l_int|1
suffix:semicolon
multiline_comment|/* Advance hardware pointer by fragment size and wrap around */
id|channel-&gt;hwptr
op_add_assign
id|channel-&gt;frag_sz
suffix:semicolon
id|channel-&gt;hwptr
op_mod_assign
id|channel-&gt;buf_sz
suffix:semicolon
multiline_comment|/* Out of buffers */
r_if
c_cond
(paren
id|channel-&gt;filled_frags
op_eq
id|channel-&gt;frag_num
op_minus
l_int|1
)paren
id|forte_channel_stop
(paren
id|channel
)paren
suffix:semicolon
id|rack
suffix:colon
multiline_comment|/* Acknowledge interrupt */
id|outw
(paren
id|FORTE_IRQ_CAPTURE
comma
id|chip-&gt;iobase
op_plus
id|FORTE_IRQ_STATUS
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
(paren
op_amp
id|channel-&gt;wait
)paren
)paren
id|wake_up_all
(paren
op_amp
id|channel-&gt;wait
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_proc_read:&n; */
r_static
r_int
DECL|function|forte_proc_read
id|forte_proc_read
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
op_assign
l_int|0
comma
id|p_rate
comma
id|p_chan
comma
id|r_rate
suffix:semicolon
r_int
r_int
id|p_reg
comma
id|r_reg
suffix:semicolon
id|i
op_add_assign
id|sprintf
(paren
id|page
comma
l_string|&quot;ForteMedia FM801 OSS Lite driver&bslash;n%s&bslash;n &bslash;n&quot;
comma
id|DRIVER_VERSION
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|forte-&gt;iobase
)paren
r_return
id|i
suffix:semicolon
id|p_rate
op_assign
id|p_chan
op_assign
op_minus
l_int|1
suffix:semicolon
id|p_reg
op_assign
id|inw
(paren
id|forte-&gt;iobase
op_plus
id|FORTE_PLY_CTRL
)paren
suffix:semicolon
id|p_rate
op_assign
(paren
id|p_reg
op_rshift
l_int|8
)paren
op_amp
l_int|15
suffix:semicolon
id|p_chan
op_assign
(paren
id|p_reg
op_rshift
l_int|12
)paren
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|p_rate
op_ge
l_int|0
op_logical_or
id|p_rate
op_le
l_int|10
)paren
id|p_rate
op_assign
id|rates
(braket
id|p_rate
)braket
suffix:semicolon
r_if
c_cond
(paren
id|p_chan
op_ge
l_int|0
op_logical_or
id|p_chan
op_le
l_int|2
)paren
id|p_chan
op_assign
id|channels
(braket
id|p_chan
)braket
suffix:semicolon
id|r_rate
op_assign
op_minus
l_int|1
suffix:semicolon
id|r_reg
op_assign
id|inw
(paren
id|forte-&gt;iobase
op_plus
id|FORTE_CAP_CTRL
)paren
suffix:semicolon
id|r_rate
op_assign
(paren
id|r_reg
op_rshift
l_int|8
)paren
op_amp
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|r_rate
op_ge
l_int|0
op_logical_or
id|r_rate
op_le
l_int|10
)paren
id|r_rate
op_assign
id|rates
(braket
id|r_rate
)braket
suffix:semicolon
id|i
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|i
comma
l_string|&quot;             Playback  Capture&bslash;n&quot;
l_string|&quot;FIFO empty : %-3s       %-3s&bslash;n&quot;
l_string|&quot;Buf1 Last  : %-3s       %-3s&bslash;n&quot;
l_string|&quot;Buf2 Last  : %-3s       %-3s&bslash;n&quot;
l_string|&quot;Started    : %-3s       %-3s&bslash;n&quot;
l_string|&quot;Paused     : %-3s       %-3s&bslash;n&quot;
l_string|&quot;Immed Stop : %-3s       %-3s&bslash;n&quot;
l_string|&quot;Rate       : %-5d     %-5d&bslash;n&quot;
l_string|&quot;Channels   : %-5d     -&bslash;n&quot;
l_string|&quot;16-bit     : %-3s       %-3s&bslash;n&quot;
l_string|&quot;Stereo     : %-3s       %-3s&bslash;n&quot;
l_string|&quot; &bslash;n&quot;
l_string|&quot;Buffer Sz  : %-6d    %-6d&bslash;n&quot;
l_string|&quot;Frag Sz    : %-6d    %-6d&bslash;n&quot;
l_string|&quot;Frag Num   : %-6d    %-6d&bslash;n&quot;
l_string|&quot;Frag msecs : %-6d    %-6d&bslash;n&quot;
l_string|&quot;Used Frags : %-6d    %-6d&bslash;n&quot;
l_string|&quot;Mapped     : %-3s       %-3s&bslash;n&quot;
comma
id|p_reg
op_amp
l_int|1
op_lshift
l_int|0
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|r_reg
op_amp
l_int|1
op_lshift
l_int|0
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|p_reg
op_amp
l_int|1
op_lshift
l_int|1
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|r_reg
op_amp
l_int|1
op_lshift
l_int|1
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|p_reg
op_amp
l_int|1
op_lshift
l_int|2
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|r_reg
op_amp
l_int|1
op_lshift
l_int|2
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|p_reg
op_amp
l_int|1
op_lshift
l_int|5
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|r_reg
op_amp
l_int|1
op_lshift
l_int|5
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|p_reg
op_amp
l_int|1
op_lshift
l_int|6
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|r_reg
op_amp
l_int|1
op_lshift
l_int|6
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|p_reg
op_amp
l_int|1
op_lshift
l_int|7
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|r_reg
op_amp
l_int|1
op_lshift
l_int|7
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|p_rate
comma
id|r_rate
comma
id|p_chan
comma
id|p_reg
op_amp
l_int|1
op_lshift
l_int|14
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|r_reg
op_amp
l_int|1
op_lshift
l_int|14
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|p_reg
op_amp
l_int|1
op_lshift
l_int|15
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|r_reg
op_amp
l_int|1
op_lshift
l_int|15
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|forte-&gt;play.buf_sz
comma
id|forte-&gt;rec.buf_sz
comma
id|forte-&gt;play.frag_sz
comma
id|forte-&gt;rec.frag_sz
comma
id|forte-&gt;play.frag_num
comma
id|forte-&gt;rec.frag_num
comma
id|forte-&gt;play.frag_msecs
comma
id|forte-&gt;rec.frag_msecs
comma
id|forte-&gt;play.filled_frags
comma
id|forte-&gt;rec.filled_frags
comma
id|forte-&gt;play.mapped
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|forte-&gt;rec.mapped
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_proc_init:&n; *&n; * Creates driver info entries in /proc&n; */
r_static
r_int
id|__init
DECL|function|forte_proc_init
id|forte_proc_init
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|proc_mkdir
(paren
l_string|&quot;driver/forte&quot;
comma
l_int|NULL
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|create_proc_read_entry
(paren
l_string|&quot;driver/forte/chip&quot;
comma
l_int|0
comma
l_int|NULL
comma
id|forte_proc_read
comma
id|forte
)paren
)paren
(brace
id|remove_proc_entry
(paren
l_string|&quot;driver/forte&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|create_proc_read_entry
c_func
(paren
l_string|&quot;driver/forte/ac97&quot;
comma
l_int|0
comma
l_int|NULL
comma
id|ac97_read_proc
comma
id|forte-&gt;ac97
)paren
)paren
(brace
id|remove_proc_entry
(paren
l_string|&quot;driver/forte/chip&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;driver/forte&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_proc_remove:&n; *&n; * Removes driver info entries in /proc&n; */
r_static
r_void
DECL|function|forte_proc_remove
id|forte_proc_remove
(paren
r_void
)paren
(brace
id|remove_proc_entry
(paren
l_string|&quot;driver/forte/ac97&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;driver/forte/chip&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;driver/forte&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_chip_init:&n; * @chip:&t;Chip instance to initialize&n; *&n; * Description:&n; * &t;&t;Resets chip, configures codec and registers the driver with&n; * &t;&t;the sound subsystem.&n; *&n; * &t;&t;Press and hold Start for 8 secs, then switch on Run&n; * &t;&t;and hold for 4 seconds.  Let go of Start.  Numbers&n; * &t;&t;assume a properly oiled TWG.&n; */
r_static
r_int
id|__devinit
DECL|function|forte_chip_init
id|forte_chip_init
(paren
r_struct
id|forte_chip
op_star
id|chip
)paren
(brace
id|u8
id|revision
suffix:semicolon
id|u16
id|cmdw
suffix:semicolon
r_struct
id|ac97_codec
op_star
id|codec
suffix:semicolon
id|pci_read_config_byte
(paren
id|chip-&gt;pci_dev
comma
id|PCI_REVISION_ID
comma
op_amp
id|revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revision
op_ge
l_int|0xB1
)paren
(brace
id|chip-&gt;multichannel
op_assign
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Multi-channel device detected.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset chip */
id|outw
(paren
id|FORTE_CC_CODEC_RESET
op_or
id|FORTE_CC_AC97_RESET
comma
id|chip-&gt;iobase
op_plus
id|FORTE_CODEC_CTRL
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|outw
(paren
l_int|0
comma
id|chip-&gt;iobase
op_plus
id|FORTE_CODEC_CTRL
)paren
suffix:semicolon
multiline_comment|/* Request read from AC97 */
id|outw
(paren
id|FORTE_AC97_READ
op_or
(paren
l_int|0
op_lshift
id|FORTE_AC97_ADDR_SHIFT
)paren
comma
id|chip-&gt;iobase
op_plus
id|FORTE_AC97_CMD
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|750
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inw
(paren
id|chip-&gt;iobase
op_plus
id|FORTE_AC97_CMD
)paren
op_amp
(paren
l_int|3
op_lshift
l_int|8
)paren
)paren
op_ne
(paren
l_int|1
op_lshift
l_int|8
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;AC97 codec not responding&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Init volume */
id|outw
(paren
l_int|0x0808
comma
id|chip-&gt;iobase
op_plus
id|FORTE_PCM_VOL
)paren
suffix:semicolon
id|outw
(paren
l_int|0x9f1f
comma
id|chip-&gt;iobase
op_plus
id|FORTE_FM_VOL
)paren
suffix:semicolon
id|outw
(paren
l_int|0x8808
comma
id|chip-&gt;iobase
op_plus
id|FORTE_I2S_VOL
)paren
suffix:semicolon
multiline_comment|/* I2S control - I2S mode */
id|outw
(paren
l_int|0x0003
comma
id|chip-&gt;iobase
op_plus
id|FORTE_I2S_MODE
)paren
suffix:semicolon
multiline_comment|/* Interrupt setup - unmask PLAYBACK &amp; CAPTURE */
id|cmdw
op_assign
id|inw
(paren
id|chip-&gt;iobase
op_plus
id|FORTE_IRQ_MASK
)paren
suffix:semicolon
id|cmdw
op_and_assign
op_complement
l_int|0x0003
suffix:semicolon
id|outw
(paren
id|cmdw
comma
id|chip-&gt;iobase
op_plus
id|FORTE_IRQ_MASK
)paren
suffix:semicolon
multiline_comment|/* Interrupt clear */
id|outw
(paren
id|FORTE_IRQ_PLAYBACK
op_or
id|FORTE_IRQ_CAPTURE
comma
id|chip-&gt;iobase
op_plus
id|FORTE_IRQ_STATUS
)paren
suffix:semicolon
multiline_comment|/* Set up the AC97 codec */
r_if
c_cond
(paren
(paren
id|codec
op_assign
id|ac97_alloc_codec
c_func
(paren
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|codec-&gt;private_data
op_assign
id|chip
suffix:semicolon
id|codec-&gt;codec_read
op_assign
id|forte_ac97_read
suffix:semicolon
id|codec-&gt;codec_write
op_assign
id|forte_ac97_write
suffix:semicolon
id|codec-&gt;id
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ac97_probe_codec
(paren
id|codec
)paren
op_eq
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;codec probe failed&bslash;n&quot;
)paren
suffix:semicolon
id|ac97_release_codec
c_func
(paren
id|codec
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Register mixer */
r_if
c_cond
(paren
(paren
id|codec-&gt;dev_mixer
op_assign
id|register_sound_mixer
(paren
op_amp
id|forte_mixer_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;couldn&squot;t register mixer!&bslash;n&quot;
)paren
suffix:semicolon
id|ac97_release_codec
c_func
(paren
id|codec
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|chip-&gt;ac97
op_assign
id|codec
suffix:semicolon
multiline_comment|/* Register DSP */
r_if
c_cond
(paren
(paren
id|chip-&gt;dsp
op_assign
id|register_sound_dsp
(paren
op_amp
id|forte_dsp_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;couldn&squot;t register dsp!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Register with /proc */
r_if
c_cond
(paren
id|forte_proc_init
c_func
(paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PFX
l_string|&quot;couldn&squot;t add entries to /proc!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_probe:&n; * @pci_dev:&t;PCI struct for probed device&n; * @pci_id:&t;&n; *&n; * Description:&n; *&t;&t;Allocates chip instance, I/O region, and IRQ&n; */
r_static
r_int
id|__init
DECL|function|forte_probe
id|forte_probe
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pci_id
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: Support more than one chip */
r_if
c_cond
(paren
id|found
op_increment
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Ignition */
r_if
c_cond
(paren
id|pci_enable_device
(paren
id|pci_dev
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|pci_set_master
(paren
id|pci_dev
)paren
suffix:semicolon
multiline_comment|/* Allocate chip instance and configure */
id|forte
op_assign
(paren
r_struct
id|forte_chip
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|forte_chip
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|chip
op_assign
id|forte
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;Out of memory&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|chip
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|forte_chip
)paren
)paren
suffix:semicolon
id|chip-&gt;pci_dev
op_assign
id|pci_dev
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|chip-&gt;open_sem
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
id|spin_lock_init
(paren
op_amp
id|chip-&gt;ac97_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
(paren
id|pci_resource_start
(paren
id|pci_dev
comma
l_int|0
)paren
comma
id|pci_resource_len
(paren
id|pci_dev
comma
l_int|0
)paren
comma
id|DRIVER_NAME
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;Unable to reserve I/O space&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|chip-&gt;iobase
op_assign
id|pci_resource_start
(paren
id|pci_dev
comma
l_int|0
)paren
suffix:semicolon
id|chip-&gt;irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
(paren
id|chip-&gt;irq
comma
id|forte_interrupt
comma
id|SA_SHIRQ
comma
id|DRIVER_NAME
comma
id|chip
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;Unable to reserve IRQ&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|pci_set_drvdata
(paren
id|pci_dev
comma
id|chip
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;FM801 chip found at 0x%04lX-0x%04lX IRQ %u&bslash;n&quot;
comma
id|chip-&gt;iobase
comma
id|pci_resource_end
(paren
id|pci_dev
comma
l_int|0
)paren
comma
id|chip-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Power it up */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|forte_chip_init
(paren
id|chip
)paren
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|chip-&gt;irq
)paren
id|free_irq
(paren
id|chip-&gt;irq
comma
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;iobase
)paren
id|release_region
(paren
id|pci_resource_start
(paren
id|pci_dev
comma
l_int|0
)paren
comma
id|pci_resource_len
(paren
id|pci_dev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|kfree
(paren
id|chip
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_remove:&n; * @pci_dev:&t;PCI device to unclaim&n; *&n; */
r_static
r_void
DECL|function|forte_remove
id|forte_remove
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|forte_chip
op_star
id|chip
op_assign
id|pci_get_drvdata
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* Turn volume down to avoid popping */
id|outw
(paren
l_int|0x1f1f
comma
id|chip-&gt;iobase
op_plus
id|FORTE_PCM_VOL
)paren
suffix:semicolon
id|outw
(paren
l_int|0x1f1f
comma
id|chip-&gt;iobase
op_plus
id|FORTE_FM_VOL
)paren
suffix:semicolon
id|outw
(paren
l_int|0x1f1f
comma
id|chip-&gt;iobase
op_plus
id|FORTE_I2S_VOL
)paren
suffix:semicolon
id|forte_proc_remove
c_func
(paren
)paren
suffix:semicolon
id|free_irq
(paren
id|chip-&gt;irq
comma
id|chip
)paren
suffix:semicolon
id|release_region
(paren
id|chip-&gt;iobase
comma
id|pci_resource_len
(paren
id|pci_dev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|unregister_sound_dsp
(paren
id|chip-&gt;dsp
)paren
suffix:semicolon
id|unregister_sound_mixer
(paren
id|chip-&gt;ac97-&gt;dev_mixer
)paren
suffix:semicolon
id|ac97_release_codec
c_func
(paren
id|chip-&gt;ac97
)paren
suffix:semicolon
id|kfree
(paren
id|chip
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;driver released&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|forte_pci_ids
r_static
r_struct
id|pci_device_id
id|forte_pci_ids
(braket
)braket
op_assign
(brace
(brace
l_int|0x1319
comma
l_int|0x0801
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|variable|forte_pci_driver
r_static
r_struct
id|pci_driver
id|forte_pci_driver
op_assign
(brace
dot
id|name
op_assign
id|DRIVER_NAME
comma
dot
id|id_table
op_assign
id|forte_pci_ids
comma
dot
id|probe
op_assign
id|forte_probe
comma
dot
id|remove
op_assign
id|forte_remove
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * forte_init_module:&n; *&n; */
r_static
r_int
id|__init
DECL|function|forte_init_module
id|forte_init_module
(paren
r_void
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PFX
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_register_driver
(paren
op_amp
id|forte_pci_driver
)paren
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|forte_pci_driver
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * forte_cleanup_module:&n; *&n; */
r_static
r_void
id|__exit
DECL|function|forte_cleanup_module
id|forte_cleanup_module
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|forte_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|forte_init_module
id|module_init
c_func
(paren
id|forte_init_module
)paren
suffix:semicolon
DECL|variable|forte_cleanup_module
id|module_exit
c_func
(paren
id|forte_cleanup_module
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Martin K. Petersen &lt;mkp@mkp.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ForteMedia FM801 OSS Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|forte_pci_ids
)paren
suffix:semicolon
eof
