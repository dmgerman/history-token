multiline_comment|/*&n; *&t;OSS driver for Linux 2.[46].x for&n; *&n; *&t;Trident 4D-Wave&n; *&t;SiS 7018&n; *&t;ALi 5451&n; *&t;Tvia/IGST CyberPro 5050&n; *&n; *&t;Driver: Alan Cox &lt;alan@redhat.com&gt;&n; *&n; *  Built from:&n; *&t;Low level code: &lt;audio@tridentmicro.com&gt; from ALSA&n; *&t;Framework: Thomas Sailer &lt;sailer@ife.ee.ethz.ch&gt;&n; *&t;Extended by: Zach Brown &lt;zab@redhat.com&gt;  &n; *&n; *  Hacked up by:&n; *&t;Aaron Holtzman &lt;aholtzma@ess.engr.uvic.ca&gt;&n; *&t;Ollie Lho &lt;ollie@sis.com.tw&gt; SiS 7018 Audio Core Support&n; *&t;Ching-Ling Lee &lt;cling-li@ali.com.tw&gt; ALi 5451 Audio Core Support &n; *&t;Matt Wu &lt;mattwu@acersoftech.com.cn&gt; ALi 5451 Audio Core Support&n; *&t;Peter W&#xfffd;chtler &lt;pwaechtler@loewe-komp.de&gt; CyberPro5050 support&n; *      Muli Ben-Yehuda &lt;mulix@mulix.org&gt;&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; *&t;This program is distributed in the hope that it will be useful,&n; *&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *&t;GNU General Public License for more details.&n; *&n; *&t;You should have received a copy of the GNU General Public License&n; *&t;along with this program; if not, write to the Free Software&n; *&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  History&n; *  v0.14.10j&n; *  &t;January 3 2004 Eugene Teo &lt;eugeneteo@eugeneteo.net&gt;&n; *  &t;minor cleanup to use pr_debug instead of TRDBG since it is already&n; *  &t;defined in linux/kernel.h.&n; *  v0.14.10i&n; *      December 29 2003 Muli Ben-Yehuda &lt;mulix@mulix.org&gt;&n; *      major cleanup for 2.6, fix a few error patch buglets&n; *      with returning without properly cleaning up first,&n; *      get rid of lock_kernel().&n; *  v0.14.10h&n; *&t;Sept 10 2002 Pascal Schmidt &lt;der.eremit@email.de&gt;&n; *&t;added support for ALi 5451 joystick port&n; *  v0.14.10g&n; *&t;Sept 05 2002 Alan Cox &lt;alan@redhat.com&gt;&n; *&t;adapt to new pci joystick attachment interface&n; *  v0.14.10f&n; *      July 24 2002 Muli Ben-Yehuda &lt;mulix@actcom.co.il&gt;&n; *      patch from Eric Lemar (via Ian Soboroff): in suspend and resume, &n; *      fix wrong cast from pci_dev* to struct trident_card*. &n; *  v0.14.10e&n; *      July 19 2002 Muli Ben-Yehuda &lt;mulix@actcom.co.il&gt;&n; *      rewrite the DMA buffer allocation/deallcoation functions, to make it &n; *      modular and fix a bug where we would call free_pages on memory &n; *      obtained with pci_alloc_consistent. Also remove unnecessary #ifdef &n; *      CONFIG_PROC_FS and various other cleanups.&n; *  v0.14.10d&n; *      July 19 2002 Muli Ben-Yehuda &lt;mulix@actcom.co.il&gt;&n; *      made several printk(KERN_NOTICE...) into TRDBG(...), to avoid spamming&n; *      my syslog with hundreds of messages. &n; *  v0.14.10c&n; *      July 16 2002 Muli Ben-Yehuda &lt;mulix@actcom.co.il&gt;&n; *      Cleaned up Lei Hu&squot;s 0.4.10 driver to conform to Documentation/CodingStyle&n; *      and the coding style used in the rest of the file. &n; *  v0.14.10b&n; *      June 23 2002 Muli Ben-Yehuda &lt;mulix@actcom.co.il&gt;&n; *      add a missing unlock_set_fmt, remove a superflous lock/unlock pair &n; *      with nothing in between. &n; *  v0.14.10a&n; *      June 21 2002 Muli Ben-Yehuda &lt;mulix@actcom.co.il&gt; &n; *      use a debug macro instead of #ifdef CONFIG_DEBUG, trim to 80 columns &n; *      per line, use &squot;do {} while (0)&squot; in statement macros. &n; *  v0.14.10&n; *      June 6 2002 Lei Hu &lt;Lei_hu@ali.com.tw&gt;&n; *      rewrite the part to read/write registers of audio codec for Ali5451 &n; *  v0.14.9e&n; *      January 2 2002 Vojtech Pavlik &lt;vojtech@ucw.cz&gt; added gameport&n; *      support to avoid resource conflict with pcigame.c&n; *  v0.14.9d&n; *  &t;October 8 2001 Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n; *&t;use set_current_state, properly release resources on failure in&n; *&t;trident_probe, get rid of check_region&n; *  v0.14.9c&n; *&t;August 10 2001 Peter W&#xfffd;chtler &lt;pwaechtler@loewe-komp.de&gt;&n; *&t;added support for Tvia (formerly Integraphics/IGST) CyberPro5050&n; *&t;this chip is often found in settop boxes (combined video+audio)&n; *  v0.14.9b&n; *&t;Switch to static inline not extern inline (gcc 3)&n; *  v0.14.9a&n; *&t;Aug 6 2001 Alan Cox&n; *&t;0.14.9 crashed on rmmod due to a timer/bh left running. Simplified&n; *&t;the existing logic (the BH doesn&squot;t help as ac97 is lock_irqsave)&n; *&t;and used del_timer_sync to clean up&n; *&t;Fixed a problem where the ALi change broke my generic card&n; *  v0.14.9&n; *&t;Jul 10 2001 Matt Wu&n; *&t;Add H/W Volume Control&n; *  v0.14.8a&n; *&t;July 7 2001 Alan Cox&n; *&t;Moved Matt Wu&squot;s ac97 register cache into the card structure&n; *  v0.14.8&n; *&t;Apr 30 2001 Matt Wu&n; *&t;Set EBUF1 and EBUF2 to still mode&n; *&t;Add dc97/ac97 reset function&n; *&t;Fix power management: ali_restore_regs&n; *  unreleased &n; *&t;Mar 09 2001 Matt Wu&n; *&t;Add cache for ac97 access&n; *  v0.14.7&n; *&t;Feb 06 2001 Matt Wu&n; *&t;Fix ac97 initialization&n; *&t;Fix bug: an extra tail will be played when playing&n; *&t;Jan 05 2001 Matt Wu&n; *&t;Implement multi-channels and S/PDIF in support for ALi 1535+&n; *  v0.14.6 &n; *&t;Nov 1 2000 Ching-Ling Lee&n; *&t;Fix the bug of memory leak when switching 5.1-channels to 2 channels.&n; *&t;Add lock protection into dynamic changing format of data.&n; *&t;Oct 18 2000 Ching-Ling Lee&n; *&t;5.1-channels support for ALi&n; *&t;June 28 2000 Ching-Ling Lee&n; *&t;S/PDIF out/in(playback/record) support for ALi 1535+, using /proc to be selected by user&n; *&t;Simple Power Management support for ALi&n; *  v0.14.5 May 23 2000 Ollie Lho&n; *  &t;Misc bug fix from the Net&n; *  v0.14.4 May 20 2000 Aaron Holtzman&n; *  &t;Fix kfree&squot;d memory access in release&n; *  &t;Fix race in open while looking for a free virtual channel slot&n; *  &t;remove open_wait wq (which appears to be unused)&n; *  v0.14.3 May 10 2000 Ollie Lho&n; *&t;fixed a small bug in trident_update_ptr, xmms 1.0.1 no longer uses 100% CPU&n; *  v0.14.2 Mar 29 2000 Ching-Ling Lee&n; *&t;Add clear to silence advance in trident_update_ptr &n; *&t;fix invalid data of the end of the sound&n; *  v0.14.1 Mar 24 2000 Ching-Ling Lee&n; *&t;ALi 5451 support added, playback and recording O.K.&n; *&t;ALi 5451 originally developed and structured based on sonicvibes, and&n; *&t;suggested to merge into this file by Alan Cox.&n; *  v0.14 Mar 15 2000 Ollie Lho&n; *&t;5.1 channel output support with channel binding. What&squot;s the Matrix ?&n; *  v0.13.1 Mar 10 2000 Ollie Lho&n; *&t;few minor bugs on dual codec support, needs more testing&n; *  v0.13 Mar 03 2000 Ollie Lho&n; *&t;new pci_* for 2.4 kernel, back ported to 2.2&n; *  v0.12 Feb 23 2000 Ollie Lho&n; *&t;Preliminary Recording support&n; *  v0.11.2 Feb 19 2000 Ollie Lho&n; *&t;removed incomplete full-dulplex support&n; *  v0.11.1 Jan 28 2000 Ollie Lho&n; *&t;small bug in setting sample rate for 4d-nx (reported by Aaron)&n; *  v0.11 Jan 27 2000 Ollie Lho&n; *&t;DMA bug, scheduler latency, second try&n; *  v0.10 Jan 24 2000 Ollie Lho&n; *&t;DMA bug fixed, found kernel scheduling problem&n; *  v0.09 Jan 20 2000 Ollie Lho&n; *&t;Clean up of channel register access routine (prepare for channel binding)&n; *  v0.08 Jan 14 2000 Ollie Lho&n; *&t;Isolation of AC97 codec code&n; *  v0.07 Jan 13 2000 Ollie Lho&n; *&t;Get rid of ugly old low level access routines (e.g. CHRegs.lp****)&n; *  v0.06 Jan 11 2000 Ollie Lho&n; *&t;Preliminary support for dual (more ?) AC97 codecs&n; *  v0.05 Jan 08 2000 Luca Montecchiani &lt;m.luca@iname.com&gt;&n; *&t;adapt to 2.3.x new __setup/__init call&n; *  v0.04 Dec 31 1999 Ollie Lho&n; *&t;Multiple Open, using Middle Loop Interrupt to smooth playback&n; *  v0.03 Dec 24 1999 Ollie Lho&n; *&t;mem leak in prog_dmabuf and dealloc_dmabuf removed&n; *  v0.02 Dec 15 1999 Ollie Lho&n; *&t;SiS 7018 support added, playback O.K.&n; *  v0.01 Alan Cox et. al.&n; *&t;Initial Release in kernel 2.3.30, does not work&n; * &n; *  ToDo&n; *&t;Clean up of low level channel register access code. (done)&n; *&t;Fix the bug on dma buffer management in update_ptr, read/write, drain_dac (done)&n; *&t;Dual AC97 codecs support (done)&n; *&t;Recording support (done)&n; *&t;Mmap support&n; *&t;&quot;Channel Binding&quot; ioctl extension (done)&n; *&t;new pci device driver interface for 2.4 kernel (done)&n; *&n; *&t;Lock order (high-&gt;low)&n; *&t;&t;lock&t;-&t;hardware lock&n; *&t;&t;open_sem - &t;guard opens&n; *&t;&t;sem&t;-&t;guard dmabuf, write re-entry etc&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/ac97_codec.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/gameport.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#if defined(CONFIG_ALPHA_NAUTILUS) || defined(CONFIG_ALPHA_GENERIC)
macro_line|#include &lt;asm/hwrpb.h&gt;
macro_line|#endif
macro_line|#include &quot;trident.h&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;0.14.10j-2.6&quot;
multiline_comment|/* magic numbers to protect our data structures */
DECL|macro|TRIDENT_CARD_MAGIC
mdefine_line|#define TRIDENT_CARD_MAGIC&t;0x5072696E&t;/* &quot;Prin&quot; */
DECL|macro|TRIDENT_STATE_MAGIC
mdefine_line|#define TRIDENT_STATE_MAGIC&t;0x63657373&t;/* &quot;cess&quot; */
DECL|macro|TRIDENT_DMA_MASK
mdefine_line|#define TRIDENT_DMA_MASK&t;0x3fffffff&t;/* DMA buffer mask for pci_alloc_consist */
DECL|macro|ALI_DMA_MASK
mdefine_line|#define ALI_DMA_MASK&t;&t;0x7fffffff&t;/* ALI Tridents have 31-bit DMA. Wow. */
DECL|macro|NR_HW_CH
mdefine_line|#define NR_HW_CH&t;&t;32
multiline_comment|/* maximum number of AC97 codecs connected, AC97 2.0 defined 4, but 7018 and 4D-NX only&n;   have 2 SDATA_IN lines (currently) */
DECL|macro|NR_AC97
mdefine_line|#define NR_AC97&t;&t;2
multiline_comment|/* minor number of /dev/swmodem (temporary, experimental) */
DECL|macro|SND_DEV_SWMODEM
mdefine_line|#define SND_DEV_SWMODEM&t;7
DECL|variable|ali_multi_channels_5_1
r_static
r_const
r_int
id|ali_multi_channels_5_1
(braket
)braket
op_assign
(brace
multiline_comment|/*ALI_SURR_LEFT_CHANNEL, ALI_SURR_RIGHT_CHANNEL, */
id|ALI_CENTER_CHANNEL
comma
id|ALI_LEF_CHANNEL
comma
id|ALI_SURR_LEFT_CHANNEL
comma
id|ALI_SURR_RIGHT_CHANNEL
)brace
suffix:semicolon
DECL|variable|sample_size
r_static
r_const
r_int
id|sample_size
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|4
)brace
suffix:semicolon
DECL|variable|sample_shift
r_static
r_const
r_int
id|sample_shift
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|2
)brace
suffix:semicolon
DECL|variable|invalid_magic
r_static
r_const
r_char
id|invalid_magic
(braket
)braket
op_assign
id|KERN_CRIT
l_string|&quot;trident: invalid magic value in %s&bslash;n&quot;
suffix:semicolon
r_enum
(brace
DECL|enumerator|TRIDENT_4D_DX
id|TRIDENT_4D_DX
op_assign
l_int|0
comma
DECL|enumerator|TRIDENT_4D_NX
id|TRIDENT_4D_NX
comma
DECL|enumerator|SIS_7018
id|SIS_7018
comma
DECL|enumerator|ALI_5451
id|ALI_5451
comma
DECL|enumerator|CYBER5050
id|CYBER5050
)brace
suffix:semicolon
DECL|variable|card_names
r_static
r_char
op_star
id|card_names
(braket
)braket
op_assign
(brace
l_string|&quot;Trident 4DWave DX&quot;
comma
l_string|&quot;Trident 4DWave NX&quot;
comma
l_string|&quot;SiS 7018 PCI Audio&quot;
comma
l_string|&quot;ALi Audio Accelerator&quot;
comma
l_string|&quot;Tvia/IGST CyberPro 5050&quot;
)brace
suffix:semicolon
DECL|variable|trident_pci_tbl
r_static
r_struct
id|pci_device_id
id|trident_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_TRIDENT
comma
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TRIDENT_4D_DX
)brace
comma
(brace
id|PCI_VENDOR_ID_TRIDENT
comma
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|TRIDENT_4D_NX
)brace
comma
(brace
id|PCI_VENDOR_ID_SI
comma
id|PCI_DEVICE_ID_SI_7018
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|SIS_7018
)brace
comma
(brace
id|PCI_VENDOR_ID_ALI
comma
id|PCI_DEVICE_ID_ALI_5451
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|ALI_5451
)brace
comma
(brace
id|PCI_VENDOR_ID_INTERG
comma
id|PCI_DEVICE_ID_INTERG_5050
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|CYBER5050
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|trident_pci_tbl
)paren
suffix:semicolon
multiline_comment|/* &quot;software&quot; or virtual channel, an instance of opened /dev/dsp */
DECL|struct|trident_state
r_struct
id|trident_state
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|card
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
multiline_comment|/* Card info */
multiline_comment|/* file mode */
DECL|member|open_mode
id|mode_t
id|open_mode
suffix:semicolon
multiline_comment|/* virtual channel number */
DECL|member|virt
r_int
id|virt
suffix:semicolon
DECL|struct|dmabuf
r_struct
id|dmabuf
(brace
multiline_comment|/* wave sample stuff */
DECL|member|rate
r_int
r_int
id|rate
suffix:semicolon
DECL|member|fmt
DECL|member|enable
r_int
r_char
id|fmt
comma
id|enable
suffix:semicolon
multiline_comment|/* hardware channel */
DECL|member|channel
r_struct
id|trident_channel
op_star
id|channel
suffix:semicolon
multiline_comment|/* OSS buffer management stuff */
DECL|member|rawbuf
r_void
op_star
id|rawbuf
suffix:semicolon
DECL|member|dma_handle
id|dma_addr_t
id|dma_handle
suffix:semicolon
DECL|member|buforder
r_int
id|buforder
suffix:semicolon
DECL|member|numfrag
r_int
id|numfrag
suffix:semicolon
DECL|member|fragshift
r_int
id|fragshift
suffix:semicolon
multiline_comment|/* our buffer acts like a circular ring */
DECL|member|hwptr
r_int
id|hwptr
suffix:semicolon
multiline_comment|/* where dma last started, updated by update_ptr */
DECL|member|swptr
r_int
id|swptr
suffix:semicolon
multiline_comment|/* where driver last clear/filled, updated by read/write */
DECL|member|count
r_int
id|count
suffix:semicolon
multiline_comment|/* bytes to be comsumed or been generated by dma machine */
DECL|member|total_bytes
r_int
id|total_bytes
suffix:semicolon
multiline_comment|/* total bytes dmaed by hardware */
DECL|member|error
r_int
id|error
suffix:semicolon
multiline_comment|/* number of over/underruns */
multiline_comment|/* put process on wait queue when no more space in buffer */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
multiline_comment|/* redundant, but makes calculations easier */
DECL|member|fragsize
r_int
id|fragsize
suffix:semicolon
DECL|member|dmasize
r_int
id|dmasize
suffix:semicolon
DECL|member|fragsamples
r_int
id|fragsamples
suffix:semicolon
multiline_comment|/* OSS stuff */
DECL|member|mapped
r_int
id|mapped
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ready
r_int
id|ready
suffix:colon
l_int|1
suffix:semicolon
DECL|member|endcleared
r_int
id|endcleared
suffix:colon
l_int|1
suffix:semicolon
DECL|member|update_flag
r_int
id|update_flag
suffix:semicolon
DECL|member|ossfragshift
r_int
id|ossfragshift
suffix:semicolon
DECL|member|ossmaxfrags
r_int
id|ossmaxfrags
suffix:semicolon
DECL|member|subdivision
r_int
id|subdivision
suffix:semicolon
DECL|member|dmabuf
)brace
id|dmabuf
suffix:semicolon
multiline_comment|/* 5.1 channels */
DECL|member|other_states
r_struct
id|trident_state
op_star
id|other_states
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|multi_channels_adjust_count
r_int
id|multi_channels_adjust_count
suffix:semicolon
DECL|member|chans_num
r_int
id|chans_num
suffix:semicolon
DECL|member|fmt_flag
r_int
r_int
id|fmt_flag
suffix:semicolon
multiline_comment|/* Guard against mmap/write/read races */
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* hardware channels */
DECL|struct|trident_channel
r_struct
id|trident_channel
(brace
DECL|member|num
r_int
id|num
suffix:semicolon
multiline_comment|/* channel number */
DECL|member|lba
id|u32
id|lba
suffix:semicolon
multiline_comment|/* Loop Begine Address, where dma buffer starts */
DECL|member|eso
id|u32
id|eso
suffix:semicolon
multiline_comment|/* End Sample Offset, wehre dma buffer ends */
multiline_comment|/* (in the unit of samples) */
DECL|member|delta
id|u32
id|delta
suffix:semicolon
multiline_comment|/* delta value, sample rate / 48k for playback, */
multiline_comment|/* 48k/sample rate for recording */
DECL|member|attribute
id|u16
id|attribute
suffix:semicolon
multiline_comment|/* control where PCM data go and come  */
DECL|member|fm_vol
id|u16
id|fm_vol
suffix:semicolon
DECL|member|control
id|u32
id|control
suffix:semicolon
multiline_comment|/* signed/unsigned, 8/16 bits, mono/stereo */
)brace
suffix:semicolon
DECL|struct|trident_pcm_bank_address
r_struct
id|trident_pcm_bank_address
(brace
DECL|member|start
id|u32
id|start
suffix:semicolon
DECL|member|stop
id|u32
id|stop
suffix:semicolon
DECL|member|aint
id|u32
id|aint
suffix:semicolon
DECL|member|aint_en
id|u32
id|aint_en
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|bank_a_addrs
r_static
r_struct
id|trident_pcm_bank_address
id|bank_a_addrs
op_assign
(brace
id|T4D_START_A
comma
id|T4D_STOP_A
comma
id|T4D_AINT_A
comma
id|T4D_AINTEN_A
)brace
suffix:semicolon
DECL|variable|bank_b_addrs
r_static
r_struct
id|trident_pcm_bank_address
id|bank_b_addrs
op_assign
(brace
id|T4D_START_B
comma
id|T4D_STOP_B
comma
id|T4D_AINT_B
comma
id|T4D_AINTEN_B
)brace
suffix:semicolon
DECL|struct|trident_pcm_bank
r_struct
id|trident_pcm_bank
(brace
multiline_comment|/* register addresses to control bank operations */
DECL|member|addresses
r_struct
id|trident_pcm_bank_address
op_star
id|addresses
suffix:semicolon
multiline_comment|/* each bank has 32 channels */
DECL|member|bitmap
id|u32
id|bitmap
suffix:semicolon
multiline_comment|/* channel allocation bitmap */
DECL|member|channels
r_struct
id|trident_channel
id|channels
(braket
l_int|32
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|trident_card
r_struct
id|trident_card
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
multiline_comment|/* We keep trident cards in a linked list */
DECL|member|next
r_struct
id|trident_card
op_star
id|next
suffix:semicolon
multiline_comment|/* single open lock mechanism, only used for recording */
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
multiline_comment|/* The trident has a certain amount of cross channel interaction&n;&t;   so we use a single per card lock */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* PCI device stuff */
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|pci_id
id|u16
id|pci_id
suffix:semicolon
DECL|member|revision
id|u8
id|revision
suffix:semicolon
multiline_comment|/* soundcore stuff */
DECL|member|dev_audio
r_int
id|dev_audio
suffix:semicolon
multiline_comment|/* structures for abstraction of hardware facilities, codecs, */
multiline_comment|/* banks and channels */
DECL|member|ac97_codec
r_struct
id|ac97_codec
op_star
id|ac97_codec
(braket
id|NR_AC97
)braket
suffix:semicolon
DECL|member|banks
r_struct
id|trident_pcm_bank
id|banks
(braket
id|NR_BANKS
)braket
suffix:semicolon
DECL|member|states
r_struct
id|trident_state
op_star
id|states
(braket
id|NR_HW_CH
)braket
suffix:semicolon
multiline_comment|/* hardware resources */
DECL|member|iobase
r_int
r_int
id|iobase
suffix:semicolon
DECL|member|irq
id|u32
id|irq
suffix:semicolon
multiline_comment|/* Function support */
DECL|member|alloc_pcm_channel
r_struct
id|trident_channel
op_star
(paren
op_star
id|alloc_pcm_channel
)paren
(paren
r_struct
id|trident_card
op_star
)paren
suffix:semicolon
DECL|member|alloc_rec_pcm_channel
r_struct
id|trident_channel
op_star
(paren
op_star
id|alloc_rec_pcm_channel
)paren
(paren
r_struct
id|trident_card
op_star
)paren
suffix:semicolon
DECL|member|free_pcm_channel
r_void
(paren
op_star
id|free_pcm_channel
)paren
(paren
r_struct
id|trident_card
op_star
comma
r_int
r_int
id|chan
)paren
suffix:semicolon
DECL|member|address_interrupt
r_void
(paren
op_star
id|address_interrupt
)paren
(paren
r_struct
id|trident_card
op_star
)paren
suffix:semicolon
multiline_comment|/* Added by Matt Wu 01-05-2001 for spdif in */
DECL|member|multi_channel_use_count
r_int
id|multi_channel_use_count
suffix:semicolon
DECL|member|rec_channel_use_count
r_int
id|rec_channel_use_count
suffix:semicolon
DECL|member|mixer_regs
id|u16
id|mixer_regs
(braket
l_int|64
)braket
(braket
id|NR_AC97
)braket
suffix:semicolon
multiline_comment|/* Made card local by Alan */
DECL|member|mixer_regs_ready
r_int
id|mixer_regs_ready
suffix:semicolon
multiline_comment|/* Added for hardware volume control */
DECL|member|hwvolctl
r_int
id|hwvolctl
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Game port support */
DECL|member|gameport
r_struct
id|gameport
id|gameport
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|dmabuf_mode
r_enum
id|dmabuf_mode
(brace
DECL|enumerator|DM_PLAYBACK
id|DM_PLAYBACK
op_assign
l_int|0
comma
DECL|enumerator|DM_RECORD
id|DM_RECORD
)brace
suffix:semicolon
multiline_comment|/* table to map from CHANNELMASK to channel attribute for SiS 7018 */
DECL|variable|mask2attr
r_static
id|u16
id|mask2attr
(braket
)braket
op_assign
(brace
id|PCM_LR
comma
id|PCM_LR
comma
id|SURR_LR
comma
id|CENTER_LFE
comma
id|HSET
comma
id|MIC
comma
id|MODEM_LINE1
comma
id|MODEM_LINE2
comma
id|I2S_LR
comma
id|SPDIF_LR
)brace
suffix:semicolon
multiline_comment|/* table to map from channel attribute to CHANNELMASK for SiS 7018 */
DECL|variable|attr2mask
r_static
r_int
id|attr2mask
(braket
)braket
op_assign
(brace
id|DSP_BIND_MODEM1
comma
id|DSP_BIND_MODEM2
comma
id|DSP_BIND_FRONT
comma
id|DSP_BIND_HANDSET
comma
id|DSP_BIND_I2S
comma
id|DSP_BIND_CENTER_LFE
comma
id|DSP_BIND_SURR
comma
id|DSP_BIND_SPDIF
)brace
suffix:semicolon
multiline_comment|/* Added by Matt Wu 01-05-2001 for spdif in */
r_static
r_int
id|ali_close_multi_channels
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ali_delay
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|interval
)paren
suffix:semicolon
r_static
r_void
id|ali_detect_spdif_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_ac97_write
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
suffix:semicolon
r_static
id|u16
id|ali_ac97_read
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
suffix:semicolon
DECL|variable|devs
r_static
r_struct
id|trident_card
op_star
id|devs
suffix:semicolon
r_static
r_void
id|trident_ac97_set
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
suffix:semicolon
r_static
id|u16
id|trident_ac97_get
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
suffix:semicolon
r_static
r_int
id|trident_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|trident_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|ali_ac97_set
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|secondary
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
suffix:semicolon
r_static
id|u16
id|ali_ac97_get
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|secondary
comma
id|u8
id|reg
)paren
suffix:semicolon
r_static
r_void
id|ali_set_spdif_out_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|rate
)paren
suffix:semicolon
r_static
r_void
id|ali_enable_special_channel
c_func
(paren
r_struct
id|trident_state
op_star
id|stat
)paren
suffix:semicolon
r_static
r_struct
id|trident_channel
op_star
id|ali_alloc_rec_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_struct
id|trident_channel
op_star
id|ali_alloc_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_restore_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_save_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_int
id|trident_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u32
id|unused
)paren
suffix:semicolon
r_static
r_int
id|trident_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ali_free_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
suffix:semicolon
r_static
r_int
id|ali_setup_multi_channels
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|chan_nums
)paren
suffix:semicolon
r_static
r_int
r_int
id|ali_get_spdif_in_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_setup_spdif_in
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_disable_spdif_in
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|ali_disable_special_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|ch
)paren
suffix:semicolon
r_static
r_void
id|ali_setup_spdif_out
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|flag
)paren
suffix:semicolon
r_static
r_int
id|ali_write_5_1
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|cnt_for_multi_channel
comma
r_int
r_int
op_star
id|copy_count
comma
r_int
r_int
op_star
id|state_cnt
)paren
suffix:semicolon
r_static
r_int
id|ali_allocate_other_states_resources
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|chan_nums
)paren
suffix:semicolon
r_static
r_void
id|ali_free_other_states_resources
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
suffix:semicolon
multiline_comment|/* save registers for ALi Power Management */
DECL|struct|ali_saved_registers
r_static
r_struct
id|ali_saved_registers
(brace
DECL|member|global_regs
r_int
r_int
id|global_regs
(braket
id|ALI_GLOBAL_REGS
)braket
suffix:semicolon
DECL|member|channel_regs
r_int
r_int
id|channel_regs
(braket
id|ALI_CHANNELS
)braket
(braket
id|ALI_CHANNEL_REGS
)braket
suffix:semicolon
DECL|member|mixer_regs
r_int
id|mixer_regs
(braket
id|ALI_MIXER_REGS
)braket
suffix:semicolon
DECL|variable|ali_registers
)brace
id|ali_registers
suffix:semicolon
DECL|macro|seek_offset
mdefine_line|#define seek_offset(dma_ptr, buffer, cnt, offset, copy_count)&t;do { &bslash;&n;        (dma_ptr) += (offset);&t;  &bslash;&n;&t;(buffer) += (offset);&t;  &bslash;&n;        (cnt) -= (offset);&t;  &bslash;&n;&t;(copy_count) += (offset); &bslash;&n;} while (0)
DECL|function|lock_set_fmt
r_static
r_inline
r_int
id|lock_set_fmt
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|state-&gt;fmt_flag
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unlock_set_fmt
r_static
r_inline
r_void
id|unlock_set_fmt
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|state-&gt;fmt_flag
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_enable_loop_interrupts
id|trident_enable_loop_interrupts
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u32
id|global_control
suffix:semicolon
id|global_control
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|global_control
op_or_assign
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
op_or
id|BANK_B_EN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
r_case
id|PCI_DEVICE_ID_INTERG_5050
suffix:colon
id|global_control
op_or_assign
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
id|outl
c_func
(paren
id|global_control
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: Enable Loop Interrupts, globctl = 0x%08X&bslash;n&quot;
comma
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_disable_loop_interrupts
id|trident_disable_loop_interrupts
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u32
id|global_control
suffix:semicolon
id|global_control
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
id|global_control
op_and_assign
op_complement
(paren
id|ENDLP_IE
op_or
id|MIDLP_IE
)paren
suffix:semicolon
id|outl
c_func
(paren
id|global_control
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: Disabled Loop Interrupts, globctl = 0x%08X&bslash;n&quot;
comma
id|global_control
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|trident_enable_voice_irq
id|trident_enable_voice_irq
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint_en
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_or_assign
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: enabled IRQ on channel %d, %s = 0x%08x(addr:%X)&bslash;n&quot;
comma
id|channel
comma
id|addr
op_eq
id|T4D_AINTEN_B
ques
c_cond
l_string|&quot;AINTEN_B&quot;
suffix:colon
l_string|&quot;AINTEN_A&quot;
comma
id|reg
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
)brace
r_static
r_void
DECL|function|trident_disable_voice_irq
id|trident_disable_voice_irq
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint_en
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Ack the channel in case the interrupt was set before we disable it. */
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|bank-&gt;addresses-&gt;aint
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: disabled IRQ on channel %d, %s = 0x%08x(addr:%X)&bslash;n&quot;
comma
id|channel
comma
id|addr
op_eq
id|T4D_AINTEN_B
ques
c_cond
l_string|&quot;AINTEN_B&quot;
suffix:colon
l_string|&quot;AINTEN_A&quot;
comma
id|reg
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
)brace
r_static
r_void
DECL|function|trident_start_voice
id|trident_start_voice
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|addr
op_assign
id|bank-&gt;addresses-&gt;start
suffix:semicolon
macro_line|#ifdef DEBUG
id|u32
id|reg
suffix:semicolon
macro_line|#endif /* DEBUG */
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: start voice on channel %d, %s = 0x%08x(addr:%X)&bslash;n&quot;
comma
id|channel
comma
id|addr
op_eq
id|T4D_START_B
ques
c_cond
l_string|&quot;START_B&quot;
suffix:colon
l_string|&quot;START_A&quot;
comma
id|reg
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
)brace
r_static
r_void
DECL|function|trident_stop_voice
id|trident_stop_voice
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|addr
op_assign
id|bank-&gt;addresses-&gt;stop
suffix:semicolon
macro_line|#ifdef DEBUG
id|u32
id|reg
suffix:semicolon
macro_line|#endif /* DEBUG */
id|outl
c_func
(paren
id|mask
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: stop voice on channel %d, %s = 0x%08x(addr:%X)&bslash;n&quot;
comma
id|channel
comma
id|addr
op_eq
id|T4D_STOP_B
ques
c_cond
l_string|&quot;STOP_B&quot;
suffix:colon
l_string|&quot;STOP_A&quot;
comma
id|reg
comma
id|addr
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
)brace
r_static
id|u32
DECL|function|trident_get_interrupt_mask
id|trident_get_interrupt_mask
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
)braket
suffix:semicolon
id|u32
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint
suffix:semicolon
r_return
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_check_channel_interrupt
id|trident_check_channel_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|u32
id|reg
op_assign
id|trident_get_interrupt_mask
c_func
(paren
id|card
comma
id|channel
op_rshift
l_int|5
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|reg
op_amp
id|mask
)paren
id|pr_debug
c_func
(paren
l_string|&quot;trident: channel %d has interrupt, %s = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
op_eq
id|T4D_AINT_B
ques
c_cond
l_string|&quot;AINT_B&quot;
suffix:colon
l_string|&quot;AINT_A&quot;
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_return
(paren
id|reg
op_amp
id|mask
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|trident_ack_channel_interrupt
id|trident_ack_channel_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|1
op_lshift
(paren
id|channel
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|channel
op_rshift
l_int|5
)braket
suffix:semicolon
id|u32
id|reg
comma
id|addr
op_assign
id|bank-&gt;addresses-&gt;aint
suffix:semicolon
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
id|reg
op_and_assign
id|mask
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINT_B
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: Ack channel %d interrupt, AINT_B = 0x%08x&bslash;n&quot;
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
)brace
r_static
r_struct
id|trident_channel
op_star
DECL|function|trident_alloc_pcm_channel
id|trident_alloc_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_B
)braket
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|31
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
op_plus
l_int|32
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
)brace
multiline_comment|/* no more free channels available */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: no more channels available on Bank B.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|trident_free_pcm_channel
id|trident_free_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
id|bank
suffix:semicolon
r_int
r_char
id|b
suffix:semicolon
r_if
c_cond
(paren
id|channel
template_param
l_int|63
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
op_logical_or
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
)paren
(brace
id|b
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_REC_CH
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b
op_amp
op_complement
l_int|0x80
)paren
op_eq
id|channel
)paren
id|outb
c_func
(paren
l_int|0x0
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_REC_CH
)paren
)paren
suffix:semicolon
)brace
id|bank
op_assign
id|channel
op_rshift
l_int|5
suffix:semicolon
id|channel
op_assign
id|channel
op_amp
l_int|0x1f
suffix:semicolon
id|card-&gt;banks
(braket
id|bank
)braket
dot
id|bitmap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|channel
)paren
)paren
suffix:semicolon
)brace
r_static
r_struct
id|trident_channel
op_star
DECL|function|cyber_alloc_pcm_channel
id|cyber_alloc_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_int
id|idx
suffix:semicolon
multiline_comment|/* The cyberpro 5050 has only 32 voices and one bank */
multiline_comment|/* .. at least they are not documented (if you want to call that &n;&t; * crap documentation), perhaps broken ? */
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_A
)braket
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|31
suffix:semicolon
id|idx
op_ge
l_int|0
suffix:semicolon
id|idx
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
)brace
multiline_comment|/* no more free channels available */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cyberpro5050: no more channels available on Bank A.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|cyber_free_pcm_channel
id|cyber_free_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_if
c_cond
(paren
id|channel
OG
l_int|31
)paren
r_return
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_A
)braket
dot
id|bitmap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|channel
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|cyber_outidx
id|cyber_outidx
c_func
(paren
r_int
id|port
comma
r_int
id|idx
comma
r_int
id|data
)paren
(brace
id|outb
c_func
(paren
id|idx
comma
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|data
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|cyber_inidx
id|cyber_inidx
c_func
(paren
r_int
id|port
comma
r_int
id|idx
)paren
(brace
id|outb
c_func
(paren
id|idx
comma
id|port
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|cyber_init_ritual
id|cyber_init_ritual
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
multiline_comment|/* some black magic, taken from SDK samples */
multiline_comment|/* remove this and nothing will work */
r_int
id|portDat
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; *      Keep interrupts off for the configure - we don&squot;t want to&n;&t; *      clash with another cyberpro config event&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|portDat
op_assign
id|cyber_inidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
id|CYBER_IDX_AUDIO_ENABLE
)paren
suffix:semicolon
multiline_comment|/* enable, if it was disabled */
r_if
c_cond
(paren
(paren
id|portDat
op_amp
id|CYBER_BMSK_AUENZ
)paren
op_ne
id|CYBER_BMSK_AUENZ_ENABLE
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;cyberpro5050: enabling audio controller&bslash;n&quot;
)paren
suffix:semicolon
id|cyber_outidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
id|CYBER_IDX_AUDIO_ENABLE
comma
id|portDat
op_or
id|CYBER_BMSK_AUENZ_ENABLE
)paren
suffix:semicolon
multiline_comment|/* check again if hardware is enabled now */
id|portDat
op_assign
id|cyber_inidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
id|CYBER_IDX_AUDIO_ENABLE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|portDat
op_amp
id|CYBER_BMSK_AUENZ
)paren
op_ne
id|CYBER_BMSK_AUENZ_ENABLE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cyberpro5050: initAudioAccess: no success&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|cyber_outidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
id|CYBER_IDX_IRQ_ENABLE
comma
id|CYBER_BMSK_AUDIO_INT_ENABLE
)paren
suffix:semicolon
id|cyber_outidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
l_int|0xbf
comma
l_int|0x01
)paren
suffix:semicolon
id|cyber_outidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
l_int|0xba
comma
l_int|0x20
)paren
suffix:semicolon
id|cyber_outidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
l_int|0xbb
comma
l_int|0x08
)paren
suffix:semicolon
id|cyber_outidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
l_int|0xbf
comma
l_int|0x02
)paren
suffix:semicolon
id|cyber_outidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
l_int|0xb3
comma
l_int|0x06
)paren
suffix:semicolon
id|cyber_outidx
c_func
(paren
id|CYBER_PORT_AUDIO
comma
l_int|0xbf
comma
l_int|0x00
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*  called with spin lock held */
r_static
r_int
DECL|function|trident_load_channel_registers
id|trident_load_channel_registers
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
id|u32
op_star
id|data
comma
r_int
r_int
id|channel
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|channel
OG
l_int|63
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* select hardware channel to write */
id|outb
c_func
(paren
id|channel
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
multiline_comment|/* Output the channel registers, but don&squot;t write register&n;&t;   three to an ALI chip. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CHANNEL_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|3
op_logical_and
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
r_continue
suffix:semicolon
id|outl
c_func
(paren
id|data
(braket
id|i
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|CHANNEL_START
op_plus
l_int|4
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
op_logical_or
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_INTERG_5050
)paren
(brace
id|outl
c_func
(paren
id|ALI_EMOD_Still
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_EBUF1
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|ALI_EMOD_Still
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_EBUF2
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* called with spin lock held */
r_static
r_int
DECL|function|trident_write_voice_regs
id|trident_write_voice_regs
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_int
r_int
id|data
(braket
id|CHANNEL_REGS
op_plus
l_int|1
)braket
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
suffix:semicolon
id|channel
op_assign
id|state-&gt;dmabuf.channel
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|channel-&gt;lba
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|channel-&gt;control
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current Sample Offset */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|channel-&gt;eso
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;delta
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
r_case
id|PCI_DEVICE_ID_INTERG_5050
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current Sample Offset */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|channel-&gt;eso
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;delta
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
(paren
id|channel-&gt;attribute
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current Sample Offset */
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|channel-&gt;eso
op_lshift
l_int|16
)paren
op_or
(paren
id|channel-&gt;delta
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
(paren
id|channel-&gt;delta
op_lshift
l_int|24
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
(paren
(paren
id|channel-&gt;delta
op_lshift
l_int|16
)paren
op_amp
l_int|0xff000000
)paren
op_or
(paren
id|channel-&gt;eso
op_amp
l_int|0x00ffffff
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|channel-&gt;fm_vol
op_amp
l_int|0xffff
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|trident_load_channel_registers
c_func
(paren
id|state-&gt;card
comma
id|data
comma
id|channel-&gt;num
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|compute_rate_play
id|compute_rate_play
c_func
(paren
id|u32
id|rate
)paren
(brace
r_int
id|delta
suffix:semicolon
multiline_comment|/* We special case 44100 and 8000 since rounding with the equation&n;&t;   does not give us an accurate enough value. For 11025 and 22050&n;&t;   the equation gives us the best answer. All other frequencies will&n;&t;   also use the equation. JDW */
r_if
c_cond
(paren
id|rate
op_eq
l_int|44100
)paren
id|delta
op_assign
l_int|0xeb3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|8000
)paren
id|delta
op_assign
l_int|0x2ab
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|48000
)paren
id|delta
op_assign
l_int|0x1000
suffix:semicolon
r_else
id|delta
op_assign
(paren
(paren
(paren
id|rate
op_lshift
l_int|12
)paren
op_plus
id|rate
)paren
op_div
l_int|48000
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
r_return
id|delta
suffix:semicolon
)brace
r_static
r_int
DECL|function|compute_rate_rec
id|compute_rate_rec
c_func
(paren
id|u32
id|rate
)paren
(brace
r_int
id|delta
suffix:semicolon
r_if
c_cond
(paren
id|rate
op_eq
l_int|44100
)paren
id|delta
op_assign
l_int|0x116a
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|8000
)paren
id|delta
op_assign
l_int|0x6000
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rate
op_eq
l_int|48000
)paren
id|delta
op_assign
l_int|0x1000
suffix:semicolon
r_else
id|delta
op_assign
(paren
(paren
l_int|48000
op_lshift
l_int|12
)paren
op_div
id|rate
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
r_return
id|delta
suffix:semicolon
)brace
multiline_comment|/* set playback sample rate */
r_static
r_int
r_int
DECL|function|trident_set_dac_rate
id|trident_set_dac_rate
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
r_int
id|rate
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
id|rate
suffix:semicolon
id|dmabuf-&gt;channel-&gt;delta
op_assign
id|compute_rate_play
c_func
(paren
id|rate
)paren
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|state
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: called trident_set_dac_rate : rate = %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/* set recording sample rate */
r_static
r_int
r_int
DECL|function|trident_set_adc_rate
id|trident_set_adc_rate
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
r_int
id|rate
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|4000
)paren
id|rate
op_assign
l_int|4000
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
id|rate
suffix:semicolon
id|dmabuf-&gt;channel-&gt;delta
op_assign
id|compute_rate_rec
c_func
(paren
id|rate
)paren
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|state
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: called trident_set_adc_rate : rate = %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/* prepare channel attributes for playback */
r_static
r_void
DECL|function|trident_play_setup
id|trident_play_setup
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
op_assign
id|dmabuf-&gt;channel
suffix:semicolon
id|channel-&gt;lba
op_assign
id|dmabuf-&gt;dma_handle
suffix:semicolon
id|channel-&gt;delta
op_assign
id|compute_rate_play
c_func
(paren
id|dmabuf-&gt;rate
)paren
suffix:semicolon
id|channel-&gt;eso
op_assign
id|dmabuf-&gt;dmasize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|channel-&gt;eso
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_ne
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
id|channel-&gt;attribute
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
r_if
c_cond
(paren
(paren
id|channel-&gt;num
op_eq
id|ALI_SPDIF_IN_CHANNEL
)paren
op_logical_or
(paren
id|channel-&gt;num
op_eq
id|ALI_PCM_IN_CHANNEL
)paren
)paren
id|ali_disable_special_channel
c_func
(paren
id|state-&gt;card
comma
id|channel-&gt;num
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
op_amp
id|ALI_SPDIF_OUT_CH_ENABLE
)paren
op_logical_and
(paren
id|channel-&gt;num
op_eq
id|ALI_SPDIF_OUT_CHANNEL
)paren
)paren
(brace
id|ali_set_spdif_out_rate
c_func
(paren
id|state-&gt;card
comma
id|state-&gt;dmabuf.rate
)paren
suffix:semicolon
id|state-&gt;dmabuf.channel-&gt;delta
op_assign
l_int|0x1000
suffix:semicolon
)brace
)brace
)brace
id|channel-&gt;fm_vol
op_assign
l_int|0x0
suffix:semicolon
id|channel-&gt;control
op_assign
id|CHANNEL_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
(brace
multiline_comment|/* 16-bits */
id|channel-&gt;control
op_or_assign
id|CHANNEL_16BITS
suffix:semicolon
multiline_comment|/* signed */
id|channel-&gt;control
op_or_assign
id|CHANNEL_SIGNED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
multiline_comment|/* stereo */
id|channel-&gt;control
op_or_assign
id|CHANNEL_STEREO
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: trident_play_setup, LBA = 0x%08x, Delta = 0x%08x, &quot;
l_string|&quot;ESO = 0x%08x, Control = 0x%08x&bslash;n&quot;
comma
id|channel-&gt;lba
comma
id|channel-&gt;delta
comma
id|channel-&gt;eso
comma
id|channel-&gt;control
)paren
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/* prepare channel attributes for recording */
r_static
r_void
DECL|function|trident_rec_setup
id|trident_rec_setup
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
id|u16
id|w
suffix:semicolon
id|u8
id|bval
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
op_assign
id|dmabuf-&gt;channel
suffix:semicolon
r_int
r_int
id|rate
suffix:semicolon
multiline_comment|/* Enable AC-97 ADC (capture) */
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
id|ali_enable_special_channel
c_func
(paren
id|state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
multiline_comment|/* for 7018, the ac97 is always in playback/record (duplex) mode */
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|w
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|w
op_or
l_int|0x48
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
multiline_comment|/* enable and set record channel */
id|outb
c_func
(paren
l_int|0x80
op_or
id|channel-&gt;num
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_REC_CH
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|w
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|w
op_or
l_int|0x1000
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
multiline_comment|/* enable and set record channel */
id|outb
c_func
(paren
l_int|0x80
op_or
id|channel-&gt;num
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_REC_CH
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_INTERG_5050
suffix:colon
multiline_comment|/* don&squot;t know yet, using special channel 22 in GC1(0xd4)? */
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|channel-&gt;lba
op_assign
id|dmabuf-&gt;dma_handle
suffix:semicolon
id|channel-&gt;delta
op_assign
id|compute_rate_rec
c_func
(paren
id|dmabuf-&gt;rate
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
op_logical_and
(paren
id|channel-&gt;num
op_eq
id|ALI_SPDIF_IN_CHANNEL
)paren
)paren
(brace
id|rate
op_assign
id|ali_get_spdif_in_rate
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rate
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;trident: ALi 5451 &quot;
l_string|&quot;S/PDIF input setup error!&bslash;n&quot;
)paren
suffix:semicolon
id|rate
op_assign
l_int|48000
suffix:semicolon
)brace
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bval
op_amp
l_int|0x10
)paren
(brace
id|outb
c_func
(paren
id|bval
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;trident: cleared ALi &quot;
l_string|&quot;5451 S/PDIF parity error flag.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rate
op_ne
l_int|48000
)paren
id|channel-&gt;delta
op_assign
(paren
(paren
id|rate
op_lshift
l_int|12
)paren
op_div
id|dmabuf-&gt;rate
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
)brace
id|channel-&gt;eso
op_assign
id|dmabuf-&gt;dmasize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|channel-&gt;eso
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_ne
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
id|channel-&gt;attribute
op_assign
l_int|0
suffix:semicolon
)brace
id|channel-&gt;fm_vol
op_assign
l_int|0x0
suffix:semicolon
id|channel-&gt;control
op_assign
id|CHANNEL_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
(brace
multiline_comment|/* 16-bits */
id|channel-&gt;control
op_or_assign
id|CHANNEL_16BITS
suffix:semicolon
multiline_comment|/* signed */
id|channel-&gt;control
op_or_assign
id|CHANNEL_SIGNED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
multiline_comment|/* stereo */
id|channel-&gt;control
op_or_assign
id|CHANNEL_STEREO
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: trident_rec_setup, LBA = 0x%08x, Delat = 0x%08x, &quot;
l_string|&quot;ESO = 0x%08x, Control = 0x%08x&bslash;n&quot;
comma
id|channel-&gt;lba
comma
id|channel-&gt;delta
comma
id|channel-&gt;eso
comma
id|channel-&gt;control
)paren
suffix:semicolon
id|trident_write_voice_regs
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/* get current playback/recording dma buffer pointer (byte offset from LBA),&n;   called with spinlock held! */
r_static
r_inline
r_int
DECL|function|trident_get_dma_addr
id|trident_get_dma_addr
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|u32
id|cso
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;enable
)paren
r_return
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|dmabuf-&gt;channel-&gt;num
comma
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
r_case
id|PCI_DEVICE_ID_INTERG_5050
suffix:colon
multiline_comment|/* 16 bits ESO, CSO for 7018 and DX */
id|cso
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|CH_DX_CSO_ALPHA_FMS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
multiline_comment|/* 24 bits ESO, CSO for NX */
id|cso
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|state-&gt;card
comma
id|CH_NX_DELTA_CSO
)paren
)paren
op_amp
l_int|0x00ffffff
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;trident: trident_get_dma_addr: chip reported channel: %d, &quot;
l_string|&quot;cso = 0x%04x&bslash;n&quot;
comma
id|dmabuf-&gt;channel-&gt;num
comma
id|cso
)paren
suffix:semicolon
multiline_comment|/* ESO and CSO are in units of Samples, convert to byte offset */
id|cso
op_lshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
r_return
(paren
id|cso
op_mod
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop recording (lock held) */
r_static
r_inline
r_void
DECL|function|__stop_adc
id|__stop_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
id|dmabuf-&gt;enable
op_and_assign
op_complement
id|ADC_RUNNING
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|stop_adc
id|stop_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|start_adc
id|start_adc
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabuf-&gt;mapped
op_logical_or
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
)paren
op_logical_and
id|dmabuf-&gt;ready
)paren
(brace
id|dmabuf-&gt;enable
op_or_assign
id|ADC_RUNNING
suffix:semicolon
id|trident_enable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* stop playback (lock held) */
r_static
r_inline
r_void
DECL|function|__stop_dac
id|__stop_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
id|dmabuf-&gt;enable
op_and_assign
op_complement
id|DAC_RUNNING
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|trident_stop_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
)brace
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|stop_dac
id|stop_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|start_dac
id|start_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|chan_num
op_assign
id|dmabuf-&gt;channel-&gt;num
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabuf-&gt;mapped
op_logical_or
id|dmabuf-&gt;count
OG
l_int|0
)paren
op_logical_and
id|dmabuf-&gt;ready
)paren
(brace
id|dmabuf-&gt;enable
op_or_assign
id|DAC_RUNNING
suffix:semicolon
id|trident_enable_voice_irq
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|chan_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|trident_start_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|trident_start_voice
c_func
(paren
id|card
comma
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf.channel-&gt;num
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|macro|DMABUF_DEFAULTORDER
mdefine_line|#define DMABUF_DEFAULTORDER (15-PAGE_SHIFT)
DECL|macro|DMABUF_MINORDER
mdefine_line|#define DMABUF_MINORDER 1
multiline_comment|/* alloc a DMA buffer of with a buffer of this order */
r_static
r_int
DECL|function|alloc_dmabuf
id|alloc_dmabuf
c_func
(paren
r_struct
id|dmabuf
op_star
id|dmabuf
comma
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_int
id|order
)paren
(brace
r_void
op_star
id|rawbuf
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|page
op_star
id|page
comma
op_star
id|pend
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rawbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pci_dev
comma
id|PAGE_SIZE
op_lshift
id|order
comma
op_amp
id|dmabuf-&gt;dma_handle
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: allocated %ld (order = %d) bytes at %p&bslash;n&quot;
comma
id|PAGE_SIZE
op_lshift
id|order
comma
id|order
comma
id|rawbuf
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
id|dmabuf-&gt;mapped
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;rawbuf
op_assign
id|rawbuf
suffix:semicolon
id|dmabuf-&gt;buforder
op_assign
id|order
suffix:semicolon
multiline_comment|/* now mark the pages as reserved; otherwise */
multiline_comment|/* remap_pfn_range doesn&squot;t do what we want */
id|pend
op_assign
id|virt_to_page
c_func
(paren
id|rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|page
op_assign
id|virt_to_page
c_func
(paren
id|rawbuf
)paren
suffix:semicolon
id|page
op_le
id|pend
suffix:semicolon
id|page
op_increment
)paren
id|SetPageReserved
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* allocate the main DMA buffer, playback and recording buffer should be */
multiline_comment|/* allocated separately */
r_static
r_int
DECL|function|alloc_main_dmabuf
id|alloc_main_dmabuf
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|order
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* alloc as big a chunk as we can, FIXME: is this necessary ?? */
r_for
c_loop
(paren
id|order
op_assign
id|DMABUF_DEFAULTORDER
suffix:semicolon
id|order
op_ge
id|DMABUF_MINORDER
suffix:semicolon
id|order
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ret
op_assign
id|alloc_dmabuf
c_func
(paren
id|dmabuf
comma
id|state-&gt;card-&gt;pci_dev
comma
id|order
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* else try again */
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* deallocate a DMA buffer */
r_static
r_void
DECL|function|dealloc_dmabuf
id|dealloc_dmabuf
c_func
(paren
r_struct
id|dmabuf
op_star
id|dmabuf
comma
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|page
op_star
id|page
comma
op_star
id|pend
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;rawbuf
)paren
(brace
multiline_comment|/* undo marking the pages as reserved */
id|pend
op_assign
id|virt_to_page
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|page
op_assign
id|virt_to_page
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
id|page
op_le
id|pend
suffix:semicolon
id|page
op_increment
)paren
id|ClearPageReserved
c_func
(paren
id|page
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pci_dev
comma
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
comma
id|dmabuf-&gt;rawbuf
comma
id|dmabuf-&gt;dma_handle
)paren
suffix:semicolon
id|dmabuf-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dmabuf-&gt;mapped
op_assign
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|prog_dmabuf
id|prog_dmabuf
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_enum
id|dmabuf_mode
id|rec
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|bytepersec
suffix:semicolon
r_struct
id|trident_state
op_star
id|s
op_assign
id|state
suffix:semicolon
r_int
id|bufsize
comma
id|dma_nums
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
comma
id|i
comma
id|order
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lock_set_fmt
c_func
(paren
id|state
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
id|dma_nums
op_assign
l_int|5
suffix:semicolon
r_else
id|dma_nums
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma_nums
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
(brace
id|s
op_assign
id|state-&gt;other_states
(braket
id|i
op_minus
l_int|1
)braket
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|s-&gt;dmabuf
suffix:semicolon
id|dmabuf-&gt;fmt
op_assign
id|state-&gt;dmabuf.fmt
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
id|state-&gt;dmabuf.rate
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;total_bytes
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;error
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* allocate DMA buffer if not allocated yet */
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;rawbuf
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|alloc_main_dmabuf
c_func
(paren
id|state
)paren
)paren
)paren
(brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_else
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|order
op_assign
id|state-&gt;dmabuf.buforder
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|order
op_ge
id|DMABUF_MINORDER
)paren
(brace
id|ret
op_assign
id|alloc_dmabuf
c_func
(paren
id|dmabuf
comma
id|state-&gt;card-&gt;pci_dev
comma
id|order
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* release the main DMA buffer */
id|dealloc_dmabuf
c_func
(paren
op_amp
id|state-&gt;dmabuf
comma
id|state-&gt;card-&gt;pci_dev
)paren
suffix:semicolon
multiline_comment|/* release the auxiliary DMA buffers */
r_for
c_loop
(paren
id|i
op_sub_assign
l_int|2
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|dealloc_dmabuf
c_func
(paren
op_amp
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf
comma
id|state-&gt;card-&gt;pci_dev
)paren
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* FIXME: figure out all this OSS fragment stuff */
id|bytepersec
op_assign
id|dmabuf-&gt;rate
op_lshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|bufsize
op_assign
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossfragshift
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1000
op_lshift
id|dmabuf-&gt;ossfragshift
)paren
OL
id|bytepersec
)paren
id|dmabuf-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|1000
)paren
suffix:semicolon
r_else
id|dmabuf-&gt;fragshift
op_assign
id|dmabuf-&gt;ossfragshift
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* lets hand out reasonable big ass buffers by default */
id|dmabuf-&gt;fragshift
op_assign
(paren
id|dmabuf-&gt;buforder
op_plus
id|PAGE_SHIFT
op_minus
l_int|2
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;numfrag
op_assign
id|bufsize
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
r_while
c_loop
(paren
id|dmabuf-&gt;numfrag
template_param
l_int|3
)paren
(brace
id|dmabuf-&gt;fragshift
op_decrement
suffix:semicolon
id|dmabuf-&gt;numfrag
op_assign
id|bufsize
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
)brace
id|dmabuf-&gt;fragsize
op_assign
l_int|1
op_lshift
id|dmabuf-&gt;fragshift
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossmaxfrags
op_ge
l_int|4
op_logical_and
id|dmabuf-&gt;ossmaxfrags
OL
id|dmabuf-&gt;numfrag
)paren
id|dmabuf-&gt;numfrag
op_assign
id|dmabuf-&gt;ossmaxfrags
suffix:semicolon
id|dmabuf-&gt;fragsamples
op_assign
id|dmabuf-&gt;fragsize
op_rshift
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|dmabuf-&gt;dmasize
op_assign
id|dmabuf-&gt;numfrag
op_lshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|memset
c_func
(paren
id|dmabuf-&gt;rawbuf
comma
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
comma
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec
op_eq
id|DM_RECORD
)paren
id|trident_rec_setup
c_func
(paren
id|s
)paren
suffix:semicolon
r_else
multiline_comment|/* DM_PLAYBACK */
id|trident_play_setup
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* set the ready flag for the dma buffer */
id|dmabuf-&gt;ready
op_assign
l_int|1
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: prog_dmabuf(%d), sample rate = %d, &quot;
l_string|&quot;format = %d, numfrag = %d, fragsize = %d &quot;
l_string|&quot;dmasize = %d&bslash;n&quot;
comma
id|dmabuf-&gt;channel-&gt;num
comma
id|dmabuf-&gt;rate
comma
id|dmabuf-&gt;fmt
comma
id|dmabuf-&gt;numfrag
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|prog_dmabuf_record
r_static
r_inline
r_int
id|prog_dmabuf_record
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_return
id|prog_dmabuf
c_func
(paren
id|state
comma
id|DM_RECORD
)paren
suffix:semicolon
)brace
DECL|function|prog_dmabuf_playback
r_static
r_inline
r_int
id|prog_dmabuf_playback
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_return
id|prog_dmabuf
c_func
(paren
id|state
comma
id|DM_PLAYBACK
)paren
suffix:semicolon
)brace
multiline_comment|/* we are doing quantum mechanics here, the buffer can only be empty, half or full filled i.e.&n;   |------------|------------|   or   |xxxxxxxxxxxx|------------|   or   |xxxxxxxxxxxx|xxxxxxxxxxxx|&n;   but we almost always get this&n;   |xxxxxx------|------------|   or   |xxxxxxxxxxxx|xxxxx-------|&n;   so we have to clear the tail space to &quot;silence&quot;&n;   |xxxxxx000000|------------|   or   |xxxxxxxxxxxx|xxxxxx000000|&n;*/
r_static
r_void
DECL|function|trident_clear_tail
id|trident_clear_tail
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
r_char
id|silence
op_assign
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|swptr
op_eq
l_int|0
op_logical_or
id|swptr
op_eq
id|dmabuf-&gt;dmasize
op_div
l_int|2
op_logical_or
id|swptr
op_eq
id|dmabuf-&gt;dmasize
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|swptr
OL
id|dmabuf-&gt;dmasize
op_div
l_int|2
)paren
id|len
op_assign
id|dmabuf-&gt;dmasize
op_div
l_int|2
op_minus
id|swptr
suffix:semicolon
r_else
id|len
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
id|memset
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_ne
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_add_assign
id|len
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|len
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* restart the dma machine in case it is halted */
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|drain_dac
id|drain_dac
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|nonblock
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|tmo
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
r_int
id|diff
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
op_logical_or
op_logical_neg
id|dmabuf-&gt;ready
)paren
r_return
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* It seems that we have to set the current state to TASK_INTERRUPTIBLE&n;&t;&t;   every time to make the process really go to sleep */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* No matter how much data is left in the buffer, we have to wait until&n;&t;&t;   CSO == ESO/2 or CSO == ESO when address engine interrupts */
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
op_logical_or
id|state-&gt;card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_INTERG_5050
)paren
(brace
id|diff
op_assign
id|dmabuf-&gt;swptr
op_minus
id|trident_get_dma_addr
c_func
(paren
id|state
)paren
op_plus
id|dmabuf-&gt;dmasize
suffix:semicolon
id|diff
op_assign
id|diff
op_mod
(paren
id|dmabuf-&gt;dmasize
)paren
suffix:semicolon
id|tmo
op_assign
(paren
id|diff
op_star
id|HZ
)paren
op_div
id|dmabuf-&gt;rate
suffix:semicolon
)brace
r_else
(brace
id|tmo
op_assign
(paren
id|dmabuf-&gt;dmasize
op_star
id|HZ
)paren
op_div
id|dmabuf-&gt;rate
suffix:semicolon
)brace
id|tmo
op_rshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|tmo
ques
c_cond
id|tmo
suffix:colon
l_int|1
)paren
op_logical_and
id|tmo
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* update buffer manangement pointers, especially, */
multiline_comment|/* dmabuf-&gt;count and dmabuf-&gt;hwptr */
r_static
r_void
DECL|function|trident_update_ptr
id|trident_update_ptr
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|hwptr
comma
id|swptr
suffix:semicolon
r_int
id|clear_cnt
op_assign
l_int|0
suffix:semicolon
r_int
id|diff
suffix:semicolon
r_int
r_char
id|silence
suffix:semicolon
r_int
id|half_dmasize
suffix:semicolon
multiline_comment|/* update hardware pointer */
id|hwptr
op_assign
id|trident_get_dma_addr
c_func
(paren
id|state
)paren
suffix:semicolon
id|diff
op_assign
(paren
id|dmabuf-&gt;dmasize
op_plus
id|hwptr
op_minus
id|dmabuf-&gt;hwptr
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
id|hwptr
suffix:semicolon
id|dmabuf-&gt;total_bytes
op_add_assign
id|diff
suffix:semicolon
multiline_comment|/* error handling and process wake up for ADC */
r_if
c_cond
(paren
id|dmabuf-&gt;enable
op_eq
id|ADC_RUNNING
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
id|dmabuf-&gt;count
op_sub_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|dmabuf-&gt;count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
template_param
id|dmabuf-&gt;dmasize
)paren
(brace
multiline_comment|/* buffer underrun or buffer overrun, */
multiline_comment|/* we have no way to recover it here, just */
multiline_comment|/* stop the machine and let the process */
multiline_comment|/* force hwptr and swptr to sync */
id|__stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;error
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
op_div
l_int|2
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* error handling and process wake up for DAC */
r_if
c_cond
(paren
id|dmabuf-&gt;enable
op_eq
id|DAC_RUNNING
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
id|dmabuf-&gt;count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|dmabuf-&gt;count
op_sub_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
template_param
id|dmabuf-&gt;dmasize
)paren
(brace
multiline_comment|/* buffer underrun or buffer overrun, we have no way to recover&n;&t;&t;&t;&t;   it here, just stop the machine and let the process force hwptr&n;&t;&t;&t;&t;   and swptr to sync */
id|__stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;error
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;endcleared
)paren
(brace
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|silence
op_assign
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;update_flag
op_amp
id|ALI_ADDRESS_INT_UPDATE
)paren
(brace
multiline_comment|/* We must clear end data of 1/2 dmabuf if needed.&n;&t;&t;&t;&t;&t;   According to 1/2 algorithm of Address Engine Interrupt,&n;&t;&t;&t;&t;&t;   check the validation of the data of half dmasize. */
id|half_dmasize
op_assign
id|dmabuf-&gt;dmasize
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|diff
op_assign
id|hwptr
op_minus
id|half_dmasize
)paren
OL
l_int|0
)paren
id|diff
op_assign
id|hwptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dmabuf-&gt;count
op_plus
id|diff
)paren
OL
id|half_dmasize
)paren
(brace
singleline_comment|//there is invalid data in the end of half buffer
r_if
c_cond
(paren
(paren
id|clear_cnt
op_assign
id|half_dmasize
op_minus
id|swptr
)paren
OL
l_int|0
)paren
id|clear_cnt
op_add_assign
id|half_dmasize
suffix:semicolon
singleline_comment|//clear the invalid data
id|memset
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|clear_cnt
op_assign
id|clear_cnt
op_div
l_int|2
suffix:semicolon
id|swptr
op_assign
id|swptr
op_div
l_int|2
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;endcleared
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
(brace
id|clear_cnt
op_assign
id|dmabuf-&gt;fragsize
suffix:semicolon
r_if
c_cond
(paren
(paren
id|swptr
op_plus
id|clear_cnt
)paren
OG
id|dmabuf-&gt;dmasize
)paren
id|clear_cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
id|memset
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|clear_cnt
op_assign
id|clear_cnt
op_div
l_int|2
suffix:semicolon
id|swptr
op_assign
id|swptr
op_div
l_int|2
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf.rawbuf
op_plus
id|swptr
comma
id|silence
comma
id|clear_cnt
)paren
suffix:semicolon
)brace
id|dmabuf-&gt;endcleared
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* trident_update_ptr is called by interrupt handler or by process via&n;&t;&t;&t;   ioctl/poll, we only wake up the waiting process when we have more&n;&t;&t;&t;   than 1/2 buffer free (always true for interrupt handler) */
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
op_div
l_int|2
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
)brace
id|dmabuf-&gt;update_flag
op_and_assign
op_complement
id|ALI_ADDRESS_INT_UPDATE
suffix:semicolon
)brace
r_static
r_void
DECL|function|trident_address_interrupt
id|trident_address_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|trident_state
op_star
id|state
suffix:semicolon
r_int
r_int
id|channel
suffix:semicolon
multiline_comment|/* Update the pointers for all channels we are running. */
multiline_comment|/* FIXME: should read interrupt status only once */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|channel
op_assign
l_int|63
op_minus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|trident_check_channel_interrupt
c_func
(paren
id|card
comma
id|channel
)paren
)paren
(brace
id|trident_ack_channel_interrupt
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;trident: spurious channel &quot;
l_string|&quot;irq %d.&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_static
r_void
DECL|function|ali_hwvol_control
id|ali_hwvol_control
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|opt
)paren
(brace
id|u16
id|dwTemp
comma
id|volume
(braket
l_int|2
)braket
comma
id|mute
comma
id|diff
comma
op_star
id|pVol
(braket
l_int|2
)braket
suffix:semicolon
id|dwTemp
op_assign
id|ali_ac97_read
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
l_int|0x02
)paren
suffix:semicolon
id|mute
op_assign
id|dwTemp
op_amp
l_int|0x8000
suffix:semicolon
id|volume
(braket
l_int|0
)braket
op_assign
id|dwTemp
op_amp
l_int|0x001f
suffix:semicolon
id|volume
(braket
l_int|1
)braket
op_assign
(paren
id|dwTemp
op_amp
l_int|0x1f00
)paren
op_rshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|volume
(braket
l_int|0
)braket
OL
id|volume
(braket
l_int|1
)braket
)paren
(brace
id|pVol
(braket
l_int|0
)braket
op_assign
op_amp
id|volume
(braket
l_int|0
)braket
suffix:semicolon
id|pVol
(braket
l_int|1
)braket
op_assign
op_amp
id|volume
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
id|pVol
(braket
l_int|1
)braket
op_assign
op_amp
id|volume
(braket
l_int|0
)braket
suffix:semicolon
id|pVol
(braket
l_int|0
)braket
op_assign
op_amp
id|volume
(braket
l_int|1
)braket
suffix:semicolon
)brace
id|diff
op_assign
op_star
(paren
id|pVol
(braket
l_int|1
)braket
)paren
op_minus
op_star
(paren
id|pVol
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_eq
l_int|1
)paren
(brace
singleline_comment|// MUTE
id|dwTemp
op_xor_assign
l_int|0x8000
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
l_int|0x02
comma
id|dwTemp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|opt
op_eq
l_int|2
)paren
(brace
singleline_comment|// Down
r_if
c_cond
(paren
id|mute
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|pVol
(braket
l_int|1
)braket
)paren
OL
l_int|0x001f
)paren
(brace
(paren
op_star
id|pVol
(braket
l_int|1
)braket
)paren
op_increment
suffix:semicolon
op_star
(paren
id|pVol
(braket
l_int|0
)braket
)paren
op_assign
op_star
(paren
id|pVol
(braket
l_int|1
)braket
)paren
op_minus
id|diff
suffix:semicolon
)brace
id|dwTemp
op_and_assign
l_int|0xe0e0
suffix:semicolon
id|dwTemp
op_or_assign
(paren
id|volume
(braket
l_int|0
)braket
)paren
op_or
(paren
id|volume
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
l_int|0x02
comma
id|dwTemp
)paren
suffix:semicolon
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
op_member_access_from_pointer
id|mixer_state
(braket
l_int|0
)braket
op_assign
(paren
(paren
l_int|32
op_minus
id|volume
(braket
l_int|0
)braket
)paren
op_star
l_int|25
op_div
l_int|8
)paren
op_or
(paren
(paren
(paren
l_int|32
op_minus
id|volume
(braket
l_int|1
)braket
)paren
op_star
l_int|25
op_div
l_int|8
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|opt
op_eq
l_int|4
)paren
(brace
singleline_comment|// Up
r_if
c_cond
(paren
id|mute
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
id|pVol
(braket
l_int|0
)braket
)paren
OG
l_int|0
)paren
(brace
(paren
op_star
id|pVol
(braket
l_int|0
)braket
)paren
op_decrement
suffix:semicolon
op_star
(paren
id|pVol
(braket
l_int|1
)braket
)paren
op_assign
op_star
(paren
id|pVol
(braket
l_int|0
)braket
)paren
op_plus
id|diff
suffix:semicolon
)brace
id|dwTemp
op_and_assign
l_int|0xe0e0
suffix:semicolon
id|dwTemp
op_or_assign
(paren
id|volume
(braket
l_int|0
)braket
)paren
op_or
(paren
id|volume
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
l_int|0x02
comma
id|dwTemp
)paren
suffix:semicolon
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
op_member_access_from_pointer
id|mixer_state
(braket
l_int|0
)braket
op_assign
(paren
(paren
l_int|32
op_minus
id|volume
(braket
l_int|0
)braket
)paren
op_star
l_int|25
op_div
l_int|8
)paren
op_or
(paren
(paren
(paren
l_int|32
op_minus
id|volume
(braket
l_int|1
)braket
)paren
op_star
l_int|25
op_div
l_int|8
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Nothing needs doing */
)brace
)brace
multiline_comment|/*&n; *&t;Re-enable reporting of vol change after 0.1 seconds&n; */
r_static
r_void
DECL|function|ali_timeout
id|ali_timeout
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|ptr
suffix:semicolon
id|u16
id|temp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Enable GPIO IRQ (MISCINT bit 18h) */
id|temp
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x0004
suffix:semicolon
id|outw
c_func
(paren
id|temp
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
op_plus
l_int|2
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set up the timer to clear the vol change notification&n; */
r_static
r_void
DECL|function|ali_set_timer
id|ali_set_timer
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
multiline_comment|/* Add Timer Routine to Enable GPIO IRQ */
id|del_timer
c_func
(paren
op_amp
id|card-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Never queue twice */
id|card-&gt;timer.function
op_assign
id|ali_timeout
suffix:semicolon
id|card-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|card
suffix:semicolon
id|card-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|10
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|card-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Process a GPIO event&n; */
r_static
r_void
DECL|function|ali_queue_task
id|ali_queue_task
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|opt
)paren
(brace
id|u16
id|temp
suffix:semicolon
multiline_comment|/* Disable GPIO IRQ (MISCINT bit 18h) */
id|temp
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|temp
op_and_assign
(paren
id|u16
)paren
(paren
op_complement
l_int|0x0004
)paren
suffix:semicolon
id|outw
c_func
(paren
id|temp
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
op_plus
l_int|2
)paren
)paren
suffix:semicolon
multiline_comment|/* Adjust the volume */
id|ali_hwvol_control
c_func
(paren
id|card
comma
id|opt
)paren
suffix:semicolon
multiline_comment|/* Set the timer for 1/10th sec */
id|ali_set_timer
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|cyber_address_interrupt
id|cyber_address_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
id|i
comma
id|irq_status
suffix:semicolon
r_struct
id|trident_state
op_star
id|state
suffix:semicolon
r_int
r_int
id|channel
suffix:semicolon
multiline_comment|/* Update the pointers for all channels we are running. */
multiline_comment|/* FIXED: read interrupt status only once */
id|irq_status
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINT_A
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;cyber_address_interrupt: irq_status 0x%X&bslash;n&quot;
comma
id|irq_status
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|channel
op_assign
l_int|31
op_minus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|irq_status
op_amp
(paren
l_int|1
op_lshift
id|channel
)paren
)paren
(brace
multiline_comment|/* clear bit by writing a 1, zeroes are ignored */
id|outl
c_func
(paren
(paren
l_int|1
op_lshift
id|channel
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINT_A
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;cyber_interrupt: channel %d&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cyber5050: spurious &quot;
l_string|&quot;channel irq %d.&bslash;n&quot;
comma
id|channel
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_static
id|irqreturn_t
DECL|function|trident_interrupt
id|trident_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|dev_id
suffix:semicolon
id|u32
id|event
suffix:semicolon
id|u32
id|gpio
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|event
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: trident_interrupt called, MISCINT = 0x%08x&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_amp
id|ADDRESS_IRQ
)paren
(brace
id|card
op_member_access_from_pointer
id|address_interrupt
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
multiline_comment|/* GPIO IRQ (H/W Volume Control) */
id|event
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_amp
(paren
l_int|1
op_lshift
l_int|25
)paren
)paren
(brace
id|gpio
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GPIO
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|card-&gt;timer
)paren
)paren
id|ali_queue_task
c_func
(paren
id|card
comma
id|gpio
op_amp
l_int|0x07
)paren
suffix:semicolon
)brace
id|event
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
id|event
op_or
(paren
id|ST_TARGET_REACHED
op_or
id|MIXER_OVERFLOW
op_or
id|MIXER_UNDERFLOW
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* manually clear interrupt status, bad hardware design, blame T^2 */
id|outl
c_func
(paren
(paren
id|ST_TARGET_REACHED
op_or
id|MIXER_OVERFLOW
op_or
id|MIXER_UNDERFLOW
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* in this loop, dmabuf.count signifies the amount of data that is waiting */
multiline_comment|/* to be copied to the user&squot;s buffer.  it is filled by the dma machine and */
multiline_comment|/* drained by this loop. */
r_static
id|ssize_t
DECL|function|trident_read
id|trident_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: trident_read called, count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|down
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf_record
c_func
(paren
id|state
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OG
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
)paren
(brace
multiline_comment|/* buffer overrun, we are recovering from */
multiline_comment|/* sleep_on_timeout, resync hwptr and swptr, */
multiline_comment|/* make process flush the buffer */
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;dmasize
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
)brace
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
id|cnt
)paren
id|cnt
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
r_int
r_int
id|tmo
suffix:semicolon
multiline_comment|/* buffer is empty, start the dma machine and */
multiline_comment|/* wait for data to be recorded */
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
multiline_comment|/* No matter how much space left in the buffer, */
multiline_comment|/* we have to wait until CSO == ESO/2 or CSO == ESO */
multiline_comment|/* when address engine interrupts */
id|tmo
op_assign
(paren
id|dmabuf-&gt;dmasize
op_star
id|HZ
)paren
op_div
(paren
id|dmabuf-&gt;rate
op_star
l_int|2
)paren
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
multiline_comment|/* There are two situations when sleep_on_timeout returns, one is when&n;&t;&t;&t;   the interrupt is serviced correctly and the process is waked up by&n;&t;&t;&t;   ISR ON TIME. Another is when timeout is expired, which means that&n;&t;&t;&t;   either interrupt is NOT serviced correctly (pending interrupt) or it&n;&t;&t;&t;   is TOO LATE for the process to be scheduled to run (scheduler latency)&n;&t;&t;&t;   which results in a (potential) buffer overrun. And worse, there is&n;&t;&t;&t;   NOTHING we can do to prevent it. */
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
id|tmo
)paren
)paren
(brace
id|pr_debug
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: recording schedule timeout, &quot;
l_string|&quot;dmasz %u fragsz %u count %i hwptr %u swptr %u&bslash;n&quot;
comma
id|dmabuf-&gt;dmasize
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;count
comma
id|dmabuf-&gt;hwptr
comma
id|dmabuf-&gt;swptr
)paren
suffix:semicolon
multiline_comment|/* a buffer overrun, we delay the recovery until next time the&n;&t;&t;&t;&t;   while loop begin and we REALLY have space to record */
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|swptr
suffix:semicolon
id|dmabuf-&gt;count
op_sub_assign
id|cnt
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* in this loop, dmabuf.count signifies the amount of data that is waiting to be dma to&n;   the soundcard.  it is drained by the dma machine and filled by this loop. */
r_static
id|ssize_t
DECL|function|trident_write
id|trident_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
r_int
id|state_cnt
suffix:semicolon
r_int
r_int
id|copy_count
suffix:semicolon
r_int
id|lret
suffix:semicolon
multiline_comment|/* for lock_set_fmt */
id|pr_debug
c_func
(paren
l_string|&quot;trident: trident_write called, count = %d&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      Guard against an mmap or ioctl while writing&n;&t; */
id|down
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf_playback
c_func
(paren
id|state
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|count
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OL
l_int|0
)paren
(brace
multiline_comment|/* buffer underrun, we are recovering from */
multiline_comment|/* sleep_on_timeout, resync hwptr and swptr */
id|dmabuf-&gt;count
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
)brace
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_plus
id|cnt
OG
id|dmabuf-&gt;dmasize
)paren
id|cnt
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
r_int
r_int
id|tmo
suffix:semicolon
multiline_comment|/* buffer is full, start the dma machine and */
multiline_comment|/* wait for data to be played */
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* No matter how much data left in the buffer, */
multiline_comment|/* we have to wait until CSO == ESO/2 or CSO == ESO */
multiline_comment|/* when address engine interrupts */
id|lock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
id|tmo
op_assign
(paren
id|dmabuf-&gt;dmasize
op_star
id|HZ
)paren
op_div
(paren
id|dmabuf-&gt;rate
op_star
l_int|2
)paren
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
id|dmabuf-&gt;fmt
)braket
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
multiline_comment|/* There are two situations when sleep_on_timeout */
multiline_comment|/* returns, one is when the interrupt is serviced */
multiline_comment|/* correctly and the process is waked up by ISR */
multiline_comment|/* ON TIME. Another is when timeout is expired, which */
multiline_comment|/* means that either interrupt is NOT serviced */
multiline_comment|/* correctly (pending interrupt) or it is TOO LATE */
multiline_comment|/* for the process to be scheduled to run */
multiline_comment|/* (scheduler latency) which results in a (potential) */
multiline_comment|/* buffer underrun. And worse, there is NOTHING we */
multiline_comment|/* can do to prevent it. */
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|dmabuf-&gt;wait
comma
id|tmo
)paren
)paren
(brace
id|pr_debug
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: playback schedule &quot;
l_string|&quot;timeout, dmasz %u fragsz %u count %i &quot;
l_string|&quot;hwptr %u swptr %u&bslash;n&quot;
comma
id|dmabuf-&gt;dmasize
comma
id|dmabuf-&gt;fragsize
comma
id|dmabuf-&gt;count
comma
id|dmabuf-&gt;hwptr
comma
id|dmabuf-&gt;swptr
)paren
suffix:semicolon
multiline_comment|/* a buffer underrun, we delay the recovery */
multiline_comment|/* until next time the while loop begin and */
multiline_comment|/* we REALLY have data to play */
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|out_nolock
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|lret
op_assign
id|lock_set_fmt
c_func
(paren
id|state
)paren
)paren
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|lret
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state-&gt;chans_num
op_eq
l_int|6
)paren
(brace
id|copy_count
op_assign
l_int|0
suffix:semicolon
id|state_cnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ali_write_5_1
c_func
(paren
id|state
comma
id|buffer
comma
id|cnt
comma
op_amp
id|copy_count
comma
op_amp
id|state_cnt
)paren
op_eq
op_minus
id|EFAULT
)paren
(brace
r_if
c_cond
(paren
id|state_cnt
)paren
(brace
id|swptr
op_assign
(paren
id|swptr
op_plus
id|state_cnt
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|swptr
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|state_cnt
suffix:semicolon
id|dmabuf-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|ret
op_add_assign
id|copy_count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|state_cnt
op_assign
id|cnt
suffix:semicolon
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
id|swptr
op_assign
(paren
id|swptr
op_plus
id|state_cnt
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|swptr
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|state_cnt
suffix:semicolon
id|dmabuf-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
id|out_nolock
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* No kernel lock - we have our own spinlock */
r_static
r_int
r_int
DECL|function|trident_poll
id|trident_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      Guard against a parallel poll and write causing multiple&n;&t; *      prog_dmabuf events&n;&t; */
id|down
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
id|prog_dmabuf_playback
c_func
(paren
id|state
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dmabuf-&gt;wait
comma
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
id|prog_dmabuf_record
c_func
(paren
id|state
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dmabuf-&gt;wait
comma
id|wait
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
op_ge
id|dmabuf-&gt;count
op_plus
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_mmap
id|trident_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      Lock against poll read write or mmap creating buffers. Also lock&n;&t; *      a read or write against an mmap.&n;&t; */
id|down
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf_playback
c_func
(paren
id|state
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf_record
c_func
(paren
id|state
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
r_goto
id|out
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_pgoff
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
(paren
id|PAGE_SIZE
op_lshift
id|dmabuf-&gt;buforder
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|remap_pfn_range
c_func
(paren
id|vma
comma
id|vma-&gt;vm_start
comma
id|virt_to_phys
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
op_rshift
id|PAGE_SHIFT
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_goto
id|out
suffix:semicolon
id|dmabuf-&gt;mapped
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_ioctl
id|trident_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|abinfo
suffix:semicolon
id|count_info
id|cinfo
suffix:semicolon
r_int
id|val
comma
id|mapped
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|__user
op_star
id|p
op_assign
id|argp
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
id|mapped
op_assign
(paren
(paren
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_WRITE
op_or
id|FMODE_READ
)paren
)paren
op_logical_and
id|dmabuf-&gt;mapped
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: trident_ioctl, command = %2d, arg = 0x%08x&bslash;n&quot;
comma
id|_IOC_NR
c_func
(paren
id|cmd
)paren
comma
id|arg
ques
c_cond
op_star
id|p
suffix:colon
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
id|ret
op_assign
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
multiline_comment|/* FIXME: spin_lock ? */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
id|card-&gt;irq
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
id|card-&gt;irq
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;swptr
op_assign
id|dmabuf-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|ret
op_assign
id|drain_dac
c_func
(paren
id|state
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
multiline_comment|/* set smaple rate */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_set_dac_rate
c_func
(paren
id|state
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_set_adc_rate
c_func
(paren
id|state
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|put_user
c_func
(paren
id|dmabuf-&gt;rate
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
multiline_comment|/* set stereo or mono channel */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lock_set_fmt
c_func
(paren
id|state
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf_playback
c_func
(paren
id|state
)paren
)paren
)paren
id|ret
op_assign
id|val
suffix:semicolon
r_else
id|ret
op_assign
id|put_user
c_func
(paren
id|dmabuf-&gt;fragsize
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf_record
c_func
(paren
id|state
)paren
)paren
)paren
id|ret
op_assign
id|val
suffix:semicolon
r_else
id|ret
op_assign
id|put_user
c_func
(paren
id|dmabuf-&gt;fragsize
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* neither READ nor WRITE? is this even possible? */
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask of supported sample format */
id|ret
op_assign
id|put_user
c_func
(paren
id|AFMT_S16_LE
op_or
id|AFMT_U16_LE
op_or
id|AFMT_S8
op_or
id|AFMT_U8
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Select sample format */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lock_set_fmt
c_func
(paren
id|state
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_16BIT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_16BIT
suffix:semicolon
)brace
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
id|ret
op_assign
id|put_user
c_func
(paren
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|lock_set_fmt
c_func
(paren
id|state
)paren
)paren
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
singleline_comment|//prevent from memory leak
r_if
c_cond
(paren
(paren
id|state-&gt;chans_num
OG
l_int|2
)paren
op_logical_and
(paren
id|state-&gt;chans_num
op_ne
id|val
)paren
)paren
(brace
id|ali_free_other_states_resources
c_func
(paren
id|state
)paren
suffix:semicolon
id|state-&gt;chans_num
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
(brace
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_eq
l_int|6
)paren
op_logical_and
(paren
id|state-&gt;card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;rec_channel_use_count
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: Record is &quot;
l_string|&quot;working on the card!&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ret
op_assign
id|ali_setup_multi_channels
c_func
(paren
id|state-&gt;card
comma
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|state-&gt;card-&gt;open_sem
)paren
suffix:semicolon
id|ret
op_assign
id|ali_allocate_other_states_resources
c_func
(paren
id|state
comma
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|state-&gt;card-&gt;open_sem
)paren
suffix:semicolon
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|state-&gt;card-&gt;multi_channel_use_count
op_increment
suffix:semicolon
id|up
c_func
(paren
op_amp
id|state-&gt;card-&gt;open_sem
)paren
suffix:semicolon
)brace
r_else
id|val
op_assign
l_int|2
suffix:semicolon
multiline_comment|/*yield to 2-channels */
)brace
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
id|state-&gt;chans_num
op_assign
id|val
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
(paren
id|val
op_eq
l_int|6
)paren
)paren
)paren
id|val
op_assign
l_int|2
suffix:semicolon
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_STEREO
suffix:semicolon
)brace
r_else
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_STEREO
suffix:semicolon
id|state-&gt;chans_num
op_assign
id|val
suffix:semicolon
)brace
id|unlock_set_fmt
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|put_user
c_func
(paren
id|val
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
multiline_comment|/* Cause the working fragment to be output */
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
r_if
c_cond
(paren
id|dmabuf-&gt;subdivision
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_ne
l_int|1
op_logical_and
id|val
op_ne
l_int|2
op_logical_and
id|val
op_ne
l_int|4
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dmabuf-&gt;subdivision
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dmabuf-&gt;ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|dmabuf-&gt;ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossfragshift
OL
l_int|4
)paren
id|dmabuf-&gt;ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossfragshift
OG
l_int|15
)paren
id|dmabuf-&gt;ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;ossmaxfrags
OL
l_int|4
)paren
id|dmabuf-&gt;ossmaxfrags
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf_playback
c_func
(paren
id|state
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ret
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|dmabuf-&gt;fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|dmabuf-&gt;dmasize
op_minus
id|dmabuf-&gt;count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|dmabuf-&gt;numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf_record
c_func
(paren
id|state
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ret
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|dmabuf-&gt;fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|dmabuf-&gt;numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
id|ret
op_assign
id|put_user
c_func
(paren
id|DSP_CAP_REALTIME
op_or
id|DSP_CAP_TRIGGER
op_or
id|DSP_CAP_MMAP
op_or
id|DSP_CAP_BIND
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
op_logical_and
id|dmabuf-&gt;enable
)paren
id|val
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
id|dmabuf-&gt;enable
)paren
id|val
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
id|ret
op_assign
id|put_user
c_func
(paren
id|val
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_INPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf_record
c_func
(paren
id|state
)paren
)paren
)paren
r_break
suffix:semicolon
id|start_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_OUTPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf_playback
c_func
(paren
id|state
)paren
)paren
)paren
r_break
suffix:semicolon
id|start_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_else
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf_record
c_func
(paren
id|state
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ret
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|dmabuf-&gt;total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|dmabuf-&gt;count
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
id|dmabuf-&gt;count
op_and_assign
id|dmabuf-&gt;fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf_playback
c_func
(paren
id|state
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ret
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|dmabuf-&gt;total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|dmabuf-&gt;count
op_rshift
id|dmabuf-&gt;fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|dmabuf-&gt;hwptr
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
id|dmabuf-&gt;count
op_and_assign
id|dmabuf-&gt;fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;ready
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf_playback
c_func
(paren
id|state
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|ret
op_assign
id|val
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
id|val
op_assign
id|dmabuf-&gt;count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|put_user
c_func
(paren
id|val
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
id|ret
op_assign
id|put_user
c_func
(paren
id|dmabuf-&gt;rate
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
id|ret
op_assign
id|put_user
c_func
(paren
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_STEREO
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
id|ret
op_assign
id|put_user
c_func
(paren
(paren
id|dmabuf-&gt;fmt
op_amp
id|TRIDENT_FMT_16BIT
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCHANNELMASK
suffix:colon
id|ret
op_assign
id|put_user
c_func
(paren
id|DSP_BIND_FRONT
op_or
id|DSP_BIND_SURR
op_or
id|DSP_BIND_CENTER_LFE
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_BIND_CHANNEL
suffix:colon
r_if
c_cond
(paren
id|state-&gt;card-&gt;pci_id
op_ne
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_eq
id|DSP_BIND_QUERY
)paren
(brace
id|val
op_assign
id|dmabuf-&gt;channel-&gt;attribute
op_or
l_int|0x3c00
suffix:semicolon
id|val
op_assign
id|attr2mask
(braket
id|val
op_rshift
l_int|8
)braket
suffix:semicolon
)brace
r_else
(brace
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|dmabuf-&gt;channel-&gt;attribute
op_assign
(paren
id|CHANNEL_REC
op_or
id|SRC_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|dmabuf-&gt;channel-&gt;attribute
op_assign
(paren
id|CHANNEL_SPC_PB
op_or
id|SRC_ENABLE
)paren
suffix:semicolon
id|dmabuf-&gt;channel-&gt;attribute
op_or_assign
id|mask2attr
(braket
id|ffs
c_func
(paren
id|val
)paren
)braket
suffix:semicolon
)brace
id|ret
op_assign
id|put_user
c_func
(paren
id|val
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_MAPINBUF
suffix:colon
r_case
id|SNDCTL_DSP_MAPOUTBUF
suffix:colon
r_case
id|SNDCTL_DSP_SETSYNCRO
suffix:colon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_open
id|trident_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_struct
id|trident_state
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Added by Matt Wu 01-05-2001 */
multiline_comment|/* TODO: there&squot;s some redundacy here wrt the check below */
multiline_comment|/* for multi_use_count &gt; 0. Should we return -EBUSY or find */
multiline_comment|/* a different card? for now, don&squot;t break current behaviour */
multiline_comment|/* -- mulix */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;multi_channel_use_count
OG
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
multiline_comment|/* find an available virtual channel (instance of /dev/dsp) */
r_while
c_loop
(paren
id|card
op_ne
l_int|NULL
)paren
(brace
id|down
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
multiline_comment|/* Skip opens on cards that are in 6 channel mode */
r_if
c_cond
(paren
id|card-&gt;multi_channel_use_count
OG
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|card
op_assign
id|card-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;states
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
l_int|NULL
)paren
(brace
id|up
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|state
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|state
)paren
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_goto
id|found_virt
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|card
op_assign
id|card-&gt;next
suffix:semicolon
)brace
multiline_comment|/* no more virtual channel avaiable */
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|found_virt
suffix:colon
multiline_comment|/* found a free virtual channel, allocate hardware channels */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|dmabuf-&gt;channel
op_assign
id|card
op_member_access_from_pointer
id|alloc_rec_pcm_channel
c_func
(paren
id|card
)paren
suffix:semicolon
r_else
id|dmabuf-&gt;channel
op_assign
id|card
op_member_access_from_pointer
id|alloc_pcm_channel
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;channel
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|card-&gt;states
(braket
id|i
)braket
)paren
suffix:semicolon
id|card-&gt;states
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* initialize the virtual channel */
id|state-&gt;virt
op_assign
id|i
suffix:semicolon
id|state-&gt;card
op_assign
id|card
suffix:semicolon
id|state-&gt;magic
op_assign
id|TRIDENT_STATE_MAGIC
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|state
suffix:semicolon
multiline_comment|/* set default sample format. According to OSS Programmer&squot;s */
multiline_comment|/* Guide  /dev/dsp should be default to unsigned 8-bits, mono, */
multiline_comment|/* with sample rate 8kHz and /dev/dspW will accept 16-bits sample */
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0x0f
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
id|dmabuf-&gt;ossfragshift
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;ossmaxfrags
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;subdivision
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
multiline_comment|/* set default channel attribute to normal playback */
id|dmabuf-&gt;channel-&gt;attribute
op_assign
id|CHANNEL_PB
suffix:semicolon
)brace
id|trident_set_dac_rate
c_func
(paren
id|state
comma
l_int|8000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
multiline_comment|/* FIXME: Trident 4d can only record in signed 16-bits stereo, */
multiline_comment|/* 48kHz sample, to be dealed with in trident_set_adc_rate() ?? */
id|dmabuf-&gt;fmt
op_and_assign
op_complement
id|TRIDENT_FMT_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0x0f
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|dmabuf-&gt;fmt
op_or_assign
id|TRIDENT_FMT_16BIT
suffix:semicolon
id|dmabuf-&gt;ossfragshift
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;ossmaxfrags
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;subdivision
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_SI_7018
)paren
(brace
multiline_comment|/* set default channel attribute to 0x8a80, record from&n;&t;&t;&t;   PCM L/R FIFO and mono = (left + right + 1)/2 */
id|dmabuf-&gt;channel-&gt;attribute
op_assign
(paren
id|CHANNEL_REC
op_or
id|PCM_LR
op_or
id|MONO_MIX
)paren
suffix:semicolon
)brace
id|trident_set_adc_rate
c_func
(paren
id|state
comma
l_int|8000
)paren
suffix:semicolon
multiline_comment|/* Added by Matt Wu 01-05-2001 */
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
id|card-&gt;rec_channel_use_count
op_increment
suffix:semicolon
)brace
id|state-&gt;open_mode
op_or_assign
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;trident: open virtual channel %d, hard channel %d&bslash;n&quot;
comma
id|state-&gt;virt
comma
id|dmabuf-&gt;channel-&gt;num
)paren
suffix:semicolon
r_return
id|nonseekable_open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_release
id|trident_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|trident_state
op_star
id|state
op_assign
(paren
r_struct
id|trident_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|state
)paren
suffix:semicolon
id|card
op_assign
id|state-&gt;card
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|trident_clear_tail
c_func
(paren
id|state
)paren
suffix:semicolon
id|drain_dac
c_func
(paren
id|state
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;trident: closing virtual channel %d, hard channel %d&bslash;n&quot;
comma
id|state-&gt;virt
comma
id|dmabuf-&gt;channel-&gt;num
)paren
suffix:semicolon
multiline_comment|/* stop DMA state machine and free DMA buffers/channels */
id|down
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|state
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
op_amp
id|state-&gt;dmabuf
comma
id|state-&gt;card-&gt;pci_dev
)paren
suffix:semicolon
id|state-&gt;card
op_member_access_from_pointer
id|free_pcm_channel
c_func
(paren
id|state-&gt;card
comma
id|dmabuf-&gt;channel-&gt;num
)paren
suffix:semicolon
multiline_comment|/* Added by Matt Wu */
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;chans_num
OG
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;multi_channel_use_count
op_decrement
OL
l_int|0
)paren
id|card-&gt;multi_channel_use_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;multi_channel_use_count
op_eq
l_int|0
)paren
id|ali_close_multi_channels
c_func
(paren
)paren
suffix:semicolon
id|ali_free_other_states_resources
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|state
)paren
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
op_amp
id|state-&gt;dmabuf
comma
id|state-&gt;card-&gt;pci_dev
)paren
suffix:semicolon
id|state-&gt;card
op_member_access_from_pointer
id|free_pcm_channel
c_func
(paren
id|state-&gt;card
comma
id|dmabuf-&gt;channel-&gt;num
)paren
suffix:semicolon
multiline_comment|/* Added by Matt Wu */
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;rec_channel_use_count
op_decrement
OL
l_int|0
)paren
id|card-&gt;rec_channel_use_count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|card-&gt;states
(braket
id|state-&gt;virt
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|state
)paren
suffix:semicolon
multiline_comment|/* we&squot;re covered by the open_sem */
id|up
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|trident_audio_fops
r_static
multiline_comment|/*const */
r_struct
id|file_operations
id|trident_audio_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|trident_read
comma
dot
id|write
op_assign
id|trident_write
comma
dot
id|poll
op_assign
id|trident_poll
comma
dot
id|ioctl
op_assign
id|trident_ioctl
comma
dot
id|mmap
op_assign
id|trident_mmap
comma
dot
id|open
op_assign
id|trident_open
comma
dot
id|release
op_assign
id|trident_release
comma
)brace
suffix:semicolon
multiline_comment|/* trident specific AC97 functions */
multiline_comment|/* Write AC97 codec registers */
r_static
r_void
DECL|function|trident_ac97_set
id|trident_ac97_set
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_int
r_int
id|address
comma
id|mask
comma
id|busy
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|data
op_assign
(paren
(paren
id|u32
)paren
id|val
)paren
op_lshift
l_int|16
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_default
suffix:colon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|address
op_assign
id|SI_AC97_WRITE
suffix:semicolon
id|mask
op_assign
id|SI_AC97_BUSY_WRITE
op_or
id|SI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|SI_AC97_SECONDARY
suffix:semicolon
id|busy
op_assign
id|SI_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|address
op_assign
id|DX_ACR0_AC97_W
suffix:semicolon
id|mask
op_assign
id|busy
op_assign
id|DX_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
id|address
op_assign
id|NX_ACR1_AC97_W
suffix:semicolon
id|mask
op_assign
id|NX_AC97_BUSY_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|NX_AC97_WRITE_SECONDARY
suffix:semicolon
id|busy
op_assign
id|NX_AC97_BUSY_WRITE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_INTERG_5050
suffix:colon
id|address
op_assign
id|SI_AC97_WRITE
suffix:semicolon
id|mask
op_assign
id|busy
op_assign
id|SI_AC97_BUSY_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|SI_AC97_SECONDARY
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
op_amp
id|busy
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
suffix:semicolon
id|data
op_or_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: AC97 CODEC write timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Read AC97 codec registers */
r_static
id|u16
DECL|function|trident_ac97_get
id|trident_ac97_get
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_int
r_int
id|address
comma
id|mask
comma
id|busy
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0xffff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|data
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_default
suffix:colon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
id|address
op_assign
id|SI_AC97_READ
suffix:semicolon
id|mask
op_assign
id|SI_AC97_BUSY_READ
op_or
id|SI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|SI_AC97_SECONDARY
suffix:semicolon
id|busy
op_assign
id|SI_AC97_BUSY_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
id|address
op_assign
id|DX_ACR1_AC97_R
suffix:semicolon
id|mask
op_assign
id|busy
op_assign
id|DX_AC97_BUSY_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|address
op_assign
id|NX_ACR3_AC97_R_SECONDARY
suffix:semicolon
r_else
id|address
op_assign
id|NX_ACR2_AC97_R_PRIMARY
suffix:semicolon
id|mask
op_assign
id|NX_AC97_BUSY_READ
suffix:semicolon
id|busy
op_assign
id|NX_AC97_BUSY_READ
op_or
id|NX_AC97_BUSY_DATA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_INTERG_5050
suffix:colon
id|address
op_assign
id|SI_AC97_READ
suffix:semicolon
id|mask
op_assign
id|busy
op_assign
id|SI_AC97_BUSY_READ
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|mask
op_or_assign
id|SI_AC97_SECONDARY
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data
op_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|data
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
r_do
(brace
id|data
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_amp
id|busy
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: AC97 CODEC read timed out.&bslash;n&quot;
)paren
suffix:semicolon
id|data
op_assign
l_int|0
suffix:semicolon
)brace
r_return
(paren
(paren
id|u16
)paren
(paren
id|data
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* rewrite ac97 read and write mixer register by hulei for ALI*/
r_static
r_int
DECL|function|acquirecodecaccess
id|acquirecodecaccess
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u16
id|wsemamask
op_assign
l_int|0x6000
suffix:semicolon
multiline_comment|/* bit 14..13 */
id|u16
id|wsemabits
suffix:semicolon
id|u16
id|wcontrol
suffix:semicolon
r_int
id|block
op_assign
l_int|0
suffix:semicolon
r_int
id|ncount
op_assign
l_int|25
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|wcontrol
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
id|wsemabits
op_assign
id|wcontrol
op_amp
id|wsemamask
suffix:semicolon
r_if
c_cond
(paren
id|wsemabits
op_eq
l_int|0x4000
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* 0x4000 is audio ,then success */
r_if
c_cond
(paren
id|ncount
op_decrement
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|wsemabits
op_eq
l_int|0
)paren
(brace
id|unlock
suffix:colon
id|outl
c_func
(paren
(paren
(paren
id|u32
)paren
(paren
id|wcontrol
op_amp
l_int|0x1eff
)paren
op_or
l_int|0x00004000
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|block
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;accesscodecsemaphore: try unlock&bslash;n&quot;
)paren
suffix:semicolon
id|block
op_assign
l_int|1
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|releasecodecaccess
id|releasecodecaccess
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|wcontrol
suffix:semicolon
id|wcontrol
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|wcontrol
op_amp
l_int|0xffff1eff
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|waitforstimertick
id|waitforstimertick
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|chk1
comma
id|chk2
suffix:semicolon
r_int
r_int
id|wcount
op_assign
l_int|0xffff
suffix:semicolon
id|chk1
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|chk2
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wcount
OG
l_int|0
)paren
op_logical_and
id|chk1
op_ne
id|chk2
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|wcount
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read AC97 codec registers for ALi*/
r_static
id|u16
DECL|function|ali_ac97_get
id|ali_ac97_get
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|secondary
comma
id|u8
id|reg
)paren
(brace
r_int
r_int
id|address
comma
id|mask
suffix:semicolon
r_int
r_int
id|ncount
suffix:semicolon
r_int
r_int
id|aud_reg
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|u16
id|wcontrol
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|address
op_assign
id|ALI_AC97_READ
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;revision
op_eq
id|ALI_5451_V02
)paren
(brace
id|address
op_assign
id|ALI_AC97_WRITE
suffix:semicolon
)brace
id|mask
op_assign
id|ALI_AC97_READ_ACTION
op_or
id|ALI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|secondary
)paren
id|mask
op_or_assign
id|ALI_AC97_SECONDARY
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acquirecodecaccess
c_func
(paren
id|card
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;access codec fail&bslash;n&quot;
)paren
suffix:semicolon
id|wcontrol
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
id|wcontrol
op_and_assign
l_int|0xfe00
suffix:semicolon
id|wcontrol
op_or_assign
(paren
l_int|0x8000
op_or
id|reg
)paren
suffix:semicolon
id|outw
c_func
(paren
id|wcontrol
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
id|data
op_assign
(paren
id|mask
op_or
(paren
id|reg
op_amp
id|AC97_REG_ADDR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|waitforstimertick
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali_ac97_read: BIT_CLOCK is dead&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|releasecodec
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|ncount
op_assign
l_int|10
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
op_amp
id|ALI_AC97_BUSY_READ
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ncount
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ncount
op_decrement
op_eq
l_int|1
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;ali_ac97_read :try clear busy flag&bslash;n&quot;
)paren
suffix:semicolon
id|aud_reg
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
(paren
id|aud_reg
op_amp
l_int|0xffff7fff
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|data
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|address
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
(paren
id|u16
)paren
(paren
id|data
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|releasecodec
suffix:colon
id|releasecodecaccess
c_func
(paren
id|card
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali_ac97_read: AC97 CODEC read timed out.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Write AC97 codec registers for hulei*/
r_static
r_void
DECL|function|ali_ac97_set
id|ali_ac97_set
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|secondary
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
r_int
r_int
id|address
comma
id|mask
suffix:semicolon
r_int
r_int
id|ncount
suffix:semicolon
id|u32
id|data
suffix:semicolon
id|u16
id|wcontrol
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|data
op_assign
(paren
(paren
id|u32
)paren
id|val
)paren
op_lshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|address
op_assign
id|ALI_AC97_WRITE
suffix:semicolon
id|mask
op_assign
id|ALI_AC97_WRITE_ACTION
op_or
id|ALI_AC97_AUDIO_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|secondary
)paren
id|mask
op_or_assign
id|ALI_AC97_SECONDARY
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;revision
op_eq
id|ALI_5451_V02
)paren
id|mask
op_or_assign
id|ALI_AC97_WRITE_MIXER_REGISTER
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acquirecodecaccess
c_func
(paren
id|card
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali_ac97_write: access codec fail&bslash;n&quot;
)paren
suffix:semicolon
id|wcontrol
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
id|wcontrol
op_and_assign
l_int|0xff00
suffix:semicolon
id|wcontrol
op_or_assign
(paren
l_int|0x8100
op_or
id|reg
)paren
suffix:semicolon
multiline_comment|/* bit 8=1: (ali1535 )reserved/ */
multiline_comment|/* ali1535+ write */
id|outl
c_func
(paren
(paren
id|data
op_or
id|wcontrol
)paren
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|waitforstimertick
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BIT_CLOCK is dead&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|releasecodec
suffix:semicolon
)brace
id|ncount
op_assign
l_int|10
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|wcontrol
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|wcontrol
op_amp
l_int|0x8000
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ncount
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ncount
op_decrement
op_eq
l_int|1
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;ali_ac97_set :try clear busy flag!!&bslash;n&quot;
)paren
suffix:semicolon
id|outw
c_func
(paren
id|wcontrol
op_amp
l_int|0x7fff
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_AC97_WRITE
)paren
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|releasecodec
suffix:colon
id|releasecodecaccess
c_func
(paren
id|card
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_enable_special_channel
id|ali_enable_special_channel
c_func
(paren
r_struct
id|trident_state
op_star
id|stat
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|stat-&gt;card
suffix:semicolon
r_int
r_int
id|s_channels
suffix:semicolon
id|s_channels
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|s_channels
op_or_assign
(paren
l_int|1
op_lshift
id|stat-&gt;dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|outl
c_func
(paren
id|s_channels
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
)brace
r_static
id|u16
DECL|function|ali_ac97_read
id|ali_ac97_read
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
(brace
r_int
id|id
suffix:semicolon
id|u16
id|data
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Added by Matt Wu */
r_if
c_cond
(paren
op_logical_neg
id|codec
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;mixer_regs_ready
)paren
r_return
id|ali_ac97_get
c_func
(paren
id|card
comma
id|codec-&gt;id
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      FIXME: need to stop this caching some registers&n;&t; */
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|id
op_assign
l_int|1
suffix:semicolon
r_else
id|id
op_assign
l_int|0
suffix:semicolon
id|data
op_assign
id|card-&gt;mixer_regs
(braket
id|reg
op_div
l_int|2
)braket
(braket
id|id
)braket
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_ac97_write
id|ali_ac97_write
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
r_int
id|id
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
multiline_comment|/*  Added by Matt Wu */
r_if
c_cond
(paren
op_logical_neg
id|codec
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|codec-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;mixer_regs_ready
)paren
(brace
id|ali_ac97_set
c_func
(paren
id|card
comma
id|codec-&gt;id
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|codec-&gt;id
)paren
id|id
op_assign
l_int|1
suffix:semicolon
r_else
id|id
op_assign
l_int|0
suffix:semicolon
id|card-&gt;mixer_regs
(braket
id|reg
op_div
l_int|2
)braket
(braket
id|id
)braket
op_assign
id|val
suffix:semicolon
id|ali_ac97_set
c_func
(paren
id|card
comma
id|codec-&gt;id
comma
id|reg
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;flag:&t;ALI_SPDIF_OUT_TO_SPDIF_OUT&n;&t;ALI_PCM_TO_SPDIF_OUT&n;*/
r_static
r_void
DECL|function|ali_setup_spdif_out
id|ali_setup_spdif_out
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|flag
)paren
(brace
r_int
r_int
id|spdif
suffix:semicolon
r_int
r_char
id|ch
suffix:semicolon
r_char
id|temp
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
id|pci_dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M1533
comma
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x61
comma
op_amp
id|temp
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x40
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x61
comma
id|temp
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x7d
comma
op_amp
id|temp
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x01
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x7d
comma
id|temp
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x7e
comma
op_amp
id|temp
)paren
suffix:semicolon
id|temp
op_and_assign
(paren
op_complement
l_int|0x20
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x10
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x7e
comma
id|temp
)paren
suffix:semicolon
id|ch
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ch
op_or
id|ALI_SPDIF_OUT_ENABLE
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|ch
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ch
op_amp
id|ALI_SPDIF_OUT_CH_STATUS
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|ALI_SPDIF_OUT_TO_SPDIF_OUT
)paren
(brace
id|spdif
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_OUT_CH_ENABLE
suffix:semicolon
id|spdif
op_and_assign
id|ALI_SPDIF_OUT_SEL_SPDIF
suffix:semicolon
id|outw
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|ALI_SPDIF_OUT_NON_PCM
)paren
id|spdif
op_or_assign
l_int|0x0002
suffix:semicolon
r_else
id|spdif
op_and_assign
(paren
op_complement
l_int|0x0002
)paren
suffix:semicolon
id|outw
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|spdif
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_OUT_SEL_PCM
suffix:semicolon
id|outw
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ali_disable_special_channel
id|ali_disable_special_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|ch
)paren
(brace
r_int
r_int
id|sc
suffix:semicolon
id|sc
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|sc
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|ch
)paren
suffix:semicolon
id|outl
c_func
(paren
id|sc
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_disable_spdif_in
id|ali_disable_spdif_in
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|spdif
suffix:semicolon
id|spdif
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_and_assign
(paren
op_complement
id|ALI_SPDIF_IN_SUPPORT
)paren
suffix:semicolon
id|outl
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|ali_disable_special_channel
c_func
(paren
id|card
comma
id|ALI_SPDIF_IN_CHANNEL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_setup_spdif_in
id|ali_setup_spdif_in
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|spdif
suffix:semicolon
singleline_comment|//Set SPDIF IN Supported
id|spdif
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_IN_SUPPORT
suffix:semicolon
id|outl
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
singleline_comment|//Set SPDIF IN Rec
id|spdif
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_IN_CH_ENABLE
suffix:semicolon
id|outl
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|spdif
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|spdif
op_or_assign
id|ALI_SPDIF_IN_CH_STATUS
suffix:semicolon
id|outb
c_func
(paren
id|spdif
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;spdif = inb(TRID_REG(card, ALI_SPDIF_CTRL));&n;&t;spdif |= ALI_SPDIF_IN_FUNC_ENABLE;&n;&t;outb(spdif, TRID_REG(card, ALI_SPDIF_CTRL));&n;*/
)brace
r_static
r_void
DECL|function|ali_delay
id|ali_delay
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|interval
)paren
(brace
r_int
r_int
id|begintimer
comma
id|currenttimer
suffix:semicolon
id|begintimer
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
id|currenttimer
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|currenttimer
OL
id|begintimer
op_plus
id|interval
)paren
id|currenttimer
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_STIMER
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_detect_spdif_rate
id|ali_detect_spdif_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u16
id|wval
op_assign
l_int|0
suffix:semicolon
id|u16
id|count
op_assign
l_int|0
suffix:semicolon
id|u8
id|bval
op_assign
l_int|0
comma
id|R1
op_assign
l_int|0
comma
id|R2
op_assign
l_int|0
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|bval
op_or_assign
l_int|0x02
suffix:semicolon
id|outb
c_func
(paren
id|bval
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|bval
op_or_assign
l_int|0x1F
suffix:semicolon
id|outb
c_func
(paren
id|bval
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|R1
OL
l_int|0x0B
)paren
op_logical_or
(paren
id|R1
OG
l_int|0x0E
)paren
)paren
op_logical_and
(paren
id|R1
op_ne
l_int|0x12
)paren
op_logical_and
id|count
op_le
l_int|50000
)paren
(brace
id|count
op_increment
suffix:semicolon
id|ali_delay
c_func
(paren
id|card
comma
l_int|6
)paren
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|R1
op_assign
id|bval
op_amp
l_int|0x1F
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
l_int|50000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;trident: Error in &quot;
l_string|&quot;ali_detect_spdif_rate!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
op_le
l_int|50000
)paren
(brace
id|count
op_increment
suffix:semicolon
id|ali_delay
c_func
(paren
id|card
comma
l_int|6
)paren
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|R2
op_assign
id|bval
op_amp
l_int|0x1F
suffix:semicolon
r_if
c_cond
(paren
id|R2
op_ne
id|R1
)paren
id|R1
op_assign
id|R2
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
l_int|50000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;trident: Error in &quot;
l_string|&quot;ali_detect_spdif_rate!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|R2
)paren
(brace
r_case
l_int|0x0b
suffix:colon
r_case
l_int|0x0c
suffix:colon
r_case
l_int|0x0d
suffix:colon
r_case
l_int|0x0e
suffix:colon
id|wval
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|wval
op_and_assign
l_int|0xE0F0
suffix:semicolon
id|wval
op_or_assign
(paren
id|u16
)paren
l_int|0x09
op_lshift
l_int|8
op_or
(paren
id|u16
)paren
l_int|0x05
suffix:semicolon
id|outw
c_func
(paren
id|wval
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|3
)paren
)paren
op_amp
l_int|0xF0
suffix:semicolon
id|outb
c_func
(paren
id|bval
op_or
l_int|0x02
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|3
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x12
suffix:colon
id|wval
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|wval
op_and_assign
l_int|0xE0F0
suffix:semicolon
id|wval
op_or_assign
(paren
id|u16
)paren
l_int|0x0E
op_lshift
l_int|8
op_or
(paren
id|u16
)paren
l_int|0x08
suffix:semicolon
id|outw
c_func
(paren
id|wval
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|3
)paren
)paren
op_amp
l_int|0xF0
suffix:semicolon
id|outb
c_func
(paren
id|bval
op_or
l_int|0x03
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|3
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_static
r_int
r_int
DECL|function|ali_get_spdif_in_rate
id|ali_get_spdif_in_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
id|u32
id|dwRate
op_assign
l_int|0
suffix:semicolon
id|u8
id|bval
op_assign
l_int|0
suffix:semicolon
id|ali_detect_spdif_rate
c_func
(paren
id|card
)paren
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|bval
op_and_assign
l_int|0x7F
suffix:semicolon
id|bval
op_or_assign
l_int|0x40
suffix:semicolon
id|outb
c_func
(paren
id|bval
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|bval
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|3
)paren
)paren
suffix:semicolon
id|bval
op_and_assign
l_int|0x0F
suffix:semicolon
r_switch
c_cond
(paren
id|bval
)paren
(brace
r_case
l_int|0
suffix:colon
id|dwRate
op_assign
l_int|44100
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|dwRate
op_assign
l_int|48000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|dwRate
op_assign
l_int|32000
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|// Error occurs
r_break
suffix:semicolon
)brace
r_return
id|dwRate
suffix:semicolon
)brace
r_static
r_int
DECL|function|ali_close_multi_channels
id|ali_close_multi_channels
c_func
(paren
r_void
)paren
(brace
r_char
id|temp
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
id|pci_dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M1533
comma
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x59
comma
op_amp
id|temp
)paren
suffix:semicolon
id|temp
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x59
comma
id|temp
)paren
suffix:semicolon
id|pci_dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M7101
comma
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0xB8
comma
op_amp
id|temp
)paren
suffix:semicolon
id|temp
op_and_assign
op_complement
l_int|0x20
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0xB8
comma
id|temp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ali_setup_multi_channels
id|ali_setup_multi_channels
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
id|chan_nums
)paren
(brace
r_int
r_int
id|dwValue
suffix:semicolon
r_char
id|temp
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
id|pci_dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M1533
comma
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x59
comma
op_amp
id|temp
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x80
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pci_dev
comma
l_int|0x59
comma
id|temp
)paren
suffix:semicolon
id|pci_dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M7101
comma
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
(paren
r_int
)paren
l_int|0xB8
comma
op_amp
id|temp
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x20
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pci_dev
comma
(paren
r_int
)paren
l_int|0xB8
comma
(paren
id|u8
)paren
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_nums
op_eq
l_int|6
)paren
(brace
id|dwValue
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
op_or
l_int|0x000f0000
suffix:semicolon
id|outl
c_func
(paren
id|dwValue
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|dwValue
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dwValue
op_amp
l_int|0x2000000
)paren
(brace
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
l_int|0x02
comma
l_int|8080
)paren
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
l_int|0x36
comma
l_int|0
)paren
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
l_int|0x38
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *      On a board with a single codec you won&squot;t get the&n;&t;&t;&t; *      surround. On other boards configure it.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|card-&gt;ac97_codec
(braket
l_int|1
)braket
op_ne
l_int|NULL
)paren
(brace
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|1
)braket
comma
l_int|0x36
comma
l_int|0
)paren
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|1
)braket
comma
l_int|0x38
comma
l_int|0
)paren
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|1
)braket
comma
l_int|0x02
comma
l_int|0x0606
)paren
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|1
)braket
comma
l_int|0x18
comma
l_int|0x0303
)paren
suffix:semicolon
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|1
)braket
comma
l_int|0x74
comma
l_int|0x3
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_free_pcm_channel
id|ali_free_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|channel
)paren
(brace
r_int
id|bank
suffix:semicolon
r_if
c_cond
(paren
id|channel
OG
l_int|31
)paren
r_return
suffix:semicolon
id|bank
op_assign
id|channel
op_rshift
l_int|5
suffix:semicolon
id|channel
op_assign
id|channel
op_amp
l_int|0x1f
suffix:semicolon
id|card-&gt;banks
(braket
id|bank
)braket
dot
id|bitmap
op_and_assign
op_complement
(paren
l_int|1
op_lshift
(paren
id|channel
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ali_allocate_other_states_resources
id|ali_allocate_other_states_resources
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_int
id|chan_nums
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_struct
id|trident_state
op_star
id|s
suffix:semicolon
r_int
id|i
comma
id|state_count
op_assign
l_int|0
suffix:semicolon
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_struct
id|trident_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|num
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_A
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chan_nums
op_ne
l_int|6
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|ALI_CHANNELS
)paren
op_logical_and
(paren
id|state_count
op_ne
l_int|4
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;states
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
id|num
op_assign
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|num
)paren
)paren
)paren
(brace
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|num
suffix:semicolon
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|num
)braket
suffix:semicolon
id|channel-&gt;num
op_assign
id|num
suffix:semicolon
)brace
r_else
(brace
id|state_count
op_decrement
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|state_count
op_ge
l_int|0
suffix:semicolon
id|state_count
op_decrement
)paren
(brace
id|kfree
c_func
(paren
id|state-&gt;other_states
(braket
id|state_count
)braket
)paren
suffix:semicolon
id|num
op_assign
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
suffix:semicolon
id|ali_free_pcm_channel
c_func
(paren
id|card
comma
id|num
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|s
op_assign
id|card-&gt;states
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
(brace
id|num
op_assign
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
suffix:semicolon
id|ali_free_pcm_channel
c_func
(paren
id|card
comma
id|num
)paren
suffix:semicolon
id|state_count
op_decrement
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|state_count
op_ge
l_int|0
suffix:semicolon
id|state_count
op_decrement
)paren
(brace
id|num
op_assign
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
suffix:semicolon
id|ali_free_pcm_channel
c_func
(paren
id|card
comma
id|num
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|state-&gt;other_states
(braket
id|state_count
)braket
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|s
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|state
)paren
)paren
suffix:semicolon
id|s-&gt;dmabuf.channel
op_assign
id|channel
suffix:semicolon
id|s-&gt;dmabuf.ossfragshift
op_assign
id|s-&gt;dmabuf.ossmaxfrags
op_assign
id|s-&gt;dmabuf.subdivision
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;dmabuf.wait
)paren
suffix:semicolon
id|s-&gt;magic
op_assign
id|card-&gt;magic
suffix:semicolon
id|s-&gt;card
op_assign
id|card
suffix:semicolon
id|s-&gt;virt
op_assign
id|i
suffix:semicolon
id|ali_enable_special_channel
c_func
(paren
id|s
)paren
suffix:semicolon
id|state-&gt;other_states
(braket
id|state_count
op_increment
)braket
op_assign
id|s
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state_count
op_ne
l_int|4
)paren
(brace
id|state_count
op_decrement
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|state_count
op_ge
l_int|0
suffix:semicolon
id|state_count
op_decrement
)paren
(brace
id|kfree
c_func
(paren
id|state-&gt;other_states
(braket
id|state_count
)braket
)paren
suffix:semicolon
id|num
op_assign
id|ali_multi_channels_5_1
(braket
id|state_count
)braket
suffix:semicolon
id|ali_free_pcm_channel
c_func
(paren
id|card
comma
id|num
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_save_regs
id|ali_save_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ali_registers.global_regs
(braket
l_int|0x2c
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
singleline_comment|//ali_registers.global_regs[0x20] = inl(TRID_REG(card,T4D_START_A));    
id|ali_registers.global_regs
(braket
l_int|0x21
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_STOP_A
)paren
)paren
suffix:semicolon
singleline_comment|//disable all IRQ bits
id|outl
c_func
(paren
id|ALI_DISABLE_ALL_IRQ
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ALI_MIXER_REGS
suffix:semicolon
id|i
op_increment
)paren
id|ali_registers.mixer_regs
(braket
id|i
)braket
op_assign
id|ali_ac97_read
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
id|i
op_star
l_int|2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALI_GLOBAL_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_MISCINT
)paren
op_logical_or
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_STOP_A
)paren
)paren
r_continue
suffix:semicolon
id|ali_registers.global_regs
(braket
id|i
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|i
op_star
l_int|4
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALI_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|i
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ALI_CHANNEL_REGS
suffix:semicolon
id|j
op_increment
)paren
id|ali_registers.channel_regs
(braket
id|i
)braket
(braket
id|j
)braket
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|j
op_star
l_int|4
op_plus
l_int|0xe0
)paren
)paren
suffix:semicolon
)brace
singleline_comment|//Stop all HW channel
id|outl
c_func
(paren
id|ALI_STOP_ALL_CHANNELS
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_STOP_A
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_restore_regs
id|ali_restore_regs
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ALI_MIXER_REGS
suffix:semicolon
id|i
op_increment
)paren
id|ali_ac97_write
c_func
(paren
id|card-&gt;ac97_codec
(braket
l_int|0
)braket
comma
id|i
op_star
l_int|2
comma
id|ali_registers.mixer_regs
(braket
id|i
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALI_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|outb
c_func
(paren
id|i
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_LFO_GC_CIR
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ALI_CHANNEL_REGS
suffix:semicolon
id|j
op_increment
)paren
id|outl
c_func
(paren
id|ali_registers.channel_regs
(braket
id|i
)braket
(braket
id|j
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|j
op_star
l_int|4
op_plus
l_int|0xe0
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALI_GLOBAL_REGS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_MISCINT
)paren
op_logical_or
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_STOP_A
)paren
op_logical_or
(paren
id|i
op_star
l_int|4
op_eq
id|T4D_START_A
)paren
)paren
r_continue
suffix:semicolon
id|outl
c_func
(paren
id|ali_registers.global_regs
(braket
id|i
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|i
op_star
l_int|4
)paren
)paren
suffix:semicolon
)brace
singleline_comment|//start HW channel
id|outl
c_func
(paren
id|ali_registers.global_regs
(braket
l_int|0x20
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_START_A
)paren
)paren
suffix:semicolon
singleline_comment|//restore IRQ enable bits
id|outl
c_func
(paren
id|ali_registers.global_regs
(braket
l_int|0x2c
)braket
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_suspend
id|trident_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u32
id|unused
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
id|ali_save_regs
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_resume
id|trident_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
id|ali_restore_regs
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|trident_channel
op_star
DECL|function|ali_alloc_pcm_channel
id|ali_alloc_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_A
)braket
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
op_amp
(paren
id|ALI_SPDIF_OUT_CH_ENABLE
)paren
)paren
(brace
id|idx
op_assign
id|ALI_SPDIF_OUT_CHANNEL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|idx
op_assign
id|ALI_PCM_OUT_CHANNEL_FIRST
suffix:semicolon
id|idx
op_le
id|ALI_PCM_OUT_CHANNEL_LAST
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
)brace
multiline_comment|/* no more free channels avaliable */
macro_line|#if 0 
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali: no more channels available on Bank A.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* 0 */ 
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_struct
id|trident_channel
op_star
DECL|function|ali_alloc_rec_pcm_channel
id|ali_alloc_rec_pcm_channel
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|trident_pcm_bank
op_star
id|bank
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
op_amp
id|ALI_SPDIF_IN_SUPPORT
)paren
id|idx
op_assign
id|ALI_SPDIF_IN_CHANNEL
suffix:semicolon
r_else
id|idx
op_assign
id|ALI_PCM_IN_CHANNEL
suffix:semicolon
id|bank
op_assign
op_amp
id|card-&gt;banks
(braket
id|BANK_A
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bank-&gt;bitmap
op_amp
(paren
l_int|1
op_lshift
id|idx
)paren
)paren
)paren
(brace
r_struct
id|trident_channel
op_star
id|channel
op_assign
op_amp
id|bank-&gt;channels
(braket
id|idx
)braket
suffix:semicolon
id|bank-&gt;bitmap
op_or_assign
l_int|1
op_lshift
id|idx
suffix:semicolon
id|channel-&gt;num
op_assign
id|idx
suffix:semicolon
r_return
id|channel
suffix:semicolon
)brace
multiline_comment|/* no free recordable channels avaliable */
macro_line|#if 0 
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ali: no recordable channels available on Bank A.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* 0 */ 
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_set_spdif_out_rate
id|ali_set_spdif_out_rate
c_func
(paren
r_struct
id|trident_card
op_star
id|card
comma
r_int
r_int
id|rate
)paren
(brace
r_int
r_char
id|ch_st_sel
suffix:semicolon
r_int
r_int
id|status_rate
suffix:semicolon
r_switch
c_cond
(paren
id|rate
)paren
(brace
r_case
l_int|44100
suffix:colon
id|status_rate
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32000
suffix:colon
id|status_rate
op_assign
l_int|0x300
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|48000
suffix:colon
r_default
suffix:colon
id|status_rate
op_assign
l_int|0x200
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* select spdif_out */
id|ch_st_sel
op_assign
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
op_amp
id|ALI_SPDIF_OUT_CH_STATUS
suffix:semicolon
id|ch_st_sel
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* select right */
id|outb
c_func
(paren
id|ch_st_sel
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|status_rate
op_or
l_int|0x20
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|ch_st_sel
op_and_assign
(paren
op_complement
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* select left */
id|outb
c_func
(paren
id|ch_st_sel
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CTRL
)paren
)paren
suffix:semicolon
id|outw
c_func
(paren
id|status_rate
op_or
l_int|0x10
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SPDIF_CS
op_plus
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_address_interrupt
id|ali_address_interrupt
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
id|i
comma
id|channel
suffix:semicolon
r_struct
id|trident_state
op_star
id|state
suffix:semicolon
id|u32
id|mask
comma
id|channel_mask
suffix:semicolon
id|mask
op_assign
id|trident_get_interrupt_mask
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|state
op_assign
id|card-&gt;states
(braket
id|i
)braket
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|channel
op_assign
id|state-&gt;dmabuf.channel-&gt;num
suffix:semicolon
r_if
c_cond
(paren
(paren
id|channel_mask
op_assign
l_int|1
op_lshift
id|channel
)paren
op_amp
id|mask
)paren
(brace
id|mask
op_and_assign
op_complement
id|channel_mask
suffix:semicolon
id|trident_ack_channel_interrupt
c_func
(paren
id|card
comma
id|channel
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|state-&gt;dmabuf.update_flag
op_or_assign
id|ALI_ADDRESS_INT_UPDATE
suffix:semicolon
id|trident_update_ptr
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|mask
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HW_CH
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ali: spurious channel irq %d.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|trident_ack_channel_interrupt
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
id|trident_stop_voice
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
id|trident_disable_voice_irq
c_func
(paren
id|card
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Updating the values of counters of other_states&squot; DMAs without lock &n;protection is no harm because all DMAs of multi-channels and interrupt&n;depend on a master state&squot;s DMA, and changing the counters of the master&n;state DMA is protected by a spinlock.&n;*/
r_static
r_int
DECL|function|ali_write_5_1
id|ali_write_5_1
c_func
(paren
r_struct
id|trident_state
op_star
id|state
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|cnt_for_multi_channel
comma
r_int
r_int
op_star
id|copy_count
comma
r_int
r_int
op_star
id|state_cnt
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf_temp
suffix:semicolon
r_const
r_char
id|__user
op_star
id|buffer
op_assign
id|buf
suffix:semicolon
r_int
id|swptr
comma
id|other_dma_nums
comma
id|sample_s
suffix:semicolon
r_int
r_int
id|i
comma
id|loop
suffix:semicolon
id|other_dma_nums
op_assign
l_int|4
suffix:semicolon
id|sample_s
op_assign
id|sample_size
(braket
id|dmabuf-&gt;fmt
)braket
op_rshift
l_int|1
suffix:semicolon
id|swptr
op_assign
id|dmabuf-&gt;swptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|state-&gt;multi_channels_adjust_count
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
(paren
op_star
id|state_cnt
)paren
op_add_assign
id|sample_s
suffix:semicolon
id|state-&gt;multi_channels_adjust_count
op_increment
suffix:semicolon
)brace
r_else
id|i
op_assign
id|i
op_minus
(paren
id|state-&gt;chans_num
op_minus
id|other_dma_nums
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
(paren
id|i
OL
id|other_dma_nums
)paren
op_logical_and
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt_for_multi_channel
op_eq
l_int|0
)paren
id|state-&gt;multi_channels_adjust_count
op_add_assign
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
(brace
id|loop
op_assign
id|cnt_for_multi_channel
op_div
(paren
id|state-&gt;chans_num
op_star
id|sample_s
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|loop
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|sample_s
op_star
l_int|2
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
op_star
l_int|2
comma
op_star
id|copy_count
)paren
suffix:semicolon
(paren
op_star
id|state_cnt
)paren
op_add_assign
(paren
id|sample_s
op_star
l_int|2
)paren
suffix:semicolon
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
l_int|2
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
l_int|3
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
(brace
id|state-&gt;multi_channels_adjust_count
op_assign
id|cnt_for_multi_channel
op_div
id|sample_s
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
(paren
op_star
id|state_cnt
)paren
op_add_assign
id|sample_s
suffix:semicolon
r_if
c_cond
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
(paren
op_star
id|state_cnt
)paren
op_add_assign
id|sample_s
suffix:semicolon
r_if
c_cond
(paren
id|cnt_for_multi_channel
OG
l_int|0
)paren
(brace
r_int
id|diff
op_assign
id|state-&gt;chans_num
op_minus
id|other_dma_nums
suffix:semicolon
id|loop
op_assign
id|state-&gt;multi_channels_adjust_count
op_minus
id|diff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|loop
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf_temp-&gt;rawbuf
op_plus
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|sample_s
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|seek_offset
c_func
(paren
id|dmabuf_temp-&gt;swptr
comma
id|buffer
comma
id|cnt_for_multi_channel
comma
id|sample_s
comma
op_star
id|copy_count
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
id|state-&gt;multi_channels_adjust_count
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|other_dma_nums
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dmabuf_temp
op_assign
op_amp
id|state-&gt;other_states
(braket
id|i
)braket
op_member_access_from_pointer
id|dmabuf
suffix:semicolon
id|dmabuf_temp-&gt;swptr
op_assign
id|dmabuf_temp-&gt;swptr
op_mod
id|dmabuf_temp-&gt;dmasize
suffix:semicolon
)brace
r_return
op_star
id|state_cnt
suffix:semicolon
)brace
r_static
r_void
DECL|function|ali_free_other_states_resources
id|ali_free_other_states_resources
c_func
(paren
r_struct
id|trident_state
op_star
id|state
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|state-&gt;card
suffix:semicolon
r_struct
id|trident_state
op_star
id|s
suffix:semicolon
r_int
id|other_states_count
suffix:semicolon
id|other_states_count
op_assign
id|state-&gt;chans_num
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* except PCM L/R channels */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|other_states_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|s
op_assign
id|state-&gt;other_states
(braket
id|i
)braket
suffix:semicolon
id|dealloc_dmabuf
c_func
(paren
op_amp
id|s-&gt;dmabuf
comma
id|card-&gt;pci_dev
)paren
suffix:semicolon
id|ali_disable_special_channel
c_func
(paren
id|s-&gt;card
comma
id|s-&gt;dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|state-&gt;card
op_member_access_from_pointer
id|free_pcm_channel
c_func
(paren
id|s-&gt;card
comma
id|s-&gt;dmabuf.channel-&gt;num
)paren
suffix:semicolon
id|card-&gt;states
(braket
id|s-&gt;virt
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
)brace
DECL|variable|res
r_static
r_struct
id|proc_dir_entry
op_star
id|res
suffix:semicolon
r_static
r_int
DECL|function|ali_write_proc
id|ali_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
(paren
r_struct
id|trident_card
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|buffer
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_PCM_TO_SPDIF_OUT
)paren
suffix:semicolon
id|ali_disable_special_channel
c_func
(paren
id|card
comma
id|ALI_SPDIF_OUT_CHANNEL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;1&squot;
suffix:colon
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_SPDIF_OUT_TO_SPDIF_OUT
op_or
id|ALI_SPDIF_OUT_PCM
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;2&squot;
suffix:colon
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_SPDIF_OUT_TO_SPDIF_OUT
op_or
id|ALI_SPDIF_OUT_NON_PCM
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;3&squot;
suffix:colon
id|ali_disable_spdif_in
c_func
(paren
id|card
)paren
suffix:semicolon
singleline_comment|//default
r_break
suffix:semicolon
r_case
l_char|&squot;4&squot;
suffix:colon
id|ali_setup_spdif_in
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* OSS /dev/mixer file operation methods */
r_static
r_int
DECL|function|trident_open_mixdev
id|trident_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
id|devs
suffix:semicolon
id|card
op_ne
l_int|NULL
suffix:semicolon
id|card
op_assign
id|card-&gt;next
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_AC97
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_ne
l_int|NULL
op_logical_and
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
op_eq
id|minor
)paren
r_goto
id|match
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|match
suffix:colon
id|file-&gt;private_data
op_assign
id|card-&gt;ac97_codec
(braket
id|i
)braket
suffix:semicolon
r_return
id|nonseekable_open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_ioctl_mixdev
id|trident_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
op_assign
(paren
r_struct
id|ac97_codec
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_return
id|codec
op_member_access_from_pointer
id|mixer_ioctl
c_func
(paren
id|codec
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|trident_mixer_fops
r_static
multiline_comment|/*const */
r_struct
id|file_operations
id|trident_mixer_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|ioctl
op_assign
id|trident_ioctl_mixdev
comma
dot
id|open
op_assign
id|trident_open_mixdev
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|ali_reset_5451
id|ali_reset_5451
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci_dev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|dwVal
suffix:semicolon
r_int
r_int
id|wCount
comma
id|wReg
suffix:semicolon
id|pci_dev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M1533
comma
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
l_int|0x7c
comma
op_amp
id|dwVal
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
l_int|0x7c
comma
id|dwVal
op_or
l_int|0x08000000
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
l_int|0x7c
comma
op_amp
id|dwVal
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
l_int|0x7c
comma
id|dwVal
op_amp
l_int|0xf7ffffff
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
id|pci_dev
op_assign
id|card-&gt;pci_dev
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
l_int|0x44
comma
op_amp
id|dwVal
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
l_int|0x44
comma
id|dwVal
op_or
l_int|0x000c0000
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
l_int|0x44
comma
op_amp
id|dwVal
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
l_int|0x44
comma
id|dwVal
op_amp
l_int|0xfffbffff
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
multiline_comment|/* TODO: recognize if we have a PM capable codec and only do this */
multiline_comment|/* if the codec is PM capable */
id|wCount
op_assign
l_int|2000
suffix:semicolon
r_while
c_loop
(paren
id|wCount
op_decrement
)paren
(brace
id|wReg
op_assign
id|ali_ac97_get
c_func
(paren
id|card
comma
l_int|0
comma
id|AC97_POWER_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wReg
op_amp
l_int|0x000f
)paren
op_eq
l_int|0x000f
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|5000
)paren
suffix:semicolon
)brace
multiline_comment|/* This is non fatal if you have a non PM capable codec.. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* AC97 codec initialisation. */
r_static
r_int
id|__devinit
DECL|function|trident_ac97_init
id|trident_ac97_init
c_func
(paren
r_struct
id|trident_card
op_star
id|card
)paren
(brace
r_int
id|num_ac97
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ready_2nd
op_assign
l_int|0
suffix:semicolon
r_struct
id|ac97_codec
op_star
id|codec
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize controller side of AC link, and find out if secondary codes&n;&t;   really exist */
r_switch
c_cond
(paren
id|card-&gt;pci_id
)paren
(brace
r_case
id|PCI_DEVICE_ID_ALI_5451
suffix:colon
r_if
c_cond
(paren
id|ali_reset_5451
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident_ac97_init: error &quot;
l_string|&quot;resetting 5451.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|outl
c_func
(paren
l_int|0x80000001
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000000
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINTEN_A
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xffffffff
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_AINT_A
)paren
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00000000
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MUSICVOL_WAVEVOL
)paren
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x10
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_MPUR2
)paren
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
l_int|0x3fff
suffix:semicolon
id|outl
c_func
(paren
id|ready_2nd
op_or
id|PCMOUT
op_or
l_int|0x8000
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_SCTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|SI_AC97_SECONDARY_READY
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;revision
OL
id|ALI_5451_V02
)paren
id|ready_2nd
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_SI_7018
suffix:colon
multiline_comment|/* disable AC97 GPIO interrupt */
id|outl
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_AC97_GPIO
)paren
)paren
suffix:semicolon
multiline_comment|/* when power up the AC link is in cold reset mode so stop it */
id|outl
c_func
(paren
id|PCMOUT
op_or
id|SURROUT
op_or
id|CENTEROUT
op_or
id|LFEOUT
op_or
id|SECONDARY_ID
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_SERIAL_INTF_CTRL
)paren
)paren
suffix:semicolon
multiline_comment|/* it take a long time to recover from a cold reset */
multiline_comment|/* (especially when you have more than one codec) */
id|udelay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_SERIAL_INTF_CTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|SI_AC97_SECONDARY_READY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_DX
suffix:colon
multiline_comment|/* playback on */
id|outl
c_func
(paren
id|DX_AC97_PLAYBACK
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|DX_ACR2_AC97_COM_STAT
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_TRIDENT_4DWAVE_NX
suffix:colon
multiline_comment|/* enable AC97 Output Slot 3,4 (PCM Left/Right Playback) */
id|outl
c_func
(paren
id|NX_AC97_PCM_OUTPUT
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|NX_ACR0_AC97_COM_STAT
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|NX_AC97_SECONDARY_READY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_INTERG_5050
suffix:colon
multiline_comment|/* disable AC97 GPIO interrupt */
id|outl
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_AC97_GPIO
)paren
)paren
suffix:semicolon
multiline_comment|/* when power up, the AC link is in cold reset mode, so stop it */
id|outl
c_func
(paren
id|PCMOUT
op_or
id|SURROUT
op_or
id|CENTEROUT
op_or
id|LFEOUT
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_SERIAL_INTF_CTRL
)paren
)paren
suffix:semicolon
multiline_comment|/* it take a long time to recover from a cold reset (especially */
multiline_comment|/* when you have more than one codec) */
id|udelay
c_func
(paren
l_int|2000
)paren
suffix:semicolon
id|ready_2nd
op_assign
id|inl
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|SI_SERIAL_INTF_CTRL
)paren
)paren
suffix:semicolon
id|ready_2nd
op_and_assign
id|SI_AC97_SECONDARY_READY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|num_ac97
op_assign
l_int|0
suffix:semicolon
id|num_ac97
OL
id|NR_AC97
suffix:semicolon
id|num_ac97
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|codec
op_assign
id|ac97_alloc_codec
c_func
(paren
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* initialize some basic codec information, other fields */
multiline_comment|/* will be filled in ac97_probe_codec */
id|codec-&gt;private_data
op_assign
id|card
suffix:semicolon
id|codec-&gt;id
op_assign
id|num_ac97
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
id|codec-&gt;codec_read
op_assign
id|ali_ac97_read
suffix:semicolon
id|codec-&gt;codec_write
op_assign
id|ali_ac97_write
suffix:semicolon
)brace
r_else
(brace
id|codec-&gt;codec_read
op_assign
id|trident_ac97_get
suffix:semicolon
id|codec-&gt;codec_write
op_assign
id|trident_ac97_set
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ac97_probe_codec
c_func
(paren
id|codec
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|codec-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|trident_mixer_fops
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|codec-&gt;dev_mixer
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: couldn&squot;t register mixer!&bslash;n&quot;
)paren
suffix:semicolon
id|ac97_release_codec
c_func
(paren
id|codec
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card-&gt;ac97_codec
(braket
id|num_ac97
)braket
op_assign
id|codec
suffix:semicolon
multiline_comment|/* if there is no secondary codec at all, don&squot;t probe any more */
r_if
c_cond
(paren
op_logical_neg
id|ready_2nd
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
r_for
c_loop
(paren
id|num_ac97
op_assign
l_int|0
suffix:semicolon
id|num_ac97
OL
id|NR_AC97
suffix:semicolon
id|num_ac97
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;ac97_codec
(braket
id|num_ac97
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u16
id|reg
op_assign
id|ali_ac97_get
c_func
(paren
id|card
comma
id|num_ac97
comma
id|i
op_star
l_int|2
)paren
suffix:semicolon
id|card-&gt;mixer_regs
(braket
id|i
)braket
(braket
id|num_ac97
)braket
op_assign
id|reg
suffix:semicolon
)brace
)brace
)brace
r_return
id|num_ac97
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Gameport functions for the cards ADC gameport */
r_static
r_int
r_char
DECL|function|trident_game_read
id|trident_game_read
c_func
(paren
r_struct
id|gameport
op_star
id|gameport
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|gameport-&gt;driver
suffix:semicolon
r_return
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_GAME_LEG
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|trident_game_trigger
id|trident_game_trigger
c_func
(paren
r_struct
id|gameport
op_star
id|gameport
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|gameport-&gt;driver
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_GAME_LEG
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_game_cooked_read
id|trident_game_cooked_read
c_func
(paren
r_struct
id|gameport
op_star
id|gameport
comma
r_int
op_star
id|axes
comma
r_int
op_star
id|buttons
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|gameport-&gt;driver
suffix:semicolon
r_int
id|i
suffix:semicolon
op_star
id|buttons
op_assign
(paren
op_complement
id|inb
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_GAME_LEG
)paren
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|axes
(braket
id|i
)braket
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_GAME_AXD
)paren
op_plus
id|i
op_star
r_sizeof
(paren
id|u16
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|axes
(braket
id|i
)braket
op_eq
l_int|0xffff
)paren
id|axes
(braket
id|i
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|trident_game_open
id|trident_game_open
c_func
(paren
r_struct
id|gameport
op_star
id|gameport
comma
r_int
id|mode
)paren
(brace
r_struct
id|trident_card
op_star
id|card
op_assign
id|gameport-&gt;driver
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|GAMEPORT_MODE_COOKED
suffix:colon
id|outb
c_func
(paren
l_int|0x80
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_GAME_CR
)paren
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|20
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|GAMEPORT_MODE_RAW
suffix:colon
id|outb
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_GAME_CR
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* install the driver, we do not allocate hardware channel nor DMA buffer */
multiline_comment|/* now, they are defered until &quot;ACCESS&quot; time (in prog_dmabuf called by */
multiline_comment|/* open/read/write/ioctl/mmap) */
r_static
r_int
id|__devinit
DECL|function|trident_probe
id|trident_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pci_id
)paren
(brace
r_int
r_int
id|iobase
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
suffix:semicolon
id|u8
id|bits
suffix:semicolon
id|u8
id|revision
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|u16
id|temp
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci_dev_m1533
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|u64
id|dma_mask
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev-&gt;device
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
id|dma_mask
op_assign
id|ALI_DMA_MASK
suffix:semicolon
r_else
id|dma_mask
op_assign
id|TRIDENT_DMA_MASK
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pci_dev
comma
id|dma_mask
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: architecture does not support&quot;
l_string|&quot; %s PCI busmaster DMA&bslash;n&quot;
comma
id|pci_dev-&gt;device
op_eq
id|PCI_DEVICE_ID_ALI_5451
ques
c_cond
l_string|&quot;32-bit&quot;
suffix:colon
l_string|&quot;30-bit&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_id-&gt;device
op_eq
id|PCI_DEVICE_ID_INTERG_5050
)paren
id|iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|1
)paren
suffix:semicolon
r_else
id|iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|iobase
comma
l_int|256
comma
id|card_names
(braket
id|pci_id-&gt;driver_data
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: can&squot;t allocate I/O space at &quot;
l_string|&quot;0x%4.4lx&bslash;n&quot;
comma
id|iobase
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|card
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_release_region
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|card
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|card-&gt;timer
)paren
suffix:semicolon
id|card-&gt;iobase
op_assign
id|iobase
suffix:semicolon
id|card-&gt;pci_dev
op_assign
id|pci_dev
suffix:semicolon
id|card-&gt;pci_id
op_assign
id|pci_id-&gt;device
suffix:semicolon
id|card-&gt;revision
op_assign
id|revision
suffix:semicolon
id|card-&gt;irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
id|card-&gt;next
op_assign
id|devs
suffix:semicolon
id|card-&gt;magic
op_assign
id|TRIDENT_CARD_MAGIC
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_A
)braket
dot
id|addresses
op_assign
op_amp
id|bank_a_addrs
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_A
)braket
dot
id|bitmap
op_assign
l_int|0UL
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_B
)braket
dot
id|addresses
op_assign
op_amp
id|bank_b_addrs
suffix:semicolon
id|card-&gt;banks
(braket
id|BANK_B
)braket
dot
id|bitmap
op_assign
l_int|0UL
suffix:semicolon
id|card-&gt;gameport.driver
op_assign
id|card
suffix:semicolon
id|card-&gt;gameport.fuzz
op_assign
l_int|64
suffix:semicolon
id|card-&gt;gameport.read
op_assign
id|trident_game_read
suffix:semicolon
id|card-&gt;gameport.trigger
op_assign
id|trident_game_trigger
suffix:semicolon
id|card-&gt;gameport.cooked_read
op_assign
id|trident_game_cooked_read
suffix:semicolon
id|card-&gt;gameport.open
op_assign
id|trident_game_open
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|card-&gt;open_sem
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|card-&gt;timer
)paren
suffix:semicolon
id|devs
op_assign
id|card
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;trident: %s found at IO 0x%04lx, IRQ %d&bslash;n&quot;
comma
id|card_names
(braket
id|pci_id-&gt;driver_data
)braket
comma
id|card-&gt;iobase
comma
id|card-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
multiline_comment|/* ALi channel Management */
id|card-&gt;alloc_pcm_channel
op_assign
id|ali_alloc_pcm_channel
suffix:semicolon
id|card-&gt;alloc_rec_pcm_channel
op_assign
id|ali_alloc_rec_pcm_channel
suffix:semicolon
id|card-&gt;free_pcm_channel
op_assign
id|ali_free_pcm_channel
suffix:semicolon
id|card-&gt;address_interrupt
op_assign
id|ali_address_interrupt
suffix:semicolon
multiline_comment|/* Added by Matt Wu 01-05-2001 for spdif in */
id|card-&gt;multi_channel_use_count
op_assign
l_int|0
suffix:semicolon
id|card-&gt;rec_channel_use_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ALi SPDIF OUT function */
r_if
c_cond
(paren
id|card-&gt;revision
op_eq
id|ALI_5451_V02
)paren
(brace
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_PCM_TO_SPDIF_OUT
)paren
suffix:semicolon
id|res
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;ALi5451&quot;
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|res-&gt;write_proc
op_assign
id|ali_write_proc
suffix:semicolon
id|res-&gt;data
op_assign
id|card
suffix:semicolon
)brace
)brace
multiline_comment|/* Add H/W Volume Control By Matt Wu Jul. 06, 2001 */
id|card-&gt;hwvolctl
op_assign
l_int|0
suffix:semicolon
id|pci_dev_m1533
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_AL
comma
id|PCI_DEVICE_ID_AL_M1533
comma
id|pci_dev_m1533
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|pci_dev_m1533
op_eq
l_int|NULL
)paren
r_goto
id|out_proc_fs
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev_m1533
comma
l_int|0x63
comma
op_amp
id|bits
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits
op_amp
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
id|card-&gt;hwvolctl
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;hwvolctl
)paren
(brace
multiline_comment|/* Clear m1533 pci cfg 78h bit 30 to zero, which makes&n;&t;&t;&t;   GPIO11/12/13 work as ACGP_UP/DOWN/MUTE. */
id|pci_read_config_byte
c_func
(paren
id|pci_dev_m1533
comma
l_int|0x7b
comma
op_amp
id|bits
)paren
suffix:semicolon
id|bits
op_and_assign
l_int|0xbf
suffix:semicolon
multiline_comment|/*clear bit 6 */
id|pci_write_config_byte
c_func
(paren
id|pci_dev_m1533
comma
l_int|0x7b
comma
id|bits
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_INTERG_5050
)paren
(brace
id|card-&gt;alloc_pcm_channel
op_assign
id|cyber_alloc_pcm_channel
suffix:semicolon
id|card-&gt;alloc_rec_pcm_channel
op_assign
id|cyber_alloc_pcm_channel
suffix:semicolon
id|card-&gt;free_pcm_channel
op_assign
id|cyber_free_pcm_channel
suffix:semicolon
id|card-&gt;address_interrupt
op_assign
id|cyber_address_interrupt
suffix:semicolon
id|cyber_init_ritual
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;alloc_pcm_channel
op_assign
id|trident_alloc_pcm_channel
suffix:semicolon
id|card-&gt;alloc_rec_pcm_channel
op_assign
id|trident_alloc_pcm_channel
suffix:semicolon
id|card-&gt;free_pcm_channel
op_assign
id|trident_free_pcm_channel
suffix:semicolon
id|card-&gt;address_interrupt
op_assign
id|trident_address_interrupt
suffix:semicolon
)brace
multiline_comment|/* claim our irq */
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
op_amp
id|trident_interrupt
comma
id|SA_SHIRQ
comma
id|card_names
(braket
id|pci_id-&gt;driver_data
)braket
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: unable to allocate irq %d&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
r_goto
id|out_proc_fs
suffix:semicolon
)brace
multiline_comment|/* register /dev/dsp */
r_if
c_cond
(paren
(paren
id|card-&gt;dev_audio
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|trident_audio_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;trident: couldn&squot;t register DSP device!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_free_irq
suffix:semicolon
)brace
id|card-&gt;mixer_regs_ready
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize AC97 codec and register /dev/mixer */
r_if
c_cond
(paren
id|trident_ac97_init
c_func
(paren
id|card
)paren
op_le
l_int|0
)paren
(brace
multiline_comment|/* unregister audio devices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_AC97
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
op_assign
id|card-&gt;ac97_codec
(braket
id|i
)braket
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|codec-&gt;dev_mixer
)paren
suffix:semicolon
id|ac97_release_codec
c_func
(paren
id|codec
)paren
suffix:semicolon
)brace
)brace
r_goto
id|out_unregister_sound_dsp
suffix:semicolon
)brace
id|card-&gt;mixer_regs_ready
op_assign
l_int|1
suffix:semicolon
id|outl
c_func
(paren
l_int|0x00
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MUSICVOL_WAVEVOL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
multiline_comment|/* Add H/W Volume Control By Matt Wu Jul. 06, 2001 */
r_if
c_cond
(paren
id|card-&gt;hwvolctl
)paren
(brace
multiline_comment|/* Enable GPIO IRQ (MISCINT bit 18h) */
id|temp
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
op_plus
l_int|2
)paren
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x0004
suffix:semicolon
id|outw
c_func
(paren
id|temp
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|T4D_MISCINT
op_plus
l_int|2
)paren
)paren
suffix:semicolon
multiline_comment|/* Enable H/W Volume Control GLOVAL CONTROL bit 0 */
id|temp
op_assign
id|inw
c_func
(paren
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
id|temp
op_or_assign
l_int|0x0001
suffix:semicolon
id|outw
c_func
(paren
id|temp
comma
id|TRID_REG
c_func
(paren
id|card
comma
id|ALI_GLOBAL_CONTROL
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;revision
op_eq
id|ALI_5451_V02
)paren
id|ali_close_multi_channels
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* edited by HMSEO for GT sound */
macro_line|#if defined(CONFIG_ALPHA_NAUTILUS) || defined(CONFIG_ALPHA_GENERIC)
(brace
id|u16
id|ac97_data
suffix:semicolon
r_extern
r_struct
id|hwrpb_struct
op_star
id|hwrpb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hwrpb-&gt;sys_type
)paren
op_eq
l_int|201
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;trident: Running on Alpha system &quot;
l_string|&quot;type Nautilus&bslash;n&quot;
)paren
suffix:semicolon
id|ac97_data
op_assign
id|ali_ac97_get
c_func
(paren
id|card
comma
l_int|0
comma
id|AC97_POWER_CONTROL
)paren
suffix:semicolon
id|ali_ac97_set
c_func
(paren
id|card
comma
l_int|0
comma
id|AC97_POWER_CONTROL
comma
id|ac97_data
op_or
id|ALI_EAPD_POWER_DOWN
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_ALPHA_NAUTILUS || CONFIG_ALPHA_GENERIC */
multiline_comment|/* edited by HMSEO for GT sound */
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
id|card
)paren
suffix:semicolon
multiline_comment|/* Enable Address Engine Interrupts */
id|trident_enable_loop_interrupts
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* Register gameport */
id|gameport_register_port
c_func
(paren
op_amp
id|card-&gt;gameport
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
id|out_unregister_sound_dsp
suffix:colon
id|unregister_sound_dsp
c_func
(paren
id|card-&gt;dev_audio
)paren
suffix:semicolon
id|out_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|out_proc_fs
suffix:colon
r_if
c_cond
(paren
id|res
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;ALi5451&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|res
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
id|devs
op_assign
l_int|NULL
suffix:semicolon
id|out_release_region
suffix:colon
id|release_region
c_func
(paren
id|iobase
comma
l_int|256
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
id|__devexit
DECL|function|trident_remove
id|trident_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|trident_card
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      Kill running timers before unload. We can&squot;t have them&n;&t; *      going off after rmmod!&n;&t; */
r_if
c_cond
(paren
id|card-&gt;hwvolctl
)paren
id|del_timer_sync
c_func
(paren
op_amp
id|card-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* ALi S/PDIF and Power Management */
r_if
c_cond
(paren
id|card-&gt;pci_id
op_eq
id|PCI_DEVICE_ID_ALI_5451
)paren
(brace
id|ali_setup_spdif_out
c_func
(paren
id|card
comma
id|ALI_PCM_TO_SPDIF_OUT
)paren
suffix:semicolon
id|ali_disable_special_channel
c_func
(paren
id|card
comma
id|ALI_SPDIF_OUT_CHANNEL
)paren
suffix:semicolon
id|ali_disable_spdif_in
c_func
(paren
id|card
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;ALi5451&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Unregister gameport */
id|gameport_unregister_port
c_func
(paren
op_amp
id|card-&gt;gameport
)paren
suffix:semicolon
multiline_comment|/* Kill interrupts, and SP/DIF */
id|trident_disable_loop_interrupts
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* free hardware resources */
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|card-&gt;iobase
comma
l_int|256
)paren
suffix:semicolon
multiline_comment|/* unregister audio devices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_AC97
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|unregister_sound_mixer
c_func
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
op_member_access_from_pointer
id|dev_mixer
)paren
suffix:semicolon
id|ac97_release_codec
c_func
(paren
id|card-&gt;ac97_codec
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|unregister_sound_dsp
c_func
(paren
id|card-&gt;dev_audio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alan Cox, Aaron Holtzman, Ollie Lho, Ching Ling Lee, Muli Ben-Yehuda&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Trident 4DWave/SiS 7018/ALi 5451 and Tvia/IGST CyberPro5050 PCI &quot;
l_string|&quot;Audio Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|TRIDENT_MODULE_NAME
mdefine_line|#define TRIDENT_MODULE_NAME &quot;trident&quot;
DECL|variable|trident_pci_driver
r_static
r_struct
id|pci_driver
id|trident_pci_driver
op_assign
(brace
dot
id|name
op_assign
id|TRIDENT_MODULE_NAME
comma
dot
id|id_table
op_assign
id|trident_pci_tbl
comma
dot
id|probe
op_assign
id|trident_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|trident_remove
)paren
comma
dot
id|suspend
op_assign
id|trident_suspend
comma
dot
id|resume
op_assign
id|trident_resume
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|trident_init_module
id|trident_init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Trident 4DWave/SiS 7018/ALi 5451,Tvia CyberPro &quot;
l_string|&quot;5050 PCI Audio, version &quot;
id|DRIVER_VERSION
l_string|&quot;, &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pci_register_driver
c_func
(paren
op_amp
id|trident_pci_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|trident_cleanup_module
id|trident_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|trident_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|trident_init_module
id|module_init
c_func
(paren
id|trident_init_module
)paren
suffix:semicolon
DECL|variable|trident_cleanup_module
id|module_exit
c_func
(paren
id|trident_cleanup_module
)paren
suffix:semicolon
eof
