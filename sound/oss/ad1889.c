multiline_comment|/*&n; *  Copyright 2001-2004 Randolph Chung &lt;tausq@debian.org&gt;&n; *&n; *  Analog Devices 1889 PCI audio driver (AD1819 AC97-compatible codec)&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *   Notes:&n; *   1. Only flat DMA is supported; s-g is not supported right now&n; *&n; *&n;&lt;jsm&gt; tausq: Anyway, to set up sample rates for D to A, you just use the sample rate on the codec. For A to D, you need to set the codec always to 48K (using the split sample rate feature on the codec) and then set the resampler on the AD1889 to the sample rate you want.&n;&lt;jsm&gt; Also, when changing the sample rate on the codec you need to power it down and re power it up for the change to take effect!&n; *&n; * $Id: ad1889.c,v 1.3 2002/10/19 21:31:44 grundler Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/ac97_codec.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;ad1889.h&quot;
DECL|macro|DBG
mdefine_line|#define DBG(fmt, arg...) printk(fmt, ##arg)
DECL|macro|DEVNAME
mdefine_line|#define DEVNAME &quot;ad1889&quot;
DECL|macro|NR_HW_CH
mdefine_line|#define NR_HW_CH&t;4
DECL|macro|DAC_RUNNING
mdefine_line|#define DAC_RUNNING&t;1
DECL|macro|ADC_RUNNING
mdefine_line|#define ADC_RUNNING&t;2
DECL|macro|UNDERRUN
mdefine_line|#define UNDERRUN(dev)&t;(0)
DECL|macro|AD1889_READW
mdefine_line|#define AD1889_READW(dev,reg) readw(dev-&gt;regbase + reg)
DECL|macro|AD1889_WRITEW
mdefine_line|#define AD1889_WRITEW(dev,reg,val) writew((val), dev-&gt;regbase + reg)
DECL|macro|AD1889_READL
mdefine_line|#define AD1889_READL(dev,reg) readl(dev-&gt;regbase + reg)
DECL|macro|AD1889_WRITEL
mdefine_line|#define AD1889_WRITEL(dev,reg,val) writel((val), dev-&gt;regbase + reg)
singleline_comment|//now 100ms
multiline_comment|/* #define WAIT_10MS()&t;schedule_timeout(HZ/10) */
DECL|macro|WAIT_10MS
mdefine_line|#define WAIT_10MS()&t;do { int __i; for (__i = 0; __i &lt; 100; __i++) udelay(1000); } while(0)
multiline_comment|/* currently only support a single device */
DECL|variable|ad1889_dev
r_static
id|ad1889_dev_t
op_star
id|ad1889_dev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/************************* helper routines ***************************** */
DECL|function|ad1889_set_wav_rate
r_static
r_inline
r_void
id|ad1889_set_wav_rate
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
comma
r_int
id|rate
)paren
(brace
r_struct
id|ac97_codec
op_star
id|ac97_codec
op_assign
id|dev-&gt;ac97_codec
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;Setting WAV rate to %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
dot
id|dmabuf.rate
op_assign
id|rate
suffix:semicolon
id|AD1889_WRITEW
c_func
(paren
id|dev
comma
id|AD_DSWAS
comma
id|rate
)paren
suffix:semicolon
multiline_comment|/* Cycle the DAC to enable the new rate */
id|ac97_codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|dev-&gt;ac97_codec
comma
id|AC97_POWER_CONTROL
comma
l_int|0x0200
)paren
suffix:semicolon
id|WAIT_10MS
c_func
(paren
)paren
suffix:semicolon
id|ac97_codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|dev-&gt;ac97_codec
comma
id|AC97_POWER_CONTROL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ad1889_set_adc_rate
r_static
r_inline
r_void
id|ad1889_set_adc_rate
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
comma
r_int
id|rate
)paren
(brace
r_struct
id|ac97_codec
op_star
id|ac97_codec
op_assign
id|dev-&gt;ac97_codec
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;Setting ADC rate to %d&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
id|dev-&gt;state
(braket
id|AD_ADC_STATE
)braket
dot
id|dmabuf.rate
op_assign
id|rate
suffix:semicolon
id|AD1889_WRITEW
c_func
(paren
id|dev
comma
id|AD_DSRES
comma
id|rate
)paren
suffix:semicolon
multiline_comment|/* Cycle the ADC to enable the new rate */
id|ac97_codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|dev-&gt;ac97_codec
comma
id|AC97_POWER_CONTROL
comma
l_int|0x0100
)paren
suffix:semicolon
id|WAIT_10MS
c_func
(paren
)paren
suffix:semicolon
id|ac97_codec
op_member_access_from_pointer
id|codec_write
c_func
(paren
id|dev-&gt;ac97_codec
comma
id|AC97_POWER_CONTROL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|ad1889_set_wav_fmt
r_static
r_inline
r_void
id|ad1889_set_wav_fmt
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
comma
r_int
id|fmt
)paren
(brace
id|u16
id|tmp
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;Setting WAV format to 0x%x&bslash;n&quot;
comma
id|fmt
)paren
suffix:semicolon
id|tmp
op_assign
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fmt
op_amp
id|AFMT_S16_LE
)paren
(brace
singleline_comment|//tmp |= 0x0100; /* set WA16 */
id|tmp
op_or_assign
l_int|0x0300
suffix:semicolon
multiline_comment|/* set WA16 stereo */
)brace
r_else
r_if
c_cond
(paren
id|fmt
op_amp
id|AFMT_U8
)paren
(brace
id|tmp
op_and_assign
op_complement
l_int|0x0100
suffix:semicolon
multiline_comment|/* clear WA16 */
)brace
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
comma
id|tmp
)paren
suffix:semicolon
)brace
DECL|function|ad1889_set_adc_fmt
r_static
r_inline
r_void
id|ad1889_set_adc_fmt
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
comma
r_int
id|fmt
)paren
(brace
id|u16
id|tmp
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;Setting ADC format to 0x%x&bslash;n&quot;
comma
id|fmt
)paren
suffix:semicolon
id|tmp
op_assign
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSRAMC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fmt
op_amp
id|AFMT_S16_LE
)paren
(brace
id|tmp
op_or_assign
l_int|0x0100
suffix:semicolon
multiline_comment|/* set WA16 */
)brace
r_else
r_if
c_cond
(paren
id|fmt
op_amp
id|AFMT_U8
)paren
(brace
id|tmp
op_and_assign
op_complement
l_int|0x0100
suffix:semicolon
multiline_comment|/* clear WA16 */
)brace
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSRAMC
comma
id|tmp
)paren
suffix:semicolon
)brace
DECL|function|ad1889_start_wav
r_static
r_void
id|ad1889_start_wav
c_func
(paren
id|ad1889_state_t
op_star
id|state
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|u16
id|tmp
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;dma_len
)paren
multiline_comment|/* DMA already in flight */
r_goto
id|skip_dma
suffix:semicolon
multiline_comment|/* setup dma */
id|cnt
op_assign
id|dmabuf-&gt;wr_ptr
op_minus
id|dmabuf-&gt;rd_ptr
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_eq
l_int|0
)paren
multiline_comment|/* done - don&squot;t need to do anything */
r_goto
id|skip_dma
suffix:semicolon
multiline_comment|/* If the wr_ptr has wrapped, only map to the end */
r_if
c_cond
(paren
id|cnt
OL
l_int|0
)paren
id|cnt
op_assign
id|DMA_SIZE
op_minus
id|dmabuf-&gt;rd_ptr
suffix:semicolon
id|dmabuf-&gt;dma_handle
op_assign
id|pci_map_single
c_func
(paren
id|ad1889_dev-&gt;pci
comma
id|dmabuf-&gt;rawbuf
op_plus
id|dmabuf-&gt;rd_ptr
comma
id|cnt
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dmabuf-&gt;dma_len
op_assign
id|cnt
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|1
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;Starting playback at 0x%p for %ld bytes&bslash;n&quot;
comma
id|dmabuf-&gt;rawbuf
op_plus
id|dmabuf-&gt;rd_ptr
comma
id|dmabuf-&gt;dma_len
)paren
suffix:semicolon
multiline_comment|/* load up the current register set */
id|AD1889_WRITEL
c_func
(paren
id|ad1889_dev
comma
id|AD_DMAWAVCC
comma
id|cnt
)paren
suffix:semicolon
id|AD1889_WRITEL
c_func
(paren
id|ad1889_dev
comma
id|AD_DMAWAVICC
comma
id|cnt
)paren
suffix:semicolon
id|AD1889_WRITEL
c_func
(paren
id|ad1889_dev
comma
id|AD_DMAWAVCA
comma
id|dmabuf-&gt;dma_handle
)paren
suffix:semicolon
multiline_comment|/* TODO: for now we load the base registers with the same thing */
id|AD1889_WRITEL
c_func
(paren
id|ad1889_dev
comma
id|AD_DMAWAVBC
comma
id|cnt
)paren
suffix:semicolon
id|AD1889_WRITEL
c_func
(paren
id|ad1889_dev
comma
id|AD_DMAWAVIBC
comma
id|cnt
)paren
suffix:semicolon
id|AD1889_WRITEL
c_func
(paren
id|ad1889_dev
comma
id|AD_DMAWAVBA
comma
id|dmabuf-&gt;dma_handle
)paren
suffix:semicolon
multiline_comment|/* and we&squot;re off to the races... */
id|AD1889_WRITEL
c_func
(paren
id|ad1889_dev
comma
id|AD_DMACHSS
comma
l_int|0x8
)paren
suffix:semicolon
id|tmp
op_assign
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
)paren
suffix:semicolon
id|tmp
op_or_assign
l_int|0x0400
suffix:semicolon
multiline_comment|/* set WAEN */
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
comma
id|tmp
)paren
suffix:semicolon
(paren
r_void
)paren
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
)paren
suffix:semicolon
multiline_comment|/* flush posted PCI write */
id|dmabuf-&gt;enable
op_or_assign
id|DAC_RUNNING
suffix:semicolon
id|skip_dma
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ad1889_stop_wav
r_static
r_void
id|ad1889_stop_wav
c_func
(paren
id|ad1889_state_t
op_star
id|state
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;enable
op_amp
id|DAC_RUNNING
)paren
(brace
id|u16
id|tmp
suffix:semicolon
r_int
r_int
id|cnt
op_assign
id|dmabuf-&gt;dma_len
suffix:semicolon
id|tmp
op_assign
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
l_int|0x0400
suffix:semicolon
multiline_comment|/* clear WAEN */
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
comma
id|tmp
)paren
suffix:semicolon
(paren
r_void
)paren
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
)paren
suffix:semicolon
multiline_comment|/* flush posted PCI write */
id|pci_unmap_single
c_func
(paren
id|ad1889_dev-&gt;pci
comma
id|dmabuf-&gt;dma_handle
comma
id|cnt
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|dmabuf-&gt;enable
op_and_assign
op_complement
id|DAC_RUNNING
suffix:semicolon
multiline_comment|/* update dma pointers */
id|dmabuf-&gt;rd_ptr
op_add_assign
id|cnt
suffix:semicolon
id|dmabuf-&gt;rd_ptr
op_and_assign
(paren
id|DMA_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|dmabuf-&gt;dma_handle
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;dma_len
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|ad1889_startstop_adc
c_func
(paren
id|ad1889_state_t
op_star
id|state
comma
r_int
id|start
)paren
(brace
id|u16
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSRAMC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start
)paren
(brace
id|state-&gt;dmabuf.enable
op_or_assign
id|ADC_RUNNING
suffix:semicolon
id|tmp
op_or_assign
l_int|0x0004
suffix:semicolon
multiline_comment|/* set ADEN */
)brace
r_else
(brace
id|state-&gt;dmabuf.enable
op_and_assign
op_complement
id|ADC_RUNNING
suffix:semicolon
id|tmp
op_and_assign
op_complement
l_int|0x0004
suffix:semicolon
multiline_comment|/* clear ADEN */
)brace
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSRAMC
comma
id|tmp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ad1889_alloc_dev
r_static
id|ad1889_dev_t
op_star
id|ad1889_alloc_dev
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
)paren
(brace
id|ad1889_dev_t
op_star
id|dev
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ad1889_dev_t
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
id|ad1889_dev_t
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|dev-&gt;pci
op_assign
id|pci
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AD_MAX_STATES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dev-&gt;state
(braket
id|i
)braket
dot
id|card
op_assign
id|dev
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|dev-&gt;state
(braket
id|i
)braket
dot
id|sem
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev-&gt;state
(braket
id|i
)braket
dot
id|dmabuf.wait
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate dma buffer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AD_MAX_STATES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dmabuf
op_assign
op_amp
id|dev-&gt;state
(braket
id|i
)braket
dot
id|dmabuf
suffix:semicolon
id|dmabuf-&gt;rawbuf
op_assign
id|kmalloc
c_func
(paren
id|DMA_SIZE
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmabuf-&gt;rawbuf
)paren
r_goto
id|err_free_dmabuf
suffix:semicolon
id|dmabuf-&gt;rawbuf_size
op_assign
id|DMA_SIZE
suffix:semicolon
id|dmabuf-&gt;dma_handle
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;rd_ptr
op_assign
id|dmabuf-&gt;wr_ptr
op_assign
id|dmabuf-&gt;dma_len
op_assign
l_int|0UL
suffix:semicolon
id|dmabuf-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|dmabuf-&gt;rate
op_assign
l_int|48000
suffix:semicolon
)brace
r_return
id|dev
suffix:semicolon
id|err_free_dmabuf
suffix:colon
r_while
c_loop
(paren
op_decrement
id|i
op_ge
l_int|0
)paren
id|kfree
c_func
(paren
id|dev-&gt;state
(braket
id|i
)braket
dot
id|dmabuf.rawbuf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ad1889_free_dev
r_static
r_void
id|ad1889_free_dev
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
)paren
(brace
r_int
id|j
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;ac97_codec
)paren
id|ac97_release_codec
c_func
(paren
id|dev-&gt;ac97_codec
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|AD_MAX_STATES
suffix:semicolon
id|j
op_increment
)paren
(brace
id|dmabuf
op_assign
op_amp
id|dev-&gt;state
(braket
id|j
)braket
dot
id|dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;rawbuf
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|dmabuf-&gt;rawbuf
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ad1889_trigger_playback
r_static
r_inline
r_void
id|ad1889_trigger_playback
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
)paren
(brace
macro_line|#if 0
id|u32
id|val
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
dot
id|dmabuf
suffix:semicolon
macro_line|#endif
id|ad1889_start_wav
c_func
(paren
op_amp
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
)paren
suffix:semicolon
)brace
DECL|function|ad1889_read_proc
r_int
id|ad1889_read_proc
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|out
op_assign
id|page
suffix:semicolon
r_int
id|len
comma
id|i
suffix:semicolon
id|ad1889_dev_t
op_star
id|dev
op_assign
id|data
suffix:semicolon
id|ad1889_reg_t
id|regs
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;WSMC&quot;
comma
id|AD_DSWSMC
comma
l_int|16
)brace
comma
(brace
l_string|&quot;RAMC&quot;
comma
id|AD_DSRAMC
comma
l_int|16
)brace
comma
(brace
l_string|&quot;WADA&quot;
comma
id|AD_DSWADA
comma
l_int|16
)brace
comma
(brace
l_string|&quot;SYDA&quot;
comma
id|AD_DSSYDA
comma
l_int|16
)brace
comma
(brace
l_string|&quot;WAS&quot;
comma
id|AD_DSWAS
comma
l_int|16
)brace
comma
(brace
l_string|&quot;RES&quot;
comma
id|AD_DSRES
comma
l_int|16
)brace
comma
(brace
l_string|&quot;CCS&quot;
comma
id|AD_DSCCS
comma
l_int|16
)brace
comma
(brace
l_string|&quot;ADCBA&quot;
comma
id|AD_DMAADCBA
comma
l_int|32
)brace
comma
(brace
l_string|&quot;ADCCA&quot;
comma
id|AD_DMAADCCA
comma
l_int|32
)brace
comma
(brace
l_string|&quot;ADCBC&quot;
comma
id|AD_DMAADCBC
comma
l_int|32
)brace
comma
(brace
l_string|&quot;ADCCC&quot;
comma
id|AD_DMAADCCC
comma
l_int|32
)brace
comma
(brace
l_string|&quot;ADCIBC&quot;
comma
id|AD_DMAADCIBC
comma
l_int|32
)brace
comma
(brace
l_string|&quot;ADCICC&quot;
comma
id|AD_DMAADCICC
comma
l_int|32
)brace
comma
(brace
l_string|&quot;ADCCTRL&quot;
comma
id|AD_DMAADCCTRL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;WAVBA&quot;
comma
id|AD_DMAWAVBA
comma
l_int|32
)brace
comma
(brace
l_string|&quot;WAVCA&quot;
comma
id|AD_DMAWAVCA
comma
l_int|32
)brace
comma
(brace
l_string|&quot;WAVBC&quot;
comma
id|AD_DMAWAVBC
comma
l_int|32
)brace
comma
(brace
l_string|&quot;WAVCC&quot;
comma
id|AD_DMAWAVCC
comma
l_int|32
)brace
comma
(brace
l_string|&quot;WAVIBC&quot;
comma
id|AD_DMAWAVIBC
comma
l_int|32
)brace
comma
(brace
l_string|&quot;WAVICC&quot;
comma
id|AD_DMAWAVICC
comma
l_int|32
)brace
comma
(brace
l_string|&quot;WAVCTRL&quot;
comma
id|AD_DMAWAVCTRL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;DISR&quot;
comma
id|AD_DMADISR
comma
l_int|32
)brace
comma
(brace
l_string|&quot;CHSS&quot;
comma
id|AD_DMACHSS
comma
l_int|32
)brace
comma
(brace
l_string|&quot;IPC&quot;
comma
id|AD_GPIOIPC
comma
l_int|16
)brace
comma
(brace
l_string|&quot;OP&quot;
comma
id|AD_GPIOOP
comma
l_int|16
)brace
comma
(brace
l_string|&quot;IP&quot;
comma
id|AD_GPIOIP
comma
l_int|16
)brace
comma
(brace
l_string|&quot;ACIC&quot;
comma
id|AD_ACIC
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_RESET&quot;
comma
l_int|0x100
op_plus
id|AC97_RESET
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_MASTER_VOL_STEREO&quot;
comma
l_int|0x100
op_plus
id|AC97_MASTER_VOL_STEREO
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_HEADPHONE_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_HEADPHONE_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_MASTER_VOL_MONO&quot;
comma
l_int|0x100
op_plus
id|AC97_MASTER_VOL_MONO
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_MASTER_TONE&quot;
comma
l_int|0x100
op_plus
id|AC97_MASTER_TONE
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_PCBEEP_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_PCBEEP_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_PHONE_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_PHONE_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_MIC_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_MIC_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_LINEIN_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_LINEIN_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_CD_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_CD_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_VIDEO_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_VIDEO_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_AUX_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_AUX_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_PCMOUT_VOL&quot;
comma
l_int|0x100
op_plus
id|AC97_PCMOUT_VOL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_RECORD_SELECT&quot;
comma
l_int|0x100
op_plus
id|AC97_RECORD_SELECT
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_RECORD_GAIN&quot;
comma
l_int|0x100
op_plus
id|AC97_RECORD_GAIN
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_RECORD_GAIN_MIC&quot;
comma
l_int|0x100
op_plus
id|AC97_RECORD_GAIN_MIC
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_GENERAL_PURPOSE&quot;
comma
l_int|0x100
op_plus
id|AC97_GENERAL_PURPOSE
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_3D_CONTROL&quot;
comma
l_int|0x100
op_plus
id|AC97_3D_CONTROL
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_MODEM_RATE&quot;
comma
l_int|0x100
op_plus
id|AC97_MODEM_RATE
comma
l_int|16
)brace
comma
(brace
l_string|&quot;AC97_POWER_CONTROL&quot;
comma
l_int|0x100
op_plus
id|AC97_POWER_CONTROL
comma
l_int|16
)brace
comma
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|regs
(braket
id|i
)braket
dot
id|name
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;%s: 0x%0*x&bslash;n&quot;
comma
id|regs
(braket
id|i
)braket
dot
id|name
comma
id|regs
(braket
id|i
)braket
dot
id|width
op_rshift
l_int|2
comma
(paren
id|regs
(braket
id|i
)braket
dot
id|width
op_eq
l_int|16
ques
c_cond
id|AD1889_READW
c_func
(paren
id|dev
comma
id|regs
(braket
id|i
)braket
dot
id|offset
)paren
suffix:colon
id|AD1889_READL
c_func
(paren
id|dev
comma
id|regs
(braket
id|i
)braket
dot
id|offset
)paren
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|AD_MAX_STATES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;DMA status for %s:&bslash;n&quot;
comma
(paren
id|i
op_eq
id|AD_WAV_STATE
ques
c_cond
l_string|&quot;WAV&quot;
suffix:colon
l_string|&quot;ADC&quot;
)paren
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;t&bslash;t0x%p (IOVA: 0x%llu)&bslash;n&quot;
comma
id|dev-&gt;state
(braket
id|i
)braket
dot
id|dmabuf.rawbuf
comma
(paren
r_int
r_int
r_int
)paren
id|dev-&gt;state
(braket
id|i
)braket
dot
id|dmabuf.dma_handle
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;tread ptr: offset %u&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|dev-&gt;state
(braket
id|i
)braket
dot
id|dmabuf.rd_ptr
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;twrite ptr: offset %u&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|dev-&gt;state
(braket
id|i
)braket
dot
id|dmabuf.wr_ptr
)paren
suffix:semicolon
id|out
op_add_assign
id|sprintf
c_func
(paren
id|out
comma
l_string|&quot;&bslash;tdma len: offset %u&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|dev-&gt;state
(braket
id|i
)braket
dot
id|dmabuf.dma_len
)paren
suffix:semicolon
)brace
id|len
op_assign
id|out
op_minus
id|page
op_minus
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
id|count
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|count
suffix:semicolon
)brace
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/***************************** DMA interfaces ************************** */
macro_line|#if 0
r_static
r_inline
r_int
r_int
id|ad1889_get_dma_addr
c_func
(paren
id|ad1889_state_t
op_star
id|state
)paren
(brace
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|u32
id|offset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dmabuf-&gt;enable
op_amp
(paren
id|DAC_RUNNING
op_or
id|ADC_RUNNING
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: get_dma_addr called without dma enabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dmabuf-&gt;enable
op_amp
id|DAC_RUNNING
)paren
id|offset
op_assign
id|le32_to_cpu
c_func
(paren
id|AD1889_READL
c_func
(paren
id|state-&gt;card
comma
id|AD_DMAWAVBA
)paren
)paren
suffix:semicolon
r_else
id|offset
op_assign
id|le32_to_cpu
c_func
(paren
id|AD1889_READL
c_func
(paren
id|state-&gt;card
comma
id|AD_DMAADCBA
)paren
)paren
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
id|bus_to_virt
c_func
(paren
(paren
r_int
r_int
)paren
id|offset
)paren
op_minus
(paren
r_int
r_int
)paren
id|dmabuf-&gt;rawbuf
suffix:semicolon
)brace
r_static
r_void
id|ad1889_update_ptr
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
comma
r_int
id|wake
)paren
(brace
id|ad1889_state_t
op_star
id|state
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_int
r_int
id|hwptr
suffix:semicolon
r_int
id|diff
suffix:semicolon
multiline_comment|/* check ADC first */
id|state
op_assign
op_amp
id|dev-&gt;adc_state
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;enable
op_amp
id|ADC_RUNNING
)paren
(brace
id|hwptr
op_assign
id|ad1889_get_dma_addr
c_func
(paren
id|state
)paren
suffix:semicolon
id|diff
op_assign
(paren
id|dmabuf-&gt;dmasize
op_plus
id|hwptr
op_minus
id|dmabuf-&gt;hwptr
)paren
op_mod
id|dmabuf-&gt;dmasize
suffix:semicolon
id|dmabuf-&gt;hwptr
op_assign
id|hwptr
suffix:semicolon
id|dmabuf-&gt;total_bytes
op_add_assign
id|diff
suffix:semicolon
id|dmabuf-&gt;count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
OG
id|dmabuf-&gt;dmasize
)paren
id|dmabuf-&gt;count
op_assign
id|dmabuf-&gt;dmasize
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
r_if
c_cond
(paren
id|wake
op_amp
id|dmabuf-&gt;count
op_ge
id|dmabuf-&gt;fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|wake
op_amp
id|dmabuf-&gt;count
OG
l_int|0
)paren
id|wake_up
c_func
(paren
op_amp
id|dmabuf-&gt;wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* check DAC */
id|state
op_assign
op_amp
id|dev-&gt;wav_state
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;enable
op_amp
id|DAC_RUNNING
)paren
(brace
id|XXX
)brace
macro_line|#endif
multiline_comment|/************************* /dev/dsp interfaces ************************* */
DECL|function|ad1889_read
r_static
id|ssize_t
id|ad1889_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1889_write
r_static
id|ssize_t
id|ad1889_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ad1889_dev_t
op_star
id|dev
op_assign
(paren
id|ad1889_dev_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ad1889_state_t
op_star
id|state
op_assign
op_amp
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
suffix:semicolon
r_volatile
r_struct
id|dmabuf
op_star
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|err1
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|count
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|err1
suffix:semicolon
)brace
id|add_wait_queue
c_func
(paren
op_amp
id|state-&gt;dmabuf.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
multiline_comment|/* start filling dma buffer.... */
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_int
id|rem
suffix:semicolon
r_int
id|cnt
op_assign
id|count
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_int
id|used_bytes
suffix:semicolon
r_int
id|timeout
suffix:semicolon
multiline_comment|/* max time for DMA in jiffies */
multiline_comment|/* buffer is full if wr catches up to rd */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|used_bytes
op_assign
id|dmabuf-&gt;wr_ptr
op_minus
id|dmabuf-&gt;rd_ptr
suffix:semicolon
id|timeout
op_assign
(paren
id|dmabuf-&gt;dma_len
op_star
id|HZ
)paren
op_div
id|dmabuf-&gt;rate
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* adjust for buffer wrap around */
id|used_bytes
op_assign
(paren
id|used_bytes
op_plus
id|DMA_SIZE
)paren
op_amp
(paren
id|DMA_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* If at least one page unused */
r_if
c_cond
(paren
id|used_bytes
OL
(paren
id|DMA_SIZE
op_minus
l_int|0x1000
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* dma buffer full */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|err2
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|err2
suffix:semicolon
)brace
)brace
multiline_comment|/* watch out for wrapping around static buffer */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rem
op_assign
id|DMA_SIZE
op_minus
id|dmabuf-&gt;wr_ptr
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|rem
)paren
id|cnt
op_assign
id|rem
suffix:semicolon
id|rem
op_assign
id|dmabuf-&gt;wr_ptr
suffix:semicolon
multiline_comment|/* update dma pointers */
id|dmabuf-&gt;wr_ptr
op_add_assign
id|cnt
suffix:semicolon
id|dmabuf-&gt;wr_ptr
op_and_assign
id|DMA_SIZE
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* wrap ptr if necessary */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|state-&gt;card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* transfer unwrapped chunk */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmabuf-&gt;rawbuf
op_plus
id|rem
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|err2
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;Writing 0x%lx bytes to +0x%lx&bslash;n&quot;
comma
id|cnt
comma
id|rem
)paren
suffix:semicolon
multiline_comment|/* update counters */
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
multiline_comment|/* we have something to play - go play it! */
id|ad1889_trigger_playback
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|err2
suffix:colon
id|remove_wait_queue
c_func
(paren
op_amp
id|state-&gt;dmabuf.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|err1
suffix:colon
id|up
c_func
(paren
op_amp
id|state-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ad1889_poll
r_static
r_int
r_int
id|ad1889_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0
id|ad1889_dev_t
op_star
id|dev
op_assign
(paren
id|ad1889_dev_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ad1889_state_t
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|state
op_assign
op_amp
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
r_return
l_int|0
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dmabuf-&gt;wait
comma
id|wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|state
op_assign
op_amp
id|dev-&gt;state
(braket
id|AD_ADC_STATE
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
r_return
l_int|0
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dmabuf-&gt;wait
comma
id|wait
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ad1889_update_ptr
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|state
op_assign
op_amp
id|dev-&gt;state
(braket
id|WAV_STATE
)braket
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;mapped
)paren
(brace
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|dmabuf-&gt;dmasize
op_ge
id|dmabuf-&gt;count
op_plus
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|file
op_member_access_from_pointer
id|f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|state
op_assign
op_amp
id|dev-&gt;state
(braket
id|AD_ADC_STATE
)braket
suffix:semicolon
id|dmabuf
op_assign
op_amp
id|state-&gt;dmabuf
suffix:semicolon
r_if
c_cond
(paren
id|dmabuf-&gt;count
op_ge
(paren
r_int
)paren
id|dmabuf-&gt;fragsize
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_return
id|mask
suffix:semicolon
)brace
DECL|function|ad1889_mmap
r_static
r_int
id|ad1889_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1889_ioctl
r_static
r_int
id|ad1889_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|val
op_assign
l_int|0
suffix:semicolon
id|ad1889_dev_t
op_star
id|dev
op_assign
(paren
id|ad1889_dev_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dmabuf
op_star
id|dmabuf
suffix:semicolon
id|audio_buf_info
id|abinfo
suffix:semicolon
r_int
id|__user
op_star
id|p
op_assign
(paren
r_int
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;ad1889_ioctl cmd 0x%x arg %lu&bslash;n&quot;
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
multiline_comment|/* set sampling rate */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
l_int|5400
op_logical_and
id|val
OL
l_int|48000
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWAS
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSRES
comma
id|val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
multiline_comment|/* undocumented? */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|val
op_assign
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|val
op_or_assign
l_int|0x0200
suffix:semicolon
multiline_comment|/* set WAST */
)brace
r_else
(brace
id|val
op_and_assign
op_complement
l_int|0x0200
suffix:semicolon
multiline_comment|/* clear WAST */
)brace
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWSMC
comma
id|val
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|val
op_assign
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSRAMC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|val
op_or_assign
l_int|0x0002
suffix:semicolon
multiline_comment|/* set ADST */
)brace
r_else
(brace
id|val
op_and_assign
op_complement
l_int|0x0002
suffix:semicolon
multiline_comment|/* clear ADST */
)brace
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSRAMC
comma
id|val
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_return
id|put_user
c_func
(paren
id|DMA_SIZE
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
r_return
id|put_user
c_func
(paren
id|AFMT_S16_LE
op_or
id|AFMT_U8
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|ad1889_set_adc_fmt
c_func
(paren
id|dev
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|ad1889_set_wav_fmt
c_func
(paren
id|dev
comma
id|val
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
id|AFMT_S16_LE
op_or
id|AFMT_U8
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|val
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
multiline_comment|/* send all data to device */
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
multiline_comment|/* not supported; uses fixed fragment sizes */
r_return
id|put_user
c_func
(paren
id|DMA_SIZE
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
multiline_comment|/* space left in dma buffers */
r_if
c_cond
(paren
id|cmd
op_eq
id|SNDCTL_DSP_GETOSPACE
)paren
id|dmabuf
op_assign
op_amp
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
dot
id|dmabuf
suffix:semicolon
r_else
id|dmabuf
op_assign
op_amp
id|dev-&gt;state
(braket
id|AD_ADC_STATE
)braket
dot
id|dmabuf
suffix:semicolon
id|abinfo.fragments
op_assign
l_int|1
suffix:semicolon
id|abinfo.fragstotal
op_assign
l_int|1
suffix:semicolon
id|abinfo.fragsize
op_assign
id|DMA_SIZE
suffix:semicolon
id|abinfo.bytes
op_assign
id|DMA_SIZE
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|p
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
l_int|0
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
r_break
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_return
id|put_user
c_func
(paren
id|AD1889_READW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWAS
)paren
comma
id|p
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_break
suffix:semicolon
r_case
id|SNDCTL_DSP_MAPINBUF
suffix:colon
r_case
id|SNDCTL_DSP_MAPOUTBUF
suffix:colon
r_case
id|SNDCTL_DSP_SETSYNCRO
suffix:colon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
DECL|function|ad1889_open
r_static
r_int
id|ad1889_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/* check minor; only support /dev/dsp atm */
r_if
c_cond
(paren
id|iminor
c_func
(paren
id|inode
)paren
op_ne
l_int|3
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|file-&gt;private_data
op_assign
id|ad1889_dev
suffix:semicolon
id|ad1889_set_wav_rate
c_func
(paren
id|ad1889_dev
comma
l_int|48000
)paren
suffix:semicolon
id|ad1889_set_wav_fmt
c_func
(paren
id|ad1889_dev
comma
id|AFMT_S16_LE
)paren
suffix:semicolon
id|AD1889_WRITEW
c_func
(paren
id|ad1889_dev
comma
id|AD_DSWADA
comma
l_int|0x0404
)paren
suffix:semicolon
multiline_comment|/* attenuation */
r_return
id|nonseekable_open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
DECL|function|ad1889_release
r_static
r_int
id|ad1889_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/* if we have state free it here */
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ad1889_fops
r_static
r_struct
id|file_operations
id|ad1889_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|ad1889_read
comma
dot
id|write
op_assign
id|ad1889_write
comma
dot
id|poll
op_assign
id|ad1889_poll
comma
dot
id|ioctl
op_assign
id|ad1889_ioctl
comma
dot
id|mmap
op_assign
id|ad1889_mmap
comma
dot
id|open
op_assign
id|ad1889_open
comma
dot
id|release
op_assign
id|ad1889_release
comma
)brace
suffix:semicolon
multiline_comment|/************************* /dev/mixer interfaces ************************ */
DECL|function|ad1889_mixer_open
r_static
r_int
id|ad1889_mixer_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|ad1889_dev-&gt;ac97_codec-&gt;dev_mixer
op_ne
id|iminor
c_func
(paren
id|inode
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|file-&gt;private_data
op_assign
id|ad1889_dev-&gt;ac97_codec
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1889_mixer_release
r_static
r_int
id|ad1889_mixer_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ad1889_mixer_ioctl
r_static
r_int
id|ad1889_mixer_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
op_assign
(paren
r_struct
id|ac97_codec
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_return
id|codec
op_member_access_from_pointer
id|mixer_ioctl
c_func
(paren
id|codec
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|ad1889_mixer_fops
r_static
r_struct
id|file_operations
id|ad1889_mixer_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|ioctl
op_assign
id|ad1889_mixer_ioctl
comma
dot
id|open
op_assign
id|ad1889_mixer_open
comma
dot
id|release
op_assign
id|ad1889_mixer_release
comma
)brace
suffix:semicolon
multiline_comment|/************************* AC97 interfaces ****************************** */
DECL|function|ad1889_codec_write
r_static
r_void
id|ad1889_codec_write
c_func
(paren
r_struct
id|ac97_codec
op_star
id|ac97
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
id|ad1889_dev_t
op_star
id|dev
op_assign
id|ac97-&gt;private_data
suffix:semicolon
singleline_comment|//DBG(&quot;Writing 0x%x to 0x%lx&bslash;n&quot;, val, dev-&gt;regbase + 0x100 + reg);
id|AD1889_WRITEW
c_func
(paren
id|dev
comma
l_int|0x100
op_plus
id|reg
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|ad1889_codec_read
r_static
id|u16
id|ad1889_codec_read
c_func
(paren
r_struct
id|ac97_codec
op_star
id|ac97
comma
id|u8
id|reg
)paren
(brace
id|ad1889_dev_t
op_star
id|dev
op_assign
id|ac97-&gt;private_data
suffix:semicolon
singleline_comment|//DBG(&quot;Reading from 0x%lx&bslash;n&quot;, dev-&gt;regbase + 0x100 + reg);
r_return
id|AD1889_READW
c_func
(paren
id|dev
comma
l_int|0x100
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|ad1889_ac97_init
r_static
r_int
id|ad1889_ac97_init
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
comma
r_int
id|id
)paren
(brace
r_struct
id|ac97_codec
op_star
id|ac97
suffix:semicolon
id|u16
id|eid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ac97
op_assign
id|ac97_alloc_codec
c_func
(paren
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ac97-&gt;private_data
op_assign
id|dev
suffix:semicolon
id|ac97-&gt;id
op_assign
id|id
suffix:semicolon
id|ac97-&gt;codec_read
op_assign
id|ad1889_codec_read
suffix:semicolon
id|ac97-&gt;codec_write
op_assign
id|ad1889_codec_write
suffix:semicolon
r_if
c_cond
(paren
id|ac97_probe_codec
c_func
(paren
id|ac97
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|DEVNAME
l_string|&quot;: ac97_probe_codec failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|eid
op_assign
id|ad1889_codec_read
c_func
(paren
id|ac97
comma
id|AC97_EXTENDED_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eid
op_eq
l_int|0xffff
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|DEVNAME
l_string|&quot;: no codec attached?&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|dev-&gt;ac97_features
op_assign
id|eid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ac97-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|ad1889_mixer_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: cannot register mixer&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|dev-&gt;ac97_codec
op_assign
id|ac97
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|ac97_release_codec
c_func
(paren
id|ac97
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|ad1889_aclink_reset
r_static
r_int
id|ad1889_aclink_reset
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
)paren
(brace
id|u16
id|stat
suffix:semicolon
r_int
id|retry
op_assign
l_int|200
suffix:semicolon
id|ad1889_dev_t
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pcidev
)paren
suffix:semicolon
id|AD1889_WRITEW
c_func
(paren
id|dev
comma
id|AD_DSCCS
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* turn on clock */
id|AD1889_READW
c_func
(paren
id|dev
comma
id|AD_DSCCS
)paren
suffix:semicolon
id|WAIT_10MS
c_func
(paren
)paren
suffix:semicolon
id|stat
op_assign
id|AD1889_READW
c_func
(paren
id|dev
comma
id|AD_ACIC
)paren
suffix:semicolon
id|stat
op_or_assign
l_int|0x0002
suffix:semicolon
multiline_comment|/* Reset Disable */
id|AD1889_WRITEW
c_func
(paren
id|dev
comma
id|AD_ACIC
comma
id|stat
)paren
suffix:semicolon
(paren
r_void
)paren
id|AD1889_READW
c_func
(paren
id|dev
comma
id|AD_ACIC
)paren
suffix:semicolon
multiline_comment|/* flush posted write */
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|stat
op_assign
id|AD1889_READW
c_func
(paren
id|dev
comma
id|AD_ACIC
)paren
suffix:semicolon
id|stat
op_or_assign
l_int|0x0001
suffix:semicolon
multiline_comment|/* Interface Enable */
id|AD1889_WRITEW
c_func
(paren
id|dev
comma
id|AD_ACIC
comma
id|stat
)paren
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|AD1889_READW
c_func
(paren
id|dev
comma
id|AD_ACIC
)paren
op_amp
l_int|0x8000
)paren
multiline_comment|/* Ready */
r_break
suffix:semicolon
id|WAIT_10MS
c_func
(paren
)paren
suffix:semicolon
id|retry
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|retry
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retry
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ad1889_aclink_reset: codec is not ready [0x%x]&bslash;n&quot;
comma
id|AD1889_READW
c_func
(paren
id|dev
comma
id|AD_ACIC
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* TODO reset AC97 codec */
multiline_comment|/* TODO set wave/adc pci ctrl status */
id|stat
op_assign
id|AD1889_READW
c_func
(paren
id|dev
comma
id|AD_ACIC
)paren
suffix:semicolon
id|stat
op_or_assign
l_int|0x0004
suffix:semicolon
multiline_comment|/* Audio Stream Output Enable */
id|AD1889_WRITEW
c_func
(paren
id|dev
comma
id|AD_ACIC
comma
id|stat
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************* PCI interfaces ****************************** */
multiline_comment|/* PCI device table */
DECL|variable|ad1889_id_tbl
r_static
r_struct
id|pci_device_id
id|ad1889_id_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_ANALOG_DEVICES
comma
id|PCI_DEVICE_ID_AD1889JS
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
(paren
r_int
r_int
)paren
id|DEVNAME
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ad1889_id_tbl
)paren
suffix:semicolon
DECL|function|ad1889_interrupt
r_static
id|irqreturn_t
id|ad1889_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|stat
suffix:semicolon
id|ad1889_dev_t
op_star
id|dev
op_assign
(paren
id|ad1889_dev_t
op_star
)paren
id|dev_id
suffix:semicolon
id|stat
op_assign
id|AD1889_READL
c_func
(paren
id|dev
comma
id|AD_DMADISR
)paren
suffix:semicolon
multiline_comment|/* clear ISR */
id|AD1889_WRITEL
c_func
(paren
id|dev
comma
id|AD_DMADISR
comma
id|stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
l_int|0x8
)paren
(brace
multiline_comment|/* WAVI */
id|DBG
c_func
(paren
l_string|&quot;WAV interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;stats.wav_intrs
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
dot
id|dmabuf.ready
)paren
(brace
id|ad1889_stop_wav
c_func
(paren
op_amp
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
)paren
suffix:semicolon
multiline_comment|/* clean up */
id|ad1889_start_wav
c_func
(paren
op_amp
id|dev-&gt;state
(braket
id|AD_WAV_STATE
)braket
)paren
suffix:semicolon
multiline_comment|/* start new */
)brace
)brace
r_if
c_cond
(paren
(paren
id|stat
op_amp
l_int|0x2
)paren
op_logical_and
id|dev-&gt;state
(braket
id|AD_ADC_STATE
)braket
dot
id|dmabuf.ready
)paren
(brace
multiline_comment|/* ADCI */
id|DBG
c_func
(paren
l_string|&quot;ADC interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;stats.adc_intrs
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat
)paren
(brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
DECL|function|ad1889_initcfg
r_static
r_void
id|ad1889_initcfg
c_func
(paren
id|ad1889_dev_t
op_star
id|dev
)paren
(brace
id|u16
id|tmp16
suffix:semicolon
id|u32
id|tmp32
suffix:semicolon
multiline_comment|/* make sure the interrupt bits are setup the way we want */
id|tmp32
op_assign
id|AD1889_READL
c_func
(paren
id|dev
comma
id|AD_DMAWAVCTRL
)paren
suffix:semicolon
id|tmp32
op_and_assign
op_complement
l_int|0xff
suffix:semicolon
multiline_comment|/* flat dma, no sg, mask out the intr bits */
id|tmp32
op_or_assign
l_int|0x6
suffix:semicolon
multiline_comment|/* intr on count, loop */
id|AD1889_WRITEL
c_func
(paren
id|dev
comma
id|AD_DMAWAVCTRL
comma
id|tmp32
)paren
suffix:semicolon
multiline_comment|/* unmute... */
id|tmp16
op_assign
id|AD1889_READW
c_func
(paren
id|dev
comma
id|AD_DSWADA
)paren
suffix:semicolon
id|tmp16
op_and_assign
op_complement
l_int|0x8080
suffix:semicolon
id|AD1889_WRITEW
c_func
(paren
id|dev
comma
id|AD_DSWADA
comma
id|tmp16
)paren
suffix:semicolon
)brace
DECL|function|ad1889_probe
r_static
r_int
id|__devinit
id|ad1889_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_int
id|err
suffix:semicolon
id|ad1889_dev_t
op_star
id|dev
suffix:semicolon
r_int
r_int
id|bar
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|proc_root
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pcidev
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: pci_enable_device failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pcidev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|ad1889_alloc_dev
c_func
(paren
id|pcidev
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: cannot allocate memory for device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pcidev
comma
id|dev
)paren
suffix:semicolon
id|bar
op_assign
id|pci_resource_start
c_func
(paren
id|pcidev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pci_resource_flags
c_func
(paren
id|pcidev
comma
l_int|0
)paren
op_amp
id|IORESOURCE_MEM
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: memory region not assigned&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_request_region
c_func
(paren
id|pcidev
comma
l_int|0
comma
id|DEVNAME
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: unable to request memory region&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
id|dev-&gt;regbase
op_assign
id|ioremap_nocache
c_func
(paren
id|bar
comma
id|AD_DSIOMEMSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;regbase
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: unable to remap iomem&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pcidev-&gt;irq
comma
id|ad1889_interrupt
comma
id|SA_SHIRQ
comma
id|DEVNAME
comma
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: unable to request interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|DEVNAME
l_string|&quot;: %s at %p IRQ %d&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|ent-&gt;driver_data
comma
id|dev-&gt;regbase
comma
id|pcidev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ad1889_aclink_reset
c_func
(paren
id|pcidev
)paren
op_ne
l_int|0
)paren
r_goto
id|out4
suffix:semicolon
multiline_comment|/* register /dev/dsp */
r_if
c_cond
(paren
(paren
id|dev-&gt;dev_audio
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|ad1889_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEVNAME
l_string|&quot;: cannot register /dev/dsp&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out4
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ad1889_ac97_init
c_func
(paren
id|dev
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out5
suffix:semicolon
multiline_comment|/* XXX: cleanups */
r_if
c_cond
(paren
(paren
(paren
id|proc_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;driver/ad1889&quot;
comma
l_int|NULL
)paren
)paren
op_eq
l_int|NULL
)paren
op_logical_or
id|create_proc_read_entry
c_func
(paren
l_string|&quot;ac97&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|proc_root
comma
id|ac97_read_proc
comma
id|dev-&gt;ac97_codec
)paren
op_eq
l_int|NULL
op_logical_or
id|create_proc_read_entry
c_func
(paren
l_string|&quot;info&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|proc_root
comma
id|ad1889_read_proc
comma
id|dev
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out5
suffix:semicolon
id|ad1889_initcfg
c_func
(paren
id|dev
)paren
suffix:semicolon
singleline_comment|//DBG(DEVNAME &quot;: Driver initialization done!&bslash;n&quot;);
id|ad1889_dev
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out5
suffix:colon
id|unregister_sound_dsp
c_func
(paren
id|dev-&gt;dev_audio
)paren
suffix:semicolon
id|out4
suffix:colon
id|free_irq
c_func
(paren
id|pcidev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|out3
suffix:colon
id|iounmap
c_func
(paren
id|dev-&gt;regbase
)paren
suffix:semicolon
id|out2
suffix:colon
id|pci_release_region
c_func
(paren
id|pcidev
comma
l_int|0
)paren
suffix:semicolon
id|out1
suffix:colon
id|ad1889_free_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pcidev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|ad1889_remove
r_static
r_void
id|__devexit
id|ad1889_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
)paren
(brace
id|ad1889_dev_t
op_star
id|dev
op_assign
id|pci_get_drvdata
c_func
(paren
id|pcidev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|dev-&gt;ac97_codec-&gt;dev_mixer
)paren
suffix:semicolon
id|unregister_sound_dsp
c_func
(paren
id|dev-&gt;dev_audio
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|pcidev-&gt;irq
comma
id|dev
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|dev-&gt;regbase
)paren
suffix:semicolon
id|pci_release_region
c_func
(paren
id|pcidev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* any hw programming needed? */
id|ad1889_free_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pcidev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Randolph Chung&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Analog Devices AD1889 PCI Audio&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|ad1889_driver
r_static
r_struct
id|pci_driver
id|ad1889_driver
op_assign
(brace
dot
id|name
op_assign
id|DEVNAME
comma
dot
id|id_table
op_assign
id|ad1889_id_tbl
comma
dot
id|probe
op_assign
id|ad1889_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|ad1889_remove
)paren
comma
)brace
suffix:semicolon
DECL|function|ad1889_init_module
r_static
r_int
id|__init
id|ad1889_init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|ad1889_driver
)paren
suffix:semicolon
)brace
DECL|function|ad1889_exit_module
r_static
r_void
id|ad1889_exit_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|ad1889_driver
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|ad1889_init_module
id|module_init
c_func
(paren
id|ad1889_init_module
)paren
suffix:semicolon
DECL|variable|ad1889_exit_module
id|module_exit
c_func
(paren
id|ad1889_exit_module
)paren
suffix:semicolon
eof
