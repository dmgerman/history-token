multiline_comment|/*&n; * PMac Tumbler/Snapper lowlevel functions&n; *&n; * Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; *   Rene Rebe &lt;rene.rebe@gmx.net&gt;:&n; *     * update from shadow registers on wakeup and headphone plug&n; *     * automatically toggle DRC on headphone plug&n; *&t;&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-dev.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#endif
macro_line|#include &quot;pmac.h&quot;
macro_line|#include &quot;tumbler_volume.h&quot;
multiline_comment|/* i2c address for tumbler */
DECL|macro|TAS_I2C_ADDR
mdefine_line|#define TAS_I2C_ADDR&t;0x34
multiline_comment|/* registers */
DECL|macro|TAS_REG_MCS
mdefine_line|#define TAS_REG_MCS&t;0x01&t;/* main control */
DECL|macro|TAS_REG_DRC
mdefine_line|#define TAS_REG_DRC&t;0x02
DECL|macro|TAS_REG_VOL
mdefine_line|#define TAS_REG_VOL&t;0x04
DECL|macro|TAS_REG_TREBLE
mdefine_line|#define TAS_REG_TREBLE&t;0x05
DECL|macro|TAS_REG_BASS
mdefine_line|#define TAS_REG_BASS&t;0x06
DECL|macro|TAS_REG_INPUT1
mdefine_line|#define TAS_REG_INPUT1&t;0x07
DECL|macro|TAS_REG_INPUT2
mdefine_line|#define TAS_REG_INPUT2&t;0x08
multiline_comment|/* tas3001c */
DECL|macro|TAS_REG_PCM
mdefine_line|#define TAS_REG_PCM&t;TAS_REG_INPUT1
multiline_comment|/* tas3004 */
DECL|macro|TAS_REG_LMIX
mdefine_line|#define TAS_REG_LMIX&t;TAS_REG_INPUT1
DECL|macro|TAS_REG_RMIX
mdefine_line|#define TAS_REG_RMIX&t;TAS_REG_INPUT2
DECL|macro|TAS_REG_MCS2
mdefine_line|#define TAS_REG_MCS2&t;0x43&t;&t;/* main control 2 */
DECL|macro|TAS_REG_ACS
mdefine_line|#define TAS_REG_ACS&t;0x40&t;&t;/* analog control */
multiline_comment|/* mono volumes for tas3001c/tas3004 */
r_enum
(brace
DECL|enumerator|VOL_IDX_PCM_MONO
id|VOL_IDX_PCM_MONO
comma
multiline_comment|/* tas3001c only */
DECL|enumerator|VOL_IDX_BASS
DECL|enumerator|VOL_IDX_TREBLE
id|VOL_IDX_BASS
comma
id|VOL_IDX_TREBLE
comma
DECL|enumerator|VOL_IDX_LAST_MONO
id|VOL_IDX_LAST_MONO
)brace
suffix:semicolon
multiline_comment|/* stereo volumes for tas3004 */
r_enum
(brace
DECL|enumerator|VOL_IDX_PCM
DECL|enumerator|VOL_IDX_PCM2
DECL|enumerator|VOL_IDX_ADC
id|VOL_IDX_PCM
comma
id|VOL_IDX_PCM2
comma
id|VOL_IDX_ADC
comma
DECL|enumerator|VOL_IDX_LAST_MIX
id|VOL_IDX_LAST_MIX
)brace
suffix:semicolon
DECL|struct|pmac_gpio
r_typedef
r_struct
id|pmac_gpio
(brace
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
DECL|member|addr
r_int
r_int
id|addr
suffix:semicolon
macro_line|#else
r_void
id|__iomem
op_star
id|addr
suffix:semicolon
macro_line|#endif
DECL|member|active_state
r_int
id|active_state
suffix:semicolon
DECL|typedef|pmac_gpio_t
)brace
id|pmac_gpio_t
suffix:semicolon
DECL|struct|pmac_tumbler_t
r_typedef
r_struct
id|pmac_tumbler_t
(brace
DECL|member|i2c
id|pmac_keywest_t
id|i2c
suffix:semicolon
DECL|member|audio_reset
id|pmac_gpio_t
id|audio_reset
suffix:semicolon
DECL|member|amp_mute
id|pmac_gpio_t
id|amp_mute
suffix:semicolon
DECL|member|hp_mute
id|pmac_gpio_t
id|hp_mute
suffix:semicolon
DECL|member|hp_detect
id|pmac_gpio_t
id|hp_detect
suffix:semicolon
DECL|member|headphone_irq
r_int
id|headphone_irq
suffix:semicolon
DECL|member|master_vol
r_int
r_int
id|master_vol
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|master_switch
r_int
r_int
id|master_switch
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|mono_vol
r_int
r_int
id|mono_vol
(braket
id|VOL_IDX_LAST_MONO
)braket
suffix:semicolon
DECL|member|mix_vol
r_int
r_int
id|mix_vol
(braket
id|VOL_IDX_LAST_MIX
)braket
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* stereo volumes for tas3004 */
DECL|member|drc_range
r_int
id|drc_range
suffix:semicolon
DECL|member|drc_enable
r_int
id|drc_enable
suffix:semicolon
DECL|member|capture_source
r_int
id|capture_source
suffix:semicolon
DECL|typedef|pmac_tumbler_t
)brace
id|pmac_tumbler_t
suffix:semicolon
multiline_comment|/*&n; */
DECL|function|send_init_client
r_static
r_int
id|send_init_client
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
comma
r_int
r_int
op_star
id|regs
)paren
(brace
r_while
c_loop
(paren
op_star
id|regs
OG
l_int|0
)paren
(brace
r_int
id|err
comma
id|count
op_assign
l_int|10
suffix:semicolon
r_do
(brace
id|err
op_assign
id|i2c_smbus_write_byte_data
c_func
(paren
id|i2c-&gt;client
comma
id|regs
(braket
l_int|0
)braket
comma
id|regs
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ge
l_int|0
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
op_decrement
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|regs
op_add_assign
l_int|2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_init_client
r_static
r_int
id|tumbler_init_client
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
)paren
(brace
r_static
r_int
r_int
id|regs
(braket
)braket
op_assign
(brace
multiline_comment|/* normal operation, SCLK=64fps, i2s output, i2s input, 16bit width */
id|TAS_REG_MCS
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
op_or
(paren
l_int|2
op_lshift
l_int|4
)paren
op_or
(paren
l_int|2
op_lshift
l_int|2
)paren
op_or
l_int|0
comma
l_int|0
comma
multiline_comment|/* terminator */
)brace
suffix:semicolon
r_return
id|send_init_client
c_func
(paren
id|i2c
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|snapper_init_client
r_static
r_int
id|snapper_init_client
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
)paren
(brace
r_static
r_int
r_int
id|regs
(braket
)braket
op_assign
(brace
multiline_comment|/* normal operation, SCLK=64fps, i2s output, 16bit width */
id|TAS_REG_MCS
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
op_or
(paren
l_int|2
op_lshift
l_int|4
)paren
op_or
l_int|0
comma
multiline_comment|/* normal operation, all-pass mode */
id|TAS_REG_MCS2
comma
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* normal output, no deemphasis, A input, power-up, line-in */
id|TAS_REG_ACS
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* terminator */
)brace
suffix:semicolon
r_return
id|send_init_client
c_func
(paren
id|i2c
comma
id|regs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * gpio access&n; */
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
DECL|macro|do_gpio_write
mdefine_line|#define do_gpio_write(gp, val) &bslash;&n;&t;pmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, (gp)-&gt;addr, val)
DECL|macro|do_gpio_read
mdefine_line|#define do_gpio_read(gp) &bslash;&n;&t;pmac_call_feature(PMAC_FTR_READ_GPIO, NULL, (gp)-&gt;addr, 0)
DECL|macro|tumbler_gpio_free
mdefine_line|#define tumbler_gpio_free(gp) /* NOP */
macro_line|#else
DECL|macro|do_gpio_write
mdefine_line|#define do_gpio_write(gp, val)&t;writeb(val, (gp)-&gt;addr)
DECL|macro|do_gpio_read
mdefine_line|#define do_gpio_read(gp)&t;readb((gp)-&gt;addr)
DECL|function|tumbler_gpio_free
r_static
r_inline
r_void
id|tumbler_gpio_free
c_func
(paren
id|pmac_gpio_t
op_star
id|gp
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;addr
)paren
(brace
id|iounmap
c_func
(paren
id|gp-&gt;addr
)paren
suffix:semicolon
id|gp-&gt;addr
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_PPC_HAS_FEATURE_CALLS */
DECL|function|write_audio_gpio
r_static
r_void
id|write_audio_gpio
c_func
(paren
id|pmac_gpio_t
op_star
id|gp
comma
r_int
id|active
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;addr
)paren
r_return
suffix:semicolon
id|active
op_assign
id|active
ques
c_cond
id|gp-&gt;active_state
suffix:colon
op_logical_neg
id|gp-&gt;active_state
suffix:semicolon
id|do_gpio_write
c_func
(paren
id|gp
comma
id|active
ques
c_cond
l_int|0x05
suffix:colon
l_int|0x04
)paren
suffix:semicolon
)brace
DECL|function|read_audio_gpio
r_static
r_int
id|read_audio_gpio
c_func
(paren
id|pmac_gpio_t
op_star
id|gp
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;addr
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
(paren
(paren
id|do_gpio_read
c_func
(paren
id|gp
)paren
op_amp
l_int|0x02
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_return
id|ret
op_eq
id|gp-&gt;active_state
suffix:semicolon
)brace
multiline_comment|/*&n; * update master volume&n; */
DECL|function|tumbler_set_master_volume
r_static
r_int
id|tumbler_set_master_volume
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
)paren
(brace
r_int
r_char
id|block
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_int
id|left_vol
comma
id|right_vol
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;master_switch
(braket
l_int|0
)braket
)paren
id|left_vol
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|left_vol
op_assign
id|mix-&gt;master_vol
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|left_vol
op_ge
id|ARRAY_SIZE
c_func
(paren
id|master_volume_table
)paren
)paren
id|left_vol
op_assign
id|ARRAY_SIZE
c_func
(paren
id|master_volume_table
)paren
op_minus
l_int|1
suffix:semicolon
id|left_vol
op_assign
id|master_volume_table
(braket
id|left_vol
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;master_switch
(braket
l_int|1
)braket
)paren
id|right_vol
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|right_vol
op_assign
id|mix-&gt;master_vol
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|right_vol
op_ge
id|ARRAY_SIZE
c_func
(paren
id|master_volume_table
)paren
)paren
id|right_vol
op_assign
id|ARRAY_SIZE
c_func
(paren
id|master_volume_table
)paren
op_minus
l_int|1
suffix:semicolon
id|right_vol
op_assign
id|master_volume_table
(braket
id|right_vol
)braket
suffix:semicolon
)brace
id|block
(braket
l_int|0
)braket
op_assign
(paren
id|left_vol
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|1
)braket
op_assign
(paren
id|left_vol
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|2
)braket
op_assign
(paren
id|left_vol
op_rshift
l_int|0
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|3
)braket
op_assign
(paren
id|right_vol
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|4
)braket
op_assign
(paren
id|right_vol
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|5
)braket
op_assign
(paren
id|right_vol
op_rshift
l_int|0
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|i2c_smbus_write_block_data
c_func
(paren
id|mix-&gt;i2c.client
comma
id|TAS_REG_VOL
comma
l_int|6
comma
id|block
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;failed to set volume &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* output volume */
DECL|function|tumbler_info_master_volume
r_static
r_int
id|tumbler_info_master_volume
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|2
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
id|ARRAY_SIZE
c_func
(paren
id|master_volume_table
)paren
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_get_master_volume
r_static
r_int
id|tumbler_get_master_volume
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;master_vol
(braket
l_int|0
)braket
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
op_assign
id|mix-&gt;master_vol
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_master_volume
r_static
r_int
id|tumbler_put_master_volume
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_int
id|change
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|change
op_assign
id|mix-&gt;master_vol
(braket
l_int|0
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_logical_or
id|mix-&gt;master_vol
(braket
l_int|1
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;master_vol
(braket
l_int|0
)braket
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|mix-&gt;master_vol
(braket
l_int|1
)braket
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
id|tumbler_set_master_volume
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
multiline_comment|/* output switch */
DECL|function|tumbler_get_master_switch
r_static
r_int
id|tumbler_get_master_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;master_switch
(braket
l_int|0
)braket
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
op_assign
id|mix-&gt;master_switch
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_master_switch
r_static
r_int
id|tumbler_put_master_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_int
id|change
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|change
op_assign
id|mix-&gt;master_switch
(braket
l_int|0
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_logical_or
id|mix-&gt;master_switch
(braket
l_int|1
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;master_switch
(braket
l_int|0
)braket
op_assign
op_logical_neg
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|mix-&gt;master_switch
(braket
l_int|1
)braket
op_assign
op_logical_neg
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
id|tumbler_set_master_volume
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
multiline_comment|/*&n; * TAS3001c dynamic range compression&n; */
DECL|macro|TAS3001_DRC_MAX
mdefine_line|#define TAS3001_DRC_MAX&t;&t;0x5f
DECL|function|tumbler_set_drc
r_static
r_int
id|tumbler_set_drc
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
)paren
(brace
r_int
r_char
id|val
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|mix-&gt;drc_enable
)paren
(brace
id|val
(braket
l_int|0
)braket
op_assign
l_int|0xc1
suffix:semicolon
multiline_comment|/* enable, 3:1 compression */
r_if
c_cond
(paren
id|mix-&gt;drc_range
OG
id|TAS3001_DRC_MAX
)paren
id|val
(braket
l_int|1
)braket
op_assign
l_int|0xf0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mix-&gt;drc_range
OL
l_int|0
)paren
id|val
(braket
l_int|1
)braket
op_assign
l_int|0x91
suffix:semicolon
r_else
id|val
(braket
l_int|1
)braket
op_assign
id|mix-&gt;drc_range
op_plus
l_int|0x91
suffix:semicolon
)brace
r_else
(brace
id|val
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|val
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c_smbus_write_block_data
c_func
(paren
id|mix-&gt;i2c.client
comma
id|TAS_REG_DRC
comma
l_int|2
comma
id|val
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;failed to set DRC&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * TAS3004&n; */
DECL|macro|TAS3004_DRC_MAX
mdefine_line|#define TAS3004_DRC_MAX&t;&t;0xef
DECL|function|snapper_set_drc
r_static
r_int
id|snapper_set_drc
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
)paren
(brace
r_int
r_char
id|val
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|mix-&gt;drc_enable
)paren
id|val
(braket
l_int|0
)braket
op_assign
l_int|0x50
suffix:semicolon
multiline_comment|/* 3:1 above threshold */
r_else
id|val
(braket
l_int|0
)braket
op_assign
l_int|0x51
suffix:semicolon
multiline_comment|/* disabled */
id|val
(braket
l_int|1
)braket
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* 1:1 below threshold */
r_if
c_cond
(paren
id|mix-&gt;drc_range
OG
l_int|0xef
)paren
id|val
(braket
l_int|2
)braket
op_assign
l_int|0xef
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mix-&gt;drc_range
OL
l_int|0
)paren
id|val
(braket
l_int|2
)braket
op_assign
l_int|0x00
suffix:semicolon
r_else
id|val
(braket
l_int|2
)braket
op_assign
id|mix-&gt;drc_range
suffix:semicolon
id|val
(braket
l_int|3
)braket
op_assign
l_int|0xb0
suffix:semicolon
id|val
(braket
l_int|4
)braket
op_assign
l_int|0x60
suffix:semicolon
id|val
(braket
l_int|5
)braket
op_assign
l_int|0xa0
suffix:semicolon
r_if
c_cond
(paren
id|i2c_smbus_write_block_data
c_func
(paren
id|mix-&gt;i2c.client
comma
id|TAS_REG_DRC
comma
l_int|6
comma
id|val
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;failed to set DRC&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_info_drc_value
r_static
r_int
id|tumbler_info_drc_value
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
id|chip-&gt;model
op_eq
id|PMAC_TUMBLER
ques
c_cond
id|TAS3001_DRC_MAX
suffix:colon
id|TAS3004_DRC_MAX
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_get_drc_value
r_static
r_int
id|tumbler_get_drc_value
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;drc_range
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_drc_value
r_static
r_int
id|tumbler_put_drc_value
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_int
id|change
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|change
op_assign
id|mix-&gt;drc_range
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;drc_range
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;model
op_eq
id|PMAC_TUMBLER
)paren
id|tumbler_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
r_else
id|snapper_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
DECL|function|tumbler_get_drc_switch
r_static
r_int
id|tumbler_get_drc_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;drc_enable
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_drc_switch
r_static
r_int
id|tumbler_put_drc_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_int
id|change
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|change
op_assign
id|mix-&gt;drc_enable
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;drc_enable
op_assign
op_logical_neg
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;model
op_eq
id|PMAC_TUMBLER
)paren
id|tumbler_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
r_else
id|snapper_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
multiline_comment|/*&n; * mono volumes&n; */
DECL|struct|tumbler_mono_vol
r_struct
id|tumbler_mono_vol
(brace
DECL|member|index
r_int
id|index
suffix:semicolon
DECL|member|reg
r_int
id|reg
suffix:semicolon
DECL|member|bytes
r_int
id|bytes
suffix:semicolon
DECL|member|max
r_int
r_int
id|max
suffix:semicolon
DECL|member|table
r_int
r_int
op_star
id|table
suffix:semicolon
)brace
suffix:semicolon
DECL|function|tumbler_set_mono_volume
r_static
r_int
id|tumbler_set_mono_volume
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
comma
r_struct
id|tumbler_mono_vol
op_star
id|info
)paren
(brace
r_int
r_char
id|block
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|vol
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|vol
op_assign
id|mix-&gt;mono_vol
(braket
id|info-&gt;index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vol
op_ge
id|info-&gt;max
)paren
id|vol
op_assign
id|info-&gt;max
op_minus
l_int|1
suffix:semicolon
id|vol
op_assign
id|info-&gt;table
(braket
id|vol
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;bytes
suffix:semicolon
id|i
op_increment
)paren
id|block
(braket
id|i
)braket
op_assign
(paren
id|vol
op_rshift
(paren
(paren
id|info-&gt;bytes
op_minus
id|i
op_minus
l_int|1
)paren
op_star
l_int|8
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|i2c_smbus_write_block_data
c_func
(paren
id|mix-&gt;i2c.client
comma
id|info-&gt;reg
comma
id|info-&gt;bytes
comma
id|block
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;failed to set mono volume %d&bslash;n&quot;
comma
id|info-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_info_mono
r_static
r_int
id|tumbler_info_mono
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
r_struct
id|tumbler_mono_vol
op_star
id|info
op_assign
(paren
r_struct
id|tumbler_mono_vol
op_star
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
id|info-&gt;max
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_get_mono
r_static
r_int
id|tumbler_get_mono
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
r_struct
id|tumbler_mono_vol
op_star
id|info
op_assign
(paren
r_struct
id|tumbler_mono_vol
op_star
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;mono_vol
(braket
id|info-&gt;index
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_mono
r_static
r_int
id|tumbler_put_mono
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
r_struct
id|tumbler_mono_vol
op_star
id|info
op_assign
(paren
r_struct
id|tumbler_mono_vol
op_star
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_int
id|change
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|change
op_assign
id|mix-&gt;mono_vol
(braket
id|info-&gt;index
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;mono_vol
(braket
id|info-&gt;index
)braket
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
id|info
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
multiline_comment|/* TAS3001c mono volumes */
DECL|variable|tumbler_pcm_vol_info
r_static
r_struct
id|tumbler_mono_vol
id|tumbler_pcm_vol_info
op_assign
(brace
dot
id|index
op_assign
id|VOL_IDX_PCM_MONO
comma
dot
id|reg
op_assign
id|TAS_REG_PCM
comma
dot
id|bytes
op_assign
l_int|3
comma
dot
id|max
op_assign
id|ARRAY_SIZE
c_func
(paren
id|mixer_volume_table
)paren
comma
dot
id|table
op_assign
id|mixer_volume_table
comma
)brace
suffix:semicolon
DECL|variable|tumbler_bass_vol_info
r_static
r_struct
id|tumbler_mono_vol
id|tumbler_bass_vol_info
op_assign
(brace
dot
id|index
op_assign
id|VOL_IDX_BASS
comma
dot
id|reg
op_assign
id|TAS_REG_BASS
comma
dot
id|bytes
op_assign
l_int|1
comma
dot
id|max
op_assign
id|ARRAY_SIZE
c_func
(paren
id|bass_volume_table
)paren
comma
dot
id|table
op_assign
id|bass_volume_table
comma
)brace
suffix:semicolon
DECL|variable|tumbler_treble_vol_info
r_static
r_struct
id|tumbler_mono_vol
id|tumbler_treble_vol_info
op_assign
(brace
dot
id|index
op_assign
id|VOL_IDX_TREBLE
comma
dot
id|reg
op_assign
id|TAS_REG_TREBLE
comma
dot
id|bytes
op_assign
l_int|1
comma
dot
id|max
op_assign
id|ARRAY_SIZE
c_func
(paren
id|treble_volume_table
)paren
comma
dot
id|table
op_assign
id|treble_volume_table
comma
)brace
suffix:semicolon
multiline_comment|/* TAS3004 mono volumes */
DECL|variable|snapper_bass_vol_info
r_static
r_struct
id|tumbler_mono_vol
id|snapper_bass_vol_info
op_assign
(brace
dot
id|index
op_assign
id|VOL_IDX_BASS
comma
dot
id|reg
op_assign
id|TAS_REG_BASS
comma
dot
id|bytes
op_assign
l_int|1
comma
dot
id|max
op_assign
id|ARRAY_SIZE
c_func
(paren
id|snapper_bass_volume_table
)paren
comma
dot
id|table
op_assign
id|snapper_bass_volume_table
comma
)brace
suffix:semicolon
DECL|variable|snapper_treble_vol_info
r_static
r_struct
id|tumbler_mono_vol
id|snapper_treble_vol_info
op_assign
(brace
dot
id|index
op_assign
id|VOL_IDX_TREBLE
comma
dot
id|reg
op_assign
id|TAS_REG_TREBLE
comma
dot
id|bytes
op_assign
l_int|1
comma
dot
id|max
op_assign
id|ARRAY_SIZE
c_func
(paren
id|snapper_treble_volume_table
)paren
comma
dot
id|table
op_assign
id|snapper_treble_volume_table
comma
)brace
suffix:semicolon
DECL|macro|DEFINE_MONO
mdefine_line|#define DEFINE_MONO(xname,type) { &bslash;&n;&t;.iface = SNDRV_CTL_ELEM_IFACE_MIXER,&bslash;&n;&t;.name = xname, &bslash;&n;&t;.info = tumbler_info_mono, &bslash;&n;&t;.get = tumbler_get_mono, &bslash;&n;&t;.put = tumbler_put_mono, &bslash;&n;&t;.private_value = (unsigned long)(&amp;tumbler_##type##_vol_info), &bslash;&n;}
DECL|macro|DEFINE_SNAPPER_MONO
mdefine_line|#define DEFINE_SNAPPER_MONO(xname,type) { &bslash;&n;&t;.iface = SNDRV_CTL_ELEM_IFACE_MIXER,&bslash;&n;&t;.name = xname, &bslash;&n;&t;.info = tumbler_info_mono, &bslash;&n;&t;.get = tumbler_get_mono, &bslash;&n;&t;.put = tumbler_put_mono, &bslash;&n;&t;.private_value = (unsigned long)(&amp;snapper_##type##_vol_info), &bslash;&n;}
multiline_comment|/*&n; * snapper mixer volumes&n; */
DECL|function|snapper_set_mix_vol1
r_static
r_int
id|snapper_set_mix_vol1
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
comma
r_int
id|idx
comma
r_int
id|ch
comma
r_int
id|reg
)paren
(brace
r_int
id|i
comma
id|j
comma
id|vol
suffix:semicolon
r_int
r_char
id|block
(braket
l_int|9
)braket
suffix:semicolon
id|vol
op_assign
id|mix-&gt;mix_vol
(braket
id|idx
)braket
(braket
id|ch
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vol
op_ge
id|ARRAY_SIZE
c_func
(paren
id|mixer_volume_table
)paren
)paren
(brace
id|vol
op_assign
id|ARRAY_SIZE
c_func
(paren
id|mixer_volume_table
)paren
op_minus
l_int|1
suffix:semicolon
id|mix-&gt;mix_vol
(braket
id|idx
)braket
(braket
id|ch
)braket
op_assign
id|vol
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vol
op_assign
id|mix-&gt;mix_vol
(braket
id|i
)braket
(braket
id|ch
)braket
suffix:semicolon
id|vol
op_assign
id|mixer_volume_table
(braket
id|vol
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|3
suffix:semicolon
id|j
op_increment
)paren
id|block
(braket
id|i
op_star
l_int|3
op_plus
id|j
)braket
op_assign
(paren
id|vol
op_rshift
(paren
(paren
l_int|2
op_minus
id|j
)paren
op_star
l_int|8
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c_smbus_write_block_data
c_func
(paren
id|mix-&gt;i2c.client
comma
id|reg
comma
l_int|9
comma
id|block
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;failed to set mono volume %d&bslash;n&quot;
comma
id|reg
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snapper_set_mix_vol
r_static
r_int
id|snapper_set_mix_vol
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
comma
r_int
id|idx
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|snapper_set_mix_vol1
c_func
(paren
id|mix
comma
id|idx
comma
l_int|0
comma
id|TAS_REG_LMIX
)paren
OL
l_int|0
op_logical_or
id|snapper_set_mix_vol1
c_func
(paren
id|mix
comma
id|idx
comma
l_int|1
comma
id|TAS_REG_RMIX
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snapper_info_mix
r_static
r_int
id|snapper_info_mix
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|2
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
id|ARRAY_SIZE
c_func
(paren
id|mixer_volume_table
)paren
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snapper_get_mix
r_static
r_int
id|snapper_get_mix
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
r_int
id|idx
op_assign
(paren
r_int
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;mix_vol
(braket
id|idx
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
op_assign
id|mix-&gt;mix_vol
(braket
id|idx
)braket
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snapper_put_mix
r_static
r_int
id|snapper_put_mix
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
r_int
id|idx
op_assign
(paren
r_int
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_int
id|change
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|change
op_assign
id|mix-&gt;mix_vol
(braket
id|idx
)braket
(braket
l_int|0
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_logical_or
id|mix-&gt;mix_vol
(braket
id|idx
)braket
(braket
l_int|1
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;mix_vol
(braket
id|idx
)braket
(braket
l_int|0
)braket
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|mix-&gt;mix_vol
(braket
id|idx
)braket
(braket
l_int|1
)braket
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
id|snapper_set_mix_vol
c_func
(paren
id|mix
comma
id|idx
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
multiline_comment|/*&n; * mute switches&n; */
DECL|enumerator|TUMBLER_MUTE_HP
DECL|enumerator|TUMBLER_MUTE_AMP
r_enum
(brace
id|TUMBLER_MUTE_HP
comma
id|TUMBLER_MUTE_AMP
)brace
suffix:semicolon
DECL|function|tumbler_get_mute_switch
r_static
r_int
id|tumbler_get_mute_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
id|pmac_gpio_t
op_star
id|gp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|gp
op_assign
(paren
id|kcontrol-&gt;private_value
op_eq
id|TUMBLER_MUTE_HP
)paren
ques
c_cond
op_amp
id|mix-&gt;hp_mute
suffix:colon
op_amp
id|mix-&gt;amp_mute
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
op_logical_neg
id|read_audio_gpio
c_func
(paren
id|gp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_mute_switch
r_static
r_int
id|tumbler_put_mute_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
id|pmac_gpio_t
op_star
id|gp
suffix:semicolon
r_int
id|val
suffix:semicolon
macro_line|#ifdef PMAC_SUPPORT_AUTOMUTE
r_if
c_cond
(paren
id|chip-&gt;update_automute
op_logical_and
id|chip-&gt;auto_mute
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t touch in the auto-mute mode */
macro_line|#endif&t;
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|gp
op_assign
(paren
id|kcontrol-&gt;private_value
op_eq
id|TUMBLER_MUTE_HP
)paren
ques
c_cond
op_amp
id|mix-&gt;hp_mute
suffix:colon
op_amp
id|mix-&gt;amp_mute
suffix:semicolon
id|val
op_assign
op_logical_neg
id|read_audio_gpio
c_func
(paren
id|gp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
)paren
(brace
id|write_audio_gpio
c_func
(paren
id|gp
comma
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snapper_set_capture_source
r_static
r_int
id|snapper_set_capture_source
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|i2c_smbus_write_byte_data
c_func
(paren
id|mix-&gt;i2c.client
comma
id|TAS_REG_ACS
comma
id|mix-&gt;capture_source
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|snapper_info_capture_source
r_static
r_int
id|snapper_info_capture_source
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
r_static
r_char
op_star
id|texts
(braket
l_int|2
)braket
op_assign
(brace
l_string|&quot;Line&quot;
comma
l_string|&quot;Mic&quot;
)brace
suffix:semicolon
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_ENUMERATED
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.enumerated.items
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|uinfo-&gt;value.enumerated.item
OG
l_int|1
)paren
id|uinfo-&gt;value.enumerated.item
op_assign
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|uinfo-&gt;value.enumerated.name
comma
id|texts
(braket
id|uinfo-&gt;value.enumerated.item
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snapper_get_capture_source
r_static
r_int
id|snapper_get_capture_source
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;capture_source
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snapper_put_capture_source
r_static
r_int
id|snapper_put_capture_source
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_int
id|change
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|change
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_ne
id|mix-&gt;capture_source
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;capture_source
op_assign
op_logical_neg
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|snapper_set_capture_source
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
DECL|macro|DEFINE_SNAPPER_MIX
mdefine_line|#define DEFINE_SNAPPER_MIX(xname,idx,ofs) { &bslash;&n;&t;.iface = SNDRV_CTL_ELEM_IFACE_MIXER,&bslash;&n;&t;.name = xname, &bslash;&n;&t;.info = snapper_info_mix, &bslash;&n;&t;.get = snapper_get_mix, &bslash;&n;&t;.put = snapper_put_mix, &bslash;&n;&t;.index = idx,&bslash;&n;&t;.private_value = ofs, &bslash;&n;}
multiline_comment|/*&n; */
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|tumbler_mixers
(braket
)braket
id|__initdata
op_assign
(brace
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Master Playback Volume&quot;
comma
dot
id|info
op_assign
id|tumbler_info_master_volume
comma
dot
id|get
op_assign
id|tumbler_get_master_volume
comma
dot
id|put
op_assign
id|tumbler_put_master_volume
)brace
comma
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Master Playback Switch&quot;
comma
dot
id|info
op_assign
id|snd_pmac_boolean_stereo_info
comma
dot
id|get
op_assign
id|tumbler_get_master_switch
comma
dot
id|put
op_assign
id|tumbler_put_master_switch
)brace
comma
id|DEFINE_MONO
c_func
(paren
l_string|&quot;Tone Control - Bass&quot;
comma
id|bass
)paren
comma
id|DEFINE_MONO
c_func
(paren
l_string|&quot;Tone Control - Treble&quot;
comma
id|treble
)paren
comma
id|DEFINE_MONO
c_func
(paren
l_string|&quot;PCM Playback Volume&quot;
comma
id|pcm
)paren
comma
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;DRC Range&quot;
comma
dot
id|info
op_assign
id|tumbler_info_drc_value
comma
dot
id|get
op_assign
id|tumbler_get_drc_value
comma
dot
id|put
op_assign
id|tumbler_put_drc_value
)brace
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|snapper_mixers
(braket
)braket
id|__initdata
op_assign
(brace
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Master Playback Volume&quot;
comma
dot
id|info
op_assign
id|tumbler_info_master_volume
comma
dot
id|get
op_assign
id|tumbler_get_master_volume
comma
dot
id|put
op_assign
id|tumbler_put_master_volume
)brace
comma
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Master Playback Switch&quot;
comma
dot
id|info
op_assign
id|snd_pmac_boolean_stereo_info
comma
dot
id|get
op_assign
id|tumbler_get_master_switch
comma
dot
id|put
op_assign
id|tumbler_put_master_switch
)brace
comma
id|DEFINE_SNAPPER_MIX
c_func
(paren
l_string|&quot;PCM Playback Volume&quot;
comma
l_int|0
comma
id|VOL_IDX_PCM
)paren
comma
id|DEFINE_SNAPPER_MIX
c_func
(paren
l_string|&quot;PCM Playback Volume&quot;
comma
l_int|1
comma
id|VOL_IDX_PCM2
)paren
comma
id|DEFINE_SNAPPER_MIX
c_func
(paren
l_string|&quot;Monitor Mix Volume&quot;
comma
l_int|0
comma
id|VOL_IDX_ADC
)paren
comma
id|DEFINE_SNAPPER_MONO
c_func
(paren
l_string|&quot;Tone Control - Bass&quot;
comma
id|bass
)paren
comma
id|DEFINE_SNAPPER_MONO
c_func
(paren
l_string|&quot;Tone Control - Treble&quot;
comma
id|treble
)paren
comma
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;DRC Range&quot;
comma
dot
id|info
op_assign
id|tumbler_info_drc_value
comma
dot
id|get
op_assign
id|tumbler_get_drc_value
comma
dot
id|put
op_assign
id|tumbler_put_drc_value
)brace
comma
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Input Source&quot;
comma
multiline_comment|/* FIXME: &quot;Capture Source&quot; doesn&squot;t work properly */
dot
id|info
op_assign
id|snapper_info_capture_source
comma
dot
id|get
op_assign
id|snapper_get_capture_source
comma
dot
id|put
op_assign
id|snapper_put_capture_source
)brace
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|tumbler_hp_sw
id|__initdata
op_assign
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Headphone Playback Switch&quot;
comma
dot
id|info
op_assign
id|snd_pmac_boolean_mono_info
comma
dot
id|get
op_assign
id|tumbler_get_mute_switch
comma
dot
id|put
op_assign
id|tumbler_put_mute_switch
comma
dot
id|private_value
op_assign
id|TUMBLER_MUTE_HP
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|tumbler_speaker_sw
id|__initdata
op_assign
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;PC Speaker Playback Switch&quot;
comma
dot
id|info
op_assign
id|snd_pmac_boolean_mono_info
comma
dot
id|get
op_assign
id|tumbler_get_mute_switch
comma
dot
id|put
op_assign
id|tumbler_put_mute_switch
comma
dot
id|private_value
op_assign
id|TUMBLER_MUTE_AMP
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|tumbler_drc_sw
id|__initdata
op_assign
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;DRC Switch&quot;
comma
dot
id|info
op_assign
id|snd_pmac_boolean_mono_info
comma
dot
id|get
op_assign
id|tumbler_get_drc_switch
comma
dot
id|put
op_assign
id|tumbler_put_drc_switch
)brace
suffix:semicolon
macro_line|#ifdef PMAC_SUPPORT_AUTOMUTE
multiline_comment|/*&n; * auto-mute stuffs&n; */
DECL|function|tumbler_detect_headphone
r_static
r_int
id|tumbler_detect_headphone
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_return
id|read_audio_gpio
c_func
(paren
op_amp
id|mix-&gt;hp_detect
)paren
suffix:semicolon
)brace
DECL|function|check_mute
r_static
r_void
id|check_mute
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_gpio_t
op_star
id|gp
comma
r_int
id|val
comma
r_int
id|do_notify
comma
id|snd_kcontrol_t
op_star
id|sw
)paren
(brace
singleline_comment|//pmac_tumbler_t *mix = chip-&gt;mixer_data;
r_if
c_cond
(paren
id|val
op_ne
id|read_audio_gpio
c_func
(paren
id|gp
)paren
)paren
(brace
id|write_audio_gpio
c_func
(paren
id|gp
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_notify
)paren
id|snd_ctl_notify
c_func
(paren
id|chip-&gt;card
comma
id|SNDRV_CTL_EVENT_MASK_VALUE
comma
op_amp
id|sw-&gt;id
)paren
suffix:semicolon
)brace
)brace
DECL|variable|device_change
r_static
r_struct
id|work_struct
id|device_change
suffix:semicolon
r_static
r_void
DECL|function|device_change_handler
id|device_change_handler
c_func
(paren
r_void
op_star
id|self
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
(paren
id|pmac_t
op_star
)paren
id|self
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
)paren
r_return
suffix:semicolon
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
multiline_comment|/* first set the DRC so the speaker do not explode -ReneR */
r_if
c_cond
(paren
id|chip-&gt;model
op_eq
id|PMAC_TUMBLER
)paren
id|tumbler_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
r_else
id|snapper_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
multiline_comment|/* reset the master volume so the correct amplification is applied */
id|tumbler_set_master_volume
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
DECL|function|tumbler_update_automute
r_static
r_void
id|tumbler_update_automute
c_func
(paren
id|pmac_t
op_star
id|chip
comma
r_int
id|do_notify
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;auto_mute
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tumbler_detect_headphone
c_func
(paren
id|chip
)paren
)paren
(brace
multiline_comment|/* mute speaker */
id|check_mute
c_func
(paren
id|chip
comma
op_amp
id|mix-&gt;amp_mute
comma
l_int|1
comma
id|do_notify
comma
id|chip-&gt;speaker_sw_ctl
)paren
suffix:semicolon
id|check_mute
c_func
(paren
id|chip
comma
op_amp
id|mix-&gt;hp_mute
comma
l_int|0
comma
id|do_notify
comma
id|chip-&gt;master_sw_ctl
)paren
suffix:semicolon
id|mix-&gt;drc_enable
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* unmute speaker */
id|check_mute
c_func
(paren
id|chip
comma
op_amp
id|mix-&gt;amp_mute
comma
l_int|0
comma
id|do_notify
comma
id|chip-&gt;speaker_sw_ctl
)paren
suffix:semicolon
id|check_mute
c_func
(paren
id|chip
comma
op_amp
id|mix-&gt;hp_mute
comma
l_int|1
comma
id|do_notify
comma
id|chip-&gt;master_sw_ctl
)paren
suffix:semicolon
id|mix-&gt;drc_enable
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_notify
)paren
(brace
id|snd_ctl_notify
c_func
(paren
id|chip-&gt;card
comma
id|SNDRV_CTL_EVENT_MASK_VALUE
comma
op_amp
id|chip-&gt;hp_detect_ctl-&gt;id
)paren
suffix:semicolon
id|snd_ctl_notify
c_func
(paren
id|chip-&gt;card
comma
id|SNDRV_CTL_EVENT_MASK_VALUE
comma
op_amp
id|chip-&gt;drc_sw_ctl-&gt;id
)paren
suffix:semicolon
)brace
multiline_comment|/* finally we need to schedule an update of the mixer values&n;&t;&t;   (master and DRC are enough for now) -ReneR */
id|schedule_work
c_func
(paren
op_amp
id|device_change
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* PMAC_SUPPORT_AUTOMUTE */
multiline_comment|/* interrupt - headphone plug changed */
DECL|function|headphone_intr
r_static
id|irqreturn_t
id|headphone_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devid
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|devid
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;update_automute
op_logical_and
id|chip-&gt;initialized
)paren
(brace
id|chip
op_member_access_from_pointer
id|update_automute
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/* look for audio-gpio device */
DECL|function|find_audio_device
r_static
r_struct
id|device_node
op_star
id|find_audio_device
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;gpio&quot;
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|np-&gt;child
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;sibling
)paren
(brace
r_char
op_star
id|property
op_assign
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;audio-gpio&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|property
op_logical_and
id|strcmp
c_func
(paren
id|property
comma
id|name
)paren
op_eq
l_int|0
)paren
r_return
id|np
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* look for audio-gpio device */
DECL|function|find_compatible_audio_device
r_static
r_struct
id|device_node
op_star
id|find_compatible_audio_device
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;gpio&quot;
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|np-&gt;child
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;sibling
)paren
(brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
id|name
)paren
)paren
r_return
id|np
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* find an audio device and get its address */
DECL|function|tumbler_find_device
r_static
r_int
r_int
id|tumbler_find_device
c_func
(paren
r_const
r_char
op_star
id|device
comma
id|pmac_gpio_t
op_star
id|gp
comma
r_int
id|is_compatible
)paren
(brace
r_struct
id|device_node
op_star
id|node
suffix:semicolon
id|u32
op_star
id|base
suffix:semicolon
r_if
c_cond
(paren
id|is_compatible
)paren
id|node
op_assign
id|find_compatible_audio_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_else
id|node
op_assign
id|find_audio_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;cannot find device %s&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|base
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;AAPL,address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;cannot find address for device %s&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
id|gp-&gt;addr
op_assign
(paren
op_star
id|base
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
macro_line|#else
id|gp-&gt;addr
op_assign
id|ioremap
c_func
(paren
(paren
r_int
r_int
)paren
(paren
op_star
id|base
)paren
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|base
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;audio-gpio-active-state&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
)paren
id|gp-&gt;active_state
op_assign
op_star
id|base
suffix:semicolon
r_else
id|gp-&gt;active_state
op_assign
l_int|1
suffix:semicolon
r_return
(paren
id|node-&gt;n_intrs
OG
l_int|0
)paren
ques
c_cond
id|node-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* reset audio */
DECL|function|tumbler_reset_audio
r_static
r_void
id|tumbler_reset_audio
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|write_audio_gpio
c_func
(paren
op_amp
id|mix-&gt;audio_reset
comma
l_int|0
)paren
suffix:semicolon
id|big_mdelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
id|write_audio_gpio
c_func
(paren
op_amp
id|mix-&gt;audio_reset
comma
l_int|1
)paren
suffix:semicolon
id|big_mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|write_audio_gpio
c_func
(paren
op_amp
id|mix-&gt;audio_reset
comma
l_int|0
)paren
suffix:semicolon
id|big_mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/* resume mixer */
DECL|function|tumbler_resume
r_static
r_void
id|tumbler_resume
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
)paren
suffix:semicolon
id|tumbler_reset_audio
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mix-&gt;i2c.client
op_logical_and
id|mix-&gt;i2c.init_client
)paren
(brace
r_if
c_cond
(paren
id|mix-&gt;i2c
dot
id|init_client
c_func
(paren
op_amp
id|mix-&gt;i2c
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;tumbler_init_client error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;tumbler: i2c is not initialized&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;model
op_eq
id|PMAC_TUMBLER
)paren
(brace
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
op_amp
id|tumbler_pcm_vol_info
)paren
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
op_amp
id|tumbler_bass_vol_info
)paren
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
op_amp
id|tumbler_treble_vol_info
)paren
suffix:semicolon
id|tumbler_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_else
(brace
id|snapper_set_mix_vol
c_func
(paren
id|mix
comma
id|VOL_IDX_PCM
)paren
suffix:semicolon
id|snapper_set_mix_vol
c_func
(paren
id|mix
comma
id|VOL_IDX_PCM2
)paren
suffix:semicolon
id|snapper_set_mix_vol
c_func
(paren
id|mix
comma
id|VOL_IDX_ADC
)paren
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
op_amp
id|snapper_bass_vol_info
)paren
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
op_amp
id|snapper_treble_vol_info
)paren
suffix:semicolon
id|snapper_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
id|snapper_set_capture_source
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
id|tumbler_set_master_volume
c_func
(paren
id|mix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;update_automute
)paren
id|chip
op_member_access_from_pointer
id|update_automute
c_func
(paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* initialize tumbler */
DECL|function|tumbler_init
r_static
r_int
id|__init
id|tumbler_init
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_int
id|irq
comma
id|err
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tumbler_find_device
c_func
(paren
l_string|&quot;audio-hw-reset&quot;
comma
op_amp
id|mix-&gt;audio_reset
comma
l_int|0
)paren
suffix:semicolon
id|tumbler_find_device
c_func
(paren
l_string|&quot;amp-mute&quot;
comma
op_amp
id|mix-&gt;amp_mute
comma
l_int|0
)paren
suffix:semicolon
id|tumbler_find_device
c_func
(paren
l_string|&quot;headphone-mute&quot;
comma
op_amp
id|mix-&gt;hp_mute
comma
l_int|0
)paren
suffix:semicolon
id|irq
op_assign
id|tumbler_find_device
c_func
(paren
l_string|&quot;headphone-detect&quot;
comma
op_amp
id|mix-&gt;hp_detect
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq
op_assign
id|tumbler_find_device
c_func
(paren
l_string|&quot;keywest-gpio15&quot;
comma
op_amp
id|mix-&gt;hp_detect
comma
l_int|1
)paren
suffix:semicolon
id|tumbler_reset_audio
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* activate headphone status interrupts */
r_if
c_cond
(paren
id|irq
op_ge
l_int|0
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|request_irq
c_func
(paren
id|irq
comma
id|headphone_intr
comma
l_int|0
comma
l_string|&quot;Tumbler Headphone Detection&quot;
comma
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* activate headphone status interrupts */
id|val
op_assign
id|do_gpio_read
c_func
(paren
op_amp
id|mix-&gt;hp_detect
)paren
suffix:semicolon
id|do_gpio_write
c_func
(paren
op_amp
id|mix-&gt;hp_detect
comma
id|val
op_or
l_int|0x80
)paren
suffix:semicolon
)brace
id|mix-&gt;headphone_irq
op_assign
id|irq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_cleanup
r_static
r_void
id|tumbler_cleanup
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|mix-&gt;headphone_irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|mix-&gt;headphone_irq
comma
id|chip
)paren
suffix:semicolon
id|tumbler_gpio_free
c_func
(paren
op_amp
id|mix-&gt;audio_reset
)paren
suffix:semicolon
id|tumbler_gpio_free
c_func
(paren
op_amp
id|mix-&gt;amp_mute
)paren
suffix:semicolon
id|tumbler_gpio_free
c_func
(paren
op_amp
id|mix-&gt;hp_mute
)paren
suffix:semicolon
id|tumbler_gpio_free
c_func
(paren
op_amp
id|mix-&gt;hp_detect
)paren
suffix:semicolon
id|snd_pmac_keywest_cleanup
c_func
(paren
op_amp
id|mix-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mix
)paren
suffix:semicolon
id|chip-&gt;mixer_data
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* exported */
DECL|function|snd_pmac_tumbler_init
r_int
id|__init
id|snd_pmac_tumbler_init
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
id|u32
op_star
id|paddr
suffix:semicolon
r_struct
id|device_node
op_star
id|tas_node
suffix:semicolon
r_char
op_star
id|chipname
suffix:semicolon
macro_line|#ifdef CONFIG_KMOD
r_if
c_cond
(paren
id|current-&gt;fs-&gt;root
)paren
id|request_module
c_func
(paren
l_string|&quot;i2c-keywest&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_KMOD */&t;
id|mix
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mix
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|mix
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mix
)paren
)paren
suffix:semicolon
id|mix-&gt;headphone_irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|chip-&gt;mixer_data
op_assign
id|mix
suffix:semicolon
id|chip-&gt;mixer_free
op_assign
id|tumbler_cleanup
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|tumbler_init
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* set up TAS */
id|tas_node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;deq&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tas_node
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|paddr
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|tas_node
comma
l_string|&quot;i2c-address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|paddr
)paren
id|mix-&gt;i2c.addr
op_assign
(paren
op_star
id|paddr
)paren
op_rshift
l_int|1
suffix:semicolon
r_else
id|mix-&gt;i2c.addr
op_assign
id|TAS_I2C_ADDR
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;model
op_eq
id|PMAC_TUMBLER
)paren
(brace
id|mix-&gt;i2c.init_client
op_assign
id|tumbler_init_client
suffix:semicolon
id|mix-&gt;i2c.name
op_assign
l_string|&quot;TAS3001c&quot;
suffix:semicolon
id|chipname
op_assign
l_string|&quot;Tumbler&quot;
suffix:semicolon
)brace
r_else
(brace
id|mix-&gt;i2c.init_client
op_assign
id|snapper_init_client
suffix:semicolon
id|mix-&gt;i2c.name
op_assign
l_string|&quot;TAS3004&quot;
suffix:semicolon
id|chipname
op_assign
l_string|&quot;Snapper&quot;
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pmac_keywest_init
c_func
(paren
op_amp
id|mix-&gt;i2c
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * build mixers&n;&t; */
id|sprintf
c_func
(paren
id|chip-&gt;card-&gt;mixername
comma
l_string|&quot;PowerMac %s&quot;
comma
id|chipname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;model
op_eq
id|PMAC_TUMBLER
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|tumbler_mixers
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|tumbler_mixers
(braket
id|i
)braket
comma
id|chip
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|snapper_mixers
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|snapper_mixers
(braket
id|i
)braket
comma
id|chip
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
)brace
id|chip-&gt;master_sw_ctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|tumbler_hp_sw
comma
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|chip-&gt;master_sw_ctl
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|chip-&gt;speaker_sw_ctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|tumbler_speaker_sw
comma
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|chip-&gt;speaker_sw_ctl
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|chip-&gt;drc_sw_ctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|tumbler_drc_sw
comma
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|chip-&gt;drc_sw_ctl
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|chip-&gt;resume
op_assign
id|tumbler_resume
suffix:semicolon
macro_line|#endif
id|INIT_WORK
c_func
(paren
op_amp
id|device_change
comma
id|device_change_handler
comma
(paren
r_void
op_star
)paren
id|chip
)paren
suffix:semicolon
macro_line|#ifdef PMAC_SUPPORT_AUTOMUTE
r_if
c_cond
(paren
id|mix-&gt;headphone_irq
op_ge
l_int|0
op_logical_and
(paren
id|err
op_assign
id|snd_pmac_add_automute
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|chip-&gt;detect_headphone
op_assign
id|tumbler_detect_headphone
suffix:semicolon
id|chip-&gt;update_automute
op_assign
id|tumbler_update_automute
suffix:semicolon
id|tumbler_update_automute
c_func
(paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* update the status only */
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
eof
