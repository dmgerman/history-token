multiline_comment|/*&n; * PMac Tumbler lowlevel functions&n; *&n; * Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-dev.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#endif
macro_line|#include &quot;pmac.h&quot;
macro_line|#include &quot;tumbler_volume.h&quot;
DECL|macro|chip_t
mdefine_line|#define chip_t pmac_t
multiline_comment|/* i2c address for tumbler */
DECL|macro|TAS_I2C_ADDR
mdefine_line|#define TAS_I2C_ADDR&t;0x34
multiline_comment|/* registers */
DECL|macro|TAS_REG_MCS
mdefine_line|#define TAS_REG_MCS&t;0x01
DECL|macro|TAS_REG_DRC
mdefine_line|#define TAS_REG_DRC&t;0x02
DECL|macro|TAS_REG_VOL
mdefine_line|#define TAS_REG_VOL&t;0x04
DECL|macro|TAS_REG_TREBLE
mdefine_line|#define TAS_REG_TREBLE&t;0x05
DECL|macro|TAS_REG_BASS
mdefine_line|#define TAS_REG_BASS&t;0x06
DECL|macro|TAS_REG_INPUT1
mdefine_line|#define TAS_REG_INPUT1&t;0x07&t;/* pcm */
DECL|macro|TAS_REG_INPUT2
mdefine_line|#define TAS_REG_INPUT2&t;0x08&t;/* ??? */
DECL|macro|TAS_REG_PCM
mdefine_line|#define TAS_REG_PCM&t;TAS_REG_INPUT1
DECL|macro|TAS_MIXER_VOL_MAX
mdefine_line|#define TAS_MIXER_VOL_MAX&t;200
r_enum
(brace
DECL|enumerator|VOL_IDX_PCM
DECL|enumerator|VOL_IDX_BASS
DECL|enumerator|VOL_IDX_TREBLE
id|VOL_IDX_PCM
comma
id|VOL_IDX_BASS
comma
id|VOL_IDX_TREBLE
comma
singleline_comment|//VOL_IDX_ALTPCM,
DECL|enumerator|VOL_IDX_LAST
id|VOL_IDX_LAST
)brace
suffix:semicolon
DECL|struct|pmac_gpio
r_typedef
r_struct
id|pmac_gpio
(brace
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
DECL|member|addr
r_int
r_int
id|addr
suffix:semicolon
macro_line|#else
r_void
op_star
id|addr
suffix:semicolon
macro_line|#endif
DECL|member|active_state
r_int
id|active_state
suffix:semicolon
DECL|typedef|pmac_gpio_t
)brace
id|pmac_gpio_t
suffix:semicolon
DECL|struct|pmac_tumber_t
r_typedef
r_struct
id|pmac_tumber_t
(brace
DECL|member|i2c
id|pmac_keywest_t
id|i2c
suffix:semicolon
DECL|member|audio_reset
id|pmac_gpio_t
id|audio_reset
suffix:semicolon
DECL|member|amp_mute
id|pmac_gpio_t
id|amp_mute
suffix:semicolon
DECL|member|hp_mute
id|pmac_gpio_t
id|hp_mute
suffix:semicolon
DECL|member|hp_detect
id|pmac_gpio_t
id|hp_detect
suffix:semicolon
DECL|member|headphone_irq
r_int
id|headphone_irq
suffix:semicolon
DECL|member|master_vol
r_int
r_int
id|master_vol
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|master_switch
r_int
r_int
id|master_switch
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|mono_vol
r_int
r_int
id|mono_vol
(braket
id|VOL_IDX_LAST
)braket
suffix:semicolon
DECL|member|drc_range
r_int
id|drc_range
suffix:semicolon
DECL|member|drc_enable
r_int
id|drc_enable
suffix:semicolon
DECL|typedef|pmac_tumbler_t
)brace
id|pmac_tumbler_t
suffix:semicolon
DECL|macro|number_of
mdefine_line|#define number_of(ary) (sizeof(ary) / sizeof(ary[0]))
multiline_comment|/*&n; */
DECL|function|tumbler_init_client
r_static
r_int
id|tumbler_init_client
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
)paren
(brace
multiline_comment|/* normal operation, SCLK=64fps, i2s output, i2s input, 16bit width */
r_return
id|snd_pmac_keywest_write_byte
c_func
(paren
id|i2c
comma
id|TAS_REG_MCS
comma
(paren
l_int|1
op_lshift
l_int|6
)paren
op_plus
(paren
l_int|2
op_lshift
l_int|4
)paren
op_plus
(paren
l_int|2
op_lshift
l_int|2
)paren
op_plus
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * gpio access&n; */
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
DECL|macro|do_gpio_write
mdefine_line|#define do_gpio_write(gp, val) &bslash;&n;&t;pmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, (gp)-&gt;addr, val)
DECL|macro|do_gpio_read
mdefine_line|#define do_gpio_read(gp) &bslash;&n;&t;pmac_call_feature(PMAC_FTR_READ_GPIO, NULL, (gp)-&gt;addr, 0)
DECL|macro|tumbler_gpio_free
mdefine_line|#define tumbler_gpio_free(gp) /* NOP */
macro_line|#else
DECL|macro|do_gpio_write
mdefine_line|#define do_gpio_write(gp, val)&t;writeb(val, (gp)-&gt;addr)
DECL|macro|do_gpio_read
mdefine_line|#define do_gpio_read(gp)&t;readb((gp)-&gt;addr)
DECL|function|tumbler_gpio_free
r_static
r_inline
r_void
id|tumbler_gpio_free
c_func
(paren
id|pmac_gpio_t
op_star
id|gp
)paren
(brace
r_if
c_cond
(paren
id|gp-&gt;addr
)paren
(brace
id|iounmap
c_func
(paren
id|gp-&gt;addr
)paren
suffix:semicolon
id|gp-&gt;addr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_PPC_HAS_FEATURE_CALLS */
DECL|function|write_audio_gpio
r_static
r_void
id|write_audio_gpio
c_func
(paren
id|pmac_gpio_t
op_star
id|gp
comma
r_int
id|active
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;addr
)paren
r_return
suffix:semicolon
id|active
op_assign
id|active
ques
c_cond
id|gp-&gt;active_state
suffix:colon
op_logical_neg
id|gp-&gt;active_state
suffix:semicolon
id|do_gpio_write
c_func
(paren
id|gp
comma
id|active
ques
c_cond
l_int|0x05
suffix:colon
l_int|0x04
)paren
suffix:semicolon
)brace
DECL|function|read_audio_gpio
r_static
r_int
id|read_audio_gpio
c_func
(paren
id|pmac_gpio_t
op_star
id|gp
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gp-&gt;addr
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
(paren
(paren
id|do_gpio_read
c_func
(paren
id|gp
)paren
op_amp
l_int|0x02
)paren
op_ne
l_int|0
)paren
suffix:semicolon
r_return
id|ret
op_eq
id|gp-&gt;active_state
suffix:semicolon
)brace
multiline_comment|/*&n; * update master volume&n; */
DECL|function|tumbler_set_master_volume
r_static
r_int
id|tumbler_set_master_volume
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
)paren
(brace
r_int
r_char
id|block
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_int
id|left_vol
comma
id|right_vol
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;master_switch
(braket
l_int|0
)braket
)paren
id|left_vol
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|left_vol
op_assign
id|mix-&gt;master_vol
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|left_vol
op_ge
id|number_of
c_func
(paren
id|master_volume_table
)paren
)paren
id|left_vol
op_assign
id|number_of
c_func
(paren
id|master_volume_table
)paren
op_minus
l_int|1
suffix:semicolon
id|left_vol
op_assign
id|master_volume_table
(braket
id|left_vol
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;master_switch
(braket
l_int|1
)braket
)paren
id|right_vol
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|right_vol
op_assign
id|mix-&gt;master_vol
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|right_vol
op_ge
id|number_of
c_func
(paren
id|master_volume_table
)paren
)paren
id|right_vol
op_assign
id|number_of
c_func
(paren
id|master_volume_table
)paren
op_minus
l_int|1
suffix:semicolon
id|right_vol
op_assign
id|master_volume_table
(braket
id|right_vol
)braket
suffix:semicolon
)brace
id|block
(braket
l_int|0
)braket
op_assign
(paren
id|left_vol
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|1
)braket
op_assign
(paren
id|left_vol
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|2
)braket
op_assign
(paren
id|left_vol
op_rshift
l_int|0
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|3
)braket
op_assign
(paren
id|right_vol
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|4
)braket
op_assign
(paren
id|right_vol
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|block
(braket
l_int|5
)braket
op_assign
(paren
id|right_vol
op_rshift
l_int|0
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|snd_pmac_keywest_write
c_func
(paren
op_amp
id|mix-&gt;i2c
comma
id|TAS_REG_VOL
comma
l_int|6
comma
id|block
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;failed to set volume &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* output volume */
DECL|function|tumbler_info_master_volume
r_static
r_int
id|tumbler_info_master_volume
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|2
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
id|number_of
c_func
(paren
id|master_volume_table
)paren
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_get_master_volume
r_static
r_int
id|tumbler_get_master_volume
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;master_vol
(braket
l_int|0
)braket
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
op_assign
id|mix-&gt;master_vol
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_master_volume
r_static
r_int
id|tumbler_put_master_volume
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_int
id|change
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|change
op_assign
id|mix-&gt;master_vol
(braket
l_int|0
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_logical_or
id|mix-&gt;master_vol
(braket
l_int|1
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;master_vol
(braket
l_int|0
)braket
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|mix-&gt;master_vol
(braket
l_int|1
)braket
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
id|tumbler_set_master_volume
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
multiline_comment|/* output switch */
DECL|function|tumbler_get_master_switch
r_static
r_int
id|tumbler_get_master_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;master_switch
(braket
l_int|0
)braket
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
op_assign
id|mix-&gt;master_switch
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_master_switch
r_static
r_int
id|tumbler_put_master_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_int
id|change
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|change
op_assign
id|mix-&gt;master_switch
(braket
l_int|0
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_logical_or
id|mix-&gt;master_switch
(braket
l_int|1
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;master_switch
(braket
l_int|0
)braket
op_assign
op_logical_neg
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|mix-&gt;master_switch
(braket
l_int|1
)braket
op_assign
op_logical_neg
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
suffix:semicolon
id|tumbler_set_master_volume
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
multiline_comment|/*&n; * dynamic range compression&n; */
DECL|function|tumbler_set_drc
r_static
r_int
id|tumbler_set_drc
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
)paren
(brace
r_int
r_char
id|val
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|mix-&gt;drc_enable
)paren
(brace
id|val
(braket
l_int|0
)braket
op_assign
l_int|0xc1
suffix:semicolon
multiline_comment|/* enable, 3:1 compression */
r_if
c_cond
(paren
id|mix-&gt;drc_range
OG
l_int|0x5f
)paren
id|val
(braket
l_int|1
)braket
op_assign
l_int|0xf0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mix-&gt;drc_range
OL
l_int|0
)paren
id|val
(braket
l_int|1
)braket
op_assign
l_int|0x91
suffix:semicolon
r_else
id|val
(braket
l_int|1
)braket
op_assign
id|mix-&gt;drc_range
op_plus
l_int|0x91
suffix:semicolon
)brace
r_else
(brace
id|val
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|val
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|snd_pmac_keywest_write
c_func
(paren
op_amp
id|mix-&gt;i2c
comma
id|TAS_REG_DRC
comma
l_int|2
comma
id|val
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;failed to set DRC&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_info_drc_value
r_static
r_int
id|tumbler_info_drc_value
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
l_int|0x5f
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_get_drc_value
r_static
r_int
id|tumbler_get_drc_value
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;drc_range
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_drc_value
r_static
r_int
id|tumbler_put_drc_value
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_int
id|change
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|change
op_assign
id|mix-&gt;drc_range
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;drc_range
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|tumbler_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
DECL|function|tumbler_get_drc_switch
r_static
r_int
id|tumbler_get_drc_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;drc_enable
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_drc_switch
r_static
r_int
id|tumbler_put_drc_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_int
id|change
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|change
op_assign
id|mix-&gt;drc_enable
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;drc_enable
op_assign
op_logical_neg
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|tumbler_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
multiline_comment|/*&n; * mono volumes&n; */
DECL|struct|tumbler_mono_vol
r_struct
id|tumbler_mono_vol
(brace
DECL|member|index
r_int
id|index
suffix:semicolon
DECL|member|reg
r_int
id|reg
suffix:semicolon
DECL|member|bytes
r_int
id|bytes
suffix:semicolon
DECL|member|max
r_int
r_int
id|max
suffix:semicolon
DECL|member|table
r_int
r_int
op_star
id|table
suffix:semicolon
)brace
suffix:semicolon
DECL|function|tumbler_set_mono_volume
r_static
r_int
id|tumbler_set_mono_volume
c_func
(paren
id|pmac_tumbler_t
op_star
id|mix
comma
r_struct
id|tumbler_mono_vol
op_star
id|info
)paren
(brace
r_int
r_char
id|block
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|vol
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix-&gt;i2c.client
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|vol
op_assign
id|mix-&gt;mono_vol
(braket
id|info-&gt;index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vol
op_ge
id|info-&gt;max
)paren
id|vol
op_assign
id|info-&gt;max
op_minus
l_int|1
suffix:semicolon
id|vol
op_assign
id|info-&gt;table
(braket
id|vol
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;bytes
suffix:semicolon
id|i
op_increment
)paren
id|block
(braket
id|i
)braket
op_assign
(paren
id|vol
op_rshift
(paren
(paren
id|info-&gt;bytes
op_minus
id|i
op_minus
l_int|1
)paren
op_star
l_int|8
)paren
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|snd_pmac_keywest_write
c_func
(paren
op_amp
id|mix-&gt;i2c
comma
id|info-&gt;reg
comma
id|info-&gt;bytes
comma
id|block
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;failed to set mono volume %d&bslash;n&quot;
comma
id|info-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_info_mono
r_static
r_int
id|tumbler_info_mono
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
r_struct
id|tumbler_mono_vol
op_star
id|info
op_assign
(paren
r_struct
id|tumbler_mono_vol
op_star
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
id|info-&gt;max
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_get_mono
r_static
r_int
id|tumbler_get_mono
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
r_struct
id|tumbler_mono_vol
op_star
id|info
op_assign
(paren
r_struct
id|tumbler_mono_vol
op_star
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|mix-&gt;mono_vol
(braket
id|info-&gt;index
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_mono
r_static
r_int
id|tumbler_put_mono
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
r_struct
id|tumbler_mono_vol
op_star
id|info
op_assign
(paren
r_struct
id|tumbler_mono_vol
op_star
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
r_int
id|change
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|change
op_assign
id|mix-&gt;mono_vol
(braket
id|info-&gt;index
)braket
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|change
)paren
(brace
id|mix-&gt;mono_vol
(braket
id|info-&gt;index
)braket
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
id|info
)paren
suffix:semicolon
)brace
r_return
id|change
suffix:semicolon
)brace
DECL|variable|tumbler_pcm_vol_info
r_static
r_struct
id|tumbler_mono_vol
id|tumbler_pcm_vol_info
op_assign
(brace
id|index
suffix:colon
id|VOL_IDX_PCM
comma
id|reg
suffix:colon
id|TAS_REG_PCM
comma
id|bytes
suffix:colon
l_int|3
comma
id|max
suffix:colon
id|number_of
c_func
(paren
id|mixer_volume_table
)paren
comma
id|table
suffix:colon
id|mixer_volume_table
comma
)brace
suffix:semicolon
macro_line|#if 0 
singleline_comment|// for what?
r_static
r_struct
id|tumbler_mono_vol
id|tumbler_altpcm_vol_info
op_assign
(brace
id|index
suffix:colon
id|VOL_IDX_ALTPCM
comma
id|reg
suffix:colon
id|TAS_REG_INPUT2
comma
id|bytes
suffix:colon
l_int|3
comma
id|max
suffix:colon
id|number_of
c_func
(paren
id|mixer_volume_table
)paren
comma
id|table
suffix:colon
id|mixer_volume_table
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|tumbler_bass_vol_info
r_static
r_struct
id|tumbler_mono_vol
id|tumbler_bass_vol_info
op_assign
(brace
id|index
suffix:colon
id|VOL_IDX_BASS
comma
id|reg
suffix:colon
id|TAS_REG_BASS
comma
id|bytes
suffix:colon
l_int|1
comma
id|max
suffix:colon
id|number_of
c_func
(paren
id|bass_volume_table
)paren
comma
id|table
suffix:colon
id|bass_volume_table
comma
)brace
suffix:semicolon
DECL|variable|tumbler_treble_vol_info
r_static
r_struct
id|tumbler_mono_vol
id|tumbler_treble_vol_info
op_assign
(brace
id|index
suffix:colon
id|VOL_IDX_TREBLE
comma
id|reg
suffix:colon
id|TAS_REG_TREBLE
comma
id|bytes
suffix:colon
l_int|1
comma
id|max
suffix:colon
id|number_of
c_func
(paren
id|treble_volume_table
)paren
comma
id|table
suffix:colon
id|treble_volume_table
comma
)brace
suffix:semicolon
DECL|macro|DEFINE_MONO
mdefine_line|#define DEFINE_MONO(xname,type) { &bslash;&n;&t;iface: SNDRV_CTL_ELEM_IFACE_MIXER,&bslash;&n;&t;name: xname, &bslash;&n;&t;info: tumbler_info_mono, &bslash;&n;&t;get: tumbler_get_mono, &bslash;&n;&t;put: tumbler_put_mono, &bslash;&n;&t;private_value: (unsigned long)(&amp;tumbler_##type##_vol_info), &bslash;&n;}
multiline_comment|/*&n; * mute switches&n; */
DECL|enumerator|TUMBLER_MUTE_HP
DECL|enumerator|TUMBLER_MUTE_AMP
r_enum
(brace
id|TUMBLER_MUTE_HP
comma
id|TUMBLER_MUTE_AMP
)brace
suffix:semicolon
DECL|function|tumbler_get_mute_switch
r_static
r_int
id|tumbler_get_mute_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
id|pmac_gpio_t
op_star
id|gp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|gp
op_assign
(paren
id|kcontrol-&gt;private_value
op_eq
id|TUMBLER_MUTE_HP
)paren
ques
c_cond
op_amp
id|mix-&gt;hp_mute
suffix:colon
op_amp
id|mix-&gt;amp_mute
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
op_logical_neg
id|read_audio_gpio
c_func
(paren
id|gp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_put_mute_switch
r_static
r_int
id|tumbler_put_mute_switch
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
id|pmac_gpio_t
op_star
id|gp
suffix:semicolon
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mix
op_assign
id|chip-&gt;mixer_data
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|gp
op_assign
(paren
id|kcontrol-&gt;private_value
op_eq
id|TUMBLER_MUTE_HP
)paren
ques
c_cond
op_amp
id|mix-&gt;hp_mute
suffix:colon
op_amp
id|mix-&gt;amp_mute
suffix:semicolon
id|val
op_assign
op_logical_neg
id|read_audio_gpio
c_func
(paren
id|gp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
)paren
(brace
id|write_audio_gpio
c_func
(paren
id|gp
comma
op_logical_neg
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|tumbler_mixers
(braket
)braket
id|__initdata
op_assign
(brace
(brace
id|iface
suffix:colon
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
id|name
suffix:colon
l_string|&quot;Master Playback Volume&quot;
comma
id|info
suffix:colon
id|tumbler_info_master_volume
comma
id|get
suffix:colon
id|tumbler_get_master_volume
comma
id|put
suffix:colon
id|tumbler_put_master_volume
)brace
comma
(brace
id|iface
suffix:colon
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
id|name
suffix:colon
l_string|&quot;Master Playback Switch&quot;
comma
id|info
suffix:colon
id|snd_pmac_boolean_stereo_info
comma
id|get
suffix:colon
id|tumbler_get_master_switch
comma
id|put
suffix:colon
id|tumbler_put_master_switch
)brace
comma
id|DEFINE_MONO
c_func
(paren
l_string|&quot;Tone Control - Bass&quot;
comma
id|bass
)paren
comma
id|DEFINE_MONO
c_func
(paren
l_string|&quot;Tone Control - Treble&quot;
comma
id|treble
)paren
comma
id|DEFINE_MONO
c_func
(paren
l_string|&quot;PCM Playback Volume&quot;
comma
id|pcm
)paren
comma
singleline_comment|//  DEFINE_MONO(&quot;Mixer2 Playback Volume&quot;, altpcm),
(brace
id|iface
suffix:colon
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
id|name
suffix:colon
l_string|&quot;DRC Switch&quot;
comma
id|info
suffix:colon
id|snd_pmac_boolean_mono_info
comma
id|get
suffix:colon
id|tumbler_get_drc_switch
comma
id|put
suffix:colon
id|tumbler_put_drc_switch
)brace
comma
(brace
id|iface
suffix:colon
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
id|name
suffix:colon
l_string|&quot;DRC Range&quot;
comma
id|info
suffix:colon
id|tumbler_info_drc_value
comma
id|get
suffix:colon
id|tumbler_get_drc_value
comma
id|put
suffix:colon
id|tumbler_put_drc_value
)brace
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|tumbler_hp_sw
id|__initdata
op_assign
(brace
id|iface
suffix:colon
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
id|name
suffix:colon
l_string|&quot;Headphone Playback Switch&quot;
comma
id|info
suffix:colon
id|snd_pmac_boolean_mono_info
comma
id|get
suffix:colon
id|tumbler_get_mute_switch
comma
id|put
suffix:colon
id|tumbler_put_mute_switch
comma
id|private_value
suffix:colon
id|TUMBLER_MUTE_HP
comma
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|tumbler_speaker_sw
id|__initdata
op_assign
(brace
id|iface
suffix:colon
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
id|name
suffix:colon
l_string|&quot;PC Speaker Playback Switch&quot;
comma
id|info
suffix:colon
id|snd_pmac_boolean_mono_info
comma
id|get
suffix:colon
id|tumbler_get_mute_switch
comma
id|put
suffix:colon
id|tumbler_put_mute_switch
comma
id|private_value
suffix:colon
id|TUMBLER_MUTE_AMP
comma
)brace
suffix:semicolon
macro_line|#ifdef PMAC_SUPPORT_AUTOMUTE
multiline_comment|/*&n; * auto-mute stuffs&n; */
DECL|function|tumbler_detect_headphone
r_static
r_int
id|tumbler_detect_headphone
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_return
id|read_audio_gpio
c_func
(paren
op_amp
id|mix-&gt;hp_detect
)paren
suffix:semicolon
)brace
DECL|function|check_mute
r_static
r_void
id|check_mute
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_gpio_t
op_star
id|gp
comma
r_int
id|val
comma
r_int
id|do_notify
comma
id|snd_kcontrol_t
op_star
id|sw
)paren
(brace
singleline_comment|//pmac_tumbler_t *mix = chip-&gt;mixer_data;
r_if
c_cond
(paren
id|val
op_ne
id|read_audio_gpio
c_func
(paren
id|gp
)paren
)paren
(brace
id|write_audio_gpio
c_func
(paren
id|gp
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_notify
)paren
id|snd_ctl_notify
c_func
(paren
id|chip-&gt;card
comma
id|SNDRV_CTL_EVENT_MASK_VALUE
comma
op_amp
id|sw-&gt;id
)paren
suffix:semicolon
)brace
)brace
DECL|function|tumbler_update_automute
r_static
r_void
id|tumbler_update_automute
c_func
(paren
id|pmac_t
op_star
id|chip
comma
r_int
id|do_notify
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;auto_mute
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tumbler_detect_headphone
c_func
(paren
id|chip
)paren
)paren
(brace
multiline_comment|/* mute speaker */
id|check_mute
c_func
(paren
id|chip
comma
op_amp
id|mix-&gt;amp_mute
comma
l_int|1
comma
id|do_notify
comma
id|chip-&gt;speaker_sw_ctl
)paren
suffix:semicolon
id|check_mute
c_func
(paren
id|chip
comma
op_amp
id|mix-&gt;hp_mute
comma
l_int|0
comma
id|do_notify
comma
id|chip-&gt;master_sw_ctl
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* unmute speaker */
id|check_mute
c_func
(paren
id|chip
comma
op_amp
id|mix-&gt;amp_mute
comma
l_int|0
comma
id|do_notify
comma
id|chip-&gt;speaker_sw_ctl
)paren
suffix:semicolon
id|check_mute
c_func
(paren
id|chip
comma
op_amp
id|mix-&gt;hp_mute
comma
l_int|1
comma
id|do_notify
comma
id|chip-&gt;master_sw_ctl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_notify
)paren
id|snd_ctl_notify
c_func
(paren
id|chip-&gt;card
comma
id|SNDRV_CTL_EVENT_MASK_VALUE
comma
op_amp
id|chip-&gt;hp_detect_ctl-&gt;id
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* PMAC_SUPPORT_AUTOMUTE */
multiline_comment|/* interrupt - headphone plug changed */
DECL|function|headphone_intr
r_static
r_void
id|headphone_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devid
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|pmac_t
comma
id|devid
comma
r_return
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;update_automute
op_logical_and
id|chip-&gt;initialized
)paren
id|chip
op_member_access_from_pointer
id|update_automute
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* look for audio-gpio device */
DECL|function|find_audio_device
r_static
r_struct
id|device_node
op_star
id|find_audio_device
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;gpio&quot;
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|np-&gt;child
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;sibling
)paren
(brace
r_char
op_star
id|property
op_assign
id|get_property
c_func
(paren
id|np
comma
l_string|&quot;audio-gpio&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|property
op_logical_and
id|strcmp
c_func
(paren
id|property
comma
id|name
)paren
op_eq
l_int|0
)paren
r_return
id|np
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* look for audio-gpio device */
DECL|function|find_compatible_audio_device
r_static
r_struct
id|device_node
op_star
id|find_compatible_audio_device
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|np
op_assign
id|find_devices
c_func
(paren
l_string|&quot;gpio&quot;
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|np
op_assign
id|np-&gt;child
suffix:semicolon
id|np
suffix:semicolon
id|np
op_assign
id|np-&gt;sibling
)paren
(brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|np
comma
id|name
)paren
)paren
r_return
id|np
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* find an audio device and get its address */
DECL|function|tumbler_find_device
r_static
r_int
r_int
id|tumbler_find_device
c_func
(paren
r_const
r_char
op_star
id|device
comma
id|pmac_gpio_t
op_star
id|gp
comma
r_int
id|is_compatible
)paren
(brace
r_struct
id|device_node
op_star
id|node
suffix:semicolon
id|u32
op_star
id|base
suffix:semicolon
r_if
c_cond
(paren
id|is_compatible
)paren
id|node
op_assign
id|find_compatible_audio_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_else
id|node
op_assign
id|find_audio_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;cannot find device %s&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|base
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;AAPL,address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|base
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;cannot find address for device %s&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
id|gp-&gt;addr
op_assign
(paren
op_star
id|base
)paren
op_amp
l_int|0x0000ffff
suffix:semicolon
macro_line|#else
id|gp-&gt;addr
op_assign
(paren
r_void
op_star
)paren
id|ioremap
c_func
(paren
(paren
r_int
r_int
)paren
(paren
op_star
id|base
)paren
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|base
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|node
comma
l_string|&quot;audio-gpio-active-state&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|base
)paren
id|gp-&gt;active_state
op_assign
op_star
id|base
suffix:semicolon
r_else
id|gp-&gt;active_state
op_assign
l_int|1
suffix:semicolon
r_return
(paren
id|node-&gt;n_intrs
OG
l_int|0
)paren
ques
c_cond
id|node-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* reset audio */
DECL|function|tumbler_reset_audio
r_static
r_void
id|tumbler_reset_audio
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|write_audio_gpio
c_func
(paren
op_amp
id|mix-&gt;audio_reset
comma
l_int|1
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|write_audio_gpio
c_func
(paren
op_amp
id|mix-&gt;audio_reset
comma
l_int|0
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
multiline_comment|/* resume mixer */
DECL|function|tumbler_resume
r_static
r_void
id|tumbler_resume
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
)paren
suffix:semicolon
id|tumbler_reset_audio
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mix-&gt;i2c.client
)paren
id|tumbler_init_client
c_func
(paren
op_amp
id|mix-&gt;i2c
)paren
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
op_amp
id|tumbler_pcm_vol_info
)paren
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
op_amp
id|tumbler_bass_vol_info
)paren
suffix:semicolon
id|tumbler_set_mono_volume
c_func
(paren
id|mix
comma
op_amp
id|tumbler_treble_vol_info
)paren
suffix:semicolon
singleline_comment|// tumbler_set_mono_volume(mix, &amp;tumbler_altpcm_vol_info);
id|tumbler_set_drc
c_func
(paren
id|mix
)paren
suffix:semicolon
id|tumbler_set_master_volume
c_func
(paren
id|mix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;update_automute
)paren
id|chip
op_member_access_from_pointer
id|update_automute
c_func
(paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* initialize tumbler */
DECL|function|tumbler_init
r_static
r_int
id|__init
id|tumbler_init
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_int
id|irq
comma
id|err
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|mix
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tumbler_find_device
c_func
(paren
l_string|&quot;audio-hw-reset&quot;
comma
op_amp
id|mix-&gt;audio_reset
comma
l_int|0
)paren
suffix:semicolon
id|tumbler_find_device
c_func
(paren
l_string|&quot;amp-mute&quot;
comma
op_amp
id|mix-&gt;amp_mute
comma
l_int|0
)paren
suffix:semicolon
id|tumbler_find_device
c_func
(paren
l_string|&quot;headphone-mute&quot;
comma
op_amp
id|mix-&gt;hp_mute
comma
l_int|0
)paren
suffix:semicolon
id|irq
op_assign
id|tumbler_find_device
c_func
(paren
l_string|&quot;headphone-detect&quot;
comma
op_amp
id|mix-&gt;hp_detect
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
id|irq
op_assign
id|tumbler_find_device
c_func
(paren
l_string|&quot;keywest-gpio15&quot;
comma
op_amp
id|mix-&gt;hp_detect
comma
l_int|1
)paren
suffix:semicolon
id|tumbler_reset_audio
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* activate headphone status interrupts */
r_if
c_cond
(paren
id|irq
op_ge
l_int|0
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|request_irq
c_func
(paren
id|irq
comma
id|headphone_intr
comma
l_int|0
comma
l_string|&quot;Tumbler Headphone Detection&quot;
comma
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* activate headphone status interrupts */
id|val
op_assign
id|do_gpio_read
c_func
(paren
op_amp
id|mix-&gt;hp_detect
)paren
suffix:semicolon
id|do_gpio_write
c_func
(paren
op_amp
id|mix-&gt;hp_detect
comma
id|val
op_or
l_int|0x80
)paren
suffix:semicolon
)brace
id|mix-&gt;headphone_irq
op_assign
id|irq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tumbler_cleanup
r_static
r_void
id|tumbler_cleanup
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_tumbler_t
op_star
id|mix
op_assign
id|chip-&gt;mixer_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|mix-&gt;headphone_irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|mix-&gt;headphone_irq
comma
id|chip
)paren
suffix:semicolon
id|tumbler_gpio_free
c_func
(paren
op_amp
id|mix-&gt;audio_reset
)paren
suffix:semicolon
id|tumbler_gpio_free
c_func
(paren
op_amp
id|mix-&gt;amp_mute
)paren
suffix:semicolon
id|tumbler_gpio_free
c_func
(paren
op_amp
id|mix-&gt;hp_mute
)paren
suffix:semicolon
id|tumbler_gpio_free
c_func
(paren
op_amp
id|mix-&gt;hp_detect
)paren
suffix:semicolon
id|snd_pmac_keywest_cleanup
c_func
(paren
op_amp
id|mix-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mix
)paren
suffix:semicolon
id|chip-&gt;mixer_data
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* exported */
DECL|function|snd_pmac_tumbler_init
r_int
id|__init
id|snd_pmac_tumbler_init
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
id|pmac_tumbler_t
op_star
id|mix
suffix:semicolon
id|u32
op_star
id|paddr
suffix:semicolon
r_struct
id|device_node
op_star
id|tas_node
suffix:semicolon
macro_line|#ifdef CONFIG_KMOD
id|request_module
c_func
(paren
l_string|&quot;i2c-keywest&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_KMOD */&t;
id|mix
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mix
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mix
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|mix
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mix
)paren
)paren
suffix:semicolon
id|mix-&gt;headphone_irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|chip-&gt;mixer_data
op_assign
id|mix
suffix:semicolon
id|chip-&gt;mixer_free
op_assign
id|tumbler_cleanup
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|tumbler_init
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* set up TAS */
id|tas_node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;deq&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tas_node
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|paddr
op_assign
(paren
id|u32
op_star
)paren
id|get_property
c_func
(paren
id|tas_node
comma
l_string|&quot;i2c-address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|paddr
)paren
id|mix-&gt;i2c.addr
op_assign
(paren
op_star
id|paddr
)paren
op_rshift
l_int|1
suffix:semicolon
r_else
id|mix-&gt;i2c.addr
op_assign
id|TAS_I2C_ADDR
suffix:semicolon
id|mix-&gt;i2c.init_client
op_assign
id|tumbler_init_client
suffix:semicolon
id|mix-&gt;i2c.name
op_assign
l_string|&quot;TAS3001c&quot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pmac_keywest_init
c_func
(paren
op_amp
id|mix-&gt;i2c
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * build mixers&n;&t; */
id|strcpy
c_func
(paren
id|chip-&gt;card-&gt;mixername
comma
l_string|&quot;PowerMac Tumbler&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|number_of
c_func
(paren
id|tumbler_mixers
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|tumbler_mixers
(braket
id|i
)braket
comma
id|chip
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
id|chip-&gt;master_sw_ctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|tumbler_hp_sw
comma
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|chip-&gt;master_sw_ctl
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|chip-&gt;speaker_sw_ctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|tumbler_speaker_sw
comma
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|chip-&gt;speaker_sw_ctl
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
macro_line|#ifdef CONFIG_PMAC_PBOOK
id|chip-&gt;resume
op_assign
id|tumbler_resume
suffix:semicolon
macro_line|#endif
macro_line|#ifdef PMAC_SUPPORT_AUTOMUTE
r_if
c_cond
(paren
id|mix-&gt;headphone_irq
op_ge
l_int|0
op_logical_and
(paren
id|err
op_assign
id|snd_pmac_add_automute
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|chip-&gt;detect_headphone
op_assign
id|tumbler_detect_headphone
suffix:semicolon
id|chip-&gt;update_automute
op_assign
id|tumbler_update_automute
suffix:semicolon
id|tumbler_update_automute
c_func
(paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* update the status only */
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
eof
