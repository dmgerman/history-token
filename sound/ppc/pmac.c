multiline_comment|/*&n; * PMac DBDMA lowlevel functions&n; *&n; * Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;&n; * code based on dmasound.c.&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &quot;pmac.h&quot;
macro_line|#include &lt;sound/pcm_params.h&gt;
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#else
macro_line|#include &lt;asm/feature.h&gt;
macro_line|#endif
macro_line|#if defined(CONFIG_PM) &amp;&amp; defined(CONFIG_PMAC_PBOOK)
r_static
r_int
id|snd_pmac_register_sleep_notifier
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
suffix:semicolon
r_static
r_int
id|snd_pmac_unregister_sleep_notifier
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
suffix:semicolon
r_static
r_int
id|snd_pmac_suspend
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
r_int
id|state
)paren
suffix:semicolon
r_static
r_int
id|snd_pmac_resume
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
r_int
id|state
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* fixed frequency table for awacs, screamer, burgundy, DACA (44100 max) */
DECL|variable|awacs_freqs
r_static
r_int
id|awacs_freqs
(braket
l_int|8
)braket
op_assign
(brace
l_int|44100
comma
l_int|29400
comma
l_int|22050
comma
l_int|17640
comma
l_int|14700
comma
l_int|11025
comma
l_int|8820
comma
l_int|7350
)brace
suffix:semicolon
multiline_comment|/* fixed frequency table for tumbler */
DECL|variable|tumbler_freqs
r_static
r_int
id|tumbler_freqs
(braket
l_int|1
)braket
op_assign
(brace
l_int|44100
)brace
suffix:semicolon
multiline_comment|/*&n; * allocate DBDMA command arrays&n; */
DECL|function|snd_pmac_dbdma_alloc
r_static
r_int
id|snd_pmac_dbdma_alloc
c_func
(paren
id|pmac_dbdma_t
op_star
id|rec
comma
r_int
id|size
)paren
(brace
id|rec-&gt;space
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
op_star
(paren
id|size
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec-&gt;space
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
suffix:semicolon
id|memset
c_func
(paren
id|rec-&gt;space
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dbdma_cmd
)paren
op_star
(paren
id|size
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|rec-&gt;cmds
op_assign
(paren
r_void
id|__iomem
op_star
)paren
id|DBDMA_ALIGN
c_func
(paren
id|rec-&gt;space
)paren
suffix:semicolon
id|rec-&gt;addr
op_assign
id|virt_to_bus
c_func
(paren
id|rec-&gt;cmds
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_dbdma_free
r_static
r_void
id|snd_pmac_dbdma_free
c_func
(paren
id|pmac_dbdma_t
op_star
id|rec
)paren
(brace
r_if
c_cond
(paren
id|rec
)paren
id|kfree
c_func
(paren
id|rec-&gt;space
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * pcm stuff&n; */
multiline_comment|/*&n; * look up frequency table&n; */
DECL|function|snd_pmac_rate_index
r_int
r_int
id|snd_pmac_rate_index
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_stream_t
op_star
id|rec
comma
r_int
r_int
id|rate
)paren
(brace
r_int
id|i
comma
id|ok
comma
id|found
suffix:semicolon
id|ok
op_assign
id|rec-&gt;cur_freqs
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
id|chip-&gt;freq_table
(braket
l_int|0
)braket
)paren
r_return
l_int|0
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|chip-&gt;num_freqs
suffix:semicolon
id|i
op_increment
comma
id|ok
op_rshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ok
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|found
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|rate
op_ge
id|chip-&gt;freq_table
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
)brace
r_return
id|found
suffix:semicolon
)brace
multiline_comment|/*&n; * check whether another stream is active&n; */
DECL|function|another_stream
r_static
r_inline
r_int
id|another_stream
c_func
(paren
r_int
id|stream
)paren
(brace
r_return
(paren
id|stream
op_eq
id|SNDRV_PCM_STREAM_PLAYBACK
)paren
ques
c_cond
id|SNDRV_PCM_STREAM_CAPTURE
suffix:colon
id|SNDRV_PCM_STREAM_PLAYBACK
suffix:semicolon
)brace
multiline_comment|/*&n; * allocate buffers&n; */
DECL|function|snd_pmac_pcm_hw_params
r_static
r_int
id|snd_pmac_pcm_hw_params
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
comma
id|snd_pcm_hw_params_t
op_star
id|hw_params
)paren
(brace
r_return
id|snd_pcm_lib_malloc_pages
c_func
(paren
id|subs
comma
id|params_buffer_bytes
c_func
(paren
id|hw_params
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * release buffers&n; */
DECL|function|snd_pmac_pcm_hw_free
r_static
r_int
id|snd_pmac_pcm_hw_free
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|snd_pcm_lib_free_pages
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * get a stream of the opposite direction&n; */
DECL|function|snd_pmac_get_stream
r_static
id|pmac_stream_t
op_star
id|snd_pmac_get_stream
c_func
(paren
id|pmac_t
op_star
id|chip
comma
r_int
id|stream
)paren
(brace
r_switch
c_cond
(paren
id|stream
)paren
(brace
r_case
id|SNDRV_PCM_STREAM_PLAYBACK
suffix:colon
r_return
op_amp
id|chip-&gt;playback
suffix:semicolon
r_case
id|SNDRV_PCM_STREAM_CAPTURE
suffix:colon
r_return
op_amp
id|chip-&gt;capture
suffix:semicolon
r_default
suffix:colon
id|snd_BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * wait while run status is on&n; */
r_inline
r_static
r_void
DECL|function|snd_pmac_wait_ack
id|snd_pmac_wait_ack
c_func
(paren
id|pmac_stream_t
op_star
id|rec
)paren
(brace
r_int
id|timeout
op_assign
l_int|50000
suffix:semicolon
r_while
c_loop
(paren
(paren
id|in_le32
c_func
(paren
op_amp
id|rec-&gt;dma-&gt;status
)paren
op_amp
id|RUN
)paren
op_logical_and
id|timeout
op_decrement
OG
l_int|0
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * set the format and rate to the chip.&n; * call the lowlevel function if defined (e.g. for AWACS).&n; */
DECL|function|snd_pmac_pcm_set_format
r_static
r_void
id|snd_pmac_pcm_set_format
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
multiline_comment|/* set up frequency and format */
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;control
comma
id|chip-&gt;control_mask
op_or
(paren
id|chip-&gt;rate_index
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;byteswap
comma
id|chip-&gt;format
op_eq
id|SNDRV_PCM_FORMAT_S16_LE
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;set_format
)paren
id|chip
op_member_access_from_pointer
id|set_format
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * stop the DMA transfer&n; */
DECL|function|snd_pmac_dma_stop
r_inline
r_static
r_void
id|snd_pmac_dma_stop
c_func
(paren
id|pmac_stream_t
op_star
id|rec
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|rec-&gt;dma-&gt;control
comma
(paren
id|RUN
op_or
id|WAKE
op_or
id|FLUSH
op_or
id|PAUSE
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|snd_pmac_wait_ack
c_func
(paren
id|rec
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * set the command pointer address&n; */
DECL|function|snd_pmac_dma_set_command
r_inline
r_static
r_void
id|snd_pmac_dma_set_command
c_func
(paren
id|pmac_stream_t
op_star
id|rec
comma
id|pmac_dbdma_t
op_star
id|cmd
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|rec-&gt;dma-&gt;cmdptr
comma
id|cmd-&gt;addr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * start the DMA&n; */
DECL|function|snd_pmac_dma_run
r_inline
r_static
r_void
id|snd_pmac_dma_run
c_func
(paren
id|pmac_stream_t
op_star
id|rec
comma
r_int
id|status
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|rec-&gt;dma-&gt;control
comma
id|status
op_or
(paren
id|status
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * prepare playback/capture stream&n; */
DECL|function|snd_pmac_pcm_prepare
r_static
r_int
id|snd_pmac_pcm_prepare
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_stream_t
op_star
id|rec
comma
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
r_int
id|i
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
id|__iomem
op_star
id|cp
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;runtime
suffix:semicolon
r_int
id|rate_index
suffix:semicolon
r_int
id|offset
suffix:semicolon
id|pmac_stream_t
op_star
id|astr
suffix:semicolon
id|rec-&gt;dma_size
op_assign
id|snd_pcm_lib_buffer_bytes
c_func
(paren
id|subs
)paren
suffix:semicolon
id|rec-&gt;period_size
op_assign
id|snd_pcm_lib_period_bytes
c_func
(paren
id|subs
)paren
suffix:semicolon
id|rec-&gt;nperiods
op_assign
id|rec-&gt;dma_size
op_div
id|rec-&gt;period_size
suffix:semicolon
id|rec-&gt;cur_period
op_assign
l_int|0
suffix:semicolon
id|rate_index
op_assign
id|snd_pmac_rate_index
c_func
(paren
id|chip
comma
id|rec
comma
id|runtime-&gt;rate
)paren
suffix:semicolon
multiline_comment|/* set up constraints */
id|astr
op_assign
id|snd_pmac_get_stream
c_func
(paren
id|chip
comma
id|another_stream
c_func
(paren
id|rec-&gt;stream
)paren
)paren
suffix:semicolon
id|snd_runtime_check
c_func
(paren
id|astr
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|astr-&gt;cur_freqs
op_assign
l_int|1
op_lshift
id|rate_index
suffix:semicolon
id|astr-&gt;cur_formats
op_assign
l_int|1
op_lshift
id|runtime-&gt;format
suffix:semicolon
id|chip-&gt;rate_index
op_assign
id|rate_index
suffix:semicolon
id|chip-&gt;format
op_assign
id|runtime-&gt;format
suffix:semicolon
multiline_comment|/* We really want to execute a DMA stop command, after the AWACS&n;&t; * is initialized.&n;&t; * For reasons I don&squot;t understand, it stops the hissing noise&n;&t; * common to many PowerBook G3 systems and random noise otherwise&n;&t; * captured on iBook2&squot;s about every third time. -ReneR&n;&t; */
id|spin_lock_irq
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|snd_pmac_dma_stop
c_func
(paren
id|rec
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|chip-&gt;extra_dma.cmds-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
id|snd_pmac_dma_set_command
c_func
(paren
id|rec
comma
op_amp
id|chip-&gt;extra_dma
)paren
suffix:semicolon
id|snd_pmac_dma_run
c_func
(paren
id|rec
comma
id|RUN
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
multiline_comment|/* continuous DMA memory type doesn&squot;t provide the physical address,&n;&t; * so we need to resolve the address here...&n;&t; */
id|offset
op_assign
id|virt_to_bus
c_func
(paren
id|runtime-&gt;dma_area
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|cp
op_assign
id|rec-&gt;cmd.cmds
suffix:semicolon
id|i
OL
id|rec-&gt;nperiods
suffix:semicolon
id|i
op_increment
comma
id|cp
op_increment
)paren
(brace
id|st_le32
c_func
(paren
op_amp
id|cp-&gt;phy_addr
comma
id|offset
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;req_count
comma
id|rec-&gt;period_size
)paren
suffix:semicolon
multiline_comment|/*st_le16(&amp;cp-&gt;res_count, 0);*/
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|offset
op_add_assign
id|rec-&gt;period_size
suffix:semicolon
)brace
multiline_comment|/* make loop */
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|DBDMA_NOP
op_plus
id|BR_ALWAYS
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|cp-&gt;cmd_dep
comma
id|rec-&gt;cmd.addr
)paren
suffix:semicolon
id|snd_pmac_dma_stop
c_func
(paren
id|rec
)paren
suffix:semicolon
id|snd_pmac_dma_set_command
c_func
(paren
id|rec
comma
op_amp
id|rec-&gt;cmd
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * PCM trigger/stop&n; */
DECL|function|snd_pmac_pcm_trigger
r_static
r_int
id|snd_pmac_pcm_trigger
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_stream_t
op_star
id|rec
comma
id|snd_pcm_substream_t
op_star
id|subs
comma
r_int
id|cmd
)paren
(brace
r_volatile
r_struct
id|dbdma_cmd
id|__iomem
op_star
id|cp
suffix:semicolon
r_int
id|i
comma
id|command
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_PCM_TRIGGER_START
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_RESUME
suffix:colon
r_if
c_cond
(paren
id|rec-&gt;running
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|command
op_assign
(paren
id|subs-&gt;stream
op_eq
id|SNDRV_PCM_STREAM_PLAYBACK
ques
c_cond
id|OUTPUT_MORE
suffix:colon
id|INPUT_MORE
)paren
op_plus
id|INTR_ALWAYS
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|snd_pmac_beep_stop
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_pmac_pcm_set_format
c_func
(paren
id|chip
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|cp
op_assign
id|rec-&gt;cmd.cmds
suffix:semicolon
id|i
OL
id|rec-&gt;nperiods
suffix:semicolon
id|i
op_increment
comma
id|cp
op_increment
)paren
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|command
)paren
suffix:semicolon
id|snd_pmac_dma_set_command
c_func
(paren
id|rec
comma
op_amp
id|rec-&gt;cmd
)paren
suffix:semicolon
(paren
r_void
)paren
id|in_le32
c_func
(paren
op_amp
id|rec-&gt;dma-&gt;status
)paren
suffix:semicolon
id|snd_pmac_dma_run
c_func
(paren
id|rec
comma
id|RUN
op_or
id|WAKE
)paren
suffix:semicolon
id|rec-&gt;running
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_STOP
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_SUSPEND
suffix:colon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|rec-&gt;running
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*printk(&quot;stopped!!&bslash;n&quot;);*/
id|snd_pmac_dma_stop
c_func
(paren
id|rec
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|cp
op_assign
id|rec-&gt;cmd.cmds
suffix:semicolon
id|i
OL
id|rec-&gt;nperiods
suffix:semicolon
id|i
op_increment
comma
id|cp
op_increment
)paren
id|out_le16
c_func
(paren
op_amp
id|cp-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * return the current pointer&n; */
r_inline
DECL|function|snd_pmac_pcm_pointer
r_static
id|snd_pcm_uframes_t
id|snd_pmac_pcm_pointer
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_stream_t
op_star
id|rec
comma
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
macro_line|#if 1 /* hmm.. how can we get the current dma pointer?? */
r_int
id|stat
suffix:semicolon
r_volatile
r_struct
id|dbdma_cmd
id|__iomem
op_star
id|cp
op_assign
op_amp
id|rec-&gt;cmd.cmds
(braket
id|rec-&gt;cur_period
)braket
suffix:semicolon
id|stat
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
(paren
id|ACTIVE
op_or
id|DEAD
)paren
)paren
(brace
id|count
op_assign
id|in_le16
c_func
(paren
op_amp
id|cp-&gt;res_count
)paren
suffix:semicolon
id|count
op_assign
id|rec-&gt;period_size
op_minus
id|count
suffix:semicolon
)brace
macro_line|#endif
id|count
op_add_assign
id|rec-&gt;cur_period
op_star
id|rec-&gt;period_size
suffix:semicolon
multiline_comment|/*printk(&quot;pointer=%d&bslash;n&quot;, count);*/
r_return
id|bytes_to_frames
c_func
(paren
id|subs-&gt;runtime
comma
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * playback&n; */
DECL|function|snd_pmac_playback_prepare
r_static
r_int
id|snd_pmac_playback_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
id|snd_pmac_pcm_prepare
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;playback
comma
id|subs
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_playback_trigger
r_static
r_int
id|snd_pmac_playback_trigger
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
comma
r_int
id|cmd
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
id|snd_pmac_pcm_trigger
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;playback
comma
id|subs
comma
id|cmd
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_playback_pointer
r_static
id|snd_pcm_uframes_t
id|snd_pmac_playback_pointer
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
id|snd_pmac_pcm_pointer
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;playback
comma
id|subs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * capture&n; */
DECL|function|snd_pmac_capture_prepare
r_static
r_int
id|snd_pmac_capture_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
id|snd_pmac_pcm_prepare
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;capture
comma
id|subs
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_capture_trigger
r_static
r_int
id|snd_pmac_capture_trigger
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
comma
r_int
id|cmd
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
id|snd_pmac_pcm_trigger
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;capture
comma
id|subs
comma
id|cmd
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_capture_pointer
r_static
id|snd_pcm_uframes_t
id|snd_pmac_capture_pointer
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
id|snd_pmac_pcm_pointer
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;capture
comma
id|subs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * update playback/capture pointer from interrupts&n; */
DECL|function|snd_pmac_pcm_update
r_static
r_void
id|snd_pmac_pcm_update
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_stream_t
op_star
id|rec
)paren
(brace
r_volatile
r_struct
id|dbdma_cmd
id|__iomem
op_star
id|cp
suffix:semicolon
r_int
id|c
suffix:semicolon
r_int
id|stat
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec-&gt;running
)paren
(brace
id|cp
op_assign
op_amp
id|rec-&gt;cmd.cmds
(braket
id|rec-&gt;cur_period
)braket
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|rec-&gt;nperiods
suffix:semicolon
id|c
op_increment
)paren
(brace
multiline_comment|/* at most all fragments */
id|stat
op_assign
id|ld_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat
op_amp
id|ACTIVE
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/*printk(&quot;update frag %d&bslash;n&quot;, rec-&gt;cur_period);*/
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|cp-&gt;req_count
comma
id|rec-&gt;period_size
)paren
suffix:semicolon
multiline_comment|/*st_le16(&amp;cp-&gt;res_count, 0);*/
id|rec-&gt;cur_period
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rec-&gt;cur_period
op_ge
id|rec-&gt;nperiods
)paren
(brace
id|rec-&gt;cur_period
op_assign
l_int|0
suffix:semicolon
id|cp
op_assign
id|rec-&gt;cmd.cmds
suffix:semicolon
)brace
r_else
id|cp
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|snd_pcm_period_elapsed
c_func
(paren
id|rec-&gt;substream
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * hw info&n; */
DECL|variable|snd_pmac_playback
r_static
id|snd_pcm_hardware_t
id|snd_pmac_playback
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_RESUME
)paren
comma
dot
id|formats
op_assign
id|SNDRV_PCM_FMTBIT_S16_BE
op_or
id|SNDRV_PCM_FMTBIT_S16_LE
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_8000_44100
comma
dot
id|rate_min
op_assign
l_int|7350
comma
dot
id|rate_max
op_assign
l_int|44100
comma
dot
id|channels_min
op_assign
l_int|2
comma
dot
id|channels_max
op_assign
l_int|2
comma
dot
id|buffer_bytes_max
op_assign
l_int|131072
comma
dot
id|period_bytes_min
op_assign
l_int|256
comma
dot
id|period_bytes_max
op_assign
l_int|16384
comma
dot
id|periods_min
op_assign
l_int|3
comma
dot
id|periods_max
op_assign
id|PMAC_MAX_FRAGS
comma
)brace
suffix:semicolon
DECL|variable|snd_pmac_capture
r_static
id|snd_pcm_hardware_t
id|snd_pmac_capture
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_RESUME
)paren
comma
dot
id|formats
op_assign
id|SNDRV_PCM_FMTBIT_S16_BE
op_or
id|SNDRV_PCM_FMTBIT_S16_LE
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_8000_44100
comma
dot
id|rate_min
op_assign
l_int|7350
comma
dot
id|rate_max
op_assign
l_int|44100
comma
dot
id|channels_min
op_assign
l_int|2
comma
dot
id|channels_max
op_assign
l_int|2
comma
dot
id|buffer_bytes_max
op_assign
l_int|131072
comma
dot
id|period_bytes_min
op_assign
l_int|256
comma
dot
id|period_bytes_max
op_assign
l_int|16384
comma
dot
id|periods_min
op_assign
l_int|3
comma
dot
id|periods_max
op_assign
id|PMAC_MAX_FRAGS
comma
)brace
suffix:semicolon
macro_line|#if 0 
singleline_comment|// NYI
r_static
r_int
id|snd_pmac_hw_rule_rate
c_func
(paren
id|snd_pcm_hw_params_t
op_star
id|params
comma
id|snd_pcm_hw_rule_t
op_star
id|rule
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|rule
op_member_access_from_pointer
r_private
suffix:semicolon
id|pmac_stream_t
op_star
id|rec
op_assign
id|snd_pmac_get_stream
c_func
(paren
id|chip
comma
id|rule-&gt;deps
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
id|i
comma
id|freq_table
(braket
l_int|8
)braket
comma
id|num_freqs
suffix:semicolon
id|snd_runtime_check
c_func
(paren
id|rec
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|num_freqs
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|chip-&gt;num_freqs
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|rec-&gt;cur_freqs
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|freq_table
(braket
id|num_freqs
op_increment
)braket
op_assign
id|chip-&gt;freq_table
(braket
id|i
)braket
suffix:semicolon
)brace
r_return
id|snd_interval_list
c_func
(paren
id|hw_param_interval
c_func
(paren
id|params
comma
id|rule-&gt;var
)paren
comma
id|num_freqs
comma
id|freq_table
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
id|snd_pmac_hw_rule_format
c_func
(paren
id|snd_pcm_hw_params_t
op_star
id|params
comma
id|snd_pcm_hw_rule_t
op_star
id|rule
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|rule
op_member_access_from_pointer
r_private
suffix:semicolon
id|pmac_stream_t
op_star
id|rec
op_assign
id|snd_pmac_get_stream
c_func
(paren
id|chip
comma
id|rule-&gt;deps
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|snd_runtime_check
c_func
(paren
id|rec
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_return
id|snd_mask_refine_set
c_func
(paren
id|hw_param_mask
c_func
(paren
id|params
comma
id|SNDRV_PCM_HW_PARAM_FORMAT
)paren
comma
id|rec-&gt;cur_formats
)paren
suffix:semicolon
)brace
macro_line|#endif 
singleline_comment|// NYI
DECL|function|snd_pmac_pcm_open
r_static
r_int
id|snd_pmac_pcm_open
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_stream_t
op_star
id|rec
comma
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;runtime
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|fflags
suffix:semicolon
r_static
r_int
id|typical_freqs
(braket
)braket
op_assign
(brace
l_int|44100
comma
l_int|22050
comma
l_int|11025
comma
l_int|0
comma
)brace
suffix:semicolon
r_static
r_int
id|typical_freq_flags
(braket
)braket
op_assign
(brace
id|SNDRV_PCM_RATE_44100
comma
id|SNDRV_PCM_RATE_22050
comma
id|SNDRV_PCM_RATE_11025
comma
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* look up frequency table and fill bit mask */
id|runtime-&gt;hw.rates
op_assign
l_int|0
suffix:semicolon
id|fflags
op_assign
id|chip-&gt;freqs_ok
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|typical_freqs
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|chip-&gt;num_freqs
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|chip-&gt;freqs_ok
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
op_logical_and
id|chip-&gt;freq_table
(braket
id|j
)braket
op_eq
id|typical_freqs
(braket
id|i
)braket
)paren
(brace
id|runtime-&gt;hw.rates
op_or_assign
id|typical_freq_flags
(braket
id|i
)braket
suffix:semicolon
id|fflags
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|j
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|fflags
)paren
multiline_comment|/* rest */
id|runtime-&gt;hw.rates
op_or_assign
id|SNDRV_PCM_RATE_KNOT
suffix:semicolon
multiline_comment|/* check for minimum and maximum rates */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|chip-&gt;num_freqs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;freqs_ok
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|runtime-&gt;hw.rate_max
op_assign
id|chip-&gt;freq_table
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
id|chip-&gt;num_freqs
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;freqs_ok
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|runtime-&gt;hw.rate_min
op_assign
id|chip-&gt;freq_table
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|runtime-&gt;hw.formats
op_assign
id|chip-&gt;formats_ok
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;can_capture
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;can_duplex
)paren
id|runtime-&gt;hw.info
op_or_assign
id|SNDRV_PCM_INFO_HALF_DUPLEX
suffix:semicolon
id|runtime-&gt;hw.info
op_or_assign
id|SNDRV_PCM_INFO_JOINT_DUPLEX
suffix:semicolon
)brace
id|runtime-&gt;private_data
op_assign
id|rec
suffix:semicolon
id|rec-&gt;substream
op_assign
id|subs
suffix:semicolon
macro_line|#if 0 /* FIXME: still under development.. */
id|snd_pcm_hw_rule_add
c_func
(paren
id|runtime
comma
l_int|0
comma
id|SNDRV_PCM_HW_PARAM_RATE
comma
id|snd_pmac_hw_rule_rate
comma
id|chip
comma
id|rec-&gt;stream
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|snd_pcm_hw_rule_add
c_func
(paren
id|runtime
comma
l_int|0
comma
id|SNDRV_PCM_HW_PARAM_FORMAT
comma
id|snd_pmac_hw_rule_format
comma
id|chip
comma
id|rec-&gt;stream
comma
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|runtime-&gt;hw.periods_max
op_assign
id|rec-&gt;cmd.size
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;can_duplex
)paren
id|snd_pcm_set_sync
c_func
(paren
id|subs
)paren
suffix:semicolon
multiline_comment|/* constraints to fix choppy sound */
id|snd_pcm_hw_constraint_integer
c_func
(paren
id|runtime
comma
id|SNDRV_PCM_HW_PARAM_PERIODS
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_pcm_close
r_static
r_int
id|snd_pmac_pcm_close
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_stream_t
op_star
id|rec
comma
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_stream_t
op_star
id|astr
suffix:semicolon
id|snd_pmac_dma_stop
c_func
(paren
id|rec
)paren
suffix:semicolon
id|astr
op_assign
id|snd_pmac_get_stream
c_func
(paren
id|chip
comma
id|another_stream
c_func
(paren
id|rec-&gt;stream
)paren
)paren
suffix:semicolon
id|snd_runtime_check
c_func
(paren
id|astr
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* reset constraints */
id|astr-&gt;cur_freqs
op_assign
id|chip-&gt;freqs_ok
suffix:semicolon
id|astr-&gt;cur_formats
op_assign
id|chip-&gt;formats_ok
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_playback_open
r_static
r_int
id|snd_pmac_playback_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
id|subs-&gt;runtime-&gt;hw
op_assign
id|snd_pmac_playback
suffix:semicolon
r_return
id|snd_pmac_pcm_open
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;playback
comma
id|subs
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_capture_open
r_static
r_int
id|snd_pmac_capture_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
id|subs-&gt;runtime-&gt;hw
op_assign
id|snd_pmac_capture
suffix:semicolon
r_return
id|snd_pmac_pcm_open
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;capture
comma
id|subs
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_playback_close
r_static
r_int
id|snd_pmac_playback_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
id|snd_pmac_pcm_close
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;playback
comma
id|subs
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_capture_close
r_static
r_int
id|snd_pmac_capture_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
id|snd_pmac_pcm_close
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;capture
comma
id|subs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|variable|snd_pmac_playback_ops
r_static
id|snd_pcm_ops_t
id|snd_pmac_playback_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_pmac_playback_open
comma
dot
id|close
op_assign
id|snd_pmac_playback_close
comma
dot
id|ioctl
op_assign
id|snd_pcm_lib_ioctl
comma
dot
id|hw_params
op_assign
id|snd_pmac_pcm_hw_params
comma
dot
id|hw_free
op_assign
id|snd_pmac_pcm_hw_free
comma
dot
id|prepare
op_assign
id|snd_pmac_playback_prepare
comma
dot
id|trigger
op_assign
id|snd_pmac_playback_trigger
comma
dot
id|pointer
op_assign
id|snd_pmac_playback_pointer
comma
)brace
suffix:semicolon
DECL|variable|snd_pmac_capture_ops
r_static
id|snd_pcm_ops_t
id|snd_pmac_capture_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_pmac_capture_open
comma
dot
id|close
op_assign
id|snd_pmac_capture_close
comma
dot
id|ioctl
op_assign
id|snd_pcm_lib_ioctl
comma
dot
id|hw_params
op_assign
id|snd_pmac_pcm_hw_params
comma
dot
id|hw_free
op_assign
id|snd_pmac_pcm_hw_free
comma
dot
id|prepare
op_assign
id|snd_pmac_capture_prepare
comma
dot
id|trigger
op_assign
id|snd_pmac_capture_trigger
comma
dot
id|pointer
op_assign
id|snd_pmac_capture_pointer
comma
)brace
suffix:semicolon
DECL|function|pmac_pcm_free
r_static
r_void
id|pmac_pcm_free
c_func
(paren
id|snd_pcm_t
op_star
id|pcm
)paren
(brace
id|snd_pcm_lib_preallocate_free_for_all
c_func
(paren
id|pcm
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_pcm_new
r_int
id|__init
id|snd_pmac_pcm_new
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|num_captures
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;can_capture
)paren
id|num_captures
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|snd_pcm_new
c_func
(paren
id|chip-&gt;card
comma
id|chip-&gt;card-&gt;driver
comma
l_int|0
comma
l_int|1
comma
id|num_captures
comma
op_amp
id|pcm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_PLAYBACK
comma
op_amp
id|snd_pmac_playback_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;can_capture
)paren
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_CAPTURE
comma
op_amp
id|snd_pmac_capture_ops
)paren
suffix:semicolon
id|pcm-&gt;private_data
op_assign
id|chip
suffix:semicolon
id|pcm-&gt;private_free
op_assign
id|pmac_pcm_free
suffix:semicolon
id|pcm-&gt;info_flags
op_assign
id|SNDRV_PCM_INFO_JOINT_DUPLEX
suffix:semicolon
id|strcpy
c_func
(paren
id|pcm-&gt;name
comma
id|chip-&gt;card-&gt;shortname
)paren
suffix:semicolon
id|chip-&gt;pcm
op_assign
id|pcm
suffix:semicolon
id|chip-&gt;formats_ok
op_assign
id|SNDRV_PCM_FMTBIT_S16_BE
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;can_byte_swap
)paren
id|chip-&gt;formats_ok
op_or_assign
id|SNDRV_PCM_FMTBIT_S16_LE
suffix:semicolon
id|chip-&gt;playback.cur_formats
op_assign
id|chip-&gt;formats_ok
suffix:semicolon
id|chip-&gt;capture.cur_formats
op_assign
id|chip-&gt;formats_ok
suffix:semicolon
id|chip-&gt;playback.cur_freqs
op_assign
id|chip-&gt;freqs_ok
suffix:semicolon
id|chip-&gt;capture.cur_freqs
op_assign
id|chip-&gt;freqs_ok
suffix:semicolon
multiline_comment|/* preallocate 64k buffer */
id|snd_pcm_lib_preallocate_pages_for_all
c_func
(paren
id|pcm
comma
id|SNDRV_DMA_TYPE_CONTINUOUS
comma
id|snd_dma_continuous_data
c_func
(paren
id|GFP_KERNEL
)paren
comma
l_int|64
op_star
l_int|1024
comma
l_int|64
op_star
l_int|1024
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_dbdma_reset
r_static
r_void
id|snd_pmac_dbdma_reset
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;playback.dma-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
op_or
id|DEAD
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|snd_pmac_wait_ack
c_func
(paren
op_amp
id|chip-&gt;playback
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;capture.dma-&gt;control
comma
(paren
id|RUN
op_or
id|PAUSE
op_or
id|FLUSH
op_or
id|WAKE
op_or
id|DEAD
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|snd_pmac_wait_ack
c_func
(paren
op_amp
id|chip-&gt;capture
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * handling beep&n; */
DECL|function|snd_pmac_beep_dma_start
r_void
id|snd_pmac_beep_dma_start
c_func
(paren
id|pmac_t
op_star
id|chip
comma
r_int
id|bytes
comma
r_int
r_int
id|addr
comma
r_int
id|speed
)paren
(brace
id|pmac_stream_t
op_star
id|rec
op_assign
op_amp
id|chip-&gt;playback
suffix:semicolon
id|snd_pmac_dma_stop
c_func
(paren
id|rec
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|chip-&gt;extra_dma.cmds-&gt;req_count
comma
id|bytes
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|chip-&gt;extra_dma.cmds-&gt;xfer_status
comma
l_int|0
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|chip-&gt;extra_dma.cmds-&gt;cmd_dep
comma
id|chip-&gt;extra_dma.addr
)paren
suffix:semicolon
id|st_le32
c_func
(paren
op_amp
id|chip-&gt;extra_dma.cmds-&gt;phy_addr
comma
id|addr
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|chip-&gt;extra_dma.cmds-&gt;command
comma
id|OUTPUT_MORE
op_plus
id|BR_ALWAYS
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;control
comma
(paren
id|in_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;control
)paren
op_amp
op_complement
l_int|0x1f00
)paren
op_or
(paren
id|speed
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;byteswap
comma
l_int|0
)paren
suffix:semicolon
id|snd_pmac_dma_set_command
c_func
(paren
id|rec
comma
op_amp
id|chip-&gt;extra_dma
)paren
suffix:semicolon
id|snd_pmac_dma_run
c_func
(paren
id|rec
comma
id|RUN
)paren
suffix:semicolon
)brace
DECL|function|snd_pmac_beep_dma_stop
r_void
id|snd_pmac_beep_dma_stop
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|snd_pmac_dma_stop
c_func
(paren
op_amp
id|chip-&gt;playback
)paren
suffix:semicolon
id|st_le16
c_func
(paren
op_amp
id|chip-&gt;extra_dma.cmds-&gt;command
comma
id|DBDMA_STOP
)paren
suffix:semicolon
id|snd_pmac_pcm_set_format
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* reset format */
)brace
multiline_comment|/*&n; * interrupt handlers&n; */
r_static
id|irqreturn_t
DECL|function|snd_pmac_tx_intr
id|snd_pmac_tx_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devid
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|devid
suffix:semicolon
id|snd_pmac_pcm_update
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;playback
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|snd_pmac_rx_intr
id|snd_pmac_rx_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devid
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|devid
suffix:semicolon
id|snd_pmac_pcm_update
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;capture
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|snd_pmac_ctrl_intr
id|snd_pmac_ctrl_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devid
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|devid
suffix:semicolon
r_int
id|ctrl
op_assign
id|in_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;control
)paren
suffix:semicolon
multiline_comment|/*printk(&quot;pmac: control interrupt.. 0x%x&bslash;n&quot;, ctrl);*/
r_if
c_cond
(paren
id|ctrl
op_amp
id|MASK_PORTCHG
)paren
(brace
multiline_comment|/* do something when headphone is plugged/unplugged? */
r_if
c_cond
(paren
id|chip-&gt;update_automute
)paren
id|chip
op_member_access_from_pointer
id|update_automute
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctrl
op_amp
id|MASK_CNTLERR
)paren
(brace
r_int
id|err
op_assign
(paren
id|in_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;codec_stat
)paren
op_amp
id|MASK_ERRCODE
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_and
id|chip-&gt;model
op_le
id|PMAC_SCREAMER
)paren
id|snd_printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;error %x&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
)brace
multiline_comment|/* Writing 1s to the CNTLERR and PORTCHG bits clears them... */
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;control
comma
id|ctrl
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * a wrapper to feature call for compatibility&n; */
macro_line|#if defined(CONFIG_PM) &amp;&amp; defined(CONFIG_PMAC_PBOOK)
DECL|function|snd_pmac_sound_feature
r_static
r_void
id|snd_pmac_sound_feature
c_func
(paren
id|pmac_t
op_star
id|chip
comma
r_int
id|enable
)paren
(brace
macro_line|#ifdef CONFIG_PPC_HAS_FEATURE_CALLS
id|ppc_md
dot
id|feature_call
c_func
(paren
id|PMAC_FTR_SOUND_CHIP_ENABLE
comma
id|chip-&gt;node
comma
l_int|0
comma
id|enable
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|chip-&gt;is_pbook_G3
)paren
(brace
id|pmu_suspend
c_func
(paren
)paren
suffix:semicolon
id|feature_clear
c_func
(paren
id|chip-&gt;node
comma
id|FEATURE_Sound_power
)paren
suffix:semicolon
id|feature_clear
c_func
(paren
id|chip-&gt;node
comma
id|FEATURE_Sound_CLK_enable
)paren
suffix:semicolon
id|big_mdelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* XXX */
id|pmu_resume
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chip-&gt;is_pbook_3400
)paren
(brace
id|feature_set
c_func
(paren
id|chip-&gt;node
comma
id|FEATURE_IOBUS_enable
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#else /* CONFIG_PM &amp;&amp; CONFIG_PMAC_PBOOK */
DECL|macro|snd_pmac_sound_feature
mdefine_line|#define snd_pmac_sound_feature(chip,enable) /**/
macro_line|#endif /* CONFIG_PM &amp;&amp; CONFIG_PMAC_PBOOK */
multiline_comment|/*&n; * release resources&n; */
DECL|function|snd_pmac_free
r_static
r_int
id|snd_pmac_free
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* stop sounds */
r_if
c_cond
(paren
id|chip-&gt;initialized
)paren
(brace
id|snd_pmac_dbdma_reset
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* disable interrupts from awacs interface */
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;control
comma
id|in_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;control
)paren
op_amp
l_int|0xfff
)paren
suffix:semicolon
)brace
id|snd_pmac_sound_feature
c_func
(paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PM) &amp;&amp; defined(CONFIG_PMAC_PBOOK)
id|snd_pmac_unregister_sleep_notifier
c_func
(paren
id|chip
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* clean up mixer if any */
r_if
c_cond
(paren
id|chip-&gt;mixer_free
)paren
id|chip
op_member_access_from_pointer
id|mixer_free
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_pmac_detach_beep
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* release resources */
r_if
c_cond
(paren
id|chip-&gt;irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|chip-&gt;irq
comma
(paren
r_void
op_star
)paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;tx_irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|chip-&gt;tx_irq
comma
(paren
r_void
op_star
)paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;rx_irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|chip-&gt;rx_irq
comma
(paren
r_void
op_star
)paren
id|chip
)paren
suffix:semicolon
id|snd_pmac_dbdma_free
c_func
(paren
op_amp
id|chip-&gt;playback.cmd
)paren
suffix:semicolon
id|snd_pmac_dbdma_free
c_func
(paren
op_amp
id|chip-&gt;capture.cmd
)paren
suffix:semicolon
id|snd_pmac_dbdma_free
c_func
(paren
op_amp
id|chip-&gt;extra_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;macio_base
)paren
id|iounmap
c_func
(paren
id|chip-&gt;macio_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;latch_base
)paren
id|iounmap
c_func
(paren
id|chip-&gt;latch_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;awacs
)paren
id|iounmap
c_func
(paren
id|chip-&gt;awacs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;playback.dma
)paren
id|iounmap
c_func
(paren
id|chip-&gt;playback.dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;capture.dma
)paren
id|iounmap
c_func
(paren
id|chip-&gt;capture.dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;node
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;of_requested
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|release_OF_resource
c_func
(paren
id|chip-&gt;node
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * free the device&n; */
DECL|function|snd_pmac_dev_free
r_static
r_int
id|snd_pmac_dev_free
c_func
(paren
id|snd_device_t
op_star
id|device
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|device-&gt;device_data
suffix:semicolon
r_return
id|snd_pmac_free
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * check the machine support byteswap (little-endian)&n; */
DECL|function|detect_byte_swap
r_static
r_void
id|__init
id|detect_byte_swap
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_struct
id|device_node
op_star
id|mio
suffix:semicolon
multiline_comment|/* if seems that Keylargo can&squot;t byte-swap  */
r_for
c_loop
(paren
id|mio
op_assign
id|chip-&gt;node-&gt;parent
suffix:semicolon
id|mio
suffix:semicolon
id|mio
op_assign
id|mio-&gt;parent
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|mio-&gt;name
comma
l_string|&quot;mac-io&quot;
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|mio
comma
l_string|&quot;Keylargo&quot;
)paren
)paren
id|chip-&gt;can_byte_swap
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* it seems the Pismo &amp; iBook can&squot;t byte-swap in hardware. */
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook3,1&quot;
)paren
op_logical_or
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook2,1&quot;
)paren
)paren
id|chip-&gt;can_byte_swap
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook2,1&quot;
)paren
)paren
id|chip-&gt;can_duplex
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * detect a sound chip&n; */
DECL|function|snd_pmac_detect
r_static
r_int
id|__init
id|snd_pmac_detect
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_struct
id|device_node
op_star
id|sound
suffix:semicolon
r_int
r_int
op_star
id|prop
comma
id|l
suffix:semicolon
r_if
c_cond
(paren
id|_machine
op_ne
id|_MACH_Pmac
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|chip-&gt;subframe
op_assign
l_int|0
suffix:semicolon
id|chip-&gt;revision
op_assign
l_int|0
suffix:semicolon
id|chip-&gt;freqs_ok
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* all ok */
id|chip-&gt;model
op_assign
id|PMAC_AWACS
suffix:semicolon
id|chip-&gt;can_byte_swap
op_assign
l_int|1
suffix:semicolon
id|chip-&gt;can_duplex
op_assign
l_int|1
suffix:semicolon
id|chip-&gt;can_capture
op_assign
l_int|1
suffix:semicolon
id|chip-&gt;num_freqs
op_assign
id|ARRAY_SIZE
c_func
(paren
id|awacs_freqs
)paren
suffix:semicolon
id|chip-&gt;freq_table
op_assign
id|awacs_freqs
suffix:semicolon
id|chip-&gt;control_mask
op_assign
id|MASK_IEPC
op_or
id|MASK_IEE
op_or
l_int|0x11
suffix:semicolon
multiline_comment|/* default */
multiline_comment|/* check machine type */
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;AAPL,3400/2400&quot;
)paren
op_logical_or
id|machine_is_compatible
c_func
(paren
l_string|&quot;AAPL,3500&quot;
)paren
)paren
id|chip-&gt;is_pbook_3400
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|machine_is_compatible
c_func
(paren
l_string|&quot;PowerBook1,1&quot;
)paren
op_logical_or
id|machine_is_compatible
c_func
(paren
l_string|&quot;AAPL,PowerBook1998&quot;
)paren
)paren
id|chip-&gt;is_pbook_G3
op_assign
l_int|1
suffix:semicolon
id|chip-&gt;node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;awacs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;node
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ok */
multiline_comment|/*&n;&t; * powermac G3 models have a node called &quot;davbus&quot;&n;&t; * with a child called &quot;sound&quot;.&n;&t; */
id|chip-&gt;node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;davbus&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * if we didn&squot;t find a davbus device, try &squot;i2s-a&squot; since&n;&t; * this seems to be what iBooks have&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;node
)paren
id|chip-&gt;node
op_assign
id|find_devices
c_func
(paren
l_string|&quot;i2s-a&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;node
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sound
op_assign
id|find_devices
c_func
(paren
l_string|&quot;sound&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sound
op_logical_and
id|sound-&gt;parent
op_ne
id|chip-&gt;node
)paren
id|sound
op_assign
id|sound-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sound
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|prop
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|sound
comma
l_string|&quot;sub-frame&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prop
op_logical_and
op_star
id|prop
OL
l_int|16
)paren
id|chip-&gt;subframe
op_assign
op_star
id|prop
suffix:semicolon
multiline_comment|/* This should be verified on older screamers */
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|sound
comma
l_string|&quot;screamer&quot;
)paren
)paren
(brace
id|chip-&gt;model
op_assign
id|PMAC_SCREAMER
suffix:semicolon
singleline_comment|// chip-&gt;can_byte_swap = 0; /* FIXME: check this */
)brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|sound
comma
l_string|&quot;burgundy&quot;
)paren
)paren
(brace
id|chip-&gt;model
op_assign
id|PMAC_BURGUNDY
suffix:semicolon
id|chip-&gt;control_mask
op_assign
id|MASK_IEPC
op_or
l_int|0x11
suffix:semicolon
multiline_comment|/* disable IEE */
)brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|sound
comma
l_string|&quot;daca&quot;
)paren
)paren
(brace
id|chip-&gt;model
op_assign
id|PMAC_DACA
suffix:semicolon
id|chip-&gt;can_capture
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no capture */
id|chip-&gt;can_duplex
op_assign
l_int|0
suffix:semicolon
singleline_comment|// chip-&gt;can_byte_swap = 0; /* FIXME: check this */
id|chip-&gt;control_mask
op_assign
id|MASK_IEPC
op_or
l_int|0x11
suffix:semicolon
multiline_comment|/* disable IEE */
)brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|sound
comma
l_string|&quot;tumbler&quot;
)paren
)paren
(brace
id|chip-&gt;model
op_assign
id|PMAC_TUMBLER
suffix:semicolon
id|chip-&gt;can_capture
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no capture */
id|chip-&gt;can_duplex
op_assign
l_int|0
suffix:semicolon
singleline_comment|// chip-&gt;can_byte_swap = 0; /* FIXME: check this */
id|chip-&gt;num_freqs
op_assign
id|ARRAY_SIZE
c_func
(paren
id|tumbler_freqs
)paren
suffix:semicolon
id|chip-&gt;freq_table
op_assign
id|tumbler_freqs
suffix:semicolon
id|chip-&gt;control_mask
op_assign
id|MASK_IEPC
op_or
l_int|0x11
suffix:semicolon
multiline_comment|/* disable IEE */
)brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|sound
comma
l_string|&quot;snapper&quot;
)paren
)paren
(brace
id|chip-&gt;model
op_assign
id|PMAC_SNAPPER
suffix:semicolon
singleline_comment|// chip-&gt;can_byte_swap = 0; /* FIXME: check this */
id|chip-&gt;num_freqs
op_assign
id|ARRAY_SIZE
c_func
(paren
id|tumbler_freqs
)paren
suffix:semicolon
id|chip-&gt;freq_table
op_assign
id|tumbler_freqs
suffix:semicolon
id|chip-&gt;control_mask
op_assign
id|MASK_IEPC
op_or
l_int|0x11
suffix:semicolon
multiline_comment|/* disable IEE */
)brace
r_if
c_cond
(paren
id|device_is_compatible
c_func
(paren
id|sound
comma
l_string|&quot;AOAKeylargo&quot;
)paren
)paren
(brace
multiline_comment|/* Seems to support the stock AWACS frequencies, but has&n;&t;&t;   a snapper mixer */
id|chip-&gt;model
op_assign
id|PMAC_SNAPPER
suffix:semicolon
singleline_comment|// chip-&gt;can_byte_swap = 0; /* FIXME: check this */
id|chip-&gt;control_mask
op_assign
id|MASK_IEPC
op_or
l_int|0x11
suffix:semicolon
multiline_comment|/* disable IEE */
)brace
id|prop
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|sound
comma
l_string|&quot;device-id&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prop
)paren
id|chip-&gt;device_id
op_assign
op_star
id|prop
suffix:semicolon
id|chip-&gt;has_iic
op_assign
(paren
id|find_devices
c_func
(paren
l_string|&quot;perch&quot;
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
id|detect_byte_swap
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* look for a property saying what sample rates&n;&t;   are available */
id|prop
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|sound
comma
l_string|&quot;sample-rates&quot;
comma
op_amp
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|prop
)paren
id|prop
op_assign
(paren
r_int
r_int
op_star
)paren
id|get_property
c_func
(paren
id|sound
comma
l_string|&quot;output-frame-rates&quot;
comma
op_amp
id|l
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prop
)paren
(brace
r_int
id|i
suffix:semicolon
id|chip-&gt;freqs_ok
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|l
op_div_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|l
OG
l_int|0
suffix:semicolon
op_decrement
id|l
)paren
(brace
r_int
r_int
id|r
op_assign
op_star
id|prop
op_increment
suffix:semicolon
multiline_comment|/* Apple &squot;Fixed&squot; format */
r_if
c_cond
(paren
id|r
op_ge
l_int|0x10000
)paren
id|r
op_rshift_assign
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|chip-&gt;num_freqs
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|r
op_eq
id|chip-&gt;freq_table
(braket
id|i
)braket
)paren
(brace
id|chip-&gt;freqs_ok
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* assume only 44.1khz */
id|chip-&gt;freqs_ok
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * exported - boolean info callbacks for ease of programming&n; */
DECL|function|snd_pmac_boolean_stereo_info
r_int
id|snd_pmac_boolean_stereo_info
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_BOOLEAN
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|2
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_boolean_mono_info
r_int
id|snd_pmac_boolean_mono_info
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_BOOLEAN
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef PMAC_SUPPORT_AUTOMUTE
multiline_comment|/*&n; * auto-mute&n; */
DECL|function|pmac_auto_mute_get
r_static
r_int
id|pmac_auto_mute_get
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|chip-&gt;auto_mute
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pmac_auto_mute_put
r_static
r_int
id|pmac_auto_mute_put
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_ne
id|chip-&gt;auto_mute
)paren
(brace
id|chip-&gt;auto_mute
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;update_automute
)paren
id|chip
op_member_access_from_pointer
id|update_automute
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pmac_hp_detect_get
r_static
r_int
id|pmac_hp_detect_get
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;detect_headphone
)paren
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|chip
op_member_access_from_pointer
id|detect_headphone
c_func
(paren
id|chip
)paren
suffix:semicolon
r_else
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
id|snd_kcontrol_new_t
id|auto_mute_controls
(braket
)braket
id|__initdata
op_assign
(brace
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Auto Mute Switch&quot;
comma
dot
id|info
op_assign
id|snd_pmac_boolean_mono_info
comma
dot
id|get
op_assign
id|pmac_auto_mute_get
comma
dot
id|put
op_assign
id|pmac_auto_mute_put
comma
)brace
comma
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Headphone Detection&quot;
comma
dot
id|access
op_assign
id|SNDRV_CTL_ELEM_ACCESS_READ
comma
dot
id|info
op_assign
id|snd_pmac_boolean_mono_info
comma
dot
id|get
op_assign
id|pmac_hp_detect_get
comma
)brace
comma
)brace
suffix:semicolon
DECL|function|snd_pmac_add_automute
r_int
id|__init
id|snd_pmac_add_automute
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_int
id|err
suffix:semicolon
id|chip-&gt;auto_mute
op_assign
l_int|1
suffix:semicolon
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|auto_mute_controls
(braket
l_int|0
)braket
comma
id|chip
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|chip-&gt;hp_detect_ctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|auto_mute_controls
(braket
l_int|1
)braket
comma
id|chip
)paren
suffix:semicolon
r_return
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|chip-&gt;hp_detect_ctl
)paren
suffix:semicolon
)brace
macro_line|#endif /* PMAC_SUPPORT_AUTOMUTE */
multiline_comment|/*&n; * create and detect a pmac chip record&n; */
DECL|function|snd_pmac_new
r_int
id|__init
id|snd_pmac_new
c_func
(paren
id|snd_card_t
op_star
id|card
comma
id|pmac_t
op_star
op_star
id|chip_return
)paren
(brace
id|pmac_t
op_star
id|chip
suffix:semicolon
r_struct
id|device_node
op_star
id|np
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
r_static
id|snd_device_ops_t
id|ops
op_assign
(brace
dot
id|dev_free
op_assign
id|snd_pmac_dev_free
comma
)brace
suffix:semicolon
id|snd_runtime_check
c_func
(paren
id|chip_return
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
op_star
id|chip_return
op_assign
l_int|NULL
suffix:semicolon
id|chip
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|chip
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|chip-&gt;card
op_assign
id|card
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|chip-&gt;irq
op_assign
id|chip-&gt;tx_irq
op_assign
id|chip-&gt;rx_irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|chip-&gt;playback.stream
op_assign
id|SNDRV_PCM_STREAM_PLAYBACK
suffix:semicolon
id|chip-&gt;capture.stream
op_assign
id|SNDRV_PCM_STREAM_CAPTURE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pmac_detect
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_goto
id|__error
suffix:semicolon
r_if
c_cond
(paren
id|snd_pmac_dbdma_alloc
c_func
(paren
op_amp
id|chip-&gt;playback.cmd
comma
id|PMAC_MAX_FRAGS
op_plus
l_int|1
)paren
OL
l_int|0
op_logical_or
id|snd_pmac_dbdma_alloc
c_func
(paren
op_amp
id|chip-&gt;capture.cmd
comma
id|PMAC_MAX_FRAGS
op_plus
l_int|1
)paren
OL
l_int|0
op_logical_or
id|snd_pmac_dbdma_alloc
c_func
(paren
op_amp
id|chip-&gt;extra_dma
comma
l_int|2
)paren
OL
l_int|0
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|__error
suffix:semicolon
)brace
id|np
op_assign
id|chip-&gt;node
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;n_addrs
OL
l_int|3
op_logical_or
id|np-&gt;n_intrs
OL
l_int|3
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|__error
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_static
r_char
op_star
id|name
(braket
l_int|3
)braket
op_assign
(brace
l_int|NULL
comma
l_string|&quot;- Tx DMA&quot;
comma
l_string|&quot;- Rx DMA&quot;
)brace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_OF_resource
c_func
(paren
id|np
comma
id|i
comma
id|name
(braket
id|i
)braket
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac: can&squot;t request resource %d!&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|__error
suffix:semicolon
)brace
id|chip-&gt;of_requested
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
)brace
id|chip-&gt;awacs
op_assign
id|ioremap
c_func
(paren
id|np-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x1000
)paren
suffix:semicolon
id|chip-&gt;playback.dma
op_assign
id|ioremap
c_func
(paren
id|np-&gt;addrs
(braket
l_int|1
)braket
dot
id|address
comma
l_int|0x100
)paren
suffix:semicolon
id|chip-&gt;capture.dma
op_assign
id|ioremap
c_func
(paren
id|np-&gt;addrs
(braket
l_int|2
)braket
dot
id|address
comma
l_int|0x100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;model
op_le
id|PMAC_BURGUNDY
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|np-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
comma
id|snd_pmac_ctrl_intr
comma
l_int|0
comma
l_string|&quot;PMac&quot;
comma
(paren
r_void
op_star
)paren
id|chip
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac: unable to grab IRQ %d&bslash;n&quot;
comma
id|np-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|__error
suffix:semicolon
)brace
id|chip-&gt;irq
op_assign
id|np-&gt;intrs
(braket
l_int|0
)braket
dot
id|line
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|np-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
comma
id|snd_pmac_tx_intr
comma
l_int|0
comma
l_string|&quot;PMac Output&quot;
comma
(paren
r_void
op_star
)paren
id|chip
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac: unable to grab IRQ %d&bslash;n&quot;
comma
id|np-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|__error
suffix:semicolon
)brace
id|chip-&gt;tx_irq
op_assign
id|np-&gt;intrs
(braket
l_int|1
)braket
dot
id|line
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|np-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
comma
id|snd_pmac_rx_intr
comma
l_int|0
comma
l_string|&quot;PMac Input&quot;
comma
(paren
r_void
op_star
)paren
id|chip
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pmac: unable to grab IRQ %d&bslash;n&quot;
comma
id|np-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|__error
suffix:semicolon
)brace
id|chip-&gt;rx_irq
op_assign
id|np-&gt;intrs
(braket
l_int|2
)braket
dot
id|line
suffix:semicolon
id|snd_pmac_sound_feature
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* reset */
id|out_le32
c_func
(paren
op_amp
id|chip-&gt;awacs-&gt;control
comma
l_int|0x11
)paren
suffix:semicolon
multiline_comment|/* Powerbooks have odd ways of enabling inputs such as&n;&t;   an expansion-bay CD or sound from an internal modem&n;&t;   or a PC-card modem. */
r_if
c_cond
(paren
id|chip-&gt;is_pbook_3400
)paren
(brace
multiline_comment|/* Enable CD and PC-card sound inputs. */
multiline_comment|/* This is done by reading from address&n;&t;&t; * f301a000, + 0x10 to enable the expansion-bay&n;&t;&t; * CD sound input, + 0x80 to enable the PC-card&n;&t;&t; * sound input.  The 0x100 enables the SCSI bus&n;&t;&t; * terminator power.&n;&t;&t; */
id|chip-&gt;latch_base
op_assign
id|ioremap
(paren
l_int|0xf301a000
comma
l_int|0x1000
)paren
suffix:semicolon
id|in_8
c_func
(paren
id|chip-&gt;latch_base
op_plus
l_int|0x190
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chip-&gt;is_pbook_G3
)paren
(brace
r_struct
id|device_node
op_star
id|mio
suffix:semicolon
r_for
c_loop
(paren
id|mio
op_assign
id|chip-&gt;node-&gt;parent
suffix:semicolon
id|mio
suffix:semicolon
id|mio
op_assign
id|mio-&gt;parent
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|mio-&gt;name
comma
l_string|&quot;mac-io&quot;
)paren
op_eq
l_int|0
op_logical_and
id|mio-&gt;n_addrs
OG
l_int|0
)paren
(brace
id|chip-&gt;macio_base
op_assign
id|ioremap
c_func
(paren
id|mio-&gt;addrs
(braket
l_int|0
)braket
dot
id|address
comma
l_int|0x40
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Enable CD sound input. */
multiline_comment|/* The relevant bits for writing to this byte are 0x8f.&n;&t;&t; * I haven&squot;t found out what the 0x80 bit does.&n;&t;&t; * For the 0xf bits, writing 3 or 7 enables the CD&n;&t;&t; * input, any other value disables it.  Values&n;&t;&t; * 1, 3, 5, 7 enable the microphone.  Values 0, 2,&n;&t;&t; * 4, 6, 8 - f enable the input from the modem.&n;&t;&t; */
r_if
c_cond
(paren
id|chip-&gt;macio_base
)paren
id|out_8
c_func
(paren
id|chip-&gt;macio_base
op_plus
l_int|0x37
comma
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset dbdma channels */
id|snd_pmac_dbdma_reset
c_func
(paren
id|chip
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PM) &amp;&amp; defined(CONFIG_PMAC_PBOOK)
multiline_comment|/* add sleep notifier */
r_if
c_cond
(paren
op_logical_neg
id|snd_pmac_register_sleep_notifier
c_func
(paren
id|chip
)paren
)paren
id|snd_card_set_pm_callback
c_func
(paren
id|chip-&gt;card
comma
id|snd_pmac_suspend
comma
id|snd_pmac_resume
comma
id|chip
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_device_new
c_func
(paren
id|card
comma
id|SNDRV_DEV_LOWLEVEL
comma
id|chip
comma
op_amp
id|ops
)paren
)paren
OL
l_int|0
)paren
r_goto
id|__error
suffix:semicolon
op_star
id|chip_return
op_assign
id|chip
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|__error
suffix:colon
id|snd_pmac_free
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * sleep notify for powerbook&n; */
macro_line|#if defined(CONFIG_PM) &amp;&amp; defined(CONFIG_PMAC_PBOOK)
multiline_comment|/*&n; * Save state when going to sleep, restore it afterwards.&n; */
DECL|function|snd_pmac_suspend
r_static
r_int
id|snd_pmac_suspend
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
r_int
id|state
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|card-&gt;pm_private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;suspend
)paren
id|chip
op_member_access_from_pointer
id|suspend
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_pcm_suspend_all
c_func
(paren
id|chip-&gt;pcm
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|snd_pmac_beep_stop
c_func
(paren
id|chip
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;irq
op_ge
l_int|0
)paren
id|disable_irq
c_func
(paren
id|chip-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;tx_irq
op_ge
l_int|0
)paren
id|disable_irq
c_func
(paren
id|chip-&gt;tx_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;rx_irq
op_ge
l_int|0
)paren
id|disable_irq
c_func
(paren
id|chip-&gt;rx_irq
)paren
suffix:semicolon
id|snd_pmac_sound_feature
c_func
(paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_resume
r_static
r_int
id|snd_pmac_resume
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
r_int
id|state
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|card-&gt;pm_private_data
suffix:semicolon
id|snd_pmac_sound_feature
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;resume
)paren
id|chip
op_member_access_from_pointer
id|resume
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* enable CD sound input */
r_if
c_cond
(paren
id|chip-&gt;macio_base
op_logical_and
id|chip-&gt;is_pbook_G3
)paren
(brace
id|out_8
c_func
(paren
id|chip-&gt;macio_base
op_plus
l_int|0x37
comma
l_int|3
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chip-&gt;is_pbook_3400
)paren
(brace
id|in_8
c_func
(paren
id|chip-&gt;latch_base
op_plus
l_int|0x190
)paren
suffix:semicolon
)brace
id|snd_pmac_pcm_set_format
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;irq
op_ge
l_int|0
)paren
id|enable_irq
c_func
(paren
id|chip-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;tx_irq
op_ge
l_int|0
)paren
id|enable_irq
c_func
(paren
id|chip-&gt;tx_irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;rx_irq
op_ge
l_int|0
)paren
id|enable_irq
c_func
(paren
id|chip-&gt;rx_irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* the chip is stored statically by snd_pmac_register_sleep_notifier&n; * because we can&squot;t have any private data for notify callback.&n; */
DECL|variable|sleeping_pmac
r_static
id|pmac_t
op_star
id|sleeping_pmac
op_assign
l_int|NULL
suffix:semicolon
DECL|function|snd_pmac_sleep_notify
r_static
r_int
id|snd_pmac_sleep_notify
c_func
(paren
r_struct
id|pmu_sleep_notifier
op_star
id|self
comma
r_int
id|when
)paren
(brace
id|pmac_t
op_star
id|chip
suffix:semicolon
id|chip
op_assign
id|sleeping_pmac
suffix:semicolon
id|snd_runtime_check
c_func
(paren
id|chip
comma
r_return
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|when
)paren
(brace
r_case
id|PBOOK_SLEEP_NOW
suffix:colon
id|snd_pmac_suspend
c_func
(paren
id|chip-&gt;card
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PBOOK_WAKE
suffix:colon
id|snd_pmac_resume
c_func
(paren
id|chip-&gt;card
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|PBOOK_SLEEP_OK
suffix:semicolon
)brace
DECL|variable|snd_pmac_sleep_notifier
r_static
r_struct
id|pmu_sleep_notifier
id|snd_pmac_sleep_notifier
op_assign
(brace
id|snd_pmac_sleep_notify
comma
id|SLEEP_LEVEL_SOUND
comma
)brace
suffix:semicolon
DECL|function|snd_pmac_register_sleep_notifier
r_static
r_int
id|__init
id|snd_pmac_register_sleep_notifier
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
multiline_comment|/* should be protected here.. */
id|snd_assert
c_func
(paren
op_logical_neg
id|sleeping_pmac
comma
r_return
op_minus
id|EBUSY
)paren
suffix:semicolon
id|sleeping_pmac
op_assign
id|chip
suffix:semicolon
id|pmu_register_sleep_notifier
c_func
(paren
op_amp
id|snd_pmac_sleep_notifier
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_unregister_sleep_notifier
r_static
r_int
id|snd_pmac_unregister_sleep_notifier
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
multiline_comment|/* should be protected here.. */
id|snd_assert
c_func
(paren
id|sleeping_pmac
op_eq
id|chip
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|pmu_unregister_sleep_notifier
c_func
(paren
op_amp
id|snd_pmac_sleep_notifier
)paren
suffix:semicolon
id|sleeping_pmac
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PM &amp;&amp; CONFIG_PMAC_PBOOK */
eof
