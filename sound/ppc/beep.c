multiline_comment|/*&n; * Beep using pcm&n; *&n; * Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/control.h&gt;
macro_line|#include &quot;pmac.h&quot;
DECL|struct|snd_pmac_beep
r_struct
id|snd_pmac_beep
(brace
DECL|member|running
r_int
id|running
suffix:semicolon
multiline_comment|/* boolean */
DECL|member|volume
r_int
id|volume
suffix:semicolon
multiline_comment|/* mixer volume: 0-100 */
DECL|member|volume_play
r_int
id|volume_play
suffix:semicolon
multiline_comment|/* currently playing volume */
DECL|member|hz
r_int
id|hz
suffix:semicolon
DECL|member|nsamples
r_int
id|nsamples
suffix:semicolon
DECL|member|buf
r_int
op_star
id|buf
suffix:semicolon
multiline_comment|/* allocated wave buffer */
DECL|member|addr
r_int
r_int
id|addr
suffix:semicolon
multiline_comment|/* physical address of buffer */
DECL|member|dev
r_struct
id|input_dev
id|dev
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * stop beep if running&n; */
DECL|function|snd_pmac_beep_stop
r_void
id|snd_pmac_beep_stop
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_beep_t
op_star
id|beep
op_assign
id|chip-&gt;beep
suffix:semicolon
r_if
c_cond
(paren
id|beep
op_logical_and
id|beep-&gt;running
)paren
(brace
id|beep-&gt;running
op_assign
l_int|0
suffix:semicolon
id|snd_pmac_beep_dma_stop
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Stuff for outputting a beep.  The values range from -327 to +327&n; * so we can multiply by an amplitude in the range 0..100 to get a&n; * signed short value to put in the output buffer.&n; */
DECL|variable|beep_wform
r_static
r_int
id|beep_wform
(braket
l_int|256
)braket
op_assign
(brace
l_int|0
comma
l_int|40
comma
l_int|79
comma
l_int|117
comma
l_int|153
comma
l_int|187
comma
l_int|218
comma
l_int|245
comma
l_int|269
comma
l_int|288
comma
l_int|304
comma
l_int|316
comma
l_int|323
comma
l_int|327
comma
l_int|327
comma
l_int|324
comma
l_int|318
comma
l_int|310
comma
l_int|299
comma
l_int|288
comma
l_int|275
comma
l_int|262
comma
l_int|249
comma
l_int|236
comma
l_int|224
comma
l_int|213
comma
l_int|204
comma
l_int|196
comma
l_int|190
comma
l_int|186
comma
l_int|183
comma
l_int|182
comma
l_int|182
comma
l_int|183
comma
l_int|186
comma
l_int|189
comma
l_int|192
comma
l_int|196
comma
l_int|200
comma
l_int|203
comma
l_int|206
comma
l_int|208
comma
l_int|209
comma
l_int|209
comma
l_int|209
comma
l_int|207
comma
l_int|204
comma
l_int|201
comma
l_int|197
comma
l_int|193
comma
l_int|188
comma
l_int|183
comma
l_int|179
comma
l_int|174
comma
l_int|170
comma
l_int|166
comma
l_int|163
comma
l_int|161
comma
l_int|160
comma
l_int|159
comma
l_int|159
comma
l_int|160
comma
l_int|161
comma
l_int|162
comma
l_int|164
comma
l_int|166
comma
l_int|168
comma
l_int|169
comma
l_int|171
comma
l_int|171
comma
l_int|171
comma
l_int|170
comma
l_int|169
comma
l_int|167
comma
l_int|163
comma
l_int|159
comma
l_int|155
comma
l_int|150
comma
l_int|144
comma
l_int|139
comma
l_int|133
comma
l_int|128
comma
l_int|122
comma
l_int|117
comma
l_int|113
comma
l_int|110
comma
l_int|107
comma
l_int|105
comma
l_int|103
comma
l_int|103
comma
l_int|103
comma
l_int|103
comma
l_int|104
comma
l_int|104
comma
l_int|105
comma
l_int|105
comma
l_int|105
comma
l_int|103
comma
l_int|101
comma
l_int|97
comma
l_int|92
comma
l_int|86
comma
l_int|78
comma
l_int|68
comma
l_int|58
comma
l_int|45
comma
l_int|32
comma
l_int|18
comma
l_int|3
comma
op_minus
l_int|11
comma
op_minus
l_int|26
comma
op_minus
l_int|41
comma
op_minus
l_int|55
comma
op_minus
l_int|68
comma
op_minus
l_int|79
comma
op_minus
l_int|88
comma
op_minus
l_int|95
comma
op_minus
l_int|100
comma
op_minus
l_int|102
comma
op_minus
l_int|102
comma
op_minus
l_int|99
comma
op_minus
l_int|93
comma
op_minus
l_int|85
comma
op_minus
l_int|75
comma
op_minus
l_int|62
comma
op_minus
l_int|48
comma
op_minus
l_int|33
comma
op_minus
l_int|16
comma
l_int|0
comma
l_int|16
comma
l_int|33
comma
l_int|48
comma
l_int|62
comma
l_int|75
comma
l_int|85
comma
l_int|93
comma
l_int|99
comma
l_int|102
comma
l_int|102
comma
l_int|100
comma
l_int|95
comma
l_int|88
comma
l_int|79
comma
l_int|68
comma
l_int|55
comma
l_int|41
comma
l_int|26
comma
l_int|11
comma
op_minus
l_int|3
comma
op_minus
l_int|18
comma
op_minus
l_int|32
comma
op_minus
l_int|45
comma
op_minus
l_int|58
comma
op_minus
l_int|68
comma
op_minus
l_int|78
comma
op_minus
l_int|86
comma
op_minus
l_int|92
comma
op_minus
l_int|97
comma
op_minus
l_int|101
comma
op_minus
l_int|103
comma
op_minus
l_int|105
comma
op_minus
l_int|105
comma
op_minus
l_int|105
comma
op_minus
l_int|104
comma
op_minus
l_int|104
comma
op_minus
l_int|103
comma
op_minus
l_int|103
comma
op_minus
l_int|103
comma
op_minus
l_int|103
comma
op_minus
l_int|105
comma
op_minus
l_int|107
comma
op_minus
l_int|110
comma
op_minus
l_int|113
comma
op_minus
l_int|117
comma
op_minus
l_int|122
comma
op_minus
l_int|128
comma
op_minus
l_int|133
comma
op_minus
l_int|139
comma
op_minus
l_int|144
comma
op_minus
l_int|150
comma
op_minus
l_int|155
comma
op_minus
l_int|159
comma
op_minus
l_int|163
comma
op_minus
l_int|167
comma
op_minus
l_int|169
comma
op_minus
l_int|170
comma
op_minus
l_int|171
comma
op_minus
l_int|171
comma
op_minus
l_int|171
comma
op_minus
l_int|169
comma
op_minus
l_int|168
comma
op_minus
l_int|166
comma
op_minus
l_int|164
comma
op_minus
l_int|162
comma
op_minus
l_int|161
comma
op_minus
l_int|160
comma
op_minus
l_int|159
comma
op_minus
l_int|159
comma
op_minus
l_int|160
comma
op_minus
l_int|161
comma
op_minus
l_int|163
comma
op_minus
l_int|166
comma
op_minus
l_int|170
comma
op_minus
l_int|174
comma
op_minus
l_int|179
comma
op_minus
l_int|183
comma
op_minus
l_int|188
comma
op_minus
l_int|193
comma
op_minus
l_int|197
comma
op_minus
l_int|201
comma
op_minus
l_int|204
comma
op_minus
l_int|207
comma
op_minus
l_int|209
comma
op_minus
l_int|209
comma
op_minus
l_int|209
comma
op_minus
l_int|208
comma
op_minus
l_int|206
comma
op_minus
l_int|203
comma
op_minus
l_int|200
comma
op_minus
l_int|196
comma
op_minus
l_int|192
comma
op_minus
l_int|189
comma
op_minus
l_int|186
comma
op_minus
l_int|183
comma
op_minus
l_int|182
comma
op_minus
l_int|182
comma
op_minus
l_int|183
comma
op_minus
l_int|186
comma
op_minus
l_int|190
comma
op_minus
l_int|196
comma
op_minus
l_int|204
comma
op_minus
l_int|213
comma
op_minus
l_int|224
comma
op_minus
l_int|236
comma
op_minus
l_int|249
comma
op_minus
l_int|262
comma
op_minus
l_int|275
comma
op_minus
l_int|288
comma
op_minus
l_int|299
comma
op_minus
l_int|310
comma
op_minus
l_int|318
comma
op_minus
l_int|324
comma
op_minus
l_int|327
comma
op_minus
l_int|327
comma
op_minus
l_int|323
comma
op_minus
l_int|316
comma
op_minus
l_int|304
comma
op_minus
l_int|288
comma
op_minus
l_int|269
comma
op_minus
l_int|245
comma
op_minus
l_int|218
comma
op_minus
l_int|187
comma
op_minus
l_int|153
comma
op_minus
l_int|117
comma
op_minus
l_int|79
comma
op_minus
l_int|40
comma
)brace
suffix:semicolon
DECL|macro|BEEP_SRATE
mdefine_line|#define BEEP_SRATE&t;22050&t;/* 22050 Hz sample rate */
DECL|macro|BEEP_BUFLEN
mdefine_line|#define BEEP_BUFLEN&t;512
DECL|macro|BEEP_VOLUME
mdefine_line|#define BEEP_VOLUME&t;15&t;/* 0 - 100 */
DECL|function|snd_pmac_beep_event
r_static
r_int
id|snd_pmac_beep_event
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_int
r_int
id|code
comma
r_int
id|hz
)paren
(brace
id|pmac_t
op_star
id|chip
suffix:semicolon
id|pmac_beep_t
op_star
id|beep
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|beep_speed
op_assign
l_int|0
suffix:semicolon
r_int
id|srate
suffix:semicolon
r_int
id|period
comma
id|ncycles
comma
id|nsamples
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|f
suffix:semicolon
r_int
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
id|EV_SND
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|SND_BELL
suffix:colon
r_if
c_cond
(paren
id|hz
)paren
id|hz
op_assign
l_int|1000
suffix:semicolon
r_case
id|SND_TONE
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|chip
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
op_logical_or
(paren
id|beep
op_assign
id|chip-&gt;beep
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hz
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|beep-&gt;running
)paren
id|snd_pmac_beep_stop
c_func
(paren
id|chip
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|beep_speed
op_assign
id|snd_pmac_rate_index
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;playback
comma
id|BEEP_SRATE
)paren
suffix:semicolon
id|srate
op_assign
id|chip-&gt;freq_table
(braket
id|beep_speed
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hz
op_le
id|srate
op_div
id|BEEP_BUFLEN
op_logical_or
id|hz
OG
id|srate
op_div
l_int|2
)paren
id|hz
op_assign
l_int|1000
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;playback.running
op_logical_or
id|chip-&gt;capture.running
op_logical_or
id|beep-&gt;running
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|beep-&gt;running
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hz
op_eq
id|beep-&gt;hz
op_logical_and
id|beep-&gt;volume
op_eq
id|beep-&gt;volume_play
)paren
(brace
id|nsamples
op_assign
id|beep-&gt;nsamples
suffix:semicolon
)brace
r_else
(brace
id|period
op_assign
id|srate
op_star
l_int|256
op_div
id|hz
suffix:semicolon
multiline_comment|/* fixed point */
id|ncycles
op_assign
id|BEEP_BUFLEN
op_star
l_int|256
op_div
id|period
suffix:semicolon
id|nsamples
op_assign
(paren
id|period
op_star
id|ncycles
)paren
op_rshift
l_int|8
suffix:semicolon
id|f
op_assign
id|ncycles
op_star
l_int|65536
op_div
id|nsamples
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
id|beep-&gt;buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsamples
suffix:semicolon
op_increment
id|i
comma
id|p
op_add_assign
l_int|2
)paren
(brace
id|p
(braket
l_int|0
)braket
op_assign
id|p
(braket
l_int|1
)braket
op_assign
id|beep_wform
(braket
id|j
op_rshift
l_int|8
)braket
op_star
id|beep-&gt;volume
suffix:semicolon
id|j
op_assign
(paren
id|j
op_plus
id|f
)paren
op_amp
l_int|0xffff
suffix:semicolon
)brace
id|beep-&gt;hz
op_assign
id|hz
suffix:semicolon
id|beep-&gt;volume_play
op_assign
id|beep-&gt;volume
suffix:semicolon
id|beep-&gt;nsamples
op_assign
id|nsamples
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|snd_pmac_beep_dma_start
c_func
(paren
id|chip
comma
id|beep-&gt;nsamples
op_star
l_int|4
comma
id|beep-&gt;addr
comma
id|beep_speed
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * beep volume mixer&n; */
DECL|macro|chip_t
mdefine_line|#define chip_t pmac_t
DECL|function|snd_pmac_info_beep
r_static
r_int
id|snd_pmac_info_beep
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
l_int|100
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_get_beep
r_static
r_int
id|snd_pmac_get_beep
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|chip-&gt;beep
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|chip-&gt;beep-&gt;volume
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_put_beep
r_static
r_int
id|snd_pmac_put_beep
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|pmac_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
r_int
id|oval
suffix:semicolon
id|snd_assert
c_func
(paren
id|chip-&gt;beep
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|oval
op_assign
id|chip-&gt;beep-&gt;volume
suffix:semicolon
id|chip-&gt;beep-&gt;volume
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|oval
op_ne
id|chip-&gt;beep-&gt;volume
suffix:semicolon
)brace
DECL|variable|snd_pmac_beep_mixer
r_static
id|snd_kcontrol_new_t
id|snd_pmac_beep_mixer
op_assign
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Beep Playback Volume&quot;
comma
dot
id|info
op_assign
id|snd_pmac_info_beep
comma
dot
id|get
op_assign
id|snd_pmac_get_beep
comma
dot
id|put
op_assign
id|snd_pmac_put_beep
comma
)brace
suffix:semicolon
multiline_comment|/* Initialize beep stuff */
DECL|function|snd_pmac_attach_beep
r_int
id|__init
id|snd_pmac_attach_beep
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
id|pmac_beep_t
op_star
id|beep
suffix:semicolon
r_int
id|err
suffix:semicolon
id|beep
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|beep
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|beep
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|beep
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|beep
)paren
)paren
suffix:semicolon
id|beep-&gt;buf
op_assign
(paren
r_int
op_star
)paren
id|kmalloc
c_func
(paren
id|BEEP_BUFLEN
op_star
l_int|4
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|beep-&gt;buf
)paren
(brace
id|kfree
c_func
(paren
id|beep
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|beep-&gt;addr
op_assign
id|virt_to_bus
c_func
(paren
id|beep-&gt;buf
)paren
suffix:semicolon
id|beep-&gt;dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_SND
)paren
suffix:semicolon
id|beep-&gt;dev.sndbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|SND_BELL
)paren
op_or
id|BIT
c_func
(paren
id|SND_TONE
)paren
suffix:semicolon
id|beep-&gt;dev.event
op_assign
id|snd_pmac_beep_event
suffix:semicolon
id|beep-&gt;dev
dot
r_private
op_assign
id|chip
suffix:semicolon
multiline_comment|/* FIXME: set more better values */
id|beep-&gt;dev.name
op_assign
l_string|&quot;PowerMac Beep&quot;
suffix:semicolon
id|beep-&gt;dev.phys
op_assign
l_string|&quot;powermac/beep&quot;
suffix:semicolon
id|beep-&gt;dev.id.bustype
op_assign
id|BUS_ADB
suffix:semicolon
id|beep-&gt;dev.id.vendor
op_assign
l_int|0x001f
suffix:semicolon
id|beep-&gt;dev.id.product
op_assign
l_int|0x0001
suffix:semicolon
id|beep-&gt;dev.id.version
op_assign
l_int|0x0100
suffix:semicolon
id|beep-&gt;volume
op_assign
id|BEEP_VOLUME
suffix:semicolon
id|beep-&gt;running
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|chip-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|snd_pmac_beep_mixer
comma
id|chip
)paren
)paren
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|beep-&gt;buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|beep
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|chip-&gt;beep
op_assign
id|beep
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|beep-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_pmac_detach_beep
r_void
id|snd_pmac_detach_beep
c_func
(paren
id|pmac_t
op_star
id|chip
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;beep
)paren
(brace
id|input_unregister_device
c_func
(paren
op_amp
id|chip-&gt;beep-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chip-&gt;beep-&gt;buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chip-&gt;beep
)paren
suffix:semicolon
id|chip-&gt;beep
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
eof
