multiline_comment|/*&n; * Keywest i2c code&n; *&n; * Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *&n; * based on i2c-keywest.c from lm_sensors.&n; *    Copyright (c) 2000 Philip Edelbrock &lt;phil@stimpy.netroedge.com&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &quot;pmac.h&quot;
multiline_comment|/* The Tumbler audio equalizer can be really slow sometimes */
DECL|macro|KW_POLL_SANITY
mdefine_line|#define KW_POLL_SANITY 10000
multiline_comment|/* address indices */
DECL|macro|KW_ADDR_MODE
mdefine_line|#define KW_ADDR_MODE&t;0
DECL|macro|KW_ADDR_CONTROL
mdefine_line|#define KW_ADDR_CONTROL&t;1
DECL|macro|KW_ADDR_STATUS
mdefine_line|#define KW_ADDR_STATUS&t;2
DECL|macro|KW_ADDR_ISR
mdefine_line|#define KW_ADDR_ISR&t;3
DECL|macro|KW_ADDR_IER
mdefine_line|#define KW_ADDR_IER&t;4
DECL|macro|KW_ADDR_ADDR
mdefine_line|#define KW_ADDR_ADDR&t;5
DECL|macro|KW_ADDR_SUBADDR
mdefine_line|#define KW_ADDR_SUBADDR&t;6
DECL|macro|KW_ADDR_DATA
mdefine_line|#define KW_ADDR_DATA&t;7
DECL|macro|KW_I2C_ADDR
mdefine_line|#define KW_I2C_ADDR(i2c,type)&t;((i2c)-&gt;base + (type) * (i2c)-&gt;steps)
multiline_comment|/* keywest needs a small delay to defuddle itself after changing a setting */
DECL|function|keywest_writeb_wait
r_inline
r_static
r_void
id|keywest_writeb_wait
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
comma
r_int
id|addr
comma
r_int
id|value
)paren
(brace
id|writeb
c_func
(paren
id|value
comma
id|KW_I2C_ADDR
c_func
(paren
id|i2c
comma
id|addr
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
DECL|function|keywest_writeb
r_inline
r_static
r_void
id|keywest_writeb
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
comma
r_int
id|addr
comma
r_int
id|value
)paren
(brace
id|writeb
c_func
(paren
id|value
comma
id|KW_I2C_ADDR
c_func
(paren
id|i2c
comma
id|addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|keywest_readb
r_inline
r_int
r_char
id|keywest_readb
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
comma
r_int
id|addr
)paren
(brace
r_return
id|readb
c_func
(paren
id|KW_I2C_ADDR
c_func
(paren
id|i2c
comma
id|addr
)paren
)paren
suffix:semicolon
)brace
DECL|function|keywest_poll_interrupt
r_static
r_int
id|keywest_poll_interrupt
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
)paren
(brace
r_int
id|i
comma
id|res
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KW_POLL_SANITY
suffix:semicolon
id|i
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|res
op_assign
id|keywest_readb
c_func
(paren
id|i2c
comma
id|KW_ADDR_ISR
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
r_return
id|res
suffix:semicolon
)brace
singleline_comment|//snd_printd(&quot;Sanity check failed!  Expected interrupt never happened.&bslash;n&quot;);
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|keywest_reset
r_static
r_void
id|keywest_reset
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
)paren
(brace
r_int
id|interrupt_state
suffix:semicolon
multiline_comment|/* Clear all past interrupts */
id|interrupt_state
op_assign
id|keywest_readb
c_func
(paren
id|i2c
comma
id|KW_ADDR_ISR
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|interrupt_state
OG
l_int|0
)paren
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_ISR
comma
id|interrupt_state
)paren
suffix:semicolon
)brace
DECL|function|keywest_start
r_static
r_int
id|keywest_start
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
comma
r_int
r_char
id|cmd
comma
r_int
id|is_read
)paren
(brace
r_int
id|interrupt_state
suffix:semicolon
r_int
id|ack
suffix:semicolon
id|keywest_reset
c_func
(paren
id|i2c
)paren
suffix:semicolon
multiline_comment|/* Set up address and r/w bit */
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_ADDR
comma
(paren
id|i2c-&gt;addr
op_lshift
l_int|1
)paren
op_or
(paren
id|is_read
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Set up &squot;sub address&squot; which I&squot;m guessing is the command field? */
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_SUBADDR
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/* Start sending address */
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_CONTROL
comma
id|keywest_readb
c_func
(paren
id|i2c
comma
id|KW_ADDR_CONTROL
)paren
op_or
l_int|2
)paren
suffix:semicolon
id|interrupt_state
op_assign
id|keywest_poll_interrupt
c_func
(paren
id|i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interrupt_state
OL
l_int|0
)paren
r_return
id|interrupt_state
suffix:semicolon
id|ack
op_assign
id|keywest_readb
c_func
(paren
id|i2c
comma
id|KW_ADDR_STATUS
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ack
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;Ack Status on addr expected but got: 0x%02x on addr: 0x%02x&bslash;n&quot;
comma
id|ack
comma
id|i2c-&gt;addr
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|interrupt_state
suffix:semicolon
)brace
multiline_comment|/* exported */
DECL|function|snd_pmac_keywest_write
r_int
id|snd_pmac_keywest_write
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
comma
r_int
r_char
id|cmd
comma
r_int
id|len
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|interrupt_state
suffix:semicolon
r_int
id|error_state
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|snd_assert
c_func
(paren
id|len
op_ge
l_int|1
op_logical_and
id|len
op_le
l_int|32
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|interrupt_state
op_assign
id|keywest_start
c_func
(paren
id|i2c
comma
id|cmd
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_DATA
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt and go */
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_ISR
comma
id|interrupt_state
)paren
suffix:semicolon
id|interrupt_state
op_assign
id|keywest_poll_interrupt
c_func
(paren
id|i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interrupt_state
OL
l_int|0
)paren
(brace
id|error_state
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|interrupt_state
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|keywest_readb
c_func
(paren
id|i2c
comma
id|KW_ADDR_STATUS
)paren
op_amp
l_int|0x02
)paren
op_eq
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;Ack Expected by not received(block)!&bslash;n&quot;
)paren
suffix:semicolon
id|error_state
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Send stop */
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_CONTROL
comma
id|keywest_readb
c_func
(paren
id|i2c
comma
id|KW_ADDR_CONTROL
)paren
op_or
l_int|4
)paren
suffix:semicolon
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_CONTROL
comma
id|interrupt_state
)paren
suffix:semicolon
id|interrupt_state
op_assign
id|keywest_poll_interrupt
c_func
(paren
id|i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|interrupt_state
OL
l_int|0
)paren
(brace
id|error_state
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|interrupt_state
op_assign
l_int|0
suffix:semicolon
)brace
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_ISR
comma
id|interrupt_state
)paren
suffix:semicolon
r_return
id|error_state
suffix:semicolon
)brace
multiline_comment|/* exported */
DECL|function|snd_pmac_keywest_cleanup
r_void
id|snd_pmac_keywest_cleanup
c_func
(paren
id|pmac_keywest_t
op_star
id|i2c
)paren
(brace
r_if
c_cond
(paren
id|i2c-&gt;base
)paren
(brace
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|i2c-&gt;base
)paren
suffix:semicolon
id|i2c-&gt;base
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* exported */
DECL|function|snd_pmac_keywest_find
r_int
id|snd_pmac_keywest_find
c_func
(paren
id|pmac_t
op_star
id|chip
comma
id|pmac_keywest_t
op_star
id|i2c
comma
r_int
id|addr
comma
r_int
(paren
op_star
id|init_client
)paren
(paren
id|pmac_t
op_star
comma
id|pmac_keywest_t
op_star
)paren
)paren
(brace
r_struct
id|device_node
op_star
id|i2c_device
suffix:semicolon
r_void
op_star
op_star
id|temp
suffix:semicolon
r_void
op_star
id|base
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|steps
op_assign
l_int|0
suffix:semicolon
id|i2c_device
op_assign
id|find_compatible_devices
c_func
(paren
l_string|&quot;i2c&quot;
comma
l_string|&quot;keywest&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c_device
op_eq
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;No Keywest i2c devices found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i2c_device
suffix:semicolon
id|i2c_device
op_assign
id|i2c_device-&gt;next
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;Keywest device found: %s&bslash;n&quot;
comma
id|i2c_device-&gt;full_name
)paren
suffix:semicolon
id|temp
op_assign
(paren
r_void
op_star
op_star
)paren
id|get_property
c_func
(paren
id|i2c_device
comma
l_string|&quot;AAPL,address&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_ne
l_int|NULL
)paren
(brace
id|base
op_assign
op_star
id|temp
suffix:semicolon
)brace
r_else
(brace
id|snd_printd
c_func
(paren
l_string|&quot;pmac: no &squot;address&squot; prop!&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|temp
op_assign
(paren
r_void
op_star
op_star
)paren
id|get_property
c_func
(paren
id|i2c_device
comma
l_string|&quot;AAPL,address-step&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp
op_ne
l_int|NULL
)paren
(brace
id|steps
op_assign
op_star
(paren
id|uint
op_star
)paren
id|temp
suffix:semicolon
)brace
r_else
(brace
id|snd_printd
c_func
(paren
l_string|&quot;pmac: no &squot;address-step&squot; prop!&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|i2c-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
(paren
r_int
r_int
)paren
id|base
comma
id|steps
op_star
l_int|8
)paren
suffix:semicolon
id|i2c-&gt;steps
op_assign
id|steps
suffix:semicolon
multiline_comment|/* Select standard sub mode &n;&t;&t; *  &n;&t;&t; * ie for &lt;Address&gt;&lt;Ack&gt;&lt;Command&gt;&lt;Ack&gt;&lt;data&gt;&lt;Ack&gt;... style transactions&n;&t;&t; */
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_MODE
comma
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts */
id|keywest_writeb_wait
c_func
(paren
id|i2c
comma
id|KW_ADDR_IER
comma
l_int|1
op_plus
l_int|2
op_plus
l_int|4
op_plus
l_int|8
)paren
suffix:semicolon
id|keywest_reset
c_func
(paren
id|i2c
)paren
suffix:semicolon
id|i2c-&gt;addr
op_assign
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|init_client
c_func
(paren
id|chip
comma
id|i2c
)paren
OL
l_int|0
)paren
(brace
id|snd_pmac_keywest_cleanup
c_func
(paren
id|i2c
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ok */
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
eof
