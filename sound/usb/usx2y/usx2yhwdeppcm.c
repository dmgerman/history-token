multiline_comment|/*&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
multiline_comment|/* USX2Y &quot;rawusb&quot; aka hwdep_pcm implementation&n;&n; Its usb&squot;s unableness to atomically handle power of 2 period sized data chuncs&n; at standard samplerates,&n; what led to this part of the usx2y module: &n; It provides the alsa kernel half of the usx2y-alsa-jack driver pair.&n; The pair uses a hardware dependant alsa-device for mmaped pcm transport.&n; Advantage achieved:&n;         The usb_hc moves pcm data from/into memory via DMA.&n;         That memory is mmaped by jack&squot;s usx2y driver.&n;         Jack&squot;s usx2y driver is the first/last to read/write pcm data.&n;         Read/write is a combination of power of 2 period shaping and&n;         float/int conversation.&n;         Compared to mainline alsa/jack we leave out power of 2 period shaping inside&n;         snd-usb-usx2y which needs memcpy() and additional buffers.&n;         As a side effect possible unwanted pcm-data coruption resulting of&n;         standard alsa&squot;s snd-usb-usx2y period shaping scheme falls away.&n;         Result is sane jack operation at buffering schemes down to 128frames,&n;         2 periods.&n;         plain usx2y alsa mode is able to achieve 64frames, 4periods, but only at the&n;         cost of easier triggered i.e. aeolus xruns (128 or 256frames,&n;         2periods works but is useless cause of crackling).&n; &n; This is a first &quot;proof of concept&quot; implementation.&n; Later, funcionalities should migrate to more apropriate places:&n; Userland:&n; - The jackd could mmap its float-pcm buffers directly from alsa-lib.&n; - alsa-lib could provide power of 2 period sized shaping combined with int/float&n;   conversation.&n;   Currently the usx2y jack driver provides above 2 services.&n; Kernel:&n; - rawusb dma pcm buffer transport should go to snd-usb-lib, so also snd-usb-audio&n;   devices can use it.&n;   Currently rawusb dma pcm buffer transport (this file) is only available to snd-usb-usx2y. &n;*/
macro_line|#include &quot;usbusx2yaudio.c&quot;
macro_line|#if defined(USX2Y_NRPACKS_VARIABLE) || (!defined(USX2Y_NRPACKS_VARIABLE) &amp;&amp;  USX2Y_NRPACKS == 1)
macro_line|#include &lt;sound/hwdep.h&gt;
DECL|function|usX2Y_usbpcm_urb_capt_retire
r_static
r_int
id|usX2Y_usbpcm_urb_capt_retire
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|subs-&gt;completed_urb
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;pcm_substream-&gt;runtime
suffix:semicolon
r_int
id|i
comma
id|lens
op_assign
l_int|0
comma
id|hwptr_done
op_assign
id|subs-&gt;hwptr_done
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|usX2Y-&gt;hwdep_pcm_shm-&gt;capture_iso_start
)paren
(brace
singleline_comment|//FIXME
r_int
id|head
op_assign
id|usX2Y-&gt;hwdep_pcm_shm-&gt;captured_iso_head
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ge
id|ARRAY_SIZE
c_func
(paren
id|usX2Y-&gt;hwdep_pcm_shm-&gt;captured_iso
)paren
)paren
id|head
op_assign
l_int|0
suffix:semicolon
id|usX2Y-&gt;hwdep_pcm_shm-&gt;capture_iso_start
op_assign
id|head
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;cap start %i&bslash;n&quot;
comma
id|head
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
)paren
(brace
multiline_comment|/* active? hmm, skip this */
id|snd_printk
c_func
(paren
l_string|&quot;activ frame status %i. Most propably some hardware problem.&bslash;n&quot;
comma
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
r_return
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
suffix:semicolon
)brace
id|lens
op_add_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_div
id|usX2Y-&gt;stride
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|hwptr_done
op_add_assign
id|lens
)paren
op_ge
id|runtime-&gt;buffer_size
)paren
id|hwptr_done
op_sub_assign
id|runtime-&gt;buffer_size
suffix:semicolon
id|subs-&gt;hwptr_done
op_assign
id|hwptr_done
suffix:semicolon
id|subs-&gt;transfer_done
op_add_assign
id|lens
suffix:semicolon
multiline_comment|/* update the pointer, call callback if necessary */
r_if
c_cond
(paren
id|subs-&gt;transfer_done
op_ge
id|runtime-&gt;period_size
)paren
(brace
id|subs-&gt;transfer_done
op_sub_assign
id|runtime-&gt;period_size
suffix:semicolon
id|snd_pcm_period_elapsed
c_func
(paren
id|subs-&gt;pcm_substream
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usX2Y_iso_frames_per_buffer
r_static
r_inline
r_int
id|usX2Y_iso_frames_per_buffer
c_func
(paren
id|snd_pcm_runtime_t
op_star
id|runtime
comma
id|usX2Ydev_t
op_star
id|usX2Y
)paren
(brace
r_return
(paren
id|runtime-&gt;buffer_size
op_star
l_int|1000
)paren
op_div
id|usX2Y-&gt;rate
op_plus
l_int|1
suffix:semicolon
singleline_comment|//FIXME: so far only correct period_size == 2^x ?
)brace
multiline_comment|/*&n; * prepare urb for playback data pipe&n; *&n; * we copy the data directly from the pcm buffer.&n; * the current position to be copied is held in hwptr field.&n; * since a urb can handle only a single linear buffer, if the total&n; * transferred area overflows the buffer boundary, we cannot send&n; * it directly from the buffer.  thus the data is once copied to&n; * a temporary buffer and urb points to that.&n; */
DECL|function|usX2Y_hwdep_urb_play_prepare
r_static
r_int
id|usX2Y_hwdep_urb_play_prepare
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|count
comma
id|counts
comma
id|pack
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
r_struct
id|snd_usX2Y_hwdep_pcm_shm
op_star
id|shm
op_assign
id|usX2Y-&gt;hwdep_pcm_shm
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;pcm_substream-&gt;runtime
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|shm-&gt;playback_iso_start
)paren
(brace
id|shm-&gt;playback_iso_start
op_assign
id|shm-&gt;captured_iso_head
op_minus
id|usX2Y_iso_frames_per_buffer
c_func
(paren
id|runtime
comma
id|usX2Y
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|shm-&gt;playback_iso_start
)paren
id|shm-&gt;playback_iso_start
op_add_assign
id|ARRAY_SIZE
c_func
(paren
id|shm-&gt;captured_iso
)paren
suffix:semicolon
id|shm-&gt;playback_iso_head
op_assign
id|shm-&gt;playback_iso_start
suffix:semicolon
)brace
id|count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|pack
op_assign
l_int|0
suffix:semicolon
id|pack
OL
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
id|pack
op_increment
)paren
(brace
multiline_comment|/* calculate the size of a packet */
id|counts
op_assign
id|shm-&gt;captured_iso
(braket
id|shm-&gt;playback_iso_head
)braket
dot
id|length
op_div
id|usX2Y-&gt;stride
suffix:semicolon
r_if
c_cond
(paren
id|counts
template_param
l_int|50
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;should not be here with counts=%i&bslash;n&quot;
comma
id|counts
)paren
suffix:semicolon
r_return
op_minus
id|EPIPE
suffix:semicolon
)brace
multiline_comment|/* set up descriptor */
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|offset
op_assign
id|shm-&gt;captured_iso
(braket
id|shm-&gt;playback_iso_head
)braket
dot
id|offset
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|length
op_assign
id|shm-&gt;captured_iso
(braket
id|shm-&gt;playback_iso_head
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_ne
id|state_RUNNING
)paren
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
id|urb-&gt;transfer_buffer
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|offset
comma
l_int|0
comma
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|shm-&gt;playback_iso_head
op_ge
id|ARRAY_SIZE
c_func
(paren
id|shm-&gt;captured_iso
)paren
)paren
id|shm-&gt;playback_iso_head
op_assign
l_int|0
suffix:semicolon
id|count
op_add_assign
id|counts
suffix:semicolon
)brace
id|urb-&gt;transfer_buffer_length
op_assign
id|count
op_star
id|usX2Y-&gt;stride
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usX2Y_usbpcm_urb_capt_iso_advance
r_static
r_inline
r_void
id|usX2Y_usbpcm_urb_capt_iso_advance
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|pack
suffix:semicolon
r_for
c_loop
(paren
id|pack
op_assign
l_int|0
suffix:semicolon
id|pack
OL
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
op_increment
id|pack
)paren
(brace
r_struct
id|usb_iso_packet_descriptor
op_star
id|desc
op_assign
id|urb-&gt;iso_frame_desc
op_plus
id|pack
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|subs
)paren
(brace
id|snd_usX2Y_hwdep_pcm_shm_t
op_star
id|shm
op_assign
id|subs-&gt;usX2Y-&gt;hwdep_pcm_shm
suffix:semicolon
r_int
id|head
op_assign
id|shm-&gt;captured_iso_head
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|head
op_ge
id|ARRAY_SIZE
c_func
(paren
id|shm-&gt;captured_iso
)paren
)paren
id|head
op_assign
l_int|0
suffix:semicolon
id|shm-&gt;captured_iso
(braket
id|head
)braket
dot
id|frame
op_assign
id|urb-&gt;start_frame
op_plus
id|pack
suffix:semicolon
id|shm-&gt;captured_iso
(braket
id|head
)braket
dot
id|offset
op_assign
id|desc-&gt;offset
suffix:semicolon
id|shm-&gt;captured_iso
(braket
id|head
)braket
dot
id|length
op_assign
id|desc-&gt;actual_length
suffix:semicolon
id|shm-&gt;captured_iso_head
op_assign
id|head
suffix:semicolon
id|shm-&gt;captured_iso_frames
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|desc-&gt;offset
op_add_assign
id|desc-&gt;length
op_star
id|NRURBS
op_star
id|nr_of_packs
c_func
(paren
)paren
)paren
op_plus
id|desc-&gt;length
op_ge
id|SSS
)paren
id|desc-&gt;offset
op_sub_assign
(paren
id|SSS
op_minus
id|desc-&gt;length
)paren
suffix:semicolon
)brace
)brace
DECL|function|usX2Y_usbpcm_usbframe_complete
r_static
r_inline
r_int
id|usX2Y_usbpcm_usbframe_complete
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|capsubs
comma
id|snd_usX2Y_substream_t
op_star
id|capsubs2
comma
id|snd_usX2Y_substream_t
op_star
id|playbacksubs
comma
r_int
id|frame
)paren
(brace
r_int
id|err
comma
id|state
suffix:semicolon
r_struct
id|urb
op_star
id|urb
op_assign
id|playbacksubs-&gt;completed_urb
suffix:semicolon
id|state
op_assign
id|atomic_read
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|urb
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|state_RUNNING
)paren
id|usX2Y_urb_play_retire
c_func
(paren
id|playbacksubs
comma
id|urb
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|state
op_ge
id|state_PRERUNNING
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|state_STARTING1
suffix:colon
id|urb
op_assign
id|playbacksubs-&gt;urb
(braket
l_int|0
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|state_STARTING2
suffix:colon
id|urb
op_assign
id|playbacksubs-&gt;urb
(braket
l_int|1
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|urb
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_hwdep_urb_play_prepare
c_func
(paren
id|playbacksubs
comma
id|urb
)paren
)paren
op_logical_or
(paren
id|err
op_assign
id|usX2Y_urb_submit
c_func
(paren
id|playbacksubs
comma
id|urb
comma
id|frame
)paren
)paren
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
id|playbacksubs-&gt;completed_urb
op_assign
l_int|NULL
suffix:semicolon
id|state
op_assign
id|atomic_read
c_func
(paren
op_amp
id|capsubs-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ge
id|state_PREPARED
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|state_RUNNING
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_usbpcm_urb_capt_retire
c_func
(paren
id|capsubs
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|state
op_ge
id|state_PRERUNNING
)paren
id|atomic_inc
c_func
(paren
op_amp
id|capsubs-&gt;state
)paren
suffix:semicolon
)brace
id|usX2Y_usbpcm_urb_capt_iso_advance
c_func
(paren
id|capsubs
comma
id|capsubs-&gt;completed_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|capsubs2
)paren
id|usX2Y_usbpcm_urb_capt_iso_advance
c_func
(paren
l_int|NULL
comma
id|capsubs2-&gt;completed_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_urb_submit
c_func
(paren
id|capsubs
comma
id|capsubs-&gt;completed_urb
comma
id|frame
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|capsubs2
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_urb_submit
c_func
(paren
id|capsubs2
comma
id|capsubs2-&gt;completed_urb
comma
id|frame
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
id|capsubs-&gt;completed_urb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|capsubs2
)paren
id|capsubs2-&gt;completed_urb
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i_usX2Y_usbpcm_urb_complete
r_static
r_void
id|i_usX2Y_usbpcm_urb_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|capsubs
comma
op_star
id|capsubs2
comma
op_star
id|playbacksubs
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
OL
id|state_PREPARED
)paren
)paren
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;hcd_frame=%i ep=%i%s status=%i start_frame=%i&bslash;n&quot;
comma
id|usb_get_current_frame_number
c_func
(paren
id|usX2Y-&gt;chip.dev
)paren
comma
id|subs-&gt;endpoint
comma
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
l_string|&quot;in&quot;
suffix:colon
l_string|&quot;out&quot;
comma
id|urb-&gt;status
comma
id|urb-&gt;start_frame
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|urb-&gt;status
)paren
)paren
(brace
id|usX2Y_error_urb_status
c_func
(paren
id|usX2Y
comma
id|subs
comma
id|urb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|likely
c_func
(paren
(paren
l_int|0xFFFF
op_amp
id|urb-&gt;start_frame
)paren
op_eq
id|usX2Y-&gt;wait_iso_frame
)paren
)paren
id|subs-&gt;completed_urb
op_assign
id|urb
suffix:semicolon
r_else
(brace
id|usX2Y_error_sequence
c_func
(paren
id|usX2Y
comma
id|subs
comma
id|urb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|capsubs
op_assign
id|usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
suffix:semicolon
id|capsubs2
op_assign
id|usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
op_plus
l_int|2
)braket
suffix:semicolon
id|playbacksubs
op_assign
id|usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
suffix:semicolon
r_if
c_cond
(paren
id|capsubs-&gt;completed_urb
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|capsubs-&gt;state
)paren
op_ge
id|state_PREPARED
op_logical_and
(paren
l_int|NULL
op_eq
id|capsubs2
op_logical_or
id|capsubs2-&gt;completed_urb
)paren
op_logical_and
(paren
id|playbacksubs-&gt;completed_urb
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
OL
id|state_PREPARED
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|usX2Y_usbpcm_usbframe_complete
c_func
(paren
id|capsubs
comma
id|capsubs2
comma
id|playbacksubs
comma
id|urb-&gt;start_frame
)paren
)paren
(brace
r_if
c_cond
(paren
id|nr_of_packs
c_func
(paren
)paren
op_le
id|urb-&gt;start_frame
op_logical_and
id|urb-&gt;start_frame
op_le
(paren
l_int|2
op_star
id|nr_of_packs
c_func
(paren
)paren
op_minus
l_int|1
)paren
)paren
singleline_comment|// uhci and ohci
id|usX2Y-&gt;wait_iso_frame
op_assign
id|urb-&gt;start_frame
op_minus
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
r_else
id|usX2Y-&gt;wait_iso_frame
op_add_assign
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|usX2Y_clients_stop
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|usX2Y_hwdep_urb_release
r_static
r_void
id|usX2Y_hwdep_urb_release
c_func
(paren
r_struct
id|urb
op_star
op_star
id|urb
)paren
(brace
id|usb_kill_urb
c_func
(paren
op_star
id|urb
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
op_star
id|urb
)paren
suffix:semicolon
op_star
id|urb
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * release a substream&n; */
DECL|function|usX2Y_usbpcm_urbs_release
r_static
r_void
id|usX2Y_usbpcm_urbs_release
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
r_int
id|i
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_usX2Y_urbs_release() %i&bslash;n&quot;
comma
id|subs-&gt;endpoint
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRURBS
suffix:semicolon
id|i
op_increment
)paren
id|usX2Y_hwdep_urb_release
c_func
(paren
id|subs-&gt;urb
op_plus
id|i
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_usbpcm_subs_startup_finish
r_static
r_void
id|usX2Y_usbpcm_subs_startup_finish
c_func
(paren
id|usX2Ydev_t
op_star
id|usX2Y
)paren
(brace
id|usX2Y_urbs_set_complete
c_func
(paren
id|usX2Y
comma
id|i_usX2Y_usbpcm_urb_complete
)paren
suffix:semicolon
id|usX2Y-&gt;prepare_subs
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|i_usX2Y_usbpcm_subs_startup
r_static
r_void
id|i_usX2Y_usbpcm_subs_startup
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|prepare_subs
op_assign
id|usX2Y-&gt;prepare_subs
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|prepare_subs
op_logical_and
id|urb-&gt;start_frame
op_eq
id|prepare_subs-&gt;urb
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start_frame
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|prepare_subs-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prepare_subs
op_eq
id|usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|cap_subs2
op_assign
id|usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
op_plus
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|cap_subs2
op_ne
l_int|NULL
)paren
id|atomic_inc
c_func
(paren
op_amp
id|cap_subs2-&gt;state
)paren
suffix:semicolon
)brace
id|usX2Y_usbpcm_subs_startup_finish
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|usX2Y-&gt;prepare_wait_queue
)paren
suffix:semicolon
)brace
id|i_usX2Y_usbpcm_urb_complete
c_func
(paren
id|urb
comma
id|regs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * initialize a substream&squot;s urbs&n; */
DECL|function|usX2Y_usbpcm_urbs_allocate
r_static
r_int
id|usX2Y_usbpcm_urbs_allocate
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|pipe
suffix:semicolon
r_int
id|is_playback
op_assign
id|subs
op_eq
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|subs-&gt;usX2Y-&gt;chip.dev
suffix:semicolon
id|pipe
op_assign
id|is_playback
ques
c_cond
id|usb_sndisocpipe
c_func
(paren
id|dev
comma
id|subs-&gt;endpoint
)paren
suffix:colon
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
id|subs-&gt;endpoint
)paren
suffix:semicolon
id|subs-&gt;maxpacksize
op_assign
id|usb_maxpacket
c_func
(paren
id|dev
comma
id|pipe
comma
id|is_playback
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|subs-&gt;maxpacksize
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* allocate and initialize data urbs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRURBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|urb
op_star
op_star
id|purb
op_assign
id|subs-&gt;urb
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|purb
)paren
(brace
id|usb_kill_urb
c_func
(paren
op_star
id|purb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
op_star
id|purb
op_assign
id|usb_alloc_urb
c_func
(paren
id|nr_of_packs
c_func
(paren
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
op_star
id|purb
)paren
(brace
id|usX2Y_usbpcm_urbs_release
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|transfer_buffer
op_assign
id|is_playback
ques
c_cond
id|subs-&gt;usX2Y-&gt;hwdep_pcm_shm-&gt;playback
suffix:colon
(paren
id|subs-&gt;endpoint
op_eq
l_int|0x8
ques
c_cond
id|subs-&gt;usX2Y-&gt;hwdep_pcm_shm-&gt;capture0x8
suffix:colon
id|subs-&gt;usX2Y-&gt;hwdep_pcm_shm-&gt;capture0xA
)paren
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|dev
op_assign
id|dev
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|pipe
op_assign
id|pipe
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|number_of_packets
op_assign
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|context
op_assign
id|subs
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|interval
op_assign
l_int|1
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|complete
op_assign
id|i_usX2Y_usbpcm_subs_startup
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * free the buffer&n; */
DECL|function|snd_usX2Y_usbpcm_hw_free
r_static
r_int
id|snd_usX2Y_usbpcm_hw_free
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|runtime-&gt;private_data
comma
op_star
id|cap_subs2
op_assign
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
op_plus
l_int|2
)braket
suffix:semicolon
id|down
c_func
(paren
op_amp
id|subs-&gt;usX2Y-&gt;prepare_mutex
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_usX2Y_usbpcm_hw_free(%p)&bslash;n&quot;
comma
id|substream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SNDRV_PCM_STREAM_PLAYBACK
op_eq
id|substream-&gt;stream
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|cap_subs
op_assign
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
id|usX2Y_usbpcm_urbs_release
c_func
(paren
id|subs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cap_subs-&gt;pcm_substream
op_logical_or
op_logical_neg
id|cap_subs-&gt;pcm_substream-&gt;runtime
op_logical_or
op_logical_neg
id|cap_subs-&gt;pcm_substream-&gt;runtime-&gt;status
op_logical_or
id|cap_subs-&gt;pcm_substream-&gt;runtime-&gt;status-&gt;state
OL
id|SNDRV_PCM_STATE_PREPARED
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|cap_subs-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|cap_subs2
)paren
id|atomic_set
c_func
(paren
op_amp
id|cap_subs2-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
id|usX2Y_usbpcm_urbs_release
c_func
(paren
id|cap_subs
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|cap_subs2
)paren
id|usX2Y_usbpcm_urbs_release
c_func
(paren
id|cap_subs2
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|snd_usX2Y_substream_t
op_star
id|playback_subs
op_assign
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|playback_subs-&gt;state
)paren
OL
id|state_PREPARED
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|cap_subs2
)paren
id|atomic_set
c_func
(paren
op_amp
id|cap_subs2-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
id|usX2Y_usbpcm_urbs_release
c_func
(paren
id|subs
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|cap_subs2
)paren
id|usX2Y_usbpcm_urbs_release
c_func
(paren
id|cap_subs2
)paren
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|subs-&gt;usX2Y-&gt;prepare_mutex
)paren
suffix:semicolon
r_return
id|snd_pcm_lib_free_pages
c_func
(paren
id|substream
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_usbpcm_subs_startup
r_static
r_void
id|usX2Y_usbpcm_subs_startup
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
id|usX2Y-&gt;prepare_subs
op_assign
id|subs
suffix:semicolon
id|subs-&gt;urb
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|smp_wmb
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// Make shure above modifications are seen by i_usX2Y_subs_startup()
id|usX2Y_urbs_set_complete
c_func
(paren
id|usX2Y
comma
id|i_usX2Y_usbpcm_subs_startup
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_usbpcm_urbs_start
r_static
r_int
id|usX2Y_usbpcm_urbs_start
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
r_int
id|p
comma
id|u
comma
id|err
comma
id|stream
op_assign
id|subs-&gt;pcm_substream-&gt;stream
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
r_if
c_cond
(paren
id|SNDRV_PCM_STREAM_CAPTURE
op_eq
id|stream
)paren
(brace
id|usX2Y-&gt;hwdep_pcm_shm-&gt;captured_iso_head
op_assign
op_minus
l_int|1
suffix:semicolon
id|usX2Y-&gt;hwdep_pcm_shm-&gt;captured_iso_frames
op_assign
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
l_int|3
op_ge
(paren
id|stream
op_plus
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|2
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
id|usX2Y-&gt;subs
(braket
id|stream
op_plus
id|p
)braket
suffix:semicolon
r_if
c_cond
(paren
id|subs
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_usbpcm_urbs_allocate
c_func
(paren
id|subs
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|subs-&gt;completed_urb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
l_int|4
suffix:semicolon
id|p
op_increment
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
id|usX2Y-&gt;subs
(braket
id|p
)braket
suffix:semicolon
r_if
c_cond
(paren
id|subs
op_ne
l_int|NULL
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_ge
id|state_PREPARED
)paren
r_goto
id|start
suffix:semicolon
)brace
id|usX2Y-&gt;wait_iso_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|start
suffix:colon
id|usX2Y_usbpcm_subs_startup
c_func
(paren
id|subs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|u
op_assign
l_int|0
suffix:semicolon
id|u
OL
id|NRURBS
suffix:semicolon
id|u
op_increment
)paren
(brace
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
l_int|3
op_ge
(paren
id|stream
op_plus
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|2
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
id|usX2Y-&gt;subs
(braket
id|stream
op_plus
id|p
)braket
suffix:semicolon
r_if
c_cond
(paren
id|subs
op_ne
l_int|NULL
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|subs-&gt;urb
(braket
id|u
)braket
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_int
r_int
id|pack
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|u
)paren
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STARTING3
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
id|usX2Y-&gt;chip.dev
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|URB_ISO_ASAP
suffix:semicolon
r_for
c_loop
(paren
id|pack
op_assign
l_int|0
suffix:semicolon
id|pack
OL
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
id|pack
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|offset
op_assign
id|subs-&gt;maxpacksize
op_star
(paren
id|pack
op_plus
id|u
op_star
id|nr_of_packs
c_func
(paren
)paren
)paren
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|length
op_assign
id|subs-&gt;maxpacksize
suffix:semicolon
)brace
id|urb-&gt;transfer_buffer_length
op_assign
id|subs-&gt;maxpacksize
op_star
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_KERNEL
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
(paren
id|KERN_ERR
l_string|&quot;cannot usb_submit_urb() for urb %d, err = %d&bslash;n&quot;
comma
id|u
comma
id|err
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPIPE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
r_else
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;%i&bslash;n&quot;
comma
id|urb-&gt;start_frame
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|usX2Y-&gt;wait_iso_frame
)paren
id|usX2Y-&gt;wait_iso_frame
op_assign
id|urb-&gt;start_frame
suffix:semicolon
)brace
id|urb-&gt;transfer_flags
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STARTING1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|wait_event
c_func
(paren
id|usX2Y-&gt;prepare_wait_queue
comma
l_int|NULL
op_eq
id|usX2Y-&gt;prepare_subs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_ne
id|state_PREPARED
)paren
id|err
op_assign
op_minus
id|EPIPE
suffix:semicolon
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|err
)paren
(brace
id|usX2Y_subs_startup_finish
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
singleline_comment|// Call it now
id|usX2Y_clients_stop
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
singleline_comment|// something is completely wroong &gt; stop evrything&t;&t;&t;
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * prepare callback&n; *&n; * set format and initialize urbs&n; */
DECL|function|snd_usX2Y_usbpcm_prepare
r_static
r_int
id|snd_usX2Y_usbpcm_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|runtime-&gt;private_data
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|capsubs
op_assign
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_usX2Y_pcm_prepare(%p)&bslash;n&quot;
comma
id|substream
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|usX2Y-&gt;hwdep_pcm_shm
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
id|usX2Y-&gt;hwdep_pcm_shm
op_assign
id|snd_malloc_pages
c_func
(paren
r_sizeof
(paren
id|snd_usX2Y_hwdep_pcm_shm_t
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|usX2Y-&gt;hwdep_pcm_shm
comma
l_int|0
comma
r_sizeof
(paren
id|snd_usX2Y_hwdep_pcm_shm_t
)paren
)paren
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|usX2Y-&gt;prepare_mutex
)paren
suffix:semicolon
id|usX2Y_subs_prepare
c_func
(paren
id|subs
)paren
suffix:semicolon
singleline_comment|// Start hardware streams
singleline_comment|// SyncStream first....
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|capsubs-&gt;state
)paren
OL
id|state_PREPARED
)paren
(brace
r_if
c_cond
(paren
id|usX2Y-&gt;format
op_ne
id|runtime-&gt;format
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_format_set
c_func
(paren
id|usX2Y
comma
id|runtime-&gt;format
)paren
)paren
OL
l_int|0
)paren
r_goto
id|up_prepare_mutex
suffix:semicolon
r_if
c_cond
(paren
id|usX2Y-&gt;rate
op_ne
id|runtime-&gt;rate
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_rate_set
c_func
(paren
id|usX2Y
comma
id|runtime-&gt;rate
)paren
)paren
OL
l_int|0
)paren
r_goto
id|up_prepare_mutex
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;starting capture pipe for %s&bslash;n&quot;
comma
id|subs
op_eq
id|capsubs
ques
c_cond
l_string|&quot;self&quot;
suffix:colon
l_string|&quot;playpipe&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
(paren
id|err
op_assign
id|usX2Y_usbpcm_urbs_start
c_func
(paren
id|capsubs
)paren
)paren
)paren
r_goto
id|up_prepare_mutex
suffix:semicolon
)brace
r_if
c_cond
(paren
id|subs
op_ne
id|capsubs
)paren
(brace
id|usX2Y-&gt;hwdep_pcm_shm-&gt;playback_iso_start
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
OL
id|state_PREPARED
)paren
(brace
r_while
c_loop
(paren
id|usX2Y_iso_frames_per_buffer
c_func
(paren
id|runtime
comma
id|usX2Y
)paren
OG
id|usX2Y-&gt;hwdep_pcm_shm-&gt;captured_iso_frames
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
id|snd_printd
c_func
(paren
l_string|&quot;Wait: iso_frames_per_buffer=%i,captured_iso_frames=%i&bslash;n&quot;
comma
id|usX2Y_iso_frames_per_buffer
c_func
(paren
id|runtime
comma
id|usX2Y
)paren
comma
id|usX2Y-&gt;hwdep_pcm_shm-&gt;captured_iso_frames
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|timeout
op_assign
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|100
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|up_prepare_mutex
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
l_int|0
OG
(paren
id|err
op_assign
id|usX2Y_usbpcm_urbs_start
c_func
(paren
id|subs
)paren
)paren
)paren
r_goto
id|up_prepare_mutex
suffix:semicolon
)brace
id|snd_printd
c_func
(paren
l_string|&quot;Ready: iso_frames_per_buffer=%i,captured_iso_frames=%i&bslash;n&quot;
comma
id|usX2Y_iso_frames_per_buffer
c_func
(paren
id|runtime
comma
id|usX2Y
)paren
comma
id|usX2Y-&gt;hwdep_pcm_shm-&gt;captured_iso_frames
)paren
suffix:semicolon
)brace
r_else
id|usX2Y-&gt;hwdep_pcm_shm-&gt;capture_iso_start
op_assign
op_minus
l_int|1
suffix:semicolon
id|up_prepare_mutex
suffix:colon
id|up
c_func
(paren
op_amp
id|usX2Y-&gt;prepare_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|snd_usX2Y_4c
r_static
id|snd_pcm_hardware_t
id|snd_usX2Y_4c
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_BLOCK_TRANSFER
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
)paren
comma
dot
id|formats
op_assign
id|SNDRV_PCM_FMTBIT_S16_LE
op_or
id|SNDRV_PCM_FMTBIT_S24_3LE
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_44100
op_or
id|SNDRV_PCM_RATE_48000
comma
dot
id|rate_min
op_assign
l_int|44100
comma
dot
id|rate_max
op_assign
l_int|48000
comma
dot
id|channels_min
op_assign
l_int|2
comma
dot
id|channels_max
op_assign
l_int|4
comma
dot
id|buffer_bytes_max
op_assign
(paren
l_int|2
op_star
l_int|128
op_star
l_int|1024
)paren
comma
dot
id|period_bytes_min
op_assign
l_int|64
comma
dot
id|period_bytes_max
op_assign
(paren
l_int|128
op_star
l_int|1024
)paren
comma
dot
id|periods_min
op_assign
l_int|2
comma
dot
id|periods_max
op_assign
l_int|1024
comma
dot
id|fifo_size
op_assign
l_int|0
)brace
suffix:semicolon
DECL|function|snd_usX2Y_usbpcm_open
r_static
r_int
id|snd_usX2Y_usbpcm_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
(paren
id|snd_usX2Y_substream_t
op_star
op_star
)paren
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
)paren
(braket
id|substream-&gt;stream
)braket
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|subs-&gt;usX2Y-&gt;chip_status
op_amp
id|USX2Y_STAT_CHIP_MMAP_PCM_URBS
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|SNDRV_PCM_STREAM_PLAYBACK
op_eq
id|substream-&gt;stream
ques
c_cond
id|snd_usX2Y_2c
suffix:colon
(paren
id|subs-&gt;usX2Y-&gt;subs
(braket
l_int|3
)braket
ques
c_cond
id|snd_usX2Y_4c
suffix:colon
id|snd_usX2Y_2c
)paren
suffix:semicolon
id|runtime-&gt;private_data
op_assign
id|subs
suffix:semicolon
id|subs-&gt;pcm_substream
op_assign
id|substream
suffix:semicolon
id|snd_pcm_hw_constraint_minmax
c_func
(paren
id|runtime
comma
id|SNDRV_PCM_HW_PARAM_PERIOD_TIME
comma
l_int|1000
comma
l_int|200000
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usX2Y_usbpcm_close
r_static
r_int
id|snd_usX2Y_usbpcm_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|runtime-&gt;private_data
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|snd_printd
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|subs-&gt;pcm_substream
op_assign
l_int|NULL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|snd_usX2Y_usbpcm_ops
r_static
id|snd_pcm_ops_t
id|snd_usX2Y_usbpcm_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_usX2Y_usbpcm_open
comma
dot
id|close
op_assign
id|snd_usX2Y_usbpcm_close
comma
dot
id|ioctl
op_assign
id|snd_pcm_lib_ioctl
comma
dot
id|hw_params
op_assign
id|snd_usX2Y_pcm_hw_params
comma
dot
id|hw_free
op_assign
id|snd_usX2Y_usbpcm_hw_free
comma
dot
id|prepare
op_assign
id|snd_usX2Y_usbpcm_prepare
comma
dot
id|trigger
op_assign
id|snd_usX2Y_pcm_trigger
comma
dot
id|pointer
op_assign
id|snd_usX2Y_pcm_pointer
comma
)brace
suffix:semicolon
DECL|function|usX2Y_pcms_lock_check
r_static
r_int
id|usX2Y_pcms_lock_check
c_func
(paren
id|snd_card_t
op_star
id|card
)paren
(brace
r_struct
id|list_head
op_star
id|list
suffix:semicolon
id|snd_device_t
op_star
id|dev
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|card-&gt;devices
)paren
(brace
id|dev
op_assign
id|snd_device
c_func
(paren
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|SNDRV_DEV_PCM
)paren
r_continue
suffix:semicolon
id|pcm
op_assign
id|dev-&gt;device_data
suffix:semicolon
id|down
c_func
(paren
op_amp
id|pcm-&gt;open_mutex
)paren
suffix:semicolon
)brace
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|card-&gt;devices
)paren
(brace
r_int
id|s
suffix:semicolon
id|dev
op_assign
id|snd_device
c_func
(paren
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|SNDRV_DEV_PCM
)paren
r_continue
suffix:semicolon
id|pcm
op_assign
id|dev-&gt;device_data
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
l_int|0
suffix:semicolon
id|s
OL
l_int|2
suffix:semicolon
op_increment
id|s
)paren
(brace
id|snd_pcm_substream_t
op_star
id|substream
suffix:semicolon
id|substream
op_assign
id|pcm-&gt;streams
(braket
id|s
)braket
dot
id|substream
suffix:semicolon
r_if
c_cond
(paren
id|substream
op_logical_and
id|substream-&gt;open_flag
)paren
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|usX2Y_pcms_unlock
r_static
r_void
id|usX2Y_pcms_unlock
c_func
(paren
id|snd_card_t
op_star
id|card
)paren
(brace
r_struct
id|list_head
op_star
id|list
suffix:semicolon
id|snd_device_t
op_star
id|dev
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|card-&gt;devices
)paren
(brace
id|dev
op_assign
id|snd_device
c_func
(paren
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|SNDRV_DEV_PCM
)paren
r_continue
suffix:semicolon
id|pcm
op_assign
id|dev-&gt;device_data
suffix:semicolon
id|up
c_func
(paren
op_amp
id|pcm-&gt;open_mutex
)paren
suffix:semicolon
)brace
)brace
DECL|function|snd_usX2Y_hwdep_pcm_open
r_static
r_int
id|snd_usX2Y_hwdep_pcm_open
c_func
(paren
id|snd_hwdep_t
op_star
id|hw
comma
r_struct
id|file
op_star
id|file
)paren
(brace
singleline_comment|// we need to be the first 
id|snd_card_t
op_star
id|card
op_assign
id|hw-&gt;card
suffix:semicolon
r_int
id|err
op_assign
id|usX2Y_pcms_lock_check
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|err
)paren
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip_status
op_or_assign
id|USX2Y_STAT_CHIP_MMAP_PCM_URBS
suffix:semicolon
id|usX2Y_pcms_unlock
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|snd_usX2Y_hwdep_pcm_release
r_static
r_int
id|snd_usX2Y_hwdep_pcm_release
c_func
(paren
id|snd_hwdep_t
op_star
id|hw
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|snd_card_t
op_star
id|card
op_assign
id|hw-&gt;card
suffix:semicolon
r_int
id|err
op_assign
id|usX2Y_pcms_lock_check
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|err
)paren
id|usX2Y
c_func
(paren
id|hw-&gt;card
)paren
op_member_access_from_pointer
id|chip_status
op_and_assign
op_complement
id|USX2Y_STAT_CHIP_MMAP_PCM_URBS
suffix:semicolon
id|usX2Y_pcms_unlock
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|snd_usX2Y_hwdep_pcm_vm_open
r_static
r_void
id|snd_usX2Y_hwdep_pcm_vm_open
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|area
)paren
(brace
)brace
DECL|function|snd_usX2Y_hwdep_pcm_vm_close
r_static
r_void
id|snd_usX2Y_hwdep_pcm_vm_close
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|area
)paren
(brace
)brace
DECL|function|snd_usX2Y_hwdep_pcm_vm_nopage
r_static
r_struct
id|page
op_star
id|snd_usX2Y_hwdep_pcm_vm_nopage
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|area
comma
r_int
r_int
id|address
comma
r_int
op_star
id|type
)paren
(brace
r_int
r_int
id|offset
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_void
op_star
id|vaddr
suffix:semicolon
id|offset
op_assign
id|area-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
suffix:semicolon
id|offset
op_add_assign
id|address
op_minus
id|area-&gt;vm_start
suffix:semicolon
id|snd_assert
c_func
(paren
(paren
id|offset
op_mod
id|PAGE_SIZE
)paren
op_eq
l_int|0
comma
r_return
id|NOPAGE_OOM
)paren
suffix:semicolon
id|vaddr
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
id|usX2Ydev_t
op_star
)paren
id|area-&gt;vm_private_data
)paren
op_member_access_from_pointer
id|hwdep_pcm_shm
op_plus
id|offset
suffix:semicolon
id|page
op_assign
id|virt_to_page
c_func
(paren
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
)paren
op_star
id|type
op_assign
id|VM_FAULT_MINOR
suffix:semicolon
r_return
id|page
suffix:semicolon
)brace
DECL|variable|snd_usX2Y_hwdep_pcm_vm_ops
r_static
r_struct
id|vm_operations_struct
id|snd_usX2Y_hwdep_pcm_vm_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_usX2Y_hwdep_pcm_vm_open
comma
dot
id|close
op_assign
id|snd_usX2Y_hwdep_pcm_vm_close
comma
dot
id|nopage
op_assign
id|snd_usX2Y_hwdep_pcm_vm_nopage
comma
)brace
suffix:semicolon
DECL|function|snd_usX2Y_hwdep_pcm_mmap
r_static
r_int
id|snd_usX2Y_hwdep_pcm_mmap
c_func
(paren
id|snd_hwdep_t
op_star
id|hw
comma
r_struct
id|file
op_star
id|filp
comma
r_struct
id|vm_area_struct
op_star
id|area
)paren
(brace
r_int
r_int
id|size
op_assign
(paren
r_int
r_int
)paren
(paren
id|area-&gt;vm_end
op_minus
id|area-&gt;vm_start
)paren
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
(paren
id|usX2Ydev_t
op_star
)paren
id|hw-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
(paren
id|usX2Ydev_t
op_star
)paren
id|hw-&gt;private_data
)paren
op_member_access_from_pointer
id|chip_status
op_amp
id|USX2Y_STAT_CHIP_INIT
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* if userspace tries to mmap beyond end of our buffer, fail */
r_if
c_cond
(paren
id|size
OG
id|PAGE_ALIGN
c_func
(paren
r_sizeof
(paren
id|snd_usX2Y_hwdep_pcm_shm_t
)paren
)paren
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;%lu &gt; %lu&bslash;n&quot;
comma
id|size
comma
(paren
r_int
r_int
)paren
r_sizeof
(paren
id|snd_usX2Y_hwdep_pcm_shm_t
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|usX2Y-&gt;hwdep_pcm_shm
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|area-&gt;vm_ops
op_assign
op_amp
id|snd_usX2Y_hwdep_pcm_vm_ops
suffix:semicolon
id|area-&gt;vm_flags
op_or_assign
id|VM_RESERVED
suffix:semicolon
id|snd_printd
c_func
(paren
l_string|&quot;vm_flags=0x%lX&bslash;n&quot;
comma
id|area-&gt;vm_flags
)paren
suffix:semicolon
id|area-&gt;vm_private_data
op_assign
id|hw-&gt;private_data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usX2Y_hwdep_pcm_private_free
r_static
r_void
id|snd_usX2Y_hwdep_pcm_private_free
c_func
(paren
id|snd_hwdep_t
op_star
id|hwdep
)paren
(brace
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
(paren
id|usX2Ydev_t
op_star
)paren
id|hwdep-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|usX2Y-&gt;hwdep_pcm_shm
)paren
id|snd_free_pages
c_func
(paren
id|usX2Y-&gt;hwdep_pcm_shm
comma
r_sizeof
(paren
id|snd_usX2Y_hwdep_pcm_shm_t
)paren
)paren
suffix:semicolon
)brace
DECL|function|snd_usX2Y_usbpcm_private_free
r_static
r_void
id|snd_usX2Y_usbpcm_private_free
c_func
(paren
id|snd_pcm_t
op_star
id|pcm
)paren
(brace
id|snd_pcm_lib_preallocate_free_for_all
c_func
(paren
id|pcm
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_hwdep_pcm_new
r_int
id|usX2Y_hwdep_pcm_new
c_func
(paren
id|snd_card_t
op_star
id|card
)paren
(brace
r_int
id|err
suffix:semicolon
id|snd_hwdep_t
op_star
id|hw
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip.dev
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_ne
id|nr_of_packs
c_func
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_hwdep_new
c_func
(paren
id|card
comma
id|SND_USX2Y_USBPCM_ID
comma
l_int|1
comma
op_amp
id|hw
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|hw-&gt;iface
op_assign
id|SNDRV_HWDEP_IFACE_USX2Y_PCM
suffix:semicolon
id|hw-&gt;private_data
op_assign
id|usX2Y
c_func
(paren
id|card
)paren
suffix:semicolon
id|hw-&gt;private_free
op_assign
id|snd_usX2Y_hwdep_pcm_private_free
suffix:semicolon
id|hw-&gt;ops.open
op_assign
id|snd_usX2Y_hwdep_pcm_open
suffix:semicolon
id|hw-&gt;ops.release
op_assign
id|snd_usX2Y_hwdep_pcm_release
suffix:semicolon
id|hw-&gt;ops.mmap
op_assign
id|snd_usX2Y_hwdep_pcm_mmap
suffix:semicolon
id|hw-&gt;exclusive
op_assign
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|hw-&gt;name
comma
l_string|&quot;/proc/bus/usb/%03d/%03d/hwdeppcm&quot;
comma
id|dev-&gt;bus-&gt;busnum
comma
id|dev-&gt;devnum
)paren
suffix:semicolon
id|err
op_assign
id|snd_pcm_new
c_func
(paren
id|card
comma
id|NAME_ALLCAPS
l_string|&quot; hwdep Audio&quot;
comma
l_int|2
comma
l_int|1
comma
l_int|1
comma
op_amp
id|pcm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_PLAYBACK
comma
op_amp
id|snd_usX2Y_usbpcm_ops
)paren
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_CAPTURE
comma
op_amp
id|snd_usX2Y_usbpcm_ops
)paren
suffix:semicolon
id|pcm-&gt;private_data
op_assign
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|subs
suffix:semicolon
id|pcm-&gt;private_free
op_assign
id|snd_usX2Y_usbpcm_private_free
suffix:semicolon
id|pcm-&gt;info_flags
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|pcm-&gt;name
comma
id|NAME_ALLCAPS
l_string|&quot; hwdep Audio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
(paren
id|err
op_assign
id|snd_pcm_lib_preallocate_pages
c_func
(paren
id|pcm-&gt;streams
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
dot
id|substream
comma
id|SNDRV_DMA_TYPE_CONTINUOUS
comma
id|snd_dma_continuous_data
c_func
(paren
id|GFP_KERNEL
)paren
comma
l_int|64
op_star
l_int|1024
comma
l_int|128
op_star
l_int|1024
)paren
)paren
op_logical_or
l_int|0
OG
(paren
id|err
op_assign
id|snd_pcm_lib_preallocate_pages
c_func
(paren
id|pcm-&gt;streams
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
dot
id|substream
comma
id|SNDRV_DMA_TYPE_CONTINUOUS
comma
id|snd_dma_continuous_data
c_func
(paren
id|GFP_KERNEL
)paren
comma
l_int|64
op_star
l_int|1024
comma
l_int|128
op_star
l_int|1024
)paren
)paren
)paren
(brace
id|snd_usX2Y_usbpcm_private_free
c_func
(paren
id|pcm
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|function|usX2Y_hwdep_pcm_new
r_int
id|usX2Y_hwdep_pcm_new
c_func
(paren
id|snd_card_t
op_star
id|card
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
eof
