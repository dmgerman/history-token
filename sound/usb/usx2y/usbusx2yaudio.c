multiline_comment|/*&n; *   US-X2Y AUDIO&n; *   Copyright (c) 2002-2004 by Karsten Wiese&n; *&n; *   based on&n; *&n; *   (Tentative) USB Audio Driver for ALSA&n; *&n; *   Main and PCM part&n; *&n; *   Copyright (c) 2002 by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   Many codes borrowed from audio.c by &n; *&t;    Alan Cox (alan@lxorguk.ukuu.org.uk)&n; *&t;    Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/info.h&gt;
macro_line|#include &lt;sound/pcm.h&gt;
macro_line|#include &lt;sound/pcm_params.h&gt;
macro_line|#include &quot;usx2y.h&quot;
macro_line|#include &quot;usbusx2y.h&quot;
DECL|macro|USX2Y_NRPACKS
mdefine_line|#define USX2Y_NRPACKS 4&t;&t;&t;/* Default value used for nr of packs per urb.&n;&t;&t;&t;&t;&t;  1 to 4 have been tested ok on uhci.&n;&t;&t;&t;&t;&t;  To use 3 on ohci, you&squot;d need a patch:&n;&t;&t;&t;&t;&t;  look for &quot;0000425-linux-2.6.9-rc4-mm1_ohci-hcd.patch.gz&quot; on&n;&t;&t;&t;&t;&t;  &quot;https://bugtrack.alsa-project.org/alsa-bug/bug_view_page.php?bug_id=0000425&quot;&n;&t;&t;&t;&t;&t;  .&n;&t;&t;&t;&t;&t;  1, 2 and 4 work out of the box on ohci, if I recall correctly.&n;&t;&t;&t;&t;&t;  Bigger is safer operation,&n;&t;&t;&t;&t;&t;  smaller gives lower latencies.&n;&t;&t;&t;&t;&t;*/
DECL|macro|USX2Y_NRPACKS_VARIABLE
mdefine_line|#define USX2Y_NRPACKS_VARIABLE y&t;/* If your system works ok with this module&squot;s parameter&n;&t;&t;&t;&t;&t;   nrpacks set to 1, you might as well comment &n;&t;&t;&t;&t;&t;   this #define out, and thereby produce smaller, faster code.&n;&t;&t;&t;&t;&t;   You&squot;d also set USX2Y_NRPACKS to 1 then.&n;&t;&t;&t;&t;&t;*/
macro_line|#ifdef USX2Y_NRPACKS_VARIABLE
DECL|variable|nrpacks
r_static
r_int
id|nrpacks
op_assign
id|USX2Y_NRPACKS
suffix:semicolon
multiline_comment|/* number of packets per urb */
DECL|macro|nr_of_packs
mdefine_line|#define  nr_of_packs() nrpacks
id|module_param
c_func
(paren
id|nrpacks
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nrpacks
comma
l_string|&quot;Number of packets per URB.&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|macro|nr_of_packs
mdefine_line|#define nr_of_packs() USX2Y_NRPACKS
macro_line|#endif
DECL|function|usX2Y_urb_capt_retire
r_static
r_int
id|usX2Y_urb_capt_retire
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|subs-&gt;completed_urb
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;pcm_substream-&gt;runtime
suffix:semicolon
r_int
r_char
op_star
id|cp
suffix:semicolon
r_int
id|i
comma
id|len
comma
id|lens
op_assign
l_int|0
comma
id|hwptr_done
op_assign
id|subs-&gt;hwptr_done
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cp
op_assign
(paren
r_int
r_char
op_star
)paren
id|urb-&gt;transfer_buffer
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
)paren
(brace
multiline_comment|/* active? hmm, skip this */
id|snd_printk
c_func
(paren
l_string|&quot;activ frame status %i. Most propably some hardware problem.&bslash;n&quot;
comma
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
)paren
suffix:semicolon
r_return
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|status
suffix:semicolon
)brace
id|len
op_assign
id|urb-&gt;iso_frame_desc
(braket
id|i
)braket
dot
id|actual_length
op_div
id|usX2Y-&gt;stride
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;0 == len ERROR!&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* copy a data chunk */
r_if
c_cond
(paren
(paren
id|hwptr_done
op_plus
id|len
)paren
OG
id|runtime-&gt;buffer_size
)paren
(brace
r_int
id|cnt
op_assign
id|runtime-&gt;buffer_size
op_minus
id|hwptr_done
suffix:semicolon
r_int
id|blen
op_assign
id|cnt
op_star
id|usX2Y-&gt;stride
suffix:semicolon
id|memcpy
c_func
(paren
id|runtime-&gt;dma_area
op_plus
id|hwptr_done
op_star
id|usX2Y-&gt;stride
comma
id|cp
comma
id|blen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|runtime-&gt;dma_area
comma
id|cp
op_plus
id|blen
comma
id|len
op_star
id|usX2Y-&gt;stride
op_minus
id|blen
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|runtime-&gt;dma_area
op_plus
id|hwptr_done
op_star
id|usX2Y-&gt;stride
comma
id|cp
comma
id|len
op_star
id|usX2Y-&gt;stride
)paren
suffix:semicolon
)brace
id|lens
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hwptr_done
op_add_assign
id|len
)paren
op_ge
id|runtime-&gt;buffer_size
)paren
id|hwptr_done
op_sub_assign
id|runtime-&gt;buffer_size
suffix:semicolon
)brace
id|subs-&gt;hwptr_done
op_assign
id|hwptr_done
suffix:semicolon
id|subs-&gt;transfer_done
op_add_assign
id|lens
suffix:semicolon
multiline_comment|/* update the pointer, call callback if necessary */
r_if
c_cond
(paren
id|subs-&gt;transfer_done
op_ge
id|runtime-&gt;period_size
)paren
(brace
id|subs-&gt;transfer_done
op_sub_assign
id|runtime-&gt;period_size
suffix:semicolon
id|snd_pcm_period_elapsed
c_func
(paren
id|subs-&gt;pcm_substream
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * prepare urb for playback data pipe&n; *&n; * we copy the data directly from the pcm buffer.&n; * the current position to be copied is held in hwptr field.&n; * since a urb can handle only a single linear buffer, if the total&n; * transferred area overflows the buffer boundary, we cannot send&n; * it directly from the buffer.  thus the data is once copied to&n; * a temporary buffer and urb points to that.&n; */
DECL|function|usX2Y_urb_play_prepare
r_static
r_int
id|usX2Y_urb_play_prepare
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
comma
r_struct
id|urb
op_star
id|cap_urb
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_int
id|count
comma
id|counts
comma
id|pack
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;pcm_substream-&gt;runtime
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|pack
op_assign
l_int|0
suffix:semicolon
id|pack
OL
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
id|pack
op_increment
)paren
(brace
multiline_comment|/* calculate the size of a packet */
id|counts
op_assign
id|cap_urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|actual_length
op_div
id|usX2Y-&gt;stride
suffix:semicolon
id|count
op_add_assign
id|counts
suffix:semicolon
r_if
c_cond
(paren
id|counts
template_param
l_int|50
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;should not be here with counts=%i&bslash;n&quot;
comma
id|counts
)paren
suffix:semicolon
r_return
op_minus
id|EPIPE
suffix:semicolon
)brace
multiline_comment|/* set up descriptor */
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|offset
op_assign
id|pack
ques
c_cond
id|urb-&gt;iso_frame_desc
(braket
id|pack
op_minus
l_int|1
)braket
dot
id|offset
op_plus
id|urb-&gt;iso_frame_desc
(braket
id|pack
op_minus
l_int|1
)braket
dot
id|length
suffix:colon
l_int|0
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|length
op_assign
id|cap_urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|actual_length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_ge
id|state_PRERUNNING
)paren
r_if
c_cond
(paren
id|subs-&gt;hwptr
op_plus
id|count
OG
id|runtime-&gt;buffer_size
)paren
(brace
multiline_comment|/* err, the transferred area goes over buffer boundary.&n;&t;&t;&t; * copy the data to the temp buffer.&n;&t;&t;&t; */
r_int
id|len
suffix:semicolon
id|len
op_assign
id|runtime-&gt;buffer_size
op_minus
id|subs-&gt;hwptr
suffix:semicolon
id|urb-&gt;transfer_buffer
op_assign
id|subs-&gt;tmpbuf
suffix:semicolon
id|memcpy
c_func
(paren
id|subs-&gt;tmpbuf
comma
id|runtime-&gt;dma_area
op_plus
id|subs-&gt;hwptr
op_star
id|usX2Y-&gt;stride
comma
id|len
op_star
id|usX2Y-&gt;stride
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|subs-&gt;tmpbuf
op_plus
id|len
op_star
id|usX2Y-&gt;stride
comma
id|runtime-&gt;dma_area
comma
(paren
id|count
op_minus
id|len
)paren
op_star
id|usX2Y-&gt;stride
)paren
suffix:semicolon
id|subs-&gt;hwptr
op_add_assign
id|count
suffix:semicolon
id|subs-&gt;hwptr
op_sub_assign
id|runtime-&gt;buffer_size
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* set the buffer pointer */
id|urb-&gt;transfer_buffer
op_assign
id|runtime-&gt;dma_area
op_plus
id|subs-&gt;hwptr
op_star
id|usX2Y-&gt;stride
suffix:semicolon
r_if
c_cond
(paren
(paren
id|subs-&gt;hwptr
op_add_assign
id|count
)paren
op_ge
id|runtime-&gt;buffer_size
)paren
id|subs-&gt;hwptr
op_sub_assign
id|runtime-&gt;buffer_size
suffix:semicolon
)brace
r_else
id|urb-&gt;transfer_buffer
op_assign
id|subs-&gt;tmpbuf
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_assign
id|count
op_star
id|usX2Y-&gt;stride
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * process after playback data complete&n; *&n; * update the current position and call callback if a period is processed.&n; */
DECL|function|usX2Y_urb_play_retire
r_static
r_void
id|usX2Y_urb_play_retire
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;pcm_substream-&gt;runtime
suffix:semicolon
r_int
id|len
op_assign
id|urb-&gt;actual_length
op_div
id|subs-&gt;usX2Y-&gt;stride
suffix:semicolon
id|subs-&gt;transfer_done
op_add_assign
id|len
suffix:semicolon
id|subs-&gt;hwptr_done
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|subs-&gt;hwptr_done
op_ge
id|runtime-&gt;buffer_size
)paren
id|subs-&gt;hwptr_done
op_sub_assign
id|runtime-&gt;buffer_size
suffix:semicolon
r_if
c_cond
(paren
id|subs-&gt;transfer_done
op_ge
id|runtime-&gt;period_size
)paren
(brace
id|subs-&gt;transfer_done
op_sub_assign
id|runtime-&gt;period_size
suffix:semicolon
id|snd_pcm_period_elapsed
c_func
(paren
id|subs-&gt;pcm_substream
)paren
suffix:semicolon
)brace
)brace
DECL|function|usX2Y_urb_submit
r_static
r_int
id|usX2Y_urb_submit
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
comma
r_struct
id|urb
op_star
id|urb
comma
r_int
id|frame
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|urb-&gt;start_frame
op_assign
(paren
id|frame
op_plus
id|NRURBS
op_star
id|nr_of_packs
c_func
(paren
)paren
)paren
suffix:semicolon
singleline_comment|// let hcd do rollover sanity checks
id|urb-&gt;hcpriv
op_assign
l_int|NULL
suffix:semicolon
id|urb-&gt;dev
op_assign
id|subs-&gt;usX2Y-&gt;chip.dev
suffix:semicolon
multiline_comment|/* we need to set this at each time */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;usb_submit_urb() returned %i&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usX2Y_usbframe_complete
r_static
r_inline
r_int
id|usX2Y_usbframe_complete
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|capsubs
comma
id|snd_usX2Y_substream_t
op_star
id|playbacksubs
comma
r_int
id|frame
)paren
(brace
r_int
id|err
comma
id|state
suffix:semicolon
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|playbacksubs-&gt;completed_urb
suffix:semicolon
id|state
op_assign
id|atomic_read
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|urb
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|state_RUNNING
)paren
id|usX2Y_urb_play_retire
c_func
(paren
id|playbacksubs
comma
id|urb
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|state
op_ge
id|state_PRERUNNING
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|state_STARTING1
suffix:colon
id|urb
op_assign
id|playbacksubs-&gt;urb
(braket
l_int|0
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|state_STARTING2
suffix:colon
id|urb
op_assign
id|playbacksubs-&gt;urb
(braket
l_int|1
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|urb
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_urb_play_prepare
c_func
(paren
id|playbacksubs
comma
id|capsubs-&gt;completed_urb
comma
id|urb
)paren
)paren
op_logical_or
(paren
id|err
op_assign
id|usX2Y_urb_submit
c_func
(paren
id|playbacksubs
comma
id|urb
comma
id|frame
)paren
)paren
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
id|playbacksubs-&gt;completed_urb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|state
op_assign
id|atomic_read
c_func
(paren
op_amp
id|capsubs-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ge
id|state_PREPARED
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|state_RUNNING
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_urb_capt_retire
c_func
(paren
id|capsubs
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|state
op_ge
id|state_PRERUNNING
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|capsubs-&gt;state
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_urb_submit
c_func
(paren
id|capsubs
comma
id|capsubs-&gt;completed_urb
comma
id|frame
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
)brace
id|capsubs-&gt;completed_urb
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usX2Y_clients_stop
r_static
r_void
id|usX2Y_clients_stop
c_func
(paren
id|usX2Ydev_t
op_star
id|usX2Y
)paren
(brace
r_int
id|s
comma
id|u
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
l_int|0
suffix:semicolon
id|s
OL
l_int|4
suffix:semicolon
id|s
op_increment
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
id|usX2Y-&gt;subs
(braket
id|s
)braket
suffix:semicolon
r_if
c_cond
(paren
id|subs
)paren
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;%i %p state=%i&bslash;n&quot;
comma
id|s
comma
id|subs
comma
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|s
op_assign
l_int|0
suffix:semicolon
id|s
OL
l_int|4
suffix:semicolon
id|s
op_increment
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
id|usX2Y-&gt;subs
(braket
id|s
)braket
suffix:semicolon
r_if
c_cond
(paren
id|subs
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_ge
id|state_PRERUNNING
)paren
(brace
id|snd_pcm_stop
c_func
(paren
id|subs-&gt;pcm_substream
comma
id|SNDRV_PCM_STATE_XRUN
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|u
op_assign
l_int|0
suffix:semicolon
id|u
OL
id|NRURBS
suffix:semicolon
id|u
op_increment
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|subs-&gt;urb
(braket
id|u
)braket
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|urb
)paren
id|snd_printdd
c_func
(paren
l_string|&quot;%i status=%i start_frame=%i&bslash;n&quot;
comma
id|u
comma
id|urb-&gt;status
comma
id|urb-&gt;start_frame
)paren
suffix:semicolon
)brace
)brace
)brace
id|usX2Y-&gt;prepare_subs
op_assign
l_int|NULL
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|usX2Y-&gt;prepare_wait_queue
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_error_urb_status
r_static
r_void
id|usX2Y_error_urb_status
c_func
(paren
id|usX2Ydev_t
op_star
id|usX2Y
comma
id|snd_usX2Y_substream_t
op_star
id|subs
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;ep=%i stalled with status=%i&bslash;n&quot;
comma
id|subs-&gt;endpoint
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|urb-&gt;status
op_assign
l_int|0
suffix:semicolon
id|usX2Y_clients_stop
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_error_sequence
r_static
r_void
id|usX2Y_error_sequence
c_func
(paren
id|usX2Ydev_t
op_star
id|usX2Y
comma
id|snd_usX2Y_substream_t
op_star
id|subs
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;Sequence Error!(hcd_frame=%i ep=%i%s;wait=%i,frame=%i).&bslash;n&quot;
l_string|&quot;Most propably some urb of usb-frame %i is still missing.&bslash;n&quot;
l_string|&quot;Cause could be too long delays in usb-hcd interrupt handling.&bslash;n&quot;
comma
id|usb_get_current_frame_number
c_func
(paren
id|usX2Y-&gt;chip.dev
)paren
comma
id|subs-&gt;endpoint
comma
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
l_string|&quot;in&quot;
suffix:colon
l_string|&quot;out&quot;
comma
id|usX2Y-&gt;wait_iso_frame
comma
id|urb-&gt;start_frame
comma
id|usX2Y-&gt;wait_iso_frame
)paren
suffix:semicolon
id|usX2Y_clients_stop
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
)brace
DECL|function|i_usX2Y_urb_complete
r_static
r_void
id|i_usX2Y_urb_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
OL
id|state_PREPARED
)paren
)paren
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;hcd_frame=%i ep=%i%s status=%i start_frame=%i&bslash;n&quot;
comma
id|usb_get_current_frame_number
c_func
(paren
id|usX2Y-&gt;chip.dev
)paren
comma
id|subs-&gt;endpoint
comma
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
ques
c_cond
l_string|&quot;in&quot;
suffix:colon
l_string|&quot;out&quot;
comma
id|urb-&gt;status
comma
id|urb-&gt;start_frame
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|urb-&gt;status
)paren
)paren
(brace
id|usX2Y_error_urb_status
c_func
(paren
id|usX2Y
comma
id|subs
comma
id|urb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|likely
c_func
(paren
(paren
l_int|0xFFFF
op_amp
id|urb-&gt;start_frame
)paren
op_eq
id|usX2Y-&gt;wait_iso_frame
)paren
)paren
id|subs-&gt;completed_urb
op_assign
id|urb
suffix:semicolon
r_else
(brace
id|usX2Y_error_sequence
c_func
(paren
id|usX2Y
comma
id|subs
comma
id|urb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
(brace
id|snd_usX2Y_substream_t
op_star
id|capsubs
op_assign
id|usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
comma
op_star
id|playbacksubs
op_assign
id|usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
suffix:semicolon
r_if
c_cond
(paren
id|capsubs-&gt;completed_urb
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|capsubs-&gt;state
)paren
op_ge
id|state_PREPARED
op_logical_and
(paren
id|playbacksubs-&gt;completed_urb
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|playbacksubs-&gt;state
)paren
OL
id|state_PREPARED
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|usX2Y_usbframe_complete
c_func
(paren
id|capsubs
comma
id|playbacksubs
comma
id|urb-&gt;start_frame
)paren
)paren
(brace
r_if
c_cond
(paren
id|nr_of_packs
c_func
(paren
)paren
op_le
id|urb-&gt;start_frame
op_logical_and
id|urb-&gt;start_frame
op_le
(paren
l_int|2
op_star
id|nr_of_packs
c_func
(paren
)paren
op_minus
l_int|1
)paren
)paren
singleline_comment|// uhci and ohci
id|usX2Y-&gt;wait_iso_frame
op_assign
id|urb-&gt;start_frame
op_minus
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
r_else
id|usX2Y-&gt;wait_iso_frame
op_add_assign
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|usX2Y_clients_stop
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|usX2Y_urbs_set_complete
r_static
r_void
id|usX2Y_urbs_set_complete
c_func
(paren
id|usX2Ydev_t
op_star
id|usX2Y
comma
r_void
(paren
op_star
id|complete
)paren
(paren
r_struct
id|urb
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
(brace
r_int
id|s
comma
id|u
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
l_int|0
suffix:semicolon
id|s
OL
l_int|4
suffix:semicolon
id|s
op_increment
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
id|usX2Y-&gt;subs
(braket
id|s
)braket
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|subs
)paren
r_for
c_loop
(paren
id|u
op_assign
l_int|0
suffix:semicolon
id|u
OL
id|NRURBS
suffix:semicolon
id|u
op_increment
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|subs-&gt;urb
(braket
id|u
)braket
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|urb
)paren
id|urb-&gt;complete
op_assign
id|complete
suffix:semicolon
)brace
)brace
)brace
DECL|function|usX2Y_subs_startup_finish
r_static
r_void
id|usX2Y_subs_startup_finish
c_func
(paren
id|usX2Ydev_t
op_star
id|usX2Y
)paren
(brace
id|usX2Y_urbs_set_complete
c_func
(paren
id|usX2Y
comma
id|i_usX2Y_urb_complete
)paren
suffix:semicolon
id|usX2Y-&gt;prepare_subs
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|i_usX2Y_subs_startup
r_static
r_void
id|i_usX2Y_subs_startup
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|urb-&gt;context
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|prepare_subs
op_assign
id|usX2Y-&gt;prepare_subs
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|prepare_subs
)paren
r_if
c_cond
(paren
id|urb-&gt;start_frame
op_eq
id|prepare_subs-&gt;urb
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start_frame
)paren
(brace
id|usX2Y_subs_startup_finish
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|prepare_subs-&gt;state
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|usX2Y-&gt;prepare_wait_queue
)paren
suffix:semicolon
)brace
id|i_usX2Y_urb_complete
c_func
(paren
id|urb
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_subs_prepare
r_static
r_void
id|usX2Y_subs_prepare
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;usX2Y_substream_prepare(%p) ep=%i urb0=%p urb1=%p&bslash;n&quot;
comma
id|subs
comma
id|subs-&gt;endpoint
comma
id|subs-&gt;urb
(braket
l_int|0
)braket
comma
id|subs-&gt;urb
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* reset the pointer */
id|subs-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
id|subs-&gt;hwptr_done
op_assign
l_int|0
suffix:semicolon
id|subs-&gt;transfer_done
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|usX2Y_urb_release
r_static
r_void
id|usX2Y_urb_release
c_func
(paren
r_struct
id|urb
op_star
op_star
id|urb
comma
r_int
id|free_tb
)paren
(brace
r_if
c_cond
(paren
op_star
id|urb
)paren
(brace
id|usb_kill_urb
c_func
(paren
op_star
id|urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|free_tb
)paren
id|kfree
c_func
(paren
(paren
op_star
id|urb
)paren
op_member_access_from_pointer
id|transfer_buffer
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
op_star
id|urb
)paren
suffix:semicolon
op_star
id|urb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * release a substreams urbs&n; */
DECL|function|usX2Y_urbs_release
r_static
r_void
id|usX2Y_urbs_release
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
r_int
id|i
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;usX2Y_urbs_release() %i&bslash;n&quot;
comma
id|subs-&gt;endpoint
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRURBS
suffix:semicolon
id|i
op_increment
)paren
id|usX2Y_urb_release
c_func
(paren
id|subs-&gt;urb
op_plus
id|i
comma
id|subs
op_ne
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|subs-&gt;tmpbuf
)paren
(brace
id|kfree
c_func
(paren
id|subs-&gt;tmpbuf
)paren
suffix:semicolon
id|subs-&gt;tmpbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * initialize a substream&squot;s urbs&n; */
DECL|function|usX2Y_urbs_allocate
r_static
r_int
id|usX2Y_urbs_allocate
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|pipe
suffix:semicolon
r_int
id|is_playback
op_assign
id|subs
op_eq
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
op_assign
id|subs-&gt;usX2Y-&gt;chip.dev
suffix:semicolon
r_struct
id|usb_host_endpoint
op_star
id|ep
suffix:semicolon
id|pipe
op_assign
id|is_playback
ques
c_cond
id|usb_sndisocpipe
c_func
(paren
id|dev
comma
id|subs-&gt;endpoint
)paren
suffix:colon
id|usb_rcvisocpipe
c_func
(paren
id|dev
comma
id|subs-&gt;endpoint
)paren
suffix:semicolon
id|subs-&gt;maxpacksize
op_assign
id|usb_maxpacket
c_func
(paren
id|dev
comma
id|pipe
comma
id|is_playback
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|subs-&gt;maxpacksize
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|is_playback
op_logical_and
l_int|NULL
op_eq
id|subs-&gt;tmpbuf
)paren
(brace
multiline_comment|/* allocate a temporary buffer for playback */
id|subs-&gt;tmpbuf
op_assign
id|kcalloc
c_func
(paren
id|nr_of_packs
c_func
(paren
)paren
comma
id|subs-&gt;maxpacksize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|subs-&gt;tmpbuf
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc tmpbuf&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
multiline_comment|/* allocate and initialize data urbs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRURBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|urb
op_star
op_star
id|purb
op_assign
id|subs-&gt;urb
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|purb
)paren
(brace
id|usb_kill_urb
c_func
(paren
op_star
id|purb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
op_star
id|purb
op_assign
id|usb_alloc_urb
c_func
(paren
id|nr_of_packs
c_func
(paren
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
op_star
id|purb
)paren
(brace
id|usX2Y_urbs_release
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_playback
op_logical_and
op_logical_neg
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|transfer_buffer
)paren
(brace
multiline_comment|/* allocate a capture buffer per urb */
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|transfer_buffer
op_assign
id|kmalloc
c_func
(paren
id|subs-&gt;maxpacksize
op_star
id|nr_of_packs
c_func
(paren
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|transfer_buffer
)paren
(brace
id|usX2Y_urbs_release
c_func
(paren
id|subs
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|dev
op_assign
id|dev
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|pipe
op_assign
id|pipe
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|number_of_packets
op_assign
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|context
op_assign
id|subs
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|interval
op_assign
l_int|1
suffix:semicolon
(paren
op_star
id|purb
)paren
op_member_access_from_pointer
id|complete
op_assign
id|i_usX2Y_subs_startup
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usX2Y_subs_startup
r_static
r_void
id|usX2Y_subs_startup
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
id|usX2Y-&gt;prepare_subs
op_assign
id|subs
suffix:semicolon
id|subs-&gt;urb
(braket
l_int|0
)braket
op_member_access_from_pointer
id|start_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|usX2Y_urbs_set_complete
c_func
(paren
id|usX2Y
comma
id|i_usX2Y_subs_startup
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_urbs_start
r_static
r_int
id|usX2Y_urbs_start
c_func
(paren
id|snd_usX2Y_substream_t
op_star
id|subs
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_urbs_allocate
c_func
(paren
id|subs
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|subs-&gt;completed_urb
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
id|usX2Y-&gt;subs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|subs
op_ne
l_int|NULL
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_ge
id|state_PREPARED
)paren
r_goto
id|start
suffix:semicolon
)brace
id|usX2Y-&gt;wait_iso_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|start
suffix:colon
(brace
id|usX2Y_subs_startup
c_func
(paren
id|subs
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NRURBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|subs-&gt;urb
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|usb_pipein
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
r_int
r_int
id|pack
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|i
)paren
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STARTING3
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
id|usX2Y-&gt;chip.dev
suffix:semicolon
id|urb-&gt;transfer_flags
op_assign
id|URB_ISO_ASAP
suffix:semicolon
r_for
c_loop
(paren
id|pack
op_assign
l_int|0
suffix:semicolon
id|pack
OL
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
id|pack
op_increment
)paren
(brace
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|offset
op_assign
id|subs-&gt;maxpacksize
op_star
id|pack
suffix:semicolon
id|urb-&gt;iso_frame_desc
(braket
id|pack
)braket
dot
id|length
op_assign
id|subs-&gt;maxpacksize
suffix:semicolon
)brace
id|urb-&gt;transfer_buffer_length
op_assign
id|subs-&gt;maxpacksize
op_star
id|nr_of_packs
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
(paren
id|KERN_ERR
l_string|&quot;cannot submit datapipe for urb %d, err = %d&bslash;n&quot;
comma
id|i
comma
id|err
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPIPE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
l_int|0
OG
id|usX2Y-&gt;wait_iso_frame
)paren
id|usX2Y-&gt;wait_iso_frame
op_assign
id|urb-&gt;start_frame
suffix:semicolon
)brace
id|urb-&gt;transfer_flags
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STARTING1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|wait_event
c_func
(paren
id|usX2Y-&gt;prepare_wait_queue
comma
l_int|NULL
op_eq
id|usX2Y-&gt;prepare_subs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_ne
id|state_PREPARED
)paren
(brace
id|err
op_assign
op_minus
id|EPIPE
suffix:semicolon
)brace
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|err
)paren
(brace
id|usX2Y_subs_startup_finish
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
id|usX2Y_clients_stop
c_func
(paren
id|usX2Y
)paren
suffix:semicolon
singleline_comment|// something is completely wroong &gt; stop evrything
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * return the current pcm pointer.  just return the hwptr_done value.&n; */
DECL|function|snd_usX2Y_pcm_pointer
r_static
id|snd_pcm_uframes_t
id|snd_usX2Y_pcm_pointer
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|substream-&gt;runtime-&gt;private_data
suffix:semicolon
r_return
id|subs-&gt;hwptr_done
suffix:semicolon
)brace
multiline_comment|/*&n; * start/stop substream&n; */
DECL|function|snd_usX2Y_pcm_trigger
r_static
r_int
id|snd_usX2Y_pcm_trigger
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
r_int
id|cmd
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|substream-&gt;runtime-&gt;private_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_PCM_TRIGGER_START
suffix:colon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_usX2Y_pcm_trigger(START)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_eq
id|state_PREPARED
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
op_member_access_from_pointer
id|state
)paren
op_ge
id|state_PREPARED
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_PRERUNNING
)paren
suffix:semicolon
)brace
r_else
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPIPE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_STOP
suffix:colon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_usX2Y_pcm_trigger(STOP)&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
op_ge
id|state_PRERUNNING
)paren
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_PREPARED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * allocate a buffer, setup samplerate&n; *&n; * so far we use a physically linear buffer although packetize transfer&n; * doesn&squot;t need a continuous area.&n; * if sg buffer is supported on the later version of alsa, we&squot;ll follow&n; * that.&n; */
DECL|struct|s_c2
r_static
r_struct
id|s_c2
(brace
DECL|member|c1
DECL|member|c2
r_char
id|c1
comma
id|c2
suffix:semicolon
)brace
DECL|variable|SetRate44100
id|SetRate44100
(braket
)braket
op_assign
(brace
(brace
l_int|0x14
comma
l_int|0x08
)brace
comma
singleline_comment|// this line sets 44100, well actually a little less
(brace
l_int|0x18
comma
l_int|0x40
)brace
comma
singleline_comment|// only tascam / frontier design knows the further lines .......
(brace
l_int|0x18
comma
l_int|0x42
)brace
comma
(brace
l_int|0x18
comma
l_int|0x45
)brace
comma
(brace
l_int|0x18
comma
l_int|0x46
)brace
comma
(brace
l_int|0x18
comma
l_int|0x48
)brace
comma
(brace
l_int|0x18
comma
l_int|0x4A
)brace
comma
(brace
l_int|0x18
comma
l_int|0x4C
)brace
comma
(brace
l_int|0x18
comma
l_int|0x4E
)brace
comma
(brace
l_int|0x18
comma
l_int|0x50
)brace
comma
(brace
l_int|0x18
comma
l_int|0x52
)brace
comma
(brace
l_int|0x18
comma
l_int|0x54
)brace
comma
(brace
l_int|0x18
comma
l_int|0x56
)brace
comma
(brace
l_int|0x18
comma
l_int|0x58
)brace
comma
(brace
l_int|0x18
comma
l_int|0x5A
)brace
comma
(brace
l_int|0x18
comma
l_int|0x5C
)brace
comma
(brace
l_int|0x18
comma
l_int|0x5E
)brace
comma
(brace
l_int|0x18
comma
l_int|0x60
)brace
comma
(brace
l_int|0x18
comma
l_int|0x62
)brace
comma
(brace
l_int|0x18
comma
l_int|0x64
)brace
comma
(brace
l_int|0x18
comma
l_int|0x66
)brace
comma
(brace
l_int|0x18
comma
l_int|0x68
)brace
comma
(brace
l_int|0x18
comma
l_int|0x6A
)brace
comma
(brace
l_int|0x18
comma
l_int|0x6C
)brace
comma
(brace
l_int|0x18
comma
l_int|0x6E
)brace
comma
(brace
l_int|0x18
comma
l_int|0x70
)brace
comma
(brace
l_int|0x18
comma
l_int|0x72
)brace
comma
(brace
l_int|0x18
comma
l_int|0x74
)brace
comma
(brace
l_int|0x18
comma
l_int|0x76
)brace
comma
(brace
l_int|0x18
comma
l_int|0x78
)brace
comma
(brace
l_int|0x18
comma
l_int|0x7A
)brace
comma
(brace
l_int|0x18
comma
l_int|0x7C
)brace
comma
(brace
l_int|0x18
comma
l_int|0x7E
)brace
)brace
suffix:semicolon
DECL|variable|SetRate48000
r_static
r_struct
id|s_c2
id|SetRate48000
(braket
)braket
op_assign
(brace
(brace
l_int|0x14
comma
l_int|0x09
)brace
comma
singleline_comment|// this line sets 48000, well actually a little less
(brace
l_int|0x18
comma
l_int|0x40
)brace
comma
singleline_comment|// only tascam / frontier design knows the further lines .......
(brace
l_int|0x18
comma
l_int|0x42
)brace
comma
(brace
l_int|0x18
comma
l_int|0x45
)brace
comma
(brace
l_int|0x18
comma
l_int|0x46
)brace
comma
(brace
l_int|0x18
comma
l_int|0x48
)brace
comma
(brace
l_int|0x18
comma
l_int|0x4A
)brace
comma
(brace
l_int|0x18
comma
l_int|0x4C
)brace
comma
(brace
l_int|0x18
comma
l_int|0x4E
)brace
comma
(brace
l_int|0x18
comma
l_int|0x50
)brace
comma
(brace
l_int|0x18
comma
l_int|0x52
)brace
comma
(brace
l_int|0x18
comma
l_int|0x54
)brace
comma
(brace
l_int|0x18
comma
l_int|0x56
)brace
comma
(brace
l_int|0x18
comma
l_int|0x58
)brace
comma
(brace
l_int|0x18
comma
l_int|0x5A
)brace
comma
(brace
l_int|0x18
comma
l_int|0x5C
)brace
comma
(brace
l_int|0x18
comma
l_int|0x5E
)brace
comma
(brace
l_int|0x18
comma
l_int|0x60
)brace
comma
(brace
l_int|0x18
comma
l_int|0x62
)brace
comma
(brace
l_int|0x18
comma
l_int|0x64
)brace
comma
(brace
l_int|0x18
comma
l_int|0x66
)brace
comma
(brace
l_int|0x18
comma
l_int|0x68
)brace
comma
(brace
l_int|0x18
comma
l_int|0x6A
)brace
comma
(brace
l_int|0x18
comma
l_int|0x6C
)brace
comma
(brace
l_int|0x18
comma
l_int|0x6E
)brace
comma
(brace
l_int|0x18
comma
l_int|0x70
)brace
comma
(brace
l_int|0x18
comma
l_int|0x73
)brace
comma
(brace
l_int|0x18
comma
l_int|0x74
)brace
comma
(brace
l_int|0x18
comma
l_int|0x76
)brace
comma
(brace
l_int|0x18
comma
l_int|0x78
)brace
comma
(brace
l_int|0x18
comma
l_int|0x7A
)brace
comma
(brace
l_int|0x18
comma
l_int|0x7C
)brace
comma
(brace
l_int|0x18
comma
l_int|0x7E
)brace
)brace
suffix:semicolon
DECL|macro|NOOF_SETRATE_URBS
mdefine_line|#define NOOF_SETRATE_URBS ARRAY_SIZE(SetRate48000)
DECL|function|i_usX2Y_04Int
r_static
r_void
id|i_usX2Y_04Int
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;snd_usX2Y_04Int() urb-&gt;status=%i&bslash;n&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_eq
op_decrement
id|usX2Y-&gt;US04-&gt;len
)paren
id|wake_up
c_func
(paren
op_amp
id|usX2Y-&gt;In04WaitQueue
)paren
suffix:semicolon
)brace
DECL|function|usX2Y_rate_set
r_static
r_int
id|usX2Y_rate_set
c_func
(paren
id|usX2Ydev_t
op_star
id|usX2Y
comma
r_int
id|rate
)paren
(brace
r_int
id|err
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|snd_usX2Y_urbSeq_t
op_star
id|us
op_assign
l_int|NULL
suffix:semicolon
r_int
op_star
id|usbdata
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|s_c2
op_star
id|ra
op_assign
id|rate
op_eq
l_int|48000
ques
c_cond
id|SetRate48000
suffix:colon
id|SetRate44100
suffix:semicolon
r_if
c_cond
(paren
id|usX2Y-&gt;rate
op_ne
id|rate
)paren
(brace
id|us
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|us
)paren
op_plus
r_sizeof
(paren
r_struct
id|urb
op_star
)paren
op_star
id|NOOF_SETRATE_URBS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|us
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|memset
c_func
(paren
id|us
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|us
)paren
op_plus
r_sizeof
(paren
r_struct
id|urb
op_star
)paren
op_star
id|NOOF_SETRATE_URBS
)paren
suffix:semicolon
id|usbdata
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_int
)paren
op_star
id|NOOF_SETRATE_URBS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|usbdata
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NOOF_SETRATE_URBS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
id|us-&gt;urb
(braket
id|i
)braket
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
(paren
(paren
r_char
op_star
)paren
(paren
id|usbdata
op_plus
id|i
)paren
)paren
(braket
l_int|0
)braket
op_assign
id|ra
(braket
id|i
)braket
dot
id|c1
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
(paren
id|usbdata
op_plus
id|i
)paren
)paren
(braket
l_int|1
)braket
op_assign
id|ra
(braket
id|i
)braket
dot
id|c2
suffix:semicolon
id|usb_fill_bulk_urb
c_func
(paren
id|us-&gt;urb
(braket
id|i
)braket
comma
id|usX2Y-&gt;chip.dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|usX2Y-&gt;chip.dev
comma
l_int|4
)paren
comma
id|usbdata
op_plus
id|i
comma
l_int|2
comma
id|i_usX2Y_04Int
comma
id|usX2Y
)paren
suffix:semicolon
macro_line|#ifdef OLD_USB
id|us-&gt;urb
(braket
id|i
)braket
op_member_access_from_pointer
id|transfer_flags
op_assign
id|USB_QUEUE_BULK
suffix:semicolon
macro_line|#endif
)brace
id|us-&gt;submitted
op_assign
l_int|0
suffix:semicolon
id|us-&gt;len
op_assign
id|NOOF_SETRATE_URBS
suffix:semicolon
id|usX2Y-&gt;US04
op_assign
id|us
suffix:semicolon
id|wait_event_timeout
c_func
(paren
id|usX2Y-&gt;In04WaitQueue
comma
l_int|0
op_eq
id|us-&gt;len
comma
id|HZ
)paren
suffix:semicolon
id|usX2Y-&gt;US04
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|us-&gt;len
)paren
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|us
)paren
(brace
id|us-&gt;submitted
op_assign
l_int|2
op_star
id|NOOF_SETRATE_URBS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NOOF_SETRATE_URBS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|us-&gt;urb
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|usb_kill_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
id|usb_free_urb
c_func
(paren
id|urb
)paren
suffix:semicolon
)brace
id|usX2Y-&gt;US04
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|usbdata
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|us
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|usX2Y-&gt;rate
op_assign
id|rate
suffix:semicolon
)brace
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|usX2Y_format_set
r_static
r_int
id|usX2Y_format_set
c_func
(paren
id|usX2Ydev_t
op_star
id|usX2Y
comma
id|snd_pcm_format_t
id|format
)paren
(brace
r_int
id|alternate
comma
id|err
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|format
op_eq
id|SNDRV_PCM_FORMAT_S24_3LE
)paren
(brace
id|alternate
op_assign
l_int|2
suffix:semicolon
id|usX2Y-&gt;stride
op_assign
l_int|6
suffix:semicolon
)brace
r_else
(brace
id|alternate
op_assign
l_int|1
suffix:semicolon
id|usX2Y-&gt;stride
op_assign
l_int|4
suffix:semicolon
)brace
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|usX2Y-&gt;chip.midi_list
)paren
(brace
id|snd_usbmidi_input_stop
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
id|usb_kill_urb
c_func
(paren
id|usX2Y-&gt;In04urb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_set_interface
c_func
(paren
id|usX2Y-&gt;chip.dev
comma
l_int|0
comma
id|alternate
)paren
)paren
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;usb_set_interface error &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|usX2Y-&gt;In04urb-&gt;dev
op_assign
id|usX2Y-&gt;chip.dev
suffix:semicolon
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|usX2Y-&gt;In04urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|usX2Y-&gt;chip.midi_list
)paren
(brace
id|snd_usbmidi_input_start
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
id|usX2Y-&gt;format
op_assign
id|format
suffix:semicolon
id|usX2Y-&gt;rate
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|snd_usX2Y_pcm_hw_params
r_static
r_int
id|snd_usX2Y_pcm_hw_params
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
id|snd_pcm_hw_params_t
op_star
id|hw_params
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|rate
op_assign
id|params_rate
c_func
(paren
id|hw_params
)paren
suffix:semicolon
id|snd_pcm_format_t
id|format
op_assign
id|params_format
c_func
(paren
id|hw_params
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_usX2Y_hw_params(%p, %p)&bslash;n&quot;
comma
id|substream
comma
id|hw_params
)paren
suffix:semicolon
(brace
singleline_comment|// all pcm substreams off one usX2Y have to operate at the same rate &amp; format
id|snd_card_t
op_star
id|card
op_assign
id|substream-&gt;pstr-&gt;pcm-&gt;card
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|card-&gt;devices
)paren
(brace
id|snd_device_t
op_star
id|dev
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_int
id|s
suffix:semicolon
id|dev
op_assign
id|snd_device
c_func
(paren
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|SNDRV_DEV_PCM
)paren
r_continue
suffix:semicolon
id|pcm
op_assign
id|dev-&gt;device_data
suffix:semicolon
r_for
c_loop
(paren
id|s
op_assign
l_int|0
suffix:semicolon
id|s
OL
l_int|2
suffix:semicolon
op_increment
id|s
)paren
(brace
id|snd_pcm_substream_t
op_star
id|test_substream
suffix:semicolon
id|test_substream
op_assign
id|pcm-&gt;streams
(braket
id|s
)braket
dot
id|substream
suffix:semicolon
r_if
c_cond
(paren
id|test_substream
op_logical_and
id|test_substream
op_ne
id|substream
op_logical_and
id|test_substream-&gt;runtime
op_logical_and
(paren
(paren
id|test_substream-&gt;runtime-&gt;format
op_logical_and
id|test_substream-&gt;runtime-&gt;format
op_ne
id|format
)paren
op_logical_or
(paren
id|test_substream-&gt;runtime-&gt;rate
op_logical_and
id|test_substream-&gt;runtime-&gt;rate
op_ne
id|rate
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
l_int|0
OG
(paren
id|err
op_assign
id|snd_pcm_lib_malloc_pages
c_func
(paren
id|substream
comma
id|params_buffer_bytes
c_func
(paren
id|hw_params
)paren
)paren
)paren
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;snd_pcm_lib_malloc_pages(%p, %i) returned %i&bslash;n&quot;
comma
id|substream
comma
id|params_buffer_bytes
c_func
(paren
id|hw_params
)paren
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * free the buffer&n; */
DECL|function|snd_usX2Y_pcm_hw_free
r_static
r_int
id|snd_usX2Y_pcm_hw_free
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|runtime-&gt;private_data
suffix:semicolon
id|down
c_func
(paren
op_amp
id|subs-&gt;usX2Y-&gt;prepare_mutex
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_usX2Y_hw_free(%p)&bslash;n&quot;
comma
id|substream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SNDRV_PCM_STREAM_PLAYBACK
op_eq
id|substream-&gt;stream
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|cap_subs
op_assign
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
id|usX2Y_urbs_release
c_func
(paren
id|subs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cap_subs-&gt;pcm_substream
op_logical_or
op_logical_neg
id|cap_subs-&gt;pcm_substream-&gt;runtime
op_logical_or
op_logical_neg
id|cap_subs-&gt;pcm_substream-&gt;runtime-&gt;status
op_logical_or
id|cap_subs-&gt;pcm_substream-&gt;runtime-&gt;status-&gt;state
OL
id|SNDRV_PCM_STATE_PREPARED
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|cap_subs-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
id|usX2Y_urbs_release
c_func
(paren
id|cap_subs
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|snd_usX2Y_substream_t
op_star
id|playback_subs
op_assign
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|playback_subs-&gt;state
)paren
OL
id|state_PREPARED
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|subs-&gt;state
comma
id|state_STOPPED
)paren
suffix:semicolon
id|usX2Y_urbs_release
c_func
(paren
id|subs
)paren
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|subs-&gt;usX2Y-&gt;prepare_mutex
)paren
suffix:semicolon
r_return
id|snd_pcm_lib_free_pages
c_func
(paren
id|substream
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * prepare callback&n; *&n; * set format and initialize urbs&n; */
DECL|function|snd_usX2Y_pcm_prepare
r_static
r_int
id|snd_usX2Y_pcm_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|runtime-&gt;private_data
suffix:semicolon
id|usX2Ydev_t
op_star
id|usX2Y
op_assign
id|subs-&gt;usX2Y
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|capsubs
op_assign
id|subs-&gt;usX2Y-&gt;subs
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_usX2Y_pcm_prepare(%p)&bslash;n&quot;
comma
id|substream
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|usX2Y-&gt;prepare_mutex
)paren
suffix:semicolon
id|usX2Y_subs_prepare
c_func
(paren
id|subs
)paren
suffix:semicolon
singleline_comment|// Start hardware streams
singleline_comment|// SyncStream first....
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|capsubs-&gt;state
)paren
OL
id|state_PREPARED
)paren
(brace
r_if
c_cond
(paren
id|usX2Y-&gt;format
op_ne
id|runtime-&gt;format
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_format_set
c_func
(paren
id|usX2Y
comma
id|runtime-&gt;format
)paren
)paren
OL
l_int|0
)paren
r_goto
id|up_prepare_mutex
suffix:semicolon
r_if
c_cond
(paren
id|usX2Y-&gt;rate
op_ne
id|runtime-&gt;rate
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usX2Y_rate_set
c_func
(paren
id|usX2Y
comma
id|runtime-&gt;rate
)paren
)paren
OL
l_int|0
)paren
r_goto
id|up_prepare_mutex
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;starting capture pipe for %s&bslash;n&quot;
comma
id|subs
op_eq
id|capsubs
ques
c_cond
l_string|&quot;self&quot;
suffix:colon
l_string|&quot;playpipe&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
(paren
id|err
op_assign
id|usX2Y_urbs_start
c_func
(paren
id|capsubs
)paren
)paren
)paren
r_goto
id|up_prepare_mutex
suffix:semicolon
)brace
r_if
c_cond
(paren
id|subs
op_ne
id|capsubs
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|subs-&gt;state
)paren
OL
id|state_PREPARED
)paren
id|err
op_assign
id|usX2Y_urbs_start
c_func
(paren
id|subs
)paren
suffix:semicolon
id|up_prepare_mutex
suffix:colon
id|up
c_func
(paren
op_amp
id|usX2Y-&gt;prepare_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|snd_usX2Y_2c
r_static
id|snd_pcm_hardware_t
id|snd_usX2Y_2c
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_BLOCK_TRANSFER
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
)paren
comma
dot
id|formats
op_assign
id|SNDRV_PCM_FMTBIT_S16_LE
op_or
id|SNDRV_PCM_FMTBIT_S24_3LE
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_44100
op_or
id|SNDRV_PCM_RATE_48000
comma
dot
id|rate_min
op_assign
l_int|44100
comma
dot
id|rate_max
op_assign
l_int|48000
comma
dot
id|channels_min
op_assign
l_int|2
comma
dot
id|channels_max
op_assign
l_int|2
comma
dot
id|buffer_bytes_max
op_assign
(paren
l_int|2
op_star
l_int|128
op_star
l_int|1024
)paren
comma
dot
id|period_bytes_min
op_assign
l_int|64
comma
dot
id|period_bytes_max
op_assign
(paren
l_int|128
op_star
l_int|1024
)paren
comma
dot
id|periods_min
op_assign
l_int|2
comma
dot
id|periods_max
op_assign
l_int|1024
comma
dot
id|fifo_size
op_assign
l_int|0
)brace
suffix:semicolon
DECL|function|snd_usX2Y_pcm_open
r_static
r_int
id|snd_usX2Y_pcm_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
(paren
id|snd_usX2Y_substream_t
op_star
op_star
)paren
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
)paren
(braket
id|substream-&gt;stream
)braket
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
r_if
c_cond
(paren
id|subs-&gt;usX2Y-&gt;chip_status
op_amp
id|USX2Y_STAT_CHIP_MMAP_PCM_URBS
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_usX2Y_2c
suffix:semicolon
id|runtime-&gt;private_data
op_assign
id|subs
suffix:semicolon
id|subs-&gt;pcm_substream
op_assign
id|substream
suffix:semicolon
id|snd_pcm_hw_constraint_minmax
c_func
(paren
id|runtime
comma
id|SNDRV_PCM_HW_PARAM_PERIOD_TIME
comma
l_int|1000
comma
l_int|200000
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usX2Y_pcm_close
r_static
r_int
id|snd_usX2Y_pcm_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
id|subs
op_assign
(paren
id|snd_usX2Y_substream_t
op_star
)paren
id|runtime-&gt;private_data
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|subs-&gt;pcm_substream
op_assign
l_int|NULL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|snd_usX2Y_pcm_ops
r_static
id|snd_pcm_ops_t
id|snd_usX2Y_pcm_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_usX2Y_pcm_open
comma
dot
id|close
op_assign
id|snd_usX2Y_pcm_close
comma
dot
id|ioctl
op_assign
id|snd_pcm_lib_ioctl
comma
dot
id|hw_params
op_assign
id|snd_usX2Y_pcm_hw_params
comma
dot
id|hw_free
op_assign
id|snd_usX2Y_pcm_hw_free
comma
dot
id|prepare
op_assign
id|snd_usX2Y_pcm_prepare
comma
dot
id|trigger
op_assign
id|snd_usX2Y_pcm_trigger
comma
dot
id|pointer
op_assign
id|snd_usX2Y_pcm_pointer
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * free a usb stream instance&n; */
DECL|function|usX2Y_audio_stream_free
r_static
r_void
id|usX2Y_audio_stream_free
c_func
(paren
id|snd_usX2Y_substream_t
op_star
op_star
id|usX2Y_substream
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_ne
id|usX2Y_substream
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
)paren
(brace
id|kfree
c_func
(paren
id|usX2Y_substream
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
)paren
suffix:semicolon
id|usX2Y_substream
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|usX2Y_substream
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
)paren
suffix:semicolon
id|usX2Y_substream
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|snd_usX2Y_pcm_private_free
r_static
r_void
id|snd_usX2Y_pcm_private_free
c_func
(paren
id|snd_pcm_t
op_star
id|pcm
)paren
(brace
id|snd_usX2Y_substream_t
op_star
op_star
id|usX2Y_stream
op_assign
id|pcm-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|usX2Y_stream
)paren
(brace
id|snd_pcm_lib_preallocate_free_for_all
c_func
(paren
id|pcm
)paren
suffix:semicolon
id|usX2Y_audio_stream_free
c_func
(paren
id|usX2Y_stream
)paren
suffix:semicolon
)brace
)brace
DECL|function|usX2Y_audio_stream_new
r_static
r_int
id|usX2Y_audio_stream_new
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
id|playback_endpoint
comma
r_int
id|capture_endpoint
)paren
(brace
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_int
id|err
comma
id|i
suffix:semicolon
id|snd_usX2Y_substream_t
op_star
op_star
id|usX2Y_substream
op_assign
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|subs
op_plus
l_int|2
op_star
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip.pcm_devs
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|playback_endpoint
ques
c_cond
id|SNDRV_PCM_STREAM_PLAYBACK
suffix:colon
id|SNDRV_PCM_STREAM_CAPTURE
suffix:semicolon
id|i
op_le
id|SNDRV_PCM_STREAM_CAPTURE
suffix:semicolon
op_increment
id|i
)paren
(brace
id|usX2Y_substream
(braket
id|i
)braket
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
id|snd_usX2Y_substream_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|usX2Y_substream
(braket
id|i
)braket
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|usX2Y_substream
(braket
id|i
)braket
op_member_access_from_pointer
id|usX2Y
op_assign
id|usX2Y
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|playback_endpoint
)paren
id|usX2Y_substream
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
op_member_access_from_pointer
id|endpoint
op_assign
id|playback_endpoint
suffix:semicolon
id|usX2Y_substream
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
op_member_access_from_pointer
id|endpoint
op_assign
id|capture_endpoint
suffix:semicolon
id|err
op_assign
id|snd_pcm_new
c_func
(paren
id|card
comma
id|NAME_ALLCAPS
l_string|&quot; Audio&quot;
comma
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip.pcm_devs
comma
id|playback_endpoint
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
l_int|1
comma
op_amp
id|pcm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|usX2Y_audio_stream_free
c_func
(paren
id|usX2Y_substream
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|playback_endpoint
)paren
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_PLAYBACK
comma
op_amp
id|snd_usX2Y_pcm_ops
)paren
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_CAPTURE
comma
op_amp
id|snd_usX2Y_pcm_ops
)paren
suffix:semicolon
id|pcm-&gt;private_data
op_assign
id|usX2Y_substream
suffix:semicolon
id|pcm-&gt;private_free
op_assign
id|snd_usX2Y_pcm_private_free
suffix:semicolon
id|pcm-&gt;info_flags
op_assign
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|pcm-&gt;name
comma
id|NAME_ALLCAPS
l_string|&quot; Audio #%d&quot;
comma
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip.pcm_devs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|playback_endpoint
op_logical_and
l_int|0
OG
(paren
id|err
op_assign
id|snd_pcm_lib_preallocate_pages
c_func
(paren
id|pcm-&gt;streams
(braket
id|SNDRV_PCM_STREAM_PLAYBACK
)braket
dot
id|substream
comma
id|SNDRV_DMA_TYPE_CONTINUOUS
comma
id|snd_dma_continuous_data
c_func
(paren
id|GFP_KERNEL
)paren
comma
l_int|64
op_star
l_int|1024
comma
l_int|128
op_star
l_int|1024
)paren
)paren
)paren
op_logical_or
l_int|0
OG
(paren
id|err
op_assign
id|snd_pcm_lib_preallocate_pages
c_func
(paren
id|pcm-&gt;streams
(braket
id|SNDRV_PCM_STREAM_CAPTURE
)braket
dot
id|substream
comma
id|SNDRV_DMA_TYPE_CONTINUOUS
comma
id|snd_dma_continuous_data
c_func
(paren
id|GFP_KERNEL
)paren
comma
l_int|64
op_star
l_int|1024
comma
l_int|128
op_star
l_int|1024
)paren
)paren
)paren
(brace
id|snd_usX2Y_pcm_private_free
c_func
(paren
id|pcm
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip.pcm_devs
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * create a chip instance and set its names.&n; */
DECL|function|usX2Y_audio_create
r_int
id|usX2Y_audio_create
c_func
(paren
id|snd_card_t
op_star
id|card
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip.pcm_list
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
(paren
id|err
op_assign
id|usX2Y_audio_stream_new
c_func
(paren
id|card
comma
l_int|0xA
comma
l_int|0x8
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip.dev-&gt;descriptor.idProduct
)paren
op_eq
id|USB_ID_US428
)paren
r_if
c_cond
(paren
l_int|0
OG
(paren
id|err
op_assign
id|usX2Y_audio_stream_new
c_func
(paren
id|card
comma
l_int|0
comma
l_int|0xA
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|usX2Y
c_func
(paren
id|card
)paren
op_member_access_from_pointer
id|chip.dev-&gt;descriptor.idProduct
)paren
op_ne
id|USB_ID_US122
)paren
id|err
op_assign
id|usX2Y_rate_set
c_func
(paren
id|usX2Y
c_func
(paren
id|card
)paren
comma
l_int|44100
)paren
suffix:semicolon
singleline_comment|// Lets us428 recognize output-volume settings, disturbs us122.
r_return
id|err
suffix:semicolon
)brace
eof
