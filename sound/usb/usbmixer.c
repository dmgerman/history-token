multiline_comment|/*&n; *   (Tentative) USB Audio Driver for ALSA&n; *&n; *   Mixer control part&n; *&n; *   Copyright (c) 2002 by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   Many codes borrowed from audio.c by &n; *&t;    Alan Cox (alan@lxorguk.ukuu.org.uk)&n; *&t;    Thomas Sailer (sailer@ife.ee.ethz.ch)&n; *&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/control.h&gt;
macro_line|#include &quot;usbaudio.h&quot;
multiline_comment|/*&n; */
multiline_comment|/* ignore error from controls - for debugging */
multiline_comment|/* #define IGNORE_CTL_ERROR */
DECL|typedef|mixer_build_t
r_typedef
r_struct
id|usb_mixer_build
id|mixer_build_t
suffix:semicolon
DECL|typedef|usb_audio_term_t
r_typedef
r_struct
id|usb_audio_term
id|usb_audio_term_t
suffix:semicolon
DECL|typedef|usb_mixer_elem_info_t
r_typedef
r_struct
id|usb_mixer_elem_info
id|usb_mixer_elem_info_t
suffix:semicolon
DECL|struct|usb_audio_term
r_struct
id|usb_audio_term
(brace
DECL|member|id
r_int
id|id
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|channels
r_int
id|channels
suffix:semicolon
DECL|member|chconfig
r_int
r_int
id|chconfig
suffix:semicolon
DECL|member|name
r_int
id|name
suffix:semicolon
)brace
suffix:semicolon
r_struct
id|usbmix_name_map
suffix:semicolon
DECL|struct|usb_mixer_build
r_struct
id|usb_mixer_build
(brace
DECL|member|chip
id|snd_usb_audio_t
op_star
id|chip
suffix:semicolon
DECL|member|buffer
r_int
r_char
op_star
id|buffer
suffix:semicolon
DECL|member|buflen
r_int
r_int
id|buflen
suffix:semicolon
DECL|member|ctrlif
r_int
r_int
id|ctrlif
suffix:semicolon
DECL|member|vendor
r_int
r_int
id|vendor
suffix:semicolon
DECL|member|product
r_int
r_int
id|product
suffix:semicolon
id|DECLARE_BITMAP
c_func
(paren
id|unitbitmap
comma
l_int|32
op_star
l_int|32
)paren
suffix:semicolon
DECL|member|oterm
id|usb_audio_term_t
id|oterm
suffix:semicolon
DECL|member|map
r_const
r_struct
id|usbmix_name_map
op_star
id|map
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|usb_mixer_elem_info
r_struct
id|usb_mixer_elem_info
(brace
DECL|member|chip
id|snd_usb_audio_t
op_star
id|chip
suffix:semicolon
DECL|member|ctrlif
r_int
r_int
id|ctrlif
suffix:semicolon
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|control
r_int
r_int
id|control
suffix:semicolon
multiline_comment|/* CS or ICN (high byte) */
DECL|member|cmask
r_int
r_int
id|cmask
suffix:semicolon
multiline_comment|/* channel mask bitmap: 0 = master */
DECL|member|channels
r_int
id|channels
suffix:semicolon
DECL|member|val_type
r_int
id|val_type
suffix:semicolon
DECL|member|min
DECL|member|max
DECL|member|res
r_int
id|min
comma
id|max
comma
id|res
suffix:semicolon
DECL|member|initialized
r_int
r_int
id|initialized
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|USB_FEATURE_NONE
id|USB_FEATURE_NONE
op_assign
l_int|0
comma
DECL|enumerator|USB_FEATURE_MUTE
id|USB_FEATURE_MUTE
op_assign
l_int|1
comma
DECL|enumerator|USB_FEATURE_VOLUME
id|USB_FEATURE_VOLUME
comma
DECL|enumerator|USB_FEATURE_BASS
id|USB_FEATURE_BASS
comma
DECL|enumerator|USB_FEATURE_MID
id|USB_FEATURE_MID
comma
DECL|enumerator|USB_FEATURE_TREBLE
id|USB_FEATURE_TREBLE
comma
DECL|enumerator|USB_FEATURE_GEQ
id|USB_FEATURE_GEQ
comma
DECL|enumerator|USB_FEATURE_AGC
id|USB_FEATURE_AGC
comma
DECL|enumerator|USB_FEATURE_DELAY
id|USB_FEATURE_DELAY
comma
DECL|enumerator|USB_FEATURE_BASSBOOST
id|USB_FEATURE_BASSBOOST
comma
DECL|enumerator|FSB_FEATURE_LOUDNESS
id|FSB_FEATURE_LOUDNESS
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|USB_MIXER_BOOLEAN
id|USB_MIXER_BOOLEAN
comma
DECL|enumerator|USB_MIXER_INV_BOOLEAN
id|USB_MIXER_INV_BOOLEAN
comma
DECL|enumerator|USB_MIXER_S8
id|USB_MIXER_S8
comma
DECL|enumerator|USB_MIXER_U8
id|USB_MIXER_U8
comma
DECL|enumerator|USB_MIXER_S16
id|USB_MIXER_S16
comma
DECL|enumerator|USB_MIXER_U16
id|USB_MIXER_U16
comma
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|USB_PROC_UPDOWN
id|USB_PROC_UPDOWN
op_assign
l_int|1
comma
DECL|enumerator|USB_PROC_UPDOWN_SWITCH
id|USB_PROC_UPDOWN_SWITCH
op_assign
l_int|1
comma
DECL|enumerator|USB_PROC_UPDOWN_MODE_SEL
id|USB_PROC_UPDOWN_MODE_SEL
op_assign
l_int|2
comma
DECL|enumerator|USB_PROC_PROLOGIC
id|USB_PROC_PROLOGIC
op_assign
l_int|2
comma
DECL|enumerator|USB_PROC_PROLOGIC_SWITCH
id|USB_PROC_PROLOGIC_SWITCH
op_assign
l_int|1
comma
DECL|enumerator|USB_PROC_PROLOGIC_MODE_SEL
id|USB_PROC_PROLOGIC_MODE_SEL
op_assign
l_int|2
comma
DECL|enumerator|USB_PROC_3DENH
id|USB_PROC_3DENH
op_assign
l_int|3
comma
DECL|enumerator|USB_PROC_3DENH_SWITCH
id|USB_PROC_3DENH_SWITCH
op_assign
l_int|1
comma
DECL|enumerator|USB_PROC_3DENH_SPACE
id|USB_PROC_3DENH_SPACE
op_assign
l_int|2
comma
DECL|enumerator|USB_PROC_REVERB
id|USB_PROC_REVERB
op_assign
l_int|4
comma
DECL|enumerator|USB_PROC_REVERB_SWITCH
id|USB_PROC_REVERB_SWITCH
op_assign
l_int|1
comma
DECL|enumerator|USB_PROC_REVERB_LEVEL
id|USB_PROC_REVERB_LEVEL
op_assign
l_int|2
comma
DECL|enumerator|USB_PROC_REVERB_TIME
id|USB_PROC_REVERB_TIME
op_assign
l_int|3
comma
DECL|enumerator|USB_PROC_REVERB_DELAY
id|USB_PROC_REVERB_DELAY
op_assign
l_int|4
comma
DECL|enumerator|USB_PROC_CHORUS
id|USB_PROC_CHORUS
op_assign
l_int|5
comma
DECL|enumerator|USB_PROC_CHORUS_SWITCH
id|USB_PROC_CHORUS_SWITCH
op_assign
l_int|1
comma
DECL|enumerator|USB_PROC_CHORUS_LEVEL
id|USB_PROC_CHORUS_LEVEL
op_assign
l_int|2
comma
DECL|enumerator|USB_PROC_CHORUS_RATE
id|USB_PROC_CHORUS_RATE
op_assign
l_int|3
comma
DECL|enumerator|USB_PROC_CHORUS_DEPTH
id|USB_PROC_CHORUS_DEPTH
op_assign
l_int|4
comma
DECL|enumerator|USB_PROC_DCR
id|USB_PROC_DCR
op_assign
l_int|6
comma
DECL|enumerator|USB_PROC_DCR_SWITCH
id|USB_PROC_DCR_SWITCH
op_assign
l_int|1
comma
DECL|enumerator|USB_PROC_DCR_RATIO
id|USB_PROC_DCR_RATIO
op_assign
l_int|2
comma
DECL|enumerator|USB_PROC_DCR_MAX_AMP
id|USB_PROC_DCR_MAX_AMP
op_assign
l_int|3
comma
DECL|enumerator|USB_PROC_DCR_THRESHOLD
id|USB_PROC_DCR_THRESHOLD
op_assign
l_int|4
comma
DECL|enumerator|USB_PROC_DCR_ATTACK
id|USB_PROC_DCR_ATTACK
op_assign
l_int|5
comma
DECL|enumerator|USB_PROC_DCR_RELEASE
id|USB_PROC_DCR_RELEASE
op_assign
l_int|6
comma
)brace
suffix:semicolon
DECL|macro|MAX_CHANNELS
mdefine_line|#define MAX_CHANNELS&t;10&t;/* max logical channels */
multiline_comment|/*&n; * manual mapping of mixer names&n; * if the mixer topology is too complicated and the parsed names are&n; * ambiguous, add the entries in usbmixer_maps.c.&n; */
macro_line|#include &quot;usbmixer_maps.c&quot;
multiline_comment|/* get the mapped name if the unit matches */
DECL|function|check_mapped_name
r_static
r_int
id|check_mapped_name
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
comma
r_int
id|control
comma
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_const
r_struct
id|usbmix_name_map
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state-&gt;map
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|state-&gt;map
suffix:semicolon
id|p-&gt;id
suffix:semicolon
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;id
op_eq
id|unitid
op_logical_and
(paren
op_logical_neg
id|control
op_logical_or
op_logical_neg
id|p-&gt;control
op_logical_or
id|control
op_eq
id|p-&gt;control
)paren
)paren
(brace
id|buflen
op_decrement
suffix:semicolon
r_return
id|strlcpy
c_func
(paren
id|buf
comma
id|p-&gt;name
comma
id|buflen
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * find an audio control unit with the given unit id&n; */
DECL|function|find_audio_control_unit
r_static
r_void
op_star
id|find_audio_control_unit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
r_char
id|unit
)paren
(brace
r_int
r_char
op_star
id|p
suffix:semicolon
id|p
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|snd_usb_find_desc
c_func
(paren
id|state-&gt;buffer
comma
id|state-&gt;buflen
comma
id|p
comma
id|USB_DT_CS_INTERFACE
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|p
(braket
l_int|0
)braket
op_ge
l_int|4
op_logical_and
id|p
(braket
l_int|2
)braket
op_ge
id|INPUT_TERMINAL
op_logical_and
id|p
(braket
l_int|2
)braket
op_le
id|EXTENSION_UNIT
op_logical_and
id|p
(braket
l_int|3
)braket
op_eq
id|unit
)paren
r_return
id|p
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * copy a string with the given id&n; */
DECL|function|snd_usb_copy_string_desc
r_static
r_int
id|snd_usb_copy_string_desc
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|index
comma
r_char
op_star
id|buf
comma
r_int
id|maxlen
)paren
(brace
r_int
id|len
op_assign
id|usb_string
c_func
(paren
id|state-&gt;chip-&gt;dev
comma
id|index
comma
id|buf
comma
id|maxlen
op_minus
l_int|1
)paren
suffix:semicolon
id|buf
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * convert from the byte/word on usb descriptor to the zero-based integer&n; */
DECL|function|convert_signed_value
r_static
r_int
id|convert_signed_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|val
)paren
(brace
r_switch
c_cond
(paren
id|cval-&gt;val_type
)paren
(brace
r_case
id|USB_MIXER_BOOLEAN
suffix:colon
r_return
op_logical_neg
op_logical_neg
id|val
suffix:semicolon
r_case
id|USB_MIXER_INV_BOOLEAN
suffix:colon
r_return
op_logical_neg
id|val
suffix:semicolon
r_case
id|USB_MIXER_U8
suffix:colon
id|val
op_and_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_MIXER_S8
suffix:colon
id|val
op_and_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|0x80
)paren
id|val
op_sub_assign
l_int|0x100
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_MIXER_U16
suffix:colon
id|val
op_and_assign
l_int|0xffff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_MIXER_S16
suffix:colon
id|val
op_and_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|0x8000
)paren
id|val
op_sub_assign
l_int|0x10000
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*&n; * convert from the zero-based int to the byte/word for usb descriptor&n; */
DECL|function|convert_bytes_value
r_static
r_int
id|convert_bytes_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|val
)paren
(brace
r_switch
c_cond
(paren
id|cval-&gt;val_type
)paren
(brace
r_case
id|USB_MIXER_BOOLEAN
suffix:colon
r_return
op_logical_neg
op_logical_neg
id|val
suffix:semicolon
r_case
id|USB_MIXER_INV_BOOLEAN
suffix:colon
r_return
op_logical_neg
id|val
suffix:semicolon
r_case
id|USB_MIXER_S8
suffix:colon
r_case
id|USB_MIXER_U8
suffix:colon
r_return
id|val
op_amp
l_int|0xff
suffix:semicolon
r_case
id|USB_MIXER_S16
suffix:colon
r_case
id|USB_MIXER_U16
suffix:colon
r_return
id|val
op_amp
l_int|0xffff
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* not reached */
)brace
DECL|function|get_relative_value
r_static
r_int
id|get_relative_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cval-&gt;res
)paren
id|cval-&gt;res
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
id|cval-&gt;min
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
OG
id|cval-&gt;max
)paren
r_return
(paren
id|cval-&gt;max
op_minus
id|cval-&gt;min
)paren
op_div
id|cval-&gt;res
suffix:semicolon
r_else
r_return
(paren
id|val
op_minus
id|cval-&gt;min
)paren
op_div
id|cval-&gt;res
suffix:semicolon
)brace
DECL|function|get_abs_value
r_static
r_int
id|get_abs_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|val
)paren
(brace
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
r_return
id|cval-&gt;min
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cval-&gt;res
)paren
id|cval-&gt;res
op_assign
l_int|1
suffix:semicolon
id|val
op_mul_assign
id|cval-&gt;res
suffix:semicolon
id|val
op_add_assign
id|cval-&gt;min
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
id|cval-&gt;max
)paren
r_return
id|cval-&gt;max
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*&n; * retrieve a mixer value&n; */
DECL|function|get_ctl_value
r_static
r_int
id|get_ctl_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|request
comma
r_int
id|validx
comma
r_int
op_star
id|value_ret
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|val_len
op_assign
id|cval-&gt;val_type
op_ge
id|USB_MIXER_S16
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
r_int
id|timeout
op_assign
l_int|10
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|cval-&gt;chip-&gt;dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|cval-&gt;chip-&gt;dev
comma
l_int|0
)paren
comma
id|request
comma
id|USB_RECIP_INTERFACE
op_or
id|USB_TYPE_CLASS
op_or
id|USB_DIR_IN
comma
id|validx
comma
id|cval-&gt;ctrlif
op_or
(paren
id|cval-&gt;id
op_lshift
l_int|8
)paren
comma
id|buf
comma
id|val_len
comma
id|HZ
op_div
l_int|10
)paren
op_ge
l_int|0
)paren
(brace
op_star
id|value_ret
op_assign
id|convert_signed_value
c_func
(paren
id|cval
comma
id|snd_usb_combine_bytes
c_func
(paren
id|buf
comma
id|val_len
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|snd_printdd
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot get ctl value: req = 0x%x, wValue = 0x%x, wIndex = 0x%x, type = %d&bslash;n&quot;
comma
id|request
comma
id|validx
comma
id|cval-&gt;ctrlif
op_or
(paren
id|cval-&gt;id
op_lshift
l_int|8
)paren
comma
id|cval-&gt;val_type
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|get_cur_ctl_value
r_static
r_int
id|get_cur_ctl_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|validx
comma
r_int
op_star
id|value
)paren
(brace
r_return
id|get_ctl_value
c_func
(paren
id|cval
comma
id|GET_CUR
comma
id|validx
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* channel = 0: master, 1 = first channel */
DECL|function|get_cur_mix_value
r_inline
r_static
r_int
id|get_cur_mix_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|channel
comma
r_int
op_star
id|value
)paren
(brace
r_return
id|get_ctl_value
c_func
(paren
id|cval
comma
id|GET_CUR
comma
(paren
id|cval-&gt;control
op_lshift
l_int|8
)paren
op_or
id|channel
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * set a mixer value&n; */
DECL|function|set_ctl_value
r_static
r_int
id|set_ctl_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|request
comma
r_int
id|validx
comma
r_int
id|value_set
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|val_len
op_assign
id|cval-&gt;val_type
op_ge
id|USB_MIXER_S16
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
r_int
id|timeout
op_assign
l_int|10
suffix:semicolon
id|value_set
op_assign
id|convert_bytes_value
c_func
(paren
id|cval
comma
id|value_set
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|value_set
op_amp
l_int|0xff
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
(paren
id|value_set
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_decrement
OG
l_int|0
)paren
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|cval-&gt;chip-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|cval-&gt;chip-&gt;dev
comma
l_int|0
)paren
comma
id|request
comma
id|USB_RECIP_INTERFACE
op_or
id|USB_TYPE_CLASS
op_or
id|USB_DIR_OUT
comma
id|validx
comma
id|cval-&gt;ctrlif
op_or
(paren
id|cval-&gt;id
op_lshift
l_int|8
)paren
comma
id|buf
comma
id|val_len
comma
id|HZ
op_div
l_int|10
)paren
op_ge
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|snd_printdd
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot set ctl value: req = 0x%x, wValue = 0x%x, wIndex = 0x%x, type = %d, data = 0x%x/0x%x&bslash;n&quot;
comma
id|request
comma
id|validx
comma
id|cval-&gt;ctrlif
op_or
(paren
id|cval-&gt;id
op_lshift
l_int|8
)paren
comma
id|cval-&gt;val_type
comma
id|buf
(braket
l_int|0
)braket
comma
id|buf
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|set_cur_ctl_value
r_static
r_int
id|set_cur_ctl_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|validx
comma
r_int
id|value
)paren
(brace
r_return
id|set_ctl_value
c_func
(paren
id|cval
comma
id|SET_CUR
comma
id|validx
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|set_cur_mix_value
r_inline
r_static
r_int
id|set_cur_mix_value
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|channel
comma
r_int
id|value
)paren
(brace
r_return
id|set_ctl_value
c_func
(paren
id|cval
comma
id|SET_CUR
comma
(paren
id|cval-&gt;control
op_lshift
l_int|8
)paren
op_or
id|channel
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * parser routines begin here... &n; */
r_static
r_int
id|parse_audio_unit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
)paren
suffix:semicolon
multiline_comment|/*&n; * check if the input/output channel routing is enabled on the given bitmap.&n; * used for mixer unit parser&n; */
DECL|function|check_matrix_bitmap
r_static
r_int
id|check_matrix_bitmap
c_func
(paren
r_int
r_char
op_star
id|bmap
comma
r_int
id|ich
comma
r_int
id|och
comma
r_int
id|num_outs
)paren
(brace
r_int
id|idx
op_assign
id|ich
op_star
id|num_outs
op_plus
id|och
suffix:semicolon
r_return
id|bmap
(braket
op_minus
(paren
id|idx
op_rshift
l_int|3
)paren
)braket
op_amp
(paren
l_int|0x80
op_rshift
(paren
id|idx
op_amp
l_int|7
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * add an alsa control element&n; * search and increment the index until an empty slot is found.&n; *&n; * if failed, give up and free the control instance.&n; */
DECL|function|add_control_to_empty
r_static
r_int
id|add_control_to_empty
c_func
(paren
id|snd_card_t
op_star
id|card
comma
id|snd_kcontrol_t
op_star
id|kctl
)paren
(brace
r_int
id|err
suffix:semicolon
r_while
c_loop
(paren
id|snd_ctl_find_id
c_func
(paren
id|card
comma
op_amp
id|kctl-&gt;id
)paren
)paren
id|kctl-&gt;id.index
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|card
comma
id|kctl
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot add control (err = %d)&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|snd_ctl_free_one
c_func
(paren
id|kctl
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * get a terminal name string&n; */
DECL|struct|iterm_name_combo
r_static
r_struct
id|iterm_name_combo
(brace
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|variable|iterm_names
)brace
id|iterm_names
(braket
)braket
op_assign
(brace
(brace
l_int|0x0300
comma
l_string|&quot;Output&quot;
)brace
comma
(brace
l_int|0x0301
comma
l_string|&quot;Speaker&quot;
)brace
comma
(brace
l_int|0x0302
comma
l_string|&quot;Headphone&quot;
)brace
comma
(brace
l_int|0x0303
comma
l_string|&quot;HMD Audio&quot;
)brace
comma
(brace
l_int|0x0304
comma
l_string|&quot;Desktop Speaker&quot;
)brace
comma
(brace
l_int|0x0305
comma
l_string|&quot;Room Speaker&quot;
)brace
comma
(brace
l_int|0x0306
comma
l_string|&quot;Com Speaker&quot;
)brace
comma
(brace
l_int|0x0307
comma
l_string|&quot;LFE&quot;
)brace
comma
(brace
l_int|0x0600
comma
l_string|&quot;External In&quot;
)brace
comma
(brace
l_int|0x0601
comma
l_string|&quot;Analog In&quot;
)brace
comma
(brace
l_int|0x0602
comma
l_string|&quot;Digital In&quot;
)brace
comma
(brace
l_int|0x0603
comma
l_string|&quot;Line&quot;
)brace
comma
(brace
l_int|0x0604
comma
l_string|&quot;Legacy In&quot;
)brace
comma
(brace
l_int|0x0605
comma
l_string|&quot;IEC958 In&quot;
)brace
comma
(brace
l_int|0x0606
comma
l_string|&quot;1394 DA Stream&quot;
)brace
comma
(brace
l_int|0x0607
comma
l_string|&quot;1394 DV Stream&quot;
)brace
comma
(brace
l_int|0x0700
comma
l_string|&quot;Embedded&quot;
)brace
comma
(brace
l_int|0x0701
comma
l_string|&quot;Noise Source&quot;
)brace
comma
(brace
l_int|0x0702
comma
l_string|&quot;Equalization Noise&quot;
)brace
comma
(brace
l_int|0x0703
comma
l_string|&quot;CD&quot;
)brace
comma
(brace
l_int|0x0704
comma
l_string|&quot;DAT&quot;
)brace
comma
(brace
l_int|0x0705
comma
l_string|&quot;DCC&quot;
)brace
comma
(brace
l_int|0x0706
comma
l_string|&quot;MiniDisk&quot;
)brace
comma
(brace
l_int|0x0707
comma
l_string|&quot;Analog Tape&quot;
)brace
comma
(brace
l_int|0x0708
comma
l_string|&quot;Phonograph&quot;
)brace
comma
(brace
l_int|0x0709
comma
l_string|&quot;VCR Audio&quot;
)brace
comma
(brace
l_int|0x070a
comma
l_string|&quot;Video Disk Audio&quot;
)brace
comma
(brace
l_int|0x070b
comma
l_string|&quot;DVD Audio&quot;
)brace
comma
(brace
l_int|0x070c
comma
l_string|&quot;TV Tuner Audio&quot;
)brace
comma
(brace
l_int|0x070d
comma
l_string|&quot;Satellite Rec Audio&quot;
)brace
comma
(brace
l_int|0x070e
comma
l_string|&quot;Cable Tuner Audio&quot;
)brace
comma
(brace
l_int|0x070f
comma
l_string|&quot;DSS Audio&quot;
)brace
comma
(brace
l_int|0x0710
comma
l_string|&quot;Radio Receiver&quot;
)brace
comma
(brace
l_int|0x0711
comma
l_string|&quot;Radio Transmitter&quot;
)brace
comma
(brace
l_int|0x0712
comma
l_string|&quot;Multi-Track Recorder&quot;
)brace
comma
(brace
l_int|0x0713
comma
l_string|&quot;Synthesizer&quot;
)brace
comma
(brace
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|function|get_term_name
r_static
r_int
id|get_term_name
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
id|usb_audio_term_t
op_star
id|iterm
comma
r_int
r_char
op_star
id|name
comma
r_int
id|maxlen
comma
r_int
id|term_only
)paren
(brace
r_struct
id|iterm_name_combo
op_star
id|names
suffix:semicolon
r_if
c_cond
(paren
id|iterm-&gt;name
)paren
r_return
id|snd_usb_copy_string_desc
c_func
(paren
id|state
comma
id|iterm-&gt;name
comma
id|name
comma
id|maxlen
)paren
suffix:semicolon
multiline_comment|/* virtual type - not a real terminal */
r_if
c_cond
(paren
id|iterm-&gt;type
op_rshift
l_int|16
)paren
(brace
r_if
c_cond
(paren
id|term_only
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|iterm-&gt;type
op_rshift
l_int|16
)paren
(brace
r_case
id|SELECTOR_UNIT
suffix:colon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;Selector&quot;
)paren
suffix:semicolon
r_return
l_int|8
suffix:semicolon
r_case
id|PROCESSING_UNIT
suffix:colon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;Process Unit&quot;
)paren
suffix:semicolon
r_return
l_int|12
suffix:semicolon
r_case
id|EXTENSION_UNIT
suffix:colon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;Ext Unit&quot;
)paren
suffix:semicolon
r_return
l_int|8
suffix:semicolon
r_case
id|MIXER_UNIT
suffix:colon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;Mixer&quot;
)paren
suffix:semicolon
r_return
l_int|5
suffix:semicolon
r_default
suffix:colon
r_return
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;Unit %d&quot;
comma
id|iterm-&gt;id
)paren
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|iterm-&gt;type
op_amp
l_int|0xff00
)paren
(brace
r_case
l_int|0x0100
suffix:colon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;PCM&quot;
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
r_case
l_int|0x0200
suffix:colon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;Mic&quot;
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
r_case
l_int|0x0400
suffix:colon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;Headset&quot;
)paren
suffix:semicolon
r_return
l_int|7
suffix:semicolon
r_case
l_int|0x0500
suffix:colon
id|strcpy
c_func
(paren
id|name
comma
l_string|&quot;Phone&quot;
)paren
suffix:semicolon
r_return
l_int|5
suffix:semicolon
)brace
r_for
c_loop
(paren
id|names
op_assign
id|iterm_names
suffix:semicolon
id|names-&gt;type
suffix:semicolon
id|names
op_increment
)paren
r_if
c_cond
(paren
id|names-&gt;type
op_eq
id|iterm-&gt;type
)paren
(brace
id|strcpy
c_func
(paren
id|name
comma
id|names-&gt;name
)paren
suffix:semicolon
r_return
id|strlen
c_func
(paren
id|names-&gt;name
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * parse the source unit recursively until it reaches to a terminal&n; * or a branched unit.&n; */
DECL|function|check_input_term
r_static
r_int
id|check_input_term
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|id
comma
id|usb_audio_term_t
op_star
id|term
)paren
(brace
r_int
r_char
op_star
id|p1
suffix:semicolon
id|memset
c_func
(paren
id|term
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|term
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p1
op_assign
id|find_audio_control_unit
c_func
(paren
id|state
comma
id|id
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|term-&gt;id
op_assign
id|id
suffix:semicolon
r_switch
c_cond
(paren
id|p1
(braket
l_int|2
)braket
)paren
(brace
r_case
id|INPUT_TERMINAL
suffix:colon
id|term-&gt;type
op_assign
id|combine_word
c_func
(paren
id|p1
op_plus
l_int|4
)paren
suffix:semicolon
id|term-&gt;channels
op_assign
id|p1
(braket
l_int|7
)braket
suffix:semicolon
id|term-&gt;chconfig
op_assign
id|combine_word
c_func
(paren
id|p1
op_plus
l_int|8
)paren
suffix:semicolon
id|term-&gt;name
op_assign
id|p1
(braket
l_int|11
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|FEATURE_UNIT
suffix:colon
id|id
op_assign
id|p1
(braket
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* continue to parse */
r_case
id|MIXER_UNIT
suffix:colon
id|term-&gt;type
op_assign
id|p1
(braket
l_int|2
)braket
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* virtual type */
id|term-&gt;channels
op_assign
id|p1
(braket
l_int|5
op_plus
id|p1
(braket
l_int|4
)braket
)braket
suffix:semicolon
id|term-&gt;chconfig
op_assign
id|combine_word
c_func
(paren
id|p1
op_plus
l_int|6
op_plus
id|p1
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|term-&gt;name
op_assign
id|p1
(braket
id|p1
(braket
l_int|0
)braket
op_minus
l_int|1
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SELECTOR_UNIT
suffix:colon
multiline_comment|/* call recursively to retrieve the channel info */
r_if
c_cond
(paren
id|check_input_term
c_func
(paren
id|state
comma
id|p1
(braket
l_int|5
)braket
comma
id|term
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|term-&gt;type
op_assign
id|p1
(braket
l_int|2
)braket
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* virtual type */
id|term-&gt;id
op_assign
id|id
suffix:semicolon
id|term-&gt;name
op_assign
id|p1
(braket
l_int|9
op_plus
id|p1
(braket
l_int|0
)braket
op_minus
l_int|1
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|PROCESSING_UNIT
suffix:colon
r_case
id|EXTENSION_UNIT
suffix:colon
r_if
c_cond
(paren
id|p1
(braket
l_int|6
)braket
op_eq
l_int|1
)paren
(brace
id|id
op_assign
id|p1
(braket
l_int|7
)braket
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* continue to parse */
)brace
id|term-&gt;type
op_assign
id|p1
(braket
l_int|2
)braket
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* virtual type */
id|term-&gt;channels
op_assign
id|p1
(braket
l_int|7
op_plus
id|p1
(braket
l_int|6
)braket
)braket
suffix:semicolon
id|term-&gt;chconfig
op_assign
id|combine_word
c_func
(paren
id|p1
op_plus
l_int|8
op_plus
id|p1
(braket
l_int|6
)braket
)paren
suffix:semicolon
id|term-&gt;name
op_assign
id|p1
(braket
l_int|12
op_plus
id|p1
(braket
l_int|6
)braket
op_plus
id|p1
(braket
l_int|11
op_plus
id|p1
(braket
l_int|6
)braket
)braket
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * Feature Unit&n; */
multiline_comment|/* feature unit control information */
DECL|struct|usb_feature_control_info
r_struct
id|usb_feature_control_info
(brace
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|type
r_int
r_int
id|type
suffix:semicolon
multiline_comment|/* control type (mute, volume, etc.) */
)brace
suffix:semicolon
DECL|variable|audio_feature_info
r_static
r_struct
id|usb_feature_control_info
id|audio_feature_info
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Mute&quot;
comma
id|USB_MIXER_INV_BOOLEAN
)brace
comma
(brace
l_string|&quot;Volume&quot;
comma
id|USB_MIXER_S16
)brace
comma
(brace
l_string|&quot;Tone Control - Bass&quot;
comma
id|USB_MIXER_S8
)brace
comma
(brace
l_string|&quot;Tone Control - Mid&quot;
comma
id|USB_MIXER_S8
)brace
comma
(brace
l_string|&quot;Tone Control - Treble&quot;
comma
id|USB_MIXER_S8
)brace
comma
(brace
l_string|&quot;Graphic Equalizer&quot;
comma
id|USB_MIXER_S8
)brace
comma
multiline_comment|/* FIXME: not implemeted yet */
(brace
l_string|&quot;Auto Gain Control&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
l_string|&quot;Delay Control&quot;
comma
id|USB_MIXER_U16
)brace
comma
(brace
l_string|&quot;Bass Boost&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
l_string|&quot;Loudness&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* private_free callback */
DECL|function|usb_mixer_elem_free
r_static
r_void
id|usb_mixer_elem_free
c_func
(paren
id|snd_kcontrol_t
op_star
id|kctl
)paren
(brace
r_if
c_cond
(paren
id|kctl-&gt;private_data
)paren
(brace
id|snd_magic_kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|kctl-&gt;private_data
)paren
suffix:semicolon
id|kctl-&gt;private_data
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * interface to ALSA control for feature/mixer units&n; */
multiline_comment|/*&n; * retrieve the minimum and maximum values for the specified control&n; */
DECL|function|get_min_max
r_static
r_int
id|get_min_max
c_func
(paren
id|usb_mixer_elem_info_t
op_star
id|cval
comma
r_int
id|default_min
)paren
(brace
multiline_comment|/* for failsafe */
id|cval-&gt;min
op_assign
id|default_min
suffix:semicolon
id|cval-&gt;max
op_assign
id|cval-&gt;min
op_plus
l_int|1
suffix:semicolon
id|cval-&gt;res
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|cval-&gt;val_type
op_eq
id|USB_MIXER_BOOLEAN
op_logical_or
id|cval-&gt;val_type
op_eq
id|USB_MIXER_INV_BOOLEAN
)paren
(brace
id|cval-&gt;initialized
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_int
id|minchn
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cval-&gt;cmask
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|cval-&gt;cmask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|minchn
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|get_ctl_value
c_func
(paren
id|cval
comma
id|GET_MAX
comma
(paren
id|cval-&gt;control
op_lshift
l_int|8
)paren
op_or
id|minchn
comma
op_amp
id|cval-&gt;max
)paren
OL
l_int|0
op_logical_or
id|get_ctl_value
c_func
(paren
id|cval
comma
id|GET_MIN
comma
(paren
id|cval-&gt;control
op_lshift
l_int|8
)paren
op_or
id|minchn
comma
op_amp
id|cval-&gt;min
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_ERR
l_string|&quot;%d:%d: cannot get min/max values for control %d (id %d)&bslash;n&quot;
comma
id|cval-&gt;id
comma
id|cval-&gt;ctrlif
comma
id|cval-&gt;control
comma
id|cval-&gt;id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_ctl_value
c_func
(paren
id|cval
comma
id|GET_RES
comma
(paren
id|cval-&gt;control
op_lshift
l_int|8
)paren
op_or
id|minchn
comma
op_amp
id|cval-&gt;res
)paren
OL
l_int|0
)paren
(brace
id|cval-&gt;res
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_int
id|last_valid_res
op_assign
id|cval-&gt;res
suffix:semicolon
r_while
c_loop
(paren
id|cval-&gt;res
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|set_ctl_value
c_func
(paren
id|cval
comma
id|SET_RES
comma
(paren
id|cval-&gt;control
op_lshift
l_int|8
)paren
op_or
id|minchn
comma
id|cval-&gt;res
op_div
l_int|2
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
id|cval-&gt;res
op_div_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|get_ctl_value
c_func
(paren
id|cval
comma
id|GET_RES
comma
(paren
id|cval-&gt;control
op_lshift
l_int|8
)paren
op_or
id|minchn
comma
op_amp
id|cval-&gt;res
)paren
OL
l_int|0
)paren
id|cval-&gt;res
op_assign
id|last_valid_res
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cval-&gt;res
op_eq
l_int|0
)paren
id|cval-&gt;res
op_assign
l_int|1
suffix:semicolon
id|cval-&gt;initialized
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get a feature/mixer unit info */
DECL|function|mixer_ctl_feature_info
r_static
r_int
id|mixer_ctl_feature_info
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kcontrol-&gt;private_data
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cval-&gt;val_type
op_eq
id|USB_MIXER_BOOLEAN
op_logical_or
id|cval-&gt;val_type
op_eq
id|USB_MIXER_INV_BOOLEAN
)paren
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_BOOLEAN
suffix:semicolon
r_else
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_INTEGER
suffix:semicolon
id|uinfo-&gt;count
op_assign
id|cval-&gt;channels
suffix:semicolon
r_if
c_cond
(paren
id|cval-&gt;val_type
op_eq
id|USB_MIXER_BOOLEAN
op_logical_or
id|cval-&gt;val_type
op_eq
id|USB_MIXER_INV_BOOLEAN
)paren
(brace
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|cval-&gt;initialized
)paren
id|get_min_max
c_func
(paren
id|cval
comma
l_int|0
)paren
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
(paren
id|cval-&gt;max
op_minus
id|cval-&gt;min
)paren
op_div
id|cval-&gt;res
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get the current value from feature/mixer unit */
DECL|function|mixer_ctl_feature_get
r_static
r_int
id|mixer_ctl_feature_get
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kcontrol-&gt;private_data
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_int
id|c
comma
id|cnt
comma
id|val
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|cval-&gt;cmask
)paren
(brace
id|cnt
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|MAX_CHANNELS
suffix:semicolon
id|c
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cval-&gt;cmask
op_amp
(paren
l_int|1
op_lshift
id|c
)paren
)paren
(brace
id|err
op_assign
id|get_cur_mix_value
c_func
(paren
id|cval
comma
id|c
op_plus
l_int|1
comma
op_amp
id|val
)paren
suffix:semicolon
macro_line|#ifdef IGNORE_CTL_ERROR
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|cval-&gt;min
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot get current value for control %d ch %d: err = %d&bslash;n&quot;
comma
id|cval-&gt;control
comma
id|c
op_plus
l_int|1
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|val
op_assign
id|get_relative_value
c_func
(paren
id|cval
comma
id|val
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
id|cnt
)braket
op_assign
id|val
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* master channel */
id|err
op_assign
id|get_cur_mix_value
c_func
(paren
id|cval
comma
l_int|0
comma
op_amp
id|val
)paren
suffix:semicolon
macro_line|#ifdef IGNORE_CTL_ERROR
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|cval-&gt;min
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot get current value for control %d master ch: err = %d&bslash;n&quot;
comma
id|cval-&gt;control
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|val
op_assign
id|get_relative_value
c_func
(paren
id|cval
comma
id|val
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* put the current value to feature/mixer unit */
DECL|function|mixer_ctl_feature_put
r_static
r_int
id|mixer_ctl_feature_put
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kcontrol-&gt;private_data
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_int
id|c
comma
id|cnt
comma
id|val
comma
id|oval
comma
id|err
suffix:semicolon
r_int
id|changed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cval-&gt;cmask
)paren
(brace
id|cnt
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|MAX_CHANNELS
suffix:semicolon
id|c
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cval-&gt;cmask
op_amp
(paren
l_int|1
op_lshift
id|c
)paren
)paren
(brace
id|err
op_assign
id|get_cur_mix_value
c_func
(paren
id|cval
comma
id|c
op_plus
l_int|1
comma
op_amp
id|oval
)paren
suffix:semicolon
macro_line|#ifdef IGNORE_CTL_ERROR
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|val
op_assign
id|ucontrol-&gt;value.integer.value
(braket
id|cnt
)braket
suffix:semicolon
id|val
op_assign
id|get_abs_value
c_func
(paren
id|cval
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oval
op_ne
id|val
)paren
(brace
id|set_cur_mix_value
c_func
(paren
id|cval
comma
id|c
op_plus
l_int|1
comma
id|val
)paren
suffix:semicolon
id|changed
op_assign
l_int|1
suffix:semicolon
)brace
id|get_cur_mix_value
c_func
(paren
id|cval
comma
id|c
op_plus
l_int|1
comma
op_amp
id|val
)paren
suffix:semicolon
id|cnt
op_increment
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* master channel */
id|err
op_assign
id|get_cur_mix_value
c_func
(paren
id|cval
comma
l_int|0
comma
op_amp
id|oval
)paren
suffix:semicolon
macro_line|#ifdef IGNORE_CTL_ERROR
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|val
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|val
op_assign
id|get_abs_value
c_func
(paren
id|cval
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|oval
)paren
(brace
id|set_cur_mix_value
c_func
(paren
id|cval
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|changed
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|changed
suffix:semicolon
)brace
DECL|variable|usb_feature_unit_ctl
r_static
id|snd_kcontrol_new_t
id|usb_feature_unit_ctl
op_assign
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;&quot;
comma
multiline_comment|/* will be filled later manually */
dot
id|info
op_assign
id|mixer_ctl_feature_info
comma
dot
id|get
op_assign
id|mixer_ctl_feature_get
comma
dot
id|put
op_assign
id|mixer_ctl_feature_put
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * build a feature control&n; */
DECL|function|build_feature_ctl
r_static
r_void
id|build_feature_ctl
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
r_char
op_star
id|desc
comma
r_int
r_int
id|ctl_mask
comma
r_int
id|control
comma
id|usb_audio_term_t
op_star
id|iterm
comma
r_int
id|unitid
)paren
(brace
r_int
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|mapped_name
op_assign
l_int|0
suffix:semicolon
r_int
id|nameid
op_assign
id|desc
(braket
id|desc
(braket
l_int|0
)braket
op_minus
l_int|1
)braket
suffix:semicolon
id|snd_kcontrol_t
op_star
id|kctl
suffix:semicolon
id|usb_mixer_elem_info_t
op_star
id|cval
suffix:semicolon
id|control
op_increment
suffix:semicolon
multiline_comment|/* change from zero-based to 1-based value */
r_if
c_cond
(paren
id|control
op_eq
id|USB_FEATURE_GEQ
)paren
(brace
multiline_comment|/* FIXME: not supported yet */
r_return
suffix:semicolon
)brace
id|cval
op_assign
id|snd_magic_kcalloc
c_func
(paren
id|usb_mixer_elem_info_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cval
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc kcontrol&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cval-&gt;chip
op_assign
id|state-&gt;chip
suffix:semicolon
id|cval-&gt;ctrlif
op_assign
id|state-&gt;ctrlif
suffix:semicolon
id|cval-&gt;id
op_assign
id|unitid
suffix:semicolon
id|cval-&gt;control
op_assign
id|control
suffix:semicolon
id|cval-&gt;cmask
op_assign
id|ctl_mask
suffix:semicolon
id|cval-&gt;val_type
op_assign
id|audio_feature_info
(braket
id|control
op_minus
l_int|1
)braket
dot
id|type
suffix:semicolon
r_if
c_cond
(paren
id|ctl_mask
op_eq
l_int|0
)paren
id|cval-&gt;channels
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* master channel */
r_else
(brace
r_int
id|i
comma
id|c
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ctl_mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|c
op_increment
suffix:semicolon
id|cval-&gt;channels
op_assign
id|c
suffix:semicolon
)brace
multiline_comment|/* get min/max values */
id|get_min_max
c_func
(paren
id|cval
comma
l_int|0
)paren
suffix:semicolon
id|kctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|usb_feature_unit_ctl
comma
id|cval
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kctl
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc kcontrol&bslash;n&quot;
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|cval
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|kctl-&gt;private_free
op_assign
id|usb_mixer_elem_free
suffix:semicolon
id|len
op_assign
id|check_mapped_name
c_func
(paren
id|state
comma
id|unitid
comma
id|control
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
id|mapped_name
op_assign
id|len
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
op_logical_and
id|nameid
)paren
id|len
op_assign
id|snd_usb_copy_string_desc
c_func
(paren
id|state
comma
id|nameid
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|control
)paren
(brace
r_case
id|USB_FEATURE_MUTE
suffix:colon
r_case
id|USB_FEATURE_VOLUME
suffix:colon
multiline_comment|/* determine the control name.  the rule is:&n;&t;&t; * - if a name id is given in descriptor, use it.&n;&t;&t; * - if the connected input can be determined, then use the name&n;&t;&t; *   of terminal type.&n;&t;&t; * - if the connected output can be determined, use it.&n;&t;&t; * - otherwise, anonymous name.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
id|len
op_assign
id|get_term_name
c_func
(paren
id|state
comma
id|iterm
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|get_term_name
c_func
(paren
id|state
comma
op_amp
id|state-&gt;oterm
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|snprintf
c_func
(paren
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
comma
l_string|&quot;Feature %d&quot;
comma
id|unitid
)paren
suffix:semicolon
)brace
multiline_comment|/* determine the stream direction:&n;&t;&t; * if the connected output is USB stream, then it&squot;s likely a&n;&t;&t; * capture stream.  otherwise it should be playback (hopefully :)&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|mapped_name
op_logical_and
op_logical_neg
(paren
id|state-&gt;oterm.type
op_rshift
l_int|16
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|state-&gt;oterm.type
op_amp
l_int|0xff00
)paren
op_eq
l_int|0x0100
)paren
(brace
id|len
op_assign
id|strlcat
c_func
(paren
id|kctl-&gt;id.name
comma
l_string|&quot; Capture&quot;
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
id|strlcat
c_func
(paren
id|kctl-&gt;id.name
op_plus
id|len
comma
l_string|&quot; Playback&quot;
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
)brace
)brace
id|strlcat
c_func
(paren
id|kctl-&gt;id.name
op_plus
id|len
comma
id|control
op_eq
id|USB_FEATURE_MUTE
ques
c_cond
l_string|&quot; Switch&quot;
suffix:colon
l_string|&quot; Volume&quot;
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|strlcpy
c_func
(paren
id|kctl-&gt;id.name
comma
id|audio_feature_info
(braket
id|control
op_minus
l_int|1
)braket
dot
id|name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* quirk for UDA1321/N101 */
multiline_comment|/* note that detection between firmware 2.1.1.7 (N101) and later 2.1.1.21 */
multiline_comment|/* is not very clear from datasheets */
multiline_comment|/* I hope that the min value is -15360 for newer firmware --jk */
r_if
c_cond
(paren
(paren
(paren
id|state-&gt;vendor
op_eq
l_int|0x471
op_logical_and
(paren
id|state-&gt;product
op_eq
l_int|0x104
op_logical_or
id|state-&gt;product
op_eq
l_int|0x105
op_logical_or
id|state-&gt;product
op_eq
l_int|0x101
)paren
)paren
op_logical_or
(paren
id|state-&gt;vendor
op_eq
l_int|0x672
op_logical_and
id|state-&gt;product
op_eq
l_int|0x1041
)paren
)paren
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|kctl-&gt;id.name
comma
l_string|&quot;PCM Playback Volume&quot;
)paren
op_logical_and
id|cval-&gt;min
op_eq
op_minus
l_int|15616
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;USB Audio: using volume control quirk for the UDA1321/N101 chip&bslash;n&quot;
)paren
suffix:semicolon
id|cval-&gt;max
op_assign
op_minus
l_int|256
suffix:semicolon
)brace
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;[%d] FU [%s] ch = %d, val = %d/%d/%d&bslash;n&quot;
comma
id|cval-&gt;id
comma
id|kctl-&gt;id.name
comma
id|cval-&gt;channels
comma
id|cval-&gt;min
comma
id|cval-&gt;max
comma
id|cval-&gt;res
)paren
suffix:semicolon
id|add_control_to_empty
c_func
(paren
id|state-&gt;chip-&gt;card
comma
id|kctl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * parse a feature unit&n; *&n; * most of controlls are defined here.&n; */
DECL|function|parse_audio_feature_unit
r_static
r_int
id|parse_audio_feature_unit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
comma
r_int
r_char
op_star
id|ftr
)paren
(brace
r_int
id|channels
comma
id|i
comma
id|j
suffix:semicolon
id|usb_audio_term_t
id|iterm
suffix:semicolon
r_int
r_int
id|master_bits
comma
id|first_ch_bits
suffix:semicolon
r_int
id|err
comma
id|csize
suffix:semicolon
r_if
c_cond
(paren
id|ftr
(braket
l_int|0
)braket
OL
l_int|7
op_logical_or
op_logical_neg
(paren
id|csize
op_assign
id|ftr
(braket
l_int|5
)braket
)paren
op_logical_or
id|ftr
(braket
l_int|0
)braket
OL
l_int|7
op_plus
id|csize
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;usbaudio: unit %u: invalid FEATURE_UNIT descriptor&bslash;n&quot;
comma
id|unitid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* parse the source unit */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|parse_audio_unit
c_func
(paren
id|state
comma
id|ftr
(braket
l_int|4
)braket
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* determine the input source type and name */
r_if
c_cond
(paren
id|check_input_term
c_func
(paren
id|state
comma
id|ftr
(braket
l_int|4
)braket
comma
op_amp
id|iterm
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|channels
op_assign
(paren
id|ftr
(braket
l_int|0
)braket
op_minus
l_int|7
)paren
op_div
id|csize
op_minus
l_int|1
suffix:semicolon
id|master_bits
op_assign
id|snd_usb_combine_bytes
c_func
(paren
id|ftr
op_plus
l_int|6
comma
id|csize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channels
OG
l_int|0
)paren
id|first_ch_bits
op_assign
id|snd_usb_combine_bytes
c_func
(paren
id|ftr
op_plus
l_int|6
op_plus
id|csize
comma
id|csize
)paren
suffix:semicolon
r_else
id|first_ch_bits
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check all control types */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|ch_bits
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|channels
suffix:semicolon
id|j
op_increment
)paren
(brace
r_int
r_int
id|mask
op_assign
id|snd_usb_combine_bytes
c_func
(paren
id|ftr
op_plus
l_int|6
op_plus
id|csize
op_star
(paren
id|j
op_plus
l_int|1
)paren
comma
id|csize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|ch_bits
op_or_assign
(paren
l_int|1
op_lshift
id|j
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch_bits
op_amp
l_int|1
)paren
multiline_comment|/* the first channel must be set (for ease of programming) */
id|build_feature_ctl
c_func
(paren
id|state
comma
id|ftr
comma
id|ch_bits
comma
id|i
comma
op_amp
id|iterm
comma
id|unitid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|master_bits
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|build_feature_ctl
c_func
(paren
id|state
comma
id|ftr
comma
l_int|0
comma
id|i
comma
op_amp
id|iterm
comma
id|unitid
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Mixer Unit&n; */
multiline_comment|/*&n; * build a mixer unit control&n; *&n; * the callbacks are identical with feature unit.&n; * input channel number (zero based) is given in control field instead.&n; */
DECL|function|build_mixer_unit_ctl
r_static
r_void
id|build_mixer_unit_ctl
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
r_char
op_star
id|desc
comma
r_int
id|in_ch
comma
r_int
id|unitid
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
suffix:semicolon
r_int
r_int
id|num_ins
op_assign
id|desc
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|num_outs
op_assign
id|desc
(braket
l_int|5
op_plus
id|num_ins
)braket
suffix:semicolon
r_int
r_int
id|i
comma
id|len
suffix:semicolon
id|snd_kcontrol_t
op_star
id|kctl
suffix:semicolon
id|usb_audio_term_t
id|iterm
suffix:semicolon
id|cval
op_assign
id|snd_magic_kcalloc
c_func
(paren
id|usb_mixer_elem_info_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cval
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|check_input_term
c_func
(paren
id|state
comma
id|desc
(braket
l_int|5
op_plus
id|in_ch
)braket
comma
op_amp
id|iterm
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|cval-&gt;chip
op_assign
id|state-&gt;chip
suffix:semicolon
id|cval-&gt;ctrlif
op_assign
id|state-&gt;ctrlif
suffix:semicolon
id|cval-&gt;id
op_assign
id|unitid
suffix:semicolon
id|cval-&gt;control
op_assign
id|in_ch
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* based on 1 */
id|cval-&gt;val_type
op_assign
id|USB_MIXER_S16
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_outs
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|check_matrix_bitmap
c_func
(paren
id|desc
op_plus
l_int|9
op_plus
id|num_ins
comma
id|in_ch
comma
id|i
comma
id|num_outs
)paren
)paren
(brace
id|cval-&gt;cmask
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|cval-&gt;channels
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* get min/max values */
id|get_min_max
c_func
(paren
id|cval
comma
l_int|0
)paren
suffix:semicolon
id|kctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|usb_feature_unit_ctl
comma
id|cval
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kctl
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc kcontrol&bslash;n&quot;
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|cval
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|kctl-&gt;private_free
op_assign
id|usb_mixer_elem_free
suffix:semicolon
id|len
op_assign
id|check_mapped_name
c_func
(paren
id|state
comma
id|unitid
comma
l_int|0
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|get_term_name
c_func
(paren
id|state
comma
op_amp
id|iterm
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|len
op_assign
id|sprintf
c_func
(paren
id|kctl-&gt;id.name
comma
l_string|&quot;Mixer Source %d&quot;
comma
id|in_ch
)paren
suffix:semicolon
id|strlcat
c_func
(paren
id|kctl-&gt;id.name
op_plus
id|len
comma
l_string|&quot; Volume&quot;
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;[%d] MU [%s] ch = %d, val = %d/%d&bslash;n&quot;
comma
id|cval-&gt;id
comma
id|kctl-&gt;id.name
comma
id|cval-&gt;channels
comma
id|cval-&gt;min
comma
id|cval-&gt;max
)paren
suffix:semicolon
id|add_control_to_empty
c_func
(paren
id|state-&gt;chip-&gt;card
comma
id|kctl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * parse a mixer unit&n; */
DECL|function|parse_audio_mixer_unit
r_static
r_int
id|parse_audio_mixer_unit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
comma
r_int
r_char
op_star
id|desc
)paren
(brace
r_int
id|num_ins
comma
id|num_outs
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|desc
(braket
l_int|0
)braket
OL
l_int|12
op_logical_or
op_logical_neg
(paren
id|num_ins
op_assign
id|desc
(braket
l_int|4
)braket
)paren
op_logical_or
op_logical_neg
(paren
id|num_outs
op_assign
id|desc
(braket
l_int|5
op_plus
id|num_ins
)braket
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ins
suffix:semicolon
id|i
op_increment
)paren
(brace
id|err
op_assign
id|parse_audio_unit
c_func
(paren
id|state
comma
id|desc
(braket
l_int|5
op_plus
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|check_matrix_bitmap
c_func
(paren
id|desc
op_plus
l_int|9
op_plus
id|num_ins
comma
id|i
comma
l_int|0
comma
id|num_outs
)paren
)paren
id|build_mixer_unit_ctl
c_func
(paren
id|state
comma
id|desc
comma
id|i
comma
id|unitid
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Processing Unit / Extension Unit&n; */
multiline_comment|/* get callback for processing/extension unit */
DECL|function|mixer_ctl_procunit_get
r_static
r_int
id|mixer_ctl_procunit_get
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kcontrol-&gt;private_data
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_int
id|err
comma
id|val
suffix:semicolon
id|err
op_assign
id|get_cur_ctl_value
c_func
(paren
id|cval
comma
id|cval-&gt;control
op_lshift
l_int|8
comma
op_amp
id|val
)paren
suffix:semicolon
macro_line|#ifdef IGNORE_CTL_ERROR
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|cval-&gt;min
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|val
op_assign
id|get_relative_value
c_func
(paren
id|cval
comma
id|val
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* put callback for processing/extension unit */
DECL|function|mixer_ctl_procunit_put
r_static
r_int
id|mixer_ctl_procunit_put
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kcontrol-&gt;private_data
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_int
id|val
comma
id|oval
comma
id|err
suffix:semicolon
id|err
op_assign
id|get_cur_ctl_value
c_func
(paren
id|cval
comma
id|cval-&gt;control
op_lshift
l_int|8
comma
op_amp
id|oval
)paren
suffix:semicolon
macro_line|#ifdef IGNORE_CTL_ERROR
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|val
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
suffix:semicolon
id|val
op_assign
id|get_abs_value
c_func
(paren
id|cval
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|oval
)paren
(brace
id|set_cur_ctl_value
c_func
(paren
id|cval
comma
id|cval-&gt;control
op_lshift
l_int|8
comma
id|val
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* alsa control interface for processing/extension unit */
DECL|variable|mixer_procunit_ctl
r_static
id|snd_kcontrol_new_t
id|mixer_procunit_ctl
op_assign
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;&quot;
comma
multiline_comment|/* will be filled later */
dot
id|info
op_assign
id|mixer_ctl_feature_info
comma
dot
id|get
op_assign
id|mixer_ctl_procunit_get
comma
dot
id|put
op_assign
id|mixer_ctl_procunit_put
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * predefined data for processing units&n; */
DECL|struct|procunit_value_info
r_struct
id|procunit_value_info
(brace
DECL|member|control
r_int
id|control
suffix:semicolon
DECL|member|suffix
r_char
op_star
id|suffix
suffix:semicolon
DECL|member|val_type
r_int
id|val_type
suffix:semicolon
DECL|member|min_value
r_int
id|min_value
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|procunit_info
r_struct
id|procunit_info
(brace
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|values
r_struct
id|procunit_value_info
op_star
id|values
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|updown_proc_info
r_static
r_struct
id|procunit_value_info
id|updown_proc_info
(braket
)braket
op_assign
(brace
(brace
id|USB_PROC_UPDOWN_SWITCH
comma
l_string|&quot;Switch&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
id|USB_PROC_UPDOWN_MODE_SEL
comma
l_string|&quot;Mode Select&quot;
comma
id|USB_MIXER_U8
comma
l_int|1
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|prologic_proc_info
r_static
r_struct
id|procunit_value_info
id|prologic_proc_info
(braket
)braket
op_assign
(brace
(brace
id|USB_PROC_PROLOGIC_SWITCH
comma
l_string|&quot;Switch&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
id|USB_PROC_PROLOGIC_MODE_SEL
comma
l_string|&quot;Mode Select&quot;
comma
id|USB_MIXER_U8
comma
l_int|1
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|threed_enh_proc_info
r_static
r_struct
id|procunit_value_info
id|threed_enh_proc_info
(braket
)braket
op_assign
(brace
(brace
id|USB_PROC_3DENH_SWITCH
comma
l_string|&quot;Switch&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
id|USB_PROC_3DENH_SPACE
comma
l_string|&quot;Spaciousness&quot;
comma
id|USB_MIXER_U8
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|reverb_proc_info
r_static
r_struct
id|procunit_value_info
id|reverb_proc_info
(braket
)braket
op_assign
(brace
(brace
id|USB_PROC_REVERB_SWITCH
comma
l_string|&quot;Switch&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
id|USB_PROC_REVERB_LEVEL
comma
l_string|&quot;Level&quot;
comma
id|USB_MIXER_U8
)brace
comma
(brace
id|USB_PROC_REVERB_TIME
comma
l_string|&quot;Time&quot;
comma
id|USB_MIXER_U16
)brace
comma
(brace
id|USB_PROC_REVERB_DELAY
comma
l_string|&quot;Delay&quot;
comma
id|USB_MIXER_U8
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|chorus_proc_info
r_static
r_struct
id|procunit_value_info
id|chorus_proc_info
(braket
)braket
op_assign
(brace
(brace
id|USB_PROC_CHORUS_SWITCH
comma
l_string|&quot;Switch&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
id|USB_PROC_CHORUS_LEVEL
comma
l_string|&quot;Level&quot;
comma
id|USB_MIXER_U8
)brace
comma
(brace
id|USB_PROC_CHORUS_RATE
comma
l_string|&quot;Rate&quot;
comma
id|USB_MIXER_U16
)brace
comma
(brace
id|USB_PROC_CHORUS_DEPTH
comma
l_string|&quot;Depth&quot;
comma
id|USB_MIXER_U16
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|dcr_proc_info
r_static
r_struct
id|procunit_value_info
id|dcr_proc_info
(braket
)braket
op_assign
(brace
(brace
id|USB_PROC_DCR_SWITCH
comma
l_string|&quot;Switch&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
id|USB_PROC_DCR_RATIO
comma
l_string|&quot;Ratio&quot;
comma
id|USB_MIXER_U16
)brace
comma
(brace
id|USB_PROC_DCR_MAX_AMP
comma
l_string|&quot;Max Amp&quot;
comma
id|USB_MIXER_S16
)brace
comma
(brace
id|USB_PROC_DCR_THRESHOLD
comma
l_string|&quot;Threshold&quot;
comma
id|USB_MIXER_S16
)brace
comma
(brace
id|USB_PROC_DCR_ATTACK
comma
l_string|&quot;Attack Time&quot;
comma
id|USB_MIXER_U16
)brace
comma
(brace
id|USB_PROC_DCR_RELEASE
comma
l_string|&quot;Release Time&quot;
comma
id|USB_MIXER_U16
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|procunits
r_static
r_struct
id|procunit_info
id|procunits
(braket
)braket
op_assign
(brace
(brace
id|USB_PROC_UPDOWN
comma
l_string|&quot;Up Down&quot;
comma
id|updown_proc_info
)brace
comma
(brace
id|USB_PROC_PROLOGIC
comma
l_string|&quot;Dolby Prologic&quot;
comma
id|prologic_proc_info
)brace
comma
(brace
id|USB_PROC_3DENH
comma
l_string|&quot;3D Stereo Extender&quot;
comma
id|threed_enh_proc_info
)brace
comma
(brace
id|USB_PROC_REVERB
comma
l_string|&quot;Reverb&quot;
comma
id|reverb_proc_info
)brace
comma
(brace
id|USB_PROC_CHORUS
comma
l_string|&quot;Chorus&quot;
comma
id|chorus_proc_info
)brace
comma
(brace
id|USB_PROC_DCR
comma
l_string|&quot;DCR&quot;
comma
id|dcr_proc_info
)brace
comma
(brace
l_int|0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * build a processing/extension unit&n; */
DECL|function|build_audio_procunit
r_static
r_int
id|build_audio_procunit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
comma
r_int
r_char
op_star
id|dsc
comma
r_struct
id|procunit_info
op_star
id|list
comma
r_char
op_star
id|name
)paren
(brace
r_int
id|num_ins
op_assign
id|dsc
(braket
l_int|6
)braket
suffix:semicolon
id|usb_mixer_elem_info_t
op_star
id|cval
suffix:semicolon
id|snd_kcontrol_t
op_star
id|kctl
suffix:semicolon
r_int
id|i
comma
id|err
comma
id|nameid
comma
id|type
comma
id|len
suffix:semicolon
r_struct
id|procunit_info
op_star
id|info
suffix:semicolon
r_struct
id|procunit_value_info
op_star
id|valinfo
suffix:semicolon
r_static
r_struct
id|procunit_value_info
id|default_value_info
(braket
)braket
op_assign
(brace
(brace
l_int|0x01
comma
l_string|&quot;Switch&quot;
comma
id|USB_MIXER_BOOLEAN
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
r_static
r_struct
id|procunit_info
id|default_info
op_assign
(brace
l_int|0
comma
l_int|NULL
comma
id|default_value_info
)brace
suffix:semicolon
r_if
c_cond
(paren
id|dsc
(braket
l_int|0
)braket
OL
l_int|13
op_logical_or
id|dsc
(braket
l_int|0
)braket
OL
l_int|13
op_plus
id|num_ins
op_logical_or
id|dsc
(braket
l_int|0
)braket
OL
id|num_ins
op_plus
id|dsc
(braket
l_int|11
op_plus
id|num_ins
)braket
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;invalid %s descriptor (id %d)&bslash;n&quot;
comma
id|name
comma
id|unitid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ins
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|parse_audio_unit
c_func
(paren
id|state
comma
id|dsc
(braket
l_int|7
op_plus
id|i
)braket
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
id|type
op_assign
id|combine_word
c_func
(paren
op_amp
id|dsc
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|type
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* undefined? */
r_for
c_loop
(paren
id|info
op_assign
id|list
suffix:semicolon
id|info
op_logical_and
id|info-&gt;type
suffix:semicolon
id|info
op_increment
)paren
r_if
c_cond
(paren
id|info-&gt;type
op_eq
id|type
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
op_logical_or
op_logical_neg
id|info-&gt;type
)paren
id|info
op_assign
op_amp
id|default_info
suffix:semicolon
r_for
c_loop
(paren
id|valinfo
op_assign
id|info-&gt;values
suffix:semicolon
id|valinfo-&gt;control
suffix:semicolon
id|valinfo
op_increment
)paren
(brace
multiline_comment|/* FIXME: bitmap might be longer than 8bit */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dsc
(braket
l_int|12
op_plus
id|num_ins
)braket
op_amp
(paren
l_int|1
op_lshift
(paren
id|valinfo-&gt;control
op_minus
l_int|1
)paren
)paren
)paren
)paren
r_continue
suffix:semicolon
id|cval
op_assign
id|snd_magic_kcalloc
c_func
(paren
id|usb_mixer_elem_info_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cval
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc kcontrol&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|cval-&gt;chip
op_assign
id|state-&gt;chip
suffix:semicolon
id|cval-&gt;ctrlif
op_assign
id|state-&gt;ctrlif
suffix:semicolon
id|cval-&gt;id
op_assign
id|unitid
suffix:semicolon
id|cval-&gt;control
op_assign
id|valinfo-&gt;control
suffix:semicolon
id|cval-&gt;val_type
op_assign
id|valinfo-&gt;val_type
suffix:semicolon
id|cval-&gt;channels
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* get min/max values */
id|get_min_max
c_func
(paren
id|cval
comma
id|valinfo-&gt;min_value
)paren
suffix:semicolon
id|kctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|mixer_procunit_ctl
comma
id|cval
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kctl
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc kcontrol&bslash;n&quot;
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|cval
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|kctl-&gt;private_free
op_assign
id|usb_mixer_elem_free
suffix:semicolon
r_if
c_cond
(paren
id|check_mapped_name
c_func
(paren
id|state
comma
id|unitid
comma
id|cval-&gt;control
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;name
)paren
id|strlcpy
c_func
(paren
id|kctl-&gt;id.name
comma
id|info-&gt;name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_else
(brace
id|nameid
op_assign
id|dsc
(braket
l_int|12
op_plus
id|num_ins
op_plus
id|dsc
(braket
l_int|11
op_plus
id|num_ins
)braket
)braket
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nameid
)paren
id|len
op_assign
id|snd_usb_copy_string_desc
c_func
(paren
id|state
comma
id|nameid
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|strlcpy
c_func
(paren
id|kctl-&gt;id.name
comma
id|name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
)brace
id|strlcat
c_func
(paren
id|kctl-&gt;id.name
comma
l_char|&squot; &squot;
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
id|strlcat
c_func
(paren
id|kctl-&gt;id.name
comma
id|valinfo-&gt;suffix
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;[%d] PU [%s] ch = %d, val = %d/%d&bslash;n&quot;
comma
id|cval-&gt;id
comma
id|kctl-&gt;id.name
comma
id|cval-&gt;channels
comma
id|cval-&gt;min
comma
id|cval-&gt;max
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|add_control_to_empty
c_func
(paren
id|state-&gt;chip-&gt;card
comma
id|kctl
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|parse_audio_processing_unit
r_static
r_int
id|parse_audio_processing_unit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
comma
r_int
r_char
op_star
id|desc
)paren
(brace
r_return
id|build_audio_procunit
c_func
(paren
id|state
comma
id|unitid
comma
id|desc
comma
id|procunits
comma
l_string|&quot;Processing Unit&quot;
)paren
suffix:semicolon
)brace
DECL|function|parse_audio_extension_unit
r_static
r_int
id|parse_audio_extension_unit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
comma
r_int
r_char
op_star
id|desc
)paren
(brace
r_return
id|build_audio_procunit
c_func
(paren
id|state
comma
id|unitid
comma
id|desc
comma
l_int|NULL
comma
l_string|&quot;Extension Unit&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Selector Unit&n; */
multiline_comment|/* info callback for selector unit&n; * use an enumerator type for routing&n; */
DECL|function|mixer_ctl_selector_info
r_static
r_int
id|mixer_ctl_selector_info
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kcontrol-&gt;private_data
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_char
op_star
op_star
id|itemlist
op_assign
(paren
r_char
op_star
op_star
)paren
id|kcontrol-&gt;private_value
suffix:semicolon
id|snd_assert
c_func
(paren
id|itemlist
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_ENUMERATED
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.enumerated.items
op_assign
id|cval-&gt;max
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|uinfo-&gt;value.enumerated.item
op_ge
id|cval-&gt;max
)paren
id|uinfo-&gt;value.enumerated.item
op_assign
id|cval-&gt;max
op_minus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|uinfo-&gt;value.enumerated.name
comma
id|itemlist
(braket
id|uinfo-&gt;value.enumerated.item
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get callback for selector unit */
DECL|function|mixer_ctl_selector_get
r_static
r_int
id|mixer_ctl_selector_get
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kcontrol-&gt;private_data
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_int
id|val
comma
id|err
suffix:semicolon
id|err
op_assign
id|get_cur_ctl_value
c_func
(paren
id|cval
comma
l_int|0
comma
op_amp
id|val
)paren
suffix:semicolon
macro_line|#ifdef IGNORE_CTL_ERROR
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|ucontrol-&gt;value.enumerated.item
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|val
op_assign
id|get_relative_value
c_func
(paren
id|cval
comma
id|val
)paren
suffix:semicolon
id|ucontrol-&gt;value.enumerated.item
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* put callback for selector unit */
DECL|function|mixer_ctl_selector_put
r_static
r_int
id|mixer_ctl_selector_put
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kcontrol-&gt;private_data
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_int
id|val
comma
id|oval
comma
id|err
suffix:semicolon
id|err
op_assign
id|get_cur_ctl_value
c_func
(paren
id|cval
comma
l_int|0
comma
op_amp
id|oval
)paren
suffix:semicolon
macro_line|#ifdef IGNORE_CTL_ERROR
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|val
op_assign
id|ucontrol-&gt;value.enumerated.item
(braket
l_int|0
)braket
suffix:semicolon
id|val
op_assign
id|get_abs_value
c_func
(paren
id|cval
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|oval
)paren
(brace
id|set_cur_ctl_value
c_func
(paren
id|cval
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* alsa control interface for selector unit */
DECL|variable|mixer_selectunit_ctl
r_static
id|snd_kcontrol_new_t
id|mixer_selectunit_ctl
op_assign
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;&quot;
comma
multiline_comment|/* will be filled later */
dot
id|info
op_assign
id|mixer_ctl_selector_info
comma
dot
id|get
op_assign
id|mixer_ctl_selector_get
comma
dot
id|put
op_assign
id|mixer_ctl_selector_put
comma
)brace
suffix:semicolon
multiline_comment|/* private free callback.&n; * free both private_data and private_value&n; */
DECL|function|usb_mixer_selector_elem_free
r_static
r_void
id|usb_mixer_selector_elem_free
c_func
(paren
id|snd_kcontrol_t
op_star
id|kctl
)paren
(brace
r_int
id|i
comma
id|num_ins
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|kctl-&gt;private_data
)paren
(brace
id|usb_mixer_elem_info_t
op_star
id|cval
op_assign
id|snd_magic_cast
c_func
(paren
id|usb_mixer_elem_info_t
comma
id|kctl-&gt;private_data
comma
)paren
suffix:semicolon
id|num_ins
op_assign
id|cval-&gt;max
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|cval
)paren
suffix:semicolon
id|kctl-&gt;private_data
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kctl-&gt;private_value
)paren
(brace
r_char
op_star
op_star
id|itemlist
op_assign
(paren
r_char
op_star
op_star
)paren
id|kctl-&gt;private_value
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ins
suffix:semicolon
id|i
op_increment
)paren
id|kfree
c_func
(paren
id|itemlist
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|itemlist
)paren
suffix:semicolon
id|kctl-&gt;private_value
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * parse a selector unit&n; */
DECL|function|parse_audio_selector_unit
r_static
r_int
id|parse_audio_selector_unit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
comma
r_int
r_char
op_star
id|desc
)paren
(brace
r_int
r_int
id|num_ins
op_assign
id|desc
(braket
l_int|4
)braket
suffix:semicolon
r_int
r_int
id|i
comma
id|nameid
comma
id|len
suffix:semicolon
r_int
id|err
suffix:semicolon
id|usb_mixer_elem_info_t
op_star
id|cval
suffix:semicolon
id|snd_kcontrol_t
op_star
id|kctl
suffix:semicolon
r_char
op_star
op_star
id|namelist
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|num_ins
op_logical_or
id|desc
(braket
l_int|0
)braket
OL
l_int|6
op_plus
id|num_ins
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;invalid SELECTOR UNIT descriptor %d&bslash;n&quot;
comma
id|unitid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ins
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|parse_audio_unit
c_func
(paren
id|state
comma
id|desc
(braket
l_int|5
op_plus
id|i
)braket
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
id|cval
op_assign
id|snd_magic_kcalloc
c_func
(paren
id|usb_mixer_elem_info_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cval
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc kcontrol&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|cval-&gt;chip
op_assign
id|state-&gt;chip
suffix:semicolon
id|cval-&gt;ctrlif
op_assign
id|state-&gt;ctrlif
suffix:semicolon
id|cval-&gt;id
op_assign
id|unitid
suffix:semicolon
id|cval-&gt;val_type
op_assign
id|USB_MIXER_U8
suffix:semicolon
id|cval-&gt;channels
op_assign
l_int|1
suffix:semicolon
id|cval-&gt;min
op_assign
l_int|1
suffix:semicolon
id|cval-&gt;max
op_assign
id|num_ins
suffix:semicolon
id|cval-&gt;res
op_assign
l_int|1
suffix:semicolon
id|cval-&gt;initialized
op_assign
l_int|1
suffix:semicolon
id|namelist
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_char
op_star
)paren
op_star
id|num_ins
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|namelist
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc&bslash;n&quot;
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|cval
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|macro|MAX_ITEM_NAME_LEN
mdefine_line|#define MAX_ITEM_NAME_LEN&t;64
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ins
suffix:semicolon
id|i
op_increment
)paren
(brace
id|usb_audio_term_t
id|iterm
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|namelist
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
id|MAX_ITEM_NAME_LEN
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|namelist
(braket
id|i
)braket
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
)paren
id|kfree
c_func
(paren
id|namelist
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|namelist
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|cval
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_input_term
c_func
(paren
id|state
comma
id|desc
(braket
l_int|5
op_plus
id|i
)braket
comma
op_amp
id|iterm
)paren
op_ge
l_int|0
)paren
id|len
op_assign
id|get_term_name
c_func
(paren
id|state
comma
op_amp
id|iterm
comma
id|namelist
(braket
id|i
)braket
comma
id|MAX_ITEM_NAME_LEN
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|sprintf
c_func
(paren
id|namelist
(braket
id|i
)braket
comma
l_string|&quot;Input %d&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|kctl
op_assign
id|snd_ctl_new1
c_func
(paren
op_amp
id|mixer_selectunit_ctl
comma
id|cval
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kctl
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot malloc kcontrol&bslash;n&quot;
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|cval
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|kctl-&gt;private_value
op_assign
(paren
r_int
r_int
)paren
id|namelist
suffix:semicolon
id|kctl-&gt;private_free
op_assign
id|usb_mixer_selector_elem_free
suffix:semicolon
id|nameid
op_assign
id|desc
(braket
id|desc
(braket
l_int|0
)braket
op_minus
l_int|1
)braket
suffix:semicolon
id|len
op_assign
id|check_mapped_name
c_func
(paren
id|state
comma
id|unitid
comma
l_int|0
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|nameid
)paren
id|snd_usb_copy_string_desc
c_func
(paren
id|state
comma
id|nameid
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_else
(brace
id|len
op_assign
id|get_term_name
c_func
(paren
id|state
comma
op_amp
id|state-&gt;oterm
comma
id|kctl-&gt;id.name
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
id|strlcpy
c_func
(paren
id|kctl-&gt;id.name
comma
l_string|&quot;USB&quot;
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state-&gt;oterm.type
op_amp
l_int|0xff00
)paren
op_eq
l_int|0x0100
)paren
id|strlcat
c_func
(paren
id|kctl-&gt;id.name
comma
l_string|&quot; Capture Source&quot;
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
r_else
id|strlcat
c_func
(paren
id|kctl-&gt;id.name
comma
l_string|&quot; Playback Source&quot;
comma
r_sizeof
(paren
id|kctl-&gt;id.name
)paren
)paren
suffix:semicolon
)brace
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;[%d] SU [%s] items = %d&bslash;n&quot;
comma
id|cval-&gt;id
comma
id|kctl-&gt;id.name
comma
id|num_ins
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|add_control_to_empty
c_func
(paren
id|state-&gt;chip-&gt;card
comma
id|kctl
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * parse an audio unit recursively&n; */
DECL|function|parse_audio_unit
r_static
r_int
id|parse_audio_unit
c_func
(paren
id|mixer_build_t
op_star
id|state
comma
r_int
id|unitid
)paren
(brace
r_int
r_char
op_star
id|p1
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|unitid
comma
id|state-&gt;unitbitmap
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* the unit already visited */
id|p1
op_assign
id|find_audio_control_unit
c_func
(paren
id|state
comma
id|unitid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p1
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;usbaudio: unit %d not found!&bslash;n&quot;
comma
id|unitid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|p1
(braket
l_int|2
)braket
)paren
(brace
r_case
id|INPUT_TERMINAL
suffix:colon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* NOP */
r_case
id|MIXER_UNIT
suffix:colon
r_return
id|parse_audio_mixer_unit
c_func
(paren
id|state
comma
id|unitid
comma
id|p1
)paren
suffix:semicolon
r_case
id|SELECTOR_UNIT
suffix:colon
r_return
id|parse_audio_selector_unit
c_func
(paren
id|state
comma
id|unitid
comma
id|p1
)paren
suffix:semicolon
r_case
id|FEATURE_UNIT
suffix:colon
r_return
id|parse_audio_feature_unit
c_func
(paren
id|state
comma
id|unitid
comma
id|p1
)paren
suffix:semicolon
r_case
id|PROCESSING_UNIT
suffix:colon
r_return
id|parse_audio_processing_unit
c_func
(paren
id|state
comma
id|unitid
comma
id|p1
)paren
suffix:semicolon
r_case
id|EXTENSION_UNIT
suffix:colon
r_return
id|parse_audio_extension_unit
c_func
(paren
id|state
comma
id|unitid
comma
id|p1
)paren
suffix:semicolon
r_default
suffix:colon
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;usbaudio: unit %u: unexpected type 0x%02x&bslash;n&quot;
comma
id|unitid
comma
id|p1
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * create mixer controls&n; *&n; * walk through all OUTPUT_TERMINAL descriptors to search for mixers&n; */
DECL|function|snd_usb_create_mixer
r_int
id|snd_usb_create_mixer
c_func
(paren
id|snd_usb_audio_t
op_star
id|chip
comma
r_int
id|ctrlif
)paren
(brace
r_int
r_char
op_star
id|desc
suffix:semicolon
id|mixer_build_t
id|state
suffix:semicolon
r_int
id|err
suffix:semicolon
r_const
r_struct
id|usbmix_ctl_map
op_star
id|map
suffix:semicolon
r_struct
id|usb_device_descriptor
op_star
id|dev
op_assign
op_amp
id|chip-&gt;dev-&gt;descriptor
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|hostif
op_assign
op_amp
id|chip-&gt;dev-&gt;actconfig-&gt;interface
(braket
id|ctrlif
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
id|strcpy
c_func
(paren
id|chip-&gt;card-&gt;mixername
comma
l_string|&quot;USB Mixer&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|state
comma
l_int|0
comma
r_sizeof
(paren
id|state
)paren
)paren
suffix:semicolon
id|state.chip
op_assign
id|chip
suffix:semicolon
id|state.buffer
op_assign
id|hostif-&gt;extra
suffix:semicolon
id|state.buflen
op_assign
id|hostif-&gt;extralen
suffix:semicolon
id|state.ctrlif
op_assign
id|ctrlif
suffix:semicolon
id|state.vendor
op_assign
id|dev-&gt;idVendor
suffix:semicolon
id|state.product
op_assign
id|dev-&gt;idProduct
suffix:semicolon
multiline_comment|/* check the mapping table */
r_for
c_loop
(paren
id|map
op_assign
id|usbmix_ctl_maps
suffix:semicolon
id|map-&gt;vendor
suffix:semicolon
id|map
op_increment
)paren
(brace
r_if
c_cond
(paren
id|map-&gt;vendor
op_eq
id|dev-&gt;idVendor
op_logical_and
id|map-&gt;product
op_eq
id|dev-&gt;idProduct
)paren
(brace
id|state.map
op_assign
id|map-&gt;map
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|desc
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|desc
op_assign
id|snd_usb_find_csint_desc
c_func
(paren
id|hostif-&gt;extra
comma
id|hostif-&gt;extralen
comma
id|desc
comma
id|OUTPUT_TERMINAL
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|desc
(braket
l_int|0
)braket
OL
l_int|9
)paren
r_continue
suffix:semicolon
multiline_comment|/* invalid descriptor? */
id|set_bit
c_func
(paren
id|desc
(braket
l_int|3
)braket
comma
id|state.unitbitmap
)paren
suffix:semicolon
multiline_comment|/* mark terminal ID as visited */
id|state.oterm.id
op_assign
id|desc
(braket
l_int|3
)braket
suffix:semicolon
id|state.oterm.type
op_assign
id|combine_word
c_func
(paren
op_amp
id|desc
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|state.oterm.name
op_assign
id|desc
(braket
l_int|8
)braket
suffix:semicolon
id|err
op_assign
id|parse_audio_unit
c_func
(paren
op_amp
id|state
comma
id|desc
(braket
l_int|7
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
