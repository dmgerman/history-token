multiline_comment|/*&n; * usbmidi.c - ALSA USB MIDI driver&n; *&n; * Copyright (c) 2002-2004 Clemens Ladisch&n; * All rights reserved.&n; *&n; * Based on the OSS usb-midi driver by NAGANO Daisuke,&n; *          NetBSD&squot;s umidi driver by Takuya SHIOZAKI,&n; *          the &quot;USB Device Class Definition for MIDI Devices&quot; by Roland&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification.&n; * 2. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * Alternatively, this software may be distributed and/or modified under the&n; * terms of the GNU General Public License as published by the Free Software&n; * Foundation; either version 2 of the License, or (at your option) any later&n; * version.&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/minors.h&gt;
macro_line|#include &lt;sound/rawmidi.h&gt;
macro_line|#include &quot;usbaudio.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Clemens Ladisch &lt;clemens@ladisch.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;USB Audio/MIDI helper module&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
DECL|struct|usb_ms_header_descriptor
r_struct
id|usb_ms_header_descriptor
(brace
DECL|member|bLength
id|__u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|__u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubtype
id|__u8
id|bDescriptorSubtype
suffix:semicolon
DECL|member|bcdMSC
id|__u8
id|bcdMSC
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|wTotalLength
id|__u16
id|wTotalLength
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|usb_ms_endpoint_descriptor
r_struct
id|usb_ms_endpoint_descriptor
(brace
DECL|member|bLength
id|__u8
id|bLength
suffix:semicolon
DECL|member|bDescriptorType
id|__u8
id|bDescriptorType
suffix:semicolon
DECL|member|bDescriptorSubtype
id|__u8
id|bDescriptorSubtype
suffix:semicolon
DECL|member|bNumEmbMIDIJack
id|__u8
id|bNumEmbMIDIJack
suffix:semicolon
DECL|member|baAssocJackID
id|__u8
id|baAssocJackID
(braket
l_int|0
)braket
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|typedef|snd_usb_midi_t
r_typedef
r_struct
id|snd_usb_midi
id|snd_usb_midi_t
suffix:semicolon
DECL|typedef|snd_usb_midi_endpoint_t
r_typedef
r_struct
id|snd_usb_midi_endpoint
id|snd_usb_midi_endpoint_t
suffix:semicolon
DECL|typedef|snd_usb_midi_out_endpoint_t
r_typedef
r_struct
id|snd_usb_midi_out_endpoint
id|snd_usb_midi_out_endpoint_t
suffix:semicolon
DECL|typedef|snd_usb_midi_in_endpoint_t
r_typedef
r_struct
id|snd_usb_midi_in_endpoint
id|snd_usb_midi_in_endpoint_t
suffix:semicolon
DECL|typedef|usbmidi_out_port_t
r_typedef
r_struct
id|usbmidi_out_port
id|usbmidi_out_port_t
suffix:semicolon
DECL|typedef|usbmidi_in_port_t
r_typedef
r_struct
id|usbmidi_in_port
id|usbmidi_in_port_t
suffix:semicolon
DECL|struct|snd_usb_midi
r_struct
id|snd_usb_midi
(brace
DECL|member|chip
id|snd_usb_audio_t
op_star
id|chip
suffix:semicolon
DECL|member|iface
r_struct
id|usb_interface
op_star
id|iface
suffix:semicolon
DECL|member|quirk
r_const
id|snd_usb_audio_quirk_t
op_star
id|quirk
suffix:semicolon
DECL|member|rmidi
id|snd_rawmidi_t
op_star
id|rmidi
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|struct|snd_usb_midi_endpoint
r_struct
id|snd_usb_midi_endpoint
(brace
DECL|member|out
id|snd_usb_midi_out_endpoint_t
op_star
id|out
suffix:semicolon
DECL|member|in
id|snd_usb_midi_in_endpoint_t
op_star
id|in
suffix:semicolon
DECL|member|endpoints
)brace
id|endpoints
(braket
id|MIDI_MAX_ENDPOINTS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|snd_usb_midi_out_endpoint
r_struct
id|snd_usb_midi_out_endpoint
(brace
DECL|member|umidi
id|snd_usb_midi_t
op_star
id|umidi
suffix:semicolon
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
DECL|member|max_transfer
r_int
id|max_transfer
suffix:semicolon
multiline_comment|/* size of urb buffer */
DECL|member|tasklet
r_struct
id|tasklet_struct
id|tasklet
suffix:semicolon
DECL|member|buffer_lock
id|spinlock_t
id|buffer_lock
suffix:semicolon
DECL|struct|usbmidi_out_port
r_struct
id|usbmidi_out_port
(brace
DECL|member|ep
id|snd_usb_midi_out_endpoint_t
op_star
id|ep
suffix:semicolon
DECL|member|substream
id|snd_rawmidi_substream_t
op_star
id|substream
suffix:semicolon
DECL|member|active
r_int
id|active
suffix:semicolon
DECL|member|cable
r_uint8
id|cable
suffix:semicolon
multiline_comment|/* cable number &lt;&lt; 4 */
DECL|member|state
r_uint8
id|state
suffix:semicolon
DECL|macro|STATE_UNKNOWN
mdefine_line|#define STATE_UNKNOWN&t;0
DECL|macro|STATE_1PARAM
mdefine_line|#define STATE_1PARAM&t;1
DECL|macro|STATE_2PARAM_1
mdefine_line|#define STATE_2PARAM_1&t;2
DECL|macro|STATE_2PARAM_2
mdefine_line|#define STATE_2PARAM_2&t;3
DECL|macro|STATE_SYSEX_0
mdefine_line|#define STATE_SYSEX_0&t;4
DECL|macro|STATE_SYSEX_1
mdefine_line|#define STATE_SYSEX_1&t;5
DECL|macro|STATE_SYSEX_2
mdefine_line|#define STATE_SYSEX_2&t;6
DECL|member|data
r_uint8
id|data
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|ports
)brace
id|ports
(braket
l_int|0x10
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|snd_usb_midi_in_endpoint
r_struct
id|snd_usb_midi_in_endpoint
(brace
DECL|member|umidi
id|snd_usb_midi_t
op_star
id|umidi
suffix:semicolon
DECL|member|urb
r_struct
id|urb
op_star
id|urb
suffix:semicolon
DECL|struct|usbmidi_in_port
r_struct
id|usbmidi_in_port
(brace
DECL|member|substream
id|snd_rawmidi_substream_t
op_star
id|substream
suffix:semicolon
DECL|member|ports
)brace
id|ports
(braket
l_int|0x10
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|snd_usbmidi_do_output
c_func
(paren
id|snd_usb_midi_out_endpoint_t
op_star
id|ep
)paren
suffix:semicolon
DECL|variable|snd_usbmidi_cin_length
r_static
r_const
r_uint8
id|snd_usbmidi_cin_length
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|2
comma
l_int|3
comma
l_int|3
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|2
comma
l_int|2
comma
l_int|3
comma
l_int|1
)brace
suffix:semicolon
multiline_comment|/*&n; * Submits the URB, with error handling.&n; */
DECL|function|snd_usbmidi_submit_urb
r_static
r_int
id|snd_usbmidi_submit_urb
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_int
id|flags
)paren
(brace
r_int
id|err
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
op_logical_and
id|err
op_ne
op_minus
id|ENODEV
)paren
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;usb_submit_urb: %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Error handling for URB completion functions.&n; */
DECL|function|snd_usbmidi_urb_error
r_static
r_int
id|snd_usbmidi_urb_error
c_func
(paren
r_int
id|status
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|ENOENT
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* killed */
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|EILSEQ
op_logical_or
id|status
op_eq
op_minus
id|ECONNRESET
op_logical_or
id|status
op_eq
op_minus
id|ETIMEDOUT
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* device removed/shutdown */
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;urb status %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* continue */
)brace
multiline_comment|/*&n; * Receives a USB MIDI packet.&n; */
DECL|function|snd_usbmidi_input_packet
r_static
r_void
id|snd_usbmidi_input_packet
c_func
(paren
id|snd_usb_midi_in_endpoint_t
op_star
id|ep
comma
r_uint8
id|packet
(braket
l_int|4
)braket
)paren
(brace
r_int
id|cable
op_assign
id|packet
(braket
l_int|0
)braket
op_rshift
l_int|4
suffix:semicolon
id|usbmidi_in_port_t
op_star
id|port
op_assign
op_amp
id|ep-&gt;ports
(braket
id|cable
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;substream
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;unexpected port %d!&bslash;n&quot;
comma
id|cable
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;substream-&gt;runtime
op_logical_or
op_logical_neg
id|port-&gt;substream-&gt;runtime-&gt;trigger
)paren
r_return
suffix:semicolon
id|snd_rawmidi_receive
c_func
(paren
id|port-&gt;substream
comma
op_amp
id|packet
(braket
l_int|1
)braket
comma
id|snd_usbmidi_cin_length
(braket
id|packet
(braket
l_int|0
)braket
op_amp
l_int|0x0f
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Processes the data read from the device.&n; */
DECL|function|snd_usbmidi_in_urb_complete
r_static
r_void
id|snd_usbmidi_in_urb_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|snd_usb_midi_in_endpoint_t
op_star
id|ep
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
l_int|0
)paren
(brace
r_uint8
op_star
id|buffer
op_assign
(paren
r_uint8
op_star
)paren
id|ep-&gt;urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_plus
l_int|4
op_le
id|urb-&gt;actual_length
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_ne
l_int|0
)paren
id|snd_usbmidi_input_packet
c_func
(paren
id|ep
comma
op_amp
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|snd_usbmidi_urb_error
c_func
(paren
id|urb-&gt;status
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|usb_pipe_needs_resubmit
c_func
(paren
id|urb-&gt;pipe
)paren
)paren
(brace
id|urb-&gt;dev
op_assign
id|ep-&gt;umidi-&gt;chip-&gt;dev
suffix:semicolon
id|snd_usbmidi_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Converts the data read from a Midiman device to standard USB MIDI packets.&n; */
DECL|function|snd_usbmidi_in_midiman_complete
r_static
r_void
id|snd_usbmidi_in_midiman_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
l_int|0
)paren
(brace
r_uint8
op_star
id|buffer
op_assign
(paren
r_uint8
op_star
)paren
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_plus
l_int|4
op_le
id|urb-&gt;actual_length
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|buffer
(braket
id|i
op_plus
l_int|3
)braket
op_ne
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * snd_usbmidi_input_packet() doesn&squot;t check the&n;&t;&t;&t;&t; * contents of the message, so we simply use&n;&t;&t;&t;&t; * some random CIN with the desired length.&n;&t;&t;&t;&t; */
r_static
r_const
r_uint8
id|cin
(braket
l_int|4
)braket
op_assign
(brace
l_int|0x0
comma
l_int|0xf
comma
l_int|0x2
comma
l_int|0x3
)brace
suffix:semicolon
r_uint8
id|ctl
op_assign
id|buffer
(braket
id|i
op_plus
l_int|3
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_plus
l_int|3
)braket
op_assign
id|buffer
(braket
id|i
op_plus
l_int|2
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_plus
l_int|2
)braket
op_assign
id|buffer
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|buffer
(braket
id|i
op_plus
l_int|0
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_plus
l_int|0
)braket
op_assign
(paren
id|ctl
op_amp
l_int|0xf0
)paren
op_or
id|cin
(braket
id|ctl
op_amp
l_int|3
)braket
suffix:semicolon
)brace
r_else
(brace
id|buffer
(braket
id|i
op_plus
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
id|snd_usbmidi_in_urb_complete
c_func
(paren
id|urb
comma
id|regs
)paren
suffix:semicolon
)brace
DECL|function|snd_usbmidi_out_urb_complete
r_static
r_void
id|snd_usbmidi_out_urb_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|snd_usb_midi_out_endpoint_t
op_star
id|ep
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|snd_usbmidi_urb_error
c_func
(paren
id|urb-&gt;status
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
)brace
id|snd_usbmidi_do_output
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Converts standard USB MIDI packets to what Midman devices expect.&n; */
DECL|function|snd_usbmidi_convert_to_midiman
r_static
r_void
id|snd_usbmidi_convert_to_midiman
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_uint8
op_star
id|buffer
op_assign
(paren
r_uint8
op_star
)paren
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_plus
l_int|4
op_le
id|urb-&gt;transfer_buffer_length
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
r_uint8
id|cin
op_assign
id|buffer
(braket
id|i
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_plus
l_int|0
)braket
op_assign
id|buffer
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|buffer
(braket
id|i
op_plus
l_int|2
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_plus
l_int|2
)braket
op_assign
id|buffer
(braket
id|i
op_plus
l_int|3
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_plus
l_int|3
)braket
op_assign
(paren
id|cin
op_amp
l_int|0xf0
)paren
op_or
id|snd_usbmidi_cin_length
(braket
id|cin
op_amp
l_int|0x0f
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Adds one USB MIDI packet to the output buffer.&n; */
DECL|function|output_packet
r_static
r_inline
r_void
id|output_packet
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_uint8
id|p0
comma
r_uint8
id|p1
comma
r_uint8
id|p2
comma
r_uint8
id|p3
)paren
(brace
r_uint8
op_star
id|buf
op_assign
(paren
r_uint8
op_star
)paren
id|urb-&gt;transfer_buffer
op_plus
id|urb-&gt;transfer_buffer_length
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|p0
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|p1
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|p2
suffix:semicolon
id|buf
(braket
l_int|3
)braket
op_assign
id|p3
suffix:semicolon
id|urb-&gt;transfer_buffer_length
op_add_assign
l_int|4
suffix:semicolon
)brace
multiline_comment|/*&n; * Converts MIDI commands to USB MIDI packets.&n; */
DECL|function|snd_usbmidi_transmit_byte
r_static
r_void
id|snd_usbmidi_transmit_byte
c_func
(paren
id|usbmidi_out_port_t
op_star
id|port
comma
r_uint8
id|b
comma
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_uint8
id|p0
op_assign
id|port-&gt;cable
suffix:semicolon
r_if
c_cond
(paren
id|b
op_ge
l_int|0xf8
)paren
(brace
id|output_packet
c_func
(paren
id|urb
comma
id|p0
op_or
l_int|0x0f
comma
id|b
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|b
op_ge
l_int|0xf0
)paren
(brace
r_switch
c_cond
(paren
id|b
)paren
(brace
r_case
l_int|0xf0
suffix:colon
id|port-&gt;data
(braket
l_int|0
)braket
op_assign
id|b
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_SYSEX_1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf1
suffix:colon
r_case
l_int|0xf3
suffix:colon
id|port-&gt;data
(braket
l_int|0
)braket
op_assign
id|b
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_1PARAM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf2
suffix:colon
id|port-&gt;data
(braket
l_int|0
)braket
op_assign
id|b
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_2PARAM_1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf4
suffix:colon
r_case
l_int|0xf5
suffix:colon
id|port-&gt;state
op_assign
id|STATE_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf6
suffix:colon
id|output_packet
c_func
(paren
id|urb
comma
id|p0
op_or
l_int|0x05
comma
l_int|0xf6
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf7
suffix:colon
r_switch
c_cond
(paren
id|port-&gt;state
)paren
(brace
r_case
id|STATE_SYSEX_0
suffix:colon
id|output_packet
c_func
(paren
id|urb
comma
id|p0
op_or
l_int|0x05
comma
l_int|0xf7
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_SYSEX_1
suffix:colon
id|output_packet
c_func
(paren
id|urb
comma
id|p0
op_or
l_int|0x06
comma
id|port-&gt;data
(braket
l_int|0
)braket
comma
l_int|0xf7
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_SYSEX_2
suffix:colon
id|output_packet
c_func
(paren
id|urb
comma
id|p0
op_or
l_int|0x07
comma
id|port-&gt;data
(braket
l_int|0
)braket
comma
id|port-&gt;data
(braket
l_int|1
)braket
comma
l_int|0xf7
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|port-&gt;state
op_assign
id|STATE_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|b
op_ge
l_int|0x80
)paren
(brace
id|port-&gt;data
(braket
l_int|0
)braket
op_assign
id|b
suffix:semicolon
r_if
c_cond
(paren
id|b
op_ge
l_int|0xc0
op_logical_and
id|b
op_le
l_int|0xdf
)paren
id|port-&gt;state
op_assign
id|STATE_1PARAM
suffix:semicolon
r_else
id|port-&gt;state
op_assign
id|STATE_2PARAM_1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* b &lt; 0x80 */
r_switch
c_cond
(paren
id|port-&gt;state
)paren
(brace
r_case
id|STATE_1PARAM
suffix:colon
r_if
c_cond
(paren
id|port-&gt;data
(braket
l_int|0
)braket
OL
l_int|0xf0
)paren
(brace
id|p0
op_or_assign
id|port-&gt;data
(braket
l_int|0
)braket
op_rshift
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|p0
op_or_assign
l_int|0x02
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_UNKNOWN
suffix:semicolon
)brace
id|output_packet
c_func
(paren
id|urb
comma
id|p0
comma
id|port-&gt;data
(braket
l_int|0
)braket
comma
id|b
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_2PARAM_1
suffix:colon
id|port-&gt;data
(braket
l_int|1
)braket
op_assign
id|b
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_2PARAM_2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_2PARAM_2
suffix:colon
r_if
c_cond
(paren
id|port-&gt;data
(braket
l_int|0
)braket
OL
l_int|0xf0
)paren
(brace
id|p0
op_or_assign
id|port-&gt;data
(braket
l_int|0
)braket
op_rshift
l_int|4
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_2PARAM_1
suffix:semicolon
)brace
r_else
(brace
id|p0
op_or_assign
l_int|0x03
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_UNKNOWN
suffix:semicolon
)brace
id|output_packet
c_func
(paren
id|urb
comma
id|p0
comma
id|port-&gt;data
(braket
l_int|0
)braket
comma
id|port-&gt;data
(braket
l_int|1
)braket
comma
id|b
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_SYSEX_0
suffix:colon
id|port-&gt;data
(braket
l_int|0
)braket
op_assign
id|b
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_SYSEX_1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_SYSEX_1
suffix:colon
id|port-&gt;data
(braket
l_int|1
)braket
op_assign
id|b
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_SYSEX_2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_SYSEX_2
suffix:colon
id|output_packet
c_func
(paren
id|urb
comma
id|p0
op_or
l_int|0x04
comma
id|port-&gt;data
(braket
l_int|0
)braket
comma
id|port-&gt;data
(braket
l_int|1
)braket
comma
id|b
)paren
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_SYSEX_0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Moves data from one substream buffer to the URB transfer buffer.&n; */
DECL|function|snd_usbmidi_transmit
r_static
r_void
id|snd_usbmidi_transmit
c_func
(paren
id|snd_usb_midi_out_endpoint_t
op_star
id|ep
comma
r_int
id|port_idx
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|ep-&gt;urb
suffix:semicolon
id|usbmidi_out_port_t
op_star
id|port
op_assign
op_amp
id|ep-&gt;ports
(braket
id|port_idx
)braket
suffix:semicolon
r_while
c_loop
(paren
id|urb-&gt;transfer_buffer_length
OL
id|ep-&gt;max_transfer
)paren
(brace
r_uint8
id|b
suffix:semicolon
r_if
c_cond
(paren
id|snd_rawmidi_transmit_peek
c_func
(paren
id|port-&gt;substream
comma
op_amp
id|b
comma
l_int|1
)paren
op_ne
l_int|1
)paren
(brace
id|port-&gt;active
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|snd_usbmidi_transmit_byte
c_func
(paren
id|port
comma
id|b
comma
id|urb
)paren
suffix:semicolon
id|snd_rawmidi_transmit_ack
c_func
(paren
id|port-&gt;substream
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This is called when some data should be transferred to the device&n; * (from one or more substreams).&n; */
DECL|function|snd_usbmidi_do_output
r_static
r_void
id|snd_usbmidi_do_output
c_func
(paren
id|snd_usb_midi_out_endpoint_t
op_star
id|ep
)paren
(brace
r_int
id|p
suffix:semicolon
r_struct
id|urb
op_star
id|urb
op_assign
id|ep-&gt;urb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ep-&gt;buffer_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
op_logical_or
id|ep-&gt;umidi-&gt;chip-&gt;shutdown
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;buffer_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|urb-&gt;transfer_buffer_length
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
l_int|0x10
suffix:semicolon
op_increment
id|p
)paren
r_if
c_cond
(paren
id|ep-&gt;ports
(braket
id|p
)braket
dot
id|active
)paren
id|snd_usbmidi_transmit
c_func
(paren
id|ep
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;transfer_buffer_length
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;umidi-&gt;quirk
op_logical_and
id|ep-&gt;umidi-&gt;quirk-&gt;type
op_eq
id|QUIRK_MIDI_MIDIMAN
)paren
id|snd_usbmidi_convert_to_midiman
c_func
(paren
id|urb
)paren
suffix:semicolon
id|urb-&gt;dev
op_assign
id|ep-&gt;umidi-&gt;chip-&gt;dev
suffix:semicolon
id|snd_usbmidi_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ep-&gt;buffer_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_usbmidi_out_tasklet
r_static
r_void
id|snd_usbmidi_out_tasklet
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|snd_usb_midi_out_endpoint_t
op_star
id|ep
op_assign
(paren
id|snd_usb_midi_out_endpoint_t
op_star
)paren
id|data
suffix:semicolon
id|snd_usbmidi_do_output
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
DECL|function|snd_usbmidi_output_open
r_static
r_int
id|snd_usbmidi_output_open
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
id|snd_usb_midi_t
op_star
id|umidi
op_assign
id|substream-&gt;rmidi-&gt;private_data
suffix:semicolon
id|usbmidi_out_port_t
op_star
id|port
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIDI_MAX_ENDPOINTS
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|umidi-&gt;endpoints
(braket
id|i
)braket
dot
id|out
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|0x10
suffix:semicolon
op_increment
id|j
)paren
r_if
c_cond
(paren
id|umidi-&gt;endpoints
(braket
id|i
)braket
dot
id|out-&gt;ports
(braket
id|j
)braket
dot
id|substream
op_eq
id|substream
)paren
(brace
id|port
op_assign
op_amp
id|umidi-&gt;endpoints
(braket
id|i
)braket
dot
id|out-&gt;ports
(braket
id|j
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
(brace
id|snd_BUG
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|substream-&gt;runtime-&gt;private_data
op_assign
id|port
suffix:semicolon
id|port-&gt;state
op_assign
id|STATE_UNKNOWN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usbmidi_output_close
r_static
r_int
id|snd_usbmidi_output_close
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usbmidi_output_trigger
r_static
r_void
id|snd_usbmidi_output_trigger
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
comma
r_int
id|up
)paren
(brace
id|usbmidi_out_port_t
op_star
id|port
op_assign
(paren
id|usbmidi_out_port_t
op_star
)paren
id|substream-&gt;runtime-&gt;private_data
suffix:semicolon
id|port-&gt;active
op_assign
id|up
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;ep-&gt;umidi-&gt;chip-&gt;shutdown
)paren
(brace
multiline_comment|/* gobble up remaining bytes to prevent wait in&n;&t;&t;&t; * snd_rawmidi_drain_output */
r_while
c_loop
(paren
op_logical_neg
id|snd_rawmidi_transmit_empty
c_func
(paren
id|substream
)paren
)paren
id|snd_rawmidi_transmit_ack
c_func
(paren
id|substream
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tasklet_hi_schedule
c_func
(paren
op_amp
id|port-&gt;ep-&gt;tasklet
)paren
suffix:semicolon
)brace
)brace
DECL|function|snd_usbmidi_input_open
r_static
r_int
id|snd_usbmidi_input_open
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usbmidi_input_close
r_static
r_int
id|snd_usbmidi_input_close
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usbmidi_input_trigger
r_static
r_void
id|snd_usbmidi_input_trigger
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
comma
r_int
id|up
)paren
(brace
)brace
DECL|variable|snd_usbmidi_output_ops
r_static
id|snd_rawmidi_ops_t
id|snd_usbmidi_output_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_usbmidi_output_open
comma
dot
id|close
op_assign
id|snd_usbmidi_output_close
comma
dot
id|trigger
op_assign
id|snd_usbmidi_output_trigger
comma
)brace
suffix:semicolon
DECL|variable|snd_usbmidi_input_ops
r_static
id|snd_rawmidi_ops_t
id|snd_usbmidi_input_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_usbmidi_input_open
comma
dot
id|close
op_assign
id|snd_usbmidi_input_close
comma
dot
id|trigger
op_assign
id|snd_usbmidi_input_trigger
)brace
suffix:semicolon
multiline_comment|/*&n; * Frees an input endpoint.&n; * May be called when ep hasn&squot;t been initialized completely.&n; */
DECL|function|snd_usbmidi_in_endpoint_delete
r_static
r_void
id|snd_usbmidi_in_endpoint_delete
c_func
(paren
id|snd_usb_midi_in_endpoint_t
op_star
id|ep
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;urb
)paren
(brace
id|kfree
c_func
(paren
id|ep-&gt;urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ep-&gt;urb
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * For Roland devices, use the alternate setting which uses interrupt&n; * transfers for input.&n; */
DECL|function|snd_usbmidi_get_int_epd
r_static
r_struct
id|usb_endpoint_descriptor
op_star
id|snd_usbmidi_get_int_epd
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
)paren
(brace
r_struct
id|usb_interface
op_star
id|intf
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|hostif
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|intfd
suffix:semicolon
r_if
c_cond
(paren
id|umidi-&gt;chip-&gt;dev-&gt;descriptor.idVendor
op_ne
l_int|0x0582
)paren
r_return
l_int|NULL
suffix:semicolon
id|intf
op_assign
id|umidi-&gt;iface
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intf
op_logical_or
id|intf-&gt;num_altsetting
op_ne
l_int|2
)paren
r_return
l_int|NULL
suffix:semicolon
id|hostif
op_assign
op_amp
id|intf-&gt;altsetting
(braket
l_int|0
)braket
suffix:semicolon
id|intfd
op_assign
id|get_iface_desc
c_func
(paren
id|hostif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intfd-&gt;bNumEndpoints
op_ne
l_int|2
op_logical_or
(paren
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|0
)paren
op_member_access_from_pointer
id|bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_BULK
op_logical_or
(paren
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|1
)paren
op_member_access_from_pointer
id|bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_BULK
)paren
r_return
l_int|NULL
suffix:semicolon
id|hostif
op_assign
op_amp
id|intf-&gt;altsetting
(braket
l_int|1
)braket
suffix:semicolon
id|intfd
op_assign
id|get_iface_desc
c_func
(paren
id|hostif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intfd-&gt;bNumEndpoints
op_ne
l_int|2
op_logical_or
(paren
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|0
)paren
op_member_access_from_pointer
id|bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_BULK
op_logical_or
(paren
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|1
)paren
op_member_access_from_pointer
id|bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_INT
)paren
r_return
l_int|NULL
suffix:semicolon
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;switching to altsetting %d with int ep&bslash;n&quot;
comma
id|intfd-&gt;bAlternateSetting
)paren
suffix:semicolon
id|usb_set_interface
c_func
(paren
id|umidi-&gt;chip-&gt;dev
comma
id|intfd-&gt;bInterfaceNumber
comma
id|intfd-&gt;bAlternateSetting
)paren
suffix:semicolon
r_return
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|snd_usbmidi_get_midiman_int_epd
r_static
r_struct
id|usb_endpoint_descriptor
op_star
id|snd_usbmidi_get_midiman_int_epd
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
)paren
(brace
r_struct
id|usb_interface
op_star
id|intf
op_assign
id|umidi-&gt;iface
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|hostif
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|intfd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intf
)paren
r_return
l_int|NULL
suffix:semicolon
id|hostif
op_assign
op_amp
id|intf-&gt;altsetting
(braket
l_int|0
)braket
suffix:semicolon
id|intfd
op_assign
id|get_iface_desc
c_func
(paren
id|hostif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intfd-&gt;bNumEndpoints
OL
l_int|1
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Creates an input endpoint.&n; */
DECL|function|snd_usbmidi_in_endpoint_create
r_static
r_int
id|snd_usbmidi_in_endpoint_create
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
id|snd_usb_midi_endpoint_info_t
op_star
id|ep_info
comma
id|snd_usb_midi_endpoint_t
op_star
id|rep
)paren
(brace
id|snd_usb_midi_in_endpoint_t
op_star
id|ep
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|int_epd
suffix:semicolon
r_void
op_star
id|buffer
suffix:semicolon
r_int
r_int
id|pipe
suffix:semicolon
r_int
id|length
suffix:semicolon
id|rep-&gt;in
op_assign
l_int|NULL
suffix:semicolon
id|ep
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|ep
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ep-&gt;umidi
op_assign
id|umidi
suffix:semicolon
r_if
c_cond
(paren
id|umidi-&gt;quirk
op_logical_and
id|umidi-&gt;quirk-&gt;type
op_eq
id|QUIRK_MIDI_MIDIMAN
)paren
id|int_epd
op_assign
id|snd_usbmidi_get_midiman_int_epd
c_func
(paren
id|umidi
)paren
suffix:semicolon
r_else
id|int_epd
op_assign
id|snd_usbmidi_get_int_epd
c_func
(paren
id|umidi
)paren
suffix:semicolon
id|ep-&gt;urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;urb
)paren
(brace
id|snd_usbmidi_in_endpoint_delete
c_func
(paren
id|ep
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|int_epd
)paren
id|pipe
op_assign
id|usb_rcvintpipe
c_func
(paren
id|umidi-&gt;chip-&gt;dev
comma
id|ep_info-&gt;in_ep
)paren
suffix:semicolon
r_else
id|pipe
op_assign
id|usb_rcvbulkpipe
c_func
(paren
id|umidi-&gt;chip-&gt;dev
comma
id|ep_info-&gt;in_ep
)paren
suffix:semicolon
id|length
op_assign
id|usb_maxpacket
c_func
(paren
id|umidi-&gt;chip-&gt;dev
comma
id|pipe
comma
l_int|0
)paren
suffix:semicolon
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|snd_usbmidi_in_endpoint_delete
c_func
(paren
id|ep
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|int_epd
)paren
id|usb_fill_int_urb
c_func
(paren
id|ep-&gt;urb
comma
id|umidi-&gt;chip-&gt;dev
comma
id|pipe
comma
id|buffer
comma
id|length
comma
id|snd_usb_complete_callback
c_func
(paren
id|snd_usbmidi_in_urb_complete
)paren
comma
id|ep
comma
id|int_epd-&gt;bInterval
)paren
suffix:semicolon
r_else
id|usb_fill_bulk_urb
c_func
(paren
id|ep-&gt;urb
comma
id|umidi-&gt;chip-&gt;dev
comma
id|pipe
comma
id|buffer
comma
id|length
comma
id|snd_usb_complete_callback
c_func
(paren
id|snd_usbmidi_in_urb_complete
)paren
comma
id|ep
)paren
suffix:semicolon
id|rep-&gt;in
op_assign
id|ep
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usbmidi_count_bits
r_static
r_int
id|snd_usbmidi_count_bits
c_func
(paren
r_uint16
id|x
)paren
(brace
r_int
id|i
comma
id|bits
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
op_increment
id|i
)paren
id|bits
op_add_assign
(paren
id|x
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_ne
l_int|0
suffix:semicolon
r_return
id|bits
suffix:semicolon
)brace
multiline_comment|/*&n; * Frees an output endpoint.&n; * May be called when ep hasn&squot;t been initialized completely.&n; */
DECL|function|snd_usbmidi_out_endpoint_delete
r_static
r_void
id|snd_usbmidi_out_endpoint_delete
c_func
(paren
id|snd_usb_midi_out_endpoint_t
op_star
id|ep
)paren
(brace
r_if
c_cond
(paren
id|ep-&gt;tasklet.func
)paren
id|tasklet_kill
c_func
(paren
op_amp
id|ep-&gt;tasklet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;urb
)paren
(brace
id|kfree
c_func
(paren
id|ep-&gt;urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|ep-&gt;urb
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ep
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Creates an output endpoint, and initializes output ports.&n; */
DECL|function|snd_usbmidi_out_endpoint_create
r_static
r_int
id|snd_usbmidi_out_endpoint_create
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
id|snd_usb_midi_endpoint_info_t
op_star
id|ep_info
comma
id|snd_usb_midi_endpoint_t
op_star
id|rep
)paren
(brace
id|snd_usb_midi_out_endpoint_t
op_star
id|ep
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|pipe
suffix:semicolon
r_void
op_star
id|buffer
suffix:semicolon
id|rep-&gt;out
op_assign
l_int|NULL
suffix:semicolon
id|ep
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|ep
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ep-&gt;umidi
op_assign
id|umidi
suffix:semicolon
id|ep-&gt;urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ep-&gt;urb
)paren
(brace
id|snd_usbmidi_out_endpoint_delete
c_func
(paren
id|ep
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pipe
op_assign
id|usb_sndbulkpipe
c_func
(paren
id|umidi-&gt;chip-&gt;dev
comma
id|ep_info-&gt;out_ep
)paren
suffix:semicolon
id|ep-&gt;max_transfer
op_assign
id|usb_maxpacket
c_func
(paren
id|umidi-&gt;chip-&gt;dev
comma
id|pipe
comma
l_int|1
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|ep-&gt;max_transfer
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|snd_usbmidi_out_endpoint_delete
c_func
(paren
id|ep
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|usb_fill_bulk_urb
c_func
(paren
id|ep-&gt;urb
comma
id|umidi-&gt;chip-&gt;dev
comma
id|pipe
comma
id|buffer
comma
id|ep-&gt;max_transfer
comma
id|snd_usb_complete_callback
c_func
(paren
id|snd_usbmidi_out_urb_complete
)paren
comma
id|ep
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ep-&gt;buffer_lock
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|ep-&gt;tasklet
comma
id|snd_usbmidi_out_tasklet
comma
(paren
r_int
r_int
)paren
id|ep
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x10
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|ep_info-&gt;out_cables
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|ep-&gt;ports
(braket
id|i
)braket
dot
id|ep
op_assign
id|ep
suffix:semicolon
id|ep-&gt;ports
(braket
id|i
)braket
dot
id|cable
op_assign
id|i
op_lshift
l_int|4
suffix:semicolon
)brace
id|rep-&gt;out
op_assign
id|ep
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Frees everything.&n; */
DECL|function|snd_usbmidi_free
r_static
r_void
id|snd_usbmidi_free
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIDI_MAX_ENDPOINTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|snd_usb_midi_endpoint_t
op_star
id|ep
op_assign
op_amp
id|umidi-&gt;endpoints
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;out
)paren
id|snd_usbmidi_out_endpoint_delete
c_func
(paren
id|ep-&gt;out
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;in
)paren
id|snd_usbmidi_in_endpoint_delete
c_func
(paren
id|ep-&gt;in
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|umidi
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Unlinks all URBs (must be done before the usb_device is deleted).&n; */
DECL|function|snd_usbmidi_disconnect
r_void
id|snd_usbmidi_disconnect
c_func
(paren
r_struct
id|list_head
op_star
id|p
comma
r_struct
id|usb_driver
op_star
id|driver
)paren
(brace
id|snd_usb_midi_t
op_star
id|umidi
suffix:semicolon
r_int
id|i
suffix:semicolon
id|umidi
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|snd_usb_midi_t
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIDI_MAX_ENDPOINTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|snd_usb_midi_endpoint_t
op_star
id|ep
op_assign
op_amp
id|umidi-&gt;endpoints
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;out
op_logical_and
id|ep-&gt;out-&gt;urb
)paren
id|usb_kill_urb
c_func
(paren
id|ep-&gt;out-&gt;urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;in
op_logical_and
id|ep-&gt;in-&gt;urb
)paren
id|usb_kill_urb
c_func
(paren
id|ep-&gt;in-&gt;urb
)paren
suffix:semicolon
)brace
)brace
DECL|function|snd_usbmidi_rawmidi_free
r_static
r_void
id|snd_usbmidi_rawmidi_free
c_func
(paren
id|snd_rawmidi_t
op_star
id|rmidi
)paren
(brace
id|snd_usb_midi_t
op_star
id|umidi
op_assign
id|rmidi-&gt;private_data
suffix:semicolon
id|snd_usbmidi_free
c_func
(paren
id|umidi
)paren
suffix:semicolon
)brace
DECL|function|snd_usbmidi_find_substream
r_static
id|snd_rawmidi_substream_t
op_star
id|snd_usbmidi_find_substream
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
r_int
id|stream
comma
r_int
id|number
)paren
(brace
r_struct
id|list_head
op_star
id|list
suffix:semicolon
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|umidi-&gt;rmidi-&gt;streams
(braket
id|stream
)braket
dot
id|substreams
)paren
(brace
id|snd_rawmidi_substream_t
op_star
id|substream
op_assign
id|list_entry
c_func
(paren
id|list
comma
id|snd_rawmidi_substream_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|substream-&gt;number
op_eq
id|number
)paren
r_return
id|substream
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * This list specifies names for ports that do not fit into the standard&n; * &quot;(product) MIDI (n)&quot; schema because they aren&squot;t external MIDI ports,&n; * such as internal control or synthesizer ports.&n; */
r_static
r_struct
(brace
DECL|member|vendor
id|__u16
id|vendor
suffix:semicolon
DECL|member|product
id|__u16
id|product
suffix:semicolon
DECL|member|port
r_int
id|port
suffix:semicolon
DECL|member|name_format
r_const
r_char
op_star
id|name_format
suffix:semicolon
DECL|variable|snd_usbmidi_port_names
)brace
id|snd_usbmidi_port_names
(braket
)braket
op_assign
(brace
multiline_comment|/* Roland UA-100 */
(brace
l_int|0x0582
comma
l_int|0x0000
comma
l_int|2
comma
l_string|&quot;%s Control&quot;
)brace
comma
multiline_comment|/* Roland SC-8850 */
(brace
l_int|0x0582
comma
l_int|0x0003
comma
l_int|0
comma
l_string|&quot;%s Part A&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0003
comma
l_int|1
comma
l_string|&quot;%s Part B&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0003
comma
l_int|2
comma
l_string|&quot;%s Part C&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0003
comma
l_int|3
comma
l_string|&quot;%s Part D&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0003
comma
l_int|4
comma
l_string|&quot;%s MIDI 1&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0003
comma
l_int|5
comma
l_string|&quot;%s MIDI 2&quot;
)brace
comma
multiline_comment|/* Roland U-8 */
(brace
l_int|0x0582
comma
l_int|0x0004
comma
l_int|0
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0004
comma
l_int|1
comma
l_string|&quot;%s Control&quot;
)brace
comma
multiline_comment|/* Roland SC-8820 */
(brace
l_int|0x0582
comma
l_int|0x0007
comma
l_int|0
comma
l_string|&quot;%s Part A&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0007
comma
l_int|1
comma
l_string|&quot;%s Part B&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0007
comma
l_int|2
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
multiline_comment|/* Roland SK-500 */
(brace
l_int|0x0582
comma
l_int|0x000b
comma
l_int|0
comma
l_string|&quot;%s Part A&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x000b
comma
l_int|1
comma
l_string|&quot;%s Part B&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x000b
comma
l_int|2
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
multiline_comment|/* Roland SC-D70 */
(brace
l_int|0x0582
comma
l_int|0x000c
comma
l_int|0
comma
l_string|&quot;%s Part A&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x000c
comma
l_int|1
comma
l_string|&quot;%s Part B&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x000c
comma
l_int|2
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
multiline_comment|/* Edirol UM-880 */
(brace
l_int|0x0582
comma
l_int|0x0014
comma
l_int|8
comma
l_string|&quot;%s Control&quot;
)brace
comma
multiline_comment|/* Edirol SD-90 */
(brace
l_int|0x0582
comma
l_int|0x0016
comma
l_int|0
comma
l_string|&quot;%s Part A&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0016
comma
l_int|1
comma
l_string|&quot;%s Part B&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0016
comma
l_int|2
comma
l_string|&quot;%s MIDI 1&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0016
comma
l_int|3
comma
l_string|&quot;%s MIDI 2&quot;
)brace
comma
multiline_comment|/* Edirol UM-550 */
(brace
l_int|0x0582
comma
l_int|0x0023
comma
l_int|5
comma
l_string|&quot;%s Control&quot;
)brace
comma
multiline_comment|/* Edirol SD-20 */
(brace
l_int|0x0582
comma
l_int|0x0027
comma
l_int|0
comma
l_string|&quot;%s Part A&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0027
comma
l_int|1
comma
l_string|&quot;%s Part B&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0027
comma
l_int|2
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
multiline_comment|/* Edirol SD-80 */
(brace
l_int|0x0582
comma
l_int|0x0029
comma
l_int|0
comma
l_string|&quot;%s Part A&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0029
comma
l_int|1
comma
l_string|&quot;%s Part B&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0029
comma
l_int|2
comma
l_string|&quot;%s MIDI 1&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0029
comma
l_int|3
comma
l_string|&quot;%s MIDI 2&quot;
)brace
comma
multiline_comment|/* Edirol UA-700 */
(brace
l_int|0x0582
comma
l_int|0x002b
comma
l_int|0
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x002b
comma
l_int|1
comma
l_string|&quot;%s Control&quot;
)brace
comma
multiline_comment|/* Roland VariOS */
(brace
l_int|0x0582
comma
l_int|0x002f
comma
l_int|0
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x002f
comma
l_int|1
comma
l_string|&quot;%s External MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x002f
comma
l_int|2
comma
l_string|&quot;%s Sync&quot;
)brace
comma
multiline_comment|/* Edirol PCR */
(brace
l_int|0x0582
comma
l_int|0x0033
comma
l_int|0
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0033
comma
l_int|1
comma
l_string|&quot;%s 1&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0033
comma
l_int|2
comma
l_string|&quot;%s 2&quot;
)brace
comma
multiline_comment|/* BOSS GS-10 */
(brace
l_int|0x0582
comma
l_int|0x003b
comma
l_int|0
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x003b
comma
l_int|1
comma
l_string|&quot;%s Control&quot;
)brace
comma
multiline_comment|/* Edirol UA-1000 */
(brace
l_int|0x0582
comma
l_int|0x0044
comma
l_int|0
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0044
comma
l_int|1
comma
l_string|&quot;%s Control&quot;
)brace
comma
multiline_comment|/* Edirol UR-80 */
(brace
l_int|0x0582
comma
l_int|0x0048
comma
l_int|0
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0048
comma
l_int|1
comma
l_string|&quot;%s 1&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x0048
comma
l_int|2
comma
l_string|&quot;%s 2&quot;
)brace
comma
multiline_comment|/* Edirol PCR-A */
(brace
l_int|0x0582
comma
l_int|0x004d
comma
l_int|0
comma
l_string|&quot;%s MIDI&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x004d
comma
l_int|1
comma
l_string|&quot;%s 1&quot;
)brace
comma
(brace
l_int|0x0582
comma
l_int|0x004d
comma
l_int|2
comma
l_string|&quot;%s 2&quot;
)brace
comma
multiline_comment|/* M-Audio MidiSport 8x8 */
(brace
l_int|0x0763
comma
l_int|0x1031
comma
l_int|8
comma
l_string|&quot;%s Control&quot;
)brace
comma
(brace
l_int|0x0763
comma
l_int|0x1033
comma
l_int|8
comma
l_string|&quot;%s Control&quot;
)brace
comma
)brace
suffix:semicolon
DECL|function|snd_usbmidi_init_substream
r_static
r_void
id|snd_usbmidi_init_substream
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
r_int
id|stream
comma
r_int
id|number
comma
id|snd_rawmidi_substream_t
op_star
op_star
id|rsubstream
)paren
(brace
r_int
id|i
suffix:semicolon
id|__u16
id|vendor
comma
id|product
suffix:semicolon
r_const
r_char
op_star
id|name_format
suffix:semicolon
id|snd_rawmidi_substream_t
op_star
id|substream
op_assign
id|snd_usbmidi_find_substream
c_func
(paren
id|umidi
comma
id|stream
comma
id|number
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|substream
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_ERR
l_string|&quot;substream %d:%d not found&bslash;n&quot;
comma
id|stream
comma
id|number
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* TODO: read port name from jack descriptor */
id|name_format
op_assign
l_string|&quot;%s MIDI %d&quot;
suffix:semicolon
id|vendor
op_assign
id|umidi-&gt;chip-&gt;dev-&gt;descriptor.idVendor
suffix:semicolon
id|product
op_assign
id|umidi-&gt;chip-&gt;dev-&gt;descriptor.idProduct
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|snd_usbmidi_port_names
)paren
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|snd_usbmidi_port_names
(braket
id|i
)braket
dot
id|vendor
op_eq
id|vendor
op_logical_and
id|snd_usbmidi_port_names
(braket
id|i
)braket
dot
id|product
op_eq
id|product
op_logical_and
id|snd_usbmidi_port_names
(braket
id|i
)braket
dot
id|port
op_eq
id|number
)paren
(brace
id|name_format
op_assign
id|snd_usbmidi_port_names
(braket
id|i
)braket
dot
id|name_format
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|snprintf
c_func
(paren
id|substream-&gt;name
comma
r_sizeof
(paren
id|substream-&gt;name
)paren
comma
id|name_format
comma
id|umidi-&gt;chip-&gt;card-&gt;shortname
comma
id|number
op_plus
l_int|1
)paren
suffix:semicolon
op_star
id|rsubstream
op_assign
id|substream
suffix:semicolon
)brace
multiline_comment|/*&n; * Creates the endpoints and their ports.&n; */
DECL|function|snd_usbmidi_create_endpoints
r_static
r_int
id|snd_usbmidi_create_endpoints
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
id|snd_usb_midi_endpoint_info_t
op_star
id|endpoints
)paren
(brace
r_int
id|i
comma
id|j
comma
id|err
suffix:semicolon
r_int
id|out_ports
op_assign
l_int|0
comma
id|in_ports
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIDI_MAX_ENDPOINTS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|endpoints
(braket
id|i
)braket
dot
id|out_cables
)paren
(brace
id|err
op_assign
id|snd_usbmidi_out_endpoint_create
c_func
(paren
id|umidi
comma
op_amp
id|endpoints
(braket
id|i
)braket
comma
op_amp
id|umidi-&gt;endpoints
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|endpoints
(braket
id|i
)braket
dot
id|in_cables
)paren
(brace
id|err
op_assign
id|snd_usbmidi_in_endpoint_create
c_func
(paren
id|umidi
comma
op_amp
id|endpoints
(braket
id|i
)braket
comma
op_amp
id|umidi-&gt;endpoints
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|0x10
suffix:semicolon
op_increment
id|j
)paren
(brace
r_if
c_cond
(paren
id|endpoints
(braket
id|i
)braket
dot
id|out_cables
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|snd_usbmidi_init_substream
c_func
(paren
id|umidi
comma
id|SNDRV_RAWMIDI_STREAM_OUTPUT
comma
id|out_ports
comma
op_amp
id|umidi-&gt;endpoints
(braket
id|i
)braket
dot
id|out-&gt;ports
(braket
id|j
)braket
dot
id|substream
)paren
suffix:semicolon
op_increment
id|out_ports
suffix:semicolon
)brace
r_if
c_cond
(paren
id|endpoints
(braket
id|i
)braket
dot
id|in_cables
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
(brace
id|snd_usbmidi_init_substream
c_func
(paren
id|umidi
comma
id|SNDRV_RAWMIDI_STREAM_INPUT
comma
id|in_ports
comma
op_amp
id|umidi-&gt;endpoints
(braket
id|i
)braket
dot
id|in-&gt;ports
(braket
id|j
)braket
dot
id|substream
)paren
suffix:semicolon
op_increment
id|in_ports
suffix:semicolon
)brace
)brace
)brace
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;created %d output and %d input ports&bslash;n&quot;
comma
id|out_ports
comma
id|in_ports
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns MIDIStreaming device capabilities.&n; */
DECL|function|snd_usbmidi_get_ms_info
r_static
r_int
id|snd_usbmidi_get_ms_info
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
id|snd_usb_midi_endpoint_info_t
op_star
id|endpoints
)paren
(brace
r_struct
id|usb_interface
op_star
id|intf
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|hostif
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|intfd
suffix:semicolon
r_struct
id|usb_ms_header_descriptor
op_star
id|ms_header
suffix:semicolon
r_struct
id|usb_host_endpoint
op_star
id|hostep
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|ep
suffix:semicolon
r_struct
id|usb_ms_endpoint_descriptor
op_star
id|ms_ep
suffix:semicolon
r_int
id|i
comma
id|epidx
suffix:semicolon
id|intf
op_assign
id|umidi-&gt;iface
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intf
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|hostif
op_assign
op_amp
id|intf-&gt;altsetting
(braket
l_int|0
)braket
suffix:semicolon
id|intfd
op_assign
id|get_iface_desc
c_func
(paren
id|hostif
)paren
suffix:semicolon
id|ms_header
op_assign
(paren
r_struct
id|usb_ms_header_descriptor
op_star
)paren
id|hostif-&gt;extra
suffix:semicolon
r_if
c_cond
(paren
id|hostif-&gt;extralen
op_ge
l_int|7
op_logical_and
id|ms_header-&gt;bLength
op_ge
l_int|7
op_logical_and
id|ms_header-&gt;bDescriptorType
op_eq
id|USB_DT_CS_INTERFACE
op_logical_and
id|ms_header-&gt;bDescriptorSubtype
op_eq
id|HEADER
)paren
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;MIDIStreaming version %02x.%02x&bslash;n&quot;
comma
id|ms_header-&gt;bcdMSC
(braket
l_int|1
)braket
comma
id|ms_header-&gt;bcdMSC
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|snd_printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;MIDIStreaming interface descriptor not found&bslash;n&quot;
)paren
suffix:semicolon
id|epidx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|intfd-&gt;bNumEndpoints
suffix:semicolon
op_increment
id|i
)paren
(brace
id|hostep
op_assign
op_amp
id|hostif-&gt;endpoint
(braket
id|i
)braket
suffix:semicolon
id|ep
op_assign
id|get_ep_desc
c_func
(paren
id|hostep
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ep-&gt;bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_BULK
)paren
r_continue
suffix:semicolon
id|ms_ep
op_assign
(paren
r_struct
id|usb_ms_endpoint_descriptor
op_star
)paren
id|hostep-&gt;extra
suffix:semicolon
r_if
c_cond
(paren
id|hostep-&gt;extralen
OL
l_int|4
op_logical_or
id|ms_ep-&gt;bLength
OL
l_int|4
op_logical_or
id|ms_ep-&gt;bDescriptorType
op_ne
id|USB_DT_CS_ENDPOINT
op_logical_or
id|ms_ep-&gt;bDescriptorSubtype
op_ne
id|MS_GENERAL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_DIR_MASK
)paren
op_eq
id|USB_DIR_OUT
)paren
(brace
r_if
c_cond
(paren
id|endpoints
(braket
id|epidx
)braket
dot
id|out_ep
)paren
(brace
r_if
c_cond
(paren
op_increment
id|epidx
op_ge
id|MIDI_MAX_ENDPOINTS
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;too many endpoints&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|endpoints
(braket
id|epidx
)braket
dot
id|out_ep
op_assign
id|ep-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_NUMBER_MASK
suffix:semicolon
id|endpoints
(braket
id|epidx
)braket
dot
id|out_cables
op_assign
(paren
l_int|1
op_lshift
id|ms_ep-&gt;bNumEmbMIDIJack
)paren
op_minus
l_int|1
suffix:semicolon
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;EP %02X: %d jack(s)&bslash;n&quot;
comma
id|ep-&gt;bEndpointAddress
comma
id|ms_ep-&gt;bNumEmbMIDIJack
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|endpoints
(braket
id|epidx
)braket
dot
id|in_ep
)paren
(brace
r_if
c_cond
(paren
op_increment
id|epidx
op_ge
id|MIDI_MAX_ENDPOINTS
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;too many endpoints&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|endpoints
(braket
id|epidx
)braket
dot
id|in_ep
op_assign
id|ep-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_NUMBER_MASK
suffix:semicolon
id|endpoints
(braket
id|epidx
)braket
dot
id|in_cables
op_assign
(paren
l_int|1
op_lshift
id|ms_ep-&gt;bNumEmbMIDIJack
)paren
op_minus
l_int|1
suffix:semicolon
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;EP %02X: %d jack(s)&bslash;n&quot;
comma
id|ep-&gt;bEndpointAddress
comma
id|ms_ep-&gt;bNumEmbMIDIJack
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * If the endpoints aren&squot;t specified, use the first bulk endpoints in the&n; * first alternate setting of the interface.&n; */
DECL|function|snd_usbmidi_detect_endpoint
r_static
r_int
id|snd_usbmidi_detect_endpoint
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
id|snd_usb_midi_endpoint_info_t
op_star
id|endpoint
)paren
(brace
r_struct
id|usb_interface
op_star
id|intf
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|hostif
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|intfd
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|epd
suffix:semicolon
r_int
id|i
suffix:semicolon
id|intf
op_assign
id|umidi-&gt;iface
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intf
op_logical_or
id|intf-&gt;num_altsetting
OL
l_int|1
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|hostif
op_assign
id|intf-&gt;altsetting
suffix:semicolon
id|intfd
op_assign
id|get_iface_desc
c_func
(paren
id|hostif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intfd-&gt;bNumEndpoints
OL
l_int|1
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|intfd-&gt;bNumEndpoints
suffix:semicolon
op_increment
id|i
)paren
(brace
id|epd
op_assign
id|get_endpoint
c_func
(paren
id|hostif
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|epd-&gt;bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_BULK
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|endpoint-&gt;out_ep
op_logical_and
id|endpoint-&gt;out_cables
op_logical_and
(paren
id|epd-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_DIR_MASK
)paren
op_eq
id|USB_DIR_OUT
)paren
id|endpoint-&gt;out_ep
op_assign
id|epd-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_NUMBER_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|endpoint-&gt;in_ep
op_logical_and
id|endpoint-&gt;in_cables
op_logical_and
(paren
id|epd-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_DIR_MASK
)paren
op_eq
id|USB_DIR_IN
)paren
id|endpoint-&gt;in_ep
op_assign
id|epd-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_NUMBER_MASK
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Detects the endpoints and ports of Yamaha devices.&n; */
DECL|function|snd_usbmidi_detect_yamaha
r_static
r_int
id|snd_usbmidi_detect_yamaha
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
id|snd_usb_midi_endpoint_info_t
op_star
id|endpoint
)paren
(brace
r_struct
id|usb_interface
op_star
id|intf
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|hostif
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|intfd
suffix:semicolon
r_uint8
op_star
id|cs_desc
suffix:semicolon
id|intf
op_assign
id|umidi-&gt;iface
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intf
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|hostif
op_assign
id|intf-&gt;altsetting
suffix:semicolon
id|intfd
op_assign
id|get_iface_desc
c_func
(paren
id|hostif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intfd-&gt;bNumEndpoints
OL
l_int|1
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
multiline_comment|/*&n;&t; * For each port there is one MIDI_IN/OUT_JACK descriptor, not&n;&t; * necessarily with any useful contents.  So simply count &squot;em.&n;&t; */
r_for
c_loop
(paren
id|cs_desc
op_assign
id|hostif-&gt;extra
suffix:semicolon
id|cs_desc
OL
id|hostif-&gt;extra
op_plus
id|hostif-&gt;extralen
op_logical_and
id|cs_desc
(braket
l_int|0
)braket
op_ge
l_int|2
suffix:semicolon
id|cs_desc
op_add_assign
id|cs_desc
(braket
l_int|0
)braket
)paren
(brace
r_if
c_cond
(paren
id|cs_desc
(braket
l_int|1
)braket
op_eq
id|CS_AUDIO_INTERFACE
)paren
(brace
r_if
c_cond
(paren
id|cs_desc
(braket
l_int|2
)braket
op_eq
id|MIDI_IN_JACK
)paren
id|endpoint-&gt;in_cables
op_assign
(paren
id|endpoint-&gt;in_cables
op_lshift
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cs_desc
(braket
l_int|2
)braket
op_eq
id|MIDI_OUT_JACK
)paren
id|endpoint-&gt;out_cables
op_assign
(paren
id|endpoint-&gt;out_cables
op_lshift
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|endpoint-&gt;in_cables
op_logical_and
op_logical_neg
id|endpoint-&gt;out_cables
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_return
id|snd_usbmidi_detect_endpoint
c_func
(paren
id|umidi
comma
id|endpoint
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Creates the endpoints and their ports for Midiman devices.&n; */
DECL|function|snd_usbmidi_create_endpoints_midiman
r_static
r_int
id|snd_usbmidi_create_endpoints_midiman
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
id|snd_usb_midi_endpoint_info_t
op_star
id|endpoint
)paren
(brace
id|snd_usb_midi_endpoint_info_t
id|ep_info
suffix:semicolon
r_struct
id|usb_interface
op_star
id|intf
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|hostif
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|intfd
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|epd
suffix:semicolon
r_int
id|cable
comma
id|err
suffix:semicolon
id|intf
op_assign
id|umidi-&gt;iface
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intf
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|hostif
op_assign
id|intf-&gt;altsetting
suffix:semicolon
id|intfd
op_assign
id|get_iface_desc
c_func
(paren
id|hostif
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The various MidiSport devices have more or less random endpoint&n;&t; * numbers, so we have to identify the endpoints by their index in&n;&t; * the descriptor array, like the driver for that other OS does.&n;&t; *&n;&t; * There is one interrupt input endpoint for all input ports, one&n;&t; * bulk output endpoint for even-numbered ports, and one for odd-&n;&t; * numbered ports.  Both bulk output endpoints have corresponding&n;&t; * input bulk endpoints (at indices 1 and 3) which aren&squot;t used.&n;&t; */
r_if
c_cond
(paren
id|intfd-&gt;bNumEndpoints
OL
(paren
id|endpoint-&gt;out_cables
OG
l_int|0x0001
ques
c_cond
l_int|5
suffix:colon
l_int|3
)paren
)paren
(brace
id|snd_printdd
c_func
(paren
id|KERN_ERR
l_string|&quot;not enough endpoints&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|epd
op_assign
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|epd-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_DIR_MASK
)paren
op_ne
id|USB_DIR_IN
op_logical_or
(paren
id|epd-&gt;bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_INT
)paren
(brace
id|snd_printdd
c_func
(paren
id|KERN_ERR
l_string|&quot;endpoint[0] isn&squot;t interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|epd
op_assign
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|epd-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_DIR_MASK
)paren
op_ne
id|USB_DIR_OUT
op_logical_or
(paren
id|epd-&gt;bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_BULK
)paren
(brace
id|snd_printdd
c_func
(paren
id|KERN_ERR
l_string|&quot;endpoint[2] isn&squot;t bulk output&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|endpoint-&gt;out_cables
OG
l_int|0x0001
)paren
(brace
id|epd
op_assign
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|epd-&gt;bEndpointAddress
op_amp
id|USB_ENDPOINT_DIR_MASK
)paren
op_ne
id|USB_DIR_OUT
op_logical_or
(paren
id|epd-&gt;bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_ne
id|USB_ENDPOINT_XFER_BULK
)paren
(brace
id|snd_printdd
c_func
(paren
id|KERN_ERR
l_string|&quot;endpoint[4] isn&squot;t bulk output&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
id|ep_info.out_ep
op_assign
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|2
)paren
op_member_access_from_pointer
id|bEndpointAddress
op_amp
id|USB_ENDPOINT_NUMBER_MASK
suffix:semicolon
id|ep_info.out_cables
op_assign
id|endpoint-&gt;out_cables
op_amp
l_int|0x5555
suffix:semicolon
id|err
op_assign
id|snd_usbmidi_out_endpoint_create
c_func
(paren
id|umidi
comma
op_amp
id|ep_info
comma
op_amp
id|umidi-&gt;endpoints
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|ep_info.in_ep
op_assign
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|0
)paren
op_member_access_from_pointer
id|bEndpointAddress
op_amp
id|USB_ENDPOINT_NUMBER_MASK
suffix:semicolon
id|ep_info.in_cables
op_assign
id|endpoint-&gt;in_cables
suffix:semicolon
id|err
op_assign
id|snd_usbmidi_in_endpoint_create
c_func
(paren
id|umidi
comma
op_amp
id|ep_info
comma
op_amp
id|umidi-&gt;endpoints
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|umidi-&gt;endpoints
(braket
l_int|0
)braket
dot
id|in-&gt;urb-&gt;complete
op_assign
id|snd_usb_complete_callback
c_func
(paren
id|snd_usbmidi_in_midiman_complete
)paren
suffix:semicolon
r_if
c_cond
(paren
id|endpoint-&gt;out_cables
OG
l_int|0x0001
)paren
(brace
id|ep_info.out_ep
op_assign
id|get_endpoint
c_func
(paren
id|hostif
comma
l_int|4
)paren
op_member_access_from_pointer
id|bEndpointAddress
op_amp
id|USB_ENDPOINT_NUMBER_MASK
suffix:semicolon
id|ep_info.out_cables
op_assign
id|endpoint-&gt;out_cables
op_amp
l_int|0xaaaa
suffix:semicolon
id|err
op_assign
id|snd_usbmidi_out_endpoint_create
c_func
(paren
id|umidi
comma
op_amp
id|ep_info
comma
op_amp
id|umidi-&gt;endpoints
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_for
c_loop
(paren
id|cable
op_assign
l_int|0
suffix:semicolon
id|cable
OL
l_int|0x10
suffix:semicolon
op_increment
id|cable
)paren
(brace
r_if
c_cond
(paren
id|endpoint-&gt;out_cables
op_amp
(paren
l_int|1
op_lshift
id|cable
)paren
)paren
id|snd_usbmidi_init_substream
c_func
(paren
id|umidi
comma
id|SNDRV_RAWMIDI_STREAM_OUTPUT
comma
id|cable
comma
op_amp
id|umidi-&gt;endpoints
(braket
id|cable
op_amp
l_int|1
)braket
dot
id|out-&gt;ports
(braket
id|cable
)braket
dot
id|substream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|endpoint-&gt;in_cables
op_amp
(paren
l_int|1
op_lshift
id|cable
)paren
)paren
id|snd_usbmidi_init_substream
c_func
(paren
id|umidi
comma
id|SNDRV_RAWMIDI_STREAM_INPUT
comma
id|cable
comma
op_amp
id|umidi-&gt;endpoints
(braket
l_int|0
)braket
dot
id|in-&gt;ports
(braket
id|cable
)braket
dot
id|substream
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_usbmidi_create_rawmidi
r_static
r_int
id|snd_usbmidi_create_rawmidi
c_func
(paren
id|snd_usb_midi_t
op_star
id|umidi
comma
r_int
id|out_ports
comma
r_int
id|in_ports
)paren
(brace
id|snd_rawmidi_t
op_star
id|rmidi
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|snd_rawmidi_new
c_func
(paren
id|umidi-&gt;chip-&gt;card
comma
l_string|&quot;USB MIDI&quot;
comma
id|umidi-&gt;chip-&gt;next_midi_device
op_increment
comma
id|out_ports
comma
id|in_ports
comma
op_amp
id|rmidi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|strcpy
c_func
(paren
id|rmidi-&gt;name
comma
id|umidi-&gt;chip-&gt;card-&gt;shortname
)paren
suffix:semicolon
id|rmidi-&gt;info_flags
op_assign
id|SNDRV_RAWMIDI_INFO_OUTPUT
op_or
id|SNDRV_RAWMIDI_INFO_INPUT
op_or
id|SNDRV_RAWMIDI_INFO_DUPLEX
suffix:semicolon
id|rmidi-&gt;private_data
op_assign
id|umidi
suffix:semicolon
id|rmidi-&gt;private_free
op_assign
id|snd_usbmidi_rawmidi_free
suffix:semicolon
id|snd_rawmidi_set_ops
c_func
(paren
id|rmidi
comma
id|SNDRV_RAWMIDI_STREAM_OUTPUT
comma
op_amp
id|snd_usbmidi_output_ops
)paren
suffix:semicolon
id|snd_rawmidi_set_ops
c_func
(paren
id|rmidi
comma
id|SNDRV_RAWMIDI_STREAM_INPUT
comma
op_amp
id|snd_usbmidi_input_ops
)paren
suffix:semicolon
id|umidi-&gt;rmidi
op_assign
id|rmidi
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Temporarily stop input.&n; */
DECL|function|snd_usbmidi_input_stop
r_void
id|snd_usbmidi_input_stop
c_func
(paren
r_struct
id|list_head
op_star
id|p
)paren
(brace
id|snd_usb_midi_t
op_star
id|umidi
suffix:semicolon
r_int
id|i
suffix:semicolon
id|umidi
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|snd_usb_midi_t
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIDI_MAX_ENDPOINTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|snd_usb_midi_endpoint_t
op_star
id|ep
op_assign
op_amp
id|umidi-&gt;endpoints
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;in
)paren
id|usb_kill_urb
c_func
(paren
id|ep-&gt;in-&gt;urb
)paren
suffix:semicolon
)brace
)brace
DECL|function|snd_usbmidi_input_start_ep
r_static
r_void
id|snd_usbmidi_input_start_ep
c_func
(paren
id|snd_usb_midi_in_endpoint_t
op_star
id|ep
)paren
(brace
r_if
c_cond
(paren
id|ep
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|ep-&gt;urb
suffix:semicolon
id|urb-&gt;dev
op_assign
id|ep-&gt;umidi-&gt;chip-&gt;dev
suffix:semicolon
id|snd_usbmidi_submit_urb
c_func
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Resume input after a call to snd_usbmidi_input_stop().&n; */
DECL|function|snd_usbmidi_input_start
r_void
id|snd_usbmidi_input_start
c_func
(paren
r_struct
id|list_head
op_star
id|p
)paren
(brace
id|snd_usb_midi_t
op_star
id|umidi
suffix:semicolon
r_int
id|i
suffix:semicolon
id|umidi
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|snd_usb_midi_t
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIDI_MAX_ENDPOINTS
suffix:semicolon
op_increment
id|i
)paren
id|snd_usbmidi_input_start_ep
c_func
(paren
id|umidi-&gt;endpoints
(braket
id|i
)braket
dot
id|in
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Creates and registers everything needed for a MIDI streaming interface.&n; */
DECL|function|snd_usb_create_midi_interface
r_int
id|snd_usb_create_midi_interface
c_func
(paren
id|snd_usb_audio_t
op_star
id|chip
comma
r_struct
id|usb_interface
op_star
id|iface
comma
r_const
id|snd_usb_audio_quirk_t
op_star
id|quirk
)paren
(brace
id|snd_usb_midi_t
op_star
id|umidi
suffix:semicolon
id|snd_usb_midi_endpoint_info_t
id|endpoints
(braket
id|MIDI_MAX_ENDPOINTS
)braket
suffix:semicolon
r_int
id|out_ports
comma
id|in_ports
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
id|umidi
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|umidi
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|umidi
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|umidi-&gt;chip
op_assign
id|chip
suffix:semicolon
id|umidi-&gt;iface
op_assign
id|iface
suffix:semicolon
id|umidi-&gt;quirk
op_assign
id|quirk
suffix:semicolon
multiline_comment|/* detect the endpoint(s) to use */
id|memset
c_func
(paren
id|endpoints
comma
l_int|0
comma
r_sizeof
(paren
id|endpoints
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|quirk
)paren
(brace
id|err
op_assign
id|snd_usbmidi_get_ms_info
c_func
(paren
id|umidi
comma
id|endpoints
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|quirk-&gt;type
)paren
(brace
r_case
id|QUIRK_MIDI_FIXED_ENDPOINT
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|endpoints
(braket
l_int|0
)braket
comma
id|quirk-&gt;data
comma
r_sizeof
(paren
id|snd_usb_midi_endpoint_info_t
)paren
)paren
suffix:semicolon
id|err
op_assign
id|snd_usbmidi_detect_endpoint
c_func
(paren
id|umidi
comma
op_amp
id|endpoints
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|QUIRK_MIDI_YAMAHA
suffix:colon
id|err
op_assign
id|snd_usbmidi_detect_yamaha
c_func
(paren
id|umidi
comma
op_amp
id|endpoints
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|QUIRK_MIDI_MIDIMAN
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|endpoints
(braket
l_int|0
)braket
comma
id|quirk-&gt;data
comma
r_sizeof
(paren
id|snd_usb_midi_endpoint_info_t
)paren
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|snd_printd
c_func
(paren
id|KERN_ERR
l_string|&quot;invalid quirk type %d&bslash;n&quot;
comma
id|quirk-&gt;type
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|umidi
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* create rawmidi device */
id|out_ports
op_assign
l_int|0
suffix:semicolon
id|in_ports
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIDI_MAX_ENDPOINTS
suffix:semicolon
op_increment
id|i
)paren
(brace
id|out_ports
op_add_assign
id|snd_usbmidi_count_bits
c_func
(paren
id|endpoints
(braket
id|i
)braket
dot
id|out_cables
)paren
suffix:semicolon
id|in_ports
op_add_assign
id|snd_usbmidi_count_bits
c_func
(paren
id|endpoints
(braket
id|i
)braket
dot
id|in_cables
)paren
suffix:semicolon
)brace
id|err
op_assign
id|snd_usbmidi_create_rawmidi
c_func
(paren
id|umidi
comma
id|out_ports
comma
id|in_ports
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|umidi
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* create endpoint/port structures */
r_if
c_cond
(paren
id|quirk
op_logical_and
id|quirk-&gt;type
op_eq
id|QUIRK_MIDI_MIDIMAN
)paren
id|err
op_assign
id|snd_usbmidi_create_endpoints_midiman
c_func
(paren
id|umidi
comma
op_amp
id|endpoints
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|err
op_assign
id|snd_usbmidi_create_endpoints
c_func
(paren
id|umidi
comma
id|endpoints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_usbmidi_free
c_func
(paren
id|umidi
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|umidi-&gt;list
comma
op_amp
id|umidi-&gt;chip-&gt;midi_list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MIDI_MAX_ENDPOINTS
suffix:semicolon
op_increment
id|i
)paren
id|snd_usbmidi_input_start_ep
c_func
(paren
id|umidi-&gt;endpoints
(braket
id|i
)braket
dot
id|in
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|snd_usb_create_midi_interface
id|EXPORT_SYMBOL
c_func
(paren
id|snd_usb_create_midi_interface
)paren
suffix:semicolon
DECL|variable|snd_usbmidi_input_stop
id|EXPORT_SYMBOL
c_func
(paren
id|snd_usbmidi_input_stop
)paren
suffix:semicolon
DECL|variable|snd_usbmidi_input_start
id|EXPORT_SYMBOL
c_func
(paren
id|snd_usbmidi_input_start
)paren
suffix:semicolon
DECL|variable|snd_usbmidi_disconnect
id|EXPORT_SYMBOL
c_func
(paren
id|snd_usbmidi_disconnect
)paren
suffix:semicolon
eof
