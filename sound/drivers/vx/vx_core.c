multiline_comment|/*&n; * Driver for Digigram VX soundcards&n; *&n; * Hardware core part&n; *&n; * Copyright (c) 2002 by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/pcm.h&gt;
macro_line|#include &lt;sound/asoundef.h&gt;
macro_line|#include &lt;sound/info.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;sound/vx_core.h&gt;
macro_line|#include &quot;vx_cmd.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Takashi Iwai &lt;tiwai@suse.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Common routines for Digigram VX drivers&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * snd_vx_delay - delay for the specified time&n; * @xmsec: the time to delay in msec&n; */
DECL|function|snd_vx_delay
r_void
id|snd_vx_delay
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_int
id|xmsec
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
op_logical_and
id|xmsec
op_ge
l_int|1000
op_div
id|HZ
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
(paren
id|xmsec
op_star
id|HZ
op_plus
l_int|999
)paren
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_else
(brace
id|mdelay
c_func
(paren
id|xmsec
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * vx_check_reg_bit - wait for the specified bit is set/reset on a register&n; * @reg: register to check&n; * @mask: bit mask&n; * @bit: resultant bit to be checked&n; * @time: time-out of loop in msec&n; *&n; * returns zero if a bit matches, or a negative error code.&n; */
DECL|function|snd_vx_check_reg_bit
r_int
id|snd_vx_check_reg_bit
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_int
id|reg
comma
r_int
id|mask
comma
r_int
id|bit
comma
r_int
id|time
)paren
(brace
r_int
r_int
id|end_time
op_assign
id|jiffies
op_plus
(paren
id|time
op_star
id|HZ
op_plus
l_int|999
)paren
op_div
l_int|1000
suffix:semicolon
macro_line|#ifdef CONFIG_SND_DEBUG
r_static
r_char
op_star
id|reg_names
(braket
id|VX_REG_MAX
)braket
op_assign
(brace
l_string|&quot;ICR&quot;
comma
l_string|&quot;CVR&quot;
comma
l_string|&quot;ISR&quot;
comma
l_string|&quot;IVR&quot;
comma
l_string|&quot;RXH&quot;
comma
l_string|&quot;RXM&quot;
comma
l_string|&quot;RXL&quot;
comma
l_string|&quot;DMA&quot;
comma
l_string|&quot;CDSP&quot;
comma
l_string|&quot;RFREQ&quot;
comma
l_string|&quot;RUER/V2&quot;
comma
l_string|&quot;DATA&quot;
comma
l_string|&quot;MEMIRQ&quot;
comma
l_string|&quot;ACQ&quot;
comma
l_string|&quot;BIT0&quot;
comma
l_string|&quot;BIT1&quot;
comma
l_string|&quot;MIC0&quot;
comma
l_string|&quot;MIC1&quot;
comma
l_string|&quot;MIC2&quot;
comma
l_string|&quot;MIC3&quot;
comma
l_string|&quot;INTCSR&quot;
comma
l_string|&quot;CNTRL&quot;
comma
l_string|&quot;GPIOC&quot;
comma
l_string|&quot;LOFREQ&quot;
comma
l_string|&quot;HIFREQ&quot;
comma
l_string|&quot;CSUER&quot;
comma
l_string|&quot;RUER&quot;
)brace
suffix:semicolon
macro_line|#endif
r_do
(brace
r_if
c_cond
(paren
(paren
id|snd_vx_inb
c_func
(paren
id|chip
comma
id|reg
)paren
op_amp
id|mask
)paren
op_eq
id|bit
)paren
r_return
l_int|0
suffix:semicolon
singleline_comment|//snd_vx_delay(chip, 10);
)brace
r_while
c_loop
(paren
id|time_after_eq
c_func
(paren
id|end_time
comma
id|jiffies
)paren
)paren
suffix:semicolon
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vx_check_reg_bit: timeout, reg=%s, mask=0x%x, val=0x%x&bslash;n&quot;
comma
id|reg_names
(braket
id|reg
)braket
comma
id|mask
comma
id|snd_vx_inb
c_func
(paren
id|chip
comma
id|reg
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_send_irq_dsp - set command irq bit&n; * @num: the requested IRQ type, IRQ_XXX&n; *&n; * this triggers the specified IRQ request&n; * returns 0 if successful, or a negative error code.&n; * &n; */
DECL|function|vx_send_irq_dsp
r_static
r_int
id|vx_send_irq_dsp
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_int
id|num
)paren
(brace
r_int
id|nirq
suffix:semicolon
multiline_comment|/* wait for Hc = 0 */
r_if
c_cond
(paren
id|snd_vx_check_reg_bit
c_func
(paren
id|chip
comma
id|VX_CVR
comma
id|CVR_HC
comma
l_int|0
comma
l_int|200
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|nirq
op_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
id|vx_has_new_dsp
c_func
(paren
id|chip
)paren
)paren
id|nirq
op_add_assign
id|VXP_IRQ_OFFSET
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|CVR
comma
(paren
id|nirq
op_rshift
l_int|1
)paren
op_or
id|CVR_HC
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_reset_chk - reset CHK bit on ISR&n; *&n; * returns 0 if successful, or a negative error code.&n; */
DECL|function|vx_reset_chk
r_static
r_int
id|vx_reset_chk
c_func
(paren
id|vx_core_t
op_star
id|chip
)paren
(brace
multiline_comment|/* Reset irq CHK */
r_if
c_cond
(paren
id|vx_send_irq_dsp
c_func
(paren
id|chip
comma
id|IRQ_RESET_CHK
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Wait until CHK = 0 */
r_if
c_cond
(paren
id|vx_check_isr
c_func
(paren
id|chip
comma
id|ISR_CHK
comma
l_int|0
comma
l_int|200
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_transfer_end - terminate message transfer&n; * @cmd: IRQ message to send (IRQ_MESS_XXX_END)&n; *&n; * returns 0 if successful, or a negative error code.&n; * the error code can be VX-specific, retrieved via vx_get_error().&n; * NB: call with spinlock held!&n; */
DECL|function|vx_transfer_end
r_static
r_int
id|vx_transfer_end
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_int
id|cmd
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_reset_chk
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* irq MESS_READ/WRITE_END */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_send_irq_dsp
c_func
(paren
id|chip
comma
id|cmd
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Wait CHK = 1 */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_CHK
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* If error, Read RX */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|ISR
)paren
)paren
op_amp
id|ISR_ERR
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_for_rx_full
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;transfer_end: error in rx_full&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXH
)paren
op_lshift
l_int|16
suffix:semicolon
id|err
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXM
)paren
op_lshift
l_int|8
suffix:semicolon
id|err
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXL
)paren
suffix:semicolon
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;transfer_end: error = 0x%x&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
op_minus
(paren
id|VX_ERR_MASK
op_or
id|err
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_read_status - return the status rmh&n; * @rmh: rmh record to store the status&n; *&n; * returns 0 if successful, or a negative error code.&n; * the error code can be VX-specific, retrieved via vx_get_error().&n; * NB: call with spinlock held!&n; */
DECL|function|vx_read_status
r_static
r_int
id|vx_read_status
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_struct
id|vx_rmh
op_star
id|rmh
)paren
(brace
r_int
id|i
comma
id|err
comma
id|val
comma
id|size
suffix:semicolon
multiline_comment|/* no read necessary? */
r_if
c_cond
(paren
id|rmh-&gt;DspStat
op_eq
id|RMH_SSIZE_FIXED
op_logical_and
id|rmh-&gt;LgStat
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Wait for RX full (with timeout protection)&n;&t; * The first word of status is in RX&n;&t; */
id|err
op_assign
id|vx_wait_for_rx_full
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Read RX */
id|val
op_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXH
)paren
op_lshift
l_int|16
suffix:semicolon
id|val
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXM
)paren
op_lshift
l_int|8
suffix:semicolon
id|val
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXL
)paren
suffix:semicolon
multiline_comment|/* If status given by DSP, let&squot;s decode its size */
r_switch
c_cond
(paren
id|rmh-&gt;DspStat
)paren
(brace
r_case
id|RMH_SSIZE_ARG
suffix:colon
id|size
op_assign
id|val
op_amp
l_int|0xff
suffix:semicolon
id|rmh-&gt;Stat
(braket
l_int|0
)braket
op_assign
id|val
op_amp
l_int|0xffff00
suffix:semicolon
id|rmh-&gt;LgStat
op_assign
id|size
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RMH_SSIZE_MASK
suffix:colon
multiline_comment|/* Let&squot;s count the arg numbers from a mask */
id|rmh-&gt;Stat
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|val
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
l_int|0x01
)paren
id|size
op_increment
suffix:semicolon
id|val
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|rmh-&gt;LgStat
op_assign
id|size
op_plus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* else retrieve the status length given by the driver */
id|size
op_assign
id|rmh-&gt;LgStat
suffix:semicolon
id|rmh-&gt;Stat
(braket
l_int|0
)braket
op_assign
id|val
suffix:semicolon
multiline_comment|/* Val is the status 1st word */
id|size
op_decrement
suffix:semicolon
multiline_comment|/* hence adjust remaining length */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OL
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
id|snd_assert
c_func
(paren
id|size
op_le
id|SIZE_MAX_STATUS
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* trigger an irq MESS_WRITE_NEXT */
id|err
op_assign
id|vx_send_irq_dsp
c_func
(paren
id|chip
comma
id|IRQ_MESS_WRITE_NEXT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Wait for RX full (with timeout protection) */
id|err
op_assign
id|vx_wait_for_rx_full
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|rmh-&gt;Stat
(braket
id|i
)braket
op_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXH
)paren
op_lshift
l_int|16
suffix:semicolon
id|rmh-&gt;Stat
(braket
id|i
)braket
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXM
)paren
op_lshift
l_int|8
suffix:semicolon
id|rmh-&gt;Stat
(braket
id|i
)braket
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXL
)paren
suffix:semicolon
)brace
r_return
id|vx_transfer_end
c_func
(paren
id|chip
comma
id|IRQ_MESS_WRITE_END
)paren
suffix:semicolon
)brace
DECL|macro|MASK_MORE_THAN_1_WORD_COMMAND
mdefine_line|#define MASK_MORE_THAN_1_WORD_COMMAND   0x00008000
DECL|macro|MASK_1_WORD_COMMAND
mdefine_line|#define MASK_1_WORD_COMMAND             0x00ff7fff
multiline_comment|/*&n; * vx_send_msg_nolock - send a DSP message and read back the status&n; * @rmh: the rmh record to send and receive&n; *&n; * returns 0 if successful, or a negative error code.&n; * the error code can be VX-specific, retrieved via vx_get_error().&n; * &n; * this function doesn&squot;t call spinlock at all.&n; */
DECL|function|vx_send_msg_nolock
r_int
id|vx_send_msg_nolock
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_struct
id|vx_rmh
op_star
id|rmh
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;chip_status
op_amp
id|VX_STAT_IS_STALE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_reset_chk
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vx_send_msg: vx_reset_chk error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;rmh: cmd = 0x%06x, length = %d, stype = %d&bslash;n&quot;
comma
id|rmh-&gt;Cmd
(braket
l_int|0
)braket
comma
id|rmh-&gt;LgCmd
comma
id|rmh-&gt;DspStat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rmh-&gt;LgCmd
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|rmh-&gt;LgCmd
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;0x%06x &quot;
comma
id|rmh-&gt;Cmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Check bit M is set according to length of the command */
r_if
c_cond
(paren
id|rmh-&gt;LgCmd
OG
l_int|1
)paren
id|rmh-&gt;Cmd
(braket
l_int|0
)braket
op_or_assign
id|MASK_MORE_THAN_1_WORD_COMMAND
suffix:semicolon
r_else
id|rmh-&gt;Cmd
(braket
l_int|0
)braket
op_and_assign
id|MASK_1_WORD_COMMAND
suffix:semicolon
multiline_comment|/* Wait for TX empty */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_TX_EMPTY
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vx_send_msg: wait tx empty error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Write Cmd[0] */
id|vx_outb
c_func
(paren
id|chip
comma
id|TXH
comma
(paren
id|rmh-&gt;Cmd
(braket
l_int|0
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXM
comma
(paren
id|rmh-&gt;Cmd
(braket
l_int|0
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXL
comma
id|rmh-&gt;Cmd
(braket
l_int|0
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Trigger irq MESSAGE */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_send_irq_dsp
c_func
(paren
id|chip
comma
id|IRQ_MESSAGE
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vx_send_msg: send IRQ_MESSAGE error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Wait for CHK = 1 */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_CHK
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* If error, get error value from RX */
r_if
c_cond
(paren
id|vx_inb
c_func
(paren
id|chip
comma
id|ISR
)paren
op_amp
id|ISR_ERR
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_for_rx_full
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vx_send_msg: rx_full read error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXH
)paren
op_lshift
l_int|16
suffix:semicolon
id|err
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXM
)paren
op_lshift
l_int|8
suffix:semicolon
id|err
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXL
)paren
suffix:semicolon
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;msg got error = 0x%x at cmd[0]&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|err
op_assign
op_minus
(paren
id|VX_ERR_MASK
op_or
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Send the other words */
r_if
c_cond
(paren
id|rmh-&gt;LgCmd
OG
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|rmh-&gt;LgCmd
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Wait for TX ready */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_TX_READY
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vx_send_msg: tx_ready error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Write Cmd[i] */
id|vx_outb
c_func
(paren
id|chip
comma
id|TXH
comma
(paren
id|rmh-&gt;Cmd
(braket
id|i
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXM
comma
(paren
id|rmh-&gt;Cmd
(braket
id|i
)braket
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXL
comma
id|rmh-&gt;Cmd
(braket
id|i
)braket
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Trigger irq MESS_READ_NEXT */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_send_irq_dsp
c_func
(paren
id|chip
comma
id|IRQ_MESS_READ_NEXT
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vx_send_msg: IRQ_READ_NEXT error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
multiline_comment|/* Wait for TX empty */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_TX_READY
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;vx_send_msg: TX_READY error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* End of transfer */
id|err
op_assign
id|vx_transfer_end
c_func
(paren
id|chip
comma
id|IRQ_MESS_READ_END
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_return
id|vx_read_status
c_func
(paren
id|chip
comma
id|rmh
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_send_msg - send a DSP message with spinlock&n; * @rmh: the rmh record to send and receive&n; *&n; * returns 0 if successful, or a negative error code.&n; * see vx_send_msg_nolock().&n; */
DECL|function|vx_send_msg
r_int
id|vx_send_msg
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_struct
id|vx_rmh
op_star
id|rmh
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|err
op_assign
id|vx_send_msg_nolock
c_func
(paren
id|chip
comma
id|rmh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_send_rih_nolock - send an RIH to xilinx&n; * @cmd: the command to send&n; *&n; * returns 0 if successful, or a negative error code.&n; * the error code can be VX-specific, retrieved via vx_get_error().&n; *&n; * this function doesn&squot;t call spinlock at all.&n; *&n; * unlike RMH, no command is sent to DSP.&n; */
DECL|function|vx_send_rih_nolock
r_int
id|vx_send_rih_nolock
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_int
id|cmd
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;chip_status
op_amp
id|VX_STAT_IS_STALE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;send_rih: cmd = 0x%x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_reset_chk
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* send the IRQ */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_send_irq_dsp
c_func
(paren
id|chip
comma
id|cmd
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Wait CHK = 1 */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_CHK
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* If error, read RX */
r_if
c_cond
(paren
id|vx_inb
c_func
(paren
id|chip
comma
id|ISR
)paren
op_amp
id|ISR_ERR
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_for_rx_full
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|err
op_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXH
)paren
op_lshift
l_int|16
suffix:semicolon
id|err
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXM
)paren
op_lshift
l_int|8
suffix:semicolon
id|err
op_or_assign
id|vx_inb
c_func
(paren
id|chip
comma
id|RXL
)paren
suffix:semicolon
r_return
op_minus
(paren
id|VX_ERR_MASK
op_or
id|err
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_send_rih - send an RIH with spinlock&n; * @cmd: the command to send&n; *&n; * see vx_send_rih_nolock().&n; */
DECL|function|vx_send_rih
r_int
id|vx_send_rih
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_int
id|cmd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|err
op_assign
id|vx_send_rih_nolock
c_func
(paren
id|chip
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|macro|END_OF_RESET_WAIT_TIME
mdefine_line|#define END_OF_RESET_WAIT_TIME&t;&t;500&t;/* us */
multiline_comment|/**&n; * snd_vx_boot_xilinx - boot up the xilinx interface&n; * @boot: the boot record to load&n; */
DECL|function|snd_vx_load_boot_image
r_int
id|snd_vx_load_boot_image
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_const
id|snd_hwdep_dsp_image_t
op_star
id|boot
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_int
id|no_fillup
op_assign
id|vx_has_new_dsp
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* check the length of boot image */
id|snd_assert
c_func
(paren
id|boot-&gt;length
OG
l_int|0
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|boot-&gt;length
op_mod
l_int|3
op_eq
l_int|0
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|boot-&gt;image
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
macro_line|#if 0
(brace
multiline_comment|/* more strict check */
r_int
r_int
id|c
op_assign
(paren
(paren
id|u32
)paren
id|boot-&gt;image
(braket
l_int|0
)braket
op_lshift
l_int|16
)paren
op_or
(paren
(paren
id|u32
)paren
id|boot-&gt;image
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|boot-&gt;image
(braket
l_int|2
)braket
suffix:semicolon
id|snd_assert
c_func
(paren
id|boot-&gt;length
op_eq
(paren
id|c
op_plus
l_int|2
)paren
op_star
l_int|3
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* reset dsp */
id|vx_reset_dsp
c_func
(paren
id|chip
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|END_OF_RESET_WAIT_TIME
)paren
suffix:semicolon
multiline_comment|/* another wait? */
multiline_comment|/* download boot strap */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x600
suffix:semicolon
id|i
op_add_assign
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|i
op_ge
id|boot-&gt;length
)paren
(brace
r_if
c_cond
(paren
id|no_fillup
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_TX_EMPTY
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dsp boot failed at %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|vx_outb
c_func
(paren
id|chip
comma
id|TXH
comma
l_int|0
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXM
comma
l_int|0
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_char
id|image
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|image
comma
id|boot-&gt;image
op_plus
id|i
comma
l_int|3
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_TX_EMPTY
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dsp boot failed at %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|vx_outb
c_func
(paren
id|chip
comma
id|TXH
comma
id|image
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXM
comma
id|image
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXL
comma
id|image
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_test_irq_src - query the source of interrupts&n; *&n; * called from irq handler only&n; */
DECL|function|vx_test_irq_src
r_static
r_int
id|vx_test_irq_src
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_int
r_int
op_star
id|ret
)paren
(brace
r_int
id|err
suffix:semicolon
id|vx_init_rmh
c_func
(paren
op_amp
id|chip-&gt;irq_rmh
comma
id|CMD_TEST_IT
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
id|err
op_assign
id|vx_send_msg_nolock
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;irq_rmh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
op_star
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
op_star
id|ret
op_assign
id|chip-&gt;irq_rmh.Stat
(braket
l_int|0
)braket
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * vx_interrupt - soft irq handler&n; */
DECL|function|vx_interrupt
r_static
r_void
id|vx_interrupt
c_func
(paren
r_int
r_int
id|private_data
)paren
(brace
id|vx_core_t
op_star
id|chip
op_assign
(paren
id|vx_core_t
op_star
)paren
id|private_data
suffix:semicolon
r_int
r_int
id|events
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;chip_status
op_amp
id|VX_STAT_IS_STALE
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|vx_test_irq_src
c_func
(paren
id|chip
comma
op_amp
id|events
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|events
op_amp
l_int|0x000800
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DSP Stream underrun ! IRQ events = 0x%x&bslash;n&quot;
comma
id|events
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|// printk(KERN_DEBUG &quot;IRQ events = 0x%x&bslash;n&quot;, events);
multiline_comment|/* We must prevent any application using this DSP&n;&t; * and block any further request until the application&n;&t; * either unregisters or reloads the DSP&n;&t; */
r_if
c_cond
(paren
id|events
op_amp
id|FATAL_DSP_ERROR
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vx_core: fatal DSP error!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* The start on time code conditions are filled (ie the time code&n;&t; * received by the board is equal to one of those given to it).&n;&t; */
r_if
c_cond
(paren
id|events
op_amp
id|TIME_CODE_EVENT_PENDING
)paren
suffix:semicolon
multiline_comment|/* so far, nothing to do yet */
multiline_comment|/* The frequency has changed on the board (UER mode). */
r_if
c_cond
(paren
id|events
op_amp
id|FREQUENCY_CHANGE_EVENT_PENDING
)paren
id|vx_change_frequency
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* update the pcm streams */
id|vx_pcm_update_intr
c_func
(paren
id|chip
comma
id|events
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_vx_irq_handler - interrupt handler&n; */
DECL|function|snd_vx_irq_handler
id|irqreturn_t
id|snd_vx_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|vx_core_t
op_star
id|chip
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|chip-&gt;chip_status
op_amp
id|VX_STAT_CHIP_INIT
)paren
op_logical_or
(paren
id|chip-&gt;chip_status
op_amp
id|VX_STAT_IS_STALE
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vx_test_and_ack
c_func
(paren
id|chip
)paren
)paren
id|tasklet_hi_schedule
c_func
(paren
op_amp
id|chip-&gt;tq
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|vx_reset_board
r_static
r_void
id|vx_reset_board
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_int
id|cold_reset
)paren
(brace
id|snd_assert
c_func
(paren
id|chip-&gt;ops-&gt;reset_board
comma
r_return
)paren
suffix:semicolon
multiline_comment|/* current source, later sync&squot;ed with target */
id|chip-&gt;audio_source
op_assign
id|VX_AUDIO_SRC_LINE
suffix:semicolon
r_if
c_cond
(paren
id|cold_reset
)paren
(brace
id|chip-&gt;audio_source_target
op_assign
id|chip-&gt;audio_source
suffix:semicolon
id|chip-&gt;clock_source
op_assign
id|INTERNAL_QUARTZ
suffix:semicolon
id|chip-&gt;clock_mode
op_assign
id|VX_CLOCK_MODE_AUTO
suffix:semicolon
id|chip-&gt;freq
op_assign
l_int|48000
suffix:semicolon
id|chip-&gt;uer_detected
op_assign
id|VX_UER_MODE_NOT_PRESENT
suffix:semicolon
id|chip-&gt;uer_bits
op_assign
id|SNDRV_PCM_DEFAULT_CON_SPDIF
suffix:semicolon
)brace
id|chip-&gt;ops
op_member_access_from_pointer
id|reset_board
c_func
(paren
id|chip
comma
id|cold_reset
)paren
suffix:semicolon
id|vx_reset_codec
c_func
(paren
id|chip
comma
id|cold_reset
)paren
suffix:semicolon
id|vx_set_internal_clock
c_func
(paren
id|chip
comma
id|chip-&gt;freq
)paren
suffix:semicolon
multiline_comment|/* Reset the DSP */
id|vx_reset_dsp
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vx_is_pcmcia
c_func
(paren
id|chip
)paren
)paren
(brace
multiline_comment|/* Acknowledge any pending IRQ and reset the MEMIRQ flag. */
id|vx_test_and_ack
c_func
(paren
id|chip
)paren
suffix:semicolon
id|vx_validate_irq
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* init CBits */
id|vx_set_iec958_status
c_func
(paren
id|chip
comma
id|chip-&gt;uer_bits
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * proc interface&n; */
DECL|function|vx_proc_read
r_static
r_void
id|vx_proc_read
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
id|snd_info_buffer_t
op_star
id|buffer
)paren
(brace
id|vx_core_t
op_star
id|chip
op_assign
id|entry-&gt;private_data
suffix:semicolon
r_static
r_char
op_star
id|audio_src_vxp
(braket
)braket
op_assign
(brace
l_string|&quot;Line&quot;
comma
l_string|&quot;Mic&quot;
comma
l_string|&quot;Digital&quot;
)brace
suffix:semicolon
r_static
r_char
op_star
id|audio_src_vx2
(braket
)braket
op_assign
(brace
l_string|&quot;Analog&quot;
comma
l_string|&quot;Analog&quot;
comma
l_string|&quot;Digital&quot;
)brace
suffix:semicolon
r_static
r_char
op_star
id|clock_mode
(braket
)braket
op_assign
(brace
l_string|&quot;Auto&quot;
comma
l_string|&quot;Internal&quot;
comma
l_string|&quot;External&quot;
)brace
suffix:semicolon
r_static
r_char
op_star
id|clock_src
(braket
)braket
op_assign
(brace
l_string|&quot;Internal&quot;
comma
l_string|&quot;External&quot;
)brace
suffix:semicolon
r_static
r_char
op_star
id|uer_type
(braket
)braket
op_assign
(brace
l_string|&quot;Consumer&quot;
comma
l_string|&quot;Professional&quot;
comma
l_string|&quot;Not Present&quot;
)brace
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|chip-&gt;card-&gt;longname
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;DSP audio info:&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;audio_info
op_amp
id|VX_AUDIO_INFO_REAL_TIME
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot; realtime&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;audio_info
op_amp
id|VX_AUDIO_INFO_OFFLINE
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot; offline&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;audio_info
op_amp
id|VX_AUDIO_INFO_MPEG1
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot; mpeg1&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;audio_info
op_amp
id|VX_AUDIO_INFO_MPEG2
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot; mpeg2&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;audio_info
op_amp
id|VX_AUDIO_INFO_LINEAR_8
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot; linear8&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;audio_info
op_amp
id|VX_AUDIO_INFO_LINEAR_16
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot; linear16&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;audio_info
op_amp
id|VX_AUDIO_INFO_LINEAR_24
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot; linear24&quot;
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Input Source: %s&bslash;n&quot;
comma
id|vx_is_pcmcia
c_func
(paren
id|chip
)paren
ques
c_cond
id|audio_src_vxp
(braket
id|chip-&gt;audio_source
)braket
suffix:colon
id|audio_src_vx2
(braket
id|chip-&gt;audio_source
)braket
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Clock Mode: %s&bslash;n&quot;
comma
id|clock_mode
(braket
id|chip-&gt;clock_mode
)braket
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Clock Source: %s&bslash;n&quot;
comma
id|clock_src
(braket
id|chip-&gt;clock_source
)braket
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Frequency: %d&bslash;n&quot;
comma
id|chip-&gt;freq
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Detected Frequency: %d&bslash;n&quot;
comma
id|chip-&gt;freq_detected
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Detected UER type: %s&bslash;n&quot;
comma
id|uer_type
(braket
id|chip-&gt;uer_detected
)braket
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Min/Max/Cur IBL: %d/%d/%d (granularity=%d)&bslash;n&quot;
comma
id|chip-&gt;ibl.min_size
comma
id|chip-&gt;ibl.max_size
comma
id|chip-&gt;ibl.size
comma
id|chip-&gt;ibl.granularity
)paren
suffix:semicolon
)brace
DECL|function|vx_proc_init
r_static
r_void
id|vx_proc_init
c_func
(paren
id|vx_core_t
op_star
id|chip
)paren
(brace
id|snd_info_entry_t
op_star
id|entry
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|snd_card_proc_new
c_func
(paren
id|chip-&gt;card
comma
l_string|&quot;vx-status&quot;
comma
op_amp
id|entry
)paren
)paren
id|snd_info_set_text_ops
c_func
(paren
id|entry
comma
id|chip
comma
l_int|1024
comma
id|vx_proc_read
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_vx_dsp_boot - load the DSP boot&n; */
DECL|function|snd_vx_dsp_boot
r_int
id|snd_vx_dsp_boot
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_const
id|snd_hwdep_dsp_image_t
op_star
id|boot
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|cold_reset
op_assign
op_logical_neg
(paren
id|chip-&gt;chip_status
op_amp
id|VX_STAT_DEVICE_INIT
)paren
suffix:semicolon
id|vx_reset_board
c_func
(paren
id|chip
comma
id|cold_reset
)paren
suffix:semicolon
id|vx_validate_irq
c_func
(paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_vx_load_boot_image
c_func
(paren
id|chip
comma
id|boot
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|snd_vx_delay
c_func
(paren
id|chip
comma
l_int|10
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_vx_dsp_load - load the DSP image&n; */
DECL|function|snd_vx_dsp_load
r_int
id|snd_vx_dsp_load
c_func
(paren
id|vx_core_t
op_star
id|chip
comma
r_const
id|snd_hwdep_dsp_image_t
op_star
id|dsp
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_int
id|csum
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|image
(braket
l_int|3
)braket
comma
op_star
id|cptr
suffix:semicolon
id|snd_assert
c_func
(paren
id|dsp-&gt;length
op_mod
l_int|3
op_eq
l_int|0
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|vx_toggle_dac_mute
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Transfert data buffer from PC to DSP */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dsp-&gt;length
suffix:semicolon
id|i
op_add_assign
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|image
comma
id|dsp-&gt;image
op_plus
id|i
comma
l_int|3
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Wait DSP ready for a new read */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_TX_EMPTY
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dsp loading error at position %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|cptr
op_assign
id|image
suffix:semicolon
id|csum
op_xor_assign
op_star
id|cptr
suffix:semicolon
id|csum
op_assign
(paren
id|csum
op_rshift
l_int|24
)paren
op_or
(paren
id|csum
op_lshift
l_int|8
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXH
comma
op_star
id|cptr
op_increment
)paren
suffix:semicolon
id|csum
op_xor_assign
op_star
id|cptr
suffix:semicolon
id|csum
op_assign
(paren
id|csum
op_rshift
l_int|24
)paren
op_or
(paren
id|csum
op_lshift
l_int|8
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXM
comma
op_star
id|cptr
op_increment
)paren
suffix:semicolon
id|csum
op_xor_assign
op_star
id|cptr
suffix:semicolon
id|csum
op_assign
(paren
id|csum
op_rshift
l_int|24
)paren
op_or
(paren
id|csum
op_lshift
l_int|8
)paren
suffix:semicolon
id|vx_outb
c_func
(paren
id|chip
comma
id|TXL
comma
op_star
id|cptr
op_increment
)paren
suffix:semicolon
)brace
id|snd_printdd
c_func
(paren
id|KERN_DEBUG
l_string|&quot;checksum = 0x%08x&bslash;n&quot;
comma
id|csum
)paren
suffix:semicolon
id|snd_vx_delay
c_func
(paren
id|chip
comma
l_int|200
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx_wait_isr_bit
c_func
(paren
id|chip
comma
id|ISR_CHK
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|vx_toggle_dac_mute
c_func
(paren
id|chip
comma
l_int|0
)paren
suffix:semicolon
id|vx_test_and_ack
c_func
(paren
id|chip
)paren
suffix:semicolon
id|vx_validate_irq
c_func
(paren
id|chip
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_vx_create - constructor for vx_core_t&n; * @hw: hardware specific record&n; *&n; * this function allocates the instance and prepare for the hardware&n; * initialization.&n; *&n; * return the instance pointer if successful, NULL in error.&n; */
DECL|function|snd_vx_create
id|vx_core_t
op_star
id|snd_vx_create
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_struct
id|snd_vx_hardware
op_star
id|hw
comma
r_struct
id|snd_vx_ops
op_star
id|ops
comma
r_int
id|extra_size
)paren
(brace
id|vx_core_t
op_star
id|chip
suffix:semicolon
id|snd_assert
c_func
(paren
id|card
op_logical_and
id|hw
op_logical_and
id|ops
comma
r_return
l_int|NULL
)paren
suffix:semicolon
id|chip
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|chip
)paren
op_plus
id|extra_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vx_core: no memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|chip-&gt;lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|chip-&gt;irq_lock
)paren
suffix:semicolon
id|chip-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|chip-&gt;hw
op_assign
id|hw
suffix:semicolon
id|chip-&gt;type
op_assign
id|hw-&gt;type
suffix:semicolon
id|chip-&gt;ops
op_assign
id|ops
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|chip-&gt;tq
comma
id|vx_interrupt
comma
(paren
r_int
r_int
)paren
id|chip
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|chip-&gt;mixer_mutex
)paren
suffix:semicolon
id|chip-&gt;card
op_assign
id|card
suffix:semicolon
id|card-&gt;private_data
op_assign
id|chip
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;driver
comma
id|hw-&gt;name
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;shortname
comma
l_string|&quot;Digigram %s&quot;
comma
id|hw-&gt;name
)paren
suffix:semicolon
id|vx_proc_init
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
id|chip
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
multiline_comment|/*&n; * suspend&n; */
DECL|function|snd_vx_suspend
r_void
id|snd_vx_suspend
c_func
(paren
id|vx_core_t
op_star
id|chip
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
id|chip-&gt;chip_status
op_or_assign
id|VX_STAT_IN_SUSPEND
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|chip-&gt;hw-&gt;num_codecs
suffix:semicolon
id|i
op_increment
)paren
id|snd_pcm_suspend_all
c_func
(paren
id|chip-&gt;pcm
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;hwdep
)paren
id|chip-&gt;hwdep-&gt;dsp_loaded
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * resume&n; */
DECL|function|snd_vx_resume
r_void
id|snd_vx_resume
c_func
(paren
id|vx_core_t
op_star
id|chip
)paren
(brace
multiline_comment|/* clear all stuff... */
id|chip-&gt;chip_status
op_and_assign
op_complement
(paren
id|VX_STAT_IN_SUSPEND
op_or
id|VX_STAT_CHIP_INIT
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * module entries&n; */
DECL|function|alsa_vx_core_init
r_static
r_int
id|__init
id|alsa_vx_core_init
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alsa_vx_core_exit
r_static
r_void
id|__exit
id|alsa_vx_core_exit
c_func
(paren
r_void
)paren
(brace
)brace
id|module_init
c_func
(paren
id|alsa_vx_core_init
)paren
id|module_exit
c_func
(paren
id|alsa_vx_core_exit
)paren
multiline_comment|/*&n; * exports&n; */
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_check_reg_bit
)paren
suffix:semicolon
DECL|variable|EXPORT_SYMBOL
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_create
)paren
suffix:semicolon
DECL|variable|snd_vx_hwdep_new
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_hwdep_new
)paren
suffix:semicolon
DECL|variable|snd_vx_irq_handler
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_irq_handler
)paren
suffix:semicolon
DECL|variable|snd_vx_delay
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_delay
)paren
suffix:semicolon
DECL|variable|snd_vx_dsp_boot
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_dsp_boot
)paren
suffix:semicolon
DECL|variable|snd_vx_dsp_load
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_dsp_load
)paren
suffix:semicolon
DECL|variable|snd_vx_load_boot_image
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_load_boot_image
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PM
DECL|variable|snd_vx_suspend
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_suspend
)paren
suffix:semicolon
DECL|variable|snd_vx_resume
id|EXPORT_SYMBOL
c_func
(paren
id|snd_vx_resume
)paren
suffix:semicolon
macro_line|#endif
eof
