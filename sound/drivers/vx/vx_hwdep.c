multiline_comment|/*&n; * Driver for Digigram VX soundcards&n; *&n; * DSP firmware management&n; *&n; * Copyright (c) 2002 by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/firmware.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/hwdep.h&gt;
macro_line|#include &lt;sound/vx_core.h&gt;
macro_line|#ifdef SND_VX_FW_LOADER
DECL|function|snd_vx_setup_firmware
r_int
id|snd_vx_setup_firmware
c_func
(paren
id|vx_core_t
op_star
id|chip
)paren
(brace
r_static
r_char
op_star
id|fw_files
(braket
id|VX_TYPE_NUMS
)braket
(braket
l_int|4
)braket
op_assign
(brace
(braket
id|VX_TYPE_BOARD
)braket
op_assign
(brace
l_int|NULL
comma
l_string|&quot;x1_1_vx2.xlx&quot;
comma
l_string|&quot;bd56002.boot&quot;
comma
l_string|&quot;l_1_vx2.d56&quot;
comma
)brace
comma
(braket
id|VX_TYPE_V2
)braket
op_assign
(brace
l_int|NULL
comma
l_string|&quot;x1_2_v22.xlx&quot;
comma
l_string|&quot;bd563v2.boot&quot;
comma
l_string|&quot;l_1_v22.d56&quot;
comma
)brace
comma
(braket
id|VX_TYPE_MIC
)braket
op_assign
(brace
l_int|NULL
comma
l_string|&quot;x1_2_v22.xlx&quot;
comma
l_string|&quot;bd563v2.boot&quot;
comma
l_string|&quot;l_1_v22.d56&quot;
comma
)brace
comma
(braket
id|VX_TYPE_VXPOCKET
)braket
op_assign
(brace
l_string|&quot;bx_1_vxp.b56&quot;
comma
l_string|&quot;x1_1_vxp.xlx&quot;
comma
l_string|&quot;bd563s3.boot&quot;
comma
l_string|&quot;l_1_vxp.d56&quot;
)brace
comma
(braket
id|VX_TYPE_VXP440
)braket
op_assign
(brace
l_string|&quot;bx_1_vp4.b56&quot;
comma
l_string|&quot;x1_1_vp4.xlx&quot;
comma
l_string|&quot;bd563s3.boot&quot;
comma
l_string|&quot;l_1_vp4.d56&quot;
)brace
comma
)brace
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|path
(braket
l_int|32
)braket
suffix:semicolon
r_const
r_struct
id|firmware
op_star
id|fw
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fw_files
(braket
id|chip-&gt;type
)braket
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
id|sprintf
c_func
(paren
id|path
comma
l_string|&quot;vx/%s&quot;
comma
id|fw_files
(braket
id|chip-&gt;type
)braket
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_firmware
c_func
(paren
op_amp
id|fw
comma
id|path
comma
id|chip-&gt;dev
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vx: can&squot;t load firmware %s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|err
op_assign
id|chip-&gt;ops
op_member_access_from_pointer
id|load_dsp
c_func
(paren
id|chip
comma
id|i
comma
id|fw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|release_firmware
c_func
(paren
id|fw
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
id|chip-&gt;chip_status
op_or_assign
id|VX_STAT_XILINX_LOADED
suffix:semicolon
macro_line|#ifdef CONFIG_PM
id|chip-&gt;firmware
(braket
id|i
)braket
op_assign
id|fw
suffix:semicolon
macro_line|#else
id|release_firmware
c_func
(paren
id|fw
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* ok, we reached to the last one */
multiline_comment|/* create the devices if not built yet */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_vx_pcm_new
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_vx_mixer_new
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;ops-&gt;add_controls
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|chip-&gt;ops
op_member_access_from_pointer
id|add_controls
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|chip-&gt;chip_status
op_or_assign
id|VX_STAT_DEVICE_INIT
suffix:semicolon
id|chip-&gt;chip_status
op_or_assign
id|VX_STAT_CHIP_INIT
suffix:semicolon
r_return
id|snd_card_register
c_func
(paren
id|chip-&gt;card
)paren
suffix:semicolon
)brace
multiline_comment|/* exported */
DECL|function|snd_vx_free_firmware
r_void
id|snd_vx_free_firmware
c_func
(paren
id|vx_core_t
op_star
id|chip
)paren
(brace
macro_line|#ifdef CONFIG_PM
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|release_firmware
c_func
(paren
id|chip-&gt;firmware
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#else /* old style firmware loading */
DECL|function|vx_hwdep_open
r_static
r_int
id|vx_hwdep_open
c_func
(paren
id|snd_hwdep_t
op_star
id|hw
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vx_hwdep_release
r_static
r_int
id|vx_hwdep_release
c_func
(paren
id|snd_hwdep_t
op_star
id|hw
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vx_hwdep_dsp_status
r_static
r_int
id|vx_hwdep_dsp_status
c_func
(paren
id|snd_hwdep_t
op_star
id|hw
comma
id|snd_hwdep_dsp_status_t
op_star
id|info
)paren
(brace
r_static
r_char
op_star
id|type_ids
(braket
id|VX_TYPE_NUMS
)braket
op_assign
(brace
(braket
id|VX_TYPE_BOARD
)braket
op_assign
l_string|&quot;vxboard&quot;
comma
(braket
id|VX_TYPE_V2
)braket
op_assign
l_string|&quot;vx222&quot;
comma
(braket
id|VX_TYPE_MIC
)braket
op_assign
l_string|&quot;vx222&quot;
comma
(braket
id|VX_TYPE_VXPOCKET
)braket
op_assign
l_string|&quot;vxpocket&quot;
comma
(braket
id|VX_TYPE_VXP440
)braket
op_assign
l_string|&quot;vxp440&quot;
comma
)brace
suffix:semicolon
id|vx_core_t
op_star
id|vx
op_assign
id|hw-&gt;private_data
suffix:semicolon
id|snd_assert
c_func
(paren
id|type_ids
(braket
id|vx-&gt;type
)braket
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;id
comma
id|type_ids
(braket
id|vx-&gt;type
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vx_is_pcmcia
c_func
(paren
id|vx
)paren
)paren
id|info-&gt;num_dsps
op_assign
l_int|4
suffix:semicolon
r_else
id|info-&gt;num_dsps
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|vx-&gt;chip_status
op_amp
id|VX_STAT_CHIP_INIT
)paren
id|info-&gt;chip_ready
op_assign
l_int|1
suffix:semicolon
id|info-&gt;version
op_assign
id|VX_DRIVER_VERSION
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_fw
r_static
r_void
id|free_fw
c_func
(paren
r_const
r_struct
id|firmware
op_star
id|fw
)paren
(brace
r_if
c_cond
(paren
id|fw
)paren
(brace
id|vfree
c_func
(paren
id|fw-&gt;data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fw
)paren
suffix:semicolon
)brace
)brace
DECL|function|vx_hwdep_dsp_load
r_static
r_int
id|vx_hwdep_dsp_load
c_func
(paren
id|snd_hwdep_t
op_star
id|hw
comma
id|snd_hwdep_dsp_image_t
op_star
id|dsp
)paren
(brace
id|vx_core_t
op_star
id|vx
op_assign
id|hw-&gt;private_data
suffix:semicolon
r_int
id|index
comma
id|err
suffix:semicolon
r_struct
id|firmware
op_star
id|fw
suffix:semicolon
id|snd_assert
c_func
(paren
id|vx-&gt;ops-&gt;load_dsp
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|fw
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|fw
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fw
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot allocate firmware&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|fw-&gt;size
op_assign
id|dsp-&gt;length
suffix:semicolon
id|fw-&gt;data
op_assign
id|vmalloc
c_func
(paren
id|fw-&gt;size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fw-&gt;data
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot allocate firmware image (length=%d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|fw-&gt;size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fw
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|fw-&gt;data
comma
id|dsp-&gt;image
comma
id|dsp-&gt;length
)paren
)paren
(brace
id|free_fw
c_func
(paren
id|fw
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|index
op_assign
id|dsp-&gt;index
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vx_is_pcmcia
c_func
(paren
id|vx
)paren
)paren
id|index
op_increment
suffix:semicolon
id|err
op_assign
id|vx-&gt;ops
op_member_access_from_pointer
id|load_dsp
c_func
(paren
id|vx
comma
id|index
comma
id|fw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|free_fw
c_func
(paren
id|fw
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
id|vx-&gt;firmware
(braket
id|index
)braket
op_assign
id|fw
suffix:semicolon
macro_line|#else
id|free_fw
c_func
(paren
id|fw
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|index
op_eq
l_int|1
)paren
id|vx-&gt;chip_status
op_or_assign
id|VX_STAT_XILINX_LOADED
suffix:semicolon
r_if
c_cond
(paren
id|index
OL
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ok, we reached to the last one */
multiline_comment|/* create the devices if not built yet */
r_if
c_cond
(paren
op_logical_neg
(paren
id|vx-&gt;chip_status
op_amp
id|VX_STAT_DEVICE_INIT
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_vx_pcm_new
c_func
(paren
id|vx
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_vx_mixer_new
c_func
(paren
id|vx
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|vx-&gt;ops-&gt;add_controls
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|vx-&gt;ops
op_member_access_from_pointer
id|add_controls
c_func
(paren
id|vx
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_register
c_func
(paren
id|vx-&gt;card
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|vx-&gt;chip_status
op_or_assign
id|VX_STAT_DEVICE_INIT
suffix:semicolon
)brace
id|vx-&gt;chip_status
op_or_assign
id|VX_STAT_CHIP_INIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* exported */
DECL|function|snd_vx_setup_firmware
r_int
id|snd_vx_setup_firmware
c_func
(paren
id|vx_core_t
op_star
id|chip
)paren
(brace
r_int
id|err
suffix:semicolon
id|snd_hwdep_t
op_star
id|hw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_hwdep_new
c_func
(paren
id|chip-&gt;card
comma
id|SND_VX_HWDEP_ID
comma
l_int|0
comma
op_amp
id|hw
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|hw-&gt;iface
op_assign
id|SNDRV_HWDEP_IFACE_VX
suffix:semicolon
id|hw-&gt;private_data
op_assign
id|chip
suffix:semicolon
id|hw-&gt;ops.open
op_assign
id|vx_hwdep_open
suffix:semicolon
id|hw-&gt;ops.release
op_assign
id|vx_hwdep_release
suffix:semicolon
id|hw-&gt;ops.dsp_status
op_assign
id|vx_hwdep_dsp_status
suffix:semicolon
id|hw-&gt;ops.dsp_load
op_assign
id|vx_hwdep_dsp_load
suffix:semicolon
id|hw-&gt;exclusive
op_assign
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|hw-&gt;name
comma
l_string|&quot;VX Loader (%s)&quot;
comma
id|chip-&gt;card-&gt;driver
)paren
suffix:semicolon
id|chip-&gt;hwdep
op_assign
id|hw
suffix:semicolon
r_return
id|snd_card_register
c_func
(paren
id|chip-&gt;card
)paren
suffix:semicolon
)brace
multiline_comment|/* exported */
DECL|function|snd_vx_free_firmware
r_void
id|snd_vx_free_firmware
c_func
(paren
id|vx_core_t
op_star
id|chip
)paren
(brace
macro_line|#ifdef CONFIG_PM
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|free_fw
c_func
(paren
id|chip-&gt;firmware
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif /* SND_VX_FW_LOADER */
eof
