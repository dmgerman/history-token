multiline_comment|/*&n; *   serial.c&n; *   Copyright (c) by Jaroslav Kysela &lt;perex@suse.cz&gt;,&n; *                    Isaku Yamahata &lt;yamahata@private.email.ne.jp&gt;,&n; *&t;&t;      George Hansper &lt;ghansper@apana.org.au&gt;,&n; *&t;&t;      Hannu Savolainen&n; *&n; *   This code is based on the code from ALSA 0.5.9, but heavily rewritten.&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; * Sat Mar 31 17:27:57 PST 2001 tim.mann@compaq.com &n; *      Added support for the Midiator MS-124T and for the MS-124W in&n; *      Single Addressed (S/A) or Multiple Burst (M/B) mode, with&n; *      power derived either parasitically from the serial port or&n; *      from a separate power supply.&n; *&n; *      More documentation can be found in serial-u16550.txt.&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/rawmidi.h&gt;
DECL|macro|SNDRV_GET_ID
mdefine_line|#define SNDRV_GET_ID
macro_line|#include &lt;sound/initval.h&gt;
macro_line|#include &lt;linux/serial_reg.h&gt;
macro_line|#include &lt;asm/io.h&gt;
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;MIDI serial u16550&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_CLASSES
c_func
(paren
l_string|&quot;{sound}&quot;
)paren
suffix:semicolon
id|MODULE_DEVICES
c_func
(paren
l_string|&quot;{{ALSA, MIDI serial u16550}}&quot;
)paren
suffix:semicolon
DECL|macro|SNDRV_SERIAL_SOUNDCANVAS
mdefine_line|#define SNDRV_SERIAL_SOUNDCANVAS 0 /* Roland Soundcanvas; F5 NN selects part */
DECL|macro|SNDRV_SERIAL_MS124T
mdefine_line|#define SNDRV_SERIAL_MS124T 1      /* Midiator MS-124T */
DECL|macro|SNDRV_SERIAL_MS124W_SA
mdefine_line|#define SNDRV_SERIAL_MS124W_SA 2   /* Midiator MS-124W in S/A mode */
DECL|macro|SNDRV_SERIAL_MS124W_MB
mdefine_line|#define SNDRV_SERIAL_MS124W_MB 3   /* Midiator MS-124W in M/B mode */
DECL|macro|SNDRV_SERIAL_GENERIC
mdefine_line|#define SNDRV_SERIAL_GENERIC 4     /* Generic Interface */
DECL|macro|SNDRV_SERIAL_MAX_ADAPTOR
mdefine_line|#define SNDRV_SERIAL_MAX_ADAPTOR SNDRV_SERIAL_GENERIC
DECL|variable|adaptor_names
r_static
r_char
op_star
id|adaptor_names
(braket
)braket
op_assign
(brace
l_string|&quot;Soundcanvas&quot;
comma
l_string|&quot;MS-124T&quot;
comma
l_string|&quot;MS-124W S/A&quot;
comma
l_string|&quot;MS-124W M/B&quot;
comma
l_string|&quot;Generic&quot;
)brace
suffix:semicolon
DECL|macro|SNDRV_SERIAL_NORMALBUFF
mdefine_line|#define SNDRV_SERIAL_NORMALBUFF 0 /* Normal blocking buffer operation */
DECL|macro|SNDRV_SERIAL_DROPBUFF
mdefine_line|#define SNDRV_SERIAL_DROPBUFF   1 /* Non-blocking discard operation */
DECL|variable|index
r_static
r_int
id|index
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_IDX
suffix:semicolon
multiline_comment|/* Index 0-MAX */
DECL|variable|id
r_static
r_char
op_star
id|id
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_STR
suffix:semicolon
multiline_comment|/* ID for this card */
DECL|variable|enable
r_static
r_int
id|enable
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_ENABLE
suffix:semicolon
multiline_comment|/* Enable this card */
DECL|variable|port
r_static
r_int
id|port
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_PORT
suffix:semicolon
multiline_comment|/* 0x3f8,0x2f8,0x3e8,0x2e8 */
DECL|variable|irq
r_static
r_int
id|irq
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_IRQ
suffix:semicolon
multiline_comment|/* 3,4,5,7,9,10,11,14,15 */
DECL|variable|speed
r_static
r_int
id|speed
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|38400
)brace
suffix:semicolon
multiline_comment|/* 9600,19200,38400,57600,115200 */
DECL|variable|base
r_static
r_int
id|base
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|115200
)brace
suffix:semicolon
multiline_comment|/* baud base */
DECL|variable|outs
r_static
r_int
id|outs
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|1
)brace
suffix:semicolon
multiline_comment|/* 1 to 16 */
DECL|variable|ins
r_static
r_int
id|ins
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|1
)brace
suffix:semicolon
multiline_comment|/* 1 to 16 */
DECL|variable|adaptor
r_static
r_int
id|adaptor
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
id|SNDRV_SERIAL_SOUNDCANVAS
)brace
suffix:semicolon
DECL|variable|droponfull
r_static
r_int
id|droponfull
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
id|SNDRV_SERIAL_NORMALBUFF
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|index
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|index
comma
l_string|&quot;Index value for Serial MIDI.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|index
comma
id|SNDRV_INDEX_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|id
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|id
comma
l_string|&quot;ID string for Serial MIDI.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|id
comma
id|SNDRV_ID_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|enable
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;l&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|enable
comma
l_string|&quot;Enable UART16550A chip.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|enable
comma
id|SNDRV_ENABLE_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|port
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;l&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|port
comma
l_string|&quot;Port # for UART16550A chip.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|port
comma
id|SNDRV_PORT12_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|irq
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;IRQ # for UART16550A chip.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|irq
comma
id|SNDRV_IRQ_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|speed
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|speed
comma
l_string|&quot;Speed in bauds.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|speed
comma
id|SNDRV_ENABLED
l_string|&quot;,allows:{9600,19200,38400,57600,115200},dialog:list&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|base
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|base
comma
l_string|&quot;Base for divisor in bauds.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|base
comma
id|SNDRV_ENABLED
l_string|&quot;,allows:{57600,115200,230400,460800},dialog:list&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|outs
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|outs
comma
l_string|&quot;Number of MIDI outputs.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ins
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ins
comma
l_string|&quot;Number of MIDI inputs.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|droponfull
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|droponfull
comma
l_string|&quot;Flag to enable drop-on-full buffer mode&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|droponfull
comma
id|SNDRV_ENABLED
l_string|&quot;,&quot;
id|SNDRV_BOOLEAN_FALSE_DESC
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|outs
comma
id|SNDRV_ENABLED
l_string|&quot;,allows:{{1,16}},dialog:list&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|ins
comma
id|SNDRV_ENABLED
l_string|&quot;,allows:{{1,16}},dialog:list&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|adaptor
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|adaptor
comma
l_string|&quot;Type of adaptor.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|adaptor
comma
id|SNDRV_ENABLED
l_string|&quot;,allows:{{0=Soundcanvas,1=MS-124T,2=MS-124W S/A,3=MS-124W M/B,4=Generic}},dialog:list&quot;
)paren
suffix:semicolon
multiline_comment|/*#define SNDRV_SERIAL_MS124W_MB_NOCOMBO 1*/
multiline_comment|/* Address outs as 0-3 instead of bitmap */
DECL|macro|SNDRV_SERIAL_MAX_OUTS
mdefine_line|#define SNDRV_SERIAL_MAX_OUTS&t;16&t;&t;/* max 64, min 16 */
DECL|macro|SNDRV_SERIAL_MAX_INS
mdefine_line|#define SNDRV_SERIAL_MAX_INS&t;16&t;&t;/* max 64, min 16 */
DECL|macro|TX_BUFF_SIZE
mdefine_line|#define TX_BUFF_SIZE&t;&t;(1&lt;&lt;15)&t;&t;/* Must be 2^n */
DECL|macro|TX_BUFF_MASK
mdefine_line|#define TX_BUFF_MASK&t;&t;(TX_BUFF_SIZE - 1)
DECL|macro|SERIAL_MODE_NOT_OPENED
mdefine_line|#define SERIAL_MODE_NOT_OPENED &t;&t;(0)
DECL|macro|SERIAL_MODE_INPUT_OPEN
mdefine_line|#define SERIAL_MODE_INPUT_OPEN&t;&t;(1 &lt;&lt; 0)
DECL|macro|SERIAL_MODE_OUTPUT_OPEN
mdefine_line|#define SERIAL_MODE_OUTPUT_OPEN&t;&t;(1 &lt;&lt; 1)
DECL|macro|SERIAL_MODE_INPUT_TRIGGERED
mdefine_line|#define SERIAL_MODE_INPUT_TRIGGERED&t;(1 &lt;&lt; 2)
DECL|macro|SERIAL_MODE_OUTPUT_TRIGGERED
mdefine_line|#define SERIAL_MODE_OUTPUT_TRIGGERED&t;(1 &lt;&lt; 3)
DECL|struct|_snd_uart16550
r_typedef
r_struct
id|_snd_uart16550
(brace
DECL|member|card
id|snd_card_t
op_star
id|card
suffix:semicolon
DECL|member|rmidi
id|snd_rawmidi_t
op_star
id|rmidi
suffix:semicolon
DECL|member|midi_output
id|snd_rawmidi_substream_t
op_star
id|midi_output
(braket
id|SNDRV_SERIAL_MAX_OUTS
)braket
suffix:semicolon
DECL|member|midi_input
id|snd_rawmidi_substream_t
op_star
id|midi_input
(braket
id|SNDRV_SERIAL_MAX_INS
)braket
suffix:semicolon
DECL|member|filemode
r_int
id|filemode
suffix:semicolon
singleline_comment|//open status of file
DECL|member|open_lock
id|spinlock_t
id|open_lock
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|base
r_int
r_int
id|base
suffix:semicolon
DECL|member|res_base
r_struct
id|resource
op_star
id|res_base
suffix:semicolon
DECL|member|speed
r_int
r_int
id|speed
suffix:semicolon
DECL|member|speed_base
r_int
r_int
id|speed_base
suffix:semicolon
DECL|member|divisor
r_int
r_char
id|divisor
suffix:semicolon
DECL|member|old_divisor_lsb
r_int
r_char
id|old_divisor_lsb
suffix:semicolon
DECL|member|old_divisor_msb
r_int
r_char
id|old_divisor_msb
suffix:semicolon
DECL|member|old_line_ctrl_reg
r_int
r_char
id|old_line_ctrl_reg
suffix:semicolon
singleline_comment|// parameter for using of write loop
DECL|member|fifo_limit
r_int
r_int
id|fifo_limit
suffix:semicolon
singleline_comment|//used in uart16550
DECL|member|fifo_count
r_int
r_int
id|fifo_count
suffix:semicolon
singleline_comment|//used in uart16550
singleline_comment|// type of adaptor
DECL|member|adaptor
r_int
id|adaptor
suffix:semicolon
singleline_comment|// inputs
DECL|member|prev_in
r_int
id|prev_in
suffix:semicolon
DECL|member|rstatus
r_int
r_char
id|rstatus
suffix:semicolon
singleline_comment|// outputs
DECL|member|prev_out
r_int
id|prev_out
suffix:semicolon
DECL|member|prev_status
r_int
r_char
id|prev_status
(braket
id|SNDRV_SERIAL_MAX_OUTS
)braket
suffix:semicolon
singleline_comment|// write buffer and its writing/reading position
DECL|member|tx_buff
r_int
r_char
id|tx_buff
(braket
id|TX_BUFF_SIZE
)braket
suffix:semicolon
DECL|member|buff_in_count
r_int
id|buff_in_count
suffix:semicolon
DECL|member|buff_in
r_int
id|buff_in
suffix:semicolon
DECL|member|buff_out
r_int
id|buff_out
suffix:semicolon
DECL|member|drop_on_full
r_int
id|drop_on_full
suffix:semicolon
singleline_comment|// wait timer
DECL|member|timer_running
r_int
r_int
id|timer_running
suffix:colon
l_int|1
suffix:semicolon
DECL|member|buffer_timer
r_struct
id|timer_list
id|buffer_timer
suffix:semicolon
DECL|typedef|snd_uart16550_t
)brace
id|snd_uart16550_t
suffix:semicolon
DECL|variable|snd_serial_cards
r_static
id|snd_card_t
op_star
id|snd_serial_cards
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_PTR
suffix:semicolon
DECL|function|snd_uart16550_add_timer
r_inline
r_static
r_void
id|snd_uart16550_add_timer
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|uart-&gt;timer_running
)paren
(brace
multiline_comment|/* timer 38600bps * 10bit * 16byte */
id|uart-&gt;buffer_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_plus
l_int|255
)paren
op_div
l_int|256
suffix:semicolon
id|uart-&gt;timer_running
op_assign
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|uart-&gt;buffer_timer
)paren
suffix:semicolon
)brace
)brace
DECL|function|snd_uart16550_del_timer
r_inline
r_static
r_void
id|snd_uart16550_del_timer
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
)paren
(brace
r_if
c_cond
(paren
id|uart-&gt;timer_running
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|uart-&gt;buffer_timer
)paren
suffix:semicolon
id|uart-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* This macro is only used in snd_uart16550_io_loop */
DECL|function|snd_uart16550_buffer_output
r_inline
r_static
r_void
id|snd_uart16550_buffer_output
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
)paren
(brace
r_int
r_int
id|buff_out
op_assign
id|uart-&gt;buff_out
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;buff_in_count
OG
l_int|0
)paren
(brace
id|outb
c_func
(paren
id|uart-&gt;tx_buff
(braket
id|buff_out
)braket
comma
id|uart-&gt;base
op_plus
id|UART_TX
)paren
suffix:semicolon
id|uart-&gt;fifo_count
op_increment
suffix:semicolon
id|buff_out
op_increment
suffix:semicolon
id|buff_out
op_and_assign
id|TX_BUFF_MASK
suffix:semicolon
id|uart-&gt;buff_out
op_assign
id|buff_out
suffix:semicolon
id|uart-&gt;buff_in_count
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/* This loop should be called with interrupts disabled&n; * We don&squot;t want to interrupt this, &n; * as we&squot;re already handling an interrupt &n; */
DECL|function|snd_uart16550_io_loop
r_static
r_void
id|snd_uart16550_io_loop
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
)paren
(brace
r_int
r_char
id|c
comma
id|status
suffix:semicolon
r_int
id|substream
suffix:semicolon
multiline_comment|/* recall previous stream */
id|substream
op_assign
id|uart-&gt;prev_in
suffix:semicolon
multiline_comment|/* Read Loop */
r_while
c_loop
(paren
(paren
id|status
op_assign
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_LSR
)paren
)paren
op_amp
id|UART_LSR_DR
)paren
(brace
multiline_comment|/* while receive data ready */
id|c
op_assign
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_RX
)paren
suffix:semicolon
multiline_comment|/* keep track of last status byte */
r_if
c_cond
(paren
id|c
op_amp
l_int|0x80
)paren
(brace
id|uart-&gt;rstatus
op_assign
id|c
suffix:semicolon
)brace
multiline_comment|/* handle stream switch */
r_if
c_cond
(paren
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_GENERIC
)paren
(brace
r_if
c_cond
(paren
id|uart-&gt;rstatus
op_eq
l_int|0xf5
)paren
(brace
r_if
c_cond
(paren
id|c
op_le
id|SNDRV_SERIAL_MAX_INS
op_logical_and
id|c
OG
l_int|0
)paren
id|substream
op_assign
id|c
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ne
l_int|0xf5
)paren
id|uart-&gt;rstatus
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* prevent future bytes from being interpreted as streams */
)brace
r_else
r_if
c_cond
(paren
(paren
id|uart-&gt;filemode
op_amp
id|SERIAL_MODE_INPUT_OPEN
)paren
op_logical_and
(paren
id|uart-&gt;midi_input
(braket
id|substream
)braket
op_ne
l_int|NULL
)paren
)paren
(brace
id|snd_rawmidi_receive
c_func
(paren
id|uart-&gt;midi_input
(braket
id|substream
)braket
comma
op_amp
id|c
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|uart-&gt;filemode
op_amp
id|SERIAL_MODE_INPUT_OPEN
)paren
op_logical_and
(paren
id|uart-&gt;midi_input
(braket
id|substream
)braket
op_ne
l_int|NULL
)paren
)paren
(brace
id|snd_rawmidi_receive
c_func
(paren
id|uart-&gt;midi_input
(braket
id|substream
)braket
comma
op_amp
id|c
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|UART_LSR_OE
)paren
id|snd_printk
c_func
(paren
l_string|&quot;%s: Overrun on device at 0x%lx&bslash;n&quot;
comma
id|uart-&gt;rmidi-&gt;name
comma
id|uart-&gt;base
)paren
suffix:semicolon
)brace
multiline_comment|/* remember the last stream */
id|uart-&gt;prev_in
op_assign
id|substream
suffix:semicolon
multiline_comment|/* no need of check SERIAL_MODE_OUTPUT_OPEN because if not,&n;&t;   buffer is never filled. */
multiline_comment|/* Check write status */
r_if
c_cond
(paren
id|status
op_amp
id|UART_LSR_THRE
)paren
(brace
id|uart-&gt;fifo_count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_MS124W_SA
op_logical_or
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_GENERIC
)paren
(brace
multiline_comment|/* Can&squot;t use FIFO, must send only when CTS is true */
id|status
op_assign
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_MSR
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|uart-&gt;fifo_count
op_eq
l_int|0
)paren
op_logical_and
(paren
id|status
op_amp
id|UART_MSR_CTS
)paren
op_logical_and
(paren
id|uart-&gt;buff_in_count
OG
l_int|0
)paren
)paren
(brace
id|snd_uart16550_buffer_output
c_func
(paren
id|uart
)paren
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_MSR
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Write loop */
r_while
c_loop
(paren
id|uart-&gt;fifo_count
template_param
l_int|0
)paren
multiline_comment|/* Do we want to? */
id|snd_uart16550_buffer_output
c_func
(paren
id|uart
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart-&gt;irq
template_param
l_int|0
)paren
id|snd_uart16550_add_timer
c_func
(paren
id|uart
)paren
suffix:semicolon
)brace
multiline_comment|/* NOTES ON SERVICING INTERUPTS&n; * ---------------------------&n; * After receiving a interrupt, it is important to indicate to the UART that&n; * this has been done. &n; * For a Rx interrupt, this is done by reading the received byte.&n; * For a Tx interrupt this is done by either:&n; * a) Writing a byte&n; * b) Reading the IIR&n; * It is particularly important to read the IIR if a Tx interrupt is received&n; * when there is no data in tx_buff[], as in this case there no other&n; * indication that the interrupt has been serviced, and it remains outstanding&n; * indefinitely. This has the curious side effect that and no further interrupts&n; * will be generated from this device AT ALL!!.&n; * It is also desirable to clear outstanding interrupts when the device is&n; * opened/closed.&n; *&n; *&n; * Note that some devices need OUT2 to be set before they will generate&n; * interrupts at all. (Possibly tied to an internal pull-up on CTS?)&n; */
DECL|function|snd_uart16550_interrupt
r_static
id|irqreturn_t
id|snd_uart16550_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|snd_uart16550_t
op_star
id|uart
suffix:semicolon
id|uart
op_assign
(paren
id|snd_uart16550_t
op_star
)paren
id|dev_id
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|uart-&gt;open_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;filemode
op_eq
id|SERIAL_MODE_NOT_OPENED
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|uart-&gt;open_lock
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_IIR
)paren
suffix:semicolon
multiline_comment|/* indicate to the UART that the interrupt has been serviced */
id|snd_uart16550_io_loop
c_func
(paren
id|uart
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|uart-&gt;open_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* When the polling mode, this function calls snd_uart16550_io_loop. */
DECL|function|snd_uart16550_buffer_timer
r_static
r_void
id|snd_uart16550_buffer_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|snd_uart16550_t
op_star
id|uart
suffix:semicolon
id|uart
op_assign
(paren
id|snd_uart16550_t
op_star
)paren
id|data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|uart-&gt;open_lock
)paren
suffix:semicolon
id|snd_uart16550_del_timer
c_func
(paren
id|uart
)paren
suffix:semicolon
id|snd_uart16550_io_loop
c_func
(paren
id|uart
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|uart-&gt;open_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  this method probes, if an uart sits on given port&n; *  return 0 if found&n; *  return negative error if not found&n; */
DECL|function|snd_uart16550_detect
r_static
r_int
id|__init
id|snd_uart16550_detect
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
)paren
(brace
r_int
r_int
id|io_base
op_assign
id|uart-&gt;base
suffix:semicolon
r_int
id|ok
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
multiline_comment|/* Do some vague tests for the presence of the uart */
r_if
c_cond
(paren
id|io_base
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Not configured */
)brace
id|uart-&gt;res_base
op_assign
id|request_region
c_func
(paren
id|io_base
comma
l_int|8
comma
l_string|&quot;Serial MIDI&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;res_base
op_eq
l_int|NULL
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;u16550: can&squot;t grab port 0x%lx&bslash;n&quot;
comma
id|io_base
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ok
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* uart detected unless one of the following tests should fail */
multiline_comment|/* 8 data-bits, 1 stop-bit, parity off, DLAB = 0 */
id|outb
c_func
(paren
id|UART_LCR_WLEN8
comma
id|io_base
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Line Control Register */
id|c
op_assign
id|inb
c_func
(paren
id|io_base
op_plus
id|UART_IER
)paren
suffix:semicolon
multiline_comment|/* The top four bits of the IER should always == 0 */
r_if
c_cond
(paren
(paren
id|c
op_amp
l_int|0xf0
)paren
op_ne
l_int|0
)paren
id|ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* failed */
id|outb
c_func
(paren
l_int|0xaa
comma
id|io_base
op_plus
id|UART_SCR
)paren
suffix:semicolon
multiline_comment|/* Write arbitrary data into the scratch reg */
id|c
op_assign
id|inb
c_func
(paren
id|io_base
op_plus
id|UART_SCR
)paren
suffix:semicolon
multiline_comment|/* If it comes back, it&squot;s OK */
r_if
c_cond
(paren
id|c
op_ne
l_int|0xaa
)paren
id|ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* failed */
id|outb
c_func
(paren
l_int|0x55
comma
id|io_base
op_plus
id|UART_SCR
)paren
suffix:semicolon
multiline_comment|/* Write arbitrary data into the scratch reg */
id|c
op_assign
id|inb
c_func
(paren
id|io_base
op_plus
id|UART_SCR
)paren
suffix:semicolon
multiline_comment|/* If it comes back, it&squot;s OK */
r_if
c_cond
(paren
id|c
op_ne
l_int|0x55
)paren
id|ok
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* failed */
r_return
id|ok
suffix:semicolon
)brace
DECL|function|snd_uart16550_do_open
r_static
r_void
id|snd_uart16550_do_open
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
)paren
(brace
r_char
id|byte
suffix:semicolon
multiline_comment|/* Initialize basic variables */
id|uart-&gt;buff_in_count
op_assign
l_int|0
suffix:semicolon
id|uart-&gt;buff_in
op_assign
l_int|0
suffix:semicolon
id|uart-&gt;buff_out
op_assign
l_int|0
suffix:semicolon
id|uart-&gt;fifo_limit
op_assign
l_int|1
suffix:semicolon
id|uart-&gt;fifo_count
op_assign
l_int|0
suffix:semicolon
id|uart-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
id|outb
c_func
(paren
id|UART_FCR_ENABLE_FIFO
multiline_comment|/* Enable FIFO&squot;s (if available) */
op_or
id|UART_FCR_CLEAR_RCVR
multiline_comment|/* Clear receiver FIFO */
op_or
id|UART_FCR_CLEAR_XMIT
multiline_comment|/* Clear transmitter FIFO */
op_or
id|UART_FCR_TRIGGER_4
multiline_comment|/* Set FIFO trigger at 4-bytes */
multiline_comment|/* NOTE: interrupt generated after T=(time)4-bytes&n;&t; * if less than UART_FCR_TRIGGER bytes received&n;&t; */
comma
id|uart-&gt;base
op_plus
id|UART_FCR
)paren
suffix:semicolon
multiline_comment|/* FIFO Control Register */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_IIR
)paren
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xc0
)paren
id|uart-&gt;fifo_limit
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;divisor
op_ne
l_int|0
)paren
(brace
id|uart-&gt;old_line_ctrl_reg
op_assign
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_LCR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|UART_LCR_DLAB
multiline_comment|/* Divisor latch access bit */
comma
id|uart-&gt;base
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Line Control Register */
id|uart-&gt;old_divisor_lsb
op_assign
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_DLL
)paren
suffix:semicolon
id|uart-&gt;old_divisor_msb
op_assign
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_DLM
)paren
suffix:semicolon
id|outb
c_func
(paren
id|uart-&gt;divisor
comma
id|uart-&gt;base
op_plus
id|UART_DLL
)paren
suffix:semicolon
multiline_comment|/* Divisor Latch Low */
id|outb
c_func
(paren
l_int|0
comma
id|uart-&gt;base
op_plus
id|UART_DLM
)paren
suffix:semicolon
multiline_comment|/* Divisor Latch High */
multiline_comment|/* DLAB is reset to 0 in next outb() */
)brace
multiline_comment|/* Set serial parameters (parity off, etc) */
id|outb
c_func
(paren
id|UART_LCR_WLEN8
multiline_comment|/* 8 data-bits */
op_or
l_int|0
multiline_comment|/* 1 stop-bit */
op_or
l_int|0
multiline_comment|/* parity off */
op_or
l_int|0
multiline_comment|/* DLAB = 0 */
comma
id|uart-&gt;base
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Line Control Register */
r_switch
c_cond
(paren
id|uart-&gt;adaptor
)paren
(brace
r_default
suffix:colon
id|outb
c_func
(paren
id|UART_MCR_RTS
multiline_comment|/* Set Request-To-Send line active */
op_or
id|UART_MCR_DTR
multiline_comment|/* Set Data-Terminal-Ready line active */
op_or
id|UART_MCR_OUT2
multiline_comment|/* Set OUT2 - not always required, but when&n;&t;&t;&t;&t;&t; * it is, it is ESSENTIAL for enabling interrupts&n;&t;&t;&t;&t; */
comma
id|uart-&gt;base
op_plus
id|UART_MCR
)paren
suffix:semicolon
multiline_comment|/* Modem Control Register */
r_break
suffix:semicolon
r_case
id|SNDRV_SERIAL_MS124W_SA
suffix:colon
r_case
id|SNDRV_SERIAL_MS124W_MB
suffix:colon
multiline_comment|/* MS-124W can draw power from RTS and DTR if they&n;&t;&t;   are in opposite states. */
id|outb
c_func
(paren
id|UART_MCR_RTS
op_or
(paren
l_int|0
op_amp
id|UART_MCR_DTR
)paren
op_or
id|UART_MCR_OUT2
comma
id|uart-&gt;base
op_plus
id|UART_MCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SERIAL_MS124T
suffix:colon
multiline_comment|/* MS-124T can draw power from RTS and/or DTR (preferably&n;&t;&t;   both) if they are both asserted. */
id|outb
c_func
(paren
id|UART_MCR_RTS
op_or
id|UART_MCR_DTR
op_or
id|UART_MCR_OUT2
comma
id|uart-&gt;base
op_plus
id|UART_MCR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart-&gt;irq
OL
l_int|0
)paren
(brace
id|byte
op_assign
(paren
l_int|0
op_amp
id|UART_IER_RDI
)paren
multiline_comment|/* Disable Receiver data interrupt */
op_or
(paren
l_int|0
op_amp
id|UART_IER_THRI
)paren
multiline_comment|/* Disable Transmitter holding register empty interrupt */
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_MS124W_SA
)paren
(brace
id|byte
op_assign
id|UART_IER_RDI
multiline_comment|/* Enable Receiver data interrupt */
op_or
id|UART_IER_MSI
multiline_comment|/* Enable Modem status interrupt */
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_GENERIC
)paren
(brace
id|byte
op_assign
id|UART_IER_RDI
multiline_comment|/* Enable Receiver data interrupt */
op_or
id|UART_IER_MSI
multiline_comment|/* Enable Modem status interrupt */
op_or
id|UART_IER_THRI
multiline_comment|/* Enable Transmitter holding register empty interrupt */
suffix:semicolon
)brace
r_else
(brace
id|byte
op_assign
id|UART_IER_RDI
multiline_comment|/* Enable Receiver data interrupt */
op_or
id|UART_IER_THRI
multiline_comment|/* Enable Transmitter holding register empty interrupt */
suffix:semicolon
)brace
id|outb
c_func
(paren
id|byte
comma
id|uart-&gt;base
op_plus
id|UART_IER
)paren
suffix:semicolon
multiline_comment|/* Interupt enable Register */
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_LSR
)paren
suffix:semicolon
multiline_comment|/* Clear any pre-existing overrun indication */
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_IIR
)paren
suffix:semicolon
multiline_comment|/* Clear any pre-existing transmit interrupt */
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_RX
)paren
suffix:semicolon
multiline_comment|/* Clear any pre-existing receive interrupt */
)brace
DECL|function|snd_uart16550_do_close
r_static
r_void
id|snd_uart16550_do_close
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
)paren
(brace
r_if
c_cond
(paren
id|uart-&gt;irq
OL
l_int|0
)paren
id|snd_uart16550_del_timer
c_func
(paren
id|uart
)paren
suffix:semicolon
multiline_comment|/* NOTE: may need to disable interrupts before de-registering out handler.&n;&t; * For now, the consequences are harmless.&n;&t; */
id|outb
c_func
(paren
(paren
l_int|0
op_amp
id|UART_IER_RDI
)paren
multiline_comment|/* Disable Receiver data interrupt */
op_or
(paren
l_int|0
op_amp
id|UART_IER_THRI
)paren
multiline_comment|/* Disable Transmitter holding register empty interrupt */
comma
id|uart-&gt;base
op_plus
id|UART_IER
)paren
suffix:semicolon
multiline_comment|/* Interupt enable Register */
r_switch
c_cond
(paren
id|uart-&gt;adaptor
)paren
(brace
r_default
suffix:colon
id|outb
c_func
(paren
(paren
l_int|0
op_amp
id|UART_MCR_RTS
)paren
multiline_comment|/* Deactivate Request-To-Send line  */
op_or
(paren
l_int|0
op_amp
id|UART_MCR_DTR
)paren
multiline_comment|/* Deactivate Data-Terminal-Ready line */
op_or
(paren
l_int|0
op_amp
id|UART_MCR_OUT2
)paren
multiline_comment|/* Deactivate OUT2 */
comma
id|uart-&gt;base
op_plus
id|UART_MCR
)paren
suffix:semicolon
multiline_comment|/* Modem Control Register */
r_break
suffix:semicolon
r_case
id|SNDRV_SERIAL_MS124W_SA
suffix:colon
r_case
id|SNDRV_SERIAL_MS124W_MB
suffix:colon
multiline_comment|/* MS-124W can draw power from RTS and DTR if they&n;&t;&t;   are in opposite states; leave it powered. */
id|outb
c_func
(paren
id|UART_MCR_RTS
op_or
(paren
l_int|0
op_amp
id|UART_MCR_DTR
)paren
op_or
(paren
l_int|0
op_amp
id|UART_MCR_OUT2
)paren
comma
id|uart-&gt;base
op_plus
id|UART_MCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SERIAL_MS124T
suffix:colon
multiline_comment|/* MS-124T can draw power from RTS and/or DTR (preferably&n;&t;&t;   both) if they are both asserted; leave it powered. */
id|outb
c_func
(paren
id|UART_MCR_RTS
op_or
id|UART_MCR_DTR
op_or
(paren
l_int|0
op_amp
id|UART_MCR_OUT2
)paren
comma
id|uart-&gt;base
op_plus
id|UART_MCR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_IIR
)paren
suffix:semicolon
multiline_comment|/* Clear any outstanding interrupts */
multiline_comment|/* Restore old divisor */
r_if
c_cond
(paren
id|uart-&gt;divisor
op_ne
l_int|0
)paren
(brace
id|outb
c_func
(paren
id|UART_LCR_DLAB
multiline_comment|/* Divisor latch access bit */
comma
id|uart-&gt;base
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Line Control Register */
id|outb
c_func
(paren
id|uart-&gt;old_divisor_lsb
comma
id|uart-&gt;base
op_plus
id|UART_DLL
)paren
suffix:semicolon
multiline_comment|/* Divisor Latch Low */
id|outb
c_func
(paren
id|uart-&gt;old_divisor_msb
comma
id|uart-&gt;base
op_plus
id|UART_DLM
)paren
suffix:semicolon
multiline_comment|/* Divisor Latch High */
multiline_comment|/* Restore old LCR (data bits, stop bits, parity, DLAB) */
id|outb
c_func
(paren
id|uart-&gt;old_line_ctrl_reg
comma
id|uart-&gt;base
op_plus
id|UART_LCR
)paren
suffix:semicolon
multiline_comment|/* Line Control Register */
)brace
)brace
DECL|function|snd_uart16550_input_open
r_static
r_int
id|snd_uart16550_input_open
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_uart16550_t
comma
id|substream-&gt;rmidi-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;filemode
op_eq
id|SERIAL_MODE_NOT_OPENED
)paren
id|snd_uart16550_do_open
c_func
(paren
id|uart
)paren
suffix:semicolon
id|uart-&gt;filemode
op_or_assign
id|SERIAL_MODE_INPUT_OPEN
suffix:semicolon
id|uart-&gt;midi_input
(braket
id|substream-&gt;number
)braket
op_assign
id|substream
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_uart16550_input_close
r_static
r_int
id|snd_uart16550_input_close
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_uart16550_t
comma
id|substream-&gt;rmidi-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
id|uart-&gt;filemode
op_and_assign
op_complement
id|SERIAL_MODE_INPUT_OPEN
suffix:semicolon
id|uart-&gt;midi_input
(braket
id|substream-&gt;number
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;filemode
op_eq
id|SERIAL_MODE_NOT_OPENED
)paren
id|snd_uart16550_do_close
c_func
(paren
id|uart
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_uart16550_input_trigger
r_static
r_void
id|snd_uart16550_input_trigger
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
comma
r_int
id|up
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_uart16550_t
comma
id|substream-&gt;rmidi-&gt;private_data
comma
r_return
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
(brace
id|uart-&gt;filemode
op_or_assign
id|SERIAL_MODE_INPUT_TRIGGERED
suffix:semicolon
)brace
r_else
(brace
id|uart-&gt;filemode
op_and_assign
op_complement
id|SERIAL_MODE_INPUT_TRIGGERED
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_uart16550_output_open
r_static
r_int
id|snd_uart16550_output_open
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_uart16550_t
comma
id|substream-&gt;rmidi-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;filemode
op_eq
id|SERIAL_MODE_NOT_OPENED
)paren
id|snd_uart16550_do_open
c_func
(paren
id|uart
)paren
suffix:semicolon
id|uart-&gt;filemode
op_or_assign
id|SERIAL_MODE_OUTPUT_OPEN
suffix:semicolon
id|uart-&gt;midi_output
(braket
id|substream-&gt;number
)braket
op_assign
id|substream
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|snd_uart16550_output_close
r_static
r_int
id|snd_uart16550_output_close
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_uart16550_t
comma
id|substream-&gt;rmidi-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
id|uart-&gt;filemode
op_and_assign
op_complement
id|SERIAL_MODE_OUTPUT_OPEN
suffix:semicolon
id|uart-&gt;midi_output
(braket
id|substream-&gt;number
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;filemode
op_eq
id|SERIAL_MODE_NOT_OPENED
)paren
id|snd_uart16550_do_close
c_func
(paren
id|uart
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|snd_uart16550_buffer_can_write
r_inline
r_static
r_int
id|snd_uart16550_buffer_can_write
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
comma
r_int
id|Num
)paren
(brace
r_if
c_cond
(paren
id|uart-&gt;buff_in_count
op_plus
id|Num
OL
id|TX_BUFF_SIZE
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_uart16550_write_buffer
r_inline
r_static
r_int
id|snd_uart16550_write_buffer
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
comma
r_int
r_char
id|byte
)paren
(brace
r_int
r_int
id|buff_in
op_assign
id|uart-&gt;buff_in
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;buff_in_count
OL
id|TX_BUFF_SIZE
)paren
(brace
id|uart-&gt;tx_buff
(braket
id|buff_in
)braket
op_assign
id|byte
suffix:semicolon
id|buff_in
op_increment
suffix:semicolon
id|buff_in
op_and_assign
id|TX_BUFF_MASK
suffix:semicolon
id|uart-&gt;buff_in
op_assign
id|buff_in
suffix:semicolon
id|uart-&gt;buff_in_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;irq
OL
l_int|0
)paren
multiline_comment|/* polling mode */
id|snd_uart16550_add_timer
c_func
(paren
id|uart
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_uart16550_output_byte
r_static
r_int
id|snd_uart16550_output_byte
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
comma
id|snd_rawmidi_substream_t
op_star
id|substream
comma
r_int
r_char
id|midi_byte
)paren
(brace
r_if
c_cond
(paren
id|uart-&gt;buff_in_count
op_eq
l_int|0
multiline_comment|/* Buffer empty? */
op_logical_and
(paren
(paren
id|uart-&gt;adaptor
op_ne
id|SNDRV_SERIAL_MS124W_SA
op_logical_and
id|uart-&gt;adaptor
op_ne
id|SNDRV_SERIAL_GENERIC
)paren
op_logical_or
(paren
id|uart-&gt;fifo_count
op_eq
l_int|0
multiline_comment|/* FIFO empty? */
op_logical_and
(paren
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_MSR
)paren
op_amp
id|UART_MSR_CTS
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* CTS? */
multiline_comment|/* Tx Buffer Empty - try to write immediately */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|uart-&gt;base
op_plus
id|UART_LSR
)paren
op_amp
id|UART_LSR_THRE
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Transmitter holding register (and Tx FIFO) empty */
id|uart-&gt;fifo_count
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|midi_byte
comma
id|uart-&gt;base
op_plus
id|UART_TX
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|uart-&gt;fifo_count
OL
id|uart-&gt;fifo_limit
)paren
(brace
id|uart-&gt;fifo_count
op_increment
suffix:semicolon
id|outb
c_func
(paren
id|midi_byte
comma
id|uart-&gt;base
op_plus
id|UART_TX
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Cannot write (buffer empty) - put char in buffer */
id|snd_uart16550_write_buffer
c_func
(paren
id|uart
comma
id|midi_byte
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|snd_uart16550_write_buffer
c_func
(paren
id|uart
comma
id|midi_byte
)paren
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;%s: Buffer overrun on device at 0x%lx&bslash;n&quot;
comma
id|uart-&gt;rmidi-&gt;name
comma
id|uart-&gt;base
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|snd_uart16550_output_write
r_static
r_void
id|snd_uart16550_output_write
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|midi_byte
comma
id|addr_byte
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_uart16550_t
comma
id|substream-&gt;rmidi-&gt;private_data
comma
r_return
)paren
suffix:semicolon
r_char
id|first
suffix:semicolon
r_static
r_int
r_int
id|lasttime
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Interupts are disabled during the updating of the tx_buff,&n;&t; * since it is &squot;bad&squot; to have two processes updating the same&n;&t; * variables (ie buff_in &amp; buff_out)&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;irq
OL
l_int|0
)paren
singleline_comment|//polling
id|snd_uart16550_io_loop
c_func
(paren
id|uart
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_MS124W_MB
)paren
(brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* buffer full? */
multiline_comment|/* in this mode we need two bytes of space */
r_if
c_cond
(paren
id|uart-&gt;buff_in_count
OG
id|TX_BUFF_SIZE
op_minus
l_int|2
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|snd_rawmidi_transmit
c_func
(paren
id|substream
comma
op_amp
id|midi_byte
comma
l_int|1
)paren
op_ne
l_int|1
)paren
r_break
suffix:semicolon
macro_line|#if SNDRV_SERIAL_MS124W_MB_NOCOMBO
multiline_comment|/* select exactly one of the four ports */
id|addr_byte
op_assign
(paren
l_int|1
op_lshift
(paren
id|substream-&gt;number
op_plus
l_int|4
)paren
)paren
op_or
l_int|0x08
suffix:semicolon
macro_line|#else
multiline_comment|/* select any combination of the four ports */
id|addr_byte
op_assign
(paren
id|substream-&gt;number
op_lshift
l_int|4
)paren
op_or
l_int|0x08
suffix:semicolon
multiline_comment|/* ...except none */
r_if
c_cond
(paren
id|addr_byte
op_eq
l_int|0x08
)paren
id|addr_byte
op_assign
l_int|0xf8
suffix:semicolon
macro_line|#endif
id|snd_uart16550_output_byte
c_func
(paren
id|uart
comma
id|substream
comma
id|addr_byte
)paren
suffix:semicolon
multiline_comment|/* send midi byte */
id|snd_uart16550_output_byte
c_func
(paren
id|uart
comma
id|substream
comma
id|midi_byte
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|first
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
op_eq
id|snd_rawmidi_transmit_peek
c_func
(paren
id|substream
comma
op_amp
id|midi_byte
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/* Also send F5 after 3 seconds with no data to handle device disconnect */
r_if
c_cond
(paren
id|first
op_eq
l_int|0
op_logical_and
(paren
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_SOUNDCANVAS
op_logical_or
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_GENERIC
)paren
op_logical_and
(paren
id|uart-&gt;prev_out
op_ne
id|substream-&gt;number
op_logical_or
id|jiffies
op_minus
id|lasttime
OG
l_int|3
op_star
id|HZ
)paren
)paren
(brace
r_if
c_cond
(paren
id|snd_uart16550_buffer_can_write
c_func
(paren
id|uart
comma
l_int|3
)paren
)paren
(brace
multiline_comment|/* Roland Soundcanvas part selection */
multiline_comment|/* If this substream of the data is different previous&n;&t;&t;&t;&t;&t;   substream in this uart, send the change part event */
id|uart-&gt;prev_out
op_assign
id|substream-&gt;number
suffix:semicolon
multiline_comment|/* change part */
id|snd_uart16550_output_byte
c_func
(paren
id|uart
comma
id|substream
comma
l_int|0xf5
)paren
suffix:semicolon
multiline_comment|/* data */
id|snd_uart16550_output_byte
c_func
(paren
id|uart
comma
id|substream
comma
id|uart-&gt;prev_out
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* If midi_byte is a data byte, send the previous status byte */
r_if
c_cond
(paren
(paren
id|midi_byte
OL
l_int|0x80
)paren
op_logical_and
(paren
id|uart-&gt;adaptor
op_eq
id|SNDRV_SERIAL_SOUNDCANVAS
)paren
)paren
id|snd_uart16550_output_byte
c_func
(paren
id|uart
comma
id|substream
comma
id|uart-&gt;prev_status
(braket
id|uart-&gt;prev_out
)braket
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|uart-&gt;drop_on_full
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* send midi byte */
r_if
c_cond
(paren
op_logical_neg
id|snd_uart16550_output_byte
c_func
(paren
id|uart
comma
id|substream
comma
id|midi_byte
)paren
op_logical_and
op_logical_neg
id|uart-&gt;drop_on_full
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|midi_byte
op_ge
l_int|0x80
op_logical_and
id|midi_byte
OL
l_int|0xf0
)paren
id|uart-&gt;prev_status
(braket
id|uart-&gt;prev_out
)braket
op_assign
id|midi_byte
suffix:semicolon
id|first
op_assign
l_int|1
suffix:semicolon
id|snd_rawmidi_transmit_ack
c_func
(paren
id|substream
comma
l_int|1
)paren
suffix:semicolon
)brace
id|lasttime
op_assign
id|jiffies
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_uart16550_output_trigger
r_static
r_void
id|snd_uart16550_output_trigger
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
comma
r_int
id|up
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_uart16550_t
comma
id|substream-&gt;rmidi-&gt;private_data
comma
r_return
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
(brace
id|uart-&gt;filemode
op_or_assign
id|SERIAL_MODE_OUTPUT_TRIGGERED
suffix:semicolon
)brace
r_else
(brace
id|uart-&gt;filemode
op_and_assign
op_complement
id|SERIAL_MODE_OUTPUT_TRIGGERED
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|uart-&gt;open_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
id|snd_uart16550_output_write
c_func
(paren
id|substream
)paren
suffix:semicolon
)brace
DECL|variable|snd_uart16550_output
r_static
id|snd_rawmidi_ops_t
id|snd_uart16550_output
op_assign
(brace
dot
id|open
op_assign
id|snd_uart16550_output_open
comma
dot
id|close
op_assign
id|snd_uart16550_output_close
comma
dot
id|trigger
op_assign
id|snd_uart16550_output_trigger
comma
)brace
suffix:semicolon
DECL|variable|snd_uart16550_input
r_static
id|snd_rawmidi_ops_t
id|snd_uart16550_input
op_assign
(brace
dot
id|open
op_assign
id|snd_uart16550_input_open
comma
dot
id|close
op_assign
id|snd_uart16550_input_close
comma
dot
id|trigger
op_assign
id|snd_uart16550_input_trigger
comma
)brace
suffix:semicolon
DECL|function|snd_uart16550_free
r_static
r_int
id|snd_uart16550_free
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
)paren
(brace
r_if
c_cond
(paren
id|uart-&gt;irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|uart-&gt;irq
comma
(paren
r_void
op_star
)paren
id|uart
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart-&gt;res_base
)paren
(brace
id|release_resource
c_func
(paren
id|uart-&gt;res_base
)paren
suffix:semicolon
id|kfree_nocheck
c_func
(paren
id|uart-&gt;res_base
)paren
suffix:semicolon
)brace
id|snd_magic_kfree
c_func
(paren
id|uart
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|snd_uart16550_dev_free
r_static
r_int
id|snd_uart16550_dev_free
c_func
(paren
id|snd_device_t
op_star
id|device
)paren
(brace
id|snd_uart16550_t
op_star
id|uart
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_uart16550_t
comma
id|device-&gt;device_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_return
id|snd_uart16550_free
c_func
(paren
id|uart
)paren
suffix:semicolon
)brace
DECL|function|snd_uart16550_create
r_static
r_int
id|__init
id|snd_uart16550_create
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
r_int
id|iobase
comma
r_int
id|irq
comma
r_int
r_int
id|speed
comma
r_int
r_int
id|base
comma
r_int
id|adaptor
comma
r_int
id|droponfull
comma
id|snd_uart16550_t
op_star
op_star
id|ruart
)paren
(brace
r_static
id|snd_device_ops_t
id|ops
op_assign
(brace
dot
id|dev_free
op_assign
id|snd_uart16550_dev_free
comma
)brace
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|uart
op_assign
id|snd_magic_kcalloc
c_func
(paren
id|snd_uart16550_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|uart-&gt;adaptor
op_assign
id|adaptor
suffix:semicolon
id|uart-&gt;card
op_assign
id|card
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|uart-&gt;open_lock
)paren
suffix:semicolon
id|uart-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|uart-&gt;base
op_assign
id|iobase
suffix:semicolon
id|uart-&gt;drop_on_full
op_assign
id|droponfull
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_uart16550_detect
c_func
(paren
id|uart
)paren
)paren
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;no UART detected at 0x%lx&bslash;n&quot;
comma
id|iobase
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|snd_uart16550_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;Serial MIDI&quot;
comma
(paren
r_void
op_star
)paren
id|uart
)paren
)paren
(brace
id|uart-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|snd_printk
c_func
(paren
l_string|&quot;irq %d busy. Using Polling.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
)brace
r_else
(brace
id|uart-&gt;irq
op_assign
id|irq
suffix:semicolon
)brace
)brace
id|uart-&gt;divisor
op_assign
id|base
op_div
id|speed
suffix:semicolon
id|uart-&gt;speed
op_assign
id|base
op_div
(paren
r_int
r_int
)paren
id|uart-&gt;divisor
suffix:semicolon
id|uart-&gt;speed_base
op_assign
id|base
suffix:semicolon
id|uart-&gt;prev_out
op_assign
op_minus
l_int|1
suffix:semicolon
id|uart-&gt;prev_in
op_assign
l_int|0
suffix:semicolon
id|uart-&gt;rstatus
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|uart-&gt;prev_status
comma
l_int|0x80
comma
r_sizeof
(paren
r_int
r_char
)paren
op_star
id|SNDRV_SERIAL_MAX_OUTS
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|uart-&gt;buffer_timer
)paren
suffix:semicolon
id|uart-&gt;buffer_timer.function
op_assign
id|snd_uart16550_buffer_timer
suffix:semicolon
id|uart-&gt;buffer_timer.data
op_assign
(paren
r_int
r_int
)paren
id|uart
suffix:semicolon
id|uart-&gt;timer_running
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Register device */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_device_new
c_func
(paren
id|card
comma
id|SNDRV_DEV_LOWLEVEL
comma
id|uart
comma
op_amp
id|ops
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_uart16550_free
c_func
(paren
id|uart
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|uart-&gt;adaptor
)paren
(brace
r_case
id|SNDRV_SERIAL_MS124W_SA
suffix:colon
r_case
id|SNDRV_SERIAL_MS124W_MB
suffix:colon
multiline_comment|/* MS-124W can draw power from RTS and DTR if they&n;&t;&t;   are in opposite states. */
id|outb
c_func
(paren
id|UART_MCR_RTS
op_or
(paren
l_int|0
op_amp
id|UART_MCR_DTR
)paren
comma
id|uart-&gt;base
op_plus
id|UART_MCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SERIAL_MS124T
suffix:colon
multiline_comment|/* MS-124T can draw power from RTS and/or DTR (preferably&n;&t;&t;   both) if they are asserted. */
id|outb
c_func
(paren
id|UART_MCR_RTS
op_or
id|UART_MCR_DTR
comma
id|uart-&gt;base
op_plus
id|UART_MCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ruart
)paren
op_star
id|ruart
op_assign
id|uart
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_uart16550_rmidi
r_static
r_int
id|__init
id|snd_uart16550_rmidi
c_func
(paren
id|snd_uart16550_t
op_star
id|uart
comma
r_int
id|device
comma
r_int
id|outs
comma
r_int
id|ins
comma
id|snd_rawmidi_t
op_star
op_star
id|rmidi
)paren
(brace
id|snd_rawmidi_t
op_star
id|rrawmidi
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_rawmidi_new
c_func
(paren
id|uart-&gt;card
comma
l_string|&quot;UART Serial MIDI&quot;
comma
id|device
comma
id|outs
comma
id|ins
comma
op_amp
id|rrawmidi
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|snd_rawmidi_set_ops
c_func
(paren
id|rrawmidi
comma
id|SNDRV_RAWMIDI_STREAM_INPUT
comma
op_amp
id|snd_uart16550_input
)paren
suffix:semicolon
id|snd_rawmidi_set_ops
c_func
(paren
id|rrawmidi
comma
id|SNDRV_RAWMIDI_STREAM_OUTPUT
comma
op_amp
id|snd_uart16550_output
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|rrawmidi-&gt;name
comma
l_string|&quot;uart16550 MIDI #%d&quot;
comma
id|device
)paren
suffix:semicolon
id|rrawmidi-&gt;info_flags
op_assign
id|SNDRV_RAWMIDI_INFO_OUTPUT
op_or
id|SNDRV_RAWMIDI_INFO_INPUT
op_or
id|SNDRV_RAWMIDI_INFO_DUPLEX
suffix:semicolon
id|rrawmidi-&gt;private_data
op_assign
id|uart
suffix:semicolon
r_if
c_cond
(paren
id|rmidi
)paren
op_star
id|rmidi
op_assign
id|rrawmidi
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_serial_probe
r_static
r_int
id|__init
id|snd_serial_probe
c_func
(paren
r_int
id|dev
)paren
(brace
id|snd_card_t
op_star
id|card
suffix:semicolon
id|snd_uart16550_t
op_star
id|uart
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|enable
(braket
id|dev
)braket
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_switch
c_cond
(paren
id|adaptor
(braket
id|dev
)braket
)paren
(brace
r_case
id|SNDRV_SERIAL_SOUNDCANVAS
suffix:colon
id|ins
(braket
id|dev
)braket
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SERIAL_MS124T
suffix:colon
r_case
id|SNDRV_SERIAL_MS124W_SA
suffix:colon
id|outs
(braket
id|dev
)braket
op_assign
l_int|1
suffix:semicolon
id|ins
(braket
id|dev
)braket
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SERIAL_MS124W_MB
suffix:colon
id|outs
(braket
id|dev
)braket
op_assign
l_int|16
suffix:semicolon
id|ins
(braket
id|dev
)braket
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SERIAL_GENERIC
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|snd_printk
c_func
(paren
l_string|&quot;Adaptor type is out of range 0-%d (%d)&bslash;n&quot;
comma
id|SNDRV_SERIAL_MAX_ADAPTOR
comma
id|adaptor
(braket
id|dev
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|outs
(braket
id|dev
)braket
template_param
id|SNDRV_SERIAL_MAX_OUTS
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;Count of outputs is out of range 1-%d (%d)&bslash;n&quot;
comma
id|SNDRV_SERIAL_MAX_OUTS
comma
id|outs
(braket
id|dev
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ins
(braket
id|dev
)braket
template_param
id|SNDRV_SERIAL_MAX_INS
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;Count of inputs is out of range 1-%d (%d)&bslash;n&quot;
comma
id|SNDRV_SERIAL_MAX_INS
comma
id|ins
(braket
id|dev
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|card
op_assign
id|snd_card_new
c_func
(paren
id|index
(braket
id|dev
)braket
comma
id|id
(braket
id|dev
)braket
comma
id|THIS_MODULE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;driver
comma
l_string|&quot;Serial&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;shortname
comma
l_string|&quot;Serial midi (uart16550A)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_uart16550_create
c_func
(paren
id|card
comma
id|port
(braket
id|dev
)braket
comma
id|irq
(braket
id|dev
)braket
comma
id|speed
(braket
id|dev
)braket
comma
id|base
(braket
id|dev
)braket
comma
id|adaptor
(braket
id|dev
)braket
comma
id|droponfull
(braket
id|dev
)braket
comma
op_amp
id|uart
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_uart16550_rmidi
c_func
(paren
id|uart
comma
l_int|0
comma
id|outs
(braket
id|dev
)braket
comma
id|ins
(braket
id|dev
)braket
comma
op_amp
id|uart-&gt;rmidi
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|card-&gt;longname
comma
l_string|&quot;%s at 0x%lx, irq %d speed %d div %d outs %d ins %d adaptor %s droponfull %d&quot;
comma
id|card-&gt;shortname
comma
id|uart-&gt;base
comma
id|uart-&gt;irq
comma
id|uart-&gt;speed
comma
(paren
r_int
)paren
id|uart-&gt;divisor
comma
id|outs
(braket
id|dev
)braket
comma
id|ins
(braket
id|dev
)braket
comma
id|adaptor_names
(braket
id|uart-&gt;adaptor
)braket
comma
id|uart-&gt;drop_on_full
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_register
c_func
(paren
id|card
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|snd_serial_cards
(braket
id|dev
)braket
op_assign
id|card
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alsa_card_serial_init
r_static
r_int
id|__init
id|alsa_card_serial_init
c_func
(paren
r_void
)paren
(brace
r_int
id|dev
op_assign
l_int|0
suffix:semicolon
r_int
id|cards
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|SNDRV_CARDS
suffix:semicolon
id|dev
op_increment
)paren
(brace
r_if
c_cond
(paren
id|snd_serial_probe
c_func
(paren
id|dev
)paren
op_eq
l_int|0
)paren
id|cards
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cards
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef MODULE
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;serial midi soundcard not found or device busy&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alsa_card_serial_exit
r_static
r_void
id|__exit
id|alsa_card_serial_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|dev
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
l_int|0
suffix:semicolon
id|dev
OL
id|SNDRV_CARDS
suffix:semicolon
id|dev
op_increment
)paren
(brace
r_if
c_cond
(paren
id|snd_serial_cards
(braket
id|dev
)braket
op_ne
l_int|NULL
)paren
id|snd_card_free
c_func
(paren
id|snd_serial_cards
(braket
id|dev
)braket
)paren
suffix:semicolon
)brace
)brace
id|module_init
c_func
(paren
id|alsa_card_serial_init
)paren
id|module_exit
c_func
(paren
id|alsa_card_serial_exit
)paren
macro_line|#ifndef MODULE
multiline_comment|/* format is: snd-serial=enable,index,id,&n;&t;&t;&t; port,irq,speed,base,outs,&n; &t;&t;&t; ins,adaptor,droponfull */
DECL|function|alsa_card_serial_setup
r_static
r_int
id|__init
id|alsa_card_serial_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_static
r_int
id|__initdata
id|nr_dev
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nr_dev
op_ge
id|SNDRV_CARDS
)paren
r_return
l_int|0
suffix:semicolon
(paren
r_void
)paren
(paren
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|enable
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|index
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_id
c_func
(paren
op_amp
id|str
comma
op_amp
id|id
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option_long
c_func
(paren
op_amp
id|str
comma
op_amp
id|port
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|irq
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|speed
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|base
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|outs
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|ins
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|adaptor
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|droponfull
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
)paren
suffix:semicolon
id|nr_dev
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;snd-serial=&quot;
comma
id|alsa_card_serial_setup
)paren
suffix:semicolon
macro_line|#endif /* ifndef MODULE */
eof
