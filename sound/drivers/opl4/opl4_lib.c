multiline_comment|/*&n; * Functions for accessing OPL4 devices&n; * Copyright (c) 2003 by Clemens Ladisch &lt;clemens@ladisch.de&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &quot;opl4_local.h&quot;
macro_line|#include &lt;sound/initval.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Clemens Ladisch &lt;clemens@ladisch.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;OPL4 driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|snd_opl4_wait
r_static
r_void
r_inline
id|snd_opl4_wait
c_func
(paren
id|opl4_t
op_star
id|opl4
)paren
(brace
r_int
id|timeout
op_assign
l_int|10
suffix:semicolon
r_while
c_loop
(paren
(paren
id|inb
c_func
(paren
id|opl4-&gt;fm_port
)paren
op_amp
id|OPL4_STATUS_BUSY
)paren
op_logical_and
op_decrement
id|timeout
OG
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|snd_opl4_write
r_void
id|snd_opl4_write
c_func
(paren
id|opl4_t
op_star
id|opl4
comma
id|u8
id|reg
comma
id|u8
id|value
)paren
(brace
id|snd_opl4_wait
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|opl4-&gt;pcm_port
)paren
suffix:semicolon
id|snd_opl4_wait
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|opl4-&gt;pcm_port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|snd_opl4_read
id|u8
id|snd_opl4_read
c_func
(paren
id|opl4_t
op_star
id|opl4
comma
id|u8
id|reg
)paren
(brace
id|snd_opl4_wait
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|opl4-&gt;pcm_port
)paren
suffix:semicolon
id|snd_opl4_wait
c_func
(paren
id|opl4
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|opl4-&gt;pcm_port
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|snd_opl4_read_memory
r_void
id|snd_opl4_read_memory
c_func
(paren
id|opl4_t
op_star
id|opl4
comma
r_char
op_star
id|buf
comma
r_int
id|offset
comma
r_int
id|size
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|memcfg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl4-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|memcfg
op_assign
id|snd_opl4_read
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_CONFIGURATION
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_CONFIGURATION
comma
id|memcfg
op_or
id|OPL4_MODE_BIT
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_ADDRESS_HIGH
comma
id|offset
op_rshift
l_int|16
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_ADDRESS_MID
comma
id|offset
op_rshift
l_int|8
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_ADDRESS_LOW
comma
id|offset
)paren
suffix:semicolon
id|snd_opl4_wait
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|OPL4_REG_MEMORY_DATA
comma
id|opl4-&gt;pcm_port
)paren
suffix:semicolon
id|snd_opl4_wait
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|insb
c_func
(paren
id|opl4-&gt;pcm_port
op_plus
l_int|1
comma
id|buf
comma
id|size
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_CONFIGURATION
comma
id|memcfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl4-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_opl4_write_memory
r_void
id|snd_opl4_write_memory
c_func
(paren
id|opl4_t
op_star
id|opl4
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|offset
comma
r_int
id|size
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|memcfg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl4-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|memcfg
op_assign
id|snd_opl4_read
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_CONFIGURATION
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_CONFIGURATION
comma
id|memcfg
op_or
id|OPL4_MODE_BIT
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_ADDRESS_HIGH
comma
id|offset
op_rshift
l_int|16
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_ADDRESS_MID
comma
id|offset
op_rshift
l_int|8
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_ADDRESS_LOW
comma
id|offset
)paren
suffix:semicolon
id|snd_opl4_wait
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|outb
c_func
(paren
id|OPL4_REG_MEMORY_DATA
comma
id|opl4-&gt;pcm_port
)paren
suffix:semicolon
id|snd_opl4_wait
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|outsb
c_func
(paren
id|opl4-&gt;pcm_port
op_plus
l_int|1
comma
id|buf
comma
id|size
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_CONFIGURATION
comma
id|memcfg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl4-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_opl4_enable_opl4
r_static
r_void
id|snd_opl4_enable_opl4
c_func
(paren
id|opl4_t
op_star
id|opl4
)paren
(brace
id|outb
c_func
(paren
id|OPL3_REG_MODE
comma
id|opl4-&gt;fm_port
op_plus
l_int|2
)paren
suffix:semicolon
id|inb
c_func
(paren
id|opl4-&gt;fm_port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|opl4-&gt;fm_port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|OPL3_OPL3_ENABLE
op_or
id|OPL3_OPL4_ENABLE
comma
id|opl4-&gt;fm_port
op_plus
l_int|3
)paren
suffix:semicolon
id|inb
c_func
(paren
id|opl4-&gt;fm_port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|opl4-&gt;fm_port
)paren
suffix:semicolon
)brace
DECL|function|snd_opl4_detect
r_static
r_int
id|snd_opl4_detect
c_func
(paren
id|opl4_t
op_star
id|opl4
)paren
(brace
id|u8
id|id1
comma
id|id2
suffix:semicolon
id|snd_opl4_enable_opl4
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|id1
op_assign
id|snd_opl4_read
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_CONFIGURATION
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;OPL4[02]=%02x&bslash;n&quot;
comma
id|id1
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|id1
op_amp
id|OPL4_DEVICE_ID_MASK
)paren
(brace
r_case
l_int|0x20
suffix:colon
id|opl4-&gt;hardware
op_assign
id|OPL3_HW_OPL4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
id|opl4-&gt;hardware
op_assign
id|OPL3_HW_OPL4_ML
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MIX_CONTROL_FM
comma
l_int|0x00
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MIX_CONTROL_PCM
comma
l_int|0xff
)paren
suffix:semicolon
id|id1
op_assign
id|snd_opl4_read
c_func
(paren
id|opl4
comma
id|OPL4_REG_MIX_CONTROL_FM
)paren
suffix:semicolon
id|id2
op_assign
id|snd_opl4_read
c_func
(paren
id|opl4
comma
id|OPL4_REG_MIX_CONTROL_PCM
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;OPL4 id1=%02x id2=%02x&bslash;n&quot;
comma
id|id1
comma
id|id2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id1
op_ne
l_int|0x00
op_logical_or
id|id2
op_ne
l_int|0xff
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MIX_CONTROL_FM
comma
l_int|0x3f
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MIX_CONTROL_PCM
comma
l_int|0x3f
)paren
suffix:semicolon
id|snd_opl4_write
c_func
(paren
id|opl4
comma
id|OPL4_REG_MEMORY_CONFIGURATION
comma
l_int|0x00
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_SND_SEQUENCER) || (defined(MODULE) &amp;&amp; defined(CONFIG_SND_SEQUENCER_MODULE))
DECL|function|snd_opl4_seq_dev_free
r_static
r_void
id|snd_opl4_seq_dev_free
c_func
(paren
id|snd_seq_device_t
op_star
id|seq_dev
)paren
(brace
id|opl4_t
op_star
id|opl4
op_assign
id|seq_dev-&gt;private_data
suffix:semicolon
id|opl4-&gt;seq_dev
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|snd_opl4_create_seq_dev
r_static
r_int
id|snd_opl4_create_seq_dev
c_func
(paren
id|opl4_t
op_star
id|opl4
comma
r_int
id|seq_device
)paren
(brace
id|opl4-&gt;seq_dev_num
op_assign
id|seq_device
suffix:semicolon
r_if
c_cond
(paren
id|snd_seq_device_new
c_func
(paren
id|opl4-&gt;card
comma
id|seq_device
comma
id|SNDRV_SEQ_DEV_ID_OPL4
comma
r_sizeof
(paren
id|opl4_t
op_star
)paren
comma
op_amp
id|opl4-&gt;seq_dev
)paren
op_ge
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|opl4-&gt;seq_dev-&gt;name
comma
l_string|&quot;OPL4 Wavetable&quot;
)paren
suffix:semicolon
op_star
(paren
id|opl4_t
op_star
op_star
)paren
id|SNDRV_SEQ_DEVICE_ARGPTR
c_func
(paren
id|opl4-&gt;seq_dev
)paren
op_assign
id|opl4
suffix:semicolon
id|opl4-&gt;seq_dev-&gt;private_data
op_assign
id|opl4
suffix:semicolon
id|opl4-&gt;seq_dev-&gt;private_free
op_assign
id|snd_opl4_seq_dev_free
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|snd_opl4_free
r_static
r_void
id|snd_opl4_free
c_func
(paren
id|opl4_t
op_star
id|opl4
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS
id|snd_opl4_free_proc
c_func
(paren
id|opl4
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|opl4-&gt;res_fm_port
)paren
(brace
id|release_resource
c_func
(paren
id|opl4-&gt;res_fm_port
)paren
suffix:semicolon
id|kfree_nocheck
c_func
(paren
id|opl4-&gt;res_fm_port
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opl4-&gt;res_pcm_port
)paren
(brace
id|release_resource
c_func
(paren
id|opl4-&gt;res_pcm_port
)paren
suffix:semicolon
id|kfree_nocheck
c_func
(paren
id|opl4-&gt;res_pcm_port
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|opl4
)paren
suffix:semicolon
)brace
DECL|function|snd_opl4_dev_free
r_static
r_int
id|snd_opl4_dev_free
c_func
(paren
id|snd_device_t
op_star
id|device
)paren
(brace
id|opl4_t
op_star
id|opl4
op_assign
id|device-&gt;device_data
suffix:semicolon
id|snd_opl4_free
c_func
(paren
id|opl4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_opl4_create
r_int
id|snd_opl4_create
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
r_int
id|fm_port
comma
r_int
r_int
id|pcm_port
comma
r_int
id|seq_device
comma
id|opl3_t
op_star
op_star
id|ropl3
comma
id|opl4_t
op_star
op_star
id|ropl4
)paren
(brace
id|opl4_t
op_star
id|opl4
suffix:semicolon
id|opl3_t
op_star
id|opl3
suffix:semicolon
r_int
id|err
suffix:semicolon
r_static
id|snd_device_ops_t
id|ops
op_assign
(brace
dot
id|dev_free
op_assign
id|snd_opl4_dev_free
)brace
suffix:semicolon
r_if
c_cond
(paren
id|ropl3
)paren
op_star
id|ropl3
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ropl4
)paren
op_star
id|ropl4
op_assign
l_int|NULL
suffix:semicolon
id|opl4
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|opl4
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|opl4
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|opl4-&gt;res_fm_port
op_assign
id|request_region
c_func
(paren
id|fm_port
comma
l_int|8
comma
l_string|&quot;OPL4 FM&quot;
)paren
suffix:semicolon
id|opl4-&gt;res_pcm_port
op_assign
id|request_region
c_func
(paren
id|pcm_port
comma
l_int|8
comma
l_string|&quot;OPL4 PCM/MIX&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|opl4-&gt;res_fm_port
op_logical_or
op_logical_neg
id|opl4-&gt;res_pcm_port
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;opl4: can&squot;t grab ports 0x%lx, 0x%lx&bslash;n&quot;
comma
id|fm_port
comma
id|pcm_port
)paren
suffix:semicolon
id|snd_opl4_free
c_func
(paren
id|opl4
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|opl4-&gt;card
op_assign
id|card
suffix:semicolon
id|opl4-&gt;fm_port
op_assign
id|fm_port
suffix:semicolon
id|opl4-&gt;pcm_port
op_assign
id|pcm_port
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|opl4-&gt;reg_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|opl4-&gt;access_mutex
)paren
suffix:semicolon
id|err
op_assign
id|snd_opl4_detect
c_func
(paren
id|opl4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_opl4_free
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|snd_printd
c_func
(paren
l_string|&quot;OPL4 chip not detected at %#lx/%#lx&bslash;n&quot;
comma
id|fm_port
comma
id|pcm_port
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|snd_device_new
c_func
(paren
id|card
comma
id|SNDRV_DEV_CODEC
comma
id|opl4
comma
op_amp
id|ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_opl4_free
c_func
(paren
id|opl4
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|snd_opl3_create
c_func
(paren
id|card
comma
id|fm_port
comma
id|fm_port
op_plus
l_int|2
comma
id|opl4-&gt;hardware
comma
l_int|1
comma
op_amp
id|opl3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_device_free
c_func
(paren
id|card
comma
id|opl4
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* opl3 initialization disabled opl4, so reenable */
id|snd_opl4_enable_opl4
c_func
(paren
id|opl4
)paren
suffix:semicolon
id|snd_opl4_create_mixer
c_func
(paren
id|opl4
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|snd_opl4_create_proc
c_func
(paren
id|opl4
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_SND_SEQUENCER) || (defined(MODULE) &amp;&amp; defined(CONFIG_SND_SEQUENCER_MODULE))
id|opl4-&gt;seq_client
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|opl4-&gt;hardware
OL
id|OPL3_HW_OPL4_ML
)paren
id|snd_opl4_create_seq_dev
c_func
(paren
id|opl4
comma
id|seq_device
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ropl3
)paren
op_star
id|ropl3
op_assign
id|opl3
suffix:semicolon
r_if
c_cond
(paren
id|ropl4
)paren
op_star
id|ropl4
op_assign
id|opl4
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|snd_opl4_write
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl4_write
)paren
suffix:semicolon
DECL|variable|snd_opl4_read
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl4_read
)paren
suffix:semicolon
DECL|variable|snd_opl4_write_memory
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl4_write_memory
)paren
suffix:semicolon
DECL|variable|snd_opl4_read_memory
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl4_read_memory
)paren
suffix:semicolon
DECL|variable|snd_opl4_create
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl4_create
)paren
suffix:semicolon
DECL|function|alsa_opl4_init
r_static
r_int
id|__init
id|alsa_opl4_init
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alsa_opl4_exit
r_static
r_void
id|__exit
id|alsa_opl4_exit
c_func
(paren
r_void
)paren
(brace
)brace
id|module_init
c_func
(paren
id|alsa_opl4_init
)paren
id|module_exit
c_func
(paren
id|alsa_opl4_exit
)paren
eof
