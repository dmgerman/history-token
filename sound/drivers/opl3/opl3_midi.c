multiline_comment|/*&n; *  Copyright (c) by Uros Bizjak &lt;uros@kss-loka.si&gt;&n; *&n; *  Midi synth routines for OPL2/OPL3/OPL4 FM&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
DECL|macro|DEBUG_ALLOC
macro_line|#undef DEBUG_ALLOC
DECL|macro|DEBUG_MIDI
macro_line|#undef DEBUG_MIDI
macro_line|#include &quot;opl3_voice.h&quot;
macro_line|#include &lt;sound/asoundef.h&gt;
r_extern
r_char
id|snd_opl3_regmap
(braket
id|MAX_OPL2_VOICES
)braket
(braket
l_int|4
)braket
suffix:semicolon
r_extern
r_int
id|use_internal_drums
suffix:semicolon
multiline_comment|/*&n; * The next table looks magical, but it certainly is not. Its values have&n; * been calculated as table[i]=8*log(i/64)/log(2) with an obvious exception&n; * for i=0. This log-table converts a linear volume-scaling (0..127) to a&n; * logarithmic scaling as present in the FM-synthesizer chips. so :    Volume&n; * 64 =  0 db = relative volume  0 and:    Volume 32 = -6 db = relative&n; * volume -8 it was implemented as a table because it is only 128 bytes and&n; * it saves a lot of log() calculations. (Rob Hooft &lt;hooft@chem.ruu.nl&gt;)&n; */
DECL|variable|opl3_volume_table
r_static
r_char
id|opl3_volume_table
(braket
l_int|128
)braket
op_assign
(brace
op_minus
l_int|63
comma
op_minus
l_int|48
comma
op_minus
l_int|40
comma
op_minus
l_int|35
comma
op_minus
l_int|32
comma
op_minus
l_int|29
comma
op_minus
l_int|27
comma
op_minus
l_int|26
comma
op_minus
l_int|24
comma
op_minus
l_int|23
comma
op_minus
l_int|21
comma
op_minus
l_int|20
comma
op_minus
l_int|19
comma
op_minus
l_int|18
comma
op_minus
l_int|18
comma
op_minus
l_int|17
comma
op_minus
l_int|16
comma
op_minus
l_int|15
comma
op_minus
l_int|15
comma
op_minus
l_int|14
comma
op_minus
l_int|13
comma
op_minus
l_int|13
comma
op_minus
l_int|12
comma
op_minus
l_int|12
comma
op_minus
l_int|11
comma
op_minus
l_int|11
comma
op_minus
l_int|10
comma
op_minus
l_int|10
comma
op_minus
l_int|10
comma
op_minus
l_int|9
comma
op_minus
l_int|9
comma
op_minus
l_int|8
comma
op_minus
l_int|8
comma
op_minus
l_int|8
comma
op_minus
l_int|7
comma
op_minus
l_int|7
comma
op_minus
l_int|7
comma
op_minus
l_int|6
comma
op_minus
l_int|6
comma
op_minus
l_int|6
comma
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
op_minus
l_int|4
comma
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|3
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|2
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
)brace
suffix:semicolon
DECL|function|snd_opl3_calc_volume
r_void
id|snd_opl3_calc_volume
c_func
(paren
r_int
r_char
op_star
id|volbyte
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
r_int
id|oldvol
comma
id|newvol
comma
id|n
suffix:semicolon
r_int
id|volume
suffix:semicolon
id|volume
op_assign
(paren
id|vel
op_star
id|chan-&gt;gm_volume
op_star
id|chan-&gt;gm_expression
)paren
op_div
(paren
l_int|127
op_star
l_int|127
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume
OG
l_int|127
)paren
id|volume
op_assign
l_int|127
suffix:semicolon
id|oldvol
op_assign
id|OPL3_TOTAL_LEVEL_MASK
op_minus
(paren
op_star
id|volbyte
op_amp
id|OPL3_TOTAL_LEVEL_MASK
)paren
suffix:semicolon
id|newvol
op_assign
id|opl3_volume_table
(braket
id|volume
)braket
op_plus
id|oldvol
suffix:semicolon
r_if
c_cond
(paren
id|newvol
OG
id|OPL3_TOTAL_LEVEL_MASK
)paren
id|newvol
op_assign
id|OPL3_TOTAL_LEVEL_MASK
suffix:semicolon
r_else
r_if
c_cond
(paren
id|newvol
OL
l_int|0
)paren
id|newvol
op_assign
l_int|0
suffix:semicolon
id|n
op_assign
id|OPL3_TOTAL_LEVEL_MASK
op_minus
(paren
id|newvol
op_amp
id|OPL3_TOTAL_LEVEL_MASK
)paren
suffix:semicolon
op_star
id|volbyte
op_assign
(paren
op_star
id|volbyte
op_amp
id|OPL3_KSL_MASK
)paren
op_or
(paren
id|n
op_amp
id|OPL3_TOTAL_LEVEL_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Converts the note frequency to block and fnum values for the FM chip&n; */
DECL|variable|opl3_note_table
r_static
r_int
id|opl3_note_table
(braket
l_int|16
)braket
op_assign
(brace
l_int|305
comma
l_int|323
comma
multiline_comment|/* for pitch bending, -2 semitones */
l_int|343
comma
l_int|363
comma
l_int|385
comma
l_int|408
comma
l_int|432
comma
l_int|458
comma
l_int|485
comma
l_int|514
comma
l_int|544
comma
l_int|577
comma
l_int|611
comma
l_int|647
comma
l_int|686
comma
l_int|726
multiline_comment|/* for pitch bending, +2 semitones */
)brace
suffix:semicolon
DECL|function|snd_opl3_calc_pitch
r_static
r_void
id|snd_opl3_calc_pitch
c_func
(paren
r_int
r_char
op_star
id|fnum
comma
r_int
r_char
op_star
id|blocknum
comma
r_int
id|note
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
r_int
id|block
op_assign
(paren
(paren
id|note
op_div
l_int|12
)paren
op_amp
l_int|0x07
)paren
op_minus
l_int|1
suffix:semicolon
r_int
id|idx
op_assign
(paren
id|note
op_mod
l_int|12
)paren
op_plus
l_int|2
suffix:semicolon
r_int
id|freq
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;midi_pitchbend
)paren
(brace
r_int
id|pitchbend
op_assign
id|chan-&gt;midi_pitchbend
suffix:semicolon
r_int
id|segment
suffix:semicolon
r_if
c_cond
(paren
id|pitchbend
OG
l_int|0x1FFF
)paren
id|pitchbend
op_assign
l_int|0x1FFF
suffix:semicolon
id|segment
op_assign
id|pitchbend
op_div
l_int|0x1000
suffix:semicolon
id|freq
op_assign
id|opl3_note_table
(braket
id|idx
op_plus
id|segment
)braket
suffix:semicolon
id|freq
op_add_assign
(paren
(paren
id|opl3_note_table
(braket
id|idx
op_plus
id|segment
op_plus
l_int|1
)braket
op_minus
id|freq
)paren
op_star
(paren
id|pitchbend
op_mod
l_int|0x1000
)paren
)paren
op_div
l_int|0x1000
suffix:semicolon
)brace
r_else
(brace
id|freq
op_assign
id|opl3_note_table
(braket
id|idx
)braket
suffix:semicolon
)brace
op_star
id|fnum
op_assign
(paren
r_int
r_char
)paren
id|freq
suffix:semicolon
op_star
id|blocknum
op_assign
(paren
(paren
id|freq
op_rshift
l_int|8
)paren
op_amp
id|OPL3_FNUM_HIGH_MASK
)paren
op_or
(paren
(paren
id|block
op_lshift
l_int|2
)paren
op_amp
id|OPL3_BLOCKNUM_MASK
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_ALLOC
DECL|function|debug_alloc
r_static
r_void
id|debug_alloc
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_char
op_star
id|s
comma
r_int
id|voice
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|str
op_assign
l_string|&quot;x.24&quot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;time %.5i: %s [%.2i]: &quot;
comma
id|opl3-&gt;use_time
comma
id|s
comma
id|voice
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|opl3-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
op_star
(paren
id|str
op_plus
id|opl3-&gt;voices
(braket
id|i
)braket
dot
id|state
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Get a FM voice (channel) to play a note on.&n; */
DECL|function|opl3_get_voice
r_static
r_int
id|opl3_get_voice
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
id|instr_4op
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
r_int
id|chan_4op_1
suffix:semicolon
multiline_comment|/* first voice for 4op instrument */
r_int
id|chan_4op_2
suffix:semicolon
multiline_comment|/* second voice for 4op instrument */
id|snd_opl3_voice_t
op_star
id|vp
comma
op_star
id|vp2
suffix:semicolon
r_int
r_int
id|voice_time
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUG_ALLOC
r_char
op_star
id|alloc_type
(braket
l_int|3
)braket
op_assign
(brace
l_string|&quot;FREE     &quot;
comma
l_string|&quot;CHEAP    &quot;
comma
l_string|&quot;EXPENSIVE&quot;
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* This is our &quot;allocation cost&quot; table */
r_enum
(brace
id|FREE
op_assign
l_int|0
comma
id|CHEAP
comma
id|EXPENSIVE
comma
id|END
)brace
suffix:semicolon
multiline_comment|/* Keeps track of what we are finding */
r_struct
id|best
(brace
r_int
r_int
id|time
suffix:semicolon
r_int
id|voice
suffix:semicolon
)brace
id|best
(braket
id|END
)braket
suffix:semicolon
r_struct
id|best
op_star
id|bp
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|END
suffix:semicolon
id|i
op_increment
)paren
(brace
id|best
(braket
id|i
)braket
dot
id|time
op_assign
(paren
r_int
r_int
)paren
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* XXX MAX_?INT really */
suffix:semicolon
id|best
(braket
id|i
)braket
dot
id|voice
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Look through all the channels for the most suitable. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|opl3-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
op_eq
id|SNDRV_OPL3_ST_NOT_AVAIL
)paren
multiline_comment|/* skip unavailable channels, allocated by&n;&t;&t;     drum voices or by bounded 4op voices) */
r_continue
suffix:semicolon
id|voice_time
op_assign
id|vp-&gt;time
suffix:semicolon
id|bp
op_assign
id|best
suffix:semicolon
id|chan_4op_1
op_assign
(paren
(paren
id|i
OL
l_int|3
)paren
op_logical_or
(paren
id|i
OG
l_int|8
op_logical_and
id|i
OL
l_int|12
)paren
)paren
suffix:semicolon
id|chan_4op_2
op_assign
(paren
(paren
id|i
OG
l_int|2
op_logical_and
id|i
OL
l_int|6
)paren
op_logical_or
(paren
id|i
OG
l_int|11
op_logical_and
id|i
OL
l_int|15
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|instr_4op
)paren
(brace
multiline_comment|/* allocate 4op voice */
multiline_comment|/* skip channels unavailable to 4op instrument */
r_if
c_cond
(paren
op_logical_neg
id|chan_4op_1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
)paren
multiline_comment|/* kill one voice, CHEAP */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* get state of bounded 2op channel&n;&t;&t;&t;   to be allocated for 4op instrument */
id|vp2
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|i
op_plus
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp2-&gt;state
op_eq
id|SNDRV_OPL3_ST_ON_2OP
)paren
(brace
multiline_comment|/* kill two voices, EXPENSIVE */
id|bp
op_increment
suffix:semicolon
id|voice_time
op_assign
(paren
id|voice_time
OG
id|vp-&gt;time
)paren
ques
c_cond
id|voice_time
suffix:colon
id|vp-&gt;time
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* allocate 2op voice */
r_if
c_cond
(paren
(paren
id|chan_4op_1
)paren
op_logical_or
(paren
id|chan_4op_2
)paren
)paren
multiline_comment|/* use bounded channels for 2op, CHEAP */
id|bp
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|vp-&gt;state
)paren
multiline_comment|/* kill one voice on 2op channel, CHEAP */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* raise kill cost to EXPENSIVE for all channels */
r_if
c_cond
(paren
id|vp-&gt;state
)paren
id|bp
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|voice_time
OL
id|bp-&gt;time
)paren
(brace
id|bp-&gt;time
op_assign
id|voice_time
suffix:semicolon
id|bp-&gt;voice
op_assign
id|i
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|END
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|best
(braket
id|i
)braket
dot
id|voice
op_ge
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG_ALLOC
id|printk
c_func
(paren
l_string|&quot;%s %iop allocation on voice %i&bslash;n&quot;
comma
id|alloc_type
(braket
id|i
)braket
comma
id|instr_4op
ques
c_cond
l_int|4
suffix:colon
l_int|2
comma
id|best
(braket
id|i
)braket
dot
id|voice
)paren
suffix:semicolon
macro_line|#endif
r_return
id|best
(braket
id|i
)braket
dot
id|voice
suffix:semicolon
)brace
)brace
multiline_comment|/* not found */
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ------------------------------ */
multiline_comment|/*&n; * System timer interrupt function&n; */
DECL|function|snd_opl3_timer_func
r_void
id|snd_opl3_timer_func
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|opl3_t
op_star
id|opl3
op_assign
(paren
id|opl3_t
op_star
)paren
id|data
suffix:semicolon
r_int
id|again
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|opl3-&gt;sys_timer_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|opl3-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|snd_opl3_voice_t
op_star
id|vp
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
OG
l_int|0
op_logical_and
id|vp-&gt;note_off_check
)paren
(brace
r_if
c_cond
(paren
id|vp-&gt;note_off
op_eq
id|jiffies
)paren
id|snd_opl3_note_off
c_func
(paren
id|opl3
comma
id|vp-&gt;note
comma
l_int|0
comma
id|vp-&gt;chan
)paren
suffix:semicolon
r_else
id|again
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|again
)paren
(brace
id|opl3-&gt;tlist.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* invoke again */
id|add_timer
c_func
(paren
op_amp
id|opl3-&gt;tlist
)paren
suffix:semicolon
)brace
r_else
(brace
id|opl3-&gt;sys_timer_status
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|opl3-&gt;sys_timer_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Start system timer&n; */
DECL|function|snd_opl3_start_timer
r_void
id|snd_opl3_start_timer
c_func
(paren
id|opl3_t
op_star
id|opl3
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;sys_timer_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|opl3-&gt;sys_timer_status
)paren
(brace
id|opl3-&gt;tlist.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|opl3-&gt;tlist
)paren
suffix:semicolon
id|opl3-&gt;sys_timer_status
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;sys_timer_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------ */
DECL|variable|snd_opl3_oss_map
r_static
r_int
id|snd_opl3_oss_map
(braket
id|MAX_OPL3_VOICES
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|15
comma
l_int|16
comma
l_int|17
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|12
comma
l_int|13
comma
l_int|14
)brace
suffix:semicolon
multiline_comment|/*&n; * Start a note.&n; */
DECL|function|snd_opl3_note_on
r_void
id|snd_opl3_note_on
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|snd_seq_instr_t
id|wanted
suffix:semicolon
id|snd_seq_kinstr_t
op_star
id|kinstr
suffix:semicolon
r_int
id|instr_4op
suffix:semicolon
r_int
id|voice
suffix:semicolon
id|snd_opl3_voice_t
op_star
id|vp
comma
op_star
id|vp2
suffix:semicolon
r_int
r_int
id|connect_mask
suffix:semicolon
r_int
r_char
id|connection
suffix:semicolon
r_int
r_char
id|vol_op
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|extra_prg
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|reg_side
suffix:semicolon
r_int
r_char
id|op_offset
suffix:semicolon
r_int
r_char
id|voice_offset
suffix:semicolon
r_int
r_int
id|opl3_reg
suffix:semicolon
r_int
r_char
id|reg_val
suffix:semicolon
r_int
id|key
op_assign
id|note
suffix:semicolon
r_int
r_char
id|fnum
comma
id|blocknum
suffix:semicolon
r_int
id|i
suffix:semicolon
id|fm_instrument_t
op_star
id|fm
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|opl3
op_assign
id|p
suffix:semicolon
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;Note on, ch %i, inst %i, note %i, vel %i&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;midi_program
comma
id|note
comma
id|vel
)paren
suffix:semicolon
macro_line|#endif
id|wanted.cluster
op_assign
l_int|0
suffix:semicolon
id|wanted.std
op_assign
id|SNDRV_SEQ_INSTR_TYPE2_OPL2_3
suffix:semicolon
multiline_comment|/* in SYNTH mode, application takes care of voices */
multiline_comment|/* in SEQ mode, drum voice numbers are notes on drum channel */
r_if
c_cond
(paren
id|opl3-&gt;synth_mode
op_eq
id|SNDRV_OPL3_MODE_SEQ
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;drum_channel
)paren
(brace
multiline_comment|/* percussion instruments are located in bank 128 */
id|wanted.bank
op_assign
l_int|128
suffix:semicolon
id|wanted.prg
op_assign
id|note
suffix:semicolon
)brace
r_else
(brace
id|wanted.bank
op_assign
id|chan-&gt;gm_bank_select
suffix:semicolon
id|wanted.prg
op_assign
id|chan-&gt;midi_program
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Prepare for OSS mode */
r_if
c_cond
(paren
id|chan-&gt;number
op_ge
id|MAX_OPL3_VOICES
)paren
r_return
suffix:semicolon
multiline_comment|/* OSS instruments are located in bank 127 */
id|wanted.bank
op_assign
l_int|127
suffix:semicolon
id|wanted.prg
op_assign
id|chan-&gt;midi_program
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|use_internal_drums
)paren
(brace
id|snd_opl3_drum_switch
c_func
(paren
id|opl3
comma
id|note
comma
id|vel
comma
l_int|1
comma
id|chan
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|__extra_prg
suffix:colon
id|kinstr
op_assign
id|snd_seq_instr_find
c_func
(paren
id|opl3-&gt;ilist
comma
op_amp
id|wanted
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kinstr
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|fm
op_assign
id|KINSTR_DATA
c_func
(paren
id|kinstr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fm-&gt;type
)paren
(brace
r_case
id|FM_PATCH_OPL2
suffix:colon
id|instr_4op
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FM_PATCH_OPL3
suffix:colon
r_if
c_cond
(paren
id|opl3-&gt;hardware
op_ge
id|OPL3_HW_OPL3
)paren
(brace
id|instr_4op
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|snd_seq_instr_free_use
c_func
(paren
id|opl3-&gt;ilist
comma
id|kinstr
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;  --&gt; OPL%i instrument: %s&bslash;n&quot;
comma
id|instr_4op
ques
c_cond
l_int|3
suffix:colon
l_int|2
comma
id|kinstr-&gt;name
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* in SYNTH mode, application takes care of voices */
multiline_comment|/* in SEQ mode, allocate voice on free OPL3 channel */
r_if
c_cond
(paren
id|opl3-&gt;synth_mode
op_eq
id|SNDRV_OPL3_MODE_SEQ
)paren
(brace
id|voice
op_assign
id|opl3_get_voice
c_func
(paren
id|opl3
comma
id|instr_4op
comma
id|chan
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* remap OSS voice */
id|voice
op_assign
id|snd_opl3_oss_map
(braket
id|chan-&gt;number
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|voice
OL
id|MAX_OPL2_VOICES
)paren
(brace
multiline_comment|/* Left register block for voices 0 .. 8 */
id|reg_side
op_assign
id|OPL3_LEFT
suffix:semicolon
id|voice_offset
op_assign
id|voice
suffix:semicolon
id|connect_mask
op_assign
(paren
id|OPL3_LEFT_4OP_0
op_lshift
id|voice_offset
)paren
op_amp
l_int|0x07
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Right register block for voices 9 .. 17 */
id|reg_side
op_assign
id|OPL3_RIGHT
suffix:semicolon
id|voice_offset
op_assign
id|voice
op_minus
id|MAX_OPL2_VOICES
suffix:semicolon
id|connect_mask
op_assign
(paren
id|OPL3_RIGHT_4OP_0
op_lshift
id|voice_offset
)paren
op_amp
l_int|0x38
suffix:semicolon
)brace
multiline_comment|/* kill voice on channel */
id|vp
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
OG
l_int|0
)paren
(brace
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_KEYON_BLOCK
op_plus
id|voice_offset
)paren
suffix:semicolon
id|reg_val
op_assign
id|vp-&gt;keyon_reg
op_amp
op_complement
id|OPL3_KEYON_BIT
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|instr_4op
)paren
(brace
id|vp2
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
op_plus
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
OG
l_int|0
)paren
(brace
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_KEYON_BLOCK
op_plus
id|voice_offset
op_plus
l_int|3
)paren
suffix:semicolon
id|reg_val
op_assign
id|vp-&gt;keyon_reg
op_amp
op_complement
id|OPL3_KEYON_BIT
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* set connection register */
r_if
c_cond
(paren
id|instr_4op
)paren
(brace
r_if
c_cond
(paren
(paren
id|opl3-&gt;connection_reg
op_xor
id|connect_mask
)paren
op_amp
id|connect_mask
)paren
(brace
id|opl3-&gt;connection_reg
op_or_assign
id|connect_mask
suffix:semicolon
multiline_comment|/* set connection bit */
id|opl3_reg
op_assign
id|OPL3_RIGHT
op_or
id|OPL3_REG_CONNECTION_SELECT
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|opl3-&gt;connection_reg
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|opl3-&gt;connection_reg
op_xor
op_complement
id|connect_mask
)paren
op_amp
id|connect_mask
)paren
(brace
id|opl3-&gt;connection_reg
op_and_assign
op_complement
id|connect_mask
suffix:semicolon
multiline_comment|/* clear connection bit */
id|opl3_reg
op_assign
id|OPL3_RIGHT
op_or
id|OPL3_REG_CONNECTION_SELECT
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|opl3-&gt;connection_reg
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;  --&gt; setting OPL3 connection: 0x%x&bslash;n&quot;
comma
id|opl3-&gt;connection_reg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * calculate volume depending on connection&n;&t; * between FM operators (see include/opl3.h)&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|instr_4op
ques
c_cond
l_int|4
suffix:colon
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
id|vol_op
(braket
id|i
)braket
op_assign
id|fm-&gt;op
(braket
id|i
)braket
dot
id|ksl_level
suffix:semicolon
id|connection
op_assign
id|fm-&gt;feedback_connection
(braket
l_int|0
)braket
op_amp
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|instr_4op
)paren
(brace
id|connection
op_lshift_assign
l_int|1
suffix:semicolon
id|connection
op_or_assign
id|fm-&gt;feedback_connection
(braket
l_int|1
)braket
op_amp
l_int|0x01
suffix:semicolon
id|snd_opl3_calc_volume
c_func
(paren
op_amp
id|vol_op
(braket
l_int|3
)braket
comma
id|vel
comma
id|chan
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|connection
)paren
(brace
r_case
l_int|0x03
suffix:colon
id|snd_opl3_calc_volume
c_func
(paren
op_amp
id|vol_op
(braket
l_int|2
)braket
comma
id|vel
comma
id|chan
)paren
suffix:semicolon
multiline_comment|/* fallthru */
r_case
l_int|0x02
suffix:colon
id|snd_opl3_calc_volume
c_func
(paren
op_amp
id|vol_op
(braket
l_int|0
)braket
comma
id|vel
comma
id|chan
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|snd_opl3_calc_volume
c_func
(paren
op_amp
id|vol_op
(braket
l_int|1
)braket
comma
id|vel
comma
id|chan
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|snd_opl3_calc_volume
c_func
(paren
op_amp
id|vol_op
(braket
l_int|1
)braket
comma
id|vel
comma
id|chan
)paren
suffix:semicolon
r_if
c_cond
(paren
id|connection
)paren
id|snd_opl3_calc_volume
c_func
(paren
op_amp
id|vol_op
(braket
l_int|0
)braket
comma
id|vel
comma
id|chan
)paren
suffix:semicolon
)brace
multiline_comment|/* Program the FM voice characteristics */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|instr_4op
ques
c_cond
l_int|4
suffix:colon
l_int|2
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;  --&gt; programming operator %i&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
id|op_offset
op_assign
id|snd_opl3_regmap
(braket
id|voice_offset
)braket
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Set OPL3 AM_VIB register of requested voice/operator */
id|reg_val
op_assign
id|fm-&gt;op
(braket
id|i
)braket
dot
id|am_vib
suffix:semicolon
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_AM_VIB
op_plus
id|op_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
multiline_comment|/* Set OPL3 KSL_LEVEL register of requested voice/operator */
id|reg_val
op_assign
id|vol_op
(braket
id|i
)braket
suffix:semicolon
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_KSL_LEVEL
op_plus
id|op_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
multiline_comment|/* Set OPL3 ATTACK_DECAY register of requested voice/operator */
id|reg_val
op_assign
id|fm-&gt;op
(braket
id|i
)braket
dot
id|attack_decay
suffix:semicolon
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_ATTACK_DECAY
op_plus
id|op_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
multiline_comment|/* Set OPL3 SUSTAIN_RELEASE register of requested voice/operator */
id|reg_val
op_assign
id|fm-&gt;op
(braket
id|i
)braket
dot
id|sustain_release
suffix:semicolon
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_SUSTAIN_RELEASE
op_plus
id|op_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
multiline_comment|/* Select waveform */
id|reg_val
op_assign
id|fm-&gt;op
(braket
id|i
)braket
dot
id|wave_select
suffix:semicolon
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_WAVE_SELECT
op_plus
id|op_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
)brace
multiline_comment|/* Set operator feedback and 2op inter-operator connection */
id|reg_val
op_assign
id|fm-&gt;feedback_connection
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Set output voice connection */
id|reg_val
op_or_assign
id|OPL3_STEREO_BITS
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;gm_pan
OL
l_int|43
)paren
id|reg_val
op_and_assign
op_complement
id|OPL3_VOICE_TO_RIGHT
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;gm_pan
OG
l_int|85
)paren
id|reg_val
op_and_assign
op_complement
id|OPL3_VOICE_TO_LEFT
suffix:semicolon
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_FEEDBACK_CONNECTION
op_plus
id|voice_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|instr_4op
)paren
(brace
multiline_comment|/* Set 4op inter-operator connection */
id|reg_val
op_assign
id|fm-&gt;feedback_connection
(braket
l_int|1
)braket
op_amp
id|OPL3_CONNECTION_BIT
suffix:semicolon
multiline_comment|/* Set output voice connection */
id|reg_val
op_or_assign
id|OPL3_STEREO_BITS
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;gm_pan
OL
l_int|43
)paren
id|reg_val
op_and_assign
op_complement
id|OPL3_VOICE_TO_RIGHT
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;gm_pan
OG
l_int|85
)paren
id|reg_val
op_and_assign
op_complement
id|OPL3_VOICE_TO_LEFT
suffix:semicolon
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_FEEDBACK_CONNECTION
op_plus
id|voice_offset
op_plus
l_int|3
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|reg_val
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Special treatment of percussion notes for fm:&n;&t; * Requested pitch is really program, and pitch for&n;&t; * device is whatever was specified in the patch library.&n;&t; */
r_if
c_cond
(paren
id|fm-&gt;fix_key
)paren
id|note
op_assign
id|fm-&gt;fix_key
suffix:semicolon
multiline_comment|/*&n;&t; * use transpose if defined in patch library&n;&t; */
r_if
c_cond
(paren
id|fm-&gt;trnsps
)paren
id|note
op_add_assign
(paren
id|fm-&gt;trnsps
op_minus
l_int|64
)paren
suffix:semicolon
id|snd_opl3_calc_pitch
c_func
(paren
op_amp
id|fnum
comma
op_amp
id|blocknum
comma
id|note
comma
id|chan
)paren
suffix:semicolon
multiline_comment|/* Set OPL3 FNUM_LOW register of requested voice */
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_FNUM_LOW
op_plus
id|voice_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|fnum
)paren
suffix:semicolon
id|opl3-&gt;voices
(braket
id|voice
)braket
dot
id|keyon_reg
op_assign
id|blocknum
suffix:semicolon
multiline_comment|/* Set output sound flag */
id|blocknum
op_or_assign
id|OPL3_KEYON_BIT
suffix:semicolon
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;  --&gt; trigger voice %i&bslash;n&quot;
comma
id|voice
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set OPL3 KEYON_BLOCK register of requested voice */
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_KEYON_BLOCK
op_plus
id|voice_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|blocknum
)paren
suffix:semicolon
multiline_comment|/* kill note after fixed duration (in centiseconds) */
r_if
c_cond
(paren
id|fm-&gt;fix_dur
)paren
(brace
id|opl3-&gt;voices
(braket
id|voice
)braket
dot
id|note_off
op_assign
id|jiffies
op_plus
(paren
id|fm-&gt;fix_dur
op_star
id|HZ
)paren
op_div
l_int|100
suffix:semicolon
id|snd_opl3_start_timer
c_func
(paren
id|opl3
)paren
suffix:semicolon
id|opl3-&gt;voices
(braket
id|voice
)braket
dot
id|note_off_check
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|opl3-&gt;voices
(braket
id|voice
)braket
dot
id|note_off_check
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* get extra pgm, but avoid possible loops */
id|extra_prg
op_assign
(paren
id|extra_prg
)paren
ques
c_cond
l_int|0
suffix:colon
id|fm-&gt;modes
suffix:semicolon
id|snd_seq_instr_free_use
c_func
(paren
id|opl3-&gt;ilist
comma
id|kinstr
)paren
suffix:semicolon
multiline_comment|/* do the bookkeeping */
id|vp-&gt;time
op_assign
id|opl3-&gt;use_time
op_increment
suffix:semicolon
id|vp-&gt;note
op_assign
id|key
suffix:semicolon
id|vp-&gt;chan
op_assign
id|chan
suffix:semicolon
r_if
c_cond
(paren
id|instr_4op
)paren
(brace
id|vp-&gt;state
op_assign
id|SNDRV_OPL3_ST_ON_4OP
suffix:semicolon
id|vp2
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
op_plus
l_int|3
)braket
suffix:semicolon
id|vp2-&gt;time
op_assign
id|opl3-&gt;use_time
op_increment
suffix:semicolon
id|vp2-&gt;note
op_assign
id|key
suffix:semicolon
id|vp2-&gt;chan
op_assign
id|chan
suffix:semicolon
id|vp2-&gt;state
op_assign
id|SNDRV_OPL3_ST_NOT_AVAIL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|vp-&gt;state
op_eq
id|SNDRV_OPL3_ST_ON_4OP
)paren
(brace
multiline_comment|/* 4op killed by 2op, release bounded voice */
id|vp2
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
op_plus
l_int|3
)braket
suffix:semicolon
id|vp2-&gt;time
op_assign
id|opl3-&gt;use_time
op_increment
suffix:semicolon
id|vp2-&gt;state
op_assign
id|SNDRV_OPL3_ST_OFF
suffix:semicolon
)brace
id|vp-&gt;state
op_assign
id|SNDRV_OPL3_ST_ON_2OP
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_ALLOC
id|debug_alloc
c_func
(paren
id|opl3
comma
l_string|&quot;note on &quot;
comma
id|voice
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* allocate extra program if specified in patch library */
r_if
c_cond
(paren
id|extra_prg
)paren
(brace
r_if
c_cond
(paren
id|extra_prg
OG
l_int|128
)paren
(brace
id|wanted.bank
op_assign
l_int|128
suffix:semicolon
multiline_comment|/* percussions start at 35 */
id|wanted.prg
op_assign
id|extra_prg
op_minus
l_int|128
op_plus
l_int|35
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|wanted.bank
op_assign
l_int|0
suffix:semicolon
id|wanted.prg
op_assign
id|extra_prg
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot; *** allocating extra program&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|__extra_prg
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_opl3_kill_voice
r_static
r_void
id|snd_opl3_kill_voice
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
id|voice
)paren
(brace
r_int
r_int
id|reg_side
suffix:semicolon
r_int
r_char
id|voice_offset
suffix:semicolon
r_int
r_int
id|opl3_reg
suffix:semicolon
id|snd_opl3_voice_t
op_star
id|vp
comma
op_star
id|vp2
suffix:semicolon
id|snd_assert
c_func
(paren
id|voice
OL
id|MAX_OPL3_VOICES
comma
r_return
)paren
suffix:semicolon
id|vp
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
id|voice
OL
id|MAX_OPL2_VOICES
)paren
(brace
multiline_comment|/* Left register block for voices 0 .. 8 */
id|reg_side
op_assign
id|OPL3_LEFT
suffix:semicolon
id|voice_offset
op_assign
id|voice
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Right register block for voices 9 .. 17 */
id|reg_side
op_assign
id|OPL3_RIGHT
suffix:semicolon
id|voice_offset
op_assign
id|voice
op_minus
id|MAX_OPL2_VOICES
suffix:semicolon
)brace
multiline_comment|/* kill voice */
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;  --&gt; kill voice %i&bslash;n&quot;
comma
id|voice
)paren
suffix:semicolon
macro_line|#endif
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_KEYON_BLOCK
op_plus
id|voice_offset
)paren
suffix:semicolon
multiline_comment|/* clear Key ON bit */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|vp-&gt;keyon_reg
)paren
suffix:semicolon
multiline_comment|/* do the bookkeeping */
id|vp-&gt;time
op_assign
id|opl3-&gt;use_time
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
op_eq
id|SNDRV_OPL3_ST_ON_4OP
)paren
(brace
id|vp2
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
op_plus
l_int|3
)braket
suffix:semicolon
id|vp2-&gt;time
op_assign
id|opl3-&gt;use_time
op_increment
suffix:semicolon
id|vp2-&gt;state
op_assign
id|SNDRV_OPL3_ST_OFF
suffix:semicolon
)brace
id|vp-&gt;state
op_assign
id|SNDRV_OPL3_ST_OFF
suffix:semicolon
macro_line|#ifdef DEBUG_ALLOC
id|debug_alloc
c_func
(paren
id|opl3
comma
l_string|&quot;note off&quot;
comma
id|voice
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Release a note in response to a midi note off.&n; */
DECL|function|snd_opl3_note_off
r_void
id|snd_opl3_note_off
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
id|opl3_t
op_star
id|opl3
suffix:semicolon
r_int
id|voice
suffix:semicolon
id|snd_opl3_voice_t
op_star
id|vp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|opl3
op_assign
id|p
suffix:semicolon
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;Note off, ch %i, inst %i, note %i&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;midi_program
comma
id|note
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opl3-&gt;synth_mode
op_eq
id|SNDRV_OPL3_MODE_SEQ
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;drum_channel
op_logical_and
id|use_internal_drums
)paren
(brace
id|snd_opl3_drum_switch
c_func
(paren
id|opl3
comma
id|note
comma
id|vel
comma
l_int|0
comma
id|chan
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* this loop will hopefully kill all extra voices, because&n;&t;&t;   they are grouped by the same channel and note values */
r_for
c_loop
(paren
id|voice
op_assign
l_int|0
suffix:semicolon
id|voice
OL
id|opl3-&gt;max_voices
suffix:semicolon
id|voice
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
OG
l_int|0
op_logical_and
id|vp-&gt;chan
op_eq
id|chan
op_logical_and
id|vp-&gt;note
op_eq
id|note
)paren
(brace
id|snd_opl3_kill_voice
c_func
(paren
id|opl3
comma
id|voice
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* remap OSS voices */
r_if
c_cond
(paren
id|chan-&gt;number
OL
id|MAX_OPL3_VOICES
)paren
(brace
id|voice
op_assign
id|snd_opl3_oss_map
(braket
id|chan-&gt;number
)braket
suffix:semicolon
id|snd_opl3_kill_voice
c_func
(paren
id|opl3
comma
id|voice
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * key pressure change&n; */
DECL|function|snd_opl3_key_press
r_void
id|snd_opl3_key_press
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|p
suffix:semicolon
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;Key pressure, ch#: %i, inst#: %i&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;midi_program
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * terminate note&n; */
DECL|function|snd_opl3_terminate_note
r_void
id|snd_opl3_terminate_note
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|note
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|p
suffix:semicolon
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;Terminate note, ch#: %i, inst#: %i&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;midi_program
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|snd_opl3_update_pitch
r_static
r_void
id|snd_opl3_update_pitch
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
id|voice
)paren
(brace
r_int
r_int
id|reg_side
suffix:semicolon
r_int
r_char
id|voice_offset
suffix:semicolon
r_int
r_int
id|opl3_reg
suffix:semicolon
r_int
r_char
id|fnum
comma
id|blocknum
suffix:semicolon
id|snd_opl3_voice_t
op_star
id|vp
suffix:semicolon
id|snd_assert
c_func
(paren
id|voice
OL
id|MAX_OPL3_VOICES
comma
r_return
)paren
suffix:semicolon
id|vp
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;chan
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* not allocated? */
r_if
c_cond
(paren
id|voice
OL
id|MAX_OPL2_VOICES
)paren
(brace
multiline_comment|/* Left register block for voices 0 .. 8 */
id|reg_side
op_assign
id|OPL3_LEFT
suffix:semicolon
id|voice_offset
op_assign
id|voice
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Right register block for voices 9 .. 17 */
id|reg_side
op_assign
id|OPL3_RIGHT
suffix:semicolon
id|voice_offset
op_assign
id|voice
op_minus
id|MAX_OPL2_VOICES
suffix:semicolon
)brace
id|snd_opl3_calc_pitch
c_func
(paren
op_amp
id|fnum
comma
op_amp
id|blocknum
comma
id|vp-&gt;note
comma
id|vp-&gt;chan
)paren
suffix:semicolon
multiline_comment|/* Set OPL3 FNUM_LOW register of requested voice */
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_FNUM_LOW
op_plus
id|voice_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|fnum
)paren
suffix:semicolon
id|vp-&gt;keyon_reg
op_assign
id|blocknum
suffix:semicolon
multiline_comment|/* Set output sound flag */
id|blocknum
op_or_assign
id|OPL3_KEYON_BIT
suffix:semicolon
multiline_comment|/* Set OPL3 KEYON_BLOCK register of requested voice */
id|opl3_reg
op_assign
id|reg_side
op_or
(paren
id|OPL3_REG_KEYON_BLOCK
op_plus
id|voice_offset
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|opl3_reg
comma
id|blocknum
)paren
suffix:semicolon
id|vp-&gt;time
op_assign
id|opl3-&gt;use_time
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * Update voice pitch controller&n; */
DECL|function|snd_opl3_pitch_ctrl
r_static
r_void
id|snd_opl3_pitch_ctrl
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
r_int
id|voice
suffix:semicolon
id|snd_opl3_voice_t
op_star
id|vp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opl3-&gt;synth_mode
op_eq
id|SNDRV_OPL3_MODE_SEQ
)paren
(brace
r_for
c_loop
(paren
id|voice
op_assign
l_int|0
suffix:semicolon
id|voice
OL
id|opl3-&gt;max_voices
suffix:semicolon
id|voice
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|opl3-&gt;voices
(braket
id|voice
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
OG
l_int|0
op_logical_and
id|vp-&gt;chan
op_eq
id|chan
)paren
(brace
id|snd_opl3_update_pitch
c_func
(paren
id|opl3
comma
id|voice
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* remap OSS voices */
r_if
c_cond
(paren
id|chan-&gt;number
OL
id|MAX_OPL3_VOICES
)paren
(brace
id|voice
op_assign
id|snd_opl3_oss_map
(braket
id|chan-&gt;number
)braket
suffix:semicolon
id|snd_opl3_update_pitch
c_func
(paren
id|opl3
comma
id|voice
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Deal with a controler type event.  This includes all types of&n; * control events, not just the midi controllers&n; */
DECL|function|snd_opl3_control
r_void
id|snd_opl3_control
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|type
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|p
suffix:semicolon
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;Controller, TYPE = %i, ch#: %i, inst#: %i&bslash;n&quot;
comma
id|type
comma
id|chan-&gt;number
comma
id|chan-&gt;midi_program
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|MIDI_CTL_MSB_MODWHEEL
suffix:colon
r_if
c_cond
(paren
id|chan-&gt;control
(braket
id|MIDI_CTL_MSB_MODWHEEL
)braket
OG
l_int|63
)paren
id|opl3-&gt;drum_reg
op_or_assign
id|OPL3_VIBRATO_DEPTH
suffix:semicolon
r_else
id|opl3-&gt;drum_reg
op_and_assign
op_complement
id|OPL3_VIBRATO_DEPTH
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_PERCUSSION
comma
id|opl3-&gt;drum_reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIDI_CTL_E2_TREMOLO_DEPTH
suffix:colon
r_if
c_cond
(paren
id|chan-&gt;control
(braket
id|MIDI_CTL_E2_TREMOLO_DEPTH
)braket
OG
l_int|63
)paren
id|opl3-&gt;drum_reg
op_or_assign
id|OPL3_TREMOLO_DEPTH
suffix:semicolon
r_else
id|opl3-&gt;drum_reg
op_and_assign
op_complement
id|OPL3_TREMOLO_DEPTH
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_PERCUSSION
comma
id|opl3-&gt;drum_reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIDI_CTL_PITCHBEND
suffix:colon
id|snd_opl3_pitch_ctrl
c_func
(paren
id|opl3
comma
id|chan
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * NRPN events&n; */
DECL|function|snd_opl3_nrpn
r_void
id|snd_opl3_nrpn
c_func
(paren
r_void
op_star
id|p
comma
id|snd_midi_channel_t
op_star
id|chan
comma
id|snd_midi_channel_set_t
op_star
id|chset
)paren
(brace
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|p
suffix:semicolon
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;NRPN, ch#: %i, inst#: %i&bslash;n&quot;
comma
id|chan-&gt;number
comma
id|chan-&gt;midi_program
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * receive sysex&n; */
DECL|function|snd_opl3_sysex
r_void
id|snd_opl3_sysex
c_func
(paren
r_void
op_star
id|p
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|len
comma
r_int
id|parsed
comma
id|snd_midi_channel_set_t
op_star
id|chset
)paren
(brace
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|p
suffix:semicolon
macro_line|#ifdef DEBUG_MIDI
id|snd_printk
c_func
(paren
l_string|&quot;SYSEX&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
