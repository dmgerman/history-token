multiline_comment|/*&n; *  Copyright (c) by Jaroslav Kysela &lt;perex@suse.cz&gt;,&n; *                   Hannu Savolainen 1993-1996,&n; *                   Rob Hooft&n; *                   &n; *  Routines for control of AdLib FM cards (OPL2/OPL3/OPL4 chips)&n; *&n; *  Most if code is ported from OSS/Lite.&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
macro_line|#include &lt;sound/opl3.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;sound/minors.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jaroslav Kysela &lt;perex@suse.cz&gt;, Hannu Savolainen 1993-1996, Rob Hooft&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Routines for control of AdLib FM cards (OPL2/OPL3/OPL4 chips)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
r_extern
r_char
id|snd_opl3_regmap
(braket
id|MAX_OPL2_VOICES
)braket
(braket
l_int|4
)braket
suffix:semicolon
DECL|function|snd_opl2_command
r_void
id|snd_opl2_command
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
r_int
id|cmd
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|port
suffix:semicolon
multiline_comment|/*&n;&t; * The original 2-OP synth requires a quite long delay&n;&t; * after writing to a register.&n;&t; */
id|port
op_assign
(paren
id|cmd
op_amp
id|OPL3_RIGHT
)paren
ques
c_cond
id|opl3-&gt;r_port
suffix:colon
id|opl3-&gt;l_port
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_int
r_char
)paren
id|cmd
comma
id|port
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_int
r_char
)paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_opl3_command
r_void
id|snd_opl3_command
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
r_int
id|cmd
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|port
suffix:semicolon
multiline_comment|/*&n;&t; * The OPL-3 survives with just two INBs&n;&t; * after writing to a register.&n;&t; */
id|port
op_assign
(paren
id|cmd
op_amp
id|OPL3_RIGHT
)paren
ques
c_cond
id|opl3-&gt;r_port
suffix:colon
id|opl3-&gt;l_port
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_int
r_char
)paren
id|cmd
comma
id|port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|opl3-&gt;l_port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|opl3-&gt;l_port
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
r_int
r_char
)paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|inb
c_func
(paren
id|opl3-&gt;l_port
)paren
suffix:semicolon
id|inb
c_func
(paren
id|opl3-&gt;l_port
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_opl3_cs4281_command
r_void
id|snd_opl3_cs4281_command
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
r_int
id|cmd
comma
r_int
r_char
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|port
suffix:semicolon
multiline_comment|/*&n;&t; * CS4281 requires a special access to I/O registers&n;&t; */
id|port
op_assign
(paren
id|cmd
op_amp
id|OPL3_RIGHT
)paren
ques
c_cond
id|opl3-&gt;r_port
suffix:colon
id|opl3-&gt;l_port
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
r_int
r_int
)paren
id|cmd
comma
id|port
op_lshift
l_int|2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
r_int
r_int
)paren
id|val
comma
(paren
id|port
op_plus
l_int|1
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_opl3_detect
r_static
r_int
id|snd_opl3_detect
c_func
(paren
id|opl3_t
op_star
id|opl3
)paren
(brace
multiline_comment|/*&n;&t; * This function returns 1 if the FM chip is present at the given I/O port&n;&t; * The detection algorithm plays with the timer built in the FM chip and&n;&t; * looks for a change in the status register.&n;&t; *&n;&t; * Note! The timers of the FM chip are not connected to AdLib (and compatible)&n;&t; * boards.&n;&t; *&n;&t; * Note2! The chip is initialized if detected.&n;&t; */
r_int
r_char
id|stat1
comma
id|stat2
comma
id|signature
suffix:semicolon
multiline_comment|/* Reset timers 1 and 2 */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|OPL3_TIMER1_MASK
op_or
id|OPL3_TIMER2_MASK
)paren
suffix:semicolon
multiline_comment|/* Reset the IRQ of the FM chip */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|OPL3_IRQ_RESET
)paren
suffix:semicolon
id|signature
op_assign
id|stat1
op_assign
id|inb
c_func
(paren
id|opl3-&gt;l_port
)paren
suffix:semicolon
multiline_comment|/* Status register */
r_if
c_cond
(paren
(paren
id|stat1
op_amp
l_int|0xe0
)paren
op_ne
l_int|0x00
)paren
(brace
multiline_comment|/* Should be 0x00 */
id|snd_printd
c_func
(paren
l_string|&quot;OPL3: stat1 = 0x%x&bslash;n&quot;
comma
id|stat1
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Set timer1 to 0xff */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER1
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Unmask and start timer 1 */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|OPL3_TIMER2_MASK
op_or
id|OPL3_TIMER1_START
)paren
suffix:semicolon
multiline_comment|/* Now we have to delay at least 80us */
id|udelay
c_func
(paren
l_int|200
)paren
suffix:semicolon
multiline_comment|/* Read status after timers have expired */
id|stat2
op_assign
id|inb
c_func
(paren
id|opl3-&gt;l_port
)paren
suffix:semicolon
multiline_comment|/* Stop the timers */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|OPL3_TIMER1_MASK
op_or
id|OPL3_TIMER2_MASK
)paren
suffix:semicolon
multiline_comment|/* Reset the IRQ of the FM chip */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|OPL3_IRQ_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat2
op_amp
l_int|0xe0
)paren
op_ne
l_int|0xc0
)paren
(brace
multiline_comment|/* There is no YM3812 */
id|snd_printd
c_func
(paren
l_string|&quot;OPL3: stat2 = 0x%x&bslash;n&quot;
comma
id|stat2
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* If the toplevel code knows exactly the type of chip, don&squot;t try&n;&t;   to detect it. */
r_if
c_cond
(paren
id|opl3-&gt;hardware
op_ne
id|OPL3_HW_AUTO
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* There is a FM chip on this address. Detect the type (OPL2 to OPL4) */
r_if
c_cond
(paren
id|signature
op_eq
l_int|0x06
)paren
(brace
multiline_comment|/* OPL2 */
id|opl3-&gt;hardware
op_assign
id|OPL3_HW_OPL2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * If we had an OPL4 chip, opl3-&gt;hardware would have been set&n;&t;&t; * by the OPL4 driver; so we can assume OPL3 here.&n;&t;&t; */
id|snd_assert
c_func
(paren
id|opl3-&gt;r_port
op_ne
l_int|0
comma
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|opl3-&gt;hardware
op_assign
id|OPL3_HW_OPL3
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  AdLib timers&n; */
multiline_comment|/*&n; *  Timer 1 - 80us&n; */
DECL|function|snd_opl3_timer1_start
r_static
r_int
id|snd_opl3_timer1_start
c_func
(paren
id|snd_timer_t
op_star
id|timer
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_int
r_int
id|ticks
suffix:semicolon
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|snd_timer_chip
c_func
(paren
id|timer
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
comma
id|flags
)paren
suffix:semicolon
id|ticks
op_assign
id|timer-&gt;sticks
suffix:semicolon
id|tmp
op_assign
(paren
id|opl3-&gt;timer_enable
op_or
id|OPL3_TIMER1_START
)paren
op_amp
op_complement
id|OPL3_TIMER1_MASK
suffix:semicolon
id|opl3-&gt;timer_enable
op_assign
id|tmp
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER1
comma
l_int|256
op_minus
id|ticks
)paren
suffix:semicolon
multiline_comment|/* timer 1 count */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* enable timer 1 IRQ */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_opl3_timer1_stop
r_static
r_int
id|snd_opl3_timer1_stop
c_func
(paren
id|snd_timer_t
op_star
id|timer
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|snd_timer_chip
c_func
(paren
id|timer
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|opl3-&gt;timer_enable
op_or
id|OPL3_TIMER1_MASK
)paren
op_amp
op_complement
id|OPL3_TIMER1_START
suffix:semicolon
id|opl3-&gt;timer_enable
op_assign
id|tmp
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* disable timer #1 */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  Timer 2 - 320us&n; */
DECL|function|snd_opl3_timer2_start
r_static
r_int
id|snd_opl3_timer2_start
c_func
(paren
id|snd_timer_t
op_star
id|timer
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
r_int
r_int
id|ticks
suffix:semicolon
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|snd_timer_chip
c_func
(paren
id|timer
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
comma
id|flags
)paren
suffix:semicolon
id|ticks
op_assign
id|timer-&gt;sticks
suffix:semicolon
id|tmp
op_assign
(paren
id|opl3-&gt;timer_enable
op_or
id|OPL3_TIMER2_START
)paren
op_amp
op_complement
id|OPL3_TIMER2_MASK
suffix:semicolon
id|opl3-&gt;timer_enable
op_assign
id|tmp
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER2
comma
l_int|256
op_minus
id|ticks
)paren
suffix:semicolon
multiline_comment|/* timer 1 count */
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* enable timer 1 IRQ */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_opl3_timer2_stop
r_static
r_int
id|snd_opl3_timer2_stop
c_func
(paren
id|snd_timer_t
op_star
id|timer
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|tmp
suffix:semicolon
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|opl3
op_assign
id|snd_timer_chip
c_func
(paren
id|timer
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
comma
id|flags
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|opl3-&gt;timer_enable
op_or
id|OPL3_TIMER2_MASK
)paren
op_amp
op_complement
id|OPL3_TIMER2_START
suffix:semicolon
id|opl3-&gt;timer_enable
op_assign
id|tmp
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TIMER_CONTROL
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* disable timer #1 */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&n; */
DECL|variable|snd_opl3_timer1
r_static
r_struct
id|_snd_timer_hardware
id|snd_opl3_timer1
op_assign
(brace
dot
id|flags
op_assign
id|SNDRV_TIMER_HW_STOP
comma
dot
id|resolution
op_assign
l_int|80000
comma
dot
id|ticks
op_assign
l_int|256
comma
dot
id|start
op_assign
id|snd_opl3_timer1_start
comma
dot
id|stop
op_assign
id|snd_opl3_timer1_stop
comma
)brace
suffix:semicolon
DECL|variable|snd_opl3_timer2
r_static
r_struct
id|_snd_timer_hardware
id|snd_opl3_timer2
op_assign
(brace
dot
id|flags
op_assign
id|SNDRV_TIMER_HW_STOP
comma
dot
id|resolution
op_assign
l_int|320000
comma
dot
id|ticks
op_assign
l_int|256
comma
dot
id|start
op_assign
id|snd_opl3_timer2_start
comma
dot
id|stop
op_assign
id|snd_opl3_timer2_stop
comma
)brace
suffix:semicolon
DECL|function|snd_opl3_timer1_init
r_static
r_int
id|snd_opl3_timer1_init
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
id|timer_no
)paren
(brace
id|snd_timer_t
op_star
id|timer
op_assign
l_int|NULL
suffix:semicolon
id|snd_timer_id_t
id|tid
suffix:semicolon
r_int
id|err
suffix:semicolon
id|tid.dev_class
op_assign
id|SNDRV_TIMER_CLASS_CARD
suffix:semicolon
id|tid.dev_sclass
op_assign
id|SNDRV_TIMER_SCLASS_NONE
suffix:semicolon
id|tid.card
op_assign
id|opl3-&gt;card-&gt;number
suffix:semicolon
id|tid.device
op_assign
id|timer_no
suffix:semicolon
id|tid.subdevice
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_timer_new
c_func
(paren
id|opl3-&gt;card
comma
l_string|&quot;AdLib timer #1&quot;
comma
op_amp
id|tid
comma
op_amp
id|timer
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|timer-&gt;name
comma
l_string|&quot;AdLib timer #1&quot;
)paren
suffix:semicolon
id|timer-&gt;private_data
op_assign
id|opl3
suffix:semicolon
id|timer-&gt;hw
op_assign
id|snd_opl3_timer1
suffix:semicolon
)brace
id|opl3-&gt;timer1
op_assign
id|timer
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|snd_opl3_timer2_init
r_static
r_int
id|snd_opl3_timer2_init
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
id|timer_no
)paren
(brace
id|snd_timer_t
op_star
id|timer
op_assign
l_int|NULL
suffix:semicolon
id|snd_timer_id_t
id|tid
suffix:semicolon
r_int
id|err
suffix:semicolon
id|tid.dev_class
op_assign
id|SNDRV_TIMER_CLASS_CARD
suffix:semicolon
id|tid.dev_sclass
op_assign
id|SNDRV_TIMER_SCLASS_NONE
suffix:semicolon
id|tid.card
op_assign
id|opl3-&gt;card-&gt;number
suffix:semicolon
id|tid.device
op_assign
id|timer_no
suffix:semicolon
id|tid.subdevice
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_timer_new
c_func
(paren
id|opl3-&gt;card
comma
l_string|&quot;AdLib timer #2&quot;
comma
op_amp
id|tid
comma
op_amp
id|timer
)paren
)paren
op_ge
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|timer-&gt;name
comma
l_string|&quot;AdLib timer #2&quot;
)paren
suffix:semicolon
id|timer-&gt;private_data
op_assign
id|opl3
suffix:semicolon
id|timer-&gt;hw
op_assign
id|snd_opl3_timer2
suffix:semicolon
)brace
id|opl3-&gt;timer2
op_assign
id|timer
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n;&n; */
DECL|function|snd_opl3_interrupt
r_void
id|snd_opl3_interrupt
c_func
(paren
id|snd_hwdep_t
op_star
id|hw
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|opl3_t
op_star
id|opl3
suffix:semicolon
id|snd_timer_t
op_star
id|timer
suffix:semicolon
r_if
c_cond
(paren
id|hw
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|opl3
op_assign
id|hw-&gt;private_data
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|opl3-&gt;l_port
)paren
suffix:semicolon
macro_line|#if 0
id|snd_printk
c_func
(paren
l_string|&quot;AdLib IRQ status = 0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
l_int|0x80
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x40
)paren
(brace
id|timer
op_assign
id|opl3-&gt;timer1
suffix:semicolon
id|snd_timer_interrupt
c_func
(paren
id|timer
comma
id|timer-&gt;sticks
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
l_int|0x20
)paren
(brace
id|timer
op_assign
id|opl3-&gt;timer2
suffix:semicolon
id|snd_timer_interrupt
c_func
(paren
id|timer
comma
id|timer-&gt;sticks
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&n; */
DECL|function|snd_opl3_free
r_static
r_int
id|snd_opl3_free
c_func
(paren
id|opl3_t
op_star
id|opl3
)paren
(brace
r_if
c_cond
(paren
id|opl3-&gt;res_l_port
)paren
(brace
id|release_resource
c_func
(paren
id|opl3-&gt;res_l_port
)paren
suffix:semicolon
id|kfree_nocheck
c_func
(paren
id|opl3-&gt;res_l_port
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opl3-&gt;res_r_port
)paren
(brace
id|release_resource
c_func
(paren
id|opl3-&gt;res_r_port
)paren
suffix:semicolon
id|kfree_nocheck
c_func
(paren
id|opl3-&gt;res_r_port
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|opl3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_opl3_dev_free
r_static
r_int
id|snd_opl3_dev_free
c_func
(paren
id|snd_device_t
op_star
id|device
)paren
(brace
id|opl3_t
op_star
id|opl3
op_assign
id|device-&gt;device_data
suffix:semicolon
r_return
id|snd_opl3_free
c_func
(paren
id|opl3
)paren
suffix:semicolon
)brace
DECL|function|snd_opl3_create
r_int
id|snd_opl3_create
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
r_int
id|l_port
comma
r_int
r_int
id|r_port
comma
r_int
r_int
id|hardware
comma
r_int
id|integrated
comma
id|opl3_t
op_star
op_star
id|ropl3
)paren
(brace
id|opl3_t
op_star
id|opl3
suffix:semicolon
r_int
id|err
suffix:semicolon
r_static
id|snd_device_ops_t
id|ops
op_assign
(brace
dot
id|dev_free
op_assign
id|snd_opl3_dev_free
comma
)brace
suffix:semicolon
op_star
id|ropl3
op_assign
l_int|NULL
suffix:semicolon
id|opl3
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|opl3
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opl3
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|integrated
)paren
r_goto
id|__step1
suffix:semicolon
multiline_comment|/* ports are already reserved */
r_if
c_cond
(paren
(paren
id|opl3-&gt;res_l_port
op_assign
id|request_region
c_func
(paren
id|l_port
comma
l_int|2
comma
l_string|&quot;OPL2/3 (left)&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;opl3: can&squot;t grab left port 0x%lx&bslash;n&quot;
comma
id|l_port
)paren
suffix:semicolon
id|snd_opl3_free
c_func
(paren
id|opl3
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|r_port
op_ne
l_int|0
op_logical_and
(paren
id|opl3-&gt;res_r_port
op_assign
id|request_region
c_func
(paren
id|r_port
comma
l_int|2
comma
l_string|&quot;OPL2/3 (right)&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;opl3: can&squot;t grab right port 0x%lx&bslash;n&quot;
comma
id|r_port
)paren
suffix:semicolon
id|snd_opl3_free
c_func
(paren
id|opl3
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|__step1
suffix:colon
id|opl3-&gt;card
op_assign
id|card
suffix:semicolon
id|opl3-&gt;hardware
op_assign
id|hardware
suffix:semicolon
id|opl3-&gt;l_port
op_assign
id|l_port
suffix:semicolon
id|opl3-&gt;r_port
op_assign
id|r_port
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|opl3-&gt;reg_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|opl3-&gt;timer_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|opl3-&gt;access_mutex
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|opl3-&gt;hardware
)paren
(brace
multiline_comment|/* some hardware doesn&squot;t support timers */
r_case
id|OPL3_HW_OPL3_SV
suffix:colon
r_case
id|OPL3_HW_OPL3_CS
suffix:colon
r_case
id|OPL3_HW_OPL3_FM801
suffix:colon
id|opl3-&gt;command
op_assign
op_amp
id|snd_opl3_command
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPL3_HW_OPL3_CS4281
suffix:colon
id|opl3-&gt;command
op_assign
op_amp
id|snd_opl3_cs4281_command
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|opl3-&gt;command
op_assign
op_amp
id|snd_opl2_command
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_opl3_detect
c_func
(paren
id|opl3
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;OPL2/3 chip not detected at 0x%lx/0x%lx&bslash;n&quot;
comma
id|opl3-&gt;l_port
comma
id|opl3-&gt;r_port
)paren
suffix:semicolon
id|snd_opl3_free
c_func
(paren
id|opl3
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* detect routine returns correct hardware type */
r_switch
c_cond
(paren
id|opl3-&gt;hardware
op_amp
id|OPL3_HW_MASK
)paren
(brace
r_case
id|OPL3_HW_OPL3
suffix:colon
r_case
id|OPL3_HW_OPL4
suffix:colon
id|opl3-&gt;command
op_assign
op_amp
id|snd_opl3_command
suffix:semicolon
)brace
)brace
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_TEST
comma
id|OPL3_ENABLE_WAVE_SELECT
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_LEFT
op_or
id|OPL3_REG_PERCUSSION
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Melodic mode */
r_switch
c_cond
(paren
id|opl3-&gt;hardware
op_amp
id|OPL3_HW_MASK
)paren
(brace
r_case
id|OPL3_HW_OPL2
suffix:colon
id|opl3-&gt;max_voices
op_assign
id|MAX_OPL2_VOICES
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPL3_HW_OPL3
suffix:colon
r_case
id|OPL3_HW_OPL4
suffix:colon
id|opl3-&gt;max_voices
op_assign
id|MAX_OPL3_VOICES
suffix:semicolon
id|snd_assert
c_func
(paren
id|opl3-&gt;r_port
op_ne
l_int|0
comma
id|snd_opl3_free
c_func
(paren
id|opl3
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
)paren
suffix:semicolon
id|opl3
op_member_access_from_pointer
id|command
c_func
(paren
id|opl3
comma
id|OPL3_RIGHT
op_or
id|OPL3_REG_MODE
comma
id|OPL3_OPL3_ENABLE
)paren
suffix:semicolon
multiline_comment|/* Enter OPL3 mode */
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_device_new
c_func
(paren
id|card
comma
id|SNDRV_DEV_LOWLEVEL
comma
id|opl3
comma
op_amp
id|ops
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_opl3_free
c_func
(paren
id|opl3
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
op_star
id|ropl3
op_assign
id|opl3
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_opl3_timer_new
r_int
id|snd_opl3_timer_new
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
id|timer1_dev
comma
r_int
id|timer2_dev
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|timer1_dev
op_ge
l_int|0
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_opl3_timer1_init
c_func
(paren
id|opl3
comma
id|timer1_dev
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|timer2_dev
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_opl3_timer2_init
c_func
(paren
id|opl3
comma
id|timer2_dev
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_device_free
c_func
(paren
id|opl3-&gt;card
comma
id|opl3-&gt;timer1
)paren
suffix:semicolon
id|opl3-&gt;timer1
op_assign
l_int|NULL
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_opl3_hwdep_new
r_int
id|snd_opl3_hwdep_new
c_func
(paren
id|opl3_t
op_star
id|opl3
comma
r_int
id|device
comma
r_int
id|seq_device
comma
id|snd_hwdep_t
op_star
op_star
id|rhwdep
)paren
(brace
id|snd_hwdep_t
op_star
id|hw
suffix:semicolon
id|snd_card_t
op_star
id|card
op_assign
id|opl3-&gt;card
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|rhwdep
)paren
op_star
id|rhwdep
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* create hardware dependent device (direct FM) */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_hwdep_new
c_func
(paren
id|card
comma
l_string|&quot;OPL2/OPL3&quot;
comma
id|device
comma
op_amp
id|hw
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_device_free
c_func
(paren
id|card
comma
id|opl3
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|hw-&gt;private_data
op_assign
id|opl3
suffix:semicolon
macro_line|#ifdef CONFIG_SND_OSSEMUL
r_if
c_cond
(paren
id|device
op_eq
l_int|0
)paren
(brace
id|hw-&gt;oss_type
op_assign
id|SNDRV_OSS_DEVICE_TYPE_DMFM
suffix:semicolon
id|sprintf
c_func
(paren
id|hw-&gt;oss_dev
comma
l_string|&quot;dmfm%i&quot;
comma
id|card-&gt;number
)paren
suffix:semicolon
)brace
macro_line|#endif
id|strcpy
c_func
(paren
id|hw-&gt;name
comma
id|hw-&gt;id
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|opl3-&gt;hardware
op_amp
id|OPL3_HW_MASK
)paren
(brace
r_case
id|OPL3_HW_OPL2
suffix:colon
id|strcpy
c_func
(paren
id|hw-&gt;name
comma
l_string|&quot;OPL2 FM&quot;
)paren
suffix:semicolon
id|hw-&gt;iface
op_assign
id|SNDRV_HWDEP_IFACE_OPL2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPL3_HW_OPL3
suffix:colon
id|strcpy
c_func
(paren
id|hw-&gt;name
comma
l_string|&quot;OPL3 FM&quot;
)paren
suffix:semicolon
id|hw-&gt;iface
op_assign
id|SNDRV_HWDEP_IFACE_OPL3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OPL3_HW_OPL4
suffix:colon
id|strcpy
c_func
(paren
id|hw-&gt;name
comma
l_string|&quot;OPL4 FM&quot;
)paren
suffix:semicolon
id|hw-&gt;iface
op_assign
id|SNDRV_HWDEP_IFACE_OPL4
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* operators - only ioctl */
id|hw-&gt;ops.open
op_assign
id|snd_opl3_open
suffix:semicolon
id|hw-&gt;ops.ioctl
op_assign
id|snd_opl3_ioctl
suffix:semicolon
id|hw-&gt;ops.release
op_assign
id|snd_opl3_release
suffix:semicolon
id|opl3-&gt;seq_dev_num
op_assign
id|seq_device
suffix:semicolon
macro_line|#if defined(CONFIG_SND_SEQUENCER) || (defined(MODULE) &amp;&amp; defined(CONFIG_SND_SEQUENCER_MODULE))
r_if
c_cond
(paren
id|snd_seq_device_new
c_func
(paren
id|card
comma
id|seq_device
comma
id|SNDRV_SEQ_DEV_ID_OPL3
comma
r_sizeof
(paren
id|opl3_t
op_star
)paren
comma
op_amp
id|opl3-&gt;seq_dev
)paren
op_ge
l_int|0
)paren
(brace
id|strcpy
c_func
(paren
id|opl3-&gt;seq_dev-&gt;name
comma
id|hw-&gt;name
)paren
suffix:semicolon
op_star
(paren
id|opl3_t
op_star
op_star
)paren
id|SNDRV_SEQ_DEVICE_ARGPTR
c_func
(paren
id|opl3-&gt;seq_dev
)paren
op_assign
id|opl3
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|rhwdep
)paren
op_star
id|rhwdep
op_assign
id|hw
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|snd_opl3_interrupt
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl3_interrupt
)paren
suffix:semicolon
DECL|variable|snd_opl3_create
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl3_create
)paren
suffix:semicolon
DECL|variable|snd_opl3_timer_new
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl3_timer_new
)paren
suffix:semicolon
DECL|variable|snd_opl3_hwdep_new
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl3_hwdep_new
)paren
suffix:semicolon
multiline_comment|/* opl3_synth.c */
DECL|variable|snd_opl3_regmap
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl3_regmap
)paren
suffix:semicolon
DECL|variable|snd_opl3_reset
id|EXPORT_SYMBOL
c_func
(paren
id|snd_opl3_reset
)paren
suffix:semicolon
multiline_comment|/*&n; *  INIT part&n; */
DECL|function|alsa_opl3_init
r_static
r_int
id|__init
id|alsa_opl3_init
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alsa_opl3_exit
r_static
r_void
id|__exit
id|alsa_opl3_exit
c_func
(paren
r_void
)paren
(brace
)brace
id|module_init
c_func
(paren
id|alsa_opl3_init
)paren
id|module_exit
c_func
(paren
id|alsa_opl3_exit
)paren
eof
