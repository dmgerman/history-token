multiline_comment|/*&n; *  Driver for ESS Maestro 1/2/2E Sound Card (started 21.8.99)&n; *  Copyright (c) by Matze Braun &lt;MatzeBraun@gmx.de&gt;.&n; *                   Takashi Iwai &lt;tiwai@suse.de&gt;&n; *                  &n; *  Most of the driver code comes from Zach Brown(zab@redhat.com)&n; *&t;Alan Cox OSS Driver&n; *  Rewritted from card-es1938.c source.&n; *&n; *  TODO:&n; *   Perhaps Synth&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; *&n; *  Notes from Zach Brown about the driver code&n; *&n; *  Hardware Description&n; *&n; *&t;A working Maestro setup contains the Maestro chip wired to a &n; *&t;codec or 2.  In the Maestro we have the APUs, the ASSP, and the&n; *&t;Wavecache.  The APUs can be though of as virtual audio routing&n; *&t;channels.  They can take data from a number of sources and perform&n; *&t;basic encodings of the data.  The wavecache is a storehouse for&n; *&t;PCM data.  Typically it deals with PCI and interracts with the&n; *&t;APUs.  The ASSP is a wacky DSP like device that ESS is loth&n; *&t;to release docs on.  Thankfully it isn&squot;t required on the Maestro&n; *&t;until you start doing insane things like FM emulation and surround&n; *&t;encoding.  The codecs are almost always AC-97 compliant codecs, &n; *&t;but it appears that early Maestros may have had PT101 (an ESS&n; *&t;part?) wired to them.  The only real difference in the Maestro&n; *&t;families is external goop like docking capability, memory for&n; *&t;the ASSP, and initialization differences.&n; *&n; *  Driver Operation&n; *&n; *&t;We only drive the APU/Wavecache as typical DACs and drive the&n; *&t;mixers in the codecs.  There are 64 APUs.  We assign 6 to each&n; *&t;/dev/dsp? device.  2 channels for output, and 4 channels for&n; *&t;input.&n; *&n; *&t;Each APU can do a number of things, but we only really use&n; *&t;3 basic functions.  For playback we use them to convert PCM&n; *&t;data fetched over PCI by the wavecahche into analog data that&n; *&t;is handed to the codec.  One APU for mono, and a pair for stereo.&n; *&t;When in stereo, the combination of smarts in the APU and Wavecache&n; *&t;decide which wavecache gets the left or right channel.&n; *&n; *&t;For record we still use the old overly mono system.  For each in&n; *&t;coming channel the data comes in from the codec, through a &squot;input&squot;&n; *&t;APU, through another rate converter APU, and then into memory via&n; *&t;the wavecache and PCI.  If its stereo, we mash it back into LRLR in&n; *&t;software.  The pass between the 2 APUs is supposedly what requires us&n; *&t;to have a 512 byte buffer sitting around in wavecache/memory.&n; *&n; *&t;The wavecache makes our life even more fun.  First off, it can&n; *&t;only address the first 28 bits of PCI address space, making it&n; *&t;useless on quite a few architectures.  Secondly, its insane.&n; *&t;It claims to fetch from 4 regions of PCI space, each 4 meg in length.&n; *&t;But that doesn&squot;t really work.  You can only use 1 region.  So all our&n; *&t;allocations have to be in 4meg of each other.  Booo.  Hiss.&n; *&t;So we have a module parameter, dsps_order, that is the order of&n; *&t;the number of dsps to provide.  All their buffer space is allocated&n; *&t;on open time.  The sonicvibes OSS routines we inherited really want&n; *&t;power of 2 buffers, so we have all those next to each other, then&n; *&t;512 byte regions for the recording wavecaches.  This ends up&n; *&t;wasting quite a bit of memory.  The only fixes I can see would be &n; *&t;getting a kernel allocator that could work in zones, or figuring out&n; *&t;just how to coerce the WP into doing what we want.&n; *&n; *&t;The indirection of the various registers means we have to spinlock&n; *&t;nearly all register accesses.  We have the main register indirection&n; *&t;like the wave cache, maestro registers, etc.  Then we have beasts&n; *&t;like the APU interface that is indirect registers gotten at through&n; *&t;the main maestro indirection.  Ouch.  We spinlock around the actual&n; *&t;ports on a per card basis.  This means spinlock activity at each IO&n; *&t;operation, but the only IO operation clusters are in non critical &n; *&t;paths and it makes the code far easier to follow.  Interrupts are&n; *&t;blocked while holding the locks because the int handler has to&n; *&t;get at some of them :(.  The mixer interface doesn&squot;t, however.&n; *&t;We also have an OSS state lock that is thrown around in a few&n; *&t;places.&n; */
DECL|macro|__SND_OSS_COMPAT__
mdefine_line|#define __SND_OSS_COMPAT__
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/pcm.h&gt;
macro_line|#include &lt;sound/mpu401.h&gt;
macro_line|#include &lt;sound/ac97_codec.h&gt;
DECL|macro|SNDRV_GET_ID
mdefine_line|#define SNDRV_GET_ID
macro_line|#include &lt;sound/initval.h&gt;
DECL|macro|chip_t
mdefine_line|#define chip_t es1968_t
DECL|macro|CARD_NAME
mdefine_line|#define CARD_NAME &quot;ESS Maestro1/2&quot;
DECL|macro|DRIVER_NAME
mdefine_line|#define DRIVER_NAME &quot;ES1968&quot;
id|EXPORT_NO_SYMBOLS
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ESS Maestro&quot;
)paren
suffix:semicolon
id|MODULE_CLASSES
c_func
(paren
l_string|&quot;{sound}&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DEVICES
c_func
(paren
l_string|&quot;{{ESS,Maestro 2e},&quot;
l_string|&quot;{ESS,Maestro 2},&quot;
l_string|&quot;{ESS,Maestro 1},&quot;
l_string|&quot;{TerraTec,DMX}}&quot;
)paren
suffix:semicolon
DECL|variable|snd_index
r_static
r_int
id|snd_index
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_IDX
suffix:semicolon
multiline_comment|/* Index 1-MAX */
DECL|variable|snd_id
r_static
r_char
op_star
id|snd_id
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_STR
suffix:semicolon
multiline_comment|/* ID for this card */
DECL|variable|snd_enable
r_static
r_int
id|snd_enable
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_ENABLE_PNP
suffix:semicolon
multiline_comment|/* Enable this card */
DECL|variable|snd_total_bufsize
r_static
r_int
id|snd_total_bufsize
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|1024
)brace
suffix:semicolon
DECL|variable|snd_pcm_substreams_p
r_static
r_int
id|snd_pcm_substreams_p
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|4
)brace
suffix:semicolon
DECL|variable|snd_pcm_substreams_c
r_static
r_int
id|snd_pcm_substreams_c
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|1
)brace
suffix:semicolon
DECL|variable|snd_clock
r_static
r_int
id|snd_clock
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|0
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snd_index
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snd_index
comma
l_string|&quot;Index value for &quot;
id|CARD_NAME
l_string|&quot; soundcard.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|snd_index
comma
id|SNDRV_INDEX_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snd_id
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snd_id
comma
l_string|&quot;ID string for &quot;
id|CARD_NAME
l_string|&quot; soundcard.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|snd_id
comma
id|SNDRV_ID_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snd_enable
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snd_enable
comma
l_string|&quot;Enable &quot;
id|CARD_NAME
l_string|&quot; soundcard.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|snd_enable
comma
id|SNDRV_ENABLE_DESC
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snd_total_bufsize
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snd_total_bufsize
comma
l_string|&quot;Total buffer size in kB.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|snd_total_bufsize
comma
id|SNDRV_ENABLED
l_string|&quot;,allows:{{1,4096}},skill:advanced&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snd_pcm_substreams_p
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snd_pcm_substreams_p
comma
l_string|&quot;PCM Playback substreams for &quot;
id|CARD_NAME
l_string|&quot; soundcard.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|snd_pcm_substreams_p
comma
id|SNDRV_ENABLED
l_string|&quot;,allows:{{1,8}}&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snd_pcm_substreams_c
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snd_pcm_substreams_c
comma
l_string|&quot;PCM Capture substreams for &quot;
id|CARD_NAME
l_string|&quot; soundcard.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|snd_pcm_substreams_c
comma
id|SNDRV_ENABLED
l_string|&quot;,allows:{{0,8}}&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|snd_clock
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|SNDRV_CARDS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|snd_clock
comma
l_string|&quot;Clock on &quot;
id|CARD_NAME
l_string|&quot; soundcard.  (0 = auto-detect)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|snd_clock
comma
id|SNDRV_ENABLED
)paren
suffix:semicolon
multiline_comment|/* PCI Dev ID&squot;s */
macro_line|#ifndef PCI_VENDOR_ID_ESS
DECL|macro|PCI_VENDOR_ID_ESS
mdefine_line|#define PCI_VENDOR_ID_ESS&t;0x125D
macro_line|#endif
DECL|macro|PCI_VENDOR_ID_ESS_OLD
mdefine_line|#define PCI_VENDOR_ID_ESS_OLD&t;0x1285&t;/* Platform Tech, the people the ESS&n;&t;&t;&t;&t;&t;   was bought form */
macro_line|#ifndef PCI_DEVICE_ID_ESS_M2E
DECL|macro|PCI_DEVICE_ID_ESS_M2E
mdefine_line|#define PCI_DEVICE_ID_ESS_M2E&t;0x1978
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_ESS_M2
DECL|macro|PCI_DEVICE_ID_ESS_M2
mdefine_line|#define PCI_DEVICE_ID_ESS_M2&t;0x1968
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_ESS_M1
DECL|macro|PCI_DEVICE_ID_ESS_M1
mdefine_line|#define PCI_DEVICE_ID_ESS_M1&t;0x0100
macro_line|#endif
DECL|macro|NR_APUS
mdefine_line|#define NR_APUS&t;&t;&t;64
DECL|macro|NR_APU_REGS
mdefine_line|#define NR_APU_REGS&t;&t;16
multiline_comment|/* NEC Versas ? */
DECL|macro|NEC_VERSA_SUBID1
mdefine_line|#define NEC_VERSA_SUBID1&t;0x80581033
DECL|macro|NEC_VERSA_SUBID2
mdefine_line|#define NEC_VERSA_SUBID2&t;0x803c1033
multiline_comment|/* Mode Flags */
DECL|macro|ESS_FMT_STEREO
mdefine_line|#define ESS_FMT_STEREO     &t;0x01
DECL|macro|ESS_FMT_16BIT
mdefine_line|#define ESS_FMT_16BIT      &t;0x02
DECL|macro|DAC_RUNNING
mdefine_line|#define DAC_RUNNING&t;&t;1
DECL|macro|ADC_RUNNING
mdefine_line|#define ADC_RUNNING&t;&t;2
multiline_comment|/* Values for the ESM_LEGACY_AUDIO_CONTROL */
DECL|macro|ESS_ENABLE_AUDIO
mdefine_line|#define ESS_ENABLE_AUDIO&t;0x8000
DECL|macro|ESS_ENABLE_SERIAL_IRQ
mdefine_line|#define ESS_ENABLE_SERIAL_IRQ&t;0x4000
DECL|macro|IO_ADRESS_ALIAS
mdefine_line|#define IO_ADRESS_ALIAS&t;&t;0x0020
DECL|macro|MPU401_IRQ_ENABLE
mdefine_line|#define MPU401_IRQ_ENABLE&t;0x0010
DECL|macro|MPU401_IO_ENABLE
mdefine_line|#define MPU401_IO_ENABLE&t;0x0008
DECL|macro|GAME_IO_ENABLE
mdefine_line|#define GAME_IO_ENABLE&t;&t;0x0004
DECL|macro|FM_IO_ENABLE
mdefine_line|#define FM_IO_ENABLE&t;&t;0x0002
DECL|macro|SB_IO_ENABLE
mdefine_line|#define SB_IO_ENABLE&t;&t;0x0001
multiline_comment|/* Values for the ESM_CONFIG_A */
DECL|macro|PIC_SNOOP1
mdefine_line|#define PIC_SNOOP1&t;&t;0x4000
DECL|macro|PIC_SNOOP2
mdefine_line|#define PIC_SNOOP2&t;&t;0x2000
DECL|macro|SAFEGUARD
mdefine_line|#define SAFEGUARD&t;&t;0x0800
DECL|macro|DMA_CLEAR
mdefine_line|#define DMA_CLEAR&t;&t;0x0700
DECL|macro|DMA_DDMA
mdefine_line|#define DMA_DDMA&t;&t;0x0000
DECL|macro|DMA_TDMA
mdefine_line|#define DMA_TDMA&t;&t;0x0100
DECL|macro|DMA_PCPCI
mdefine_line|#define DMA_PCPCI&t;&t;0x0200
DECL|macro|POST_WRITE
mdefine_line|#define POST_WRITE&t;&t;0x0080
DECL|macro|ISA_TIMING
mdefine_line|#define ISA_TIMING&t;&t;0x0040
DECL|macro|SWAP_LR
mdefine_line|#define SWAP_LR&t;&t;&t;0x0020
DECL|macro|SUBTR_DECODE
mdefine_line|#define SUBTR_DECODE&t;&t;0x0002
multiline_comment|/* Values for the ESM_CONFIG_B */
DECL|macro|SPDIF_CONFB
mdefine_line|#define SPDIF_CONFB&t;&t;0x0100
DECL|macro|HWV_CONFB
mdefine_line|#define HWV_CONFB&t;&t;0x0080
DECL|macro|DEBOUNCE
mdefine_line|#define DEBOUNCE&t;&t;0x0040
DECL|macro|GPIO_CONFB
mdefine_line|#define GPIO_CONFB&t;&t;0x0020
DECL|macro|CHI_CONFB
mdefine_line|#define CHI_CONFB&t;&t;0x0010
DECL|macro|IDMA_CONFB
mdefine_line|#define IDMA_CONFB&t;&t;0x0008&t;/*undoc */
DECL|macro|MIDI_FIX
mdefine_line|#define MIDI_FIX&t;&t;0x0004&t;/*undoc */
DECL|macro|IRQ_TO_ISA
mdefine_line|#define IRQ_TO_ISA&t;&t;0x0001&t;/*undoc */
multiline_comment|/* Values for Ring Bus Control B */
DECL|macro|RINGB_2CODEC_ID_MASK
mdefine_line|#define&t;RINGB_2CODEC_ID_MASK&t;0x0003
DECL|macro|RINGB_DIS_VALIDATION
mdefine_line|#define RINGB_DIS_VALIDATION&t;0x0008
DECL|macro|RINGB_EN_SPDIF
mdefine_line|#define RINGB_EN_SPDIF&t;&t;0x0010
DECL|macro|RINGB_EN_2CODEC
mdefine_line|#define&t;RINGB_EN_2CODEC&t;&t;0x0020
DECL|macro|RINGB_SING_BIT_DUAL
mdefine_line|#define RINGB_SING_BIT_DUAL&t;0x0040
multiline_comment|/* ****Port Adresses**** */
multiline_comment|/*   Write &amp; Read */
DECL|macro|ESM_INDEX
mdefine_line|#define ESM_INDEX&t;&t;0x02
DECL|macro|ESM_DATA
mdefine_line|#define ESM_DATA&t;&t;0x00
multiline_comment|/*   AC97 + RingBus */
DECL|macro|ESM_AC97_INDEX
mdefine_line|#define ESM_AC97_INDEX&t;&t;0x30
DECL|macro|ESM_AC97_DATA
mdefine_line|#define&t;ESM_AC97_DATA&t;&t;0x32
DECL|macro|ESM_RING_BUS_DEST
mdefine_line|#define ESM_RING_BUS_DEST&t;0x34
DECL|macro|ESM_RING_BUS_CONTR_A
mdefine_line|#define ESM_RING_BUS_CONTR_A&t;0x36
DECL|macro|ESM_RING_BUS_CONTR_B
mdefine_line|#define ESM_RING_BUS_CONTR_B&t;0x38
DECL|macro|ESM_RING_BUS_SDO
mdefine_line|#define ESM_RING_BUS_SDO&t;0x3A
multiline_comment|/*   WaveCache*/
DECL|macro|WC_INDEX
mdefine_line|#define WC_INDEX&t;&t;0x10
DECL|macro|WC_DATA
mdefine_line|#define WC_DATA&t;&t;&t;0x12
DECL|macro|WC_CONTROL
mdefine_line|#define WC_CONTROL&t;&t;0x14
multiline_comment|/*   ASSP*/
DECL|macro|ASSP_INDEX
mdefine_line|#define ASSP_INDEX&t;&t;0x80
DECL|macro|ASSP_MEMORY
mdefine_line|#define ASSP_MEMORY&t;&t;0x82
DECL|macro|ASSP_DATA
mdefine_line|#define ASSP_DATA&t;&t;0x84
DECL|macro|ASSP_CONTROL_A
mdefine_line|#define ASSP_CONTROL_A&t;&t;0xA2
DECL|macro|ASSP_CONTROL_B
mdefine_line|#define ASSP_CONTROL_B&t;&t;0xA4
DECL|macro|ASSP_CONTROL_C
mdefine_line|#define ASSP_CONTROL_C&t;&t;0xA6
DECL|macro|ASSP_HOSTW_INDEX
mdefine_line|#define ASSP_HOSTW_INDEX&t;0xA8
DECL|macro|ASSP_HOSTW_DATA
mdefine_line|#define ASSP_HOSTW_DATA&t;&t;0xAA
DECL|macro|ASSP_HOSTW_IRQ
mdefine_line|#define ASSP_HOSTW_IRQ&t;&t;0xAC
multiline_comment|/* Midi */
DECL|macro|ESM_MPU401_PORT
mdefine_line|#define ESM_MPU401_PORT&t;&t;0x98
multiline_comment|/* Others */
DECL|macro|ESM_PORT_HOST_IRQ
mdefine_line|#define ESM_PORT_HOST_IRQ&t;0x18
DECL|macro|IDR0_DATA_PORT
mdefine_line|#define IDR0_DATA_PORT&t;&t;0x00
DECL|macro|IDR1_CRAM_POINTER
mdefine_line|#define IDR1_CRAM_POINTER&t;0x01
DECL|macro|IDR2_CRAM_DATA
mdefine_line|#define IDR2_CRAM_DATA&t;&t;0x02
DECL|macro|IDR3_WAVE_DATA
mdefine_line|#define IDR3_WAVE_DATA&t;&t;0x03
DECL|macro|IDR4_WAVE_PTR_LOW
mdefine_line|#define IDR4_WAVE_PTR_LOW&t;0x04
DECL|macro|IDR5_WAVE_PTR_HI
mdefine_line|#define IDR5_WAVE_PTR_HI&t;0x05
DECL|macro|IDR6_TIMER_CTRL
mdefine_line|#define IDR6_TIMER_CTRL&t;&t;0x06
DECL|macro|IDR7_WAVE_ROMRAM
mdefine_line|#define IDR7_WAVE_ROMRAM&t;0x07
DECL|macro|WRITEABLE_MAP
mdefine_line|#define WRITEABLE_MAP&t;&t;0xEFFFFF
DECL|macro|READABLE_MAP
mdefine_line|#define READABLE_MAP&t;&t;0x64003F
multiline_comment|/* PCI Register */
DECL|macro|ESM_LEGACY_AUDIO_CONTROL
mdefine_line|#define ESM_LEGACY_AUDIO_CONTROL 0x40
DECL|macro|ESM_ACPI_COMMAND
mdefine_line|#define ESM_ACPI_COMMAND&t;0x54
DECL|macro|ESM_CONFIG_A
mdefine_line|#define ESM_CONFIG_A&t;&t;0x50
DECL|macro|ESM_CONFIG_B
mdefine_line|#define ESM_CONFIG_B&t;&t;0x52
DECL|macro|ESM_DDMA
mdefine_line|#define ESM_DDMA&t;&t;0x60
multiline_comment|/* Bob Bits */
DECL|macro|ESM_BOB_ENABLE
mdefine_line|#define ESM_BOB_ENABLE&t;&t;0x0001
DECL|macro|ESM_BOB_START
mdefine_line|#define ESM_BOB_START&t;&t;0x0001
multiline_comment|/* Host IRQ Control Bits */
DECL|macro|ESM_RESET_MAESTRO
mdefine_line|#define ESM_RESET_MAESTRO&t;0x8000
DECL|macro|ESM_RESET_DIRECTSOUND
mdefine_line|#define ESM_RESET_DIRECTSOUND   0x4000
DECL|macro|ESM_HIRQ_ClkRun
mdefine_line|#define ESM_HIRQ_ClkRun&t;&t;0x0100
DECL|macro|ESM_HIRQ_HW_VOLUME
mdefine_line|#define ESM_HIRQ_HW_VOLUME&t;0x0040
DECL|macro|ESM_HIRQ_HARPO
mdefine_line|#define ESM_HIRQ_HARPO&t;&t;0x0030&t;/* What&squot;s that? */
DECL|macro|ESM_HIRQ_ASSP
mdefine_line|#define ESM_HIRQ_ASSP&t;&t;0x0010
DECL|macro|ESM_HIRQ_DSIE
mdefine_line|#define&t;ESM_HIRQ_DSIE&t;&t;0x0004
DECL|macro|ESM_HIRQ_MPU401
mdefine_line|#define ESM_HIRQ_MPU401&t;&t;0x0002
DECL|macro|ESM_HIRQ_SB
mdefine_line|#define ESM_HIRQ_SB&t;&t;0x0001
multiline_comment|/* Host IRQ Status Bits */
DECL|macro|ESM_MPU401_IRQ
mdefine_line|#define ESM_MPU401_IRQ&t;&t;0x02
DECL|macro|ESM_SB_IRQ
mdefine_line|#define ESM_SB_IRQ&t;&t;0x01
DECL|macro|ESM_SOUND_IRQ
mdefine_line|#define ESM_SOUND_IRQ&t;&t;0x04
DECL|macro|ESM_ASSP_IRQ
mdefine_line|#define&t;ESM_ASSP_IRQ&t;&t;0x10
DECL|macro|ESM_HWVOL_IRQ
mdefine_line|#define ESM_HWVOL_IRQ&t;&t;0x40
DECL|macro|ESS_SYSCLK
mdefine_line|#define ESS_SYSCLK&t;&t;50000000
DECL|macro|ESM_BOB_FREQ
mdefine_line|#define ESM_BOB_FREQ &t;&t;200
DECL|macro|ESM_BOB_FREQ_MAX
mdefine_line|#define ESM_BOB_FREQ_MAX&t;800
DECL|macro|ESM_FREQ_ESM1
mdefine_line|#define ESM_FREQ_ESM1  &t;&t;(49152000L / 1024L)&t;/* default rate 48000 */
DECL|macro|ESM_FREQ_ESM2
mdefine_line|#define ESM_FREQ_ESM2  &t;&t;(50000000L / 1024L)
multiline_comment|/* APU Modes: reg 0x00, bit 4-7 */
DECL|macro|ESM_APU_MODE_SHIFT
mdefine_line|#define ESM_APU_MODE_SHIFT&t;4
DECL|macro|ESM_APU_MODE_MASK
mdefine_line|#define ESM_APU_MODE_MASK&t;(0xf &lt;&lt; 4)
DECL|macro|ESM_APU_OFF
mdefine_line|#define&t;ESM_APU_OFF&t;&t;0x00
DECL|macro|ESM_APU_16BITLINEAR
mdefine_line|#define&t;ESM_APU_16BITLINEAR&t;0x01&t;/* 16-Bit Linear Sample Player */
DECL|macro|ESM_APU_16BITSTEREO
mdefine_line|#define&t;ESM_APU_16BITSTEREO&t;0x02&t;/* 16-Bit Stereo Sample Player */
DECL|macro|ESM_APU_8BITLINEAR
mdefine_line|#define&t;ESM_APU_8BITLINEAR&t;0x03&t;/* 8-Bit Linear Sample Player */
DECL|macro|ESM_APU_8BITSTEREO
mdefine_line|#define&t;ESM_APU_8BITSTEREO&t;0x04&t;/* 8-Bit Stereo Sample Player */
DECL|macro|ESM_APU_8BITDIFF
mdefine_line|#define&t;ESM_APU_8BITDIFF&t;0x05&t;/* 8-Bit Differential Sample Playrer */
DECL|macro|ESM_APU_DIGITALDELAY
mdefine_line|#define&t;ESM_APU_DIGITALDELAY&t;0x06&t;/* Digital Delay Line */
DECL|macro|ESM_APU_DUALTAP
mdefine_line|#define&t;ESM_APU_DUALTAP&t;&t;0x07&t;/* Dual Tap Reader */
DECL|macro|ESM_APU_CORRELATOR
mdefine_line|#define&t;ESM_APU_CORRELATOR&t;0x08&t;/* Correlator */
DECL|macro|ESM_APU_INPUTMIXER
mdefine_line|#define&t;ESM_APU_INPUTMIXER&t;0x09&t;/* Input Mixer */
DECL|macro|ESM_APU_WAVETABLE
mdefine_line|#define&t;ESM_APU_WAVETABLE&t;0x0A&t;/* Wave Table Mode */
DECL|macro|ESM_APU_SRCONVERTOR
mdefine_line|#define&t;ESM_APU_SRCONVERTOR&t;0x0B&t;/* Sample Rate Convertor */
DECL|macro|ESM_APU_16BITPINGPONG
mdefine_line|#define&t;ESM_APU_16BITPINGPONG&t;0x0C&t;/* 16-Bit Ping-Pong Sample Player */
DECL|macro|ESM_APU_RESERVED1
mdefine_line|#define&t;ESM_APU_RESERVED1&t;0x0D&t;/* Reserved 1 */
DECL|macro|ESM_APU_RESERVED2
mdefine_line|#define&t;ESM_APU_RESERVED2&t;0x0E&t;/* Reserved 2 */
DECL|macro|ESM_APU_RESERVED3
mdefine_line|#define&t;ESM_APU_RESERVED3&t;0x0F&t;/* Reserved 3 */
multiline_comment|/* reg 0x00 */
DECL|macro|ESM_APU_FILTER_Q_SHIFT
mdefine_line|#define ESM_APU_FILTER_Q_SHIFT&t;&t;0
DECL|macro|ESM_APU_FILTER_Q_MASK
mdefine_line|#define ESM_APU_FILTER_Q_MASK&t;&t;(3 &lt;&lt; 0)
multiline_comment|/* APU Filtey Q Control */
DECL|macro|ESM_APU_FILTER_LESSQ
mdefine_line|#define ESM_APU_FILTER_LESSQ&t;0x00
DECL|macro|ESM_APU_FILTER_MOREQ
mdefine_line|#define ESM_APU_FILTER_MOREQ&t;0x03
DECL|macro|ESM_APU_FILTER_TYPE_SHIFT
mdefine_line|#define ESM_APU_FILTER_TYPE_SHIFT&t;2
DECL|macro|ESM_APU_FILTER_TYPE_MASK
mdefine_line|#define ESM_APU_FILTER_TYPE_MASK&t;(3 &lt;&lt; 2)
DECL|macro|ESM_APU_ENV_TYPE_SHIFT
mdefine_line|#define ESM_APU_ENV_TYPE_SHIFT&t;&t;8
DECL|macro|ESM_APU_ENV_TYPE_MASK
mdefine_line|#define ESM_APU_ENV_TYPE_MASK&t;&t;(3 &lt;&lt; 8)
DECL|macro|ESM_APU_ENV_STATE_SHIFT
mdefine_line|#define ESM_APU_ENV_STATE_SHIFT&t;&t;10
DECL|macro|ESM_APU_ENV_STATE_MASK
mdefine_line|#define ESM_APU_ENV_STATE_MASK&t;&t;(3 &lt;&lt; 10)
DECL|macro|ESM_APU_END_CURVE
mdefine_line|#define ESM_APU_END_CURVE&t;&t;(1 &lt;&lt; 12)
DECL|macro|ESM_APU_INT_ON_LOOP
mdefine_line|#define ESM_APU_INT_ON_LOOP&t;&t;(1 &lt;&lt; 13)
DECL|macro|ESM_APU_DMA_ENABLE
mdefine_line|#define ESM_APU_DMA_ENABLE&t;&t;(1 &lt;&lt; 14)
multiline_comment|/* reg 0x02 */
DECL|macro|ESM_APU_SUBMIX_GROUP_SHIRT
mdefine_line|#define ESM_APU_SUBMIX_GROUP_SHIRT&t;0
DECL|macro|ESM_APU_SUBMIX_GROUP_MASK
mdefine_line|#define ESM_APU_SUBMIX_GROUP_MASK&t;(7 &lt;&lt; 0)
DECL|macro|ESM_APU_SUBMIX_MODE
mdefine_line|#define ESM_APU_SUBMIX_MODE&t;&t;(1 &lt;&lt; 3)
DECL|macro|ESM_APU_6dB
mdefine_line|#define ESM_APU_6dB&t;&t;&t;(1 &lt;&lt; 4)
DECL|macro|ESM_APU_DUAL_EFFECT
mdefine_line|#define ESM_APU_DUAL_EFFECT&t;&t;(1 &lt;&lt; 5)
DECL|macro|ESM_APU_EFFECT_CHANNELS_SHIFT
mdefine_line|#define ESM_APU_EFFECT_CHANNELS_SHIFT&t;6
DECL|macro|ESM_APU_EFFECT_CHANNELS_MASK
mdefine_line|#define ESM_APU_EFFECT_CHANNELS_MASK&t;(3 &lt;&lt; 6)
multiline_comment|/* reg 0x03 */
DECL|macro|ESM_APU_STEP_SIZE_MASK
mdefine_line|#define ESM_APU_STEP_SIZE_MASK&t;&t;0x0fff
multiline_comment|/* reg 0x04 */
DECL|macro|ESM_APU_PHASE_SHIFT
mdefine_line|#define ESM_APU_PHASE_SHIFT&t;&t;0
DECL|macro|ESM_APU_PHASE_MASK
mdefine_line|#define ESM_APU_PHASE_MASK&t;&t;(0xff &lt;&lt; 0)
DECL|macro|ESM_APU_WAVE64K_PAGE_SHIFT
mdefine_line|#define ESM_APU_WAVE64K_PAGE_SHIFT&t;8&t;/* most 8bit of wave start offset */
DECL|macro|ESM_APU_WAVE64K_PAGE_MASK
mdefine_line|#define ESM_APU_WAVE64K_PAGE_MASK&t;(0xff &lt;&lt; 8)
multiline_comment|/* reg 0x05 - wave start offset */
multiline_comment|/* reg 0x06 - wave end offset */
multiline_comment|/* reg 0x07 - wave loop length */
multiline_comment|/* reg 0x08 */
DECL|macro|ESM_APU_EFFECT_GAIN_SHIFT
mdefine_line|#define ESM_APU_EFFECT_GAIN_SHIFT&t;0
DECL|macro|ESM_APU_EFFECT_GAIN_MASK
mdefine_line|#define ESM_APU_EFFECT_GAIN_MASK&t;(0xff &lt;&lt; 0)
DECL|macro|ESM_APU_TREMOLO_DEPTH_SHIFT
mdefine_line|#define ESM_APU_TREMOLO_DEPTH_SHIFT&t;8
DECL|macro|ESM_APU_TREMOLO_DEPTH_MASK
mdefine_line|#define ESM_APU_TREMOLO_DEPTH_MASK&t;(0xf &lt;&lt; 8)
DECL|macro|ESM_APU_TREMOLO_RATE_SHIFT
mdefine_line|#define ESM_APU_TREMOLO_RATE_SHIFT&t;12
DECL|macro|ESM_APU_TREMOLO_RATE_MASK
mdefine_line|#define ESM_APU_TREMOLO_RATE_MASK&t;(0xf &lt;&lt; 12)
multiline_comment|/* reg 0x09 */
multiline_comment|/* bit 0-7 amplitude dest? */
DECL|macro|ESM_APU_AMPLITUDE_NOW_SHIFT
mdefine_line|#define ESM_APU_AMPLITUDE_NOW_SHIFT&t;8
DECL|macro|ESM_APU_AMPLITUDE_NOW_MASK
mdefine_line|#define ESM_APU_AMPLITUDE_NOW_MASK&t;(0xff &lt;&lt; 8)
multiline_comment|/* reg 0x0a */
DECL|macro|ESM_APU_POLAR_PAN_SHIFT
mdefine_line|#define ESM_APU_POLAR_PAN_SHIFT&t;&t;0
DECL|macro|ESM_APU_POLAR_PAN_MASK
mdefine_line|#define ESM_APU_POLAR_PAN_MASK&t;&t;(0x3f &lt;&lt; 0)
multiline_comment|/* Polar Pan Control */
DECL|macro|ESM_APU_PAN_CENTER_CIRCLE
mdefine_line|#define&t;ESM_APU_PAN_CENTER_CIRCLE&t;&t;0x00
DECL|macro|ESM_APU_PAN_MIDDLE_RADIUS
mdefine_line|#define&t;ESM_APU_PAN_MIDDLE_RADIUS&t;&t;0x01
DECL|macro|ESM_APU_PAN_OUTSIDE_RADIUS
mdefine_line|#define&t;ESM_APU_PAN_OUTSIDE_RADIUS&t;&t;0x02
DECL|macro|ESM_APU_FILTER_TUNING_SHIFT
mdefine_line|#define ESM_APU_FILTER_TUNING_SHIFT&t;8
DECL|macro|ESM_APU_FILTER_TUNING_MASK
mdefine_line|#define ESM_APU_FILTER_TUNING_MASK&t;(0xff &lt;&lt; 8)
multiline_comment|/* reg 0x0b */
DECL|macro|ESM_APU_DATA_SRC_A_SHIFT
mdefine_line|#define ESM_APU_DATA_SRC_A_SHIFT&t;0
DECL|macro|ESM_APU_DATA_SRC_A_MASK
mdefine_line|#define ESM_APU_DATA_SRC_A_MASK&t;&t;(0x7f &lt;&lt; 0)
DECL|macro|ESM_APU_INV_POL_A
mdefine_line|#define ESM_APU_INV_POL_A&t;&t;(1 &lt;&lt; 7)
DECL|macro|ESM_APU_DATA_SRC_B_SHIFT
mdefine_line|#define ESM_APU_DATA_SRC_B_SHIFT&t;8
DECL|macro|ESM_APU_DATA_SRC_B_MASK
mdefine_line|#define ESM_APU_DATA_SRC_B_MASK&t;&t;(0x7f &lt;&lt; 8)
DECL|macro|ESM_APU_INV_POL_B
mdefine_line|#define ESM_APU_INV_POL_B&t;&t;(1 &lt;&lt; 15)
DECL|macro|ESM_APU_VIBRATO_RATE_SHIFT
mdefine_line|#define ESM_APU_VIBRATO_RATE_SHIFT&t;0
DECL|macro|ESM_APU_VIBRATO_RATE_MASK
mdefine_line|#define ESM_APU_VIBRATO_RATE_MASK&t;(0xf &lt;&lt; 0)
DECL|macro|ESM_APU_VIBRATO_DEPTH_SHIFT
mdefine_line|#define ESM_APU_VIBRATO_DEPTH_SHIFT&t;4
DECL|macro|ESM_APU_VIBRATO_DEPTH_MASK
mdefine_line|#define ESM_APU_VIBRATO_DEPTH_MASK&t;(0xf &lt;&lt; 4)
DECL|macro|ESM_APU_VIBRATO_PHASE_SHIFT
mdefine_line|#define ESM_APU_VIBRATO_PHASE_SHIFT&t;8
DECL|macro|ESM_APU_VIBRATO_PHASE_MASK
mdefine_line|#define ESM_APU_VIBRATO_PHASE_MASK&t;(0xff &lt;&lt; 8)
multiline_comment|/* reg 0x0c */
DECL|macro|ESM_APU_RADIUS_SELECT
mdefine_line|#define ESM_APU_RADIUS_SELECT&t;&t;(1 &lt;&lt; 6)
multiline_comment|/* APU Filter Control */
DECL|macro|ESM_APU_FILTER_2POLE_LOPASS
mdefine_line|#define&t;ESM_APU_FILTER_2POLE_LOPASS&t;0x00
DECL|macro|ESM_APU_FILTER_2POLE_BANDPASS
mdefine_line|#define&t;ESM_APU_FILTER_2POLE_BANDPASS&t;0x01
DECL|macro|ESM_APU_FILTER_2POLE_HIPASS
mdefine_line|#define&t;ESM_APU_FILTER_2POLE_HIPASS&t;0x02
DECL|macro|ESM_APU_FILTER_1POLE_LOPASS
mdefine_line|#define&t;ESM_APU_FILTER_1POLE_LOPASS&t;0x03
DECL|macro|ESM_APU_FILTER_1POLE_HIPASS
mdefine_line|#define&t;ESM_APU_FILTER_1POLE_HIPASS&t;0x04
DECL|macro|ESM_APU_FILTER_OFF
mdefine_line|#define&t;ESM_APU_FILTER_OFF&t;&t;0x05
multiline_comment|/* APU ATFP Type */
DECL|macro|ESM_APU_ATFP_AMPLITUDE
mdefine_line|#define&t;ESM_APU_ATFP_AMPLITUDE&t;&t;&t;0x00
DECL|macro|ESM_APU_ATFP_TREMELO
mdefine_line|#define&t;ESM_APU_ATFP_TREMELO&t;&t;&t;0x01
DECL|macro|ESM_APU_ATFP_FILTER
mdefine_line|#define&t;ESM_APU_ATFP_FILTER&t;&t;&t;0x02
DECL|macro|ESM_APU_ATFP_PAN
mdefine_line|#define&t;ESM_APU_ATFP_PAN&t;&t;&t;0x03
multiline_comment|/* APU ATFP Flags */
DECL|macro|ESM_APU_ATFP_FLG_OFF
mdefine_line|#define&t;ESM_APU_ATFP_FLG_OFF&t;&t;&t;0x00
DECL|macro|ESM_APU_ATFP_FLG_WAIT
mdefine_line|#define&t;ESM_APU_ATFP_FLG_WAIT&t;&t;&t;0x01
DECL|macro|ESM_APU_ATFP_FLG_DONE
mdefine_line|#define&t;ESM_APU_ATFP_FLG_DONE&t;&t;&t;0x02
DECL|macro|ESM_APU_ATFP_FLG_INPROCESS
mdefine_line|#define&t;ESM_APU_ATFP_FLG_INPROCESS&t;&t;0x03
multiline_comment|/* capture mixing buffer size */
DECL|macro|ESM_MIXBUF_SIZE
mdefine_line|#define ESM_MIXBUF_SIZE&t;&t;512
DECL|macro|ESM_MODE_PLAY
mdefine_line|#define ESM_MODE_PLAY&t;&t;0
DECL|macro|ESM_MODE_CAPTURE
mdefine_line|#define ESM_MODE_CAPTURE&t;1
multiline_comment|/* acpi states */
r_enum
(brace
DECL|enumerator|ACPI_D0
id|ACPI_D0
op_assign
l_int|0
comma
DECL|enumerator|ACPI_D1
id|ACPI_D1
comma
DECL|enumerator|ACPI_D2
id|ACPI_D2
comma
DECL|enumerator|ACPI_D3
id|ACPI_D3
)brace
suffix:semicolon
multiline_comment|/* bits in the acpi masks */
DECL|macro|ACPI_12MHZ
mdefine_line|#define ACPI_12MHZ&t;( 1 &lt;&lt; 15)
DECL|macro|ACPI_24MHZ
mdefine_line|#define ACPI_24MHZ&t;( 1 &lt;&lt; 14)
DECL|macro|ACPI_978
mdefine_line|#define ACPI_978&t;( 1 &lt;&lt; 13)
DECL|macro|ACPI_SPDIF
mdefine_line|#define ACPI_SPDIF&t;( 1 &lt;&lt; 12)
DECL|macro|ACPI_GLUE
mdefine_line|#define ACPI_GLUE&t;( 1 &lt;&lt; 11)
DECL|macro|ACPI__10
mdefine_line|#define ACPI__10&t;( 1 &lt;&lt; 10) /* reserved */
DECL|macro|ACPI_PCIINT
mdefine_line|#define ACPI_PCIINT&t;( 1 &lt;&lt; 9)
DECL|macro|ACPI_HV
mdefine_line|#define ACPI_HV&t;&t;( 1 &lt;&lt; 8) /* hardware volume */
DECL|macro|ACPI_GPIO
mdefine_line|#define ACPI_GPIO&t;( 1 &lt;&lt; 7)
DECL|macro|ACPI_ASSP
mdefine_line|#define ACPI_ASSP&t;( 1 &lt;&lt; 6)
DECL|macro|ACPI_SB
mdefine_line|#define ACPI_SB&t;&t;( 1 &lt;&lt; 5) /* sb emul */
DECL|macro|ACPI_FM
mdefine_line|#define ACPI_FM&t;&t;( 1 &lt;&lt; 4) /* fm emul */
DECL|macro|ACPI_RB
mdefine_line|#define ACPI_RB&t;&t;( 1 &lt;&lt; 3) /* ringbus / aclink */
DECL|macro|ACPI_MIDI
mdefine_line|#define ACPI_MIDI&t;( 1 &lt;&lt; 2) 
DECL|macro|ACPI_GP
mdefine_line|#define ACPI_GP&t;&t;( 1 &lt;&lt; 1) /* game port */
DECL|macro|ACPI_WP
mdefine_line|#define ACPI_WP&t;&t;( 1 &lt;&lt; 0) /* wave processor */
DECL|macro|ACPI_ALL
mdefine_line|#define ACPI_ALL&t;(0xffff)
DECL|macro|ACPI_SLEEP
mdefine_line|#define ACPI_SLEEP&t;(~(ACPI_SPDIF|ACPI_ASSP|ACPI_SB|ACPI_FM| &bslash;&n;&t;&t;&t;ACPI_MIDI|ACPI_GP|ACPI_WP))
DECL|macro|ACPI_NONE
mdefine_line|#define ACPI_NONE&t;(ACPI__10)
multiline_comment|/* these masks indicate which units we care about at&n;&t;which states */
DECL|variable|acpi_state_mask
r_static
id|u16
id|acpi_state_mask
(braket
)braket
op_assign
(brace
(braket
id|ACPI_D0
)braket
op_assign
id|ACPI_ALL
comma
(braket
id|ACPI_D1
)braket
op_assign
id|ACPI_SLEEP
comma
(braket
id|ACPI_D2
)braket
op_assign
id|ACPI_SLEEP
comma
(braket
id|ACPI_D3
)braket
op_assign
id|ACPI_NONE
)brace
suffix:semicolon
DECL|typedef|es1968_t
r_typedef
r_struct
id|snd_es1968
id|es1968_t
suffix:semicolon
DECL|typedef|esschan_t
r_typedef
r_struct
id|snd_esschan
id|esschan_t
suffix:semicolon
DECL|typedef|esm_memory_t
r_typedef
r_struct
id|snd_esm_memory
id|esm_memory_t
suffix:semicolon
multiline_comment|/* APU use in the driver */
DECL|enum|snd_enum_apu_type
r_enum
id|snd_enum_apu_type
(brace
DECL|enumerator|ESM_APU_PCM_PLAY
id|ESM_APU_PCM_PLAY
comma
DECL|enumerator|ESM_APU_PCM_CAPTURE
id|ESM_APU_PCM_CAPTURE
comma
DECL|enumerator|ESM_APU_PCM_RATECONV
id|ESM_APU_PCM_RATECONV
comma
DECL|enumerator|ESM_APU_FREE
id|ESM_APU_FREE
)brace
suffix:semicolon
multiline_comment|/* DMA Hack! */
DECL|struct|snd_esm_memory
r_struct
id|snd_esm_memory
(brace
DECL|member|buf
r_char
op_star
id|buf
suffix:semicolon
DECL|member|addr
r_int
r_int
id|addr
suffix:semicolon
DECL|member|size
r_int
id|size
suffix:semicolon
DECL|member|empty
r_int
id|empty
suffix:semicolon
multiline_comment|/* status */
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Playback Channel */
DECL|struct|snd_esschan
r_struct
id|snd_esschan
(brace
DECL|member|running
r_int
id|running
suffix:semicolon
DECL|member|apu
id|u8
id|apu
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|apu_mode
id|u8
id|apu_mode
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* playback/capture pcm buffer */
DECL|member|memory
id|esm_memory_t
op_star
id|memory
suffix:semicolon
multiline_comment|/* capture mixer buffer */
DECL|member|mixbuf
id|esm_memory_t
op_star
id|mixbuf
suffix:semicolon
DECL|member|hwptr
r_int
r_int
id|hwptr
suffix:semicolon
multiline_comment|/* current hw pointer in bytes */
DECL|member|count
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* sample counter in bytes */
DECL|member|dma_size
r_int
r_int
id|dma_size
suffix:semicolon
multiline_comment|/* total buffer size in bytes */
DECL|member|frag_size
r_int
r_int
id|frag_size
suffix:semicolon
multiline_comment|/* period size in bytes */
DECL|member|wav_shift
r_int
r_int
id|wav_shift
suffix:semicolon
DECL|member|base
id|u16
id|base
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* offset for ptr */
multiline_comment|/* stereo/16bit flag */
DECL|member|fmt
r_int
r_char
id|fmt
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
multiline_comment|/* playback / capture */
DECL|member|bob_freq
r_int
id|bob_freq
suffix:semicolon
multiline_comment|/* required timer frequency */
DECL|member|substream
id|snd_pcm_substream_t
op_star
id|substream
suffix:semicolon
multiline_comment|/* linked list */
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
macro_line|#ifdef CONFIG_PM
DECL|member|wc_map
id|u16
id|wc_map
(braket
l_int|4
)braket
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
DECL|struct|snd_es1968
r_struct
id|snd_es1968
(brace
multiline_comment|/* Module Config */
DECL|member|total_bufsize
r_int
id|total_bufsize
suffix:semicolon
multiline_comment|/* in bytes */
DECL|member|playback_streams
DECL|member|capture_streams
r_int
id|playback_streams
comma
id|capture_streams
suffix:semicolon
DECL|member|clock
r_int
r_int
id|clock
suffix:semicolon
multiline_comment|/* clock */
multiline_comment|/* buffer */
DECL|member|dma_buf
r_void
op_star
id|dma_buf
suffix:semicolon
DECL|member|dma_buf_addr
id|dma_addr_t
id|dma_buf_addr
suffix:semicolon
DECL|member|dma_buf_size
r_int
r_int
id|dma_buf_size
suffix:semicolon
multiline_comment|/* Resources... */
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|io_port
r_int
r_int
id|io_port
suffix:semicolon
DECL|member|res_io_port
r_struct
id|resource
op_star
id|res_io_port
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|pci
r_struct
id|pci_dev
op_star
id|pci
suffix:semicolon
DECL|member|card
id|snd_card_t
op_star
id|card
suffix:semicolon
DECL|member|pcm
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
multiline_comment|/* DMA memory block */
DECL|member|buf_list
r_struct
id|list_head
id|buf_list
suffix:semicolon
multiline_comment|/* ALSA Stuff */
DECL|member|ac97
id|ac97_t
op_star
id|ac97
suffix:semicolon
DECL|member|master_switch
id|snd_kcontrol_t
op_star
id|master_switch
suffix:semicolon
multiline_comment|/* for h/w volume control */
DECL|member|master_volume
id|snd_kcontrol_t
op_star
id|master_volume
suffix:semicolon
DECL|member|rmidi
id|snd_rawmidi_t
op_star
id|rmidi
suffix:semicolon
DECL|member|reg_lock
id|spinlock_t
id|reg_lock
suffix:semicolon
DECL|member|hwvol_tq
r_struct
id|tasklet_struct
id|hwvol_tq
suffix:semicolon
multiline_comment|/* Maestro Stuff */
DECL|member|maestro_map
id|u16
id|maestro_map
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|bobclient
id|atomic_t
id|bobclient
suffix:semicolon
multiline_comment|/* active timer instancs */
DECL|member|bob_freq
r_int
id|bob_freq
suffix:semicolon
multiline_comment|/* timer frequency */
DECL|member|bob_lock
id|spinlock_t
id|bob_lock
suffix:semicolon
DECL|member|memory_mutex
r_struct
id|semaphore
id|memory_mutex
suffix:semicolon
multiline_comment|/* memory lock */
multiline_comment|/* APU states */
DECL|member|apu
r_int
r_char
id|apu
(braket
id|NR_APUS
)braket
suffix:semicolon
multiline_comment|/* active substreams */
DECL|member|substream_list
r_struct
id|list_head
id|substream_list
suffix:semicolon
DECL|member|substream_lock
id|spinlock_t
id|substream_lock
suffix:semicolon
macro_line|#ifdef CONFIG_PM
DECL|member|apu_map
id|u16
id|apu_map
(braket
id|NR_APUS
)braket
(braket
id|NR_APU_REGS
)braket
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
r_static
r_void
id|snd_es1968_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|macro|CARD_TYPE_ESS_ESOLDM1
mdefine_line|#define CARD_TYPE_ESS_ESOLDM1&t;&t;0x12850100
DECL|macro|CARD_TYPE_ESS_ES1968
mdefine_line|#define CARD_TYPE_ESS_ES1968&t;&t;0x125d1968
DECL|macro|CARD_TYPE_ESS_ES1978
mdefine_line|#define CARD_TYPE_ESS_ES1978&t;&t;0x125d1978
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|snd_es1968_ids
(braket
)braket
id|__devinitdata
op_assign
(brace
multiline_comment|/* Maestro 1 */
(brace
l_int|0x1285
comma
l_int|0x0100
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_CLASS_MULTIMEDIA_AUDIO
op_lshift
l_int|8
comma
l_int|0xffff00
comma
l_int|0
comma
)brace
comma
multiline_comment|/* Maestro 2 */
(brace
l_int|0x125d
comma
l_int|0x1968
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_CLASS_MULTIMEDIA_AUDIO
op_lshift
l_int|8
comma
l_int|0xffff00
comma
l_int|0
comma
)brace
comma
multiline_comment|/* Maestro 2E */
(brace
l_int|0x125d
comma
l_int|0x1978
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_CLASS_MULTIMEDIA_AUDIO
op_lshift
l_int|8
comma
l_int|0xffff00
comma
l_int|0
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|snd_es1968_ids
)paren
suffix:semicolon
multiline_comment|/* *********************&n;   * Low Level Funcs!  *&n;   *********************/
multiline_comment|/* no spinlock */
DECL|function|__maestro_write
r_static
r_void
id|__maestro_write
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|reg
comma
id|u16
id|data
)paren
(brace
id|outw
c_func
(paren
id|reg
comma
id|chip-&gt;io_port
op_plus
id|ESM_INDEX
)paren
suffix:semicolon
id|outw
c_func
(paren
id|data
comma
id|chip-&gt;io_port
op_plus
id|ESM_DATA
)paren
suffix:semicolon
id|chip-&gt;maestro_map
(braket
id|reg
)braket
op_assign
id|data
suffix:semicolon
)brace
DECL|function|maestro_write
r_inline
r_static
r_void
id|maestro_write
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|reg
comma
id|u16
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|__maestro_write
c_func
(paren
id|chip
comma
id|reg
comma
id|data
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* no spinlock */
DECL|function|__maestro_read
r_static
id|u16
id|__maestro_read
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|reg
)paren
(brace
r_if
c_cond
(paren
id|READABLE_MAP
op_amp
(paren
l_int|1
op_lshift
id|reg
)paren
)paren
(brace
id|outw
c_func
(paren
id|reg
comma
id|chip-&gt;io_port
op_plus
id|ESM_INDEX
)paren
suffix:semicolon
id|chip-&gt;maestro_map
(braket
id|reg
)braket
op_assign
id|inw
c_func
(paren
id|chip-&gt;io_port
op_plus
id|ESM_DATA
)paren
suffix:semicolon
)brace
r_return
id|chip-&gt;maestro_map
(braket
id|reg
)braket
suffix:semicolon
)brace
DECL|function|maestro_read
r_inline
r_static
id|u16
id|maestro_read
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|result
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|result
op_assign
id|__maestro_read
c_func
(paren
id|chip
comma
id|reg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Wait for the codec bus to be free */
DECL|function|snd_es1968_ac97_wait
r_static
r_int
id|snd_es1968_ac97_wait
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
r_int
id|timeout
op_assign
l_int|100000
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|chip-&gt;io_port
op_plus
id|ESM_AC97_INDEX
)paren
op_amp
l_int|1
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|snd_printd
c_func
(paren
l_string|&quot;es1968: ac97 timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* timeout */
)brace
DECL|function|snd_es1968_ac97_write
r_static
r_void
id|snd_es1968_ac97_write
c_func
(paren
id|ac97_t
op_star
id|ac97
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|val
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|ac97-&gt;private_data
comma
r_return
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|snd_es1968_ac97_wait
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* Write the bus */
id|outw
c_func
(paren
id|val
comma
id|chip-&gt;io_port
op_plus
id|ESM_AC97_DATA
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|chip-&gt;io_port
op_plus
id|ESM_AC97_INDEX
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_ac97_read
r_static
r_int
r_int
id|snd_es1968_ac97_read
c_func
(paren
id|ac97_t
op_star
id|ac97
comma
r_int
r_int
id|reg
)paren
(brace
id|u16
id|data
op_assign
l_int|0
suffix:semicolon
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|ac97-&gt;private_data
comma
r_return
l_int|0
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|snd_es1968_ac97_wait
c_func
(paren
id|chip
)paren
suffix:semicolon
id|outb
c_func
(paren
id|reg
op_or
l_int|0x80
comma
id|chip-&gt;io_port
op_plus
id|ESM_AC97_INDEX
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|snd_es1968_ac97_wait
c_func
(paren
id|chip
)paren
)paren
(brace
id|data
op_assign
id|inw
c_func
(paren
id|chip-&gt;io_port
op_plus
id|ESM_AC97_DATA
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
multiline_comment|/* no spinlock */
DECL|function|apu_index_set
r_static
r_void
id|apu_index_set
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|index
)paren
(brace
r_int
id|i
suffix:semicolon
id|__maestro_write
c_func
(paren
id|chip
comma
id|IDR1_CRAM_POINTER
comma
id|index
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|__maestro_read
c_func
(paren
id|chip
comma
id|IDR1_CRAM_POINTER
)paren
op_eq
id|index
)paren
r_return
suffix:semicolon
id|snd_printd
c_func
(paren
l_string|&quot;es1968: APU register select failed. (Timeout)&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* no spinlock */
DECL|function|apu_data_set
r_static
r_void
id|apu_data_set
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|__maestro_read
c_func
(paren
id|chip
comma
id|IDR0_DATA_PORT
)paren
op_eq
id|data
)paren
r_return
suffix:semicolon
id|__maestro_write
c_func
(paren
id|chip
comma
id|IDR0_DATA_PORT
comma
id|data
)paren
suffix:semicolon
)brace
id|snd_printd
c_func
(paren
l_string|&quot;es1968: APU register set probably failed (Timeout)!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* no spinlock */
DECL|function|__apu_set_register
r_static
r_void
id|__apu_set_register
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|channel
comma
id|u8
id|reg
comma
id|u16
id|data
)paren
(brace
id|snd_assert
c_func
(paren
id|channel
OL
id|NR_APUS
comma
r_return
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PM
id|chip-&gt;apu_map
(braket
id|channel
)braket
(braket
id|reg
)braket
op_assign
id|data
suffix:semicolon
macro_line|#endif
id|reg
op_or_assign
(paren
id|channel
op_lshift
l_int|4
)paren
suffix:semicolon
id|apu_index_set
c_func
(paren
id|chip
comma
id|reg
)paren
suffix:semicolon
id|apu_data_set
c_func
(paren
id|chip
comma
id|data
)paren
suffix:semicolon
)brace
DECL|function|apu_set_register
r_inline
r_static
r_void
id|apu_set_register
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|channel
comma
id|u8
id|reg
comma
id|u16
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|__apu_set_register
c_func
(paren
id|chip
comma
id|channel
comma
id|reg
comma
id|data
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|__apu_get_register
r_static
id|u16
id|__apu_get_register
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|channel
comma
id|u8
id|reg
)paren
(brace
id|snd_assert
c_func
(paren
id|channel
OL
id|NR_APUS
comma
r_return
l_int|0
)paren
suffix:semicolon
id|reg
op_or_assign
(paren
id|channel
op_lshift
l_int|4
)paren
suffix:semicolon
id|apu_index_set
c_func
(paren
id|chip
comma
id|reg
)paren
suffix:semicolon
r_return
id|__maestro_read
c_func
(paren
id|chip
comma
id|IDR0_DATA_PORT
)paren
suffix:semicolon
)brace
DECL|function|apu_get_register
r_inline
r_static
id|u16
id|apu_get_register
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|channel
comma
id|u8
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|v
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|v
op_assign
id|__apu_get_register
c_func
(paren
id|chip
comma
id|channel
comma
id|reg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|v
suffix:semicolon
)brace
macro_line|#if 0 /* ASSP is not supported */
r_static
r_void
id|assp_set_register
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u32
id|reg
comma
id|u32
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|chip-&gt;io_port
op_plus
id|ASSP_INDEX
)paren
suffix:semicolon
id|outl
c_func
(paren
id|value
comma
id|chip-&gt;io_port
op_plus
id|ASSP_DATA
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
id|u32
id|assp_get_register
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u32
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|value
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|chip-&gt;io_port
op_plus
id|ASSP_INDEX
)paren
suffix:semicolon
id|value
op_assign
id|inl
c_func
(paren
id|chip-&gt;io_port
op_plus
id|ASSP_DATA
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
macro_line|#endif
DECL|function|wave_set_register
r_static
r_void
id|wave_set_register
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|reg
comma
id|u16
id|value
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
comma
id|chip-&gt;io_port
op_plus
id|WC_INDEX
)paren
suffix:semicolon
id|outw
c_func
(paren
id|value
comma
id|chip-&gt;io_port
op_plus
id|WC_DATA
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|wave_get_register
r_static
id|u16
id|wave_get_register
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u16
id|reg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|value
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outw
c_func
(paren
id|reg
comma
id|chip-&gt;io_port
op_plus
id|WC_INDEX
)paren
suffix:semicolon
id|value
op_assign
id|inw
c_func
(paren
id|chip-&gt;io_port
op_plus
id|WC_DATA
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|value
suffix:semicolon
)brace
multiline_comment|/* *******************&n;   * Bob the Timer!  *&n;   *******************/
DECL|function|snd_es1968_bob_stop
r_static
r_void
id|snd_es1968_bob_stop
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
id|u16
id|reg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|__maestro_read
c_func
(paren
id|chip
comma
l_int|0x11
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
id|ESM_BOB_ENABLE
suffix:semicolon
id|__maestro_write
c_func
(paren
id|chip
comma
l_int|0x11
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|__maestro_read
c_func
(paren
id|chip
comma
l_int|0x17
)paren
suffix:semicolon
id|reg
op_and_assign
op_complement
id|ESM_BOB_START
suffix:semicolon
id|__maestro_write
c_func
(paren
id|chip
comma
l_int|0x17
comma
id|reg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_bob_start
r_static
r_void
id|snd_es1968_bob_start
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
r_int
id|prescale
suffix:semicolon
r_int
id|divide
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* compute ideal interrupt frequency for buffer size &amp; play rate */
multiline_comment|/* first, find best prescaler value to match freq */
r_for
c_loop
(paren
id|prescale
op_assign
l_int|5
suffix:semicolon
id|prescale
OL
l_int|12
suffix:semicolon
id|prescale
op_increment
)paren
r_if
c_cond
(paren
id|chip-&gt;bob_freq
OG
(paren
id|ESS_SYSCLK
op_rshift
(paren
id|prescale
op_plus
l_int|9
)paren
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* next, back off prescaler whilst getting divider into optimum range */
id|divide
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|prescale
OG
l_int|5
)paren
op_logical_and
(paren
id|divide
OL
l_int|32
)paren
)paren
(brace
id|prescale
op_decrement
suffix:semicolon
id|divide
op_lshift_assign
l_int|1
suffix:semicolon
)brace
id|divide
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* now fine-tune the divider for best match */
r_for
c_loop
(paren
suffix:semicolon
id|divide
OL
l_int|31
suffix:semicolon
id|divide
op_increment
)paren
r_if
c_cond
(paren
id|chip-&gt;bob_freq
OG
(paren
(paren
id|ESS_SYSCLK
op_rshift
(paren
id|prescale
op_plus
l_int|9
)paren
)paren
op_div
(paren
id|divide
op_plus
l_int|1
)paren
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* divide = 0 is illegal, but don&squot;t let prescale = 4! */
r_if
c_cond
(paren
id|divide
op_eq
l_int|0
)paren
(brace
id|divide
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|prescale
OG
l_int|5
)paren
id|prescale
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|divide
OG
l_int|1
)paren
id|divide
op_decrement
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|__maestro_write
c_func
(paren
id|chip
comma
l_int|6
comma
l_int|0x9000
op_or
(paren
id|prescale
op_lshift
l_int|5
)paren
op_or
id|divide
)paren
suffix:semicolon
multiline_comment|/* set reg */
multiline_comment|/* Now set IDR 11/17 */
id|__maestro_write
c_func
(paren
id|chip
comma
l_int|0x11
comma
id|__maestro_read
c_func
(paren
id|chip
comma
l_int|0x11
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|__maestro_write
c_func
(paren
id|chip
comma
l_int|0x17
comma
id|__maestro_read
c_func
(paren
id|chip
comma
l_int|0x17
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_bob_inc
r_static
r_void
id|snd_es1968_bob_inc
c_func
(paren
id|es1968_t
op_star
id|chip
comma
r_int
id|freq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;bob_lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|chip-&gt;bobclient
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chip-&gt;bobclient
)paren
op_eq
l_int|1
)paren
(brace
id|chip-&gt;bob_freq
op_assign
id|freq
suffix:semicolon
id|snd_es1968_bob_start
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chip-&gt;bob_freq
OL
id|freq
)paren
(brace
id|snd_es1968_bob_stop
c_func
(paren
id|chip
)paren
suffix:semicolon
id|chip-&gt;bob_freq
op_assign
id|freq
suffix:semicolon
id|snd_es1968_bob_start
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;bob_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_bob_dec
r_static
r_void
id|snd_es1968_bob_dec
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;bob_lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|chip-&gt;bobclient
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chip-&gt;bobclient
)paren
op_le
l_int|0
)paren
id|snd_es1968_bob_stop
c_func
(paren
id|chip
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|chip-&gt;bob_freq
OG
id|ESM_BOB_FREQ
)paren
(brace
multiline_comment|/* check reduction of timer frequency */
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_int
id|max_freq
op_assign
id|ESM_BOB_FREQ
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;substream_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|chip-&gt;substream_list
)paren
(brace
id|esschan_t
op_star
id|es
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|esschan_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_freq
OL
id|es-&gt;bob_freq
)paren
id|max_freq
op_assign
id|es-&gt;bob_freq
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;substream_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_freq
op_ne
id|chip-&gt;bob_freq
)paren
(brace
id|snd_es1968_bob_stop
c_func
(paren
id|chip
)paren
suffix:semicolon
id|chip-&gt;bob_freq
op_assign
id|max_freq
suffix:semicolon
id|snd_es1968_bob_start
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;bob_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|snd_es1968_calc_bob_rate
id|snd_es1968_calc_bob_rate
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esschan_t
op_star
id|es
comma
id|snd_pcm_runtime_t
op_star
id|runtime
)paren
(brace
multiline_comment|/* we acquire 4 interrupts per period for precise control.. */
r_int
id|freq
op_assign
id|runtime-&gt;rate
op_star
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
id|freq
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_16BIT
)paren
id|freq
op_lshift_assign
l_int|1
suffix:semicolon
id|freq
op_div_assign
id|es-&gt;frag_size
suffix:semicolon
r_if
c_cond
(paren
id|freq
OL
id|ESM_BOB_FREQ
)paren
id|freq
op_assign
id|ESM_BOB_FREQ
suffix:semicolon
r_else
r_if
c_cond
(paren
id|freq
OG
id|ESM_BOB_FREQ_MAX
)paren
id|freq
op_assign
id|ESM_BOB_FREQ_MAX
suffix:semicolon
r_return
id|freq
suffix:semicolon
)brace
multiline_comment|/*************&n; *  PCM Part *&n; *************/
DECL|function|snd_es1968_compute_rate
r_static
id|u32
id|snd_es1968_compute_rate
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|u32
id|freq
)paren
(brace
id|u32
id|rate
op_assign
(paren
id|freq
op_lshift
l_int|16
)paren
op_div
id|chip-&gt;clock
suffix:semicolon
macro_line|#if 0 /* XXX: do we need this? */ 
r_if
c_cond
(paren
id|rate
OG
l_int|0x10000
)paren
id|rate
op_assign
l_int|0x10000
suffix:semicolon
macro_line|#endif
r_return
id|rate
suffix:semicolon
)brace
multiline_comment|/* get current pointer */
r_inline
r_static
r_int
r_int
DECL|function|snd_es1968_get_dma_ptr
id|snd_es1968_get_dma_ptr
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esschan_t
op_star
id|es
)paren
(brace
r_int
r_int
id|offset
suffix:semicolon
id|offset
op_assign
id|apu_get_register
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|0
)braket
comma
l_int|5
)paren
suffix:semicolon
id|offset
op_sub_assign
id|es-&gt;base
(braket
l_int|0
)braket
suffix:semicolon
r_return
(paren
id|offset
op_amp
l_int|0xFFFE
)paren
suffix:semicolon
multiline_comment|/* hardware is in words */
)brace
DECL|function|snd_es1968_apu_set_freq
r_static
r_void
id|snd_es1968_apu_set_freq
c_func
(paren
id|es1968_t
op_star
id|chip
comma
r_int
id|apu
comma
r_int
id|freq
)paren
(brace
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|2
comma
(paren
id|apu_get_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|2
)paren
op_amp
l_int|0x00FF
)paren
op_or
(paren
(paren
id|freq
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
op_or
l_int|0x10
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|3
comma
id|freq
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* spin lock held */
DECL|function|snd_es1968_trigger_apu
r_inline
r_static
r_void
id|snd_es1968_trigger_apu
c_func
(paren
id|es1968_t
op_star
id|esm
comma
r_int
id|apu
comma
r_int
id|mode
)paren
(brace
multiline_comment|/* dma on, no envelopes, filter to all 1s) */
id|__apu_set_register
c_func
(paren
id|esm
comma
id|apu
comma
l_int|0
comma
l_int|0x400f
op_or
id|mode
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_pcm_start
r_static
r_void
id|snd_es1968_pcm_start
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esschan_t
op_star
id|es
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;running
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|__apu_set_register
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|0
)braket
comma
l_int|5
comma
id|es-&gt;base
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|0
)braket
comma
id|es-&gt;apu_mode
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;mode
op_eq
id|ESM_MODE_CAPTURE
)paren
(brace
id|__apu_set_register
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|2
)braket
comma
l_int|5
comma
id|es-&gt;base
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|2
)braket
comma
id|es-&gt;apu_mode
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
(brace
id|__apu_set_register
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|1
)braket
comma
l_int|5
comma
id|es-&gt;base
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|1
)braket
comma
id|es-&gt;apu_mode
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;mode
op_eq
id|ESM_MODE_CAPTURE
)paren
(brace
id|__apu_set_register
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|3
)braket
comma
l_int|5
comma
id|es-&gt;base
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|3
)braket
comma
id|es-&gt;apu_mode
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
id|es-&gt;running
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_pcm_stop
r_static
r_void
id|snd_es1968_pcm_stop
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esschan_t
op_star
id|es
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|es-&gt;running
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|1
)braket
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;mode
op_eq
id|ESM_MODE_CAPTURE
)paren
(brace
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|2
)braket
comma
l_int|0
)paren
suffix:semicolon
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|3
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|es-&gt;running
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* set the wavecache control reg */
DECL|function|snd_es1968_program_wavecache
r_static
r_void
id|snd_es1968_program_wavecache
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esschan_t
op_star
id|es
comma
r_int
id|channel
comma
id|u32
id|addr
comma
r_int
id|capture
)paren
(brace
id|u32
id|tmpval
op_assign
(paren
id|addr
op_minus
l_int|0x10
)paren
op_amp
l_int|0xFFF8
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capture
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_16BIT
)paren
)paren
id|tmpval
op_or_assign
l_int|4
suffix:semicolon
multiline_comment|/* 8bit */
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
id|tmpval
op_or_assign
l_int|2
suffix:semicolon
multiline_comment|/* stereo */
)brace
multiline_comment|/* set the wavecache control reg */
id|wave_set_register
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
id|channel
)braket
op_lshift
l_int|3
comma
id|tmpval
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PM
id|es-&gt;wc_map
(braket
id|channel
)braket
op_assign
id|tmpval
suffix:semicolon
macro_line|#endif
)brace
DECL|function|snd_es1968_playback_setup
r_static
r_void
id|snd_es1968_playback_setup
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esschan_t
op_star
id|es
comma
id|snd_pcm_runtime_t
op_star
id|runtime
)paren
(brace
id|u32
id|pa
suffix:semicolon
r_int
id|high_apu
op_assign
l_int|0
suffix:semicolon
r_int
id|channel
comma
id|apu
suffix:semicolon
r_int
id|i
comma
id|size
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|freq
suffix:semicolon
id|size
op_assign
id|es-&gt;dma_size
op_rshift
id|es-&gt;wav_shift
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
id|high_apu
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
op_le
id|high_apu
suffix:semicolon
id|channel
op_increment
)paren
(brace
id|apu
op_assign
id|es-&gt;apu
(braket
id|channel
)braket
suffix:semicolon
id|snd_es1968_program_wavecache
c_func
(paren
id|chip
comma
id|es
comma
id|channel
comma
id|es-&gt;memory-&gt;addr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Offset to PCMBAR */
id|pa
op_assign
id|es-&gt;memory-&gt;addr
suffix:semicolon
id|pa
op_sub_assign
id|chip-&gt;dma_buf_addr
suffix:semicolon
id|pa
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* words */
id|pa
op_or_assign
l_int|0x00400000
suffix:semicolon
multiline_comment|/* System RAM (Bit 22) */
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
(brace
multiline_comment|/* Enable stereo */
r_if
c_cond
(paren
id|channel
)paren
id|pa
op_or_assign
l_int|0x00800000
suffix:semicolon
multiline_comment|/* (Bit 23) */
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_16BIT
)paren
id|pa
op_rshift_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* base offset of dma calcs when reading the pointer&n;&t;&t;   on this left one */
id|es-&gt;base
(braket
id|channel
)braket
op_assign
id|pa
op_amp
l_int|0xFFFF
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
id|i
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* Load the buffer into the wave engine */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|4
comma
(paren
(paren
id|pa
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|5
comma
id|pa
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|6
comma
(paren
id|pa
op_plus
id|size
)paren
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
multiline_comment|/* setting loop == sample len */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|7
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* clear effects/env.. */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|8
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* set amp now to 0xd0 (?), low byte is &squot;amplitude dest&squot;? */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|9
comma
l_int|0xD000
)paren
suffix:semicolon
multiline_comment|/* clear routing stuff */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|11
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* dma on, no envelopes, filter to all 1s) */
singleline_comment|// apu_set_register(chip, apu, 0, 0x400F);
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_16BIT
)paren
id|es-&gt;apu_mode
(braket
id|channel
)braket
op_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* 16bit mono */
r_else
id|es-&gt;apu_mode
(braket
id|channel
)braket
op_assign
l_int|0x30
suffix:semicolon
multiline_comment|/* 8bit mono */
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
(brace
multiline_comment|/* set panning: left or right */
multiline_comment|/* Check: different panning. On my Canyon 3D Chipset the&n;&t;&t;&t;   Channels are swapped. I don&squot;t know, about the output&n;&t;&t;&t;   to the SPDif Link. Perhaps you have to change this&n;&t;&t;&t;   and not the APU Regs 4-5. */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|10
comma
l_int|0x8F00
op_or
(paren
id|channel
ques
c_cond
l_int|0
suffix:colon
l_int|0x10
)paren
)paren
suffix:semicolon
id|es-&gt;apu_mode
(braket
id|channel
)braket
op_add_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* stereo */
)brace
r_else
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|10
comma
l_int|0x8F08
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* clear WP interupts */
id|outw
c_func
(paren
l_int|1
comma
id|chip-&gt;io_port
op_plus
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* enable WP ints */
id|outw
c_func
(paren
id|inw
c_func
(paren
id|chip-&gt;io_port
op_plus
l_int|0x18
)paren
op_or
l_int|4
comma
id|chip-&gt;io_port
op_plus
l_int|0x18
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|freq
op_assign
id|runtime-&gt;rate
suffix:semicolon
multiline_comment|/* set frequency */
r_if
c_cond
(paren
id|freq
OG
l_int|48000
)paren
id|freq
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|freq
OL
l_int|4000
)paren
id|freq
op_assign
l_int|4000
suffix:semicolon
multiline_comment|/* hmmm.. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_16BIT
)paren
op_logical_and
op_logical_neg
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
)paren
id|freq
op_rshift_assign
l_int|1
suffix:semicolon
id|freq
op_assign
id|snd_es1968_compute_rate
c_func
(paren
id|chip
comma
id|freq
)paren
suffix:semicolon
multiline_comment|/* Load the frequency, turn on 6dB */
id|snd_es1968_apu_set_freq
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|0
)braket
comma
id|freq
)paren
suffix:semicolon
id|snd_es1968_apu_set_freq
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|1
)braket
comma
id|freq
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_capture_setup
r_static
r_void
id|snd_es1968_capture_setup
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esschan_t
op_star
id|es
comma
id|snd_pcm_runtime_t
op_star
id|runtime
)paren
(brace
r_int
id|apu_step
op_assign
l_int|2
suffix:semicolon
r_int
id|channel
comma
id|apu
suffix:semicolon
r_int
id|i
comma
id|size
suffix:semicolon
id|u32
id|freq
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|size
op_assign
id|es-&gt;dma_size
op_rshift
id|es-&gt;wav_shift
suffix:semicolon
multiline_comment|/* we&squot;re given the full size of the buffer, but&n;&t;   in stereo each channel will only use its half */
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
id|apu_step
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* APU assignments:&n;&t;   0 = mono/left SRC&n;&t;   1 = right SRC&n;&t;   2 = mono/left Input Mixer&n;&t;   3 = right Input Mixer */
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
OL
l_int|4
suffix:semicolon
id|channel
op_add_assign
id|apu_step
)paren
(brace
r_int
id|bsize
comma
id|route
suffix:semicolon
id|u32
id|pa
suffix:semicolon
id|apu
op_assign
id|es-&gt;apu
(braket
id|channel
)braket
suffix:semicolon
multiline_comment|/* data seems to flow from the codec, through an apu into&n;&t;&t;   the &squot;mixbuf&squot; bit of page, then through the SRC apu&n;&t;&t;   and out to the real &squot;buffer&squot;.  ok.  sure.  */
r_if
c_cond
(paren
id|channel
op_amp
l_int|2
)paren
(brace
multiline_comment|/* ok, we&squot;re an input mixer going from adc&n;&t;&t;&t;   through the mixbuf to the other apus */
r_if
c_cond
(paren
op_logical_neg
(paren
id|channel
op_amp
l_int|0x01
)paren
)paren
(brace
id|pa
op_assign
id|es-&gt;mixbuf-&gt;addr
suffix:semicolon
)brace
r_else
(brace
id|pa
op_assign
id|es-&gt;mixbuf-&gt;addr
op_plus
id|ESM_MIXBUF_SIZE
op_div
l_int|2
suffix:semicolon
)brace
multiline_comment|/* we source from a &squot;magic&squot; apu */
id|bsize
op_assign
id|ESM_MIXBUF_SIZE
op_div
l_int|4
suffix:semicolon
multiline_comment|/* half of this channels alloc, in words */
multiline_comment|/* parallel in crap, see maestro reg 0xC [8-11] */
id|route
op_assign
l_int|0x14
op_plus
id|channel
op_minus
l_int|2
suffix:semicolon
id|es-&gt;apu_mode
(braket
id|channel
)braket
op_assign
l_int|0x90
suffix:semicolon
multiline_comment|/* Input Mixer */
)brace
r_else
(brace
multiline_comment|/* we&squot;re a rate converter taking&n;&t;&t;&t;   input from the input apus and outputing it to&n;&t;&t;&t;   system memory */
r_if
c_cond
(paren
op_logical_neg
(paren
id|channel
op_amp
l_int|0x01
)paren
)paren
id|pa
op_assign
id|es-&gt;memory-&gt;addr
suffix:semicolon
r_else
id|pa
op_assign
id|es-&gt;memory-&gt;addr
op_plus
id|size
op_star
l_int|2
suffix:semicolon
multiline_comment|/* size is in word */
id|es-&gt;apu_mode
(braket
id|channel
)braket
op_assign
l_int|0xB0
suffix:semicolon
multiline_comment|/* Sample Rate Converter */
id|bsize
op_assign
id|size
suffix:semicolon
multiline_comment|/* get input from inputing apu */
id|route
op_assign
id|es-&gt;apu
(braket
id|channel
op_plus
l_int|2
)braket
suffix:semicolon
)brace
multiline_comment|/* set the wavecache control reg */
id|snd_es1968_program_wavecache
c_func
(paren
id|chip
comma
id|es
comma
id|channel
comma
id|pa
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Offset to PCMBAR */
id|pa
op_sub_assign
id|chip-&gt;dma_buf_addr
suffix:semicolon
id|pa
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* words */
multiline_comment|/* base offset of dma calcs when reading the pointer&n;&t;&t;   on this left one */
id|es-&gt;base
(braket
id|channel
)braket
op_assign
id|pa
op_amp
l_int|0xFFFF
suffix:semicolon
id|pa
op_or_assign
l_int|0x00400000
suffix:semicolon
multiline_comment|/* bit 22 -&gt; System RAM */
multiline_comment|/* Begin loading the APU */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
id|i
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* need to enable subgroups.. and we should probably&n;&t;&t;   have different groups for different /dev/dsps..  */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|2
comma
l_int|0x8
)paren
suffix:semicolon
multiline_comment|/* Load the buffer into the wave engine */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|4
comma
(paren
(paren
id|pa
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* XXX reg is little endian.. */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|5
comma
id|pa
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|6
comma
(paren
id|pa
op_plus
id|bsize
)paren
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|7
comma
id|bsize
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_STEREO
)paren
multiline_comment|/* ??? really ??? */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|7
comma
id|bsize
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* clear effects/env.. */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|8
comma
l_int|0x00F0
)paren
suffix:semicolon
multiline_comment|/* amplitude now?  sure.  why not.  */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|9
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* set filter tune, radius, polar pan */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|10
comma
l_int|0x8F08
)paren
suffix:semicolon
multiline_comment|/* route input */
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|11
comma
id|route
)paren
suffix:semicolon
multiline_comment|/* dma on, no envelopes, filter to all 1s) */
singleline_comment|// apu_set_register(chip, apu, 0, 0x400F);
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* clear WP interupts */
id|outw
c_func
(paren
l_int|1
comma
id|chip-&gt;io_port
op_plus
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* enable WP ints */
id|outw
c_func
(paren
id|inw
c_func
(paren
id|chip-&gt;io_port
op_plus
l_int|0x18
)paren
op_or
l_int|4
comma
id|chip-&gt;io_port
op_plus
l_int|0x18
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|freq
op_assign
id|runtime-&gt;rate
suffix:semicolon
multiline_comment|/* Sample Rate conversion APUs don&squot;t like 0x10000 for their rate */
r_if
c_cond
(paren
id|freq
OG
l_int|47999
)paren
id|freq
op_assign
l_int|47999
suffix:semicolon
r_if
c_cond
(paren
id|freq
OL
l_int|4000
)paren
id|freq
op_assign
l_int|4000
suffix:semicolon
id|freq
op_assign
id|snd_es1968_compute_rate
c_func
(paren
id|chip
comma
id|freq
)paren
suffix:semicolon
multiline_comment|/* Load the frequency, turn on 6dB */
id|snd_es1968_apu_set_freq
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|0
)braket
comma
id|freq
)paren
suffix:semicolon
id|snd_es1968_apu_set_freq
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|1
)braket
comma
id|freq
)paren
suffix:semicolon
multiline_comment|/* fix mixer rate at 48khz.  and its _must_ be 0x10000. */
id|freq
op_assign
l_int|0x10000
suffix:semicolon
id|snd_es1968_apu_set_freq
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|2
)braket
comma
id|freq
)paren
suffix:semicolon
id|snd_es1968_apu_set_freq
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|3
)braket
comma
id|freq
)paren
suffix:semicolon
)brace
multiline_comment|/*******************&n; *  ALSA Interface *&n; *******************/
DECL|function|snd_es1968_pcm_prepare
r_static
r_int
id|snd_es1968_pcm_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|esschan_t
op_star
id|es
op_assign
id|snd_magic_cast
c_func
(paren
id|esschan_t
comma
id|runtime-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|es-&gt;dma_size
op_assign
id|snd_pcm_lib_buffer_bytes
c_func
(paren
id|substream
)paren
suffix:semicolon
id|es-&gt;frag_size
op_assign
id|snd_pcm_lib_period_bytes
c_func
(paren
id|substream
)paren
suffix:semicolon
id|es-&gt;wav_shift
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* maestro handles always 16bit */
id|es-&gt;fmt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|snd_pcm_format_width
c_func
(paren
id|runtime-&gt;format
)paren
op_eq
l_int|16
)paren
id|es-&gt;fmt
op_or_assign
id|ESS_FMT_16BIT
suffix:semicolon
r_if
c_cond
(paren
id|runtime-&gt;channels
OG
l_int|1
)paren
(brace
id|es-&gt;fmt
op_or_assign
id|ESS_FMT_STEREO
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;fmt
op_amp
id|ESS_FMT_16BIT
)paren
multiline_comment|/* 8bit is already word shifted */
id|es-&gt;wav_shift
op_increment
suffix:semicolon
)brace
id|es-&gt;bob_freq
op_assign
id|snd_es1968_calc_bob_rate
c_func
(paren
id|chip
comma
id|es
comma
id|runtime
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|es-&gt;mode
)paren
(brace
r_case
id|ESM_MODE_PLAY
suffix:colon
id|snd_es1968_playback_setup
c_func
(paren
id|chip
comma
id|es
comma
id|runtime
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ESM_MODE_CAPTURE
suffix:colon
id|snd_es1968_capture_setup
c_func
(paren
id|chip
comma
id|es
comma
id|runtime
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_pcm_trigger
r_static
r_int
id|snd_es1968_pcm_trigger
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
r_int
id|cmd
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|esschan_t
op_star
id|es
op_assign
id|snd_magic_cast
c_func
(paren
id|esschan_t
comma
id|substream-&gt;runtime-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_PCM_TRIGGER_START
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_RESUME
suffix:colon
r_if
c_cond
(paren
id|es-&gt;running
)paren
r_return
l_int|0
suffix:semicolon
id|snd_es1968_bob_inc
c_func
(paren
id|chip
comma
id|es-&gt;bob_freq
)paren
suffix:semicolon
id|es-&gt;count
op_assign
l_int|0
suffix:semicolon
id|es-&gt;hwptr
op_assign
l_int|0
suffix:semicolon
id|snd_es1968_pcm_start
c_func
(paren
id|chip
comma
id|es
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;substream_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|es-&gt;list
comma
op_amp
id|chip-&gt;substream_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;substream_lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_STOP
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_SUSPEND
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|es-&gt;running
)paren
r_return
l_int|0
suffix:semicolon
id|snd_es1968_pcm_stop
c_func
(paren
id|chip
comma
id|es
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;substream_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|es-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;substream_lock
comma
id|flags
)paren
suffix:semicolon
id|snd_es1968_bob_dec
c_func
(paren
id|chip
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_pcm_pointer
r_static
id|snd_pcm_uframes_t
id|snd_es1968_pcm_pointer
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|esschan_t
op_star
id|es
op_assign
id|snd_magic_cast
c_func
(paren
id|esschan_t
comma
id|substream-&gt;runtime-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_int
r_int
id|ptr
suffix:semicolon
id|ptr
op_assign
id|snd_es1968_get_dma_ptr
c_func
(paren
id|chip
comma
id|es
)paren
op_lshift
id|es-&gt;wav_shift
suffix:semicolon
r_return
id|bytes_to_frames
c_func
(paren
id|substream-&gt;runtime
comma
id|ptr
op_mod
id|es-&gt;dma_size
)paren
suffix:semicolon
)brace
DECL|variable|snd_es1968_playback
r_static
id|snd_pcm_hardware_t
id|snd_es1968_playback
op_assign
(brace
id|info
suffix:colon
(paren
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_BLOCK_TRANSFER
op_or
multiline_comment|/*SNDRV_PCM_INFO_PAUSE |*/
id|SNDRV_PCM_INFO_RESUME
)paren
comma
id|formats
suffix:colon
id|SNDRV_PCM_FMTBIT_U8
op_or
id|SNDRV_PCM_FMTBIT_S16_LE
comma
id|rates
suffix:colon
id|SNDRV_PCM_RATE_CONTINUOUS
op_or
id|SNDRV_PCM_RATE_8000_48000
comma
id|rate_min
suffix:colon
l_int|4000
comma
id|rate_max
suffix:colon
l_int|48000
comma
id|channels_min
suffix:colon
l_int|1
comma
id|channels_max
suffix:colon
l_int|2
comma
id|buffer_bytes_max
suffix:colon
l_int|65536
comma
id|period_bytes_min
suffix:colon
l_int|256
comma
id|period_bytes_max
suffix:colon
l_int|65536
comma
id|periods_min
suffix:colon
l_int|1
comma
id|periods_max
suffix:colon
l_int|1024
comma
id|fifo_size
suffix:colon
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|snd_es1968_capture
r_static
id|snd_pcm_hardware_t
id|snd_es1968_capture
op_assign
(brace
id|info
suffix:colon
(paren
id|SNDRV_PCM_INFO_NONINTERLEAVED
op_or
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_BLOCK_TRANSFER
op_or
multiline_comment|/*SNDRV_PCM_INFO_PAUSE |*/
id|SNDRV_PCM_INFO_RESUME
)paren
comma
id|formats
suffix:colon
multiline_comment|/*SNDRV_PCM_FMTBIT_U8 |*/
id|SNDRV_PCM_FMTBIT_S16_LE
comma
id|rates
suffix:colon
id|SNDRV_PCM_RATE_CONTINUOUS
op_or
id|SNDRV_PCM_RATE_8000_48000
comma
id|rate_min
suffix:colon
l_int|4000
comma
id|rate_max
suffix:colon
l_int|48000
comma
id|channels_min
suffix:colon
l_int|1
comma
id|channels_max
suffix:colon
l_int|2
comma
id|buffer_bytes_max
suffix:colon
l_int|65536
comma
id|period_bytes_min
suffix:colon
l_int|256
comma
id|period_bytes_max
suffix:colon
l_int|65536
comma
id|periods_min
suffix:colon
l_int|1
comma
id|periods_max
suffix:colon
l_int|1024
comma
id|fifo_size
suffix:colon
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* *************************&n;   * DMA memory management *&n;   *************************/
multiline_comment|/* Because the Maestro can only take adresses relative to the PCM base adress&n;   register :( */
DECL|function|calc_available_memory_size
r_static
r_int
id|calc_available_memory_size
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_int
id|max_size
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|chip-&gt;memory_mutex
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|chip-&gt;buf_list
)paren
(brace
id|esm_memory_t
op_star
id|buf
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|esm_memory_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;empty
op_logical_and
id|buf-&gt;size
OG
id|max_size
)paren
id|max_size
op_assign
id|buf-&gt;size
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|chip-&gt;memory_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_size
op_ge
l_int|128
op_star
l_int|1024
)paren
id|max_size
op_assign
l_int|127
op_star
l_int|1024
suffix:semicolon
r_return
id|max_size
suffix:semicolon
)brace
multiline_comment|/* allocate a new memory chunk with the specified size */
DECL|function|snd_es1968_new_memory
r_static
id|esm_memory_t
op_star
id|snd_es1968_new_memory
c_func
(paren
id|es1968_t
op_star
id|chip
comma
r_int
id|size
)paren
(brace
id|esm_memory_t
op_star
id|buf
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|down
c_func
(paren
op_amp
id|chip-&gt;memory_mutex
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|chip-&gt;buf_list
)paren
(brace
id|buf
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|esm_memory_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;empty
op_logical_and
id|buf-&gt;size
op_ge
id|size
)paren
r_goto
id|__found
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|chip-&gt;memory_mutex
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
id|__found
suffix:colon
r_if
c_cond
(paren
id|buf-&gt;size
OG
id|size
)paren
(brace
id|esm_memory_t
op_star
id|chunk
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|chunk
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chunk
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|chunk-&gt;size
op_assign
id|buf-&gt;size
op_minus
id|size
suffix:semicolon
id|chunk-&gt;buf
op_assign
id|buf-&gt;buf
op_plus
id|size
suffix:semicolon
id|chunk-&gt;addr
op_assign
id|buf-&gt;addr
op_plus
id|size
suffix:semicolon
id|chunk-&gt;empty
op_assign
l_int|1
suffix:semicolon
id|buf-&gt;size
op_assign
id|size
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|chunk-&gt;list
comma
op_amp
id|buf-&gt;list
)paren
suffix:semicolon
)brace
id|buf-&gt;empty
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;memory_mutex
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
multiline_comment|/* free a memory chunk */
DECL|function|snd_es1968_free_memory
r_static
r_void
id|snd_es1968_free_memory
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esm_memory_t
op_star
id|buf
)paren
(brace
id|esm_memory_t
op_star
id|chunk
suffix:semicolon
id|down
c_func
(paren
op_amp
id|chip-&gt;memory_mutex
)paren
suffix:semicolon
id|buf-&gt;empty
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;list.prev
op_ne
op_amp
id|chip-&gt;buf_list
)paren
(brace
id|chunk
op_assign
id|list_entry
c_func
(paren
id|buf-&gt;list.prev
comma
id|esm_memory_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chunk-&gt;empty
)paren
(brace
id|chunk-&gt;size
op_add_assign
id|buf-&gt;size
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|buf-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
id|buf
op_assign
id|chunk
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|buf-&gt;list.next
op_ne
op_amp
id|chip-&gt;buf_list
)paren
(brace
id|chunk
op_assign
id|list_entry
c_func
(paren
id|buf-&gt;list.next
comma
id|esm_memory_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chunk-&gt;empty
)paren
(brace
id|buf-&gt;size
op_add_assign
id|chunk-&gt;size
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|chunk-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chunk
)paren
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|chip-&gt;memory_mutex
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_free_dmabuf
r_static
r_void
id|snd_es1968_free_dmabuf
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;dma_buf
)paren
r_return
suffix:semicolon
id|snd_free_pci_pages
c_func
(paren
id|chip-&gt;pci
comma
id|chip-&gt;dma_buf_size
comma
id|chip-&gt;dma_buf
comma
id|chip-&gt;dma_buf_addr
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|chip-&gt;buf_list.next
)paren
op_ne
op_amp
id|chip-&gt;buf_list
)paren
(brace
id|esm_memory_t
op_star
id|chunk
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|esm_memory_t
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|p
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chunk
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
id|__devinit
DECL|function|snd_es1968_init_dmabuf
id|snd_es1968_init_dmabuf
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
id|esm_memory_t
op_star
id|chunk
suffix:semicolon
id|chip-&gt;dma_buf
op_assign
id|snd_malloc_pci_pages_fallback
c_func
(paren
id|chip-&gt;pci
comma
id|chip-&gt;total_bufsize
comma
op_amp
id|chip-&gt;dma_buf_addr
comma
op_amp
id|chip-&gt;dma_buf_size
)paren
suffix:semicolon
singleline_comment|//snd_printd(&quot;es1968: allocated buffer size %ld at %p&bslash;n&quot;, chip-&gt;dma_buf_size, chip-&gt;dma_buf);
r_if
c_cond
(paren
id|chip-&gt;dma_buf
op_eq
l_int|NULL
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;es1968: can&squot;t allocate dma pages for size %d&bslash;n&quot;
comma
id|chip-&gt;total_bufsize
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|chip-&gt;dma_buf_addr
op_plus
id|chip-&gt;dma_buf_size
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
(paren
l_int|1
op_lshift
l_int|28
)paren
op_minus
l_int|1
)paren
)paren
(brace
id|snd_es1968_free_dmabuf
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_printk
c_func
(paren
l_string|&quot;es1968: DMA buffer beyond 256MB.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|chip-&gt;buf_list
)paren
suffix:semicolon
multiline_comment|/* allocate an empty chunk */
id|chunk
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|chunk
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chunk
op_eq
l_int|NULL
)paren
(brace
id|snd_es1968_free_dmabuf
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|chip-&gt;dma_buf
comma
l_int|0
comma
l_int|512
)paren
suffix:semicolon
id|chunk-&gt;buf
op_assign
id|chip-&gt;dma_buf
op_plus
l_int|512
suffix:semicolon
id|chunk-&gt;addr
op_assign
id|chip-&gt;dma_buf_addr
op_plus
l_int|512
suffix:semicolon
id|chunk-&gt;size
op_assign
id|chip-&gt;dma_buf_size
op_minus
l_int|512
suffix:semicolon
id|chunk-&gt;empty
op_assign
l_int|1
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|chunk-&gt;list
comma
op_amp
id|chip-&gt;buf_list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* setup the dma_areas */
multiline_comment|/* buffer is extracted from the pre-allocated memory chunk */
DECL|function|snd_es1968_hw_params
r_static
r_int
id|snd_es1968_hw_params
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
id|snd_pcm_hw_params_t
op_star
id|hw_params
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|esschan_t
op_star
id|chan
op_assign
id|snd_magic_cast
c_func
(paren
id|esschan_t
comma
id|runtime-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_int
id|size
op_assign
id|params_buffer_bytes
c_func
(paren
id|hw_params
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;memory
)paren
(brace
r_if
c_cond
(paren
id|chan-&gt;memory-&gt;size
op_ge
id|size
)paren
(brace
id|runtime-&gt;dma_bytes
op_assign
id|size
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|snd_es1968_free_memory
c_func
(paren
id|chip
comma
id|chan-&gt;memory
)paren
suffix:semicolon
)brace
id|chan-&gt;memory
op_assign
id|snd_es1968_new_memory
c_func
(paren
id|chip
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;memory
op_eq
l_int|NULL
)paren
(brace
singleline_comment|// snd_printd(&quot;cannot allocate dma buffer: size = %d&bslash;n&quot;, size);
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|runtime-&gt;dma_bytes
op_assign
id|size
suffix:semicolon
id|runtime-&gt;dma_area
op_assign
id|chan-&gt;memory-&gt;buf
suffix:semicolon
id|runtime-&gt;dma_addr
op_assign
id|chan-&gt;memory-&gt;addr
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* area was changed */
)brace
multiline_comment|/* remove dma areas if allocated */
DECL|function|snd_es1968_hw_free
r_static
r_int
id|snd_es1968_hw_free
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|esschan_t
op_star
id|chan
suffix:semicolon
r_if
c_cond
(paren
id|runtime-&gt;private_data
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|chan
op_assign
id|snd_magic_cast
c_func
(paren
id|esschan_t
comma
id|runtime-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;memory
)paren
(brace
id|snd_es1968_free_memory
c_func
(paren
id|chip
comma
id|chan-&gt;memory
)paren
suffix:semicolon
id|chan-&gt;memory
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * allocate APU pair&n; */
DECL|function|snd_es1968_alloc_apu_pair
r_static
r_int
id|snd_es1968_alloc_apu_pair
c_func
(paren
id|es1968_t
op_star
id|chip
comma
r_int
id|type
)paren
(brace
r_int
id|apu
suffix:semicolon
r_for
c_loop
(paren
id|apu
op_assign
l_int|0
suffix:semicolon
id|apu
OL
id|NR_APUS
suffix:semicolon
id|apu
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;apu
(braket
id|apu
)braket
op_eq
id|ESM_APU_FREE
op_logical_and
id|chip-&gt;apu
(braket
id|apu
op_plus
l_int|1
)braket
op_eq
id|ESM_APU_FREE
)paren
(brace
id|chip-&gt;apu
(braket
id|apu
)braket
op_assign
id|chip-&gt;apu
(braket
id|apu
op_plus
l_int|1
)braket
op_assign
id|type
suffix:semicolon
r_return
id|apu
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n; * release APU pair&n; */
DECL|function|snd_es1968_free_apu_pair
r_static
r_void
id|snd_es1968_free_apu_pair
c_func
(paren
id|es1968_t
op_star
id|chip
comma
r_int
id|apu
)paren
(brace
id|chip-&gt;apu
(braket
id|apu
)braket
op_assign
id|chip-&gt;apu
(braket
id|apu
op_plus
l_int|1
)braket
op_assign
id|ESM_APU_FREE
suffix:semicolon
)brace
multiline_comment|/******************&n; * PCM open/close *&n; ******************/
DECL|function|snd_es1968_playback_open
r_static
r_int
id|snd_es1968_playback_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|esschan_t
op_star
id|es
suffix:semicolon
r_int
id|apu1
suffix:semicolon
multiline_comment|/* search 2 APUs */
id|apu1
op_assign
id|snd_es1968_alloc_apu_pair
c_func
(paren
id|chip
comma
id|ESM_APU_PCM_PLAY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|apu1
OL
l_int|0
)paren
r_return
id|apu1
suffix:semicolon
id|es
op_assign
id|snd_magic_kcalloc
c_func
(paren
id|esschan_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|es
)paren
(brace
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|apu1
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|es-&gt;apu
(braket
l_int|0
)braket
op_assign
id|apu1
suffix:semicolon
id|es-&gt;apu
(braket
l_int|1
)braket
op_assign
id|apu1
op_plus
l_int|1
suffix:semicolon
id|es-&gt;apu_mode
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|es-&gt;apu_mode
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|es-&gt;running
op_assign
l_int|0
suffix:semicolon
id|es-&gt;substream
op_assign
id|substream
suffix:semicolon
id|es-&gt;mode
op_assign
id|ESM_MODE_PLAY
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|es-&gt;list
)paren
suffix:semicolon
id|runtime-&gt;private_data
op_assign
id|es
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_es1968_playback
suffix:semicolon
id|runtime-&gt;hw.buffer_bytes_max
op_assign
id|runtime-&gt;hw.period_bytes_max
op_assign
id|calc_available_memory_size
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_capture_copy
r_static
r_int
id|snd_es1968_capture_copy
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
r_int
id|channel
comma
id|snd_pcm_uframes_t
id|pos
comma
r_void
op_star
id|buf
comma
id|snd_pcm_uframes_t
id|count
)paren
(brace
singleline_comment|//es1968_t *chip = snd_pcm_substream_chip(substream);
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|esschan_t
op_star
id|es
op_assign
id|snd_magic_cast
c_func
(paren
id|esschan_t
comma
id|runtime-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_char
op_star
id|src
op_assign
id|runtime-&gt;dma_area
suffix:semicolon
r_if
c_cond
(paren
id|runtime-&gt;channels
op_eq
l_int|1
)paren
r_return
id|copy_to_user
c_func
(paren
id|buf
comma
id|src
op_plus
id|pos
comma
id|count
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_else
(brace
id|count
op_div_assign
l_int|2
suffix:semicolon
id|pos
op_div_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|src
op_plus
id|pos
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
op_plus
id|count
comma
id|src
op_plus
id|pos
op_plus
id|es-&gt;dma_size
op_div
l_int|2
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|snd_es1968_capture_open
r_static
r_int
id|snd_es1968_capture_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|esschan_t
op_star
id|es
suffix:semicolon
r_int
id|apu1
comma
id|apu2
suffix:semicolon
id|apu1
op_assign
id|snd_es1968_alloc_apu_pair
c_func
(paren
id|chip
comma
id|ESM_APU_PCM_CAPTURE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|apu1
OL
l_int|0
)paren
r_return
id|apu1
suffix:semicolon
id|apu2
op_assign
id|snd_es1968_alloc_apu_pair
c_func
(paren
id|chip
comma
id|ESM_APU_PCM_RATECONV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|apu2
OL
l_int|0
)paren
(brace
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|apu1
)paren
suffix:semicolon
r_return
id|apu2
suffix:semicolon
)brace
id|es
op_assign
id|snd_magic_kcalloc
c_func
(paren
id|esschan_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|es
)paren
(brace
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|apu1
)paren
suffix:semicolon
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|apu2
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|es-&gt;apu
(braket
l_int|0
)braket
op_assign
id|apu1
suffix:semicolon
id|es-&gt;apu
(braket
l_int|1
)braket
op_assign
id|apu1
op_plus
l_int|1
suffix:semicolon
id|es-&gt;apu
(braket
l_int|2
)braket
op_assign
id|apu2
suffix:semicolon
id|es-&gt;apu
(braket
l_int|3
)braket
op_assign
id|apu2
op_plus
l_int|1
suffix:semicolon
id|es-&gt;apu_mode
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|es-&gt;apu_mode
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|es-&gt;apu_mode
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|es-&gt;apu_mode
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|es-&gt;running
op_assign
l_int|0
suffix:semicolon
id|es-&gt;substream
op_assign
id|substream
suffix:semicolon
id|es-&gt;mode
op_assign
id|ESM_MODE_CAPTURE
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|es-&gt;list
)paren
suffix:semicolon
multiline_comment|/* get mixbuffer */
r_if
c_cond
(paren
(paren
id|es-&gt;mixbuf
op_assign
id|snd_es1968_new_memory
c_func
(paren
id|chip
comma
id|ESM_MIXBUF_SIZE
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|apu1
)paren
suffix:semicolon
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|apu2
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|es
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|runtime-&gt;private_data
op_assign
id|es
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_es1968_capture
suffix:semicolon
id|runtime-&gt;hw.buffer_bytes_max
op_assign
id|runtime-&gt;hw.period_bytes_max
op_assign
id|calc_available_memory_size
c_func
(paren
id|chip
)paren
op_minus
l_int|1024
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_playback_close
r_static
r_int
id|snd_es1968_playback_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|esschan_t
op_star
id|es
suffix:semicolon
r_if
c_cond
(paren
id|substream-&gt;runtime-&gt;private_data
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|es
op_assign
id|snd_magic_cast
c_func
(paren
id|esschan_t
comma
id|substream-&gt;runtime-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|es
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_capture_close
r_static
r_int
id|snd_es1968_capture_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|esschan_t
op_star
id|es
suffix:semicolon
r_if
c_cond
(paren
id|substream-&gt;runtime-&gt;private_data
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|es
op_assign
id|snd_magic_cast
c_func
(paren
id|esschan_t
comma
id|substream-&gt;runtime-&gt;private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|snd_es1968_free_memory
c_func
(paren
id|chip
comma
id|es-&gt;mixbuf
)paren
suffix:semicolon
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|es-&gt;apu
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|es
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|snd_es1968_playback_ops
r_static
id|snd_pcm_ops_t
id|snd_es1968_playback_ops
op_assign
(brace
id|open
suffix:colon
id|snd_es1968_playback_open
comma
id|close
suffix:colon
id|snd_es1968_playback_close
comma
id|ioctl
suffix:colon
id|snd_pcm_lib_ioctl
comma
id|hw_params
suffix:colon
id|snd_es1968_hw_params
comma
id|hw_free
suffix:colon
id|snd_es1968_hw_free
comma
id|prepare
suffix:colon
id|snd_es1968_pcm_prepare
comma
id|trigger
suffix:colon
id|snd_es1968_pcm_trigger
comma
id|pointer
suffix:colon
id|snd_es1968_pcm_pointer
comma
)brace
suffix:semicolon
DECL|variable|snd_es1968_capture_ops
r_static
id|snd_pcm_ops_t
id|snd_es1968_capture_ops
op_assign
(brace
id|open
suffix:colon
id|snd_es1968_capture_open
comma
id|close
suffix:colon
id|snd_es1968_capture_close
comma
id|ioctl
suffix:colon
id|snd_pcm_lib_ioctl
comma
id|hw_params
suffix:colon
id|snd_es1968_hw_params
comma
id|hw_free
suffix:colon
id|snd_es1968_hw_free
comma
id|prepare
suffix:colon
id|snd_es1968_pcm_prepare
comma
id|trigger
suffix:colon
id|snd_es1968_pcm_trigger
comma
id|pointer
suffix:colon
id|snd_es1968_pcm_pointer
comma
id|copy
suffix:colon
id|snd_es1968_capture_copy
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * measure clock&n; */
DECL|macro|CLOCK_MEASURE_BUFSIZE
mdefine_line|#define CLOCK_MEASURE_BUFSIZE&t;16768&t;/* enough large for a single shot */
DECL|function|es1968_measure_clock
r_static
r_void
id|__devinit
id|es1968_measure_clock
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
r_int
id|i
comma
id|apu
suffix:semicolon
r_int
r_int
id|pa
comma
id|offset
comma
id|t
suffix:semicolon
id|esm_memory_t
op_star
id|memory
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|timeval
id|start_time
comma
id|stop_time
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;clock
op_eq
l_int|0
)paren
id|chip-&gt;clock
op_assign
l_int|48000
suffix:semicolon
multiline_comment|/* default clock value */
multiline_comment|/* search 2 APUs (although one apu is enough) */
r_if
c_cond
(paren
(paren
id|apu
op_assign
id|snd_es1968_alloc_apu_pair
c_func
(paren
id|chip
comma
id|ESM_APU_PCM_PLAY
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;Hmm, cannot find empty APU pair!?&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|memory
op_assign
id|snd_es1968_new_memory
c_func
(paren
id|chip
comma
id|CLOCK_MEASURE_BUFSIZE
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;cannot allocate dma buffer - using default clock %d&bslash;n&quot;
comma
id|chip-&gt;clock
)paren
suffix:semicolon
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|apu
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|memory-&gt;buf
comma
l_int|0
comma
id|CLOCK_MEASURE_BUFSIZE
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|chip
comma
id|apu
op_lshift
l_int|3
comma
(paren
id|memory-&gt;addr
op_minus
l_int|0x10
)paren
op_amp
l_int|0xfff8
)paren
suffix:semicolon
id|pa
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
id|memory-&gt;addr
op_minus
id|chip-&gt;dma_buf_addr
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|pa
op_or_assign
l_int|0x00400000
suffix:semicolon
multiline_comment|/* System RAM (Bit 22) */
multiline_comment|/* initialize apu */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
id|i
comma
l_int|0x0000
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|4
comma
(paren
(paren
id|pa
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|5
comma
id|pa
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|6
comma
(paren
id|pa
op_plus
id|CLOCK_MEASURE_BUFSIZE
op_div
l_int|2
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|7
comma
id|CLOCK_MEASURE_BUFSIZE
op_div
l_int|2
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|8
comma
l_int|0x0000
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|9
comma
l_int|0xD000
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|10
comma
l_int|0x8F08
)paren
suffix:semicolon
id|apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|11
comma
l_int|0x0000
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|1
comma
id|chip-&gt;io_port
op_plus
l_int|0x04
)paren
suffix:semicolon
multiline_comment|/* clear WP interupts */
id|outw
c_func
(paren
id|inw
c_func
(paren
id|chip-&gt;io_port
op_plus
l_int|0x18
)paren
op_or
l_int|4
comma
id|chip-&gt;io_port
op_plus
l_int|0x18
)paren
suffix:semicolon
multiline_comment|/* enable WP ints */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|snd_es1968_apu_set_freq
c_func
(paren
id|chip
comma
id|apu
comma
(paren
(paren
r_int
r_int
)paren
l_int|48000
op_lshift
l_int|16
)paren
op_div
id|chip-&gt;clock
)paren
suffix:semicolon
multiline_comment|/* 48000 Hz */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|__apu_set_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|5
comma
id|pa
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|apu
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* 16bit mono */
id|do_gettimeofday
c_func
(paren
op_amp
id|start_time
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#if 0
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
multiline_comment|/* 50 msec */
macro_line|#else
multiline_comment|/* FIXME:&n;&t; * schedule() above may be too inaccurate and the pointer can&n;&t; * overlap the boundary..&n;&t; */
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|offset
op_assign
id|__apu_get_register
c_func
(paren
id|chip
comma
id|apu
comma
l_int|5
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|stop_time
)paren
suffix:semicolon
id|snd_es1968_trigger_apu
c_func
(paren
id|chip
comma
id|apu
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* stop */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* check the current position */
id|offset
op_sub_assign
(paren
id|pa
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|offset
op_and_assign
l_int|0xfffe
suffix:semicolon
id|t
op_assign
id|stop_time.tv_sec
op_minus
id|start_time.tv_sec
suffix:semicolon
id|t
op_mul_assign
l_int|1000000
suffix:semicolon
r_if
c_cond
(paren
id|stop_time.tv_usec
OL
id|start_time.tv_usec
)paren
id|t
op_sub_assign
id|start_time.tv_usec
op_minus
id|stop_time.tv_usec
suffix:semicolon
r_else
id|t
op_add_assign
id|stop_time.tv_usec
op_minus
id|start_time.tv_usec
suffix:semicolon
r_if
c_cond
(paren
id|t
op_eq
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;?? calculation error..&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|offset
op_mul_assign
l_int|1000
suffix:semicolon
id|offset
op_assign
(paren
id|offset
op_div
id|t
)paren
op_star
l_int|1000
op_plus
(paren
(paren
id|offset
op_mod
id|t
)paren
op_star
l_int|1000
)paren
op_div
id|t
suffix:semicolon
r_if
c_cond
(paren
id|offset
template_param
l_int|48500
)paren
(brace
r_if
c_cond
(paren
id|offset
op_ge
l_int|40000
op_logical_and
id|offset
op_le
l_int|50000
)paren
id|chip-&gt;clock
op_assign
(paren
id|chip-&gt;clock
op_star
id|offset
)paren
op_div
l_int|48000
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;es1968: clocking to %d&bslash;n&quot;
comma
id|chip-&gt;clock
)paren
suffix:semicolon
)brace
id|snd_es1968_free_memory
c_func
(paren
id|chip
comma
id|memory
)paren
suffix:semicolon
id|snd_es1968_free_apu_pair
c_func
(paren
id|chip
comma
id|apu
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|snd_es1968_pcm_free
r_static
r_void
id|snd_es1968_pcm_free
c_func
(paren
id|snd_pcm_t
op_star
id|pcm
)paren
(brace
id|es1968_t
op_star
id|esm
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|pcm-&gt;private_data
comma
r_return
)paren
suffix:semicolon
id|snd_es1968_free_dmabuf
c_func
(paren
id|esm
)paren
suffix:semicolon
id|esm-&gt;pcm
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
id|__devinit
DECL|function|snd_es1968_pcm
id|snd_es1968_pcm
c_func
(paren
id|es1968_t
op_star
id|chip
comma
r_int
id|device
)paren
(brace
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* get DMA buffer */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_es1968_init_dmabuf
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* set PCMBAR */
id|wave_set_register
c_func
(paren
id|chip
comma
l_int|0x01FC
comma
id|chip-&gt;dma_buf_addr
op_rshift
l_int|12
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|chip
comma
l_int|0x01FD
comma
id|chip-&gt;dma_buf_addr
op_rshift
l_int|12
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|chip
comma
l_int|0x01FE
comma
id|chip-&gt;dma_buf_addr
op_rshift
l_int|12
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|chip
comma
l_int|0x01FF
comma
id|chip-&gt;dma_buf_addr
op_rshift
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pcm_new
c_func
(paren
id|chip-&gt;card
comma
l_string|&quot;ESS Maestro&quot;
comma
id|device
comma
id|chip-&gt;playback_streams
comma
id|chip-&gt;capture_streams
comma
op_amp
id|pcm
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|pcm-&gt;private_data
op_assign
id|chip
suffix:semicolon
id|pcm-&gt;private_free
op_assign
id|snd_es1968_pcm_free
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_PLAYBACK
comma
op_amp
id|snd_es1968_playback_ops
)paren
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_CAPTURE
comma
op_amp
id|snd_es1968_capture_ops
)paren
suffix:semicolon
id|pcm-&gt;info_flags
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|pcm-&gt;name
comma
l_string|&quot;ESS Maestro&quot;
)paren
suffix:semicolon
id|chip-&gt;pcm
op_assign
id|pcm
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * update pointer&n; */
DECL|function|snd_es1968_update_pcm
r_static
r_void
id|snd_es1968_update_pcm
c_func
(paren
id|es1968_t
op_star
id|chip
comma
id|esschan_t
op_star
id|es
)paren
(brace
r_int
r_int
id|hwptr
suffix:semicolon
r_int
r_int
id|diff
suffix:semicolon
id|snd_pcm_substream_t
op_star
id|subs
op_assign
id|es-&gt;substream
suffix:semicolon
r_if
c_cond
(paren
id|subs
op_eq
l_int|NULL
op_logical_or
op_logical_neg
id|es-&gt;running
)paren
r_return
suffix:semicolon
id|hwptr
op_assign
id|snd_es1968_get_dma_ptr
c_func
(paren
id|chip
comma
id|es
)paren
op_lshift
id|es-&gt;wav_shift
suffix:semicolon
id|hwptr
op_mod_assign
id|es-&gt;dma_size
suffix:semicolon
id|diff
op_assign
(paren
id|es-&gt;dma_size
op_plus
id|hwptr
op_minus
id|es-&gt;hwptr
)paren
op_mod
id|es-&gt;dma_size
suffix:semicolon
id|es-&gt;hwptr
op_assign
id|hwptr
suffix:semicolon
id|es-&gt;count
op_add_assign
id|diff
suffix:semicolon
r_while
c_loop
(paren
id|es-&gt;count
OG
id|es-&gt;frag_size
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;substream_lock
)paren
suffix:semicolon
id|snd_pcm_period_elapsed
c_func
(paren
id|subs
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;substream_lock
)paren
suffix:semicolon
id|es-&gt;count
op_sub_assign
id|es-&gt;frag_size
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; */
DECL|function|es1968_update_hw_volume
r_static
r_void
id|es1968_update_hw_volume
c_func
(paren
r_int
r_int
id|private_data
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
(paren
r_void
op_star
)paren
id|private_data
comma
r_return
)paren
suffix:semicolon
r_int
id|x
comma
id|val
suffix:semicolon
multiline_comment|/* Figure out which volume control button was pushed,&n;&t;   based on differences from the default register&n;&t;   values. */
id|x
op_assign
id|inb
c_func
(paren
id|chip-&gt;io_port
op_plus
l_int|0x1c
)paren
suffix:semicolon
multiline_comment|/* Reset the volume control registers. */
id|outb
c_func
(paren
l_int|0x88
comma
id|chip-&gt;io_port
op_plus
l_int|0x1c
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x88
comma
id|chip-&gt;io_port
op_plus
l_int|0x1d
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x88
comma
id|chip-&gt;io_port
op_plus
l_int|0x1e
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x88
comma
id|chip-&gt;io_port
op_plus
l_int|0x1f
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;master_switch
op_logical_or
op_logical_neg
id|chip-&gt;master_volume
)paren
r_return
suffix:semicolon
multiline_comment|/* FIXME: more clean up is needed.. */
id|val
op_assign
id|chip-&gt;ac97-&gt;regs
(braket
id|AC97_MASTER
)braket
suffix:semicolon
r_if
c_cond
(paren
id|x
op_amp
l_int|1
)paren
(brace
multiline_comment|/* mute */
id|snd_ac97_write_cache
c_func
(paren
id|chip-&gt;ac97
comma
l_int|0
comma
id|val
op_xor
l_int|0x8000
)paren
suffix:semicolon
id|snd_ctl_notify
c_func
(paren
id|chip-&gt;card
comma
id|SNDRV_CTL_EVENT_MASK_VALUE
comma
op_amp
id|chip-&gt;master_switch-&gt;id
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_and_assign
l_int|0x7fff
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|x
op_rshift
l_int|1
)paren
op_amp
l_int|7
)paren
OG
l_int|4
)paren
(brace
multiline_comment|/* volume up */
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|0xff
)paren
OG
l_int|0
)paren
id|val
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|0xff00
)paren
OG
l_int|0x100
)paren
id|val
op_sub_assign
l_int|0x0100
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* volume down */
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|0xff
)paren
OL
l_int|0x1f
)paren
id|val
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|0xff00
)paren
OL
l_int|0x1f00
)paren
id|val
op_add_assign
l_int|0x0100
suffix:semicolon
)brace
id|snd_ac97_write_cache
c_func
(paren
id|chip-&gt;ac97
comma
l_int|0
comma
id|val
)paren
suffix:semicolon
id|snd_ctl_notify
c_func
(paren
id|chip-&gt;card
comma
id|SNDRV_CTL_EVENT_MASK_VALUE
comma
op_amp
id|chip-&gt;master_volume-&gt;id
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * interrupt handler&n; */
DECL|function|snd_es1968_interrupt
r_static
r_void
id|snd_es1968_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|dev_id
comma
r_return
)paren
suffix:semicolon
id|u32
id|event
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|event
op_assign
id|inb
c_func
(paren
id|chip-&gt;io_port
op_plus
l_int|0x1A
)paren
)paren
)paren
r_return
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|chip-&gt;io_port
op_plus
l_int|4
)paren
op_amp
l_int|1
comma
id|chip-&gt;io_port
op_plus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_amp
id|ESM_HWVOL_IRQ
)paren
id|tasklet_hi_schedule
c_func
(paren
op_amp
id|chip-&gt;hwvol_tq
)paren
suffix:semicolon
multiline_comment|/* we&squot;ll do this later */
multiline_comment|/* else ack &squot;em all, i imagine */
id|outb
c_func
(paren
l_int|0xFF
comma
id|chip-&gt;io_port
op_plus
l_int|0x1A
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|event
op_amp
id|ESM_MPU401_IRQ
)paren
op_logical_and
id|chip-&gt;rmidi
)paren
(brace
id|snd_mpu401_uart_interrupt
c_func
(paren
id|irq
comma
id|chip-&gt;rmidi-&gt;private_data
comma
id|regs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|ESM_SOUND_IRQ
)paren
(brace
r_struct
id|list_head
op_star
id|p
comma
op_star
id|n
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;substream_lock
)paren
suffix:semicolon
multiline_comment|/* we need to use list_for_each_safe here since the substream&n;&t;&t; * can be deleted in period_elapsed().&n;&t;&t; */
id|list_for_each_safe
c_func
(paren
id|p
comma
id|n
comma
op_amp
id|chip-&gt;substream_list
)paren
(brace
id|esschan_t
op_star
id|es
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|esschan_t
comma
id|list
)paren
suffix:semicolon
id|snd_es1968_update_pcm
c_func
(paren
id|chip
comma
id|es
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;substream_lock
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *  Mixer stuff&n; */
r_static
r_int
id|__devinit
DECL|function|snd_es1968_mixer
id|snd_es1968_mixer
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
id|ac97_t
id|ac97
suffix:semicolon
id|snd_ctl_elem_id_t
id|id
suffix:semicolon
r_int
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ac97
comma
l_int|0
comma
r_sizeof
(paren
id|ac97
)paren
)paren
suffix:semicolon
id|ac97.write
op_assign
id|snd_es1968_ac97_write
suffix:semicolon
id|ac97.read
op_assign
id|snd_es1968_ac97_read
suffix:semicolon
id|ac97.private_data
op_assign
id|chip
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ac97_mixer
c_func
(paren
id|chip-&gt;card
comma
op_amp
id|ac97
comma
op_amp
id|chip-&gt;ac97
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* attach master switch / volumes for h/w volume control */
id|memset
c_func
(paren
op_amp
id|id
comma
l_int|0
comma
r_sizeof
(paren
id|id
)paren
)paren
suffix:semicolon
id|id.iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
suffix:semicolon
id|strcpy
c_func
(paren
id|id.name
comma
l_string|&quot;Master Playback Switch&quot;
)paren
suffix:semicolon
id|chip-&gt;master_switch
op_assign
id|snd_ctl_find_id
c_func
(paren
id|chip-&gt;card
comma
op_amp
id|id
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|id
comma
l_int|0
comma
r_sizeof
(paren
id|id
)paren
)paren
suffix:semicolon
id|id.iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
suffix:semicolon
id|strcpy
c_func
(paren
id|id.name
comma
l_string|&quot;Master Playback Volume&quot;
)paren
suffix:semicolon
id|chip-&gt;master_volume
op_assign
id|snd_ctl_find_id
c_func
(paren
id|chip-&gt;card
comma
op_amp
id|id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * reset ac97 codec&n; */
DECL|function|snd_es1968_ac97_reset
r_static
r_void
id|snd_es1968_ac97_reset
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
r_int
r_int
id|ioaddr
op_assign
id|chip-&gt;io_port
suffix:semicolon
r_int
r_int
id|save_ringbus_a
suffix:semicolon
r_int
r_int
id|save_68
suffix:semicolon
r_int
r_int
id|w
suffix:semicolon
r_int
r_int
id|vend
suffix:semicolon
multiline_comment|/* save configuration */
id|save_ringbus_a
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x36
)paren
suffix:semicolon
singleline_comment|//outw(inw(ioaddr + 0x38) &amp; 0xfffc, ioaddr + 0x38); /* clear second codec id? */
multiline_comment|/* set command/status address i/o to 1st codec */
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x3a
)paren
op_amp
l_int|0xfffc
comma
id|ioaddr
op_plus
l_int|0x3a
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x3c
)paren
op_amp
l_int|0xfffc
comma
id|ioaddr
op_plus
l_int|0x3c
)paren
suffix:semicolon
multiline_comment|/* disable ac link */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x36
)paren
suffix:semicolon
id|save_68
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x68
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|chip-&gt;pci
comma
l_int|0x58
comma
op_amp
id|w
)paren
suffix:semicolon
multiline_comment|/* something magical with gpio and bus arb. */
id|pci_read_config_dword
c_func
(paren
id|chip-&gt;pci
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|vend
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w
op_amp
l_int|1
)paren
id|save_68
op_or_assign
l_int|0x10
suffix:semicolon
id|outw
c_func
(paren
l_int|0xfffe
comma
id|ioaddr
op_plus
l_int|0x64
)paren
suffix:semicolon
multiline_comment|/* unmask gpio 0 */
id|outw
c_func
(paren
l_int|0x0001
comma
id|ioaddr
op_plus
l_int|0x68
)paren
suffix:semicolon
multiline_comment|/* gpio write */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x60
)paren
suffix:semicolon
multiline_comment|/* write 0 to gpio 0 */
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0001
comma
id|ioaddr
op_plus
l_int|0x60
)paren
suffix:semicolon
multiline_comment|/* write 1 to gpio 1 */
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outw
c_func
(paren
id|save_68
op_or
l_int|0x1
comma
id|ioaddr
op_plus
l_int|0x68
)paren
suffix:semicolon
multiline_comment|/* now restore .. */
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x38
)paren
op_amp
l_int|0xfffc
)paren
op_or
l_int|0x1
comma
id|ioaddr
op_plus
l_int|0x38
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x3a
)paren
op_amp
l_int|0xfffc
)paren
op_or
l_int|0x1
comma
id|ioaddr
op_plus
l_int|0x3a
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x3c
)paren
op_amp
l_int|0xfffc
)paren
op_or
l_int|0x1
comma
id|ioaddr
op_plus
l_int|0x3c
)paren
suffix:semicolon
multiline_comment|/* now the second codec */
multiline_comment|/* disable ac link */
id|outw
c_func
(paren
l_int|0x0000
comma
id|ioaddr
op_plus
l_int|0x36
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xfff7
comma
id|ioaddr
op_plus
l_int|0x64
)paren
suffix:semicolon
multiline_comment|/* unmask gpio 3 */
id|save_68
op_assign
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x68
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0009
comma
id|ioaddr
op_plus
l_int|0x68
)paren
suffix:semicolon
multiline_comment|/* gpio write 0 &amp; 3 ?? */
id|outw
c_func
(paren
l_int|0x0001
comma
id|ioaddr
op_plus
l_int|0x60
)paren
suffix:semicolon
multiline_comment|/* write 1 to gpio */
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0009
comma
id|ioaddr
op_plus
l_int|0x60
)paren
suffix:semicolon
multiline_comment|/* write 9 to gpio */
id|mdelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* .. ouch.. */
singleline_comment|//outw(inw(ioaddr + 0x38) &amp; 0xfffc, ioaddr + 0x38);
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x3a
)paren
op_amp
l_int|0xfffc
comma
id|ioaddr
op_plus
l_int|0x3a
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x3c
)paren
op_amp
l_int|0xfffc
comma
id|ioaddr
op_plus
l_int|0x3c
)paren
suffix:semicolon
macro_line|#if 0&t;&t;&t;&t;/* the loop here needs to be much better if we want it.. */
id|snd_printk
c_func
(paren
l_string|&quot;trying software reset&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* try and do a software reset */
id|outb
c_func
(paren
l_int|0x80
op_or
l_int|0x7c
comma
id|ioaddr
op_plus
l_int|0x30
)paren
suffix:semicolon
r_for
c_loop
(paren
id|w
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
id|w
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x30
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0x32
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|outb
c_func
(paren
l_int|0x80
op_or
l_int|0x7d
comma
id|ioaddr
op_plus
l_int|0x30
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x30
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0x32
)paren
op_ne
l_int|0
)paren
)paren
r_break
suffix:semicolon
id|outb
c_func
(paren
l_int|0x80
op_or
l_int|0x7f
comma
id|ioaddr
op_plus
l_int|0x30
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x30
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0x32
)paren
op_ne
l_int|0
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|w
OG
l_int|10000
)paren
(brace
id|outb
c_func
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0x37
)paren
op_or
l_int|0x08
comma
id|ioaddr
op_plus
l_int|0x37
)paren
suffix:semicolon
multiline_comment|/* do a software reset */
id|mdelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* oh my.. */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0x37
)paren
op_amp
op_complement
l_int|0x08
comma
id|ioaddr
op_plus
l_int|0x37
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x80
comma
id|ioaddr
op_plus
l_int|0x30
)paren
suffix:semicolon
r_for
c_loop
(paren
id|w
op_assign
l_int|0
suffix:semicolon
id|w
OL
l_int|10000
suffix:semicolon
id|w
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x30
)paren
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|vend
op_eq
id|NEC_VERSA_SUBID1
op_logical_or
id|vend
op_eq
id|NEC_VERSA_SUBID2
)paren
(brace
multiline_comment|/* turn on external amp? */
id|outw
c_func
(paren
l_int|0xf9ff
comma
id|ioaddr
op_plus
l_int|0x64
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|ioaddr
op_plus
l_int|0x68
)paren
op_or
l_int|0x600
comma
id|ioaddr
op_plus
l_int|0x68
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0209
comma
id|ioaddr
op_plus
l_int|0x60
)paren
suffix:semicolon
)brace
multiline_comment|/* restore.. */
id|outw
c_func
(paren
id|save_ringbus_a
comma
id|ioaddr
op_plus
l_int|0x36
)paren
suffix:semicolon
multiline_comment|/* Turn on the 978 docking chip.&n;&t;   First frob the &quot;master output enable&quot; bit,&n;&t;   then set most of the playback volume control registers to max. */
id|outb
c_func
(paren
id|inb
c_func
(paren
id|ioaddr
op_plus
l_int|0xc0
)paren
op_or
(paren
l_int|1
op_lshift
l_int|5
)paren
comma
id|ioaddr
op_plus
l_int|0xc0
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|ioaddr
op_plus
l_int|0xc3
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|ioaddr
op_plus
l_int|0xc4
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|ioaddr
op_plus
l_int|0xc6
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0xff
comma
id|ioaddr
op_plus
l_int|0xc8
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x3f
comma
id|ioaddr
op_plus
l_int|0xcf
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x3f
comma
id|ioaddr
op_plus
l_int|0xd0
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_reset
r_static
r_void
id|snd_es1968_reset
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
multiline_comment|/* Reset */
id|outw
c_func
(paren
id|ESM_RESET_MAESTRO
op_or
id|ESM_RESET_DIRECTSOUND
comma
id|chip-&gt;io_port
op_plus
id|ESM_PORT_HOST_IRQ
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|chip-&gt;io_port
op_plus
id|ESM_PORT_HOST_IRQ
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * power management&n; */
DECL|function|snd_es1968_set_acpi
r_static
r_void
id|snd_es1968_set_acpi
c_func
(paren
id|es1968_t
op_star
id|chip
comma
r_int
id|state
)paren
(brace
id|u16
id|active_mask
op_assign
id|acpi_state_mask
(braket
id|state
)braket
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|chip-&gt;pci
comma
id|state
)paren
suffix:semicolon
multiline_comment|/* make sure the units we care about are on &n;&t;&t;XXX we might want to do this before state flipping? */
id|pci_write_config_word
c_func
(paren
id|chip-&gt;pci
comma
l_int|0x54
comma
op_complement
id|active_mask
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|chip-&gt;pci
comma
l_int|0x56
comma
op_complement
id|active_mask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * initialize maestro chip&n; */
DECL|function|snd_es1968_chip_init
r_static
r_void
id|snd_es1968_chip_init
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci
op_assign
id|chip-&gt;pci
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|iobase
op_assign
id|chip-&gt;io_port
suffix:semicolon
id|u16
id|w
suffix:semicolon
id|u32
id|n
suffix:semicolon
multiline_comment|/* We used to muck around with pci config space that&n;&t; * we had no business messing with.  We don&squot;t know enough&n;&t; * about the machine to know which DMA mode is appropriate, &n;&t; * etc.  We were guessing wrong on some machines and making&n;&t; * them unhappy.  We now trust in the BIOS to do things right,&n;&t; * which almost certainly means a new host of problems will&n;&t; * arise with broken BIOS implementations.  screw &squot;em. &n;&t; * We&squot;re already intolerant of machines that don&squot;t assign&n;&t; * IRQs.&n;&t; */
multiline_comment|/* do config work at full power */
id|snd_es1968_set_acpi
c_func
(paren
id|chip
comma
id|ACPI_D0
)paren
suffix:semicolon
multiline_comment|/* Config Reg A */
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|ESM_CONFIG_A
comma
op_amp
id|w
)paren
suffix:semicolon
multiline_comment|/*      Use TDMA for now. TDMA works on all boards, so while its&n;&t; *      not the most efficient its the simplest. */
id|w
op_and_assign
op_complement
id|DMA_CLEAR
suffix:semicolon
multiline_comment|/* Clear DMA bits */
id|w
op_or_assign
id|DMA_TDMA
suffix:semicolon
multiline_comment|/* TDMA on */
id|w
op_and_assign
op_complement
(paren
id|PIC_SNOOP1
op_or
id|PIC_SNOOP2
)paren
suffix:semicolon
multiline_comment|/* Clear Pic Snoop Mode Bits */
id|w
op_and_assign
op_complement
id|SAFEGUARD
suffix:semicolon
multiline_comment|/* Safeguard off */
id|w
op_or_assign
id|POST_WRITE
suffix:semicolon
multiline_comment|/* Posted write */
id|w
op_or_assign
id|ISA_TIMING
suffix:semicolon
multiline_comment|/* ISA timing on */
multiline_comment|/* XXX huh?  claims to be reserved.. */
id|w
op_and_assign
op_complement
id|SWAP_LR
suffix:semicolon
multiline_comment|/* swap left/right &n;&t;&t;&t;&t;   seems to only have effect on SB&n;&t;&t;&t;&t;   Emulation */
id|w
op_and_assign
op_complement
id|SUBTR_DECODE
suffix:semicolon
multiline_comment|/* Subtractive decode off */
id|pci_write_config_word
c_func
(paren
id|pci
comma
id|ESM_CONFIG_A
comma
id|w
)paren
suffix:semicolon
multiline_comment|/* Config Reg B */
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|ESM_CONFIG_B
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|15
)paren
suffix:semicolon
multiline_comment|/* Turn off internal clock multiplier */
multiline_comment|/* XXX how do we know which to use? */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|14
)paren
suffix:semicolon
multiline_comment|/* External clock */
id|w
op_and_assign
op_complement
id|SPDIF_CONFB
suffix:semicolon
multiline_comment|/* disable S/PDIF output */
id|w
op_or_assign
id|HWV_CONFB
suffix:semicolon
multiline_comment|/* HWV on */
id|w
op_or_assign
id|DEBOUNCE
suffix:semicolon
multiline_comment|/* Debounce off: easier to push the HW buttons */
id|w
op_and_assign
op_complement
id|GPIO_CONFB
suffix:semicolon
multiline_comment|/* GPIO 4:5 */
id|w
op_or_assign
id|CHI_CONFB
suffix:semicolon
multiline_comment|/* Disconnect from the CHI.  Enabling this made a dell 7500 work. */
id|w
op_and_assign
op_complement
id|IDMA_CONFB
suffix:semicolon
multiline_comment|/* IDMA off (undocumented) */
id|w
op_and_assign
op_complement
id|MIDI_FIX
suffix:semicolon
multiline_comment|/* MIDI fix off (undoc) */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|1
)paren
suffix:semicolon
multiline_comment|/* reserved, always write 0 */
id|w
op_and_assign
op_complement
id|IRQ_TO_ISA
suffix:semicolon
multiline_comment|/* IRQ to ISA off (undoc) */
id|pci_write_config_word
c_func
(paren
id|pci
comma
id|ESM_CONFIG_B
comma
id|w
)paren
suffix:semicolon
multiline_comment|/* DDMA off */
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|ESM_DDMA
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|0
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|pci
comma
id|ESM_DDMA
comma
id|w
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Legacy mode&n;&t; */
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|ESM_LEGACY_AUDIO_CONTROL
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
id|ESS_ENABLE_AUDIO
suffix:semicolon
multiline_comment|/* Disable Legacy Audio */
id|w
op_and_assign
op_complement
id|ESS_ENABLE_SERIAL_IRQ
suffix:semicolon
multiline_comment|/* Disable SIRQ */
id|w
op_and_assign
op_complement
(paren
l_int|0x1f
)paren
suffix:semicolon
multiline_comment|/* disable mpu irq/io, game port, fm, SB */
id|pci_write_config_word
c_func
(paren
id|pci
comma
id|ESM_LEGACY_AUDIO_CONTROL
comma
id|w
)paren
suffix:semicolon
multiline_comment|/* Set up 978 docking control chip. */
id|pci_read_config_word
c_func
(paren
id|pci
comma
l_int|0x58
comma
op_amp
id|w
)paren
suffix:semicolon
id|w
op_or_assign
l_int|1
op_lshift
l_int|2
suffix:semicolon
multiline_comment|/* Enable 978. */
id|w
op_or_assign
l_int|1
op_lshift
l_int|3
suffix:semicolon
multiline_comment|/* Turn on 978 hardware volume control. */
id|w
op_and_assign
op_complement
(paren
l_int|1
op_lshift
l_int|11
)paren
suffix:semicolon
multiline_comment|/* Turn on 978 mixer volume control. */
id|pci_write_config_word
c_func
(paren
id|pci
comma
l_int|0x58
comma
id|w
)paren
suffix:semicolon
multiline_comment|/* Sound Reset */
id|snd_es1968_reset
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Ring Bus Setup&n;&t; */
multiline_comment|/* setup usual 0x34 stuff.. 0x36 may be chip specific */
id|outw
c_func
(paren
l_int|0xC090
comma
id|iobase
op_plus
id|ESM_RING_BUS_DEST
)paren
suffix:semicolon
multiline_comment|/* direct sound, stereo */
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x3000
comma
id|iobase
op_plus
id|ESM_RING_BUS_CONTR_A
)paren
suffix:semicolon
multiline_comment|/* enable ringbus/serial */
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Reset the CODEC&n;&t; */
id|snd_es1968_ac97_reset
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* Ring Bus Control B */
id|n
op_assign
id|inl
c_func
(paren
id|iobase
op_plus
id|ESM_RING_BUS_CONTR_B
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
id|RINGB_EN_SPDIF
suffix:semicolon
multiline_comment|/* SPDIF off */
singleline_comment|//w |= RINGB_EN_2CODEC;&t;/* enable 2nd codec */
id|outl
c_func
(paren
id|n
comma
id|iobase
op_plus
id|ESM_RING_BUS_CONTR_B
)paren
suffix:semicolon
multiline_comment|/* Set hardware volume control registers to midpoints.&n;&t;   We can tell which button was pushed based on how they change. */
id|outb
c_func
(paren
l_int|0x88
comma
id|iobase
op_plus
l_int|0x1c
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x88
comma
id|iobase
op_plus
l_int|0x1d
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x88
comma
id|iobase
op_plus
l_int|0x1e
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x88
comma
id|iobase
op_plus
l_int|0x1f
)paren
suffix:semicolon
multiline_comment|/* it appears some maestros (dell 7500) only work if these are set,&n;&t;   regardless of wether we use the assp or not. */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|ASSP_CONTROL_B
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|3
comma
id|iobase
op_plus
id|ASSP_CONTROL_A
)paren
suffix:semicolon
multiline_comment|/* M: Reserved bits... */
id|outb
c_func
(paren
l_int|0
comma
id|iobase
op_plus
id|ASSP_CONTROL_C
)paren
suffix:semicolon
multiline_comment|/* M: Disable ASSP, ASSP IRQ&squot;s and FM Port */
multiline_comment|/* Enable IRQ&squot;s */
id|w
op_assign
id|ESM_HIRQ_DSIE
op_or
id|ESM_HIRQ_MPU401
suffix:semicolon
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
id|ESM_PORT_HOST_IRQ
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set up wavecache&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Write 0 into the buffer area 0x1E0-&gt;1EF */
id|outw
c_func
(paren
l_int|0x01E0
op_plus
id|i
comma
id|iobase
op_plus
id|WC_INDEX
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|iobase
op_plus
id|WC_DATA
)paren
suffix:semicolon
multiline_comment|/* The 1.10 test program seem to write 0 into the buffer area&n;&t;&t; * 0x1D0-0x1DF too.*/
id|outw
c_func
(paren
l_int|0x01D0
op_plus
id|i
comma
id|iobase
op_plus
id|WC_INDEX
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
id|iobase
op_plus
id|WC_DATA
)paren
suffix:semicolon
)brace
id|wave_set_register
c_func
(paren
id|chip
comma
id|IDR7_WAVE_ROMRAM
comma
(paren
id|wave_get_register
c_func
(paren
id|chip
comma
id|IDR7_WAVE_ROMRAM
)paren
op_amp
l_int|0xFF00
)paren
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|chip
comma
id|IDR7_WAVE_ROMRAM
comma
id|wave_get_register
c_func
(paren
id|chip
comma
id|IDR7_WAVE_ROMRAM
)paren
op_or
l_int|0x100
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|chip
comma
id|IDR7_WAVE_ROMRAM
comma
id|wave_get_register
c_func
(paren
id|chip
comma
id|IDR7_WAVE_ROMRAM
)paren
op_amp
op_complement
l_int|0x200
)paren
suffix:semicolon
id|wave_set_register
c_func
(paren
id|chip
comma
id|IDR7_WAVE_ROMRAM
comma
id|wave_get_register
c_func
(paren
id|chip
comma
id|IDR7_WAVE_ROMRAM
)paren
op_or
op_complement
l_int|0x400
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|chip
comma
id|IDR2_CRAM_DATA
comma
l_int|0x0000
)paren
suffix:semicolon
multiline_comment|/* Now back to the DirectSound stuff */
multiline_comment|/* audio serial configuration.. ? */
id|maestro_write
c_func
(paren
id|chip
comma
l_int|0x08
comma
l_int|0xB004
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|chip
comma
l_int|0x09
comma
l_int|0x001B
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|chip
comma
l_int|0x0A
comma
l_int|0x8000
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|chip
comma
l_int|0x0B
comma
l_int|0x3F37
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|chip
comma
l_int|0x0C
comma
l_int|0x0098
)paren
suffix:semicolon
multiline_comment|/* parallel in, has something to do with recording :) */
id|maestro_write
c_func
(paren
id|chip
comma
l_int|0x0C
comma
(paren
id|maestro_read
c_func
(paren
id|chip
comma
l_int|0x0C
)paren
op_amp
op_complement
l_int|0xF000
)paren
op_or
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* parallel out */
id|maestro_write
c_func
(paren
id|chip
comma
l_int|0x0C
comma
(paren
id|maestro_read
c_func
(paren
id|chip
comma
l_int|0x0C
)paren
op_amp
op_complement
l_int|0x0F00
)paren
op_or
l_int|0x0500
)paren
suffix:semicolon
id|maestro_write
c_func
(paren
id|chip
comma
l_int|0x0D
comma
l_int|0x7632
)paren
suffix:semicolon
multiline_comment|/* Wave cache control on - test off, sg off, &n;&t;   enable, enable extra chans 1Mb */
id|w
op_assign
id|inw
c_func
(paren
id|iobase
op_plus
id|WC_CONTROL
)paren
suffix:semicolon
id|w
op_and_assign
op_complement
l_int|0xFA00
suffix:semicolon
multiline_comment|/* Seems to be reserved? I don&squot;t know */
id|w
op_or_assign
l_int|0xA000
suffix:semicolon
multiline_comment|/* reserved... I don&squot;t know */
id|w
op_and_assign
op_complement
l_int|0x0200
suffix:semicolon
multiline_comment|/* Channels 56,57,58,59 as Extra Play,Rec Channel enable&n;&t;&t;&t;&t;   Seems to crash the Computer if enabled... */
id|w
op_or_assign
l_int|0x0100
suffix:semicolon
multiline_comment|/* Wave Cache Operation Enabled */
id|w
op_or_assign
l_int|0x0080
suffix:semicolon
multiline_comment|/* Channels 60/61 as Placback/Record enabled */
id|w
op_and_assign
op_complement
l_int|0x0060
suffix:semicolon
multiline_comment|/* Clear Wavtable Size */
id|w
op_or_assign
l_int|0x0020
suffix:semicolon
multiline_comment|/* Wavetable Size : 1MB */
multiline_comment|/* Bit 4 is reserved */
id|w
op_and_assign
op_complement
l_int|0x000C
suffix:semicolon
multiline_comment|/* DMA Stuff? I don&squot;t understand what the datasheet means */
multiline_comment|/* Bit 1 is reserved */
id|w
op_and_assign
op_complement
l_int|0x0001
suffix:semicolon
multiline_comment|/* Test Mode off */
id|outw
c_func
(paren
id|w
comma
id|iobase
op_plus
id|WC_CONTROL
)paren
suffix:semicolon
multiline_comment|/* Now clear the APU control ram */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_APUS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|w
op_assign
l_int|0
suffix:semicolon
id|w
OL
id|NR_APU_REGS
suffix:semicolon
id|w
op_increment
)paren
id|apu_set_register
c_func
(paren
id|chip
comma
id|i
comma
id|w
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_PM
multiline_comment|/*&n; * PM support&n; */
DECL|function|es1968_suspend
r_static
r_void
id|es1968_suspend
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
id|snd_card_t
op_star
id|card
op_assign
id|chip-&gt;card
suffix:semicolon
id|snd_power_lock
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;power_state
op_eq
id|SNDRV_CTL_POWER_D3hot
)paren
r_goto
id|__skip
suffix:semicolon
id|snd_pcm_suspend_all
c_func
(paren
id|chip-&gt;pcm
)paren
suffix:semicolon
id|snd_es1968_bob_stop
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_power_change_state
c_func
(paren
id|card
comma
id|SNDRV_CTL_POWER_D3hot
)paren
suffix:semicolon
id|__skip
suffix:colon
id|snd_power_unlock
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
DECL|function|es1968_resume
r_static
r_void
id|es1968_resume
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
id|snd_card_t
op_star
id|card
op_assign
id|chip-&gt;card
suffix:semicolon
id|snd_power_lock
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;power_state
op_eq
id|SNDRV_CTL_POWER_D0
)paren
r_goto
id|__skip
suffix:semicolon
multiline_comment|/* restore all our config */
id|pci_enable_device
c_func
(paren
id|chip-&gt;pci
)paren
suffix:semicolon
id|snd_es1968_chip_init
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* need to restore the base pointers.. */
r_if
c_cond
(paren
id|chip-&gt;dma_buf_addr
)paren
(brace
multiline_comment|/* set PCMBAR */
id|wave_set_register
c_func
(paren
id|chip
comma
l_int|0x01FC
comma
id|chip-&gt;dma_buf_addr
op_rshift
l_int|12
)paren
suffix:semicolon
)brace
multiline_comment|/* restore ac97 state */
id|snd_ac97_resume
c_func
(paren
id|chip-&gt;ac97
)paren
suffix:semicolon
multiline_comment|/* start timer again */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chip-&gt;bobclient
)paren
)paren
id|snd_es1968_bob_start
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_power_change_state
c_func
(paren
id|card
comma
id|SNDRV_CTL_POWER_D0
)paren
suffix:semicolon
id|__skip
suffix:colon
id|snd_power_unlock
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
macro_line|#ifndef PCI_OLD_SUSPEND
DECL|function|snd_es1968_suspend
r_static
r_int
id|snd_es1968_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|es1968_suspend
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_resume
r_static
r_int
id|snd_es1968_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|es1968_resume
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|function|snd_es1968_suspend
r_static
r_void
id|snd_es1968_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
comma
r_return
)paren
suffix:semicolon
id|es1968_suspend
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_resume
r_static
r_void
id|snd_es1968_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
comma
r_return
)paren
suffix:semicolon
id|es1968_resume
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* callback */
DECL|function|snd_es1968_set_power_state
r_static
r_int
id|snd_es1968_set_power_state
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
r_int
id|power_state
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|card-&gt;power_state_private_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|power_state
)paren
(brace
r_case
id|SNDRV_CTL_POWER_D0
suffix:colon
r_case
id|SNDRV_CTL_POWER_D1
suffix:colon
r_case
id|SNDRV_CTL_POWER_D2
suffix:colon
id|es1968_resume
c_func
(paren
id|chip
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_CTL_POWER_D3hot
suffix:colon
r_case
id|SNDRV_CTL_POWER_D3cold
suffix:colon
id|es1968_suspend
c_func
(paren
id|chip
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PM */
DECL|function|snd_es1968_free
r_static
r_int
id|snd_es1968_free
c_func
(paren
id|es1968_t
op_star
id|chip
)paren
(brace
id|snd_es1968_set_acpi
c_func
(paren
id|chip
comma
id|ACPI_D3
)paren
suffix:semicolon
id|chip-&gt;master_switch
op_assign
l_int|NULL
suffix:semicolon
id|chip-&gt;master_volume
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;res_io_port
)paren
(brace
id|release_resource
c_func
(paren
id|chip-&gt;res_io_port
)paren
suffix:semicolon
id|kfree_nocheck
c_func
(paren
id|chip-&gt;res_io_port
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chip-&gt;irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|chip-&gt;irq
comma
(paren
r_void
op_star
)paren
id|chip
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_dev_free
r_static
r_int
id|snd_es1968_dev_free
c_func
(paren
id|snd_device_t
op_star
id|device
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|device-&gt;device_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_return
id|snd_es1968_free
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
DECL|function|snd_es1968_create
r_static
r_int
id|__devinit
id|snd_es1968_create
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_struct
id|pci_dev
op_star
id|pci
comma
r_int
id|total_bufsize
comma
r_int
id|play_streams
comma
r_int
id|capt_streams
comma
id|es1968_t
op_star
op_star
id|chip_ret
)paren
(brace
r_static
id|snd_device_ops_t
id|ops
op_assign
(brace
id|dev_free
suffix:colon
id|snd_es1968_dev_free
comma
)brace
suffix:semicolon
id|es1968_t
op_star
id|chip
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
op_star
id|chip_ret
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* enable PCI device */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pci
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* check, if we can restrict PCI DMA transfers to 28 bits */
r_if
c_cond
(paren
op_logical_neg
id|pci_dma_supported
c_func
(paren
id|pci
comma
l_int|0x0fffffff
)paren
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;architecture does not support 28bit PCI busmaster DMA&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|pci_set_dma_mask
c_func
(paren
id|pci
comma
l_int|0x0fffffff
)paren
suffix:semicolon
id|chip
op_assign
(paren
id|es1968_t
op_star
)paren
id|snd_magic_kcalloc
c_func
(paren
id|es1968_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Set Vars */
id|chip-&gt;type
op_assign
(paren
id|pci-&gt;vendor
op_lshift
l_int|16
)paren
op_or
id|pci-&gt;device
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|chip-&gt;substream_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|chip-&gt;bob_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|chip-&gt;buf_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|chip-&gt;substream_list
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|chip-&gt;memory_mutex
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|chip-&gt;hwvol_tq
comma
id|es1968_update_hw_volume
comma
(paren
r_int
r_int
)paren
id|chip
)paren
suffix:semicolon
id|chip-&gt;card
op_assign
id|card
suffix:semicolon
id|chip-&gt;pci
op_assign
id|pci
suffix:semicolon
id|chip-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|chip-&gt;total_bufsize
op_assign
id|total_bufsize
suffix:semicolon
multiline_comment|/* in bytes */
id|chip-&gt;playback_streams
op_assign
id|play_streams
suffix:semicolon
id|chip-&gt;capture_streams
op_assign
id|capt_streams
suffix:semicolon
id|chip-&gt;io_port
op_assign
id|pci_resource_start
c_func
(paren
id|pci
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chip-&gt;res_io_port
op_assign
id|request_region
c_func
(paren
id|chip-&gt;io_port
comma
l_int|0x100
comma
l_string|&quot;ESS Maestro&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|snd_es1968_free
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_printk
c_func
(paren
l_string|&quot;unable to grab region 0x%lx-0x%lx&bslash;n&quot;
comma
id|chip-&gt;io_port
comma
id|chip-&gt;io_port
op_plus
l_int|0x100
op_minus
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pci-&gt;irq
comma
id|snd_es1968_interrupt
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;ESS Maestro&quot;
comma
(paren
r_void
op_star
)paren
id|chip
)paren
)paren
(brace
id|snd_es1968_free
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_printk
c_func
(paren
l_string|&quot;unable to grab IRQ %d&bslash;n&quot;
comma
id|pci-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|chip-&gt;irq
op_assign
id|pci-&gt;irq
suffix:semicolon
multiline_comment|/* Clear Maestro_map */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
id|chip-&gt;maestro_map
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Clear Apu Map */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_APUS
suffix:semicolon
id|i
op_increment
)paren
id|chip-&gt;apu
(braket
id|i
)braket
op_assign
id|ESM_APU_FREE
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|chip-&gt;bobclient
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* just to be sure */
id|pci_set_master
c_func
(paren
id|pci
)paren
suffix:semicolon
id|snd_es1968_chip_init
c_func
(paren
id|chip
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PM
id|card-&gt;set_power_state
op_assign
id|snd_es1968_set_power_state
suffix:semicolon
id|card-&gt;power_state_private_data
op_assign
id|chip
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_device_new
c_func
(paren
id|card
comma
id|SNDRV_DEV_LOWLEVEL
comma
id|chip
comma
op_amp
id|ops
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_es1968_free
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
op_star
id|chip_ret
op_assign
id|chip
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * joystick&n; */
DECL|function|snd_es1968_joystick_info
r_static
r_int
id|snd_es1968_joystick_info
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
id|uinfo-&gt;type
op_assign
id|SNDRV_CTL_ELEM_TYPE_BOOLEAN
suffix:semicolon
id|uinfo-&gt;count
op_assign
l_int|1
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_joystick_get
r_static
r_int
id|snd_es1968_joystick_get
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|u16
id|val
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|chip-&gt;pci
comma
id|ESM_LEGACY_AUDIO_CONTROL
comma
op_amp
id|val
)paren
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
(paren
id|val
op_amp
l_int|0x04
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_joystick_put
r_static
r_int
id|snd_es1968_joystick_put
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
id|u16
id|val
comma
id|oval
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|chip-&gt;pci
comma
id|ESM_LEGACY_AUDIO_CONTROL
comma
op_amp
id|oval
)paren
suffix:semicolon
id|val
op_assign
id|oval
op_amp
op_complement
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
)paren
id|val
op_or_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|oval
)paren
suffix:semicolon
(brace
id|pci_write_config_word
c_func
(paren
id|chip-&gt;pci
comma
id|ESM_LEGACY_AUDIO_CONTROL
comma
id|val
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|num_controls
mdefine_line|#define num_controls(ary) (sizeof(ary) / sizeof(snd_kcontrol_new_t))
DECL|variable|__devinitdata
r_static
id|snd_kcontrol_new_t
id|snd_es1968_control_switches
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|name
suffix:colon
l_string|&quot;Joystick&quot;
comma
id|iface
suffix:colon
id|SNDRV_CTL_ELEM_IFACE_CARD
comma
id|info
suffix:colon
id|snd_es1968_joystick_info
comma
id|get
suffix:colon
id|snd_es1968_joystick_get
comma
id|put
suffix:colon
id|snd_es1968_joystick_put
comma
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; */
DECL|function|snd_es1968_probe
r_static
r_int
id|__devinit
id|snd_es1968_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_static
r_int
id|dev
op_assign
l_int|0
suffix:semicolon
id|snd_card_t
op_star
id|card
suffix:semicolon
id|es1968_t
op_star
id|chip
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|SNDRV_CARDS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|snd_enable
(braket
id|dev
)braket
)paren
(brace
id|dev
op_increment
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|card
op_assign
id|snd_card_new
c_func
(paren
id|snd_index
(braket
id|dev
)braket
comma
id|snd_id
(braket
id|dev
)braket
comma
id|THIS_MODULE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|snd_total_bufsize
(braket
id|dev
)braket
OL
l_int|128
)paren
id|snd_total_bufsize
(braket
id|dev
)braket
op_assign
l_int|128
suffix:semicolon
r_if
c_cond
(paren
id|snd_total_bufsize
(braket
id|dev
)braket
OG
l_int|4096
)paren
id|snd_total_bufsize
(braket
id|dev
)braket
op_assign
l_int|4096
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_es1968_create
c_func
(paren
id|card
comma
id|pci
comma
id|snd_total_bufsize
(braket
id|dev
)braket
op_star
l_int|1024
comma
multiline_comment|/* in bytes */
id|snd_pcm_substreams_p
(braket
id|dev
)braket
comma
id|snd_pcm_substreams_c
(braket
id|dev
)braket
comma
op_amp
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|chip-&gt;type
)paren
(brace
r_case
id|CARD_TYPE_ESS_ES1978
suffix:colon
id|strcpy
c_func
(paren
id|card-&gt;driver
comma
l_string|&quot;ES1978&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;shortname
comma
l_string|&quot;ESS ES1978 (Maestro 2E)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CARD_TYPE_ESS_ES1968
suffix:colon
id|strcpy
c_func
(paren
id|card-&gt;driver
comma
l_string|&quot;ES1968&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;shortname
comma
l_string|&quot;ESS ES1968 (Maestro 2)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CARD_TYPE_ESS_ESOLDM1
suffix:colon
id|strcpy
c_func
(paren
id|card-&gt;driver
comma
l_string|&quot;ESM1&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;shortname
comma
l_string|&quot;ESS Maestro 1&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_es1968_pcm
c_func
(paren
id|chip
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_es1968_mixer
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_mpu401_uart_new
c_func
(paren
id|card
comma
l_int|0
comma
id|MPU401_HW_MPU401
comma
id|chip-&gt;io_port
op_plus
id|ESM_MPU401_PORT
comma
l_int|1
comma
id|chip-&gt;irq
comma
l_int|0
comma
op_amp
id|chip-&gt;rmidi
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;es1968: skipping MPU-401 MIDI support..&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* card switches */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_controls
c_func
(paren
id|snd_es1968_control_switches
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|snd_es1968_control_switches
(braket
id|i
)braket
comma
id|chip
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
id|chip-&gt;clock
op_assign
id|snd_clock
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;clock
)paren
id|es1968_measure_clock
c_func
(paren
id|chip
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;longname
comma
l_string|&quot;%s at 0x%lx, irq %i&quot;
comma
id|card-&gt;shortname
comma
id|chip-&gt;io_port
comma
id|chip-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_register
c_func
(paren
id|card
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pci
comma
id|chip
)paren
suffix:semicolon
id|dev
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_es1968_remove
r_static
r_void
id|__devexit
id|snd_es1968_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
)paren
(brace
id|es1968_t
op_star
id|chip
op_assign
id|snd_magic_cast
c_func
(paren
id|es1968_t
comma
id|pci_get_drvdata
c_func
(paren
id|pci
)paren
comma
r_return
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
)paren
id|snd_card_free
c_func
(paren
id|chip-&gt;card
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|driver
r_static
r_struct
id|pci_driver
id|driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ES1968 (ESS Maestro)&quot;
comma
id|id_table
suffix:colon
id|snd_es1968_ids
comma
id|probe
suffix:colon
id|snd_es1968_probe
comma
id|remove
suffix:colon
id|__devexit_p
c_func
(paren
id|snd_es1968_remove
)paren
comma
macro_line|#ifdef CONFIG_PM
id|suspend
suffix:colon
id|snd_es1968_suspend
comma
id|resume
suffix:colon
id|snd_es1968_resume
comma
macro_line|#endif
)brace
suffix:semicolon
macro_line|#if 0 
singleline_comment|// do we really need this?
r_static
r_int
id|snd_es1968_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|event
comma
r_void
op_star
id|buf
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
r_return
id|NOTIFY_OK
suffix:semicolon
)brace
r_static
r_struct
id|notifier_block
id|snd_es1968_nb
op_assign
(brace
id|snd_es1968_notifier
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif
DECL|function|alsa_card_es1968_init
r_static
r_int
id|__init
id|alsa_card_es1968_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|driver
)paren
)paren
OL
l_int|0
)paren
(brace
macro_line|#ifdef MODULE
id|snd_printk
c_func
(paren
l_string|&quot;ESS Maestro soundcard not found or device busy&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|err
suffix:semicolon
)brace
macro_line|#if 0 
singleline_comment|// do we really need this?
multiline_comment|/* If this driver is not shutdown cleanly at reboot, it can&n;&t;   leave the speaking emitting an annoying noise, so we catch&n;&t;   shutdown events. */
r_if
c_cond
(paren
id|register_reboot_notifier
c_func
(paren
op_amp
id|snd_es1968_nb
)paren
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;reboot notifier registration failed; may make noise at shutdown.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alsa_card_es1968_exit
r_static
r_void
id|__exit
id|alsa_card_es1968_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#if 0 
singleline_comment|// do we really need this?
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|snd_es1968_nb
)paren
suffix:semicolon
macro_line|#endif
id|pci_unregister_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|alsa_card_es1968_init
)paren
id|module_exit
c_func
(paren
id|alsa_card_es1968_exit
)paren
macro_line|#ifndef MODULE
multiline_comment|/* format is: snd-es1968=snd_enable,snd_index,snd_id,&n;&t;&t;&t; snd_total_bufsize,&n;&t;&t;&t; snd_pcm_substreams_p,&n;&t;&t;&t; snd_pcm_substreams_c,&n;&t;&t;&t; snd_clock&n;*/
DECL|function|alsa_card_es1968_setup
r_static
r_int
id|__init
id|alsa_card_es1968_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_static
r_int
id|__initdata
id|nr_dev
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nr_dev
op_ge
id|SNDRV_CARDS
)paren
r_return
l_int|0
suffix:semicolon
(paren
r_void
)paren
(paren
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|snd_enable
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|snd_index
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_id
c_func
(paren
op_amp
id|str
comma
op_amp
id|snd_id
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|snd_total_bufsize
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|snd_pcm_substreams_p
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|snd_pcm_substreams_c
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
op_logical_and
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|snd_clock
(braket
id|nr_dev
)braket
)paren
op_eq
l_int|2
)paren
suffix:semicolon
id|nr_dev
op_increment
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;snd-es1968=&quot;
comma
id|alsa_card_es1968_setup
)paren
suffix:semicolon
macro_line|#endif /* ifndef MODULE */
eof
