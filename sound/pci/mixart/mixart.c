multiline_comment|/*&n; * Driver for Digigram miXart soundcards&n; *&n; * main file with alsa callbacks&n; *&n; * Copyright (c) 2003 by Digigram &lt;alsa@digigram.com&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/initval.h&gt;
macro_line|#include &lt;sound/info.h&gt;
macro_line|#include &lt;sound/control.h&gt;
macro_line|#include &lt;sound/pcm.h&gt;
macro_line|#include &lt;sound/pcm_params.h&gt;
macro_line|#include &quot;mixart.h&quot;
macro_line|#include &quot;mixart_hwdep.h&quot;
macro_line|#include &quot;mixart_core.h&quot;
macro_line|#include &quot;mixart_mixer.h&quot;
DECL|macro|CARD_NAME
mdefine_line|#define CARD_NAME &quot;miXart&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Digigram &lt;alsa@digigram.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Digigram &quot;
id|CARD_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;{{Digigram,&quot;
id|CARD_NAME
l_string|&quot;}}&quot;
)paren
suffix:semicolon
DECL|variable|index
r_static
r_int
id|index
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_IDX
suffix:semicolon
multiline_comment|/* Index 0-MAX */
DECL|variable|id
r_static
r_char
op_star
id|id
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_STR
suffix:semicolon
multiline_comment|/* ID for this card */
DECL|variable|enable
r_static
r_int
id|enable
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_ENABLE_PNP
suffix:semicolon
multiline_comment|/* Enable this card */
DECL|variable|boot_devs
r_static
r_int
id|boot_devs
suffix:semicolon
id|module_param_array
c_func
(paren
id|index
comma
r_int
comma
id|boot_devs
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|index
comma
l_string|&quot;Index value for Digigram &quot;
id|CARD_NAME
l_string|&quot; soundcard.&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|id
comma
id|charp
comma
id|boot_devs
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|id
comma
l_string|&quot;ID string for Digigram &quot;
id|CARD_NAME
l_string|&quot; soundcard.&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|enable
comma
r_bool
comma
id|boot_devs
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|enable
comma
l_string|&quot;Enable Digigram &quot;
id|CARD_NAME
l_string|&quot; soundcard.&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; */
DECL|variable|snd_mixart_ids
r_static
r_struct
id|pci_device_id
id|snd_mixart_ids
(braket
)braket
op_assign
(brace
(brace
l_int|0x1057
comma
l_int|0x0003
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
)brace
comma
multiline_comment|/* MC8240 */
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|snd_mixart_ids
)paren
suffix:semicolon
DECL|function|mixart_set_pipe_state
r_static
r_int
id|mixart_set_pipe_state
c_func
(paren
id|mixart_mgr_t
op_star
id|mgr
comma
id|mixart_pipe_t
op_star
id|pipe
comma
r_int
id|start
)paren
(brace
id|mixart_group_state_req_t
id|group_state
suffix:semicolon
id|mixart_group_state_resp_t
id|group_state_resp
suffix:semicolon
id|mixart_msg_t
id|request
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u32
id|system_msg_uid
suffix:semicolon
r_switch
c_cond
(paren
id|pipe-&gt;status
)paren
(brace
r_case
id|PIPE_RUNNING
suffix:colon
r_case
id|PIPE_CLOCK_SET
suffix:colon
r_if
c_cond
(paren
id|start
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* already started */
r_break
suffix:semicolon
r_case
id|PIPE_STOPPED
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|start
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* already stopped */
r_break
suffix:semicolon
r_default
suffix:colon
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error mixart_set_pipe_state called with wrong pipe-&gt;status!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* function called with wrong pipe status */
)brace
id|system_msg_uid
op_assign
l_int|0x12345678
suffix:semicolon
multiline_comment|/* the event ! (take care: the MSB and two LSB&squot;s have to be 0) */
multiline_comment|/* wait on the last MSG_SYSTEM_SEND_SYNCHRO_CMD command to be really finished */
id|request.message_id
op_assign
id|MSG_SYSTEM_WAIT_SYNCHRO_CMD
suffix:semicolon
id|request.uid
op_assign
(paren
id|mixart_uid_t
)paren
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|request.data
op_assign
op_amp
id|system_msg_uid
suffix:semicolon
id|request.size
op_assign
r_sizeof
(paren
id|system_msg_uid
)paren
suffix:semicolon
id|err
op_assign
id|snd_mixart_send_msg_wait_notif
c_func
(paren
id|mgr
comma
op_amp
id|request
comma
id|system_msg_uid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error : MSG_SYSTEM_WAIT_SYNCHRO_CMD was not notified !&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* start or stop the pipe (1 pipe) */
id|memset
c_func
(paren
op_amp
id|group_state
comma
l_int|0
comma
r_sizeof
(paren
id|group_state
)paren
)paren
suffix:semicolon
id|group_state.pipe_count
op_assign
l_int|1
suffix:semicolon
id|group_state.pipe_uid
(braket
l_int|0
)braket
op_assign
id|pipe-&gt;group_uid
suffix:semicolon
r_if
c_cond
(paren
id|start
)paren
(brace
id|request.message_id
op_assign
id|MSG_STREAM_START_STREAM_GRP_PACKET
suffix:semicolon
)brace
r_else
id|request.message_id
op_assign
id|MSG_STREAM_STOP_STREAM_GRP_PACKET
suffix:semicolon
id|request.uid
op_assign
id|pipe-&gt;group_uid
suffix:semicolon
multiline_comment|/*(mixart_uid_t){0,0};*/
id|request.data
op_assign
op_amp
id|group_state
suffix:semicolon
id|request.size
op_assign
r_sizeof
(paren
id|group_state
)paren
suffix:semicolon
id|err
op_assign
id|snd_mixart_send_msg
c_func
(paren
id|mgr
comma
op_amp
id|request
comma
r_sizeof
(paren
id|group_state_resp
)paren
comma
op_amp
id|group_state_resp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
op_logical_or
id|group_state_resp.txx_status
op_ne
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error MSG_STREAM_ST***_STREAM_GRP_PACKET err=%x stat=%x !&bslash;n&quot;
comma
id|err
comma
id|group_state_resp.txx_status
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start
)paren
(brace
id|u32
id|stat
suffix:semicolon
id|group_state.pipe_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* in case of start same command once again with pipe_count=0 */
id|err
op_assign
id|snd_mixart_send_msg
c_func
(paren
id|mgr
comma
op_amp
id|request
comma
r_sizeof
(paren
id|group_state_resp
)paren
comma
op_amp
id|group_state_resp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
op_logical_or
id|group_state_resp.txx_status
op_ne
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error MSG_STREAM_START_STREAM_GRP_PACKET err=%x stat=%x !&bslash;n&quot;
comma
id|err
comma
id|group_state_resp.txx_status
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* in case of start send a synchro top */
id|request.message_id
op_assign
id|MSG_SYSTEM_SEND_SYNCHRO_CMD
suffix:semicolon
id|request.uid
op_assign
(paren
id|mixart_uid_t
)paren
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|request.data
op_assign
l_int|NULL
suffix:semicolon
id|request.size
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|snd_mixart_send_msg
c_func
(paren
id|mgr
comma
op_amp
id|request
comma
r_sizeof
(paren
id|stat
)paren
comma
op_amp
id|stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
op_logical_or
id|stat
op_ne
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error MSG_SYSTEM_SEND_SYNCHRO_CMD err=%x stat=%x !&bslash;n&quot;
comma
id|err
comma
id|stat
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pipe-&gt;status
op_assign
id|PIPE_RUNNING
suffix:semicolon
)brace
r_else
multiline_comment|/* !start */
id|pipe-&gt;status
op_assign
id|PIPE_STOPPED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mixart_set_clock
r_static
r_int
id|mixart_set_clock
c_func
(paren
id|mixart_mgr_t
op_star
id|mgr
comma
id|mixart_pipe_t
op_star
id|pipe
comma
r_int
r_int
id|rate
)paren
(brace
id|mixart_msg_t
id|request
suffix:semicolon
id|mixart_clock_properties_t
id|clock_properties
suffix:semicolon
id|mixart_clock_properties_resp_t
id|clock_prop_resp
suffix:semicolon
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|pipe-&gt;status
)paren
(brace
r_case
id|PIPE_CLOCK_SET
suffix:colon
r_break
suffix:semicolon
r_case
id|PIPE_RUNNING
suffix:colon
r_if
c_cond
(paren
id|rate
op_ne
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|rate
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* nothing to do */
r_else
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error mixart_set_clock(%d) called with wrong pipe-&gt;status !&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
op_amp
id|clock_properties
comma
l_int|0
comma
r_sizeof
(paren
id|clock_properties
)paren
)paren
suffix:semicolon
id|clock_properties.clock_generic_type
op_assign
(paren
id|rate
op_ne
l_int|0
)paren
ques
c_cond
id|CGT_INTERNAL_CLOCK
suffix:colon
id|CGT_NO_CLOCK
suffix:semicolon
id|clock_properties.clock_mode
op_assign
id|CM_STANDALONE
suffix:semicolon
id|clock_properties.frequency
op_assign
id|rate
suffix:semicolon
id|clock_properties.nb_callers
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* only one entry in uid_caller ! */
id|clock_properties.uid_caller
(braket
l_int|0
)braket
op_assign
id|pipe-&gt;group_uid
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;mixart_set_clock to %d kHz&bslash;n&quot;
comma
id|rate
)paren
suffix:semicolon
id|request.message_id
op_assign
id|MSG_CLOCK_SET_PROPERTIES
suffix:semicolon
id|request.uid
op_assign
id|mgr-&gt;uid_console_manager
suffix:semicolon
id|request.data
op_assign
op_amp
id|clock_properties
suffix:semicolon
id|request.size
op_assign
r_sizeof
(paren
id|clock_properties
)paren
suffix:semicolon
id|err
op_assign
id|snd_mixart_send_msg
c_func
(paren
id|mgr
comma
op_amp
id|request
comma
r_sizeof
(paren
id|clock_prop_resp
)paren
comma
op_amp
id|clock_prop_resp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
op_logical_or
id|clock_prop_resp.status
op_ne
l_int|0
op_logical_or
id|clock_prop_resp.clock_mode
op_ne
id|CM_STANDALONE
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error MSG_CLOCK_SET_PROPERTIES err=%x stat=%x mod=%x !&bslash;n&quot;
comma
id|err
comma
id|clock_prop_resp.status
comma
id|clock_prop_resp.clock_mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rate
)paren
(brace
id|pipe-&gt;status
op_assign
id|PIPE_CLOCK_SET
suffix:semicolon
)brace
r_else
id|pipe-&gt;status
op_assign
id|PIPE_RUNNING
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  Allocate or reference output pipe for analog IOs (pcmp0/1)&n; */
DECL|function|snd_mixart_add_ref_pipe
id|mixart_pipe_t
op_star
id|snd_mixart_add_ref_pipe
c_func
(paren
id|mixart_t
op_star
id|chip
comma
r_int
id|pcm_number
comma
r_int
id|capture
comma
r_int
id|monitoring
)paren
(brace
r_int
id|stream_count
suffix:semicolon
id|mixart_pipe_t
op_star
id|pipe
suffix:semicolon
id|mixart_msg_t
id|request
suffix:semicolon
r_if
c_cond
(paren
id|capture
)paren
(brace
r_if
c_cond
(paren
id|pcm_number
op_eq
id|MIXART_PCM_ANALOG
)paren
(brace
id|pipe
op_assign
op_amp
(paren
id|chip-&gt;pipe_in_ana
)paren
suffix:semicolon
multiline_comment|/* analog inputs */
)brace
r_else
(brace
id|pipe
op_assign
op_amp
(paren
id|chip-&gt;pipe_in_dig
)paren
suffix:semicolon
multiline_comment|/* digital inputs */
)brace
id|request.message_id
op_assign
id|MSG_STREAM_ADD_OUTPUT_GROUP
suffix:semicolon
id|stream_count
op_assign
id|MIXART_CAPTURE_STREAMS
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pcm_number
op_eq
id|MIXART_PCM_ANALOG
)paren
(brace
id|pipe
op_assign
op_amp
(paren
id|chip-&gt;pipe_out_ana
)paren
suffix:semicolon
multiline_comment|/* analog outputs */
)brace
r_else
(brace
id|pipe
op_assign
op_amp
(paren
id|chip-&gt;pipe_out_dig
)paren
suffix:semicolon
multiline_comment|/* digital outputs */
)brace
id|request.message_id
op_assign
id|MSG_STREAM_ADD_INPUT_GROUP
suffix:semicolon
id|stream_count
op_assign
id|MIXART_PLAYBACK_STREAMS
suffix:semicolon
)brace
multiline_comment|/* a new stream is opened and there are already all streams in use */
r_if
c_cond
(paren
(paren
id|monitoring
op_eq
l_int|0
)paren
op_logical_and
(paren
id|pipe-&gt;references
op_ge
id|stream_count
)paren
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* pipe is not yet defined */
r_if
c_cond
(paren
id|pipe-&gt;status
op_eq
id|PIPE_UNDEFINED
)paren
(brace
r_int
id|err
comma
id|i
suffix:semicolon
r_struct
(brace
id|mixart_streaming_group_req_t
id|sgroup_req
suffix:semicolon
id|mixart_streaming_group_t
id|sgroup_resp
suffix:semicolon
)brace
op_star
id|buf
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;add_ref_pipe audio chip(%d) pcm(%d)&bslash;n&quot;
comma
id|chip-&gt;chip_idx
comma
id|pcm_number
)paren
suffix:semicolon
id|buf
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|buf
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
l_int|NULL
suffix:semicolon
id|request.uid
op_assign
(paren
id|mixart_uid_t
)paren
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* should be StreamManagerUID, but zero is OK if there is only one ! */
id|request.data
op_assign
op_amp
id|buf-&gt;sgroup_req
suffix:semicolon
id|request.size
op_assign
r_sizeof
(paren
id|buf-&gt;sgroup_req
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|buf-&gt;sgroup_req
comma
l_int|0
comma
r_sizeof
(paren
id|buf-&gt;sgroup_req
)paren
)paren
suffix:semicolon
id|buf-&gt;sgroup_req.stream_count
op_assign
id|stream_count
suffix:semicolon
id|buf-&gt;sgroup_req.channel_count
op_assign
l_int|2
suffix:semicolon
id|buf-&gt;sgroup_req.latency
op_assign
l_int|256
suffix:semicolon
id|buf-&gt;sgroup_req.connector
op_assign
id|pipe-&gt;uid_left_connector
suffix:semicolon
multiline_comment|/* the left connector */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|stream_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|j
suffix:semicolon
r_struct
id|mixart_flowinfo
op_star
id|flowinfo
suffix:semicolon
r_struct
id|mixart_bufferinfo
op_star
id|bufferinfo
suffix:semicolon
multiline_comment|/* we don&squot;t yet know the format, so config 16 bit pcm audio for instance */
id|buf-&gt;sgroup_req.stream_info
(braket
id|i
)braket
dot
id|size_max_byte_frame
op_assign
l_int|1024
suffix:semicolon
id|buf-&gt;sgroup_req.stream_info
(braket
id|i
)braket
dot
id|size_max_sample_frame
op_assign
l_int|256
suffix:semicolon
id|buf-&gt;sgroup_req.stream_info
(braket
id|i
)braket
dot
id|nb_bytes_max_per_sample
op_assign
id|MIXART_FLOAT_P__4_0_TO_HEX
suffix:semicolon
multiline_comment|/* is 4.0f */
multiline_comment|/* find the right bufferinfo_array */
id|j
op_assign
(paren
id|chip-&gt;chip_idx
op_star
id|MIXART_MAX_STREAM_PER_CARD
)paren
op_plus
(paren
id|pcm_number
op_star
(paren
id|MIXART_PLAYBACK_STREAMS
op_plus
id|MIXART_CAPTURE_STREAMS
)paren
)paren
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|capture
)paren
(brace
id|j
op_add_assign
id|MIXART_PLAYBACK_STREAMS
suffix:semicolon
)brace
multiline_comment|/* in the array capture is behind playback */
id|buf-&gt;sgroup_req.flow_entry
(braket
id|i
)braket
op_assign
id|j
suffix:semicolon
id|flowinfo
op_assign
(paren
r_struct
id|mixart_flowinfo
op_star
)paren
id|chip-&gt;mgr-&gt;flowinfo.area
suffix:semicolon
id|flowinfo
(braket
id|j
)braket
dot
id|bufferinfo_array_phy_address
op_assign
(paren
id|u32
)paren
id|chip-&gt;mgr-&gt;bufferinfo.addr
op_plus
(paren
id|j
op_star
r_sizeof
(paren
id|mixart_bufferinfo_t
)paren
)paren
suffix:semicolon
id|flowinfo
(braket
id|j
)braket
dot
id|bufferinfo_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 will set the miXart to ring-buffer mode ! */
id|bufferinfo
op_assign
(paren
r_struct
id|mixart_bufferinfo
op_star
)paren
id|chip-&gt;mgr-&gt;bufferinfo.area
suffix:semicolon
id|bufferinfo
(braket
id|j
)braket
dot
id|buffer_address
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* buffer is not yet allocated */
id|bufferinfo
(braket
id|j
)braket
dot
id|available_length
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* buffer is not yet allocated */
multiline_comment|/* construct the identifier of the stream buffer received in the interrupts ! */
id|bufferinfo
(braket
id|j
)braket
dot
id|buffer_id
op_assign
(paren
id|chip-&gt;chip_idx
op_lshift
id|MIXART_NOTIFY_CARD_OFFSET
)paren
op_plus
(paren
id|pcm_number
op_lshift
id|MIXART_NOTIFY_PCM_OFFSET
)paren
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|capture
)paren
(brace
id|bufferinfo
(braket
id|j
)braket
dot
id|buffer_id
op_or_assign
id|MIXART_NOTIFY_CAPT_MASK
suffix:semicolon
)brace
)brace
id|err
op_assign
id|snd_mixart_send_msg
c_func
(paren
id|chip-&gt;mgr
comma
op_amp
id|request
comma
r_sizeof
(paren
id|buf-&gt;sgroup_resp
)paren
comma
op_amp
id|buf-&gt;sgroup_resp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
OL
l_int|0
)paren
op_logical_or
(paren
id|buf-&gt;sgroup_resp.status
op_ne
l_int|0
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error MSG_STREAM_ADD_**PUT_GROUP err=%x stat=%x !&bslash;n&quot;
comma
id|err
comma
id|buf-&gt;sgroup_resp.status
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|pipe-&gt;group_uid
op_assign
id|buf-&gt;sgroup_resp.group
suffix:semicolon
multiline_comment|/* id of the pipe, as returned by embedded */
id|pipe-&gt;stream_count
op_assign
id|buf-&gt;sgroup_resp.stream_count
suffix:semicolon
multiline_comment|/* pipe-&gt;stream_uid[i] = buf-&gt;sgroup_resp.stream[i].stream_uid; */
id|pipe-&gt;status
op_assign
id|PIPE_STOPPED
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|monitoring
)paren
(brace
id|pipe-&gt;monitoring
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|pipe-&gt;references
op_increment
suffix:semicolon
r_return
id|pipe
suffix:semicolon
)brace
DECL|function|snd_mixart_kill_ref_pipe
r_int
id|snd_mixart_kill_ref_pipe
c_func
(paren
id|mixart_mgr_t
op_star
id|mgr
comma
id|mixart_pipe_t
op_star
id|pipe
comma
r_int
id|monitoring
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pipe-&gt;status
op_eq
id|PIPE_UNDEFINED
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|monitoring
)paren
(brace
id|pipe-&gt;monitoring
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|pipe-&gt;references
op_decrement
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pipe-&gt;references
op_le
l_int|0
)paren
op_logical_and
(paren
id|pipe-&gt;monitoring
op_eq
l_int|0
)paren
)paren
(brace
id|mixart_msg_t
id|request
suffix:semicolon
id|mixart_delete_group_resp_t
id|delete_resp
suffix:semicolon
multiline_comment|/* release the clock */
id|err
op_assign
id|mixart_set_clock
c_func
(paren
id|mgr
comma
id|pipe
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mixart_set_clock(0) return error!&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* stop the pipe */
id|err
op_assign
id|mixart_set_pipe_state
c_func
(paren
id|mgr
comma
id|pipe
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error stopping pipe!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|request.message_id
op_assign
id|MSG_STREAM_DELETE_GROUP
suffix:semicolon
id|request.uid
op_assign
(paren
id|mixart_uid_t
)paren
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|request.data
op_assign
op_amp
id|pipe-&gt;group_uid
suffix:semicolon
multiline_comment|/* the streaming group ! */
id|request.size
op_assign
r_sizeof
(paren
id|pipe-&gt;group_uid
)paren
suffix:semicolon
multiline_comment|/* delete the pipe */
id|err
op_assign
id|snd_mixart_send_msg
c_func
(paren
id|mgr
comma
op_amp
id|request
comma
r_sizeof
(paren
id|delete_resp
)paren
comma
op_amp
id|delete_resp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
OL
l_int|0
)paren
op_logical_or
(paren
id|delete_resp.status
op_ne
l_int|0
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error MSG_STREAM_DELETE_GROUP err(%x), status(%x)&bslash;n&quot;
comma
id|err
comma
id|delete_resp.status
)paren
suffix:semicolon
)brace
id|pipe-&gt;group_uid
op_assign
(paren
id|mixart_uid_t
)paren
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|pipe-&gt;stream_count
op_assign
l_int|0
suffix:semicolon
id|pipe-&gt;status
op_assign
id|PIPE_UNDEFINED
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|mixart_set_stream_state
r_static
r_int
id|mixart_set_stream_state
c_func
(paren
id|mixart_stream_t
op_star
id|stream
comma
r_int
id|start
)paren
(brace
id|mixart_t
op_star
id|chip
suffix:semicolon
id|mixart_stream_state_req_t
id|stream_state_req
suffix:semicolon
id|mixart_msg_t
id|request
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stream-&gt;substream
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|stream_state_req
comma
l_int|0
comma
r_sizeof
(paren
id|stream_state_req
)paren
)paren
suffix:semicolon
id|stream_state_req.stream_count
op_assign
l_int|1
suffix:semicolon
id|stream_state_req.stream_info.stream_desc.uid_pipe
op_assign
id|stream-&gt;pipe-&gt;group_uid
suffix:semicolon
id|stream_state_req.stream_info.stream_desc.stream_idx
op_assign
id|stream-&gt;substream-&gt;number
suffix:semicolon
r_if
c_cond
(paren
id|stream-&gt;substream-&gt;stream
op_eq
id|SNDRV_PCM_STREAM_PLAYBACK
)paren
id|request.message_id
op_assign
id|start
ques
c_cond
id|MSG_STREAM_START_INPUT_STAGE_PACKET
suffix:colon
id|MSG_STREAM_STOP_INPUT_STAGE_PACKET
suffix:semicolon
r_else
id|request.message_id
op_assign
id|start
ques
c_cond
id|MSG_STREAM_START_OUTPUT_STAGE_PACKET
suffix:colon
id|MSG_STREAM_STOP_OUTPUT_STAGE_PACKET
suffix:semicolon
id|request.uid
op_assign
(paren
id|mixart_uid_t
)paren
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|request.data
op_assign
op_amp
id|stream_state_req
suffix:semicolon
id|request.size
op_assign
r_sizeof
(paren
id|stream_state_req
)paren
suffix:semicolon
id|stream-&gt;abs_period_elapsed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset stream pos      */
id|stream-&gt;buf_periods
op_assign
l_int|0
suffix:semicolon
id|stream-&gt;buf_period_frag
op_assign
l_int|0
suffix:semicolon
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|stream-&gt;substream
)paren
suffix:semicolon
r_return
id|snd_mixart_send_msg_nonblock
c_func
(paren
id|chip-&gt;mgr
comma
op_amp
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  Trigger callback&n; */
DECL|function|snd_mixart_trigger
r_static
r_int
id|snd_mixart_trigger
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
comma
r_int
id|cmd
)paren
(brace
id|mixart_stream_t
op_star
id|stream
op_assign
(paren
id|mixart_stream_t
op_star
)paren
id|subs-&gt;runtime-&gt;private_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_PCM_TRIGGER_START
suffix:colon
id|snd_printdd
c_func
(paren
l_string|&quot;SNDRV_PCM_TRIGGER_START&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* START_STREAM */
r_if
c_cond
(paren
id|mixart_set_stream_state
c_func
(paren
id|stream
comma
l_int|1
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|stream-&gt;status
op_assign
id|MIXART_STREAM_STATUS_RUNNING
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_STOP
suffix:colon
multiline_comment|/* STOP_STREAM */
r_if
c_cond
(paren
id|mixart_set_stream_state
c_func
(paren
id|stream
comma
l_int|0
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|stream-&gt;status
op_assign
id|MIXART_STREAM_STATUS_OPEN
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;SNDRV_PCM_TRIGGER_STOP&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_PAUSE_PUSH
suffix:colon
multiline_comment|/* TODO */
id|stream-&gt;status
op_assign
id|MIXART_STREAM_STATUS_PAUSE
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;SNDRV_PCM_PAUSE_PUSH&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_PAUSE_RELEASE
suffix:colon
multiline_comment|/* TODO */
id|stream-&gt;status
op_assign
id|MIXART_STREAM_STATUS_RUNNING
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;SNDRV_PCM_PAUSE_RELEASE&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mixart_sync_nonblock_events
r_static
r_int
id|mixart_sync_nonblock_events
c_func
(paren
id|mixart_mgr_t
op_star
id|mgr
)paren
(brace
r_int
id|timeout
op_assign
id|HZ
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|mgr-&gt;msg_processed
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|timeout
op_decrement
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mixart: cannot process nonblock events!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  prepare callback for all pcms&n; */
DECL|function|snd_mixart_prepare
r_static
r_int
id|snd_mixart_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|mixart_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
id|mixart_stream_t
op_star
id|stream
op_assign
(paren
id|mixart_stream_t
op_star
)paren
id|subs-&gt;runtime-&gt;private_data
suffix:semicolon
multiline_comment|/* TODO de fa&#xfffd;on non bloquante, r&#xfffd;appliquer les hw_params (rate, bits, codec) */
id|snd_printdd
c_func
(paren
l_string|&quot;snd_mixart_prepare&bslash;n&quot;
)paren
suffix:semicolon
id|mixart_sync_nonblock_events
c_func
(paren
id|chip-&gt;mgr
)paren
suffix:semicolon
multiline_comment|/* only the first stream can choose the sample rate */
multiline_comment|/* the further opened streams will be limited to its frequency (see open) */
r_if
c_cond
(paren
id|chip-&gt;mgr-&gt;ref_count_rate
op_eq
l_int|1
)paren
(brace
id|chip-&gt;mgr-&gt;sample_rate
op_assign
id|subs-&gt;runtime-&gt;rate
suffix:semicolon
)brace
multiline_comment|/* set the clock only once (first stream) on the same pipe */
r_if
c_cond
(paren
id|stream-&gt;pipe-&gt;references
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|mixart_set_clock
c_func
(paren
id|chip-&gt;mgr
comma
id|stream-&gt;pipe
comma
id|subs-&gt;runtime-&gt;rate
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mixart_set_format
r_static
r_int
id|mixart_set_format
c_func
(paren
id|mixart_stream_t
op_star
id|stream
comma
id|snd_pcm_format_t
id|format
)paren
(brace
r_int
id|err
suffix:semicolon
id|mixart_t
op_star
id|chip
suffix:semicolon
id|mixart_msg_t
id|request
suffix:semicolon
id|mixart_stream_param_desc_t
id|stream_param
suffix:semicolon
id|mixart_return_uid_t
id|resp
suffix:semicolon
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|stream-&gt;substream
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|stream_param
comma
l_int|0
comma
r_sizeof
(paren
id|stream_param
)paren
)paren
suffix:semicolon
id|stream_param.coding_type
op_assign
id|CT_LINEAR
suffix:semicolon
id|stream_param.number_of_channel
op_assign
id|stream-&gt;channels
suffix:semicolon
id|stream_param.sampling_freq
op_assign
id|chip-&gt;mgr-&gt;sample_rate
suffix:semicolon
r_if
c_cond
(paren
id|stream_param.sampling_freq
op_eq
l_int|0
)paren
(brace
id|stream_param.sampling_freq
op_assign
l_int|44100
suffix:semicolon
)brace
multiline_comment|/* if frequency not yet defined, use some default */
r_switch
c_cond
(paren
id|format
)paren
(brace
r_case
id|SNDRV_PCM_FORMAT_U8
suffix:colon
id|stream_param.sample_type
op_assign
id|ST_INTEGER_8
suffix:semicolon
id|stream_param.sample_size
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_FORMAT_S16_LE
suffix:colon
id|stream_param.sample_type
op_assign
id|ST_INTEGER_16LE
suffix:semicolon
id|stream_param.sample_size
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_FORMAT_S16_BE
suffix:colon
id|stream_param.sample_type
op_assign
id|ST_INTEGER_16BE
suffix:semicolon
id|stream_param.sample_size
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_FORMAT_S24_3LE
suffix:colon
id|stream_param.sample_type
op_assign
id|ST_INTEGER_24LE
suffix:semicolon
id|stream_param.sample_size
op_assign
l_int|24
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_FORMAT_S24_3BE
suffix:colon
id|stream_param.sample_type
op_assign
id|ST_INTEGER_24BE
suffix:semicolon
id|stream_param.sample_size
op_assign
l_int|24
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_FMTBIT_FLOAT_LE
suffix:colon
id|stream_param.sample_type
op_assign
id|ST_FLOATING_POINT_32LE
suffix:semicolon
id|stream_param.sample_size
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_FMTBIT_FLOAT_BE
suffix:colon
id|stream_param.sample_type
op_assign
id|ST_FLOATING_POINT_32BE
suffix:semicolon
id|stream_param.sample_size
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error mixart_set_format() : unknown format&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|snd_printdd
c_func
(paren
l_string|&quot;set SNDRV_PCM_FORMAT sample_type(%d) sample_size(%d) freq(%d) channels(%d)&bslash;n&quot;
comma
id|stream_param.sample_type
comma
id|stream_param.sample_size
comma
id|stream_param.sampling_freq
comma
id|stream-&gt;channels
)paren
suffix:semicolon
multiline_comment|/* TODO: what else to configure ? */
multiline_comment|/* stream_param.samples_per_frame = 2; */
multiline_comment|/* stream_param.bytes_per_frame = 4; */
multiline_comment|/* stream_param.bytes_per_sample = 2; */
id|stream_param.pipe_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set to 1 */
id|stream_param.stream_count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set to 1 */
id|stream_param.stream_desc
(braket
l_int|0
)braket
dot
id|uid_pipe
op_assign
id|stream-&gt;pipe-&gt;group_uid
suffix:semicolon
id|stream_param.stream_desc
(braket
l_int|0
)braket
dot
id|stream_idx
op_assign
id|stream-&gt;substream-&gt;number
suffix:semicolon
id|request.message_id
op_assign
id|MSG_STREAM_SET_INPUT_STAGE_PARAM
suffix:semicolon
id|request.uid
op_assign
(paren
id|mixart_uid_t
)paren
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|request.data
op_assign
op_amp
id|stream_param
suffix:semicolon
id|request.size
op_assign
r_sizeof
(paren
id|stream_param
)paren
suffix:semicolon
id|err
op_assign
id|snd_mixart_send_msg
c_func
(paren
id|chip-&gt;mgr
comma
op_amp
id|request
comma
r_sizeof
(paren
id|resp
)paren
comma
op_amp
id|resp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
OL
l_int|0
)paren
op_logical_or
id|resp.error_code
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MSG_STREAM_SET_INPUT_STAGE_PARAM err=%x; resp=%x&bslash;n&quot;
comma
id|err
comma
id|resp.error_code
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  HW_PARAMS callback for all pcms&n; */
DECL|function|snd_mixart_hw_params
r_static
r_int
id|snd_mixart_hw_params
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
comma
id|snd_pcm_hw_params_t
op_star
id|hw
)paren
(brace
id|mixart_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
id|mixart_mgr_t
op_star
id|mgr
op_assign
id|chip-&gt;mgr
suffix:semicolon
id|mixart_stream_t
op_star
id|stream
op_assign
(paren
id|mixart_stream_t
op_star
)paren
id|subs-&gt;runtime-&gt;private_data
suffix:semicolon
id|snd_pcm_format_t
id|format
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|channels
suffix:semicolon
multiline_comment|/* set up channels */
id|channels
op_assign
id|params_channels
c_func
(paren
id|hw
)paren
suffix:semicolon
multiline_comment|/*  set up format for the stream */
id|format
op_assign
id|params_format
c_func
(paren
id|hw
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
multiline_comment|/* update the stream levels */
r_if
c_cond
(paren
id|stream-&gt;pcm_number
op_le
id|MIXART_PCM_DIGITAL
)paren
(brace
r_int
id|is_aes
op_assign
id|stream-&gt;pcm_number
OG
id|MIXART_PCM_ANALOG
suffix:semicolon
r_if
c_cond
(paren
id|subs-&gt;stream
op_eq
id|SNDRV_PCM_STREAM_PLAYBACK
)paren
(brace
id|mixart_update_playback_stream_level
c_func
(paren
id|chip
comma
id|is_aes
comma
id|subs-&gt;number
)paren
suffix:semicolon
)brace
r_else
id|mixart_update_capture_stream_level
c_func
(paren
id|chip
comma
id|is_aes
)paren
suffix:semicolon
)brace
id|stream-&gt;channels
op_assign
id|channels
suffix:semicolon
multiline_comment|/* set the format to the board */
id|err
op_assign
id|mixart_set_format
c_func
(paren
id|stream
comma
id|format
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* allocate buffer */
id|err
op_assign
id|snd_pcm_lib_malloc_pages
c_func
(paren
id|subs
comma
id|params_buffer_bytes
c_func
(paren
id|hw
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
r_struct
id|mixart_bufferinfo
op_star
id|bufferinfo
suffix:semicolon
r_int
id|i
op_assign
(paren
id|chip-&gt;chip_idx
op_star
id|MIXART_MAX_STREAM_PER_CARD
)paren
op_plus
(paren
id|stream-&gt;pcm_number
op_star
(paren
id|MIXART_PLAYBACK_STREAMS
op_plus
id|MIXART_CAPTURE_STREAMS
)paren
)paren
op_plus
id|subs-&gt;number
suffix:semicolon
r_if
c_cond
(paren
id|subs-&gt;stream
op_eq
id|SNDRV_PCM_STREAM_CAPTURE
)paren
(brace
id|i
op_add_assign
id|MIXART_PLAYBACK_STREAMS
suffix:semicolon
multiline_comment|/* in array capture is behind playback */
)brace
id|bufferinfo
op_assign
(paren
r_struct
id|mixart_bufferinfo
op_star
)paren
id|chip-&gt;mgr-&gt;bufferinfo.area
suffix:semicolon
id|bufferinfo
(braket
id|i
)braket
dot
id|buffer_address
op_assign
id|subs-&gt;runtime-&gt;dma_addr
suffix:semicolon
id|bufferinfo
(braket
id|i
)braket
dot
id|available_length
op_assign
id|subs-&gt;runtime-&gt;dma_bytes
suffix:semicolon
multiline_comment|/* bufferinfo[i].buffer_id  is already defined */
id|snd_printdd
c_func
(paren
l_string|&quot;snd_mixart_hw_params(pcm %d) : dma_addr(%x) dma_bytes(%x) subs-number(%d)&bslash;n&quot;
comma
id|i
comma
id|subs-&gt;runtime-&gt;dma_addr
comma
id|subs-&gt;runtime-&gt;dma_bytes
comma
id|subs-&gt;number
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|snd_mixart_hw_free
r_static
r_int
id|snd_mixart_hw_free
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|mixart_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
id|snd_pcm_lib_free_pages
c_func
(paren
id|subs
)paren
suffix:semicolon
id|mixart_sync_nonblock_events
c_func
(paren
id|chip-&gt;mgr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  TODO CONFIGURATION SPACE for all pcms, mono pcm must update channels_max&n; */
DECL|variable|snd_mixart_analog_caps
r_static
id|snd_pcm_hardware_t
id|snd_mixart_analog_caps
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_SYNC_START
op_or
id|SNDRV_PCM_INFO_PAUSE
)paren
comma
dot
id|formats
op_assign
(paren
id|SNDRV_PCM_FMTBIT_U8
op_or
id|SNDRV_PCM_FMTBIT_S16_LE
op_or
id|SNDRV_PCM_FMTBIT_S16_BE
op_or
id|SNDRV_PCM_FMTBIT_S24_3LE
op_or
id|SNDRV_PCM_FMTBIT_S24_3BE
op_or
id|SNDRV_PCM_FMTBIT_FLOAT_LE
op_or
id|SNDRV_PCM_FMTBIT_FLOAT_BE
)paren
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_CONTINUOUS
op_or
id|SNDRV_PCM_RATE_8000_48000
comma
dot
id|rate_min
op_assign
l_int|8000
comma
dot
id|rate_max
op_assign
l_int|48000
comma
dot
id|channels_min
op_assign
l_int|1
comma
dot
id|channels_max
op_assign
l_int|2
comma
dot
id|buffer_bytes_max
op_assign
(paren
l_int|32
op_star
l_int|1024
)paren
comma
dot
id|period_bytes_min
op_assign
l_int|256
comma
multiline_comment|/* 256 frames U8 mono*/
dot
id|period_bytes_max
op_assign
(paren
l_int|16
op_star
l_int|1024
)paren
comma
dot
id|periods_min
op_assign
l_int|2
comma
dot
id|periods_max
op_assign
(paren
l_int|32
op_star
l_int|1024
op_div
l_int|256
)paren
comma
)brace
suffix:semicolon
DECL|variable|snd_mixart_digital_caps
r_static
id|snd_pcm_hardware_t
id|snd_mixart_digital_caps
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_SYNC_START
op_or
id|SNDRV_PCM_INFO_PAUSE
)paren
comma
dot
id|formats
op_assign
(paren
id|SNDRV_PCM_FMTBIT_U8
op_or
id|SNDRV_PCM_FMTBIT_S16_LE
op_or
id|SNDRV_PCM_FMTBIT_S16_BE
op_or
id|SNDRV_PCM_FMTBIT_S24_3LE
op_or
id|SNDRV_PCM_FMTBIT_S24_3BE
op_or
id|SNDRV_PCM_FMTBIT_FLOAT_LE
op_or
id|SNDRV_PCM_FMTBIT_FLOAT_BE
)paren
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_32000
op_or
id|SNDRV_PCM_RATE_44100
op_or
id|SNDRV_PCM_RATE_48000
comma
dot
id|rate_min
op_assign
l_int|32000
comma
dot
id|rate_max
op_assign
l_int|48000
comma
dot
id|channels_min
op_assign
l_int|1
comma
dot
id|channels_max
op_assign
l_int|2
comma
dot
id|buffer_bytes_max
op_assign
(paren
l_int|32
op_star
l_int|1024
)paren
comma
dot
id|period_bytes_min
op_assign
l_int|256
comma
multiline_comment|/* 256 frames U8 mono*/
dot
id|period_bytes_max
op_assign
(paren
l_int|16
op_star
l_int|1024
)paren
comma
dot
id|periods_min
op_assign
l_int|2
comma
dot
id|periods_max
op_assign
(paren
l_int|32
op_star
l_int|1024
op_div
l_int|256
)paren
comma
)brace
suffix:semicolon
DECL|function|snd_mixart_playback_open
r_static
r_int
id|snd_mixart_playback_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|mixart_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
id|mixart_mgr_t
op_star
id|mgr
op_assign
id|chip-&gt;mgr
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;runtime
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
op_assign
id|subs-&gt;pcm
suffix:semicolon
id|mixart_stream_t
op_star
id|stream
suffix:semicolon
id|mixart_pipe_t
op_star
id|pipe
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|pcm_number
suffix:semicolon
id|down
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcm
op_eq
id|chip-&gt;pcm
)paren
(brace
id|pcm_number
op_assign
id|MIXART_PCM_ANALOG
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_mixart_analog_caps
suffix:semicolon
)brace
r_else
(brace
id|snd_assert
(paren
id|pcm
op_eq
id|chip-&gt;pcm_dig
)paren
suffix:semicolon
id|pcm_number
op_assign
id|MIXART_PCM_DIGITAL
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_mixart_digital_caps
suffix:semicolon
)brace
id|snd_printdd
c_func
(paren
l_string|&quot;snd_mixart_playback_open C%d/P%d/Sub%d&bslash;n&quot;
comma
id|chip-&gt;chip_idx
comma
id|pcm_number
comma
id|subs-&gt;number
)paren
suffix:semicolon
multiline_comment|/* get stream info */
id|stream
op_assign
op_amp
(paren
id|chip-&gt;playback_stream
(braket
id|pcm_number
)braket
(braket
id|subs-&gt;number
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stream-&gt;status
op_ne
id|MIXART_STREAM_STATUS_FREE
)paren
(brace
multiline_comment|/* streams in use */
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;snd_mixart_playback_open C%d/P%d/Sub%d in use&bslash;n&quot;
comma
id|chip-&gt;chip_idx
comma
id|pcm_number
comma
id|subs-&gt;number
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|_exit_open
suffix:semicolon
)brace
multiline_comment|/* get pipe pointer (out pipe) */
id|pipe
op_assign
id|snd_mixart_add_ref_pipe
c_func
(paren
id|chip
comma
id|pcm_number
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pipe
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|_exit_open
suffix:semicolon
)brace
multiline_comment|/* start the pipe if necessary */
id|err
op_assign
id|mixart_set_pipe_state
c_func
(paren
id|chip-&gt;mgr
comma
id|pipe
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error starting pipe!&bslash;n&quot;
)paren
suffix:semicolon
id|snd_mixart_kill_ref_pipe
c_func
(paren
id|chip-&gt;mgr
comma
id|pipe
comma
l_int|0
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|_exit_open
suffix:semicolon
)brace
id|stream-&gt;pipe
op_assign
id|pipe
suffix:semicolon
id|stream-&gt;pcm_number
op_assign
id|pcm_number
suffix:semicolon
id|stream-&gt;status
op_assign
id|MIXART_STREAM_STATUS_OPEN
suffix:semicolon
id|stream-&gt;substream
op_assign
id|subs
suffix:semicolon
id|stream-&gt;channels
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not configured yet */
id|runtime-&gt;private_data
op_assign
id|stream
suffix:semicolon
id|snd_pcm_hw_constraint_step
c_func
(paren
id|runtime
comma
l_int|0
comma
id|SNDRV_PCM_HW_PARAM_PERIOD_BYTES
comma
l_int|32
)paren
suffix:semicolon
id|snd_pcm_hw_constraint_step
c_func
(paren
id|runtime
comma
l_int|0
comma
id|SNDRV_PCM_HW_PARAM_BUFFER_SIZE
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* if a sample rate is already used, another stream cannot change */
r_if
c_cond
(paren
id|mgr-&gt;ref_count_rate
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mgr-&gt;sample_rate
)paren
(brace
id|runtime-&gt;hw.rate_min
op_assign
id|runtime-&gt;hw.rate_max
op_assign
id|mgr-&gt;sample_rate
suffix:semicolon
)brace
)brace
id|_exit_open
suffix:colon
id|up
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|snd_mixart_capture_open
r_static
r_int
id|snd_mixart_capture_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|mixart_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
id|mixart_mgr_t
op_star
id|mgr
op_assign
id|chip-&gt;mgr
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;runtime
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
op_assign
id|subs-&gt;pcm
suffix:semicolon
id|mixart_stream_t
op_star
id|stream
suffix:semicolon
id|mixart_pipe_t
op_star
id|pipe
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|pcm_number
suffix:semicolon
id|down
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcm
op_eq
id|chip-&gt;pcm
)paren
(brace
id|pcm_number
op_assign
id|MIXART_PCM_ANALOG
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_mixart_analog_caps
suffix:semicolon
)brace
r_else
(brace
id|snd_assert
(paren
id|pcm
op_eq
id|chip-&gt;pcm_dig
)paren
suffix:semicolon
id|pcm_number
op_assign
id|MIXART_PCM_DIGITAL
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_mixart_digital_caps
suffix:semicolon
)brace
id|runtime-&gt;hw.channels_min
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* for instance, no mono */
id|snd_printdd
c_func
(paren
l_string|&quot;snd_mixart_capture_open C%d/P%d/Sub%d&bslash;n&quot;
comma
id|chip-&gt;chip_idx
comma
id|pcm_number
comma
id|subs-&gt;number
)paren
suffix:semicolon
multiline_comment|/* get stream info */
id|stream
op_assign
op_amp
(paren
id|chip-&gt;capture_stream
(braket
id|pcm_number
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stream-&gt;status
op_ne
id|MIXART_STREAM_STATUS_FREE
)paren
(brace
multiline_comment|/* streams in use */
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;snd_mixart_capture_open C%d/P%d/Sub%d in use&bslash;n&quot;
comma
id|chip-&gt;chip_idx
comma
id|pcm_number
comma
id|subs-&gt;number
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|_exit_open
suffix:semicolon
)brace
multiline_comment|/* get pipe pointer (in pipe) */
id|pipe
op_assign
id|snd_mixart_add_ref_pipe
c_func
(paren
id|chip
comma
id|pcm_number
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pipe
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|_exit_open
suffix:semicolon
)brace
multiline_comment|/* start the pipe if necessary */
id|err
op_assign
id|mixart_set_pipe_state
c_func
(paren
id|chip-&gt;mgr
comma
id|pipe
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error starting pipe!&bslash;n&quot;
)paren
suffix:semicolon
id|snd_mixart_kill_ref_pipe
c_func
(paren
id|chip-&gt;mgr
comma
id|pipe
comma
l_int|0
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|_exit_open
suffix:semicolon
)brace
id|stream-&gt;pipe
op_assign
id|pipe
suffix:semicolon
id|stream-&gt;pcm_number
op_assign
id|pcm_number
suffix:semicolon
id|stream-&gt;status
op_assign
id|MIXART_STREAM_STATUS_OPEN
suffix:semicolon
id|stream-&gt;substream
op_assign
id|subs
suffix:semicolon
id|stream-&gt;channels
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* not configured yet */
id|runtime-&gt;private_data
op_assign
id|stream
suffix:semicolon
id|snd_pcm_hw_constraint_step
c_func
(paren
id|runtime
comma
l_int|0
comma
id|SNDRV_PCM_HW_PARAM_PERIOD_BYTES
comma
l_int|32
)paren
suffix:semicolon
id|snd_pcm_hw_constraint_step
c_func
(paren
id|runtime
comma
l_int|0
comma
id|SNDRV_PCM_HW_PARAM_BUFFER_SIZE
comma
l_int|64
)paren
suffix:semicolon
multiline_comment|/* if a sample rate is already used, another stream cannot change */
r_if
c_cond
(paren
id|mgr-&gt;ref_count_rate
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mgr-&gt;sample_rate
)paren
(brace
id|runtime-&gt;hw.rate_min
op_assign
id|runtime-&gt;hw.rate_max
op_assign
id|mgr-&gt;sample_rate
suffix:semicolon
)brace
)brace
id|_exit_open
suffix:colon
id|up
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|snd_mixart_close
r_static
r_int
id|snd_mixart_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|mixart_t
op_star
id|chip
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|subs
)paren
suffix:semicolon
id|mixart_mgr_t
op_star
id|mgr
op_assign
id|chip-&gt;mgr
suffix:semicolon
id|mixart_stream_t
op_star
id|stream
op_assign
(paren
id|mixart_stream_t
op_star
)paren
id|subs-&gt;runtime-&gt;private_data
suffix:semicolon
id|down
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;snd_mixart_close C%d/P%d/Sub%d&bslash;n&quot;
comma
id|chip-&gt;chip_idx
comma
id|stream-&gt;pcm_number
comma
id|subs-&gt;number
)paren
suffix:semicolon
multiline_comment|/* sample rate released */
r_if
c_cond
(paren
op_decrement
id|mgr-&gt;ref_count_rate
op_eq
l_int|0
)paren
(brace
id|mgr-&gt;sample_rate
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* delete pipe */
r_if
c_cond
(paren
id|snd_mixart_kill_ref_pipe
c_func
(paren
id|mgr
comma
id|stream-&gt;pipe
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;error snd_mixart_kill_ref_pipe C%dP%d&bslash;n&quot;
comma
id|chip-&gt;chip_idx
comma
id|stream-&gt;pcm_number
)paren
suffix:semicolon
)brace
id|stream-&gt;pipe
op_assign
l_int|NULL
suffix:semicolon
id|stream-&gt;status
op_assign
id|MIXART_STREAM_STATUS_FREE
suffix:semicolon
id|stream-&gt;substream
op_assign
l_int|NULL
suffix:semicolon
id|up
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_mixart_stream_pointer
r_static
id|snd_pcm_uframes_t
id|snd_mixart_stream_pointer
c_func
(paren
id|snd_pcm_substream_t
op_star
id|subs
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|subs-&gt;runtime
suffix:semicolon
id|mixart_stream_t
op_star
id|stream
op_assign
(paren
id|mixart_stream_t
op_star
)paren
id|runtime-&gt;private_data
suffix:semicolon
r_return
(paren
id|snd_pcm_uframes_t
)paren
(paren
(paren
id|stream-&gt;buf_periods
op_star
id|runtime-&gt;period_size
)paren
op_plus
id|stream-&gt;buf_period_frag
)paren
suffix:semicolon
)brace
DECL|variable|snd_mixart_playback_ops
r_static
id|snd_pcm_ops_t
id|snd_mixart_playback_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_mixart_playback_open
comma
dot
id|close
op_assign
id|snd_mixart_close
comma
dot
id|ioctl
op_assign
id|snd_pcm_lib_ioctl
comma
dot
id|prepare
op_assign
id|snd_mixart_prepare
comma
dot
id|hw_params
op_assign
id|snd_mixart_hw_params
comma
dot
id|hw_free
op_assign
id|snd_mixart_hw_free
comma
dot
id|trigger
op_assign
id|snd_mixart_trigger
comma
dot
id|pointer
op_assign
id|snd_mixart_stream_pointer
comma
)brace
suffix:semicolon
DECL|variable|snd_mixart_capture_ops
r_static
id|snd_pcm_ops_t
id|snd_mixart_capture_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_mixart_capture_open
comma
dot
id|close
op_assign
id|snd_mixart_close
comma
dot
id|ioctl
op_assign
id|snd_pcm_lib_ioctl
comma
dot
id|prepare
op_assign
id|snd_mixart_prepare
comma
dot
id|hw_params
op_assign
id|snd_mixart_hw_params
comma
dot
id|hw_free
op_assign
id|snd_mixart_hw_free
comma
dot
id|trigger
op_assign
id|snd_mixart_trigger
comma
dot
id|pointer
op_assign
id|snd_mixart_stream_pointer
comma
)brace
suffix:semicolon
DECL|function|preallocate_buffers
r_static
r_void
id|preallocate_buffers
c_func
(paren
id|mixart_t
op_star
id|chip
comma
id|snd_pcm_t
op_star
id|pcm
)paren
(brace
id|snd_pcm_substream_t
op_star
id|subs
suffix:semicolon
r_int
id|stream
suffix:semicolon
r_for
c_loop
(paren
id|stream
op_assign
l_int|0
suffix:semicolon
id|stream
OL
l_int|2
suffix:semicolon
id|stream
op_increment
)paren
(brace
r_int
id|idx
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|subs
op_assign
id|pcm-&gt;streams
(braket
id|stream
)braket
dot
id|substream
suffix:semicolon
id|subs
suffix:semicolon
id|subs
op_assign
id|subs-&gt;next
comma
id|idx
op_increment
)paren
multiline_comment|/* set up the unique device id with the chip index */
id|subs-&gt;dma_device.id
op_assign
id|subs-&gt;pcm-&gt;device
op_lshift
l_int|16
op_or
id|subs-&gt;stream
op_lshift
l_int|8
op_or
(paren
id|subs-&gt;number
op_plus
l_int|1
)paren
op_or
(paren
id|chip-&gt;chip_idx
op_plus
l_int|1
)paren
op_lshift
l_int|24
suffix:semicolon
)brace
id|snd_pcm_lib_preallocate_pages_for_all
c_func
(paren
id|pcm
comma
id|SNDRV_DMA_TYPE_DEV
comma
id|snd_dma_pci_data
c_func
(paren
id|chip-&gt;mgr-&gt;pci
)paren
comma
l_int|32
op_star
l_int|1024
comma
l_int|32
op_star
l_int|1024
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|snd_mixart_pcm_analog
r_static
r_int
id|snd_mixart_pcm_analog
c_func
(paren
id|mixart_t
op_star
id|chip
)paren
(brace
r_int
id|err
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;miXart analog %d&quot;
comma
id|chip-&gt;chip_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pcm_new
c_func
(paren
id|chip-&gt;card
comma
id|name
comma
id|MIXART_PCM_ANALOG
comma
id|MIXART_PLAYBACK_STREAMS
comma
id|MIXART_CAPTURE_STREAMS
comma
op_amp
id|pcm
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot create the analog pcm %d&bslash;n&quot;
comma
id|chip-&gt;chip_idx
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|pcm-&gt;private_data
op_assign
id|chip
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_PLAYBACK
comma
op_amp
id|snd_mixart_playback_ops
)paren
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_CAPTURE
comma
op_amp
id|snd_mixart_capture_ops
)paren
suffix:semicolon
id|pcm-&gt;info_flags
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|pcm-&gt;name
comma
id|name
)paren
suffix:semicolon
id|preallocate_buffers
c_func
(paren
id|chip
comma
id|pcm
)paren
suffix:semicolon
id|chip-&gt;pcm
op_assign
id|pcm
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|snd_mixart_pcm_digital
r_static
r_int
id|snd_mixart_pcm_digital
c_func
(paren
id|mixart_t
op_star
id|chip
)paren
(brace
r_int
id|err
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;miXart AES/EBU %d&quot;
comma
id|chip-&gt;chip_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pcm_new
c_func
(paren
id|chip-&gt;card
comma
id|name
comma
id|MIXART_PCM_DIGITAL
comma
id|MIXART_PLAYBACK_STREAMS
comma
id|MIXART_CAPTURE_STREAMS
comma
op_amp
id|pcm
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot create the digital pcm %d&bslash;n&quot;
comma
id|chip-&gt;chip_idx
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|pcm-&gt;private_data
op_assign
id|chip
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_PLAYBACK
comma
op_amp
id|snd_mixart_playback_ops
)paren
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_CAPTURE
comma
op_amp
id|snd_mixart_capture_ops
)paren
suffix:semicolon
id|pcm-&gt;info_flags
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|pcm-&gt;name
comma
id|name
)paren
suffix:semicolon
id|preallocate_buffers
c_func
(paren
id|chip
comma
id|pcm
)paren
suffix:semicolon
id|chip-&gt;pcm_dig
op_assign
id|pcm
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_mixart_chip_free
r_static
r_int
id|snd_mixart_chip_free
c_func
(paren
id|mixart_t
op_star
id|chip
)paren
(brace
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_mixart_chip_dev_free
r_static
r_int
id|snd_mixart_chip_dev_free
c_func
(paren
id|snd_device_t
op_star
id|device
)paren
(brace
id|mixart_t
op_star
id|chip
op_assign
id|device-&gt;device_data
suffix:semicolon
r_return
id|snd_mixart_chip_free
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|snd_mixart_create
r_static
r_int
id|__devinit
id|snd_mixart_create
c_func
(paren
id|mixart_mgr_t
op_star
id|mgr
comma
id|snd_card_t
op_star
id|card
comma
r_int
id|idx
)paren
(brace
r_int
id|err
suffix:semicolon
id|mixart_t
op_star
id|chip
suffix:semicolon
r_static
id|snd_device_ops_t
id|ops
op_assign
(brace
dot
id|dev_free
op_assign
id|snd_mixart_chip_dev_free
comma
)brace
suffix:semicolon
id|mgr-&gt;chip
(braket
id|idx
)braket
op_assign
id|chip
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|chip
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot allocate chip&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|chip-&gt;card
op_assign
id|card
suffix:semicolon
id|chip-&gt;chip_idx
op_assign
id|idx
suffix:semicolon
id|chip-&gt;mgr
op_assign
id|mgr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_device_new
c_func
(paren
id|card
comma
id|SNDRV_DEV_LOWLEVEL
comma
id|chip
comma
op_amp
id|ops
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_mixart_chip_free
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idx
op_eq
l_int|0
)paren
(brace
multiline_comment|/* create a DSP loader only on first cardX*/
id|err
op_assign
id|snd_mixart_hwdep_new
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
id|snd_card_set_dev
c_func
(paren
id|card
comma
op_amp
id|mgr-&gt;pci-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_mixart_create_pcm
r_int
id|snd_mixart_create_pcm
c_func
(paren
id|mixart_t
op_star
id|chip
)paren
(brace
r_int
id|err
suffix:semicolon
id|err
op_assign
id|snd_mixart_pcm_analog
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;mgr-&gt;board_type
op_eq
id|MIXART_DAUGHTER_TYPE_AES
)paren
(brace
id|err
op_assign
id|snd_mixart_pcm_digital
c_func
(paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * release all the cards assigned to a manager instance&n; */
DECL|function|snd_mixart_free
r_static
r_int
id|snd_mixart_free
c_func
(paren
id|mixart_mgr_t
op_star
id|mgr
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mgr-&gt;num_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mgr-&gt;chip
(braket
id|i
)braket
)paren
id|snd_card_free
c_func
(paren
id|mgr-&gt;chip
(braket
id|i
)braket
op_member_access_from_pointer
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/* stop mailbox */
id|snd_mixart_exit_mailbox
c_func
(paren
id|mgr
)paren
suffix:semicolon
multiline_comment|/* release irq  */
r_if
c_cond
(paren
id|mgr-&gt;irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|mgr-&gt;irq
comma
(paren
r_void
op_star
)paren
id|mgr
)paren
suffix:semicolon
multiline_comment|/* reset board if some firmware was loaded */
r_if
c_cond
(paren
id|mgr-&gt;hwdep-&gt;dsp_loaded
)paren
(brace
id|snd_mixart_reset_board
c_func
(paren
id|mgr
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;reset miXart !&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* release the i/o ports */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mgr-&gt;mem
(braket
id|i
)braket
dot
id|virt
)paren
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|mgr-&gt;mem
(braket
id|i
)braket
dot
id|virt
)paren
suffix:semicolon
)brace
id|pci_release_regions
c_func
(paren
id|mgr-&gt;pci
)paren
suffix:semicolon
multiline_comment|/* free flowarray */
r_if
c_cond
(paren
id|mgr-&gt;flowinfo.area
)paren
(brace
id|snd_dma_free_pages
c_func
(paren
op_amp
id|mgr-&gt;dma_dev
comma
op_amp
id|mgr-&gt;flowinfo
)paren
suffix:semicolon
id|mgr-&gt;flowinfo.area
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* free bufferarray */
r_if
c_cond
(paren
id|mgr-&gt;bufferinfo.area
)paren
(brace
id|snd_dma_free_pages
c_func
(paren
op_amp
id|mgr-&gt;dma_dev
comma
op_amp
id|mgr-&gt;bufferinfo
)paren
suffix:semicolon
id|mgr-&gt;bufferinfo.area
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * proc interface&n; */
DECL|function|snd_mixart_BA0_llseek
r_static
r_int
r_int
id|snd_mixart_BA0_llseek
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
r_void
op_star
id|private_file_data
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|offset
comma
r_int
id|orig
)paren
(brace
id|offset
op_assign
id|offset
op_amp
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* 4 bytes aligned */
r_switch
c_cond
(paren
id|orig
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* SEEK_SET */
id|file-&gt;f_pos
op_assign
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* SEEK_CUR */
id|file-&gt;f_pos
op_add_assign
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* SEEK_END, offset is negative */
id|file-&gt;f_pos
op_assign
id|MIXART_BA0_SIZE
op_plus
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_pos
OG
id|MIXART_BA0_SIZE
)paren
(brace
id|file-&gt;f_pos
op_assign
id|MIXART_BA0_SIZE
suffix:semicolon
)brace
r_return
id|file-&gt;f_pos
suffix:semicolon
)brace
DECL|function|snd_mixart_BA1_llseek
r_static
r_int
r_int
id|snd_mixart_BA1_llseek
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
r_void
op_star
id|private_file_data
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|offset
comma
r_int
id|orig
)paren
(brace
id|offset
op_assign
id|offset
op_amp
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* 4 bytes aligned */
r_switch
c_cond
(paren
id|orig
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* SEEK_SET */
id|file-&gt;f_pos
op_assign
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* SEEK_CUR */
id|file-&gt;f_pos
op_add_assign
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* SEEK_END, offset is negative */
id|file-&gt;f_pos
op_assign
id|MIXART_BA1_SIZE
op_plus
id|offset
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_pos
OG
id|MIXART_BA1_SIZE
)paren
(brace
id|file-&gt;f_pos
op_assign
id|MIXART_BA1_SIZE
suffix:semicolon
)brace
r_return
id|file-&gt;f_pos
suffix:semicolon
)brace
multiline_comment|/*&n;  mixart_BA0 proc interface for BAR 0 - read callback&n; */
DECL|function|snd_mixart_BA0_read
r_static
r_int
id|snd_mixart_BA0_read
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
r_void
op_star
id|file_private_data
comma
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|mixart_mgr_t
op_star
id|mgr
op_assign
id|entry-&gt;private_data
suffix:semicolon
id|count
op_assign
id|count
op_amp
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* make sure the read size is a multiple of 4 bytes */
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_pos
op_plus
id|count
OG
id|MIXART_BA0_SIZE
)paren
(brace
id|count
op_assign
(paren
r_int
)paren
(paren
id|MIXART_BA0_SIZE
op_minus
id|file-&gt;f_pos
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user_fromio
c_func
(paren
id|buf
comma
id|MIXART_MEM
c_func
(paren
id|mgr
comma
id|file-&gt;f_pos
)paren
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|file-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n;  mixart_BA1 proc interface for BAR 1 - read callback&n; */
DECL|function|snd_mixart_BA1_read
r_static
r_int
id|snd_mixart_BA1_read
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
r_void
op_star
id|file_private_data
comma
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|mixart_mgr_t
op_star
id|mgr
op_assign
id|entry-&gt;private_data
suffix:semicolon
id|count
op_assign
id|count
op_amp
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* make sure the read size is a multiple of 4 bytes */
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_pos
op_plus
id|count
OG
id|MIXART_BA1_SIZE
)paren
(brace
id|count
op_assign
(paren
r_int
)paren
(paren
id|MIXART_BA1_SIZE
op_minus
id|file-&gt;f_pos
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user_fromio
c_func
(paren
id|buf
comma
id|MIXART_REG
c_func
(paren
id|mgr
comma
id|file-&gt;f_pos
)paren
comma
id|count
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|file-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|variable|snd_mixart_proc_ops_BA0
r_static
r_struct
id|snd_info_entry_ops
id|snd_mixart_proc_ops_BA0
op_assign
(brace
dot
id|read
op_assign
id|snd_mixart_BA0_read
comma
dot
id|llseek
op_assign
id|snd_mixart_BA0_llseek
)brace
suffix:semicolon
DECL|variable|snd_mixart_proc_ops_BA1
r_static
r_struct
id|snd_info_entry_ops
id|snd_mixart_proc_ops_BA1
op_assign
(brace
dot
id|read
op_assign
id|snd_mixart_BA1_read
comma
dot
id|llseek
op_assign
id|snd_mixart_BA1_llseek
)brace
suffix:semicolon
DECL|function|snd_mixart_proc_read
r_static
r_void
id|snd_mixart_proc_read
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
id|snd_info_buffer_t
op_star
id|buffer
)paren
(brace
id|mixart_t
op_star
id|chip
op_assign
id|entry-&gt;private_data
suffix:semicolon
id|u32
id|ref
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Digigram miXart (alsa card %d)&bslash;n&bslash;n&quot;
comma
id|chip-&gt;chip_idx
)paren
suffix:semicolon
multiline_comment|/* stats available when embedded OS is running */
r_if
c_cond
(paren
id|chip-&gt;mgr-&gt;hwdep-&gt;dsp_loaded
op_amp
(paren
l_int|1
op_lshift
id|MIXART_MOTHERBOARD_ELF_INDEX
)paren
)paren
(brace
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;- hardware -&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|chip-&gt;mgr-&gt;board_type
)paren
(brace
r_case
id|MIXART_DAUGHTER_TYPE_NONE
suffix:colon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tmiXart8 (no daughter board)&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXART_DAUGHTER_TYPE_AES
suffix:colon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tmiXart8 AES/EBU&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIXART_DAUGHTER_TYPE_COBRANET
suffix:colon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tmiXart8 Cobranet&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tUNKNOWN!&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;- system load -&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* get perf reference */
id|ref
op_assign
id|readl_be
c_func
(paren
id|MIXART_MEM
c_func
(paren
id|chip-&gt;mgr
comma
id|MIXART_PSEUDOREG_PERF_SYSTEM_LOAD_OFFSET
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ref
)paren
(brace
id|u32
id|mailbox
op_assign
l_int|100
op_star
id|readl_be
c_func
(paren
id|MIXART_MEM
c_func
(paren
id|chip-&gt;mgr
comma
id|MIXART_PSEUDOREG_PERF_MAILBX_LOAD_OFFSET
)paren
)paren
op_div
id|ref
suffix:semicolon
id|u32
id|streaming
op_assign
l_int|100
op_star
id|readl_be
c_func
(paren
id|MIXART_MEM
c_func
(paren
id|chip-&gt;mgr
comma
id|MIXART_PSEUDOREG_PERF_STREAM_LOAD_OFFSET
)paren
)paren
op_div
id|ref
suffix:semicolon
id|u32
id|interr
op_assign
l_int|100
op_star
id|readl_be
c_func
(paren
id|MIXART_MEM
c_func
(paren
id|chip-&gt;mgr
comma
id|MIXART_PSEUDOREG_PERF_INTERR_LOAD_OFFSET
)paren
)paren
op_div
id|ref
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tstreaming          : %d&bslash;n&quot;
comma
id|streaming
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tmailbox            : %d&bslash;n&quot;
comma
id|mailbox
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tinterrups handling : %d&bslash;n&bslash;n&quot;
comma
id|interr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* endif elf loaded */
)brace
DECL|function|snd_mixart_proc_init
r_static
r_void
id|__devinit
id|snd_mixart_proc_init
c_func
(paren
id|mixart_t
op_star
id|chip
)paren
(brace
id|snd_info_entry_t
op_star
id|entry
suffix:semicolon
multiline_comment|/* text interface to read perf and temp meters */
r_if
c_cond
(paren
op_logical_neg
id|snd_card_proc_new
c_func
(paren
id|chip-&gt;card
comma
l_string|&quot;board_info&quot;
comma
op_amp
id|entry
)paren
)paren
(brace
id|entry-&gt;private_data
op_assign
id|chip
suffix:semicolon
id|entry-&gt;c.text.read_size
op_assign
l_int|1024
suffix:semicolon
id|entry-&gt;c.text.read
op_assign
id|snd_mixart_proc_read
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|snd_card_proc_new
c_func
(paren
id|chip-&gt;card
comma
l_string|&quot;mixart_BA0&quot;
comma
op_amp
id|entry
)paren
)paren
(brace
id|entry-&gt;content
op_assign
id|SNDRV_INFO_CONTENT_DATA
suffix:semicolon
id|entry-&gt;private_data
op_assign
id|chip-&gt;mgr
suffix:semicolon
id|entry-&gt;c.ops
op_assign
op_amp
id|snd_mixart_proc_ops_BA0
suffix:semicolon
id|entry-&gt;size
op_assign
id|MIXART_BA0_SIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|snd_card_proc_new
c_func
(paren
id|chip-&gt;card
comma
l_string|&quot;mixart_BA1&quot;
comma
op_amp
id|entry
)paren
)paren
(brace
id|entry-&gt;content
op_assign
id|SNDRV_INFO_CONTENT_DATA
suffix:semicolon
id|entry-&gt;private_data
op_assign
id|chip-&gt;mgr
suffix:semicolon
id|entry-&gt;c.ops
op_assign
op_amp
id|snd_mixart_proc_ops_BA1
suffix:semicolon
id|entry-&gt;size
op_assign
id|MIXART_BA1_SIZE
suffix:semicolon
)brace
)brace
multiline_comment|/* end of proc interface */
multiline_comment|/*&n; *    probe function - creates the card manager&n; */
DECL|function|snd_mixart_probe
r_static
r_int
id|__devinit
id|snd_mixart_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
comma
r_const
r_struct
id|pci_device_id
op_star
id|pci_id
)paren
(brace
r_static
r_int
id|dev
suffix:semicolon
id|mixart_mgr_t
op_star
id|mgr
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|size
suffix:semicolon
multiline_comment|/*&n;&t; */
r_if
c_cond
(paren
id|dev
op_ge
id|SNDRV_CARDS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|enable
(braket
id|dev
)braket
)paren
(brace
id|dev
op_increment
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
multiline_comment|/* enable PCI device */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pci
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pci
)paren
suffix:semicolon
multiline_comment|/* check if we can restrict PCI DMA transfers to 32 bits */
r_if
c_cond
(paren
op_logical_neg
id|pci_dma_supported
c_func
(paren
id|pci
comma
l_int|0xffffffff
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;architecture does not support 32bit PCI busmaster DMA&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|pci_set_dma_mask
c_func
(paren
id|pci
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/*&n;&t; */
id|mgr
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|mgr
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mgr
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|mgr-&gt;pci
op_assign
id|pci
suffix:semicolon
id|mgr-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* resource assignment */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_request_regions
c_func
(paren
id|pci
comma
id|CARD_NAME
)paren
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mgr-&gt;mem
(braket
id|i
)braket
dot
id|phys
op_assign
id|pci_resource_start
c_func
(paren
id|pci
comma
id|i
)paren
suffix:semicolon
id|mgr-&gt;mem
(braket
id|i
)braket
dot
id|virt
op_assign
(paren
r_int
r_int
)paren
id|ioremap_nocache
c_func
(paren
id|mgr-&gt;mem
(braket
id|i
)braket
dot
id|phys
comma
id|pci_resource_len
c_func
(paren
id|pci
comma
id|i
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pci-&gt;irq
comma
id|snd_mixart_interrupt
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
id|CARD_NAME
comma
(paren
r_void
op_star
)paren
id|mgr
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;unable to grab IRQ %d&bslash;n&quot;
comma
id|pci-&gt;irq
)paren
suffix:semicolon
id|snd_mixart_free
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|mgr-&gt;irq
op_assign
id|pci-&gt;irq
suffix:semicolon
id|sprintf
c_func
(paren
id|mgr-&gt;shortname
comma
l_string|&quot;Digigram miXart&quot;
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|mgr-&gt;longname
comma
l_string|&quot;%s at 0x%lx &amp; 0x%lx, irq %i&quot;
comma
id|mgr-&gt;shortname
comma
id|mgr-&gt;mem
(braket
l_int|0
)braket
dot
id|phys
comma
id|mgr-&gt;mem
(braket
l_int|1
)braket
dot
id|phys
comma
id|mgr-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* ISR spinlock  */
id|spin_lock_init
c_func
(paren
op_amp
id|mgr-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* init mailbox  */
id|mgr-&gt;msg_fifo_readptr
op_assign
l_int|0
suffix:semicolon
id|mgr-&gt;msg_fifo_writeptr
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|mgr-&gt;msg_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|mgr-&gt;msg_mutex
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mgr-&gt;msg_sleep
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|mgr-&gt;msg_processed
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* init setup mutex*/
id|init_MUTEX
c_func
(paren
op_amp
id|mgr-&gt;setup_mutex
)paren
suffix:semicolon
multiline_comment|/* init message taslket */
id|tasklet_init
c_func
(paren
op_amp
id|mgr-&gt;msg_taskq
comma
id|snd_mixart_msg_tasklet
comma
(paren
r_int
r_int
)paren
id|mgr
)paren
suffix:semicolon
multiline_comment|/* card assignment */
id|mgr-&gt;num_cards
op_assign
id|MIXART_MAX_CARDS
suffix:semicolon
multiline_comment|/* 4  FIXME: configurable? */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mgr-&gt;num_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|snd_card_t
op_star
id|card
suffix:semicolon
r_char
id|tmpid
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|index
(braket
id|dev
)braket
OL
l_int|0
)paren
id|idx
op_assign
id|index
(braket
id|dev
)braket
suffix:semicolon
r_else
id|idx
op_assign
id|index
(braket
id|dev
)braket
op_plus
id|i
suffix:semicolon
id|snprintf
c_func
(paren
id|tmpid
comma
r_sizeof
(paren
id|tmpid
)paren
comma
l_string|&quot;%s-%d&quot;
comma
id|id
(braket
id|dev
)braket
comma
id|i
)paren
suffix:semicolon
id|card
op_assign
id|snd_card_new
c_func
(paren
id|idx
comma
id|tmpid
comma
id|THIS_MODULE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cannot allocate the card %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|snd_mixart_free
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|card-&gt;driver
comma
id|CARD_NAME
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;shortname
comma
l_string|&quot;%s [PCM #%d]&quot;
comma
id|mgr-&gt;shortname
comma
id|i
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;longname
comma
l_string|&quot;%s [PCM #%d]&quot;
comma
id|mgr-&gt;longname
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_mixart_create
c_func
(paren
id|mgr
comma
id|card
comma
id|i
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_mixart_free
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
multiline_comment|/* init proc interface only for chip0 */
id|snd_mixart_proc_init
c_func
(paren
id|mgr-&gt;chip
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_register
c_func
(paren
id|card
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_mixart_free
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
multiline_comment|/* init firmware status (mgr-&gt;hwdep-&gt;dsp_loaded reset in hwdep_new) */
id|mgr-&gt;board_type
op_assign
id|MIXART_DAUGHTER_TYPE_NONE
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mgr-&gt;dma_dev
comma
l_int|0
comma
r_sizeof
(paren
id|mgr-&gt;dma_dev
)paren
)paren
suffix:semicolon
id|mgr-&gt;dma_dev.type
op_assign
id|SNDRV_DMA_TYPE_DEV
suffix:semicolon
id|mgr-&gt;dma_dev.dev
op_assign
id|snd_dma_pci_data
c_func
(paren
id|mgr-&gt;pci
)paren
suffix:semicolon
multiline_comment|/* create array of streaminfo */
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
id|MIXART_MAX_STREAM_PER_CARD
op_star
id|MIXART_MAX_CARDS
op_star
r_sizeof
(paren
id|mixart_flowinfo_t
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd_dma_alloc_pages
c_func
(paren
op_amp
id|mgr-&gt;dma_dev
comma
id|size
comma
op_amp
id|mgr-&gt;flowinfo
)paren
OL
l_int|0
)paren
(brace
id|snd_mixart_free
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* init streaminfo_array */
id|memset
c_func
(paren
id|mgr-&gt;flowinfo.area
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* create array of bufferinfo */
id|size
op_assign
id|PAGE_ALIGN
c_func
(paren
(paren
id|MIXART_MAX_STREAM_PER_CARD
op_star
id|MIXART_MAX_CARDS
op_star
r_sizeof
(paren
id|mixart_bufferinfo_t
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd_dma_alloc_pages
c_func
(paren
op_amp
id|mgr-&gt;dma_dev
comma
id|size
comma
op_amp
id|mgr-&gt;bufferinfo
)paren
OL
l_int|0
)paren
(brace
id|snd_mixart_free
c_func
(paren
id|mgr
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* init bufferinfo_array */
id|memset
c_func
(paren
id|mgr-&gt;bufferinfo.area
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci
comma
id|mgr
)paren
suffix:semicolon
id|dev
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_mixart_remove
r_static
r_void
id|__devexit
id|snd_mixart_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
)paren
(brace
id|snd_mixart_free
c_func
(paren
id|pci_get_drvdata
c_func
(paren
id|pci
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|driver
r_static
r_struct
id|pci_driver
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Digigram miXart&quot;
comma
dot
id|id_table
op_assign
id|snd_mixart_ids
comma
dot
id|probe
op_assign
id|snd_mixart_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|snd_mixart_remove
)paren
comma
)brace
suffix:semicolon
DECL|function|alsa_card_mixart_init
r_static
r_int
id|__init
id|alsa_card_mixart_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|function|alsa_card_mixart_exit
r_static
r_void
id|__exit
id|alsa_card_mixart_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|alsa_card_mixart_init
)paren
id|module_exit
c_func
(paren
id|alsa_card_mixart_exit
)paren
eof
