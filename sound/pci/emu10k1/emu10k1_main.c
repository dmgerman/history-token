multiline_comment|/*&n; *  Copyright (c) by Jaroslav Kysela &lt;perex@suse.cz&gt;&n; *                   Creative Labs, Inc.&n; *  Routines for control of EMU10K1 chips&n; *&n; *  BUGS:&n; *    --&n; *&n; *  TODO:&n; *    --&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/emu10k1.h&gt;
macro_line|#if 0
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jaroslav Kysela &lt;perex@suse.cz&gt;, Creative Labs, Inc.&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Routines for control of EMU10K1 chips&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*************************************************************************&n; * EMU10K1 init / done&n; *************************************************************************/
DECL|function|snd_emu10k1_voice_init
r_void
id|snd_emu10k1_voice_init
c_func
(paren
id|emu10k1_t
op_star
id|emu
comma
r_int
id|ch
)paren
(brace
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|DCYSUSV
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|IP
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|VTFT
comma
id|ch
comma
l_int|0xffff
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CVCF
comma
id|ch
comma
l_int|0xffff
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|PTRX
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CPF
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CCR
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|PSST
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|DSL
comma
id|ch
comma
l_int|0x10
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CCCA
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|Z1
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|Z2
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|FXRT
comma
id|ch
comma
l_int|0x32100000
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|ATKHLDM
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|DCYSUSM
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|IFATN
comma
id|ch
comma
l_int|0xffff
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|PEFE
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|FMMOD
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|TREMFRQ
comma
id|ch
comma
l_int|24
)paren
suffix:semicolon
multiline_comment|/* 1 Hz */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|FM2FRQ2
comma
id|ch
comma
l_int|24
)paren
suffix:semicolon
multiline_comment|/* 1 Hz */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|TEMPENV
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*** these are last so OFF prevents writing ***/
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|LFOVAL2
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|LFOVAL1
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|ATKHLDV
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|ENVVOL
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|ENVVAL
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Audigy extra stuffs */
r_if
c_cond
(paren
id|emu-&gt;audigy
)paren
(brace
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
l_int|0x4c
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ?? */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
l_int|0x4d
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ?? */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
l_int|0x4e
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ?? */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
l_int|0x4f
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ?? */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|A_FXRT1
comma
id|ch
comma
l_int|0x03020100
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|A_FXRT2
comma
id|ch
comma
l_int|0x3f3f3f3f
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|A_SENDAMOUNTS
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|snd_emu10k1_init
r_static
r_int
id|__devinit
id|snd_emu10k1_init
c_func
(paren
id|emu10k1_t
op_star
id|emu
comma
r_int
id|enable_ir
)paren
(brace
r_int
id|ch
comma
id|idx
comma
id|err
suffix:semicolon
r_int
r_int
id|silent_page
suffix:semicolon
id|emu-&gt;fx8010.itram_size
op_assign
(paren
l_int|16
op_star
l_int|1024
)paren
op_div
l_int|2
suffix:semicolon
id|emu-&gt;fx8010.etram_size
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable audio and lock cache */
id|outl
c_func
(paren
id|HCFG_LOCKSOUNDCACHE
op_or
id|HCFG_LOCKTANKCACHE_MASK
op_or
id|HCFG_MUTEBUTTONENABLE
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
multiline_comment|/* reset recording buffers */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|MICBS
comma
l_int|0
comma
id|ADCBS_BUFSIZE_NONE
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|MICBA
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|FXBS
comma
l_int|0
comma
id|ADCBS_BUFSIZE_NONE
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|FXBA
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|ADCBS
comma
l_int|0
comma
id|ADCBS_BUFSIZE_NONE
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|ADCBA
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable channel interrupt */
id|outl
c_func
(paren
l_int|0
comma
id|emu-&gt;port
op_plus
id|INTE
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CLIEL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CLIEH
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|SOLEL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|SOLEH
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;audigy
)paren
(brace
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
l_int|0x5e
comma
l_int|0
comma
l_int|0xf00
)paren
suffix:semicolon
multiline_comment|/* ?? */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
l_int|0x5f
comma
l_int|0
comma
l_int|0x3
)paren
suffix:semicolon
multiline_comment|/* ?? */
)brace
multiline_comment|/* init envelope engine */
r_for
c_loop
(paren
id|ch
op_assign
l_int|0
suffix:semicolon
id|ch
OL
id|NUM_G
suffix:semicolon
id|ch
op_increment
)paren
(brace
id|emu-&gt;voices
(braket
id|ch
)braket
dot
id|emu
op_assign
id|emu
suffix:semicolon
id|emu-&gt;voices
(braket
id|ch
)braket
dot
id|number
op_assign
id|ch
suffix:semicolon
id|snd_emu10k1_voice_init
c_func
(paren
id|emu
comma
id|ch
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Init to 0x02109204 :&n;&t; *  Clock accuracy    = 0     (1000ppm)&n;&t; *  Sample Rate       = 2     (48kHz)&n;&t; *  Audio Channel     = 1     (Left of 2)&n;&t; *  Source Number     = 0     (Unspecified)&n;&t; *  Generation Status = 1     (Original for Cat Code 12)&n;&t; *  Cat Code          = 12    (Digital Signal Mixer)&n;&t; *  Mode              = 0     (Mode 0)&n;&t; *  Emphasis          = 0     (None)&n;&t; *  CP                = 1     (Copyright unasserted)&n;&t; *  AN                = 0     (Audio data)&n;&t; *  P                 = 0     (Consumer)&n;&t; */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|SPCS0
comma
l_int|0
comma
id|emu-&gt;spdif_bits
(braket
l_int|0
)braket
op_assign
id|SPCS_CLKACCY_1000PPM
op_or
id|SPCS_SAMPLERATE_48
op_or
id|SPCS_CHANNELNUM_LEFT
op_or
id|SPCS_SOURCENUM_UNSPEC
op_or
id|SPCS_GENERATIONSTATUS
op_or
l_int|0x00001200
op_or
l_int|0x00000000
op_or
id|SPCS_EMPHASIS_NONE
op_or
id|SPCS_COPYRIGHT
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|SPCS1
comma
l_int|0
comma
id|emu-&gt;spdif_bits
(braket
l_int|1
)braket
op_assign
id|SPCS_CLKACCY_1000PPM
op_or
id|SPCS_SAMPLERATE_48
op_or
id|SPCS_CHANNELNUM_LEFT
op_or
id|SPCS_SOURCENUM_UNSPEC
op_or
id|SPCS_GENERATIONSTATUS
op_or
l_int|0x00001200
op_or
l_int|0x00000000
op_or
id|SPCS_EMPHASIS_NONE
op_or
id|SPCS_COPYRIGHT
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|SPCS2
comma
l_int|0
comma
id|emu-&gt;spdif_bits
(braket
l_int|2
)braket
op_assign
id|SPCS_CLKACCY_1000PPM
op_or
id|SPCS_SAMPLERATE_48
op_or
id|SPCS_CHANNELNUM_LEFT
op_or
id|SPCS_SOURCENUM_UNSPEC
op_or
id|SPCS_GENERATIONSTATUS
op_or
l_int|0x00001200
op_or
l_int|0x00000000
op_or
id|SPCS_EMPHASIS_NONE
op_or
id|SPCS_COPYRIGHT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;audigy
op_logical_and
id|emu-&gt;revision
op_eq
l_int|4
)paren
(brace
multiline_comment|/* audigy2 */
multiline_comment|/* Hacks for Alice3 to work independent of haP16V driver */
id|u32
id|tmp
suffix:semicolon
singleline_comment|//Setup SRCMulti_I2S SamplingRate
id|tmp
op_assign
id|snd_emu10k1_ptr_read
c_func
(paren
id|emu
comma
id|A_SPDIF_SAMPLERATE
comma
l_int|0
)paren
suffix:semicolon
id|tmp
op_and_assign
l_int|0xfffff1ff
suffix:semicolon
id|tmp
op_or_assign
(paren
l_int|0x2
op_lshift
l_int|9
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|A_SPDIF_SAMPLERATE
comma
l_int|0
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Setup SRCSel (Enable Spdif,I2S SRCMulti) */
id|outl
c_func
(paren
l_int|0x600000
comma
id|emu-&gt;port
op_plus
l_int|0x20
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0x14
comma
id|emu-&gt;port
op_plus
l_int|0x24
)paren
suffix:semicolon
multiline_comment|/* Setup SRCMulti Input Audio Enable */
id|outl
c_func
(paren
l_int|0x6E0000
comma
id|emu-&gt;port
op_plus
l_int|0x20
)paren
suffix:semicolon
id|outl
c_func
(paren
l_int|0xFF00FF00
comma
id|emu-&gt;port
op_plus
l_int|0x24
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Clear page with silence &amp; setup all pointers to this page&n;&t; */
id|memset
c_func
(paren
id|emu-&gt;silent_page
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|silent_page
op_assign
id|emu-&gt;silent_page_dmaaddr
op_lshift
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|MAXPAGES
suffix:semicolon
id|idx
op_increment
)paren
id|emu-&gt;ptb_pages
(braket
id|idx
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|silent_page
op_or
id|idx
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|PTB
comma
l_int|0
comma
id|emu-&gt;ptb_pages_dmaaddr
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|TCB
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* taken from original driver */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|TCBS
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* taken from original driver */
id|silent_page
op_assign
(paren
id|emu-&gt;silent_page_dmaaddr
op_lshift
l_int|1
)paren
op_or
id|MAP_PTI_MASK
suffix:semicolon
r_for
c_loop
(paren
id|ch
op_assign
l_int|0
suffix:semicolon
id|ch
OL
id|NUM_G
suffix:semicolon
id|ch
op_increment
)paren
(brace
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|MAPA
comma
id|ch
comma
id|silent_page
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|MAPB
comma
id|ch
comma
id|silent_page
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Hokay, setup HCFG&n;&t; *   Mute Disable Audio = 0&n;&t; *   Lock Tank Memory = 1&n;&t; *   Lock Sound Memory = 0&n;&t; *   Auto Mute = 1&n;&t; */
r_if
c_cond
(paren
id|emu-&gt;audigy
)paren
(brace
r_if
c_cond
(paren
id|emu-&gt;revision
op_eq
l_int|4
)paren
multiline_comment|/* audigy2 */
id|outl
c_func
(paren
id|HCFG_AUDIOENABLE
op_or
id|HCFG_AC3ENABLE_CDSPDIF
op_or
id|HCFG_AC3ENABLE_GPSPDIF
op_or
id|HCFG_AUTOMUTE
op_or
id|HCFG_JOYENABLE
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
r_else
id|outl
c_func
(paren
id|HCFG_AUTOMUTE
op_or
id|HCFG_JOYENABLE
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|emu-&gt;model
op_eq
l_int|0x20
op_logical_or
id|emu-&gt;model
op_eq
l_int|0xc400
op_logical_or
(paren
id|emu-&gt;model
op_eq
l_int|0x21
op_logical_and
id|emu-&gt;revision
OL
l_int|6
)paren
)paren
id|outl
c_func
(paren
id|HCFG_LOCKTANKCACHE_MASK
op_or
id|HCFG_AUTOMUTE
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
r_else
singleline_comment|// With on-chip joystick
id|outl
c_func
(paren
id|HCFG_LOCKTANKCACHE_MASK
op_or
id|HCFG_AUTOMUTE
op_or
id|HCFG_JOYENABLE
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable_ir
)paren
(brace
multiline_comment|/* enable IR for SB Live */
r_if
c_cond
(paren
id|emu-&gt;audigy
)paren
(brace
r_int
r_int
id|reg
op_assign
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
op_or
id|A_IOCFG_GPOUT2
comma
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
op_or
id|A_IOCFG_GPOUT1
op_or
id|A_IOCFG_GPOUT2
comma
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|reg
op_assign
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
op_or
id|HCFG_GPOUT2
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
op_or
id|HCFG_GPOUT1
op_or
id|HCFG_GPOUT2
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|emu-&gt;audigy
)paren
(brace
multiline_comment|/* enable analog output */
r_int
r_int
id|reg
op_assign
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
id|outl
c_func
(paren
id|reg
op_or
id|A_IOCFG_GPOUT0
comma
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Initialize the effect engine&n;&t; */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_emu10k1_init_efx
c_func
(paren
id|emu
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/*&n;&t; *  Enable the audio bit&n;&t; */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|HCFG
)paren
op_or
id|HCFG_AUDIOENABLE
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
multiline_comment|/* Enable analog/digital outs on audigy */
r_if
c_cond
(paren
id|emu-&gt;audigy
)paren
(brace
id|outl
c_func
(paren
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
op_amp
op_complement
l_int|0x44
comma
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;revision
op_eq
l_int|4
)paren
(brace
multiline_comment|/* audigy2 */
multiline_comment|/* Unmute Analog now.  Set GPO6 to 1 for Apollo.&n;&t;&t;&t; * This has to be done after init ALice3 I2SOut beyond 48KHz.&n;&t;&t;&t; * So, sequence is important. */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
op_or
l_int|0x0040
comma
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Disable routing from AC97 line out to Front speakers */
id|outl
c_func
(paren
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
op_or
l_int|0x0080
comma
id|emu-&gt;port
op_plus
id|A_IOCFG
)paren
suffix:semicolon
)brace
)brace
macro_line|#if 0
(brace
r_int
r_int
id|tmp
suffix:semicolon
multiline_comment|/* FIXME: the following routine disables LiveDrive-II !! */
singleline_comment|// TOSLink detection
id|emu-&gt;tos_link
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
(paren
id|HCFG_GPINPUT0
op_or
id|HCFG_GPINPUT1
)paren
)paren
(brace
id|outl
c_func
(paren
id|tmp
op_or
l_int|0x800
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
(paren
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|HCFG
)paren
op_amp
op_complement
l_int|0x800
)paren
)paren
(brace
id|emu-&gt;tos_link
op_assign
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|tmp
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
id|snd_emu10k1_intr_enable
c_func
(paren
id|emu
comma
id|INTE_PCIERRORENABLE
)paren
suffix:semicolon
id|emu-&gt;reserved_page
op_assign
(paren
id|emu10k1_memblk_t
op_star
)paren
id|snd_emu10k1_synth_alloc
c_func
(paren
id|emu
comma
l_int|4096
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;reserved_page
)paren
id|emu-&gt;reserved_page-&gt;map_locked
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_emu10k1_done
r_static
r_int
id|snd_emu10k1_done
c_func
(paren
id|emu10k1_t
op_star
id|emu
)paren
(brace
r_int
id|ch
suffix:semicolon
id|outl
c_func
(paren
l_int|0
comma
id|emu-&gt;port
op_plus
id|INTE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Shutdown the chip&n;&t; */
r_for
c_loop
(paren
id|ch
op_assign
l_int|0
suffix:semicolon
id|ch
OL
id|NUM_G
suffix:semicolon
id|ch
op_increment
)paren
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|DCYSUSV
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ch
op_assign
l_int|0
suffix:semicolon
id|ch
OL
id|NUM_G
suffix:semicolon
id|ch
op_increment
)paren
(brace
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|VTFT
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CVCF
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|PTRX
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CPF
comma
id|ch
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* reset recording buffers */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|MICBS
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|MICBA
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|FXBS
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|FXBA
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|FXWC
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|ADCBS
comma
l_int|0
comma
id|ADCBS_BUFSIZE_NONE
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|ADCBA
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|TCBS
comma
l_int|0
comma
id|TCBS_BUFFSIZE_16K
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|TCB
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;audigy
)paren
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|A_DBG
comma
l_int|0
comma
id|A_DBG_SINGLE_STEP
)paren
suffix:semicolon
r_else
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|DBG
comma
l_int|0
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* disable channel interrupt */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CLIEL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|CLIEH
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|SOLEL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|SOLEH
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* remove reserved page */
r_if
c_cond
(paren
id|emu-&gt;reserved_page
op_ne
l_int|NULL
)paren
(brace
id|snd_emu10k1_synth_free
c_func
(paren
id|emu
comma
(paren
id|snd_util_memblk_t
op_star
)paren
id|emu-&gt;reserved_page
)paren
suffix:semicolon
id|emu-&gt;reserved_page
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* disable audio and lock cache */
id|outl
c_func
(paren
id|HCFG_LOCKSOUNDCACHE
op_or
id|HCFG_LOCKTANKCACHE_MASK
op_or
id|HCFG_MUTEBUTTONENABLE
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|PTB
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_free_efx
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*************************************************************************&n; * ECARD functional implementation&n; *************************************************************************/
multiline_comment|/* In A1 Silicon, these bits are in the HC register */
DECL|macro|HOOKN_BIT
mdefine_line|#define HOOKN_BIT&t;&t;(1L &lt;&lt; 12)
DECL|macro|HANDN_BIT
mdefine_line|#define HANDN_BIT&t;&t;(1L &lt;&lt; 11)
DECL|macro|PULSEN_BIT
mdefine_line|#define PULSEN_BIT&t;&t;(1L &lt;&lt; 10)
DECL|macro|EC_GDI1
mdefine_line|#define EC_GDI1&t;&t;&t;(1 &lt;&lt; 13)
DECL|macro|EC_GDI0
mdefine_line|#define EC_GDI0&t;&t;&t;(1 &lt;&lt; 14)
DECL|macro|EC_NUM_CONTROL_BITS
mdefine_line|#define EC_NUM_CONTROL_BITS&t;20
DECL|macro|EC_AC3_DATA_SELN
mdefine_line|#define EC_AC3_DATA_SELN&t;0x0001L
DECL|macro|EC_EE_DATA_SEL
mdefine_line|#define EC_EE_DATA_SEL&t;&t;0x0002L
DECL|macro|EC_EE_CNTRL_SELN
mdefine_line|#define EC_EE_CNTRL_SELN&t;0x0004L
DECL|macro|EC_EECLK
mdefine_line|#define EC_EECLK&t;&t;0x0008L
DECL|macro|EC_EECS
mdefine_line|#define EC_EECS&t;&t;&t;0x0010L
DECL|macro|EC_EESDO
mdefine_line|#define EC_EESDO&t;&t;0x0020L
DECL|macro|EC_TRIM_CSN
mdefine_line|#define EC_TRIM_CSN&t;&t;0x0040L
DECL|macro|EC_TRIM_SCLK
mdefine_line|#define EC_TRIM_SCLK&t;&t;0x0080L
DECL|macro|EC_TRIM_SDATA
mdefine_line|#define EC_TRIM_SDATA&t;&t;0x0100L
DECL|macro|EC_TRIM_MUTEN
mdefine_line|#define EC_TRIM_MUTEN&t;&t;0x0200L
DECL|macro|EC_ADCCAL
mdefine_line|#define EC_ADCCAL&t;&t;0x0400L
DECL|macro|EC_ADCRSTN
mdefine_line|#define EC_ADCRSTN&t;&t;0x0800L
DECL|macro|EC_DACCAL
mdefine_line|#define EC_DACCAL&t;&t;0x1000L
DECL|macro|EC_DACMUTEN
mdefine_line|#define EC_DACMUTEN&t;&t;0x2000L
DECL|macro|EC_LEDN
mdefine_line|#define EC_LEDN&t;&t;&t;0x4000L
DECL|macro|EC_SPDIF0_SEL_SHIFT
mdefine_line|#define EC_SPDIF0_SEL_SHIFT&t;15
DECL|macro|EC_SPDIF1_SEL_SHIFT
mdefine_line|#define EC_SPDIF1_SEL_SHIFT&t;17
DECL|macro|EC_SPDIF0_SEL_MASK
mdefine_line|#define EC_SPDIF0_SEL_MASK&t;(0x3L &lt;&lt; EC_SPDIF0_SEL_SHIFT)
DECL|macro|EC_SPDIF1_SEL_MASK
mdefine_line|#define EC_SPDIF1_SEL_MASK&t;(0x7L &lt;&lt; EC_SPDIF1_SEL_SHIFT)
DECL|macro|EC_SPDIF0_SELECT
mdefine_line|#define EC_SPDIF0_SELECT(_x)&t;(((_x) &lt;&lt; EC_SPDIF0_SEL_SHIFT) &amp; EC_SPDIF0_SEL_MASK)
DECL|macro|EC_SPDIF1_SELECT
mdefine_line|#define EC_SPDIF1_SELECT(_x)&t;(((_x) &lt;&lt; EC_SPDIF1_SEL_SHIFT) &amp; EC_SPDIF1_SEL_MASK)
DECL|macro|EC_CURRENT_PROM_VERSION
mdefine_line|#define EC_CURRENT_PROM_VERSION 0x01&t;/* Self-explanatory.  This should&n;&t;&t;&t;&t;&t; * be incremented any time the EEPROM&squot;s&n;&t;&t;&t;&t;&t; * format is changed.  */
DECL|macro|EC_EEPROM_SIZE
mdefine_line|#define EC_EEPROM_SIZE&t;&t;0x40&t;/* ECARD EEPROM has 64 16-bit words */
multiline_comment|/* Addresses for special values stored in to EEPROM */
DECL|macro|EC_PROM_VERSION_ADDR
mdefine_line|#define EC_PROM_VERSION_ADDR&t;0x20&t;/* Address of the current prom version */
DECL|macro|EC_BOARDREV0_ADDR
mdefine_line|#define EC_BOARDREV0_ADDR&t;0x21&t;/* LSW of board rev */
DECL|macro|EC_BOARDREV1_ADDR
mdefine_line|#define EC_BOARDREV1_ADDR&t;0x22&t;/* MSW of board rev */
DECL|macro|EC_LAST_PROMFILE_ADDR
mdefine_line|#define EC_LAST_PROMFILE_ADDR&t;0x2f
DECL|macro|EC_SERIALNUM_ADDR
mdefine_line|#define EC_SERIALNUM_ADDR&t;0x30&t;/* First word of serial number.  The &n;&t;&t;&t;&t;&t; * can be up to 30 characters in length&n;&t;&t;&t;&t;&t; * and is stored as a NULL-terminated&n;&t;&t;&t;&t;&t; * ASCII string.  Any unused bytes must be&n;&t;&t;&t;&t;&t; * filled with zeros */
DECL|macro|EC_CHECKSUM_ADDR
mdefine_line|#define EC_CHECKSUM_ADDR&t;0x3f&t;/* Location at which checksum is stored */
multiline_comment|/* Most of this stuff is pretty self-evident.  According to the hardware &n; * dudes, we need to leave the ADCCAL bit low in order to avoid a DC &n; * offset problem.  Weird.&n; */
DECL|macro|EC_RAW_RUN_MODE
mdefine_line|#define EC_RAW_RUN_MODE&t;&t;(EC_DACMUTEN | EC_ADCRSTN | EC_TRIM_MUTEN | &bslash;&n;&t;&t;&t;&t; EC_TRIM_CSN)
DECL|macro|EC_DEFAULT_ADC_GAIN
mdefine_line|#define EC_DEFAULT_ADC_GAIN&t;0xC4C4
DECL|macro|EC_DEFAULT_SPDIF0_SEL
mdefine_line|#define EC_DEFAULT_SPDIF0_SEL&t;0x0
DECL|macro|EC_DEFAULT_SPDIF1_SEL
mdefine_line|#define EC_DEFAULT_SPDIF1_SEL&t;0x4
multiline_comment|/**************************************************************************&n; * @func Clock bits into the Ecard&squot;s control latch.  The Ecard uses a&n; *  control latch will is loaded bit-serially by toggling the Modem control&n; *  lines from function 2 on the E8010.  This function hides these details&n; *  and presents the illusion that we are actually writing to a distinct&n; *  register.&n; */
DECL|function|snd_emu10k1_ecard_write
r_static
r_void
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu10k1_t
op_star
id|emu
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_int
id|count
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_int
r_int
id|hc_port
suffix:semicolon
r_int
r_int
id|hc_value
suffix:semicolon
id|hc_port
op_assign
id|emu-&gt;port
op_plus
id|HCFG
suffix:semicolon
id|hc_value
op_assign
id|inl
c_func
(paren
id|hc_port
)paren
op_amp
op_complement
(paren
id|HOOKN_BIT
op_or
id|HANDN_BIT
op_or
id|PULSEN_BIT
)paren
suffix:semicolon
id|outl
c_func
(paren
id|hc_value
comma
id|hc_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|EC_NUM_CONTROL_BITS
suffix:semicolon
id|count
op_increment
)paren
(brace
multiline_comment|/* Set up the value */
id|data
op_assign
(paren
(paren
id|value
op_amp
l_int|0x1
)paren
ques
c_cond
id|PULSEN_BIT
suffix:colon
l_int|0
)paren
suffix:semicolon
id|value
op_rshift_assign
l_int|1
suffix:semicolon
id|outl
c_func
(paren
id|hc_value
op_or
id|data
comma
id|hc_port
)paren
suffix:semicolon
multiline_comment|/* Clock the shift register */
id|outl
c_func
(paren
id|hc_value
op_or
id|data
op_or
id|HANDN_BIT
comma
id|hc_port
)paren
suffix:semicolon
id|outl
c_func
(paren
id|hc_value
op_or
id|data
comma
id|hc_port
)paren
suffix:semicolon
)brace
multiline_comment|/* Latch the bits */
id|outl
c_func
(paren
id|hc_value
op_or
id|HOOKN_BIT
comma
id|hc_port
)paren
suffix:semicolon
id|outl
c_func
(paren
id|hc_value
comma
id|hc_port
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n; * @func Set the gain of the ECARD&squot;s CS3310 Trim/gain controller.  The&n; * trim value consists of a 16bit value which is composed of two&n; * 8 bit gain/trim values, one for the left channel and one for the&n; * right channel.  The following table maps from the Gain/Attenuation&n; * value in decibels into the corresponding bit pattern for a single&n; * channel.&n; */
DECL|function|snd_emu10k1_ecard_setadcgain
r_static
r_void
id|snd_emu10k1_ecard_setadcgain
c_func
(paren
id|emu10k1_t
op_star
id|emu
comma
r_int
r_int
id|gain
)paren
(brace
r_int
r_int
id|bit
suffix:semicolon
multiline_comment|/* Enable writing to the TRIM registers */
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|emu-&gt;ecard_ctrl
op_amp
op_complement
id|EC_TRIM_CSN
)paren
suffix:semicolon
multiline_comment|/* Do it again to insure that we meet hold time requirements */
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|emu-&gt;ecard_ctrl
op_amp
op_complement
id|EC_TRIM_CSN
)paren
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
(paren
l_int|1
op_lshift
l_int|15
)paren
suffix:semicolon
id|bit
suffix:semicolon
id|bit
op_rshift_assign
l_int|1
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
id|value
op_assign
id|emu-&gt;ecard_ctrl
op_amp
op_complement
(paren
id|EC_TRIM_CSN
op_or
id|EC_TRIM_SDATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gain
op_amp
id|bit
)paren
id|value
op_or_assign
id|EC_TRIM_SDATA
suffix:semicolon
multiline_comment|/* Clock the bit */
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|value
)paren
suffix:semicolon
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|value
op_or
id|EC_TRIM_SCLK
)paren
suffix:semicolon
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|value
)paren
suffix:semicolon
)brace
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|emu-&gt;ecard_ctrl
)paren
suffix:semicolon
)brace
DECL|function|snd_emu10k1_ecard_init
r_static
r_int
id|__devinit
id|snd_emu10k1_ecard_init
c_func
(paren
id|emu10k1_t
op_star
id|emu
)paren
(brace
r_int
r_int
id|hc_value
suffix:semicolon
multiline_comment|/* Set up the initial settings */
id|emu-&gt;ecard_ctrl
op_assign
id|EC_RAW_RUN_MODE
op_or
id|EC_SPDIF0_SELECT
c_func
(paren
id|EC_DEFAULT_SPDIF0_SEL
)paren
op_or
id|EC_SPDIF1_SELECT
c_func
(paren
id|EC_DEFAULT_SPDIF1_SEL
)paren
suffix:semicolon
multiline_comment|/* Step 0: Set the codec type in the hardware control register &n;&t; * and enable audio output */
id|hc_value
op_assign
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
id|outl
c_func
(paren
id|hc_value
op_or
id|HCFG_AUDIOENABLE
op_or
id|HCFG_CODECFORMAT_I2S
comma
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
id|inl
c_func
(paren
id|emu-&gt;port
op_plus
id|HCFG
)paren
suffix:semicolon
multiline_comment|/* Step 1: Turn off the led and deassert TRIM_CS */
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|EC_ADCCAL
op_or
id|EC_LEDN
op_or
id|EC_TRIM_CSN
)paren
suffix:semicolon
multiline_comment|/* Step 2: Calibrate the ADC and DAC */
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|EC_DACCAL
op_or
id|EC_LEDN
op_or
id|EC_TRIM_CSN
)paren
suffix:semicolon
multiline_comment|/* Step 3: Wait for awhile;   XXX We can&squot;t get away with this&n;&t; * under a real operating system; we&squot;ll need to block and wait that&n;&t; * way. */
id|snd_emu10k1_wait
c_func
(paren
id|emu
comma
l_int|48000
)paren
suffix:semicolon
multiline_comment|/* Step 4: Switch off the DAC and ADC calibration.  Note&n;&t; * That ADC_CAL is actually an inverted signal, so we assert&n;&t; * it here to stop calibration.  */
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|EC_ADCCAL
op_or
id|EC_LEDN
op_or
id|EC_TRIM_CSN
)paren
suffix:semicolon
multiline_comment|/* Step 4: Switch into run mode */
id|snd_emu10k1_ecard_write
c_func
(paren
id|emu
comma
id|emu-&gt;ecard_ctrl
)paren
suffix:semicolon
multiline_comment|/* Step 5: Set the analog input gain */
id|snd_emu10k1_ecard_setadcgain
c_func
(paren
id|emu
comma
id|EC_DEFAULT_ADC_GAIN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  Create the EMU10K1 instance&n; */
DECL|function|snd_emu10k1_free
r_static
r_int
id|snd_emu10k1_free
c_func
(paren
id|emu10k1_t
op_star
id|emu
)paren
(brace
r_if
c_cond
(paren
id|emu-&gt;res_port
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* avoid access to already used hardware */
id|snd_emu10k1_fx8010_tram_setup
c_func
(paren
id|emu
comma
l_int|0
)paren
suffix:semicolon
id|snd_emu10k1_done
c_func
(paren
id|emu
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|emu-&gt;memhdr
)paren
id|snd_util_memhdr_free
c_func
(paren
id|emu-&gt;memhdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;silent_page
)paren
id|snd_free_pci_pages
c_func
(paren
id|emu-&gt;pci
comma
id|EMUPAGESIZE
comma
id|emu-&gt;silent_page
comma
id|emu-&gt;silent_page_dmaaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;ptb_pages
)paren
id|snd_free_pci_pages
c_func
(paren
id|emu-&gt;pci
comma
l_int|32
op_star
l_int|1024
comma
(paren
r_void
op_star
)paren
id|emu-&gt;ptb_pages
comma
id|emu-&gt;ptb_pages_dmaaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;page_ptr_table
)paren
id|vfree
c_func
(paren
id|emu-&gt;page_ptr_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;page_addr_table
)paren
id|vfree
c_func
(paren
id|emu-&gt;page_addr_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;res_port
)paren
(brace
id|release_resource
c_func
(paren
id|emu-&gt;res_port
)paren
suffix:semicolon
id|kfree_nocheck
c_func
(paren
id|emu-&gt;res_port
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|emu-&gt;irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|emu-&gt;irq
comma
(paren
r_void
op_star
)paren
id|emu
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_emu10k1_dev_free
r_static
r_int
id|snd_emu10k1_dev_free
c_func
(paren
id|snd_device_t
op_star
id|device
)paren
(brace
id|emu10k1_t
op_star
id|emu
op_assign
id|snd_magic_cast
c_func
(paren
id|emu10k1_t
comma
id|device-&gt;device_data
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_return
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
)brace
DECL|function|snd_emu10k1_create
r_int
id|__devinit
id|snd_emu10k1_create
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_struct
id|pci_dev
op_star
id|pci
comma
r_int
r_int
id|extin_mask
comma
r_int
r_int
id|extout_mask
comma
r_int
id|max_cache_bytes
comma
r_int
id|enable_ir
comma
id|emu10k1_t
op_star
op_star
id|remu
)paren
(brace
id|emu10k1_t
op_star
id|emu
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|is_audigy
suffix:semicolon
r_static
id|snd_device_ops_t
id|ops
op_assign
(brace
dot
id|dev_free
op_assign
id|snd_emu10k1_dev_free
comma
)brace
suffix:semicolon
op_star
id|remu
op_assign
l_int|NULL
suffix:semicolon
singleline_comment|// is_audigy = (int)pci-&gt;driver_data;
id|is_audigy
op_assign
(paren
id|pci-&gt;device
op_eq
l_int|0x0004
)paren
suffix:semicolon
multiline_comment|/* enable PCI device */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pci
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|emu
op_assign
id|snd_magic_kcalloc
c_func
(paren
id|emu10k1_t
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* set the DMA transfer mask */
id|emu-&gt;dma_mask
op_assign
id|is_audigy
ques
c_cond
id|AUDIGY_DMA_MASK
suffix:colon
id|EMU10K1_DMA_MASK
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pci
comma
id|emu-&gt;dma_mask
)paren
OL
l_int|0
op_logical_or
id|pci_set_consistent_dma_mask
c_func
(paren
id|pci
comma
id|emu-&gt;dma_mask
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;architecture does not support PCI busmaster DMA with mask 0x%lx&bslash;n&quot;
comma
id|emu-&gt;dma_mask
)paren
suffix:semicolon
id|snd_magic_kfree
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|emu-&gt;card
op_assign
id|card
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|emu-&gt;reg_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|emu-&gt;emu_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|emu-&gt;voice_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|emu-&gt;synth_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|emu-&gt;memblk_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|emu-&gt;ptb_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|emu-&gt;fx8010.lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|emu-&gt;mapped_link_head
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|emu-&gt;mapped_order_link_head
)paren
suffix:semicolon
id|emu-&gt;pci
op_assign
id|pci
suffix:semicolon
id|emu-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|emu-&gt;synth
op_assign
l_int|NULL
suffix:semicolon
id|emu-&gt;get_synth_voice
op_assign
l_int|NULL
suffix:semicolon
id|emu-&gt;port
op_assign
id|pci_resource_start
c_func
(paren
id|pci
comma
l_int|0
)paren
suffix:semicolon
id|emu-&gt;audigy
op_assign
id|is_audigy
suffix:semicolon
r_if
c_cond
(paren
id|is_audigy
)paren
id|emu-&gt;gpr_base
op_assign
id|A_FXGPREGBASE
suffix:semicolon
r_else
id|emu-&gt;gpr_base
op_assign
id|FXGPREGBASE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|emu-&gt;res_port
op_assign
id|request_region
c_func
(paren
id|emu-&gt;port
comma
l_int|0x20
comma
l_string|&quot;EMU10K1&quot;
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pci-&gt;irq
comma
id|snd_emu10k1_interrupt
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;EMU10K1&quot;
comma
(paren
r_void
op_star
)paren
id|emu
)paren
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|emu-&gt;irq
op_assign
id|pci-&gt;irq
suffix:semicolon
id|emu-&gt;max_cache_pages
op_assign
id|max_cache_bytes
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|emu-&gt;ptb_pages
op_assign
id|snd_malloc_pci_pages
c_func
(paren
id|pci
comma
l_int|32
op_star
l_int|1024
comma
op_amp
id|emu-&gt;ptb_pages_dmaaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;ptb_pages
op_eq
l_int|NULL
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|emu-&gt;page_ptr_table
op_assign
(paren
r_void
op_star
op_star
)paren
id|vmalloc
c_func
(paren
id|emu-&gt;max_cache_pages
op_star
r_sizeof
(paren
r_void
op_star
)paren
)paren
suffix:semicolon
id|emu-&gt;page_addr_table
op_assign
(paren
r_int
r_int
op_star
)paren
id|vmalloc
c_func
(paren
id|emu-&gt;max_cache_pages
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;page_ptr_table
op_eq
l_int|NULL
op_logical_or
id|emu-&gt;page_addr_table
op_eq
l_int|NULL
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|emu-&gt;silent_page
op_assign
id|snd_malloc_pci_pages
c_func
(paren
id|pci
comma
id|EMUPAGESIZE
comma
op_amp
id|emu-&gt;silent_page_dmaaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;silent_page
op_eq
l_int|NULL
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|emu-&gt;memhdr
op_assign
id|snd_util_memhdr_new
c_func
(paren
id|emu-&gt;max_cache_pages
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;memhdr
op_eq
l_int|NULL
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|emu-&gt;memhdr-&gt;block_extra_size
op_assign
r_sizeof
(paren
id|emu10k1_memblk_t
)paren
op_minus
r_sizeof
(paren
id|snd_util_memblk_t
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pci
)paren
suffix:semicolon
multiline_comment|/* read revision &amp; serial */
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_REVISION_ID
comma
(paren
r_char
op_star
)paren
op_amp
id|emu-&gt;revision
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pci
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|emu-&gt;serial
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|emu-&gt;model
)paren
suffix:semicolon
id|emu-&gt;card_type
op_assign
id|EMU10K1_CARD_CREATIVE
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;serial
op_eq
l_int|0x40011102
)paren
(brace
id|emu-&gt;card_type
op_assign
id|EMU10K1_CARD_EMUAPS
suffix:semicolon
id|emu-&gt;APS
op_assign
l_int|1
suffix:semicolon
id|emu-&gt;no_ac97
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* APS has no AC97 chip */
)brace
r_else
r_if
c_cond
(paren
id|emu-&gt;revision
op_eq
l_int|4
op_logical_and
id|emu-&gt;serial
op_eq
l_int|0x10051102
)paren
(brace
multiline_comment|/* Audigy 2 EX has apparently no effective AC97 controls&n;&t;&t; * (for both input and output), so we skip the AC97 detections&n;&t;&t; */
id|snd_printdd
c_func
(paren
id|KERN_INFO
l_string|&quot;Audigy2 EX is detected. skpping ac97.&bslash;n&quot;
)paren
suffix:semicolon
id|emu-&gt;no_ac97
op_assign
l_int|1
suffix:semicolon
)brace
id|emu-&gt;fx8010.fxbus_mask
op_assign
l_int|0x303f
suffix:semicolon
r_if
c_cond
(paren
id|extin_mask
op_eq
l_int|0
)paren
id|extin_mask
op_assign
l_int|0x3fcf
suffix:semicolon
r_if
c_cond
(paren
id|extout_mask
op_eq
l_int|0
)paren
id|extout_mask
op_assign
l_int|0x1fff
suffix:semicolon
id|emu-&gt;fx8010.extin_mask
op_assign
id|extin_mask
suffix:semicolon
id|emu-&gt;fx8010.extout_mask
op_assign
id|extout_mask
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;APS
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_emu10k1_ecard_init
c_func
(paren
id|emu
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* 5.1: Enable the additional AC97 Slots. If the emu10k1 version&n;&t;&t;&t;does not support this, it shouldn&squot;t do any harm */
id|snd_emu10k1_ptr_write
c_func
(paren
id|emu
comma
id|AC97SLOT
comma
l_int|0
comma
id|AC97SLOT_CNTR
op_or
id|AC97SLOT_LFE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_emu10k1_init
c_func
(paren
id|emu
comma
id|enable_ir
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_device_new
c_func
(paren
id|card
comma
id|SNDRV_DEV_LOWLEVEL
comma
id|emu
comma
op_amp
id|ops
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_emu10k1_free
c_func
(paren
id|emu
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|snd_emu10k1_proc_init
c_func
(paren
id|emu
)paren
suffix:semicolon
id|snd_card_set_dev
c_func
(paren
id|card
comma
op_amp
id|pci-&gt;dev
)paren
suffix:semicolon
op_star
id|remu
op_assign
id|emu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* memory.c */
DECL|variable|snd_emu10k1_synth_alloc
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_synth_alloc
)paren
suffix:semicolon
DECL|variable|snd_emu10k1_synth_free
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_synth_free
)paren
suffix:semicolon
DECL|variable|snd_emu10k1_synth_bzero
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_synth_bzero
)paren
suffix:semicolon
DECL|variable|snd_emu10k1_synth_copy_from_user
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_synth_copy_from_user
)paren
suffix:semicolon
DECL|variable|snd_emu10k1_memblk_map
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_memblk_map
)paren
suffix:semicolon
multiline_comment|/* voice.c */
DECL|variable|snd_emu10k1_voice_alloc
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_voice_alloc
)paren
suffix:semicolon
DECL|variable|snd_emu10k1_voice_free
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_voice_free
)paren
suffix:semicolon
multiline_comment|/* io.c */
DECL|variable|snd_emu10k1_ptr_read
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_ptr_read
)paren
suffix:semicolon
DECL|variable|snd_emu10k1_ptr_write
id|EXPORT_SYMBOL
c_func
(paren
id|snd_emu10k1_ptr_write
)paren
suffix:semicolon
eof
