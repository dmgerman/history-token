multiline_comment|/*&n; *&n; *  hda_intel.c - Implementation of primary alsa driver code base for Intel HD Audio.&n; *&n; *  Copyright(c) 2004 Intel Corporation. All rights reserved.&n; *&n; *  Copyright (c) 2004 Takashi Iwai &lt;tiwai@suse.de&gt;&n; *                     PeiSen Hou &lt;pshou@realtek.com.tw&gt;&n; *&n; *  This program is free software; you can redistribute it and/or modify it&n; *  under the terms of the GNU General Public License as published by the Free&n; *  Software Foundation; either version 2 of the License, or (at your option)&n; *  any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but WITHOUT&n; *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or&n; *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for&n; *  more details.&n; *&n; *  You should have received a copy of the GNU General Public License along with&n; *  this program; if not, write to the Free Software Foundation, Inc., 59&n; *  Temple Place - Suite 330, Boston, MA  02111-1307, USA.&n; *&n; *  CONTACTS:&n; *&n; *  Matt Jared&t;&t;matt.jared@intel.com&n; *  Andy Kopp&t;&t;andy.kopp@intel.com&n; *  Dan Kogan&t;&t;dan.d.kogan@intel.com&n; *&n; *  CHANGES:&n; *&n; *  2004.12.01&t;Major rewrite by tiwai, merged the work of pshou&n; * &n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/initval.h&gt;
macro_line|#include &quot;hda_codec.h&quot;
DECL|variable|index
r_static
r_int
id|index
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_IDX
suffix:semicolon
DECL|variable|enable
r_static
r_int
id|enable
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_ENABLE_PNP
suffix:semicolon
DECL|variable|id
r_static
r_char
op_star
id|id
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_STR
suffix:semicolon
DECL|variable|model
r_static
r_char
op_star
id|model
(braket
id|SNDRV_CARDS
)braket
suffix:semicolon
id|module_param_array
c_func
(paren
id|index
comma
r_int
comma
l_int|NULL
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|index
comma
l_string|&quot;Index value for Intel HD audio interface.&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|id
comma
id|charp
comma
l_int|NULL
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|id
comma
l_string|&quot;ID string for Intel HD audio interface.&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|enable
comma
r_bool
comma
l_int|NULL
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|enable
comma
l_string|&quot;Enable Intel HD audio interface.&quot;
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|model
comma
id|charp
comma
l_int|NULL
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|model
comma
l_string|&quot;Use the given board model.&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;{{Intel, ICH6},&quot;
l_string|&quot;{Intel, ICH6M},&quot;
l_string|&quot;{Intel, ICH7}}&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Intel HDA driver&quot;
)paren
suffix:semicolon
DECL|macro|SFX
mdefine_line|#define SFX&t;&quot;hda-intel: &quot;
multiline_comment|/*&n; * registers&n; */
DECL|macro|ICH6_REG_GCAP
mdefine_line|#define ICH6_REG_GCAP&t;&t;&t;0x00
DECL|macro|ICH6_REG_VMIN
mdefine_line|#define ICH6_REG_VMIN&t;&t;&t;0x02
DECL|macro|ICH6_REG_VMAJ
mdefine_line|#define ICH6_REG_VMAJ&t;&t;&t;0x03
DECL|macro|ICH6_REG_OUTPAY
mdefine_line|#define ICH6_REG_OUTPAY&t;&t;&t;0x04
DECL|macro|ICH6_REG_INPAY
mdefine_line|#define ICH6_REG_INPAY&t;&t;&t;0x06
DECL|macro|ICH6_REG_GCTL
mdefine_line|#define ICH6_REG_GCTL&t;&t;&t;0x08
DECL|macro|ICH6_REG_WAKEEN
mdefine_line|#define ICH6_REG_WAKEEN&t;&t;&t;0x0c
DECL|macro|ICH6_REG_STATESTS
mdefine_line|#define ICH6_REG_STATESTS&t;&t;0x0e
DECL|macro|ICH6_REG_GSTS
mdefine_line|#define ICH6_REG_GSTS&t;&t;&t;0x10
DECL|macro|ICH6_REG_INTCTL
mdefine_line|#define ICH6_REG_INTCTL&t;&t;&t;0x20
DECL|macro|ICH6_REG_INTSTS
mdefine_line|#define ICH6_REG_INTSTS&t;&t;&t;0x24
DECL|macro|ICH6_REG_WALCLK
mdefine_line|#define ICH6_REG_WALCLK&t;&t;&t;0x30
DECL|macro|ICH6_REG_SYNC
mdefine_line|#define ICH6_REG_SYNC&t;&t;&t;0x34&t;
DECL|macro|ICH6_REG_CORBLBASE
mdefine_line|#define ICH6_REG_CORBLBASE&t;&t;0x40
DECL|macro|ICH6_REG_CORBUBASE
mdefine_line|#define ICH6_REG_CORBUBASE&t;&t;0x44
DECL|macro|ICH6_REG_CORBWP
mdefine_line|#define ICH6_REG_CORBWP&t;&t;&t;0x48
DECL|macro|ICH6_REG_CORBRP
mdefine_line|#define ICH6_REG_CORBRP&t;&t;&t;0x4A
DECL|macro|ICH6_REG_CORBCTL
mdefine_line|#define ICH6_REG_CORBCTL&t;&t;0x4c
DECL|macro|ICH6_REG_CORBSTS
mdefine_line|#define ICH6_REG_CORBSTS&t;&t;0x4d
DECL|macro|ICH6_REG_CORBSIZE
mdefine_line|#define ICH6_REG_CORBSIZE&t;&t;0x4e
DECL|macro|ICH6_REG_RIRBLBASE
mdefine_line|#define ICH6_REG_RIRBLBASE&t;&t;0x50
DECL|macro|ICH6_REG_RIRBUBASE
mdefine_line|#define ICH6_REG_RIRBUBASE&t;&t;0x54
DECL|macro|ICH6_REG_RIRBWP
mdefine_line|#define ICH6_REG_RIRBWP&t;&t;&t;0x58
DECL|macro|ICH6_REG_RINTCNT
mdefine_line|#define ICH6_REG_RINTCNT&t;&t;0x5a
DECL|macro|ICH6_REG_RIRBCTL
mdefine_line|#define ICH6_REG_RIRBCTL&t;&t;0x5c
DECL|macro|ICH6_REG_RIRBSTS
mdefine_line|#define ICH6_REG_RIRBSTS&t;&t;0x5d
DECL|macro|ICH6_REG_RIRBSIZE
mdefine_line|#define ICH6_REG_RIRBSIZE&t;&t;0x5e
DECL|macro|ICH6_REG_IC
mdefine_line|#define ICH6_REG_IC&t;&t;&t;0x60
DECL|macro|ICH6_REG_IR
mdefine_line|#define ICH6_REG_IR&t;&t;&t;0x64
DECL|macro|ICH6_REG_IRS
mdefine_line|#define ICH6_REG_IRS&t;&t;&t;0x68
DECL|macro|ICH6_IRS_VALID
mdefine_line|#define   ICH6_IRS_VALID&t;(1&lt;&lt;1)
DECL|macro|ICH6_IRS_BUSY
mdefine_line|#define   ICH6_IRS_BUSY&t;&t;(1&lt;&lt;0)
DECL|macro|ICH6_REG_DPLBASE
mdefine_line|#define ICH6_REG_DPLBASE&t;&t;0x70
DECL|macro|ICH6_REG_DPUBASE
mdefine_line|#define ICH6_REG_DPUBASE&t;&t;0x74
DECL|macro|ICH6_DPLBASE_ENABLE
mdefine_line|#define   ICH6_DPLBASE_ENABLE&t;0x1&t;/* Enable position buffer */
multiline_comment|/* SD offset: SDI0=0x80, SDI1=0xa0, ... SDO3=0x160 */
DECL|enumerator|SDI0
DECL|enumerator|SDI1
DECL|enumerator|SDI2
DECL|enumerator|SDI3
DECL|enumerator|SDO0
DECL|enumerator|SDO1
DECL|enumerator|SDO2
DECL|enumerator|SDO3
r_enum
(brace
id|SDI0
comma
id|SDI1
comma
id|SDI2
comma
id|SDI3
comma
id|SDO0
comma
id|SDO1
comma
id|SDO2
comma
id|SDO3
)brace
suffix:semicolon
multiline_comment|/* stream register offsets from stream base */
DECL|macro|ICH6_REG_SD_CTL
mdefine_line|#define ICH6_REG_SD_CTL&t;&t;&t;0x00
DECL|macro|ICH6_REG_SD_STS
mdefine_line|#define ICH6_REG_SD_STS&t;&t;&t;0x03
DECL|macro|ICH6_REG_SD_LPIB
mdefine_line|#define ICH6_REG_SD_LPIB&t;&t;0x04
DECL|macro|ICH6_REG_SD_CBL
mdefine_line|#define ICH6_REG_SD_CBL&t;&t;&t;0x08
DECL|macro|ICH6_REG_SD_LVI
mdefine_line|#define ICH6_REG_SD_LVI&t;&t;&t;0x0c
DECL|macro|ICH6_REG_SD_FIFOW
mdefine_line|#define ICH6_REG_SD_FIFOW&t;&t;0x0e
DECL|macro|ICH6_REG_SD_FIFOSIZE
mdefine_line|#define ICH6_REG_SD_FIFOSIZE&t;&t;0x10
DECL|macro|ICH6_REG_SD_FORMAT
mdefine_line|#define ICH6_REG_SD_FORMAT&t;&t;0x12
DECL|macro|ICH6_REG_SD_BDLPL
mdefine_line|#define ICH6_REG_SD_BDLPL&t;&t;0x18
DECL|macro|ICH6_REG_SD_BDLPU
mdefine_line|#define ICH6_REG_SD_BDLPU&t;&t;0x1c
multiline_comment|/* PCI space */
DECL|macro|ICH6_PCIREG_TCSEL
mdefine_line|#define ICH6_PCIREG_TCSEL&t;0x44
multiline_comment|/*&n; * other constants&n; */
multiline_comment|/* max number of SDs */
DECL|macro|MAX_ICH6_DEV
mdefine_line|#define MAX_ICH6_DEV&t;&t;8
multiline_comment|/* max number of fragments - we may use more if allocating more pages for BDL */
DECL|macro|AZX_MAX_FRAG
mdefine_line|#define AZX_MAX_FRAG&t;&t;(PAGE_SIZE / (MAX_ICH6_DEV * 16))
multiline_comment|/* max buffer size - no h/w limit, you can increase as you like */
DECL|macro|AZX_MAX_BUF_SIZE
mdefine_line|#define AZX_MAX_BUF_SIZE&t;(1024*1024*1024)
multiline_comment|/* max number of PCM devics per card */
DECL|macro|AZX_MAX_PCMS
mdefine_line|#define AZX_MAX_PCMS&t;&t;8
multiline_comment|/* RIRB int mask: overrun[2], response[0] */
DECL|macro|RIRB_INT_RESPONSE
mdefine_line|#define RIRB_INT_RESPONSE&t;0x01
DECL|macro|RIRB_INT_OVERRUN
mdefine_line|#define RIRB_INT_OVERRUN&t;0x04
DECL|macro|RIRB_INT_MASK
mdefine_line|#define RIRB_INT_MASK&t;&t;0x05
multiline_comment|/* STATESTS int mask: SD2,SD1,SD0 */
DECL|macro|STATESTS_INT_MASK
mdefine_line|#define STATESTS_INT_MASK&t;0x07
DECL|macro|AZX_MAX_CODECS
mdefine_line|#define AZX_MAX_CODECS&t;&t;3
multiline_comment|/* SD_CTL bits */
DECL|macro|SD_CTL_STREAM_RESET
mdefine_line|#define SD_CTL_STREAM_RESET&t;0x01&t;/* stream reset bit */
DECL|macro|SD_CTL_DMA_START
mdefine_line|#define SD_CTL_DMA_START&t;0x02&t;/* stream DMA start bit */
DECL|macro|SD_CTL_STREAM_TAG_MASK
mdefine_line|#define SD_CTL_STREAM_TAG_MASK&t;(0xf &lt;&lt; 20)
DECL|macro|SD_CTL_STREAM_TAG_SHIFT
mdefine_line|#define SD_CTL_STREAM_TAG_SHIFT&t;20
multiline_comment|/* SD_CTL and SD_STS */
DECL|macro|SD_INT_DESC_ERR
mdefine_line|#define SD_INT_DESC_ERR&t;&t;0x10&t;/* descriptor error interrupt */
DECL|macro|SD_INT_FIFO_ERR
mdefine_line|#define SD_INT_FIFO_ERR&t;&t;0x08&t;/* FIFO error interrupt */
DECL|macro|SD_INT_COMPLETE
mdefine_line|#define SD_INT_COMPLETE&t;&t;0x04&t;/* completion interrupt */
DECL|macro|SD_INT_MASK
mdefine_line|#define SD_INT_MASK&t;&t;(SD_INT_DESC_ERR|SD_INT_FIFO_ERR|SD_INT_COMPLETE)
multiline_comment|/* SD_STS */
DECL|macro|SD_STS_FIFO_READY
mdefine_line|#define SD_STS_FIFO_READY&t;0x20&t;/* FIFO ready */
multiline_comment|/* INTCTL and INTSTS */
DECL|macro|ICH6_INT_ALL_STREAM
mdefine_line|#define ICH6_INT_ALL_STREAM&t;0xff&t;&t;/* all stream interrupts */
DECL|macro|ICH6_INT_CTRL_EN
mdefine_line|#define ICH6_INT_CTRL_EN&t;0x40000000&t;/* controller interrupt enable bit */
DECL|macro|ICH6_INT_GLOBAL_EN
mdefine_line|#define ICH6_INT_GLOBAL_EN&t;0x80000000&t;/* global interrupt enable bit */
multiline_comment|/* GCTL reset bit */
DECL|macro|ICH6_GCTL_RESET
mdefine_line|#define ICH6_GCTL_RESET&t;&t;(1&lt;&lt;0)
multiline_comment|/* CORB/RIRB control, read/write pointer */
DECL|macro|ICH6_RBCTL_DMA_EN
mdefine_line|#define ICH6_RBCTL_DMA_EN&t;0x02&t;/* enable DMA */
DECL|macro|ICH6_RBCTL_IRQ_EN
mdefine_line|#define ICH6_RBCTL_IRQ_EN&t;0x01&t;/* enable IRQ */
DECL|macro|ICH6_RBRWP_CLR
mdefine_line|#define ICH6_RBRWP_CLR&t;&t;0x8000&t;/* read/write pointer clear */
multiline_comment|/* below are so far hardcoded - should read registers in future */
DECL|macro|ICH6_MAX_CORB_ENTRIES
mdefine_line|#define ICH6_MAX_CORB_ENTRIES&t;256
DECL|macro|ICH6_MAX_RIRB_ENTRIES
mdefine_line|#define ICH6_MAX_RIRB_ENTRIES&t;256
multiline_comment|/*&n; * Use CORB/RIRB for communication from/to codecs.&n; * This is the way recommended by Intel (see below).&n; */
DECL|macro|USE_CORB_RIRB
mdefine_line|#define USE_CORB_RIRB
multiline_comment|/*&n; * Define this if use the position buffer instead of reading SD_LPIB&n; * It&squot;s not used as default since SD_LPIB seems to give more accurate position&n; */
multiline_comment|/* #define USE_POSBUF */
multiline_comment|/*&n; */
DECL|typedef|azx_t
r_typedef
r_struct
id|snd_azx
id|azx_t
suffix:semicolon
DECL|typedef|azx_rb_t
r_typedef
r_struct
id|snd_azx_rb
id|azx_rb_t
suffix:semicolon
DECL|typedef|azx_dev_t
r_typedef
r_struct
id|snd_azx_dev
id|azx_dev_t
suffix:semicolon
DECL|struct|snd_azx_dev
r_struct
id|snd_azx_dev
(brace
DECL|member|bdl
id|u32
op_star
id|bdl
suffix:semicolon
multiline_comment|/* virtual address of the BDL */
DECL|member|bdl_addr
id|dma_addr_t
id|bdl_addr
suffix:semicolon
multiline_comment|/* physical address of the BDL */
DECL|member|posbuf
r_volatile
id|u32
op_star
id|posbuf
suffix:semicolon
multiline_comment|/* position buffer pointer */
DECL|member|bufsize
r_int
r_int
id|bufsize
suffix:semicolon
multiline_comment|/* size of the play buffer in bytes */
DECL|member|fragsize
r_int
r_int
id|fragsize
suffix:semicolon
multiline_comment|/* size of each period in bytes */
DECL|member|frags
r_int
r_int
id|frags
suffix:semicolon
multiline_comment|/* number for period in the play buffer */
DECL|member|fifo_size
r_int
r_int
id|fifo_size
suffix:semicolon
multiline_comment|/* FIFO size */
DECL|member|sd_addr
r_void
id|__iomem
op_star
id|sd_addr
suffix:semicolon
multiline_comment|/* stream descriptor pointer */
DECL|member|sd_int_sta_mask
id|u32
id|sd_int_sta_mask
suffix:semicolon
multiline_comment|/* stream int status mask */
multiline_comment|/* pcm support */
DECL|member|substream
id|snd_pcm_substream_t
op_star
id|substream
suffix:semicolon
multiline_comment|/* assigned substream, set in PCM open */
DECL|member|format_val
r_int
r_int
id|format_val
suffix:semicolon
multiline_comment|/* format value to be set in the controller and the codec */
DECL|member|stream_tag
r_int
r_char
id|stream_tag
suffix:semicolon
multiline_comment|/* assigned stream */
DECL|member|index
r_int
r_char
id|index
suffix:semicolon
multiline_comment|/* stream index */
DECL|member|opened
r_int
r_int
id|opened
suffix:colon
l_int|1
suffix:semicolon
DECL|member|running
r_int
r_int
id|running
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* CORB/RIRB */
DECL|struct|snd_azx_rb
r_struct
id|snd_azx_rb
(brace
DECL|member|buf
id|u32
op_star
id|buf
suffix:semicolon
multiline_comment|/* CORB/RIRB buffer&n;&t;&t;&t;&t; * Each CORB entry is 4byte, RIRB is 8byte&n;&t;&t;&t;&t; */
DECL|member|addr
id|dma_addr_t
id|addr
suffix:semicolon
multiline_comment|/* physical address of CORB/RIRB buffer */
multiline_comment|/* for RIRB */
DECL|member|rp
DECL|member|wp
r_int
r_int
id|rp
comma
id|wp
suffix:semicolon
multiline_comment|/* read/write pointers */
DECL|member|cmds
r_int
id|cmds
suffix:semicolon
multiline_comment|/* number of pending requests */
DECL|member|res
id|u32
id|res
suffix:semicolon
multiline_comment|/* last read value */
)brace
suffix:semicolon
DECL|struct|snd_azx
r_struct
id|snd_azx
(brace
DECL|member|card
id|snd_card_t
op_star
id|card
suffix:semicolon
DECL|member|pci
r_struct
id|pci_dev
op_star
id|pci
suffix:semicolon
multiline_comment|/* pci resources */
DECL|member|addr
r_int
r_int
id|addr
suffix:semicolon
DECL|member|remap_addr
r_void
id|__iomem
op_star
id|remap_addr
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
multiline_comment|/* locks */
DECL|member|reg_lock
id|spinlock_t
id|reg_lock
suffix:semicolon
DECL|member|open_mutex
r_struct
id|semaphore
id|open_mutex
suffix:semicolon
multiline_comment|/* streams */
DECL|member|azx_dev
id|azx_dev_t
id|azx_dev
(braket
id|MAX_ICH6_DEV
)braket
suffix:semicolon
multiline_comment|/* PCM */
DECL|member|pcm_devs
r_int
r_int
id|pcm_devs
suffix:semicolon
DECL|member|pcm
id|snd_pcm_t
op_star
id|pcm
(braket
id|AZX_MAX_PCMS
)braket
suffix:semicolon
multiline_comment|/* HD codec */
DECL|member|codec_mask
r_int
r_int
id|codec_mask
suffix:semicolon
DECL|member|bus
r_struct
id|hda_bus
op_star
id|bus
suffix:semicolon
multiline_comment|/* CORB/RIRB */
DECL|member|corb
id|azx_rb_t
id|corb
suffix:semicolon
DECL|member|rirb
id|azx_rb_t
id|rirb
suffix:semicolon
multiline_comment|/* BDL, CORB/RIRB and position buffers */
DECL|member|bdl
r_struct
id|snd_dma_buffer
id|bdl
suffix:semicolon
DECL|member|rb
r_struct
id|snd_dma_buffer
id|rb
suffix:semicolon
DECL|member|posbuf
r_struct
id|snd_dma_buffer
id|posbuf
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * macros for easy use&n; */
DECL|macro|azx_writel
mdefine_line|#define azx_writel(chip,reg,value) &bslash;&n;&t;writel(value, (chip)-&gt;remap_addr + ICH6_REG_##reg)
DECL|macro|azx_readl
mdefine_line|#define azx_readl(chip,reg) &bslash;&n;&t;readl((chip)-&gt;remap_addr + ICH6_REG_##reg)
DECL|macro|azx_writew
mdefine_line|#define azx_writew(chip,reg,value) &bslash;&n;&t;writew(value, (chip)-&gt;remap_addr + ICH6_REG_##reg)
DECL|macro|azx_readw
mdefine_line|#define azx_readw(chip,reg) &bslash;&n;&t;readw((chip)-&gt;remap_addr + ICH6_REG_##reg)
DECL|macro|azx_writeb
mdefine_line|#define azx_writeb(chip,reg,value) &bslash;&n;&t;writeb(value, (chip)-&gt;remap_addr + ICH6_REG_##reg)
DECL|macro|azx_readb
mdefine_line|#define azx_readb(chip,reg) &bslash;&n;&t;readb((chip)-&gt;remap_addr + ICH6_REG_##reg)
DECL|macro|azx_sd_writel
mdefine_line|#define azx_sd_writel(dev,reg,value) &bslash;&n;&t;writel(value, (dev)-&gt;sd_addr + ICH6_REG_##reg)
DECL|macro|azx_sd_readl
mdefine_line|#define azx_sd_readl(dev,reg) &bslash;&n;&t;readl((dev)-&gt;sd_addr + ICH6_REG_##reg)
DECL|macro|azx_sd_writew
mdefine_line|#define azx_sd_writew(dev,reg,value) &bslash;&n;&t;writew(value, (dev)-&gt;sd_addr + ICH6_REG_##reg)
DECL|macro|azx_sd_readw
mdefine_line|#define azx_sd_readw(dev,reg) &bslash;&n;&t;readw((dev)-&gt;sd_addr + ICH6_REG_##reg)
DECL|macro|azx_sd_writeb
mdefine_line|#define azx_sd_writeb(dev,reg,value) &bslash;&n;&t;writeb(value, (dev)-&gt;sd_addr + ICH6_REG_##reg)
DECL|macro|azx_sd_readb
mdefine_line|#define azx_sd_readb(dev,reg) &bslash;&n;&t;readb((dev)-&gt;sd_addr + ICH6_REG_##reg)
multiline_comment|/* for pcm support */
DECL|macro|get_azx_dev
mdefine_line|#define get_azx_dev(substream) (azx_dev_t*)(substream-&gt;runtime-&gt;private_data)
multiline_comment|/* Get the upper 32bit of the given dma_addr_t&n; * Compiler should optimize and eliminate the code if dma_addr_t is 32bit&n; */
DECL|macro|upper_32bit
mdefine_line|#define upper_32bit(addr) (sizeof(addr) &gt; 4 ? (u32)((addr) &gt;&gt; 32) : (u32)0)
multiline_comment|/*&n; * Interface for HD codec&n; */
macro_line|#ifdef USE_CORB_RIRB
multiline_comment|/*&n; * CORB / RIRB interface&n; */
DECL|function|azx_alloc_cmd_io
r_static
r_int
id|azx_alloc_cmd_io
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/* single page (at least 4096 bytes) must suffice for both ringbuffes */
id|err
op_assign
id|snd_dma_alloc_pages
c_func
(paren
id|SNDRV_DMA_TYPE_DEV
comma
id|snd_dma_pci_data
c_func
(paren
id|chip-&gt;pci
)paren
comma
id|PAGE_SIZE
comma
op_amp
id|chip-&gt;rb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;cannot allocate CORB/RIRB&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|azx_init_cmd_io
r_static
r_void
id|azx_init_cmd_io
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
multiline_comment|/* CORB set up */
id|chip-&gt;corb.addr
op_assign
id|chip-&gt;rb.addr
suffix:semicolon
id|chip-&gt;corb.buf
op_assign
(paren
id|u32
op_star
)paren
id|chip-&gt;rb.area
suffix:semicolon
id|azx_writel
c_func
(paren
id|chip
comma
id|CORBLBASE
comma
(paren
id|u32
)paren
id|chip-&gt;corb.addr
)paren
suffix:semicolon
id|azx_writel
c_func
(paren
id|chip
comma
id|CORBUBASE
comma
id|upper_32bit
c_func
(paren
id|chip-&gt;corb.addr
)paren
)paren
suffix:semicolon
multiline_comment|/* set the corb write pointer to 0 */
id|azx_writew
c_func
(paren
id|chip
comma
id|CORBWP
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reset the corb hw read pointer */
id|azx_writew
c_func
(paren
id|chip
comma
id|CORBRP
comma
id|ICH6_RBRWP_CLR
)paren
suffix:semicolon
multiline_comment|/* enable corb dma */
id|azx_writeb
c_func
(paren
id|chip
comma
id|CORBCTL
comma
id|ICH6_RBCTL_DMA_EN
)paren
suffix:semicolon
multiline_comment|/* RIRB set up */
id|chip-&gt;rirb.addr
op_assign
id|chip-&gt;rb.addr
op_plus
l_int|2048
suffix:semicolon
id|chip-&gt;rirb.buf
op_assign
(paren
id|u32
op_star
)paren
(paren
id|chip-&gt;rb.area
op_plus
l_int|2048
)paren
suffix:semicolon
id|azx_writel
c_func
(paren
id|chip
comma
id|RIRBLBASE
comma
(paren
id|u32
)paren
id|chip-&gt;rirb.addr
)paren
suffix:semicolon
id|azx_writel
c_func
(paren
id|chip
comma
id|RIRBUBASE
comma
id|upper_32bit
c_func
(paren
id|chip-&gt;rirb.addr
)paren
)paren
suffix:semicolon
multiline_comment|/* reset the rirb hw write pointer */
id|azx_writew
c_func
(paren
id|chip
comma
id|RIRBWP
comma
id|ICH6_RBRWP_CLR
)paren
suffix:semicolon
multiline_comment|/* set N=1, get RIRB response interrupt for new entry */
id|azx_writew
c_func
(paren
id|chip
comma
id|RINTCNT
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* enable rirb dma and response irq */
macro_line|#ifdef USE_CORB_RIRB
id|azx_writeb
c_func
(paren
id|chip
comma
id|RIRBCTL
comma
id|ICH6_RBCTL_DMA_EN
op_or
id|ICH6_RBCTL_IRQ_EN
)paren
suffix:semicolon
macro_line|#else
id|azx_writeb
c_func
(paren
id|chip
comma
id|RIRBCTL
comma
id|ICH6_RBCTL_DMA_EN
)paren
suffix:semicolon
macro_line|#endif
id|chip-&gt;rirb.rp
op_assign
id|chip-&gt;rirb.cmds
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|azx_free_cmd_io
r_static
r_void
id|azx_free_cmd_io
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
multiline_comment|/* disable ringbuffer DMAs */
id|azx_writeb
c_func
(paren
id|chip
comma
id|RIRBCTL
comma
l_int|0
)paren
suffix:semicolon
id|azx_writeb
c_func
(paren
id|chip
comma
id|CORBCTL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* send a command */
DECL|function|azx_send_cmd
r_static
r_int
id|azx_send_cmd
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
id|hda_nid_t
id|nid
comma
r_int
id|direct
comma
r_int
r_int
id|verb
comma
r_int
r_int
id|para
)paren
(brace
id|azx_t
op_star
id|chip
op_assign
id|codec-&gt;bus-&gt;private_data
suffix:semicolon
r_int
r_int
id|wp
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|val
op_assign
(paren
id|u32
)paren
(paren
id|codec-&gt;addr
op_amp
l_int|0x0f
)paren
op_lshift
l_int|28
suffix:semicolon
id|val
op_or_assign
(paren
id|u32
)paren
id|direct
op_lshift
l_int|27
suffix:semicolon
id|val
op_or_assign
(paren
id|u32
)paren
id|nid
op_lshift
l_int|20
suffix:semicolon
id|val
op_or_assign
id|verb
op_lshift
l_int|8
suffix:semicolon
id|val
op_or_assign
id|para
suffix:semicolon
multiline_comment|/* add command to corb */
id|wp
op_assign
id|azx_readb
c_func
(paren
id|chip
comma
id|CORBWP
)paren
suffix:semicolon
id|wp
op_increment
suffix:semicolon
id|wp
op_mod_assign
id|ICH6_MAX_CORB_ENTRIES
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|chip-&gt;rirb.cmds
op_increment
suffix:semicolon
id|chip-&gt;corb.buf
(braket
id|wp
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|val
)paren
suffix:semicolon
id|azx_writel
c_func
(paren
id|chip
comma
id|CORBWP
comma
id|wp
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|ICH6_RIRB_EX_UNSOL_EV
mdefine_line|#define ICH6_RIRB_EX_UNSOL_EV&t;(1&lt;&lt;4)
multiline_comment|/* retrieve RIRB entry - called from interrupt handler */
DECL|function|azx_update_rirb
r_static
r_void
id|azx_update_rirb
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_int
r_int
id|rp
comma
id|wp
suffix:semicolon
id|u32
id|res
comma
id|res_ex
suffix:semicolon
id|wp
op_assign
id|azx_readb
c_func
(paren
id|chip
comma
id|RIRBWP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wp
op_eq
id|chip-&gt;rirb.wp
)paren
r_return
suffix:semicolon
id|chip-&gt;rirb.wp
op_assign
id|wp
suffix:semicolon
r_while
c_loop
(paren
id|chip-&gt;rirb.rp
op_ne
id|wp
)paren
(brace
id|chip-&gt;rirb.rp
op_increment
suffix:semicolon
id|chip-&gt;rirb.rp
op_mod_assign
id|ICH6_MAX_RIRB_ENTRIES
suffix:semicolon
id|rp
op_assign
id|chip-&gt;rirb.rp
op_lshift
l_int|1
suffix:semicolon
multiline_comment|/* an RIRB entry is 8-bytes */
id|res_ex
op_assign
id|le32_to_cpu
c_func
(paren
id|chip-&gt;rirb.buf
(braket
id|rp
op_plus
l_int|1
)braket
)paren
suffix:semicolon
id|res
op_assign
id|le32_to_cpu
c_func
(paren
id|chip-&gt;rirb.buf
(braket
id|rp
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res_ex
op_amp
id|ICH6_RIRB_EX_UNSOL_EV
)paren
id|snd_hda_queue_unsol_event
c_func
(paren
id|chip-&gt;bus
comma
id|res
comma
id|res_ex
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|chip-&gt;rirb.cmds
)paren
(brace
id|chip-&gt;rirb.cmds
op_decrement
suffix:semicolon
id|chip-&gt;rirb.res
op_assign
id|res
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* receive a response */
DECL|function|azx_get_response
r_static
r_int
r_int
id|azx_get_response
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
id|azx_t
op_star
id|chip
op_assign
id|codec-&gt;bus-&gt;private_data
suffix:semicolon
r_int
id|timeout
op_assign
l_int|50
suffix:semicolon
r_while
c_loop
(paren
id|chip-&gt;rirb.cmds
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|timeout
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;azx_get_response timeout&bslash;n&quot;
)paren
suffix:semicolon
id|chip-&gt;rirb.rp
op_assign
id|azx_readb
c_func
(paren
id|chip
comma
id|RIRBWP
)paren
suffix:semicolon
id|chip-&gt;rirb.cmds
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|chip-&gt;rirb.res
suffix:semicolon
multiline_comment|/* the last value */
)brace
macro_line|#else
multiline_comment|/*&n; * Use the single immediate command instead of CORB/RIRB for simplicity&n; *&n; * Note: according to Intel, this is not preferred use.  The command was&n; *       intended for the BIOS only, and may get confused with unsolicited&n; *       responses.  So, we shouldn&squot;t use it for normal operation from the&n; *       driver.&n; *       I left the codes, however, for debugging/testing purposes.&n; */
DECL|macro|azx_alloc_cmd_io
mdefine_line|#define azx_alloc_cmd_io(chip)&t;0
DECL|macro|azx_init_cmd_io
mdefine_line|#define azx_init_cmd_io(chip)
DECL|macro|azx_free_cmd_io
mdefine_line|#define azx_free_cmd_io(chip)
multiline_comment|/* send a command */
DECL|function|azx_send_cmd
r_static
r_int
id|azx_send_cmd
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
id|hda_nid_t
id|nid
comma
r_int
id|direct
comma
r_int
r_int
id|verb
comma
r_int
r_int
id|para
)paren
(brace
id|azx_t
op_star
id|chip
op_assign
id|codec-&gt;bus-&gt;private_data
suffix:semicolon
id|u32
id|val
suffix:semicolon
r_int
id|timeout
op_assign
l_int|50
suffix:semicolon
id|val
op_assign
(paren
id|u32
)paren
(paren
id|codec-&gt;addr
op_amp
l_int|0x0f
)paren
op_lshift
l_int|28
suffix:semicolon
id|val
op_or_assign
(paren
id|u32
)paren
id|direct
op_lshift
l_int|27
suffix:semicolon
id|val
op_or_assign
(paren
id|u32
)paren
id|nid
op_lshift
l_int|20
suffix:semicolon
id|val
op_or_assign
id|verb
op_lshift
l_int|8
suffix:semicolon
id|val
op_or_assign
id|para
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_decrement
)paren
(brace
multiline_comment|/* check ICB busy bit */
r_if
c_cond
(paren
op_logical_neg
(paren
id|azx_readw
c_func
(paren
id|chip
comma
id|IRS
)paren
op_amp
id|ICH6_IRS_BUSY
)paren
)paren
(brace
multiline_comment|/* Clear IRV valid bit */
id|azx_writew
c_func
(paren
id|chip
comma
id|IRS
comma
id|azx_readw
c_func
(paren
id|chip
comma
id|IRS
)paren
op_or
id|ICH6_IRS_VALID
)paren
suffix:semicolon
id|azx_writel
c_func
(paren
id|chip
comma
id|IC
comma
id|val
)paren
suffix:semicolon
id|azx_writew
c_func
(paren
id|chip
comma
id|IRS
comma
id|azx_readw
c_func
(paren
id|chip
comma
id|IRS
)paren
op_or
id|ICH6_IRS_BUSY
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|snd_printd
c_func
(paren
id|SFX
l_string|&quot;send_cmd timeout: IRS=0x%x, val=0x%x&bslash;n&quot;
comma
id|azx_readw
c_func
(paren
id|chip
comma
id|IRS
)paren
comma
id|val
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* receive a response */
DECL|function|azx_get_response
r_static
r_int
r_int
id|azx_get_response
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
id|azx_t
op_star
id|chip
op_assign
id|codec-&gt;bus-&gt;private_data
suffix:semicolon
r_int
id|timeout
op_assign
l_int|50
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_decrement
)paren
(brace
multiline_comment|/* check IRV busy bit */
r_if
c_cond
(paren
id|azx_readw
c_func
(paren
id|chip
comma
id|IRS
)paren
op_amp
id|ICH6_IRS_VALID
)paren
r_return
id|azx_readl
c_func
(paren
id|chip
comma
id|IR
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|snd_printd
c_func
(paren
id|SFX
l_string|&quot;get_response timeout: IRS=0x%x&bslash;n&quot;
comma
id|azx_readw
c_func
(paren
id|chip
comma
id|IRS
)paren
)paren
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
op_minus
l_int|1
suffix:semicolon
)brace
DECL|macro|azx_update_rirb
mdefine_line|#define azx_update_rirb(chip)
macro_line|#endif /* USE_CORB_RIRB */
multiline_comment|/* reset codec link */
DECL|function|azx_reset
r_static
r_int
id|azx_reset
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_int
id|count
suffix:semicolon
multiline_comment|/* reset controller */
id|azx_writel
c_func
(paren
id|chip
comma
id|GCTL
comma
id|azx_readl
c_func
(paren
id|chip
comma
id|GCTL
)paren
op_amp
op_complement
id|ICH6_GCTL_RESET
)paren
suffix:semicolon
id|count
op_assign
l_int|50
suffix:semicolon
r_while
c_loop
(paren
id|azx_readb
c_func
(paren
id|chip
comma
id|GCTL
)paren
op_logical_and
op_decrement
id|count
)paren
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* delay for &gt;= 100us for codec PLL to settle per spec&n;&t; * Rev 0.9 section 5.5.1&n;&t; */
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Bring controller out of reset */
id|azx_writeb
c_func
(paren
id|chip
comma
id|GCTL
comma
id|azx_readb
c_func
(paren
id|chip
comma
id|GCTL
)paren
op_or
id|ICH6_GCTL_RESET
)paren
suffix:semicolon
id|count
op_assign
l_int|50
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|azx_readb
c_func
(paren
id|chip
comma
id|GCTL
)paren
op_logical_and
op_decrement
id|count
)paren
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Brent Chartrand said to wait &gt;= 540us for codecs to intialize */
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* check to see if controller is ready */
r_if
c_cond
(paren
op_logical_neg
id|azx_readb
c_func
(paren
id|chip
comma
id|GCTL
)paren
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;azx_reset: controller not ready!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* detect codecs */
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;codec_mask
)paren
(brace
id|chip-&gt;codec_mask
op_assign
id|azx_readw
c_func
(paren
id|chip
comma
id|STATESTS
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;codec_mask = 0x%x&bslash;n&quot;
comma
id|chip-&gt;codec_mask
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Lowlevel interface&n; */
multiline_comment|/* enable interrupts */
DECL|function|azx_int_enable
r_static
r_void
id|azx_int_enable
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
multiline_comment|/* enable controller CIE and GIE */
id|azx_writel
c_func
(paren
id|chip
comma
id|INTCTL
comma
id|azx_readl
c_func
(paren
id|chip
comma
id|INTCTL
)paren
op_or
id|ICH6_INT_CTRL_EN
op_or
id|ICH6_INT_GLOBAL_EN
)paren
suffix:semicolon
)brace
multiline_comment|/* disable interrupts */
DECL|function|azx_int_disable
r_static
r_void
id|azx_int_disable
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* disable interrupts in stream descriptor */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ICH6_DEV
suffix:semicolon
id|i
op_increment
)paren
(brace
id|azx_dev_t
op_star
id|azx_dev
op_assign
op_amp
id|chip-&gt;azx_dev
(braket
id|i
)braket
suffix:semicolon
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
id|azx_sd_readb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
op_amp
op_complement
id|SD_INT_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/* disable SIE for all streams */
id|azx_writeb
c_func
(paren
id|chip
comma
id|INTCTL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable controller CIE and GIE */
id|azx_writel
c_func
(paren
id|chip
comma
id|INTCTL
comma
id|azx_readl
c_func
(paren
id|chip
comma
id|INTCTL
)paren
op_amp
op_complement
(paren
id|ICH6_INT_CTRL_EN
op_or
id|ICH6_INT_GLOBAL_EN
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* clear interrupts */
DECL|function|azx_int_clear
r_static
r_void
id|azx_int_clear
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* clear stream status */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ICH6_DEV
suffix:semicolon
id|i
op_increment
)paren
(brace
id|azx_dev_t
op_star
id|azx_dev
op_assign
op_amp
id|chip-&gt;azx_dev
(braket
id|i
)braket
suffix:semicolon
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_STS
comma
id|SD_INT_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/* clear STATESTS */
id|azx_writeb
c_func
(paren
id|chip
comma
id|STATESTS
comma
id|STATESTS_INT_MASK
)paren
suffix:semicolon
multiline_comment|/* clear rirb status */
id|azx_writeb
c_func
(paren
id|chip
comma
id|RIRBSTS
comma
id|RIRB_INT_MASK
)paren
suffix:semicolon
multiline_comment|/* clear int status */
id|azx_writel
c_func
(paren
id|chip
comma
id|INTSTS
comma
id|ICH6_INT_CTRL_EN
op_or
id|ICH6_INT_ALL_STREAM
)paren
suffix:semicolon
)brace
multiline_comment|/* start a stream */
DECL|function|azx_stream_start
r_static
r_void
id|azx_stream_start
c_func
(paren
id|azx_t
op_star
id|chip
comma
id|azx_dev_t
op_star
id|azx_dev
)paren
(brace
multiline_comment|/* enable SIE */
id|azx_writeb
c_func
(paren
id|chip
comma
id|INTCTL
comma
id|azx_readb
c_func
(paren
id|chip
comma
id|INTCTL
)paren
op_or
(paren
l_int|1
op_lshift
id|azx_dev-&gt;index
)paren
)paren
suffix:semicolon
multiline_comment|/* set DMA start and interrupt mask */
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
id|azx_sd_readb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
op_or
id|SD_CTL_DMA_START
op_or
id|SD_INT_MASK
)paren
suffix:semicolon
)brace
multiline_comment|/* stop a stream */
DECL|function|azx_stream_stop
r_static
r_void
id|azx_stream_stop
c_func
(paren
id|azx_t
op_star
id|chip
comma
id|azx_dev_t
op_star
id|azx_dev
)paren
(brace
multiline_comment|/* stop DMA */
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
id|azx_sd_readb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
op_amp
op_complement
(paren
id|SD_CTL_DMA_START
op_or
id|SD_INT_MASK
)paren
)paren
suffix:semicolon
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_STS
comma
id|SD_INT_MASK
)paren
suffix:semicolon
multiline_comment|/* to be sure */
multiline_comment|/* disable SIE */
id|azx_writeb
c_func
(paren
id|chip
comma
id|INTCTL
comma
id|azx_readb
c_func
(paren
id|chip
comma
id|INTCTL
)paren
op_amp
op_complement
(paren
l_int|1
op_lshift
id|azx_dev-&gt;index
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * initialize the chip&n; */
DECL|function|azx_init_chip
r_static
r_void
id|azx_init_chip
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_int
r_char
id|tcsel_reg
suffix:semicolon
multiline_comment|/* Clear bits 0-2 of PCI register TCSEL (at offset 0x44)&n;&t; * TCSEL == Traffic Class Select Register, which sets PCI express QOS&n;&t; * Ensuring these bits are 0 clears playback static on some HD Audio codecs&n;&t; */
id|pci_read_config_byte
(paren
id|chip-&gt;pci
comma
id|ICH6_PCIREG_TCSEL
comma
op_amp
id|tcsel_reg
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|chip-&gt;pci
comma
id|ICH6_PCIREG_TCSEL
comma
id|tcsel_reg
op_amp
l_int|0xf8
)paren
suffix:semicolon
multiline_comment|/* reset controller */
id|azx_reset
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* initialize interrupts */
id|azx_int_clear
c_func
(paren
id|chip
)paren
suffix:semicolon
id|azx_int_enable
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* initialize the codec command I/O */
id|azx_init_cmd_io
c_func
(paren
id|chip
)paren
suffix:semicolon
macro_line|#ifdef USE_POSBUF
multiline_comment|/* program the position buffer */
id|azx_writel
c_func
(paren
id|chip
comma
id|DPLBASE
comma
(paren
id|u32
)paren
id|chip-&gt;posbuf.addr
)paren
suffix:semicolon
id|azx_writel
c_func
(paren
id|chip
comma
id|DPUBASE
comma
id|upper_32bit
c_func
(paren
id|chip-&gt;posbuf.addr
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * interrupt handler&n; */
DECL|function|azx_interrupt
r_static
id|irqreturn_t
id|azx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|azx_t
op_star
id|chip
op_assign
id|dev_id
suffix:semicolon
id|azx_dev_t
op_star
id|azx_dev
suffix:semicolon
id|u32
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|status
op_assign
id|azx_readl
c_func
(paren
id|chip
comma
id|INTSTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ICH6_DEV
suffix:semicolon
id|i
op_increment
)paren
(brace
id|azx_dev
op_assign
op_amp
id|chip-&gt;azx_dev
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|azx_dev-&gt;sd_int_sta_mask
)paren
(brace
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_STS
comma
id|SD_INT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|azx_dev-&gt;substream
op_logical_and
id|azx_dev-&gt;running
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|snd_pcm_period_elapsed
c_func
(paren
id|azx_dev-&gt;substream
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* clear rirb int */
id|status
op_assign
id|azx_readb
c_func
(paren
id|chip
comma
id|RIRBSTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|RIRB_INT_MASK
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|RIRB_INT_RESPONSE
)paren
id|azx_update_rirb
c_func
(paren
id|chip
)paren
suffix:semicolon
id|azx_writeb
c_func
(paren
id|chip
comma
id|RIRBSTS
comma
id|RIRB_INT_MASK
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* clear state status int */
r_if
c_cond
(paren
id|azx_readb
c_func
(paren
id|chip
comma
id|STATESTS
)paren
op_amp
l_int|0x04
)paren
id|azx_writeb
c_func
(paren
id|chip
comma
id|STATESTS
comma
l_int|0x04
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * set up BDL entries&n; */
DECL|function|azx_setup_periods
r_static
r_void
id|azx_setup_periods
c_func
(paren
id|azx_dev_t
op_star
id|azx_dev
)paren
(brace
id|u32
op_star
id|bdl
op_assign
id|azx_dev-&gt;bdl
suffix:semicolon
id|dma_addr_t
id|dma_addr
op_assign
id|azx_dev-&gt;substream-&gt;runtime-&gt;dma_addr
suffix:semicolon
r_int
id|idx
suffix:semicolon
multiline_comment|/* reset BDL address */
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_BDLPL
comma
l_int|0
)paren
suffix:semicolon
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_BDLPU
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* program the initial BDL entries */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|azx_dev-&gt;frags
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_int
r_int
id|off
op_assign
id|idx
op_lshift
l_int|2
suffix:semicolon
multiline_comment|/* 4 dword step */
id|dma_addr_t
id|addr
op_assign
id|dma_addr
op_plus
id|idx
op_star
id|azx_dev-&gt;fragsize
suffix:semicolon
multiline_comment|/* program the address field of the BDL entry */
id|bdl
(braket
id|off
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
id|addr
)paren
suffix:semicolon
id|bdl
(braket
id|off
op_plus
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|upper_32bit
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
multiline_comment|/* program the size field of the BDL entry */
id|bdl
(braket
id|off
op_plus
l_int|2
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|azx_dev-&gt;fragsize
)paren
suffix:semicolon
multiline_comment|/* program the IOC to enable interrupt when buffer completes */
id|bdl
(braket
id|off
op_plus
l_int|3
)braket
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x01
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * set up the SD for streaming&n; */
DECL|function|azx_setup_controller
r_static
r_int
id|azx_setup_controller
c_func
(paren
id|azx_t
op_star
id|chip
comma
id|azx_dev_t
op_star
id|azx_dev
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
r_int
id|timeout
suffix:semicolon
multiline_comment|/* make sure the run bit is zero for SD */
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
id|azx_sd_readb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
op_amp
op_complement
id|SD_CTL_DMA_START
)paren
suffix:semicolon
multiline_comment|/* reset stream */
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
id|azx_sd_readb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
op_or
id|SD_CTL_STREAM_RESET
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|timeout
op_assign
l_int|300
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
(paren
id|val
op_assign
id|azx_sd_readb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
)paren
op_amp
id|SD_CTL_STREAM_RESET
)paren
op_logical_and
op_decrement
id|timeout
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|SD_CTL_STREAM_RESET
suffix:semicolon
id|azx_sd_writeb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
id|val
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|timeout
op_assign
l_int|300
suffix:semicolon
multiline_comment|/* waiting for hardware to report that the stream is out of reset */
r_while
c_loop
(paren
(paren
(paren
id|val
op_assign
id|azx_sd_readb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
)paren
op_amp
id|SD_CTL_STREAM_RESET
)paren
op_logical_and
op_decrement
id|timeout
)paren
suffix:semicolon
multiline_comment|/* program the stream_tag */
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
(paren
id|azx_sd_readl
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
op_amp
op_complement
id|SD_CTL_STREAM_TAG_MASK
)paren
op_or
(paren
id|azx_dev-&gt;stream_tag
op_lshift
id|SD_CTL_STREAM_TAG_SHIFT
)paren
)paren
suffix:semicolon
multiline_comment|/* program the length of samples in cyclic buffer */
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_CBL
comma
id|azx_dev-&gt;bufsize
)paren
suffix:semicolon
multiline_comment|/* program the stream format */
multiline_comment|/* this value needs to be the same as the one programmed */
id|azx_sd_writew
c_func
(paren
id|azx_dev
comma
id|SD_FORMAT
comma
id|azx_dev-&gt;format_val
)paren
suffix:semicolon
multiline_comment|/* program the stream LVI (last valid index) of the BDL */
id|azx_sd_writew
c_func
(paren
id|azx_dev
comma
id|SD_LVI
comma
id|azx_dev-&gt;frags
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* program the BDL address */
multiline_comment|/* lower BDL address */
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_BDLPL
comma
(paren
id|u32
)paren
id|azx_dev-&gt;bdl_addr
)paren
suffix:semicolon
multiline_comment|/* upper BDL address */
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_BDLPU
comma
id|upper_32bit
c_func
(paren
id|azx_dev-&gt;bdl_addr
)paren
)paren
suffix:semicolon
macro_line|#ifdef USE_POSBUF
multiline_comment|/* enable the position buffer */
r_if
c_cond
(paren
op_logical_neg
(paren
id|azx_readl
c_func
(paren
id|chip
comma
id|DPLBASE
)paren
op_amp
id|ICH6_DPLBASE_ENABLE
)paren
)paren
id|azx_writel
c_func
(paren
id|chip
comma
id|DPLBASE
comma
(paren
id|u32
)paren
id|chip-&gt;posbuf.addr
op_or
id|ICH6_DPLBASE_ENABLE
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* set the interrupt enable bits in the descriptor control register */
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
id|azx_sd_readl
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
op_or
id|SD_INT_MASK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Codec initialization&n; */
DECL|function|azx_codec_create
r_static
r_int
id|__devinit
id|azx_codec_create
c_func
(paren
id|azx_t
op_star
id|chip
comma
r_const
r_char
op_star
id|model
)paren
(brace
r_struct
id|hda_bus_template
id|bus_temp
suffix:semicolon
r_int
id|c
comma
id|codecs
comma
id|err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|bus_temp
comma
l_int|0
comma
r_sizeof
(paren
id|bus_temp
)paren
)paren
suffix:semicolon
id|bus_temp.private_data
op_assign
id|chip
suffix:semicolon
id|bus_temp.modelname
op_assign
id|model
suffix:semicolon
id|bus_temp.pci
op_assign
id|chip-&gt;pci
suffix:semicolon
id|bus_temp.ops.command
op_assign
id|azx_send_cmd
suffix:semicolon
id|bus_temp.ops.get_response
op_assign
id|azx_get_response
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_hda_bus_new
c_func
(paren
id|chip-&gt;card
comma
op_amp
id|bus_temp
comma
op_amp
id|chip-&gt;bus
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|codecs
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|AZX_MAX_CODECS
suffix:semicolon
id|c
op_increment
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;codec_mask
op_amp
(paren
l_int|1
op_lshift
id|c
)paren
)paren
(brace
id|err
op_assign
id|snd_hda_codec_new
c_func
(paren
id|chip-&gt;bus
comma
id|c
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_continue
suffix:semicolon
id|codecs
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|codecs
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;no codecs initialized&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * PCM support&n; */
multiline_comment|/* assign a stream for the PCM */
DECL|function|azx_assign_device
r_static
r_inline
id|azx_dev_t
op_star
id|azx_assign_device
c_func
(paren
id|azx_t
op_star
id|chip
comma
r_int
id|stream
)paren
(brace
r_int
id|dev
comma
id|i
suffix:semicolon
id|dev
op_assign
id|stream
op_eq
id|SNDRV_PCM_STREAM_PLAYBACK
ques
c_cond
l_int|4
suffix:colon
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
comma
id|dev
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;azx_dev
(braket
id|dev
)braket
dot
id|opened
)paren
(brace
id|chip-&gt;azx_dev
(braket
id|dev
)braket
dot
id|opened
op_assign
l_int|1
suffix:semicolon
r_return
op_amp
id|chip-&gt;azx_dev
(braket
id|dev
)braket
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* release the assigned stream */
DECL|function|azx_release_device
r_static
r_inline
r_void
id|azx_release_device
c_func
(paren
id|azx_dev_t
op_star
id|azx_dev
)paren
(brace
id|azx_dev-&gt;opened
op_assign
l_int|0
suffix:semicolon
)brace
DECL|variable|azx_pcm_hw
r_static
id|snd_pcm_hardware_t
id|azx_pcm_hw
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_BLOCK_TRANSFER
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_PAUSE
op_or
id|SNDRV_PCM_INFO_RESUME
)paren
comma
dot
id|formats
op_assign
id|SNDRV_PCM_FMTBIT_S16_LE
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_48000
comma
dot
id|rate_min
op_assign
l_int|48000
comma
dot
id|rate_max
op_assign
l_int|48000
comma
dot
id|channels_min
op_assign
l_int|2
comma
dot
id|channels_max
op_assign
l_int|2
comma
dot
id|buffer_bytes_max
op_assign
id|AZX_MAX_BUF_SIZE
comma
dot
id|period_bytes_min
op_assign
l_int|128
comma
dot
id|period_bytes_max
op_assign
id|AZX_MAX_BUF_SIZE
op_div
l_int|2
comma
dot
id|periods_min
op_assign
l_int|2
comma
dot
id|periods_max
op_assign
id|AZX_MAX_FRAG
comma
dot
id|fifo_size
op_assign
l_int|0
comma
)brace
suffix:semicolon
DECL|struct|azx_pcm
r_struct
id|azx_pcm
(brace
DECL|member|chip
id|azx_t
op_star
id|chip
suffix:semicolon
DECL|member|codec
r_struct
id|hda_codec
op_star
id|codec
suffix:semicolon
DECL|member|hinfo
r_struct
id|hda_pcm_stream
op_star
id|hinfo
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|azx_pcm_open
r_static
r_int
id|azx_pcm_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
r_struct
id|azx_pcm
op_star
id|apcm
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
r_struct
id|hda_pcm_stream
op_star
id|hinfo
op_assign
id|apcm-&gt;hinfo
(braket
id|substream-&gt;stream
)braket
suffix:semicolon
id|azx_t
op_star
id|chip
op_assign
id|apcm-&gt;chip
suffix:semicolon
id|azx_dev_t
op_star
id|azx_dev
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
id|down
c_func
(paren
op_amp
id|chip-&gt;open_mutex
)paren
suffix:semicolon
id|azx_dev
op_assign
id|azx_assign_device
c_func
(paren
id|chip
comma
id|substream-&gt;stream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|azx_dev
op_eq
l_int|NULL
)paren
(brace
id|up
c_func
(paren
op_amp
id|chip-&gt;open_mutex
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|runtime-&gt;hw
op_assign
id|azx_pcm_hw
suffix:semicolon
id|runtime-&gt;hw.channels_min
op_assign
id|hinfo-&gt;channels_min
suffix:semicolon
id|runtime-&gt;hw.channels_max
op_assign
id|hinfo-&gt;channels_max
suffix:semicolon
id|runtime-&gt;hw.formats
op_assign
id|hinfo-&gt;formats
suffix:semicolon
id|runtime-&gt;hw.rates
op_assign
id|hinfo-&gt;rates
suffix:semicolon
id|snd_pcm_limit_hw_rates
c_func
(paren
id|runtime
)paren
suffix:semicolon
id|snd_pcm_hw_constraint_integer
c_func
(paren
id|runtime
comma
id|SNDRV_PCM_HW_PARAM_PERIODS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|hinfo-&gt;ops
dot
id|open
c_func
(paren
id|hinfo
comma
id|apcm-&gt;codec
comma
id|substream
)paren
)paren
OL
l_int|0
)paren
(brace
id|azx_release_device
c_func
(paren
id|azx_dev
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;open_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|azx_dev-&gt;substream
op_assign
id|substream
suffix:semicolon
id|azx_dev-&gt;running
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|runtime-&gt;private_data
op_assign
id|azx_dev
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;open_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|azx_pcm_close
r_static
r_int
id|azx_pcm_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
r_struct
id|azx_pcm
op_star
id|apcm
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
r_struct
id|hda_pcm_stream
op_star
id|hinfo
op_assign
id|apcm-&gt;hinfo
(braket
id|substream-&gt;stream
)braket
suffix:semicolon
id|azx_t
op_star
id|chip
op_assign
id|apcm-&gt;chip
suffix:semicolon
id|azx_dev_t
op_star
id|azx_dev
op_assign
id|get_azx_dev
c_func
(paren
id|substream
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|down
c_func
(paren
op_amp
id|chip-&gt;open_mutex
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|azx_dev-&gt;substream
op_assign
l_int|NULL
suffix:semicolon
id|azx_dev-&gt;running
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|chip-&gt;reg_lock
comma
id|flags
)paren
suffix:semicolon
id|azx_release_device
c_func
(paren
id|azx_dev
)paren
suffix:semicolon
id|hinfo-&gt;ops
dot
id|close
c_func
(paren
id|hinfo
comma
id|apcm-&gt;codec
comma
id|substream
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;open_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|azx_pcm_hw_params
r_static
r_int
id|azx_pcm_hw_params
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
id|snd_pcm_hw_params_t
op_star
id|hw_params
)paren
(brace
r_return
id|snd_pcm_lib_malloc_pages
c_func
(paren
id|substream
comma
id|params_buffer_bytes
c_func
(paren
id|hw_params
)paren
)paren
suffix:semicolon
)brace
DECL|function|azx_pcm_hw_free
r_static
r_int
id|azx_pcm_hw_free
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
r_struct
id|azx_pcm
op_star
id|apcm
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|azx_dev_t
op_star
id|azx_dev
op_assign
id|get_azx_dev
c_func
(paren
id|substream
)paren
suffix:semicolon
r_struct
id|hda_pcm_stream
op_star
id|hinfo
op_assign
id|apcm-&gt;hinfo
(braket
id|substream-&gt;stream
)braket
suffix:semicolon
multiline_comment|/* reset BDL address */
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_BDLPL
comma
l_int|0
)paren
suffix:semicolon
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_BDLPU
comma
l_int|0
)paren
suffix:semicolon
id|azx_sd_writel
c_func
(paren
id|azx_dev
comma
id|SD_CTL
comma
l_int|0
)paren
suffix:semicolon
id|hinfo-&gt;ops
dot
id|cleanup
c_func
(paren
id|hinfo
comma
id|apcm-&gt;codec
comma
id|substream
)paren
suffix:semicolon
r_return
id|snd_pcm_lib_free_pages
c_func
(paren
id|substream
)paren
suffix:semicolon
)brace
DECL|function|azx_pcm_prepare
r_static
r_int
id|azx_pcm_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
r_struct
id|azx_pcm
op_star
id|apcm
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|azx_t
op_star
id|chip
op_assign
id|apcm-&gt;chip
suffix:semicolon
id|azx_dev_t
op_star
id|azx_dev
op_assign
id|get_azx_dev
c_func
(paren
id|substream
)paren
suffix:semicolon
r_struct
id|hda_pcm_stream
op_star
id|hinfo
op_assign
id|apcm-&gt;hinfo
(braket
id|substream-&gt;stream
)braket
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|azx_dev-&gt;bufsize
op_assign
id|snd_pcm_lib_buffer_bytes
c_func
(paren
id|substream
)paren
suffix:semicolon
id|azx_dev-&gt;fragsize
op_assign
id|snd_pcm_lib_period_bytes
c_func
(paren
id|substream
)paren
suffix:semicolon
id|azx_dev-&gt;frags
op_assign
id|azx_dev-&gt;bufsize
op_div
id|azx_dev-&gt;fragsize
suffix:semicolon
id|azx_dev-&gt;format_val
op_assign
id|snd_hda_calc_stream_format
c_func
(paren
id|runtime-&gt;rate
comma
id|runtime-&gt;channels
comma
id|runtime-&gt;format
comma
id|hinfo-&gt;maxbps
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|azx_dev-&gt;format_val
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;invalid format_val, rate=%d, ch=%d, format=%d&bslash;n&quot;
comma
id|runtime-&gt;rate
comma
id|runtime-&gt;channels
comma
id|runtime-&gt;format
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|snd_printdd
c_func
(paren
l_string|&quot;azx_pcm_prepare: bufsize=0x%x, fragsize=0x%x, format=0x%x&bslash;n&quot;
comma
id|azx_dev-&gt;bufsize
comma
id|azx_dev-&gt;fragsize
comma
id|azx_dev-&gt;format_val
)paren
suffix:semicolon
id|azx_setup_periods
c_func
(paren
id|azx_dev
)paren
suffix:semicolon
id|azx_setup_controller
c_func
(paren
id|chip
comma
id|azx_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|substream-&gt;stream
op_eq
id|SNDRV_PCM_STREAM_PLAYBACK
)paren
id|azx_dev-&gt;fifo_size
op_assign
id|azx_sd_readw
c_func
(paren
id|azx_dev
comma
id|SD_FIFOSIZE
)paren
op_plus
l_int|1
suffix:semicolon
r_else
id|azx_dev-&gt;fifo_size
op_assign
l_int|0
suffix:semicolon
r_return
id|hinfo-&gt;ops
dot
id|prepare
c_func
(paren
id|hinfo
comma
id|apcm-&gt;codec
comma
id|azx_dev-&gt;stream_tag
comma
id|azx_dev-&gt;format_val
comma
id|substream
)paren
suffix:semicolon
)brace
DECL|function|azx_pcm_trigger
r_static
r_int
id|azx_pcm_trigger
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
r_int
id|cmd
)paren
(brace
r_struct
id|azx_pcm
op_star
id|apcm
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|azx_dev_t
op_star
id|azx_dev
op_assign
id|get_azx_dev
c_func
(paren
id|substream
)paren
suffix:semicolon
id|azx_t
op_star
id|chip
op_assign
id|apcm-&gt;chip
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_PCM_TRIGGER_PAUSE_RELEASE
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_RESUME
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_START
suffix:colon
id|azx_stream_start
c_func
(paren
id|chip
comma
id|azx_dev
)paren
suffix:semicolon
id|azx_dev-&gt;running
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_PAUSE_PUSH
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_STOP
suffix:colon
id|azx_stream_stop
c_func
(paren
id|chip
comma
id|azx_dev
)paren
suffix:semicolon
id|azx_dev-&gt;running
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|SNDRV_PCM_TRIGGER_PAUSE_PUSH
op_logical_or
id|cmd
op_eq
id|SNDRV_PCM_TRIGGER_STOP
)paren
(brace
r_int
id|timeout
op_assign
l_int|5000
suffix:semicolon
r_while
c_loop
(paren
id|azx_sd_readb
c_func
(paren
id|azx_dev
comma
id|SD_CTL
)paren
op_amp
id|SD_CTL_DMA_START
op_logical_and
op_decrement
id|timeout
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|azx_pcm_pointer
r_static
id|snd_pcm_uframes_t
id|azx_pcm_pointer
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|azx_dev_t
op_star
id|azx_dev
op_assign
id|get_azx_dev
c_func
(paren
id|substream
)paren
suffix:semicolon
r_int
r_int
id|pos
suffix:semicolon
macro_line|#ifdef USE_POSBUF
multiline_comment|/* use the position buffer */
id|pos
op_assign
op_star
id|azx_dev-&gt;posbuf
suffix:semicolon
macro_line|#else
multiline_comment|/* read LPIB */
id|pos
op_assign
id|azx_sd_readl
c_func
(paren
id|azx_dev
comma
id|SD_LPIB
)paren
op_plus
id|azx_dev-&gt;fifo_size
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pos
op_ge
id|azx_dev-&gt;bufsize
)paren
id|pos
op_assign
l_int|0
suffix:semicolon
r_return
id|bytes_to_frames
c_func
(paren
id|substream-&gt;runtime
comma
id|pos
)paren
suffix:semicolon
)brace
DECL|variable|azx_pcm_ops
r_static
id|snd_pcm_ops_t
id|azx_pcm_ops
op_assign
(brace
dot
id|open
op_assign
id|azx_pcm_open
comma
dot
id|close
op_assign
id|azx_pcm_close
comma
dot
id|ioctl
op_assign
id|snd_pcm_lib_ioctl
comma
dot
id|hw_params
op_assign
id|azx_pcm_hw_params
comma
dot
id|hw_free
op_assign
id|azx_pcm_hw_free
comma
dot
id|prepare
op_assign
id|azx_pcm_prepare
comma
dot
id|trigger
op_assign
id|azx_pcm_trigger
comma
dot
id|pointer
op_assign
id|azx_pcm_pointer
comma
)brace
suffix:semicolon
DECL|function|azx_pcm_free
r_static
r_void
id|azx_pcm_free
c_func
(paren
id|snd_pcm_t
op_star
id|pcm
)paren
(brace
id|kfree
c_func
(paren
id|pcm-&gt;private_data
)paren
suffix:semicolon
)brace
DECL|function|create_codec_pcm
r_static
r_int
id|__devinit
id|create_codec_pcm
c_func
(paren
id|azx_t
op_star
id|chip
comma
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_pcm
op_star
id|cpcm
comma
r_int
id|pcm_dev
)paren
(brace
r_int
id|err
suffix:semicolon
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_struct
id|azx_pcm
op_star
id|apcm
suffix:semicolon
id|snd_assert
c_func
(paren
id|cpcm-&gt;stream
(braket
l_int|0
)braket
dot
id|substreams
op_logical_or
id|cpcm-&gt;stream
(braket
l_int|1
)braket
dot
id|substreams
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|cpcm-&gt;name
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|err
op_assign
id|snd_pcm_new
c_func
(paren
id|chip-&gt;card
comma
id|cpcm-&gt;name
comma
id|pcm_dev
comma
id|cpcm-&gt;stream
(braket
l_int|0
)braket
dot
id|substreams
comma
id|cpcm-&gt;stream
(braket
l_int|1
)braket
dot
id|substreams
comma
op_amp
id|pcm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|strcpy
c_func
(paren
id|pcm-&gt;name
comma
id|cpcm-&gt;name
)paren
suffix:semicolon
id|apcm
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|apcm
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|apcm
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|apcm-&gt;chip
op_assign
id|chip
suffix:semicolon
id|apcm-&gt;codec
op_assign
id|codec
suffix:semicolon
id|apcm-&gt;hinfo
(braket
l_int|0
)braket
op_assign
op_amp
id|cpcm-&gt;stream
(braket
l_int|0
)braket
suffix:semicolon
id|apcm-&gt;hinfo
(braket
l_int|1
)braket
op_assign
op_amp
id|cpcm-&gt;stream
(braket
l_int|1
)braket
suffix:semicolon
id|pcm-&gt;private_data
op_assign
id|apcm
suffix:semicolon
id|pcm-&gt;private_free
op_assign
id|azx_pcm_free
suffix:semicolon
r_if
c_cond
(paren
id|cpcm-&gt;stream
(braket
l_int|0
)braket
dot
id|substreams
)paren
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_PLAYBACK
comma
op_amp
id|azx_pcm_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cpcm-&gt;stream
(braket
l_int|1
)braket
dot
id|substreams
)paren
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_CAPTURE
comma
op_amp
id|azx_pcm_ops
)paren
suffix:semicolon
id|snd_pcm_lib_preallocate_pages_for_all
c_func
(paren
id|pcm
comma
id|SNDRV_DMA_TYPE_DEV
comma
id|snd_dma_pci_data
c_func
(paren
id|chip-&gt;pci
)paren
comma
l_int|1024
op_star
l_int|64
comma
l_int|1024
op_star
l_int|128
)paren
suffix:semicolon
id|chip-&gt;pcm
(braket
id|pcm_dev
)braket
op_assign
id|pcm
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|azx_pcm_create
r_static
r_int
id|__devinit
id|azx_pcm_create
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|hda_codec
op_star
id|codec
suffix:semicolon
r_int
id|c
comma
id|err
suffix:semicolon
r_int
id|pcm_dev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_hda_build_pcms
c_func
(paren
id|chip-&gt;bus
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|pcm_dev
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|chip-&gt;bus-&gt;codec_list
)paren
(brace
id|codec
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|hda_codec
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|codec-&gt;num_pcms
suffix:semicolon
id|c
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pcm_dev
op_ge
id|AZX_MAX_PCMS
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;Too many PCMs&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|err
op_assign
id|create_codec_pcm
c_func
(paren
id|chip
comma
id|codec
comma
op_amp
id|codec-&gt;pcm_info
(braket
id|c
)braket
comma
id|pcm_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|pcm_dev
op_increment
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * mixer creation - all stuff is implemented in hda module&n; */
DECL|function|azx_mixer_create
r_static
r_int
id|__devinit
id|azx_mixer_create
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_return
id|snd_hda_build_controls
c_func
(paren
id|chip-&gt;bus
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * initialize SD streams&n; */
DECL|function|azx_init_stream
r_static
r_int
id|__devinit
id|azx_init_stream
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* initialize each stream (aka device)&n;&t; * assign the starting bdl address to each stream (device) and initialize&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ICH6_DEV
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|off
op_assign
r_sizeof
(paren
id|u32
)paren
op_star
(paren
id|i
op_star
id|AZX_MAX_FRAG
op_star
l_int|4
)paren
suffix:semicolon
id|azx_dev_t
op_star
id|azx_dev
op_assign
op_amp
id|chip-&gt;azx_dev
(braket
id|i
)braket
suffix:semicolon
id|azx_dev-&gt;bdl
op_assign
(paren
id|u32
op_star
)paren
(paren
id|chip-&gt;bdl.area
op_plus
id|off
)paren
suffix:semicolon
id|azx_dev-&gt;bdl_addr
op_assign
id|chip-&gt;bdl.addr
op_plus
id|off
suffix:semicolon
macro_line|#ifdef USE_POSBUF
id|azx_dev-&gt;posbuf
op_assign
(paren
r_volatile
id|u32
op_star
)paren
(paren
id|chip-&gt;posbuf.area
op_plus
id|i
op_star
l_int|8
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* offset: SDI0=0x80, SDI1=0xa0, ... SDO3=0x160 */
id|azx_dev-&gt;sd_addr
op_assign
id|chip-&gt;remap_addr
op_plus
(paren
l_int|0x20
op_star
id|i
op_plus
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* int mask: SDI0=0x01, SDI1=0x02, ... SDO3=0x80 */
id|azx_dev-&gt;sd_int_sta_mask
op_assign
l_int|1
op_lshift
id|i
suffix:semicolon
multiline_comment|/* stream tag: must be non-zero and unique */
id|azx_dev-&gt;index
op_assign
id|i
suffix:semicolon
id|azx_dev-&gt;stream_tag
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
multiline_comment|/*&n; * power management&n; */
DECL|function|azx_suspend
r_static
r_int
id|azx_suspend
c_func
(paren
id|snd_card_t
op_star
id|card
comma
id|pm_message_t
id|state
)paren
(brace
id|azx_t
op_star
id|chip
op_assign
id|card-&gt;pm_private_data
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|chip-&gt;pcm_devs
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|chip-&gt;pcm
(braket
id|i
)braket
)paren
id|snd_pcm_suspend_all
c_func
(paren
id|chip-&gt;pcm
(braket
id|i
)braket
)paren
suffix:semicolon
id|snd_hda_suspend
c_func
(paren
id|chip-&gt;bus
comma
id|state
)paren
suffix:semicolon
id|azx_free_cmd_io
c_func
(paren
id|chip
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|chip-&gt;pci
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|azx_resume
r_static
r_int
id|azx_resume
c_func
(paren
id|snd_card_t
op_star
id|card
)paren
(brace
id|azx_t
op_star
id|chip
op_assign
id|card-&gt;pm_private_data
suffix:semicolon
id|pci_enable_device
c_func
(paren
id|chip-&gt;pci
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|chip-&gt;pci
)paren
suffix:semicolon
id|azx_init_chip
c_func
(paren
id|chip
)paren
suffix:semicolon
id|snd_hda_resume
c_func
(paren
id|chip-&gt;bus
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PM */
multiline_comment|/*&n; * destructor&n; */
DECL|function|azx_free
r_static
r_int
id|azx_free
c_func
(paren
id|azx_t
op_star
id|chip
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;remap_addr
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_ICH6_DEV
suffix:semicolon
id|i
op_increment
)paren
id|azx_stream_stop
c_func
(paren
id|chip
comma
op_amp
id|chip-&gt;azx_dev
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|azx_int_disable
c_func
(paren
id|chip
)paren
suffix:semicolon
id|azx_int_clear
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* disable CORB/RIRB */
id|azx_free_cmd_io
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* disable position buffer */
id|azx_writel
c_func
(paren
id|chip
comma
id|DPLBASE
comma
l_int|0
)paren
suffix:semicolon
id|azx_writel
c_func
(paren
id|chip
comma
id|DPUBASE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait a little for interrupts to finish */
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|chip-&gt;remap_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chip-&gt;irq
op_ge
l_int|0
)paren
id|free_irq
c_func
(paren
id|chip-&gt;irq
comma
(paren
r_void
op_star
)paren
id|chip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;bdl.area
)paren
id|snd_dma_free_pages
c_func
(paren
op_amp
id|chip-&gt;bdl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;rb.area
)paren
id|snd_dma_free_pages
c_func
(paren
op_amp
id|chip-&gt;rb
)paren
suffix:semicolon
macro_line|#ifdef USE_POSBUF
r_if
c_cond
(paren
id|chip-&gt;posbuf.area
)paren
id|snd_dma_free_pages
c_func
(paren
op_amp
id|chip-&gt;posbuf
)paren
suffix:semicolon
macro_line|#endif
id|pci_release_regions
c_func
(paren
id|chip-&gt;pci
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|chip-&gt;pci
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|azx_dev_free
r_static
r_int
id|azx_dev_free
c_func
(paren
id|snd_device_t
op_star
id|device
)paren
(brace
r_return
id|azx_free
c_func
(paren
id|device-&gt;device_data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * constructor&n; */
DECL|function|azx_create
r_static
r_int
id|__devinit
id|azx_create
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_struct
id|pci_dev
op_star
id|pci
comma
id|azx_t
op_star
op_star
id|rchip
)paren
(brace
id|azx_t
op_star
id|chip
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_static
id|snd_device_ops_t
id|ops
op_assign
(brace
dot
id|dev_free
op_assign
id|azx_dev_free
comma
)brace
suffix:semicolon
op_star
id|rchip
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pci
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|chip
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|chip
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|chip
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;cannot allocate chip&bslash;n&quot;
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pci
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|chip-&gt;reg_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|chip-&gt;open_mutex
)paren
suffix:semicolon
id|chip-&gt;card
op_assign
id|card
suffix:semicolon
id|chip-&gt;pci
op_assign
id|pci
suffix:semicolon
id|chip-&gt;irq
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_request_regions
c_func
(paren
id|pci
comma
l_string|&quot;ICH HD audio&quot;
)paren
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pci
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|chip-&gt;addr
op_assign
id|pci_resource_start
c_func
(paren
id|pci
comma
l_int|0
)paren
suffix:semicolon
id|chip-&gt;remap_addr
op_assign
id|ioremap_nocache
c_func
(paren
id|chip-&gt;addr
comma
id|pci_resource_len
c_func
(paren
id|pci
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;remap_addr
op_eq
l_int|NULL
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;ioremap error&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pci-&gt;irq
comma
id|azx_interrupt
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
comma
l_string|&quot;HDA Intel&quot;
comma
(paren
r_void
op_star
)paren
id|chip
)paren
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;unable to grab IRQ %d&bslash;n&quot;
comma
id|pci-&gt;irq
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
id|chip-&gt;irq
op_assign
id|pci-&gt;irq
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pci
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
id|chip-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* allocate memory for the BDL for each stream */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_dma_alloc_pages
c_func
(paren
id|SNDRV_DMA_TYPE_DEV
comma
id|snd_dma_pci_data
c_func
(paren
id|chip-&gt;pci
)paren
comma
id|PAGE_SIZE
comma
op_amp
id|chip-&gt;bdl
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;cannot allocate BDL&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
macro_line|#ifdef USE_POSBUF
multiline_comment|/* allocate memory for the position buffer */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_dma_alloc_pages
c_func
(paren
id|SNDRV_DMA_TYPE_DEV
comma
id|snd_dma_pci_data
c_func
(paren
id|chip-&gt;pci
)paren
comma
id|MAX_ICH6_DEV
op_star
l_int|8
comma
op_amp
id|chip-&gt;posbuf
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;cannot allocate posbuf&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* allocate CORB/RIRB */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|azx_alloc_cmd_io
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
r_goto
id|errout
suffix:semicolon
multiline_comment|/* initialize streams */
id|azx_init_stream
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* initialize chip */
id|azx_init_chip
c_func
(paren
id|chip
)paren
suffix:semicolon
multiline_comment|/* codec detection */
r_if
c_cond
(paren
op_logical_neg
id|chip-&gt;codec_mask
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;no codecs found!&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_device_new
c_func
(paren
id|card
comma
id|SNDRV_DEV_LOWLEVEL
comma
id|chip
comma
op_amp
id|ops
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;Error creating device [card]!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
op_star
id|rchip
op_assign
id|chip
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|errout
suffix:colon
id|azx_free
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|azx_probe
r_static
r_int
id|__devinit
id|azx_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
comma
r_const
r_struct
id|pci_device_id
op_star
id|pci_id
)paren
(brace
r_static
r_int
id|dev
suffix:semicolon
id|snd_card_t
op_star
id|card
suffix:semicolon
id|azx_t
op_star
id|chip
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|SNDRV_CARDS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|enable
(braket
id|dev
)braket
)paren
(brace
id|dev
op_increment
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|card
op_assign
id|snd_card_new
c_func
(paren
id|index
(braket
id|dev
)braket
comma
id|id
(braket
id|dev
)braket
comma
id|THIS_MODULE
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|card
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
id|SFX
l_string|&quot;Error creating card!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|azx_create
c_func
(paren
id|card
comma
id|pci
comma
op_amp
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|card-&gt;driver
comma
l_string|&quot;HDA-Intel&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;shortname
comma
l_string|&quot;HDA Intel&quot;
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;longname
comma
l_string|&quot;%s at 0x%lx irq %i&quot;
comma
id|card-&gt;shortname
comma
id|chip-&gt;addr
comma
id|chip-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* create codec instances */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|azx_codec_create
c_func
(paren
id|chip
comma
id|model
(braket
id|dev
)braket
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* create PCM streams */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|azx_pcm_create
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* create mixer controls */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|azx_mixer_create
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|snd_card_set_pm_callback
c_func
(paren
id|card
comma
id|azx_suspend
comma
id|azx_resume
comma
id|chip
)paren
suffix:semicolon
id|snd_card_set_dev
c_func
(paren
id|card
comma
op_amp
id|pci-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_register
c_func
(paren
id|card
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pci
comma
id|card
)paren
suffix:semicolon
id|dev
op_increment
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|azx_remove
r_static
r_void
id|__devexit
id|azx_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
)paren
(brace
id|snd_card_free
c_func
(paren
id|pci_get_drvdata
c_func
(paren
id|pci
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* PCI IDs */
DECL|variable|azx_ids
r_static
r_struct
id|pci_device_id
id|azx_ids
(braket
)braket
op_assign
(brace
(brace
l_int|0x8086
comma
l_int|0x2668
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* ICH6 */
(brace
l_int|0x8086
comma
l_int|0x27d8
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* ICH7 */
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|azx_ids
)paren
suffix:semicolon
multiline_comment|/* pci_driver definition */
DECL|variable|driver
r_static
r_struct
id|pci_driver
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;HDA Intel&quot;
comma
dot
id|id_table
op_assign
id|azx_ids
comma
dot
id|probe
op_assign
id|azx_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|azx_remove
)paren
comma
id|SND_PCI_PM_CALLBACKS
)brace
suffix:semicolon
DECL|function|alsa_card_azx_init
r_static
r_int
id|__init
id|alsa_card_azx_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|function|alsa_card_azx_exit
r_static
r_void
id|__exit
id|alsa_card_azx_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|alsa_card_azx_init
)paren
id|module_exit
c_func
(paren
id|alsa_card_azx_exit
)paren
eof
