multiline_comment|/*&n; * Universal Interface for Intel High Definition Audio Codec&n; *&n; * Generic widget tree parser&n; *&n; * Copyright (c) 2004 Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *  This driver is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This driver is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &quot;hda_codec.h&quot;
macro_line|#include &quot;hda_local.h&quot;
multiline_comment|/* widget node for parsing */
DECL|struct|hda_gnode
r_struct
id|hda_gnode
(brace
DECL|member|nid
id|hda_nid_t
id|nid
suffix:semicolon
multiline_comment|/* NID of this widget */
DECL|member|nconns
r_int
r_int
id|nconns
suffix:semicolon
multiline_comment|/* number of input connections */
DECL|member|conn_list
id|hda_nid_t
id|conn_list
(braket
id|HDA_MAX_CONNECTIONS
)braket
suffix:semicolon
multiline_comment|/* input connections */
DECL|member|wid_caps
r_int
r_int
id|wid_caps
suffix:semicolon
multiline_comment|/* widget capabilities */
DECL|member|type
r_int
r_char
id|type
suffix:semicolon
multiline_comment|/* widget type */
DECL|member|pin_ctl
r_int
r_char
id|pin_ctl
suffix:semicolon
multiline_comment|/* pin controls */
DECL|member|checked
r_int
r_char
id|checked
suffix:semicolon
multiline_comment|/* the flag indicates that the node is already parsed */
DECL|member|pin_caps
r_int
r_int
id|pin_caps
suffix:semicolon
multiline_comment|/* pin widget capabilities */
DECL|member|def_cfg
r_int
r_int
id|def_cfg
suffix:semicolon
multiline_comment|/* default configuration */
DECL|member|amp_out_caps
r_int
r_int
id|amp_out_caps
suffix:semicolon
multiline_comment|/* AMP out capabilities */
DECL|member|amp_in_caps
r_int
r_int
id|amp_in_caps
suffix:semicolon
multiline_comment|/* AMP in capabilities */
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* pathc-specific record */
DECL|struct|hda_gspec
r_struct
id|hda_gspec
(brace
DECL|member|dac_node
r_struct
id|hda_gnode
op_star
id|dac_node
suffix:semicolon
multiline_comment|/* DAC node */
DECL|member|out_pin_node
r_struct
id|hda_gnode
op_star
id|out_pin_node
suffix:semicolon
multiline_comment|/* Output pin (Line-Out) node */
DECL|member|pcm_vol_node
r_struct
id|hda_gnode
op_star
id|pcm_vol_node
suffix:semicolon
multiline_comment|/* Node for PCM volume */
DECL|member|pcm_vol_index
r_int
r_int
id|pcm_vol_index
suffix:semicolon
multiline_comment|/* connection of PCM volume */
DECL|member|adc_node
r_struct
id|hda_gnode
op_star
id|adc_node
suffix:semicolon
multiline_comment|/* ADC node */
DECL|member|cap_vol_node
r_struct
id|hda_gnode
op_star
id|cap_vol_node
suffix:semicolon
multiline_comment|/* Node for capture volume */
DECL|member|cur_cap_src
r_int
r_int
id|cur_cap_src
suffix:semicolon
multiline_comment|/* current capture source */
DECL|member|input_mux
r_struct
id|hda_input_mux
id|input_mux
suffix:semicolon
DECL|member|cap_labels
r_char
id|cap_labels
(braket
id|HDA_MAX_NUM_INPUTS
)braket
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|def_amp_in_caps
r_int
r_int
id|def_amp_in_caps
suffix:semicolon
DECL|member|def_amp_out_caps
r_int
r_int
id|def_amp_out_caps
suffix:semicolon
DECL|member|pcm_rec
r_struct
id|hda_pcm
id|pcm_rec
suffix:semicolon
multiline_comment|/* PCM information */
DECL|member|nid_list
r_struct
id|list_head
id|nid_list
suffix:semicolon
multiline_comment|/* list of widgets */
)brace
suffix:semicolon
multiline_comment|/*&n; * retrieve the default device type from the default config value&n; */
DECL|macro|get_defcfg_type
mdefine_line|#define get_defcfg_type(node) (((node)-&gt;def_cfg &amp; AC_DEFCFG_DEVICE) &gt;&gt; AC_DEFCFG_DEVICE_SHIFT)
DECL|macro|get_defcfg_location
mdefine_line|#define get_defcfg_location(node) (((node)-&gt;def_cfg &amp; AC_DEFCFG_LOCATION) &gt;&gt; AC_DEFCFG_LOCATION_SHIFT)
multiline_comment|/*&n; * destructor&n; */
DECL|function|snd_hda_generic_free
r_static
r_void
id|snd_hda_generic_free
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_struct
id|list_head
op_star
id|p
comma
op_star
id|n
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|spec
)paren
r_return
suffix:semicolon
multiline_comment|/* free all widgets */
id|list_for_each_safe
c_func
(paren
id|p
comma
id|n
comma
op_amp
id|spec-&gt;nid_list
)paren
(brace
r_struct
id|hda_gnode
op_star
id|node
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|hda_gnode
comma
id|list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|spec
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * add a new widget node and read its attributes&n; */
DECL|function|add_new_node
r_static
r_int
id|add_new_node
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gspec
op_star
id|spec
comma
id|hda_nid_t
id|nid
)paren
(brace
r_struct
id|hda_gnode
op_star
id|node
suffix:semicolon
r_int
id|nconns
suffix:semicolon
id|node
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|node
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|node-&gt;nid
op_assign
id|nid
suffix:semicolon
id|nconns
op_assign
id|snd_hda_get_connections
c_func
(paren
id|codec
comma
id|nid
comma
id|node-&gt;conn_list
comma
id|HDA_MAX_CONNECTIONS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nconns
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
id|nconns
suffix:semicolon
)brace
id|node-&gt;nconns
op_assign
id|nconns
suffix:semicolon
id|node-&gt;wid_caps
op_assign
id|snd_hda_param_read
c_func
(paren
id|codec
comma
id|nid
comma
id|AC_PAR_AUDIO_WIDGET_CAP
)paren
suffix:semicolon
id|node-&gt;type
op_assign
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_TYPE
)paren
op_rshift
id|AC_WCAP_TYPE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_eq
id|AC_WID_PIN
)paren
(brace
id|node-&gt;pin_caps
op_assign
id|snd_hda_param_read
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
id|AC_PAR_PIN_CAP
)paren
suffix:semicolon
id|node-&gt;pin_ctl
op_assign
id|snd_hda_codec_read
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
l_int|0
comma
id|AC_VERB_GET_PIN_WIDGET_CONTROL
comma
l_int|0
)paren
suffix:semicolon
id|node-&gt;def_cfg
op_assign
id|snd_hda_codec_read
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
l_int|0
comma
id|AC_VERB_GET_CONFIG_DEFAULT
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_OUT_AMP
)paren
(brace
r_if
c_cond
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_AMP_OVRD
)paren
id|node-&gt;amp_out_caps
op_assign
id|snd_hda_param_read
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
id|AC_PAR_AMP_OUT_CAP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node-&gt;amp_out_caps
)paren
id|node-&gt;amp_out_caps
op_assign
id|spec-&gt;def_amp_out_caps
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_IN_AMP
)paren
(brace
r_if
c_cond
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_AMP_OVRD
)paren
id|node-&gt;amp_in_caps
op_assign
id|snd_hda_param_read
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
id|AC_PAR_AMP_IN_CAP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node-&gt;amp_in_caps
)paren
id|node-&gt;amp_in_caps
op_assign
id|spec-&gt;def_amp_in_caps
suffix:semicolon
)brace
id|list_add_tail
c_func
(paren
op_amp
id|node-&gt;list
comma
op_amp
id|spec-&gt;nid_list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * build the AFG subtree&n; */
DECL|function|build_afg_tree
r_static
r_int
id|build_afg_tree
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_int
id|i
comma
id|nodes
comma
id|err
suffix:semicolon
id|hda_nid_t
id|nid
suffix:semicolon
id|snd_assert
c_func
(paren
id|spec
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|spec-&gt;def_amp_out_caps
op_assign
id|snd_hda_param_read
c_func
(paren
id|codec
comma
id|codec-&gt;afg
comma
id|AC_PAR_AMP_OUT_CAP
)paren
suffix:semicolon
id|spec-&gt;def_amp_in_caps
op_assign
id|snd_hda_param_read
c_func
(paren
id|codec
comma
id|codec-&gt;afg
comma
id|AC_PAR_AMP_IN_CAP
)paren
suffix:semicolon
id|nodes
op_assign
id|snd_hda_get_sub_nodes
c_func
(paren
id|codec
comma
id|codec-&gt;afg
comma
op_amp
id|nid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nid
op_logical_or
id|nodes
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Invalid AFG subtree&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* parse all nodes belonging to the AFG */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nodes
suffix:semicolon
id|i
op_increment
comma
id|nid
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|add_new_node
c_func
(paren
id|codec
comma
id|spec
comma
id|nid
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * look for the node record for the given NID&n; */
multiline_comment|/* FIXME: should avoid the braindead linear search */
DECL|function|hda_get_node
r_static
r_struct
id|hda_gnode
op_star
id|hda_get_node
c_func
(paren
r_struct
id|hda_gspec
op_star
id|spec
comma
id|hda_nid_t
id|nid
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|node
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|spec-&gt;nid_list
)paren
(brace
id|node
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|hda_gnode
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;nid
op_eq
id|nid
)paren
r_return
id|node
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * unmute (and set max vol) the output amplifier&n; */
DECL|function|unmute_output
r_static
r_int
id|unmute_output
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gnode
op_star
id|node
)paren
(brace
r_int
r_int
id|val
comma
id|ofs
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;UNMUTE OUT: NID=0x%x&bslash;n&quot;
comma
id|node-&gt;nid
)paren
suffix:semicolon
id|val
op_assign
(paren
id|node-&gt;amp_out_caps
op_amp
id|AC_AMPCAP_NUM_STEPS
)paren
op_rshift
id|AC_AMPCAP_NUM_STEPS_SHIFT
suffix:semicolon
id|ofs
op_assign
(paren
id|node-&gt;amp_out_caps
op_amp
id|AC_AMPCAP_OFFSET
)paren
op_rshift
id|AC_AMPCAP_OFFSET_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
id|ofs
)paren
id|val
op_sub_assign
id|ofs
suffix:semicolon
id|val
op_or_assign
id|AC_AMP_SET_LEFT
op_or
id|AC_AMP_SET_RIGHT
suffix:semicolon
id|val
op_or_assign
id|AC_AMP_SET_OUTPUT
suffix:semicolon
r_return
id|snd_hda_codec_write
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
l_int|0
comma
id|AC_VERB_SET_AMP_GAIN_MUTE
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * unmute (and set max vol) the input amplifier&n; */
DECL|function|unmute_input
r_static
r_int
id|unmute_input
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gnode
op_star
id|node
comma
r_int
r_int
id|index
)paren
(brace
r_int
r_int
id|val
comma
id|ofs
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;UNMUTE IN: NID=0x%x IDX=0x%x&bslash;n&quot;
comma
id|node-&gt;nid
comma
id|index
)paren
suffix:semicolon
id|val
op_assign
(paren
id|node-&gt;amp_in_caps
op_amp
id|AC_AMPCAP_NUM_STEPS
)paren
op_rshift
id|AC_AMPCAP_NUM_STEPS_SHIFT
suffix:semicolon
id|ofs
op_assign
(paren
id|node-&gt;amp_in_caps
op_amp
id|AC_AMPCAP_OFFSET
)paren
op_rshift
id|AC_AMPCAP_OFFSET_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
id|ofs
)paren
id|val
op_sub_assign
id|ofs
suffix:semicolon
id|val
op_or_assign
id|AC_AMP_SET_LEFT
op_or
id|AC_AMP_SET_RIGHT
suffix:semicolon
id|val
op_or_assign
id|AC_AMP_SET_INPUT
suffix:semicolon
singleline_comment|// awk added - fixed to allow unmuting of indexed amps
id|val
op_or_assign
id|index
op_lshift
id|AC_AMP_SET_INDEX_SHIFT
suffix:semicolon
r_return
id|snd_hda_codec_write
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
l_int|0
comma
id|AC_VERB_SET_AMP_GAIN_MUTE
comma
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * select the input connection of the given node.&n; */
DECL|function|select_input_connection
r_static
r_int
id|select_input_connection
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gnode
op_star
id|node
comma
r_int
r_int
id|index
)paren
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;CONNECT: NID=0x%x IDX=0x%x&bslash;n&quot;
comma
id|node-&gt;nid
comma
id|index
)paren
suffix:semicolon
r_return
id|snd_hda_codec_write
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
l_int|0
comma
id|AC_VERB_SET_CONNECT_SEL
comma
id|index
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * clear checked flag of each node in the node list&n; */
DECL|function|clear_check_flags
r_static
r_void
id|clear_check_flags
c_func
(paren
r_struct
id|hda_gspec
op_star
id|spec
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|node
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|spec-&gt;nid_list
)paren
(brace
id|node
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|hda_gnode
comma
id|list
)paren
suffix:semicolon
id|node-&gt;checked
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * parse the output path recursively until reach to an audio output widget&n; *&n; * returns 0 if not found, 1 if found, or a negative error code.&n; */
DECL|function|parse_output_path
r_static
r_int
id|parse_output_path
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gspec
op_star
id|spec
comma
r_struct
id|hda_gnode
op_star
id|node
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|child
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;checked
)paren
r_return
l_int|0
suffix:semicolon
id|node-&gt;checked
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_eq
id|AC_WID_AUD_OUT
)paren
(brace
id|snd_printdd
c_func
(paren
l_string|&quot;AUD_OUT found %x&bslash;n&quot;
comma
id|node-&gt;nid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spec-&gt;dac_node
)paren
(brace
multiline_comment|/* already DAC node is assigned, just unmute &amp; connect */
r_return
id|node
op_eq
id|spec-&gt;dac_node
suffix:semicolon
)brace
id|spec-&gt;dac_node
op_assign
id|node
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_OUT_AMP
)paren
(brace
id|spec-&gt;pcm_vol_node
op_assign
id|node
suffix:semicolon
id|spec-&gt;pcm_vol_index
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* found */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|node-&gt;nconns
suffix:semicolon
id|i
op_increment
)paren
(brace
id|child
op_assign
id|hda_get_node
c_func
(paren
id|spec
comma
id|node-&gt;conn_list
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|child
)paren
r_continue
suffix:semicolon
id|err
op_assign
id|parse_output_path
c_func
(paren
id|codec
comma
id|spec
comma
id|child
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_else
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
multiline_comment|/* found one,&n;&t;&t;&t; * select the path, unmute both input and output&n;&t;&t;&t; */
r_if
c_cond
(paren
id|node-&gt;nconns
OG
l_int|1
)paren
id|select_input_connection
c_func
(paren
id|codec
comma
id|node
comma
id|i
)paren
suffix:semicolon
id|unmute_input
c_func
(paren
id|codec
comma
id|node
comma
id|i
)paren
suffix:semicolon
id|unmute_output
c_func
(paren
id|codec
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|spec-&gt;pcm_vol_node
)paren
(brace
r_if
c_cond
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_IN_AMP
)paren
(brace
id|spec-&gt;pcm_vol_node
op_assign
id|node
suffix:semicolon
id|spec-&gt;pcm_vol_index
op_assign
id|i
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_OUT_AMP
)paren
(brace
id|spec-&gt;pcm_vol_node
op_assign
id|node
suffix:semicolon
id|spec-&gt;pcm_vol_index
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Look for the output PIN widget with the given jack type&n; * and parse the output path to that PIN.&n; *&n; * Returns the PIN node when the path to DAC is established.&n; */
DECL|function|parse_output_jack
r_static
r_struct
id|hda_gnode
op_star
id|parse_output_jack
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gspec
op_star
id|spec
comma
r_int
id|jack_type
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|node
suffix:semicolon
r_int
id|err
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|spec-&gt;nid_list
)paren
(brace
id|node
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|hda_gnode
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_ne
id|AC_WID_PIN
)paren
r_continue
suffix:semicolon
multiline_comment|/* output capable? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|node-&gt;pin_caps
op_amp
id|AC_PINCAP_OUT
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|jack_type
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jack_type
op_ne
id|get_defcfg_type
c_func
(paren
id|node
)paren
)paren
r_continue
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* output as default? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|node-&gt;pin_ctl
op_amp
id|AC_PINCTL_OUT_EN
)paren
)paren
r_continue
suffix:semicolon
)brace
id|clear_check_flags
c_func
(paren
id|spec
)paren
suffix:semicolon
id|err
op_assign
id|parse_output_path
c_func
(paren
id|codec
comma
id|spec
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
multiline_comment|/* unmute the PIN output */
id|unmute_output
c_func
(paren
id|codec
comma
id|node
)paren
suffix:semicolon
multiline_comment|/* set PIN-Out enable */
id|snd_hda_codec_write
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
l_int|0
comma
id|AC_VERB_SET_PIN_WIDGET_CONTROL
comma
id|AC_PINCTL_OUT_EN
op_or
id|AC_PINCTL_HP_EN
)paren
suffix:semicolon
r_return
id|node
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * parse outputs&n; */
DECL|function|parse_output
r_static
r_int
id|parse_output
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|node
suffix:semicolon
multiline_comment|/*&n;&t; * Look for the output PIN widget&n;&t; */
multiline_comment|/* first, look for the line-out pin */
id|node
op_assign
id|parse_output_jack
c_func
(paren
id|codec
comma
id|spec
comma
id|AC_JACK_LINE_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
)paren
multiline_comment|/* found, remember the PIN node */
id|spec-&gt;out_pin_node
op_assign
id|node
suffix:semicolon
multiline_comment|/* look for the HP-out pin */
id|node
op_assign
id|parse_output_jack
c_func
(paren
id|codec
comma
id|spec
comma
id|AC_JACK_HP_OUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|spec-&gt;out_pin_node
)paren
id|spec-&gt;out_pin_node
op_assign
id|node
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|spec-&gt;out_pin_node
)paren
(brace
multiline_comment|/* no line-out or HP pins found,&n;&t;&t; * then choose for the first output pin&n;&t;&t; */
id|spec-&gt;out_pin_node
op_assign
id|parse_output_jack
c_func
(paren
id|codec
comma
id|spec
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|spec-&gt;out_pin_node
)paren
id|snd_printd
c_func
(paren
l_string|&quot;hda_generic: no proper output path found&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * input MUX&n; */
multiline_comment|/* control callbacks */
DECL|function|capture_source_info
r_static
r_int
id|capture_source_info
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
r_struct
id|hda_codec
op_star
id|codec
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_return
id|snd_hda_input_mux_info
c_func
(paren
op_amp
id|spec-&gt;input_mux
comma
id|uinfo
)paren
suffix:semicolon
)brace
DECL|function|capture_source_get
r_static
r_int
id|capture_source_get
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
r_struct
id|hda_codec
op_star
id|codec
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
id|ucontrol-&gt;value.enumerated.item
(braket
l_int|0
)braket
op_assign
id|spec-&gt;cur_cap_src
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|capture_source_put
r_static
r_int
id|capture_source_put
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
r_struct
id|hda_codec
op_star
id|codec
op_assign
id|snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_return
id|snd_hda_input_mux_put
c_func
(paren
id|codec
comma
op_amp
id|spec-&gt;input_mux
comma
id|ucontrol
comma
id|spec-&gt;adc_node-&gt;nid
comma
op_amp
id|spec-&gt;cur_cap_src
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * return the string name of the given input PIN widget&n; */
DECL|function|get_input_type
r_static
r_const
r_char
op_star
id|get_input_type
c_func
(paren
r_struct
id|hda_gnode
op_star
id|node
comma
r_int
r_int
op_star
id|pinctl
)paren
(brace
r_int
r_int
id|location
op_assign
id|get_defcfg_location
c_func
(paren
id|node
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|get_defcfg_type
c_func
(paren
id|node
)paren
)paren
(brace
r_case
id|AC_JACK_LINE_IN
suffix:colon
r_if
c_cond
(paren
(paren
id|location
op_amp
l_int|0x0f
)paren
op_eq
id|AC_JACK_LOC_FRONT
)paren
r_return
l_string|&quot;Front Line&quot;
suffix:semicolon
r_return
l_string|&quot;Line&quot;
suffix:semicolon
r_case
id|AC_JACK_CD
suffix:colon
r_if
c_cond
(paren
id|pinctl
)paren
op_star
id|pinctl
op_or_assign
id|AC_PIN_VREF_GRD
suffix:semicolon
r_return
l_string|&quot;CD&quot;
suffix:semicolon
r_case
id|AC_JACK_AUX
suffix:colon
r_if
c_cond
(paren
(paren
id|location
op_amp
l_int|0x0f
)paren
op_eq
id|AC_JACK_LOC_FRONT
)paren
r_return
l_string|&quot;Front Aux&quot;
suffix:semicolon
r_return
l_string|&quot;Aux&quot;
suffix:semicolon
r_case
id|AC_JACK_MIC_IN
suffix:colon
r_if
c_cond
(paren
(paren
id|location
op_amp
l_int|0x0f
)paren
op_eq
id|AC_JACK_LOC_FRONT
)paren
r_return
l_string|&quot;Front Mic&quot;
suffix:semicolon
r_return
l_string|&quot;Mic&quot;
suffix:semicolon
r_case
id|AC_JACK_SPDIF_IN
suffix:colon
r_return
l_string|&quot;SPDIF&quot;
suffix:semicolon
r_case
id|AC_JACK_DIG_OTHER_IN
suffix:colon
r_return
l_string|&quot;Digital&quot;
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * parse the nodes recursively until reach to the input PIN&n; *&n; * returns 0 if not found, 1 if found, or a negative error code.&n; */
DECL|function|parse_adc_sub_nodes
r_static
r_int
id|parse_adc_sub_nodes
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gspec
op_star
id|spec
comma
r_struct
id|hda_gnode
op_star
id|node
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
r_int
r_int
id|pinctl
suffix:semicolon
r_char
op_star
id|label
suffix:semicolon
r_const
r_char
op_star
id|type
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;checked
)paren
r_return
l_int|0
suffix:semicolon
id|node-&gt;checked
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_ne
id|AC_WID_PIN
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|node-&gt;nconns
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|hda_gnode
op_star
id|child
suffix:semicolon
id|child
op_assign
id|hda_get_node
c_func
(paren
id|spec
comma
id|node-&gt;conn_list
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|child
)paren
r_continue
suffix:semicolon
id|err
op_assign
id|parse_adc_sub_nodes
c_func
(paren
id|codec
comma
id|spec
comma
id|child
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
multiline_comment|/* found one,&n;&t;&t;&t;&t; * select the path, unmute both input and output&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|node-&gt;nconns
OG
l_int|1
)paren
id|select_input_connection
c_func
(paren
id|codec
comma
id|node
comma
id|i
)paren
suffix:semicolon
id|unmute_input
c_func
(paren
id|codec
comma
id|node
comma
id|i
)paren
suffix:semicolon
id|unmute_output
c_func
(paren
id|codec
comma
id|node
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* input capable? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|node-&gt;pin_caps
op_amp
id|AC_PINCAP_IN
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|spec-&gt;input_mux.num_items
op_ge
id|HDA_MAX_NUM_INPUTS
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hda_generic: Too many items for capture&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pinctl
op_assign
id|AC_PINCTL_IN_EN
suffix:semicolon
multiline_comment|/* create a proper capture source label */
id|type
op_assign
id|get_input_type
c_func
(paren
id|node
comma
op_amp
id|pinctl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|type
)paren
(brace
multiline_comment|/* input as default? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|node-&gt;pin_ctl
op_amp
id|AC_PINCTL_IN_EN
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|type
op_assign
l_string|&quot;Input&quot;
suffix:semicolon
)brace
id|label
op_assign
id|spec-&gt;cap_labels
(braket
id|spec-&gt;input_mux.num_items
)braket
suffix:semicolon
id|strcpy
c_func
(paren
id|label
comma
id|type
)paren
suffix:semicolon
id|spec-&gt;input_mux.items
(braket
id|spec-&gt;input_mux.num_items
)braket
dot
id|label
op_assign
id|label
suffix:semicolon
multiline_comment|/* unmute the PIN external input */
id|unmute_input
c_func
(paren
id|codec
comma
id|node
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* index = 0? */
multiline_comment|/* set PIN-In enable */
id|snd_hda_codec_write
c_func
(paren
id|codec
comma
id|node-&gt;nid
comma
l_int|0
comma
id|AC_VERB_SET_PIN_WIDGET_CONTROL
comma
id|pinctl
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* found */
)brace
multiline_comment|/*&n; * parse input&n; */
DECL|function|parse_input_path
r_static
r_int
id|parse_input_path
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gnode
op_star
id|adc_node
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|node
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;AUD_IN = %x&bslash;n&quot;
comma
id|adc_node-&gt;nid
)paren
suffix:semicolon
id|clear_check_flags
c_func
(paren
id|spec
)paren
suffix:semicolon
singleline_comment|// awk added - fixed no recording due to muted widget
id|unmute_input
c_func
(paren
id|codec
comma
id|adc_node
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * check each connection of the ADC&n;&t; * if it reaches to a proper input PIN, add the path as the&n;&t; * input path.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|adc_node-&gt;nconns
suffix:semicolon
id|i
op_increment
)paren
(brace
id|node
op_assign
id|hda_get_node
c_func
(paren
id|spec
comma
id|adc_node-&gt;conn_list
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_continue
suffix:semicolon
id|err
op_assign
id|parse_adc_sub_nodes
c_func
(paren
id|codec
comma
id|spec
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_else
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
(brace
r_struct
id|hda_input_mux_item
op_star
id|csrc
op_assign
op_amp
id|spec-&gt;input_mux.items
(braket
id|spec-&gt;input_mux.num_items
)braket
suffix:semicolon
r_char
op_star
id|buf
op_assign
id|spec-&gt;cap_labels
(braket
id|spec-&gt;input_mux.num_items
)braket
suffix:semicolon
r_int
id|ocap
suffix:semicolon
r_for
c_loop
(paren
id|ocap
op_assign
l_int|0
suffix:semicolon
id|ocap
OL
id|spec-&gt;input_mux.num_items
suffix:semicolon
id|ocap
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|buf
comma
id|spec-&gt;cap_labels
(braket
id|ocap
)braket
)paren
)paren
(brace
multiline_comment|/* same label already exists,&n;&t;&t;&t;&t;&t; * put the index number to be unique&n;&t;&t;&t;&t;&t; */
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s %d&quot;
comma
id|spec-&gt;cap_labels
(braket
id|ocap
)braket
comma
id|spec-&gt;input_mux.num_items
)paren
suffix:semicolon
)brace
)brace
id|csrc-&gt;index
op_assign
id|i
suffix:semicolon
id|spec-&gt;input_mux.num_items
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|spec-&gt;input_mux.num_items
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no input path found... */
id|snd_printdd
c_func
(paren
l_string|&quot;[Capture Source] NID=0x%x, #SRC=%d&bslash;n&quot;
comma
id|adc_node-&gt;nid
comma
id|spec-&gt;input_mux.num_items
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|spec-&gt;input_mux.num_items
suffix:semicolon
id|i
op_increment
)paren
id|snd_printdd
c_func
(paren
l_string|&quot;  [%s] IDX=0x%x&bslash;n&quot;
comma
id|spec-&gt;input_mux.items
(braket
id|i
)braket
dot
id|label
comma
id|spec-&gt;input_mux.items
(braket
id|i
)braket
dot
id|index
)paren
suffix:semicolon
id|spec-&gt;adc_node
op_assign
id|adc_node
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * parse input&n; */
DECL|function|parse_input
r_static
r_int
id|parse_input
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|node
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * At first we look for an audio input widget.&n;&t; * If it reaches to certain input PINs, we take it as the&n;&t; * input path.&n;&t; */
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|spec-&gt;nid_list
)paren
(brace
id|node
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|hda_gnode
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_eq
id|AC_WID_AUD_IN
)paren
(brace
id|err
op_assign
id|parse_input_path
c_func
(paren
id|codec
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_else
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|snd_printd
c_func
(paren
l_string|&quot;hda_generic: no proper input path found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * create mixer controls if possible&n; */
DECL|macro|DIR_OUT
mdefine_line|#define DIR_OUT&t;&t;0x1
DECL|macro|DIR_IN
mdefine_line|#define DIR_IN&t;&t;0x2
DECL|function|create_mixer
r_static
r_int
id|create_mixer
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gnode
op_star
id|node
comma
r_int
r_int
id|index
comma
r_const
r_char
op_star
id|type
comma
r_const
r_char
op_star
id|dir_sfx
)paren
(brace
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|created
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|type
)paren
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s %s Switch&quot;
comma
id|type
comma
id|dir_sfx
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s Switch&quot;
comma
id|dir_sfx
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_IN_AMP
)paren
op_logical_and
(paren
id|node-&gt;amp_in_caps
op_amp
id|AC_AMPCAP_MUTE
)paren
)paren
(brace
id|snd_kcontrol_new_t
id|knew
op_assign
id|HDA_CODEC_MUTE
c_func
(paren
id|name
comma
id|node-&gt;nid
comma
id|index
comma
id|HDA_INPUT
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;[%s] NID=0x%x, DIR=IN, IDX=0x%x&bslash;n&quot;
comma
id|name
comma
id|node-&gt;nid
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|codec-&gt;bus-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|knew
comma
id|codec
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|created
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_OUT_AMP
)paren
op_logical_and
(paren
id|node-&gt;amp_out_caps
op_amp
id|AC_AMPCAP_MUTE
)paren
)paren
(brace
id|snd_kcontrol_new_t
id|knew
op_assign
id|HDA_CODEC_MUTE
c_func
(paren
id|name
comma
id|node-&gt;nid
comma
l_int|0
comma
id|HDA_OUTPUT
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;[%s] NID=0x%x, DIR=OUT&bslash;n&quot;
comma
id|name
comma
id|node-&gt;nid
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|codec-&gt;bus-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|knew
comma
id|codec
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|created
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|type
)paren
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s %s Volume&quot;
comma
id|type
comma
id|dir_sfx
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s Volume&quot;
comma
id|dir_sfx
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_IN_AMP
)paren
op_logical_and
(paren
id|node-&gt;amp_in_caps
op_amp
id|AC_AMPCAP_NUM_STEPS
)paren
)paren
(brace
id|snd_kcontrol_new_t
id|knew
op_assign
id|HDA_CODEC_VOLUME
c_func
(paren
id|name
comma
id|node-&gt;nid
comma
id|index
comma
id|HDA_INPUT
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;[%s] NID=0x%x, DIR=IN, IDX=0x%x&bslash;n&quot;
comma
id|name
comma
id|node-&gt;nid
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|codec-&gt;bus-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|knew
comma
id|codec
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|created
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|node-&gt;wid_caps
op_amp
id|AC_WCAP_OUT_AMP
)paren
op_logical_and
(paren
id|node-&gt;amp_out_caps
op_amp
id|AC_AMPCAP_NUM_STEPS
)paren
)paren
(brace
id|snd_kcontrol_new_t
id|knew
op_assign
id|HDA_CODEC_VOLUME
c_func
(paren
id|name
comma
id|node-&gt;nid
comma
l_int|0
comma
id|HDA_OUTPUT
)paren
suffix:semicolon
id|snd_printdd
c_func
(paren
l_string|&quot;[%s] NID=0x%x, DIR=OUT&bslash;n&quot;
comma
id|name
comma
id|node-&gt;nid
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|codec-&gt;bus-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|knew
comma
id|codec
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|created
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|created
suffix:semicolon
)brace
multiline_comment|/*&n; * check whether the controls with the given name and direction suffix already exist&n; */
DECL|function|check_existing_control
r_static
r_int
id|check_existing_control
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_const
r_char
op_star
id|type
comma
r_const
r_char
op_star
id|dir
)paren
(brace
id|snd_ctl_elem_id_t
id|id
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|id
comma
l_int|0
comma
r_sizeof
(paren
id|id
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|id.name
comma
l_string|&quot;%s %s Volume&quot;
comma
id|type
comma
id|dir
)paren
suffix:semicolon
id|id.iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
suffix:semicolon
r_if
c_cond
(paren
id|snd_ctl_find_id
c_func
(paren
id|codec-&gt;bus-&gt;card
comma
op_amp
id|id
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|sprintf
c_func
(paren
id|id.name
comma
l_string|&quot;%s %s Switch&quot;
comma
id|type
comma
id|dir
)paren
suffix:semicolon
id|id.iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
suffix:semicolon
r_if
c_cond
(paren
id|snd_ctl_find_id
c_func
(paren
id|codec-&gt;bus-&gt;card
comma
op_amp
id|id
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * build output mixer controls&n; */
DECL|function|build_output_controls
r_static
r_int
id|build_output_controls
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|create_mixer
c_func
(paren
id|codec
comma
id|spec-&gt;pcm_vol_node
comma
id|spec-&gt;pcm_vol_index
comma
l_string|&quot;PCM&quot;
comma
l_string|&quot;Playback&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* create capture volume/switch */
DECL|function|build_input_controls
r_static
r_int
id|build_input_controls
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|adc_node
op_assign
id|spec-&gt;adc_node
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adc_node
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* not found */
multiline_comment|/* create capture volume and switch controls if the ADC has an amp */
id|err
op_assign
id|create_mixer
c_func
(paren
id|codec
comma
id|adc_node
comma
l_int|0
comma
l_int|NULL
comma
l_string|&quot;Capture&quot;
)paren
suffix:semicolon
multiline_comment|/* create input MUX if multiple sources are available */
r_if
c_cond
(paren
id|spec-&gt;input_mux.num_items
OG
l_int|1
)paren
(brace
r_static
id|snd_kcontrol_new_t
id|cap_sel
op_assign
(brace
dot
id|iface
op_assign
id|SNDRV_CTL_ELEM_IFACE_MIXER
comma
dot
id|name
op_assign
l_string|&quot;Capture Source&quot;
comma
dot
id|info
op_assign
id|capture_source_info
comma
dot
id|get
op_assign
id|capture_source_get
comma
dot
id|put
op_assign
id|capture_source_put
comma
)brace
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|codec-&gt;bus-&gt;card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|cap_sel
comma
id|codec
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|spec-&gt;cur_cap_src
op_assign
l_int|0
suffix:semicolon
id|select_input_connection
c_func
(paren
id|codec
comma
id|adc_node
comma
id|spec-&gt;input_mux.items
(braket
l_int|0
)braket
dot
id|index
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * parse the nodes recursively until reach to the output PIN.&n; *&n; * returns 0 - if not found,&n; *         1 - if found, but no mixer is created&n; *         2 - if found and mixer was already created, (just skip)&n; *         a negative error code&n; */
DECL|function|parse_loopback_path
r_static
r_int
id|parse_loopback_path
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
comma
r_struct
id|hda_gspec
op_star
id|spec
comma
r_struct
id|hda_gnode
op_star
id|node
comma
r_struct
id|hda_gnode
op_star
id|dest_node
comma
r_const
r_char
op_star
id|type
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;checked
)paren
r_return
l_int|0
suffix:semicolon
id|node-&gt;checked
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
id|dest_node
)paren
(brace
multiline_comment|/* loopback connection found */
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|node-&gt;nconns
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|hda_gnode
op_star
id|child
op_assign
id|hda_get_node
c_func
(paren
id|spec
comma
id|node-&gt;conn_list
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|child
)paren
r_continue
suffix:semicolon
id|err
op_assign
id|parse_loopback_path
c_func
(paren
id|codec
comma
id|spec
comma
id|child
comma
id|dest_node
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_else
r_if
c_cond
(paren
id|err
op_ge
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|err
op_eq
l_int|1
)paren
(brace
id|err
op_assign
id|create_mixer
c_func
(paren
id|codec
comma
id|node
comma
id|i
comma
id|type
comma
l_string|&quot;Playback&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
r_return
l_int|2
suffix:semicolon
multiline_comment|/* ok, created */
multiline_comment|/* not created, maybe in the lower path */
id|err
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* connect and unmute */
r_if
c_cond
(paren
id|node-&gt;nconns
OG
l_int|1
)paren
id|select_input_connection
c_func
(paren
id|codec
comma
id|node
comma
id|i
)paren
suffix:semicolon
id|unmute_input
c_func
(paren
id|codec
comma
id|node
comma
id|i
)paren
suffix:semicolon
id|unmute_output
c_func
(paren
id|codec
comma
id|node
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * parse the tree and build the loopback controls&n; */
DECL|function|build_loopback_controls
r_static
r_int
id|build_loopback_controls
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|hda_gnode
op_star
id|node
suffix:semicolon
r_int
id|err
suffix:semicolon
r_const
r_char
op_star
id|type
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|spec-&gt;out_pin_node
)paren
r_return
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|spec-&gt;nid_list
)paren
(brace
id|node
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|hda_gnode
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_ne
id|AC_WID_PIN
)paren
r_continue
suffix:semicolon
multiline_comment|/* input capable? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|node-&gt;pin_caps
op_amp
id|AC_PINCAP_IN
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|type
op_assign
id|get_input_type
c_func
(paren
id|node
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
)paren
(brace
r_if
c_cond
(paren
id|check_existing_control
c_func
(paren
id|codec
comma
id|type
comma
l_string|&quot;Playback&quot;
)paren
)paren
r_continue
suffix:semicolon
id|clear_check_flags
c_func
(paren
id|spec
)paren
suffix:semicolon
id|err
op_assign
id|parse_loopback_path
c_func
(paren
id|codec
comma
id|spec
comma
id|spec-&gt;out_pin_node
comma
id|node
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
r_continue
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * build mixer controls&n; */
DECL|function|build_generic_controls
r_static
r_int
id|build_generic_controls
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|build_input_controls
c_func
(paren
id|codec
)paren
)paren
OL
l_int|0
op_logical_or
(paren
id|err
op_assign
id|build_output_controls
c_func
(paren
id|codec
)paren
)paren
OL
l_int|0
op_logical_or
(paren
id|err
op_assign
id|build_loopback_controls
c_func
(paren
id|codec
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * PCM&n; */
DECL|variable|generic_pcm_playback
r_static
r_struct
id|hda_pcm_stream
id|generic_pcm_playback
op_assign
(brace
dot
id|substreams
op_assign
l_int|1
comma
dot
id|channels_min
op_assign
l_int|2
comma
dot
id|channels_max
op_assign
l_int|2
comma
)brace
suffix:semicolon
DECL|function|build_generic_pcms
r_static
r_int
id|build_generic_pcms
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
op_assign
id|codec-&gt;spec
suffix:semicolon
r_struct
id|hda_pcm
op_star
id|info
op_assign
op_amp
id|spec-&gt;pcm_rec
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|spec-&gt;dac_node
op_logical_and
op_logical_neg
id|spec-&gt;adc_node
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;hda_generic: no PCM found&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|codec-&gt;num_pcms
op_assign
l_int|1
suffix:semicolon
id|codec-&gt;pcm_info
op_assign
id|info
suffix:semicolon
id|info-&gt;name
op_assign
l_string|&quot;HDA Generic&quot;
suffix:semicolon
r_if
c_cond
(paren
id|spec-&gt;dac_node
)paren
(brace
id|info-&gt;stream
(braket
l_int|0
)braket
op_assign
id|generic_pcm_playback
suffix:semicolon
id|info-&gt;stream
(braket
l_int|0
)braket
dot
id|nid
op_assign
id|spec-&gt;dac_node-&gt;nid
suffix:semicolon
)brace
r_if
c_cond
(paren
id|spec-&gt;adc_node
)paren
(brace
id|info-&gt;stream
(braket
l_int|1
)braket
op_assign
id|generic_pcm_playback
suffix:semicolon
id|info-&gt;stream
(braket
l_int|1
)braket
dot
id|nid
op_assign
id|spec-&gt;adc_node-&gt;nid
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|variable|generic_patch_ops
r_static
r_struct
id|hda_codec_ops
id|generic_patch_ops
op_assign
(brace
dot
id|build_controls
op_assign
id|build_generic_controls
comma
dot
id|build_pcms
op_assign
id|build_generic_pcms
comma
dot
id|free
op_assign
id|snd_hda_generic_free
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * the generic parser&n; */
DECL|function|snd_hda_parse_generic_codec
r_int
id|snd_hda_parse_generic_codec
c_func
(paren
r_struct
id|hda_codec
op_star
id|codec
)paren
(brace
r_struct
id|hda_gspec
op_star
id|spec
suffix:semicolon
r_int
id|err
suffix:semicolon
id|spec
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|spec
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|spec
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hda_generic: can&squot;t allocate spec&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|codec-&gt;spec
op_assign
id|spec
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|spec-&gt;nid_list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|build_afg_tree
c_func
(paren
id|codec
)paren
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|parse_input
c_func
(paren
id|codec
)paren
)paren
OL
l_int|0
op_logical_or
(paren
id|err
op_assign
id|parse_output
c_func
(paren
id|codec
)paren
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
id|codec-&gt;patch_ops
op_assign
id|generic_patch_ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|snd_hda_generic_free
c_func
(paren
id|codec
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
eof
