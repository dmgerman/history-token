multiline_comment|/*&n; * Copyright (C) by Paul Barton-Davis 1998-1999&n; *&n; * This file is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)&n; * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this&n; * software for more info.  &n; */
multiline_comment|/* The low level driver for the WaveFront ICS2115 MIDI interface(s)&n; *&n; * Note that there is also an MPU-401 emulation (actually, a UART-401&n; * emulation) on the CS4232 on the Tropez and Tropez Plus. This code&n; * has nothing to do with that interface at all.&n; *&n; * The interface is essentially just a UART-401, but is has the&n; * interesting property of supporting what Turtle Beach called&n; * &quot;Virtual MIDI&quot; mode. In this mode, there are effectively *two*&n; * MIDI buses accessible via the interface, one that is routed&n; * solely to/from the external WaveFront synthesizer and the other&n; * corresponding to the pin/socket connector used to link external&n; * MIDI devices to the board.&n; *&n; * This driver fully supports this mode, allowing two distinct MIDI&n; * busses to be used completely independently, giving 32 channels of&n; * MIDI routing, 16 to the WaveFront synth and 16 to the external MIDI&n; * bus. The devices are named /dev/snd/midiCnD0 and /dev/snd/midiCnD1,&n; * where `n&squot; is the card number. Note that the device numbers may be&n; * something other than 0 and 1 if the CS4232 UART/MPU-401 interface&n; * is enabled.&n; *&n; * Switching between the two is accomplished externally by the driver&n; * using the two otherwise unused MIDI bytes. See the code for more details.&n; *&n; * NOTE: VIRTUAL MIDI MODE IS ON BY DEFAULT (see lowlevel/isa/wavefront.c)&n; *&n; * The main reason to turn off Virtual MIDI mode is when you want to&n; * tightly couple the WaveFront synth with an external MIDI&n; * device. You won&squot;t be able to distinguish the source of any MIDI&n; * data except via SysEx ID, but thats probably OK, since for the most&n; * part, the WaveFront won&squot;t be sending any MIDI data at all.&n; *  &n; * The main reason to turn on Virtual MIDI Mode is to provide two&n; * completely independent 16-channel MIDI buses, one to the&n; * WaveFront and one to any external MIDI devices. Given the 32&n; * voice nature of the WaveFront, its pretty easy to find a use&n; * for all 16 channels driving just that synth.&n; *  &n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/snd_wavefront.h&gt;
r_static
r_inline
r_int
DECL|function|wf_mpu_status
id|wf_mpu_status
(paren
id|snd_wavefront_midi_t
op_star
id|midi
)paren
(brace
r_return
id|inb
(paren
id|midi-&gt;mpu_status_port
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|input_avail
id|input_avail
(paren
id|snd_wavefront_midi_t
op_star
id|midi
)paren
(brace
r_return
op_logical_neg
(paren
id|wf_mpu_status
c_func
(paren
id|midi
)paren
op_amp
id|INPUT_AVAIL
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|output_ready
id|output_ready
(paren
id|snd_wavefront_midi_t
op_star
id|midi
)paren
(brace
r_return
op_logical_neg
(paren
id|wf_mpu_status
c_func
(paren
id|midi
)paren
op_amp
id|OUTPUT_READY
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|read_data
id|read_data
(paren
id|snd_wavefront_midi_t
op_star
id|midi
)paren
(brace
r_return
id|inb
(paren
id|midi-&gt;mpu_data_port
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|write_data
id|write_data
(paren
id|snd_wavefront_midi_t
op_star
id|midi
comma
r_int
r_char
id|byte
)paren
(brace
id|outb
(paren
id|byte
comma
id|midi-&gt;mpu_data_port
)paren
suffix:semicolon
)brace
r_static
id|snd_wavefront_midi_t
op_star
DECL|function|get_wavefront_midi
id|get_wavefront_midi
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
id|snd_card_t
op_star
id|card
suffix:semicolon
id|snd_wavefront_card_t
op_star
id|acard
suffix:semicolon
r_if
c_cond
(paren
id|substream
op_eq
l_int|NULL
op_logical_or
id|substream-&gt;rmidi
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|card
op_assign
id|substream-&gt;rmidi-&gt;card
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;private_data
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|acard
op_assign
id|card-&gt;private_data
suffix:semicolon
r_return
op_amp
id|acard-&gt;wavefront.midi
suffix:semicolon
)brace
DECL|function|snd_wavefront_midi_output_write
r_static
r_void
id|snd_wavefront_midi_output_write
c_func
(paren
id|snd_wavefront_card_t
op_star
id|card
)paren
(brace
id|snd_wavefront_midi_t
op_star
id|midi
op_assign
op_amp
id|card-&gt;wavefront.midi
suffix:semicolon
id|snd_wavefront_mpu_id
id|mpu
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|midi_byte
suffix:semicolon
r_int
id|max
op_assign
l_int|256
comma
id|mask
op_assign
l_int|1
suffix:semicolon
r_int
id|timeout
suffix:semicolon
multiline_comment|/* Its not OK to try to change the status of &quot;virtuality&quot; of&n;&t;   the MIDI interface while we&squot;re outputting stuff.  See&n;&t;   snd_wavefront_midi_{enable,disable}_virtual () for the&n;&t;   other half of this.  &n;&n;&t;   The first loop attempts to flush any data from the&n;&t;   current output device, and then the second &n;&t;   emits the switch byte (if necessary), and starts&n;&t;   outputting data for the output device currently in use.&n;&t;*/
r_if
c_cond
(paren
id|midi-&gt;substream_output
(braket
id|midi-&gt;output_mpu
)braket
op_eq
l_int|NULL
)paren
(brace
r_goto
id|__second
suffix:semicolon
)brace
r_while
c_loop
(paren
id|max
OG
l_int|0
)paren
(brace
multiline_comment|/* XXX fix me - no hard timing loops allowed! */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|30000
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|output_ready
(paren
id|midi
)paren
)paren
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|midi-&gt;mode
(braket
id|midi-&gt;output_mpu
)braket
op_amp
id|MPU401_MODE_OUTPUT
)paren
op_eq
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_goto
id|__second
suffix:semicolon
)brace
r_if
c_cond
(paren
id|output_ready
(paren
id|midi
)paren
)paren
(brace
r_if
c_cond
(paren
id|snd_rawmidi_transmit
c_func
(paren
id|midi-&gt;substream_output
(braket
id|midi-&gt;output_mpu
)braket
comma
op_amp
id|midi_byte
comma
l_int|1
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|midi-&gt;isvirtual
op_logical_or
(paren
id|midi_byte
op_ne
id|WF_INTERNAL_SWITCH
op_logical_and
id|midi_byte
op_ne
id|WF_EXTERNAL_SWITCH
)paren
)paren
id|write_data
c_func
(paren
id|midi
comma
id|midi_byte
)paren
suffix:semicolon
id|max
op_decrement
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|midi-&gt;istimer
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|midi-&gt;istimer
op_le
l_int|0
)paren
id|del_timer
c_func
(paren
op_amp
id|midi-&gt;timer
)paren
suffix:semicolon
)brace
id|midi-&gt;mode
(braket
id|midi-&gt;output_mpu
)braket
op_and_assign
op_complement
id|MPU401_MODE_OUTPUT_TRIGGER
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_goto
id|__second
suffix:semicolon
)brace
)brace
r_else
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
)brace
id|__second
suffix:colon
r_if
c_cond
(paren
id|midi-&gt;substream_output
(braket
op_logical_neg
id|midi-&gt;output_mpu
)braket
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|max
OG
l_int|0
)paren
(brace
multiline_comment|/* XXX fix me - no hard timing loops allowed! */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|30000
suffix:semicolon
id|timeout
OG
l_int|0
suffix:semicolon
id|timeout
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|output_ready
(paren
id|midi
)paren
)paren
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|midi-&gt;isvirtual
)paren
id|mask
op_assign
l_int|0
suffix:semicolon
id|mpu
op_assign
id|midi-&gt;output_mpu
op_xor
id|mask
suffix:semicolon
id|mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t invert the value from now */
r_if
c_cond
(paren
(paren
id|midi-&gt;mode
(braket
id|mpu
)braket
op_amp
id|MPU401_MODE_OUTPUT
)paren
op_eq
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|snd_rawmidi_transmit_empty
c_func
(paren
id|midi-&gt;substream_output
(braket
id|mpu
)braket
)paren
)paren
r_goto
id|__timer
suffix:semicolon
r_if
c_cond
(paren
id|output_ready
(paren
id|midi
)paren
)paren
(brace
r_if
c_cond
(paren
id|mpu
op_ne
id|midi-&gt;output_mpu
)paren
(brace
id|write_data
c_func
(paren
id|midi
comma
id|mpu
op_eq
id|internal_mpu
ques
c_cond
id|WF_INTERNAL_SWITCH
suffix:colon
id|WF_EXTERNAL_SWITCH
)paren
suffix:semicolon
id|midi-&gt;output_mpu
op_assign
id|mpu
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|snd_rawmidi_transmit
c_func
(paren
id|midi-&gt;substream_output
(braket
id|mpu
)braket
comma
op_amp
id|midi_byte
comma
l_int|1
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|midi-&gt;isvirtual
op_logical_or
(paren
id|midi_byte
op_ne
id|WF_INTERNAL_SWITCH
op_logical_and
id|midi_byte
op_ne
id|WF_EXTERNAL_SWITCH
)paren
)paren
id|write_data
c_func
(paren
id|midi
comma
id|midi_byte
)paren
suffix:semicolon
id|max
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|__timer
suffix:colon
r_if
c_cond
(paren
id|midi-&gt;istimer
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|midi-&gt;istimer
op_le
l_int|0
)paren
id|del_timer
c_func
(paren
op_amp
id|midi-&gt;timer
)paren
suffix:semicolon
)brace
id|midi-&gt;mode
(braket
id|mpu
)braket
op_and_assign
op_complement
id|MPU401_MODE_OUTPUT_TRIGGER
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|snd_wavefront_midi_input_open
r_static
r_int
id|snd_wavefront_midi_input_open
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
suffix:semicolon
id|snd_wavefront_mpu_id
id|mpu
suffix:semicolon
id|snd_assert
c_func
(paren
id|substream
op_ne
l_int|NULL
op_logical_and
id|substream-&gt;rmidi
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|substream-&gt;rmidi-&gt;private_data
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
)paren
suffix:semicolon
id|mpu
op_assign
op_star
(paren
(paren
id|snd_wavefront_mpu_id
op_star
)paren
id|substream-&gt;rmidi-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|midi
op_assign
id|get_wavefront_midi
(paren
id|substream
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|midi-&gt;open
comma
id|flags
)paren
suffix:semicolon
id|midi-&gt;mode
(braket
id|mpu
)braket
op_or_assign
id|MPU401_MODE_INPUT
suffix:semicolon
id|midi-&gt;substream_input
(braket
id|mpu
)braket
op_assign
id|substream
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|midi-&gt;open
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_wavefront_midi_output_open
r_static
r_int
id|snd_wavefront_midi_output_open
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
suffix:semicolon
id|snd_wavefront_mpu_id
id|mpu
suffix:semicolon
id|snd_assert
c_func
(paren
id|substream
op_ne
l_int|NULL
op_logical_and
id|substream-&gt;rmidi
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|substream-&gt;rmidi-&gt;private_data
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
)paren
suffix:semicolon
id|mpu
op_assign
op_star
(paren
(paren
id|snd_wavefront_mpu_id
op_star
)paren
id|substream-&gt;rmidi-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|midi
op_assign
id|get_wavefront_midi
(paren
id|substream
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|midi-&gt;open
comma
id|flags
)paren
suffix:semicolon
id|midi-&gt;mode
(braket
id|mpu
)braket
op_or_assign
id|MPU401_MODE_OUTPUT
suffix:semicolon
id|midi-&gt;substream_output
(braket
id|mpu
)braket
op_assign
id|substream
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|midi-&gt;open
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_wavefront_midi_input_close
r_static
r_int
id|snd_wavefront_midi_input_close
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
suffix:semicolon
id|snd_wavefront_mpu_id
id|mpu
suffix:semicolon
id|snd_assert
c_func
(paren
id|substream
op_ne
l_int|NULL
op_logical_and
id|substream-&gt;rmidi
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|substream-&gt;rmidi-&gt;private_data
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
)paren
suffix:semicolon
id|mpu
op_assign
op_star
(paren
(paren
id|snd_wavefront_mpu_id
op_star
)paren
id|substream-&gt;rmidi-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|midi
op_assign
id|get_wavefront_midi
(paren
id|substream
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|midi-&gt;open
comma
id|flags
)paren
suffix:semicolon
id|midi-&gt;mode
(braket
id|mpu
)braket
op_and_assign
op_complement
id|MPU401_MODE_INPUT
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|midi-&gt;open
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_wavefront_midi_output_close
r_static
r_int
id|snd_wavefront_midi_output_close
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
suffix:semicolon
id|snd_wavefront_mpu_id
id|mpu
suffix:semicolon
id|snd_assert
c_func
(paren
id|substream
op_ne
l_int|NULL
op_logical_and
id|substream-&gt;rmidi
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|substream-&gt;rmidi-&gt;private_data
op_ne
l_int|NULL
comma
r_return
op_minus
id|EIO
)paren
suffix:semicolon
id|mpu
op_assign
op_star
(paren
(paren
id|snd_wavefront_mpu_id
op_star
)paren
id|substream-&gt;rmidi-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|midi
op_assign
id|get_wavefront_midi
(paren
id|substream
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|midi-&gt;open
comma
id|flags
)paren
suffix:semicolon
id|midi-&gt;mode
(braket
id|mpu
)braket
op_and_assign
op_complement
id|MPU401_MODE_OUTPUT
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|midi-&gt;open
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_wavefront_midi_input_trigger
r_static
r_void
id|snd_wavefront_midi_input_trigger
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
comma
r_int
id|up
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
suffix:semicolon
id|snd_wavefront_mpu_id
id|mpu
suffix:semicolon
r_if
c_cond
(paren
id|substream
op_eq
l_int|NULL
op_logical_or
id|substream-&gt;rmidi
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|substream-&gt;rmidi-&gt;private_data
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|mpu
op_assign
op_star
(paren
(paren
id|snd_wavefront_mpu_id
op_star
)paren
id|substream-&gt;rmidi-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|midi
op_assign
id|get_wavefront_midi
(paren
id|substream
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
(brace
id|midi-&gt;mode
(braket
id|mpu
)braket
op_or_assign
id|MPU401_MODE_INPUT_TRIGGER
suffix:semicolon
)brace
r_else
(brace
id|midi-&gt;mode
(braket
id|mpu
)braket
op_and_assign
op_complement
id|MPU401_MODE_INPUT_TRIGGER
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|snd_wavefront_midi_output_timer
r_static
r_void
id|snd_wavefront_midi_output_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|snd_wavefront_card_t
op_star
id|card
op_assign
(paren
id|snd_wavefront_card_t
op_star
)paren
id|data
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
op_assign
op_amp
id|card-&gt;wavefront.midi
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
id|midi-&gt;timer.expires
op_assign
l_int|1
op_plus
id|jiffies
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|midi-&gt;timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
id|snd_wavefront_midi_output_write
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
DECL|function|snd_wavefront_midi_output_trigger
r_static
r_void
id|snd_wavefront_midi_output_trigger
c_func
(paren
id|snd_rawmidi_substream_t
op_star
id|substream
comma
r_int
id|up
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
suffix:semicolon
id|snd_wavefront_mpu_id
id|mpu
suffix:semicolon
r_if
c_cond
(paren
id|substream
op_eq
l_int|NULL
op_logical_or
id|substream-&gt;rmidi
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|substream-&gt;rmidi-&gt;private_data
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|mpu
op_assign
op_star
(paren
(paren
id|snd_wavefront_mpu_id
op_star
)paren
id|substream-&gt;rmidi-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|midi
op_assign
id|get_wavefront_midi
(paren
id|substream
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
(brace
r_if
c_cond
(paren
(paren
id|midi-&gt;mode
(braket
id|mpu
)braket
op_amp
id|MPU401_MODE_OUTPUT_TRIGGER
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|midi-&gt;istimer
)paren
(brace
id|midi-&gt;timer.function
op_assign
id|snd_wavefront_midi_output_timer
suffix:semicolon
id|midi-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|substream-&gt;rmidi-&gt;card-&gt;private_data
suffix:semicolon
id|midi-&gt;timer.expires
op_assign
l_int|1
op_plus
id|jiffies
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|midi-&gt;timer
)paren
suffix:semicolon
)brace
id|midi-&gt;istimer
op_increment
suffix:semicolon
id|midi-&gt;mode
(braket
id|mpu
)braket
op_or_assign
id|MPU401_MODE_OUTPUT_TRIGGER
suffix:semicolon
)brace
)brace
r_else
(brace
id|midi-&gt;mode
(braket
id|mpu
)braket
op_and_assign
op_complement
id|MPU401_MODE_OUTPUT_TRIGGER
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|up
)paren
id|snd_wavefront_midi_output_write
c_func
(paren
(paren
id|snd_wavefront_card_t
op_star
)paren
id|substream-&gt;rmidi-&gt;card-&gt;private_data
)paren
suffix:semicolon
)brace
r_void
DECL|function|snd_wavefront_midi_interrupt
id|snd_wavefront_midi_interrupt
(paren
id|snd_wavefront_card_t
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
suffix:semicolon
r_static
id|snd_rawmidi_substream_t
op_star
id|substream
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|mpu
op_assign
id|external_mpu
suffix:semicolon
r_int
id|max
op_assign
l_int|128
suffix:semicolon
r_int
r_char
id|byte
suffix:semicolon
id|midi
op_assign
op_amp
id|card-&gt;wavefront.midi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|input_avail
(paren
id|midi
)paren
)paren
(brace
multiline_comment|/* not for us */
id|snd_wavefront_midi_output_write
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|max
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input_avail
(paren
id|midi
)paren
)paren
(brace
id|byte
op_assign
id|read_data
(paren
id|midi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|midi-&gt;isvirtual
)paren
(brace
r_if
c_cond
(paren
id|byte
op_eq
id|WF_EXTERNAL_SWITCH
)paren
(brace
id|substream
op_assign
id|midi-&gt;substream_input
(braket
id|external_mpu
)braket
suffix:semicolon
id|mpu
op_assign
id|external_mpu
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|byte
op_eq
id|WF_INTERNAL_SWITCH
)paren
(brace
id|substream
op_assign
id|midi-&gt;substream_output
(braket
id|internal_mpu
)braket
suffix:semicolon
id|mpu
op_assign
id|internal_mpu
suffix:semicolon
)brace
multiline_comment|/* else just leave it as it is */
)brace
r_else
(brace
id|substream
op_assign
id|midi-&gt;substream_input
(braket
id|internal_mpu
)braket
suffix:semicolon
id|mpu
op_assign
id|internal_mpu
suffix:semicolon
)brace
r_if
c_cond
(paren
id|substream
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|midi-&gt;mode
(braket
id|mpu
)braket
op_amp
id|MPU401_MODE_INPUT_TRIGGER
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
id|snd_rawmidi_receive
c_func
(paren
id|substream
comma
op_amp
id|byte
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|midi
op_member_access_from_pointer
r_virtual
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|snd_wavefront_midi_output_write
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_void
DECL|function|snd_wavefront_midi_enable_virtual
id|snd_wavefront_midi_enable_virtual
(paren
id|snd_wavefront_card_t
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|card-&gt;wavefront.midi
dot
r_virtual
comma
id|flags
)paren
suffix:semicolon
id|card-&gt;wavefront.midi.isvirtual
op_assign
l_int|1
suffix:semicolon
id|card-&gt;wavefront.midi.output_mpu
op_assign
id|internal_mpu
suffix:semicolon
id|card-&gt;wavefront.midi.input_mpu
op_assign
id|internal_mpu
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|card-&gt;wavefront.midi
dot
r_virtual
comma
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|snd_wavefront_midi_disable_virtual
id|snd_wavefront_midi_disable_virtual
(paren
id|snd_wavefront_card_t
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|card-&gt;wavefront.midi
dot
r_virtual
comma
id|flags
)paren
suffix:semicolon
singleline_comment|// snd_wavefront_midi_input_close (card-&gt;ics2115_external_rmidi);
singleline_comment|// snd_wavefront_midi_output_close (card-&gt;ics2115_external_rmidi);
id|card-&gt;wavefront.midi.isvirtual
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|card-&gt;wavefront.midi
dot
r_virtual
comma
id|flags
)paren
suffix:semicolon
)brace
r_int
id|__init
DECL|function|snd_wavefront_midi_start
id|snd_wavefront_midi_start
(paren
id|snd_wavefront_card_t
op_star
id|card
)paren
(brace
r_int
id|ok
comma
id|i
suffix:semicolon
r_int
r_char
id|rbuf
(braket
l_int|4
)braket
comma
id|wbuf
(braket
l_int|4
)braket
suffix:semicolon
id|snd_wavefront_t
op_star
id|dev
suffix:semicolon
id|snd_wavefront_midi_t
op_star
id|midi
suffix:semicolon
id|dev
op_assign
op_amp
id|card-&gt;wavefront
suffix:semicolon
id|midi
op_assign
op_amp
id|dev-&gt;midi
suffix:semicolon
multiline_comment|/* The ICS2115 MPU-401 interface doesn&squot;t do anything&n;&t;   until its set into UART mode.&n;&t;*/
multiline_comment|/* XXX fix me - no hard timing loops allowed! */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|30000
op_logical_and
op_logical_neg
id|output_ready
(paren
id|midi
)paren
suffix:semicolon
id|i
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|output_ready
(paren
id|midi
)paren
)paren
(brace
id|snd_printk
(paren
l_string|&quot;MIDI interface not ready for command&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Any interrupts received from now on&n;&t;   are owned by the MIDI side of things.&n;&t;*/
id|dev-&gt;interrupts_are_midi
op_assign
l_int|1
suffix:semicolon
id|outb
(paren
id|UART_MODE_ON
comma
id|midi-&gt;mpu_command_port
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ok
op_assign
l_int|0
comma
id|i
op_assign
l_int|50000
suffix:semicolon
id|i
OG
l_int|0
op_logical_and
op_logical_neg
id|ok
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|input_avail
(paren
id|midi
)paren
)paren
(brace
r_if
c_cond
(paren
id|read_data
(paren
id|midi
)paren
op_eq
id|MPU_ACK
)paren
(brace
id|ok
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ok
)paren
(brace
id|snd_printk
(paren
l_string|&quot;cannot set UART mode for MIDI interface&quot;
)paren
suffix:semicolon
id|dev-&gt;interrupts_are_midi
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Route external MIDI to WaveFront synth (by default) */
r_if
c_cond
(paren
id|snd_wavefront_cmd
(paren
id|dev
comma
id|WFC_MISYNTH_ON
comma
id|rbuf
comma
id|wbuf
)paren
)paren
(brace
id|snd_printk
(paren
l_string|&quot;can&squot;t enable MIDI-IN-2-synth routing.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX error ? */
)brace
multiline_comment|/* Turn on Virtual MIDI, but first *always* turn it off,&n;&t;   since otherwise consectutive reloads of the driver will&n;&t;   never cause the hardware to generate the initial &quot;internal&quot; or &n;&t;   &quot;external&quot; source bytes in the MIDI data stream. This&n;&t;   is pretty important, since the internal hardware generally will&n;&t;   be used to generate none or very little MIDI output, and&n;&t;   thus the only source of MIDI data is actually external. Without&n;&t;   the switch bytes, the driver will think it all comes from&n;&t;   the internal interface. Duh.&n;&t;*/
r_if
c_cond
(paren
id|snd_wavefront_cmd
(paren
id|dev
comma
id|WFC_VMIDI_OFF
comma
id|rbuf
comma
id|wbuf
)paren
)paren
(brace
id|snd_printk
(paren
l_string|&quot;virtual MIDI mode not disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* We&squot;re OK, but missing the external MIDI dev */
)brace
id|snd_wavefront_midi_enable_virtual
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd_wavefront_cmd
(paren
id|dev
comma
id|WFC_VMIDI_ON
comma
id|rbuf
comma
id|wbuf
)paren
)paren
(brace
id|snd_printk
(paren
l_string|&quot;cannot enable virtual MIDI mode.&bslash;n&quot;
)paren
suffix:semicolon
id|snd_wavefront_midi_disable_virtual
(paren
id|card
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|snd_wavefront_midi_output
id|snd_rawmidi_ops_t
id|snd_wavefront_midi_output
op_assign
(brace
dot
id|open
op_assign
id|snd_wavefront_midi_output_open
comma
dot
id|close
op_assign
id|snd_wavefront_midi_output_close
comma
dot
id|trigger
op_assign
id|snd_wavefront_midi_output_trigger
comma
)brace
suffix:semicolon
DECL|variable|snd_wavefront_midi_input
id|snd_rawmidi_ops_t
id|snd_wavefront_midi_input
op_assign
(brace
dot
id|open
op_assign
id|snd_wavefront_midi_input_open
comma
dot
id|close
op_assign
id|snd_wavefront_midi_input_close
comma
dot
id|trigger
op_assign
id|snd_wavefront_midi_input_trigger
comma
)brace
suffix:semicolon
eof
