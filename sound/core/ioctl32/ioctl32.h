multiline_comment|/*&n; *   32bit -&gt; 64bit ioctl helpers&n; *   Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; *&n; * This file registers the converters from 32-bit ioctls to 64-bit ones.&n; * The converter assumes that a 32-bit user-pointer can be casted by A(x)&n; * macro to a valid 64-bit pointer which is accessible via copy_from/to_user.&n; *&n; */
macro_line|#ifndef __ALSA_IOCTL32_H
DECL|macro|__ALSA_IOCTL32_H
mdefine_line|#define __ALSA_IOCTL32_H
macro_line|#ifndef A
macro_line|#ifdef CONFIG_PPC64
macro_line|#include &lt;asm/ppc32.h&gt;
macro_line|#else
multiline_comment|/* x86-64, sparc64 */
DECL|macro|A
mdefine_line|#define A(__x) ((void *)(unsigned long)(__x))
macro_line|#endif
macro_line|#endif
DECL|macro|TO_PTR
mdefine_line|#define TO_PTR(x)  A(x)
DECL|macro|COPY
mdefine_line|#define COPY(x)  (dst-&gt;x = src-&gt;x)
DECL|macro|CPTR
mdefine_line|#define CPTR(x)&t; (dst-&gt;x = (typeof(dst-&gt;x))A(src-&gt;x))
DECL|macro|convert_from_32
mdefine_line|#define convert_from_32(type, dstp, srcp)&bslash;&n;{&bslash;&n;&t;struct sndrv_##type *dst = dstp;&bslash;&n;&t;struct sndrv_##type##32 *src = srcp;&bslash;&n;&t;CVT_##sndrv_##type();&bslash;&n;}
DECL|macro|convert_to_32
mdefine_line|#define convert_to_32(type, dstp, srcp)&bslash;&n;{&bslash;&n;&t;struct sndrv_##type *src = srcp;&bslash;&n;&t;struct sndrv_##type##32 *dst = dstp;&bslash;&n;&t;CVT_##sndrv_##type();&bslash;&n;}
DECL|macro|DEFINE_ALSA_IOCTL
mdefine_line|#define DEFINE_ALSA_IOCTL(type) &bslash;&n;static int _snd_ioctl32_##type(unsigned int fd, unsigned int cmd, unsigned long arg, struct file *file, unsigned int native_ctl)&bslash;&n;{&bslash;&n;&t;struct sndrv_##type##32 data32;&bslash;&n;&t;struct sndrv_##type data;&bslash;&n;&t;mm_segment_t oldseg;&bslash;&n;&t;int err;&bslash;&n;&t;if (copy_from_user(&amp;data32, (void*)arg, sizeof(data32)))&bslash;&n;&t;&t;return -EFAULT;&bslash;&n;&t;memset(&amp;data, 0, sizeof(data));&bslash;&n;&t;convert_from_32(type, &amp;data, &amp;data32);&bslash;&n;&t;oldseg = get_fs();&bslash;&n;&t;set_fs(KERNEL_DS);&bslash;&n;&t;err = file-&gt;f_op-&gt;ioctl(file-&gt;f_dentry-&gt;d_inode, file, native_ctl, (unsigned long)&amp;data);&bslash;&n;&t;if (err &lt; 0) &bslash;&n;&t;&t;return err;&bslash;&n;&t;if (native_ctl &amp; (_IOC_READ &lt;&lt; _IOC_DIRSHIFT)) {&bslash;&n;&t;&t;convert_to_32(type, &amp;data32, &amp;data);&bslash;&n;&t;&t;if (copy_to_user((void*)arg, &amp;data32, sizeof(data32)))&bslash;&n;&t;&t;&t;return -EFAULT;&bslash;&n;&t;}&bslash;&n;&t;return 0;&bslash;&n;}
DECL|macro|DEFINE_ALSA_IOCTL_BIG
mdefine_line|#define DEFINE_ALSA_IOCTL_BIG(type) &bslash;&n;static int _snd_ioctl32_##type(unsigned int fd, unsigned int cmd, unsigned long arg, struct file *file, unsigned int native_ctl)&bslash;&n;{&bslash;&n;&t;struct sndrv_##type##32 *data32;&bslash;&n;&t;struct sndrv_##type *data;&bslash;&n;&t;mm_segment_t oldseg;&bslash;&n;&t;int err;&bslash;&n;&t;data32 = kcalloc(sizeof(*data32), GFP_KERNEL); &bslash;&n;&t;data = kcalloc(sizeof(*data), GFP_KERNEL); &bslash;&n;&t;if (data32 == NULL || data == NULL) { &bslash;&n;&t;&t;err = -ENOMEM; &bslash;&n;&t;&t;goto __end; &bslash;&n;&t;}
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|data32
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
op_star
id|data32
)paren
)paren
)paren
(brace
"&bslash;"
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
"&bslash;"
r_goto
id|__end
suffix:semicolon
"&bslash;"
)brace
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|data
)paren
)paren
suffix:semicolon
"&bslash;"
id|convert_from_32
c_func
(paren
id|type
comma
id|data
comma
id|data32
)paren
suffix:semicolon
"&bslash;"
id|oldseg
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
"&bslash;"
DECL|variable|KERNEL_DS
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
"&bslash;"
id|err
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
comma
id|file
comma
id|native_ctl
comma
(paren
r_int
r_int
)paren
id|data
)paren
suffix:semicolon
"&bslash;"
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
"&bslash;"
r_goto
id|__end
suffix:semicolon
"&bslash;"
id|err
op_assign
l_int|0
suffix:semicolon
"&bslash;"
r_if
c_cond
(paren
id|native_ctl
op_amp
(paren
id|_IOC_READ
op_lshift
id|_IOC_DIRSHIFT
)paren
)paren
(brace
"&bslash;"
id|convert_to_32
c_func
(paren
id|type
comma
id|data32
comma
id|data
)paren
suffix:semicolon
"&bslash;"
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
id|data32
comma
r_sizeof
(paren
op_star
id|data32
)paren
)paren
)paren
"&bslash;"
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
"&bslash;"
)brace
"&bslash;"
id|__end
suffix:colon
"&bslash;"
r_if
c_cond
(paren
id|data
)paren
"&bslash;"
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
"&bslash;"
r_if
c_cond
(paren
id|data32
)paren
"&bslash;"
DECL|variable|data32
id|kfree
c_func
(paren
id|data32
)paren
suffix:semicolon
"&bslash;"
r_return
id|err
suffix:semicolon
"&bslash;"
)brace
mdefine_line|#define DEFINE_ALSA_IOCTL_ENTRY(name,type,native_ctl) &bslash;&n;static int snd_ioctl32_##name(unsigned int fd, unsigned int cmd, unsigned long arg, struct file *file) {&bslash;&n;&t;return _snd_ioctl32_##type(fd, cmd, arg, file, native_ctl);&bslash;&n;}
r_struct
id|ioctl32_mapper
(brace
r_int
r_int
id|cmd
suffix:semicolon
r_int
(paren
op_star
id|handler
)paren
(paren
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_int
id|registered
suffix:semicolon
)brace
suffix:semicolon
r_int
id|snd_ioctl32_register
c_func
(paren
r_struct
id|ioctl32_mapper
op_star
id|mappers
)paren
suffix:semicolon
r_void
id|snd_ioctl32_unregister
c_func
(paren
r_struct
id|ioctl32_mapper
op_star
id|mappers
)paren
suffix:semicolon
macro_line|#endif /* __ALSA_IOCTL32_H */
eof
