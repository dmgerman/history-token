multiline_comment|/*&n; *   32bit -&gt; 64bit ioctl wrapper for PCM API&n; *   Copyright (c) by Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/compat.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/pcm.h&gt;
macro_line|#include &lt;sound/minors.h&gt;
macro_line|#include &quot;ioctl32.h&quot;
multiline_comment|/* wrapper for sndrv_pcm_[us]frames */
DECL|struct|sndrv_pcm_sframes_str
r_struct
id|sndrv_pcm_sframes_str
(brace
DECL|member|val
id|sndrv_pcm_sframes_t
id|val
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sndrv_pcm_sframes_str32
r_struct
id|sndrv_pcm_sframes_str32
(brace
DECL|member|val
id|s32
id|val
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sndrv_pcm_uframes_str
r_struct
id|sndrv_pcm_uframes_str
(brace
DECL|member|val
id|sndrv_pcm_uframes_t
id|val
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|sndrv_pcm_uframes_str32
r_struct
id|sndrv_pcm_uframes_str32
(brace
DECL|member|val
id|u32
id|val
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|CVT_sndrv_pcm_sframes_str
mdefine_line|#define CVT_sndrv_pcm_sframes_str() { COPY_CVT(val); }
DECL|macro|CVT_sndrv_pcm_uframes_str
mdefine_line|#define CVT_sndrv_pcm_uframes_str() { COPY_CVT(val); }
DECL|struct|sndrv_pcm_hw_params32
r_struct
id|sndrv_pcm_hw_params32
(brace
DECL|member|flags
id|u32
id|flags
suffix:semicolon
DECL|member|masks
r_struct
id|sndrv_mask
id|masks
(braket
id|SNDRV_PCM_HW_PARAM_LAST_MASK
op_minus
id|SNDRV_PCM_HW_PARAM_FIRST_MASK
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* this must be identical */
DECL|member|mres
r_struct
id|sndrv_mask
id|mres
(braket
l_int|5
)braket
suffix:semicolon
multiline_comment|/* reserved masks */
DECL|member|intervals
r_struct
id|sndrv_interval
id|intervals
(braket
id|SNDRV_PCM_HW_PARAM_LAST_INTERVAL
op_minus
id|SNDRV_PCM_HW_PARAM_FIRST_INTERVAL
op_plus
l_int|1
)braket
suffix:semicolon
DECL|member|ires
r_struct
id|sndrv_interval
id|ires
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* reserved intervals */
DECL|member|rmask
id|u32
id|rmask
suffix:semicolon
DECL|member|cmask
id|u32
id|cmask
suffix:semicolon
DECL|member|info
id|u32
id|info
suffix:semicolon
DECL|member|msbits
id|u32
id|msbits
suffix:semicolon
DECL|member|rate_num
id|u32
id|rate_num
suffix:semicolon
DECL|member|rate_den
id|u32
id|rate_den
suffix:semicolon
DECL|member|fifo_size
id|u32
id|fifo_size
suffix:semicolon
DECL|member|reserved
r_int
r_char
id|reserved
(braket
l_int|64
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|sndrv_pcm_sw_params32
r_struct
id|sndrv_pcm_sw_params32
(brace
DECL|member|tstamp_mode
id|s32
id|tstamp_mode
suffix:semicolon
DECL|member|period_step
id|u32
id|period_step
suffix:semicolon
DECL|member|sleep_min
id|u32
id|sleep_min
suffix:semicolon
DECL|member|avail_min
id|u32
id|avail_min
suffix:semicolon
DECL|member|xfer_align
id|u32
id|xfer_align
suffix:semicolon
DECL|member|start_threshold
id|u32
id|start_threshold
suffix:semicolon
DECL|member|stop_threshold
id|u32
id|stop_threshold
suffix:semicolon
DECL|member|silence_threshold
id|u32
id|silence_threshold
suffix:semicolon
DECL|member|silence_size
id|u32
id|silence_size
suffix:semicolon
DECL|member|boundary
id|u32
id|boundary
suffix:semicolon
DECL|member|reserved
r_int
r_char
id|reserved
(braket
l_int|64
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|CVT_sndrv_pcm_sw_params
mdefine_line|#define CVT_sndrv_pcm_sw_params()&bslash;&n;{&bslash;&n;&t;COPY(tstamp_mode);&bslash;&n;&t;COPY(period_step);&bslash;&n;&t;COPY(sleep_min);&bslash;&n;&t;COPY_CVT(avail_min);&bslash;&n;&t;COPY_CVT(xfer_align);&bslash;&n;&t;COPY_CVT(start_threshold);&bslash;&n;&t;COPY_CVT(stop_threshold);&bslash;&n;&t;COPY_CVT(silence_threshold);&bslash;&n;&t;COPY_CVT(silence_size);&bslash;&n;&t;COPY_CVT(boundary);&bslash;&n;}
DECL|struct|sndrv_pcm_channel_info32
r_struct
id|sndrv_pcm_channel_info32
(brace
DECL|member|channel
id|u32
id|channel
suffix:semicolon
DECL|member|offset
id|u32
id|offset
suffix:semicolon
DECL|member|first
id|u32
id|first
suffix:semicolon
DECL|member|step
id|u32
id|step
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|CVT_sndrv_pcm_channel_info
mdefine_line|#define CVT_sndrv_pcm_channel_info()&bslash;&n;{&bslash;&n;&t;COPY(channel);&bslash;&n;&t;COPY_CVT(offset);&bslash;&n;&t;COPY(first);&bslash;&n;&t;COPY(step);&bslash;&n;}
DECL|struct|sndrv_pcm_status32
r_struct
id|sndrv_pcm_status32
(brace
DECL|member|state
id|s32
id|state
suffix:semicolon
DECL|member|trigger_tstamp
r_struct
id|compat_timespec
id|trigger_tstamp
suffix:semicolon
DECL|member|tstamp
r_struct
id|compat_timespec
id|tstamp
suffix:semicolon
DECL|member|appl_ptr
id|u32
id|appl_ptr
suffix:semicolon
DECL|member|hw_ptr
id|u32
id|hw_ptr
suffix:semicolon
DECL|member|delay
id|s32
id|delay
suffix:semicolon
DECL|member|avail
id|u32
id|avail
suffix:semicolon
DECL|member|avail_max
id|u32
id|avail_max
suffix:semicolon
DECL|member|overrange
id|u32
id|overrange
suffix:semicolon
DECL|member|suspended_state
id|s32
id|suspended_state
suffix:semicolon
DECL|member|reserved
r_int
r_char
id|reserved
(braket
l_int|60
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|CVT_sndrv_pcm_status
mdefine_line|#define CVT_sndrv_pcm_status()&bslash;&n;{&bslash;&n;&t;COPY(state);&bslash;&n;&t;COPY_CVT(trigger_tstamp.tv_sec);&bslash;&n;&t;COPY_CVT(trigger_tstamp.tv_nsec);&bslash;&n;&t;COPY_CVT(tstamp.tv_sec);&bslash;&n;&t;COPY_CVT(tstamp.tv_nsec);&bslash;&n;&t;COPY_CVT(appl_ptr);&bslash;&n;&t;COPY_CVT(hw_ptr);&bslash;&n;&t;COPY_CVT(delay);&bslash;&n;&t;COPY_CVT(avail);&bslash;&n;&t;COPY_CVT(avail_max);&bslash;&n;&t;COPY_CVT(overrange);&bslash;&n;&t;COPY(suspended_state);&bslash;&n;}
DECL|variable|pcm_uframes_str
id|DEFINE_ALSA_IOCTL
c_func
(paren
id|pcm_uframes_str
)paren
suffix:semicolon
DECL|variable|pcm_sframes_str
id|DEFINE_ALSA_IOCTL
c_func
(paren
id|pcm_sframes_str
)paren
suffix:semicolon
DECL|variable|pcm_sw_params
id|DEFINE_ALSA_IOCTL
c_func
(paren
id|pcm_sw_params
)paren
suffix:semicolon
DECL|variable|pcm_channel_info
id|DEFINE_ALSA_IOCTL
c_func
(paren
id|pcm_channel_info
)paren
suffix:semicolon
DECL|variable|pcm_status
id|DEFINE_ALSA_IOCTL
c_func
(paren
id|pcm_status
)paren
suffix:semicolon
multiline_comment|/* sanity device check */
r_extern
r_int
id|snd_major
suffix:semicolon
DECL|function|sanity_check_pcm
r_static
r_int
id|sanity_check_pcm
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|minor
suffix:semicolon
r_if
c_cond
(paren
id|imajor
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
op_ne
id|snd_major
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
id|minor
op_assign
id|iminor
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_ge
l_int|256
op_logical_or
id|minor
op_mod
id|SNDRV_MINOR_DEVICES
OL
id|SNDRV_MINOR_PCM_PLAYBACK
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* recalcuate the boundary within 32bit */
DECL|function|recalculate_boundary
r_static
r_void
id|recalculate_boundary
c_func
(paren
id|snd_pcm_runtime_t
op_star
id|runtime
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|runtime-&gt;buffer_size
)paren
r_return
suffix:semicolon
id|runtime-&gt;boundary
op_assign
id|runtime-&gt;buffer_size
suffix:semicolon
r_while
c_loop
(paren
id|runtime-&gt;boundary
op_star
l_int|2
op_le
l_int|0x7fffffffUL
op_minus
id|runtime-&gt;buffer_size
)paren
id|runtime-&gt;boundary
op_mul_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* both for HW_PARAMS and HW_REFINE */
DECL|function|_snd_ioctl32_pcm_hw_params
r_static
r_int
id|_snd_ioctl32_pcm_hw_params
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|native_ctl
)paren
(brace
r_struct
id|sndrv_pcm_hw_params32
id|__user
op_star
id|data32
suffix:semicolon
r_struct
id|sndrv_pcm_hw_params
op_star
id|data
suffix:semicolon
id|snd_pcm_file_t
op_star
id|pcm_file
suffix:semicolon
id|snd_pcm_substream_t
op_star
id|substream
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check_pcm
c_func
(paren
id|file
)paren
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcm_file
op_assign
id|file-&gt;private_data
)paren
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|substream
op_assign
id|pcm_file-&gt;substream
)paren
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|runtime
op_assign
id|substream-&gt;runtime
)paren
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
id|data32
op_assign
id|compat_ptr
c_func
(paren
id|arg
)paren
suffix:semicolon
id|data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|data
comma
id|data32
comma
r_sizeof
(paren
op_star
id|data32
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|native_ctl
op_eq
id|SNDRV_PCM_IOCTL_HW_REFINE
)paren
id|err
op_assign
id|snd_pcm_hw_refine
c_func
(paren
id|substream
comma
id|data
)paren
suffix:semicolon
r_else
id|err
op_assign
id|snd_pcm_hw_params
c_func
(paren
id|substream
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|data32
comma
id|data
comma
r_sizeof
(paren
op_star
id|data32
)paren
)paren
op_logical_or
id|__put_user
c_func
(paren
(paren
id|u32
)paren
id|data-&gt;fifo_size
comma
op_amp
id|data32-&gt;fifo_size
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|native_ctl
op_eq
id|SNDRV_PCM_IOCTL_HW_PARAMS
)paren
id|recalculate_boundary
c_func
(paren
id|runtime
)paren
suffix:semicolon
id|error
suffix:colon
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|struct|sndrv_xferi32
r_struct
id|sndrv_xferi32
(brace
DECL|member|result
id|s32
id|result
suffix:semicolon
DECL|member|buf
id|u32
id|buf
suffix:semicolon
DECL|member|frames
id|u32
id|frames
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|function|_snd_ioctl32_xferi
r_static
r_int
id|_snd_ioctl32_xferi
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|native_ctl
)paren
(brace
r_struct
id|sndrv_xferi32
id|data32
suffix:semicolon
r_struct
id|sndrv_xferi
id|__user
op_star
id|data
suffix:semicolon
id|snd_pcm_sframes_t
id|result
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|data32
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_assign
id|compat_alloc_user_space
c_func
(paren
r_sizeof
(paren
op_star
id|data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
(paren
id|snd_pcm_sframes_t
)paren
id|data32.result
comma
op_amp
id|data-&gt;result
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|data32.buf
)paren
comma
op_amp
id|data-&gt;buf
)paren
op_logical_or
id|__put_user
c_func
(paren
(paren
id|snd_pcm_uframes_t
)paren
id|data32.frames
comma
op_amp
id|data-&gt;frames
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|err
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
comma
id|file
comma
id|native_ctl
comma
(paren
r_int
r_int
)paren
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* copy the result */
r_if
c_cond
(paren
id|__get_user
c_func
(paren
id|result
comma
op_amp
id|data-&gt;result
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data32.result
op_assign
id|result
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
op_amp
id|data32
comma
r_sizeof
(paren
id|data32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* snd_xfern needs remapping of bufs */
DECL|struct|sndrv_xfern32
r_struct
id|sndrv_xfern32
(brace
DECL|member|result
id|s32
id|result
suffix:semicolon
DECL|member|bufs
id|u32
id|bufs
suffix:semicolon
multiline_comment|/* this is void **; */
DECL|member|frames
id|u32
id|frames
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * xfern ioctl nees to copy (up to) 128 pointers on stack.&n; * although we may pass the copied pointers through f_op-&gt;ioctl, but the ioctl&n; * handler there expands again the same 128 pointers on stack, so it is better&n; * to handle the function (calling pcm_readv/writev) directly in this handler.&n; */
DECL|function|_snd_ioctl32_xfern
r_static
r_int
id|_snd_ioctl32_xfern
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|native_ctl
)paren
(brace
id|snd_pcm_file_t
op_star
id|pcm_file
suffix:semicolon
id|snd_pcm_substream_t
op_star
id|substream
suffix:semicolon
r_struct
id|sndrv_xfern32
id|__user
op_star
id|srcptr
op_assign
id|compat_ptr
c_func
(paren
id|arg
)paren
suffix:semicolon
r_struct
id|sndrv_xfern32
id|data32
suffix:semicolon
r_void
id|__user
op_star
op_star
id|bufs
suffix:semicolon
r_int
id|err
op_assign
l_int|0
comma
id|ch
comma
id|i
suffix:semicolon
id|u32
id|__user
op_star
id|bufptr
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check_pcm
c_func
(paren
id|file
)paren
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcm_file
op_assign
id|file-&gt;private_data
)paren
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|substream
op_assign
id|pcm_file-&gt;substream
)paren
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|substream-&gt;runtime
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
multiline_comment|/* check validty of the command */
r_switch
c_cond
(paren
id|native_ctl
)paren
(brace
r_case
id|SNDRV_PCM_IOCTL_WRITEN_FRAMES
suffix:colon
r_if
c_cond
(paren
id|substream-&gt;stream
op_ne
id|SNDRV_PCM_STREAM_PLAYBACK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|substream-&gt;runtime-&gt;status-&gt;state
op_eq
id|SNDRV_PCM_STATE_OPEN
)paren
r_return
op_minus
id|EBADFD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_IOCTL_READN_FRAMES
suffix:colon
r_if
c_cond
(paren
id|substream-&gt;stream
op_ne
id|SNDRV_PCM_STREAM_CAPTURE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ch
op_assign
id|substream-&gt;runtime-&gt;channels
)paren
OG
l_int|128
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|data32
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|data32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|bufptr
op_assign
id|compat_ptr
c_func
(paren
id|data32.bufs
)paren
suffix:semicolon
id|bufs
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_void
id|__user
op_star
)paren
op_star
id|ch
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufs
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ch
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|ptr
comma
id|bufptr
)paren
)paren
(brace
id|kfree
c_func
(paren
id|bufs
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|bufs
(braket
id|ch
)braket
op_assign
id|compat_ptr
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|bufptr
op_increment
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|native_ctl
)paren
(brace
r_case
id|SNDRV_PCM_IOCTL_WRITEN_FRAMES
suffix:colon
id|err
op_assign
id|snd_pcm_lib_writev
c_func
(paren
id|substream
comma
id|bufs
comma
id|data32.frames
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_IOCTL_READN_FRAMES
suffix:colon
id|err
op_assign
id|snd_pcm_lib_readv
c_func
(paren
id|substream
comma
id|bufs
comma
id|data32.frames
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|err
comma
op_amp
id|srcptr-&gt;result
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|bufs
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|struct|sndrv_pcm_mmap_status32
r_struct
id|sndrv_pcm_mmap_status32
(brace
DECL|member|state
id|s32
id|state
suffix:semicolon
DECL|member|pad1
id|s32
id|pad1
suffix:semicolon
DECL|member|hw_ptr
id|u32
id|hw_ptr
suffix:semicolon
DECL|member|tstamp
r_struct
id|compat_timespec
id|tstamp
suffix:semicolon
DECL|member|suspended_state
id|s32
id|suspended_state
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|sndrv_pcm_mmap_control32
r_struct
id|sndrv_pcm_mmap_control32
(brace
DECL|member|appl_ptr
id|u32
id|appl_ptr
suffix:semicolon
DECL|member|avail_min
id|u32
id|avail_min
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|sndrv_pcm_sync_ptr32
r_struct
id|sndrv_pcm_sync_ptr32
(brace
DECL|member|flags
id|u32
id|flags
suffix:semicolon
r_union
(brace
DECL|member|status
r_struct
id|sndrv_pcm_mmap_status32
id|status
suffix:semicolon
DECL|member|reserved
r_int
r_char
id|reserved
(braket
l_int|64
)braket
suffix:semicolon
DECL|member|s
)brace
id|s
suffix:semicolon
r_union
(brace
DECL|member|control
r_struct
id|sndrv_pcm_mmap_control32
id|control
suffix:semicolon
DECL|member|reserved
r_int
r_char
id|reserved
(braket
l_int|64
)braket
suffix:semicolon
DECL|member|c
)brace
id|c
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|CVT_sndrv_pcm_sync_ptr
mdefine_line|#define CVT_sndrv_pcm_sync_ptr()&bslash;&n;{&bslash;&n;&t;COPY(flags);&bslash;&n;&t;COPY(s.status.state);&bslash;&n;&t;COPY(s.status.pad1);&bslash;&n;&t;COPY_CVT(s.status.hw_ptr);&bslash;&n;&t;COPY_CVT(s.status.tstamp.tv_sec);&bslash;&n;&t;COPY_CVT(s.status.tstamp.tv_nsec);&bslash;&n;&t;COPY(s.status.suspended_state);&bslash;&n;&t;COPY_CVT(c.control.appl_ptr);&bslash;&n;&t;COPY_CVT(c.control.avail_min);&bslash;&n;}
DECL|variable|pcm_sync_ptr
id|DEFINE_ALSA_IOCTL
c_func
(paren
id|pcm_sync_ptr
)paren
suffix:semicolon
multiline_comment|/*&n; */
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_hw_refine
comma
id|pcm_hw_params
comma
id|SNDRV_PCM_IOCTL_HW_REFINE
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_hw_params
comma
id|pcm_hw_params
comma
id|SNDRV_PCM_IOCTL_HW_PARAMS
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_sw_params
comma
id|pcm_sw_params
comma
id|SNDRV_PCM_IOCTL_SW_PARAMS
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_status
comma
id|pcm_status
comma
id|SNDRV_PCM_IOCTL_STATUS
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_delay
comma
id|pcm_sframes_str
comma
id|SNDRV_PCM_IOCTL_DELAY
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_channel_info
comma
id|pcm_channel_info
comma
id|SNDRV_PCM_IOCTL_CHANNEL_INFO
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_rewind
comma
id|pcm_uframes_str
comma
id|SNDRV_PCM_IOCTL_REWIND
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_forward
comma
id|pcm_uframes_str
comma
id|SNDRV_PCM_IOCTL_FORWARD
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_readi
comma
id|xferi
comma
id|SNDRV_PCM_IOCTL_READI_FRAMES
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_writei
comma
id|xferi
comma
id|SNDRV_PCM_IOCTL_WRITEI_FRAMES
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_readn
comma
id|xfern
comma
id|SNDRV_PCM_IOCTL_READN_FRAMES
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_writen
comma
id|xfern
comma
id|SNDRV_PCM_IOCTL_WRITEN_FRAMES
)paren
suffix:semicolon
id|DEFINE_ALSA_IOCTL_ENTRY
c_func
(paren
id|pcm_sync_ptr
comma
id|pcm_sync_ptr
comma
id|SNDRV_PCM_IOCTL_SYNC_PTR
)paren
suffix:semicolon
multiline_comment|/*&n; * When PCM is used on 32bit mode, we need to disable&n; * mmap of PCM status/control records because of the size&n; * incompatibility.&n; * &n; * Since INFO ioctl is always called at first, we mark the&n; * mmap-disabling in this ioctl wrapper.&n; */
DECL|function|snd_pcm_info_ioctl32
r_static
r_int
id|snd_pcm_info_ioctl32
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|snd_pcm_file_t
op_star
id|pcm_file
suffix:semicolon
id|snd_pcm_substream_t
op_star
id|substream
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filp-&gt;f_op
op_logical_or
op_logical_neg
id|filp-&gt;f_op-&gt;ioctl
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
id|pcm_file
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcm_file
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
id|substream
op_assign
id|pcm_file-&gt;substream
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|substream
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
id|substream-&gt;no_mmap_ctrl
op_assign
l_int|1
suffix:semicolon
r_return
id|filp-&gt;f_op
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|filp-&gt;f_dentry-&gt;d_inode
comma
id|filp
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|macro|AP
mdefine_line|#define AP(x) snd_ioctl32_##x
r_enum
(brace
DECL|enumerator|SNDRV_PCM_IOCTL_HW_REFINE32
id|SNDRV_PCM_IOCTL_HW_REFINE32
op_assign
id|_IOWR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x10
comma
r_struct
id|sndrv_pcm_hw_params32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_HW_PARAMS32
id|SNDRV_PCM_IOCTL_HW_PARAMS32
op_assign
id|_IOWR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x11
comma
r_struct
id|sndrv_pcm_hw_params32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_SW_PARAMS32
id|SNDRV_PCM_IOCTL_SW_PARAMS32
op_assign
id|_IOWR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x13
comma
r_struct
id|sndrv_pcm_sw_params32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_STATUS32
id|SNDRV_PCM_IOCTL_STATUS32
op_assign
id|_IOR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x20
comma
r_struct
id|sndrv_pcm_status32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_DELAY32
id|SNDRV_PCM_IOCTL_DELAY32
op_assign
id|_IOR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x21
comma
id|s32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_CHANNEL_INFO32
id|SNDRV_PCM_IOCTL_CHANNEL_INFO32
op_assign
id|_IOR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x32
comma
r_struct
id|sndrv_pcm_channel_info32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_REWIND32
id|SNDRV_PCM_IOCTL_REWIND32
op_assign
id|_IOW
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x46
comma
id|u32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_FORWARD32
id|SNDRV_PCM_IOCTL_FORWARD32
op_assign
id|_IOW
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x49
comma
id|u32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_WRITEI_FRAMES32
id|SNDRV_PCM_IOCTL_WRITEI_FRAMES32
op_assign
id|_IOW
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x50
comma
r_struct
id|sndrv_xferi32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_READI_FRAMES32
id|SNDRV_PCM_IOCTL_READI_FRAMES32
op_assign
id|_IOR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x51
comma
r_struct
id|sndrv_xferi32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_WRITEN_FRAMES32
id|SNDRV_PCM_IOCTL_WRITEN_FRAMES32
op_assign
id|_IOW
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x52
comma
r_struct
id|sndrv_xfern32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_READN_FRAMES32
id|SNDRV_PCM_IOCTL_READN_FRAMES32
op_assign
id|_IOR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x53
comma
r_struct
id|sndrv_xfern32
)paren
comma
DECL|enumerator|SNDRV_PCM_IOCTL_SYNC_PTR32
id|SNDRV_PCM_IOCTL_SYNC_PTR32
op_assign
id|_IOWR
c_func
(paren
l_char|&squot;A&squot;
comma
l_int|0x23
comma
r_struct
id|sndrv_pcm_sync_ptr32
)paren
comma
)brace
suffix:semicolon
DECL|variable|pcm_mappers
r_struct
id|ioctl32_mapper
id|pcm_mappers
(braket
)braket
op_assign
(brace
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_PVERSION
)paren
comma
multiline_comment|/* MAP_COMPAT(SNDRV_PCM_IOCTL_INFO), */
(brace
id|SNDRV_PCM_IOCTL_INFO
comma
id|snd_pcm_info_ioctl32
)brace
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_TSTAMP
)paren
comma
(brace
id|SNDRV_PCM_IOCTL_HW_REFINE32
comma
id|AP
c_func
(paren
id|pcm_hw_refine
)paren
)brace
comma
(brace
id|SNDRV_PCM_IOCTL_HW_PARAMS32
comma
id|AP
c_func
(paren
id|pcm_hw_params
)paren
)brace
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_HW_FREE
)paren
comma
(brace
id|SNDRV_PCM_IOCTL_SW_PARAMS32
comma
id|AP
c_func
(paren
id|pcm_sw_params
)paren
)brace
comma
(brace
id|SNDRV_PCM_IOCTL_STATUS32
comma
id|AP
c_func
(paren
id|pcm_status
)paren
)brace
comma
(brace
id|SNDRV_PCM_IOCTL_DELAY32
comma
id|AP
c_func
(paren
id|pcm_delay
)paren
)brace
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_HWSYNC
)paren
comma
(brace
id|SNDRV_PCM_IOCTL_SYNC_PTR32
comma
id|AP
c_func
(paren
id|pcm_sync_ptr
)paren
)brace
comma
(brace
id|SNDRV_PCM_IOCTL_CHANNEL_INFO32
comma
id|AP
c_func
(paren
id|pcm_channel_info
)paren
)brace
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_PREPARE
)paren
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_RESET
)paren
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_START
)paren
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_DROP
)paren
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_DRAIN
)paren
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_PAUSE
)paren
comma
(brace
id|SNDRV_PCM_IOCTL_REWIND32
comma
id|AP
c_func
(paren
id|pcm_rewind
)paren
)brace
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_RESUME
)paren
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_XRUN
)paren
comma
(brace
id|SNDRV_PCM_IOCTL_FORWARD32
comma
id|AP
c_func
(paren
id|pcm_forward
)paren
)brace
comma
(brace
id|SNDRV_PCM_IOCTL_WRITEI_FRAMES32
comma
id|AP
c_func
(paren
id|pcm_writei
)paren
)brace
comma
(brace
id|SNDRV_PCM_IOCTL_READI_FRAMES32
comma
id|AP
c_func
(paren
id|pcm_readi
)paren
)brace
comma
(brace
id|SNDRV_PCM_IOCTL_WRITEN_FRAMES32
comma
id|AP
c_func
(paren
id|pcm_writen
)paren
)brace
comma
(brace
id|SNDRV_PCM_IOCTL_READN_FRAMES32
comma
id|AP
c_func
(paren
id|pcm_readn
)paren
)brace
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_LINK
)paren
comma
id|MAP_COMPAT
c_func
(paren
id|SNDRV_PCM_IOCTL_UNLINK
)paren
comma
(brace
l_int|0
)brace
comma
)brace
suffix:semicolon
eof
