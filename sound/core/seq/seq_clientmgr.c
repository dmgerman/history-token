multiline_comment|/*&n; *  ALSA sequencer Client Manager&n; *  Copyright (c) 1998-2001 by Frank van de Pol &lt;fvdpol@coil.demon.nl&gt;&n; *                             Jaroslav Kysela &lt;perex@suse.cz&gt;&n; *                             Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/minors.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &lt;sound/seq_kernel.h&gt;
macro_line|#include &quot;seq_clientmgr.h&quot;
macro_line|#include &quot;seq_memory.h&quot;
macro_line|#include &quot;seq_queue.h&quot;
macro_line|#include &quot;seq_timer.h&quot;
macro_line|#include &quot;seq_info.h&quot;
macro_line|#include &quot;seq_system.h&quot;
macro_line|#include &lt;sound/seq_device.h&gt;
macro_line|#if defined(CONFIG_SND_BIT32_EMUL) || defined(CONFIG_SND_BIT32_EMUL_MODULE)
macro_line|#include &quot;../ioctl32/ioctl32.h&quot;
macro_line|#endif
multiline_comment|/* Client Manager&n;&n; * this module handles the connections of userland and kernel clients&n; * &n; */
DECL|macro|SNDRV_SEQ_LFLG_INPUT
mdefine_line|#define SNDRV_SEQ_LFLG_INPUT&t;0x0001
DECL|macro|SNDRV_SEQ_LFLG_OUTPUT
mdefine_line|#define SNDRV_SEQ_LFLG_OUTPUT&t;0x0002
DECL|macro|SNDRV_SEQ_LFLG_OPEN
mdefine_line|#define SNDRV_SEQ_LFLG_OPEN&t;(SNDRV_SEQ_LFLG_INPUT|SNDRV_SEQ_LFLG_OUTPUT)
DECL|variable|clients_lock
r_static
id|spinlock_t
id|clients_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|register_mutex
)paren
suffix:semicolon
multiline_comment|/*&n; * client table&n; */
DECL|variable|clienttablock
r_static
r_char
id|clienttablock
(braket
id|SNDRV_SEQ_MAX_CLIENTS
)braket
suffix:semicolon
DECL|variable|clienttab
r_static
id|client_t
op_star
id|clienttab
(braket
id|SNDRV_SEQ_MAX_CLIENTS
)braket
suffix:semicolon
DECL|variable|client_usage
r_static
id|usage_t
id|client_usage
suffix:semicolon
multiline_comment|/*&n; * prototypes&n; */
r_static
r_int
id|bounce_error_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|err
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
suffix:semicolon
r_static
r_int
id|snd_seq_deliver_single_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|filter
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
suffix:semicolon
multiline_comment|/*&n; */
DECL|function|snd_enter_user
r_static
r_inline
id|mm_segment_t
id|snd_enter_user
c_func
(paren
r_void
)paren
(brace
id|mm_segment_t
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
id|fs
suffix:semicolon
)brace
DECL|function|snd_leave_user
r_static
r_inline
r_void
id|snd_leave_user
c_func
(paren
id|mm_segment_t
id|fs
)paren
(brace
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|snd_seq_file_flags
r_static
r_inline
r_int
r_int
id|snd_seq_file_flags
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_switch
c_cond
(paren
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
)paren
(brace
r_case
id|FMODE_WRITE
suffix:colon
r_return
id|SNDRV_SEQ_LFLG_OUTPUT
suffix:semicolon
r_case
id|FMODE_READ
suffix:colon
r_return
id|SNDRV_SEQ_LFLG_INPUT
suffix:semicolon
r_default
suffix:colon
r_return
id|SNDRV_SEQ_LFLG_OPEN
suffix:semicolon
)brace
)brace
DECL|function|snd_seq_write_pool_allocated
r_static
r_inline
r_int
id|snd_seq_write_pool_allocated
c_func
(paren
id|client_t
op_star
id|client
)paren
(brace
r_return
id|snd_seq_total_cells
c_func
(paren
id|client-&gt;pool
)paren
OG
l_int|0
suffix:semicolon
)brace
multiline_comment|/* return pointer to client structure for specified id */
DECL|function|clientptr
r_static
id|client_t
op_star
id|clientptr
c_func
(paren
r_int
id|clientid
)paren
(brace
r_if
c_cond
(paren
id|clientid
OL
l_int|0
op_logical_or
id|clientid
op_ge
id|SNDRV_SEQ_MAX_CLIENTS
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;Seq: oops. Trying to get pointer to client %d&bslash;n&quot;
comma
id|clientid
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|clienttab
(braket
id|clientid
)braket
suffix:semicolon
)brace
r_extern
r_int
id|seq_client_load
(braket
)braket
suffix:semicolon
DECL|function|snd_seq_client_use_ptr
id|client_t
op_star
id|snd_seq_client_use_ptr
c_func
(paren
r_int
id|clientid
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|client_t
op_star
id|client
suffix:semicolon
r_if
c_cond
(paren
id|clientid
OL
l_int|0
op_logical_or
id|clientid
op_ge
id|SNDRV_SEQ_MAX_CLIENTS
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;Seq: oops. Trying to get pointer to client %d&bslash;n&quot;
comma
id|clientid
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
id|client
op_assign
id|clientptr
c_func
(paren
id|clientid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
)paren
r_goto
id|__lock
suffix:semicolon
r_if
c_cond
(paren
id|clienttablock
(braket
id|clientid
)braket
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_KMOD
r_if
c_cond
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
op_logical_and
id|current-&gt;fs-&gt;root
)paren
(brace
r_static
r_char
id|client_requested
(braket
l_int|64
)braket
suffix:semicolon
r_static
r_char
id|card_requested
(braket
id|SNDRV_CARDS
)braket
suffix:semicolon
r_if
c_cond
(paren
id|clientid
OL
l_int|64
)paren
(brace
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|client_requested
(braket
id|clientid
)braket
op_logical_and
id|current-&gt;fs-&gt;root
)paren
(brace
id|client_requested
(braket
id|clientid
)braket
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
l_int|64
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|seq_client_load
(braket
id|idx
)braket
OL
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|seq_client_load
(braket
id|idx
)braket
op_eq
id|clientid
)paren
(brace
id|request_module
c_func
(paren
l_string|&quot;snd-seq-client-%i&quot;
comma
id|clientid
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|clientid
op_ge
l_int|64
op_logical_and
id|clientid
OL
l_int|128
)paren
(brace
r_int
id|card
op_assign
(paren
id|clientid
op_minus
l_int|64
)paren
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|card
OL
id|snd_ecards_limit
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card_requested
(braket
id|card
)braket
)paren
(brace
id|card_requested
(braket
id|card
)braket
op_assign
l_int|1
suffix:semicolon
id|snd_request_card
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|snd_seq_device_load_drivers
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
id|client
op_assign
id|clientptr
c_func
(paren
id|clientid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
)paren
r_goto
id|__lock
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
id|__lock
suffix:colon
id|snd_use_lock_use
c_func
(paren
op_amp
id|client-&gt;use_lock
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|client
suffix:semicolon
)brace
DECL|function|usage_alloc
r_static
r_void
id|usage_alloc
c_func
(paren
id|usage_t
op_star
id|res
comma
r_int
id|num
)paren
(brace
id|res-&gt;cur
op_add_assign
id|num
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;cur
OG
id|res-&gt;peak
)paren
id|res-&gt;peak
op_assign
id|res-&gt;cur
suffix:semicolon
)brace
DECL|function|usage_free
r_static
r_void
id|usage_free
c_func
(paren
id|usage_t
op_star
id|res
comma
r_int
id|num
)paren
(brace
id|res-&gt;cur
op_sub_assign
id|num
suffix:semicolon
)brace
multiline_comment|/* initialise data structures */
DECL|function|client_init_data
r_int
id|__init
id|client_init_data
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* zap out the client table */
id|memset
c_func
(paren
op_amp
id|clienttablock
comma
l_int|0
comma
r_sizeof
(paren
id|clienttablock
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|clienttab
comma
l_int|0
comma
r_sizeof
(paren
id|clienttab
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|seq_create_client1
r_static
id|client_t
op_star
id|seq_create_client1
c_func
(paren
r_int
id|client_index
comma
r_int
id|poolsize
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|c
suffix:semicolon
id|client_t
op_star
id|client
suffix:semicolon
multiline_comment|/* init client data */
id|client
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|client
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|client-&gt;pool
op_assign
id|snd_seq_pool_new
c_func
(paren
id|poolsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;pool
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|client-&gt;type
op_assign
id|NO_CLIENT
suffix:semicolon
id|snd_use_lock_init
c_func
(paren
op_amp
id|client-&gt;use_lock
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|client-&gt;ports_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|client-&gt;ports_mutex
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|client-&gt;ports_list_head
)paren
suffix:semicolon
multiline_comment|/* find free slot in the client table */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client_index
OL
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|c
op_assign
l_int|128
suffix:semicolon
id|c
OL
id|SNDRV_SEQ_MAX_CLIENTS
suffix:semicolon
id|c
op_increment
)paren
(brace
r_if
c_cond
(paren
id|clienttab
(braket
id|c
)braket
op_logical_or
id|clienttablock
(braket
id|c
)braket
)paren
r_continue
suffix:semicolon
id|clienttab
(braket
id|client-&gt;number
op_assign
id|c
)braket
op_assign
id|client
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|client
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|clienttab
(braket
id|client_index
)braket
op_eq
l_int|NULL
op_logical_and
op_logical_neg
id|clienttablock
(braket
id|client_index
)braket
)paren
(brace
id|clienttab
(braket
id|client-&gt;number
op_assign
id|client_index
)braket
op_assign
id|client
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|client
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
id|snd_seq_pool_delete
c_func
(paren
op_amp
id|client-&gt;pool
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* no free slot found or busy, return failure code */
)brace
DECL|function|seq_free_client1
r_static
r_int
id|seq_free_client1
c_func
(paren
id|client_t
op_star
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_assert
c_func
(paren
id|client
op_ne
l_int|NULL
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|snd_seq_delete_all_ports
c_func
(paren
id|client
)paren
suffix:semicolon
id|snd_seq_queue_client_leave
c_func
(paren
id|client-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
id|clienttablock
(braket
id|client-&gt;number
)braket
op_assign
l_int|1
suffix:semicolon
id|clienttab
(braket
id|client-&gt;number
)braket
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
id|snd_use_lock_sync
c_func
(paren
op_amp
id|client-&gt;use_lock
)paren
suffix:semicolon
id|snd_seq_queue_client_termination
c_func
(paren
id|client-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;pool
)paren
id|snd_seq_pool_delete
c_func
(paren
op_amp
id|client-&gt;pool
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
id|clienttablock
(braket
id|client-&gt;number
)braket
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|clients_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|seq_free_client
r_static
r_void
id|seq_free_client
c_func
(paren
id|client_t
op_star
id|client
)paren
(brace
id|down
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|client-&gt;type
)paren
(brace
r_case
id|NO_CLIENT
suffix:colon
id|snd_printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Seq: Trying to free unused client %d&bslash;n&quot;
comma
id|client-&gt;number
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USER_CLIENT
suffix:colon
r_case
id|KERNEL_CLIENT
suffix:colon
id|seq_free_client1
c_func
(paren
id|client
)paren
suffix:semicolon
id|usage_free
c_func
(paren
op_amp
id|client_usage
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Seq: Trying to free client %d with undefined type = %d&bslash;n&quot;
comma
id|client-&gt;number
comma
id|client-&gt;type
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
id|snd_seq_system_client_ev_client_exit
c_func
(paren
id|client-&gt;number
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------- */
multiline_comment|/* create a user client */
DECL|function|snd_seq_open
r_static
r_int
id|snd_seq_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|c
comma
id|mode
suffix:semicolon
multiline_comment|/* client id */
id|client_t
op_star
id|client
suffix:semicolon
id|user_client_t
op_star
id|user
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|register_mutex
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|client
op_assign
id|seq_create_client1
c_func
(paren
op_minus
l_int|1
comma
id|SNDRV_SEQ_DEFAULT_EVENTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
)paren
(brace
id|up
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* failure code */
)brace
id|mode
op_assign
id|snd_seq_file_flags
c_func
(paren
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|SNDRV_SEQ_LFLG_INPUT
)paren
id|client-&gt;accept_input
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|SNDRV_SEQ_LFLG_OUTPUT
)paren
id|client-&gt;accept_output
op_assign
l_int|1
suffix:semicolon
id|user
op_assign
op_amp
id|client-&gt;data.user
suffix:semicolon
id|user-&gt;fifo
op_assign
l_int|NULL
suffix:semicolon
id|user-&gt;fifo_pool_size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|SNDRV_SEQ_LFLG_INPUT
)paren
(brace
id|user-&gt;fifo_pool_size
op_assign
id|SNDRV_SEQ_DEFAULT_CLIENT_EVENTS
suffix:semicolon
id|user-&gt;fifo
op_assign
id|snd_seq_fifo_new
c_func
(paren
id|user-&gt;fifo_pool_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|user-&gt;fifo
op_eq
l_int|NULL
)paren
(brace
id|seq_free_client1
c_func
(paren
id|client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|usage_alloc
c_func
(paren
op_amp
id|client_usage
comma
l_int|1
)paren
suffix:semicolon
id|client-&gt;type
op_assign
id|USER_CLIENT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
id|c
op_assign
id|client-&gt;number
suffix:semicolon
id|file-&gt;private_data
op_assign
id|client
suffix:semicolon
multiline_comment|/* fill client data */
id|user-&gt;file
op_assign
id|file
suffix:semicolon
id|sprintf
c_func
(paren
id|client-&gt;name
comma
l_string|&quot;Client-%d&quot;
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* make others aware this new client */
id|snd_seq_system_client_ev_client_start
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* delete a user client */
DECL|function|snd_seq_release
r_static
r_int
id|snd_seq_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|client_t
op_star
id|client
op_assign
(paren
id|client_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|client
)paren
(brace
id|seq_free_client
c_func
(paren
id|client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;data.user.fifo
)paren
id|snd_seq_fifo_delete
c_func
(paren
op_amp
id|client-&gt;data.user.fifo
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* handle client read() */
multiline_comment|/* possible error values:&n; *&t;-ENXIO&t;invalid client or file open mode&n; *&t;-ENOSPC&t;FIFO overflow (the flag is cleared after this error report)&n; *&t;-EINVAL&t;no enough user-space buffer to write the whole event&n; *&t;-EFAULT&t;seg. fault during copy to user space&n; */
DECL|function|snd_seq_read
r_static
id|ssize_t
id|snd_seq_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|offset
)paren
(brace
id|client_t
op_star
id|client
op_assign
(paren
id|client_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|fifo_t
op_star
id|fifo
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|snd_seq_event_cell_t
op_star
id|cell
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|snd_seq_file_flags
c_func
(paren
id|file
)paren
op_amp
id|SNDRV_SEQ_LFLG_INPUT
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|buf
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* check client structures are in place */
id|snd_assert
c_func
(paren
id|client
op_ne
l_int|NULL
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|client-&gt;accept_input
op_logical_or
(paren
id|fifo
op_assign
id|client-&gt;data.user.fifo
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|fifo-&gt;overflow
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/* buffer overflow is detected */
id|snd_seq_fifo_clear
c_func
(paren
id|fifo
)paren
suffix:semicolon
multiline_comment|/* return error code */
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|cell
op_assign
l_int|NULL
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|snd_seq_fifo_lock
c_func
(paren
id|fifo
)paren
suffix:semicolon
multiline_comment|/* while data available in queue */
r_while
c_loop
(paren
id|count
op_ge
r_sizeof
(paren
id|snd_seq_event_t
)paren
)paren
(brace
r_int
id|nonblock
suffix:semicolon
id|nonblock
op_assign
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
op_logical_or
id|result
OG
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_seq_fifo_cell_out
c_func
(paren
id|fifo
comma
op_amp
id|cell
comma
id|nonblock
)paren
)paren
OL
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|snd_seq_ev_is_variable
c_func
(paren
op_amp
id|cell-&gt;event
)paren
)paren
(brace
id|snd_seq_event_t
id|tmpev
suffix:semicolon
id|tmpev
op_assign
id|cell-&gt;event
suffix:semicolon
id|tmpev.data.ext.len
op_and_assign
op_complement
id|SNDRV_SEQ_EXT_MASK
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|tmpev
comma
r_sizeof
(paren
id|snd_seq_event_t
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|count
op_sub_assign
r_sizeof
(paren
id|snd_seq_event_t
)paren
suffix:semicolon
id|buf
op_add_assign
r_sizeof
(paren
id|snd_seq_event_t
)paren
suffix:semicolon
id|err
op_assign
id|snd_seq_expand_var_event
c_func
(paren
op_amp
id|cell-&gt;event
comma
id|count
comma
id|buf
comma
l_int|0
comma
r_sizeof
(paren
id|snd_seq_event_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_break
suffix:semicolon
id|result
op_add_assign
id|err
suffix:semicolon
id|count
op_sub_assign
id|err
suffix:semicolon
id|buf
op_add_assign
id|err
suffix:semicolon
)brace
r_else
(brace
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|cell-&gt;event
comma
r_sizeof
(paren
id|snd_seq_event_t
)paren
)paren
suffix:semicolon
id|count
op_sub_assign
r_sizeof
(paren
id|snd_seq_event_t
)paren
suffix:semicolon
id|buf
op_add_assign
r_sizeof
(paren
id|snd_seq_event_t
)paren
suffix:semicolon
)brace
id|snd_seq_cell_free
c_func
(paren
id|cell
)paren
suffix:semicolon
id|cell
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* to be sure */
id|result
op_add_assign
r_sizeof
(paren
id|snd_seq_event_t
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cell
)paren
id|snd_seq_fifo_cell_putback
c_func
(paren
id|fifo
comma
id|cell
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EAGAIN
op_logical_and
id|result
OG
l_int|0
)paren
id|err
op_assign
l_int|0
suffix:semicolon
)brace
id|snd_seq_fifo_unlock
c_func
(paren
id|fifo
)paren
suffix:semicolon
r_return
(paren
id|err
OL
l_int|0
)paren
ques
c_cond
id|err
suffix:colon
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * check access permission to the port&n; */
DECL|function|check_port_perm
r_static
r_int
id|check_port_perm
c_func
(paren
id|client_port_t
op_star
id|port
comma
r_int
r_int
id|flags
)paren
(brace
r_if
c_cond
(paren
(paren
id|port-&gt;capability
op_amp
id|flags
)paren
op_ne
id|flags
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|flags
suffix:semicolon
)brace
multiline_comment|/*&n; * check if the destination client is available, and return the pointer&n; * if filter is non-zero, client filter bitmap is tested.&n; */
DECL|function|get_event_dest_client
r_static
id|client_t
op_star
id|get_event_dest_client
c_func
(paren
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|filter
)paren
(brace
id|client_t
op_star
id|dest
suffix:semicolon
id|dest
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|event-&gt;dest.client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dest-&gt;accept_input
)paren
r_goto
id|__not_avail
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dest-&gt;filter
op_amp
id|SNDRV_SEQ_FILTER_USE_EVENT
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|event-&gt;type
comma
id|dest-&gt;event_filter
)paren
)paren
r_goto
id|__not_avail
suffix:semicolon
r_if
c_cond
(paren
id|filter
op_logical_and
op_logical_neg
(paren
id|dest-&gt;filter
op_amp
id|filter
)paren
)paren
r_goto
id|__not_avail
suffix:semicolon
r_return
id|dest
suffix:semicolon
multiline_comment|/* ok - accessible */
id|__not_avail
suffix:colon
id|snd_seq_client_unlock
c_func
(paren
id|dest
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the error event.&n; *&n; * If the receiver client is a user client, the original event is&n; * encapsulated in SNDRV_SEQ_EVENT_BOUNCE as variable length event.  If&n; * the original event is also variable length, the external data is&n; * copied after the event record. &n; * If the receiver client is a kernel client, the original event is&n; * quoted in SNDRV_SEQ_EVENT_KERNEL_ERROR, since this requires no extra&n; * kmalloc.&n; */
DECL|function|bounce_error_event
r_static
r_int
id|bounce_error_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|err
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|snd_seq_event_t
id|bounce_ev
suffix:semicolon
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
op_logical_or
op_logical_neg
(paren
id|client-&gt;filter
op_amp
id|SNDRV_SEQ_FILTER_BOUNCE
)paren
op_logical_or
op_logical_neg
id|client-&gt;accept_input
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ignored */
multiline_comment|/* set up quoted error */
id|memset
c_func
(paren
op_amp
id|bounce_ev
comma
l_int|0
comma
r_sizeof
(paren
id|bounce_ev
)paren
)paren
suffix:semicolon
id|bounce_ev.type
op_assign
id|SNDRV_SEQ_EVENT_KERNEL_ERROR
suffix:semicolon
id|bounce_ev.flags
op_assign
id|SNDRV_SEQ_EVENT_LENGTH_FIXED
suffix:semicolon
id|bounce_ev.queue
op_assign
id|SNDRV_SEQ_QUEUE_DIRECT
suffix:semicolon
id|bounce_ev.source.client
op_assign
id|SNDRV_SEQ_CLIENT_SYSTEM
suffix:semicolon
id|bounce_ev.source.port
op_assign
id|SNDRV_SEQ_PORT_SYSTEM_ANNOUNCE
suffix:semicolon
id|bounce_ev.dest.client
op_assign
id|client-&gt;number
suffix:semicolon
id|bounce_ev.dest.port
op_assign
id|event-&gt;source.port
suffix:semicolon
id|bounce_ev.data.quote.origin
op_assign
id|event-&gt;dest
suffix:semicolon
id|bounce_ev.data.quote.event
op_assign
id|event
suffix:semicolon
id|bounce_ev.data.quote.value
op_assign
op_minus
id|err
suffix:semicolon
multiline_comment|/* use positive value */
id|result
op_assign
id|snd_seq_deliver_single_event
c_func
(paren
l_int|NULL
comma
op_amp
id|bounce_ev
comma
l_int|0
comma
id|atomic
comma
id|hop
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|client-&gt;event_lost
op_increment
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * rewrite the time-stamp of the event record with the curren time&n; * of the given queue.&n; * return non-zero if updated.&n; */
DECL|function|update_timestamp_of_queue
r_static
r_int
id|update_timestamp_of_queue
c_func
(paren
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|queue
comma
r_int
id|real_time
)paren
(brace
id|queue_t
op_star
id|q
suffix:semicolon
id|q
op_assign
id|queueptr
c_func
(paren
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
r_return
l_int|0
suffix:semicolon
id|event-&gt;queue
op_assign
id|queue
suffix:semicolon
id|event-&gt;flags
op_and_assign
op_complement
id|SNDRV_SEQ_TIME_STAMP_MASK
suffix:semicolon
r_if
c_cond
(paren
id|real_time
)paren
(brace
id|event-&gt;time.time
op_assign
id|snd_seq_timer_get_cur_time
c_func
(paren
id|q-&gt;timer
)paren
suffix:semicolon
id|event-&gt;flags
op_or_assign
id|SNDRV_SEQ_TIME_STAMP_REAL
suffix:semicolon
)brace
r_else
(brace
id|event-&gt;time.tick
op_assign
id|snd_seq_timer_get_cur_tick
c_func
(paren
id|q-&gt;timer
)paren
suffix:semicolon
id|event-&gt;flags
op_or_assign
id|SNDRV_SEQ_TIME_STAMP_TICK
suffix:semicolon
)brace
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * deliver an event to the specified destination.&n; * if filter is non-zero, client filter bitmap is tested.&n; *&n; *  RETURN VALUE: 0 : if succeeded&n; *&t;&t; &lt;0 : error&n; */
DECL|function|snd_seq_deliver_single_event
r_static
r_int
id|snd_seq_deliver_single_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|filter
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|client_t
op_star
id|dest
op_assign
l_int|NULL
suffix:semicolon
id|client_port_t
op_star
id|dest_port
op_assign
l_int|NULL
suffix:semicolon
r_int
id|result
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_int
id|direct
suffix:semicolon
id|direct
op_assign
id|snd_seq_ev_is_direct
c_func
(paren
id|event
)paren
suffix:semicolon
id|dest
op_assign
id|get_event_dest_client
c_func
(paren
id|event
comma
id|filter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
op_eq
l_int|NULL
)paren
r_goto
id|__skip
suffix:semicolon
id|dest_port
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|dest
comma
id|event-&gt;dest.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest_port
op_eq
l_int|NULL
)paren
r_goto
id|__skip
suffix:semicolon
multiline_comment|/* check permission */
r_if
c_cond
(paren
op_logical_neg
id|check_port_perm
c_func
(paren
id|dest_port
comma
id|SNDRV_SEQ_PORT_CAP_WRITE
)paren
)paren
(brace
id|result
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|__skip
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dest_port-&gt;timestamping
)paren
id|update_timestamp_of_queue
c_func
(paren
id|event
comma
id|dest_port-&gt;time_queue
comma
id|dest_port-&gt;time_real
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dest-&gt;type
)paren
(brace
r_case
id|USER_CLIENT
suffix:colon
r_if
c_cond
(paren
id|dest-&gt;data.user.fifo
)paren
id|result
op_assign
id|snd_seq_fifo_event_in
c_func
(paren
id|dest-&gt;data.user.fifo
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KERNEL_CLIENT
suffix:colon
r_if
c_cond
(paren
id|dest_port-&gt;event_input
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|result
op_assign
id|dest_port
op_member_access_from_pointer
id|event_input
c_func
(paren
id|event
comma
id|direct
comma
id|dest_port-&gt;private_data
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|__skip
suffix:colon
r_if
c_cond
(paren
id|dest_port
)paren
id|snd_seq_port_unlock
c_func
(paren
id|dest_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
)paren
id|snd_seq_client_unlock
c_func
(paren
id|dest
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
op_logical_and
op_logical_neg
id|direct
)paren
(brace
id|result
op_assign
id|bounce_error_event
c_func
(paren
id|client
comma
id|event
comma
id|result
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * send the event to all subscribers:&n; */
DECL|function|deliver_to_subscribers
r_static
r_int
id|deliver_to_subscribers
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|subscribers_t
op_star
id|subs
suffix:semicolon
r_int
id|err
op_assign
l_int|0
comma
id|num_ev
op_assign
l_int|0
suffix:semicolon
id|snd_seq_event_t
id|event_saved
suffix:semicolon
id|client_port_t
op_star
id|src_port
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|port_subs_info_t
op_star
id|grp
suffix:semicolon
id|src_port
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|client
comma
id|event-&gt;source.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|src_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* invalid source port */
multiline_comment|/* save original event record */
id|event_saved
op_assign
op_star
id|event
suffix:semicolon
id|grp
op_assign
op_amp
id|src_port-&gt;c_src
suffix:semicolon
multiline_comment|/* lock list */
r_if
c_cond
(paren
id|atomic
)paren
id|read_lock
c_func
(paren
op_amp
id|grp-&gt;list_lock
)paren
suffix:semicolon
r_else
id|down_read
c_func
(paren
op_amp
id|grp-&gt;list_mutex
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|grp-&gt;list_head
)paren
(brace
id|subs
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|subscribers_t
comma
id|src_list
)paren
suffix:semicolon
id|event-&gt;dest
op_assign
id|subs-&gt;info.dest
suffix:semicolon
r_if
c_cond
(paren
id|subs-&gt;info.flags
op_amp
id|SNDRV_SEQ_PORT_SUBS_TIMESTAMP
)paren
multiline_comment|/* convert time according to flag with subscription */
id|update_timestamp_of_queue
c_func
(paren
id|event
comma
id|subs-&gt;info.queue
comma
id|subs-&gt;info.flags
op_amp
id|SNDRV_SEQ_PORT_SUBS_TIME_REAL
)paren
suffix:semicolon
id|err
op_assign
id|snd_seq_deliver_single_event
c_func
(paren
id|client
comma
id|event
comma
l_int|0
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_break
suffix:semicolon
id|num_ev
op_increment
suffix:semicolon
multiline_comment|/* restore original event record */
op_star
id|event
op_assign
id|event_saved
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic
)paren
id|read_unlock
c_func
(paren
op_amp
id|grp-&gt;list_lock
)paren
suffix:semicolon
r_else
id|up_read
c_func
(paren
op_amp
id|grp-&gt;list_mutex
)paren
suffix:semicolon
op_star
id|event
op_assign
id|event_saved
suffix:semicolon
multiline_comment|/* restore */
id|snd_seq_port_unlock
c_func
(paren
id|src_port
)paren
suffix:semicolon
r_return
(paren
id|err
OL
l_int|0
)paren
ques
c_cond
id|err
suffix:colon
id|num_ev
suffix:semicolon
)brace
macro_line|#ifdef SUPPORT_BROADCAST 
multiline_comment|/*&n; * broadcast to all ports:&n; */
DECL|function|port_broadcast_event
r_static
r_int
id|port_broadcast_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
r_int
id|num_ev
op_assign
l_int|0
comma
id|err
op_assign
l_int|0
suffix:semicolon
id|client_t
op_star
id|dest_client
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|dest_client
op_assign
id|get_event_dest_client
c_func
(paren
id|event
comma
id|SNDRV_SEQ_FILTER_BROADCAST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest_client
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no matching destination */
id|read_lock
c_func
(paren
op_amp
id|dest_client-&gt;ports_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|dest_client-&gt;ports_list_head
)paren
(brace
id|client_port_t
op_star
id|port
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|client_port_t
comma
id|list
)paren
suffix:semicolon
id|event-&gt;dest.port
op_assign
id|port-&gt;addr.port
suffix:semicolon
multiline_comment|/* pass NULL as source client to avoid error bounce */
id|err
op_assign
id|snd_seq_deliver_single_event
c_func
(paren
l_int|NULL
comma
id|event
comma
id|SNDRV_SEQ_FILTER_BROADCAST
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_break
suffix:semicolon
id|num_ev
op_increment
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|dest_client-&gt;ports_lock
)paren
suffix:semicolon
id|snd_seq_client_unlock
c_func
(paren
id|dest_client
)paren
suffix:semicolon
id|event-&gt;dest.port
op_assign
id|SNDRV_SEQ_ADDRESS_BROADCAST
suffix:semicolon
multiline_comment|/* restore */
r_return
(paren
id|err
OL
l_int|0
)paren
ques
c_cond
id|err
suffix:colon
id|num_ev
suffix:semicolon
)brace
multiline_comment|/*&n; * send the event to all clients:&n; * if destination port is also ADDRESS_BROADCAST, deliver to all ports.&n; */
DECL|function|broadcast_event
r_static
r_int
id|broadcast_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
r_int
id|err
op_assign
l_int|0
comma
id|num_ev
op_assign
l_int|0
suffix:semicolon
r_int
id|dest
suffix:semicolon
id|snd_seq_addr_t
id|addr
suffix:semicolon
id|addr
op_assign
id|event-&gt;dest
suffix:semicolon
multiline_comment|/* save */
r_for
c_loop
(paren
id|dest
op_assign
l_int|0
suffix:semicolon
id|dest
OL
id|SNDRV_SEQ_MAX_CLIENTS
suffix:semicolon
id|dest
op_increment
)paren
(brace
multiline_comment|/* don&squot;t send to itself */
r_if
c_cond
(paren
id|dest
op_eq
id|client-&gt;number
)paren
r_continue
suffix:semicolon
id|event-&gt;dest.client
op_assign
id|dest
suffix:semicolon
id|event-&gt;dest.port
op_assign
id|addr.port
suffix:semicolon
r_if
c_cond
(paren
id|addr.port
op_eq
id|SNDRV_SEQ_ADDRESS_BROADCAST
)paren
id|err
op_assign
id|port_broadcast_event
c_func
(paren
id|client
comma
id|event
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
r_else
multiline_comment|/* pass NULL as source client to avoid error bounce */
id|err
op_assign
id|snd_seq_deliver_single_event
c_func
(paren
l_int|NULL
comma
id|event
comma
id|SNDRV_SEQ_FILTER_BROADCAST
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_break
suffix:semicolon
id|num_ev
op_add_assign
id|err
suffix:semicolon
)brace
id|event-&gt;dest
op_assign
id|addr
suffix:semicolon
multiline_comment|/* restore */
r_return
(paren
id|err
OL
l_int|0
)paren
ques
c_cond
id|err
suffix:colon
id|num_ev
suffix:semicolon
)brace
multiline_comment|/* multicast - not supported yet */
DECL|function|multicast_event
r_static
r_int
id|multicast_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;seq: multicast not supported yet.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ignored */
)brace
macro_line|#endif /* SUPPORT_BROADCAST */
multiline_comment|/* deliver an event to the destination port(s).&n; * if the event is to subscribers or broadcast, the event is dispatched&n; * to multiple targets.&n; *&n; * RETURN VALUE: n &gt; 0  : the number of delivered events.&n; *               n == 0 : the event was not passed to any client.&n; *               n &lt; 0  : error - event was not processed.&n; */
DECL|function|snd_seq_deliver_event
r_int
id|snd_seq_deliver_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
r_int
id|result
suffix:semicolon
id|hop
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|hop
op_ge
id|SNDRV_SEQ_MAX_HOPS
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;too long delivery path (%d:%d-&gt;%d:%d)&bslash;n&quot;
comma
id|event-&gt;source.client
comma
id|event-&gt;source.port
comma
id|event-&gt;dest.client
comma
id|event-&gt;dest.port
)paren
suffix:semicolon
r_return
op_minus
id|EMLINK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event-&gt;queue
op_eq
id|SNDRV_SEQ_ADDRESS_SUBSCRIBERS
op_logical_or
id|event-&gt;dest.client
op_eq
id|SNDRV_SEQ_ADDRESS_SUBSCRIBERS
)paren
id|result
op_assign
id|deliver_to_subscribers
c_func
(paren
id|client
comma
id|event
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
macro_line|#ifdef SUPPORT_BROADCAST
r_else
r_if
c_cond
(paren
id|event-&gt;queue
op_eq
id|SNDRV_SEQ_ADDRESS_BROADCAST
op_logical_or
id|event-&gt;dest.client
op_eq
id|SNDRV_SEQ_ADDRESS_BROADCAST
)paren
id|result
op_assign
id|broadcast_event
c_func
(paren
id|client
comma
id|event
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|event-&gt;dest.client
op_ge
id|SNDRV_SEQ_MAX_CLIENTS
)paren
id|result
op_assign
id|multicast_event
c_func
(paren
id|client
comma
id|event
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|event-&gt;dest.port
op_eq
id|SNDRV_SEQ_ADDRESS_BROADCAST
)paren
id|result
op_assign
id|port_broadcast_event
c_func
(paren
id|client
comma
id|event
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
macro_line|#endif
r_else
id|result
op_assign
id|snd_seq_deliver_single_event
c_func
(paren
id|client
comma
id|event
comma
l_int|0
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * dispatch an event cell:&n; * This function is called only from queue check routines in timer&n; * interrupts or after enqueued.&n; * The event cell shall be released or re-queued in this function.&n; *&n; * RETURN VALUE: n &gt; 0  : the number of delivered events.&n; *&t;&t; n == 0 : the event was not passed to any client.&n; *&t;&t; n &lt; 0  : error - event was not processed.&n; */
DECL|function|snd_seq_dispatch_event
r_int
id|snd_seq_dispatch_event
c_func
(paren
id|snd_seq_event_cell_t
op_star
id|cell
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|client_t
op_star
id|client
suffix:semicolon
r_int
id|result
suffix:semicolon
id|snd_assert
c_func
(paren
id|cell
op_ne
l_int|NULL
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|client
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|cell-&gt;event.source.client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
)paren
(brace
id|snd_seq_cell_free
c_func
(paren
id|cell
)paren
suffix:semicolon
multiline_comment|/* release this cell */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cell-&gt;event.type
op_eq
id|SNDRV_SEQ_EVENT_NOTE
)paren
(brace
multiline_comment|/* NOTE event:&n;&t;&t; * the event cell is re-used as a NOTE-OFF event and&n;&t;&t; * enqueued again.&n;&t;&t; */
id|snd_seq_event_t
id|tmpev
comma
op_star
id|ev
suffix:semicolon
multiline_comment|/* reserve this event to enqueue note-off later */
id|tmpev
op_assign
id|cell-&gt;event
suffix:semicolon
id|tmpev.type
op_assign
id|SNDRV_SEQ_EVENT_NOTEON
suffix:semicolon
id|result
op_assign
id|snd_seq_deliver_event
c_func
(paren
id|client
comma
op_amp
id|tmpev
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This was originally a note event.  We now re-use the&n;&t;&t; * cell for the note-off event.&n;&t;&t; */
id|ev
op_assign
op_amp
id|cell-&gt;event
suffix:semicolon
id|ev-&gt;type
op_assign
id|SNDRV_SEQ_EVENT_NOTEOFF
suffix:semicolon
id|ev-&gt;flags
op_or_assign
id|SNDRV_SEQ_PRIORITY_HIGH
suffix:semicolon
multiline_comment|/* add the duration time */
r_switch
c_cond
(paren
id|ev-&gt;flags
op_amp
id|SNDRV_SEQ_TIME_STAMP_MASK
)paren
(brace
r_case
id|SNDRV_SEQ_TIME_STAMP_TICK
suffix:colon
id|ev-&gt;time.tick
op_add_assign
id|ev-&gt;data.note.duration
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SEQ_TIME_STAMP_REAL
suffix:colon
multiline_comment|/* unit for duration is ms */
id|ev-&gt;time.time.tv_nsec
op_add_assign
l_int|1000000
op_star
(paren
id|ev-&gt;data.note.duration
op_mod
l_int|1000
)paren
suffix:semicolon
id|ev-&gt;time.time.tv_sec
op_add_assign
id|ev-&gt;data.note.duration
op_div
l_int|1000
op_plus
id|ev-&gt;time.time.tv_nsec
op_div
l_int|1000000000
suffix:semicolon
id|ev-&gt;time.time.tv_nsec
op_mod_assign
l_int|1000000000
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ev-&gt;data.note.velocity
op_assign
id|ev-&gt;data.note.off_velocity
suffix:semicolon
multiline_comment|/* Now queue this cell as the note off event */
r_if
c_cond
(paren
id|snd_seq_enqueue_event
c_func
(paren
id|cell
comma
id|atomic
comma
id|hop
)paren
OL
l_int|0
)paren
id|snd_seq_cell_free
c_func
(paren
id|cell
)paren
suffix:semicolon
multiline_comment|/* release this cell */
)brace
r_else
(brace
multiline_comment|/* Normal events:&n;&t;&t; * event cell is freed after processing the event&n;&t;&t; */
id|result
op_assign
id|snd_seq_deliver_event
c_func
(paren
id|client
comma
op_amp
id|cell-&gt;event
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
id|snd_seq_cell_free
c_func
(paren
id|cell
)paren
suffix:semicolon
)brace
id|snd_seq_client_unlock
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Allocate a cell from client pool and enqueue it to queue:&n; * if pool is empty and blocking is TRUE, sleep until a new cell is&n; * available.&n; */
DECL|function|snd_seq_client_enqueue_event
r_static
r_int
id|snd_seq_client_enqueue_event
c_func
(paren
id|client_t
op_star
id|client
comma
id|snd_seq_event_t
op_star
id|event
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|blocking
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|snd_seq_event_cell_t
op_star
id|cell
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* special queue values - force direct passing */
r_if
c_cond
(paren
id|event-&gt;queue
op_eq
id|SNDRV_SEQ_ADDRESS_SUBSCRIBERS
)paren
(brace
id|event-&gt;dest.client
op_assign
id|SNDRV_SEQ_ADDRESS_SUBSCRIBERS
suffix:semicolon
id|event-&gt;queue
op_assign
id|SNDRV_SEQ_QUEUE_DIRECT
suffix:semicolon
)brace
r_else
macro_line|#ifdef SUPPORT_BROADCAST
r_if
c_cond
(paren
id|event-&gt;queue
op_eq
id|SNDRV_SEQ_ADDRESS_BROADCAST
)paren
(brace
id|event-&gt;dest.client
op_assign
id|SNDRV_SEQ_ADDRESS_BROADCAST
suffix:semicolon
id|event-&gt;queue
op_assign
id|SNDRV_SEQ_QUEUE_DIRECT
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|event-&gt;dest.client
op_eq
id|SNDRV_SEQ_ADDRESS_SUBSCRIBERS
)paren
(brace
multiline_comment|/* check presence of source port */
id|client_port_t
op_star
id|src_port
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|client
comma
id|event-&gt;source.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|src_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|snd_seq_port_unlock
c_func
(paren
id|src_port
)paren
suffix:semicolon
)brace
multiline_comment|/* direct event processing without enqueued */
r_if
c_cond
(paren
id|snd_seq_ev_is_direct
c_func
(paren
id|event
)paren
)paren
(brace
r_if
c_cond
(paren
id|event-&gt;type
op_eq
id|SNDRV_SEQ_EVENT_NOTE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* this event must be enqueued! */
r_return
id|snd_seq_deliver_event
c_func
(paren
id|client
comma
id|event
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
)brace
multiline_comment|/* Not direct, normal queuing */
r_if
c_cond
(paren
id|snd_seq_queue_is_used
c_func
(paren
id|event-&gt;queue
comma
id|client-&gt;number
)paren
op_le
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* invalid queue */
r_if
c_cond
(paren
op_logical_neg
id|snd_seq_write_pool_allocated
c_func
(paren
id|client
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* queue is not allocated */
multiline_comment|/* allocate an event cell */
id|err
op_assign
id|snd_seq_event_dup
c_func
(paren
id|client-&gt;pool
comma
id|event
comma
op_amp
id|cell
comma
op_logical_neg
id|blocking
op_logical_and
op_logical_neg
id|atomic
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* we got a cell. enqueue it. */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_seq_enqueue_event
c_func
(paren
id|cell
comma
id|atomic
comma
id|hop
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_seq_cell_free
c_func
(paren
id|cell
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * check validity of event type and data length.&n; * return non-zero if invalid.&n; */
DECL|function|check_event_type_and_length
r_static
r_int
id|check_event_type_and_length
c_func
(paren
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_switch
c_cond
(paren
id|snd_seq_ev_length_type
c_func
(paren
id|ev
)paren
)paren
(brace
r_case
id|SNDRV_SEQ_EVENT_LENGTH_FIXED
suffix:colon
r_if
c_cond
(paren
id|snd_seq_ev_is_variable_type
c_func
(paren
id|ev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SEQ_EVENT_LENGTH_VARIABLE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|snd_seq_ev_is_variable_type
c_func
(paren
id|ev
)paren
op_logical_or
(paren
id|ev-&gt;data.ext.len
op_amp
op_complement
id|SNDRV_SEQ_EXT_MASK
)paren
op_ge
id|SNDRV_SEQ_MAX_EVENT_LEN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SEQ_EVENT_LENGTH_VARUSR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|snd_seq_ev_is_instr_type
c_func
(paren
id|ev
)paren
op_logical_or
op_logical_neg
id|snd_seq_ev_is_direct
c_func
(paren
id|ev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* handle write() */
multiline_comment|/* possible error values:&n; *&t;-ENXIO&t;invalid client or file open mode&n; *&t;-ENOMEM&t;malloc failed&n; *&t;-EFAULT&t;seg. fault during copy from user space&n; *&t;-EINVAL&t;invalid event&n; *&t;-EAGAIN&t;no space in output pool&n; *&t;-EINTR&t;interrupts while sleep&n; *&t;-EMLINK&t;too many hops&n; *&t;others&t;depends on return value from driver callback&n; */
DECL|function|snd_seq_write
r_static
id|ssize_t
id|snd_seq_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|offset
)paren
(brace
id|client_t
op_star
id|client
op_assign
(paren
id|client_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
id|written
op_assign
l_int|0
comma
id|len
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|snd_seq_event_t
id|event
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|snd_seq_file_flags
c_func
(paren
id|file
)paren
op_amp
id|SNDRV_SEQ_LFLG_OUTPUT
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* check client structures are in place */
id|snd_assert
c_func
(paren
id|client
op_ne
l_int|NULL
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|client-&gt;accept_output
op_logical_or
id|client-&gt;pool
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* allocate the pool now if the pool is not allocated yet */
r_if
c_cond
(paren
id|client-&gt;pool-&gt;size
OG
l_int|0
op_logical_and
op_logical_neg
id|snd_seq_write_pool_allocated
c_func
(paren
id|client
)paren
)paren
(brace
r_if
c_cond
(paren
id|snd_seq_pool_init
c_func
(paren
id|client-&gt;pool
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* only process whole events */
r_while
c_loop
(paren
id|count
op_ge
r_sizeof
(paren
id|snd_seq_event_t
)paren
)paren
(brace
multiline_comment|/* Read in the event header from the user */
id|len
op_assign
r_sizeof
(paren
id|event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|event
comma
id|buf
comma
id|len
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|event.source.client
op_assign
id|client-&gt;number
suffix:semicolon
multiline_comment|/* fill in client number */
multiline_comment|/* Check for extension data length */
r_if
c_cond
(paren
id|check_event_type_and_length
c_func
(paren
op_amp
id|event
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* check for special events */
r_if
c_cond
(paren
id|event.type
op_eq
id|SNDRV_SEQ_EVENT_NONE
)paren
r_goto
id|__skip_event
suffix:semicolon
r_else
r_if
c_cond
(paren
id|snd_seq_ev_is_reserved
c_func
(paren
op_amp
id|event
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|snd_seq_ev_is_variable
c_func
(paren
op_amp
id|event
)paren
)paren
(brace
r_int
id|extlen
op_assign
id|event.data.ext.len
op_amp
op_complement
id|SNDRV_SEQ_EXT_MASK
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|extlen
op_plus
id|len
)paren
OG
id|count
)paren
(brace
multiline_comment|/* back out, will get an error this time or next */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* set user space pointer */
id|event.data.ext.len
op_assign
id|extlen
op_or
id|SNDRV_SEQ_EXT_USRPTR
suffix:semicolon
id|event.data.ext.ptr
op_assign
(paren
r_char
op_star
)paren
id|buf
op_plus
r_sizeof
(paren
id|snd_seq_event_t
)paren
suffix:semicolon
id|len
op_add_assign
id|extlen
suffix:semicolon
multiline_comment|/* increment data length */
)brace
r_else
(brace
macro_line|#if defined(CONFIG_SND_BIT32_EMUL) || defined(CONFIG_SND_BIT32_EMUL_MODULE)
r_if
c_cond
(paren
id|client-&gt;convert32
op_logical_and
id|snd_seq_ev_is_varusr
c_func
(paren
op_amp
id|event
)paren
)paren
(brace
r_void
op_star
id|ptr
op_assign
id|compat_ptr
c_func
(paren
id|event.data.raw32.d
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|event.data.ext.ptr
op_assign
id|ptr
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* ok, enqueue it */
id|err
op_assign
id|snd_seq_client_enqueue_event
c_func
(paren
id|client
comma
op_amp
id|event
comma
id|file
comma
op_logical_neg
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_break
suffix:semicolon
id|__skip_event
suffix:colon
multiline_comment|/* Update pointers and counts */
id|count
op_sub_assign
id|len
suffix:semicolon
id|buf
op_add_assign
id|len
suffix:semicolon
id|written
op_add_assign
id|len
suffix:semicolon
)brace
r_return
id|written
ques
c_cond
id|written
suffix:colon
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * handle polling&n; */
DECL|function|snd_seq_poll
r_static
r_int
r_int
id|snd_seq_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
id|client_t
op_star
id|client
op_assign
(paren
id|client_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check client structures are in place */
id|snd_assert
c_func
(paren
id|client
op_ne
l_int|NULL
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|snd_seq_file_flags
c_func
(paren
id|file
)paren
op_amp
id|SNDRV_SEQ_LFLG_INPUT
)paren
op_logical_and
id|client-&gt;data.user.fifo
)paren
(brace
multiline_comment|/* check if data is available in the outqueue */
r_if
c_cond
(paren
id|snd_seq_fifo_poll_wait
c_func
(paren
id|client-&gt;data.user.fifo
comma
id|file
comma
id|wait
)paren
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|snd_seq_file_flags
c_func
(paren
id|file
)paren
op_amp
id|SNDRV_SEQ_LFLG_OUTPUT
)paren
(brace
multiline_comment|/* check if data is available in the pool */
r_if
c_cond
(paren
op_logical_neg
id|snd_seq_write_pool_allocated
c_func
(paren
id|client
)paren
op_logical_or
id|snd_seq_pool_poll_wait
c_func
(paren
id|client-&gt;pool
comma
id|file
comma
id|wait
)paren
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------*/
multiline_comment|/* SYSTEM_INFO ioctl() */
DECL|function|snd_seq_ioctl_system_info
r_static
r_int
id|snd_seq_ioctl_system_info
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_system_info_t
id|info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* fill the info fields */
id|info.queues
op_assign
id|SNDRV_SEQ_MAX_QUEUES
suffix:semicolon
id|info.clients
op_assign
id|SNDRV_SEQ_MAX_CLIENTS
suffix:semicolon
id|info.ports
op_assign
l_int|256
suffix:semicolon
multiline_comment|/* fixed limit */
id|info.channels
op_assign
l_int|256
suffix:semicolon
multiline_comment|/* fixed limit */
id|info.cur_clients
op_assign
id|client_usage.cur
suffix:semicolon
id|info.cur_queues
op_assign
id|snd_seq_queue_get_cur_queues
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* RUNNING_MODE ioctl() */
DECL|function|snd_seq_ioctl_running_mode
r_static
r_int
id|snd_seq_ioctl_running_mode
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|sndrv_seq_running_info
id|info
suffix:semicolon
id|client_t
op_star
id|cptr
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* requested client number */
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|info.client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
multiline_comment|/* don&squot;t change !!! */
macro_line|#ifdef SNDRV_BIG_ENDIAN
r_if
c_cond
(paren
op_logical_neg
id|info.big_endian
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|__err
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|info.big_endian
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|__err
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|info.cpu_mode
OG
r_sizeof
(paren
r_int
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|__err
suffix:semicolon
)brace
id|cptr-&gt;convert32
op_assign
(paren
id|info.cpu_mode
OL
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|__err
suffix:colon
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* CLIENT_INFO ioctl() */
DECL|function|get_client_info
r_static
r_void
id|get_client_info
c_func
(paren
id|client_t
op_star
id|cptr
comma
id|snd_seq_client_info_t
op_star
id|info
)paren
(brace
id|info-&gt;client
op_assign
id|cptr-&gt;number
suffix:semicolon
multiline_comment|/* fill the info fields */
id|info-&gt;type
op_assign
id|cptr-&gt;type
suffix:semicolon
id|strcpy
c_func
(paren
id|info-&gt;name
comma
id|cptr-&gt;name
)paren
suffix:semicolon
id|info-&gt;filter
op_assign
id|cptr-&gt;filter
suffix:semicolon
id|info-&gt;event_lost
op_assign
id|cptr-&gt;event_lost
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;event_filter
comma
id|cptr-&gt;event_filter
comma
l_int|32
)paren
suffix:semicolon
id|info-&gt;num_ports
op_assign
id|cptr-&gt;num_ports
suffix:semicolon
id|memset
c_func
(paren
id|info-&gt;reserved
comma
l_int|0
comma
r_sizeof
(paren
id|info-&gt;reserved
)paren
)paren
suffix:semicolon
)brace
DECL|function|snd_seq_ioctl_get_client_info
r_static
r_int
id|snd_seq_ioctl_get_client_info
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|client_t
op_star
id|cptr
suffix:semicolon
id|snd_seq_client_info_t
id|client_info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|client_info
comma
id|arg
comma
r_sizeof
(paren
id|client_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* requested client number */
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|client_info.client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
multiline_comment|/* don&squot;t change !!! */
id|get_client_info
c_func
(paren
id|cptr
comma
op_amp
id|client_info
)paren
suffix:semicolon
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|client_info
comma
r_sizeof
(paren
id|client_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* CLIENT_INFO ioctl() */
DECL|function|snd_seq_ioctl_set_client_info
r_static
r_int
id|snd_seq_ioctl_set_client_info
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_client_info_t
id|client_info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|client_info
comma
id|arg
comma
r_sizeof
(paren
id|client_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* it is not allowed to set the info fields for an another client */
r_if
c_cond
(paren
id|client-&gt;number
op_ne
id|client_info.client
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* also client type must be set now */
r_if
c_cond
(paren
id|client-&gt;type
op_ne
id|client_info.type
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* fill the info fields */
r_if
c_cond
(paren
id|client_info.name
(braket
l_int|0
)braket
)paren
id|strlcpy
c_func
(paren
id|client-&gt;name
comma
id|client_info.name
comma
r_sizeof
(paren
id|client-&gt;name
)paren
)paren
suffix:semicolon
id|client-&gt;filter
op_assign
id|client_info.filter
suffix:semicolon
id|client-&gt;event_lost
op_assign
id|client_info.event_lost
suffix:semicolon
id|memcpy
c_func
(paren
id|client-&gt;event_filter
comma
id|client_info.event_filter
comma
l_int|32
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * CREATE PORT ioctl() &n; */
DECL|function|snd_seq_ioctl_create_port
r_static
r_int
id|snd_seq_ioctl_create_port
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|client_port_t
op_star
id|port
suffix:semicolon
id|snd_seq_port_info_t
id|info
suffix:semicolon
id|snd_seq_port_callback_t
op_star
id|callback
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* it is not allowed to create the port for an another client */
r_if
c_cond
(paren
id|info.addr.client
op_ne
id|client-&gt;number
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|port
op_assign
id|snd_seq_create_port
c_func
(paren
id|client
comma
(paren
id|info.flags
op_amp
id|SNDRV_SEQ_PORT_FLG_GIVEN_PORT
)paren
ques
c_cond
id|info.addr.port
suffix:colon
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;type
op_eq
id|USER_CLIENT
op_logical_and
id|info.kernel
)paren
(brace
id|snd_seq_delete_port
c_func
(paren
id|client
comma
id|port-&gt;addr.port
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|client-&gt;type
op_eq
id|KERNEL_CLIENT
)paren
(brace
r_if
c_cond
(paren
(paren
id|callback
op_assign
id|info.kernel
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|callback-&gt;owner
)paren
id|port-&gt;owner
op_assign
id|callback-&gt;owner
suffix:semicolon
id|port-&gt;private_data
op_assign
id|callback-&gt;private_data
suffix:semicolon
id|port-&gt;private_free
op_assign
id|callback-&gt;private_free
suffix:semicolon
id|port-&gt;callback_all
op_assign
id|callback-&gt;callback_all
suffix:semicolon
id|port-&gt;event_input
op_assign
id|callback-&gt;event_input
suffix:semicolon
id|port-&gt;c_src.open
op_assign
id|callback-&gt;subscribe
suffix:semicolon
id|port-&gt;c_src.close
op_assign
id|callback-&gt;unsubscribe
suffix:semicolon
id|port-&gt;c_dest.open
op_assign
id|callback-&gt;use
suffix:semicolon
id|port-&gt;c_dest.close
op_assign
id|callback-&gt;unuse
suffix:semicolon
)brace
)brace
id|info.addr
op_assign
id|port-&gt;addr
suffix:semicolon
id|snd_seq_set_port_info
c_func
(paren
id|port
comma
op_amp
id|info
)paren
suffix:semicolon
id|snd_seq_system_client_ev_port_start
c_func
(paren
id|port-&gt;addr.client
comma
id|port-&gt;addr.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * DELETE PORT ioctl() &n; */
DECL|function|snd_seq_ioctl_delete_port
r_static
r_int
id|snd_seq_ioctl_delete_port
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_port_info_t
id|info
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* set passed parameters */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* it is not allowed to remove the port for an another client */
r_if
c_cond
(paren
id|info.addr.client
op_ne
id|client-&gt;number
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|err
op_assign
id|snd_seq_delete_port
c_func
(paren
id|client
comma
id|info.addr.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ge
l_int|0
)paren
id|snd_seq_system_client_ev_port_exit
c_func
(paren
id|client-&gt;number
comma
id|info.addr.port
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* &n; * GET_PORT_INFO ioctl() (on any client) &n; */
DECL|function|snd_seq_ioctl_get_port_info
r_static
r_int
id|snd_seq_ioctl_get_port_info
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|client_t
op_star
id|cptr
suffix:semicolon
id|client_port_t
op_star
id|port
suffix:semicolon
id|snd_seq_port_info_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|info.addr.client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|port
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|cptr
comma
id|info.addr.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
l_int|NULL
)paren
(brace
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
multiline_comment|/* don&squot;t change */
)brace
multiline_comment|/* get port info */
id|snd_seq_get_port_info
c_func
(paren
id|port
comma
op_amp
id|info
)paren
suffix:semicolon
id|snd_seq_port_unlock
c_func
(paren
id|port
)paren
suffix:semicolon
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * SET_PORT_INFO ioctl() (only ports on this/own client) &n; */
DECL|function|snd_seq_ioctl_set_port_info
r_static
r_int
id|snd_seq_ioctl_set_port_info
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|client_port_t
op_star
id|port
suffix:semicolon
id|snd_seq_port_info_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|info.addr.client
op_ne
id|client-&gt;number
)paren
multiline_comment|/* only set our own ports ! */
r_return
op_minus
id|EPERM
suffix:semicolon
id|port
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|client
comma
id|info.addr.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
(brace
id|snd_seq_set_port_info
c_func
(paren
id|port
comma
op_amp
id|info
)paren
suffix:semicolon
id|snd_seq_port_unlock
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * port subscription (connection)&n; */
DECL|macro|PERM_RD
mdefine_line|#define PERM_RD&t;&t;(SNDRV_SEQ_PORT_CAP_READ|SNDRV_SEQ_PORT_CAP_SUBS_READ)
DECL|macro|PERM_WR
mdefine_line|#define PERM_WR&t;&t;(SNDRV_SEQ_PORT_CAP_WRITE|SNDRV_SEQ_PORT_CAP_SUBS_WRITE)
DECL|function|check_subscription_permission
r_static
r_int
id|check_subscription_permission
c_func
(paren
id|client_t
op_star
id|client
comma
id|client_port_t
op_star
id|sport
comma
id|client_port_t
op_star
id|dport
comma
id|snd_seq_port_subscribe_t
op_star
id|subs
)paren
(brace
r_if
c_cond
(paren
id|client-&gt;number
op_ne
id|subs-&gt;sender.client
op_logical_and
id|client-&gt;number
op_ne
id|subs-&gt;dest.client
)paren
(brace
multiline_comment|/* connection by third client - check export permission */
r_if
c_cond
(paren
id|check_port_perm
c_func
(paren
id|sport
comma
id|SNDRV_SEQ_PORT_CAP_NO_EXPORT
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|check_port_perm
c_func
(paren
id|dport
comma
id|SNDRV_SEQ_PORT_CAP_NO_EXPORT
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* check read permission */
multiline_comment|/* if sender or receiver is the subscribing client itself,&n;&t; * no permission check is necessary&n;&t; */
r_if
c_cond
(paren
id|client-&gt;number
op_ne
id|subs-&gt;sender.client
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|check_port_perm
c_func
(paren
id|sport
comma
id|PERM_RD
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* check write permission */
r_if
c_cond
(paren
id|client-&gt;number
op_ne
id|subs-&gt;dest.client
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|check_port_perm
c_func
(paren
id|dport
comma
id|PERM_WR
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * send an subscription notify event to user client:&n; * client must be user client.&n; */
DECL|function|snd_seq_client_notify_subscription
r_int
id|snd_seq_client_notify_subscription
c_func
(paren
r_int
id|client
comma
r_int
id|port
comma
id|snd_seq_port_subscribe_t
op_star
id|info
comma
r_int
id|evtype
)paren
(brace
id|snd_seq_event_t
id|event
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|event
comma
l_int|0
comma
r_sizeof
(paren
id|event
)paren
)paren
suffix:semicolon
id|event.type
op_assign
id|evtype
suffix:semicolon
id|event.data.connect.dest
op_assign
id|info-&gt;dest
suffix:semicolon
id|event.data.connect.sender
op_assign
id|info-&gt;sender
suffix:semicolon
r_return
id|snd_seq_system_notify
c_func
(paren
id|client
comma
id|port
comma
op_amp
id|event
)paren
suffix:semicolon
multiline_comment|/* non-atomic */
)brace
multiline_comment|/* &n; * add to port&squot;s subscription list IOCTL interface &n; */
DECL|function|snd_seq_ioctl_subscribe_port
r_static
r_int
id|snd_seq_ioctl_subscribe_port
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_int
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|client_t
op_star
id|receiver
op_assign
l_int|NULL
comma
op_star
id|sender
op_assign
l_int|NULL
suffix:semicolon
id|client_port_t
op_star
id|sport
op_assign
l_int|NULL
comma
op_star
id|dport
op_assign
l_int|NULL
suffix:semicolon
id|snd_seq_port_subscribe_t
id|subs
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|subs
comma
id|arg
comma
r_sizeof
(paren
id|subs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|receiver
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|subs.dest.client
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sender
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|subs.sender.client
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sport
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|sender
comma
id|subs.sender.port
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dport
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|receiver
comma
id|subs.dest.port
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
id|result
op_assign
id|check_subscription_permission
c_func
(paren
id|client
comma
id|sport
comma
id|dport
comma
op_amp
id|subs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|__end
suffix:semicolon
multiline_comment|/* connect them */
id|result
op_assign
id|snd_seq_port_connect
c_func
(paren
id|client
comma
id|sender
comma
id|sport
comma
id|receiver
comma
id|dport
comma
op_amp
id|subs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
multiline_comment|/* broadcast announce */
id|snd_seq_client_notify_subscription
c_func
(paren
id|SNDRV_SEQ_ADDRESS_SUBSCRIBERS
comma
l_int|0
comma
op_amp
id|subs
comma
id|SNDRV_SEQ_EVENT_PORT_SUBSCRIBED
)paren
suffix:semicolon
id|__end
suffix:colon
r_if
c_cond
(paren
id|sport
)paren
id|snd_seq_port_unlock
c_func
(paren
id|sport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dport
)paren
id|snd_seq_port_unlock
c_func
(paren
id|dport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sender
)paren
id|snd_seq_client_unlock
c_func
(paren
id|sender
)paren
suffix:semicolon
r_if
c_cond
(paren
id|receiver
)paren
id|snd_seq_client_unlock
c_func
(paren
id|receiver
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* &n; * remove from port&squot;s subscription list &n; */
DECL|function|snd_seq_ioctl_unsubscribe_port
r_static
r_int
id|snd_seq_ioctl_unsubscribe_port
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_int
id|result
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|client_t
op_star
id|receiver
op_assign
l_int|NULL
comma
op_star
id|sender
op_assign
l_int|NULL
suffix:semicolon
id|client_port_t
op_star
id|sport
op_assign
l_int|NULL
comma
op_star
id|dport
op_assign
l_int|NULL
suffix:semicolon
id|snd_seq_port_subscribe_t
id|subs
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|subs
comma
id|arg
comma
r_sizeof
(paren
id|subs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|receiver
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|subs.dest.client
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sender
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|subs.sender.client
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sport
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|sender
comma
id|subs.sender.port
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dport
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|receiver
comma
id|subs.dest.port
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
id|result
op_assign
id|check_subscription_permission
c_func
(paren
id|client
comma
id|sport
comma
id|dport
comma
op_amp
id|subs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|__end
suffix:semicolon
id|result
op_assign
id|snd_seq_port_disconnect
c_func
(paren
id|client
comma
id|sender
comma
id|sport
comma
id|receiver
comma
id|dport
comma
op_amp
id|subs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
multiline_comment|/* broadcast announce */
id|snd_seq_client_notify_subscription
c_func
(paren
id|SNDRV_SEQ_ADDRESS_SUBSCRIBERS
comma
l_int|0
comma
op_amp
id|subs
comma
id|SNDRV_SEQ_EVENT_PORT_UNSUBSCRIBED
)paren
suffix:semicolon
id|__end
suffix:colon
r_if
c_cond
(paren
id|sport
)paren
id|snd_seq_port_unlock
c_func
(paren
id|sport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dport
)paren
id|snd_seq_port_unlock
c_func
(paren
id|dport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sender
)paren
id|snd_seq_client_unlock
c_func
(paren
id|sender
)paren
suffix:semicolon
r_if
c_cond
(paren
id|receiver
)paren
id|snd_seq_client_unlock
c_func
(paren
id|receiver
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* CREATE_QUEUE ioctl() */
DECL|function|snd_seq_ioctl_create_queue
r_static
r_int
id|snd_seq_ioctl_create_queue
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_info_t
id|info
suffix:semicolon
r_int
id|result
suffix:semicolon
id|queue_t
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|result
op_assign
id|snd_seq_queue_alloc
c_func
(paren
id|client-&gt;number
comma
id|info.locked
comma
id|info.flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|q
op_assign
id|queueptr
c_func
(paren
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info.queue
op_assign
id|q-&gt;queue
suffix:semicolon
id|info.locked
op_assign
id|q-&gt;locked
suffix:semicolon
id|info.owner
op_assign
id|q-&gt;owner
suffix:semicolon
multiline_comment|/* set queue name */
r_if
c_cond
(paren
op_logical_neg
id|info.name
(braket
l_int|0
)braket
)paren
id|snprintf
c_func
(paren
id|info.name
comma
r_sizeof
(paren
id|info.name
)paren
comma
l_string|&quot;Queue-%d&quot;
comma
id|q-&gt;queue
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|q-&gt;name
comma
id|info.name
comma
r_sizeof
(paren
id|q-&gt;name
)paren
)paren
suffix:semicolon
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* DELETE_QUEUE ioctl() */
DECL|function|snd_seq_ioctl_delete_queue
r_static
r_int
id|snd_seq_ioctl_delete_queue
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_info_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|snd_seq_queue_delete
c_func
(paren
id|client-&gt;number
comma
id|info.queue
)paren
suffix:semicolon
)brace
multiline_comment|/* GET_QUEUE_INFO ioctl() */
DECL|function|snd_seq_ioctl_get_queue_info
r_static
r_int
id|snd_seq_ioctl_get_queue_info
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_info_t
id|info
suffix:semicolon
id|queue_t
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|q
op_assign
id|queueptr
c_func
(paren
id|info.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|info.queue
op_assign
id|q-&gt;queue
suffix:semicolon
id|info.owner
op_assign
id|q-&gt;owner
suffix:semicolon
id|info.locked
op_assign
id|q-&gt;locked
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.name
comma
id|q-&gt;name
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SET_QUEUE_INFO ioctl() */
DECL|function|snd_seq_ioctl_set_queue_info
r_static
r_int
id|snd_seq_ioctl_set_queue_info
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_info_t
id|info
suffix:semicolon
id|queue_t
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|info.owner
op_ne
id|client-&gt;number
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* change owner/locked permission */
r_if
c_cond
(paren
id|snd_seq_queue_check_access
c_func
(paren
id|info.queue
comma
id|client-&gt;number
)paren
)paren
(brace
r_if
c_cond
(paren
id|snd_seq_queue_set_owner
c_func
(paren
id|info.queue
comma
id|client-&gt;number
comma
id|info.locked
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|info.locked
)paren
id|snd_seq_queue_use
c_func
(paren
id|info.queue
comma
id|client-&gt;number
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|q
op_assign
id|queueptr
c_func
(paren
id|info.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;owner
op_ne
id|client-&gt;number
)paren
(brace
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|strlcpy
c_func
(paren
id|q-&gt;name
comma
id|info.name
comma
r_sizeof
(paren
id|q-&gt;name
)paren
)paren
suffix:semicolon
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* GET_NAMED_QUEUE ioctl() */
DECL|function|snd_seq_ioctl_get_named_queue
r_static
r_int
id|snd_seq_ioctl_get_named_queue
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_info_t
id|info
suffix:semicolon
id|queue_t
op_star
id|q
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|q
op_assign
id|snd_seq_queue_find_name
c_func
(paren
id|info.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info.queue
op_assign
id|q-&gt;queue
suffix:semicolon
id|info.owner
op_assign
id|q-&gt;owner
suffix:semicolon
id|info.locked
op_assign
id|q-&gt;locked
suffix:semicolon
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* GET_QUEUE_STATUS ioctl() */
DECL|function|snd_seq_ioctl_get_queue_status
r_static
r_int
id|snd_seq_ioctl_get_queue_status
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_status_t
id|status
suffix:semicolon
id|queue_t
op_star
id|queue
suffix:semicolon
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|status
comma
id|arg
comma
r_sizeof
(paren
id|status
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|queue
op_assign
id|queueptr
c_func
(paren
id|status.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|queue
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|status
comma
l_int|0
comma
r_sizeof
(paren
id|status
)paren
)paren
suffix:semicolon
id|status.queue
op_assign
id|queue-&gt;queue
suffix:semicolon
id|tmr
op_assign
id|queue-&gt;timer
suffix:semicolon
id|status.events
op_assign
id|queue-&gt;tickq-&gt;cells
op_plus
id|queue-&gt;timeq-&gt;cells
suffix:semicolon
id|status.time
op_assign
id|snd_seq_timer_get_cur_time
c_func
(paren
id|tmr
)paren
suffix:semicolon
id|status.tick
op_assign
id|snd_seq_timer_get_cur_tick
c_func
(paren
id|tmr
)paren
suffix:semicolon
id|status.running
op_assign
id|tmr-&gt;running
suffix:semicolon
id|status.flags
op_assign
id|queue-&gt;flags
suffix:semicolon
id|queuefree
c_func
(paren
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|status
comma
r_sizeof
(paren
id|status
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* GET_QUEUE_TEMPO ioctl() */
DECL|function|snd_seq_ioctl_get_queue_tempo
r_static
r_int
id|snd_seq_ioctl_get_queue_tempo
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_tempo_t
id|tempo
suffix:semicolon
id|queue_t
op_star
id|queue
suffix:semicolon
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|tempo
comma
id|arg
comma
r_sizeof
(paren
id|tempo
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|queue
op_assign
id|queueptr
c_func
(paren
id|tempo.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|queue
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tempo
comma
l_int|0
comma
r_sizeof
(paren
id|tempo
)paren
)paren
suffix:semicolon
id|tempo.queue
op_assign
id|queue-&gt;queue
suffix:semicolon
id|tmr
op_assign
id|queue-&gt;timer
suffix:semicolon
id|tempo.tempo
op_assign
id|tmr-&gt;tempo
suffix:semicolon
id|tempo.ppq
op_assign
id|tmr-&gt;ppq
suffix:semicolon
id|tempo.skew_value
op_assign
id|tmr-&gt;skew
suffix:semicolon
id|tempo.skew_base
op_assign
id|tmr-&gt;skew_base
suffix:semicolon
id|queuefree
c_func
(paren
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|tempo
comma
r_sizeof
(paren
id|tempo
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SET_QUEUE_TEMPO ioctl() */
DECL|function|snd_seq_set_queue_tempo
r_int
id|snd_seq_set_queue_tempo
c_func
(paren
r_int
id|client
comma
id|snd_seq_queue_tempo_t
op_star
id|tempo
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|snd_seq_queue_check_access
c_func
(paren
id|tempo-&gt;queue
comma
id|client
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_return
id|snd_seq_queue_timer_set_tempo
c_func
(paren
id|tempo-&gt;queue
comma
id|client
comma
id|tempo
)paren
suffix:semicolon
)brace
DECL|function|snd_seq_ioctl_set_queue_tempo
r_static
r_int
id|snd_seq_ioctl_set_queue_tempo
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_int
id|result
suffix:semicolon
id|snd_seq_queue_tempo_t
id|tempo
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|tempo
comma
id|arg
comma
r_sizeof
(paren
id|tempo
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|result
op_assign
id|snd_seq_set_queue_tempo
c_func
(paren
id|client-&gt;number
comma
op_amp
id|tempo
)paren
suffix:semicolon
r_return
id|result
OL
l_int|0
ques
c_cond
id|result
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* GET_QUEUE_TIMER ioctl() */
DECL|function|snd_seq_ioctl_get_queue_timer
r_static
r_int
id|snd_seq_ioctl_get_queue_timer
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_timer_t
id|timer
suffix:semicolon
id|queue_t
op_star
id|queue
suffix:semicolon
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|timer
comma
id|arg
comma
r_sizeof
(paren
id|timer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|queue
op_assign
id|queueptr
c_func
(paren
id|timer.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|queue
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|queue-&gt;timer_mutex
)paren
)paren
(brace
id|queuefree
c_func
(paren
id|queue
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|tmr
op_assign
id|queue-&gt;timer
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|timer
comma
l_int|0
comma
r_sizeof
(paren
id|timer
)paren
)paren
suffix:semicolon
id|timer.queue
op_assign
id|queue-&gt;queue
suffix:semicolon
id|timer.type
op_assign
id|tmr-&gt;type
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;type
op_eq
id|SNDRV_SEQ_TIMER_ALSA
)paren
(brace
id|timer.u.alsa.id
op_assign
id|tmr-&gt;alsa_id
suffix:semicolon
id|timer.u.alsa.resolution
op_assign
id|tmr-&gt;preferred_resolution
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|queue-&gt;timer_mutex
)paren
suffix:semicolon
id|queuefree
c_func
(paren
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|timer
comma
r_sizeof
(paren
id|timer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SET_QUEUE_TIMER ioctl() */
DECL|function|snd_seq_ioctl_set_queue_timer
r_static
r_int
id|snd_seq_ioctl_set_queue_timer
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|snd_seq_queue_timer_t
id|timer
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|timer
comma
id|arg
comma
r_sizeof
(paren
id|timer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|timer.type
op_ne
id|SNDRV_SEQ_TIMER_ALSA
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|snd_seq_queue_check_access
c_func
(paren
id|timer.queue
comma
id|client-&gt;number
)paren
)paren
(brace
id|queue_t
op_star
id|q
suffix:semicolon
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
id|q
op_assign
id|queueptr
c_func
(paren
id|timer.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|q-&gt;timer_mutex
)paren
)paren
(brace
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|tmr
op_assign
id|q-&gt;timer
suffix:semicolon
id|snd_seq_queue_timer_close
c_func
(paren
id|timer.queue
)paren
suffix:semicolon
id|tmr-&gt;type
op_assign
id|timer.type
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;type
op_eq
id|SNDRV_SEQ_TIMER_ALSA
)paren
(brace
id|tmr-&gt;alsa_id
op_assign
id|timer.u.alsa.id
suffix:semicolon
id|tmr-&gt;preferred_resolution
op_assign
id|timer.u.alsa.resolution
suffix:semicolon
)brace
id|result
op_assign
id|snd_seq_queue_timer_open
c_func
(paren
id|timer.queue
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|q-&gt;timer_mutex
)paren
suffix:semicolon
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* GET_QUEUE_CLIENT ioctl() */
DECL|function|snd_seq_ioctl_get_queue_client
r_static
r_int
id|snd_seq_ioctl_get_queue_client
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_queue_client_t
id|info
suffix:semicolon
r_int
id|used
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|used
op_assign
id|snd_seq_queue_is_used
c_func
(paren
id|info.queue
comma
id|client-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|used
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info.used
op_assign
id|used
suffix:semicolon
id|info.client
op_assign
id|client-&gt;number
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SET_QUEUE_CLIENT ioctl() */
DECL|function|snd_seq_ioctl_set_queue_client
r_static
r_int
id|snd_seq_ioctl_set_queue_client
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
id|snd_seq_queue_client_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|info.used
op_ge
l_int|0
)paren
(brace
id|err
op_assign
id|snd_seq_queue_use
c_func
(paren
id|info.queue
comma
id|client-&gt;number
comma
id|info.used
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
r_return
id|snd_seq_ioctl_get_queue_client
c_func
(paren
id|client
comma
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/* GET_CLIENT_POOL ioctl() */
DECL|function|snd_seq_ioctl_get_client_pool
r_static
r_int
id|snd_seq_ioctl_get_client_pool
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_client_pool_t
id|info
suffix:semicolon
id|client_t
op_star
id|cptr
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|info.client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|info.output_pool
op_assign
id|cptr-&gt;pool-&gt;size
suffix:semicolon
id|info.output_room
op_assign
id|cptr-&gt;pool-&gt;room
suffix:semicolon
id|info.output_free
op_assign
id|info.output_pool
suffix:semicolon
r_if
c_cond
(paren
id|cptr-&gt;pool
)paren
id|info.output_free
op_assign
id|snd_seq_unused_cells
c_func
(paren
id|cptr-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr-&gt;type
op_eq
id|USER_CLIENT
)paren
(brace
id|info.input_pool
op_assign
id|cptr-&gt;data.user.fifo_pool_size
suffix:semicolon
id|info.input_free
op_assign
id|info.input_pool
suffix:semicolon
r_if
c_cond
(paren
id|cptr-&gt;data.user.fifo
)paren
id|info.input_free
op_assign
id|snd_seq_unused_cells
c_func
(paren
id|cptr-&gt;data.user.fifo-&gt;pool
)paren
suffix:semicolon
)brace
r_else
(brace
id|info.input_pool
op_assign
l_int|0
suffix:semicolon
id|info.input_free
op_assign
l_int|0
suffix:semicolon
)brace
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SET_CLIENT_POOL ioctl() */
DECL|function|snd_seq_ioctl_set_client_pool
r_static
r_int
id|snd_seq_ioctl_set_client_pool
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_client_pool_t
id|info
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;number
op_ne
id|info.client
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* can&squot;t change other clients */
r_if
c_cond
(paren
id|info.output_pool
op_ge
l_int|1
op_logical_and
id|info.output_pool
op_le
id|SNDRV_SEQ_MAX_EVENTS
op_logical_and
(paren
op_logical_neg
id|snd_seq_write_pool_allocated
c_func
(paren
id|client
)paren
op_logical_or
id|info.output_pool
op_ne
id|client-&gt;pool-&gt;size
)paren
)paren
(brace
r_if
c_cond
(paren
id|snd_seq_write_pool_allocated
c_func
(paren
id|client
)paren
)paren
(brace
multiline_comment|/* remove all existing cells */
id|snd_seq_queue_client_leave_cells
c_func
(paren
id|client-&gt;number
)paren
suffix:semicolon
id|snd_seq_pool_done
c_func
(paren
id|client-&gt;pool
)paren
suffix:semicolon
)brace
id|client-&gt;pool-&gt;size
op_assign
id|info.output_pool
suffix:semicolon
id|rc
op_assign
id|snd_seq_pool_init
c_func
(paren
id|client-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|client-&gt;type
op_eq
id|USER_CLIENT
op_logical_and
id|client-&gt;data.user.fifo
op_ne
l_int|NULL
op_logical_and
id|info.input_pool
op_ge
l_int|1
op_logical_and
id|info.input_pool
op_le
id|SNDRV_SEQ_MAX_CLIENT_EVENTS
op_logical_and
id|info.input_pool
op_ne
id|client-&gt;data.user.fifo_pool_size
)paren
(brace
multiline_comment|/* change pool size */
id|rc
op_assign
id|snd_seq_fifo_resize
c_func
(paren
id|client-&gt;data.user.fifo
comma
id|info.input_pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|client-&gt;data.user.fifo_pool_size
op_assign
id|info.input_pool
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info.output_room
op_ge
l_int|1
op_logical_and
id|info.output_room
op_le
id|client-&gt;pool-&gt;size
)paren
(brace
id|client-&gt;pool-&gt;room
op_assign
id|info.output_room
suffix:semicolon
)brace
r_return
id|snd_seq_ioctl_get_client_pool
c_func
(paren
id|client
comma
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/* REMOVE_EVENTS ioctl() */
DECL|function|snd_seq_ioctl_remove_events
r_static
r_int
id|snd_seq_ioctl_remove_events
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|snd_seq_remove_events_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/*&n;&t; * Input mostly not implemented XXX.&n;&t; */
r_if
c_cond
(paren
id|info.remove_mode
op_amp
id|SNDRV_SEQ_REMOVE_INPUT
)paren
(brace
multiline_comment|/*&n;&t;&t; * No restrictions so for a user client we can clear&n;&t;&t; * the whole fifo&n;&t;&t; */
r_if
c_cond
(paren
id|client-&gt;type
op_eq
id|USER_CLIENT
)paren
id|snd_seq_fifo_clear
c_func
(paren
id|client-&gt;data.user.fifo
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info.remove_mode
op_amp
id|SNDRV_SEQ_REMOVE_OUTPUT
)paren
id|snd_seq_queue_remove_cells
c_func
(paren
id|client-&gt;number
comma
op_amp
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * get subscription info&n; */
DECL|function|snd_seq_ioctl_get_subscription
r_static
r_int
id|snd_seq_ioctl_get_subscription
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_int
id|result
suffix:semicolon
id|client_t
op_star
id|sender
op_assign
l_int|NULL
suffix:semicolon
id|client_port_t
op_star
id|sport
op_assign
l_int|NULL
suffix:semicolon
id|snd_seq_port_subscribe_t
id|subs
suffix:semicolon
id|subscribers_t
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|subs
comma
id|arg
comma
r_sizeof
(paren
id|subs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sender
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|subs.sender.client
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sport
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|sender
comma
id|subs.sender.port
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
id|p
op_assign
id|snd_seq_port_get_subscription
c_func
(paren
op_amp
id|sport-&gt;c_src
comma
op_amp
id|subs.dest
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|result
op_assign
l_int|0
suffix:semicolon
id|subs
op_assign
id|p-&gt;info
suffix:semicolon
)brace
r_else
id|result
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|__end
suffix:colon
r_if
c_cond
(paren
id|sport
)paren
id|snd_seq_port_unlock
c_func
(paren
id|sport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sender
)paren
id|snd_seq_client_unlock
c_func
(paren
id|sender
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|subs
comma
r_sizeof
(paren
id|subs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * get subscription info - check only its presence&n; */
DECL|function|snd_seq_ioctl_query_subs
r_static
r_int
id|snd_seq_ioctl_query_subs
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_int
id|result
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|client_t
op_star
id|cptr
op_assign
l_int|NULL
suffix:semicolon
id|client_port_t
op_star
id|port
op_assign
l_int|NULL
suffix:semicolon
id|snd_seq_query_subs_t
id|subs
suffix:semicolon
id|port_subs_info_t
op_star
id|group
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|subs
comma
id|arg
comma
r_sizeof
(paren
id|subs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|subs.root.client
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_if
c_cond
(paren
(paren
id|port
op_assign
id|snd_seq_port_use_ptr
c_func
(paren
id|cptr
comma
id|subs.root.port
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|__end
suffix:semicolon
r_switch
c_cond
(paren
id|subs.type
)paren
(brace
r_case
id|SNDRV_SEQ_QUERY_SUBS_READ
suffix:colon
id|group
op_assign
op_amp
id|port-&gt;c_src
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SEQ_QUERY_SUBS_WRITE
suffix:colon
id|group
op_assign
op_amp
id|port-&gt;c_dest
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|__end
suffix:semicolon
)brace
id|down_read
c_func
(paren
op_amp
id|group-&gt;list_mutex
)paren
suffix:semicolon
multiline_comment|/* search for the subscriber */
id|subs.num_subs
op_assign
id|group-&gt;count
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|group-&gt;list_head
)paren
(brace
r_if
c_cond
(paren
id|i
op_increment
op_eq
id|subs.index
)paren
(brace
multiline_comment|/* found! */
id|subscribers_t
op_star
id|s
suffix:semicolon
r_if
c_cond
(paren
id|subs.type
op_eq
id|SNDRV_SEQ_QUERY_SUBS_READ
)paren
(brace
id|s
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|subscribers_t
comma
id|src_list
)paren
suffix:semicolon
id|subs.addr
op_assign
id|s-&gt;info.dest
suffix:semicolon
)brace
r_else
(brace
id|s
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|subscribers_t
comma
id|dest_list
)paren
suffix:semicolon
id|subs.addr
op_assign
id|s-&gt;info.sender
suffix:semicolon
)brace
id|subs.flags
op_assign
id|s-&gt;info.flags
suffix:semicolon
id|subs.queue
op_assign
id|s-&gt;info.queue
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|up_read
c_func
(paren
op_amp
id|group-&gt;list_mutex
)paren
suffix:semicolon
id|__end
suffix:colon
r_if
c_cond
(paren
id|port
)paren
id|snd_seq_port_unlock
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
)paren
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|subs
comma
r_sizeof
(paren
id|subs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * query next client&n; */
DECL|function|snd_seq_ioctl_query_next_client
r_static
r_int
id|snd_seq_ioctl_query_next_client
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|client_t
op_star
id|cptr
op_assign
l_int|NULL
suffix:semicolon
id|snd_seq_client_info_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* search for next client */
id|info.client
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info.client
OL
l_int|0
)paren
id|info.client
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|info.client
OL
id|SNDRV_SEQ_MAX_CLIENTS
suffix:semicolon
id|info.client
op_increment
)paren
(brace
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|info.client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
)paren
r_break
suffix:semicolon
multiline_comment|/* found */
)brace
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|get_client_info
c_func
(paren
id|cptr
comma
op_amp
id|info
)paren
suffix:semicolon
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * query next port&n; */
DECL|function|snd_seq_ioctl_query_next_port
r_static
r_int
id|snd_seq_ioctl_query_next_port
c_func
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|client_t
op_star
id|cptr
suffix:semicolon
id|client_port_t
op_star
id|port
op_assign
l_int|NULL
suffix:semicolon
id|snd_seq_port_info_t
id|info
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|info.addr.client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* search for next port */
id|info.addr.port
op_increment
suffix:semicolon
id|port
op_assign
id|snd_seq_port_query_nearest
c_func
(paren
id|cptr
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
l_int|NULL
)paren
(brace
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
multiline_comment|/* get port info */
id|info.addr
op_assign
id|port-&gt;addr
suffix:semicolon
id|snd_seq_get_port_info
c_func
(paren
id|port
comma
op_amp
id|info
)paren
suffix:semicolon
id|snd_seq_port_unlock
c_func
(paren
id|port
)paren
suffix:semicolon
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------- */
DECL|struct|seq_ioctl_table
r_static
r_struct
id|seq_ioctl_table
(brace
DECL|member|cmd
r_int
r_int
id|cmd
suffix:semicolon
DECL|member|func
r_int
(paren
op_star
id|func
)paren
(paren
id|client_t
op_star
id|client
comma
r_void
id|__user
op_star
id|arg
)paren
suffix:semicolon
DECL|variable|ioctl_tables
)brace
id|ioctl_tables
(braket
)braket
op_assign
(brace
(brace
id|SNDRV_SEQ_IOCTL_SYSTEM_INFO
comma
id|snd_seq_ioctl_system_info
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_RUNNING_MODE
comma
id|snd_seq_ioctl_running_mode
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_CLIENT_INFO
comma
id|snd_seq_ioctl_get_client_info
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_SET_CLIENT_INFO
comma
id|snd_seq_ioctl_set_client_info
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_CREATE_PORT
comma
id|snd_seq_ioctl_create_port
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_DELETE_PORT
comma
id|snd_seq_ioctl_delete_port
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_PORT_INFO
comma
id|snd_seq_ioctl_get_port_info
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_SET_PORT_INFO
comma
id|snd_seq_ioctl_set_port_info
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_SUBSCRIBE_PORT
comma
id|snd_seq_ioctl_subscribe_port
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_UNSUBSCRIBE_PORT
comma
id|snd_seq_ioctl_unsubscribe_port
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_CREATE_QUEUE
comma
id|snd_seq_ioctl_create_queue
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_DELETE_QUEUE
comma
id|snd_seq_ioctl_delete_queue
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_QUEUE_INFO
comma
id|snd_seq_ioctl_get_queue_info
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_SET_QUEUE_INFO
comma
id|snd_seq_ioctl_set_queue_info
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_NAMED_QUEUE
comma
id|snd_seq_ioctl_get_named_queue
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_QUEUE_STATUS
comma
id|snd_seq_ioctl_get_queue_status
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_QUEUE_TEMPO
comma
id|snd_seq_ioctl_get_queue_tempo
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_SET_QUEUE_TEMPO
comma
id|snd_seq_ioctl_set_queue_tempo
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_QUEUE_TIMER
comma
id|snd_seq_ioctl_get_queue_timer
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_SET_QUEUE_TIMER
comma
id|snd_seq_ioctl_set_queue_timer
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_QUEUE_CLIENT
comma
id|snd_seq_ioctl_get_queue_client
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_SET_QUEUE_CLIENT
comma
id|snd_seq_ioctl_set_queue_client
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_CLIENT_POOL
comma
id|snd_seq_ioctl_get_client_pool
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_SET_CLIENT_POOL
comma
id|snd_seq_ioctl_set_client_pool
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_GET_SUBSCRIPTION
comma
id|snd_seq_ioctl_get_subscription
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_QUERY_NEXT_CLIENT
comma
id|snd_seq_ioctl_query_next_client
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_QUERY_NEXT_PORT
comma
id|snd_seq_ioctl_query_next_port
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_REMOVE_EVENTS
comma
id|snd_seq_ioctl_remove_events
)brace
comma
(brace
id|SNDRV_SEQ_IOCTL_QUERY_SUBS
comma
id|snd_seq_ioctl_query_subs
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
comma
)brace
suffix:semicolon
DECL|function|snd_seq_do_ioctl
r_static
r_int
id|snd_seq_do_ioctl
c_func
(paren
id|client_t
op_star
id|client
comma
r_int
r_int
id|cmd
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|seq_ioctl_table
op_star
id|p
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_SEQ_IOCTL_PVERSION
suffix:colon
multiline_comment|/* return sequencer version number */
r_return
id|put_user
c_func
(paren
id|SNDRV_SEQ_VERSION
comma
(paren
r_int
id|__user
op_star
)paren
id|arg
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDRV_SEQ_IOCTL_CLIENT_ID
suffix:colon
multiline_comment|/* return the id of this client */
r_return
id|put_user
c_func
(paren
id|client-&gt;number
comma
(paren
r_int
id|__user
op_star
)paren
id|arg
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|ioctl_tables
suffix:semicolon
id|p-&gt;cmd
suffix:semicolon
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;cmd
op_eq
id|cmd
)paren
r_return
id|p
op_member_access_from_pointer
id|func
c_func
(paren
id|client
comma
id|arg
)paren
suffix:semicolon
)brace
id|snd_printd
c_func
(paren
l_string|&quot;seq unknown ioctl() 0x%x (type=&squot;%c&squot;, number=0x%2x)&bslash;n&quot;
comma
id|cmd
comma
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
comma
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
DECL|function|snd_seq_ioctl
r_static
r_int
id|snd_seq_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|client_t
op_star
id|client
op_assign
(paren
id|client_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
id|err
suffix:semicolon
id|snd_assert
c_func
(paren
id|client
op_ne
l_int|NULL
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
multiline_comment|/* FIXME: need to unlock BKL to allow preemption */
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|snd_seq_do_ioctl
c_func
(paren
id|client
comma
id|cmd
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* -------------------------------------------------------- */
multiline_comment|/* exported to kernel modules */
DECL|function|snd_seq_create_kernel_client
r_int
id|snd_seq_create_kernel_client
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_int
id|client_index
comma
id|snd_seq_client_callback_t
op_star
id|callback
)paren
(brace
id|client_t
op_star
id|client
suffix:semicolon
id|snd_assert
c_func
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
comma
r_return
op_minus
id|EBUSY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|callback
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|card
op_logical_and
id|client_index
OG
l_int|7
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
op_logical_and
id|client_index
OG
l_int|63
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|card
)paren
id|client_index
op_add_assign
l_int|64
op_plus
(paren
id|card-&gt;number
op_lshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|register_mutex
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
multiline_comment|/* empty write queue as default */
id|client
op_assign
id|seq_create_client1
c_func
(paren
id|client_index
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
)paren
(brace
id|up
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* failure code */
)brace
id|usage_alloc
c_func
(paren
op_amp
id|client_usage
comma
l_int|1
)paren
suffix:semicolon
id|client-&gt;accept_input
op_assign
id|callback-&gt;allow_output
suffix:semicolon
id|client-&gt;accept_output
op_assign
id|callback-&gt;allow_input
suffix:semicolon
multiline_comment|/* fill client data */
id|client-&gt;data.kernel.card
op_assign
id|card
suffix:semicolon
id|client-&gt;data.kernel.private_data
op_assign
id|callback-&gt;private_data
suffix:semicolon
id|sprintf
c_func
(paren
id|client-&gt;name
comma
l_string|&quot;Client-%d&quot;
comma
id|client-&gt;number
)paren
suffix:semicolon
id|client-&gt;type
op_assign
id|KERNEL_CLIENT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
multiline_comment|/* make others aware this new client */
id|snd_seq_system_client_ev_client_start
c_func
(paren
id|client-&gt;number
)paren
suffix:semicolon
multiline_comment|/* return client number to caller */
r_return
id|client-&gt;number
suffix:semicolon
)brace
multiline_comment|/* exported to kernel modules */
DECL|function|snd_seq_delete_kernel_client
r_int
id|snd_seq_delete_kernel_client
c_func
(paren
r_int
id|client
)paren
(brace
id|client_t
op_star
id|ptr
suffix:semicolon
id|snd_assert
c_func
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
comma
r_return
op_minus
id|EBUSY
)paren
suffix:semicolon
id|ptr
op_assign
id|clientptr
c_func
(paren
id|client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|seq_free_client
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* skeleton to enqueue event, called from snd_seq_kernel_client_enqueue&n; * and snd_seq_kernel_client_enqueue_blocking&n; */
DECL|function|kernel_client_enqueue
r_static
r_int
id|kernel_client_enqueue
c_func
(paren
r_int
id|client
comma
id|snd_seq_event_t
op_star
id|ev
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|blocking
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|client_t
op_star
id|cptr
suffix:semicolon
r_int
id|result
suffix:semicolon
id|snd_assert
c_func
(paren
id|ev
op_ne
l_int|NULL
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev-&gt;type
op_eq
id|SNDRV_SEQ_EVENT_NONE
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ignore this */
r_if
c_cond
(paren
id|ev-&gt;type
op_eq
id|SNDRV_SEQ_EVENT_KERNEL_ERROR
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* quoted events can&squot;t be enqueued */
multiline_comment|/* fill in client number */
id|ev-&gt;source.client
op_assign
id|client
suffix:semicolon
r_if
c_cond
(paren
id|check_event_type_and_length
c_func
(paren
id|ev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cptr-&gt;accept_output
)paren
id|result
op_assign
op_minus
id|EPERM
suffix:semicolon
r_else
multiline_comment|/* send it */
id|result
op_assign
id|snd_seq_client_enqueue_event
c_func
(paren
id|cptr
comma
id|ev
comma
id|file
comma
id|blocking
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * exported, called by kernel clients to enqueue events (w/o blocking)&n; *&n; * RETURN VALUE: zero if succeed, negative if error&n; */
DECL|function|snd_seq_kernel_client_enqueue
r_int
id|snd_seq_kernel_client_enqueue
c_func
(paren
r_int
id|client
comma
id|snd_seq_event_t
op_star
id|ev
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
r_return
id|kernel_client_enqueue
c_func
(paren
id|client
comma
id|ev
comma
l_int|NULL
comma
l_int|0
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * exported, called by kernel clients to enqueue events (with blocking)&n; *&n; * RETURN VALUE: zero if succeed, negative if error&n; */
DECL|function|snd_seq_kernel_client_enqueue_blocking
r_int
id|snd_seq_kernel_client_enqueue_blocking
c_func
(paren
r_int
id|client
comma
id|snd_seq_event_t
op_star
id|ev
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
r_return
id|kernel_client_enqueue
c_func
(paren
id|client
comma
id|ev
comma
id|file
comma
l_int|1
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * exported, called by kernel clients to dispatch events directly to other&n; * clients, bypassing the queues.  Event time-stamp will be updated.&n; *&n; * RETURN VALUE: negative = delivery failed,&n; *&t;&t; zero, or positive: the number of delivered events&n; */
DECL|function|snd_seq_kernel_client_dispatch
r_int
id|snd_seq_kernel_client_dispatch
c_func
(paren
r_int
id|client
comma
id|snd_seq_event_t
op_star
id|ev
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|client_t
op_star
id|cptr
suffix:semicolon
r_int
id|result
suffix:semicolon
id|snd_assert
c_func
(paren
id|ev
op_ne
l_int|NULL
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* fill in client number */
id|ev-&gt;queue
op_assign
id|SNDRV_SEQ_QUEUE_DIRECT
suffix:semicolon
id|ev-&gt;source.client
op_assign
id|client
suffix:semicolon
r_if
c_cond
(paren
id|check_event_type_and_length
c_func
(paren
id|ev
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|cptr
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cptr
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cptr-&gt;accept_output
)paren
id|result
op_assign
op_minus
id|EPERM
suffix:semicolon
r_else
id|result
op_assign
id|snd_seq_deliver_event
c_func
(paren
id|cptr
comma
id|ev
comma
id|atomic
comma
id|hop
)paren
suffix:semicolon
id|snd_seq_client_unlock
c_func
(paren
id|cptr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * exported, called by kernel clients to perform same functions as with&n; * userland ioctl() &n; */
DECL|function|snd_seq_kernel_client_ctl
r_int
id|snd_seq_kernel_client_ctl
c_func
(paren
r_int
id|clientid
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
id|client_t
op_star
id|client
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
r_int
id|result
suffix:semicolon
id|client
op_assign
id|clientptr
c_func
(paren
id|clientid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|fs
op_assign
id|snd_enter_user
c_func
(paren
)paren
suffix:semicolon
id|result
op_assign
id|snd_seq_do_ioctl
c_func
(paren
id|client
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|snd_leave_user
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* exported (for OSS emulator) */
DECL|function|snd_seq_kernel_client_write_poll
r_int
id|snd_seq_kernel_client_write_poll
c_func
(paren
r_int
id|clientid
comma
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
id|client_t
op_star
id|client
suffix:semicolon
id|client
op_assign
id|clientptr
c_func
(paren
id|clientid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|snd_seq_write_pool_allocated
c_func
(paren
id|client
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|snd_seq_pool_poll_wait
c_func
(paren
id|client-&gt;pool
comma
id|file
comma
id|wait
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*---------------------------------------------------------------------------*/
multiline_comment|/*&n; *  /proc interface&n; */
DECL|function|snd_seq_info_dump_subscribers
r_static
r_void
id|snd_seq_info_dump_subscribers
c_func
(paren
id|snd_info_buffer_t
op_star
id|buffer
comma
id|port_subs_info_t
op_star
id|group
comma
r_int
id|is_src
comma
r_char
op_star
id|msg
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|subscribers_t
op_star
id|s
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|group-&gt;list_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|group-&gt;list_head
)paren
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|group-&gt;list_mutex
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|snd_iprintf
c_func
(paren
id|buffer
comma
id|msg
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|group-&gt;list_head
)paren
(brace
r_if
c_cond
(paren
id|is_src
)paren
id|s
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|subscribers_t
comma
id|src_list
)paren
suffix:semicolon
r_else
id|s
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|subscribers_t
comma
id|dest_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_increment
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;, &quot;
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%d:%d&quot;
comma
id|is_src
ques
c_cond
id|s-&gt;info.dest.client
suffix:colon
id|s-&gt;info.sender.client
comma
id|is_src
ques
c_cond
id|s-&gt;info.dest.port
suffix:colon
id|s-&gt;info.sender.port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;info.flags
op_amp
id|SNDRV_SEQ_PORT_SUBS_TIMESTAMP
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;[%c:%d]&quot;
comma
(paren
(paren
id|s-&gt;info.flags
op_amp
id|SNDRV_SEQ_PORT_SUBS_TIME_REAL
)paren
ques
c_cond
l_char|&squot;r&squot;
suffix:colon
l_char|&squot;t&squot;
)paren
comma
id|s-&gt;info.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|group-&gt;exclusive
)paren
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;[ex]&quot;
)paren
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|group-&gt;list_mutex
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|macro|FLAG_PERM_RD
mdefine_line|#define FLAG_PERM_RD(perm) ((perm) &amp; SNDRV_SEQ_PORT_CAP_READ ? ((perm) &amp; SNDRV_SEQ_PORT_CAP_SUBS_READ ? &squot;R&squot; : &squot;r&squot;) : &squot;-&squot;)
DECL|macro|FLAG_PERM_WR
mdefine_line|#define FLAG_PERM_WR(perm) ((perm) &amp; SNDRV_SEQ_PORT_CAP_WRITE ? ((perm) &amp; SNDRV_SEQ_PORT_CAP_SUBS_WRITE ? &squot;W&squot; : &squot;w&squot;) : &squot;-&squot;)
DECL|macro|FLAG_PERM_EX
mdefine_line|#define FLAG_PERM_EX(perm) ((perm) &amp; SNDRV_SEQ_PORT_CAP_NO_EXPORT ? &squot;-&squot; : &squot;e&squot;)
DECL|macro|FLAG_PERM_DUPLEX
mdefine_line|#define FLAG_PERM_DUPLEX(perm) ((perm) &amp; SNDRV_SEQ_PORT_CAP_DUPLEX ? &squot;X&squot; : &squot;-&squot;)
DECL|function|snd_seq_info_dump_ports
r_static
r_void
id|snd_seq_info_dump_ports
c_func
(paren
id|snd_info_buffer_t
op_star
id|buffer
comma
id|client_t
op_star
id|client
)paren
(brace
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|down
c_func
(paren
op_amp
id|client-&gt;ports_mutex
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|client-&gt;ports_list_head
)paren
(brace
id|client_port_t
op_star
id|p
op_assign
id|list_entry
c_func
(paren
id|l
comma
id|client_port_t
comma
id|list
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;  Port %3d : &bslash;&quot;%s&bslash;&quot; (%c%c%c%c)&bslash;n&quot;
comma
id|p-&gt;addr.port
comma
id|p-&gt;name
comma
id|FLAG_PERM_RD
c_func
(paren
id|p-&gt;capability
)paren
comma
id|FLAG_PERM_WR
c_func
(paren
id|p-&gt;capability
)paren
comma
id|FLAG_PERM_EX
c_func
(paren
id|p-&gt;capability
)paren
comma
id|FLAG_PERM_DUPLEX
c_func
(paren
id|p-&gt;capability
)paren
)paren
suffix:semicolon
id|snd_seq_info_dump_subscribers
c_func
(paren
id|buffer
comma
op_amp
id|p-&gt;c_src
comma
l_int|1
comma
l_string|&quot;    Connecting To: &quot;
)paren
suffix:semicolon
id|snd_seq_info_dump_subscribers
c_func
(paren
id|buffer
comma
op_amp
id|p-&gt;c_dest
comma
l_int|0
comma
l_string|&quot;    Connected From: &quot;
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|client-&gt;ports_mutex
)paren
suffix:semicolon
)brace
multiline_comment|/* exported to seq_info.c */
DECL|function|snd_seq_info_clients_read
r_void
id|snd_seq_info_clients_read
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
id|snd_info_buffer_t
op_star
id|buffer
)paren
(brace
r_extern
r_void
id|snd_seq_info_pool
c_func
(paren
id|snd_info_buffer_t
op_star
id|buffer
comma
id|pool_t
op_star
id|pool
comma
r_char
op_star
id|space
)paren
suffix:semicolon
r_int
id|c
suffix:semicolon
id|client_t
op_star
id|client
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Client info&bslash;n&quot;
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;  cur  clients : %d&bslash;n&quot;
comma
id|client_usage.cur
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;  peak clients : %d&bslash;n&quot;
comma
id|client_usage.peak
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;  max  clients : %d&bslash;n&quot;
comma
id|SNDRV_SEQ_MAX_CLIENTS
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* list the client table */
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
id|SNDRV_SEQ_MAX_CLIENTS
suffix:semicolon
id|c
op_increment
)paren
(brace
id|client
op_assign
id|snd_seq_client_use_ptr
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;type
op_eq
id|NO_CLIENT
)paren
(brace
id|snd_seq_client_unlock
c_func
(paren
id|client
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Client %3d : &bslash;&quot;%s&bslash;&quot; [%s]&bslash;n&quot;
comma
id|c
comma
id|client-&gt;name
comma
id|client-&gt;type
op_eq
id|USER_CLIENT
ques
c_cond
l_string|&quot;User&quot;
suffix:colon
l_string|&quot;Kernel&quot;
)paren
suffix:semicolon
id|snd_seq_info_dump_ports
c_func
(paren
id|buffer
comma
id|client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd_seq_write_pool_allocated
c_func
(paren
id|client
)paren
)paren
(brace
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;  Output pool :&bslash;n&quot;
)paren
suffix:semicolon
id|snd_seq_info_pool
c_func
(paren
id|buffer
comma
id|client-&gt;pool
comma
l_string|&quot;    &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|client-&gt;type
op_eq
id|USER_CLIENT
op_logical_and
id|client-&gt;data.user.fifo
op_logical_and
id|client-&gt;data.user.fifo-&gt;pool
)paren
(brace
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;  Input pool :&bslash;n&quot;
)paren
suffix:semicolon
id|snd_seq_info_pool
c_func
(paren
id|buffer
comma
id|client-&gt;data.user.fifo-&gt;pool
comma
l_string|&quot;    &quot;
)paren
suffix:semicolon
)brace
id|snd_seq_client_unlock
c_func
(paren
id|client
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*---------------------------------------------------------------------------*/
multiline_comment|/*&n; *  REGISTRATION PART&n; */
DECL|variable|snd_seq_f_ops
r_static
r_struct
id|file_operations
id|snd_seq_f_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|snd_seq_read
comma
dot
id|write
op_assign
id|snd_seq_write
comma
dot
id|open
op_assign
id|snd_seq_open
comma
dot
id|release
op_assign
id|snd_seq_release
comma
dot
id|poll
op_assign
id|snd_seq_poll
comma
dot
id|ioctl
op_assign
id|snd_seq_ioctl
comma
)brace
suffix:semicolon
DECL|variable|snd_seq_reg
r_static
id|snd_minor_t
id|snd_seq_reg
op_assign
(brace
dot
id|comment
op_assign
l_string|&quot;sequencer&quot;
comma
dot
id|f_ops
op_assign
op_amp
id|snd_seq_f_ops
comma
)brace
suffix:semicolon
multiline_comment|/* &n; * register sequencer device &n; */
DECL|function|snd_sequencer_device_init
r_int
id|__init
id|snd_sequencer_device_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|register_mutex
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_register_device
c_func
(paren
id|SNDRV_DEVICE_TYPE_SEQUENCER
comma
l_int|NULL
comma
l_int|0
comma
op_amp
id|snd_seq_reg
comma
l_string|&quot;seq&quot;
)paren
)paren
OL
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|register_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * unregister sequencer device &n; */
DECL|function|snd_sequencer_device_done
r_void
id|__exit
id|snd_sequencer_device_done
c_func
(paren
r_void
)paren
(brace
id|snd_unregister_device
c_func
(paren
id|SNDRV_DEVICE_TYPE_SEQUENCER
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
eof
