multiline_comment|/*&n; * OSS compatible sequencer driver&n; *&n; * Copyright (C) 1998,99 Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
macro_line|#include &quot;seq_oss_device.h&quot;
macro_line|#include &quot;seq_oss_synth.h&quot;
macro_line|#include &quot;seq_oss_midi.h&quot;
macro_line|#include &quot;seq_oss_event.h&quot;
macro_line|#include &quot;seq_oss_timer.h&quot;
macro_line|#include &lt;sound/seq_oss_legacy.h&gt;
macro_line|#include &quot;seq_oss_readq.h&quot;
macro_line|#include &quot;seq_oss_writeq.h&quot;
multiline_comment|/*&n; * prototypes&n; */
r_static
r_int
id|extended_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|chn_voice_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|event_rec
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|chn_common_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|event_rec
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|timing_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|event_rec
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|local_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|event_rec
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|old_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|note_on_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
r_int
id|dev
comma
r_int
id|ch
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|note_off_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
r_int
id|dev
comma
r_int
id|ch
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|set_note_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
r_int
id|dev
comma
r_int
id|type
comma
r_int
id|ch
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|set_control_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
r_int
id|dev
comma
r_int
id|type
comma
r_int
id|ch
comma
r_int
id|param
comma
r_int
id|val
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
r_static
r_int
id|set_echo_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|rec
comma
id|snd_seq_event_t
op_star
id|ev
)paren
suffix:semicolon
multiline_comment|/*&n; * convert an OSS event to ALSA event&n; * return 0 : enqueued&n; *        non-zero : invalid - ignored&n; */
r_int
DECL|function|snd_seq_oss_process_event
id|snd_seq_oss_process_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_switch
c_cond
(paren
id|q-&gt;s.code
)paren
(brace
r_case
id|SEQ_EXTENDED
suffix:colon
r_return
id|extended_event
c_func
(paren
id|dp
comma
id|q
comma
id|ev
)paren
suffix:semicolon
r_case
id|EV_CHN_VOICE
suffix:colon
r_return
id|chn_voice_event
c_func
(paren
id|dp
comma
id|q
comma
id|ev
)paren
suffix:semicolon
r_case
id|EV_CHN_COMMON
suffix:colon
r_return
id|chn_common_event
c_func
(paren
id|dp
comma
id|q
comma
id|ev
)paren
suffix:semicolon
r_case
id|EV_TIMING
suffix:colon
r_return
id|timing_event
c_func
(paren
id|dp
comma
id|q
comma
id|ev
)paren
suffix:semicolon
r_case
id|EV_SEQ_LOCAL
suffix:colon
r_return
id|local_event
c_func
(paren
id|dp
comma
id|q
comma
id|ev
)paren
suffix:semicolon
r_case
id|EV_SYSEX
suffix:colon
r_return
id|snd_seq_oss_synth_sysex
c_func
(paren
id|dp
comma
id|q-&gt;x.dev
comma
id|q-&gt;x.buf
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_MIDIPUTC
suffix:colon
r_if
c_cond
(paren
id|dp-&gt;seq_mode
op_eq
id|SNDRV_SEQ_OSS_MODE_MUSIC
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* put a midi byte */
r_if
c_cond
(paren
op_logical_neg
id|is_write_mode
c_func
(paren
id|dp-&gt;file_mode
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|snd_seq_oss_midi_open
c_func
(paren
id|dp
comma
id|q-&gt;s.dev
comma
id|SNDRV_SEQ_OSS_FILE_WRITE
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|snd_seq_oss_midi_filemode
c_func
(paren
id|dp
comma
id|q-&gt;s.dev
)paren
op_amp
id|SNDRV_SEQ_OSS_FILE_WRITE
)paren
r_return
id|snd_seq_oss_midi_putc
c_func
(paren
id|dp
comma
id|q-&gt;s.dev
comma
id|q-&gt;s.parm1
comma
id|ev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEQ_ECHO
suffix:colon
r_if
c_cond
(paren
id|dp-&gt;seq_mode
op_eq
id|SNDRV_SEQ_OSS_MODE_MUSIC
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|set_echo_event
c_func
(paren
id|dp
comma
id|q
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_PRIVATE
suffix:colon
r_if
c_cond
(paren
id|dp-&gt;seq_mode
op_eq
id|SNDRV_SEQ_OSS_MODE_MUSIC
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|snd_seq_oss_synth_raw_event
c_func
(paren
id|dp
comma
id|q-&gt;c
(braket
l_int|1
)braket
comma
id|q-&gt;c
comma
id|ev
)paren
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|dp-&gt;seq_mode
op_eq
id|SNDRV_SEQ_OSS_MODE_MUSIC
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|old_event
c_func
(paren
id|dp
comma
id|q
comma
id|ev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* old type events: mode1 only */
r_static
r_int
DECL|function|old_event
id|old_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_switch
c_cond
(paren
id|q-&gt;s.code
)paren
(brace
r_case
id|SEQ_NOTEOFF
suffix:colon
r_return
id|note_off_event
c_func
(paren
id|dp
comma
l_int|0
comma
id|q-&gt;n.chn
comma
id|q-&gt;n.note
comma
id|q-&gt;n.vel
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_NOTEON
suffix:colon
r_return
id|note_on_event
c_func
(paren
id|dp
comma
l_int|0
comma
id|q-&gt;n.chn
comma
id|q-&gt;n.note
comma
id|q-&gt;n.vel
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_WAIT
suffix:colon
multiline_comment|/* skip */
r_break
suffix:semicolon
r_case
id|SEQ_PGMCHANGE
suffix:colon
r_return
id|set_control_event
c_func
(paren
id|dp
comma
l_int|0
comma
id|SNDRV_SEQ_EVENT_PGMCHANGE
comma
id|q-&gt;n.chn
comma
l_int|0
comma
id|q-&gt;n.note
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_SYNCTIMER
suffix:colon
r_return
id|snd_seq_oss_timer_reset
c_func
(paren
id|dp-&gt;timer
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* 8bytes extended event: mode1 only */
r_static
r_int
DECL|function|extended_event
id|extended_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_int
id|val
suffix:semicolon
r_switch
c_cond
(paren
id|q-&gt;e.cmd
)paren
(brace
r_case
id|SEQ_NOTEOFF
suffix:colon
r_return
id|note_off_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|q-&gt;e.chn
comma
id|q-&gt;e.p1
comma
id|q-&gt;e.p2
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_NOTEON
suffix:colon
r_return
id|note_on_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|q-&gt;e.chn
comma
id|q-&gt;e.p1
comma
id|q-&gt;e.p2
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_PGMCHANGE
suffix:colon
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|SNDRV_SEQ_EVENT_PGMCHANGE
comma
id|q-&gt;e.chn
comma
l_int|0
comma
id|q-&gt;e.p1
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_AFTERTOUCH
suffix:colon
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|SNDRV_SEQ_EVENT_CHANPRESS
comma
id|q-&gt;e.chn
comma
l_int|0
comma
id|q-&gt;e.p1
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_BALANCE
suffix:colon
multiline_comment|/* convert -128:127 to 0:127 */
id|val
op_assign
(paren
r_char
)paren
id|q-&gt;e.p1
suffix:semicolon
id|val
op_assign
(paren
id|val
op_plus
l_int|128
)paren
op_div
l_int|2
suffix:semicolon
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|SNDRV_SEQ_EVENT_CONTROLLER
comma
id|q-&gt;e.chn
comma
id|CTL_PAN
comma
id|val
comma
id|ev
)paren
suffix:semicolon
r_case
id|SEQ_CONTROLLER
suffix:colon
id|val
op_assign
(paren
(paren
r_int
)paren
id|q-&gt;e.p3
op_lshift
l_int|8
)paren
op_or
(paren
r_int
)paren
id|q-&gt;e.p2
suffix:semicolon
r_switch
c_cond
(paren
id|q-&gt;e.p1
)paren
(brace
r_case
id|CTRL_PITCH_BENDER
suffix:colon
multiline_comment|/* SEQ1 V2 control */
multiline_comment|/* -0x2000:0x1fff */
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|SNDRV_SEQ_EVENT_PITCHBEND
comma
id|q-&gt;e.chn
comma
l_int|0
comma
id|val
comma
id|ev
)paren
suffix:semicolon
r_case
id|CTRL_PITCH_BENDER_RANGE
suffix:colon
multiline_comment|/* conversion: 100/semitone -&gt; 128/semitone */
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|SNDRV_SEQ_EVENT_REGPARAM
comma
id|q-&gt;e.chn
comma
l_int|0
comma
id|val
op_star
l_int|128
op_div
l_int|100
comma
id|ev
)paren
suffix:semicolon
r_default
suffix:colon
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|SNDRV_SEQ_EVENT_CONTROL14
comma
id|q-&gt;e.chn
comma
id|q-&gt;e.p1
comma
id|val
comma
id|ev
)paren
suffix:semicolon
)brace
r_case
id|SEQ_VOLMODE
suffix:colon
r_return
id|snd_seq_oss_synth_raw_event
c_func
(paren
id|dp
comma
id|q-&gt;e.dev
comma
id|q-&gt;c
comma
id|ev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* channel voice events: mode1 and 2 */
r_static
r_int
DECL|function|chn_voice_event
id|chn_voice_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_if
c_cond
(paren
id|q-&gt;v.chn
op_ge
l_int|32
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|q-&gt;v.cmd
)paren
(brace
r_case
id|MIDI_NOTEON
suffix:colon
r_return
id|note_on_event
c_func
(paren
id|dp
comma
id|q-&gt;v.dev
comma
id|q-&gt;v.chn
comma
id|q-&gt;v.note
comma
id|q-&gt;v.parm
comma
id|ev
)paren
suffix:semicolon
r_case
id|MIDI_NOTEOFF
suffix:colon
r_return
id|note_off_event
c_func
(paren
id|dp
comma
id|q-&gt;v.dev
comma
id|q-&gt;v.chn
comma
id|q-&gt;v.note
comma
id|q-&gt;v.parm
comma
id|ev
)paren
suffix:semicolon
r_case
id|MIDI_KEY_PRESSURE
suffix:colon
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|q-&gt;v.dev
comma
id|SNDRV_SEQ_EVENT_KEYPRESS
comma
id|q-&gt;v.chn
comma
id|q-&gt;v.note
comma
id|q-&gt;v.parm
comma
id|ev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* channel common events: mode1 and 2 */
r_static
r_int
DECL|function|chn_common_event
id|chn_common_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_if
c_cond
(paren
id|q-&gt;l.chn
op_ge
l_int|32
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|q-&gt;l.cmd
)paren
(brace
r_case
id|MIDI_PGM_CHANGE
suffix:colon
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;l.dev
comma
id|SNDRV_SEQ_EVENT_PGMCHANGE
comma
id|q-&gt;l.chn
comma
l_int|0
comma
id|q-&gt;l.p1
comma
id|ev
)paren
suffix:semicolon
r_case
id|MIDI_CTL_CHANGE
suffix:colon
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;l.dev
comma
id|SNDRV_SEQ_EVENT_CONTROLLER
comma
id|q-&gt;l.chn
comma
id|q-&gt;l.p1
comma
id|q-&gt;l.val
comma
id|ev
)paren
suffix:semicolon
r_case
id|MIDI_PITCH_BEND
suffix:colon
multiline_comment|/* conversion: 0:0x3fff -&gt; -0x2000:0x1fff */
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;l.dev
comma
id|SNDRV_SEQ_EVENT_PITCHBEND
comma
id|q-&gt;l.chn
comma
l_int|0
comma
id|q-&gt;l.val
op_minus
l_int|8192
comma
id|ev
)paren
suffix:semicolon
r_case
id|MIDI_CHN_PRESSURE
suffix:colon
r_return
id|set_control_event
c_func
(paren
id|dp
comma
id|q-&gt;l.dev
comma
id|SNDRV_SEQ_EVENT_CHANPRESS
comma
id|q-&gt;l.chn
comma
l_int|0
comma
id|q-&gt;l.val
comma
id|ev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* timer events: mode1 and mode2 */
r_static
r_int
DECL|function|timing_event
id|timing_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_switch
c_cond
(paren
id|q-&gt;t.cmd
)paren
(brace
r_case
id|TMR_ECHO
suffix:colon
r_if
c_cond
(paren
id|dp-&gt;seq_mode
op_eq
id|SNDRV_SEQ_OSS_MODE_MUSIC
)paren
r_return
id|set_echo_event
c_func
(paren
id|dp
comma
id|q
comma
id|ev
)paren
suffix:semicolon
r_else
(brace
id|evrec_t
id|tmp
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp
comma
l_int|0
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
multiline_comment|/* XXX: only for little-endian! */
id|tmp.echo
op_assign
(paren
id|q-&gt;t.time
op_lshift
l_int|8
)paren
op_or
id|SEQ_ECHO
suffix:semicolon
r_return
id|set_echo_event
c_func
(paren
id|dp
comma
op_amp
id|tmp
comma
id|ev
)paren
suffix:semicolon
)brace
r_case
id|TMR_STOP
suffix:colon
r_if
c_cond
(paren
id|dp-&gt;seq_mode
)paren
r_return
id|snd_seq_oss_timer_stop
c_func
(paren
id|dp-&gt;timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TMR_CONTINUE
suffix:colon
r_if
c_cond
(paren
id|dp-&gt;seq_mode
)paren
r_return
id|snd_seq_oss_timer_continue
c_func
(paren
id|dp-&gt;timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|TMR_TEMPO
suffix:colon
r_if
c_cond
(paren
id|dp-&gt;seq_mode
)paren
r_return
id|snd_seq_oss_timer_tempo
c_func
(paren
id|dp-&gt;timer
comma
id|q-&gt;t.time
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* local events: mode1 and 2 */
r_static
r_int
DECL|function|local_event
id|local_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|q
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * process note-on event for OSS synth&n; * three different modes are available:&n; * - SNDRV_SEQ_OSS_PROCESS_EVENTS  (for one-voice per channel mode)&n; *&t;Accept note 255 as volume change.&n; * - SNDRV_SEQ_OSS_PASS_EVENTS&n; *&t;Pass all events to lowlevel driver anyway&n; * - SNDRV_SEQ_OSS_PROCESS_KEYPRESS  (mostly for Emu8000)&n; *&t;Use key-pressure if note &gt;= 128&n; */
r_static
r_int
DECL|function|note_on_event
id|note_on_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
r_int
id|dev
comma
r_int
id|ch
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
id|seq_oss_synthinfo_t
op_star
id|info
op_assign
op_amp
id|dp-&gt;synths
(braket
id|dev
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;arg.event_passing
)paren
(brace
r_case
id|SNDRV_SEQ_OSS_PROCESS_EVENTS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;ch
op_logical_or
id|ch
OL
l_int|0
op_logical_or
id|ch
op_ge
id|info-&gt;nr_voices
)paren
(brace
multiline_comment|/* pass directly */
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_NOTEON
comma
id|ch
comma
id|note
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|note
op_eq
l_int|255
op_logical_and
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
op_ge
l_int|0
)paren
(brace
multiline_comment|/* volume control */
r_int
id|type
suffix:semicolon
singleline_comment|//if (! vel)
multiline_comment|/* set volume to zero -- note off */
singleline_comment|//&t;type = SNDRV_SEQ_EVENT_NOTEOFF;
singleline_comment|//else
r_if
c_cond
(paren
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|vel
)paren
multiline_comment|/* sample already started -- volume change */
id|type
op_assign
id|SNDRV_SEQ_EVENT_KEYPRESS
suffix:semicolon
r_else
multiline_comment|/* sample not started -- start now */
id|type
op_assign
id|SNDRV_SEQ_EVENT_NOTEON
suffix:semicolon
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|vel
op_assign
id|vel
suffix:semicolon
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|type
comma
id|ch
comma
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|note
op_ge
l_int|128
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* invalid */
r_if
c_cond
(paren
id|note
op_ne
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
op_logical_and
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
op_ge
l_int|0
)paren
multiline_comment|/* note changed - note off at beginning */
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_NOTEOFF
comma
id|ch
comma
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
comma
l_int|0
comma
id|ev
)paren
suffix:semicolon
multiline_comment|/* set current status */
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
op_assign
id|note
suffix:semicolon
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|vel
op_assign
id|vel
suffix:semicolon
r_if
c_cond
(paren
id|vel
)paren
multiline_comment|/* non-zero velocity - start the note now */
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_NOTEON
comma
id|ch
comma
id|note
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|SNDRV_SEQ_OSS_PASS_EVENTS
suffix:colon
multiline_comment|/* pass the event anyway */
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_NOTEON
comma
id|ch
comma
id|note
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
r_case
id|SNDRV_SEQ_OSS_PROCESS_KEYPRESS
suffix:colon
r_if
c_cond
(paren
id|note
op_ge
l_int|128
)paren
multiline_comment|/* key pressure: shifted by 128 */
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_KEYPRESS
comma
id|ch
comma
id|note
op_minus
l_int|128
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
r_else
multiline_comment|/* normal note-on event */
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_NOTEON
comma
id|ch
comma
id|note
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * process note-off event for OSS synth&n; */
r_static
r_int
DECL|function|note_off_event
id|note_off_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
r_int
id|dev
comma
r_int
id|ch
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
id|seq_oss_synthinfo_t
op_star
id|info
op_assign
op_amp
id|dp-&gt;synths
(braket
id|dev
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;arg.event_passing
)paren
(brace
r_case
id|SNDRV_SEQ_OSS_PROCESS_EVENTS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;ch
op_logical_or
id|ch
OL
l_int|0
op_logical_or
id|ch
op_ge
id|info-&gt;nr_voices
)paren
(brace
multiline_comment|/* pass directly */
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_NOTEON
comma
id|ch
comma
id|note
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
op_ge
l_int|0
)paren
(brace
id|note
op_assign
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
suffix:semicolon
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|vel
op_assign
l_int|0
suffix:semicolon
id|info-&gt;ch
(braket
id|ch
)braket
dot
id|note
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_NOTEOFF
comma
id|ch
comma
id|note
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* invalid */
r_case
id|SNDRV_SEQ_OSS_PASS_EVENTS
suffix:colon
r_case
id|SNDRV_SEQ_OSS_PROCESS_KEYPRESS
suffix:colon
multiline_comment|/* pass the event anyway */
r_return
id|set_note_event
c_func
(paren
id|dp
comma
id|dev
comma
id|SNDRV_SEQ_EVENT_NOTEOFF
comma
id|ch
comma
id|note
comma
id|vel
comma
id|ev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * create a note event&n; */
r_static
r_int
DECL|function|set_note_event
id|set_note_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
r_int
id|dev
comma
r_int
id|type
comma
r_int
id|ch
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|snd_seq_oss_synth_is_valid
c_func
(paren
id|dp
comma
id|dev
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|ev-&gt;type
op_assign
id|type
suffix:semicolon
id|snd_seq_oss_synth_addr
c_func
(paren
id|dp
comma
id|dev
comma
id|ev
)paren
suffix:semicolon
id|ev-&gt;data.note.channel
op_assign
id|ch
suffix:semicolon
id|ev-&gt;data.note.note
op_assign
id|note
suffix:semicolon
id|ev-&gt;data.note.velocity
op_assign
id|vel
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * create a control event&n; */
r_static
r_int
DECL|function|set_control_event
id|set_control_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
r_int
id|dev
comma
r_int
id|type
comma
r_int
id|ch
comma
r_int
id|param
comma
r_int
id|val
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|snd_seq_oss_synth_is_valid
c_func
(paren
id|dp
comma
id|dev
)paren
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|ev-&gt;type
op_assign
id|type
suffix:semicolon
id|snd_seq_oss_synth_addr
c_func
(paren
id|dp
comma
id|dev
comma
id|ev
)paren
suffix:semicolon
id|ev-&gt;data.control.channel
op_assign
id|ch
suffix:semicolon
id|ev-&gt;data.control.param
op_assign
id|param
suffix:semicolon
id|ev-&gt;data.control.value
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * create an echo event&n; */
r_static
r_int
DECL|function|set_echo_event
id|set_echo_event
c_func
(paren
id|seq_oss_devinfo_t
op_star
id|dp
comma
id|evrec_t
op_star
id|rec
comma
id|snd_seq_event_t
op_star
id|ev
)paren
(brace
id|ev-&gt;type
op_assign
id|SNDRV_SEQ_EVENT_ECHO
suffix:semicolon
multiline_comment|/* echo back to itself */
id|snd_seq_oss_fill_addr
c_func
(paren
id|dp
comma
id|ev
comma
id|dp-&gt;addr.client
comma
id|dp-&gt;addr.port
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ev-&gt;data
comma
id|rec
comma
id|LONG_EVENT_SIZE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * event input callback from ALSA sequencer:&n; * the echo event is processed here.&n; */
r_int
DECL|function|snd_seq_oss_event_input
id|snd_seq_oss_event_input
c_func
(paren
id|snd_seq_event_t
op_star
id|ev
comma
r_int
id|direct
comma
r_void
op_star
id|private_data
comma
r_int
id|atomic
comma
r_int
id|hop
)paren
(brace
id|seq_oss_devinfo_t
op_star
id|dp
op_assign
(paren
id|seq_oss_devinfo_t
op_star
)paren
id|private_data
suffix:semicolon
id|evrec_t
op_star
id|rec
suffix:semicolon
r_if
c_cond
(paren
id|ev-&gt;type
op_ne
id|SNDRV_SEQ_EVENT_ECHO
)paren
r_return
id|snd_seq_oss_midi_input
c_func
(paren
id|ev
comma
id|direct
comma
id|private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev-&gt;source.client
op_ne
id|dp-&gt;cseq
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ignored */
id|rec
op_assign
(paren
id|evrec_t
op_star
)paren
op_amp
id|ev-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|rec-&gt;s.code
op_eq
id|SEQ_SYNCTIMER
)paren
(brace
multiline_comment|/* sync echo back */
id|snd_seq_oss_writeq_wakeup
c_func
(paren
id|dp-&gt;writeq
comma
id|rec-&gt;t.time
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* echo back event */
r_if
c_cond
(paren
id|dp-&gt;readq
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|snd_seq_oss_readq_put_event
c_func
(paren
id|dp-&gt;readq
comma
id|rec
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
