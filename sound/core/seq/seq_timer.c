multiline_comment|/*&n; *   ALSA sequencer Timer&n; *   Copyright (c) 1998-1999 by Frank van de Pol &lt;fvdpol@home.nl&gt;&n; *                              Jaroslav Kysela &lt;perex@suse.cz&gt;&n; *&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &quot;seq_timer.h&quot;
macro_line|#include &quot;seq_queue.h&quot;
macro_line|#include &quot;seq_info.h&quot;
r_extern
r_int
id|seq_default_timer_class
suffix:semicolon
r_extern
r_int
id|seq_default_timer_sclass
suffix:semicolon
r_extern
r_int
id|seq_default_timer_card
suffix:semicolon
r_extern
r_int
id|seq_default_timer_device
suffix:semicolon
r_extern
r_int
id|seq_default_timer_subdevice
suffix:semicolon
r_extern
r_int
id|seq_default_timer_resolution
suffix:semicolon
DECL|macro|SKEW_BASE
mdefine_line|#define SKEW_BASE&t;0x10000&t;/* 16bit shift */
DECL|function|snd_seq_timer_set_tick_resolution
r_void
id|snd_seq_timer_set_tick_resolution
c_func
(paren
id|seq_timer_tick_t
op_star
id|tick
comma
r_int
id|tempo
comma
r_int
id|ppq
comma
r_int
id|nticks
)paren
(brace
r_if
c_cond
(paren
id|tempo
OL
l_int|1000000
)paren
id|tick-&gt;resolution
op_assign
(paren
id|tempo
op_star
l_int|1000
)paren
op_div
id|ppq
suffix:semicolon
r_else
(brace
multiline_comment|/* might overflow.. */
r_int
r_int
id|s
suffix:semicolon
id|s
op_assign
id|tempo
op_mod
id|ppq
suffix:semicolon
id|s
op_assign
(paren
id|s
op_star
l_int|1000
)paren
op_div
id|ppq
suffix:semicolon
id|tick-&gt;resolution
op_assign
(paren
id|tempo
op_div
id|ppq
)paren
op_star
l_int|1000
suffix:semicolon
id|tick-&gt;resolution
op_add_assign
id|s
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tick-&gt;resolution
op_le
l_int|0
)paren
id|tick-&gt;resolution
op_assign
l_int|1
suffix:semicolon
id|tick-&gt;resolution
op_mul_assign
id|nticks
suffix:semicolon
id|snd_seq_timer_update_tick
c_func
(paren
id|tick
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* create new timer (constructor) */
DECL|function|snd_seq_timer_new
id|seq_timer_t
op_star
id|snd_seq_timer_new
c_func
(paren
r_void
)paren
(brace
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
id|tmr
op_assign
id|snd_kcalloc
c_func
(paren
r_sizeof
(paren
id|seq_timer_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmr
op_eq
l_int|NULL
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;malloc failed for snd_seq_timer_new() &bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|tmr-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* reset setup to defaults */
id|snd_seq_timer_defaults
c_func
(paren
id|tmr
)paren
suffix:semicolon
multiline_comment|/* reset time */
id|snd_seq_timer_reset
c_func
(paren
id|tmr
)paren
suffix:semicolon
r_return
id|tmr
suffix:semicolon
)brace
multiline_comment|/* delete timer (destructor) */
DECL|function|snd_seq_timer_delete
r_void
id|snd_seq_timer_delete
c_func
(paren
id|seq_timer_t
op_star
op_star
id|tmr
)paren
(brace
id|seq_timer_t
op_star
id|t
op_assign
op_star
id|tmr
suffix:semicolon
op_star
id|tmr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|t
op_eq
l_int|NULL
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;oops: snd_seq_timer_delete() called with NULL timer&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|t-&gt;running
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset time */
id|snd_seq_timer_stop
c_func
(paren
id|t
)paren
suffix:semicolon
id|snd_seq_timer_reset
c_func
(paren
id|t
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|t
)paren
suffix:semicolon
)brace
DECL|function|snd_seq_timer_defaults
r_void
id|snd_seq_timer_defaults
c_func
(paren
id|seq_timer_t
op_star
id|tmr
)paren
(brace
multiline_comment|/* setup defaults */
id|tmr-&gt;ppq
op_assign
l_int|96
suffix:semicolon
multiline_comment|/* 96 PPQ */
id|tmr-&gt;tempo
op_assign
l_int|500000
suffix:semicolon
multiline_comment|/* 120 BPM */
id|snd_seq_timer_set_tick_resolution
c_func
(paren
op_amp
id|tmr-&gt;tick
comma
id|tmr-&gt;tempo
comma
id|tmr-&gt;ppq
comma
l_int|1
)paren
suffix:semicolon
id|tmr-&gt;running
op_assign
l_int|0
suffix:semicolon
id|tmr-&gt;type
op_assign
id|SNDRV_SEQ_TIMER_ALSA
suffix:semicolon
id|tmr-&gt;alsa_id.dev_class
op_assign
id|seq_default_timer_class
suffix:semicolon
id|tmr-&gt;alsa_id.dev_sclass
op_assign
id|seq_default_timer_sclass
suffix:semicolon
id|tmr-&gt;alsa_id.card
op_assign
id|seq_default_timer_card
suffix:semicolon
id|tmr-&gt;alsa_id.device
op_assign
id|seq_default_timer_device
suffix:semicolon
id|tmr-&gt;alsa_id.subdevice
op_assign
id|seq_default_timer_subdevice
suffix:semicolon
id|tmr-&gt;preferred_resolution
op_assign
id|seq_default_timer_resolution
suffix:semicolon
id|tmr-&gt;skew
op_assign
id|tmr-&gt;skew_base
op_assign
id|SKEW_BASE
suffix:semicolon
)brace
DECL|function|snd_seq_timer_reset
r_void
id|snd_seq_timer_reset
c_func
(paren
id|seq_timer_t
op_star
id|tmr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* reset time &amp; songposition */
id|tmr-&gt;cur_time.tv_sec
op_assign
l_int|0
suffix:semicolon
id|tmr-&gt;cur_time.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|tmr-&gt;tick.cur_tick
op_assign
l_int|0
suffix:semicolon
id|tmr-&gt;tick.fraction
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* called by timer interrupt routine. the period time since previous invocation is passed */
DECL|function|snd_seq_timer_interrupt
r_static
r_void
id|snd_seq_timer_interrupt
c_func
(paren
id|snd_timer_instance_t
op_star
id|timeri
comma
r_int
r_int
id|resolution
comma
r_int
r_int
id|ticks
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|queue_t
op_star
id|q
op_assign
(paren
id|queue_t
op_star
)paren
id|timeri-&gt;callback_data
suffix:semicolon
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|tmr
op_assign
id|q-&gt;timer
suffix:semicolon
r_if
c_cond
(paren
id|tmr
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmr-&gt;running
)paren
r_return
suffix:semicolon
id|resolution
op_mul_assign
id|ticks
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;skew
op_ne
id|tmr-&gt;skew_base
)paren
(brace
multiline_comment|/* FIXME: assuming skew_base = 0x10000 */
id|resolution
op_assign
(paren
id|resolution
op_rshift
l_int|16
)paren
op_star
id|tmr-&gt;skew
op_plus
(paren
(paren
(paren
id|resolution
op_amp
l_int|0xffff
)paren
op_star
id|tmr-&gt;skew
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* update timer */
id|snd_seq_inc_time_nsec
c_func
(paren
op_amp
id|tmr-&gt;cur_time
comma
id|resolution
)paren
suffix:semicolon
multiline_comment|/* calculate current tick */
id|snd_seq_timer_update_tick
c_func
(paren
op_amp
id|tmr-&gt;tick
comma
id|resolution
)paren
suffix:semicolon
multiline_comment|/* register actual time of this timer update */
id|do_gettimeofday
c_func
(paren
op_amp
id|tmr-&gt;last_update
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* check queues and dispatch events */
id|snd_seq_check_queue
c_func
(paren
id|q
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* set current tempo */
DECL|function|snd_seq_timer_set_tempo
r_int
id|snd_seq_timer_set_tempo
c_func
(paren
id|seq_timer_t
op_star
id|tmr
comma
r_int
id|tempo
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_assert
c_func
(paren
id|tmr
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tempo
op_le
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|tempo
op_ne
id|tmr-&gt;tempo
)paren
(brace
id|tmr-&gt;tempo
op_assign
id|tempo
suffix:semicolon
id|snd_seq_timer_set_tick_resolution
c_func
(paren
op_amp
id|tmr-&gt;tick
comma
id|tmr-&gt;tempo
comma
id|tmr-&gt;ppq
comma
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set current ppq */
DECL|function|snd_seq_timer_set_ppq
r_int
id|snd_seq_timer_set_ppq
c_func
(paren
id|seq_timer_t
op_star
id|tmr
comma
r_int
id|ppq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_assert
c_func
(paren
id|tmr
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppq
op_le
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;running
op_logical_and
(paren
id|ppq
op_ne
id|tmr-&gt;ppq
)paren
)paren
(brace
multiline_comment|/* refuse to change ppq on running timers */
multiline_comment|/* because it will upset the song position (ticks) */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|snd_printd
c_func
(paren
l_string|&quot;seq: cannot change ppq of a running timer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|tmr-&gt;ppq
op_assign
id|ppq
suffix:semicolon
id|snd_seq_timer_set_tick_resolution
c_func
(paren
op_amp
id|tmr-&gt;tick
comma
id|tmr-&gt;tempo
comma
id|tmr-&gt;ppq
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set current tick position */
DECL|function|snd_seq_timer_set_position_tick
r_int
id|snd_seq_timer_set_position_tick
c_func
(paren
id|seq_timer_t
op_star
id|tmr
comma
id|snd_seq_tick_time_t
id|position
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_assert
c_func
(paren
id|tmr
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tmr-&gt;tick.cur_tick
op_assign
id|position
suffix:semicolon
id|tmr-&gt;tick.fraction
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set current real-time position */
DECL|function|snd_seq_timer_set_position_time
r_int
id|snd_seq_timer_set_position_time
c_func
(paren
id|seq_timer_t
op_star
id|tmr
comma
id|snd_seq_real_time_t
id|position
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_assert
c_func
(paren
id|tmr
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|snd_seq_sanity_real_time
c_func
(paren
op_amp
id|position
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tmr-&gt;cur_time
op_assign
id|position
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set timer skew */
DECL|function|snd_seq_timer_set_skew
r_int
id|snd_seq_timer_set_skew
c_func
(paren
id|seq_timer_t
op_star
id|tmr
comma
r_int
r_int
id|skew
comma
r_int
r_int
id|base
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|snd_assert
c_func
(paren
id|tmr
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* FIXME */
r_if
c_cond
(paren
id|base
op_ne
id|SKEW_BASE
)paren
(brace
id|snd_printd
c_func
(paren
l_string|&quot;invalid skew base 0x%x&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tmr-&gt;skew
op_assign
id|skew
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tmr-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_seq_timer_open
r_int
id|snd_seq_timer_open
c_func
(paren
id|queue_t
op_star
id|q
)paren
(brace
id|snd_timer_instance_t
op_star
id|t
suffix:semicolon
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
r_char
id|str
(braket
l_int|32
)braket
suffix:semicolon
id|tmr
op_assign
id|q-&gt;timer
suffix:semicolon
id|snd_assert
c_func
(paren
id|tmr
op_ne
l_int|NULL
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;timeri
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;sequencer queue %i&quot;
comma
id|q-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;type
op_eq
id|SNDRV_SEQ_TIMER_ALSA
)paren
(brace
multiline_comment|/* standard ALSA timer */
r_if
c_cond
(paren
id|tmr-&gt;alsa_id.dev_class
op_ne
id|SNDRV_TIMER_CLASS_SLAVE
)paren
id|tmr-&gt;alsa_id.dev_sclass
op_assign
id|SNDRV_TIMER_SCLASS_SEQUENCER
suffix:semicolon
id|t
op_assign
id|snd_timer_open
c_func
(paren
id|str
comma
op_amp
id|tmr-&gt;alsa_id
comma
id|q-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_eq
l_int|NULL
op_logical_and
id|tmr-&gt;alsa_id.dev_class
op_ne
id|SNDRV_TIMER_CLASS_SLAVE
)paren
(brace
r_if
c_cond
(paren
id|tmr-&gt;alsa_id.dev_class
op_ne
id|SNDRV_TIMER_CLASS_GLOBAL
op_logical_or
id|tmr-&gt;alsa_id.device
op_ne
id|SNDRV_TIMER_GLOBAL_SYSTEM
)paren
(brace
id|snd_timer_id_t
id|tid
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tid
comma
l_int|0
comma
r_sizeof
(paren
id|tid
)paren
)paren
suffix:semicolon
id|tid.dev_class
op_assign
id|SNDRV_TIMER_CLASS_GLOBAL
suffix:semicolon
id|tid.dev_sclass
op_assign
id|SNDRV_TIMER_SCLASS_SEQUENCER
suffix:semicolon
id|tid.card
op_assign
op_minus
l_int|1
suffix:semicolon
id|tid.device
op_assign
id|SNDRV_TIMER_GLOBAL_SYSTEM
suffix:semicolon
id|t
op_assign
id|snd_timer_open
c_func
(paren
id|str
comma
op_amp
id|tid
comma
id|q-&gt;queue
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t
op_eq
l_int|NULL
)paren
(brace
id|snd_printk
c_func
(paren
id|KERN_ERR
l_string|&quot;fatal error: cannot create timer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|t-&gt;callback
op_assign
id|snd_seq_timer_interrupt
suffix:semicolon
id|t-&gt;callback_data
op_assign
id|q
suffix:semicolon
id|t-&gt;flags
op_or_assign
id|SNDRV_TIMER_IFLG_AUTO
suffix:semicolon
id|tmr-&gt;timeri
op_assign
id|t
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_seq_timer_close
r_int
id|snd_seq_timer_close
c_func
(paren
id|queue_t
op_star
id|q
)paren
(brace
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
id|tmr
op_assign
id|q-&gt;timer
suffix:semicolon
id|snd_assert
c_func
(paren
id|tmr
op_ne
l_int|NULL
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;timeri
)paren
(brace
id|snd_timer_stop
c_func
(paren
id|tmr-&gt;timeri
)paren
suffix:semicolon
id|snd_timer_close
c_func
(paren
id|tmr-&gt;timeri
)paren
suffix:semicolon
id|tmr-&gt;timeri
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_seq_timer_stop
r_int
id|snd_seq_timer_stop
c_func
(paren
id|seq_timer_t
op_star
id|tmr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tmr-&gt;timeri
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmr-&gt;running
)paren
r_return
l_int|0
suffix:semicolon
id|tmr-&gt;running
op_assign
l_int|0
suffix:semicolon
id|snd_timer_stop
c_func
(paren
id|tmr-&gt;timeri
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|initialize_timer
r_static
r_int
id|initialize_timer
c_func
(paren
id|seq_timer_t
op_star
id|tmr
)paren
(brace
id|snd_timer_t
op_star
id|t
suffix:semicolon
id|t
op_assign
id|tmr-&gt;timeri-&gt;timer
suffix:semicolon
id|snd_assert
c_func
(paren
id|t
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tmr-&gt;ticks
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;preferred_resolution
op_logical_and
op_logical_neg
(paren
id|t-&gt;hw.flags
op_amp
id|SNDRV_TIMER_HW_SLAVE
)paren
)paren
(brace
r_int
r_int
id|r
op_assign
id|t-&gt;hw.resolution
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
op_logical_and
id|t-&gt;hw.c_resolution
)paren
id|r
op_assign
id|t-&gt;hw
dot
id|c_resolution
c_func
(paren
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|tmr-&gt;ticks
op_assign
(paren
r_int
r_int
)paren
(paren
id|tmr-&gt;preferred_resolution
op_div
id|r
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmr-&gt;ticks
)paren
id|tmr-&gt;ticks
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|tmr-&gt;initialized
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_seq_timer_start
r_int
id|snd_seq_timer_start
c_func
(paren
id|seq_timer_t
op_star
id|tmr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tmr-&gt;timeri
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;running
)paren
id|snd_seq_timer_stop
c_func
(paren
id|tmr
)paren
suffix:semicolon
id|snd_seq_timer_reset
c_func
(paren
id|tmr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|initialize_timer
c_func
(paren
id|tmr
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|snd_timer_start
c_func
(paren
id|tmr-&gt;timeri
comma
id|tmr-&gt;ticks
)paren
suffix:semicolon
id|tmr-&gt;running
op_assign
l_int|1
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tmr-&gt;last_update
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_seq_timer_continue
r_int
id|snd_seq_timer_continue
c_func
(paren
id|seq_timer_t
op_star
id|tmr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tmr-&gt;timeri
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;running
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmr-&gt;initialized
)paren
(brace
id|snd_seq_timer_reset
c_func
(paren
id|tmr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|initialize_timer
c_func
(paren
id|tmr
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|snd_timer_start
c_func
(paren
id|tmr-&gt;timeri
comma
id|tmr-&gt;ticks
)paren
suffix:semicolon
id|tmr-&gt;running
op_assign
l_int|1
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tmr-&gt;last_update
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* return current &squot;real&squot; time. use timeofday() to get better granularity. */
DECL|function|snd_seq_timer_get_cur_time
id|snd_seq_real_time_t
id|snd_seq_timer_get_cur_time
c_func
(paren
id|seq_timer_t
op_star
id|tmr
)paren
(brace
id|snd_seq_real_time_t
id|cur_time
suffix:semicolon
id|cur_time
op_assign
id|tmr-&gt;cur_time
suffix:semicolon
r_if
c_cond
(paren
id|tmr-&gt;running
)paren
(brace
r_struct
id|timeval
id|tm
suffix:semicolon
r_int
id|usec
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tm
)paren
suffix:semicolon
id|usec
op_assign
(paren
r_int
)paren
(paren
id|tm.tv_usec
op_minus
id|tmr-&gt;last_update.tv_usec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usec
OL
l_int|0
)paren
(brace
id|cur_time.tv_nsec
op_add_assign
(paren
l_int|1000000
op_plus
id|usec
)paren
op_star
l_int|1000
suffix:semicolon
id|cur_time.tv_sec
op_add_assign
id|tm.tv_sec
op_minus
id|tmr-&gt;last_update.tv_sec
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|cur_time.tv_nsec
op_add_assign
id|usec
op_star
l_int|1000
suffix:semicolon
id|cur_time.tv_sec
op_add_assign
id|tm.tv_sec
op_minus
id|tmr-&gt;last_update.tv_sec
suffix:semicolon
)brace
id|snd_seq_sanity_real_time
c_func
(paren
op_amp
id|cur_time
)paren
suffix:semicolon
)brace
r_return
id|cur_time
suffix:semicolon
)brace
multiline_comment|/* TODO: use interpolation on tick queue (will only be useful for very&n; high PPQ values) */
DECL|function|snd_seq_timer_get_cur_tick
id|snd_seq_tick_time_t
id|snd_seq_timer_get_cur_tick
c_func
(paren
id|seq_timer_t
op_star
id|tmr
)paren
(brace
r_return
id|tmr-&gt;tick.cur_tick
suffix:semicolon
)brace
multiline_comment|/* exported to seq_info.c */
DECL|function|snd_seq_info_timer_read
r_void
id|snd_seq_info_timer_read
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
id|snd_info_buffer_t
op_star
id|buffer
)paren
(brace
r_int
id|idx
suffix:semicolon
id|queue_t
op_star
id|q
suffix:semicolon
id|seq_timer_t
op_star
id|tmr
suffix:semicolon
id|snd_timer_instance_t
op_star
id|ti
suffix:semicolon
r_int
r_int
id|resolution
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|SNDRV_SEQ_MAX_QUEUES
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|q
op_assign
id|queueptr
c_func
(paren
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmr
op_assign
id|q-&gt;timer
)paren
op_eq
l_int|NULL
op_logical_or
(paren
id|ti
op_assign
id|tmr-&gt;timeri
)paren
op_eq
l_int|NULL
)paren
(brace
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Timer for queue %i : %s&bslash;n&quot;
comma
id|q-&gt;queue
comma
id|ti-&gt;timer-&gt;name
)paren
suffix:semicolon
id|resolution
op_assign
id|snd_timer_resolution
c_func
(paren
id|ti
)paren
op_star
id|tmr-&gt;ticks
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;  Period time : %lu.%09lu&bslash;n&quot;
comma
id|resolution
op_div
l_int|1000000000
comma
id|resolution
op_mod
l_int|1000000000
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;  Skew : %u / %u&bslash;n&quot;
comma
id|tmr-&gt;skew
comma
id|tmr-&gt;skew_base
)paren
suffix:semicolon
id|queuefree
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
)brace
eof
