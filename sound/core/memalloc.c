multiline_comment|/*&n; *  Copyright (c) by Jaroslav Kysela &lt;perex@suse.cz&gt;&n; *                   Takashi Iwai &lt;tiwai@suse.de&gt;&n; * &n; *  Generic memory allocators&n; *&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;sound/memalloc.h&gt;
macro_line|#ifdef CONFIG_SBUS
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Takashi Iwai &lt;tiwai@suse.de&gt;, Jaroslav Kysela &lt;perex@suse.cz&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Memory allocator for ALSA system.&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifndef SNDRV_CARDS
DECL|macro|SNDRV_CARDS
mdefine_line|#define SNDRV_CARDS&t;8
macro_line|#endif
multiline_comment|/* FIXME: so far only some PCI devices have the preallocation table */
macro_line|#ifdef CONFIG_PCI
DECL|variable|enable
r_static
r_int
id|enable
(braket
id|SNDRV_CARDS
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|SNDRV_CARDS
op_minus
l_int|1
)paren
)braket
op_assign
l_int|1
)brace
suffix:semicolon
DECL|variable|boot_devs
r_static
r_int
id|boot_devs
suffix:semicolon
id|module_param_array
c_func
(paren
id|enable
comma
r_bool
comma
id|boot_devs
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|enable
comma
l_string|&quot;Enable cards to allocate buffers.&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; */
r_void
op_star
id|snd_malloc_sgbuf_pages
c_func
(paren
r_struct
id|device
op_star
id|device
comma
r_int
id|size
comma
r_struct
id|snd_dma_buffer
op_star
id|dmab
comma
r_int
op_star
id|res_size
)paren
suffix:semicolon
r_int
id|snd_free_sgbuf_pages
c_func
(paren
r_struct
id|snd_dma_buffer
op_star
id|dmab
)paren
suffix:semicolon
multiline_comment|/*&n; */
r_static
id|DECLARE_MUTEX
c_func
(paren
id|list_mutex
)paren
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|mem_list_head
)paren
suffix:semicolon
multiline_comment|/* buffer preservation list */
DECL|struct|snd_mem_list
r_struct
id|snd_mem_list
(brace
DECL|member|buffer
r_struct
id|snd_dma_buffer
id|buffer
suffix:semicolon
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* id for pre-allocated buffers */
DECL|macro|SNDRV_DMA_DEVICE_UNUSED
mdefine_line|#define SNDRV_DMA_DEVICE_UNUSED (unsigned int)-1
macro_line|#ifdef CONFIG_SND_DEBUG
DECL|macro|__ASTRING__
mdefine_line|#define __ASTRING__(x) #x
DECL|macro|snd_assert
mdefine_line|#define snd_assert(expr, args...) do {&bslash;&n;&t;if (!(expr)) {&bslash;&n;&t;&t;printk(KERN_ERR &quot;snd-malloc: BUG? (%s) (called from %p)&bslash;n&quot;, __ASTRING__(expr), __builtin_return_address(0));&bslash;&n;&t;&t;args;&bslash;&n;&t;}&bslash;&n;} while (0)
macro_line|#else
DECL|macro|snd_assert
mdefine_line|#define snd_assert(expr, args...) /**/
macro_line|#endif
multiline_comment|/*&n; *  Hacks&n; */
macro_line|#if defined(__i386__) || defined(__ppc__) || defined(__x86_64__)
multiline_comment|/*&n; * A hack to allocate large buffers via dma_alloc_coherent()&n; *&n; * since dma_alloc_coherent always tries GFP_DMA when the requested&n; * pci memory region is below 32bit, it happens quite often that even&n; * 2 order of pages cannot be allocated.&n; *&n; * so in the following, we allocate at first without dma_mask, so that&n; * allocation will be done without GFP_DMA.  if the area doesn&squot;t match&n; * with the requested region, then realloate with the original dma_mask&n; * again.&n; *&n; * Really, we want to move this type of thing into dma_alloc_coherent()&n; * so dma_mask doesn&squot;t have to be messed with.&n; */
DECL|function|snd_dma_hack_alloc_coherent
r_static
r_void
op_star
id|snd_dma_hack_alloc_coherent
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
comma
r_int
id|flags
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
id|u64
id|dma_mask
comma
id|coherent_dma_mask
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
op_logical_neg
id|dev-&gt;dma_mask
)paren
r_return
id|dma_alloc_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|dma_handle
comma
id|flags
)paren
suffix:semicolon
id|dma_mask
op_assign
op_star
id|dev-&gt;dma_mask
suffix:semicolon
id|coherent_dma_mask
op_assign
id|dev-&gt;coherent_dma_mask
suffix:semicolon
op_star
id|dev-&gt;dma_mask
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* do without masking */
id|dev-&gt;coherent_dma_mask
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* do without masking */
id|ret
op_assign
id|dma_alloc_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|dma_handle
comma
id|flags
)paren
suffix:semicolon
op_star
id|dev-&gt;dma_mask
op_assign
id|dma_mask
suffix:semicolon
multiline_comment|/* restore */
id|dev-&gt;coherent_dma_mask
op_assign
id|coherent_dma_mask
suffix:semicolon
multiline_comment|/* restore */
r_if
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* obtained address is out of range? */
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
op_star
id|dma_handle
op_plus
id|size
op_minus
l_int|1
)paren
op_amp
op_complement
id|dma_mask
)paren
(brace
multiline_comment|/* reallocate with the proper mask */
id|dma_free_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|ret
comma
op_star
id|dma_handle
)paren
suffix:semicolon
id|ret
op_assign
id|dma_alloc_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|dma_handle
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* wish to success now with the proper mask... */
r_if
c_cond
(paren
id|dma_mask
op_ne
l_int|0xffffffffUL
)paren
(brace
multiline_comment|/* allocation with GFP_ATOMIC to avoid the long stall */
id|flags
op_and_assign
op_complement
id|GFP_KERNEL
suffix:semicolon
id|flags
op_or_assign
id|GFP_ATOMIC
suffix:semicolon
id|ret
op_assign
id|dma_alloc_coherent
c_func
(paren
id|dev
comma
id|size
comma
id|dma_handle
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* redefine dma_alloc_coherent for some architectures */
DECL|macro|dma_alloc_coherent
macro_line|#undef dma_alloc_coherent
DECL|macro|dma_alloc_coherent
mdefine_line|#define dma_alloc_coherent snd_dma_hack_alloc_coherent
macro_line|#endif /* arch */
macro_line|#if ! defined(__arm__)
DECL|macro|NEED_RESERVE_PAGES
mdefine_line|#define NEED_RESERVE_PAGES
macro_line|#endif
multiline_comment|/*&n; *&n; *  Generic memory allocators&n; *&n; */
DECL|variable|snd_allocated_pages
r_static
r_int
id|snd_allocated_pages
suffix:semicolon
multiline_comment|/* holding the number of allocated pages */
DECL|function|inc_snd_pages
r_static
r_inline
r_void
id|inc_snd_pages
c_func
(paren
r_int
id|order
)paren
(brace
id|snd_allocated_pages
op_add_assign
l_int|1
op_lshift
id|order
suffix:semicolon
)brace
DECL|function|dec_snd_pages
r_static
r_inline
r_void
id|dec_snd_pages
c_func
(paren
r_int
id|order
)paren
(brace
id|snd_allocated_pages
op_sub_assign
l_int|1
op_lshift
id|order
suffix:semicolon
)brace
DECL|function|mark_pages
r_static
r_void
id|mark_pages
c_func
(paren
r_struct
id|page
op_star
id|page
comma
r_int
id|order
)paren
(brace
r_struct
id|page
op_star
id|last_page
op_assign
id|page
op_plus
(paren
l_int|1
op_lshift
id|order
)paren
suffix:semicolon
r_while
c_loop
(paren
id|page
OL
id|last_page
)paren
id|SetPageReserved
c_func
(paren
id|page
op_increment
)paren
suffix:semicolon
)brace
DECL|function|unmark_pages
r_static
r_void
id|unmark_pages
c_func
(paren
r_struct
id|page
op_star
id|page
comma
r_int
id|order
)paren
(brace
r_struct
id|page
op_star
id|last_page
op_assign
id|page
op_plus
(paren
l_int|1
op_lshift
id|order
)paren
suffix:semicolon
r_while
c_loop
(paren
id|page
OL
id|last_page
)paren
id|ClearPageReserved
c_func
(paren
id|page
op_increment
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_malloc_pages - allocate pages with the given size&n; * @size: the size to allocate in bytes&n; * @gfp_flags: the allocation conditions, GFP_XXX&n; *&n; * Allocates the physically contiguous pages with the given size.&n; *&n; * Returns the pointer of the buffer, or NULL if no enoguh memory.&n; */
DECL|function|snd_malloc_pages
r_void
op_star
id|snd_malloc_pages
c_func
(paren
r_int
id|size
comma
r_int
r_int
id|gfp_flags
)paren
(brace
r_int
id|pg
suffix:semicolon
r_void
op_star
id|res
suffix:semicolon
id|snd_assert
c_func
(paren
id|size
OG
l_int|0
comma
r_return
l_int|NULL
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|gfp_flags
op_ne
l_int|0
comma
r_return
l_int|NULL
)paren
suffix:semicolon
id|pg
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|gfp_flags
comma
id|pg
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|mark_pages
c_func
(paren
id|virt_to_page
c_func
(paren
id|res
)paren
comma
id|pg
)paren
suffix:semicolon
id|inc_snd_pages
c_func
(paren
id|pg
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_free_pages - release the pages&n; * @ptr: the buffer pointer to release&n; * @size: the allocated buffer size&n; *&n; * Releases the buffer allocated via snd_malloc_pages().&n; */
DECL|function|snd_free_pages
r_void
id|snd_free_pages
c_func
(paren
r_void
op_star
id|ptr
comma
r_int
id|size
)paren
(brace
r_int
id|pg
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|pg
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|dec_snd_pages
c_func
(paren
id|pg
)paren
suffix:semicolon
id|unmark_pages
c_func
(paren
id|virt_to_page
c_func
(paren
id|ptr
)paren
comma
id|pg
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|ptr
comma
id|pg
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&n; *  Bus-specific memory allocators&n; *&n; */
multiline_comment|/* allocate the coherent DMA pages */
DECL|function|snd_malloc_dev_pages
r_static
r_void
op_star
id|snd_malloc_dev_pages
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma
)paren
(brace
r_int
id|pg
suffix:semicolon
r_void
op_star
id|res
suffix:semicolon
r_int
r_int
id|gfp_flags
suffix:semicolon
id|snd_assert
c_func
(paren
id|size
OG
l_int|0
comma
r_return
l_int|NULL
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|dma
op_ne
l_int|NULL
comma
r_return
l_int|NULL
)paren
suffix:semicolon
id|pg
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|gfp_flags
op_assign
id|GFP_KERNEL
suffix:semicolon
id|gfp_flags
op_or_assign
id|__GFP_NORETRY
suffix:semicolon
multiline_comment|/* don&squot;t trigger OOM-killer */
r_if
c_cond
(paren
id|pg
OG
l_int|0
)paren
id|gfp_flags
op_or_assign
id|__GFP_NOWARN
suffix:semicolon
id|res
op_assign
id|dma_alloc_coherent
c_func
(paren
id|dev
comma
id|PAGE_SIZE
op_lshift
id|pg
comma
id|dma
comma
id|gfp_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ne
l_int|NULL
)paren
(brace
macro_line|#ifdef NEED_RESERVE_PAGES
id|mark_pages
c_func
(paren
id|virt_to_page
c_func
(paren
id|res
)paren
comma
id|pg
)paren
suffix:semicolon
multiline_comment|/* should be dma_to_page() */
macro_line|#endif
id|inc_snd_pages
c_func
(paren
id|pg
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* free the coherent DMA pages */
DECL|function|snd_free_dev_pages
r_static
r_void
id|snd_free_dev_pages
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|size
comma
r_void
op_star
id|ptr
comma
id|dma_addr_t
id|dma
)paren
(brace
r_int
id|pg
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|pg
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|dec_snd_pages
c_func
(paren
id|pg
)paren
suffix:semicolon
macro_line|#ifdef NEED_RESERVE_PAGES
id|unmark_pages
c_func
(paren
id|virt_to_page
c_func
(paren
id|ptr
)paren
comma
id|pg
)paren
suffix:semicolon
multiline_comment|/* should be dma_to_page() */
macro_line|#endif
id|dma_free_coherent
c_func
(paren
id|dev
comma
id|PAGE_SIZE
op_lshift
id|pg
comma
id|ptr
comma
id|dma
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SBUS
DECL|function|snd_malloc_sbus_pages
r_static
r_void
op_star
id|snd_malloc_sbus_pages
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_addr
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
(paren
r_struct
id|sbus_dev
op_star
)paren
id|dev
suffix:semicolon
r_int
id|pg
suffix:semicolon
r_void
op_star
id|res
suffix:semicolon
id|snd_assert
c_func
(paren
id|size
OG
l_int|0
comma
r_return
l_int|NULL
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|dma_addr
op_ne
l_int|NULL
comma
r_return
l_int|NULL
)paren
suffix:semicolon
id|pg
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|res
op_assign
id|sbus_alloc_consistent
c_func
(paren
id|sdev
comma
id|PAGE_SIZE
op_star
(paren
l_int|1
op_lshift
id|pg
)paren
comma
id|dma_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ne
l_int|NULL
)paren
id|inc_snd_pages
c_func
(paren
id|pg
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|snd_free_sbus_pages
r_static
r_void
id|snd_free_sbus_pages
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|size
comma
r_void
op_star
id|ptr
comma
id|dma_addr_t
id|dma_addr
)paren
(brace
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
(paren
r_struct
id|sbus_dev
op_star
)paren
id|dev
suffix:semicolon
r_int
id|pg
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|pg
op_assign
id|get_order
c_func
(paren
id|size
)paren
suffix:semicolon
id|dec_snd_pages
c_func
(paren
id|pg
)paren
suffix:semicolon
id|sbus_free_consistent
c_func
(paren
id|sdev
comma
id|PAGE_SIZE
op_star
(paren
l_int|1
op_lshift
id|pg
)paren
comma
id|ptr
comma
id|dma_addr
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SBUS */
multiline_comment|/*&n; *&n; *  ALSA generic memory management&n; *&n; */
multiline_comment|/**&n; * snd_dma_alloc_pages - allocate the buffer area according to the given type&n; * @type: the DMA buffer type&n; * @device: the device pointer&n; * @size: the buffer size to allocate&n; * @dmab: buffer allocation record to store the allocated data&n; *&n; * Calls the memory-allocator function for the corresponding&n; * buffer type.&n; * &n; * Returns zero if the buffer with the given size is allocated successfuly,&n; * other a negative value at error.&n; */
DECL|function|snd_dma_alloc_pages
r_int
id|snd_dma_alloc_pages
c_func
(paren
r_int
id|type
comma
r_struct
id|device
op_star
id|device
comma
r_int
id|size
comma
r_struct
id|snd_dma_buffer
op_star
id|dmab
)paren
(brace
id|snd_assert
c_func
(paren
id|size
OG
l_int|0
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|dmab
op_ne
l_int|NULL
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|dmab-&gt;dev.type
op_assign
id|type
suffix:semicolon
id|dmab-&gt;dev.dev
op_assign
id|device
suffix:semicolon
id|dmab-&gt;bytes
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|SNDRV_DMA_TYPE_CONTINUOUS
suffix:colon
id|dmab-&gt;area
op_assign
id|snd_malloc_pages
c_func
(paren
id|size
comma
(paren
r_int
r_int
)paren
id|device
)paren
suffix:semicolon
id|dmab-&gt;addr
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_SBUS
r_case
id|SNDRV_DMA_TYPE_SBUS
suffix:colon
id|dmab-&gt;area
op_assign
id|snd_malloc_sbus_pages
c_func
(paren
id|device
comma
id|size
comma
op_amp
id|dmab-&gt;addr
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|SNDRV_DMA_TYPE_DEV
suffix:colon
id|dmab-&gt;area
op_assign
id|snd_malloc_dev_pages
c_func
(paren
id|device
comma
id|size
comma
op_amp
id|dmab-&gt;addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_DMA_TYPE_DEV_SG
suffix:colon
id|snd_malloc_sgbuf_pages
c_func
(paren
id|device
comma
id|size
comma
id|dmab
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;snd-malloc: invalid device type %d&bslash;n&quot;
comma
id|type
)paren
suffix:semicolon
id|dmab-&gt;area
op_assign
l_int|NULL
suffix:semicolon
id|dmab-&gt;addr
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dmab-&gt;area
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dmab-&gt;bytes
op_assign
id|size
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_dma_alloc_pages_fallback - allocate the buffer area according to the given type with fallback&n; * @type: the DMA buffer type&n; * @device: the device pointer&n; * @size: the buffer size to allocate&n; * @dmab: buffer allocation record to store the allocated data&n; *&n; * Calls the memory-allocator function for the corresponding&n; * buffer type.  When no space is left, this function reduces the size and&n; * tries to allocate again.  The size actually allocated is stored in&n; * res_size argument.&n; * &n; * Returns zero if the buffer with the given size is allocated successfuly,&n; * other a negative value at error.&n; */
DECL|function|snd_dma_alloc_pages_fallback
r_int
id|snd_dma_alloc_pages_fallback
c_func
(paren
r_int
id|type
comma
r_struct
id|device
op_star
id|device
comma
r_int
id|size
comma
r_struct
id|snd_dma_buffer
op_star
id|dmab
)paren
(brace
r_int
id|err
suffix:semicolon
id|snd_assert
c_func
(paren
id|size
OG
l_int|0
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|dmab
op_ne
l_int|NULL
comma
r_return
op_minus
id|ENXIO
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|err
op_assign
id|snd_dma_alloc_pages
c_func
(paren
id|type
comma
id|device
comma
id|size
comma
id|dmab
)paren
)paren
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|err
op_ne
op_minus
id|ENOMEM
)paren
r_return
id|err
suffix:semicolon
id|size
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
id|PAGE_SIZE
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dmab-&gt;area
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_dma_free_pages - release the allocated buffer&n; * @dmab: the buffer allocation record to release&n; *&n; * Releases the allocated buffer via snd_dma_alloc_pages().&n; */
DECL|function|snd_dma_free_pages
r_void
id|snd_dma_free_pages
c_func
(paren
r_struct
id|snd_dma_buffer
op_star
id|dmab
)paren
(brace
r_switch
c_cond
(paren
id|dmab-&gt;dev.type
)paren
(brace
r_case
id|SNDRV_DMA_TYPE_CONTINUOUS
suffix:colon
id|snd_free_pages
c_func
(paren
id|dmab-&gt;area
comma
id|dmab-&gt;bytes
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_SBUS
r_case
id|SNDRV_DMA_TYPE_SBUS
suffix:colon
id|snd_free_sbus_pages
c_func
(paren
id|dmab-&gt;dev.dev
comma
id|dmab-&gt;bytes
comma
id|dmab-&gt;area
comma
id|dmab-&gt;addr
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|SNDRV_DMA_TYPE_DEV
suffix:colon
id|snd_free_dev_pages
c_func
(paren
id|dmab-&gt;dev.dev
comma
id|dmab-&gt;bytes
comma
id|dmab-&gt;area
comma
id|dmab-&gt;addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_DMA_TYPE_DEV_SG
suffix:colon
id|snd_free_sgbuf_pages
c_func
(paren
id|dmab
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;snd-malloc: invalid device type %d&bslash;n&quot;
comma
id|dmab-&gt;dev.type
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * snd_dma_get_reserved - get the reserved buffer for the given device&n; * @dmab: the buffer allocation record to store&n; * @id: the buffer id&n; *&n; * Looks for the reserved-buffer list and re-uses if the same buffer&n; * is found in the list.  When the buffer is found, it&squot;s removed from the free list.&n; *&n; * Returns the size of buffer if the buffer is found, or zero if not found.&n; */
DECL|function|snd_dma_get_reserved_buf
r_int
id|snd_dma_get_reserved_buf
c_func
(paren
r_struct
id|snd_dma_buffer
op_star
id|dmab
comma
r_int
r_int
id|id
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|snd_mem_list
op_star
id|mem
suffix:semicolon
id|snd_assert
c_func
(paren
id|dmab
comma
r_return
l_int|0
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|mem_list_head
)paren
(brace
id|mem
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|snd_mem_list
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;id
op_eq
id|id
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|mem-&gt;buffer.dev
comma
op_amp
id|dmab-&gt;dev
comma
r_sizeof
(paren
id|dmab-&gt;dev
)paren
)paren
)paren
(brace
id|list_del
c_func
(paren
id|p
)paren
suffix:semicolon
op_star
id|dmab
op_assign
id|mem-&gt;buffer
suffix:semicolon
id|kfree
c_func
(paren
id|mem
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
r_return
id|dmab-&gt;bytes
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * snd_dma_reserve_buf - reserve the buffer&n; * @dmab: the buffer to reserve&n; * @id: the buffer id&n; *&n; * Reserves the given buffer as a reserved buffer.&n; * &n; * Returns zero if successful, or a negative code at error.&n; */
DECL|function|snd_dma_reserve_buf
r_int
id|snd_dma_reserve_buf
c_func
(paren
r_struct
id|snd_dma_buffer
op_star
id|dmab
comma
r_int
r_int
id|id
)paren
(brace
r_struct
id|snd_mem_list
op_star
id|mem
suffix:semicolon
id|snd_assert
c_func
(paren
id|dmab
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|mem
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mem
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|down
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
id|mem-&gt;buffer
op_assign
op_star
id|dmab
suffix:semicolon
id|mem-&gt;id
op_assign
id|id
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|mem-&gt;list
comma
op_amp
id|mem_list_head
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * purge all reserved buffers&n; */
DECL|function|free_all_reserved_pages
r_static
r_void
id|free_all_reserved_pages
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|snd_mem_list
op_star
id|mem
suffix:semicolon
id|down
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|mem_list_head
)paren
)paren
(brace
id|p
op_assign
id|mem_list_head.next
suffix:semicolon
id|mem
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|snd_mem_list
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|p
)paren
suffix:semicolon
id|snd_dma_free_pages
c_func
(paren
op_amp
id|mem-&gt;buffer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * allocation of buffers for pre-defined devices&n; */
macro_line|#ifdef CONFIG_PCI
multiline_comment|/* FIXME: for pci only - other bus? */
DECL|struct|prealloc_dev
r_struct
id|prealloc_dev
(brace
DECL|member|vendor
r_int
r_int
id|vendor
suffix:semicolon
DECL|member|device
r_int
r_int
id|device
suffix:semicolon
DECL|member|dma_mask
r_int
r_int
id|dma_mask
suffix:semicolon
DECL|member|size
r_int
r_int
id|size
suffix:semicolon
DECL|member|buffers
r_int
r_int
id|buffers
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|HAMMERFALL_BUFFER_SIZE
mdefine_line|#define HAMMERFALL_BUFFER_SIZE    (16*1024*4*(26+1)+0x10000)
DECL|variable|__initdata
r_static
r_struct
id|prealloc_dev
id|prealloc_devices
(braket
)braket
id|__initdata
op_assign
(brace
(brace
multiline_comment|/* hammerfall */
dot
id|vendor
op_assign
l_int|0x10ee
comma
dot
id|device
op_assign
l_int|0x3fc4
comma
dot
id|dma_mask
op_assign
l_int|0xffffffff
comma
dot
id|size
op_assign
id|HAMMERFALL_BUFFER_SIZE
comma
dot
id|buffers
op_assign
l_int|2
)brace
comma
(brace
multiline_comment|/* HDSP */
dot
id|vendor
op_assign
l_int|0x10ee
comma
dot
id|device
op_assign
l_int|0x3fc5
comma
dot
id|dma_mask
op_assign
l_int|0xffffffff
comma
dot
id|size
op_assign
id|HAMMERFALL_BUFFER_SIZE
comma
dot
id|buffers
op_assign
l_int|2
)brace
comma
(brace
)brace
comma
multiline_comment|/* terminator */
)brace
suffix:semicolon
DECL|function|preallocate_cards
r_static
r_void
id|__init
id|preallocate_cards
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci
op_assign
l_int|NULL
suffix:semicolon
r_int
id|card
suffix:semicolon
id|card
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pci
op_assign
id|pci_find_device
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|pci
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_struct
id|prealloc_dev
op_star
id|dev
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|card
op_ge
id|SNDRV_CARDS
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|dev
op_assign
id|prealloc_devices
suffix:semicolon
id|dev-&gt;vendor
suffix:semicolon
id|dev
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|pci-&gt;vendor
op_logical_and
id|dev-&gt;device
op_eq
id|pci-&gt;device
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;vendor
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|enable
(braket
id|card
op_increment
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;snd-page-alloc: skipping card %d, device %04x:%04x&bslash;n&quot;
comma
id|card
comma
id|pci-&gt;vendor
comma
id|pci-&gt;device
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pci
comma
id|dev-&gt;dma_mask
)paren
OL
l_int|0
op_logical_or
id|pci_set_consistent_dma_mask
c_func
(paren
id|pci
comma
id|dev-&gt;dma_mask
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;snd-page-alloc: cannot set DMA mask %lx for pci %04x:%04x&bslash;n&quot;
comma
id|dev-&gt;dma_mask
comma
id|dev-&gt;vendor
comma
id|dev-&gt;device
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|snd_dma_buffer
id|dmab
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|dmab
comma
l_int|0
comma
r_sizeof
(paren
id|dmab
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd_dma_alloc_pages
c_func
(paren
id|SNDRV_DMA_TYPE_DEV
comma
id|snd_dma_pci_data
c_func
(paren
id|pci
)paren
comma
id|dev-&gt;size
comma
op_amp
id|dmab
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;snd-page-alloc: cannot allocate buffer pages (size = %d)&bslash;n&quot;
comma
id|dev-&gt;size
)paren
suffix:semicolon
r_else
id|snd_dma_reserve_buf
c_func
(paren
op_amp
id|dmab
comma
id|snd_dma_pci_buf_id
c_func
(paren
id|pci
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#else
DECL|macro|preallocate_cards
mdefine_line|#define preallocate_cards()&t;/* NOP */
macro_line|#endif
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; * proc file interface&n; */
DECL|function|snd_mem_proc_read
r_static
r_int
id|snd_mem_proc_read
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|pages
op_assign
id|snd_allocated_pages
op_rshift
(paren
id|PAGE_SHIFT
op_minus
l_int|12
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|snd_mem_list
op_star
id|mem
suffix:semicolon
r_int
id|devno
suffix:semicolon
r_static
r_char
op_star
id|types
(braket
)braket
op_assign
(brace
l_string|&quot;UNKNOWN&quot;
comma
l_string|&quot;CONT&quot;
comma
l_string|&quot;DEV&quot;
comma
l_string|&quot;DEV-SG&quot;
comma
l_string|&quot;SBUS&quot;
)brace
suffix:semicolon
id|down
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|count
op_minus
id|len
comma
l_string|&quot;pages  : %li bytes (%li pages per %likB)&bslash;n&quot;
comma
id|pages
op_star
id|PAGE_SIZE
comma
id|pages
comma
id|PAGE_SIZE
op_div
l_int|1024
)paren
suffix:semicolon
id|devno
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|mem_list_head
)paren
(brace
id|mem
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|snd_mem_list
comma
id|list
)paren
suffix:semicolon
id|devno
op_increment
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|count
op_minus
id|len
comma
l_string|&quot;buffer %d : ID %08x : type %s&bslash;n&quot;
comma
id|devno
comma
id|mem-&gt;id
comma
id|types
(braket
id|mem-&gt;buffer.dev.type
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|snprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|count
op_minus
id|len
comma
l_string|&quot;  addr = 0x%lx, size = %d bytes&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|mem-&gt;buffer.addr
comma
(paren
r_int
)paren
id|mem-&gt;buffer.bytes
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|list_mutex
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS */
multiline_comment|/*&n; * module entry&n; */
DECL|function|snd_mem_init
r_static
r_int
id|__init
id|snd_mem_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS
id|create_proc_read_entry
c_func
(paren
l_string|&quot;driver/snd-page-alloc&quot;
comma
l_int|0
comma
l_int|NULL
comma
id|snd_mem_proc_read
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
id|preallocate_cards
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_mem_exit
r_static
r_void
id|__exit
id|snd_mem_exit
c_func
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;driver/snd-page-alloc&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|free_all_reserved_pages
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|snd_allocated_pages
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;snd-malloc: Memory leak?  pages not freed = %li&bslash;n&quot;
comma
id|snd_allocated_pages
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|snd_mem_init
)paren
id|module_exit
c_func
(paren
id|snd_mem_exit
)paren
multiline_comment|/*&n; * exports&n; */
id|EXPORT_SYMBOL
c_func
(paren
id|snd_dma_alloc_pages
)paren
suffix:semicolon
DECL|variable|EXPORT_SYMBOL
id|EXPORT_SYMBOL
c_func
(paren
id|snd_dma_alloc_pages_fallback
)paren
suffix:semicolon
DECL|variable|snd_dma_free_pages
id|EXPORT_SYMBOL
c_func
(paren
id|snd_dma_free_pages
)paren
suffix:semicolon
DECL|variable|snd_dma_get_reserved_buf
id|EXPORT_SYMBOL
c_func
(paren
id|snd_dma_get_reserved_buf
)paren
suffix:semicolon
DECL|variable|snd_dma_reserve_buf
id|EXPORT_SYMBOL
c_func
(paren
id|snd_dma_reserve_buf
)paren
suffix:semicolon
DECL|variable|snd_malloc_pages
id|EXPORT_SYMBOL
c_func
(paren
id|snd_malloc_pages
)paren
suffix:semicolon
DECL|variable|snd_free_pages
id|EXPORT_SYMBOL
c_func
(paren
id|snd_free_pages
)paren
suffix:semicolon
eof
