multiline_comment|/*&n; *  Soundfont generic routines.&n; *&t;It is intended that these should be used by any driver that is willing&n; *&t;to accept soundfont patches.&n; *&n; *  Copyright (C) 1999 Steve Ratcliffe&n; *  Copyright (c) 1999-2000 Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
multiline_comment|/*&n; * Deal with reading in of a soundfont.  Code follows the OSS way&n; * of doing things so that the old sfxload utility can be used.&n; * Everything may change when there is an alsa way of doing things.&n; */
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/soundfont.h&gt;
multiline_comment|/* Prototypes for static functions */
r_static
r_int
id|open_patch
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
r_int
id|client
)paren
suffix:semicolon
r_static
id|snd_soundfont_t
op_star
id|newsf
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
id|type
comma
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_int
id|is_identical_font
c_func
(paren
id|snd_soundfont_t
op_star
id|sf
comma
r_int
id|type
comma
r_int
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_int
id|close_patch
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
suffix:semicolon
r_static
r_int
id|probe_data
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
id|sample_id
)paren
suffix:semicolon
r_static
r_void
id|set_zone_counter
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
comma
id|snd_sf_zone_t
op_star
id|zp
)paren
suffix:semicolon
r_static
id|snd_sf_zone_t
op_star
id|sf_zone_new
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
)paren
suffix:semicolon
r_static
r_void
id|set_sample_counter
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
comma
id|snd_sf_sample_t
op_star
id|sp
)paren
suffix:semicolon
r_static
id|snd_sf_sample_t
op_star
id|sf_sample_new
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
)paren
suffix:semicolon
r_static
r_void
id|sf_sample_delete
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
comma
id|snd_sf_sample_t
op_star
id|sp
)paren
suffix:semicolon
r_static
r_int
id|load_map
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_void
id|__user
op_star
id|data
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|load_info
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_void
id|__user
op_star
id|data
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|remove_info
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
comma
r_int
id|bank
comma
r_int
id|instr
)paren
suffix:semicolon
r_static
r_void
id|init_voice_info
c_func
(paren
id|soundfont_voice_info_t
op_star
id|avp
)paren
suffix:semicolon
r_static
r_void
id|init_voice_parm
c_func
(paren
id|soundfont_voice_parm_t
op_star
id|pp
)paren
suffix:semicolon
r_static
id|snd_sf_sample_t
op_star
id|set_sample
c_func
(paren
id|snd_soundfont_t
op_star
id|sf
comma
id|soundfont_voice_info_t
op_star
id|avp
)paren
suffix:semicolon
r_static
id|snd_sf_sample_t
op_star
id|find_sample
c_func
(paren
id|snd_soundfont_t
op_star
id|sf
comma
r_int
id|sample_id
)paren
suffix:semicolon
r_static
r_int
id|load_data
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_void
id|__user
op_star
id|data
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|rebuild_presets
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
suffix:semicolon
r_static
r_void
id|add_preset
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_sf_zone_t
op_star
id|cur
)paren
suffix:semicolon
r_static
r_void
id|delete_preset
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_sf_zone_t
op_star
id|zp
)paren
suffix:semicolon
r_static
id|snd_sf_zone_t
op_star
id|search_first_zone
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
id|bank
comma
r_int
id|preset
comma
r_int
id|key
)paren
suffix:semicolon
r_static
r_int
id|search_zones
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
op_star
id|notep
comma
r_int
id|vel
comma
r_int
id|preset
comma
r_int
id|bank
comma
id|snd_sf_zone_t
op_star
op_star
id|table
comma
r_int
id|max_layers
comma
r_int
id|level
)paren
suffix:semicolon
r_static
r_int
id|get_index
c_func
(paren
r_int
id|bank
comma
r_int
id|instr
comma
r_int
id|key
)paren
suffix:semicolon
r_static
r_void
id|snd_sf_init
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
suffix:semicolon
r_static
r_void
id|snd_sf_clear
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
suffix:semicolon
multiline_comment|/*&n; * lock access to sflist&n; */
r_static
r_int
DECL|function|lock_preset
id|lock_preset
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|nonblock
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|sflist-&gt;presets_mutex
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
id|down
c_func
(paren
op_amp
id|sflist-&gt;presets_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * remove lock&n; */
r_static
r_void
DECL|function|unlock_preset
id|unlock_preset
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
id|up
c_func
(paren
op_amp
id|sflist-&gt;presets_mutex
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * close the patch if the patch was opened by this client.&n; */
r_int
DECL|function|snd_soundfont_close_check
id|snd_soundfont_close_check
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
id|client
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sflist-&gt;open_client
op_eq
id|client
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|close_patch
c_func
(paren
id|sflist
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Deal with a soundfont patch.  Any driver could use these routines&n; * although it was designed for the AWE64.&n; *&n; * The sample_write and callargs pararameters allow a callback into&n; * the actual driver to write sample data to the board or whatever&n; * it wants to do with it.&n; */
r_int
DECL|function|snd_soundfont_load
id|snd_soundfont_load
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_void
id|__user
op_star
id|data
comma
r_int
id|count
comma
r_int
id|client
)paren
(brace
id|soundfont_patch_info_t
id|patch
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
(paren
r_int
)paren
r_sizeof
(paren
id|patch
)paren
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;patch record too small %ld&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|patch
comma
id|data
comma
r_sizeof
(paren
id|patch
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|count
op_sub_assign
r_sizeof
(paren
id|patch
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
id|patch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|patch.key
op_ne
id|SNDRV_OSS_SOUNDFONT_PATCH
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;&squot;The wrong kind of patch&squot; %x&bslash;n&quot;
comma
id|patch.key
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
id|patch.len
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;Patch too short %ld, need %d&bslash;n&quot;
comma
id|count
comma
id|patch.len
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|patch.len
OL
l_int|0
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;poor length %d&bslash;n&quot;
comma
id|patch.len
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|patch.type
op_eq
id|SNDRV_SFNT_OPEN_PATCH
)paren
(brace
multiline_comment|/* grab sflist to open */
id|lock_preset
c_func
(paren
id|sflist
comma
l_int|0
)paren
suffix:semicolon
id|rc
op_assign
id|open_patch
c_func
(paren
id|sflist
comma
id|data
comma
id|count
comma
id|client
)paren
suffix:semicolon
id|unlock_preset
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* check if other client already opened patch */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sflist-&gt;open_client
op_ne
id|client
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|lock_preset
c_func
(paren
id|sflist
comma
l_int|0
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|patch.type
)paren
(brace
r_case
id|SNDRV_SFNT_LOAD_INFO
suffix:colon
id|rc
op_assign
id|load_info
c_func
(paren
id|sflist
comma
id|data
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SFNT_LOAD_DATA
suffix:colon
id|rc
op_assign
id|load_data
c_func
(paren
id|sflist
comma
id|data
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SFNT_CLOSE_PATCH
suffix:colon
id|rc
op_assign
id|close_patch
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SFNT_REPLACE_DATA
suffix:colon
multiline_comment|/*rc = replace_data(&amp;patch, data, count);*/
r_break
suffix:semicolon
r_case
id|SNDRV_SFNT_MAP_PRESET
suffix:colon
id|rc
op_assign
id|load_map
c_func
(paren
id|sflist
comma
id|data
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SFNT_PROBE_DATA
suffix:colon
id|rc
op_assign
id|probe_data
c_func
(paren
id|sflist
comma
id|patch.optarg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_SFNT_REMOVE_INFO
suffix:colon
multiline_comment|/* patch must be opened */
r_if
c_cond
(paren
id|sflist-&gt;currsf
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;soundfont: remove_info: patch not opened&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_int
id|bank
comma
id|instr
suffix:semicolon
id|bank
op_assign
(paren
(paren
r_int
r_int
)paren
id|patch.optarg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|instr
op_assign
(paren
r_int
r_int
)paren
id|patch.optarg
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|remove_info
c_func
(paren
id|sflist
comma
id|sflist-&gt;currsf
comma
id|bank
comma
id|instr
)paren
)paren
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|unlock_preset
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* check if specified type is special font (GUS or preset-alias) */
r_static
r_inline
r_int
DECL|function|is_special_type
id|is_special_type
c_func
(paren
r_int
id|type
)paren
(brace
id|type
op_and_assign
l_int|0x0f
suffix:semicolon
r_return
(paren
id|type
op_eq
id|SNDRV_SFNT_PAT_TYPE_GUS
op_logical_or
id|type
op_eq
id|SNDRV_SFNT_PAT_TYPE_MAP
)paren
suffix:semicolon
)brace
multiline_comment|/* open patch; create sf list */
r_static
r_int
DECL|function|open_patch
id|open_patch
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_char
id|__user
op_star
id|data
comma
r_int
id|count
comma
r_int
id|client
)paren
(brace
id|soundfont_open_parm_t
id|parm
suffix:semicolon
id|snd_soundfont_t
op_star
id|sf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sflist-&gt;open_client
op_ge
l_int|0
op_logical_or
id|sflist-&gt;currsf
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sflist-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|parm
comma
id|data
comma
r_sizeof
(paren
id|parm
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|is_special_type
c_func
(paren
id|parm.type
)paren
)paren
(brace
id|parm.type
op_or_assign
id|SNDRV_SFNT_PAT_SHARED
suffix:semicolon
id|sf
op_assign
id|newsf
c_func
(paren
id|sflist
comma
id|parm.type
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
id|sf
op_assign
id|newsf
c_func
(paren
id|sflist
comma
id|parm.type
comma
id|parm.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sf
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|sflist-&gt;open_client
op_assign
id|client
suffix:semicolon
id|sflist-&gt;currsf
op_assign
id|sf
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new soundfont structure.&n; */
r_static
id|snd_soundfont_t
op_star
DECL|function|newsf
id|newsf
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
id|type
comma
r_char
op_star
id|name
)paren
(brace
id|snd_soundfont_t
op_star
id|sf
suffix:semicolon
multiline_comment|/* check the shared fonts */
r_if
c_cond
(paren
id|type
op_amp
id|SNDRV_SFNT_PAT_SHARED
)paren
(brace
r_for
c_loop
(paren
id|sf
op_assign
id|sflist-&gt;fonts
suffix:semicolon
id|sf
suffix:semicolon
id|sf
op_assign
id|sf-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|is_identical_font
c_func
(paren
id|sf
comma
id|type
comma
id|name
)paren
)paren
(brace
r_return
id|sf
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* not found -- create a new one */
id|sf
op_assign
(paren
id|snd_soundfont_t
op_star
)paren
id|snd_kcalloc
c_func
(paren
r_sizeof
(paren
op_star
id|sf
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sf
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|sf-&gt;id
op_assign
id|sflist-&gt;fonts_size
suffix:semicolon
id|sflist-&gt;fonts_size
op_increment
suffix:semicolon
multiline_comment|/* prepend this record */
id|sf-&gt;next
op_assign
id|sflist-&gt;fonts
suffix:semicolon
id|sflist-&gt;fonts
op_assign
id|sf
suffix:semicolon
id|sf-&gt;type
op_assign
id|type
suffix:semicolon
id|sf-&gt;zones
op_assign
l_int|NULL
suffix:semicolon
id|sf-&gt;samples
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|name
)paren
id|memcpy
c_func
(paren
id|sf-&gt;name
comma
id|name
comma
id|SNDRV_SFNT_PATCH_NAME_LEN
)paren
suffix:semicolon
r_return
id|sf
suffix:semicolon
)brace
multiline_comment|/* check if the given name matches to the existing list */
r_static
r_int
DECL|function|is_identical_font
id|is_identical_font
c_func
(paren
id|snd_soundfont_t
op_star
id|sf
comma
r_int
id|type
comma
r_int
r_char
op_star
id|name
)paren
(brace
r_return
(paren
(paren
id|sf-&gt;type
op_amp
id|SNDRV_SFNT_PAT_SHARED
)paren
op_logical_and
(paren
id|sf-&gt;type
op_amp
l_int|0x0f
)paren
op_eq
(paren
id|type
op_amp
l_int|0x0f
)paren
op_logical_and
(paren
id|name
op_eq
l_int|NULL
op_logical_or
id|memcmp
c_func
(paren
id|sf-&gt;name
comma
id|name
comma
id|SNDRV_SFNT_PATCH_NAME_LEN
)paren
op_eq
l_int|0
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Close the current patch.&n; */
r_static
r_int
DECL|function|close_patch
id|close_patch
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
id|sflist-&gt;currsf
op_assign
l_int|NULL
suffix:semicolon
id|sflist-&gt;open_client
op_assign
op_minus
l_int|1
suffix:semicolon
id|rebuild_presets
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* probe sample in the current list -- nothing to be loaded */
r_static
r_int
DECL|function|probe_data
id|probe_data
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
id|sample_id
)paren
(brace
multiline_comment|/* patch must be opened */
r_if
c_cond
(paren
id|sflist-&gt;currsf
)paren
(brace
multiline_comment|/* search the specified sample by optarg */
r_if
c_cond
(paren
id|find_sample
c_func
(paren
id|sflist-&gt;currsf
comma
id|sample_id
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * increment zone counter&n; */
r_static
r_void
DECL|function|set_zone_counter
id|set_zone_counter
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
comma
id|snd_sf_zone_t
op_star
id|zp
)paren
(brace
id|zp-&gt;counter
op_assign
id|sflist-&gt;zone_counter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sf-&gt;type
op_amp
id|SNDRV_SFNT_PAT_LOCKED
)paren
id|sflist-&gt;zone_locked
op_assign
id|sflist-&gt;zone_counter
suffix:semicolon
)brace
multiline_comment|/*&n; * allocate a new zone record&n; */
r_static
id|snd_sf_zone_t
op_star
DECL|function|sf_zone_new
id|sf_zone_new
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
)paren
(brace
id|snd_sf_zone_t
op_star
id|zp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|zp
op_assign
id|snd_kcalloc
c_func
(paren
r_sizeof
(paren
op_star
id|zp
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|zp-&gt;next
op_assign
id|sf-&gt;zones
suffix:semicolon
id|sf-&gt;zones
op_assign
id|zp
suffix:semicolon
id|init_voice_info
c_func
(paren
op_amp
id|zp-&gt;v
)paren
suffix:semicolon
id|set_zone_counter
c_func
(paren
id|sflist
comma
id|sf
comma
id|zp
)paren
suffix:semicolon
r_return
id|zp
suffix:semicolon
)brace
multiline_comment|/*&n; * increment sample couter&n; */
r_static
r_void
DECL|function|set_sample_counter
id|set_sample_counter
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
comma
id|snd_sf_sample_t
op_star
id|sp
)paren
(brace
id|sp-&gt;counter
op_assign
id|sflist-&gt;sample_counter
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|sf-&gt;type
op_amp
id|SNDRV_SFNT_PAT_LOCKED
)paren
id|sflist-&gt;sample_locked
op_assign
id|sflist-&gt;sample_counter
suffix:semicolon
)brace
multiline_comment|/*&n; * allocate a new sample list record&n; */
r_static
id|snd_sf_sample_t
op_star
DECL|function|sf_sample_new
id|sf_sample_new
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
)paren
(brace
id|snd_sf_sample_t
op_star
id|sp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp
op_assign
id|snd_kcalloc
c_func
(paren
r_sizeof
(paren
op_star
id|sp
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|sp-&gt;next
op_assign
id|sf-&gt;samples
suffix:semicolon
id|sf-&gt;samples
op_assign
id|sp
suffix:semicolon
id|set_sample_counter
c_func
(paren
id|sflist
comma
id|sf
comma
id|sp
)paren
suffix:semicolon
r_return
id|sp
suffix:semicolon
)brace
multiline_comment|/*&n; * delete sample list -- this is an exceptional job.&n; * only the last allocated sample can be deleted.&n; */
r_static
r_void
DECL|function|sf_sample_delete
id|sf_sample_delete
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
comma
id|snd_sf_sample_t
op_star
id|sp
)paren
(brace
multiline_comment|/* only last sample is accepted */
r_if
c_cond
(paren
id|sp
op_eq
id|sf-&gt;samples
)paren
(brace
id|sf-&gt;samples
op_assign
id|sp-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* load voice map */
r_static
r_int
DECL|function|load_map
id|load_map
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_void
id|__user
op_star
id|data
comma
r_int
id|count
)paren
(brace
id|snd_sf_zone_t
op_star
id|zp
comma
op_star
id|prevp
suffix:semicolon
id|snd_soundfont_t
op_star
id|sf
suffix:semicolon
id|soundfont_voice_map_t
id|map
suffix:semicolon
multiline_comment|/* get the link info */
r_if
c_cond
(paren
id|count
OL
(paren
r_int
)paren
r_sizeof
(paren
id|map
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|map
comma
id|data
comma
r_sizeof
(paren
id|map
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|map.map_instr
OL
l_int|0
op_logical_or
id|map.map_instr
op_ge
id|SF_MAX_INSTRUMENTS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sf
op_assign
id|newsf
c_func
(paren
id|sflist
comma
id|SNDRV_SFNT_PAT_TYPE_MAP
op_or
id|SNDRV_SFNT_PAT_SHARED
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|prevp
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|zp
op_assign
id|sf-&gt;zones
suffix:semicolon
id|zp
suffix:semicolon
id|prevp
op_assign
id|zp
comma
id|zp
op_assign
id|zp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|zp-&gt;mapped
op_logical_and
id|zp-&gt;instr
op_eq
id|map.map_instr
op_logical_and
id|zp-&gt;bank
op_eq
id|map.map_bank
op_logical_and
id|zp-&gt;v.low
op_eq
id|map.map_key
op_logical_and
id|zp-&gt;v.start
op_eq
id|map.src_instr
op_logical_and
id|zp-&gt;v.end
op_eq
id|map.src_bank
op_logical_and
id|zp-&gt;v.fixkey
op_eq
id|map.src_key
)paren
(brace
multiline_comment|/* the same mapping is already present */
multiline_comment|/* relink this record to the link head */
r_if
c_cond
(paren
id|prevp
)paren
(brace
id|prevp-&gt;next
op_assign
id|zp-&gt;next
suffix:semicolon
id|zp-&gt;next
op_assign
id|sf-&gt;zones
suffix:semicolon
id|sf-&gt;zones
op_assign
id|zp
suffix:semicolon
)brace
multiline_comment|/* update the counter */
id|set_zone_counter
c_func
(paren
id|sflist
comma
id|sf
comma
id|zp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* create a new zone */
r_if
c_cond
(paren
(paren
id|zp
op_assign
id|sf_zone_new
c_func
(paren
id|sflist
comma
id|sf
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|zp-&gt;bank
op_assign
id|map.map_bank
suffix:semicolon
id|zp-&gt;instr
op_assign
id|map.map_instr
suffix:semicolon
id|zp-&gt;mapped
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|map.map_key
op_ge
l_int|0
)paren
(brace
id|zp-&gt;v.low
op_assign
id|map.map_key
suffix:semicolon
id|zp-&gt;v.high
op_assign
id|map.map_key
suffix:semicolon
)brace
id|zp-&gt;v.start
op_assign
id|map.src_instr
suffix:semicolon
id|zp-&gt;v.end
op_assign
id|map.src_bank
suffix:semicolon
id|zp-&gt;v.fixkey
op_assign
id|map.src_key
suffix:semicolon
id|zp-&gt;v.sf_id
op_assign
id|sf-&gt;id
suffix:semicolon
id|add_preset
c_func
(paren
id|sflist
comma
id|zp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* remove the present instrument layers */
r_static
r_int
DECL|function|remove_info
id|remove_info
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_soundfont_t
op_star
id|sf
comma
r_int
id|bank
comma
r_int
id|instr
)paren
(brace
id|snd_sf_zone_t
op_star
id|prev
comma
op_star
id|next
comma
op_star
id|p
suffix:semicolon
r_int
id|removed
op_assign
l_int|0
suffix:semicolon
id|prev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|sf-&gt;zones
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|next
)paren
(brace
id|next
op_assign
id|p-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;mapped
op_logical_and
id|p-&gt;bank
op_eq
id|bank
op_logical_and
id|p-&gt;instr
op_eq
id|instr
)paren
(brace
multiline_comment|/* remove this layer */
r_if
c_cond
(paren
id|prev
)paren
id|prev-&gt;next
op_assign
id|next
suffix:semicolon
r_else
id|sf-&gt;zones
op_assign
id|next
suffix:semicolon
id|removed
op_increment
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
r_else
id|prev
op_assign
id|p
suffix:semicolon
)brace
r_if
c_cond
(paren
id|removed
)paren
id|rebuild_presets
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
id|removed
suffix:semicolon
)brace
multiline_comment|/*&n; * Read an info record from the user buffer and save it on the current&n; * open soundfont.&n; */
r_static
r_int
DECL|function|load_info
id|load_info
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_void
id|__user
op_star
id|data
comma
r_int
id|count
)paren
(brace
id|snd_soundfont_t
op_star
id|sf
suffix:semicolon
id|snd_sf_zone_t
op_star
id|zone
suffix:semicolon
id|soundfont_voice_rec_hdr_t
id|hdr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* patch must be opened */
r_if
c_cond
(paren
(paren
id|sf
op_assign
id|sflist-&gt;currsf
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|is_special_type
c_func
(paren
id|sf-&gt;type
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
(paren
r_int
)paren
r_sizeof
(paren
id|hdr
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Soundfont error: invalid patch zone length&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|hdr
comma
id|data
comma
r_sizeof
(paren
id|hdr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
id|hdr
)paren
suffix:semicolon
id|count
op_sub_assign
r_sizeof
(paren
id|hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdr.nvoices
op_le
l_int|0
op_logical_or
id|hdr.nvoices
op_ge
l_int|100
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Soundfont error: Illegal voice number %d&bslash;n&quot;
comma
id|hdr.nvoices
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
(paren
r_int
)paren
r_sizeof
(paren
id|soundfont_voice_info_t
)paren
op_star
id|hdr.nvoices
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Soundfont Error: patch length(%ld) is smaller than nvoices(%d)&bslash;n&quot;
comma
id|count
comma
id|hdr.nvoices
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|hdr.write_mode
)paren
(brace
r_case
id|SNDRV_SFNT_WR_EXCLUSIVE
suffix:colon
multiline_comment|/* exclusive mode - if the instrument already exists,&n;&t;&t;   return error */
r_for
c_loop
(paren
id|zone
op_assign
id|sf-&gt;zones
suffix:semicolon
id|zone
suffix:semicolon
id|zone
op_assign
id|zone-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|zone-&gt;mapped
op_logical_and
id|zone-&gt;bank
op_eq
id|hdr.bank
op_logical_and
id|zone-&gt;instr
op_eq
id|hdr.instr
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SNDRV_SFNT_WR_REPLACE
suffix:colon
multiline_comment|/* replace mode - remove the instrument if it already exists */
id|remove_info
c_func
(paren
id|sflist
comma
id|sf
comma
id|hdr.bank
comma
id|hdr.instr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hdr.nvoices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|snd_sf_zone_t
id|tmpzone
suffix:semicolon
multiline_comment|/* copy awe_voice_info parameters */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|tmpzone.v
comma
id|data
comma
r_sizeof
(paren
id|tmpzone.v
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|data
op_add_assign
r_sizeof
(paren
id|tmpzone.v
)paren
suffix:semicolon
id|count
op_sub_assign
r_sizeof
(paren
id|tmpzone.v
)paren
suffix:semicolon
id|tmpzone.bank
op_assign
id|hdr.bank
suffix:semicolon
id|tmpzone.instr
op_assign
id|hdr.instr
suffix:semicolon
id|tmpzone.mapped
op_assign
l_int|0
suffix:semicolon
id|tmpzone.v.sf_id
op_assign
id|sf-&gt;id
suffix:semicolon
r_if
c_cond
(paren
id|tmpzone.v.mode
op_amp
id|SNDRV_SFNT_MODE_INIT_PARM
)paren
id|init_voice_parm
c_func
(paren
op_amp
id|tmpzone.v.parm
)paren
suffix:semicolon
multiline_comment|/* create a new zone */
r_if
c_cond
(paren
(paren
id|zone
op_assign
id|sf_zone_new
c_func
(paren
id|sflist
comma
id|sf
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* copy the temporary data */
id|zone-&gt;bank
op_assign
id|tmpzone.bank
suffix:semicolon
id|zone-&gt;instr
op_assign
id|tmpzone.instr
suffix:semicolon
id|zone-&gt;v
op_assign
id|tmpzone.v
suffix:semicolon
multiline_comment|/* look up the sample */
id|zone-&gt;sample
op_assign
id|set_sample
c_func
(paren
id|sf
comma
op_amp
id|zone-&gt;v
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* initialize voice_info record */
r_static
r_void
DECL|function|init_voice_info
id|init_voice_info
c_func
(paren
id|soundfont_voice_info_t
op_star
id|avp
)paren
(brace
id|memset
c_func
(paren
id|avp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|avp
)paren
)paren
suffix:semicolon
id|avp-&gt;root
op_assign
l_int|60
suffix:semicolon
id|avp-&gt;high
op_assign
l_int|127
suffix:semicolon
id|avp-&gt;velhigh
op_assign
l_int|127
suffix:semicolon
id|avp-&gt;fixkey
op_assign
op_minus
l_int|1
suffix:semicolon
id|avp-&gt;fixvel
op_assign
op_minus
l_int|1
suffix:semicolon
id|avp-&gt;fixpan
op_assign
op_minus
l_int|1
suffix:semicolon
id|avp-&gt;pan
op_assign
op_minus
l_int|1
suffix:semicolon
id|avp-&gt;amplitude
op_assign
l_int|127
suffix:semicolon
id|avp-&gt;scaleTuning
op_assign
l_int|100
suffix:semicolon
id|init_voice_parm
c_func
(paren
op_amp
id|avp-&gt;parm
)paren
suffix:semicolon
)brace
multiline_comment|/* initialize voice_parm record:&n; * Env1/2: delay=0, attack=0, hold=0, sustain=0, decay=0, release=0.&n; * Vibrato and Tremolo effects are zero.&n; * Cutoff is maximum.&n; * Chorus and Reverb effects are zero.&n; */
r_static
r_void
DECL|function|init_voice_parm
id|init_voice_parm
c_func
(paren
id|soundfont_voice_parm_t
op_star
id|pp
)paren
(brace
id|memset
c_func
(paren
id|pp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pp
)paren
)paren
suffix:semicolon
id|pp-&gt;moddelay
op_assign
l_int|0x8000
suffix:semicolon
id|pp-&gt;modatkhld
op_assign
l_int|0x7f7f
suffix:semicolon
id|pp-&gt;moddcysus
op_assign
l_int|0x7f7f
suffix:semicolon
id|pp-&gt;modrelease
op_assign
l_int|0x807f
suffix:semicolon
id|pp-&gt;voldelay
op_assign
l_int|0x8000
suffix:semicolon
id|pp-&gt;volatkhld
op_assign
l_int|0x7f7f
suffix:semicolon
id|pp-&gt;voldcysus
op_assign
l_int|0x7f7f
suffix:semicolon
id|pp-&gt;volrelease
op_assign
l_int|0x807f
suffix:semicolon
id|pp-&gt;lfo1delay
op_assign
l_int|0x8000
suffix:semicolon
id|pp-&gt;lfo2delay
op_assign
l_int|0x8000
suffix:semicolon
id|pp-&gt;cutoff
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* search the specified sample */
r_static
id|snd_sf_sample_t
op_star
DECL|function|set_sample
id|set_sample
c_func
(paren
id|snd_soundfont_t
op_star
id|sf
comma
id|soundfont_voice_info_t
op_star
id|avp
)paren
(brace
id|snd_sf_sample_t
op_star
id|sample
suffix:semicolon
id|sample
op_assign
id|find_sample
c_func
(paren
id|sf
comma
id|avp-&gt;sample
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sample
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* add in the actual sample offsets:&n;&t; * The voice_info addresses define only the relative offset&n;&t; * from sample pointers.  Here we calculate the actual DRAM&n;&t; * offset from sample pointers.&n;&t; */
id|avp-&gt;start
op_add_assign
id|sample-&gt;v.start
suffix:semicolon
id|avp-&gt;end
op_add_assign
id|sample-&gt;v.end
suffix:semicolon
id|avp-&gt;loopstart
op_add_assign
id|sample-&gt;v.loopstart
suffix:semicolon
id|avp-&gt;loopend
op_add_assign
id|sample-&gt;v.loopend
suffix:semicolon
multiline_comment|/* copy mode flags */
id|avp-&gt;sample_mode
op_assign
id|sample-&gt;v.mode_flags
suffix:semicolon
r_return
id|sample
suffix:semicolon
)brace
multiline_comment|/* find the sample pointer with the given id in the soundfont */
r_static
id|snd_sf_sample_t
op_star
DECL|function|find_sample
id|find_sample
c_func
(paren
id|snd_soundfont_t
op_star
id|sf
comma
r_int
id|sample_id
)paren
(brace
id|snd_sf_sample_t
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|sf
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|sf-&gt;samples
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;v.sample
op_eq
id|sample_id
)paren
r_return
id|p
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Load sample information, this can include data to be loaded onto&n; * the soundcard.  It can also just be a pointer into soundcard ROM.&n; * If there is data it will be written to the soundcard via the callback&n; * routine.&n; */
r_static
r_int
DECL|function|load_data
id|load_data
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_void
id|__user
op_star
id|data
comma
r_int
id|count
)paren
(brace
id|snd_soundfont_t
op_star
id|sf
suffix:semicolon
id|soundfont_sample_info_t
id|sample_info
suffix:semicolon
id|snd_sf_sample_t
op_star
id|sp
suffix:semicolon
r_int
id|off
suffix:semicolon
multiline_comment|/* patch must be opened */
r_if
c_cond
(paren
(paren
id|sf
op_assign
id|sflist-&gt;currsf
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|is_special_type
c_func
(paren
id|sf-&gt;type
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|sample_info
comma
id|data
comma
r_sizeof
(paren
id|sample_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|off
op_assign
r_sizeof
(paren
id|sample_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sample_info.size
op_ne
(paren
id|count
op_minus
id|off
)paren
op_div
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Check for dup */
r_if
c_cond
(paren
id|find_sample
c_func
(paren
id|sf
comma
id|sample_info.sample
)paren
)paren
(brace
multiline_comment|/* if shared sample, skip this data */
r_if
c_cond
(paren
id|sf-&gt;type
op_amp
id|SNDRV_SFNT_PAT_SHARED
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Allocate a new sample structure */
r_if
c_cond
(paren
(paren
id|sp
op_assign
id|sf_sample_new
c_func
(paren
id|sflist
comma
id|sf
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sp-&gt;v
op_assign
id|sample_info
suffix:semicolon
id|sp-&gt;v.sf_id
op_assign
id|sf-&gt;id
suffix:semicolon
id|sp-&gt;v.dummy
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;v.truesize
op_assign
id|sp-&gt;v.size
suffix:semicolon
multiline_comment|/*&n;&t; * If there is wave data then load it.&n;&t; */
r_if
c_cond
(paren
id|sp-&gt;v.size
OG
l_int|0
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|sflist-&gt;callback.sample_new
(paren
id|sflist-&gt;callback.private_data
comma
id|sp
comma
id|sflist-&gt;memhdr
comma
id|data
op_plus
id|off
comma
id|count
op_minus
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|sf_sample_delete
c_func
(paren
id|sflist
comma
id|sf
comma
id|sp
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|sflist-&gt;mem_used
op_add_assign
id|sp-&gt;v.truesize
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* log2_tbl[i] = log2(i+128) * 0x10000 */
DECL|variable|log_tbl
r_static
r_int
id|log_tbl
(braket
l_int|129
)braket
op_assign
(brace
l_int|0x70000
comma
l_int|0x702df
comma
l_int|0x705b9
comma
l_int|0x7088e
comma
l_int|0x70b5d
comma
l_int|0x70e26
comma
l_int|0x710eb
comma
l_int|0x713aa
comma
l_int|0x71663
comma
l_int|0x71918
comma
l_int|0x71bc8
comma
l_int|0x71e72
comma
l_int|0x72118
comma
l_int|0x723b9
comma
l_int|0x72655
comma
l_int|0x728ed
comma
l_int|0x72b80
comma
l_int|0x72e0e
comma
l_int|0x73098
comma
l_int|0x7331d
comma
l_int|0x7359e
comma
l_int|0x7381b
comma
l_int|0x73a93
comma
l_int|0x73d08
comma
l_int|0x73f78
comma
l_int|0x741e4
comma
l_int|0x7444c
comma
l_int|0x746b0
comma
l_int|0x74910
comma
l_int|0x74b6c
comma
l_int|0x74dc4
comma
l_int|0x75019
comma
l_int|0x75269
comma
l_int|0x754b6
comma
l_int|0x75700
comma
l_int|0x75946
comma
l_int|0x75b88
comma
l_int|0x75dc7
comma
l_int|0x76002
comma
l_int|0x7623a
comma
l_int|0x7646e
comma
l_int|0x766a0
comma
l_int|0x768cd
comma
l_int|0x76af8
comma
l_int|0x76d1f
comma
l_int|0x76f43
comma
l_int|0x77164
comma
l_int|0x77382
comma
l_int|0x7759d
comma
l_int|0x777b4
comma
l_int|0x779c9
comma
l_int|0x77bdb
comma
l_int|0x77dea
comma
l_int|0x77ff5
comma
l_int|0x781fe
comma
l_int|0x78404
comma
l_int|0x78608
comma
l_int|0x78808
comma
l_int|0x78a06
comma
l_int|0x78c01
comma
l_int|0x78df9
comma
l_int|0x78fef
comma
l_int|0x791e2
comma
l_int|0x793d2
comma
l_int|0x795c0
comma
l_int|0x797ab
comma
l_int|0x79993
comma
l_int|0x79b79
comma
l_int|0x79d5d
comma
l_int|0x79f3e
comma
l_int|0x7a11d
comma
l_int|0x7a2f9
comma
l_int|0x7a4d3
comma
l_int|0x7a6ab
comma
l_int|0x7a880
comma
l_int|0x7aa53
comma
l_int|0x7ac24
comma
l_int|0x7adf2
comma
l_int|0x7afbe
comma
l_int|0x7b188
comma
l_int|0x7b350
comma
l_int|0x7b515
comma
l_int|0x7b6d8
comma
l_int|0x7b899
comma
l_int|0x7ba58
comma
l_int|0x7bc15
comma
l_int|0x7bdd0
comma
l_int|0x7bf89
comma
l_int|0x7c140
comma
l_int|0x7c2f5
comma
l_int|0x7c4a7
comma
l_int|0x7c658
comma
l_int|0x7c807
comma
l_int|0x7c9b3
comma
l_int|0x7cb5e
comma
l_int|0x7cd07
comma
l_int|0x7ceae
comma
l_int|0x7d053
comma
l_int|0x7d1f7
comma
l_int|0x7d398
comma
l_int|0x7d538
comma
l_int|0x7d6d6
comma
l_int|0x7d872
comma
l_int|0x7da0c
comma
l_int|0x7dba4
comma
l_int|0x7dd3b
comma
l_int|0x7ded0
comma
l_int|0x7e063
comma
l_int|0x7e1f4
comma
l_int|0x7e384
comma
l_int|0x7e512
comma
l_int|0x7e69f
comma
l_int|0x7e829
comma
l_int|0x7e9b3
comma
l_int|0x7eb3a
comma
l_int|0x7ecc0
comma
l_int|0x7ee44
comma
l_int|0x7efc7
comma
l_int|0x7f148
comma
l_int|0x7f2c8
comma
l_int|0x7f446
comma
l_int|0x7f5c2
comma
l_int|0x7f73d
comma
l_int|0x7f8b7
comma
l_int|0x7fa2f
comma
l_int|0x7fba5
comma
l_int|0x7fd1a
comma
l_int|0x7fe8d
comma
l_int|0x80000
comma
)brace
suffix:semicolon
multiline_comment|/* convert from linear to log value&n; *&n; * conversion: value = log2(amount / base) * ratio&n; *&n; * argument:&n; *   amount = linear value (unsigned, 32bit max)&n; *   offset = base offset (:= log2(base) * 0x10000)&n; *   ratio = division ratio&n; *&n; */
r_int
DECL|function|snd_sf_linear_to_log
id|snd_sf_linear_to_log
c_func
(paren
r_int
r_int
id|amount
comma
r_int
id|offset
comma
r_int
id|ratio
)paren
(brace
r_int
id|v
suffix:semicolon
r_int
id|s
comma
id|low
comma
id|bit
suffix:semicolon
r_if
c_cond
(paren
id|amount
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|bit
op_assign
l_int|0
suffix:semicolon
op_logical_neg
(paren
id|amount
op_amp
l_int|0x80000000L
)paren
suffix:semicolon
id|bit
op_increment
)paren
id|amount
op_lshift_assign
l_int|1
suffix:semicolon
id|s
op_assign
(paren
id|amount
op_rshift
l_int|24
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|low
op_assign
(paren
id|amount
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* linear approxmimation by lower 8 bit */
id|v
op_assign
(paren
id|log_tbl
(braket
id|s
op_plus
l_int|1
)braket
op_star
id|low
op_plus
id|log_tbl
(braket
id|s
)braket
op_star
(paren
l_int|0x100
op_minus
id|low
)paren
)paren
op_rshift
l_int|8
suffix:semicolon
id|v
op_sub_assign
id|offset
suffix:semicolon
id|v
op_assign
(paren
id|v
op_star
id|ratio
)paren
op_rshift
l_int|16
suffix:semicolon
id|v
op_add_assign
(paren
l_int|24
op_minus
id|bit
)paren
op_star
id|ratio
suffix:semicolon
r_return
id|v
suffix:semicolon
)brace
DECL|macro|OFFSET_MSEC
mdefine_line|#define OFFSET_MSEC&t;&t;653117&t;&t;/* base = 1000 */
DECL|macro|OFFSET_ABSCENT
mdefine_line|#define OFFSET_ABSCENT&t;&t;851781&t;&t;/* base = 8176 */
DECL|macro|OFFSET_SAMPLERATE
mdefine_line|#define OFFSET_SAMPLERATE&t;1011119&t;&t;/* base = 44100 */
DECL|macro|ABSCENT_RATIO
mdefine_line|#define ABSCENT_RATIO&t;&t;1200
DECL|macro|TIMECENT_RATIO
mdefine_line|#define TIMECENT_RATIO&t;&t;1200
DECL|macro|SAMPLERATE_RATIO
mdefine_line|#define SAMPLERATE_RATIO&t;4096
multiline_comment|/*&n; * mHz to abscent&n; * conversion: abscent = log2(MHz / 8176) * 1200&n; */
r_static
r_int
DECL|function|freq_to_note
id|freq_to_note
c_func
(paren
r_int
id|mhz
)paren
(brace
r_return
id|snd_sf_linear_to_log
c_func
(paren
id|mhz
comma
id|OFFSET_ABSCENT
comma
id|ABSCENT_RATIO
)paren
suffix:semicolon
)brace
multiline_comment|/* convert Hz to AWE32 rate offset:&n; * sample pitch offset for the specified sample rate&n; * rate=44100 is no offset, each 4096 is 1 octave (twice).&n; * eg, when rate is 22050, this offset becomes -4096.&n; *&n; * conversion: offset = log2(Hz / 44100) * 4096&n; */
r_static
r_int
DECL|function|calc_rate_offset
id|calc_rate_offset
c_func
(paren
r_int
id|hz
)paren
(brace
r_return
id|snd_sf_linear_to_log
c_func
(paren
id|hz
comma
id|OFFSET_SAMPLERATE
comma
id|SAMPLERATE_RATIO
)paren
suffix:semicolon
)brace
multiline_comment|/* calculate GUS envelope time */
r_static
r_int
DECL|function|calc_gus_envelope_time
id|calc_gus_envelope_time
c_func
(paren
r_int
id|rate
comma
r_int
id|start
comma
r_int
id|end
)paren
(brace
r_int
id|r
comma
id|p
comma
id|t
suffix:semicolon
id|r
op_assign
(paren
l_int|3
op_minus
(paren
(paren
id|rate
op_rshift
l_int|6
)paren
op_amp
l_int|3
)paren
)paren
op_star
l_int|3
suffix:semicolon
id|p
op_assign
id|rate
op_amp
l_int|0x3f
suffix:semicolon
id|t
op_assign
id|end
op_minus
id|start
suffix:semicolon
r_if
c_cond
(paren
id|t
OL
l_int|0
)paren
id|t
op_assign
op_minus
id|t
suffix:semicolon
r_if
c_cond
(paren
l_int|13
OG
id|r
)paren
id|t
op_assign
id|t
op_lshift
(paren
l_int|13
op_minus
id|r
)paren
suffix:semicolon
r_else
id|t
op_assign
id|t
op_rshift
(paren
id|r
op_minus
l_int|13
)paren
suffix:semicolon
r_return
(paren
id|t
op_star
l_int|10
)paren
op_div
(paren
id|p
op_star
l_int|441
)paren
suffix:semicolon
)brace
multiline_comment|/* convert envelope time parameter to soundfont parameters */
multiline_comment|/* attack &amp; decay/release time table (msec) */
DECL|variable|attack_time_tbl
r_static
r_int
id|attack_time_tbl
(braket
l_int|128
)braket
op_assign
(brace
l_int|32767
comma
l_int|32767
comma
l_int|5989
comma
l_int|4235
comma
l_int|2994
comma
l_int|2518
comma
l_int|2117
comma
l_int|1780
comma
l_int|1497
comma
l_int|1373
comma
l_int|1259
comma
l_int|1154
comma
l_int|1058
comma
l_int|970
comma
l_int|890
comma
l_int|816
comma
l_int|707
comma
l_int|691
comma
l_int|662
comma
l_int|634
comma
l_int|607
comma
l_int|581
comma
l_int|557
comma
l_int|533
comma
l_int|510
comma
l_int|489
comma
l_int|468
comma
l_int|448
comma
l_int|429
comma
l_int|411
comma
l_int|393
comma
l_int|377
comma
l_int|361
comma
l_int|345
comma
l_int|331
comma
l_int|317
comma
l_int|303
comma
l_int|290
comma
l_int|278
comma
l_int|266
comma
l_int|255
comma
l_int|244
comma
l_int|234
comma
l_int|224
comma
l_int|214
comma
l_int|205
comma
l_int|196
comma
l_int|188
comma
l_int|180
comma
l_int|172
comma
l_int|165
comma
l_int|158
comma
l_int|151
comma
l_int|145
comma
l_int|139
comma
l_int|133
comma
l_int|127
comma
l_int|122
comma
l_int|117
comma
l_int|112
comma
l_int|107
comma
l_int|102
comma
l_int|98
comma
l_int|94
comma
l_int|90
comma
l_int|86
comma
l_int|82
comma
l_int|79
comma
l_int|75
comma
l_int|72
comma
l_int|69
comma
l_int|66
comma
l_int|63
comma
l_int|61
comma
l_int|58
comma
l_int|56
comma
l_int|53
comma
l_int|51
comma
l_int|49
comma
l_int|47
comma
l_int|45
comma
l_int|43
comma
l_int|41
comma
l_int|39
comma
l_int|37
comma
l_int|36
comma
l_int|34
comma
l_int|33
comma
l_int|31
comma
l_int|30
comma
l_int|29
comma
l_int|28
comma
l_int|26
comma
l_int|25
comma
l_int|24
comma
l_int|23
comma
l_int|22
comma
l_int|21
comma
l_int|20
comma
l_int|19
comma
l_int|19
comma
l_int|18
comma
l_int|17
comma
l_int|16
comma
l_int|16
comma
l_int|15
comma
l_int|15
comma
l_int|14
comma
l_int|13
comma
l_int|13
comma
l_int|12
comma
l_int|12
comma
l_int|11
comma
l_int|11
comma
l_int|10
comma
l_int|10
comma
l_int|10
comma
l_int|9
comma
l_int|9
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|6
comma
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|decay_time_tbl
r_static
r_int
id|decay_time_tbl
(braket
l_int|128
)braket
op_assign
(brace
l_int|32767
comma
l_int|32767
comma
l_int|22614
comma
l_int|15990
comma
l_int|11307
comma
l_int|9508
comma
l_int|7995
comma
l_int|6723
comma
l_int|5653
comma
l_int|5184
comma
l_int|4754
comma
l_int|4359
comma
l_int|3997
comma
l_int|3665
comma
l_int|3361
comma
l_int|3082
comma
l_int|2828
comma
l_int|2765
comma
l_int|2648
comma
l_int|2535
comma
l_int|2428
comma
l_int|2325
comma
l_int|2226
comma
l_int|2132
comma
l_int|2042
comma
l_int|1955
comma
l_int|1872
comma
l_int|1793
comma
l_int|1717
comma
l_int|1644
comma
l_int|1574
comma
l_int|1507
comma
l_int|1443
comma
l_int|1382
comma
l_int|1324
comma
l_int|1267
comma
l_int|1214
comma
l_int|1162
comma
l_int|1113
comma
l_int|1066
comma
l_int|978
comma
l_int|936
comma
l_int|897
comma
l_int|859
comma
l_int|822
comma
l_int|787
comma
l_int|754
comma
l_int|722
comma
l_int|691
comma
l_int|662
comma
l_int|634
comma
l_int|607
comma
l_int|581
comma
l_int|557
comma
l_int|533
comma
l_int|510
comma
l_int|489
comma
l_int|468
comma
l_int|448
comma
l_int|429
comma
l_int|411
comma
l_int|393
comma
l_int|377
comma
l_int|361
comma
l_int|345
comma
l_int|331
comma
l_int|317
comma
l_int|303
comma
l_int|290
comma
l_int|278
comma
l_int|266
comma
l_int|255
comma
l_int|244
comma
l_int|234
comma
l_int|224
comma
l_int|214
comma
l_int|205
comma
l_int|196
comma
l_int|188
comma
l_int|180
comma
l_int|172
comma
l_int|165
comma
l_int|158
comma
l_int|151
comma
l_int|145
comma
l_int|139
comma
l_int|133
comma
l_int|127
comma
l_int|122
comma
l_int|117
comma
l_int|112
comma
l_int|107
comma
l_int|102
comma
l_int|98
comma
l_int|94
comma
l_int|90
comma
l_int|86
comma
l_int|82
comma
l_int|79
comma
l_int|75
comma
l_int|72
comma
l_int|69
comma
l_int|66
comma
l_int|63
comma
l_int|61
comma
l_int|58
comma
l_int|56
comma
l_int|53
comma
l_int|51
comma
l_int|49
comma
l_int|47
comma
l_int|45
comma
l_int|43
comma
l_int|41
comma
l_int|39
comma
l_int|37
comma
l_int|36
comma
l_int|34
comma
l_int|33
comma
l_int|31
comma
l_int|30
comma
l_int|29
comma
l_int|28
comma
l_int|26
comma
l_int|25
comma
l_int|24
comma
l_int|23
comma
l_int|22
comma
)brace
suffix:semicolon
multiline_comment|/* delay time = 0x8000 - msec/92 */
r_int
DECL|function|snd_sf_calc_parm_hold
id|snd_sf_calc_parm_hold
c_func
(paren
r_int
id|msec
)paren
(brace
r_int
id|val
op_assign
(paren
l_int|0x7f
op_star
l_int|92
op_minus
id|msec
)paren
op_div
l_int|92
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|1
)paren
id|val
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|126
)paren
id|val
op_assign
l_int|126
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/* search an index for specified time from given time table */
r_static
r_int
DECL|function|calc_parm_search
id|calc_parm_search
c_func
(paren
r_int
id|msec
comma
r_int
op_star
id|table
)paren
(brace
r_int
id|left
op_assign
l_int|1
comma
id|right
op_assign
l_int|127
comma
id|mid
suffix:semicolon
r_while
c_loop
(paren
id|left
OL
id|right
)paren
(brace
id|mid
op_assign
(paren
id|left
op_plus
id|right
)paren
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|msec
OL
(paren
r_int
)paren
id|table
(braket
id|mid
)braket
)paren
id|left
op_assign
id|mid
op_plus
l_int|1
suffix:semicolon
r_else
id|right
op_assign
id|mid
suffix:semicolon
)brace
r_return
id|left
suffix:semicolon
)brace
multiline_comment|/* attack time: search from time table */
r_int
DECL|function|snd_sf_calc_parm_attack
id|snd_sf_calc_parm_attack
c_func
(paren
r_int
id|msec
)paren
(brace
r_return
id|calc_parm_search
c_func
(paren
id|msec
comma
id|attack_time_tbl
)paren
suffix:semicolon
)brace
multiline_comment|/* decay/release time: search from time table */
r_int
DECL|function|snd_sf_calc_parm_decay
id|snd_sf_calc_parm_decay
c_func
(paren
r_int
id|msec
)paren
(brace
r_return
id|calc_parm_search
c_func
(paren
id|msec
comma
id|decay_time_tbl
)paren
suffix:semicolon
)brace
DECL|variable|snd_sf_vol_table
r_int
id|snd_sf_vol_table
(braket
l_int|128
)braket
op_assign
(brace
l_int|255
comma
l_int|111
comma
l_int|95
comma
l_int|86
comma
l_int|79
comma
l_int|74
comma
l_int|70
comma
l_int|66
comma
l_int|63
comma
l_int|61
comma
l_int|58
comma
l_int|56
comma
l_int|54
comma
l_int|52
comma
l_int|50
comma
l_int|49
comma
l_int|47
comma
l_int|46
comma
l_int|45
comma
l_int|43
comma
l_int|42
comma
l_int|41
comma
l_int|40
comma
l_int|39
comma
l_int|38
comma
l_int|37
comma
l_int|36
comma
l_int|35
comma
l_int|34
comma
l_int|34
comma
l_int|33
comma
l_int|32
comma
l_int|31
comma
l_int|31
comma
l_int|30
comma
l_int|29
comma
l_int|29
comma
l_int|28
comma
l_int|27
comma
l_int|27
comma
l_int|26
comma
l_int|26
comma
l_int|25
comma
l_int|24
comma
l_int|24
comma
l_int|23
comma
l_int|23
comma
l_int|22
comma
l_int|22
comma
l_int|21
comma
l_int|21
comma
l_int|21
comma
l_int|20
comma
l_int|20
comma
l_int|19
comma
l_int|19
comma
l_int|18
comma
l_int|18
comma
l_int|18
comma
l_int|17
comma
l_int|17
comma
l_int|16
comma
l_int|16
comma
l_int|16
comma
l_int|15
comma
l_int|15
comma
l_int|15
comma
l_int|14
comma
l_int|14
comma
l_int|14
comma
l_int|13
comma
l_int|13
comma
l_int|13
comma
l_int|12
comma
l_int|12
comma
l_int|12
comma
l_int|11
comma
l_int|11
comma
l_int|11
comma
l_int|10
comma
l_int|10
comma
l_int|10
comma
l_int|10
comma
l_int|9
comma
l_int|9
comma
l_int|9
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|8
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|7
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|6
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|5
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|4
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|3
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
)brace
suffix:semicolon
DECL|macro|calc_gus_sustain
mdefine_line|#define calc_gus_sustain(val)  (0x7f - snd_sf_vol_table[(val)/2])
DECL|macro|calc_gus_attenuation
mdefine_line|#define calc_gus_attenuation(val)&t;snd_sf_vol_table[(val)/2]
multiline_comment|/* load GUS patch */
r_static
r_int
DECL|function|load_guspatch
id|load_guspatch
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_char
id|__user
op_star
id|data
comma
r_int
id|count
comma
r_int
id|client
)paren
(brace
r_struct
id|patch_info
id|patch
suffix:semicolon
id|snd_soundfont_t
op_star
id|sf
suffix:semicolon
id|snd_sf_zone_t
op_star
id|zone
suffix:semicolon
id|snd_sf_sample_t
op_star
id|smp
suffix:semicolon
r_int
id|note
comma
id|sample_id
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
(paren
r_int
)paren
r_sizeof
(paren
id|patch
)paren
)paren
(brace
id|snd_printk
c_func
(paren
l_string|&quot;patch record too small %ld&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|patch
comma
id|data
comma
r_sizeof
(paren
id|patch
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|count
op_sub_assign
r_sizeof
(paren
id|patch
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
id|patch
)paren
suffix:semicolon
id|sf
op_assign
id|newsf
c_func
(paren
id|sflist
comma
id|SNDRV_SFNT_PAT_TYPE_GUS
op_or
id|SNDRV_SFNT_PAT_SHARED
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|smp
op_assign
id|sf_sample_new
c_func
(paren
id|sflist
comma
id|sf
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sample_id
op_assign
id|sflist-&gt;sample_counter
suffix:semicolon
id|smp-&gt;v.sample
op_assign
id|sample_id
suffix:semicolon
id|smp-&gt;v.start
op_assign
l_int|0
suffix:semicolon
id|smp-&gt;v.end
op_assign
id|patch.len
suffix:semicolon
id|smp-&gt;v.loopstart
op_assign
id|patch.loop_start
suffix:semicolon
id|smp-&gt;v.loopend
op_assign
id|patch.loop_end
suffix:semicolon
id|smp-&gt;v.size
op_assign
id|patch.len
suffix:semicolon
multiline_comment|/* set up mode flags */
id|smp-&gt;v.mode_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|patch.mode
op_amp
id|WAVE_16_BITS
)paren
)paren
id|smp-&gt;v.mode_flags
op_or_assign
id|SNDRV_SFNT_SAMPLE_8BITS
suffix:semicolon
r_if
c_cond
(paren
id|patch.mode
op_amp
id|WAVE_UNSIGNED
)paren
id|smp-&gt;v.mode_flags
op_or_assign
id|SNDRV_SFNT_SAMPLE_UNSIGNED
suffix:semicolon
id|smp-&gt;v.mode_flags
op_or_assign
id|SNDRV_SFNT_SAMPLE_NO_BLANK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|patch.mode
op_amp
(paren
id|WAVE_LOOPING
op_or
id|WAVE_BIDIR_LOOP
op_or
id|WAVE_LOOP_BACK
)paren
)paren
)paren
id|smp-&gt;v.mode_flags
op_or_assign
id|SNDRV_SFNT_SAMPLE_SINGLESHOT
suffix:semicolon
r_if
c_cond
(paren
id|patch.mode
op_amp
id|WAVE_BIDIR_LOOP
)paren
id|smp-&gt;v.mode_flags
op_or_assign
id|SNDRV_SFNT_SAMPLE_BIDIR_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|patch.mode
op_amp
id|WAVE_LOOP_BACK
)paren
id|smp-&gt;v.mode_flags
op_or_assign
id|SNDRV_SFNT_SAMPLE_REVERSE_LOOP
suffix:semicolon
r_if
c_cond
(paren
id|patch.mode
op_amp
id|WAVE_16_BITS
)paren
(brace
multiline_comment|/* convert to word offsets */
id|smp-&gt;v.size
op_div_assign
l_int|2
suffix:semicolon
id|smp-&gt;v.end
op_div_assign
l_int|2
suffix:semicolon
id|smp-&gt;v.loopstart
op_div_assign
l_int|2
suffix:semicolon
id|smp-&gt;v.loopend
op_div_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/*smp-&gt;v.loopend++;*/
id|smp-&gt;v.dummy
op_assign
l_int|0
suffix:semicolon
id|smp-&gt;v.truesize
op_assign
l_int|0
suffix:semicolon
id|smp-&gt;v.sf_id
op_assign
id|sf-&gt;id
suffix:semicolon
multiline_comment|/* set up voice info */
r_if
c_cond
(paren
(paren
id|zone
op_assign
id|sf_zone_new
c_func
(paren
id|sflist
comma
id|sf
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|sf_sample_delete
c_func
(paren
id|sflist
comma
id|sf
comma
id|smp
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * load wave data&n;&t; */
r_if
c_cond
(paren
id|sflist-&gt;callback.sample_new
)paren
(brace
id|rc
op_assign
id|sflist-&gt;callback.sample_new
(paren
id|sflist-&gt;callback.private_data
comma
id|smp
comma
id|sflist-&gt;memhdr
comma
id|data
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|sf_sample_delete
c_func
(paren
id|sflist
comma
id|sf
comma
id|smp
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* memory offset is updated after */
)brace
multiline_comment|/* update the memory offset here */
id|sflist-&gt;mem_used
op_add_assign
id|smp-&gt;v.truesize
suffix:semicolon
id|zone-&gt;v.sample
op_assign
id|sample_id
suffix:semicolon
multiline_comment|/* the last sample */
id|zone-&gt;v.rate_offset
op_assign
id|calc_rate_offset
c_func
(paren
id|patch.base_freq
)paren
suffix:semicolon
id|note
op_assign
id|freq_to_note
c_func
(paren
id|patch.base_note
)paren
suffix:semicolon
id|zone-&gt;v.root
op_assign
id|note
op_div
l_int|100
suffix:semicolon
id|zone-&gt;v.tune
op_assign
op_minus
(paren
id|note
op_mod
l_int|100
)paren
suffix:semicolon
id|zone-&gt;v.low
op_assign
(paren
id|freq_to_note
c_func
(paren
id|patch.low_note
)paren
op_plus
l_int|99
)paren
op_div
l_int|100
suffix:semicolon
id|zone-&gt;v.high
op_assign
id|freq_to_note
c_func
(paren
id|patch.high_note
)paren
op_div
l_int|100
suffix:semicolon
multiline_comment|/* panning position; -128 - 127 =&gt; 0-127 */
id|zone-&gt;v.pan
op_assign
(paren
id|patch.panning
op_plus
l_int|128
)paren
op_div
l_int|2
suffix:semicolon
macro_line|#if 0
id|snd_printk
c_func
(paren
l_string|&quot;gus: basefrq=%d (ofs=%d) root=%d,tune=%d, range:%d-%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|patch.base_freq
comma
id|zone-&gt;v.rate_offset
comma
id|zone-&gt;v.root
comma
id|zone-&gt;v.tune
comma
id|zone-&gt;v.low
comma
id|zone-&gt;v.high
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* detuning is ignored */
multiline_comment|/* 6points volume envelope */
r_if
c_cond
(paren
id|patch.mode
op_amp
id|WAVE_ENVELOPES
)paren
(brace
r_int
id|attack
comma
id|hold
comma
id|decay
comma
id|release
suffix:semicolon
id|attack
op_assign
id|calc_gus_envelope_time
(paren
id|patch.env_rate
(braket
l_int|0
)braket
comma
l_int|0
comma
id|patch.env_offset
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hold
op_assign
id|calc_gus_envelope_time
(paren
id|patch.env_rate
(braket
l_int|1
)braket
comma
id|patch.env_offset
(braket
l_int|0
)braket
comma
id|patch.env_offset
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|decay
op_assign
id|calc_gus_envelope_time
(paren
id|patch.env_rate
(braket
l_int|2
)braket
comma
id|patch.env_offset
(braket
l_int|1
)braket
comma
id|patch.env_offset
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|release
op_assign
id|calc_gus_envelope_time
(paren
id|patch.env_rate
(braket
l_int|3
)braket
comma
id|patch.env_offset
(braket
l_int|1
)braket
comma
id|patch.env_offset
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|release
op_add_assign
id|calc_gus_envelope_time
(paren
id|patch.env_rate
(braket
l_int|4
)braket
comma
id|patch.env_offset
(braket
l_int|3
)braket
comma
id|patch.env_offset
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|release
op_add_assign
id|calc_gus_envelope_time
(paren
id|patch.env_rate
(braket
l_int|5
)braket
comma
id|patch.env_offset
(braket
l_int|4
)braket
comma
id|patch.env_offset
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|zone-&gt;v.parm.volatkhld
op_assign
(paren
id|snd_sf_calc_parm_hold
c_func
(paren
id|hold
)paren
op_lshift
l_int|8
)paren
op_or
id|snd_sf_calc_parm_attack
c_func
(paren
id|attack
)paren
suffix:semicolon
id|zone-&gt;v.parm.voldcysus
op_assign
(paren
id|calc_gus_sustain
c_func
(paren
id|patch.env_offset
(braket
l_int|2
)braket
)paren
op_lshift
l_int|8
)paren
op_or
id|snd_sf_calc_parm_decay
c_func
(paren
id|decay
)paren
suffix:semicolon
id|zone-&gt;v.parm.volrelease
op_assign
l_int|0x8000
op_or
id|snd_sf_calc_parm_decay
c_func
(paren
id|release
)paren
suffix:semicolon
id|zone-&gt;v.attenuation
op_assign
id|calc_gus_attenuation
c_func
(paren
id|patch.env_offset
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#if 0
id|snd_printk
c_func
(paren
l_string|&quot;gus: atkhld=%x, dcysus=%x, volrel=%x, att=%d&bslash;n&quot;
comma
id|zone-&gt;v.parm.volatkhld
comma
id|zone-&gt;v.parm.voldcysus
comma
id|zone-&gt;v.parm.volrelease
comma
id|zone-&gt;v.attenuation
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* fast release */
r_if
c_cond
(paren
id|patch.mode
op_amp
id|WAVE_FAST_RELEASE
)paren
(brace
id|zone-&gt;v.parm.volrelease
op_assign
l_int|0x807f
suffix:semicolon
)brace
multiline_comment|/* tremolo effect */
r_if
c_cond
(paren
id|patch.mode
op_amp
id|WAVE_TREMOLO
)paren
(brace
r_int
id|rate
op_assign
(paren
id|patch.tremolo_rate
op_star
l_int|1000
op_div
l_int|38
)paren
op_div
l_int|42
suffix:semicolon
id|zone-&gt;v.parm.tremfrq
op_assign
(paren
(paren
id|patch.tremolo_depth
op_div
l_int|2
)paren
op_lshift
l_int|8
)paren
op_or
id|rate
suffix:semicolon
)brace
multiline_comment|/* vibrato effect */
r_if
c_cond
(paren
id|patch.mode
op_amp
id|WAVE_VIBRATO
)paren
(brace
r_int
id|rate
op_assign
(paren
id|patch.vibrato_rate
op_star
l_int|1000
op_div
l_int|38
)paren
op_div
l_int|42
suffix:semicolon
id|zone-&gt;v.parm.fm2frq2
op_assign
(paren
(paren
id|patch.vibrato_depth
op_div
l_int|6
)paren
op_lshift
l_int|8
)paren
op_or
id|rate
suffix:semicolon
)brace
multiline_comment|/* scale_freq, scale_factor, volume, and fractions not implemented */
r_if
c_cond
(paren
op_logical_neg
(paren
id|smp-&gt;v.mode_flags
op_amp
id|SNDRV_SFNT_SAMPLE_SINGLESHOT
)paren
)paren
id|zone-&gt;v.mode
op_assign
id|SNDRV_SFNT_MODE_LOOPING
suffix:semicolon
r_else
id|zone-&gt;v.mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* append to the tail of the list */
multiline_comment|/*zone-&gt;bank = ctrls[AWE_MD_GUS_BANK];*/
id|zone-&gt;bank
op_assign
l_int|0
suffix:semicolon
id|zone-&gt;instr
op_assign
id|patch.instr_no
suffix:semicolon
id|zone-&gt;mapped
op_assign
l_int|0
suffix:semicolon
id|zone-&gt;v.sf_id
op_assign
id|sf-&gt;id
suffix:semicolon
id|zone-&gt;sample
op_assign
id|set_sample
c_func
(paren
id|sf
comma
op_amp
id|zone-&gt;v
)paren
suffix:semicolon
multiline_comment|/* rebuild preset now */
id|add_preset
c_func
(paren
id|sflist
comma
id|zone
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* load GUS patch */
r_int
DECL|function|snd_soundfont_load_guspatch
id|snd_soundfont_load_guspatch
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_const
r_char
id|__user
op_star
id|data
comma
r_int
id|count
comma
r_int
id|client
)paren
(brace
r_int
id|rc
suffix:semicolon
id|lock_preset
c_func
(paren
id|sflist
comma
l_int|0
)paren
suffix:semicolon
id|rc
op_assign
id|load_guspatch
c_func
(paren
id|sflist
comma
id|data
comma
id|count
comma
id|client
)paren
suffix:semicolon
id|unlock_preset
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Rebuild the preset table.  This is like a hash table in that it allows&n; * quick access to the zone information.  For each preset there are zone&n; * structures linked by next_instr and by next_zone.  Former is the whole&n; * link for this preset, and latter is the link for zone (i.e. instrument/&n; * bank/key combination).&n; */
r_static
r_void
DECL|function|rebuild_presets
id|rebuild_presets
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
id|snd_soundfont_t
op_star
id|sf
suffix:semicolon
id|snd_sf_zone_t
op_star
id|cur
suffix:semicolon
multiline_comment|/* clear preset table */
id|memset
c_func
(paren
id|sflist-&gt;presets
comma
l_int|0
comma
r_sizeof
(paren
id|sflist-&gt;presets
)paren
)paren
suffix:semicolon
multiline_comment|/* search all fonts and insert each font */
r_for
c_loop
(paren
id|sf
op_assign
id|sflist-&gt;fonts
suffix:semicolon
id|sf
suffix:semicolon
id|sf
op_assign
id|sf-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|cur
op_assign
id|sf-&gt;zones
suffix:semicolon
id|cur
suffix:semicolon
id|cur
op_assign
id|cur-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cur-&gt;mapped
op_logical_and
id|cur-&gt;sample
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* try again to search the corresponding sample */
id|cur-&gt;sample
op_assign
id|set_sample
c_func
(paren
id|sf
comma
op_amp
id|cur-&gt;v
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur-&gt;sample
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
)brace
id|add_preset
c_func
(paren
id|sflist
comma
id|cur
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * add the given zone to preset table&n; */
r_static
r_void
DECL|function|add_preset
id|add_preset
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_sf_zone_t
op_star
id|cur
)paren
(brace
id|snd_sf_zone_t
op_star
id|zone
suffix:semicolon
r_int
id|index
suffix:semicolon
id|zone
op_assign
id|search_first_zone
c_func
(paren
id|sflist
comma
id|cur-&gt;bank
comma
id|cur-&gt;instr
comma
id|cur-&gt;v.low
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zone
op_logical_and
id|zone-&gt;v.sf_id
op_ne
id|cur-&gt;v.sf_id
)paren
(brace
multiline_comment|/* different instrument was already defined */
id|snd_sf_zone_t
op_star
id|p
suffix:semicolon
multiline_comment|/* compare the allocated time */
r_for
c_loop
(paren
id|p
op_assign
id|zone
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next_zone
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;counter
OG
id|cur-&gt;counter
)paren
multiline_comment|/* the current is older.. skipped */
r_return
suffix:semicolon
)brace
multiline_comment|/* remove old zones */
id|delete_preset
c_func
(paren
id|sflist
comma
id|zone
)paren
suffix:semicolon
id|zone
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* do not forget to clear this! */
)brace
multiline_comment|/* prepend this zone */
r_if
c_cond
(paren
(paren
id|index
op_assign
id|get_index
c_func
(paren
id|cur-&gt;bank
comma
id|cur-&gt;instr
comma
id|cur-&gt;v.low
)paren
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
id|cur-&gt;next_zone
op_assign
id|zone
suffix:semicolon
multiline_comment|/* zone link */
id|cur-&gt;next_instr
op_assign
id|sflist-&gt;presets
(braket
id|index
)braket
suffix:semicolon
multiline_comment|/* preset table link */
id|sflist-&gt;presets
(braket
id|index
)braket
op_assign
id|cur
suffix:semicolon
)brace
multiline_comment|/*&n; * delete the given zones from preset_table&n; */
r_static
r_void
DECL|function|delete_preset
id|delete_preset
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
id|snd_sf_zone_t
op_star
id|zp
)paren
(brace
r_int
id|index
suffix:semicolon
id|snd_sf_zone_t
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|index
op_assign
id|get_index
c_func
(paren
id|zp-&gt;bank
comma
id|zp-&gt;instr
comma
id|zp-&gt;v.low
)paren
)paren
OL
l_int|0
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|sflist-&gt;presets
(braket
id|index
)braket
suffix:semicolon
id|p
suffix:semicolon
id|p
op_assign
id|p-&gt;next_instr
)paren
(brace
r_while
c_loop
(paren
id|p-&gt;next_instr
op_eq
id|zp
)paren
(brace
id|p-&gt;next_instr
op_assign
id|zp-&gt;next_instr
suffix:semicolon
id|zp
op_assign
id|zp-&gt;next_zone
suffix:semicolon
r_if
c_cond
(paren
id|zp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Search matching zones from preset table.&n; * The note can be rewritten by preset mapping (alias).&n; * The found zones are stored on &squot;table&squot; array.  max_layers defines&n; * the maximum number of elements in this array.&n; * This function returns the number of found zones.  0 if not found.&n; */
r_int
DECL|function|snd_soundfont_search_zone
id|snd_soundfont_search_zone
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
op_star
id|notep
comma
r_int
id|vel
comma
r_int
id|preset
comma
r_int
id|bank
comma
r_int
id|def_preset
comma
r_int
id|def_bank
comma
id|snd_sf_zone_t
op_star
op_star
id|table
comma
r_int
id|max_layers
)paren
(brace
r_int
id|nvoices
suffix:semicolon
r_if
c_cond
(paren
id|lock_preset
c_func
(paren
id|sflist
comma
l_int|1
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|nvoices
op_assign
id|search_zones
c_func
(paren
id|sflist
comma
id|notep
comma
id|vel
comma
id|preset
comma
id|bank
comma
id|table
comma
id|max_layers
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nvoices
)paren
(brace
r_if
c_cond
(paren
id|preset
op_ne
id|def_preset
op_logical_or
id|bank
op_ne
id|def_bank
)paren
id|nvoices
op_assign
id|search_zones
c_func
(paren
id|sflist
comma
id|notep
comma
id|vel
comma
id|def_preset
comma
id|def_bank
comma
id|table
comma
id|max_layers
comma
l_int|0
)paren
suffix:semicolon
)brace
id|unlock_preset
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
id|nvoices
suffix:semicolon
)brace
multiline_comment|/*&n; * search the first matching zone&n; */
r_static
id|snd_sf_zone_t
op_star
DECL|function|search_first_zone
id|search_first_zone
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
id|bank
comma
r_int
id|preset
comma
r_int
id|key
)paren
(brace
r_int
id|index
suffix:semicolon
id|snd_sf_zone_t
op_star
id|zp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|index
op_assign
id|get_index
c_func
(paren
id|bank
comma
id|preset
comma
id|key
)paren
)paren
OL
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|zp
op_assign
id|sflist-&gt;presets
(braket
id|index
)braket
suffix:semicolon
id|zp
suffix:semicolon
id|zp
op_assign
id|zp-&gt;next_instr
)paren
(brace
r_if
c_cond
(paren
id|zp-&gt;instr
op_eq
id|preset
op_logical_and
id|zp-&gt;bank
op_eq
id|bank
)paren
r_return
id|zp
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * search matching zones from sflist.  can be called recursively.&n; */
r_static
r_int
DECL|function|search_zones
id|search_zones
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
comma
r_int
op_star
id|notep
comma
r_int
id|vel
comma
r_int
id|preset
comma
r_int
id|bank
comma
id|snd_sf_zone_t
op_star
op_star
id|table
comma
r_int
id|max_layers
comma
r_int
id|level
)paren
(brace
id|snd_sf_zone_t
op_star
id|zp
suffix:semicolon
r_int
id|nvoices
suffix:semicolon
id|zp
op_assign
id|search_first_zone
c_func
(paren
id|sflist
comma
id|bank
comma
id|preset
comma
op_star
id|notep
)paren
suffix:semicolon
id|nvoices
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|zp
suffix:semicolon
id|zp
op_assign
id|zp-&gt;next_zone
)paren
(brace
r_if
c_cond
(paren
op_star
id|notep
op_ge
id|zp-&gt;v.low
op_logical_and
op_star
id|notep
op_le
id|zp-&gt;v.high
op_logical_and
id|vel
op_ge
id|zp-&gt;v.vellow
op_logical_and
id|vel
op_le
id|zp-&gt;v.velhigh
)paren
(brace
r_if
c_cond
(paren
id|zp-&gt;mapped
)paren
(brace
multiline_comment|/* search preset mapping (aliasing) */
r_int
id|key
op_assign
id|zp-&gt;v.fixkey
suffix:semicolon
id|preset
op_assign
id|zp-&gt;v.start
suffix:semicolon
id|bank
op_assign
id|zp-&gt;v.end
suffix:semicolon
r_if
c_cond
(paren
id|level
OG
l_int|5
)paren
multiline_comment|/* too deep alias level */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|key
OL
l_int|0
)paren
id|key
op_assign
op_star
id|notep
suffix:semicolon
id|nvoices
op_assign
id|search_zones
c_func
(paren
id|sflist
comma
op_amp
id|key
comma
id|vel
comma
id|preset
comma
id|bank
comma
id|table
comma
id|max_layers
comma
id|level
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nvoices
OG
l_int|0
)paren
op_star
id|notep
op_assign
id|key
suffix:semicolon
r_break
suffix:semicolon
)brace
id|table
(braket
id|nvoices
op_increment
)braket
op_assign
id|zp
suffix:semicolon
r_if
c_cond
(paren
id|nvoices
op_ge
id|max_layers
)paren
r_break
suffix:semicolon
)brace
)brace
r_return
id|nvoices
suffix:semicolon
)brace
multiline_comment|/* calculate the index of preset table:&n; * drums are mapped from 128 to 255 according to its note key.&n; * other instruments are mapped from 0 to 127.&n; * if the index is out of range, return -1.&n; */
r_static
r_int
DECL|function|get_index
id|get_index
c_func
(paren
r_int
id|bank
comma
r_int
id|instr
comma
r_int
id|key
)paren
(brace
r_int
id|index
suffix:semicolon
r_if
c_cond
(paren
id|SF_IS_DRUM_BANK
c_func
(paren
id|bank
)paren
)paren
id|index
op_assign
id|key
op_plus
id|SF_MAX_INSTRUMENTS
suffix:semicolon
r_else
id|index
op_assign
id|instr
suffix:semicolon
id|index
op_assign
id|index
op_mod
id|SF_MAX_PRESETS
suffix:semicolon
r_if
c_cond
(paren
id|index
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|index
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialise the sflist structure.&n; */
r_static
r_void
DECL|function|snd_sf_init
id|snd_sf_init
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
id|memset
c_func
(paren
id|sflist-&gt;presets
comma
l_int|0
comma
r_sizeof
(paren
id|sflist-&gt;presets
)paren
)paren
suffix:semicolon
id|sflist-&gt;mem_used
op_assign
l_int|0
suffix:semicolon
id|sflist-&gt;currsf
op_assign
l_int|NULL
suffix:semicolon
id|sflist-&gt;open_client
op_assign
op_minus
l_int|1
suffix:semicolon
id|sflist-&gt;fonts
op_assign
l_int|NULL
suffix:semicolon
id|sflist-&gt;fonts_size
op_assign
l_int|0
suffix:semicolon
id|sflist-&gt;zone_counter
op_assign
l_int|0
suffix:semicolon
id|sflist-&gt;sample_counter
op_assign
l_int|0
suffix:semicolon
id|sflist-&gt;zone_locked
op_assign
l_int|0
suffix:semicolon
id|sflist-&gt;sample_locked
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Release all list records&n; */
r_static
r_void
DECL|function|snd_sf_clear
id|snd_sf_clear
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
id|snd_soundfont_t
op_star
id|sf
comma
op_star
id|nextsf
suffix:semicolon
id|snd_sf_zone_t
op_star
id|zp
comma
op_star
id|nextzp
suffix:semicolon
id|snd_sf_sample_t
op_star
id|sp
comma
op_star
id|nextsp
suffix:semicolon
r_for
c_loop
(paren
id|sf
op_assign
id|sflist-&gt;fonts
suffix:semicolon
id|sf
suffix:semicolon
id|sf
op_assign
id|nextsf
)paren
(brace
id|nextsf
op_assign
id|sf-&gt;next
suffix:semicolon
r_for
c_loop
(paren
id|zp
op_assign
id|sf-&gt;zones
suffix:semicolon
id|zp
suffix:semicolon
id|zp
op_assign
id|nextzp
)paren
(brace
id|nextzp
op_assign
id|zp-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|zp
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|sp
op_assign
id|sf-&gt;samples
suffix:semicolon
id|sp
suffix:semicolon
id|sp
op_assign
id|nextsp
)paren
(brace
id|nextsp
op_assign
id|sp-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|sflist-&gt;callback.sample_free
)paren
id|sflist-&gt;callback
dot
id|sample_free
c_func
(paren
id|sflist-&gt;callback.private_data
comma
id|sp
comma
id|sflist-&gt;memhdr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|sf
)paren
suffix:semicolon
)brace
id|snd_sf_init
c_func
(paren
id|sflist
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Create a new sflist structure&n; */
id|snd_sf_list_t
op_star
DECL|function|snd_sf_new
id|snd_sf_new
c_func
(paren
id|snd_sf_callback_t
op_star
id|callback
comma
id|snd_util_memhdr_t
op_star
id|hdr
)paren
(brace
id|snd_sf_list_t
op_star
id|sflist
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sflist
op_assign
id|snd_kcalloc
c_func
(paren
r_sizeof
(paren
id|snd_sf_list_t
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|sflist-&gt;presets_mutex
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|sflist-&gt;lock
)paren
suffix:semicolon
id|sflist-&gt;memhdr
op_assign
id|hdr
suffix:semicolon
r_if
c_cond
(paren
id|callback
)paren
id|sflist-&gt;callback
op_assign
op_star
id|callback
suffix:semicolon
id|snd_sf_init
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
id|sflist
suffix:semicolon
)brace
multiline_comment|/*&n; * Free everything allocated off the sflist structure.&n; */
r_void
DECL|function|snd_sf_free
id|snd_sf_free
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
r_if
c_cond
(paren
id|sflist
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|lock_preset
c_func
(paren
id|sflist
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sflist-&gt;callback.sample_reset
)paren
id|sflist-&gt;callback
dot
id|sample_reset
c_func
(paren
id|sflist-&gt;callback.private_data
)paren
suffix:semicolon
id|snd_sf_clear
c_func
(paren
id|sflist
)paren
suffix:semicolon
id|unlock_preset
c_func
(paren
id|sflist
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sflist
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove all samples&n; * The soundcard should be silet before calling this function.&n; */
r_int
DECL|function|snd_soundfont_remove_samples
id|snd_soundfont_remove_samples
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
id|lock_preset
c_func
(paren
id|sflist
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sflist-&gt;callback.sample_reset
)paren
id|sflist-&gt;callback
dot
id|sample_reset
c_func
(paren
id|sflist-&gt;callback.private_data
)paren
suffix:semicolon
id|snd_sf_clear
c_func
(paren
id|sflist
)paren
suffix:semicolon
id|unlock_preset
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove unlocked samples.&n; * The soundcard should be silent before calling this function.&n; */
r_int
DECL|function|snd_soundfont_remove_unlocked
id|snd_soundfont_remove_unlocked
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
id|snd_soundfont_t
op_star
id|sf
suffix:semicolon
id|snd_sf_zone_t
op_star
id|zp
comma
op_star
id|nextzp
suffix:semicolon
id|snd_sf_sample_t
op_star
id|sp
comma
op_star
id|nextsp
suffix:semicolon
r_if
c_cond
(paren
id|lock_preset
c_func
(paren
id|sflist
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|sflist-&gt;callback.sample_reset
)paren
id|sflist-&gt;callback
dot
id|sample_reset
c_func
(paren
id|sflist-&gt;callback.private_data
)paren
suffix:semicolon
multiline_comment|/* to be sure */
id|memset
c_func
(paren
id|sflist-&gt;presets
comma
l_int|0
comma
r_sizeof
(paren
id|sflist-&gt;presets
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sf
op_assign
id|sflist-&gt;fonts
suffix:semicolon
id|sf
suffix:semicolon
id|sf
op_assign
id|sf-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|zp
op_assign
id|sf-&gt;zones
suffix:semicolon
id|zp
suffix:semicolon
id|zp
op_assign
id|nextzp
)paren
(brace
r_if
c_cond
(paren
id|zp-&gt;counter
OL
id|sflist-&gt;zone_locked
)paren
r_break
suffix:semicolon
id|nextzp
op_assign
id|zp-&gt;next
suffix:semicolon
id|sf-&gt;zones
op_assign
id|nextzp
suffix:semicolon
id|kfree
c_func
(paren
id|zp
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|sp
op_assign
id|sf-&gt;samples
suffix:semicolon
id|sp
suffix:semicolon
id|sp
op_assign
id|nextsp
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;counter
OL
id|sflist-&gt;sample_locked
)paren
r_break
suffix:semicolon
id|nextsp
op_assign
id|sp-&gt;next
suffix:semicolon
id|sf-&gt;samples
op_assign
id|nextsp
suffix:semicolon
id|sflist-&gt;mem_used
op_sub_assign
id|sp-&gt;v.truesize
suffix:semicolon
r_if
c_cond
(paren
id|sflist-&gt;callback.sample_free
)paren
id|sflist-&gt;callback
dot
id|sample_free
c_func
(paren
id|sflist-&gt;callback.private_data
comma
id|sp
comma
id|sflist-&gt;memhdr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
)brace
id|sflist-&gt;zone_counter
op_assign
id|sflist-&gt;zone_locked
suffix:semicolon
id|sflist-&gt;sample_counter
op_assign
id|sflist-&gt;sample_locked
suffix:semicolon
id|rebuild_presets
c_func
(paren
id|sflist
)paren
suffix:semicolon
id|unlock_preset
c_func
(paren
id|sflist
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the used memory size (in words)&n; */
r_int
DECL|function|snd_soundfont_mem_used
id|snd_soundfont_mem_used
c_func
(paren
id|snd_sf_list_t
op_star
id|sflist
)paren
(brace
r_return
id|sflist-&gt;mem_used
suffix:semicolon
)brace
eof
