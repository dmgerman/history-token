multiline_comment|/*&n; *  Midi synth routines for the Emu8k/Emu10k1&n; *&n; *  Copyright (C) 1999 Steve Ratcliffe&n; *  Copyright (c) 1999-2000 Takashi Iwai &lt;tiwai@suse.de&gt;&n; *&n; *  Contains code based on awe_wave.c by Takashi Iwai&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; *&n; */
macro_line|#include &quot;emux_voice.h&quot;
macro_line|#include &lt;sound/asoundef.h&gt;
multiline_comment|/*&n; * Prototypes&n; */
multiline_comment|/*&n; * Ensure a value is between two points&n; * macro evaluates its args more than once, so changed to upper-case.&n; */
DECL|macro|LIMITVALUE
mdefine_line|#define LIMITVALUE(x, a, b) do { if ((x) &lt; (a)) (x) = (a); else if ((x) &gt; (b)) (x) = (b); } while (0)
DECL|macro|LIMITMAX
mdefine_line|#define LIMITMAX(x, a) do {if ((x) &gt; (a)) (x) = (a); } while (0)
r_static
r_int
id|get_zone
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
id|snd_emux_port_t
op_star
id|port
comma
r_int
op_star
id|notep
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
comma
id|snd_sf_zone_t
op_star
op_star
id|table
)paren
suffix:semicolon
r_static
r_int
id|get_bank
c_func
(paren
id|snd_emux_port_t
op_star
id|port
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
suffix:semicolon
r_static
r_void
id|terminate_note1
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
r_int
id|note
comma
id|snd_midi_channel_t
op_star
id|chan
comma
r_int
id|free
)paren
suffix:semicolon
r_static
r_void
id|exclusive_note_off
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
id|snd_emux_port_t
op_star
id|port
comma
r_int
id|exclass
)paren
suffix:semicolon
r_static
r_void
id|terminate_voice
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
id|snd_emux_voice_t
op_star
id|vp
comma
r_int
id|free
)paren
suffix:semicolon
r_static
r_void
id|update_voice
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
id|snd_emux_voice_t
op_star
id|vp
comma
r_int
id|update
)paren
suffix:semicolon
r_static
r_void
id|setup_voice
c_func
(paren
id|snd_emux_voice_t
op_star
id|vp
)paren
suffix:semicolon
r_static
r_int
id|calc_pan
c_func
(paren
id|snd_emux_voice_t
op_star
id|vp
)paren
suffix:semicolon
r_static
r_int
id|calc_volume
c_func
(paren
id|snd_emux_voice_t
op_star
id|vp
)paren
suffix:semicolon
r_static
r_int
id|calc_pitch
c_func
(paren
id|snd_emux_voice_t
op_star
id|vp
)paren
suffix:semicolon
multiline_comment|/*&n; * Start a note.&n; */
r_void
DECL|function|snd_emux_note_on
id|snd_emux_note_on
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
id|snd_emux_t
op_star
id|emu
suffix:semicolon
r_int
id|i
comma
id|key
comma
id|nvoices
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
id|snd_sf_zone_t
op_star
id|table
(braket
id|SNDRV_EMUX_MAX_MULTI_VOICES
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|snd_emux_port_t
op_star
id|port
suffix:semicolon
id|port
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_emux_port_t
comma
id|p
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|port
op_ne
l_int|NULL
op_logical_and
id|chan
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|emu
op_assign
id|port-&gt;emu
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu-&gt;ops.get_voice
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu-&gt;ops.trigger
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|key
op_assign
id|note
suffix:semicolon
multiline_comment|/* remember the original note */
id|nvoices
op_assign
id|get_zone
c_func
(paren
id|emu
comma
id|port
comma
op_amp
id|note
comma
id|vel
comma
id|chan
comma
id|table
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nvoices
)paren
r_return
suffix:semicolon
multiline_comment|/* exclusive note off */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nvoices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|snd_sf_zone_t
op_star
id|zp
op_assign
id|table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|zp
op_logical_and
id|zp-&gt;v.exclusiveClass
)paren
id|exclusive_note_off
c_func
(paren
id|emu
comma
id|port
comma
id|zp-&gt;v.exclusiveClass
)paren
suffix:semicolon
)brace
macro_line|#if 0 
singleline_comment|// seems not necessary
multiline_comment|/* Turn off the same note on the same channel. */
id|terminate_note1
c_func
(paren
id|emu
comma
id|key
comma
id|chan
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nvoices
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* set up each voice parameter */
multiline_comment|/* at this stage, we don&squot;t trigger the voice yet. */
r_if
c_cond
(paren
id|table
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|vp
op_assign
id|emu-&gt;ops
dot
id|get_voice
c_func
(paren
id|emu
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp
op_eq
l_int|NULL
op_logical_or
id|vp-&gt;ch
OL
l_int|0
)paren
r_continue
suffix:semicolon
id|snd_assert
c_func
(paren
id|vp-&gt;emu
op_ne
l_int|NULL
op_logical_and
id|vp-&gt;hw
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
r_if
c_cond
(paren
id|STATE_IS_PLAYING
c_func
(paren
id|vp-&gt;state
)paren
)paren
id|emu-&gt;ops
dot
id|terminate
c_func
(paren
id|vp
)paren
suffix:semicolon
id|vp-&gt;time
op_assign
id|emu-&gt;use_time
op_increment
suffix:semicolon
id|vp-&gt;chan
op_assign
id|chan
suffix:semicolon
id|vp-&gt;port
op_assign
id|port
suffix:semicolon
id|vp-&gt;key
op_assign
id|key
suffix:semicolon
id|vp-&gt;note
op_assign
id|note
suffix:semicolon
id|vp-&gt;velocity
op_assign
id|vel
suffix:semicolon
id|vp-&gt;zone
op_assign
id|table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;zone-&gt;sample
)paren
id|vp-&gt;block
op_assign
id|vp-&gt;zone-&gt;sample-&gt;block
suffix:semicolon
r_else
id|vp-&gt;block
op_assign
l_int|NULL
suffix:semicolon
id|setup_voice
c_func
(paren
id|vp
)paren
suffix:semicolon
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_STANDBY
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;ops.prepare
)paren
(brace
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_OFF
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;ops
dot
id|prepare
c_func
(paren
id|vp
)paren
op_ge
l_int|0
)paren
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_STANDBY
suffix:semicolon
)brace
)brace
multiline_comment|/* start envelope now */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|emu-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
op_eq
id|SNDRV_EMUX_ST_STANDBY
op_logical_and
id|vp-&gt;chan
op_eq
id|chan
)paren
(brace
id|emu-&gt;ops
dot
id|trigger
c_func
(paren
id|vp
)paren
suffix:semicolon
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_ON
suffix:semicolon
id|vp-&gt;ontime
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* remember the trigger timing */
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef SNDRV_EMUX_USE_RAW_EFFECT
r_if
c_cond
(paren
id|port-&gt;port_mode
op_eq
id|SNDRV_EMUX_PORT_MODE_OSS_SYNTH
)paren
(brace
multiline_comment|/* clear voice position for the next note on this channel */
id|snd_emux_effect_table_t
op_star
id|fx
op_assign
id|chan
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|fx
)paren
(brace
id|fx-&gt;flag
(braket
id|EMUX_FX_SAMPLE_START
)braket
op_assign
l_int|0
suffix:semicolon
id|fx-&gt;flag
(braket
id|EMUX_FX_COARSE_SAMPLE_START
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
multiline_comment|/*&n; * Release a note in response to a midi note off.&n; */
r_void
DECL|function|snd_emux_note_off
id|snd_emux_note_off
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
r_int
id|ch
suffix:semicolon
id|snd_emux_t
op_star
id|emu
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|snd_emux_port_t
op_star
id|port
suffix:semicolon
id|port
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_emux_port_t
comma
id|p
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|port
op_ne
l_int|NULL
op_logical_and
id|chan
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|emu
op_assign
id|port-&gt;emu
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu-&gt;ops.release
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ch
op_assign
l_int|0
suffix:semicolon
id|ch
OL
id|emu-&gt;max_voices
suffix:semicolon
id|ch
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|ch
)braket
suffix:semicolon
r_if
c_cond
(paren
id|STATE_IS_PLAYING
c_func
(paren
id|vp-&gt;state
)paren
op_logical_and
id|vp-&gt;chan
op_eq
id|chan
op_logical_and
id|vp-&gt;key
op_eq
id|note
)paren
(brace
id|vp-&gt;time
op_assign
id|emu-&gt;use_time
op_increment
suffix:semicolon
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_RELEASED
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;ontime
op_eq
id|jiffies
)paren
(brace
multiline_comment|/* if note-off is sent too shortly after&n;&t;&t;&t;&t; * note-on, emuX engine cannot produce the sound&n;&t;&t;&t;&t; * correctly.  so we&squot;ll release this note&n;&t;&t;&t;&t; * a bit later via timer callback.&n;&t;&t;&t;&t; */
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_PENDING
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|emu-&gt;timer_active
)paren
(brace
id|emu-&gt;tlist.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|emu-&gt;tlist
)paren
suffix:semicolon
id|emu-&gt;timer_active
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* ok now release the note */
id|emu-&gt;ops
dot
id|release
c_func
(paren
id|vp
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * timer callback&n; *&n; * release the pending note-offs&n; */
DECL|function|snd_emux_timer_callback
r_void
id|snd_emux_timer_callback
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|snd_emux_t
op_star
id|emu
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_emux_t
comma
(paren
r_void
op_star
)paren
id|data
comma
r_return
)paren
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
id|ch
comma
id|do_again
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|emu-&gt;voice_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ch
op_assign
l_int|0
suffix:semicolon
id|ch
OL
id|emu-&gt;max_voices
suffix:semicolon
id|ch
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|ch
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
op_eq
id|SNDRV_EMUX_ST_PENDING
)paren
(brace
r_if
c_cond
(paren
id|vp-&gt;ontime
op_eq
id|jiffies
)paren
id|do_again
op_increment
suffix:semicolon
multiline_comment|/* release this at the next interrupt */
r_else
(brace
id|emu-&gt;ops
dot
id|release
c_func
(paren
id|vp
)paren
suffix:semicolon
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_RELEASED
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|do_again
)paren
(brace
id|emu-&gt;tlist.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|emu-&gt;tlist
)paren
suffix:semicolon
id|emu-&gt;timer_active
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|emu-&gt;timer_active
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|emu-&gt;voice_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * key pressure change&n; */
r_void
DECL|function|snd_emux_key_press
id|snd_emux_key_press
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|note
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
r_int
id|ch
suffix:semicolon
id|snd_emux_t
op_star
id|emu
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|snd_emux_port_t
op_star
id|port
suffix:semicolon
id|port
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_emux_port_t
comma
id|p
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|port
op_ne
l_int|NULL
op_logical_and
id|chan
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|emu
op_assign
id|port-&gt;emu
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu-&gt;ops.update
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ch
op_assign
l_int|0
suffix:semicolon
id|ch
OL
id|emu-&gt;max_voices
suffix:semicolon
id|ch
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|ch
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
op_eq
id|SNDRV_EMUX_ST_ON
op_logical_and
id|vp-&gt;chan
op_eq
id|chan
op_logical_and
id|vp-&gt;key
op_eq
id|note
)paren
(brace
id|vp-&gt;velocity
op_assign
id|vel
suffix:semicolon
id|update_voice
c_func
(paren
id|emu
comma
id|vp
comma
id|SNDRV_EMUX_UPDATE_VOLUME
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Modulate the voices which belong to the channel&n; */
r_void
DECL|function|snd_emux_update_channel
id|snd_emux_update_channel
c_func
(paren
id|snd_emux_port_t
op_star
id|port
comma
id|snd_midi_channel_t
op_star
id|chan
comma
r_int
id|update
)paren
(brace
id|snd_emux_t
op_star
id|emu
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|update
)paren
r_return
suffix:semicolon
id|emu
op_assign
id|port-&gt;emu
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu-&gt;ops.update
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|emu-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;chan
op_eq
id|chan
)paren
id|update_voice
c_func
(paren
id|emu
comma
id|vp
comma
id|update
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Modulate all the voices which belong to the port.&n; */
r_void
DECL|function|snd_emux_update_port
id|snd_emux_update_port
c_func
(paren
id|snd_emux_port_t
op_star
id|port
comma
r_int
id|update
)paren
(brace
id|snd_emux_t
op_star
id|emu
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|update
)paren
r_return
suffix:semicolon
id|emu
op_assign
id|port-&gt;emu
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu-&gt;ops.update
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|emu-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;port
op_eq
id|port
)paren
id|update_voice
c_func
(paren
id|emu
comma
id|vp
comma
id|update
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Deal with a controler type event.  This includes all types of&n; * control events, not just the midi controllers&n; */
r_void
DECL|function|snd_emux_control
id|snd_emux_control
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|type
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
id|snd_emux_port_t
op_star
id|port
suffix:semicolon
id|port
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_emux_port_t
comma
id|p
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|port
op_ne
l_int|NULL
op_logical_and
id|chan
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|MIDI_CTL_MSB_MAIN_VOLUME
suffix:colon
r_case
id|MIDI_CTL_MSB_EXPRESSION
suffix:colon
id|snd_emux_update_channel
c_func
(paren
id|port
comma
id|chan
comma
id|SNDRV_EMUX_UPDATE_VOLUME
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIDI_CTL_MSB_PAN
suffix:colon
id|snd_emux_update_channel
c_func
(paren
id|port
comma
id|chan
comma
id|SNDRV_EMUX_UPDATE_PAN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIDI_CTL_SOFT_PEDAL
suffix:colon
macro_line|#ifdef SNDRV_EMUX_USE_RAW_EFFECT
multiline_comment|/* FIXME: this is an emulation */
id|snd_emux_send_effect
c_func
(paren
id|port
comma
id|chan
comma
id|EMUX_FX_CUTOFF
comma
op_minus
l_int|160
comma
id|EMUX_FX_FLAG_ADD
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|MIDI_CTL_PITCHBEND
suffix:colon
id|snd_emux_update_channel
c_func
(paren
id|port
comma
id|chan
comma
id|SNDRV_EMUX_UPDATE_PITCH
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MIDI_CTL_MSB_MODWHEEL
suffix:colon
r_case
id|MIDI_CTL_CHAN_PRESSURE
suffix:colon
id|snd_emux_update_channel
c_func
(paren
id|port
comma
id|chan
comma
id|SNDRV_EMUX_UPDATE_FMMOD
op_or
id|SNDRV_EMUX_UPDATE_FM2FRQ2
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port-&gt;chset.midi_mode
op_eq
id|SNDRV_MIDI_MODE_XG
)paren
(brace
id|snd_emux_xg_control
c_func
(paren
id|port
comma
id|chan
comma
id|type
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * for Emu10k1 - release at least 1 voice currently using&n; */
r_int
DECL|function|snd_emux_release_voice
id|snd_emux_release_voice
c_func
(paren
id|snd_emux_t
op_star
id|emu
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * terminate note - if free flag is true, free the terminated voice&n; */
r_static
r_void
DECL|function|terminate_note1
id|terminate_note1
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
r_int
id|note
comma
id|snd_midi_channel_t
op_star
id|chan
comma
r_int
id|free
)paren
(brace
r_int
id|i
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|emu-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|STATE_IS_PLAYING
c_func
(paren
id|vp-&gt;state
)paren
op_logical_and
id|vp-&gt;chan
op_eq
id|chan
op_logical_and
id|vp-&gt;key
op_eq
id|note
)paren
id|terminate_voice
c_func
(paren
id|emu
comma
id|vp
comma
id|free
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * terminate note - exported for midi emulation&n; */
r_void
DECL|function|snd_emux_terminate_note
id|snd_emux_terminate_note
c_func
(paren
r_void
op_star
id|p
comma
r_int
id|note
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
id|snd_emux_t
op_star
id|emu
suffix:semicolon
id|snd_emux_port_t
op_star
id|port
suffix:semicolon
id|port
op_assign
id|snd_magic_cast
c_func
(paren
id|snd_emux_port_t
comma
id|p
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|port
op_ne
l_int|NULL
op_logical_and
id|chan
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|emu
op_assign
id|port-&gt;emu
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu-&gt;ops.terminate
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|terminate_note1
c_func
(paren
id|emu
comma
id|note
comma
id|chan
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Terminate all the notes&n; */
r_void
DECL|function|snd_emux_terminate_all
id|snd_emux_terminate_all
c_func
(paren
id|snd_emux_t
op_star
id|emu
)paren
(brace
r_int
id|i
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|emu-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|STATE_IS_PLAYING
c_func
(paren
id|vp-&gt;state
)paren
)paren
id|terminate_voice
c_func
(paren
id|emu
comma
id|vp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
op_eq
id|SNDRV_EMUX_ST_OFF
)paren
(brace
r_if
c_cond
(paren
id|emu-&gt;ops.free_voice
)paren
id|emu-&gt;ops
dot
id|free_voice
c_func
(paren
id|vp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;ops.reset
)paren
id|emu-&gt;ops
dot
id|reset
c_func
(paren
id|emu
comma
id|i
)paren
suffix:semicolon
)brace
id|vp-&gt;time
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* initialize allocation time */
id|emu-&gt;use_time
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Terminate all voices associated with the given port&n; */
r_void
DECL|function|snd_emux_sounds_off_all
id|snd_emux_sounds_off_all
c_func
(paren
id|snd_emux_port_t
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
id|snd_emux_t
op_star
id|emu
suffix:semicolon
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|snd_assert
c_func
(paren
id|port
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|emu
op_assign
id|port-&gt;emu
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|snd_assert
c_func
(paren
id|emu-&gt;ops.terminate
op_ne
l_int|NULL
comma
r_return
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|emu-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|STATE_IS_PLAYING
c_func
(paren
id|vp-&gt;state
)paren
op_logical_and
id|vp-&gt;port
op_eq
id|port
)paren
id|terminate_voice
c_func
(paren
id|emu
comma
id|vp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;state
op_eq
id|SNDRV_EMUX_ST_OFF
)paren
(brace
r_if
c_cond
(paren
id|emu-&gt;ops.free_voice
)paren
id|emu-&gt;ops
dot
id|free_voice
c_func
(paren
id|vp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;ops.reset
)paren
id|emu-&gt;ops
dot
id|reset
c_func
(paren
id|emu
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Terminate all voices that have the same exclusive class.  This&n; * is mainly for drums.&n; */
r_static
r_void
DECL|function|exclusive_note_off
id|exclusive_note_off
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
id|snd_emux_port_t
op_star
id|port
comma
r_int
id|exclass
)paren
(brace
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|emu-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|STATE_IS_PLAYING
c_func
(paren
id|vp-&gt;state
)paren
op_logical_and
id|vp-&gt;port
op_eq
id|port
op_logical_and
id|vp-&gt;reg.exclusiveClass
op_eq
id|exclass
)paren
(brace
id|terminate_voice
c_func
(paren
id|emu
comma
id|vp
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * terminate a voice&n; * if free flag is true, call free_voice after termination&n; */
r_static
r_void
DECL|function|terminate_voice
id|terminate_voice
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
id|snd_emux_voice_t
op_star
id|vp
comma
r_int
id|free
)paren
(brace
id|emu-&gt;ops
dot
id|terminate
c_func
(paren
id|vp
)paren
suffix:semicolon
id|vp-&gt;time
op_assign
id|emu-&gt;use_time
op_increment
suffix:semicolon
id|vp-&gt;chan
op_assign
l_int|NULL
suffix:semicolon
id|vp-&gt;port
op_assign
l_int|NULL
suffix:semicolon
id|vp-&gt;zone
op_assign
l_int|NULL
suffix:semicolon
id|vp-&gt;block
op_assign
l_int|NULL
suffix:semicolon
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_OFF
suffix:semicolon
r_if
c_cond
(paren
id|free
op_logical_and
id|emu-&gt;ops.free_voice
)paren
id|emu-&gt;ops
dot
id|free_voice
c_func
(paren
id|vp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Modulate the voice&n; */
r_static
r_void
DECL|function|update_voice
id|update_voice
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
id|snd_emux_voice_t
op_star
id|vp
comma
r_int
id|update
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|STATE_IS_PLAYING
c_func
(paren
id|vp-&gt;state
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;chan
op_eq
l_int|NULL
op_logical_or
id|vp-&gt;port
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|update
op_amp
id|SNDRV_EMUX_UPDATE_VOLUME
)paren
id|calc_volume
c_func
(paren
id|vp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|update
op_amp
id|SNDRV_EMUX_UPDATE_PITCH
)paren
id|calc_pitch
c_func
(paren
id|vp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|update
op_amp
id|SNDRV_EMUX_UPDATE_PAN
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|calc_pan
c_func
(paren
id|vp
)paren
op_logical_and
(paren
id|update
op_eq
id|SNDRV_EMUX_UPDATE_PAN
)paren
)paren
r_return
suffix:semicolon
)brace
id|emu-&gt;ops
dot
id|update
c_func
(paren
id|vp
comma
id|update
)paren
suffix:semicolon
)brace
macro_line|#if 0 
singleline_comment|// not used
multiline_comment|/* table for volume target calculation */
r_static
r_int
r_int
id|voltarget
(braket
l_int|16
)braket
op_assign
(brace
l_int|0xEAC0
comma
l_int|0xE0C8
comma
l_int|0xD740
comma
l_int|0xCE20
comma
l_int|0xC560
comma
l_int|0xBD08
comma
l_int|0xB500
comma
l_int|0xAD58
comma
l_int|0xA5F8
comma
l_int|0x9EF0
comma
l_int|0x9830
comma
l_int|0x91C0
comma
l_int|0x8B90
comma
l_int|0x85A8
comma
l_int|0x8000
comma
l_int|0x7A90
)brace
suffix:semicolon
macro_line|#endif
DECL|macro|LO_BYTE
mdefine_line|#define LO_BYTE(v)&t;((v) &amp; 0xff)
DECL|macro|HI_BYTE
mdefine_line|#define HI_BYTE(v)&t;(((v) &gt;&gt; 8) &amp; 0xff)
multiline_comment|/*&n; * Sets up the voice structure by calculating some values that&n; * will be needed later.&n; */
r_static
r_void
DECL|function|setup_voice
id|setup_voice
c_func
(paren
id|snd_emux_voice_t
op_star
id|vp
)paren
(brace
id|soundfont_voice_parm_t
op_star
id|parm
suffix:semicolon
r_int
id|pitch
suffix:semicolon
multiline_comment|/* copy the original register values */
id|vp-&gt;reg
op_assign
id|vp-&gt;zone-&gt;v
suffix:semicolon
macro_line|#ifdef SNDRV_EMUX_USE_RAW_EFFECT
id|snd_emux_setup_effect
c_func
(paren
id|vp
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* reset status */
id|vp-&gt;apan
op_assign
op_minus
l_int|1
suffix:semicolon
id|vp-&gt;avol
op_assign
op_minus
l_int|1
suffix:semicolon
id|vp-&gt;apitch
op_assign
op_minus
l_int|1
suffix:semicolon
id|calc_volume
c_func
(paren
id|vp
)paren
suffix:semicolon
id|calc_pitch
c_func
(paren
id|vp
)paren
suffix:semicolon
id|calc_pan
c_func
(paren
id|vp
)paren
suffix:semicolon
id|parm
op_assign
op_amp
id|vp-&gt;reg.parm
suffix:semicolon
multiline_comment|/* compute filter target and correct modulation parameters */
r_if
c_cond
(paren
id|LO_BYTE
c_func
(paren
id|parm-&gt;modatkhld
)paren
op_ge
l_int|0x80
op_logical_and
id|parm-&gt;moddelay
op_ge
l_int|0x8000
)paren
(brace
id|parm-&gt;moddelay
op_assign
l_int|0xbfff
suffix:semicolon
id|pitch
op_assign
(paren
id|HI_BYTE
c_func
(paren
id|parm-&gt;pefe
)paren
op_lshift
l_int|4
)paren
op_plus
id|vp-&gt;apitch
suffix:semicolon
r_if
c_cond
(paren
id|pitch
OG
l_int|0xffff
)paren
id|pitch
op_assign
l_int|0xffff
suffix:semicolon
multiline_comment|/* calculate filter target */
id|vp-&gt;ftarget
op_assign
id|parm-&gt;cutoff
op_plus
id|LO_BYTE
c_func
(paren
id|parm-&gt;pefe
)paren
suffix:semicolon
id|LIMITVALUE
c_func
(paren
id|vp-&gt;ftarget
comma
l_int|0
comma
l_int|255
)paren
suffix:semicolon
id|vp-&gt;ftarget
op_lshift_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|vp-&gt;ftarget
op_assign
id|parm-&gt;cutoff
suffix:semicolon
id|vp-&gt;ftarget
op_lshift_assign
l_int|8
suffix:semicolon
id|pitch
op_assign
id|vp-&gt;apitch
suffix:semicolon
)brace
multiline_comment|/* compute pitch target */
r_if
c_cond
(paren
id|pitch
op_ne
l_int|0xffff
)paren
(brace
id|vp-&gt;ptarget
op_assign
l_int|1
op_lshift
(paren
id|pitch
op_rshift
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pitch
op_amp
l_int|0x800
)paren
id|vp-&gt;ptarget
op_add_assign
(paren
id|vp-&gt;ptarget
op_star
l_int|0x102e
)paren
op_div
l_int|0x2710
suffix:semicolon
r_if
c_cond
(paren
id|pitch
op_amp
l_int|0x400
)paren
id|vp-&gt;ptarget
op_add_assign
(paren
id|vp-&gt;ptarget
op_star
l_int|0x764
)paren
op_div
l_int|0x2710
suffix:semicolon
r_if
c_cond
(paren
id|pitch
op_amp
l_int|0x200
)paren
id|vp-&gt;ptarget
op_add_assign
(paren
id|vp-&gt;ptarget
op_star
l_int|0x389
)paren
op_div
l_int|0x2710
suffix:semicolon
id|vp-&gt;ptarget
op_add_assign
(paren
id|vp-&gt;ptarget
op_rshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;ptarget
OG
l_int|0xffff
)paren
id|vp-&gt;ptarget
op_assign
l_int|0xffff
suffix:semicolon
)brace
r_else
id|vp-&gt;ptarget
op_assign
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|LO_BYTE
c_func
(paren
id|parm-&gt;modatkhld
)paren
op_ge
l_int|0x80
)paren
(brace
id|parm-&gt;modatkhld
op_and_assign
op_complement
l_int|0xff
suffix:semicolon
id|parm-&gt;modatkhld
op_or_assign
l_int|0x7f
suffix:semicolon
)brace
multiline_comment|/* compute volume target and correct volume parameters */
id|vp-&gt;vtarget
op_assign
l_int|0
suffix:semicolon
macro_line|#if 0 /* FIXME: this leads to some clicks.. */
r_if
c_cond
(paren
id|LO_BYTE
c_func
(paren
id|parm-&gt;volatkhld
)paren
op_ge
l_int|0x80
op_logical_and
id|parm-&gt;voldelay
op_ge
l_int|0x8000
)paren
(brace
id|parm-&gt;voldelay
op_assign
l_int|0xbfff
suffix:semicolon
id|vp-&gt;vtarget
op_assign
id|voltarget
(braket
id|vp-&gt;avol
op_mod
l_int|0x10
)braket
op_rshift
(paren
id|vp-&gt;avol
op_rshift
l_int|4
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|LO_BYTE
c_func
(paren
id|parm-&gt;volatkhld
)paren
op_ge
l_int|0x80
)paren
(brace
id|parm-&gt;volatkhld
op_and_assign
op_complement
l_int|0xff
suffix:semicolon
id|parm-&gt;volatkhld
op_or_assign
l_int|0x7f
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * calculate pitch parameter&n; */
DECL|variable|pan_volumes
r_static
r_int
r_char
id|pan_volumes
(braket
l_int|256
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x03
comma
l_int|0x06
comma
l_int|0x09
comma
l_int|0x0c
comma
l_int|0x0f
comma
l_int|0x12
comma
l_int|0x14
comma
l_int|0x17
comma
l_int|0x1a
comma
l_int|0x1d
comma
l_int|0x20
comma
l_int|0x22
comma
l_int|0x25
comma
l_int|0x28
comma
l_int|0x2a
comma
l_int|0x2d
comma
l_int|0x30
comma
l_int|0x32
comma
l_int|0x35
comma
l_int|0x37
comma
l_int|0x3a
comma
l_int|0x3c
comma
l_int|0x3f
comma
l_int|0x41
comma
l_int|0x44
comma
l_int|0x46
comma
l_int|0x49
comma
l_int|0x4b
comma
l_int|0x4d
comma
l_int|0x50
comma
l_int|0x52
comma
l_int|0x54
comma
l_int|0x57
comma
l_int|0x59
comma
l_int|0x5b
comma
l_int|0x5d
comma
l_int|0x60
comma
l_int|0x62
comma
l_int|0x64
comma
l_int|0x66
comma
l_int|0x68
comma
l_int|0x6a
comma
l_int|0x6c
comma
l_int|0x6f
comma
l_int|0x71
comma
l_int|0x73
comma
l_int|0x75
comma
l_int|0x77
comma
l_int|0x79
comma
l_int|0x7b
comma
l_int|0x7c
comma
l_int|0x7e
comma
l_int|0x80
comma
l_int|0x82
comma
l_int|0x84
comma
l_int|0x86
comma
l_int|0x88
comma
l_int|0x89
comma
l_int|0x8b
comma
l_int|0x8d
comma
l_int|0x8f
comma
l_int|0x90
comma
l_int|0x92
comma
l_int|0x94
comma
l_int|0x96
comma
l_int|0x97
comma
l_int|0x99
comma
l_int|0x9a
comma
l_int|0x9c
comma
l_int|0x9e
comma
l_int|0x9f
comma
l_int|0xa1
comma
l_int|0xa2
comma
l_int|0xa4
comma
l_int|0xa5
comma
l_int|0xa7
comma
l_int|0xa8
comma
l_int|0xaa
comma
l_int|0xab
comma
l_int|0xad
comma
l_int|0xae
comma
l_int|0xaf
comma
l_int|0xb1
comma
l_int|0xb2
comma
l_int|0xb3
comma
l_int|0xb5
comma
l_int|0xb6
comma
l_int|0xb7
comma
l_int|0xb9
comma
l_int|0xba
comma
l_int|0xbb
comma
l_int|0xbc
comma
l_int|0xbe
comma
l_int|0xbf
comma
l_int|0xc0
comma
l_int|0xc1
comma
l_int|0xc2
comma
l_int|0xc3
comma
l_int|0xc5
comma
l_int|0xc6
comma
l_int|0xc7
comma
l_int|0xc8
comma
l_int|0xc9
comma
l_int|0xca
comma
l_int|0xcb
comma
l_int|0xcc
comma
l_int|0xcd
comma
l_int|0xce
comma
l_int|0xcf
comma
l_int|0xd0
comma
l_int|0xd1
comma
l_int|0xd2
comma
l_int|0xd3
comma
l_int|0xd4
comma
l_int|0xd5
comma
l_int|0xd6
comma
l_int|0xd7
comma
l_int|0xd7
comma
l_int|0xd8
comma
l_int|0xd9
comma
l_int|0xda
comma
l_int|0xdb
comma
l_int|0xdc
comma
l_int|0xdc
comma
l_int|0xdd
comma
l_int|0xde
comma
l_int|0xdf
comma
l_int|0xdf
comma
l_int|0xe0
comma
l_int|0xe1
comma
l_int|0xe2
comma
l_int|0xe2
comma
l_int|0xe3
comma
l_int|0xe4
comma
l_int|0xe4
comma
l_int|0xe5
comma
l_int|0xe6
comma
l_int|0xe6
comma
l_int|0xe7
comma
l_int|0xe8
comma
l_int|0xe8
comma
l_int|0xe9
comma
l_int|0xe9
comma
l_int|0xea
comma
l_int|0xeb
comma
l_int|0xeb
comma
l_int|0xec
comma
l_int|0xec
comma
l_int|0xed
comma
l_int|0xed
comma
l_int|0xee
comma
l_int|0xee
comma
l_int|0xef
comma
l_int|0xef
comma
l_int|0xf0
comma
l_int|0xf0
comma
l_int|0xf1
comma
l_int|0xf1
comma
l_int|0xf1
comma
l_int|0xf2
comma
l_int|0xf2
comma
l_int|0xf3
comma
l_int|0xf3
comma
l_int|0xf3
comma
l_int|0xf4
comma
l_int|0xf4
comma
l_int|0xf5
comma
l_int|0xf5
comma
l_int|0xf5
comma
l_int|0xf6
comma
l_int|0xf6
comma
l_int|0xf6
comma
l_int|0xf7
comma
l_int|0xf7
comma
l_int|0xf7
comma
l_int|0xf7
comma
l_int|0xf8
comma
l_int|0xf8
comma
l_int|0xf8
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xf9
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfa
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfb
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfc
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfd
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xfe
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|calc_pan
id|calc_pan
c_func
(paren
id|snd_emux_voice_t
op_star
id|vp
)paren
(brace
id|snd_midi_channel_t
op_star
id|chan
op_assign
id|vp-&gt;chan
suffix:semicolon
r_int
id|pan
suffix:semicolon
multiline_comment|/* pan &amp; loop start (pan 8bit, MSB, 0:right, 0xff:left) */
r_if
c_cond
(paren
id|vp-&gt;reg.fixpan
OG
l_int|0
)paren
multiline_comment|/* 0-127 */
id|pan
op_assign
l_int|255
op_minus
(paren
r_int
)paren
id|vp-&gt;reg.fixpan
op_star
l_int|2
suffix:semicolon
r_else
(brace
id|pan
op_assign
id|chan-&gt;control
(braket
id|MIDI_CTL_MSB_PAN
)braket
op_minus
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;reg.pan
op_ge
l_int|0
)paren
multiline_comment|/* 0-127 */
id|pan
op_add_assign
id|vp-&gt;reg.pan
op_minus
l_int|64
suffix:semicolon
id|pan
op_assign
l_int|127
op_minus
(paren
r_int
)paren
id|pan
op_star
l_int|2
suffix:semicolon
)brace
id|LIMITVALUE
c_func
(paren
id|pan
comma
l_int|0
comma
l_int|255
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;emu-&gt;linear_panning
)paren
(brace
multiline_comment|/* assuming linear volume */
r_if
c_cond
(paren
id|pan
op_ne
id|vp-&gt;apan
)paren
(brace
id|vp-&gt;apan
op_assign
id|pan
suffix:semicolon
r_if
c_cond
(paren
id|pan
op_eq
l_int|0
)paren
id|vp-&gt;aaux
op_assign
l_int|0xff
suffix:semicolon
r_else
id|vp-&gt;aaux
op_assign
(paren
op_minus
id|pan
)paren
op_amp
l_int|0xff
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* using volume table */
r_if
c_cond
(paren
id|vp-&gt;apan
op_ne
(paren
r_int
)paren
id|pan_volumes
(braket
id|pan
)braket
)paren
(brace
id|vp-&gt;apan
op_assign
id|pan_volumes
(braket
id|pan
)braket
suffix:semicolon
id|vp-&gt;aaux
op_assign
id|pan_volumes
(braket
l_int|255
op_minus
id|pan
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * calculate volume attenuation&n; *&n; * Voice volume is controlled by volume attenuation parameter.&n; * So volume becomes maximum when avol is 0 (no attenuation), and&n; * minimum when 255 (-96dB or silence).&n; */
multiline_comment|/* tables for volume-&gt;attenuation calculation */
DECL|variable|voltab1
r_static
r_int
r_char
id|voltab1
(braket
l_int|128
)braket
op_assign
(brace
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x63
comma
l_int|0x2b
comma
l_int|0x29
comma
l_int|0x28
comma
l_int|0x27
comma
l_int|0x26
comma
l_int|0x25
comma
l_int|0x24
comma
l_int|0x23
comma
l_int|0x22
comma
l_int|0x21
comma
l_int|0x20
comma
l_int|0x1f
comma
l_int|0x1e
comma
l_int|0x1e
comma
l_int|0x1d
comma
l_int|0x1c
comma
l_int|0x1b
comma
l_int|0x1b
comma
l_int|0x1a
comma
l_int|0x19
comma
l_int|0x19
comma
l_int|0x18
comma
l_int|0x17
comma
l_int|0x17
comma
l_int|0x16
comma
l_int|0x16
comma
l_int|0x15
comma
l_int|0x15
comma
l_int|0x14
comma
l_int|0x14
comma
l_int|0x13
comma
l_int|0x13
comma
l_int|0x13
comma
l_int|0x12
comma
l_int|0x12
comma
l_int|0x11
comma
l_int|0x11
comma
l_int|0x11
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|voltab2
r_static
r_int
r_char
id|voltab2
(braket
l_int|128
)braket
op_assign
(brace
l_int|0x32
comma
l_int|0x31
comma
l_int|0x30
comma
l_int|0x2f
comma
l_int|0x2e
comma
l_int|0x2d
comma
l_int|0x2c
comma
l_int|0x2b
comma
l_int|0x2a
comma
l_int|0x2a
comma
l_int|0x29
comma
l_int|0x28
comma
l_int|0x27
comma
l_int|0x26
comma
l_int|0x25
comma
l_int|0x24
comma
l_int|0x24
comma
l_int|0x23
comma
l_int|0x22
comma
l_int|0x21
comma
l_int|0x21
comma
l_int|0x20
comma
l_int|0x1f
comma
l_int|0x1e
comma
l_int|0x1e
comma
l_int|0x1d
comma
l_int|0x1c
comma
l_int|0x1c
comma
l_int|0x1b
comma
l_int|0x1a
comma
l_int|0x1a
comma
l_int|0x19
comma
l_int|0x19
comma
l_int|0x18
comma
l_int|0x18
comma
l_int|0x17
comma
l_int|0x16
comma
l_int|0x16
comma
l_int|0x15
comma
l_int|0x15
comma
l_int|0x14
comma
l_int|0x14
comma
l_int|0x13
comma
l_int|0x13
comma
l_int|0x13
comma
l_int|0x12
comma
l_int|0x12
comma
l_int|0x11
comma
l_int|0x11
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|variable|expressiontab
r_static
r_int
r_char
id|expressiontab
(braket
l_int|128
)braket
op_assign
(brace
l_int|0x7f
comma
l_int|0x6c
comma
l_int|0x62
comma
l_int|0x5a
comma
l_int|0x54
comma
l_int|0x50
comma
l_int|0x4b
comma
l_int|0x48
comma
l_int|0x45
comma
l_int|0x42
comma
l_int|0x40
comma
l_int|0x3d
comma
l_int|0x3b
comma
l_int|0x39
comma
l_int|0x38
comma
l_int|0x36
comma
l_int|0x34
comma
l_int|0x33
comma
l_int|0x31
comma
l_int|0x30
comma
l_int|0x2f
comma
l_int|0x2d
comma
l_int|0x2c
comma
l_int|0x2b
comma
l_int|0x2a
comma
l_int|0x29
comma
l_int|0x28
comma
l_int|0x27
comma
l_int|0x26
comma
l_int|0x25
comma
l_int|0x24
comma
l_int|0x24
comma
l_int|0x23
comma
l_int|0x22
comma
l_int|0x21
comma
l_int|0x21
comma
l_int|0x20
comma
l_int|0x1f
comma
l_int|0x1e
comma
l_int|0x1e
comma
l_int|0x1d
comma
l_int|0x1d
comma
l_int|0x1c
comma
l_int|0x1b
comma
l_int|0x1b
comma
l_int|0x1a
comma
l_int|0x1a
comma
l_int|0x19
comma
l_int|0x18
comma
l_int|0x18
comma
l_int|0x17
comma
l_int|0x17
comma
l_int|0x16
comma
l_int|0x16
comma
l_int|0x15
comma
l_int|0x15
comma
l_int|0x15
comma
l_int|0x14
comma
l_int|0x14
comma
l_int|0x13
comma
l_int|0x13
comma
l_int|0x12
comma
l_int|0x12
comma
l_int|0x11
comma
l_int|0x11
comma
l_int|0x11
comma
l_int|0x10
comma
l_int|0x10
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0f
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0e
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0d
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0c
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0b
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x0a
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x09
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x08
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x07
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x06
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x05
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x04
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x02
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
multiline_comment|/*&n; * Magic to calculate the volume (actually attenuation) from all the&n; * voice and channels parameters.&n; */
r_static
r_int
DECL|function|calc_volume
id|calc_volume
c_func
(paren
id|snd_emux_voice_t
op_star
id|vp
)paren
(brace
r_int
id|vol
suffix:semicolon
r_int
id|main_vol
comma
id|expression_vol
comma
id|master_vol
suffix:semicolon
id|snd_midi_channel_t
op_star
id|chan
op_assign
id|vp-&gt;chan
suffix:semicolon
id|snd_emux_port_t
op_star
id|port
op_assign
id|vp-&gt;port
suffix:semicolon
id|expression_vol
op_assign
id|chan-&gt;control
(braket
id|MIDI_CTL_MSB_EXPRESSION
)braket
suffix:semicolon
id|LIMITMAX
c_func
(paren
id|vp-&gt;velocity
comma
l_int|127
)paren
suffix:semicolon
id|LIMITVALUE
c_func
(paren
id|expression_vol
comma
l_int|0
comma
l_int|127
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;port_mode
op_eq
id|SNDRV_EMUX_PORT_MODE_OSS_SYNTH
)paren
(brace
multiline_comment|/* 0 - 127 */
id|main_vol
op_assign
id|chan-&gt;control
(braket
id|MIDI_CTL_MSB_MAIN_VOLUME
)braket
suffix:semicolon
id|vol
op_assign
(paren
id|vp-&gt;velocity
op_star
id|main_vol
op_star
id|expression_vol
)paren
op_div
(paren
l_int|127
op_star
l_int|127
)paren
suffix:semicolon
id|vol
op_assign
id|vol
op_star
id|vp-&gt;reg.amplitude
op_div
l_int|127
suffix:semicolon
id|LIMITVALUE
c_func
(paren
id|vol
comma
l_int|0
comma
l_int|127
)paren
suffix:semicolon
multiline_comment|/* calc to attenuation */
id|vol
op_assign
id|snd_sf_vol_table
(braket
id|vol
)braket
suffix:semicolon
)brace
r_else
(brace
id|main_vol
op_assign
id|chan-&gt;control
(braket
id|MIDI_CTL_MSB_MAIN_VOLUME
)braket
op_star
id|vp-&gt;reg.amplitude
op_div
l_int|127
suffix:semicolon
id|LIMITVALUE
c_func
(paren
id|main_vol
comma
l_int|0
comma
l_int|127
)paren
suffix:semicolon
id|vol
op_assign
id|voltab1
(braket
id|main_vol
)braket
op_plus
id|voltab2
(braket
id|vp-&gt;velocity
)braket
suffix:semicolon
id|vol
op_assign
(paren
id|vol
op_star
l_int|8
)paren
op_div
l_int|3
suffix:semicolon
id|vol
op_add_assign
id|vp-&gt;reg.attenuation
suffix:semicolon
id|vol
op_add_assign
(paren
(paren
l_int|0x100
op_minus
id|vol
)paren
op_star
id|expressiontab
(braket
id|expression_vol
)braket
)paren
op_div
l_int|128
suffix:semicolon
)brace
id|master_vol
op_assign
id|port-&gt;chset.gs_master_volume
suffix:semicolon
id|LIMITVALUE
c_func
(paren
id|master_vol
comma
l_int|0
comma
l_int|127
)paren
suffix:semicolon
id|vol
op_add_assign
id|snd_sf_vol_table
(braket
id|master_vol
)braket
suffix:semicolon
id|vol
op_add_assign
id|port-&gt;volume_atten
suffix:semicolon
macro_line|#ifdef SNDRV_EMUX_USE_RAW_EFFECT
r_if
c_cond
(paren
id|chan
op_member_access_from_pointer
r_private
)paren
(brace
id|snd_emux_effect_table_t
op_star
id|fx
op_assign
id|chan
op_member_access_from_pointer
r_private
suffix:semicolon
id|vol
op_add_assign
id|fx-&gt;val
(braket
id|EMUX_FX_ATTEN
)braket
suffix:semicolon
)brace
macro_line|#endif
id|LIMITVALUE
c_func
(paren
id|vol
comma
l_int|0
comma
l_int|255
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;avol
op_eq
id|vol
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* value unchanged */
id|vp-&gt;avol
op_assign
id|vol
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|SF_IS_DRUM_BANK
c_func
(paren
id|get_bank
c_func
(paren
id|port
comma
id|chan
)paren
)paren
op_logical_and
id|LO_BYTE
c_func
(paren
id|vp-&gt;reg.parm.volatkhld
)paren
OL
l_int|0x7d
)paren
(brace
r_int
id|atten
suffix:semicolon
r_if
c_cond
(paren
id|vp-&gt;velocity
OL
l_int|70
)paren
id|atten
op_assign
l_int|70
suffix:semicolon
r_else
id|atten
op_assign
id|vp-&gt;velocity
suffix:semicolon
id|vp-&gt;acutoff
op_assign
(paren
id|atten
op_star
id|vp-&gt;reg.parm.cutoff
op_plus
l_int|0xa0
)paren
op_rshift
l_int|7
suffix:semicolon
)brace
r_else
(brace
id|vp-&gt;acutoff
op_assign
id|vp-&gt;reg.parm.cutoff
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* value changed */
)brace
multiline_comment|/*&n; * calculate pitch offset&n; *&n; * 0xE000 is no pitch offset at 44100Hz sample.&n; * Every 4096 is one octave.&n; */
r_static
r_int
DECL|function|calc_pitch
id|calc_pitch
c_func
(paren
id|snd_emux_voice_t
op_star
id|vp
)paren
(brace
id|snd_midi_channel_t
op_star
id|chan
op_assign
id|vp-&gt;chan
suffix:semicolon
r_int
id|offset
suffix:semicolon
multiline_comment|/* calculate offset */
r_if
c_cond
(paren
id|vp-&gt;reg.fixkey
op_ge
l_int|0
)paren
(brace
id|offset
op_assign
(paren
id|vp-&gt;reg.fixkey
op_minus
id|vp-&gt;reg.root
)paren
op_star
l_int|4096
op_div
l_int|12
suffix:semicolon
)brace
r_else
(brace
id|offset
op_assign
(paren
id|vp-&gt;note
op_minus
id|vp-&gt;reg.root
)paren
op_star
l_int|4096
op_div
l_int|12
suffix:semicolon
)brace
id|offset
op_assign
(paren
id|offset
op_star
id|vp-&gt;reg.scaleTuning
)paren
op_div
l_int|100
suffix:semicolon
id|offset
op_add_assign
id|vp-&gt;reg.tune
op_star
l_int|4096
op_div
l_int|1200
suffix:semicolon
r_if
c_cond
(paren
id|chan-&gt;midi_pitchbend
op_ne
l_int|0
)paren
(brace
multiline_comment|/* (128 * 8192: 1 semitone) ==&gt; (4096: 12 semitones) */
id|offset
op_add_assign
id|chan-&gt;midi_pitchbend
op_star
id|chan-&gt;gm_rpn_pitch_bend_range
op_div
l_int|3072
suffix:semicolon
)brace
multiline_comment|/* tuning via RPN:&n;&t; *   coarse = -8192 to 8192 (100 cent per 128)&n;&t; *   fine = -8192 to 8192 (max=100cent)&n;&t; */
multiline_comment|/* 4096 = 1200 cents in emu8000 parameter */
id|offset
op_add_assign
id|chan-&gt;gm_rpn_coarse_tuning
op_star
l_int|4096
op_div
(paren
l_int|12
op_star
l_int|128
)paren
suffix:semicolon
id|offset
op_add_assign
id|chan-&gt;gm_rpn_fine_tuning
op_div
l_int|24
suffix:semicolon
macro_line|#ifdef SNDRV_EMUX_USE_RAW_EFFECT
multiline_comment|/* add initial pitch correction */
r_if
c_cond
(paren
id|chan
op_member_access_from_pointer
r_private
)paren
(brace
id|snd_emux_effect_table_t
op_star
id|fx
op_assign
id|chan
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|fx-&gt;flag
(braket
id|EMUX_FX_INIT_PITCH
)braket
)paren
id|offset
op_add_assign
id|fx-&gt;val
(braket
id|EMUX_FX_INIT_PITCH
)braket
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* 0xe000: root pitch */
id|offset
op_add_assign
l_int|0xe000
op_plus
id|vp-&gt;reg.rate_offset
suffix:semicolon
id|offset
op_add_assign
id|vp-&gt;emu-&gt;pitch_shift
suffix:semicolon
id|LIMITVALUE
c_func
(paren
id|offset
comma
l_int|0
comma
l_int|0xffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|vp-&gt;apitch
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* unchanged */
id|vp-&gt;apitch
op_assign
id|offset
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* value changed */
)brace
multiline_comment|/*&n; * Get the bank number assigned to the channel&n; */
r_static
r_int
DECL|function|get_bank
id|get_bank
c_func
(paren
id|snd_emux_port_t
op_star
id|port
comma
id|snd_midi_channel_t
op_star
id|chan
)paren
(brace
r_int
id|val
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;chset.midi_mode
)paren
(brace
r_case
id|SNDRV_MIDI_MODE_XG
suffix:colon
id|val
op_assign
id|chan-&gt;control
(braket
id|MIDI_CTL_MSB_BANK
)braket
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
l_int|127
)paren
r_return
l_int|128
suffix:semicolon
multiline_comment|/* return drum bank */
r_return
id|chan-&gt;control
(braket
id|MIDI_CTL_LSB_BANK
)braket
suffix:semicolon
r_case
id|SNDRV_MIDI_MODE_GS
suffix:colon
r_if
c_cond
(paren
id|chan-&gt;drum_channel
)paren
r_return
l_int|128
suffix:semicolon
multiline_comment|/* ignore LSB (bank map) */
r_return
id|chan-&gt;control
(braket
id|MIDI_CTL_MSB_BANK
)braket
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|chan-&gt;drum_channel
)paren
r_return
l_int|128
suffix:semicolon
r_return
id|chan-&gt;control
(braket
id|MIDI_CTL_MSB_BANK
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/* Look for the zones matching with the given note and velocity.&n; * The resultant zones are stored on table.&n; */
r_static
r_int
DECL|function|get_zone
id|get_zone
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
id|snd_emux_port_t
op_star
id|port
comma
r_int
op_star
id|notep
comma
r_int
id|vel
comma
id|snd_midi_channel_t
op_star
id|chan
comma
id|snd_sf_zone_t
op_star
op_star
id|table
)paren
(brace
r_int
id|preset
comma
id|bank
comma
id|def_preset
comma
id|def_bank
suffix:semicolon
id|bank
op_assign
id|get_bank
c_func
(paren
id|port
comma
id|chan
)paren
suffix:semicolon
id|preset
op_assign
id|chan-&gt;midi_program
suffix:semicolon
r_if
c_cond
(paren
id|SF_IS_DRUM_BANK
c_func
(paren
id|bank
)paren
)paren
(brace
id|def_preset
op_assign
id|port-&gt;ctrls
(braket
id|EMUX_MD_DEF_DRUM
)braket
suffix:semicolon
id|def_bank
op_assign
id|bank
suffix:semicolon
)brace
r_else
(brace
id|def_preset
op_assign
id|preset
suffix:semicolon
id|def_bank
op_assign
id|port-&gt;ctrls
(braket
id|EMUX_MD_DEF_BANK
)braket
suffix:semicolon
)brace
r_return
id|snd_soundfont_search_zone
c_func
(paren
id|emu-&gt;sflist
comma
id|notep
comma
id|vel
comma
id|preset
comma
id|bank
comma
id|def_preset
comma
id|def_bank
comma
id|table
comma
id|SNDRV_EMUX_MAX_MULTI_VOICES
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
r_void
DECL|function|snd_emux_init_voices
id|snd_emux_init_voices
c_func
(paren
id|snd_emux_t
op_star
id|emu
)paren
(brace
id|snd_emux_voice_t
op_star
id|vp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|emu-&gt;max_voices
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vp
op_assign
op_amp
id|emu-&gt;voices
(braket
id|i
)braket
suffix:semicolon
id|vp-&gt;ch
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* not used */
id|vp-&gt;state
op_assign
id|SNDRV_EMUX_ST_OFF
suffix:semicolon
id|vp-&gt;chan
op_assign
l_int|NULL
suffix:semicolon
id|vp-&gt;port
op_assign
l_int|NULL
suffix:semicolon
id|vp-&gt;time
op_assign
l_int|0
suffix:semicolon
id|vp-&gt;emu
op_assign
id|emu
suffix:semicolon
id|vp-&gt;hw
op_assign
id|emu-&gt;hw
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|snd_emux_lock_voice
r_void
id|snd_emux_lock_voice
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
r_int
id|voice
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;voices
(braket
id|voice
)braket
dot
id|state
op_eq
id|SNDRV_EMUX_ST_OFF
)paren
id|emu-&gt;voices
(braket
id|voice
)braket
dot
id|state
op_assign
id|SNDRV_EMUX_ST_LOCKED
suffix:semicolon
r_else
id|snd_printk
c_func
(paren
l_string|&quot;invalid voice for lock %d (state = %x)&bslash;n&quot;
comma
id|voice
comma
id|emu-&gt;voices
(braket
id|voice
)braket
dot
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|snd_emux_unlock_voice
r_void
id|snd_emux_unlock_voice
c_func
(paren
id|snd_emux_t
op_star
id|emu
comma
r_int
id|voice
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emu-&gt;voices
(braket
id|voice
)braket
dot
id|state
op_eq
id|SNDRV_EMUX_ST_LOCKED
)paren
id|emu-&gt;voices
(braket
id|voice
)braket
dot
id|state
op_assign
id|SNDRV_EMUX_ST_OFF
suffix:semicolon
r_else
id|snd_printk
c_func
(paren
l_string|&quot;invalid voice for unlock %d (state = %x)&bslash;n&quot;
comma
id|voice
comma
id|emu-&gt;voices
(braket
id|voice
)braket
dot
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emu-&gt;voice_lock
comma
id|flags
)paren
suffix:semicolon
)brace
eof
