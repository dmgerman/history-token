multiline_comment|/*&n; *  Harmony chipset driver&n; *&n; *&t;This is a sound driver for ASP&squot;s and Lasi&squot;s Harmony sound chip&n; *&t;and is unlikely to be used for anything other than on a HP PA-RISC.&n; *&n; *&t;Harmony is found in HP 712s, 715/new and many other GSC based machines.&n; *&t;On older 715 machines you&squot;ll find the technically identical chip &n; *&t;called &squot;Vivace&squot;. Both Harmony and Vicace are supported by this driver.&n; *&n; *  this ALSA driver is based on OSS driver by:&n; *&t;Copyright 2000 (c) Linuxcare Canada, Alex deVries &lt;alex@linuxcare.com&gt;&n; *&t;Copyright 2000-2002 (c) Helge Deller &lt;deller@gmx.de&gt;&n; *&t;Copyright 2001 (c) Matthieu Delahaye &lt;delahaym@esiee.fr&gt;&n; *&n; * TODO:&n; * - use generic DMA interface and ioremap()/iounmap()&n; * - capture is still untested (and probaby non-working)&n; * - spin locks&n; * - implement non-consistent DMA pages&n; * - implement gain meter&n; * - module parameters&n; * - correct cleaning sequence&n; * - better error checking&n; * - try to have a better quality.&n; *   &n; */
multiline_comment|/*&n; * Harmony chipset &squot;modus operandi&squot;.&n; * - This chipset is found in some HP 32bit workstations, like 712, or B132 class.&n; * most of controls are done through registers. Register are found at a fixed offset&n; * from the hard physical adress, given in struct dev by register_parisc_driver.&n; *&n; * Playback and recording use 4kb pages (dma or not, depending on the machine).&n; *&n; * Most of PCM playback &amp; capture is done through interrupt. When harmony needs&n; * a new buffer to put recorded data or read played PCM, it sends an interrupt.&n; * Bits 2 and 10 of DSTATUS register are &squot;1&squot; when harmony needs respectively&n; * a new page for recording and playing. &n; * Interrupt are disabled/enabled by writing to bit 32 of DSTATUS. &n; * Adresses of next page to be played is put in PNXTADD register, next page&n; * to be recorded is put in RNXTADD. There is 2 read-only registers, PCURADD and &n; * RCURADD that provides adress of current page.&n; * &n; * Harmony has no way to controll full duplex or half duplex mode. It means&n; * that we always need to provide adresses of playback and capture data, even&n; * when this is not needed. That&squot;s why we statically alloc one graveyard&n; * buffer (to put recorded data in play-only mode) and a silence buffer.&n; * &n; * Bitrate, number of channels and data format are controlled with&n; * the CNTL register.&n; *&n; * Mixer work is done through one register (GAINCTL). Only input gain,&n; * output attenuation and general attenuation control is provided. There is&n; * also controls for enabling/disabling internal speaker and line&n; * input.&n; *&n; * Buffers used by this driver are all DMA consistent. Since harmony is&n; * not &quot;real&quot; pci device, we use a fake struct pci_dev for&n; * pci_alloc_consistent().&n; * (note that some machines -712 for ex.- don&squot;t implement DMA consistent&n; * memory, so we will need to use kmalloc instead)&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;sound/driver.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;sound/core.h&gt;
macro_line|#include &lt;sound/control.h&gt;
macro_line|#include &lt;sound/pcm.h&gt;
macro_line|#include &lt;sound/rawmidi.h&gt;
macro_line|#include &lt;sound/initval.h&gt;
macro_line|#include &lt;sound/info.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/parisc-device.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Laurent Canet &lt;canetl@esiee.fr&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ALSA Harmony sound driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_CLASSES
c_func
(paren
l_string|&quot;{sound}&quot;
)paren
suffix:semicolon
id|MODULE_DEVICES
c_func
(paren
l_string|&quot;{{ALSA,Harmony soundcard}}&quot;
)paren
suffix:semicolon
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#ifdef DEBUG
DECL|macro|DPRINTK
macro_line|# define DPRINTK printk 
macro_line|#else
DECL|macro|DPRINTK
macro_line|# define DPRINTK(x,...)
macro_line|#endif
DECL|macro|PFX
mdefine_line|#define PFX&t;&quot;harmony: &quot;
DECL|macro|MAX_PCM_DEVICES
mdefine_line|#define MAX_PCM_DEVICES&t;&t;1
DECL|macro|MAX_PCM_SUBSTREAMS
mdefine_line|#define MAX_PCM_SUBSTREAMS&t;4
DECL|macro|MAX_MIDI_DEVICES
mdefine_line|#define MAX_MIDI_DEVICES&t;0
DECL|macro|BUFFER_SIZE
mdefine_line|#define BUFFER_SIZE&t;&t;&t;4096
DECL|macro|MAX_BUFS
mdefine_line|#define MAX_BUFS&t;&t;&t;10
multiline_comment|/* number of silence &amp; graveyard buffers */
DECL|macro|GRAVEYARD_BUFS
mdefine_line|#define GRAVEYARD_BUFS&t;&t;3
DECL|macro|SILENCE_BUFS
mdefine_line|#define SILENCE_BUFS&t;&t;3
DECL|macro|MAX_BUFFER_SIZE
mdefine_line|#define MAX_BUFFER_SIZE&t;&t;(MAX_BUFS * BUFFER_SIZE)
DECL|macro|HARMONY_BUF_SIZE
mdefine_line|#define HARMONY_BUF_SIZE&t;BUFFER_SIZE
DECL|macro|HARMONY_CNTL_C
mdefine_line|#define HARMONY_CNTL_C&t;&t;0x80000000
DECL|macro|HARMONY_DSTATUS_PN
mdefine_line|#define HARMONY_DSTATUS_PN&t;0x00000200
DECL|macro|HARMONY_DSTATUS_RN
mdefine_line|#define HARMONY_DSTATUS_RN&t;0x00000002
DECL|macro|HARMONY_DSTATUS_IE
mdefine_line|#define HARMONY_DSTATUS_IE&t;0x80000000
DECL|macro|HARMONY_DF_16BIT_LINEAR
mdefine_line|#define HARMONY_DF_16BIT_LINEAR&t;0x00000000
DECL|macro|HARMONY_DF_8BIT_ULAW
mdefine_line|#define HARMONY_DF_8BIT_ULAW&t;0x00000001
DECL|macro|HARMONY_DF_8BIT_ALAW
mdefine_line|#define HARMONY_DF_8BIT_ALAW&t;0x00000002
DECL|macro|HARMONY_SS_MONO
mdefine_line|#define HARMONY_SS_MONO&t;&t;0x00000000
DECL|macro|HARMONY_SS_STEREO
mdefine_line|#define HARMONY_SS_STEREO&t;0x00000001
multiline_comment|/*&n; * Channels Mask in mixer register&n; * try some &quot;reasonable&quot; default gain values&n; */
DECL|macro|HARMONY_GAIN_TOTAL_SILENCE
mdefine_line|#define HARMONY_GAIN_TOTAL_SILENCE 0x00F00FFF
multiline_comment|/* the following should be enough (mixer is &n; * very sensible on harmony)&n; */
DECL|macro|HARMONY_GAIN_DEFAULT
mdefine_line|#define HARMONY_GAIN_DEFAULT       0x0F2FF082
multiline_comment|/* useless since only one card is supported ATM */
DECL|variable|index
r_static
r_int
id|index
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_IDX
suffix:semicolon
multiline_comment|/* Index 0-MAX */
DECL|variable|id
r_static
r_char
op_star
id|id
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_STR
suffix:semicolon
multiline_comment|/* ID for this card */
DECL|variable|enable
r_static
r_int
id|enable
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_ENABLE
suffix:semicolon
DECL|variable|boot_devs
r_static
r_int
id|boot_devs
suffix:semicolon
id|module_param_array
c_func
(paren
id|index
comma
r_int
comma
id|boot_devs
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|index
comma
l_string|&quot;Index value for Sun CS4231 soundcard.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|index
comma
id|SNDRV_INDEX_DESC
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|id
comma
id|charp
comma
id|boot_devs
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|id
comma
l_string|&quot;ID string for Sun CS4231 soundcard.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|id
comma
id|SNDRV_ID_DESC
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|enable
comma
r_bool
comma
id|boot_devs
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|enable
comma
l_string|&quot;Enable Sun CS4231 soundcard.&quot;
)paren
suffix:semicolon
id|MODULE_PARM_SYNTAX
c_func
(paren
id|enable
comma
id|SNDRV_ENABLE_DESC
)paren
suffix:semicolon
multiline_comment|/* Register offset (from base hpa) */
DECL|macro|REG_ID
mdefine_line|#define REG_ID&t;&t;0x00
DECL|macro|REG_RESET
mdefine_line|#define REG_RESET&t;0x04
DECL|macro|REG_CNTL
mdefine_line|#define REG_CNTL&t;0x08
DECL|macro|REG_GAINCTL
mdefine_line|#define REG_GAINCTL&t;0x0C
DECL|macro|REG_PNXTADD
mdefine_line|#define REG_PNXTADD&t;0x10
DECL|macro|REG_PCURADD
mdefine_line|#define REG_PCURADD&t;0x14
DECL|macro|REG_RNXTADD
mdefine_line|#define REG_RNXTADD&t;0x18
DECL|macro|REG_RCURADD
mdefine_line|#define REG_RCURADD&t;0x1C
DECL|macro|REG_DSTATUS
mdefine_line|#define REG_DSTATUS&t;0x20
DECL|macro|REG_OV
mdefine_line|#define REG_OV&t;&t;0x24
DECL|macro|REG_PIO
mdefine_line|#define REG_PIO&t;&t;0x28
DECL|macro|REG_DIAG
mdefine_line|#define REG_DIAG&t;0x3C
multiline_comment|/*&n; * main harmony structure&n; */
DECL|struct|snd_card_harmony
r_typedef
r_struct
id|snd_card_harmony
(brace
multiline_comment|/* spinlocks (To be done) */
DECL|member|mixer_lock
id|spinlock_t
id|mixer_lock
suffix:semicolon
DECL|member|control_lock
id|spinlock_t
id|control_lock
suffix:semicolon
multiline_comment|/* parameters */
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|hpa
r_int
r_int
id|hpa
suffix:semicolon
DECL|member|id
r_int
id|id
suffix:semicolon
DECL|member|rev
r_int
id|rev
suffix:semicolon
DECL|member|current_gain
id|u32
id|current_gain
suffix:semicolon
DECL|member|data_format
r_int
id|data_format
suffix:semicolon
multiline_comment|/* HARMONY_DF_xx_BIT_xxx */
DECL|member|sample_rate
r_int
id|sample_rate
suffix:semicolon
multiline_comment|/* HARMONY_SR_xx_KHZ */
DECL|member|stereo_select
r_int
id|stereo_select
suffix:semicolon
multiline_comment|/* HARMONY_SS_MONO or HARMONY_SS_STEREO */
DECL|member|format_initialized
r_int
id|format_initialized
suffix:semicolon
DECL|member|ply_buffer
r_int
r_int
id|ply_buffer
suffix:semicolon
DECL|member|ply_buf
r_int
id|ply_buf
suffix:semicolon
DECL|member|ply_count
r_int
id|ply_count
suffix:semicolon
DECL|member|ply_size
r_int
id|ply_size
suffix:semicolon
DECL|member|ply_stopped
r_int
id|ply_stopped
suffix:semicolon
DECL|member|ply_total
r_int
id|ply_total
suffix:semicolon
DECL|member|cap_buffer
r_int
r_int
id|cap_buffer
suffix:semicolon
DECL|member|cap_buf
r_int
id|cap_buf
suffix:semicolon
DECL|member|cap_count
r_int
id|cap_count
suffix:semicolon
DECL|member|cap_size
r_int
id|cap_size
suffix:semicolon
DECL|member|cap_stopped
r_int
id|cap_stopped
suffix:semicolon
DECL|member|cap_total
r_int
id|cap_total
suffix:semicolon
DECL|member|fake_pci_dev
r_struct
id|pci_dev
op_star
id|fake_pci_dev
suffix:semicolon
multiline_comment|/* The fake pci_dev needed for &n;&t;&t;&t;&t;&t;pci_* functions under ccio. */
multiline_comment|/* the graveyard buffer is used as recording buffer when playback, &n;&t; * because harmony always want a buffer to put recorded data */
DECL|member|graveyard_addr
r_int
r_char
op_star
id|graveyard_addr
suffix:semicolon
DECL|member|graveyard_dma
id|dma_addr_t
id|graveyard_dma
suffix:semicolon
DECL|member|graveyard_count
r_int
id|graveyard_count
suffix:semicolon
multiline_comment|/* same thing for silence buffer */
DECL|member|silence_addr
r_int
r_char
op_star
id|silence_addr
suffix:semicolon
DECL|member|silence_dma
id|dma_addr_t
id|silence_dma
suffix:semicolon
DECL|member|silence_count
r_int
id|silence_count
suffix:semicolon
DECL|member|dma_dev
r_struct
id|snd_dma_device
id|dma_dev
suffix:semicolon
multiline_comment|/* alsa stuff */
DECL|member|card
id|snd_card_t
op_star
id|card
suffix:semicolon
DECL|member|pcm
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
DECL|member|playback_substream
id|snd_pcm_substream_t
op_star
id|playback_substream
suffix:semicolon
DECL|member|capture_substream
id|snd_pcm_substream_t
op_star
id|capture_substream
suffix:semicolon
DECL|member|proc_entry
id|snd_info_entry_t
op_star
id|proc_entry
suffix:semicolon
DECL|typedef|snd_card_harmony_t
)brace
id|snd_card_harmony_t
suffix:semicolon
DECL|macro|chip_t
mdefine_line|#define chip_t snd_card_harmony_t
DECL|variable|snd_harmony_cards
r_static
id|snd_card_t
op_star
id|snd_harmony_cards
(braket
id|SNDRV_CARDS
)braket
op_assign
id|SNDRV_DEFAULT_PTR
suffix:semicolon
multiline_comment|/* wait to be out of control mode */
DECL|function|snd_harmony_wait_cntl
r_static
r_inline
r_void
id|snd_harmony_wait_cntl
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
r_int
id|timeout
op_assign
l_int|5000
suffix:semicolon
r_while
c_loop
(paren
(paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_CNTL
)paren
op_amp
id|HARMONY_CNTL_C
)paren
op_logical_and
op_decrement
id|timeout
)paren
(brace
multiline_comment|/* Wait */
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
id|DPRINTK
c_func
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;Error: wait cntl timeouted&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * sample rate routines &n; */
DECL|variable|snd_card_harmony_rates
r_static
r_int
r_int
id|snd_card_harmony_rates
(braket
)braket
op_assign
(brace
l_int|5125
comma
l_int|6615
comma
l_int|8000
comma
l_int|9600
comma
l_int|11025
comma
l_int|16000
comma
l_int|18900
comma
l_int|22050
comma
l_int|27428
comma
l_int|32000
comma
l_int|33075
comma
l_int|37800
comma
l_int|44100
comma
l_int|48000
)brace
suffix:semicolon
DECL|macro|RATES
mdefine_line|#define RATES sizeof(snd_card_harmony_rates) / sizeof(snd_card_harmony_rates[0])
DECL|variable|hw_constraint_rates
r_static
id|snd_pcm_hw_constraint_list_t
id|hw_constraint_rates
op_assign
(brace
dot
id|count
op_assign
id|RATES
comma
dot
id|list
op_assign
id|snd_card_harmony_rates
comma
dot
id|mask
op_assign
l_int|0
comma
)brace
suffix:semicolon
DECL|macro|HARMONY_SR_8KHZ
mdefine_line|#define HARMONY_SR_8KHZ&t;&t;0x08
DECL|macro|HARMONY_SR_16KHZ
mdefine_line|#define HARMONY_SR_16KHZ&t;0x09
DECL|macro|HARMONY_SR_27KHZ
mdefine_line|#define HARMONY_SR_27KHZ&t;0x0A
DECL|macro|HARMONY_SR_32KHZ
mdefine_line|#define HARMONY_SR_32KHZ&t;0x0B
DECL|macro|HARMONY_SR_48KHZ
mdefine_line|#define HARMONY_SR_48KHZ&t;0x0E
DECL|macro|HARMONY_SR_9KHZ
mdefine_line|#define HARMONY_SR_9KHZ&t;&t;0x0F
DECL|macro|HARMONY_SR_5KHZ
mdefine_line|#define HARMONY_SR_5KHZ&t;&t;0x10
DECL|macro|HARMONY_SR_11KHZ
mdefine_line|#define HARMONY_SR_11KHZ&t;0x11
DECL|macro|HARMONY_SR_18KHZ
mdefine_line|#define HARMONY_SR_18KHZ&t;0x12
DECL|macro|HARMONY_SR_22KHZ
mdefine_line|#define HARMONY_SR_22KHZ&t;0x13
DECL|macro|HARMONY_SR_37KHZ
mdefine_line|#define HARMONY_SR_37KHZ&t;0x14
DECL|macro|HARMONY_SR_44KHZ
mdefine_line|#define HARMONY_SR_44KHZ&t;0x15
DECL|macro|HARMONY_SR_33KHZ
mdefine_line|#define HARMONY_SR_33KHZ&t;0x16
DECL|macro|HARMONY_SR_6KHZ
mdefine_line|#define HARMONY_SR_6KHZ&t;&t;0x17
multiline_comment|/* snd_card_harmony_rate_bits&n; * @rate:&t;index of current data rate in list&n; * returns: harmony hex code for registers&n; */
DECL|function|snd_card_harmony_rate_bits
r_static
r_int
r_int
id|snd_card_harmony_rate_bits
c_func
(paren
r_int
id|rate
)paren
(brace
r_int
r_int
id|idx
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
op_le
id|RATES
suffix:semicolon
id|idx
op_increment
)paren
r_if
c_cond
(paren
id|snd_card_harmony_rates
(braket
id|idx
)braket
op_eq
id|rate
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|idx
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|HARMONY_SR_5KHZ
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|HARMONY_SR_6KHZ
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
id|HARMONY_SR_8KHZ
suffix:semicolon
r_case
l_int|3
suffix:colon
r_return
id|HARMONY_SR_9KHZ
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
id|HARMONY_SR_11KHZ
suffix:semicolon
r_case
l_int|5
suffix:colon
r_return
id|HARMONY_SR_16KHZ
suffix:semicolon
r_case
l_int|6
suffix:colon
r_return
id|HARMONY_SR_18KHZ
suffix:semicolon
r_case
l_int|7
suffix:colon
r_return
id|HARMONY_SR_22KHZ
suffix:semicolon
r_case
l_int|8
suffix:colon
r_return
id|HARMONY_SR_27KHZ
suffix:semicolon
r_case
l_int|9
suffix:colon
r_return
id|HARMONY_SR_32KHZ
suffix:semicolon
r_case
l_int|10
suffix:colon
r_return
id|HARMONY_SR_33KHZ
suffix:semicolon
r_case
l_int|11
suffix:colon
r_return
id|HARMONY_SR_37KHZ
suffix:semicolon
r_case
l_int|12
suffix:colon
r_return
id|HARMONY_SR_44KHZ
suffix:semicolon
r_case
l_int|13
suffix:colon
r_return
id|HARMONY_SR_48KHZ
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* fallback */
r_return
id|HARMONY_SR_44KHZ
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * update controls (data format, sample rate, number of channels)&n; * according to value supplied in data structure&n; */
DECL|function|snd_harmony_update_control
r_void
id|snd_harmony_update_control
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
id|u32
id|default_cntl
suffix:semicolon
multiline_comment|/* Set CNTL */
id|default_cntl
op_assign
(paren
id|HARMONY_CNTL_C
op_or
multiline_comment|/* The C bit */
(paren
id|harmony-&gt;data_format
op_lshift
l_int|6
)paren
op_or
multiline_comment|/* Set the data format */
(paren
id|harmony-&gt;stereo_select
op_lshift
l_int|5
)paren
op_or
multiline_comment|/* Stereo select */
(paren
id|harmony-&gt;sample_rate
)paren
)paren
suffix:semicolon
multiline_comment|/* Set sample rate */
multiline_comment|/* initialize CNTL */
id|snd_harmony_wait_cntl
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
id|default_cntl
comma
id|harmony-&gt;hpa
op_plus
id|REG_CNTL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * silence a buffer&n; * XXX: alsa could probably do this by itself&n; * XXX: memset hpmc, commented.&n; */
DECL|function|snd_harmony_silence
r_void
id|snd_harmony_silence
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
comma
r_void
op_star
id|addr
comma
r_int
id|length
)paren
(brace
id|u8
id|silence_char
suffix:semicolon
r_switch
c_cond
(paren
id|harmony-&gt;data_format
)paren
(brace
r_case
id|HARMONY_DF_8BIT_ULAW
suffix:colon
id|silence_char
op_assign
l_int|0x55
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_DF_8BIT_ALAW
suffix:colon
id|silence_char
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HARMONY_DF_16BIT_LINEAR
suffix:colon
r_default
suffix:colon
id|silence_char
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|//memset(addr, silence_char, length);
)brace
multiline_comment|/*&n; * interruption controls routines&n; */
DECL|function|snd_harmony_disable_interrupts
r_static
r_void
id|snd_harmony_disable_interrupts
c_func
(paren
id|snd_card_harmony_t
op_star
id|chip
)paren
(brace
id|snd_harmony_wait_cntl
c_func
(paren
id|chip
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
l_int|0
comma
id|chip-&gt;hpa
op_plus
id|REG_DSTATUS
)paren
suffix:semicolon
)brace
DECL|function|snd_harmony_enable_interrupts
r_static
r_void
id|snd_harmony_enable_interrupts
c_func
(paren
id|snd_card_harmony_t
op_star
id|chip
)paren
(brace
id|snd_harmony_wait_cntl
c_func
(paren
id|chip
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
id|HARMONY_DSTATUS_IE
comma
id|chip-&gt;hpa
op_plus
id|REG_DSTATUS
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * interruption routine:&n; * The interrupt routine must provide adresse of next physical pages &n; * used by harmony&n; */
DECL|function|snd_card_harmony_interrupt
r_static
r_int
id|snd_card_harmony_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
(paren
id|snd_card_harmony_t
op_star
)paren
id|dev
suffix:semicolon
id|u32
id|dstatus
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|hpa
op_assign
id|harmony-&gt;hpa
suffix:semicolon
multiline_comment|/* Turn off interrupts */
id|snd_harmony_disable_interrupts
c_func
(paren
id|harmony
)paren
suffix:semicolon
multiline_comment|/* wait for control to free */
id|snd_harmony_wait_cntl
c_func
(paren
id|harmony
)paren
suffix:semicolon
multiline_comment|/* Read dstatus and pcuradd (the current address) */
id|dstatus
op_assign
id|gsc_readl
c_func
(paren
id|hpa
op_plus
id|REG_DSTATUS
)paren
suffix:semicolon
multiline_comment|/* Check if this is a request to get the next play buffer */
r_if
c_cond
(paren
id|dstatus
op_amp
id|HARMONY_DSTATUS_PN
)paren
(brace
r_if
c_cond
(paren
id|harmony-&gt;playback_substream
)paren
(brace
id|harmony-&gt;ply_buf
op_add_assign
id|harmony-&gt;ply_count
suffix:semicolon
id|harmony-&gt;ply_buf
op_mod_assign
id|harmony-&gt;ply_size
suffix:semicolon
id|gsc_writel
c_func
(paren
id|harmony-&gt;ply_buffer
op_plus
id|harmony-&gt;ply_buf
comma
id|hpa
op_plus
id|REG_PNXTADD
)paren
suffix:semicolon
id|snd_pcm_period_elapsed
c_func
(paren
id|harmony-&gt;playback_substream
)paren
suffix:semicolon
id|harmony-&gt;ply_total
op_increment
suffix:semicolon
)brace
r_else
(brace
id|gsc_writel
c_func
(paren
id|harmony-&gt;silence_dma
op_plus
(paren
id|HARMONY_BUF_SIZE
op_star
id|harmony-&gt;silence_count
)paren
comma
id|hpa
op_plus
id|REG_PNXTADD
)paren
suffix:semicolon
id|harmony-&gt;silence_count
op_increment
suffix:semicolon
id|harmony-&gt;silence_count
op_mod_assign
id|SILENCE_BUFS
suffix:semicolon
)brace
)brace
multiline_comment|/* Check if we&squot;re being asked to fill in a recording buffer */
r_if
c_cond
(paren
id|dstatus
op_amp
id|HARMONY_DSTATUS_RN
)paren
(brace
r_if
c_cond
(paren
id|harmony-&gt;capture_substream
)paren
(brace
id|harmony-&gt;cap_buf
op_add_assign
id|harmony-&gt;cap_count
suffix:semicolon
id|harmony-&gt;cap_buf
op_mod_assign
id|harmony-&gt;cap_size
suffix:semicolon
id|gsc_writel
c_func
(paren
id|harmony-&gt;cap_buffer
op_plus
id|harmony-&gt;cap_buf
comma
id|hpa
op_plus
id|REG_RNXTADD
)paren
suffix:semicolon
id|snd_pcm_period_elapsed
c_func
(paren
id|harmony-&gt;capture_substream
)paren
suffix:semicolon
id|harmony-&gt;cap_total
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* graveyard buffer */
id|gsc_writel
c_func
(paren
id|harmony-&gt;graveyard_dma
op_plus
(paren
id|HARMONY_BUF_SIZE
op_star
id|harmony-&gt;graveyard_count
)paren
comma
id|hpa
op_plus
id|REG_RNXTADD
)paren
suffix:semicolon
id|harmony-&gt;graveyard_count
op_increment
suffix:semicolon
id|harmony-&gt;graveyard_count
op_mod_assign
id|GRAVEYARD_BUFS
suffix:semicolon
)brace
)brace
id|snd_harmony_enable_interrupts
c_func
(paren
id|harmony
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* &n; * proc entry&n; * this proc file will give some debugging info&n; */
DECL|function|snd_harmony_proc_read
r_static
r_void
id|snd_harmony_proc_read
c_func
(paren
id|snd_info_entry_t
op_star
id|entry
comma
id|snd_info_buffer_t
op_star
id|buffer
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
(paren
id|snd_card_harmony_t
op_star
)paren
id|entry-&gt;private_data
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;LASI Harmony driver&bslash;nLaurent Canet &lt;canetl@esiee.fr&gt;&bslash;n&bslash;n&quot;
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;IRQ %d, hpa %lx, id %d rev %d&bslash;n&quot;
comma
id|harmony-&gt;irq
comma
id|harmony-&gt;hpa
comma
id|harmony-&gt;id
comma
id|harmony-&gt;rev
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Current gain %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|harmony-&gt;current_gain
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tsample rate=%d&bslash;n&quot;
comma
id|harmony-&gt;sample_rate
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tstereo select=%d&bslash;n&quot;
comma
id|harmony-&gt;stereo_select
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tbitperchan=%d&bslash;n&bslash;n&quot;
comma
id|harmony-&gt;data_format
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Play status:&bslash;n&quot;
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tstopped %d&bslash;n&quot;
comma
id|harmony-&gt;ply_stopped
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tbuffer %lx, count %d&bslash;n&quot;
comma
id|harmony-&gt;ply_buffer
comma
id|harmony-&gt;ply_count
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tbuf %d size %d&bslash;n&bslash;n&quot;
comma
id|harmony-&gt;ply_buf
comma
id|harmony-&gt;ply_size
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Capture status:&bslash;n&quot;
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tstopped %d&bslash;n&quot;
comma
id|harmony-&gt;cap_stopped
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tbuffer %lx, count %d&bslash;n&quot;
comma
id|harmony-&gt;cap_buffer
comma
id|harmony-&gt;cap_count
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tbuf %d, size %d&bslash;n&bslash;n&quot;
comma
id|harmony-&gt;cap_buf
comma
id|harmony-&gt;cap_size
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Funny stats: total played=%d, recorded=%d&bslash;n&bslash;n&quot;
comma
id|harmony-&gt;ply_total
comma
id|harmony-&gt;cap_total
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Register:&bslash;n&quot;
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tgainctl: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_GAINCTL
)paren
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tcntl: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_CNTL
)paren
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tid: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_ID
)paren
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tpcuradd: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_PCURADD
)paren
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;trcuradd: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_RCURADD
)paren
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tpnxtadd: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_PNXTADD
)paren
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;trnxtadd: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_RNXTADD
)paren
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tdstatus: %lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_DSTATUS
)paren
)paren
suffix:semicolon
id|snd_iprintf
c_func
(paren
id|buffer
comma
l_string|&quot;&bslash;tov: %lx&bslash;n&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_OV
)paren
)paren
suffix:semicolon
)brace
DECL|function|snd_harmony_proc_init
r_static
r_void
id|__devinit
id|snd_harmony_proc_init
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
id|snd_info_entry_t
op_star
id|entry
suffix:semicolon
r_if
c_cond
(paren
(paren
id|entry
op_assign
id|snd_info_create_card_entry
c_func
(paren
id|harmony-&gt;card
comma
l_string|&quot;harmony&quot;
comma
id|harmony-&gt;card-&gt;proc_root
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|entry-&gt;content
op_assign
id|SNDRV_INFO_CONTENT_TEXT
suffix:semicolon
id|entry-&gt;private_data
op_assign
id|harmony
suffix:semicolon
id|entry-&gt;mode
op_assign
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
suffix:semicolon
id|entry-&gt;c.text.read_size
op_assign
l_int|2048
suffix:semicolon
multiline_comment|/* should be enough */
id|entry-&gt;c.text.read
op_assign
id|snd_harmony_proc_read
suffix:semicolon
r_if
c_cond
(paren
id|snd_info_register
c_func
(paren
id|entry
)paren
OL
l_int|0
)paren
(brace
id|snd_info_free_entry
c_func
(paren
id|entry
)paren
suffix:semicolon
id|entry
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|harmony-&gt;proc_entry
op_assign
id|entry
suffix:semicolon
)brace
DECL|function|snd_harmony_proc_done
r_static
r_void
id|snd_harmony_proc_done
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
r_if
c_cond
(paren
id|harmony-&gt;proc_entry
)paren
(brace
id|snd_info_unregister
c_func
(paren
id|harmony-&gt;proc_entry
)paren
suffix:semicolon
id|harmony-&gt;proc_entry
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * PCM Stuff&n; */
DECL|function|snd_card_harmony_playback_ioctl
r_static
r_int
id|snd_card_harmony_playback_ioctl
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_return
id|snd_pcm_lib_ioctl
c_func
(paren
id|substream
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|snd_card_harmony_capture_ioctl
r_static
r_int
id|snd_card_harmony_capture_ioctl
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_return
id|snd_pcm_lib_ioctl
c_func
(paren
id|substream
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|snd_card_harmony_playback_trigger
r_static
r_int
id|snd_card_harmony_playback_trigger
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
r_int
id|cmd
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_PCM_TRIGGER_STOP
suffix:colon
r_if
c_cond
(paren
id|harmony-&gt;ply_stopped
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|harmony-&gt;ply_stopped
op_assign
l_int|1
suffix:semicolon
id|snd_harmony_disable_interrupts
c_func
(paren
id|harmony
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_START
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|harmony-&gt;ply_stopped
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|harmony-&gt;ply_stopped
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* write the location of the first buffer to play */
id|gsc_writel
c_func
(paren
id|harmony-&gt;ply_buffer
comma
id|harmony-&gt;hpa
op_plus
id|REG_PNXTADD
)paren
suffix:semicolon
id|snd_harmony_enable_interrupts
c_func
(paren
id|harmony
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_PAUSE_PUSH
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_PAUSE_RELEASE
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_SUSPEND
suffix:colon
id|DPRINTK
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;received unimplemented trigger: %d&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_capture_trigger
r_static
r_int
id|snd_card_harmony_capture_trigger
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
r_int
id|cmd
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SNDRV_PCM_TRIGGER_STOP
suffix:colon
r_if
c_cond
(paren
id|harmony-&gt;cap_stopped
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|harmony-&gt;cap_stopped
op_assign
l_int|1
suffix:semicolon
id|snd_harmony_disable_interrupts
c_func
(paren
id|harmony
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_START
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|harmony-&gt;cap_stopped
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|harmony-&gt;cap_stopped
op_assign
l_int|0
suffix:semicolon
id|snd_harmony_enable_interrupts
c_func
(paren
id|harmony
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SNDRV_PCM_TRIGGER_PAUSE_PUSH
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_PAUSE_RELEASE
suffix:colon
r_case
id|SNDRV_PCM_TRIGGER_SUSPEND
suffix:colon
id|DPRINTK
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Received unimplemented trigger: %d&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_playback_prepare
r_static
r_int
id|snd_card_harmony_playback_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|harmony-&gt;ply_size
op_assign
id|snd_pcm_lib_buffer_bytes
c_func
(paren
id|substream
)paren
suffix:semicolon
id|harmony-&gt;ply_count
op_assign
id|snd_pcm_lib_period_bytes
c_func
(paren
id|substream
)paren
suffix:semicolon
id|harmony-&gt;ply_buf
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;ply_stopped
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* initialize given sample rate */
id|harmony-&gt;sample_rate
op_assign
id|snd_card_harmony_rate_bits
c_func
(paren
id|runtime-&gt;rate
)paren
suffix:semicolon
multiline_comment|/* data format */
r_if
c_cond
(paren
id|snd_pcm_format_width
c_func
(paren
id|runtime-&gt;format
)paren
op_eq
l_int|16
)paren
id|harmony-&gt;data_format
op_assign
id|HARMONY_DF_16BIT_LINEAR
suffix:semicolon
r_else
id|harmony-&gt;data_format
op_assign
id|HARMONY_DF_8BIT_ULAW
suffix:semicolon
multiline_comment|/* number of channels */
r_if
c_cond
(paren
id|runtime-&gt;channels
op_eq
l_int|2
)paren
id|harmony-&gt;stereo_select
op_assign
id|HARMONY_SS_STEREO
suffix:semicolon
r_else
id|harmony-&gt;stereo_select
op_assign
id|HARMONY_SS_MONO
suffix:semicolon
id|DPRINTK
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Playback_prepare, sr=%d(%x), df=%x, ss=%x hpa=%lx&bslash;n&quot;
comma
id|runtime-&gt;rate
comma
id|harmony-&gt;sample_rate
comma
id|harmony-&gt;data_format
comma
id|harmony-&gt;stereo_select
comma
id|harmony-&gt;hpa
)paren
suffix:semicolon
id|snd_harmony_update_control
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|harmony-&gt;format_initialized
op_assign
l_int|1
suffix:semicolon
id|harmony-&gt;ply_buffer
op_assign
id|runtime-&gt;dma_addr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_capture_prepare
r_static
r_int
id|snd_card_harmony_capture_prepare
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|harmony-&gt;cap_size
op_assign
id|snd_pcm_lib_buffer_bytes
c_func
(paren
id|substream
)paren
suffix:semicolon
id|harmony-&gt;cap_count
op_assign
id|snd_pcm_lib_period_bytes
c_func
(paren
id|substream
)paren
suffix:semicolon
id|harmony-&gt;cap_count
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;cap_stopped
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* initialize given sample rate */
id|harmony-&gt;sample_rate
op_assign
id|snd_card_harmony_rate_bits
c_func
(paren
id|runtime-&gt;rate
)paren
suffix:semicolon
multiline_comment|/* data format */
r_if
c_cond
(paren
id|snd_pcm_format_width
c_func
(paren
id|runtime-&gt;format
)paren
op_eq
l_int|16
)paren
id|harmony-&gt;data_format
op_assign
id|HARMONY_DF_16BIT_LINEAR
suffix:semicolon
r_else
id|harmony-&gt;data_format
op_assign
id|HARMONY_DF_8BIT_ULAW
suffix:semicolon
multiline_comment|/* number of channels */
r_if
c_cond
(paren
id|runtime-&gt;channels
op_eq
l_int|1
)paren
id|harmony-&gt;stereo_select
op_assign
id|HARMONY_SS_MONO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|runtime-&gt;channels
op_eq
l_int|2
)paren
id|harmony-&gt;stereo_select
op_assign
id|HARMONY_SS_STEREO
suffix:semicolon
id|snd_harmony_update_control
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|harmony-&gt;format_initialized
op_assign
l_int|1
suffix:semicolon
id|harmony-&gt;cap_buffer
op_assign
id|runtime-&gt;dma_addr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_capture_pointer
r_static
id|snd_pcm_uframes_t
id|snd_card_harmony_capture_pointer
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
r_int
r_int
id|rcuradd
suffix:semicolon
r_int
id|recorded
suffix:semicolon
r_if
c_cond
(paren
id|harmony-&gt;cap_stopped
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|harmony-&gt;capture_substream
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|rcuradd
op_assign
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_RCURADD
)paren
suffix:semicolon
id|recorded
op_assign
(paren
id|rcuradd
op_minus
id|harmony-&gt;cap_buffer
)paren
suffix:semicolon
id|recorded
op_mod_assign
id|harmony-&gt;cap_size
suffix:semicolon
r_return
id|bytes_to_frames
c_func
(paren
id|runtime
comma
id|recorded
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; */
DECL|function|snd_card_harmony_playback_pointer
r_static
id|snd_pcm_uframes_t
id|snd_card_harmony_playback_pointer
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
r_int
id|played
suffix:semicolon
r_int
r_int
id|pcuradd
op_assign
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_PCURADD
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|harmony-&gt;ply_stopped
)paren
op_logical_or
(paren
id|harmony-&gt;playback_substream
op_eq
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|harmony-&gt;ply_buffer
op_eq
l_int|0
)paren
op_logical_or
(paren
id|harmony-&gt;ply_size
op_eq
l_int|0
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|played
op_assign
(paren
id|pcuradd
op_minus
id|harmony-&gt;ply_buffer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;Pointer is %lx-%lx = %d&bslash;n&quot;
comma
id|pcuradd
comma
id|harmony-&gt;ply_buffer
comma
id|played
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcuradd
OG
id|harmony-&gt;ply_buffer
op_plus
id|harmony-&gt;ply_size
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|bytes_to_frames
c_func
(paren
id|runtime
comma
id|played
)paren
suffix:semicolon
)brace
DECL|variable|snd_card_harmony_playback
r_static
id|snd_pcm_hardware_t
id|snd_card_harmony_playback
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_JOINT_DUPLEX
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_BLOCK_TRANSFER
)paren
comma
dot
id|formats
op_assign
(paren
id|SNDRV_PCM_FMTBIT_U8
op_or
id|SNDRV_PCM_FMTBIT_S16_BE
op_or
id|SNDRV_PCM_FMTBIT_A_LAW
op_or
id|SNDRV_PCM_FMTBIT_MU_LAW
)paren
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_CONTINUOUS
op_or
id|SNDRV_PCM_RATE_8000_48000
comma
dot
id|rate_min
op_assign
l_int|5500
comma
dot
id|rate_max
op_assign
l_int|48000
comma
dot
id|channels_min
op_assign
l_int|1
comma
dot
id|channels_max
op_assign
l_int|2
comma
dot
id|buffer_bytes_max
op_assign
id|MAX_BUFFER_SIZE
comma
dot
id|period_bytes_min
op_assign
id|HARMONY_BUF_SIZE
comma
dot
id|period_bytes_max
op_assign
id|HARMONY_BUF_SIZE
comma
dot
id|periods_min
op_assign
l_int|1
comma
dot
id|periods_max
op_assign
id|MAX_BUFS
comma
dot
id|fifo_size
op_assign
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|snd_card_harmony_capture
r_static
id|snd_pcm_hardware_t
id|snd_card_harmony_capture
op_assign
(brace
dot
id|info
op_assign
(paren
id|SNDRV_PCM_INFO_MMAP
op_or
id|SNDRV_PCM_INFO_INTERLEAVED
op_or
id|SNDRV_PCM_INFO_JOINT_DUPLEX
op_or
id|SNDRV_PCM_INFO_MMAP_VALID
op_or
id|SNDRV_PCM_INFO_BLOCK_TRANSFER
)paren
comma
dot
id|formats
op_assign
(paren
id|SNDRV_PCM_FMTBIT_U8
op_or
id|SNDRV_PCM_FMTBIT_S16_BE
op_or
id|SNDRV_PCM_FMTBIT_A_LAW
op_or
id|SNDRV_PCM_FMTBIT_MU_LAW
)paren
comma
dot
id|rates
op_assign
id|SNDRV_PCM_RATE_CONTINUOUS
op_or
id|SNDRV_PCM_RATE_8000_48000
comma
dot
id|rate_min
op_assign
l_int|5500
comma
dot
id|rate_max
op_assign
l_int|48000
comma
dot
id|channels_min
op_assign
l_int|1
comma
dot
id|channels_max
op_assign
l_int|2
comma
dot
id|buffer_bytes_max
op_assign
id|MAX_BUFFER_SIZE
comma
dot
id|period_bytes_min
op_assign
id|HARMONY_BUF_SIZE
comma
dot
id|period_bytes_max
op_assign
id|HARMONY_BUF_SIZE
comma
dot
id|periods_min
op_assign
l_int|1
comma
dot
id|periods_max
op_assign
id|MAX_BUFS
comma
dot
id|fifo_size
op_assign
l_int|0
comma
)brace
suffix:semicolon
DECL|function|snd_card_harmony_playback_open
r_static
r_int
id|snd_card_harmony_playback_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * harmony is not &quot;real&quot; pci, but we need a pci_dev&n;&t; * to alloc PCI DMA pages&n;&t; */
id|substream-&gt;runtime-&gt;dma_private
op_assign
id|harmony-&gt;fake_pci_dev
suffix:semicolon
singleline_comment|//&t;substream-&gt;dma_type = SNDRV_PCM_DMA_TYPE_PCI;
id|harmony-&gt;playback_substream
op_assign
id|substream
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_card_harmony_playback
suffix:semicolon
id|snd_pcm_hw_constraint_list
c_func
(paren
id|runtime
comma
l_int|0
comma
id|SNDRV_PCM_HW_PARAM_RATE
comma
op_amp
id|hw_constraint_rates
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pcm_hw_constraint_integer
c_func
(paren
id|runtime
comma
id|SNDRV_PCM_HW_PARAM_PERIODS
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_capture_open
r_static
r_int
id|snd_card_harmony_capture_open
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * harmony is not &quot;real&quot; pci, but we need a pci_dev&n;&t; * to alloc PCI DMA pages&n;&t; */
id|substream-&gt;runtime-&gt;dma_private
op_assign
id|harmony-&gt;fake_pci_dev
suffix:semicolon
singleline_comment|//&t;substream-&gt;dma_type = SNDRV_PCM_DMA_TYPE_PCI;
id|harmony-&gt;capture_substream
op_assign
id|substream
suffix:semicolon
id|runtime-&gt;hw
op_assign
id|snd_card_harmony_capture
suffix:semicolon
id|snd_pcm_hw_constraint_list
c_func
(paren
id|runtime
comma
l_int|0
comma
id|SNDRV_PCM_HW_PARAM_RATE
comma
op_amp
id|hw_constraint_rates
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pcm_hw_constraint_integer
c_func
(paren
id|runtime
comma
id|SNDRV_PCM_HW_PARAM_PERIODS
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_playback_close
r_static
r_int
id|snd_card_harmony_playback_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_lib_free_pages
c_func
(paren
id|substream
)paren
suffix:semicolon
id|harmony-&gt;playback_substream
op_assign
l_int|NULL
suffix:semicolon
id|harmony-&gt;ply_size
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;ply_buf
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;ply_buffer
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;ply_count
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;ply_stopped
op_assign
l_int|1
suffix:semicolon
id|harmony-&gt;format_initialized
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_capture_close
r_static
r_int
id|snd_card_harmony_capture_close
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|snd_pcm_substream_chip
c_func
(paren
id|substream
)paren
suffix:semicolon
id|snd_pcm_lib_free_pages
c_func
(paren
id|substream
)paren
suffix:semicolon
id|harmony-&gt;capture_substream
op_assign
l_int|NULL
suffix:semicolon
id|harmony-&gt;cap_size
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;cap_buf
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;cap_buffer
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;cap_count
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;cap_stopped
op_assign
l_int|1
suffix:semicolon
id|harmony-&gt;format_initialized
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_hw_params
r_static
r_int
id|snd_card_harmony_hw_params
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
comma
id|snd_pcm_hw_params_t
op_star
id|hw_params
)paren
(brace
id|snd_pcm_runtime_t
op_star
id|runtime
op_assign
id|substream-&gt;runtime
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
id|snd_pcm_lib_malloc_pages
c_func
(paren
id|substream
comma
id|params_buffer_bytes
c_func
(paren
id|hw_params
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;HW Params returned %d, dma_addr %lx&bslash;n&quot;
comma
id|err
comma
(paren
r_int
r_int
)paren
id|runtime-&gt;dma_addr
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|snd_card_harmony_hw_free
r_static
r_int
id|snd_card_harmony_hw_free
c_func
(paren
id|snd_pcm_substream_t
op_star
id|substream
)paren
(brace
id|snd_pcm_lib_free_pages
c_func
(paren
id|substream
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|snd_card_harmony_playback_ops
r_static
id|snd_pcm_ops_t
id|snd_card_harmony_playback_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_card_harmony_playback_open
comma
dot
id|close
op_assign
id|snd_card_harmony_playback_close
comma
dot
id|ioctl
op_assign
id|snd_card_harmony_playback_ioctl
comma
dot
id|hw_params
op_assign
id|snd_card_harmony_hw_params
comma
dot
id|hw_free
op_assign
id|snd_card_harmony_hw_free
comma
dot
id|prepare
op_assign
id|snd_card_harmony_playback_prepare
comma
dot
id|trigger
op_assign
id|snd_card_harmony_playback_trigger
comma
dot
id|pointer
op_assign
id|snd_card_harmony_playback_pointer
comma
)brace
suffix:semicolon
DECL|variable|snd_card_harmony_capture_ops
r_static
id|snd_pcm_ops_t
id|snd_card_harmony_capture_ops
op_assign
(brace
dot
id|open
op_assign
id|snd_card_harmony_capture_open
comma
dot
id|close
op_assign
id|snd_card_harmony_capture_close
comma
dot
id|ioctl
op_assign
id|snd_card_harmony_capture_ioctl
comma
dot
id|hw_params
op_assign
id|snd_card_harmony_hw_params
comma
dot
id|hw_free
op_assign
id|snd_card_harmony_hw_free
comma
dot
id|prepare
op_assign
id|snd_card_harmony_capture_prepare
comma
dot
id|trigger
op_assign
id|snd_card_harmony_capture_trigger
comma
dot
id|pointer
op_assign
id|snd_card_harmony_capture_pointer
comma
)brace
suffix:semicolon
DECL|function|snd_card_harmony_pcm_init
r_static
r_int
id|snd_card_harmony_pcm_init
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
comma
r_int
id|device
)paren
(brace
id|snd_pcm_t
op_star
id|pcm
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Request that IRQ */
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|harmony-&gt;irq
comma
id|snd_card_harmony_interrupt
comma
l_int|0
comma
l_string|&quot;harmony&quot;
comma
id|harmony
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Error requesting irq %d.&bslash;n&quot;
comma
id|harmony-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|snd_harmony_disable_interrupts
c_func
(paren
id|harmony
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_pcm_new
c_func
(paren
id|harmony-&gt;card
comma
l_string|&quot;Harmony&quot;
comma
id|device
comma
l_int|1
comma
l_int|1
comma
op_amp
id|pcm
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_PLAYBACK
comma
op_amp
id|snd_card_harmony_playback_ops
)paren
suffix:semicolon
id|snd_pcm_set_ops
c_func
(paren
id|pcm
comma
id|SNDRV_PCM_STREAM_CAPTURE
comma
op_amp
id|snd_card_harmony_capture_ops
)paren
suffix:semicolon
id|pcm-&gt;private_data
op_assign
id|harmony
suffix:semicolon
id|pcm-&gt;info_flags
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|pcm-&gt;name
comma
l_string|&quot;Harmony&quot;
)paren
suffix:semicolon
id|harmony-&gt;pcm
op_assign
id|pcm
suffix:semicolon
multiline_comment|/* initialize graveyard buffer */
id|harmony-&gt;dma_dev.type
op_assign
id|SNDRV_DMA_TYPE_PCI
suffix:semicolon
id|harmony-&gt;dma_dev.dev
op_assign
id|snd_dma_pci_data
c_func
(paren
id|harmony-&gt;fake_pci_dev
)paren
suffix:semicolon
id|harmony-&gt;graveyard_addr
op_assign
id|snd_dma_alloc_pages
c_func
(paren
op_amp
id|chip-&gt;dma_dev
comma
id|HARMONY_BUF_SIZE
op_star
id|GRAVEYARD_BUFS
comma
op_amp
id|harmony-&gt;graveyard_dma
)paren
suffix:semicolon
id|harmony-&gt;graveyard_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize silence buffers */
id|harmony-&gt;silence_addr
op_assign
id|snd_dma_alloc_pages
c_func
(paren
op_amp
id|chip-&gt;dma_dev
comma
id|HARMONY_BUF_SIZE
op_star
id|SILENCE_BUFS
comma
op_amp
id|harmony-&gt;silence_dma
)paren
suffix:semicolon
id|harmony-&gt;silence_count
op_assign
l_int|0
suffix:semicolon
id|harmony-&gt;ply_stopped
op_assign
id|harmony-&gt;cap_stopped
op_assign
l_int|1
suffix:semicolon
id|harmony-&gt;playback_substream
op_assign
l_int|NULL
suffix:semicolon
id|harmony-&gt;capture_substream
op_assign
l_int|NULL
suffix:semicolon
id|harmony-&gt;graveyard_count
op_assign
l_int|0
suffix:semicolon
id|snd_pcm_lib_preallocate_pages_for_all
c_func
(paren
id|pcm
comma
id|SNDRV_DMA_TYPE_DEV
comma
id|snd_dma_pci_data
c_func
(paren
id|harmony-&gt;fake_pci_dev
)paren
comma
l_int|64
op_star
l_int|1024
comma
l_int|128
op_star
l_int|1024
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * mixer routines&n; */
DECL|function|snd_harmony_set_new_gain
r_static
r_void
id|snd_harmony_set_new_gain
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
id|DPRINTK
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Setting new gain %x at %lx&bslash;n&quot;
comma
id|harmony-&gt;current_gain
comma
id|harmony-&gt;hpa
op_plus
id|REG_GAINCTL
)paren
suffix:semicolon
multiline_comment|/* Wait until we&squot;re out of control mode */
id|snd_harmony_wait_cntl
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
id|harmony-&gt;current_gain
comma
id|harmony-&gt;hpa
op_plus
id|REG_GAINCTL
)paren
suffix:semicolon
)brace
DECL|macro|HARMONY_VOLUME
mdefine_line|#define HARMONY_VOLUME(xname, left_shift, right_shift, mask, invert) &bslash;&n;{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, &bslash;&n;  .info = snd_harmony_mixercontrol_info, &bslash;&n;  .get = snd_harmony_volume_get, .put = snd_harmony_volume_put, &bslash;&n;  .private_value = ((left_shift) | ((right_shift) &lt;&lt; 8) | ((mask) &lt;&lt; 16) | ((invert) &lt;&lt; 24)) }
DECL|function|snd_harmony_mixercontrol_info
r_static
r_int
id|snd_harmony_mixercontrol_info
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_info_t
op_star
id|uinfo
)paren
(brace
r_int
id|mask
op_assign
(paren
id|kcontrol-&gt;private_value
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|left_shift
op_assign
(paren
id|kcontrol-&gt;private_value
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|right_shift
op_assign
(paren
id|kcontrol-&gt;private_value
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|uinfo-&gt;type
op_assign
(paren
id|mask
op_eq
l_int|1
ques
c_cond
id|SNDRV_CTL_ELEM_TYPE_BOOLEAN
suffix:colon
id|SNDRV_CTL_ELEM_TYPE_INTEGER
)paren
suffix:semicolon
id|uinfo-&gt;count
op_assign
(paren
id|left_shift
op_eq
id|right_shift
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|2
suffix:semicolon
id|uinfo-&gt;value.integer.min
op_assign
l_int|0
suffix:semicolon
id|uinfo-&gt;value.integer.max
op_assign
id|mask
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_harmony_volume_get
r_static
r_int
id|snd_harmony_volume_get
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|_snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
r_int
id|shift_left
op_assign
(paren
id|kcontrol-&gt;private_value
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|shift_right
op_assign
(paren
id|kcontrol-&gt;private_value
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|mask
op_assign
(paren
id|kcontrol-&gt;private_value
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|invert
op_assign
(paren
id|kcontrol-&gt;private_value
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|left
comma
id|right
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|harmony-&gt;mixer_lock
comma
id|flags
)paren
suffix:semicolon
id|left
op_assign
(paren
id|harmony-&gt;current_gain
op_rshift
id|shift_left
)paren
op_amp
id|mask
suffix:semicolon
id|right
op_assign
(paren
id|harmony-&gt;current_gain
op_rshift
id|shift_right
)paren
op_amp
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|invert
)paren
(brace
id|left
op_assign
id|mask
op_minus
id|left
suffix:semicolon
id|right
op_assign
id|mask
op_minus
id|right
suffix:semicolon
)brace
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_assign
id|left
suffix:semicolon
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
op_assign
id|right
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|harmony-&gt;mixer_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_harmony_volume_put
r_static
r_int
id|snd_harmony_volume_put
c_func
(paren
id|snd_kcontrol_t
op_star
id|kcontrol
comma
id|snd_ctl_elem_value_t
op_star
id|ucontrol
)paren
(brace
id|snd_card_harmony_t
op_star
id|harmony
op_assign
id|_snd_kcontrol_chip
c_func
(paren
id|kcontrol
)paren
suffix:semicolon
r_int
id|shift_left
op_assign
(paren
id|kcontrol-&gt;private_value
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|shift_right
op_assign
(paren
id|kcontrol-&gt;private_value
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|mask
op_assign
(paren
id|kcontrol-&gt;private_value
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
id|invert
op_assign
(paren
id|kcontrol-&gt;private_value
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|left
comma
id|right
suffix:semicolon
r_int
id|old_gain
op_assign
id|harmony-&gt;current_gain
suffix:semicolon
id|left
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|0
)braket
op_amp
id|mask
suffix:semicolon
id|right
op_assign
id|ucontrol-&gt;value.integer.value
(braket
l_int|1
)braket
op_amp
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|invert
)paren
(brace
id|left
op_assign
id|mask
op_minus
id|left
suffix:semicolon
id|right
op_assign
id|mask
op_minus
id|right
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|harmony-&gt;mixer_lock
comma
id|flags
)paren
suffix:semicolon
id|harmony-&gt;current_gain
op_assign
id|harmony-&gt;current_gain
op_amp
op_complement
(paren
(paren
id|mask
op_lshift
id|shift_right
)paren
op_or
(paren
id|mask
op_lshift
id|shift_left
)paren
)paren
suffix:semicolon
id|harmony-&gt;current_gain
op_assign
id|harmony-&gt;current_gain
op_or
(paren
(paren
id|left
op_lshift
id|shift_left
)paren
op_or
(paren
id|right
op_lshift
id|shift_right
)paren
)paren
suffix:semicolon
id|snd_harmony_set_new_gain
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|harmony-&gt;mixer_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|old_gain
op_minus
id|harmony-&gt;current_gain
)paren
suffix:semicolon
)brace
DECL|macro|HARMONY_CONTROLS
mdefine_line|#define HARMONY_CONTROLS (sizeof(snd_harmony_controls)/sizeof(snd_kcontrol_new_t))
DECL|variable|snd_harmony_controls
r_static
id|snd_kcontrol_new_t
id|snd_harmony_controls
(braket
)braket
op_assign
(brace
id|HARMONY_VOLUME
c_func
(paren
l_string|&quot;PCM Capture Volume&quot;
comma
l_int|12
comma
l_int|16
comma
l_int|0x0f
comma
l_int|0
)paren
comma
id|HARMONY_VOLUME
c_func
(paren
l_string|&quot;Master Volume&quot;
comma
l_int|20
comma
l_int|20
comma
l_int|0x0f
comma
l_int|1
)paren
comma
id|HARMONY_VOLUME
c_func
(paren
l_string|&quot;PCM Playback Volume&quot;
comma
l_int|6
comma
l_int|0
comma
l_int|0x3f
comma
l_int|1
)paren
comma
)brace
suffix:semicolon
DECL|function|snd_harmony_reset_codec
r_static
r_void
id|snd_harmony_reset_codec
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
id|snd_harmony_wait_cntl
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|gsc_writel
c_func
(paren
l_int|1
comma
id|harmony-&gt;hpa
op_plus
id|REG_RESET
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* wait 50 ms */
id|gsc_writel
c_func
(paren
l_int|0
comma
id|harmony-&gt;hpa
op_plus
id|REG_RESET
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Mute all the output and reset Harmony.&n; */
DECL|function|snd_harmony_mixer_reset
r_static
r_void
id|__init
id|snd_harmony_mixer_reset
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
id|harmony-&gt;current_gain
op_assign
id|HARMONY_GAIN_TOTAL_SILENCE
suffix:semicolon
id|snd_harmony_set_new_gain
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|snd_harmony_reset_codec
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|harmony-&gt;current_gain
op_assign
id|HARMONY_GAIN_DEFAULT
suffix:semicolon
id|snd_harmony_set_new_gain
c_func
(paren
id|harmony
)paren
suffix:semicolon
)brace
DECL|function|snd_card_harmony_mixer_init
r_int
id|__init
id|snd_card_harmony_mixer_init
c_func
(paren
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
id|snd_card_t
op_star
id|card
op_assign
id|harmony-&gt;card
suffix:semicolon
r_int
id|idx
comma
id|err
suffix:semicolon
id|snd_assert
c_func
(paren
id|harmony
op_ne
l_int|NULL
comma
r_return
op_minus
id|EINVAL
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;mixername
comma
l_string|&quot;Harmony Gain control interface&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|HARMONY_CONTROLS
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_ctl_add
c_func
(paren
id|card
comma
id|snd_ctl_new1
c_func
(paren
op_amp
id|snd_harmony_controls
(braket
id|idx
)braket
comma
id|harmony
)paren
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
)brace
id|snd_harmony_mixer_reset
c_func
(paren
id|harmony
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_create
r_static
r_int
id|snd_card_harmony_create
c_func
(paren
id|snd_card_t
op_star
id|card
comma
r_struct
id|parisc_device
op_star
id|pa_dev
comma
id|snd_card_harmony_t
op_star
id|harmony
)paren
(brace
id|u32
id|cntl
suffix:semicolon
id|harmony-&gt;card
op_assign
id|card
suffix:semicolon
multiline_comment|/* Set the HPA of harmony */
id|harmony-&gt;hpa
op_assign
id|pa_dev-&gt;hpa
suffix:semicolon
id|harmony-&gt;irq
op_assign
id|pa_dev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|harmony-&gt;irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;no irq found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Grab the ID and revision from the device */
id|harmony-&gt;id
op_assign
(paren
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_ID
)paren
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|harmony-&gt;id
op_or
l_int|1
)paren
op_ne
l_int|0x15
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;wrong harmony id 0x%02x&bslash;n&quot;
comma
id|harmony-&gt;id
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|cntl
op_assign
id|gsc_readl
c_func
(paren
id|harmony-&gt;hpa
op_plus
id|REG_CNTL
)paren
suffix:semicolon
id|harmony-&gt;rev
op_assign
(paren
id|cntl
op_rshift
l_int|20
)paren
op_amp
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Lasi Harmony Audio driver h/w id %i, rev. %i at 0x%lx, IRQ %i&bslash;n&quot;
comma
id|harmony-&gt;id
comma
id|harmony-&gt;rev
comma
id|pa_dev-&gt;hpa
comma
id|harmony-&gt;irq
)paren
suffix:semicolon
multiline_comment|/* Make sure the control bit isn&squot;t set, although I don&squot;t think it &n;&t;   ever is. */
r_if
c_cond
(paren
id|cntl
op_amp
id|HARMONY_CNTL_C
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;CNTL busy&bslash;n&quot;
)paren
suffix:semicolon
id|harmony-&gt;hpa
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* a fake pci_dev is needed for pci_* functions under ccio */
id|harmony-&gt;fake_pci_dev
op_assign
id|ccio_get_fake
c_func
(paren
id|pa_dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|snd_card_harmony_probe
r_static
r_int
id|__init
id|snd_card_harmony_probe
c_func
(paren
r_struct
id|parisc_device
op_star
id|pa_dev
)paren
(brace
r_static
r_int
id|dev
suffix:semicolon
id|snd_card_harmony_t
op_star
id|chip
suffix:semicolon
id|snd_card_t
op_star
id|card
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|SNDRV_CARDS
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|enable
(braket
id|dev
)braket
)paren
(brace
id|dev
op_increment
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|snd_harmony_cards
(braket
id|dev
)braket
op_assign
id|snd_card_new
c_func
(paren
id|index
(braket
id|dev
)braket
comma
id|id
(braket
id|dev
)braket
comma
id|THIS_MODULE
comma
r_sizeof
(paren
id|snd_card_harmony_t
)paren
)paren
suffix:semicolon
id|card
op_assign
id|snd_harmony_cards
(braket
id|dev
)braket
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|chip
op_assign
(paren
r_struct
id|snd_card_harmony
op_star
)paren
id|card-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_harmony_create
c_func
(paren
id|card
comma
id|pa_dev
comma
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Creation failed&bslash;n&quot;
)paren
suffix:semicolon
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_harmony_pcm_init
c_func
(paren
id|chip
comma
id|dev
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;PCM Init failed&bslash;n&quot;
)paren
suffix:semicolon
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_harmony_mixer_init
c_func
(paren
id|chip
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Mixer init failed&bslash;n&quot;
)paren
suffix:semicolon
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|snd_harmony_proc_init
c_func
(paren
id|chip
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;driver
comma
l_string|&quot;Harmony&quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|card-&gt;shortname
comma
l_string|&quot;ALSA driver for LASI Harmony&quot;
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|card-&gt;longname
comma
l_string|&quot;%s at h/w, id %i, rev. %i hpa 0x%lx, IRQ %i&bslash;n&quot;
comma
id|card-&gt;shortname
comma
id|chip-&gt;id
comma
id|chip-&gt;rev
comma
id|pa_dev-&gt;hpa
comma
id|chip-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|snd_card_register
c_func
(paren
id|card
)paren
)paren
OL
l_int|0
)paren
(brace
id|snd_card_free
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
id|PFX
l_string|&quot;Successfully registered harmony pcm backend &amp; mixer %d&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|dev
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|snd_card_harmony_devicetbl
r_static
r_struct
id|parisc_device_id
id|snd_card_harmony_devicetbl
(braket
)braket
op_assign
(brace
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x0007A
)brace
comma
multiline_comment|/* Bushmaster/Flounder */
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x0007B
)brace
comma
multiline_comment|/* 712/715 Audio */
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x0007E
)brace
comma
multiline_comment|/* Pace Audio */
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x0007F
)brace
comma
multiline_comment|/* Outfield / Coral II */
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|parisc
comma
id|snd_card_harmony_devicetbl
)paren
suffix:semicolon
multiline_comment|/*&n; * bloc device parisc. c&squot;est une structure qui definit un device&n; * que l&squot;on trouve sur parisc. &n; * On y trouve les differents numeros HVERSION correspondant au device&n; * en question (ce qui permet a l&squot;inventory de l&squot;identifier) et la fonction&n; * d&squot;initialisation du chose &n; */
DECL|variable|snd_card_harmony_driver
r_static
r_struct
id|parisc_driver
id|snd_card_harmony_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Lasi ALSA Harmony&quot;
comma
dot
id|id_table
op_assign
id|snd_card_harmony_devicetbl
comma
dot
id|probe
op_assign
id|snd_card_harmony_probe
comma
)brace
suffix:semicolon
DECL|function|alsa_card_harmony_init
r_static
r_int
id|__init
id|alsa_card_harmony_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|register_parisc_driver
c_func
(paren
op_amp
id|snd_card_harmony_driver
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Harmony soundcard not found or device busy&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alsa_card_harmony_exit
r_static
r_void
id|__exit
id|alsa_card_harmony_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|idx
suffix:semicolon
id|snd_card_harmony_t
op_star
id|harmony
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|SNDRV_CARDS
suffix:semicolon
id|idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|snd_harmony_cards
(braket
id|idx
)braket
op_ne
l_int|NULL
)paren
(brace
id|DPRINTK
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Freeing card %d&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
id|harmony
op_assign
id|snd_harmony_cards
(braket
id|idx
)braket
op_member_access_from_pointer
id|private_data
suffix:semicolon
id|snd_harmony_proc_done
c_func
(paren
id|harmony
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|harmony-&gt;irq
comma
id|snd_card_harmony_interrupt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Card unloaded %d, irq=%d&bslash;n&quot;
comma
id|idx
comma
id|harmony-&gt;irq
)paren
suffix:semicolon
id|snd_card_free
c_func
(paren
id|snd_harmony_cards
(braket
id|idx
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
id|module_init
c_func
(paren
id|alsa_card_harmony_init
)paren
id|module_exit
c_func
(paren
id|alsa_card_harmony_exit
)paren
eof
