multiline_comment|/* &n; * Cryptographic API.&n; *&n; * Deflate algorithm (RFC 1951), implemented here primarily for use&n; * by IPCOMP (RFC 3173 &amp; RFC 2394).&n; *&n; * Copyright (c) 2003 James Morris &lt;jmorris@intercode.com.au&gt;&n; * &n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the Free&n; * Software Foundation; either version 2 of the License, or (at your option) &n; * any later version.&n; *&n; * FIXME: deflate transforms will require up to a total of about 436k of kernel&n; * memory on i386 (390k for compression, the rest for decompression), as the&n; * current zlib kernel code uses a worst case pre-allocation system by default.&n; * This needs to be fixed so that the amount of memory required is properly&n; * related to the  winbits and memlevel parameters.&n; *&n; * The default winbits of 11 should suit most packets, and it may be something&n; * to configure on a per-tfm basis in the future.&n; *&n; * Currently, compression history is not maintained between tfm calls, as&n; * it is not needed for IPCOMP and keeps the code simpler.  It can be&n; * implemented if someone wants it.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/crypto.h&gt;
macro_line|#include &lt;linux/zlib.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
DECL|macro|DEFLATE_DEF_LEVEL
mdefine_line|#define DEFLATE_DEF_LEVEL&t;&t;Z_DEFAULT_COMPRESSION
DECL|macro|DEFLATE_DEF_WINBITS
mdefine_line|#define DEFLATE_DEF_WINBITS&t;&t;11
DECL|macro|DEFLATE_DEF_MEMLEVEL
mdefine_line|#define DEFLATE_DEF_MEMLEVEL&t;&t;MAX_MEM_LEVEL
DECL|struct|deflate_ctx
r_struct
id|deflate_ctx
(brace
DECL|member|comp_initialized
r_int
id|comp_initialized
suffix:semicolon
DECL|member|decomp_initialized
r_int
id|decomp_initialized
suffix:semicolon
DECL|member|comp_stream
r_struct
id|z_stream_s
id|comp_stream
suffix:semicolon
DECL|member|decomp_stream
r_struct
id|z_stream_s
id|decomp_stream
suffix:semicolon
)brace
suffix:semicolon
DECL|function|deflate_gfp
r_static
r_inline
r_int
id|deflate_gfp
c_func
(paren
r_void
)paren
(brace
r_return
id|in_softirq
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
suffix:semicolon
)brace
DECL|function|deflate_init
r_static
r_int
id|deflate_init
c_func
(paren
r_void
op_star
id|ctx
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|deflate_exit
r_static
r_void
id|deflate_exit
c_func
(paren
r_void
op_star
id|ctx
)paren
(brace
r_struct
id|deflate_ctx
op_star
id|dctx
op_assign
id|ctx
suffix:semicolon
r_if
c_cond
(paren
id|dctx-&gt;comp_initialized
)paren
id|vfree
c_func
(paren
id|dctx-&gt;comp_stream.workspace
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dctx-&gt;decomp_initialized
)paren
id|kfree
c_func
(paren
id|dctx-&gt;decomp_stream.workspace
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Lazy initialization to make interface simple without allocating&n; * un-needed workspaces.  Thus can be called in softirq context.&n; */
DECL|function|deflate_comp_init
r_static
r_int
id|deflate_comp_init
c_func
(paren
r_struct
id|deflate_ctx
op_star
id|ctx
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|z_stream_s
op_star
id|stream
op_assign
op_amp
id|ctx-&gt;comp_stream
suffix:semicolon
id|stream-&gt;workspace
op_assign
id|__vmalloc
c_func
(paren
id|zlib_deflate_workspacesize
c_func
(paren
)paren
comma
id|deflate_gfp
c_func
(paren
)paren
op_or
id|__GFP_HIGHMEM
comma
id|PAGE_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stream-&gt;workspace
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|stream-&gt;workspace
comma
l_int|0
comma
id|zlib_deflate_workspacesize
c_func
(paren
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|zlib_deflateInit2
c_func
(paren
id|stream
comma
id|DEFLATE_DEF_LEVEL
comma
id|Z_DEFLATED
comma
op_minus
id|DEFLATE_DEF_WINBITS
comma
id|DEFLATE_DEF_MEMLEVEL
comma
id|Z_DEFAULT_STRATEGY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|Z_OK
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|ctx-&gt;comp_initialized
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
id|out_free
suffix:colon
id|vfree
c_func
(paren
id|stream-&gt;workspace
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|deflate_decomp_init
r_static
r_int
id|deflate_decomp_init
c_func
(paren
r_struct
id|deflate_ctx
op_star
id|ctx
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|z_stream_s
op_star
id|stream
op_assign
op_amp
id|ctx-&gt;decomp_stream
suffix:semicolon
id|stream-&gt;workspace
op_assign
id|kmalloc
c_func
(paren
id|zlib_inflate_workspacesize
c_func
(paren
)paren
comma
id|deflate_gfp
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stream-&gt;workspace
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|stream-&gt;workspace
comma
l_int|0
comma
id|zlib_inflate_workspacesize
c_func
(paren
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|zlib_inflateInit2
c_func
(paren
id|stream
comma
op_minus
id|DEFLATE_DEF_WINBITS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|Z_OK
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|ctx-&gt;decomp_initialized
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
id|out_free
suffix:colon
id|kfree
c_func
(paren
id|stream-&gt;workspace
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|deflate_compress
r_static
r_int
id|deflate_compress
c_func
(paren
r_void
op_star
id|ctx
comma
r_const
id|u8
op_star
id|src
comma
r_int
r_int
id|slen
comma
id|u8
op_star
id|dst
comma
r_int
r_int
op_star
id|dlen
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|deflate_ctx
op_star
id|dctx
op_assign
id|ctx
suffix:semicolon
r_struct
id|z_stream_s
op_star
id|stream
op_assign
op_amp
id|dctx-&gt;comp_stream
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dctx-&gt;comp_initialized
)paren
(brace
id|ret
op_assign
id|deflate_comp_init
c_func
(paren
id|dctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|zlib_deflateReset
c_func
(paren
id|stream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|Z_OK
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|stream-&gt;next_in
op_assign
(paren
id|u8
op_star
)paren
id|src
suffix:semicolon
id|stream-&gt;avail_in
op_assign
id|slen
suffix:semicolon
id|stream-&gt;next_out
op_assign
(paren
id|u8
op_star
)paren
id|dst
suffix:semicolon
id|stream-&gt;avail_out
op_assign
op_star
id|dlen
suffix:semicolon
id|ret
op_assign
id|zlib_deflate
c_func
(paren
id|stream
comma
id|Z_FINISH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|Z_STREAM_END
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
op_star
id|dlen
op_assign
id|stream-&gt;total_out
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|deflate_decompress
r_static
r_int
id|deflate_decompress
c_func
(paren
r_void
op_star
id|ctx
comma
r_const
id|u8
op_star
id|src
comma
r_int
r_int
id|slen
comma
id|u8
op_star
id|dst
comma
r_int
r_int
op_star
id|dlen
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|deflate_ctx
op_star
id|dctx
op_assign
id|ctx
suffix:semicolon
r_struct
id|z_stream_s
op_star
id|stream
op_assign
op_amp
id|dctx-&gt;decomp_stream
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dctx-&gt;decomp_initialized
)paren
(brace
id|ret
op_assign
id|deflate_decomp_init
c_func
(paren
id|dctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|zlib_inflateReset
c_func
(paren
id|stream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|Z_OK
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|stream-&gt;next_in
op_assign
(paren
id|u8
op_star
)paren
id|src
suffix:semicolon
id|stream-&gt;avail_in
op_assign
id|slen
suffix:semicolon
id|stream-&gt;next_out
op_assign
(paren
id|u8
op_star
)paren
id|dst
suffix:semicolon
id|stream-&gt;avail_out
op_assign
op_star
id|dlen
suffix:semicolon
id|ret
op_assign
id|zlib_inflate
c_func
(paren
id|stream
comma
id|Z_SYNC_FLUSH
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Work around a bug in zlib, which sometimes wants to taste an extra&n;&t; * byte when being used in the (undocumented) raw deflate mode.&n;&t; * (From USAGI).&n;&t; */
r_if
c_cond
(paren
id|ret
op_eq
id|Z_OK
op_logical_and
op_logical_neg
id|stream-&gt;avail_in
op_logical_and
id|stream-&gt;avail_out
)paren
(brace
id|u8
id|zerostuff
op_assign
l_int|0
suffix:semicolon
id|stream-&gt;next_in
op_assign
op_amp
id|zerostuff
suffix:semicolon
id|stream-&gt;avail_in
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
id|zlib_inflate
c_func
(paren
id|stream
comma
id|Z_FINISH
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_ne
id|Z_STREAM_END
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
op_star
id|dlen
op_assign
id|stream-&gt;total_out
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|alg
r_static
r_struct
id|crypto_alg
id|alg
op_assign
(brace
dot
id|cra_name
op_assign
l_string|&quot;deflate&quot;
comma
dot
id|cra_flags
op_assign
id|CRYPTO_ALG_TYPE_COMPRESS
comma
dot
id|cra_ctxsize
op_assign
r_sizeof
(paren
r_struct
id|deflate_ctx
)paren
comma
dot
id|cra_module
op_assign
id|THIS_MODULE
comma
dot
id|cra_list
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|alg.cra_list
)paren
comma
dot
id|cra_u
op_assign
(brace
dot
id|compress
op_assign
(brace
dot
id|coa_init
op_assign
id|deflate_init
comma
dot
id|coa_exit
op_assign
id|deflate_exit
comma
dot
id|coa_compress
op_assign
id|deflate_compress
comma
dot
id|coa_decompress
op_assign
id|deflate_decompress
)brace
)brace
)brace
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
r_return
id|crypto_register_alg
c_func
(paren
op_amp
id|alg
)paren
suffix:semicolon
)brace
DECL|function|fini
r_static
r_void
id|__exit
id|fini
c_func
(paren
r_void
)paren
(brace
id|crypto_unregister_alg
c_func
(paren
op_amp
id|alg
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Deflate Compression Algorithm for IPCOMP&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;James Morris &lt;jmorris@intercode.com.au&gt;&quot;
)paren
suffix:semicolon
eof
