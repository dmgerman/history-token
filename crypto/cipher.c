multiline_comment|/*&n; * Cryptographic API.&n; *&n; * Cipher operations.&n; *&n; * Copyright (c) 2002 James Morris &lt;jmorris@intercode.com.au&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the Free&n; * Software Foundation; either version 2 of the License, or (at your option) &n; * any later version.&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/crypto.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/highmem.h&gt;
macro_line|#include &lt;asm/scatterlist.h&gt;
macro_line|#include &quot;internal.h&quot;
DECL|typedef|cryptfn_t
r_typedef
r_void
(paren
id|cryptfn_t
)paren
(paren
r_void
op_star
comma
id|u8
op_star
comma
r_const
id|u8
op_star
)paren
suffix:semicolon
DECL|typedef|procfn_t
r_typedef
r_void
(paren
id|procfn_t
)paren
(paren
r_struct
id|crypto_tfm
op_star
comma
id|u8
op_star
comma
id|cryptfn_t
comma
r_int
id|enc
)paren
suffix:semicolon
DECL|function|xor_64
r_static
r_inline
r_void
id|xor_64
c_func
(paren
id|u8
op_star
id|a
comma
r_const
id|u8
op_star
id|b
)paren
(brace
(paren
(paren
id|u32
op_star
)paren
id|a
)paren
(braket
l_int|0
)braket
op_xor_assign
(paren
(paren
id|u32
op_star
)paren
id|b
)paren
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
id|a
)paren
(braket
l_int|1
)braket
op_xor_assign
(paren
(paren
id|u32
op_star
)paren
id|b
)paren
(braket
l_int|1
)braket
suffix:semicolon
)brace
DECL|function|xor_128
r_static
r_inline
r_void
id|xor_128
c_func
(paren
id|u8
op_star
id|a
comma
r_const
id|u8
op_star
id|b
)paren
(brace
(paren
(paren
id|u32
op_star
)paren
id|a
)paren
(braket
l_int|0
)braket
op_xor_assign
(paren
(paren
id|u32
op_star
)paren
id|b
)paren
(braket
l_int|0
)braket
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
id|a
)paren
(braket
l_int|1
)braket
op_xor_assign
(paren
(paren
id|u32
op_star
)paren
id|b
)paren
(braket
l_int|1
)braket
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
id|a
)paren
(braket
l_int|2
)braket
op_xor_assign
(paren
(paren
id|u32
op_star
)paren
id|b
)paren
(braket
l_int|2
)braket
suffix:semicolon
(paren
(paren
id|u32
op_star
)paren
id|a
)paren
(braket
l_int|3
)braket
op_xor_assign
(paren
(paren
id|u32
op_star
)paren
id|b
)paren
(braket
l_int|3
)braket
suffix:semicolon
)brace
DECL|function|sglen
r_static
r_inline
r_int
r_int
id|sglen
c_func
(paren
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|nsg
)paren
(brace
r_int
r_int
id|i
comma
id|n
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|n
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsg
suffix:semicolon
id|i
op_increment
)paren
id|n
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/*&n; * Do not call this unless the total length of all of the fragments &n; * has been verified as multiple of the block size.&n; */
DECL|function|copy_chunks
r_static
r_int
r_int
id|copy_chunks
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
id|u8
op_star
id|buf
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|sgidx
comma
r_int
r_int
id|rlen
comma
r_int
r_int
op_star
id|last
comma
r_int
id|in
)paren
(brace
r_int
r_int
id|i
comma
id|copied
comma
id|coff
comma
id|j
comma
id|aligned
suffix:semicolon
r_int
r_int
id|bsize
op_assign
id|crypto_tfm_alg_blocksize
c_func
(paren
id|tfm
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|sgidx
comma
id|j
op_assign
id|copied
op_assign
l_int|0
comma
id|aligned
op_assign
l_int|0
suffix:semicolon
id|copied
OL
id|bsize
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|len
op_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_int
r_int
id|clen
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|copied
)paren
(brace
id|coff
op_assign
l_int|0
suffix:semicolon
id|clen
op_assign
id|min
c_func
(paren
id|len
comma
id|bsize
op_minus
id|copied
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
id|bsize
op_minus
id|copied
)paren
id|aligned
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* last + right aligned */
)brace
r_else
(brace
id|coff
op_assign
id|len
op_minus
id|rlen
suffix:semicolon
id|clen
op_assign
id|rlen
suffix:semicolon
)brace
id|p
op_assign
id|crypto_kmap
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|page
)paren
op_plus
id|sg
(braket
id|i
)braket
dot
id|offset
op_plus
id|coff
suffix:semicolon
r_if
c_cond
(paren
id|in
)paren
id|memcpy
c_func
(paren
op_amp
id|buf
(braket
id|copied
)braket
comma
id|p
comma
id|clen
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|p
comma
op_amp
id|buf
(braket
id|copied
)braket
comma
id|clen
)paren
suffix:semicolon
id|crypto_kunmap
c_func
(paren
id|p
)paren
suffix:semicolon
op_star
id|last
op_assign
id|aligned
ques
c_cond
l_int|0
suffix:colon
id|clen
suffix:semicolon
id|copied
op_add_assign
id|clen
suffix:semicolon
)brace
r_return
id|i
op_minus
id|sgidx
op_minus
l_int|2
op_plus
id|aligned
suffix:semicolon
)brace
DECL|function|gather_chunks
r_static
r_inline
r_int
r_int
id|gather_chunks
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
id|u8
op_star
id|buf
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|sgidx
comma
r_int
r_int
id|rlen
comma
r_int
r_int
op_star
id|last
)paren
(brace
r_return
id|copy_chunks
c_func
(paren
id|tfm
comma
id|buf
comma
id|sg
comma
id|sgidx
comma
id|rlen
comma
id|last
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|scatter_chunks
r_static
r_inline
r_int
r_int
id|scatter_chunks
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
id|u8
op_star
id|buf
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|sgidx
comma
r_int
r_int
id|rlen
comma
r_int
r_int
op_star
id|last
)paren
(brace
r_return
id|copy_chunks
c_func
(paren
id|tfm
comma
id|buf
comma
id|sg
comma
id|sgidx
comma
id|rlen
comma
id|last
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Generic encrypt/decrypt wrapper for ciphers.&n; *&n; * If we find a a remnant at the end of a frag, we have to encrypt or&n; * decrypt across possibly multiple page boundaries via a temporary&n; * block, then continue processing with a chunk offset until the end&n; * of a frag is block aligned.&n; *&n; * The code is further complicated by having to remap a page after&n; * processing a block then yielding.  The data will be offset from the&n; * start of page at the scatterlist offset, the chunking offset (coff)&n; * and the block offset (boff).&n; */
DECL|function|crypt
r_static
r_int
id|crypt
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|nsg
comma
id|cryptfn_t
id|crfn
comma
id|procfn_t
id|prfn
comma
r_int
id|enc
)paren
(brace
r_int
r_int
id|i
comma
id|coff
suffix:semicolon
r_int
r_int
id|bsize
op_assign
id|crypto_tfm_alg_blocksize
c_func
(paren
id|tfm
)paren
suffix:semicolon
id|u8
id|tmp
(braket
id|bsize
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sglen
c_func
(paren
id|sg
comma
id|nsg
)paren
op_mod
id|bsize
)paren
(brace
id|tfm-&gt;crt_flags
op_or_assign
id|CRYPTO_TFM_RES_BAD_BLOCK_LEN
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|coff
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nsg
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|n
op_assign
l_int|0
comma
id|boff
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|len
op_assign
id|sg
(braket
id|i
)braket
dot
id|length
op_minus
id|coff
suffix:semicolon
r_char
op_star
id|p
op_assign
id|crypto_kmap
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|page
)paren
op_plus
id|sg
(braket
id|i
)braket
dot
id|offset
op_plus
id|coff
suffix:semicolon
r_while
c_loop
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
id|len
OL
id|bsize
)paren
(brace
id|crypto_kunmap
c_func
(paren
id|p
)paren
suffix:semicolon
id|n
op_assign
id|gather_chunks
c_func
(paren
id|tfm
comma
id|tmp
comma
id|sg
comma
id|i
comma
id|len
comma
op_amp
id|coff
)paren
suffix:semicolon
id|prfn
c_func
(paren
id|tfm
comma
id|tmp
comma
id|crfn
comma
id|enc
)paren
suffix:semicolon
id|scatter_chunks
c_func
(paren
id|tfm
comma
id|tmp
comma
id|sg
comma
id|i
comma
id|len
comma
op_amp
id|coff
)paren
suffix:semicolon
id|crypto_yield
c_func
(paren
id|tfm
)paren
suffix:semicolon
r_goto
id|unmapped
suffix:semicolon
)brace
r_else
(brace
id|prfn
c_func
(paren
id|tfm
comma
id|p
comma
id|crfn
comma
id|enc
)paren
suffix:semicolon
id|crypto_kunmap
c_func
(paren
id|p
)paren
suffix:semicolon
id|crypto_yield
c_func
(paren
id|tfm
)paren
suffix:semicolon
multiline_comment|/* remap and point to recalculated offset */
id|boff
op_add_assign
id|bsize
suffix:semicolon
id|p
op_assign
id|crypto_kmap
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|page
)paren
op_plus
id|sg
(braket
id|i
)braket
dot
id|offset
op_plus
id|coff
op_plus
id|boff
suffix:semicolon
id|len
op_sub_assign
id|bsize
suffix:semicolon
multiline_comment|/* End of frag with no remnant? */
r_if
c_cond
(paren
id|coff
op_logical_and
id|len
op_eq
l_int|0
)paren
id|coff
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|crypto_kunmap
c_func
(paren
id|p
)paren
suffix:semicolon
id|unmapped
suffix:colon
id|i
op_add_assign
id|n
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cbc_process
r_static
r_void
id|cbc_process
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
id|u8
op_star
id|block
comma
id|cryptfn_t
id|fn
comma
r_int
id|enc
)paren
(brace
multiline_comment|/* Null encryption */
r_if
c_cond
(paren
op_logical_neg
id|tfm-&gt;crt_cipher.cit_iv
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|enc
)paren
(brace
id|tfm-&gt;crt_u.cipher
dot
id|cit_xor_block
c_func
(paren
id|tfm-&gt;crt_cipher.cit_iv
comma
id|block
)paren
suffix:semicolon
id|fn
c_func
(paren
id|tfm-&gt;crt_ctx
comma
id|block
comma
id|tfm-&gt;crt_cipher.cit_iv
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tfm-&gt;crt_cipher.cit_iv
comma
id|block
comma
id|crypto_tfm_alg_blocksize
c_func
(paren
id|tfm
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|u8
id|buf
(braket
id|crypto_tfm_alg_blocksize
c_func
(paren
id|tfm
)paren
)braket
suffix:semicolon
id|fn
c_func
(paren
id|tfm-&gt;crt_ctx
comma
id|buf
comma
id|block
)paren
suffix:semicolon
id|tfm-&gt;crt_u.cipher
dot
id|cit_xor_block
c_func
(paren
id|buf
comma
id|tfm-&gt;crt_cipher.cit_iv
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tfm-&gt;crt_cipher.cit_iv
comma
id|block
comma
id|crypto_tfm_alg_blocksize
c_func
(paren
id|tfm
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|block
comma
id|buf
comma
id|crypto_tfm_alg_blocksize
c_func
(paren
id|tfm
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|ecb_process
r_static
r_void
id|ecb_process
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
id|u8
op_star
id|block
comma
id|cryptfn_t
id|fn
comma
r_int
id|enc
)paren
(brace
id|fn
c_func
(paren
id|tfm-&gt;crt_ctx
comma
id|block
comma
id|block
)paren
suffix:semicolon
)brace
DECL|function|setkey
r_static
r_int
id|setkey
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
r_const
id|u8
op_star
id|key
comma
r_int
r_int
id|keylen
)paren
(brace
r_struct
id|cipher_alg
op_star
id|cia
op_assign
op_amp
id|tfm-&gt;__crt_alg-&gt;cra_cipher
suffix:semicolon
r_if
c_cond
(paren
id|keylen
template_param
id|cia-&gt;cia_max_keysize
)paren
(brace
id|tfm-&gt;crt_flags
op_or_assign
id|CRYPTO_TFM_RES_BAD_KEY_LEN
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_return
id|cia
op_member_access_from_pointer
id|cia_setkey
c_func
(paren
id|tfm-&gt;crt_ctx
comma
id|key
comma
id|keylen
comma
op_amp
id|tfm-&gt;crt_flags
)paren
suffix:semicolon
)brace
DECL|function|ecb_encrypt
r_static
r_int
id|ecb_encrypt
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|nsg
)paren
(brace
r_return
id|crypt
c_func
(paren
id|tfm
comma
id|sg
comma
id|nsg
comma
id|tfm-&gt;__crt_alg-&gt;cra_cipher.cia_encrypt
comma
id|ecb_process
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ecb_decrypt
r_static
r_int
id|ecb_decrypt
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|nsg
)paren
(brace
r_return
id|crypt
c_func
(paren
id|tfm
comma
id|sg
comma
id|nsg
comma
id|tfm-&gt;__crt_alg-&gt;cra_cipher.cia_decrypt
comma
id|ecb_process
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|cbc_encrypt
r_static
r_int
id|cbc_encrypt
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|nsg
)paren
(brace
r_return
id|crypt
c_func
(paren
id|tfm
comma
id|sg
comma
id|nsg
comma
id|tfm-&gt;__crt_alg-&gt;cra_cipher.cia_encrypt
comma
id|cbc_process
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|cbc_decrypt
r_static
r_int
id|cbc_decrypt
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|nsg
)paren
(brace
r_return
id|crypt
c_func
(paren
id|tfm
comma
id|sg
comma
id|nsg
comma
id|tfm-&gt;__crt_alg-&gt;cra_cipher.cia_decrypt
comma
id|cbc_process
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nocrypt
r_static
r_int
id|nocrypt
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|nsg
)paren
(brace
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
DECL|function|crypto_init_cipher_flags
r_int
id|crypto_init_cipher_flags
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
comma
id|u32
id|flags
)paren
(brace
id|u32
id|mode
op_assign
id|flags
op_amp
id|CRYPTO_TFM_MODE_MASK
suffix:semicolon
id|tfm-&gt;crt_cipher.cit_mode
op_assign
id|mode
ques
c_cond
id|mode
suffix:colon
id|CRYPTO_TFM_MODE_ECB
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|CRYPTO_TFM_REQ_WEAK_KEY
)paren
id|tfm-&gt;crt_flags
op_assign
id|CRYPTO_TFM_REQ_WEAK_KEY
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|crypto_init_cipher_ops
r_int
id|crypto_init_cipher_ops
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|crypto_alg
op_star
id|alg
op_assign
id|tfm-&gt;__crt_alg
suffix:semicolon
r_struct
id|cipher_tfm
op_star
id|ops
op_assign
op_amp
id|tfm-&gt;crt_cipher
suffix:semicolon
id|ops-&gt;cit_setkey
op_assign
id|setkey
suffix:semicolon
r_switch
c_cond
(paren
id|tfm-&gt;crt_cipher.cit_mode
)paren
(brace
r_case
id|CRYPTO_TFM_MODE_ECB
suffix:colon
id|ops-&gt;cit_encrypt
op_assign
id|ecb_encrypt
suffix:semicolon
id|ops-&gt;cit_decrypt
op_assign
id|ecb_decrypt
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRYPTO_TFM_MODE_CBC
suffix:colon
id|ops-&gt;cit_encrypt
op_assign
id|cbc_encrypt
suffix:semicolon
id|ops-&gt;cit_decrypt
op_assign
id|cbc_decrypt
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRYPTO_TFM_MODE_CFB
suffix:colon
id|ops-&gt;cit_encrypt
op_assign
id|nocrypt
suffix:semicolon
id|ops-&gt;cit_decrypt
op_assign
id|nocrypt
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRYPTO_TFM_MODE_CTR
suffix:colon
id|ops-&gt;cit_encrypt
op_assign
id|nocrypt
suffix:semicolon
id|ops-&gt;cit_decrypt
op_assign
id|nocrypt
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|alg-&gt;cra_cipher.cia_ivsize
op_logical_and
id|ops-&gt;cit_mode
op_ne
id|CRYPTO_TFM_MODE_ECB
)paren
(brace
r_switch
c_cond
(paren
id|crypto_tfm_alg_blocksize
c_func
(paren
id|tfm
)paren
)paren
(brace
r_case
l_int|8
suffix:colon
id|ops-&gt;cit_xor_block
op_assign
id|xor_64
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|16
suffix:colon
id|ops-&gt;cit_xor_block
op_assign
id|xor_128
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: block size %u not supported&bslash;n&quot;
comma
id|crypto_tfm_alg_name
c_func
(paren
id|tfm
)paren
comma
id|crypto_tfm_alg_blocksize
c_func
(paren
id|tfm
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ops-&gt;cit_iv
op_assign
id|kmalloc
c_func
(paren
id|alg-&gt;cra_cipher.cia_ivsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ops-&gt;cit_iv
op_eq
l_int|NULL
)paren
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|crypto_exit_cipher_ops
r_void
id|crypto_exit_cipher_ops
c_func
(paren
r_struct
id|crypto_tfm
op_star
id|tfm
)paren
(brace
r_if
c_cond
(paren
id|tfm-&gt;crt_cipher.cit_iv
)paren
id|kfree
c_func
(paren
id|tfm-&gt;crt_cipher.cit_iv
)paren
suffix:semicolon
)brace
eof
