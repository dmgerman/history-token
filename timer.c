multiline_comment|/*&n; * linux/arch/ia64/sn/kernel/sn2/timer.c&n; *&n; * Copyright (C) 2003 Silicon Graphics, Inc.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/hw_irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/sn/leds.h&gt;
macro_line|#include &lt;asm/sn/clksupport.h&gt;
r_extern
r_int
r_int
id|sn_rtc_cycles_per_second
suffix:semicolon
DECL|variable|last_wall_rtc
r_static
r_volatile
r_int
r_int
id|last_wall_rtc
suffix:semicolon
multiline_comment|/**&n; * gettimeoffset - number of nsecs elapsed since &amp;xtime was last updated&n; *&n; * This function is used by do_gettimeofday() to determine the number&n; * of nsecs that have elapsed since the last update to &amp;xtime.  On SN&n; * this is accomplished using the RTC built in to each Hub chip; each&n; * is guaranteed to be synchronized by the PROM, so a local read will&n; * suffice (GET_RTC_COUNTER() does this for us).  A snapshot of the RTC&n; * value is taken every time wall_jiffies is updated by the&n; * update_wall_time_hook (sn2_update_wall_time) which means we don&squot;t&n; * have to adjust for lost jiffies ticks or anything like that.&n; */
DECL|variable|rtc_offset
r_static
r_volatile
r_int
id|rtc_offset
suffix:semicolon
DECL|variable|rtc_nsecs_per_cycle
r_static
r_int
id|rtc_nsecs_per_cycle
suffix:semicolon
DECL|variable|rtc_per_timer_tick
r_static
r_int
id|rtc_per_timer_tick
suffix:semicolon
r_int
r_int
DECL|function|sn_gettimeoffset
id|sn_gettimeoffset
c_func
(paren
r_void
)paren
(brace
r_int
id|current_rtc
comma
id|elapsed_rtc
comma
id|old
comma
id|new_offset
suffix:semicolon
r_do
(brace
id|old
op_assign
id|rtc_offset
suffix:semicolon
id|current_rtc
op_assign
id|GET_RTC_COUNTER
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Need to address wrapping here!&n;&t;&t; */
id|elapsed_rtc
op_assign
(paren
r_int
)paren
(paren
id|current_rtc
op_minus
id|last_wall_rtc
)paren
suffix:semicolon
id|new_offset
op_assign
id|max
c_func
(paren
id|elapsed_rtc
comma
id|old
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|cmpxchg
c_func
(paren
op_amp
id|rtc_offset
comma
id|old
comma
id|new_offset
)paren
op_ne
id|old
)paren
suffix:semicolon
r_return
id|new_offset
op_star
id|rtc_nsecs_per_cycle
suffix:semicolon
)brace
DECL|function|sn2_update_wall_time
r_void
id|sn2_update_wall_time
c_func
(paren
r_int
id|delta_nsec
)paren
(brace
id|rtc_offset
op_sub_assign
id|min
c_func
(paren
id|rtc_offset
comma
id|rtc_per_timer_tick
)paren
suffix:semicolon
id|last_wall_rtc
op_assign
id|GET_RTC_COUNTER
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sn2_reset_wall_time
r_void
id|sn2_reset_wall_time
c_func
(paren
r_void
)paren
(brace
id|rtc_offset
op_assign
l_int|0
suffix:semicolon
id|last_wall_rtc
op_assign
id|GET_RTC_COUNTER
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
id|__init
DECL|function|sn_timer_init
id|sn_timer_init
c_func
(paren
r_void
)paren
(brace
id|rtc_per_timer_tick
op_assign
id|sn_rtc_cycles_per_second
op_div
id|HZ
suffix:semicolon
id|rtc_nsecs_per_cycle
op_assign
l_int|1000000000
op_div
id|sn_rtc_cycles_per_second
suffix:semicolon
id|last_wall_rtc
op_assign
id|GET_RTC_COUNTER
c_func
(paren
)paren
suffix:semicolon
id|update_wall_time_hook
op_assign
id|sn2_update_wall_time
suffix:semicolon
id|reset_wall_time_hook
op_assign
id|sn2_reset_wall_time
suffix:semicolon
id|gettimeoffset
op_assign
id|sn_gettimeoffset
suffix:semicolon
)brace
eof
