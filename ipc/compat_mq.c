multiline_comment|/*&n; *  ipc/compat_mq.c&n; *    32 bit emulation for POSIX message queue system calls&n; *&n; *    Copyright (C) 2004 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author: Arnd Bergmann &lt;arnd@arndb.de&gt;&n; */
macro_line|#include &lt;linux/compat.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mqueue.h&gt;
macro_line|#include &lt;linux/syscalls.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|struct|compat_mq_attr
r_struct
id|compat_mq_attr
(brace
DECL|member|mq_flags
id|compat_long_t
id|mq_flags
suffix:semicolon
multiline_comment|/* message queue flags&t;&t;     */
DECL|member|mq_maxmsg
id|compat_long_t
id|mq_maxmsg
suffix:semicolon
multiline_comment|/* maximum number of messages&t;     */
DECL|member|mq_msgsize
id|compat_long_t
id|mq_msgsize
suffix:semicolon
multiline_comment|/* maximum message size&t;&t;     */
DECL|member|mq_curmsgs
id|compat_long_t
id|mq_curmsgs
suffix:semicolon
multiline_comment|/* number of messages currently queued  */
DECL|member|__reserved
id|compat_long_t
id|__reserved
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* ignored for input, zeroed for output */
)brace
suffix:semicolon
DECL|function|get_compat_mq_attr
r_static
r_inline
r_int
id|get_compat_mq_attr
c_func
(paren
r_struct
id|mq_attr
op_star
id|attr
comma
r_const
r_struct
id|compat_mq_attr
id|__user
op_star
id|uattr
)paren
(brace
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|uattr
comma
r_sizeof
op_star
id|uattr
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|__get_user
c_func
(paren
id|attr-&gt;mq_flags
comma
op_amp
id|uattr-&gt;mq_flags
)paren
op_or
id|__get_user
c_func
(paren
id|attr-&gt;mq_maxmsg
comma
op_amp
id|uattr-&gt;mq_maxmsg
)paren
op_or
id|__get_user
c_func
(paren
id|attr-&gt;mq_msgsize
comma
op_amp
id|uattr-&gt;mq_msgsize
)paren
op_or
id|__get_user
c_func
(paren
id|attr-&gt;mq_curmsgs
comma
op_amp
id|uattr-&gt;mq_curmsgs
)paren
suffix:semicolon
)brace
DECL|function|put_compat_mq_attr
r_static
r_inline
r_int
id|put_compat_mq_attr
c_func
(paren
r_const
r_struct
id|mq_attr
op_star
id|attr
comma
r_struct
id|compat_mq_attr
id|__user
op_star
id|uattr
)paren
(brace
r_if
c_cond
(paren
id|clear_user
c_func
(paren
id|uattr
comma
r_sizeof
op_star
id|uattr
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|__put_user
c_func
(paren
id|attr-&gt;mq_flags
comma
op_amp
id|uattr-&gt;mq_flags
)paren
op_or
id|__put_user
c_func
(paren
id|attr-&gt;mq_maxmsg
comma
op_amp
id|uattr-&gt;mq_maxmsg
)paren
op_or
id|__put_user
c_func
(paren
id|attr-&gt;mq_msgsize
comma
op_amp
id|uattr-&gt;mq_msgsize
)paren
op_or
id|__put_user
c_func
(paren
id|attr-&gt;mq_curmsgs
comma
op_amp
id|uattr-&gt;mq_curmsgs
)paren
suffix:semicolon
)brace
DECL|function|compat_sys_mq_open
id|asmlinkage
r_int
id|compat_sys_mq_open
c_func
(paren
r_const
r_char
id|__user
op_star
id|u_name
comma
r_int
id|oflag
comma
id|compat_mode_t
id|mode
comma
r_struct
id|compat_mq_attr
id|__user
op_star
id|u_attr
)paren
(brace
r_void
id|__user
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|u_attr
op_logical_and
id|oflag
op_amp
id|O_CREAT
)paren
(brace
r_struct
id|mq_attr
id|attr
suffix:semicolon
id|p
op_assign
id|compat_alloc_user_space
c_func
(paren
r_sizeof
(paren
id|attr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_compat_mq_attr
c_func
(paren
op_amp
id|attr
comma
id|u_attr
)paren
op_logical_or
id|copy_to_user
c_func
(paren
id|p
comma
op_amp
id|attr
comma
r_sizeof
(paren
id|attr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|sys_mq_open
c_func
(paren
id|u_name
comma
id|oflag
comma
id|mode
comma
id|p
)paren
suffix:semicolon
)brace
DECL|function|compat_prepare_timeout
r_static
r_int
id|compat_prepare_timeout
c_func
(paren
r_struct
id|timespec
id|__user
op_star
op_star
id|p
comma
r_const
r_struct
id|compat_timespec
id|__user
op_star
id|u
)paren
(brace
r_struct
id|timespec
id|ts
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|u
)paren
(brace
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
op_star
id|p
op_assign
id|compat_alloc_user_space
c_func
(paren
r_sizeof
(paren
id|ts
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_compat_timespec
c_func
(paren
op_amp
id|ts
comma
id|u
)paren
op_logical_or
id|copy_to_user
c_func
(paren
op_star
id|p
comma
op_amp
id|ts
comma
r_sizeof
(paren
id|ts
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|compat_sys_mq_timedsend
id|asmlinkage
r_int
id|compat_sys_mq_timedsend
c_func
(paren
id|mqd_t
id|mqdes
comma
r_const
r_char
id|__user
op_star
id|u_msg_ptr
comma
r_int
id|msg_len
comma
r_int
r_int
id|msg_prio
comma
r_const
r_struct
id|compat_timespec
id|__user
op_star
id|u_abs_timeout
)paren
(brace
r_struct
id|timespec
id|__user
op_star
id|u_ts
suffix:semicolon
r_if
c_cond
(paren
id|compat_prepare_timeout
c_func
(paren
op_amp
id|u_ts
comma
id|u_abs_timeout
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|sys_mq_timedsend
c_func
(paren
id|mqdes
comma
id|u_msg_ptr
comma
id|msg_len
comma
id|msg_prio
comma
id|u_ts
)paren
suffix:semicolon
)brace
DECL|function|compat_sys_mq_timedreceive
id|asmlinkage
id|ssize_t
id|compat_sys_mq_timedreceive
c_func
(paren
id|mqd_t
id|mqdes
comma
r_char
id|__user
op_star
id|u_msg_ptr
comma
r_int
id|msg_len
comma
r_int
r_int
id|__user
op_star
id|u_msg_prio
comma
r_const
r_struct
id|compat_timespec
id|__user
op_star
id|u_abs_timeout
)paren
(brace
r_struct
id|timespec
id|__user
op_star
id|u_ts
suffix:semicolon
r_if
c_cond
(paren
id|compat_prepare_timeout
c_func
(paren
op_amp
id|u_ts
comma
id|u_abs_timeout
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|sys_mq_timedreceive
c_func
(paren
id|mqdes
comma
id|u_msg_ptr
comma
id|msg_len
comma
id|u_msg_prio
comma
id|u_ts
)paren
suffix:semicolon
)brace
DECL|function|get_compat_sigevent
r_static
r_int
id|get_compat_sigevent
c_func
(paren
r_struct
id|sigevent
op_star
id|event
comma
r_const
r_struct
id|compat_sigevent
id|__user
op_star
id|u_event
)paren
(brace
r_if
c_cond
(paren
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|u_event
comma
r_sizeof
(paren
op_star
id|u_event
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|__get_user
c_func
(paren
id|event-&gt;sigev_value.sival_int
comma
op_amp
id|u_event-&gt;sigev_value.sival_int
)paren
op_or
id|__get_user
c_func
(paren
id|event-&gt;sigev_signo
comma
op_amp
id|u_event-&gt;sigev_signo
)paren
op_or
id|__get_user
c_func
(paren
id|event-&gt;sigev_notify
comma
op_amp
id|u_event-&gt;sigev_notify
)paren
op_or
id|__get_user
c_func
(paren
id|event-&gt;sigev_notify_thread_id
comma
op_amp
id|u_event-&gt;sigev_notify_thread_id
)paren
suffix:semicolon
)brace
DECL|function|compat_sys_mq_notify
id|asmlinkage
r_int
id|compat_sys_mq_notify
c_func
(paren
id|mqd_t
id|mqdes
comma
r_const
r_struct
id|compat_sigevent
id|__user
op_star
id|u_notification
)paren
(brace
r_struct
id|sigevent
id|__user
op_star
id|p
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|u_notification
)paren
(brace
r_struct
id|sigevent
id|n
suffix:semicolon
id|p
op_assign
id|compat_alloc_user_space
c_func
(paren
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_compat_sigevent
c_func
(paren
op_amp
id|n
comma
id|u_notification
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|n.sigev_notify
op_eq
id|SIGEV_THREAD
)paren
id|n.sigev_value.sival_ptr
op_assign
id|compat_ptr
c_func
(paren
id|n.sigev_value.sival_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|p
comma
op_amp
id|n
comma
r_sizeof
(paren
op_star
id|p
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|sys_mq_notify
c_func
(paren
id|mqdes
comma
id|p
)paren
suffix:semicolon
)brace
DECL|function|compat_sys_mq_getsetattr
id|asmlinkage
r_int
id|compat_sys_mq_getsetattr
c_func
(paren
id|mqd_t
id|mqdes
comma
r_const
r_struct
id|compat_mq_attr
id|__user
op_star
id|u_mqstat
comma
r_struct
id|compat_mq_attr
id|__user
op_star
id|u_omqstat
)paren
(brace
r_struct
id|mq_attr
id|mqstat
suffix:semicolon
r_struct
id|mq_attr
id|__user
op_star
id|p
op_assign
id|compat_alloc_user_space
c_func
(paren
l_int|2
op_star
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|u_mqstat
)paren
(brace
r_if
c_cond
(paren
id|get_compat_mq_attr
c_func
(paren
op_amp
id|mqstat
comma
id|u_mqstat
)paren
op_logical_or
id|copy_to_user
c_func
(paren
id|p
comma
op_amp
id|mqstat
comma
r_sizeof
(paren
id|mqstat
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ret
op_assign
id|sys_mq_getsetattr
c_func
(paren
id|mqdes
comma
id|u_mqstat
ques
c_cond
id|p
suffix:colon
l_int|NULL
comma
id|u_omqstat
ques
c_cond
id|p
op_plus
l_int|1
suffix:colon
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|u_omqstat
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|mqstat
comma
id|p
op_plus
l_int|1
comma
r_sizeof
(paren
id|mqstat
)paren
)paren
op_logical_or
id|put_compat_mq_attr
c_func
(paren
op_amp
id|mqstat
comma
id|u_omqstat
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
