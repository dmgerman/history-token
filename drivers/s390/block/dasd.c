multiline_comment|/*&n; * File...........: linux/drivers/s390/block/dasd.c&n; * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n; *                  Horst Hummel &lt;Horst.Hummel@de.ibm.com&gt; &n; *                  Carsten Otte &lt;Cotte@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 1999-2001&n; *&n; * History of changes (starts July 2000)&n; * 11/09/00 complete redesign after code review&n; * 02/01/01 added dynamic registration of ioctls&n; *          fixed bug in registration of new majors&n; *          fixed handling of request during dasd_end_request&n; *          fixed handling of plugged queues&n; *          fixed partition handling and HDIO_GETGEO&n; *          fixed traditional naming scheme for devices beyond 702&n; *          fixed some race conditions related to modules&n; *          added devfs suupport&n; * 03/06/01 refined dynamic attach/detach for leaving devices which are online.&n; * 03/09/01 refined dynamic modifiaction of devices&n; * 03/12/01 moved policy in dasd_format to dasdfmt (renamed BIODASDFORMAT)&n; * 03/19/01 added BIODASDINFO-ioctl&n; *          removed 2.2 compatibility&n; * 04/27/01 fixed PL030119COT (dasd_disciplines does not work)&n; * 04/30/01 fixed PL030146HSM (module locking with dynamic ioctls)&n; *          fixed PL030130SBA (handling of invalid ranges)&n; * 05/02/01 fixed PL030145SBA (killing dasdmt)&n; *          fixed PL030149SBA (status of &squot;accepted&squot; devices)&n; *          fixed PL030146SBA (BUG in ibm.c after adding device)&n; *          added BIODASDPRRD ioctl interface&n; * 05/11/01 fixed  PL030164MVE (trap in probeonly mode)&n; * 05/15/01 fixed devfs support for unformatted devices&n; * 06/26/01 hopefully fixed PL030172SBA,PL030234SBA&n; * 07/09/01 fixed PL030324MSH (wrong statistics output)&n; * 07/16/01 merged in new fixes for handling low-mem situations&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#endif&t;&t;&t;&t;/* CONFIG_PROC_FS */
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;asm/ccwcache.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/s390_ext.h&gt;
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/dasd.h&gt;
macro_line|#include &quot;dasd_int.h&quot;
macro_line|#ifdef CONFIG_DASD_ECKD
macro_line|#include &quot;dasd_eckd.h&quot;
macro_line|#endif&t;&t;&t;&t;/*  CONFIG_DASD_ECKD */
macro_line|#ifdef CONFIG_DASD_FBA
macro_line|#include &quot;dasd_fba.h&quot;
macro_line|#endif&t;&t;&t;&t;/*  CONFIG_DASD_FBA */
macro_line|#ifdef CONFIG_DASD_DIAG
macro_line|#include &quot;dasd_diag.h&quot;
macro_line|#endif&t;&t;&t;&t;/*  CONFIG_DASD_DIAG */
multiline_comment|/* SECTION: exported variables of dasd.c */
DECL|variable|dasd_debug_area
id|debug_info_t
op_star
id|dasd_debug_area
suffix:semicolon
id|MODULE_AUTHOR
(paren
l_string|&quot;Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;Linux on S/390 DASD device driver,&quot;
l_string|&quot; Copyright 2000 IBM Corporation&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
(paren
l_string|&quot;dasd&quot;
)paren
suffix:semicolon
id|MODULE_PARM
(paren
id|dasd
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
(paren
l_int|256
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM
(paren
id|dasd_disciplines
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
(paren
l_int|8
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
DECL|variable|dasd_chanq_enq_head
id|EXPORT_SYMBOL
(paren
id|dasd_chanq_enq_head
)paren
suffix:semicolon
DECL|variable|dasd_debug_area
id|EXPORT_SYMBOL
(paren
id|dasd_debug_area
)paren
suffix:semicolon
DECL|variable|dasd_chanq_enq
id|EXPORT_SYMBOL
(paren
id|dasd_chanq_enq
)paren
suffix:semicolon
DECL|variable|dasd_chanq_deq
id|EXPORT_SYMBOL
(paren
id|dasd_chanq_deq
)paren
suffix:semicolon
DECL|variable|dasd_discipline_add
id|EXPORT_SYMBOL
(paren
id|dasd_discipline_add
)paren
suffix:semicolon
DECL|variable|dasd_discipline_del
id|EXPORT_SYMBOL
(paren
id|dasd_discipline_del
)paren
suffix:semicolon
DECL|variable|dasd_start_IO
id|EXPORT_SYMBOL
(paren
id|dasd_start_IO
)paren
suffix:semicolon
DECL|variable|dasd_term_IO
id|EXPORT_SYMBOL
(paren
id|dasd_term_IO
)paren
suffix:semicolon
DECL|variable|dasd_schedule_bh
id|EXPORT_SYMBOL
(paren
id|dasd_schedule_bh
)paren
suffix:semicolon
DECL|variable|dasd_int_handler
id|EXPORT_SYMBOL
(paren
id|dasd_int_handler
)paren
suffix:semicolon
DECL|variable|dasd_oper_handler
id|EXPORT_SYMBOL
(paren
id|dasd_oper_handler
)paren
suffix:semicolon
DECL|variable|dasd_alloc_request
id|EXPORT_SYMBOL
(paren
id|dasd_alloc_request
)paren
suffix:semicolon
DECL|variable|dasd_free_request
id|EXPORT_SYMBOL
(paren
id|dasd_free_request
)paren
suffix:semicolon
DECL|variable|dasd_ioctl_no_register
id|EXPORT_SYMBOL
(paren
id|dasd_ioctl_no_register
)paren
suffix:semicolon
DECL|variable|dasd_ioctl_no_unregister
id|EXPORT_SYMBOL
(paren
id|dasd_ioctl_no_unregister
)paren
suffix:semicolon
DECL|variable|dasd_default_erp_action
id|EXPORT_SYMBOL
(paren
id|dasd_default_erp_action
)paren
suffix:semicolon
DECL|variable|dasd_default_erp_postaction
id|EXPORT_SYMBOL
(paren
id|dasd_default_erp_postaction
)paren
suffix:semicolon
DECL|variable|dasd_sleep_on_req
id|EXPORT_SYMBOL
(paren
id|dasd_sleep_on_req
)paren
suffix:semicolon
DECL|variable|dasd_set_normalized_cda
id|EXPORT_SYMBOL
(paren
id|dasd_set_normalized_cda
)paren
suffix:semicolon
multiline_comment|/* SECTION: Constant definitions to be used within this file */
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER DASD_NAME&quot;:&quot;
DECL|macro|DASD_PROFILE
macro_line|#undef  DASD_PROFILE            /* fill profile information - used for */
multiline_comment|/* statistics and perfomance           */
DECL|macro|DASD_MIN_SIZE_FOR_QUEUE
mdefine_line|#define DASD_MIN_SIZE_FOR_QUEUE 32
DECL|macro|CONFIG_DYNAMIC_QUEUE_MIN_SIZE
macro_line|#undef CONFIG_DYNAMIC_QUEUE_MIN_SIZE
DECL|macro|DASD_CHANQ_MAX_SIZE
mdefine_line|#define DASD_CHANQ_MAX_SIZE 6
multiline_comment|/* SECTION: prototypes for static functions of dasd.c */
DECL|variable|do_dasd_request
r_static
id|request_fn_proc
id|do_dasd_request
suffix:semicolon
r_static
r_int
id|dasd_set_device_level
(paren
r_int
r_int
comma
id|dasd_discipline_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|request_queue_t
op_star
id|dasd_get_queue
(paren
id|kdev_t
id|kdev
)paren
suffix:semicolon
r_static
r_void
id|cleanup_dasd
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|dasd_plug_device
(paren
id|dasd_device_t
op_star
id|device
)paren
suffix:semicolon
r_static
r_int
id|dasd_fillgeo
(paren
r_int
id|kdev
comma
r_struct
id|hd_geometry
op_star
id|geo
)paren
suffix:semicolon
r_static
r_void
id|dasd_enable_ranges
(paren
id|dasd_range_t
op_star
comma
id|dasd_discipline_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|dasd_disable_ranges
(paren
id|dasd_range_t
op_star
comma
id|dasd_discipline_t
op_star
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|dasd_enable_single_device
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_inline
r_int
id|dasd_state_init_to_ready
c_func
(paren
id|dasd_device_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|dasd_setup_partitions
(paren
id|dasd_device_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|dasd_destroy_partitions
(paren
id|dasd_device_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_int
id|dasd_setup_blkdev
c_func
(paren
id|dasd_device_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|dasd_deactivate_queue
(paren
id|dasd_device_t
op_star
)paren
suffix:semicolon
r_static
r_inline
r_int
id|dasd_disable_blkdev
c_func
(paren
id|dasd_device_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|dasd_flush_chanq
(paren
id|dasd_device_t
op_star
id|device
comma
r_int
id|destroy
)paren
suffix:semicolon
r_static
r_void
id|dasd_flush_request_queues
(paren
id|dasd_device_t
op_star
id|device
comma
r_int
id|destroy
)paren
suffix:semicolon
DECL|variable|dasd_device_operations
r_static
r_struct
id|block_device_operations
id|dasd_device_operations
suffix:semicolon
r_static
r_inline
id|dasd_device_t
op_star
op_star
id|dasd_device_from_devno
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|dasd_process_queues
(paren
id|dasd_device_t
op_star
id|device
)paren
suffix:semicolon
multiline_comment|/* SECTION: static variables of dasd.c */
DECL|variable|dasd_devfs_handle
r_static
id|devfs_handle_t
id|dasd_devfs_handle
suffix:semicolon
DECL|variable|dasd_init_waitq
r_static
id|wait_queue_head_t
id|dasd_init_waitq
suffix:semicolon
DECL|variable|dasd_init_pending
r_static
id|atomic_t
id|dasd_init_pending
op_assign
id|ATOMIC_INIT
(paren
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DASD_DYNAMIC
multiline_comment|/* SECTION: managing dynamic configuration of dasd_driver */
DECL|variable|dasd_devreg_head
r_static
r_struct
id|list_head
id|dasd_devreg_head
op_assign
id|LIST_HEAD_INIT
(paren
id|dasd_devreg_head
)paren
suffix:semicolon
multiline_comment|/*&n; * function: dasd_create_devreg&n; * creates a dasd_devreg_t related to a devno&n; */
r_static
r_inline
id|dasd_devreg_t
op_star
DECL|function|dasd_create_devreg
id|dasd_create_devreg
(paren
r_int
id|devno
)paren
(brace
id|dasd_devreg_t
op_star
id|r
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|dasd_devreg_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
op_ne
l_int|NULL
)paren
(brace
id|memset
(paren
id|r
comma
l_int|0
comma
r_sizeof
(paren
id|dasd_devreg_t
)paren
)paren
suffix:semicolon
id|r-&gt;devreg.ci.devno
op_assign
id|devno
suffix:semicolon
id|r-&gt;devreg.flag
op_assign
id|DEVREG_TYPE_DEVNO
suffix:semicolon
id|r-&gt;devreg.oper_func
op_assign
id|dasd_oper_handler
suffix:semicolon
)brace
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_destroy_devreg&n; * destroys the dasd_devreg_t given as argument&n; */
r_static
r_inline
r_void
DECL|function|dasd_destroy_devreg
id|dasd_destroy_devreg
(paren
id|dasd_devreg_t
op_star
id|devreg
)paren
(brace
id|kfree
(paren
id|devreg
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_DASD_DYNAMIC */
multiline_comment|/* SECTION: managing setup of dasd_driver */
multiline_comment|/* default setting is probeonly, autodetect */
DECL|variable|dasd_probeonly
r_static
r_int
id|dasd_probeonly
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* is true, when probeonly mode is active */
DECL|variable|dasd_autodetect
r_static
r_int
id|dasd_autodetect
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* is true, when autodetection is active */
DECL|variable|dasd_range_head
r_static
id|dasd_range_t
id|dasd_range_head
op_assign
(brace
id|list
suffix:colon
id|LIST_HEAD_INIT
(paren
id|dasd_range_head.list
)paren
)brace
suffix:semicolon
DECL|variable|range_lock
r_static
id|spinlock_t
id|range_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * function: dasd_create_range&n; * creates a dasd_range_t according to the arguments&n; * FIXME: no check is performed for reoccurrence of a devno&n; */
r_static
r_inline
id|dasd_range_t
op_star
DECL|function|dasd_create_range
id|dasd_create_range
(paren
r_int
id|from
comma
r_int
id|to
comma
r_int
id|features
)paren
(brace
id|dasd_range_t
op_star
id|range
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|from
OG
id|to
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Adding device range %04x-%04x: range invalid, ignoring.&bslash;n&quot;
comma
id|from
comma
id|to
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|from
suffix:semicolon
id|i
op_le
id|to
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dasd_device_from_devno
c_func
(paren
id|i
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;device range %04x-%04x: device %04x is already in a range.&bslash;n&quot;
comma
id|from
comma
id|to
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|range
op_assign
(paren
id|dasd_range_t
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|dasd_range_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|range
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
(paren
id|range
comma
l_int|0
comma
r_sizeof
(paren
id|dasd_range_t
)paren
)paren
suffix:semicolon
id|range-&gt;from
op_assign
id|from
suffix:semicolon
id|range-&gt;to
op_assign
id|to
suffix:semicolon
id|range-&gt;features
op_assign
id|features
suffix:semicolon
r_return
id|range
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_destroy_range&n; * destroy a range allocated wit dasd_crate_range&n; * CAUTION: must not be callen in arunning sysztem, because it destroys&n; * the mapping of DASDs&n; */
r_static
r_inline
r_void
DECL|function|dasd_destroy_range
id|dasd_destroy_range
(paren
id|dasd_range_t
op_star
id|range
)paren
(brace
id|kfree
(paren
id|range
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_append_range&n; * appends the range given as argument to the list anchored at dasd_range_head.&n; */
r_static
r_inline
r_void
DECL|function|dasd_append_range
id|dasd_append_range
(paren
id|dasd_range_t
op_star
id|range
)paren
(brace
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|range-&gt;list
comma
op_amp
id|dasd_range_head.list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_dechain_range&n; * removes a range from the chain of ranges&n; * CAUTION: must not be called in a running system because it destroys&n; * the mapping of devices&n; */
r_static
r_inline
r_void
DECL|function|dasd_dechain_range
id|dasd_dechain_range
(paren
id|dasd_range_t
op_star
id|range
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|range-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_add_range&n; * creates a dasd_range_t according to the arguments and&n; * appends it to the list of ranges&n; * additionally a devreg_t is created and added to the list of devregs&n; */
r_static
r_inline
id|dasd_range_t
op_star
DECL|function|dasd_add_range
id|dasd_add_range
(paren
r_int
id|from
comma
r_int
id|to
comma
r_int
id|features
)paren
(brace
id|dasd_range_t
op_star
id|range
suffix:semicolon
id|range
op_assign
id|dasd_create_range
(paren
id|from
comma
id|to
comma
id|features
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|range
)paren
r_return
l_int|NULL
suffix:semicolon
id|dasd_append_range
(paren
id|range
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DASD_DYNAMIC
multiline_comment|/* allocate and chain devreg infos for the devnos... */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|range-&gt;from
suffix:semicolon
id|i
op_le
id|range-&gt;to
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dasd_devreg_t
op_star
id|reg
op_assign
id|dasd_create_devreg
(paren
id|i
)paren
suffix:semicolon
id|s390_device_register
(paren
op_amp
id|reg-&gt;devreg
)paren
suffix:semicolon
id|list_add
(paren
op_amp
id|reg-&gt;list
comma
op_amp
id|dasd_devreg_head
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_DASD_DYNAMIC */
r_return
id|range
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_remove_range&n; * removes a range and the corresponding devregs from all of the chains&n; * CAUTION: must not be called in a running system because it destroys&n; * the mapping of devices!&n; */
r_static
r_inline
r_void
DECL|function|dasd_remove_range
id|dasd_remove_range
(paren
id|dasd_range_t
op_star
id|range
)paren
(brace
macro_line|#ifdef CONFIG_DASD_DYNAMIC
multiline_comment|/* deallocate and dechain devreg infos for the devnos... */
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|range-&gt;from
suffix:semicolon
id|i
op_le
id|range-&gt;to
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|dasd_devreg_t
op_star
id|reg
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_devreg_head
)paren
(brace
id|reg
op_assign
id|list_entry
(paren
id|l
comma
id|dasd_devreg_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg-&gt;devreg.flag
op_eq
id|DEVREG_TYPE_DEVNO
op_logical_and
id|reg-&gt;devreg.ci.devno
op_eq
id|i
op_logical_and
id|reg-&gt;devreg.oper_func
op_eq
id|dasd_oper_handler
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|l
op_eq
op_amp
id|dasd_devreg_head
)paren
id|BUG
(paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|reg-&gt;list
)paren
suffix:semicolon
id|s390_device_unregister
(paren
op_amp
id|reg-&gt;devreg
)paren
suffix:semicolon
id|dasd_destroy_devreg
(paren
id|reg
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_DASD_DYNAMIC */
id|dasd_dechain_range
(paren
id|range
)paren
suffix:semicolon
id|dasd_destroy_range
(paren
id|range
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * function: dasd_devindex_from_devno&n; * finds the logical number of the devno supplied as argument in the list&n; * of dasd ranges and returns it or ENODEV when not found&n; */
r_static
r_int
DECL|function|dasd_devindex_from_devno
id|dasd_devindex_from_devno
(paren
r_int
id|devno
)paren
(brace
id|dasd_range_t
op_star
id|temp
suffix:semicolon
r_int
id|devindex
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_range_head.list
)paren
(brace
id|temp
op_assign
id|list_entry
(paren
id|l
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devno
op_ge
id|temp-&gt;from
op_logical_and
id|devno
op_le
id|temp-&gt;to
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|devindex
op_plus
id|devno
op_minus
id|temp-&gt;from
suffix:semicolon
)brace
id|devindex
op_add_assign
id|temp-&gt;to
op_minus
id|temp-&gt;from
op_plus
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_devno_from_devindex&n; */
r_static
r_int
DECL|function|dasd_devno_from_devindex
id|dasd_devno_from_devindex
(paren
r_int
id|devindex
)paren
(brace
id|dasd_range_t
op_star
id|temp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_range_head.list
)paren
(brace
id|temp
op_assign
id|list_entry
(paren
id|l
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devindex
OL
id|temp-&gt;to
op_minus
id|temp-&gt;from
op_plus
l_int|1
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|temp-&gt;from
op_plus
id|devindex
suffix:semicolon
)brace
id|devindex
op_sub_assign
id|temp-&gt;to
op_minus
id|temp-&gt;from
op_plus
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* SECTION: parsing the dasd= parameter of the parmline/insmod cmdline */
multiline_comment|/*&n; * char *dasd[] is intended to hold the ranges supplied by the dasd= statement&n; * it is named &squot;dasd&squot; to directly be filled by insmod with the comma separated&n; * strings when running as a module.&n; * a maximum of 256 ranges can be supplied, as the parmline is limited to&n; * &lt;1024 Byte anyway.&n; */
DECL|variable|dasd
r_char
op_star
id|dasd
(braket
l_int|256
)braket
suffix:semicolon
DECL|variable|dasd_disciplines
r_char
op_star
id|dasd_disciplines
(braket
l_int|8
)braket
suffix:semicolon
macro_line|#ifndef MODULE
multiline_comment|/*&n; * function: dasd_split_parm_string&n; * splits the parmline given to the kernel into comma separated strings&n; * which are filled into the &squot;dasd[]&squot; array, to be parsed later on&n; */
r_static
r_void
DECL|function|dasd_split_parm_string
id|dasd_split_parm_string
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|tmp
op_assign
id|str
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
l_int|NULL
op_logical_and
op_star
id|tmp
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
r_char
op_star
id|end
suffix:semicolon
r_int
id|len
suffix:semicolon
id|end
op_assign
id|strchr
(paren
id|tmp
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
l_int|NULL
)paren
(brace
id|len
op_assign
id|strlen
(paren
id|tmp
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
(paren
r_int
)paren
id|end
op_minus
(paren
r_int
)paren
id|tmp
op_plus
l_int|1
suffix:semicolon
op_star
id|end
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|end
op_increment
suffix:semicolon
)brace
id|dasd
(braket
id|count
)braket
op_assign
id|kmalloc
(paren
id|len
op_star
r_sizeof
(paren
r_char
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd
(braket
id|count
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;can&squot;t store dasd= parameter no %d&bslash;n&quot;
comma
id|count
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memset
(paren
id|dasd
(braket
id|count
)braket
comma
l_int|0
comma
id|len
op_star
r_sizeof
(paren
r_char
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|dasd
(braket
id|count
)braket
comma
id|tmp
comma
id|len
op_star
r_sizeof
(paren
r_char
)paren
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
id|tmp
op_assign
id|end
suffix:semicolon
)brace
suffix:semicolon
)brace
multiline_comment|/*&n; * dasd_parm_string holds a concatenated version of all &squot;dasd=&squot; parameters&n; * supplied in the parmline, which is later to be split by&n; * dasd_split_parm_string&n; * FIXME: why first concatenate then split ?&n; */
DECL|variable|__initdata
r_static
r_char
id|dasd_parm_string
(braket
l_int|1024
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * function: dasd_setup&n; * is invoked for any single &squot;dasd=&squot; parameter supplied in the parmline&n; * it merges all the arguments into dasd_parm_string&n; */
r_void
id|__init
DECL|function|dasd_setup
id|dasd_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|len
op_assign
id|strlen
(paren
id|dasd_parm_string
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|0
)paren
(brace
id|strcat
(paren
id|dasd_parm_string
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
)brace
id|strcat
(paren
id|dasd_parm_string
comma
id|str
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_call_setup&n; * is the 2.4 version of dasd_setup and&n; * is invoked for any single &squot;dasd=&squot; parameter supplied in the parmline&n; */
r_int
id|__init
DECL|function|dasd_call_setup
id|dasd_call_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|dummy
suffix:semicolon
id|dasd_setup
(paren
id|str
comma
op_amp
id|dummy
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_int
id|__init
DECL|function|dasd_disciplines_setup
id|dasd_disciplines_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
(paren
l_string|&quot;dasd=&quot;
comma
id|dasd_call_setup
)paren
suffix:semicolon
id|__setup
(paren
l_string|&quot;dasd_disciplines=&quot;
comma
id|dasd_disciplines_setup
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* MODULE */
multiline_comment|/*&n; * function: dasd_strtoul&n; * provides a wrapper to simple_strtoul to strip leading &squot;0x&squot; and&n; * interpret any argument to dasd=[range,...] as hexadecimal&n; */
r_static
r_inline
r_int
DECL|function|dasd_strtoul
id|dasd_strtoul
(paren
r_char
op_star
id|str
comma
r_char
op_star
op_star
id|stra
comma
r_int
op_star
id|features
)paren
(brace
r_char
op_star
id|temp
op_assign
id|str
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_int
id|val
comma
id|i
comma
id|start
suffix:semicolon
id|buffer
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
(paren
id|strlen
c_func
(paren
id|str
)paren
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_char
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;can&squot;t parse dasd= parameter %s due to low memory&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
)brace
multiline_comment|/* remove leading &squot;0x&squot; */
r_if
c_cond
(paren
op_star
id|temp
op_eq
l_char|&squot;0&squot;
)paren
(brace
id|temp
op_increment
suffix:semicolon
multiline_comment|/* strip leading zero */
r_if
c_cond
(paren
op_star
id|temp
op_eq
l_char|&squot;x&squot;
)paren
id|temp
op_increment
suffix:semicolon
multiline_comment|/* strip leading x */
)brace
multiline_comment|/* copy device no to buffer and convert to decimal */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
op_logical_and
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;(&squot;
op_logical_and
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;-&squot;
op_logical_and
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot; &squot;
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|isxdigit
c_func
(paren
id|temp
(braket
id|i
)braket
)paren
)paren
(brace
id|buffer
(braket
id|i
)braket
op_assign
id|temp
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|buffer
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|val
op_assign
id|simple_strtoul
(paren
id|buffer
comma
op_amp
id|buffer
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* check for features - e.g. (ro) ; the &squot;&bslash;0&squot;, &squot;)&squot; and &squot;-&squot; stops check */
op_star
id|features
op_assign
id|DASD_DEFAULT_FEATURES
suffix:semicolon
r_if
c_cond
(paren
id|temp
(braket
id|i
)braket
op_eq
l_char|&squot;(&squot;
)paren
(brace
r_while
c_loop
(paren
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
op_logical_and
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;)&squot;
op_logical_and
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;-&squot;
)paren
(brace
id|start
op_assign
op_increment
id|i
suffix:semicolon
multiline_comment|/* move next feature to buffer */
r_for
c_loop
(paren
suffix:semicolon
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
op_logical_and
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;:&squot;
op_logical_and
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;)&squot;
op_logical_and
id|temp
(braket
id|i
)braket
op_ne
l_char|&squot;-&squot;
suffix:semicolon
id|i
op_increment
)paren
id|buffer
(braket
id|i
op_minus
id|start
)braket
op_assign
id|temp
(braket
id|i
)braket
suffix:semicolon
id|buffer
(braket
id|i
op_minus
id|start
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|buffer
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|buffer
comma
l_string|&quot;ro&quot;
)paren
)paren
(brace
multiline_comment|/* handle &squot;ro&squot; feature */
(paren
op_star
id|features
)paren
op_or_assign
id|DASD_FEATURE_READONLY
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;unsupported feature: %s, ignoring setting&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
)brace
)brace
op_star
id|stra
op_assign
id|temp
op_plus
id|i
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_parse&n; * examines the strings given in the string array str and&n; * creates and adds the ranges to the apropriate lists&n; */
r_static
r_int
DECL|function|dasd_parse
id|dasd_parse
(paren
r_char
op_star
op_star
id|str
)paren
(brace
r_char
op_star
id|temp
suffix:semicolon
r_int
id|from
comma
id|to
suffix:semicolon
r_int
id|features
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|str
)paren
(brace
multiline_comment|/* turn off probeonly mode, if any dasd parameter is present */
id|dasd_probeonly
op_assign
l_int|0
suffix:semicolon
id|dasd_autodetect
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|str
)paren
(brace
id|temp
op_assign
op_star
id|str
suffix:semicolon
id|from
op_assign
l_int|0
suffix:semicolon
id|to
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
(paren
l_string|&quot;autodetect&quot;
comma
op_star
id|str
)paren
op_eq
l_int|0
)paren
(brace
id|dasd_autodetect
op_assign
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;turning to autodetection mode&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strcmp
(paren
l_string|&quot;probeonly&quot;
comma
op_star
id|str
)paren
op_eq
l_int|0
)paren
(brace
id|dasd_probeonly
op_assign
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;turning to probeonly mode&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* turn off autodetect mode, if any range is present */
id|dasd_autodetect
op_assign
l_int|0
suffix:semicolon
id|from
op_assign
id|dasd_strtoul
(paren
id|temp
comma
op_amp
id|temp
comma
op_amp
id|features
)paren
suffix:semicolon
id|to
op_assign
id|from
suffix:semicolon
r_if
c_cond
(paren
op_star
id|temp
op_eq
l_char|&squot;-&squot;
)paren
(brace
id|temp
op_increment
suffix:semicolon
id|to
op_assign
id|dasd_strtoul
(paren
id|temp
comma
op_amp
id|temp
comma
op_amp
id|features
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from
op_eq
op_minus
id|EINVAL
op_logical_or
id|to
op_eq
op_minus
id|EINVAL
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|dasd_add_range
(paren
id|from
comma
id|to
comma
id|features
)paren
suffix:semicolon
)brace
)brace
id|str
op_increment
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* SECTION: Dealing with devices registered to multiple major numbers */
DECL|variable|dasd_major_lock
r_static
id|spinlock_t
id|dasd_major_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|dasd_major_info
r_static
id|major_info_t
id|dasd_major_info
(braket
)braket
op_assign
(brace
(brace
id|list
suffix:colon
id|LIST_HEAD_INIT
(paren
id|dasd_major_info
(braket
l_int|1
)braket
dot
id|list
)paren
)brace
comma
(brace
id|list
suffix:colon
id|LIST_HEAD_INIT
(paren
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
comma
id|gendisk
suffix:colon
(brace
id|INIT_GENDISK
(paren
l_int|94
comma
id|DASD_NAME
comma
id|DASD_PARTN_BITS
comma
id|DASD_PER_MAJOR
)paren
)brace
comma
id|flags
suffix:colon
id|DASD_MAJOR_INFO_IS_STATIC
)brace
)brace
suffix:semicolon
r_static
id|major_info_t
op_star
DECL|function|get_new_major_info
id|get_new_major_info
(paren
r_void
)paren
(brace
id|major_info_t
op_star
id|major_info
op_assign
l_int|NULL
suffix:semicolon
id|major_info
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|major_info_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|major_info
)paren
(brace
r_static
id|major_info_t
id|temp_major_info
op_assign
(brace
id|gendisk
suffix:colon
(brace
id|INIT_GENDISK
(paren
l_int|0
comma
id|DASD_NAME
comma
id|DASD_PARTN_BITS
comma
id|DASD_PER_MAJOR
)paren
)brace
)brace
suffix:semicolon
id|memcpy
(paren
id|major_info
comma
op_amp
id|temp_major_info
comma
r_sizeof
(paren
id|major_info_t
)paren
)paren
suffix:semicolon
)brace
r_return
id|major_info
suffix:semicolon
)brace
multiline_comment|/*&n; * register major number&n; * is called with the &squot;static&squot; major_info during init of the driver or &squot;NULL&squot; to&n; * allocate an additional dynamic major.&n; */
r_static
r_int
DECL|function|dasd_register_major
id|dasd_register_major
(paren
id|major_info_t
op_star
id|major_info
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|major
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* allocate dynamic major */
r_if
c_cond
(paren
id|major_info
op_eq
l_int|NULL
)paren
(brace
id|major_info
op_assign
id|get_new_major_info
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|major_info
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Cannot get memory to allocate another major number&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|major
op_assign
id|major_info-&gt;gendisk.major
suffix:semicolon
multiline_comment|/* init devfs array */
id|major_info-&gt;gendisk.de_arr
op_assign
(paren
id|devfs_handle_t
op_star
)paren
id|kmalloc
(paren
id|DASD_PER_MAJOR
op_star
r_sizeof
(paren
id|devfs_handle_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
(paren
id|major_info-&gt;gendisk.de_arr
comma
l_int|0
comma
id|DASD_PER_MAJOR
op_star
r_sizeof
(paren
id|devfs_handle_t
)paren
)paren
suffix:semicolon
multiline_comment|/* init flags */
id|major_info-&gt;gendisk.flags
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
(paren
id|DASD_PER_MAJOR
op_star
r_sizeof
(paren
r_char
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
(paren
id|major_info-&gt;gendisk.flags
comma
l_int|0
comma
id|DASD_PER_MAJOR
op_star
r_sizeof
(paren
r_char
)paren
)paren
suffix:semicolon
multiline_comment|/* register blockdevice */
id|rc
op_assign
id|devfs_register_blkdev
(paren
id|major
comma
id|DASD_NAME
comma
op_amp
id|dasd_device_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Cannot register to major no %d, rc = %d&bslash;n&quot;
comma
id|major
comma
id|rc
)paren
suffix:semicolon
r_goto
id|out_reg_blkdev
suffix:semicolon
)brace
r_else
(brace
id|major_info-&gt;flags
op_or_assign
id|DASD_MAJOR_INFO_REGISTERED
suffix:semicolon
)brace
multiline_comment|/* Insert the new major info into dasd_major_info if needed (dynamic major) */
r_if
c_cond
(paren
op_logical_neg
(paren
id|major_info-&gt;flags
op_amp
id|DASD_MAJOR_INFO_IS_STATIC
)paren
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|major_info-&gt;list
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|major
op_eq
l_int|0
)paren
(brace
id|major
op_assign
id|rc
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* init array of devices */
id|major_info-&gt;dasd_device
op_assign
(paren
id|dasd_device_t
op_star
op_star
)paren
id|kmalloc
(paren
id|DASD_PER_MAJOR
op_star
r_sizeof
(paren
id|dasd_device_t
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|major_info-&gt;dasd_device
)paren
r_goto
id|out_devices
suffix:semicolon
id|memset
(paren
id|major_info-&gt;dasd_device
comma
l_int|0
comma
id|DASD_PER_MAJOR
op_star
r_sizeof
(paren
id|dasd_device_t
op_star
)paren
)paren
suffix:semicolon
multiline_comment|/* init blk_size */
id|blk_size
(braket
id|major
)braket
op_assign
(paren
r_int
op_star
)paren
id|kmalloc
(paren
(paren
l_int|1
op_lshift
id|MINORBITS
)paren
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|blk_size
(braket
id|major
)braket
)paren
r_goto
id|out_blk_size
suffix:semicolon
id|memset
(paren
id|blk_size
(braket
id|major
)braket
comma
l_int|0
comma
(paren
l_int|1
op_lshift
id|MINORBITS
)paren
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
multiline_comment|/* init blksize_size */
id|blksize_size
(braket
id|major
)braket
op_assign
(paren
r_int
op_star
)paren
id|kmalloc
(paren
(paren
l_int|1
op_lshift
id|MINORBITS
)paren
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|blksize_size
(braket
id|major
)braket
)paren
r_goto
id|out_blksize_size
suffix:semicolon
id|memset
(paren
id|blksize_size
(braket
id|major
)braket
comma
l_int|0
comma
(paren
l_int|1
op_lshift
id|MINORBITS
)paren
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
multiline_comment|/* finally do the gendisk stuff */
id|major_info-&gt;gendisk.part
op_assign
id|kmalloc
(paren
(paren
l_int|1
op_lshift
id|MINORBITS
)paren
op_star
r_sizeof
(paren
r_struct
id|hd_struct
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|major_info-&gt;gendisk.part
)paren
r_goto
id|out_gendisk
suffix:semicolon
id|memset
(paren
id|major_info-&gt;gendisk.part
comma
l_int|0
comma
(paren
l_int|1
op_lshift
id|MINORBITS
)paren
op_star
r_sizeof
(paren
r_struct
id|hd_struct
)paren
)paren
suffix:semicolon
id|INIT_BLK_DEV
(paren
id|major
comma
id|do_dasd_request
comma
id|dasd_get_queue
comma
l_int|NULL
)paren
suffix:semicolon
id|major_info-&gt;gendisk.sizes
op_assign
id|blk_size
(braket
id|major
)braket
suffix:semicolon
id|major_info-&gt;gendisk.major
op_assign
id|major
suffix:semicolon
id|add_gendisk
(paren
op_amp
id|major_info-&gt;gendisk
)paren
suffix:semicolon
r_return
id|major
suffix:semicolon
multiline_comment|/* error handling - free the prior allocated memory */
id|out_gendisk
suffix:colon
id|kfree
(paren
id|blksize_size
(braket
id|major
)braket
)paren
suffix:semicolon
id|blksize_size
(braket
id|major
)braket
op_assign
l_int|NULL
suffix:semicolon
id|out_blksize_size
suffix:colon
id|kfree
(paren
id|blk_size
(braket
id|major
)braket
)paren
suffix:semicolon
id|blk_size
(braket
id|major
)braket
op_assign
l_int|NULL
suffix:semicolon
id|out_blk_size
suffix:colon
id|kfree
(paren
id|major_info-&gt;dasd_device
)paren
suffix:semicolon
id|out_devices
suffix:colon
multiline_comment|/* Delete the new major info from dasd_major_info list if needed (dynamic) +*/
r_if
c_cond
(paren
op_logical_neg
(paren
id|major_info-&gt;flags
op_amp
id|DASD_MAJOR_INFO_IS_STATIC
)paren
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|major_info-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* unregister blockdevice */
id|rc
op_assign
id|devfs_unregister_blkdev
(paren
id|major
comma
id|DASD_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Unable to unregister from major no %d, rc = %d&bslash;n&quot;
comma
id|major
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
(brace
id|major_info-&gt;flags
op_and_assign
op_complement
id|DASD_MAJOR_INFO_REGISTERED
suffix:semicolon
)brace
id|out_reg_blkdev
suffix:colon
id|kfree
(paren
id|major_info-&gt;gendisk.flags
)paren
suffix:semicolon
id|kfree
(paren
id|major_info-&gt;gendisk.de_arr
)paren
suffix:semicolon
multiline_comment|/* Delete the new major info from dasd_major_info if needed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|major_info-&gt;flags
op_amp
id|DASD_MAJOR_INFO_IS_STATIC
)paren
)paren
(brace
id|kfree
(paren
id|major_info
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_unregister_major
id|dasd_unregister_major
(paren
id|major_info_t
op_star
id|major_info
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|major
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|major_info
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|major
op_assign
id|major_info-&gt;gendisk.major
suffix:semicolon
id|INIT_BLK_DEV
(paren
id|major
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|del_gendisk
(paren
op_amp
id|major_info-&gt;gendisk
)paren
suffix:semicolon
id|kfree
(paren
id|major_info-&gt;dasd_device
)paren
suffix:semicolon
id|kfree
(paren
id|major_info-&gt;gendisk.part
)paren
suffix:semicolon
id|kfree
(paren
id|blk_size
(braket
id|major
)braket
)paren
suffix:semicolon
id|kfree
(paren
id|blksize_size
(braket
id|major
)braket
)paren
suffix:semicolon
id|blk_clear
c_func
(paren
id|major
)paren
suffix:semicolon
id|rc
op_assign
id|devfs_unregister_blkdev
(paren
id|major
comma
id|DASD_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Cannot unregister from major no %d, rc = %d&bslash;n&quot;
comma
id|major
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
id|major_info-&gt;flags
op_and_assign
op_complement
id|DASD_MAJOR_INFO_REGISTERED
suffix:semicolon
)brace
id|kfree
(paren
id|major_info-&gt;gendisk.flags
)paren
suffix:semicolon
id|kfree
(paren
id|major_info-&gt;gendisk.de_arr
)paren
suffix:semicolon
multiline_comment|/* Delete the new major info from dasd_major_info if needed */
r_if
c_cond
(paren
op_logical_neg
(paren
id|major_info-&gt;flags
op_amp
id|DASD_MAJOR_INFO_IS_STATIC
)paren
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|major_info-&gt;list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
(paren
id|major_info
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_device_from_kdev&n; * finds the device structure corresponding to the kdev supplied as argument&n; * in the major_info structures and returns it or NULL when not found&n; */
r_static
r_inline
id|dasd_device_t
op_star
DECL|function|dasd_device_from_kdev
id|dasd_device_from_kdev
(paren
id|kdev_t
id|kdev
)paren
(brace
id|major_info_t
op_star
id|major_info
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|major_info
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|major_info-&gt;gendisk.major
op_eq
id|MAJOR
(paren
id|kdev
)paren
)paren
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|major_info
op_ne
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
)paren
r_return
id|major_info-&gt;dasd_device
(braket
id|MINOR
(paren
id|kdev
)paren
op_rshift
id|DASD_PARTN_BITS
)braket
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_device_from_devno&n; * finds the address of the device structure corresponding to the devno&n; * supplied as argument in the major_info structures and returns&n; * it or NULL when not found&n; */
r_static
r_inline
id|dasd_device_t
op_star
op_star
DECL|function|dasd_device_from_devno
id|dasd_device_from_devno
(paren
r_int
id|devno
)paren
(brace
id|major_info_t
op_star
id|major_info
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
id|devindex
op_assign
id|dasd_devindex_from_devno
(paren
id|devno
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|major_info
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devindex
OL
id|DASD_PER_MAJOR
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_amp
id|major_info-&gt;dasd_device
(braket
id|devindex
)braket
suffix:semicolon
)brace
id|devindex
op_sub_assign
id|DASD_PER_MAJOR
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|dasd_major_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * function: dasd_features_from_devno&n; * finds the device range corresponding to the devno&n; * supplied as argument in the major_info structures and returns&n; * the features set for it&n; */
r_static
r_int
DECL|function|dasd_features_from_devno
id|dasd_features_from_devno
(paren
r_int
id|devno
)paren
(brace
id|dasd_range_t
op_star
id|temp
suffix:semicolon
r_int
id|devindex
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_range_head.list
)paren
(brace
id|temp
op_assign
id|list_entry
(paren
id|l
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devno
op_ge
id|temp-&gt;from
op_logical_and
id|devno
op_le
id|temp-&gt;to
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|temp-&gt;features
suffix:semicolon
)brace
id|devindex
op_add_assign
id|temp-&gt;to
op_minus
id|temp-&gt;from
op_plus
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|range_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* SECTION: managing dasd disciplines */
multiline_comment|/* anchor and spinlock for list of disciplines */
DECL|variable|dasd_disc_head
r_static
r_struct
id|list_head
id|dasd_disc_head
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|dasd_disc_head
)paren
suffix:semicolon
DECL|variable|discipline_lock
r_static
id|spinlock_t
id|discipline_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * function dasd_discipline_enq&n; * chains the discpline given as argument to the head of disiplines&n; * head chaining policy is required to allow module disciplines to&n; * be preferred against those, who are statically linked&n; */
r_static
r_inline
r_void
DECL|function|dasd_discipline_enq
id|dasd_discipline_enq
(paren
id|dasd_discipline_t
op_star
id|d
)paren
(brace
id|list_add
c_func
(paren
op_amp
id|d-&gt;list
comma
op_amp
id|dasd_disc_head
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_discipline_deq&n; * removes the discipline given as argument from the list of disciplines&n; */
r_static
r_inline
r_void
DECL|function|dasd_discipline_deq
id|dasd_discipline_deq
(paren
id|dasd_discipline_t
op_star
id|d
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|d-&gt;list
)paren
suffix:semicolon
)brace
r_void
DECL|function|dasd_discipline_add
id|dasd_discipline_add
(paren
id|dasd_discipline_t
op_star
id|d
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|discipline_lock
comma
id|flags
)paren
suffix:semicolon
id|dasd_discipline_enq
(paren
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|discipline_lock
comma
id|flags
)paren
suffix:semicolon
id|dasd_enable_ranges
(paren
op_amp
id|dasd_range_head
comma
id|d
comma
id|DASD_STATE_ONLINE
)paren
suffix:semicolon
)brace
DECL|function|dasd_discipline_del
r_void
id|dasd_discipline_del
(paren
id|dasd_discipline_t
op_star
id|d
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|discipline_lock
comma
id|flags
)paren
suffix:semicolon
id|dasd_disable_ranges
c_func
(paren
op_amp
id|dasd_range_head
comma
id|d
comma
id|DASD_STATE_DEL
comma
l_int|1
)paren
suffix:semicolon
id|dasd_discipline_deq
(paren
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|discipline_lock
comma
id|flags
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_static
r_inline
id|dasd_discipline_t
op_star
DECL|function|dasd_find_disc
id|dasd_find_disc
(paren
id|dasd_device_t
op_star
id|device
comma
id|dasd_discipline_t
op_star
id|d
)paren
(brace
id|dasd_discipline_t
op_star
id|t
suffix:semicolon
r_struct
id|list_head
op_star
id|l
op_assign
id|d
ques
c_cond
op_amp
id|d-&gt;list
suffix:colon
id|dasd_disc_head.next
suffix:semicolon
r_do
(brace
id|t
op_assign
id|list_entry
c_func
(paren
id|l
comma
id|dasd_discipline_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t-&gt;id_check
op_eq
l_int|NULL
op_logical_or
id|t-&gt;id_check
(paren
op_amp
id|device-&gt;devinfo
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|t-&gt;check_characteristics
op_eq
l_int|NULL
op_logical_or
id|t-&gt;check_characteristics
(paren
id|device
)paren
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
id|l
op_assign
id|l-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|d
op_logical_or
id|l
op_eq
op_amp
id|dasd_disc_head
)paren
(brace
id|t
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_return
id|t
suffix:semicolon
)brace
multiline_comment|/* SECTION: profiling stuff */
DECL|variable|dasd_global_profile
r_static
id|dasd_profile_info_t
id|dasd_global_profile
suffix:semicolon
macro_line|#ifdef DASD_PROFILE
multiline_comment|/*&n; * macro: dasd_profile_add_counter&n; * increments counter in global and local profiling structures&n; * according to the value&n; */
DECL|macro|dasd_profile_add_counter
mdefine_line|#define dasd_profile_add_counter( value, counter, device ) &bslash;&n;{ &bslash;&n;        int ind; &bslash;&n;        long help; &bslash;&n;&t;for (ind = 0, help = value &gt;&gt; 3; &bslash;&n;             ind &lt; 31 &amp;&amp; help; &bslash;&n;             help = help &gt;&gt; 1, ind++) {} &bslash;&n;&t;dasd_global_profile.counter[ind]++; &bslash;&n;        device-&gt;profile.counter[ind]++; &bslash;&n;}
multiline_comment|/*&n; * function dasd_profile_add&n; * adds the profiling information from the cqr given as argument to the&n; * global and device specific profiling information&n; */
r_void
DECL|function|dasd_profile_add
id|dasd_profile_add
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_int
id|strtime
comma
id|irqtime
comma
id|endtime
comma
id|tottime
suffix:semicolon
multiline_comment|/* in microsecnds*/
r_int
id|tottimeps
comma
id|sectors
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr-&gt;req
)paren
multiline_comment|/* safeguard against abnormal cqrs */
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|cqr-&gt;buildclk
)paren
op_logical_or
(paren
op_logical_neg
id|cqr-&gt;startclk
)paren
op_logical_or
(paren
op_logical_neg
id|cqr-&gt;stopclk
)paren
op_logical_or
(paren
op_logical_neg
id|cqr-&gt;endclk
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|sectors
op_assign
(paren
(paren
r_struct
id|request
op_star
)paren
(paren
id|cqr-&gt;req
)paren
)paren
op_member_access_from_pointer
id|nr_sectors
)paren
)paren
)paren
r_return
suffix:semicolon
id|strtime
op_assign
(paren
(paren
id|cqr-&gt;startclk
op_minus
id|cqr-&gt;buildclk
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|irqtime
op_assign
(paren
(paren
id|cqr-&gt;stopclk
op_minus
id|cqr-&gt;startclk
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|endtime
op_assign
(paren
(paren
id|cqr-&gt;endclk
op_minus
id|cqr-&gt;stopclk
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|tottime
op_assign
(paren
(paren
id|cqr-&gt;endclk
op_minus
id|cqr-&gt;buildclk
)paren
op_rshift
l_int|12
)paren
suffix:semicolon
id|tottimeps
op_assign
id|tottime
op_div
id|sectors
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dasd_global_profile.dasd_io_reqs
)paren
(brace
id|memset
(paren
op_amp
id|dasd_global_profile
comma
l_int|0
comma
r_sizeof
(paren
id|dasd_profile_info_t
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device-&gt;profile.dasd_io_reqs
)paren
(brace
id|memset
(paren
op_amp
id|device-&gt;profile
comma
l_int|0
comma
r_sizeof
(paren
id|dasd_profile_info_t
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
id|dasd_global_profile.dasd_io_reqs
op_increment
suffix:semicolon
id|device-&gt;profile.dasd_io_reqs
op_increment
suffix:semicolon
id|dasd_global_profile.dasd_io_sects
op_add_assign
id|sectors
suffix:semicolon
id|device-&gt;profile.dasd_io_sects
op_add_assign
id|sectors
suffix:semicolon
id|dasd_profile_add_counter
(paren
id|sectors
comma
id|dasd_io_secs
comma
id|device
)paren
suffix:semicolon
id|dasd_profile_add_counter
(paren
id|tottime
comma
id|dasd_io_times
comma
id|device
)paren
suffix:semicolon
id|dasd_profile_add_counter
(paren
id|tottimeps
comma
id|dasd_io_timps
comma
id|device
)paren
suffix:semicolon
id|dasd_profile_add_counter
(paren
id|strtime
comma
id|dasd_io_time1
comma
id|device
)paren
suffix:semicolon
id|dasd_profile_add_counter
(paren
id|irqtime
comma
id|dasd_io_time2
comma
id|device
)paren
suffix:semicolon
id|dasd_profile_add_counter
(paren
id|irqtime
op_div
id|sectors
comma
id|dasd_io_time2ps
comma
id|device
)paren
suffix:semicolon
id|dasd_profile_add_counter
(paren
id|endtime
comma
id|dasd_io_time3
comma
id|device
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* SECTION: All the gendisk stuff */
multiline_comment|/* SECTION: Managing wrappers for ccwcache */
multiline_comment|/*&n; * function dasd_alloc_request&n; * tries to return space for a channel program of length cplength with&n; * additional data of size datasize.&n; * If the ccwcache cannot fulfill the request it tries the emergeny requests&n; * before giving up finally&n; * FIXME: initialization of ccw_req_t should be done by function of ccwcache&n; */
id|ccw_req_t
op_star
DECL|function|dasd_alloc_request
id|dasd_alloc_request
(paren
r_char
op_star
id|magic
comma
r_int
id|cplength
comma
r_int
id|datasize
comma
id|dasd_device_t
op_star
id|device
)paren
(brace
id|ccw_req_t
op_star
id|rv
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|ccw_alloc_request
(paren
id|magic
comma
id|cplength
comma
id|datasize
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_return
id|rv
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
(paren
r_sizeof
(paren
id|ccw_req_t
)paren
op_plus
l_int|7
)paren
op_amp
op_minus
l_int|8
)paren
op_plus
id|cplength
op_star
r_sizeof
(paren
id|ccw1_t
)paren
op_plus
id|datasize
)paren
OG
id|PAGE_SIZE
)paren
(brace
id|BUG
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;lowmem_cqr
op_eq
l_int|NULL
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|2
comma
id|dasd_alloc_request
comma
l_string|&quot;(%04x) Low memory! Using emergency request %p.&quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;lowmem_ccws
)paren
suffix:semicolon
id|device-&gt;lowmem_cqr
op_assign
id|device-&gt;lowmem_ccws
suffix:semicolon
id|rv
op_assign
id|device-&gt;lowmem_ccws
suffix:semicolon
id|memset
(paren
id|rv
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|strncpy
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|rv-&gt;magic
)paren
comma
id|magic
comma
l_int|4
)paren
suffix:semicolon
id|ASCEBC
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|rv-&gt;magic
)paren
comma
l_int|4
)paren
suffix:semicolon
id|rv-&gt;cplength
op_assign
id|cplength
suffix:semicolon
id|rv-&gt;datasize
op_assign
id|datasize
suffix:semicolon
id|rv-&gt;data
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_int
)paren
id|rv
op_plus
id|PAGE_SIZE
op_minus
id|datasize
)paren
suffix:semicolon
id|rv-&gt;cpaddr
op_assign
(paren
id|ccw1_t
op_star
)paren
(paren
(paren
r_int
)paren
id|rv
op_plus
r_sizeof
(paren
id|ccw_req_t
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|2
comma
id|dasd_alloc_request
comma
l_string|&quot;(%04x) Refusing emergency mem for request &quot;
l_string|&quot;NULL, already in use at %p.&quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;lowmem_ccws
)paren
suffix:semicolon
)brace
r_return
id|rv
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_free_request&n; * returns a ccw_req_t to the appropriate cache or emergeny request line&n; */
r_void
DECL|function|dasd_free_request
id|dasd_free_request
(paren
id|ccw_req_t
op_star
id|request
comma
id|dasd_device_t
op_star
id|device
)paren
(brace
macro_line|#ifdef CONFIG_ARCH_S390X
id|ccw1_t
op_star
id|ccw
suffix:semicolon
multiline_comment|/* clear any idals used for chain */
id|ccw
op_assign
id|request-&gt;cpaddr
op_minus
l_int|1
suffix:semicolon
r_do
(brace
id|ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ccw-&gt;cda
OL
(paren
r_int
r_int
)paren
id|device-&gt;lowmem_idals
)paren
op_logical_or
(paren
id|ccw-&gt;cda
op_ge
(paren
r_int
r_int
)paren
id|device-&gt;lowmem_idals
op_plus
id|PAGE_SIZE
)paren
)paren
id|clear_normalized_cda
(paren
id|ccw
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|device-&gt;lowmem_idal_ptr
op_ne
id|device-&gt;lowmem_idals
)paren
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;Freeing emergency idals from request at %p.&quot;
comma
id|request
)paren
suffix:semicolon
id|device-&gt;lowmem_idal_ptr
op_assign
id|device-&gt;lowmem_idals
suffix:semicolon
id|device-&gt;lowmem_cqr
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_CC
)paren
op_logical_or
(paren
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_DC
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|request
op_ne
id|device-&gt;lowmem_ccws
)paren
(brace
multiline_comment|/* compare to lowmem_ccws to protect usage of lowmem_cqr for IDAL only ! */
id|ccw_free_request
(paren
id|request
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;Freeing emergency request at %p&quot;
comma
id|request
)paren
suffix:semicolon
id|device-&gt;lowmem_cqr
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_int
DECL|function|dasd_set_normalized_cda
id|dasd_set_normalized_cda
(paren
id|ccw1_t
op_star
id|cp
comma
r_int
r_int
id|address
comma
id|ccw_req_t
op_star
id|request
comma
id|dasd_device_t
op_star
id|device
)paren
(brace
macro_line|#ifdef CONFIG_ARCH_S390X
r_int
id|nridaws
suffix:semicolon
r_int
id|count
op_assign
id|cp-&gt;count
suffix:semicolon
r_if
c_cond
(paren
id|set_normalized_cda
(paren
id|cp
comma
id|address
)paren
op_ne
op_minus
id|ENOMEM
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|device-&gt;lowmem_cqr
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|device-&gt;lowmem_cqr
op_ne
id|request
)paren
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;Refusing emergency idals for request %p, memory&quot;
l_string|&quot; is already in use for request %p&quot;
comma
id|request
comma
id|device-&gt;lowmem_cqr
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|device-&gt;lowmem_cqr
op_assign
id|request
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;lowmem_idal_ptr
op_eq
id|device-&gt;lowmem_idals
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;Low memory! Using emergency IDALs for request %p.&bslash;n&quot;
comma
id|request
)paren
suffix:semicolon
)brace
id|nridaws
op_assign
(paren
(paren
id|address
op_amp
(paren
id|IDA_BLOCK_SIZE
op_minus
l_int|1
)paren
)paren
op_plus
id|count
op_plus
(paren
id|IDA_BLOCK_SIZE
op_minus
l_int|1
)paren
)paren
op_rshift
id|IDA_SIZE_LOG
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;lowmem_idal_ptr
op_ge
id|device-&gt;lowmem_idals
op_plus
id|PAGE_SIZE
)paren
(brace
multiline_comment|/* Ouch! No Idals left for emergency request */
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|cp-&gt;flags
op_or_assign
id|CCW_FLAG_IDA
suffix:semicolon
id|cp-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
r_int
r_int
)paren
id|device-&gt;lowmem_idal_ptr
suffix:semicolon
r_do
(brace
op_star
(paren
(paren
r_int
op_star
)paren
id|device-&gt;lowmem_idal_ptr
)paren
op_assign
id|address
suffix:semicolon
id|address
op_assign
(paren
id|address
op_amp
op_minus
(paren
id|IDA_BLOCK_SIZE
)paren
)paren
op_plus
(paren
id|IDA_BLOCK_SIZE
)paren
suffix:semicolon
id|nridaws
op_decrement
suffix:semicolon
id|device-&gt;lowmem_idal_ptr
op_add_assign
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nridaws
OG
l_int|0
)paren
suffix:semicolon
macro_line|#else 
id|cp
op_member_access_from_pointer
id|cda
op_assign
id|address
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* SECTION: (de)queueing of requests to channel program queues */
multiline_comment|/*&n; * function dasd_chanq_enq&n; * appends the cqr given as argument to the queue&n; * has to be called with the queue lock (namely the s390_irq_lock) acquired&n; */
r_inline
r_void
DECL|function|dasd_chanq_enq
id|dasd_chanq_enq
(paren
id|dasd_chanq_t
op_star
id|q
comma
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_if
c_cond
(paren
id|q-&gt;head
op_ne
l_int|NULL
)paren
(brace
id|q-&gt;tail-&gt;next
op_assign
id|cqr
suffix:semicolon
)brace
r_else
id|q-&gt;head
op_assign
id|cqr
suffix:semicolon
id|cqr-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|q-&gt;tail
op_assign
id|cqr
suffix:semicolon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_FILLED
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
macro_line|#ifdef DASD_PROFILE
multiline_comment|/* save profile information for non erp cqr */
r_if
c_cond
(paren
id|cqr-&gt;refers
op_eq
l_int|NULL
)paren
(brace
r_int
r_int
id|counter
op_assign
l_int|0
suffix:semicolon
id|ccw_req_t
op_star
id|ptr
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
multiline_comment|/* count the length of the chanq for statistics */
r_for
c_loop
(paren
id|ptr
op_assign
id|q-&gt;head
suffix:semicolon
id|ptr-&gt;next
op_ne
l_int|NULL
op_logical_and
id|counter
op_le
l_int|31
suffix:semicolon
id|ptr
op_assign
id|ptr-&gt;next
)paren
(brace
id|counter
op_increment
suffix:semicolon
)brace
id|dasd_global_profile.dasd_io_nr_req
(braket
id|counter
)braket
op_increment
suffix:semicolon
id|device-&gt;profile.dasd_io_nr_req
(braket
id|counter
)braket
op_increment
suffix:semicolon
)brace
macro_line|#endif 
)brace
multiline_comment|/*&n; * function dasd_chanq_enq_head&n; * chains the cqr given as argument to the queue head&n; * has to be called with the queue lock (namely the s390_irq_lock) acquired&n; */
r_inline
r_void
DECL|function|dasd_chanq_enq_head
id|dasd_chanq_enq_head
(paren
id|dasd_chanq_t
op_star
id|q
comma
id|ccw_req_t
op_star
id|cqr
)paren
(brace
id|cqr-&gt;next
op_assign
id|q-&gt;head
suffix:semicolon
id|q-&gt;head
op_assign
id|cqr
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;tail
op_eq
l_int|NULL
)paren
id|q-&gt;tail
op_assign
id|cqr
suffix:semicolon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_FILLED
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_chanq_deq&n; * dechains the cqr given as argument from the queue&n; * has to be called with the queue lock (namely the s390_irq_lock) acquired&n; */
r_inline
r_void
DECL|function|dasd_chanq_deq
id|dasd_chanq_deq
(paren
id|dasd_chanq_t
op_star
id|q
comma
id|ccw_req_t
op_star
id|cqr
)paren
(brace
id|ccw_req_t
op_star
id|prev
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
id|BUG
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
id|q-&gt;head
)paren
(brace
id|q-&gt;head
op_assign
id|cqr-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;head
op_eq
l_int|NULL
)paren
id|q-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|prev
op_assign
id|q-&gt;head
suffix:semicolon
r_while
c_loop
(paren
id|prev
op_logical_and
id|prev-&gt;next
op_ne
id|cqr
)paren
id|prev
op_assign
id|prev-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|prev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|prev-&gt;next
op_assign
id|cqr-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|prev-&gt;next
op_eq
l_int|NULL
)paren
id|q-&gt;tail
op_assign
id|prev
suffix:semicolon
)brace
id|cqr-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* SECTION: Managing the device queues etc. */
multiline_comment|/*&n; * DASD_TERM_IO&n; *&n; * attempts to terminate the the current IO and set it to failed if termination&n; * was successful.&n; * returns an appropriate return code&n; */
r_int
DECL|function|dasd_term_IO
id|dasd_term_IO
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_int
id|retries
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
id|BUG
(paren
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|device-&gt;devinfo.irq
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
id|device-&gt;discipline-&gt;ebcname
comma
l_int|4
)paren
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot; ccw_req_t 0x%08x magic doesn&squot;t match&quot;
l_string|&quot; discipline 0x%08x&bslash;n&quot;
comma
id|cqr-&gt;magic
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|device-&gt;discipline-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|retries
OL
l_int|5
)paren
op_logical_and
(paren
id|cqr-&gt;status
op_eq
id|CQR_STATUS_IN_IO
)paren
)paren
(brace
r_if
c_cond
(paren
id|retries
OL
l_int|2
)paren
id|rc
op_assign
id|halt_IO
c_func
(paren
id|irq
comma
(paren
r_int
)paren
id|cqr
comma
id|cqr-&gt;options
op_or
id|DOIO_WAIT_FOR_INTERRUPT
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|clear_IO
c_func
(paren
id|irq
comma
(paren
r_int
)paren
id|cqr
comma
id|cqr-&gt;options
op_or
id|DOIO_WAIT_FOR_INTERRUPT
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rc
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* termination successful */
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_IN_IO
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|cqr-&gt;stopclk
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENODEV
suffix:colon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;device gone, retry&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EIO
suffix:colon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;I/O error, retry&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EBUSY
suffix:colon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;device busy, retry later&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DASD_MESSAGE
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;line %d unknown RC=%d, please report&quot;
l_string|&quot; to linux390@de.ibm.com&bslash;n&quot;
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
id|BUG
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|retries
op_increment
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_start_IO&n; * attempts to start the IO and returns an appropriate return code&n; */
r_int
DECL|function|dasd_start_IO
id|dasd_start_IO
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_int
r_int
r_int
id|now
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
id|BUG
(paren
)paren
suffix:semicolon
)brace
id|irq
op_assign
id|device-&gt;devinfo.irq
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
id|device-&gt;discipline-&gt;ebcname
comma
l_int|4
)paren
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot; ccw_req_t 0x%08x magic doesn&squot;t match&quot;
l_string|&quot; discipline 0x%08x&bslash;n&quot;
comma
id|cqr-&gt;magic
comma
op_star
(paren
r_int
r_int
op_star
)paren
id|device-&gt;discipline-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|now
)paren
)paren
suffix:semicolon
id|cqr-&gt;startclk
op_assign
id|now
suffix:semicolon
id|rc
op_assign
id|do_IO
(paren
id|irq
comma
id|cqr-&gt;cpaddr
comma
(paren
r_int
)paren
id|cqr
comma
id|cqr-&gt;lpm
comma
id|cqr-&gt;options
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rc
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|cqr-&gt;options
op_amp
id|DOIO_WAIT_FOR_INTERRUPT
)paren
(brace
multiline_comment|/* request already finished (synchronous IO) */
id|DASD_MESSAGE
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot; do_IO finished request... &quot;
l_string|&quot;DOIO_WAIT_FOR_INTERRUPT was set&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_QUEUED
comma
id|CQR_STATUS_DONE
)paren
suffix:semicolon
id|cqr-&gt;stopclk
op_assign
id|now
suffix:semicolon
id|dasd_schedule_bh
(paren
id|device
)paren
suffix:semicolon
)brace
r_else
(brace
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_QUEUED
comma
id|CQR_STATUS_IN_IO
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
op_minus
id|EBUSY
suffix:colon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;device busy, retry later&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ETIMEDOUT
suffix:colon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;request timeout - terminated&bslash;n&quot;
)paren
suffix:semicolon
r_case
op_minus
id|ENODEV
suffix:colon
r_case
op_minus
id|EIO
suffix:colon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_QUEUED
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
id|cqr-&gt;stopclk
op_assign
id|now
suffix:semicolon
id|dasd_schedule_bh
(paren
id|device
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DASD_MESSAGE
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;line %d unknown RC=%d, please report&quot;
l_string|&quot; to linux390@de.ibm.com&bslash;n&quot;
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
id|BUG
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_sleep_on_req&n; * attempts to start the IO and waits for completion&n; * FIXME: replace handmade sleeping by wait_event&n; */
r_int
DECL|function|dasd_sleep_on_req
id|dasd_sleep_on_req
(paren
id|ccw_req_t
op_star
id|req
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|cs
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
(paren
id|dasd_device_t
op_star
)paren
id|req-&gt;device
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
id|dasd_chanq_enq
(paren
op_amp
id|device-&gt;queue
comma
id|req
)paren
suffix:semicolon
multiline_comment|/* let the bh start the request to keep them in order */
id|dasd_schedule_bh
(paren
id|device
)paren
suffix:semicolon
r_do
(brace
id|s390irq_spin_unlock_irqrestore
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
id|wait_event
(paren
id|device-&gt;wait_q
comma
(paren
(paren
(paren
id|cs
op_assign
id|req-&gt;status
)paren
op_eq
id|CQR_STATUS_DONE
)paren
op_logical_or
(paren
id|cs
op_eq
id|CQR_STATUS_FAILED
)paren
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;status
op_eq
id|CQR_STATUS_IN_IO
)paren
id|device-&gt;discipline
op_member_access_from_pointer
id|term_IO
c_func
(paren
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|req-&gt;status
op_eq
id|CQR_STATUS_FAILED
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|cs
op_ne
id|CQR_STATUS_DONE
op_logical_and
id|cs
op_ne
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* end dasd_sleep_on_req */
multiline_comment|/*&n; * function dasd_end_request&n; * posts the buffer_cache about a finalized request&n; * FIXME: for requests splitted to serveral cqrs&n; */
r_static
r_inline
r_void
DECL|function|dasd_end_request
id|dasd_end_request
(paren
r_struct
id|request
op_star
id|req
comma
r_int
id|uptodate
)paren
(brace
r_while
c_loop
(paren
id|end_that_request_first
(paren
id|req
comma
id|uptodate
comma
id|DASD_NAME
)paren
)paren
(brace
)brace
macro_line|#ifndef DEVICE_NO_RANDOM
id|add_blkdev_randomness
(paren
id|MAJOR
(paren
id|req-&gt;rq_dev
)paren
)paren
suffix:semicolon
macro_line|#endif
id|end_that_request_last
(paren
id|req
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_get_queue&n; * returns the queue corresponding to a device behind a kdev&n; */
r_static
id|request_queue_t
op_star
DECL|function|dasd_get_queue
id|dasd_get_queue
(paren
id|kdev_t
id|kdev
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|dasd_device_from_kdev
(paren
id|kdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|device-&gt;request_queue
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_check_expire_time&n; * check the request given as argument for expiration&n; * and returns 0 if not yet expired, EIO else&n; */
r_static
r_inline
r_int
DECL|function|dasd_check_expire_time
id|dasd_check_expire_time
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_int
r_int
r_int
id|now
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|now
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;expires
op_logical_and
id|cqr-&gt;expires
op_plus
id|cqr-&gt;startclk
OL
id|now
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_ERR
comma
(paren
(paren
id|dasd_device_t
op_star
)paren
id|cqr-&gt;device
)paren
comma
l_string|&quot;IO timeout 0x%08lx%08lx usecs in req %p&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|cqr-&gt;expires
op_rshift
l_int|44
)paren
comma
(paren
r_int
)paren
(paren
id|cqr-&gt;expires
op_rshift
l_int|12
)paren
comma
id|cqr
)paren
suffix:semicolon
id|cqr-&gt;expires
op_lshift_assign
l_int|1
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_finalize_request&n; * implemets the actions to perform, when a request is finally finished&n; * namely in status CQR_STATUS_DONE || CQR_STATUS_FAILED&n; */
r_static
r_inline
r_void
DECL|function|dasd_finalize_request
id|dasd_finalize_request
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|cqr-&gt;endclk
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;req
)paren
(brace
macro_line|#ifdef DASD_PROFILE
id|dasd_profile_add
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#endif
id|dasd_end_request
(paren
id|cqr-&gt;req
comma
(paren
id|cqr-&gt;status
op_eq
id|CQR_STATUS_DONE
)paren
)paren
suffix:semicolon
multiline_comment|/* free request if nobody is waiting on it */
id|dasd_free_request
(paren
id|cqr
comma
id|cqr-&gt;device
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|cqr
op_eq
id|device-&gt;init_cqr
op_logical_and
multiline_comment|/* bring late devices online */
id|device-&gt;level
op_le
id|DASD_STATE_ONLINE
)paren
(brace
id|device-&gt;timer.function
op_assign
id|dasd_enable_single_device
suffix:semicolon
id|device-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|device
suffix:semicolon
id|device-&gt;timer.expires
op_assign
id|jiffies
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|device-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/* notify sleeping task about finished postprocessing */
id|wake_up
(paren
op_amp
id|device-&gt;wait_q
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_process_queues&n; * transfers the requests on the queue given as argument to the chanq&n; * if possible, the request ist started on a fastpath&n; */
r_static
r_void
DECL|function|dasd_process_queues
id|dasd_process_queues
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
id|request_queue_t
op_star
id|queue
op_assign
id|device-&gt;request_queue
suffix:semicolon
id|dasd_chanq_t
op_star
id|qp
op_assign
op_amp
id|device-&gt;queue
suffix:semicolon
r_int
id|irq
op_assign
id|device-&gt;devinfo.irq
suffix:semicolon
id|ccw_req_t
op_star
id|final_requests
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|chanq_min_size
op_assign
id|DASD_MIN_SIZE_FOR_QUEUE
suffix:semicolon
r_int
id|chanq_max_size
op_assign
id|DASD_CHANQ_MAX_SIZE
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
op_assign
l_int|NULL
comma
op_star
id|temp
suffix:semicolon
id|dasd_erp_postaction_fn_t
id|erp_postaction
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|irq
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* First we dechain the requests, processed with completed status */
r_while
c_loop
(paren
id|qp-&gt;head
op_logical_and
(paren
(paren
id|qp-&gt;head-&gt;status
op_eq
id|CQR_STATUS_DONE
)paren
op_logical_or
(paren
id|qp-&gt;head-&gt;status
op_eq
id|CQR_STATUS_FAILED
)paren
op_logical_or
(paren
id|qp-&gt;head-&gt;status
op_eq
id|CQR_STATUS_ERROR
)paren
)paren
)paren
(brace
id|dasd_erp_action_fn_t
id|erp_action
suffix:semicolon
id|ccw_req_t
op_star
id|erp_cqr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*  preprocess requests with CQR_STATUS_ERROR */
r_if
c_cond
(paren
id|qp-&gt;head-&gt;status
op_eq
id|CQR_STATUS_ERROR
)paren
(brace
id|qp-&gt;head-&gt;retries
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|qp-&gt;head-&gt;dstat-&gt;flag
op_amp
id|DEVSTAT_HALT_FUNCTION
)paren
(brace
id|check_then_set
(paren
op_amp
id|qp-&gt;head-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|qp-&gt;head-&gt;stopclk
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|device-&gt;discipline-&gt;erp_action
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|erp_action
op_assign
id|device-&gt;discipline-&gt;erp_action
(paren
id|qp-&gt;head
)paren
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
id|erp_cqr
op_assign
id|dasd_default_erp_action
(paren
id|qp-&gt;head
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* call discipline ERP action */
id|erp_cqr
op_assign
id|erp_action
(paren
id|qp-&gt;head
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|qp-&gt;head-&gt;refers
)paren
(brace
multiline_comment|/* we deal with a finished ERP */
r_if
c_cond
(paren
id|qp-&gt;head-&gt;status
op_eq
id|CQR_STATUS_DONE
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ERP successful&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_MESSAGE
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ERP unsuccessful&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|device-&gt;discipline-&gt;erp_postaction
op_eq
l_int|NULL
)paren
op_logical_or
(paren
(paren
id|erp_postaction
op_assign
id|device-&gt;discipline-&gt;erp_postaction
(paren
id|qp-&gt;head
)paren
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
id|dasd_default_erp_postaction
(paren
id|qp-&gt;head
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* call ERP postaction of discipline */
id|erp_postaction
(paren
id|qp-&gt;head
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* dechain request now */
r_if
c_cond
(paren
id|final_requests
op_eq
l_int|NULL
)paren
id|final_requests
op_assign
id|qp-&gt;head
suffix:semicolon
id|cqr
op_assign
id|qp-&gt;head
suffix:semicolon
id|qp-&gt;head
op_assign
id|qp-&gt;head-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|qp-&gt;head
op_eq
l_int|NULL
)paren
id|qp-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* end while over completed requests */
r_if
c_cond
(paren
id|cqr
)paren
id|cqr-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Now clean the requests with final status */
r_while
c_loop
(paren
id|final_requests
)paren
(brace
id|temp
op_assign
id|final_requests
suffix:semicolon
id|final_requests
op_assign
id|temp-&gt;next
suffix:semicolon
id|dasd_finalize_request
(paren
id|temp
)paren
suffix:semicolon
)brace
multiline_comment|/* Now we try to fetch requests from the request queue */
r_for
c_loop
(paren
id|temp
op_assign
id|cqr
suffix:semicolon
id|temp
op_ne
l_int|NULL
suffix:semicolon
id|temp
op_assign
id|temp-&gt;next
)paren
r_if
c_cond
(paren
id|temp-&gt;status
op_eq
id|CQR_STATUS_QUEUED
)paren
id|chanq_max_size
op_decrement
suffix:semicolon
r_while
c_loop
(paren
(paren
id|atomic_read
c_func
(paren
op_amp
id|device-&gt;plugged
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
id|queue-&gt;plugged
)paren
op_logical_and
(paren
op_logical_neg
id|list_empty
(paren
op_amp
id|queue-&gt;queue_head
)paren
)paren
op_logical_and
(paren
id|req
op_assign
id|dasd_next_request
(paren
id|queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* queue empty or certain critera fulfilled -&gt; transfer */
r_if
c_cond
(paren
id|qp-&gt;head
op_eq
l_int|NULL
op_logical_or
id|chanq_max_size
OG
l_int|0
op_logical_or
(paren
id|req-&gt;nr_sectors
op_ge
id|chanq_min_size
)paren
)paren
(brace
id|ccw_req_t
op_star
id|cqr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|is_read_only
c_func
(paren
id|device-&gt;kdev
)paren
op_logical_and
id|req-&gt;cmd
op_eq
id|WRITE
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|3
comma
id|dasd_int_handler
comma
l_string|&quot;(%04x) Rejecting write request %p&bslash;n&quot;
comma
id|device-&gt;devinfo.devno
comma
id|req
)paren
suffix:semicolon
id|dasd_end_request
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
id|dasd_dequeue_request
(paren
id|queue
comma
id|req
)paren
suffix:semicolon
)brace
r_else
(brace
id|cqr
op_assign
id|device-&gt;discipline-&gt;build_cp_from_req
(paren
id|device
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|3
comma
id|dasd_int_handler
comma
l_string|&quot;(%04x) CCW creation failed &quot;
l_string|&quot;on request %p&bslash;n&quot;
comma
id|device-&gt;devinfo.devno
comma
id|req
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* terminate request queue loop */
)brace
macro_line|#ifdef CONFIG_DYNAMIC_QUEUE_MIN_SIZE
id|chanq_min_size
op_assign
(paren
id|chanq_min_size
op_plus
id|req-&gt;nr_sectors
)paren
op_rshift
l_int|1
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_DYNAMIC_QUEUE_MIN_SIZE */
id|dasd_dequeue_request
(paren
id|queue
comma
id|req
)paren
suffix:semicolon
id|dasd_chanq_enq
(paren
id|qp
comma
id|cqr
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* queue not empty OR criteria not met */
r_break
suffix:semicolon
multiline_comment|/* terminate request queue loop */
)brace
)brace
multiline_comment|/* we process the requests with non-final status */
r_if
c_cond
(paren
id|qp-&gt;head
)paren
(brace
r_switch
c_cond
(paren
id|qp-&gt;head-&gt;status
)paren
(brace
r_case
id|CQR_STATUS_QUEUED
suffix:colon
multiline_comment|/* try to start the first I/O that can be started */
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;start_IO
op_eq
l_int|NULL
)paren
id|BUG
(paren
)paren
suffix:semicolon
id|device-&gt;discipline
op_member_access_from_pointer
id|start_IO
c_func
(paren
id|qp-&gt;head
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CQR_STATUS_IN_IO
suffix:colon
multiline_comment|/* Check, if to invoke the missing interrupt handler */
r_if
c_cond
(paren
id|dasd_check_expire_time
(paren
id|qp-&gt;head
)paren
)paren
(brace
multiline_comment|/* to be filled with MIH */
)brace
r_break
suffix:semicolon
r_case
id|CQR_STATUS_PENDING
suffix:colon
multiline_comment|/* just wait */
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
(paren
)paren
suffix:semicolon
)brace
)brace
id|s390irq_spin_unlock_irqrestore
(paren
id|irq
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* end dasd_process_queues */
multiline_comment|/*&n; * function dasd_run_bh&n; * acquires the locks needed and then runs the bh&n; */
r_static
r_void
DECL|function|dasd_run_bh
id|dasd_run_bh
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|device-&gt;request_queue.queue_lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_set
(paren
op_amp
id|device-&gt;bh_scheduled
comma
l_int|0
)paren
suffix:semicolon
id|dasd_process_queues
(paren
id|device
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|device-&gt;request_queue.queue_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_schedule_bh&n; * schedules the request_fn to run with next run_bh cycle&n; */
r_void
DECL|function|dasd_schedule_bh
id|dasd_schedule_bh
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
multiline_comment|/* Protect against rescheduling, when already running */
r_if
c_cond
(paren
id|atomic_compare_and_swap
(paren
l_int|0
comma
l_int|1
comma
op_amp
id|device-&gt;bh_scheduled
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|INIT_LIST_HEAD
(paren
op_amp
id|device-&gt;bh_tq.list
)paren
suffix:semicolon
id|device-&gt;bh_tq.sync
op_assign
l_int|0
suffix:semicolon
id|device-&gt;bh_tq.routine
op_assign
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|dasd_run_bh
suffix:semicolon
id|device-&gt;bh_tq.data
op_assign
id|device
suffix:semicolon
id|queue_task
(paren
op_amp
id|device-&gt;bh_tq
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * function do_dasd_request&n; * is called from ll_rw_blk.c and provides the caller of&n; * dasd_process_queues&n; */
r_static
r_void
DECL|function|do_dasd_request
id|do_dasd_request
(paren
id|request_queue_t
op_star
id|queue
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
(paren
id|dasd_device_t
op_star
)paren
id|queue-&gt;queuedata
suffix:semicolon
id|dasd_process_queues
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * DASD_HANDLE_STATE_CHANGE_PENDING&n; *&n; * DESCRIPTION&n; *   Handles the state change pending interrupt.&n; *   Search for the device related request queue and check if the first&n; *   cqr in queue in in status &squot;CQR_STATUE_PENDING&squot;.&n; *   If so the status is set to &squot;CQR_STATUS_QUEUED&squot; to reactivate&n; *   the device.&n; *&n; *  PARAMETER&n; *   stat               device status of state change pending interrupt.&n; */
r_void
DECL|function|dasd_handle_state_change_pending
id|dasd_handle_state_change_pending
(paren
id|devstat_t
op_star
id|stat
)paren
(brace
id|dasd_device_t
op_star
op_star
id|device_addr
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|device_addr
op_assign
id|dasd_device_from_devno
(paren
id|stat-&gt;devno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_addr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|PRINTK_HEADER
l_string|&quot;unable to find device for state change pending &quot;
l_string|&quot;interrupt: devno%04x&bslash;n&quot;
comma
id|stat-&gt;devno
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* re-activate first request in queue */
id|cqr
op_assign
(paren
op_star
id|device_addr
)paren
op_member_access_from_pointer
id|queue.head
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;status
op_eq
id|CQR_STATUS_PENDING
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_DEBUG
comma
(paren
op_star
id|device_addr
)paren
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;device request queue restarted by &quot;
l_string|&quot;state change pending interrupt&bslash;n&quot;
)paren
suffix:semicolon
id|del_timer
(paren
op_amp
(paren
op_star
id|device_addr
)paren
op_member_access_from_pointer
id|timer
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_PENDING
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
id|dasd_schedule_bh
(paren
op_star
id|device_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end dasd_handle_state_change_pending */
multiline_comment|/*&n; * function dasd_int_handler&n; * is the DASD driver&squot;s default interrupt handler for SSCH-IO&n; */
r_void
DECL|function|dasd_int_handler
id|dasd_int_handler
(paren
r_int
id|irq
comma
r_void
op_star
id|ds
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|ip
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|dasd_device_t
op_star
id|device
suffix:semicolon
r_int
r_int
r_int
id|now
suffix:semicolon
id|dasd_era_t
id|era
op_assign
id|dasd_era_none
suffix:semicolon
multiline_comment|/* default is everything is okay */
id|devstat_t
op_star
id|stat
op_assign
(paren
id|devstat_t
op_star
)paren
id|ds
suffix:semicolon
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|6
comma
id|dasd_int_handler
comma
l_string|&quot;Interrupt: IRQ %02x, stat %02x, devno %04x&quot;
comma
id|irq
comma
id|stat-&gt;dstat
comma
id|stat-&gt;devno
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|now
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_eq
l_int|NULL
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* first of all check for state change pending interrupt */
r_if
c_cond
(paren
(paren
id|stat-&gt;dstat
op_amp
id|DEV_STAT_ATTENTION
)paren
op_logical_and
(paren
id|stat-&gt;dstat
op_amp
id|DEV_STAT_DEV_END
)paren
op_logical_and
(paren
id|stat-&gt;dstat
op_amp
id|DEV_STAT_UNIT_EXCEP
)paren
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|2
comma
id|dasd_int_handler
comma
l_string|&quot;State change Interrupt: %04x&quot;
comma
id|stat-&gt;devno
)paren
suffix:semicolon
id|dasd_handle_state_change_pending
(paren
id|stat
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ip
op_assign
id|stat-&gt;intparm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip
)paren
(brace
multiline_comment|/* no intparm: unsolicited interrupt */
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|2
comma
id|dasd_int_handler
comma
l_string|&quot;Unsolicited Interrupt: %04x&quot;
comma
id|stat-&gt;devno
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|PRINTK_HEADER
l_string|&quot;unsolicited interrupt: irq 0x%x devno %04x&bslash;n&quot;
comma
id|irq
comma
id|stat-&gt;devno
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip
op_amp
l_int|0x80000001
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|2
comma
id|dasd_int_handler
comma
l_string|&quot;spurious Interrupt: %04x&quot;
comma
id|stat-&gt;devno
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|PRINTK_HEADER
l_string|&quot;spurious interrupt: irq 0x%x devno %04x, parm %08x&bslash;n&quot;
comma
id|irq
comma
id|stat-&gt;devno
comma
id|ip
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cqr
op_assign
(paren
id|ccw_req_t
op_star
)paren
(paren
r_int
)paren
id|ip
suffix:semicolon
multiline_comment|/* check status - the request might have been killed because of dyn dettach */
r_if
c_cond
(paren
id|cqr-&gt;status
op_ne
id|CQR_STATUS_IN_IO
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|2
comma
id|dasd_int_handler
comma
l_string|&quot;invalid status %02x on device %04x&quot;
comma
id|cqr-&gt;status
comma
id|stat-&gt;devno
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|PRINTK_HEADER
l_string|&quot;invalid status: irq 0x%x devno %04x, status %02x&bslash;n&quot;
comma
id|irq
comma
id|stat-&gt;devno
comma
id|cqr-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|device
op_assign
(paren
id|dasd_device_t
op_star
)paren
id|cqr-&gt;device
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
op_logical_or
id|device
op_ne
id|ds
op_minus
m_offsetof
(paren
id|dasd_device_t
comma
id|dev_status
)paren
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;devinfo.irq
op_ne
id|irq
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
(paren
id|device-&gt;discipline-&gt;ebcname
comma
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
l_int|4
)paren
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* first of all lets try to find out the appropriate era_action */
id|DASD_DEVICE_DEBUG_EVENT
(paren
l_int|4
comma
id|device
comma
l_string|&quot; Int: CS/DS 0x%04x&quot;
comma
(paren
(paren
id|stat-&gt;cstat
op_lshift
l_int|8
)paren
op_or
id|stat-&gt;dstat
)paren
)paren
suffix:semicolon
multiline_comment|/* first of all lets try to find out the appropriate era_action */
r_if
c_cond
(paren
id|stat-&gt;flag
op_amp
id|DEVSTAT_FLAG_SENSE_AVAIL
op_logical_or
id|stat-&gt;dstat
op_amp
op_complement
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
(brace
multiline_comment|/* anything abnormal ? */
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;examine_error
op_eq
l_int|NULL
op_logical_or
id|stat-&gt;flag
op_amp
id|DEVSTAT_HALT_FUNCTION
)paren
(brace
id|era
op_assign
id|dasd_era_fatal
suffix:semicolon
)brace
r_else
(brace
id|era
op_assign
id|device-&gt;discipline-&gt;examine_error
(paren
id|cqr
comma
id|stat
)paren
suffix:semicolon
)brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_int_handler
comma
l_string|&quot; era_code %d&quot;
comma
id|era
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|era
op_eq
id|dasd_era_none
)paren
(brace
id|check_then_set
c_func
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_IN_IO
comma
id|CQR_STATUS_DONE
)paren
suffix:semicolon
id|cqr-&gt;stopclk
op_assign
id|now
suffix:semicolon
multiline_comment|/* start the next queued request if possible -&gt; fast_io */
r_if
c_cond
(paren
id|cqr-&gt;next
op_logical_and
id|cqr-&gt;next-&gt;status
op_eq
id|CQR_STATUS_QUEUED
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;start_IO
(paren
id|cqr-&gt;next
)paren
op_ne
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Interrupt fastpath failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* error */
r_if
c_cond
(paren
id|cqr-&gt;dstat
op_eq
l_int|NULL
)paren
id|cqr-&gt;dstat
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|devstat_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;dstat
)paren
(brace
id|memcpy
(paren
id|cqr-&gt;dstat
comma
id|stat
comma
r_sizeof
(paren
id|devstat_t
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT_ERR
(paren
l_string|&quot;no memory for dstat...ignoring&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef ERP_DEBUG
multiline_comment|/* dump sense data */
r_if
c_cond
(paren
id|device-&gt;discipline
op_logical_and
id|device-&gt;discipline-&gt;dump_sense
)paren
(brace
id|device-&gt;discipline-&gt;dump_sense
(paren
id|device
comma
id|cqr
)paren
suffix:semicolon
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|era
)paren
(brace
r_case
id|dasd_era_fatal
suffix:colon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_IN_IO
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
id|cqr-&gt;stopclk
op_assign
id|now
suffix:semicolon
r_break
suffix:semicolon
r_case
id|dasd_era_recover
suffix:colon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_IN_IO
comma
id|CQR_STATUS_ERROR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cqr
op_eq
id|device-&gt;init_cqr
op_logical_and
(paren
id|cqr-&gt;status
op_eq
id|CQR_STATUS_DONE
op_logical_or
id|cqr-&gt;status
op_eq
id|CQR_STATUS_FAILED
)paren
)paren
(brace
id|dasd_state_init_to_ready
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dasd_init_pending
)paren
op_eq
l_int|0
)paren
id|wake_up
(paren
op_amp
id|dasd_init_waitq
)paren
suffix:semicolon
)brace
id|dasd_schedule_bh
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* end dasd_int_handler */
multiline_comment|/* SECTION: Some stuff related to error recovery */
multiline_comment|/*&n; * DEFAULT_ERP_ACTION&n; *&n; * DESCRIPTION&n; *   sets up the default-ERP ccw_req_t, namely one, which performs a TIC&n; *   to the original channel program with a retry counter of 16&n; *&n; * PARAMETER&n; *   cqr                failed CQR&n; *&n; * RETURN VALUES&n; *   erp                CQR performing the ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_default_erp_action
id|dasd_default_erp_action
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
id|ccw_req_t
op_star
id|erp
op_assign
id|dasd_alloc_request
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
l_int|1
comma
l_int|0
comma
id|cqr-&gt;device
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
id|PRINTK_HEADER
l_string|&quot;Default ERP called... &bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|erp
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to allocate ERP request&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|cqr-&gt;stopclk
)paren
)paren
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
id|erp-&gt;cpaddr-&gt;cmd_code
op_assign
id|CCW_CMD_TIC
suffix:semicolon
id|erp-&gt;cpaddr-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|cqr-&gt;cpaddr
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_default_erp_action
suffix:semicolon
id|erp-&gt;refers
op_assign
id|cqr
suffix:semicolon
id|erp-&gt;device
op_assign
id|cqr-&gt;device
suffix:semicolon
id|erp-&gt;magic
op_assign
id|cqr-&gt;magic
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|16
suffix:semicolon
id|erp-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
id|dasd_chanq_enq_head
(paren
op_amp
id|device-&gt;queue
comma
id|erp
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_default_erp_action */
multiline_comment|/*&n; * DEFAULT_ERP_POSTACTION&n; *&n; * DESCRIPTION&n; *   Frees all ERPs of the current ERP Chain and set the status&n; *   of the original CQR either to CQR_STATUS_DONE if ERP was successful&n; *   or to CQR_STATUS_FAILED if ERP was NOT successful.&n; *   NOTE: This function is only called if no discipline postaction&n; *         is available&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; *&n; * RETURN VALUES&n; *   cqr                pointer to the original CQR&n; */
id|ccw_req_t
op_star
DECL|function|dasd_default_erp_postaction
id|dasd_default_erp_postaction
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
id|ccw_req_t
op_star
id|cqr
op_assign
l_int|NULL
comma
op_star
id|free_erp
op_assign
l_int|NULL
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
r_int
id|success
suffix:semicolon
r_if
c_cond
(paren
id|erp-&gt;refers
op_eq
l_int|NULL
op_logical_or
id|erp-&gt;function
op_eq
l_int|NULL
)paren
(brace
id|BUG
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|erp-&gt;status
op_eq
id|CQR_STATUS_DONE
)paren
id|success
op_assign
l_int|1
suffix:semicolon
r_else
id|success
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* free all ERPs - but NOT the original cqr */
r_while
c_loop
(paren
id|erp-&gt;refers
op_ne
l_int|NULL
)paren
(brace
id|free_erp
op_assign
id|erp
suffix:semicolon
id|erp
op_assign
id|erp-&gt;refers
suffix:semicolon
multiline_comment|/* remove the request from the device queue */
id|dasd_chanq_deq
(paren
op_amp
id|device-&gt;queue
comma
id|free_erp
)paren
suffix:semicolon
multiline_comment|/* free the finished erp request */
id|dasd_free_request
(paren
id|free_erp
comma
id|free_erp-&gt;device
)paren
suffix:semicolon
)brace
multiline_comment|/* save ptr to original cqr */
id|cqr
op_assign
id|erp
suffix:semicolon
multiline_comment|/* set corresponding status to original cqr */
r_if
c_cond
(paren
id|success
)paren
(brace
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_DONE
)paren
suffix:semicolon
)brace
r_else
(brace
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|cqr-&gt;stopclk
)paren
)paren
suffix:semicolon
)brace
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* end default_erp_postaction */
multiline_comment|/* SECTION: The helpers of the struct file_operations */
multiline_comment|/*&n; * function dasd_format&n; * performs formatting of _device_ according to _fdata_&n; * Note: The discipline&squot;s format_function is assumed to deliver formatting&n; * commands to format a single unit of the device. In terms of the ECKD&n; * devices this means CCWs are generated to format a single track.&n; */
r_static
r_int
DECL|function|dasd_format
id|dasd_format
(paren
id|dasd_device_t
op_star
id|device
comma
id|format_data_t
op_star
id|fdata
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|openct
op_assign
id|atomic_read
(paren
op_amp
id|device-&gt;open_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|openct
OG
l_int|1
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;dasd_format: device is open! expect errors.&quot;
)paren
suffix:semicolon
)brace
id|DASD_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;formatting units %d to %d (%d B blocks) flags %d&quot;
comma
id|fdata-&gt;start_unit
comma
id|fdata-&gt;stop_unit
comma
id|fdata-&gt;blksize
comma
id|fdata-&gt;intensity
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
id|rc
)paren
op_logical_and
(paren
id|fdata-&gt;start_unit
op_le
id|fdata-&gt;stop_unit
)paren
)paren
(brace
id|ccw_req_t
op_star
id|req
suffix:semicolon
id|dasd_format_fn_t
id|ffn
op_assign
id|device-&gt;discipline-&gt;format_device
suffix:semicolon
id|ffn
op_assign
id|device-&gt;discipline-&gt;format_device
suffix:semicolon
r_if
c_cond
(paren
id|ffn
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|req
op_assign
id|ffn
(paren
id|device
comma
id|fdata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dasd_sleep_on_req
(paren
id|req
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot; Formatting of unit %d failed with rc = %d&bslash;n&quot;
comma
id|fdata-&gt;start_unit
comma
id|rc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dasd_free_request
(paren
id|req
comma
id|device
)paren
suffix:semicolon
multiline_comment|/* request is no longer used */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|fdata-&gt;start_unit
op_increment
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* end dasd_format */
DECL|variable|dasd_ioctls
r_static
r_struct
id|list_head
id|dasd_ioctls
op_assign
id|LIST_HEAD_INIT
(paren
id|dasd_ioctls
)paren
suffix:semicolon
r_static
id|dasd_ioctl_list_t
op_star
DECL|function|dasd_find_ioctl
id|dasd_find_ioctl
(paren
r_int
id|no
)paren
(brace
r_struct
id|list_head
op_star
id|curr
suffix:semicolon
id|list_for_each
(paren
id|curr
comma
op_amp
id|dasd_ioctls
)paren
(brace
r_if
c_cond
(paren
id|list_entry
(paren
id|curr
comma
id|dasd_ioctl_list_t
comma
id|list
)paren
op_member_access_from_pointer
id|no
op_eq
id|no
)paren
(brace
r_return
id|list_entry
(paren
id|curr
comma
id|dasd_ioctl_list_t
comma
id|list
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_int
DECL|function|dasd_ioctl_no_register
id|dasd_ioctl_no_register
(paren
r_struct
id|module
op_star
id|owner
comma
r_int
id|no
comma
id|dasd_ioctl_fn_t
id|handler
)paren
(brace
id|dasd_ioctl_list_t
op_star
r_new
suffix:semicolon
r_if
c_cond
(paren
id|dasd_find_ioctl
(paren
id|no
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_new
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|dasd_ioctl_list_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_new
op_member_access_from_pointer
id|owner
op_assign
id|owner
suffix:semicolon
r_new
op_member_access_from_pointer
id|no
op_assign
id|no
suffix:semicolon
r_new
op_member_access_from_pointer
id|handler
op_assign
id|handler
suffix:semicolon
id|list_add
(paren
op_amp
r_new
op_member_access_from_pointer
id|list
comma
op_amp
id|dasd_ioctls
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|dasd_ioctl_no_unregister
id|dasd_ioctl_no_unregister
(paren
r_struct
id|module
op_star
id|owner
comma
r_int
id|no
comma
id|dasd_ioctl_fn_t
id|handler
)paren
(brace
id|dasd_ioctl_list_t
op_star
id|old
op_assign
id|dasd_find_ioctl
(paren
id|no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|old-&gt;no
op_ne
id|no
op_logical_or
id|old-&gt;handler
op_ne
id|handler
op_logical_or
id|owner
op_ne
id|old-&gt;owner
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|list_del
(paren
op_amp
id|old-&gt;list
)paren
suffix:semicolon
id|kfree
(paren
id|old
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_revalidate
id|dasd_revalidate
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|kdev_t
id|kdev
op_assign
id|device-&gt;kdev
suffix:semicolon
r_int
id|openct
op_assign
id|atomic_read
(paren
op_amp
id|device-&gt;open_count
)paren
suffix:semicolon
r_int
id|start
op_assign
id|MINOR
(paren
id|kdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|openct
op_ne
l_int|1
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;BLKRRPART: device is open! expect errors.&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
(paren
l_int|1
op_lshift
id|DASD_PARTN_BITS
)paren
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_int
id|major
op_assign
id|device-&gt;major_info-&gt;gendisk.major
suffix:semicolon
id|invalidate_device
c_func
(paren
id|MKDEV
(paren
id|major
comma
id|start
op_plus
id|i
)paren
comma
l_int|1
)paren
suffix:semicolon
)brace
id|dasd_destroy_partitions
c_func
(paren
id|device
)paren
suffix:semicolon
id|dasd_setup_partitions
c_func
(paren
id|device
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_dasd_ioctl
id|do_dasd_ioctl
(paren
r_struct
id|inode
op_star
id|inp
comma
multiline_comment|/* unsigned */
r_int
id|no
comma
r_int
r_int
id|data
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|dasd_device_from_kdev
(paren
id|inp-&gt;i_rdev
)paren
suffix:semicolon
id|major_info_t
op_star
id|major_info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No device registered as device (%d:%d)&bslash;n&quot;
comma
id|MAJOR
(paren
id|inp-&gt;i_rdev
)paren
comma
id|MINOR
(paren
id|inp-&gt;i_rdev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|_IOC_DIR
(paren
id|no
)paren
op_ne
id|_IOC_NONE
)paren
op_logical_and
(paren
id|data
op_eq
l_int|0
)paren
)paren
(brace
id|PRINT_DEBUG
(paren
l_string|&quot;empty data ptr&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|major_info
op_assign
id|device-&gt;major_info
suffix:semicolon
macro_line|#if 0
id|printk
(paren
id|KERN_DEBUG
id|PRINTK_HEADER
l_string|&quot;ioctl 0x%08x %s&squot;0x%x&squot;%d(%d) on /dev/%s (%d:%d,&quot;
l_string|&quot; devno 0x%04x on irq %d) with data %8lx&bslash;n&quot;
comma
id|no
comma
id|_IOC_DIR
(paren
id|no
)paren
op_eq
id|_IOC_NONE
ques
c_cond
l_string|&quot;0&quot;
suffix:colon
id|_IOC_DIR
(paren
id|no
)paren
op_eq
id|_IOC_READ
ques
c_cond
l_string|&quot;r&quot;
suffix:colon
id|_IOC_DIR
(paren
id|no
)paren
op_eq
id|_IOC_WRITE
ques
c_cond
l_string|&quot;w&quot;
suffix:colon
id|_IOC_DIR
(paren
id|no
)paren
op_eq
(paren
id|_IOC_READ
op_or
id|_IOC_WRITE
)paren
ques
c_cond
l_string|&quot;rw&quot;
suffix:colon
l_string|&quot;u&quot;
comma
id|_IOC_TYPE
(paren
id|no
)paren
comma
id|_IOC_NR
(paren
id|no
)paren
comma
id|_IOC_SIZE
(paren
id|no
)paren
comma
id|device-&gt;name
comma
id|MAJOR
(paren
id|inp-&gt;i_rdev
)paren
comma
id|MINOR
(paren
id|inp-&gt;i_rdev
)paren
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;devinfo.irq
comma
id|data
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|no
)paren
(brace
r_case
id|DASDAPIVER
suffix:colon
(brace
r_int
id|ver
op_assign
id|DASD_API_VERSION
suffix:semicolon
id|rc
op_assign
id|put_user
c_func
(paren
id|ver
comma
(paren
r_int
op_star
)paren
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BLKRRPART
suffix:colon
(brace
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rc
op_assign
id|dasd_revalidate
(paren
id|device
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|HDIO_GETGEO
suffix:colon
(brace
r_struct
id|hd_geometry
id|geo
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
id|rc
op_assign
id|dasd_fillgeo
(paren
id|inp-&gt;i_rdev
comma
op_amp
id|geo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_break
suffix:semicolon
id|rc
op_assign
id|copy_to_user
(paren
(paren
r_struct
id|hd_geometry
op_star
)paren
id|data
comma
op_amp
id|geo
comma
r_sizeof
(paren
r_struct
id|hd_geometry
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BIODASDDISABLE
suffix:colon
(brace
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;level
OG
id|DASD_STATE_ACCEPT
)paren
(brace
id|dasd_deactivate_queue
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;request_queue
)paren
id|dasd_flush_request_queues
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
id|dasd_flush_chanq
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
id|dasd_disable_blkdev
c_func
(paren
id|device
)paren
suffix:semicolon
id|dasd_set_device_level
(paren
id|device-&gt;devinfo.devno
comma
id|device-&gt;discipline
comma
id|DASD_STATE_ACCEPT
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|BIODASDENABLE
suffix:colon
(brace
id|dasd_range_t
id|range
op_assign
(brace
id|from
suffix:colon
id|device-&gt;devinfo.devno
comma
id|to
suffix:colon
id|device-&gt;devinfo.devno
)brace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dasd_enable_ranges
(paren
op_amp
id|range
comma
id|device-&gt;discipline
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BIODASDFMT
suffix:colon
(brace
multiline_comment|/* fdata == NULL is no longer a valid arg to dasd_format ! */
r_int
id|partn
op_assign
id|MINOR
(paren
id|inp-&gt;i_rdev
)paren
op_amp
(paren
(paren
l_int|1
op_lshift
id|major_info-&gt;gendisk.minor_shift
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|format_data_t
id|fdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dasd_features_from_devno
c_func
(paren
id|device-&gt;devinfo.devno
)paren
op_amp
id|DASD_FEATURE_READONLY
)paren
(brace
id|rc
op_assign
op_minus
id|EROFS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rc
op_assign
id|copy_from_user
(paren
op_amp
id|fdata
comma
(paren
r_void
op_star
)paren
id|data
comma
r_sizeof
(paren
id|format_data_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|partn
op_ne
l_int|0
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Cannot low-level format a partition&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|rc
op_assign
id|dasd_format
(paren
id|device
comma
op_amp
id|fdata
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BIODASDPRRST
suffix:colon
(brace
multiline_comment|/* reset device profile information */
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memset
(paren
op_amp
id|device-&gt;profile
comma
l_int|0
comma
r_sizeof
(paren
id|dasd_profile_info_t
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BIODASDPRRD
suffix:colon
(brace
multiline_comment|/* retrun device profile information */
id|rc
op_assign
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|data
comma
(paren
r_int
op_star
)paren
op_amp
id|device-&gt;profile
comma
r_sizeof
(paren
id|dasd_profile_info_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BIODASDRSRV
suffix:colon
(brace
multiline_comment|/* reserve */
id|ccw_req_t
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
id|req
op_assign
id|device-&gt;discipline-&gt;reserve
(paren
id|device
)paren
suffix:semicolon
id|rc
op_assign
id|dasd_sleep_on_req
(paren
id|req
)paren
suffix:semicolon
id|dasd_free_request
(paren
id|req
comma
id|device
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BIODASDRLSE
suffix:colon
(brace
multiline_comment|/* release */
id|ccw_req_t
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
id|req
op_assign
id|device-&gt;discipline-&gt;release
(paren
id|device
)paren
suffix:semicolon
id|rc
op_assign
id|dasd_sleep_on_req
(paren
id|req
)paren
suffix:semicolon
id|dasd_free_request
(paren
id|req
comma
id|device
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BIODASDSLCK
suffix:colon
(brace
multiline_comment|/* steal lock - unconditional reserve */
id|ccw_req_t
op_star
id|req
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
id|req
op_assign
id|device-&gt;discipline-&gt;steal_lock
(paren
id|device
)paren
suffix:semicolon
id|rc
op_assign
id|dasd_sleep_on_req
(paren
id|req
)paren
suffix:semicolon
id|dasd_free_request
(paren
id|req
comma
id|device
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|BIODASDINFO
suffix:colon
(brace
id|dasd_information_t
id|dasd_info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|rc
op_assign
id|device-&gt;discipline-&gt;fill_info
(paren
id|device
comma
op_amp
id|dasd_info
)paren
suffix:semicolon
id|dasd_info.label_block
op_assign
id|device-&gt;sizes.pt_block
suffix:semicolon
id|dasd_info.devno
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
id|dasd_info.schid
op_assign
id|device-&gt;devinfo.irq
suffix:semicolon
id|dasd_info.cu_type
op_assign
id|device-&gt;devinfo.sid_data.cu_type
suffix:semicolon
id|dasd_info.cu_model
op_assign
id|device-&gt;devinfo.sid_data.cu_model
suffix:semicolon
id|dasd_info.dev_type
op_assign
id|device-&gt;devinfo.sid_data.dev_type
suffix:semicolon
id|dasd_info.dev_model
op_assign
id|device-&gt;devinfo.sid_data.dev_model
suffix:semicolon
id|dasd_info.open_count
op_assign
id|atomic_read
(paren
op_amp
id|device-&gt;open_count
)paren
suffix:semicolon
id|dasd_info.status
op_assign
id|device-&gt;level
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;discipline
)paren
(brace
id|memcpy
(paren
id|dasd_info.type
comma
id|device-&gt;discipline-&gt;name
comma
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|dasd_info.type
comma
l_string|&quot;none&quot;
comma
l_int|4
)paren
suffix:semicolon
)brace
id|dasd_info.req_queue_len
op_assign
l_int|0
suffix:semicolon
id|dasd_info.chanq_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;request_queue-&gt;request_fn
)paren
(brace
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|request_queue_t
op_star
id|q
op_assign
id|drive-&gt;request_queue
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
op_assign
id|device-&gt;queue.head
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
(paren
id|l
comma
id|q-&gt;queue_head
comma
id|queue_head
)paren
id|dasd_info.req_queue_len
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|q-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cqr
)paren
(brace
id|cqr
op_assign
id|cqr-&gt;next
suffix:semicolon
id|dasd_info.chanq_len
op_increment
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
(paren
id|device-&gt;devinfo
dot
id|irq
comma
id|flags
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|copy_to_user
(paren
(paren
r_int
op_star
)paren
id|data
comma
(paren
r_int
op_star
)paren
op_amp
id|dasd_info
comma
r_sizeof
(paren
id|dasd_information_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if 0 /* needed for XFS */
r_case
id|BLKBSZSET
suffix:colon
(brace
r_int
id|bsz
suffix:semicolon
id|rc
op_assign
id|copy_from_user
(paren
(paren
r_int
op_star
)paren
op_amp
id|bsz
comma
(paren
r_int
op_star
)paren
id|data
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|bsz
op_ge
id|device-&gt;sizes.bp_block
)paren
id|rc
op_assign
id|blk_ioctl
(paren
id|inp-&gt;i_bdev
comma
id|no
comma
id|data
)paren
suffix:semicolon
r_else
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
macro_line|#endif /* 0 */
r_case
id|BLKGETSIZE
suffix:colon
r_case
id|BLKGETSIZE64
suffix:colon
r_case
id|BLKSSZGET
suffix:colon
r_case
id|BLKROSET
suffix:colon
r_case
id|BLKROGET
suffix:colon
r_case
id|BLKFLSBUF
suffix:colon
r_case
id|BLKPG
suffix:colon
r_case
id|BLKELVGET
suffix:colon
r_case
id|BLKELVSET
suffix:colon
r_return
id|blk_ioctl
(paren
id|inp-&gt;i_bdev
comma
id|no
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
id|dasd_ioctl_list_t
op_star
id|old
op_assign
id|dasd_find_ioctl
(paren
id|no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old
)paren
(brace
r_if
c_cond
(paren
id|old-&gt;owner
)paren
id|__MOD_INC_USE_COUNT
c_func
(paren
id|old-&gt;owner
)paren
suffix:semicolon
id|rc
op_assign
id|old-&gt;handler
(paren
id|inp
comma
id|no
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old-&gt;owner
)paren
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|old-&gt;owner
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;ioctl 0x%08x=%s&squot;0x%x&squot;%d(%d) data %8lx&bslash;n&quot;
comma
id|no
comma
id|_IOC_DIR
(paren
id|no
)paren
op_eq
id|_IOC_NONE
ques
c_cond
l_string|&quot;0&quot;
suffix:colon
id|_IOC_DIR
(paren
id|no
)paren
op_eq
id|_IOC_READ
ques
c_cond
l_string|&quot;r&quot;
suffix:colon
id|_IOC_DIR
(paren
id|no
)paren
op_eq
id|_IOC_WRITE
ques
c_cond
l_string|&quot;w&quot;
suffix:colon
id|_IOC_DIR
(paren
id|no
)paren
op_eq
(paren
id|_IOC_READ
op_or
id|_IOC_WRITE
)paren
ques
c_cond
l_string|&quot;rw&quot;
suffix:colon
l_string|&quot;u&quot;
comma
id|_IOC_TYPE
(paren
id|no
)paren
comma
id|_IOC_NR
(paren
id|no
)paren
comma
id|_IOC_SIZE
(paren
id|no
)paren
comma
id|data
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOTTY
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* SECTION: The members of the struct file_operations */
r_static
r_int
DECL|function|dasd_ioctl
id|dasd_ioctl
(paren
r_struct
id|inode
op_star
id|inp
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|no
comma
r_int
r_int
id|data
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|inp
)paren
op_logical_or
op_logical_neg
(paren
id|inp-&gt;i_rdev
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|rc
op_assign
id|do_dasd_ioctl
(paren
id|inp
comma
id|no
comma
id|data
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_open
id|dasd_open
(paren
r_struct
id|inode
op_star
id|inp
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dasd_device_t
op_star
id|device
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|inp
)paren
op_logical_or
op_logical_neg
(paren
id|inp-&gt;i_rdev
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dasd_probeonly
)paren
(brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;No access to device (%d:%d) due to probeonly mode&bslash;n&quot;
comma
id|MAJOR
(paren
id|inp-&gt;i_rdev
)paren
comma
id|MINOR
(paren
id|inp-&gt;i_rdev
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|discipline_lock
comma
id|flags
)paren
suffix:semicolon
id|device
op_assign
id|dasd_device_from_kdev
(paren
id|inp-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No device registered as (%d:%d)&bslash;n&quot;
comma
id|MAJOR
(paren
id|inp-&gt;i_rdev
)paren
comma
id|MINOR
(paren
id|inp-&gt;i_rdev
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;level
op_le
id|DASD_STATE_ACCEPT
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot; %s&quot;
comma
l_string|&quot; Cannot open unrecognized device&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_inc_return
(paren
op_amp
id|device-&gt;open_count
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;owner
)paren
id|__MOD_INC_USE_COUNT
c_func
(paren
id|device-&gt;discipline-&gt;owner
)paren
suffix:semicolon
)brace
id|unlock
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|discipline_lock
comma
id|flags
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * DASD_RELEASE&n; *&n; * DESCRIPTION&n; */
r_static
r_int
DECL|function|dasd_release
id|dasd_release
(paren
r_struct
id|inode
op_star
id|inp
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|count
suffix:semicolon
id|dasd_device_t
op_star
id|device
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|inp
)paren
op_logical_or
op_logical_neg
(paren
id|inp-&gt;i_rdev
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|device
op_assign
id|dasd_device_from_kdev
(paren
id|inp-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No device registered as %d:%d&bslash;n&quot;
comma
id|MAJOR
(paren
id|inp-&gt;i_rdev
)paren
comma
id|MINOR
(paren
id|inp-&gt;i_rdev
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;level
OL
id|DASD_STATE_ACCEPT
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot; %s&quot;
comma
l_string|&quot; Cannot release unrecognized device&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|count
op_assign
id|atomic_dec_return
(paren
op_amp
id|device-&gt;open_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|invalidate_bdev
(paren
id|inp-&gt;i_bdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;owner
)paren
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|device-&gt;discipline-&gt;owner
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|count
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* paranoia only */
id|atomic_set
(paren
op_amp
id|device-&gt;open_count
comma
l_int|0
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;release called with open count==0&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_struct
DECL|variable|dasd_device_operations
id|block_device_operations
id|dasd_device_operations
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|dasd_open
comma
id|release
suffix:colon
id|dasd_release
comma
id|ioctl
suffix:colon
id|dasd_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/* SECTION: Management of device list */
r_int
DECL|function|dasd_fillgeo
id|dasd_fillgeo
c_func
(paren
id|kdev_t
id|kdev
comma
r_struct
id|hd_geometry
op_star
id|geo
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|dasd_device_from_kdev
(paren
id|kdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device-&gt;discipline-&gt;fill_geometry
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|device-&gt;discipline-&gt;fill_geometry
(paren
id|device
comma
id|geo
)paren
suffix:semicolon
id|geo-&gt;start
op_assign
id|get_start_sect
c_func
(paren
id|kdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This one is needed for naming 18000+ possible dasd devices */
r_int
DECL|function|dasd_device_name
id|dasd_device_name
(paren
r_char
op_star
id|str
comma
r_int
id|index
comma
r_int
id|partition
comma
r_struct
id|gendisk
op_star
id|hd
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_char
id|first
comma
id|second
comma
id|third
suffix:semicolon
r_if
c_cond
(paren
id|hd
)paren
(brace
id|major_info_t
op_star
id|major_info
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|major_info
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_amp
id|major_info-&gt;gendisk
op_eq
id|hd
)paren
(brace
r_break
suffix:semicolon
)brace
id|index
op_add_assign
id|DASD_PER_MAJOR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|major_info
op_eq
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|third
op_assign
id|index
op_mod
l_int|26
suffix:semicolon
id|second
op_assign
(paren
(paren
id|index
op_minus
l_int|26
)paren
op_div
l_int|26
)paren
op_mod
l_int|26
suffix:semicolon
id|first
op_assign
(paren
(paren
(paren
id|index
op_minus
l_int|702
)paren
op_div
l_int|26
)paren
op_div
l_int|26
)paren
op_mod
l_int|26
suffix:semicolon
id|len
op_assign
id|sprintf
(paren
id|str
comma
l_string|&quot;dasd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
OG
l_int|701
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|str
op_plus
id|len
comma
l_string|&quot;%c&quot;
comma
id|first
op_plus
l_char|&squot;a&squot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|index
OG
l_int|25
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|str
op_plus
id|len
comma
l_string|&quot;%c&quot;
comma
id|second
op_plus
l_char|&squot;a&squot;
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|str
op_plus
id|len
comma
l_string|&quot;%c&quot;
comma
id|third
op_plus
l_char|&squot;a&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|partition
)paren
(brace
r_if
c_cond
(paren
id|partition
OG
l_int|9
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
(paren
id|str
op_plus
id|len
comma
l_string|&quot;%d&quot;
comma
id|partition
)paren
suffix:semicolon
)brace
)brace
id|str
(braket
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|dasd_plug_device
id|dasd_plug_device
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|device-&gt;plugged
comma
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dasd_unplug_device
id|dasd_unplug_device
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|device-&gt;plugged
comma
l_int|0
)paren
suffix:semicolon
id|dasd_schedule_bh
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dasd_flush_chanq
id|dasd_flush_chanq
(paren
id|dasd_device_t
op_star
id|device
comma
r_int
id|destroy
)paren
(brace
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|destroy
)paren
(brace
id|s390irq_spin_lock_irqsave
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
id|cqr
op_assign
id|device-&gt;queue.head
suffix:semicolon
r_while
c_loop
(paren
id|cqr
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|cqr-&gt;status
op_eq
id|CQR_STATUS_IN_IO
)paren
id|device-&gt;discipline-&gt;term_IO
(paren
id|cqr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;status
op_ne
id|CQR_STATUS_DONE
op_logical_or
id|cqr-&gt;status
op_ne
id|CQR_STATUS_FAILED
)paren
(brace
id|cqr-&gt;status
op_assign
id|CQR_STATUS_FAILED
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|cqr-&gt;stopclk
)paren
)paren
suffix:semicolon
)brace
id|dasd_schedule_bh
c_func
(paren
id|device
)paren
suffix:semicolon
id|cqr
op_assign
id|cqr-&gt;next
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
)brace
id|wait_event
c_func
(paren
id|device-&gt;wait_q
comma
id|device-&gt;queue.head
op_eq
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dasd_flush_request_queues
id|dasd_flush_request_queues
(paren
id|dasd_device_t
op_star
id|device
comma
r_int
id|destroy
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|major
op_assign
id|MAJOR
c_func
(paren
id|device-&gt;kdev
)paren
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|1
op_lshift
id|DASD_PARTN_BITS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|destroy
)paren
id|destroy_buffers
c_func
(paren
id|MKDEV
c_func
(paren
id|major
comma
id|minor
op_plus
id|i
)paren
)paren
suffix:semicolon
r_else
id|invalidate_buffers
c_func
(paren
id|MKDEV
c_func
(paren
id|major
comma
id|minor
op_plus
id|i
)paren
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|dasd_disable_volume
id|dasd_disable_volume
(paren
id|dasd_device_t
op_star
id|device
comma
r_int
id|force
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|target
op_assign
id|DASD_STATE_KNOWN
suffix:semicolon
r_int
id|count
op_assign
id|atomic_read
(paren
op_amp
id|device-&gt;open_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_EMERG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;device has vanished although it was open!&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|force
)paren
(brace
id|dasd_deactivate_queue
c_func
(paren
id|device
)paren
suffix:semicolon
id|dasd_flush_chanq
c_func
(paren
id|device
comma
id|force
)paren
suffix:semicolon
id|dasd_flush_request_queues
c_func
(paren
id|device
comma
id|force
)paren
suffix:semicolon
id|dasd_disable_blkdev
c_func
(paren
id|device
)paren
suffix:semicolon
id|target
op_assign
id|DASD_STATE_DEL
suffix:semicolon
)brace
multiline_comment|/* unregister partitions (&squot;ungrok_partitions&squot;) */
id|devfs_register_partitions
c_func
(paren
op_amp
id|device-&gt;major_info-&gt;gendisk
comma
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
comma
l_int|1
)paren
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;disabling device, target state: %d&quot;
comma
id|target
)paren
suffix:semicolon
id|dasd_set_device_level
(paren
id|device-&gt;devinfo.devno
comma
id|device-&gt;discipline
comma
id|target
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|dasd_disable_ranges
id|dasd_disable_ranges
(paren
id|dasd_range_t
op_star
id|range
comma
id|dasd_discipline_t
op_star
id|d
comma
r_int
id|all
comma
r_int
id|force
)paren
(brace
id|dasd_range_t
op_star
id|rrange
suffix:semicolon
r_int
id|j
suffix:semicolon
r_if
c_cond
(paren
id|range
op_eq
op_amp
id|dasd_range_head
)paren
(brace
id|rrange
op_assign
id|list_entry
(paren
id|range-&gt;list.next
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
)brace
r_else
(brace
id|rrange
op_assign
id|range
suffix:semicolon
)brace
r_do
(brace
r_for
c_loop
(paren
id|j
op_assign
id|rrange-&gt;from
suffix:semicolon
id|j
op_le
id|rrange-&gt;to
suffix:semicolon
id|j
op_increment
)paren
(brace
id|dasd_device_t
op_star
op_star
id|dptr
suffix:semicolon
id|dasd_device_t
op_star
id|device
suffix:semicolon
id|dptr
op_assign
id|dasd_device_from_devno
c_func
(paren
id|j
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dptr
op_eq
l_int|NULL
)paren
(brace
r_continue
suffix:semicolon
)brace
id|device
op_assign
op_star
id|dptr
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
op_logical_or
(paren
id|d
op_ne
l_int|NULL
op_logical_and
id|device
op_member_access_from_pointer
id|discipline
op_ne
id|d
)paren
)paren
r_continue
suffix:semicolon
id|dasd_disable_volume
c_func
(paren
id|device
comma
id|force
)paren
suffix:semicolon
)brace
id|rrange
op_assign
id|list_entry
(paren
id|rrange-&gt;list.next
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|all
op_logical_and
id|rrange
op_logical_and
id|rrange
op_ne
id|range
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dasd_enable_single_device
id|dasd_enable_single_device
(paren
r_int
r_int
id|arg
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
(paren
id|dasd_device_t
op_star
)paren
id|arg
suffix:semicolon
r_int
id|devno
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
id|dasd_range_t
id|range
op_assign
(brace
id|from
suffix:colon
id|devno
comma
id|to
suffix:colon
id|devno
)brace
suffix:semicolon
id|dasd_enable_ranges
(paren
op_amp
id|range
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|dasd_enable_ranges
id|dasd_enable_ranges
(paren
id|dasd_range_t
op_star
id|range
comma
id|dasd_discipline_t
op_star
id|d
comma
r_int
id|all
)paren
(brace
r_int
id|retries
op_assign
l_int|0
suffix:semicolon
r_int
id|j
suffix:semicolon
id|kdev_t
id|tempdev
suffix:semicolon
id|dasd_range_t
op_star
id|rrange
suffix:semicolon
r_if
c_cond
(paren
id|range
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|range
op_eq
op_amp
id|dasd_range_head
)paren
(brace
id|rrange
op_assign
id|list_entry
(paren
id|range-&gt;list.next
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
)brace
r_else
(brace
id|rrange
op_assign
id|range
suffix:semicolon
)brace
r_do
(brace
r_for
c_loop
(paren
id|j
op_assign
id|rrange-&gt;from
suffix:semicolon
id|j
op_le
id|rrange-&gt;to
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|dasd_devindex_from_devno
c_func
(paren
id|j
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
id|dasd_set_device_level
(paren
id|j
comma
id|d
comma
id|DASD_STATE_ONLINE
)paren
suffix:semicolon
)brace
id|rrange
op_assign
id|list_entry
(paren
id|rrange-&gt;list.next
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|all
op_logical_and
id|rrange
op_logical_and
id|rrange
op_ne
id|range
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
(paren
op_amp
id|dasd_init_pending
)paren
op_eq
l_int|0
)paren
multiline_comment|/* we are done, exit loop */
r_break
suffix:semicolon
r_if
c_cond
(paren
id|retries
op_eq
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;waiting for responses...&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|retries
OL
l_int|5
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;waiting a little bit longer...&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;giving up, enable late devices manually!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|interruptible_sleep_on_timeout
(paren
op_amp
id|dasd_init_waitq
comma
(paren
l_int|1
op_star
id|HZ
)paren
)paren
suffix:semicolon
id|retries
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* now setup block devices */
multiline_comment|/* Now do block device and partition setup */
r_if
c_cond
(paren
id|range
op_eq
op_amp
id|dasd_range_head
)paren
(brace
id|rrange
op_assign
id|list_entry
(paren
id|range-&gt;list.next
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
)brace
r_else
(brace
id|rrange
op_assign
id|range
suffix:semicolon
)brace
r_do
(brace
r_for
c_loop
(paren
id|j
op_assign
id|rrange-&gt;from
suffix:semicolon
id|j
op_le
id|rrange-&gt;to
suffix:semicolon
id|j
op_increment
)paren
(brace
id|dasd_device_t
op_star
op_star
id|dptr
suffix:semicolon
id|dasd_device_t
op_star
id|device
suffix:semicolon
r_if
c_cond
(paren
id|dasd_devindex_from_devno
c_func
(paren
id|j
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
id|dptr
op_assign
id|dasd_device_from_devno
c_func
(paren
id|j
)paren
suffix:semicolon
id|device
op_assign
op_star
id|dptr
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|d
op_eq
l_int|NULL
op_logical_and
id|device-&gt;discipline
op_ne
l_int|NULL
)paren
op_logical_or
(paren
id|device-&gt;discipline
op_eq
id|d
)paren
)paren
op_logical_and
id|device-&gt;level
op_ge
id|DASD_STATE_READY
op_logical_and
id|device-&gt;request_queue
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|dasd_features_from_devno
c_func
(paren
id|j
)paren
op_amp
id|DASD_FEATURE_READONLY
)paren
(brace
r_for
c_loop
(paren
id|tempdev
op_assign
id|device-&gt;kdev
suffix:semicolon
id|tempdev
OL
(paren
id|device-&gt;kdev
op_plus
(paren
l_int|1
op_lshift
id|DASD_PARTN_BITS
)paren
)paren
suffix:semicolon
id|tempdev
op_increment
)paren
id|set_device_ro
(paren
id|tempdev
comma
l_int|1
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;setting read-only mode for device /dev/%s&bslash;n&quot;
comma
id|device-&gt;name
)paren
suffix:semicolon
)brace
id|dasd_setup_blkdev
c_func
(paren
id|device
)paren
suffix:semicolon
id|dasd_setup_partitions
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
)brace
id|rrange
op_assign
id|list_entry
(paren
id|rrange-&gt;list.next
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|all
op_logical_and
id|rrange
op_logical_and
id|rrange
op_ne
id|range
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_DASD_DYNAMIC
multiline_comment|/*&n; * DASD_NOT_OPER_HANDLER&n; *&n; * DESCRIPTION&n; *   handles leaving devices&n; */
r_static
r_void
DECL|function|dasd_not_oper_handler
id|dasd_not_oper_handler
(paren
r_int
id|irq
comma
r_int
id|status
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
id|major_info_t
op_star
id|major_info
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
id|i
comma
id|devno
op_assign
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* find out devno of leaving device: CIO has already deleted this information ! */
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|major_info
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DASD_PER_MAJOR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|device
op_assign
id|major_info-&gt;dasd_device
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|device
op_logical_and
id|device-&gt;devinfo.irq
op_eq
id|irq
)paren
(brace
id|devno
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|devno
op_ne
op_minus
id|ENODEV
)paren
r_break
suffix:semicolon
)brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|5
comma
id|dasd_not_oper_handler
comma
l_string|&quot;called for devno %04x&quot;
comma
id|devno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devno
OL
l_int|0
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;not_oper_handler called on irq 0x%04x no devno!&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dasd_disable_volume
c_func
(paren
id|device
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * DASD_OPER_HANDLER&n; *&n; * DESCRIPTION&n; *   called by the machine check handler to make an device operational&n; */
r_int
DECL|function|dasd_oper_handler
id|dasd_oper_handler
(paren
r_int
id|irq
comma
id|devreg_t
op_star
id|devreg
)paren
(brace
r_int
id|devno
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|major_info_t
op_star
id|major_info
op_assign
l_int|NULL
suffix:semicolon
id|dasd_range_t
op_star
id|rptr
comma
id|range
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
id|i
suffix:semicolon
id|devno
op_assign
id|get_devno_by_irq
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devno
op_eq
op_minus
id|ENODEV
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|5
comma
id|dasd_oper_handler
comma
l_string|&quot;called for devno %04x&quot;
comma
id|devno
)paren
suffix:semicolon
multiline_comment|/* find out devno of device */
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|major_info
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DASD_PER_MAJOR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|device
op_assign
id|major_info-&gt;dasd_device
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|device
op_logical_and
id|device-&gt;devinfo.irq
op_eq
id|irq
)paren
(brace
id|devno
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|devno
op_ne
op_minus
id|ENODEV
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devno
OL
l_int|0
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device
op_logical_and
id|device-&gt;level
op_eq
id|DASD_STATE_READY
)paren
(brace
id|dasd_set_device_level
(paren
id|device-&gt;devinfo.devno
comma
id|device-&gt;discipline
comma
id|DASD_STATE_ONLINE
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dasd_autodetect
)paren
(brace
id|rptr
op_assign
id|dasd_add_range
(paren
id|devno
comma
id|devno
comma
id|DASD_DEFAULT_FEATURES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rptr
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
(brace
id|range.from
op_assign
id|devno
suffix:semicolon
id|range.to
op_assign
id|devno
suffix:semicolon
id|rptr
op_assign
op_amp
id|range
suffix:semicolon
)brace
id|dasd_enable_ranges
(paren
id|rptr
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_DASD_DYNAMIC */
r_static
r_inline
id|dasd_device_t
op_star
op_star
DECL|function|dasd_find_device_addr
id|dasd_find_device_addr
(paren
r_int
id|devno
)paren
(brace
id|dasd_device_t
op_star
op_star
id|device_addr
suffix:semicolon
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_find_device_addr
comma
l_string|&quot;devno %04x&quot;
comma
id|devno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd_devindex_from_devno
(paren
id|devno
)paren
OL
l_int|0
)paren
(brace
id|DASD_DRIVER_DEBUG_EXCEPTION
(paren
l_int|1
comma
id|dasd_find_device_addr
comma
l_string|&quot;no dasd: devno %04x&quot;
comma
id|devno
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* allocate major numbers on demand  for new devices */
r_while
c_loop
(paren
(paren
id|device_addr
op_assign
id|dasd_device_from_devno
(paren
id|devno
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dasd_register_major
(paren
l_int|NULL
)paren
)paren
op_le
l_int|0
)paren
(brace
id|DASD_DRIVER_DEBUG_EXCEPTION
(paren
l_int|1
comma
id|dasd_find_device_addr
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;out of major numbers!&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|device_addr
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_del_to_new
id|dasd_state_del_to_new
(paren
id|dasd_device_t
op_star
op_star
id|addr
)paren
(brace
id|dasd_device_t
op_star
id|device
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|addr
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* allocate device descriptor on demand for new device */
id|device
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|dasd_device_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
(paren
id|device
comma
l_int|0
comma
r_sizeof
(paren
id|dasd_device_t
)paren
)paren
suffix:semicolon
op_star
id|addr
op_assign
id|device
suffix:semicolon
id|device-&gt;lowmem_ccws
op_assign
(paren
r_void
op_star
)paren
id|get_free_page
(paren
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;lowmem_ccws
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|noccw
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ARCH_S390X
id|device-&gt;lowmem_idals
op_assign
id|device-&gt;lowmem_idal_ptr
op_assign
(paren
r_void
op_star
)paren
id|get_free_page
(paren
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;lowmem_idals
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|noidal
suffix:semicolon
)brace
macro_line|#endif
)brace
r_goto
id|out
suffix:semicolon
macro_line|#ifdef CONFIG_ARCH_S390X
id|noidal
suffix:colon
id|free_page
(paren
(paren
r_int
)paren
id|device-&gt;lowmem_ccws
)paren
suffix:semicolon
macro_line|#endif
id|noccw
suffix:colon
id|kfree
c_func
(paren
id|device
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_new_to_del
id|dasd_state_new_to_del
(paren
id|dasd_device_t
op_star
op_star
id|addr
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
op_star
id|addr
suffix:semicolon
r_if
c_cond
(paren
id|device
op_logical_and
id|device
op_member_access_from_pointer
r_private
)paren
(brace
id|kfree
c_func
(paren
id|device
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|device
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ARCH_S390X
id|free_page
(paren
(paren
r_int
)paren
(paren
id|device-&gt;lowmem_idals
)paren
)paren
suffix:semicolon
macro_line|#endif
id|free_page
c_func
(paren
(paren
r_int
)paren
(paren
id|device-&gt;lowmem_ccws
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|device
)paren
suffix:semicolon
op_star
id|addr
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_new_to_known
id|dasd_state_new_to_known
(paren
id|dasd_device_t
op_star
op_star
id|dptr
comma
r_int
id|devno
comma
id|dasd_discipline_t
op_star
id|disc
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|umode_t
id|devfs_perm
op_assign
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|major_info_t
op_star
id|major_info
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
op_star
id|dptr
suffix:semicolon
id|devfs_handle_t
id|dir
suffix:semicolon
r_char
id|buffer
(braket
l_int|5
)braket
suffix:semicolon
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|major_info
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DASD_PER_MAJOR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|major_info-&gt;dasd_device
(braket
id|i
)braket
op_eq
id|device
)paren
(brace
id|device-&gt;kdev
op_assign
id|MKDEV
(paren
id|major_info-&gt;gendisk.major
comma
id|i
op_lshift
id|DASD_PARTN_BITS
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
OL
id|DASD_PER_MAJOR
)paren
multiline_comment|/* we found one */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|major_info
op_eq
l_int|NULL
op_logical_or
id|major_info
op_eq
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|device-&gt;major_info
op_assign
id|major_info
suffix:semicolon
id|dasd_device_name
(paren
id|device-&gt;name
comma
(paren
(paren
(paren
r_int
)paren
id|dptr
op_minus
(paren
r_int
)paren
id|device-&gt;major_info-&gt;dasd_device
)paren
op_div
r_sizeof
(paren
id|dasd_device_t
op_star
)paren
)paren
comma
l_int|0
comma
op_amp
id|device-&gt;major_info-&gt;gendisk
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|device-&gt;wait_q
)paren
suffix:semicolon
id|rc
op_assign
id|get_dev_info_by_devno
(paren
id|devno
comma
op_amp
id|device-&gt;devinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|5
comma
id|dasd_state_new_to_known
comma
l_string|&quot;got devinfo CU-type %04x and dev-type %04x&quot;
comma
id|device-&gt;devinfo.sid_data.cu_type
comma
id|device-&gt;devinfo.sid_data.dev_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devno
op_ne
id|device-&gt;devinfo.devno
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|device-&gt;discipline
op_assign
id|dasd_find_disc
(paren
id|device
comma
id|disc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;discipline
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sprintf
(paren
id|buffer
comma
l_string|&quot;%04x&quot;
comma
id|device-&gt;devinfo.devno
)paren
suffix:semicolon
id|dir
op_assign
id|devfs_mk_dir
(paren
id|dasd_devfs_handle
comma
id|buffer
comma
id|device
)paren
suffix:semicolon
id|device-&gt;major_info-&gt;gendisk.de_arr
(braket
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
op_rshift
id|DASD_PARTN_BITS
)braket
op_assign
id|dir
suffix:semicolon
r_if
c_cond
(paren
id|dasd_features_from_devno
c_func
(paren
id|device-&gt;devinfo.devno
)paren
op_amp
id|DASD_FEATURE_READONLY
)paren
(brace
id|devfs_perm
op_and_assign
op_complement
(paren
id|S_IWUSR
)paren
suffix:semicolon
)brace
id|device-&gt;devfs_entry
op_assign
id|devfs_register
(paren
id|dir
comma
l_string|&quot;device&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR
c_func
(paren
id|device-&gt;kdev
)paren
comma
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
comma
id|devfs_perm
comma
op_amp
id|dasd_device_operations
comma
l_int|NULL
)paren
suffix:semicolon
id|device-&gt;level
op_assign
id|DASD_STATE_KNOWN
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_known_to_new
id|dasd_state_known_to_new
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t reset to zeros because of persistent data durich detach/attach! */
id|devfs_unregister
c_func
(paren
id|device-&gt;devfs_entry
)paren
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|device-&gt;major_info-&gt;gendisk.de_arr
(braket
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
op_rshift
id|DASD_PARTN_BITS
)braket
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_known_to_accept
id|dasd_state_known_to_accept
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|device-&gt;debug_area
op_assign
id|debug_register
(paren
id|device-&gt;name
comma
l_int|0
comma
l_int|2
comma
l_int|3
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_register_view
(paren
id|device-&gt;debug_area
comma
op_amp
id|debug_sprintf_view
)paren
suffix:semicolon
id|debug_register_view
(paren
id|device-&gt;debug_area
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|DASD_DEVICE_DEBUG_EVENT
(paren
l_int|0
comma
id|device
comma
l_string|&quot;%p debug area created&quot;
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;int_handler
)paren
(brace
id|rc
op_assign
id|s390_request_irq_special
(paren
id|device-&gt;devinfo.irq
comma
id|device-&gt;discipline-&gt;int_handler
comma
id|dasd_not_oper_handler
comma
l_int|0
comma
id|DASD_NAME
comma
op_amp
id|device-&gt;dev_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No request IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|device-&gt;level
op_assign
id|DASD_STATE_ACCEPT
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_accept_to_known
id|dasd_state_accept_to_known
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;discipline
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;int_handler
)paren
(brace
id|free_irq
(paren
id|device-&gt;devinfo.irq
comma
op_amp
id|device-&gt;dev_status
)paren
suffix:semicolon
)brace
id|DASD_DEVICE_DEBUG_EVENT
(paren
l_int|0
comma
id|device
comma
l_string|&quot;%p debug area deleted&quot;
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;debug_area
op_ne
l_int|NULL
)paren
id|debug_unregister
(paren
id|device-&gt;debug_area
)paren
suffix:semicolon
id|device-&gt;discipline
op_assign
l_int|NULL
suffix:semicolon
id|device-&gt;level
op_assign
id|DASD_STATE_KNOWN
suffix:semicolon
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_accept_to_init
id|dasd_state_accept_to_init
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;init_analysis
)paren
(brace
id|device-&gt;init_cqr
op_assign
id|device-&gt;discipline-&gt;init_analysis
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;init_cqr
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;start_IO
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|atomic_inc
(paren
op_amp
id|dasd_init_pending
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|device-&gt;discipline-&gt;start_IO
(paren
id|device-&gt;init_cqr
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
id|device-&gt;level
op_assign
id|DASD_STATE_INIT
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
r_else
(brace
id|rc
op_assign
id|dasd_state_init_to_ready
(paren
id|device
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_init_to_ready
id|dasd_state_init_to_ready
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;do_analysis
op_ne
l_int|NULL
)paren
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;do_analysis
(paren
id|device
)paren
op_eq
l_int|0
)paren
r_switch
c_cond
(paren
id|device-&gt;sizes.bp_block
)paren
(brace
r_case
l_int|512
suffix:colon
r_case
l_int|1024
suffix:colon
r_case
l_int|2048
suffix:colon
r_case
l_int|4096
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|EMEDIUMTYPE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;init_cqr
)paren
(brace
multiline_comment|/* This pointer is no longer needed, BUT dont&squot;t free the       */
multiline_comment|/* memory, because this is done in bh for finished request!!!! */
id|atomic_dec
c_func
(paren
op_amp
id|dasd_init_pending
)paren
suffix:semicolon
id|device-&gt;init_cqr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|device-&gt;level
op_assign
id|DASD_STATE_READY
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_ready_to_accept
id|dasd_state_ready_to_accept
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;init_cqr
op_ne
l_int|NULL
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|dasd_init_pending
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;discipline-&gt;term_IO
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|device-&gt;discipline-&gt;term_IO
(paren
id|device-&gt;init_cqr
)paren
suffix:semicolon
id|atomic_dec
(paren
op_amp
id|dasd_init_pending
)paren
suffix:semicolon
id|dasd_free_request
(paren
id|device-&gt;init_cqr
comma
id|device
)paren
suffix:semicolon
id|device-&gt;init_cqr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|device-&gt;sizes
comma
l_int|0
comma
r_sizeof
(paren
id|dasd_sizes_t
)paren
)paren
suffix:semicolon
id|device-&gt;level
op_assign
id|DASD_STATE_ACCEPT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_ready_to_online
id|dasd_state_ready_to_online
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_unplug_device
(paren
id|device
)paren
suffix:semicolon
id|device-&gt;level
op_assign
id|DASD_STATE_ONLINE
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_state_online_to_ready
id|dasd_state_online_to_ready
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_plug_device
(paren
id|device
)paren
suffix:semicolon
id|device-&gt;level
op_assign
id|DASD_STATE_READY
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_setup_blkdev
id|dasd_setup_blkdev
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|major
op_assign
id|MAJOR
c_func
(paren
id|device-&gt;kdev
)paren
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
suffix:semicolon
id|device-&gt;request_queue
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|request_queue_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|device-&gt;request_queue-&gt;queuedata
op_assign
id|device
suffix:semicolon
id|blk_init_queue
(paren
id|device-&gt;request_queue
comma
id|do_dasd_request
)paren
suffix:semicolon
id|blk_queue_hardsect_size
c_func
(paren
id|device-&gt;request_queue
comma
id|device-&gt;sizes.bp_block
)paren
suffix:semicolon
id|elevator_init
(paren
op_amp
(paren
id|device-&gt;request_queue-&gt;elevator
)paren
comma
id|ELEVATOR_NOOP
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|1
op_lshift
id|DASD_PARTN_BITS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
id|device-&gt;major_info-&gt;gendisk.sizes
(braket
id|minor
)braket
op_assign
(paren
id|device-&gt;sizes.blocks
op_lshift
id|device
op_member_access_from_pointer
id|sizes.s2b_shift
)paren
op_rshift
l_int|1
suffix:semicolon
r_else
id|device-&gt;major_info-&gt;gendisk.sizes
(braket
id|minor
op_plus
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|blksize_size
(braket
id|major
)braket
(braket
id|minor
op_plus
id|i
)braket
op_assign
id|device-&gt;sizes.bp_block
suffix:semicolon
id|blk_queue_max_sectors
c_func
(paren
id|device-&gt;request_queue
comma
id|device-&gt;discipline-&gt;max_blocks
op_lshift
id|device-&gt;sizes.s2b_shift
)paren
suffix:semicolon
id|device-&gt;major_info-&gt;gendisk.part
(braket
id|minor
op_plus
id|i
)braket
dot
id|start_sect
op_assign
l_int|0
suffix:semicolon
id|device-&gt;major_info-&gt;gendisk.part
(braket
id|minor
op_plus
id|i
)braket
dot
id|nr_sects
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|dasd_deactivate_queue
id|dasd_deactivate_queue
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|1
op_lshift
id|DASD_PARTN_BITS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|device-&gt;major_info-&gt;gendisk.sizes
(braket
id|minor
op_plus
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
r_inline
r_int
DECL|function|dasd_disable_blkdev
id|dasd_disable_blkdev
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|major
op_assign
id|MAJOR
c_func
(paren
id|device-&gt;kdev
)paren
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|1
op_lshift
id|DASD_PARTN_BITS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|destroy_buffers
c_func
(paren
id|MKDEV
c_func
(paren
id|major
comma
id|minor
op_plus
id|i
)paren
)paren
suffix:semicolon
id|device-&gt;major_info-&gt;gendisk.sizes
(braket
id|minor
op_plus
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|blksize_size
(braket
id|major
)braket
(braket
id|minor
op_plus
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;request_queue
)paren
(brace
id|blk_cleanup_queue
(paren
id|device-&gt;request_queue
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|device-&gt;request_queue
)paren
suffix:semicolon
id|device-&gt;request_queue
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_setup_partitions&n; * calls the function in genhd, which is appropriate to setup a partitioned disk&n; */
r_static
r_inline
r_void
DECL|function|dasd_setup_partitions
id|dasd_setup_partitions
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
id|register_disk
(paren
op_amp
id|device-&gt;major_info-&gt;gendisk
comma
id|device-&gt;kdev
comma
l_int|1
op_lshift
id|DASD_PARTN_BITS
comma
op_amp
id|dasd_device_operations
comma
(paren
id|device-&gt;sizes.blocks
op_lshift
id|device-&gt;sizes.s2b_shift
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|dasd_destroy_partitions
id|dasd_destroy_partitions
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
l_int|1
op_lshift
id|DASD_PARTN_BITS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|device-&gt;major_info-&gt;gendisk.part
(braket
id|minor
op_plus
id|i
)braket
dot
id|start_sect
op_assign
l_int|0
suffix:semicolon
id|device-&gt;major_info-&gt;gendisk.part
(braket
id|minor
op_plus
id|i
)braket
dot
id|nr_sects
op_assign
l_int|0
suffix:semicolon
)brace
id|devfs_register_partitions
c_func
(paren
op_amp
id|device-&gt;major_info-&gt;gendisk
comma
id|MINOR
c_func
(paren
id|device-&gt;kdev
)paren
comma
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|dasd_resetup_partitions
id|dasd_resetup_partitions
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|dasd_destroy_partitions
(paren
id|device
)paren
suffix:semicolon
id|dasd_setup_partitions
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function dasd_set_device_level&n; */
r_static
r_int
DECL|function|dasd_set_device_level
id|dasd_set_device_level
(paren
r_int
r_int
id|devno
comma
id|dasd_discipline_t
op_star
id|discipline
comma
r_int
id|to_state
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_device_t
op_star
op_star
id|device_addr
suffix:semicolon
id|dasd_device_t
op_star
id|device
suffix:semicolon
r_int
id|from_state
suffix:semicolon
id|device_addr
op_assign
id|dasd_find_device_addr
(paren
id|devno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_addr
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|device
op_assign
op_star
id|device_addr
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
(brace
id|from_state
op_assign
id|DASD_STATE_DEL
suffix:semicolon
r_if
c_cond
(paren
id|to_state
op_eq
id|DASD_STATE_DEL
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
id|from_state
op_assign
id|device-&gt;level
suffix:semicolon
)brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|3
comma
id|dasd_set_device_level
comma
l_string|&quot;devno %04x; from %i to %i&quot;
comma
id|devno
comma
id|from_state
comma
id|to_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_state
op_eq
id|to_state
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|to_state
OL
id|from_state
)paren
r_goto
id|shutdown
suffix:semicolon
multiline_comment|/* First check for bringup */
r_if
c_cond
(paren
id|from_state
op_le
id|DASD_STATE_DEL
op_logical_and
id|to_state
op_ge
id|DASD_STATE_NEW
)paren
(brace
id|rc
op_assign
id|dasd_state_del_to_new
c_func
(paren
id|device_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_goto
id|bringup_fail
suffix:semicolon
)brace
id|device
op_assign
op_star
id|device_addr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from_state
op_le
id|DASD_STATE_NEW
op_logical_and
id|to_state
op_ge
id|DASD_STATE_KNOWN
)paren
(brace
id|rc
op_assign
id|dasd_state_new_to_known
c_func
(paren
id|device_addr
comma
id|devno
comma
id|discipline
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_goto
id|bringup_fail
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|from_state
op_le
id|DASD_STATE_KNOWN
op_logical_and
id|to_state
op_ge
id|DASD_STATE_ACCEPT
)paren
(brace
id|rc
op_assign
id|dasd_state_known_to_accept
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_goto
id|bringup_fail
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dasd_probeonly
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from_state
op_le
id|DASD_STATE_ACCEPT
op_logical_and
id|to_state
op_ge
id|DASD_STATE_INIT
)paren
(brace
id|rc
op_assign
id|dasd_state_accept_to_init
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_goto
id|bringup_fail
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|from_state
op_le
id|DASD_STATE_INIT
op_logical_and
id|to_state
op_ge
id|DASD_STATE_READY
)paren
(brace
id|rc
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|from_state
op_le
id|DASD_STATE_READY
op_logical_and
id|to_state
op_ge
id|DASD_STATE_ONLINE
)paren
(brace
id|rc
op_assign
id|dasd_state_ready_to_online
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_goto
id|bringup_fail
suffix:semicolon
)brace
)brace
r_goto
id|out
suffix:semicolon
id|bringup_fail
suffix:colon
multiline_comment|/* revert changes */
macro_line|#if 0
id|printk
(paren
id|KERN_DEBUG
id|PRINTK_HEADER
l_string|&quot;failed to set device from state %d to %d at &quot;
l_string|&quot;level %d rc %d. Reverting...&bslash;n&quot;
comma
id|from_state
comma
id|to_state
comma
id|device-&gt;level
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
id|to_state
op_assign
id|from_state
suffix:semicolon
id|from_state
op_assign
id|device-&gt;level
suffix:semicolon
multiline_comment|/* now do a shutdown */
id|shutdown
suffix:colon
r_if
c_cond
(paren
id|from_state
op_ge
id|DASD_STATE_ONLINE
op_logical_and
id|to_state
op_le
id|DASD_STATE_READY
)paren
r_if
c_cond
(paren
id|dasd_state_online_to_ready
c_func
(paren
id|device
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_state
op_ge
id|DASD_STATE_READY
op_logical_and
id|to_state
op_le
id|DASD_STATE_ACCEPT
)paren
r_if
c_cond
(paren
id|dasd_state_ready_to_accept
c_func
(paren
id|device
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_state
op_ge
id|DASD_STATE_ACCEPT
op_logical_and
id|to_state
op_le
id|DASD_STATE_KNOWN
)paren
r_if
c_cond
(paren
id|dasd_state_accept_to_known
c_func
(paren
id|device
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_state
op_ge
id|DASD_STATE_KNOWN
op_logical_and
id|to_state
op_le
id|DASD_STATE_NEW
)paren
r_if
c_cond
(paren
id|dasd_state_known_to_new
c_func
(paren
id|device
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_state
op_ge
id|DASD_STATE_NEW
op_logical_and
id|to_state
op_le
id|DASD_STATE_DEL
)paren
r_if
c_cond
(paren
id|dasd_state_new_to_del
c_func
(paren
id|device_addr
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* SECTION: Procfs stuff */
r_typedef
r_struct
(brace
DECL|member|data
r_char
op_star
id|data
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
DECL|typedef|tempinfo_t
)brace
id|tempinfo_t
suffix:semicolon
r_void
DECL|function|dasd_fill_inode
id|dasd_fill_inode
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|fill
)paren
(brace
r_if
c_cond
(paren
id|fill
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_else
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|variable|dasd_proc_root_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|dasd_proc_root_entry
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dasd_devices_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|dasd_devices_entry
suffix:semicolon
DECL|variable|dasd_statistics_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|dasd_statistics_entry
suffix:semicolon
r_static
r_int
DECL|function|dasd_devices_open
id|dasd_devices_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|size
op_assign
l_int|1
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|major_info_t
op_star
id|temp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|tempinfo_t
op_star
id|info
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|index
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|discipline_lock
comma
id|flags
)paren
suffix:semicolon
id|info
op_assign
(paren
id|tempinfo_t
op_star
)paren
id|vmalloc
(paren
r_sizeof
(paren
id|tempinfo_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;No memory available for data&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
id|info
suffix:semicolon
)brace
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|size
op_add_assign
l_int|128
op_star
l_int|1
op_lshift
(paren
id|MINORBITS
op_minus
id|DASD_PARTN_BITS
)paren
suffix:semicolon
)brace
id|info-&gt;data
op_assign
(paren
r_char
op_star
)paren
id|vmalloc
(paren
id|size
)paren
suffix:semicolon
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_devices_open
comma
l_string|&quot;area: %p, size 0x%x&quot;
comma
id|info-&gt;data
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_logical_and
id|info-&gt;data
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;No memory available for data&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
(paren
id|info
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|temp
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1
op_lshift
(paren
id|MINORBITS
op_minus
id|DASD_PARTN_BITS
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dasd_device_t
op_star
id|device
suffix:semicolon
r_int
id|devno
op_assign
id|dasd_devno_from_devindex
c_func
(paren
id|index
op_plus
id|i
)paren
suffix:semicolon
r_int
id|features
suffix:semicolon
r_if
c_cond
(paren
id|devno
op_eq
op_minus
id|ENODEV
)paren
r_continue
suffix:semicolon
id|features
op_assign
id|dasd_features_from_devno
c_func
(paren
id|devno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|features
OL
id|DASD_DEFAULT_FEATURES
)paren
id|features
op_assign
id|DASD_DEFAULT_FEATURES
suffix:semicolon
id|device
op_assign
id|temp-&gt;dasd_device
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|device
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%04x(%s) at (%3d:%3d) is %-7s%4s: &quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;discipline
ques
c_cond
id|device
op_member_access_from_pointer
id|discipline-&gt;name
suffix:colon
l_string|&quot;none&quot;
comma
id|temp-&gt;gendisk.major
comma
id|i
op_lshift
id|DASD_PARTN_BITS
comma
id|device-&gt;name
comma
(paren
id|features
op_amp
id|DASD_FEATURE_READONLY
)paren
ques
c_cond
l_string|&quot;(ro)&quot;
suffix:colon
l_string|&quot; &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|device-&gt;level
)paren
(brace
r_case
id|DASD_STATE_NEW
suffix:colon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;new&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_STATE_KNOWN
suffix:colon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;detected&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_STATE_ACCEPT
suffix:colon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;accepted&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_STATE_INIT
suffix:colon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;busy   &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_STATE_READY
suffix:colon
r_case
id|DASD_STATE_ONLINE
suffix:colon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|device-&gt;plugged
)paren
)paren
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;fenced &quot;
)paren
suffix:semicolon
r_else
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;active &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;sizes.bp_block
op_eq
l_int|512
op_logical_or
id|device-&gt;sizes.bp_block
op_eq
l_int|1024
op_logical_or
id|device-&gt;sizes.bp_block
op_eq
l_int|2048
op_logical_or
id|device-&gt;sizes.bp_block
op_eq
l_int|4096
)paren
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;at blocksize: %d, %ld blocks, %ld MB&quot;
comma
id|device-&gt;sizes.bp_block
comma
id|device-&gt;sizes.blocks
comma
(paren
(paren
id|device
op_member_access_from_pointer
id|sizes.bp_block
op_rshift
l_int|9
)paren
op_star
id|device-&gt;sizes
dot
id|blocks
)paren
op_rshift
l_int|11
)paren
suffix:semicolon
r_else
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;n/f    &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;no stat&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_char
id|buffer
(braket
l_int|7
)braket
suffix:semicolon
id|dasd_device_name
(paren
id|buffer
comma
id|i
comma
l_int|0
comma
op_amp
id|temp-&gt;gendisk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devno
OL
l_int|0
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;none&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%04x&quot;
comma
id|devno
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;(none) at (%3d:%3d) is %-7s%4s: unknown&quot;
comma
id|temp-&gt;gendisk.major
comma
id|i
op_lshift
id|DASD_PARTN_BITS
comma
id|buffer
comma
(paren
id|features
op_amp
id|DASD_FEATURE_READONLY
)paren
ques
c_cond
l_string|&quot;(ro)&quot;
suffix:colon
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dasd_probeonly
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;(probeonly)&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|index
op_add_assign
l_int|1
op_lshift
(paren
id|MINORBITS
op_minus
id|DASD_PARTN_BITS
)paren
suffix:semicolon
)brace
id|info-&gt;len
op_assign
id|len
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|discipline_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|macro|MIN
mdefine_line|#define MIN(a,b) ((a)&lt;(b)?(a):(b))
r_static
id|ssize_t
DECL|function|dasd_generic_read
id|dasd_generic_read
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|user_buf
comma
r_int
id|user_len
comma
id|loff_t
op_star
id|offset
)paren
(brace
id|loff_t
id|len
suffix:semicolon
id|tempinfo_t
op_star
id|p_info
op_assign
(paren
id|tempinfo_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_star
id|offset
op_ge
id|p_info-&gt;len
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* EOF */
)brace
r_else
(brace
id|len
op_assign
id|MIN
(paren
id|user_len
comma
(paren
id|p_info-&gt;len
op_minus
op_star
id|offset
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|user_buf
comma
op_amp
(paren
id|p_info-&gt;data
(braket
op_star
id|offset
)braket
)paren
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
(paren
op_star
id|offset
)paren
op_add_assign
id|len
suffix:semicolon
r_return
id|len
suffix:semicolon
multiline_comment|/* number of bytes &quot;read&quot; */
)brace
)brace
r_static
id|ssize_t
DECL|function|dasd_devices_write
id|dasd_devices_write
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|user_buf
comma
r_int
id|user_len
comma
id|loff_t
op_star
id|offset
)paren
(brace
r_char
op_star
id|buffer
op_assign
id|vmalloc
(paren
id|user_len
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|off
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|temp
suffix:semicolon
id|dasd_range_t
id|range
suffix:semicolon
r_int
id|features
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
id|buffer
comma
id|user_buf
comma
id|user_len
)paren
)paren
(brace
id|vfree
(paren
id|buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* replace LF with &squot;&bslash;0&squot; */
r_if
c_cond
(paren
id|buffer
(braket
id|user_len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|buffer
(braket
id|user_len
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_else
(brace
id|buffer
(braket
id|user_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;/proc/dasd/devices: &squot;%s&squot;&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
id|buffer
comma
l_string|&quot;set &quot;
comma
l_int|4
)paren
op_logical_and
id|strncmp
(paren
id|buffer
comma
l_string|&quot;add &quot;
comma
l_int|4
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;/proc/dasd/devices: only &squot;set&squot; and &squot;add&squot; are supported verbs&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|off
op_add_assign
l_int|4
suffix:semicolon
r_while
c_loop
(paren
id|buffer
(braket
id|off
)braket
op_logical_and
op_logical_neg
id|isalnum
(paren
id|buffer
(braket
id|off
)braket
)paren
)paren
id|off
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|buffer
op_plus
id|off
comma
l_string|&quot;device&quot;
comma
id|strlen
(paren
l_string|&quot;device&quot;
)paren
)paren
)paren
(brace
id|off
op_add_assign
id|strlen
(paren
l_string|&quot;device&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|buffer
(braket
id|off
)braket
op_logical_and
op_logical_neg
id|isalnum
(paren
id|buffer
(braket
id|off
)braket
)paren
)paren
id|off
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|buffer
op_plus
id|off
comma
l_string|&quot;range=&quot;
comma
id|strlen
(paren
l_string|&quot;range=&quot;
)paren
)paren
)paren
(brace
id|off
op_add_assign
id|strlen
(paren
l_string|&quot;range=&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|buffer
(braket
id|off
)braket
op_logical_and
op_logical_neg
id|isalnum
(paren
id|buffer
(braket
id|off
)braket
)paren
)paren
id|off
op_increment
suffix:semicolon
)brace
id|temp
op_assign
id|buffer
op_plus
id|off
suffix:semicolon
id|range.from
op_assign
id|dasd_strtoul
(paren
id|temp
comma
op_amp
id|temp
comma
op_amp
id|features
)paren
suffix:semicolon
id|range.to
op_assign
id|range.from
suffix:semicolon
r_if
c_cond
(paren
op_star
id|temp
op_eq
l_char|&squot;-&squot;
)paren
(brace
id|temp
op_increment
suffix:semicolon
id|range.to
op_assign
id|dasd_strtoul
(paren
id|temp
comma
op_amp
id|temp
comma
op_amp
id|features
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|range.from
op_eq
op_minus
id|EINVAL
op_logical_or
id|range.to
op_eq
op_minus
id|EINVAL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;/proc/dasd/devices: range parse error in &squot;%s&squot;&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
r_else
(brace
id|off
op_assign
(paren
r_int
)paren
id|temp
op_minus
(paren
r_int
)paren
id|buffer
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|buffer
comma
l_string|&quot;add&quot;
comma
id|strlen
(paren
l_string|&quot;add&quot;
)paren
)paren
)paren
(brace
id|dasd_add_range
(paren
id|range.from
comma
id|range.to
comma
id|features
)paren
suffix:semicolon
id|dasd_enable_ranges
(paren
op_amp
id|range
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|buffer
(braket
id|off
)braket
op_logical_and
op_logical_neg
id|isalnum
(paren
id|buffer
(braket
id|off
)braket
)paren
)paren
id|off
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|buffer
op_plus
id|off
comma
l_string|&quot;on&quot;
comma
id|strlen
(paren
l_string|&quot;on&quot;
)paren
)paren
)paren
(brace
id|dasd_enable_ranges
(paren
op_amp
id|range
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|buffer
op_plus
id|off
comma
l_string|&quot;off&quot;
comma
id|strlen
(paren
l_string|&quot;off&quot;
)paren
)paren
)paren
(brace
id|dasd_disable_ranges
(paren
op_amp
id|range
comma
l_int|NULL
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;/proc/dasd/devices: parse error in &squot;%s&squot;&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
)brace
)brace
id|vfree
(paren
id|buffer
)paren
suffix:semicolon
r_return
id|user_len
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_devices_close
id|dasd_devices_close
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|tempinfo_t
op_star
id|p_info
op_assign
(paren
id|tempinfo_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|p_info
)paren
(brace
r_if
c_cond
(paren
id|p_info-&gt;data
)paren
id|vfree
(paren
id|p_info-&gt;data
)paren
suffix:semicolon
id|vfree
(paren
id|p_info
)paren
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|dasd_devices_file_ops
r_static
r_struct
id|file_operations
id|dasd_devices_file_ops
op_assign
(brace
id|read
suffix:colon
id|dasd_generic_read
comma
multiline_comment|/* read */
id|write
suffix:colon
id|dasd_devices_write
comma
multiline_comment|/* write */
id|open
suffix:colon
id|dasd_devices_open
comma
multiline_comment|/* open */
id|release
suffix:colon
id|dasd_devices_close
comma
multiline_comment|/* close */
)brace
suffix:semicolon
DECL|variable|dasd_devices_inode_ops
r_static
r_struct
id|inode_operations
id|dasd_devices_inode_ops
op_assign
(brace
)brace
suffix:semicolon
r_static
r_int
DECL|function|dasd_statistics_open
id|dasd_statistics_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|tempinfo_t
op_star
id|info
suffix:semicolon
r_int
id|shift
comma
id|i
comma
id|help
op_assign
l_int|0
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|info
op_assign
(paren
id|tempinfo_t
op_star
)paren
id|vmalloc
(paren
r_sizeof
(paren
id|tempinfo_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;No memory available for data&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
id|info
suffix:semicolon
)brace
id|info-&gt;data
op_assign
(paren
r_char
op_star
)paren
id|vmalloc
(paren
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* FIXME! determine space needed in a better way */
r_if
c_cond
(paren
id|info-&gt;data
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;No memory available for data&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
(paren
id|info
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* prevent couter &squot;ouverflow&squot; on output */
r_for
c_loop
(paren
id|shift
op_assign
l_int|0
comma
id|help
op_assign
id|dasd_global_profile.dasd_io_reqs
suffix:semicolon
id|help
OG
l_int|9999999
suffix:semicolon
id|help
op_assign
id|help
op_rshift
l_int|1
comma
id|shift
op_increment
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
(paren
id|info-&gt;data
comma
l_string|&quot;%d dasd I/O requests&bslash;n&quot;
comma
id|dasd_global_profile.dasd_io_reqs
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;with %d sectors(512B each)&bslash;n&quot;
comma
id|dasd_global_profile.dasd_io_sects
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;   __&lt;4    ___8    __16    __32    __64 &quot;
l_string|&quot;   _128    _256    _512    __1k    __2k &quot;
l_string|&quot;   __4k    __8k    _16k    _32k    _64k &quot;
l_string|&quot;   128k&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;   _256    _512    __1M    __2M    __4M &quot;
l_string|&quot;   __8M    _16M    _32M    _64M    128M &quot;
l_string|&quot;   256M    512M    __1G    __2G    __4G &quot;
l_string|&quot;   _&gt;4G&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;Histogram of sizes (512B secs)&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_secs
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;Histogram of I/O times (microseconds)&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_times
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_times
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;Histogram of I/O times per sector&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_timps
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_timps
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;Histogram of I/O time till ssch&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_time1
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_time1
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;Histogram of I/O time between ssch and irq&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_time2
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_time2
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;Histogram of I/O time between ssch and irq per sector&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_time2ps
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_time2ps
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;Histogram of I/O time between irq and end&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_time3
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_time3
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;# of req in chanq at enqueuing (1..32) &bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_nr_req
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;%7d &quot;
comma
id|dasd_global_profile.dasd_io_nr_req
(braket
id|i
)braket
op_rshift
id|shift
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|info-&gt;data
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|info-&gt;len
op_assign
id|len
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|dasd_statistics_write
id|dasd_statistics_write
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|user_buf
comma
r_int
id|user_len
comma
id|loff_t
op_star
id|offset
)paren
(brace
r_char
op_star
id|buffer
op_assign
id|vmalloc
(paren
id|user_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
id|buffer
comma
id|user_buf
comma
id|user_len
)paren
)paren
(brace
id|vfree
(paren
id|buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|buffer
(braket
id|user_len
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;/proc/dasd/statictics: &squot;%s&squot;&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
id|buffer
comma
l_string|&quot;reset&quot;
comma
l_int|4
)paren
)paren
(brace
id|memset
(paren
op_amp
id|dasd_global_profile
comma
l_int|0
comma
r_sizeof
(paren
id|dasd_profile_info_t
)paren
)paren
suffix:semicolon
)brace
r_return
id|user_len
suffix:semicolon
)brace
DECL|variable|dasd_statistics_file_ops
r_static
r_struct
id|file_operations
id|dasd_statistics_file_ops
op_assign
(brace
id|read
suffix:colon
id|dasd_generic_read
comma
multiline_comment|/* read */
id|open
suffix:colon
id|dasd_statistics_open
comma
multiline_comment|/* open */
id|write
suffix:colon
id|dasd_statistics_write
comma
multiline_comment|/* write */
id|release
suffix:colon
id|dasd_devices_close
comma
multiline_comment|/* close */
)brace
suffix:semicolon
DECL|variable|dasd_statistics_inode_ops
r_static
r_struct
id|inode_operations
id|dasd_statistics_inode_ops
op_assign
(brace
)brace
suffix:semicolon
r_int
DECL|function|dasd_proc_init
id|dasd_proc_init
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_proc_root_entry
op_assign
id|proc_mkdir
(paren
l_string|&quot;dasd&quot;
comma
op_amp
id|proc_root
)paren
suffix:semicolon
id|dasd_devices_entry
op_assign
id|create_proc_entry
(paren
l_string|&quot;devices&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|dasd_proc_root_entry
)paren
suffix:semicolon
id|dasd_devices_entry-&gt;proc_fops
op_assign
op_amp
id|dasd_devices_file_ops
suffix:semicolon
id|dasd_devices_entry-&gt;proc_iops
op_assign
op_amp
id|dasd_devices_inode_ops
suffix:semicolon
id|dasd_statistics_entry
op_assign
id|create_proc_entry
(paren
l_string|&quot;statistics&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|dasd_proc_root_entry
)paren
suffix:semicolon
id|dasd_statistics_entry-&gt;proc_fops
op_assign
op_amp
id|dasd_statistics_file_ops
suffix:semicolon
id|dasd_statistics_entry-&gt;proc_iops
op_assign
op_amp
id|dasd_statistics_inode_ops
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|dasd_proc_cleanup
id|dasd_proc_cleanup
(paren
r_void
)paren
(brace
id|remove_proc_entry
(paren
l_string|&quot;devices&quot;
comma
id|dasd_proc_root_entry
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;statistics&quot;
comma
id|dasd_proc_root_entry
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;dasd&quot;
comma
op_amp
id|proc_root
)paren
suffix:semicolon
)brace
r_int
DECL|function|dasd_request_module
id|dasd_request_module
(paren
r_void
op_star
id|name
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
id|strcpy
c_func
(paren
id|current-&gt;comm
comma
id|name
)paren
suffix:semicolon
id|daemonize
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|current-&gt;fs-&gt;root
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* wait for root-FS */
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|wait
)paren
suffix:semicolon
id|sleep_on_timeout
c_func
(paren
op_amp
id|wait
comma
id|HZ
)paren
suffix:semicolon
multiline_comment|/* wait in steps of one second */
)brace
r_while
c_loop
(paren
(paren
id|rc
op_assign
id|request_module
c_func
(paren
id|name
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|wait
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;request_module returned %d for %s&bslash;n&quot;
comma
id|rc
comma
(paren
r_char
op_star
)paren
id|name
)paren
suffix:semicolon
id|sleep_on_timeout
c_func
(paren
op_amp
id|wait
comma
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* wait in steps of 5 seconds */
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* SECTION: Initializing the driver */
r_int
id|__init
DECL|function|dasd_init
id|dasd_init
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|major_info_t
op_star
id|major_info
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;initializing...&bslash;n&quot;
)paren
suffix:semicolon
id|dasd_debug_area
op_assign
id|debug_register
(paren
id|DASD_NAME
comma
l_int|0
comma
l_int|2
comma
l_int|5
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_register_view
(paren
id|dasd_debug_area
comma
op_amp
id|debug_sprintf_view
)paren
suffix:semicolon
id|debug_register_view
(paren
id|dasd_debug_area
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|dasd_init_waitq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd_debug_area
op_eq
l_int|NULL
)paren
(brace
r_goto
id|failed
suffix:semicolon
)brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|0
comma
id|dasd_init
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ENTRY&quot;
)paren
suffix:semicolon
id|dasd_devfs_handle
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
id|DASD_NAME
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd_devfs_handle
OL
l_int|0
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;no devfs&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|list_for_each
(paren
id|l
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|major_info
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dasd_register_major
(paren
id|major_info
)paren
)paren
OG
l_int|0
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;major %d: success&quot;
comma
id|major_info-&gt;gendisk.major
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;Registered successfully to major no %u&bslash;n&quot;
comma
id|major_info-&gt;gendisk.major
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;major %d: failed&quot;
comma
id|major_info-&gt;gendisk.major
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Couldn&squot;t register successfully to major no %d&bslash;n&quot;
comma
id|major_info-&gt;gendisk.major
)paren
suffix:semicolon
multiline_comment|/* revert registration of major infos */
r_goto
id|failed
suffix:semicolon
)brace
)brace
macro_line|#ifndef MODULE
id|dasd_split_parm_string
(paren
id|dasd_parm_string
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ! MODULE */
id|rc
op_assign
id|dasd_parse
(paren
id|dasd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;invalid range found&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|rc
op_assign
id|dasd_proc_init
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;no proc-FS&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|genhd_dasd_name
op_assign
id|dasd_device_name
suffix:semicolon
r_if
c_cond
(paren
id|dasd_autodetect
)paren
(brace
multiline_comment|/* update device range to all devices */
r_for
c_loop
(paren
id|irq
op_assign
id|get_irq_first
(paren
)paren
suffix:semicolon
id|irq
op_ne
op_minus
id|ENODEV
suffix:semicolon
id|irq
op_assign
id|get_irq_next
(paren
id|irq
)paren
)paren
(brace
r_int
id|devno
op_assign
id|get_devno_by_irq
(paren
id|irq
)paren
suffix:semicolon
r_int
id|index
op_assign
id|dasd_devindex_from_devno
(paren
id|devno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_eq
op_minus
id|ENODEV
)paren
(brace
multiline_comment|/* not included in ranges */
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|2
comma
id|dasd_init
comma
l_string|&quot;add %04x to range&quot;
comma
id|devno
)paren
suffix:semicolon
id|dasd_add_range
(paren
id|devno
comma
id|devno
comma
id|DASD_DEFAULT_FEATURES
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|MACHINE_IS_VM
)paren
(brace
macro_line|#ifdef CONFIG_DASD_DIAG
id|rc
op_assign
id|dasd_diag_init
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;DIAG discipline %s&quot;
comma
l_string|&quot;success&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;Registered DIAG discipline successfully&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;DIAG discipline %s&quot;
comma
l_string|&quot;failed&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_DASD_DIAG */
macro_line|#if defined(CONFIG_DASD_DIAG_MODULE) &amp;&amp; defined(CONFIG_DASD_AUTO_DIAG)
id|kernel_thread
c_func
(paren
id|dasd_request_module
comma
l_string|&quot;dasd_diag_mod&quot;
comma
id|SIGCHLD
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_DASD_AUTO_DIAG */
)brace
macro_line|#ifdef CONFIG_DASD_ECKD
id|rc
op_assign
id|dasd_eckd_init
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;ECKD discipline %s&quot;
comma
l_string|&quot;success&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;Registered ECKD discipline successfully&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;ECKD discipline %s&quot;
comma
l_string|&quot;failed&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_DASD_ECKD */
macro_line|#if defined(CONFIG_DASD_ECKD_MODULE) &amp;&amp; defined(CONFIG_DASD_AUTO_ECKD)
id|kernel_thread
c_func
(paren
id|dasd_request_module
comma
l_string|&quot;dasd_eckd_mod&quot;
comma
id|SIGCHLD
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_DASD_AUTO_ECKD */
macro_line|#ifdef CONFIG_DASD_FBA
id|rc
op_assign
id|dasd_fba_init
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;FBA discipline %s&quot;
comma
l_string|&quot;success&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;Registered FBA discipline successfully&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
id|dasd_init
comma
l_string|&quot;FBA discipline %s&quot;
comma
l_string|&quot;failed&quot;
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_DASD_FBA */
macro_line|#if defined(CONFIG_DASD_FBA_MODULE) &amp;&amp; defined(CONFIG_DASD_AUTO_FBA)
id|kernel_thread
c_func
(paren
id|dasd_request_module
comma
l_string|&quot;dasd_fba_mod&quot;
comma
id|SIGCHLD
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_DASD_AUTO_FBA */
(brace
r_char
op_star
op_star
id|disc
op_assign
id|dasd_disciplines
suffix:semicolon
r_while
c_loop
(paren
op_star
id|disc
)paren
(brace
id|kernel_thread
c_func
(paren
id|dasd_request_module
comma
op_star
id|disc
comma
id|SIGCHLD
)paren
suffix:semicolon
id|disc
op_increment
suffix:semicolon
)brace
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|failed
suffix:colon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;initialization not performed due to errors&bslash;n&quot;
)paren
suffix:semicolon
id|cleanup_dasd
(paren
)paren
suffix:semicolon
id|out
suffix:colon
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|0
comma
id|dasd_init
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;LEAVE&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;initialization finished&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|cleanup_dasd
id|cleanup_dasd
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|rc
op_assign
l_int|0
suffix:semicolon
id|major_info_t
op_star
id|major_info
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
id|dasd_range_t
op_star
id|range
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;shutting down&bslash;n&quot;
)paren
suffix:semicolon
id|DASD_DRIVER_DEBUG_EVENT
c_func
(paren
l_int|0
comma
l_string|&quot;cleanup_dasd&quot;
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ENTRY&quot;
)paren
suffix:semicolon
id|dasd_disable_ranges
(paren
op_amp
id|dasd_range_head
comma
l_int|NULL
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MACHINE_IS_VM
)paren
(brace
macro_line|#ifdef CONFIG_DASD_DIAG
id|dasd_diag_cleanup
(paren
)paren
suffix:semicolon
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
l_string|&quot;cleanup_dasd&quot;
comma
l_string|&quot;DIAG discipline %s&quot;
comma
l_string|&quot;success&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;De-Registered DIAG discipline successfully&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_DASD_ECKD_BUILTIN */
)brace
macro_line|#ifdef CONFIG_DASD_FBA
id|dasd_fba_cleanup
(paren
)paren
suffix:semicolon
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
l_string|&quot;cleanup_dasd&quot;
comma
l_string|&quot;FBA discipline %s&quot;
comma
l_string|&quot;success&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;De-Registered FBA discipline successfully&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_DASD_ECKD_BUILTIN */
macro_line|#ifdef CONFIG_DASD_ECKD
id|dasd_eckd_cleanup
(paren
)paren
suffix:semicolon
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
l_string|&quot;cleanup_dasd&quot;
comma
l_string|&quot;ECKD discipline %s&quot;
comma
l_string|&quot;success&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;De-Registered ECKD discipline successfully&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_DASD_ECKD_BUILTIN */
id|dasd_proc_cleanup
(paren
)paren
suffix:semicolon
id|list_for_each_safe
(paren
id|l
comma
id|n
comma
op_amp
id|dasd_major_info
(braket
l_int|0
)braket
dot
id|list
)paren
(brace
id|major_info
op_assign
id|list_entry
(paren
id|l
comma
id|major_info_t
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DASD_PER_MAJOR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kfree
(paren
id|major_info-&gt;dasd_device
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|major_info-&gt;flags
op_amp
id|DASD_MAJOR_INFO_REGISTERED
)paren
op_logical_and
(paren
id|rc
op_assign
id|dasd_unregister_major
(paren
id|major_info
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
l_string|&quot;cleanup_dasd&quot;
comma
l_string|&quot;major %d: success&quot;
comma
id|major_info-&gt;gendisk.major
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;Unregistered successfully from major no %u&bslash;n&quot;
comma
id|major_info-&gt;gendisk.major
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_DRIVER_DEBUG_EVENT
(paren
l_int|1
comma
l_string|&quot;cleanup_dasd&quot;
comma
l_string|&quot;major %d: failed&quot;
comma
id|major_info-&gt;gendisk.major
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Couldn&squot;t unregister successfully from major no %d rc = %d&bslash;n&quot;
comma
id|major_info-&gt;gendisk.major
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
id|list_for_each_safe
(paren
id|l
comma
id|n
comma
op_amp
id|dasd_range_head.list
)paren
(brace
id|range
op_assign
id|list_entry
(paren
id|l
comma
id|dasd_range_t
comma
id|list
)paren
suffix:semicolon
id|dasd_remove_range
c_func
(paren
id|range
)paren
suffix:semicolon
)brace
macro_line|#ifndef MODULE
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dasd
(braket
id|i
)braket
)paren
(brace
id|kfree
c_func
(paren
id|dasd
(braket
id|i
)braket
)paren
suffix:semicolon
id|dasd
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* MODULE */
r_if
c_cond
(paren
id|dasd_devfs_handle
)paren
id|devfs_unregister
c_func
(paren
id|dasd_devfs_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd_debug_area
op_ne
l_int|NULL
)paren
id|debug_unregister
c_func
(paren
id|dasd_debug_area
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;shutdown completed&bslash;n&quot;
)paren
suffix:semicolon
id|DASD_DRIVER_DEBUG_EVENT
c_func
(paren
l_int|0
comma
l_string|&quot;cleanup_dasd&quot;
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;LEAVE&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_int
DECL|function|init_module
id|init_module
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|dasd_init
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
(paren
r_void
)paren
(brace
id|cleanup_dasd
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 4&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -4&n; * c-argdecl-indent: 4&n; * c-label-offset: -4&n; * c-continued-statement-offset: 4&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
