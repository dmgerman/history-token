multiline_comment|/*&n; * dcssblk.c -- the S/390 block driver for dcss memory&n; *&n; * Authors: Carsten Otte, Stefan Weinhuber, Gerald Schaefer&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;asm/extmem.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt; &t;
singleline_comment|// for s390_root_dev_(un)register()
singleline_comment|//#define DCSSBLK_DEBUG&t;&t;/* Debug messages on/off */
DECL|macro|DCSSBLK_NAME
mdefine_line|#define DCSSBLK_NAME &quot;dcssblk&quot;
DECL|macro|DCSSBLK_MINORS_PER_DISK
mdefine_line|#define DCSSBLK_MINORS_PER_DISK 1
DECL|macro|DCSSBLK_PARM_LEN
mdefine_line|#define DCSSBLK_PARM_LEN 400
macro_line|#ifdef DCSSBLK_DEBUG
DECL|macro|PRINT_DEBUG
mdefine_line|#define PRINT_DEBUG(x...) printk(KERN_DEBUG DCSSBLK_NAME &quot; debug: &quot; x)
macro_line|#else
DECL|macro|PRINT_DEBUG
mdefine_line|#define PRINT_DEBUG(x...) do {} while (0)
macro_line|#endif
DECL|macro|PRINT_INFO
mdefine_line|#define PRINT_INFO(x...)  printk(KERN_INFO DCSSBLK_NAME &quot; info: &quot; x)
DECL|macro|PRINT_WARN
mdefine_line|#define PRINT_WARN(x...)  printk(KERN_WARNING DCSSBLK_NAME &quot; warning: &quot; x)
DECL|macro|PRINT_ERR
mdefine_line|#define PRINT_ERR(x...)&t;  printk(KERN_ERR DCSSBLK_NAME &quot; error: &quot; x)
r_static
r_int
id|dcssblk_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|dcssblk_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|dcssblk_make_request
c_func
(paren
r_struct
id|request_queue
op_star
id|q
comma
r_struct
id|bio
op_star
id|bio
)paren
suffix:semicolon
DECL|variable|dcssblk_segments
r_static
r_char
id|dcssblk_segments
(braket
id|DCSSBLK_PARM_LEN
)braket
op_assign
l_string|&quot;&bslash;0&quot;
suffix:semicolon
DECL|variable|dcssblk_major
r_static
r_int
id|dcssblk_major
suffix:semicolon
DECL|variable|dcssblk_devops
r_static
r_struct
id|block_device_operations
id|dcssblk_devops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|dcssblk_open
comma
dot
id|release
op_assign
id|dcssblk_release
comma
)brace
suffix:semicolon
r_static
id|ssize_t
id|dcssblk_add_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|ssize_t
id|dcssblk_remove_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|ssize_t
id|dcssblk_save_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|ssize_t
id|dcssblk_save_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_static
id|ssize_t
id|dcssblk_shared_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|ssize_t
id|dcssblk_shared_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|add
comma
id|S_IWUSR
comma
l_int|NULL
comma
id|dcssblk_add_store
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|remove
comma
id|S_IWUSR
comma
l_int|NULL
comma
id|dcssblk_remove_store
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|save
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
id|dcssblk_save_show
comma
id|dcssblk_save_store
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|shared
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
id|dcssblk_shared_show
comma
id|dcssblk_shared_store
)paren
suffix:semicolon
DECL|variable|dcssblk_root_dev
r_static
r_struct
id|device
op_star
id|dcssblk_root_dev
suffix:semicolon
DECL|struct|dcssblk_dev_info
r_struct
id|dcssblk_dev_info
(brace
DECL|member|lh
r_struct
id|list_head
id|lh
suffix:semicolon
DECL|member|dev
r_struct
id|device
id|dev
suffix:semicolon
DECL|member|segment_name
r_char
id|segment_name
(braket
id|BUS_ID_SIZE
)braket
suffix:semicolon
DECL|member|use_count
id|atomic_t
id|use_count
suffix:semicolon
DECL|member|gd
r_struct
id|gendisk
op_star
id|gd
suffix:semicolon
DECL|member|start
r_int
r_int
id|start
suffix:semicolon
DECL|member|end
r_int
r_int
id|end
suffix:semicolon
DECL|member|segment_type
r_int
id|segment_type
suffix:semicolon
DECL|member|save_pending
r_int
r_char
id|save_pending
suffix:semicolon
DECL|member|is_shared
r_int
r_char
id|is_shared
suffix:semicolon
DECL|member|dcssblk_queue
r_struct
id|request_queue
op_star
id|dcssblk_queue
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|dcssblk_devices
r_static
r_struct
id|list_head
id|dcssblk_devices
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|dcssblk_devices
)paren
suffix:semicolon
DECL|variable|dcssblk_devices_sem
r_static
r_struct
id|rw_semaphore
id|dcssblk_devices_sem
suffix:semicolon
multiline_comment|/*&n; * release function for segment device.&n; */
r_static
r_void
DECL|function|dcssblk_release_segment
id|dcssblk_release_segment
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|PRINT_DEBUG
c_func
(paren
l_string|&quot;segment release fn called for %s&bslash;n&quot;
comma
id|dev-&gt;bus_id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|dcssblk_dev_info
comma
id|dev
)paren
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * get a minor number. needs to be called with&n; * down_write(&amp;dcssblk_devices_sem) and the&n; * device needs to be enqueued before the semaphore is&n; * freed.&n; */
r_static
r_inline
r_int
DECL|function|dcssblk_assign_free_minor
id|dcssblk_assign_free_minor
c_func
(paren
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
)paren
(brace
r_int
id|minor
comma
id|found
suffix:semicolon
r_struct
id|dcssblk_dev_info
op_star
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|dev_info
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|minor
op_assign
l_int|0
suffix:semicolon
id|minor
OL
(paren
l_int|1
op_lshift
id|MINORBITS
)paren
suffix:semicolon
id|minor
op_increment
)paren
(brace
id|found
op_assign
l_int|0
suffix:semicolon
singleline_comment|// test if minor available
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|dcssblk_devices
comma
id|lh
)paren
r_if
c_cond
(paren
id|minor
op_eq
id|entry-&gt;gd-&gt;first_minor
)paren
id|found
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
r_break
suffix:semicolon
singleline_comment|// got unused minor
)brace
r_if
c_cond
(paren
id|found
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|dev_info-&gt;gd-&gt;first_minor
op_assign
id|minor
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * get the struct dcssblk_dev_info from dcssblk_devices&n; * for the given name.&n; * down_read(&amp;dcssblk_devices_sem) must be held.&n; */
r_static
r_struct
id|dcssblk_dev_info
op_star
DECL|function|dcssblk_get_device_by_name
id|dcssblk_get_device_by_name
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|entry
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|entry
comma
op_amp
id|dcssblk_devices
comma
id|lh
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
id|entry-&gt;segment_name
)paren
)paren
(brace
r_return
id|entry
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * print appropriate error message for segment_load()/segment_type()&n; * return code&n; */
r_static
r_void
DECL|function|dcssblk_segment_warn
id|dcssblk_segment_warn
c_func
(paren
r_int
id|rc
comma
r_char
op_star
id|seg_name
)paren
(brace
r_switch
c_cond
(paren
id|rc
)paren
(brace
r_case
op_minus
id|ENOENT
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, does not exist&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENOSYS
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, not running on VM&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EIO
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, hardware error&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENOTSUPP
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, is a multi-part &quot;
l_string|&quot;segment&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENOSPC
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, overlaps with &quot;
l_string|&quot;storage&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EBUSY
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, overlaps with &quot;
l_string|&quot;already loaded dcss&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EPERM
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, already loaded in &quot;
l_string|&quot;incompatible mode&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENOMEM
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, out of memory&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ERANGE
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, exceeds kernel &quot;
l_string|&quot;mapping range&bslash;n&quot;
comma
id|seg_name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;cannot load/query segment %s, return value %i&bslash;n&quot;
comma
id|seg_name
comma
id|rc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * device attribute for switching shared/nonshared (exclusive)&n; * operation (show + store)&n; */
r_static
id|ssize_t
DECL|function|dcssblk_shared_show
id|dcssblk_shared_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
id|dev_info
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|dcssblk_dev_info
comma
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
id|dev_info-&gt;is_shared
ques
c_cond
l_string|&quot;1&bslash;n&quot;
suffix:colon
l_string|&quot;0&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|dcssblk_shared_store
id|dcssblk_shared_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|inbuf
comma
r_int
id|count
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
OG
l_int|1
)paren
op_logical_and
(paren
id|inbuf
(braket
l_int|1
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
op_logical_and
(paren
id|inbuf
(braket
l_int|1
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Invalid value, must be 0 or 1&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|dev_info
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|dcssblk_dev_info
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev_info-&gt;use_count
)paren
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;share: segment %s is busy!&bslash;n&quot;
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inbuf
(braket
l_int|0
)braket
op_eq
l_char|&squot;1&squot;
)paren
(brace
singleline_comment|// reload segment in shared mode
id|rc
op_assign
id|segment_modify_shared
c_func
(paren
id|dev_info-&gt;segment_name
comma
id|SEGMENT_SHARED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|BUG_ON
c_func
(paren
id|rc
op_eq
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EIO
op_logical_or
id|rc
op_eq
op_minus
id|ENOENT
)paren
r_goto
id|removeseg
suffix:semicolon
)brace
r_else
(brace
id|dev_info-&gt;is_shared
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|dev_info-&gt;segment_type
)paren
(brace
r_case
id|SEG_TYPE_SR
suffix:colon
r_case
id|SEG_TYPE_ER
suffix:colon
r_case
id|SEG_TYPE_SC
suffix:colon
id|set_disk_ro
c_func
(paren
id|dev_info-&gt;gd
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|inbuf
(braket
l_int|0
)braket
op_eq
l_char|&squot;0&squot;
)paren
(brace
singleline_comment|// reload segment in exclusive mode
r_if
c_cond
(paren
id|dev_info-&gt;segment_type
op_eq
id|SEG_TYPE_SC
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Segment type SC (%s) cannot be loaded in &quot;
l_string|&quot;non-shared mode&bslash;n&quot;
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
id|segment_modify_shared
c_func
(paren
id|dev_info-&gt;segment_name
comma
id|SEGMENT_EXCLUSIVE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|BUG_ON
c_func
(paren
id|rc
op_eq
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EIO
op_logical_or
id|rc
op_eq
op_minus
id|ENOENT
)paren
r_goto
id|removeseg
suffix:semicolon
)brace
r_else
(brace
id|dev_info-&gt;is_shared
op_assign
l_int|0
suffix:semicolon
id|set_disk_ro
c_func
(paren
id|dev_info-&gt;gd
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Invalid value, must be 0 or 1&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
id|count
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|removeseg
suffix:colon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Could not reload segment %s, removing it now!&bslash;n&quot;
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|dev_info-&gt;lh
)paren
suffix:semicolon
id|del_gendisk
c_func
(paren
id|dev_info-&gt;gd
)paren
suffix:semicolon
id|blk_put_queue
c_func
(paren
id|dev_info-&gt;dcssblk_queue
)paren
suffix:semicolon
id|dev_info-&gt;gd-&gt;queue
op_assign
l_int|NULL
suffix:semicolon
id|put_disk
c_func
(paren
id|dev_info-&gt;gd
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
id|dev
)paren
suffix:semicolon
id|put_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * device attribute for save operation on current copy&n; * of the segment. If the segment is busy, saving will&n; * become pending until it gets released, which can be&n; * undone by storing a non-true value to this entry.&n; * (show + store)&n; */
r_static
id|ssize_t
DECL|function|dcssblk_save_show
id|dcssblk_save_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
id|dev_info
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|dcssblk_dev_info
comma
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
id|dev_info-&gt;save_pending
ques
c_cond
l_string|&quot;1&bslash;n&quot;
suffix:colon
l_string|&quot;0&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|dcssblk_save_store
id|dcssblk_save_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|inbuf
comma
r_int
id|count
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
OG
l_int|1
)paren
op_logical_and
(paren
id|inbuf
(braket
l_int|1
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
op_logical_and
(paren
id|inbuf
(braket
l_int|1
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Invalid value, must be 0 or 1&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev_info
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|dcssblk_dev_info
comma
id|dev
)paren
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inbuf
(braket
l_int|0
)braket
op_eq
l_char|&squot;1&squot;
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev_info-&gt;use_count
)paren
op_eq
l_int|0
)paren
(brace
singleline_comment|// device is idle =&gt; we save immediately
id|PRINT_INFO
c_func
(paren
l_string|&quot;Saving segment %s&bslash;n&quot;
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|segment_save
c_func
(paren
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// device is busy =&gt; we save it when it becomes
singleline_comment|// idle in dcssblk_release
id|PRINT_INFO
c_func
(paren
l_string|&quot;Segment %s is currently busy, it will &quot;
l_string|&quot;be saved when it becomes idle...&bslash;n&quot;
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|dev_info-&gt;save_pending
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|inbuf
(braket
l_int|0
)braket
op_eq
l_char|&squot;0&squot;
)paren
(brace
r_if
c_cond
(paren
id|dev_info-&gt;save_pending
)paren
(brace
singleline_comment|// device is busy &amp; the user wants to undo his save
singleline_comment|// request
id|dev_info-&gt;save_pending
op_assign
l_int|0
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;Pending save for segment %s deactivated&bslash;n&quot;
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Invalid value, must be 0 or 1&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * device attribute for adding devices&n; */
r_static
id|ssize_t
DECL|function|dcssblk_add_store
id|dcssblk_add_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|rc
comma
id|i
suffix:semicolon
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
r_char
op_star
id|local_buf
suffix:semicolon
r_int
r_int
id|seg_byte_size
suffix:semicolon
id|dev_info
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
id|dcssblk_root_dev
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_nobuf
suffix:semicolon
)brace
id|local_buf
op_assign
id|kmalloc
c_func
(paren
id|count
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local_buf
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_nobuf
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * parse input&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|buf
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_and
(paren
id|buf
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
op_logical_and
id|i
OL
id|count
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|local_buf
(braket
id|i
)braket
op_assign
id|toupper
c_func
(paren
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|local_buf
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
l_int|0
)paren
op_logical_or
(paren
id|i
OG
l_int|8
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * already loaded?&n;&t; */
id|down_read
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|dev_info
op_assign
id|dcssblk_get_device_by_name
c_func
(paren
id|local_buf
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_info
op_ne
l_int|NULL
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Segment %s already loaded!&bslash;n&quot;
comma
id|local_buf
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * get a struct dcssblk_dev_info&n;&t; */
id|dev_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dcssblk_dev_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_info
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev_info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dcssblk_dev_info
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|dev_info-&gt;segment_name
comma
id|local_buf
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|dev_info-&gt;dev.bus_id
comma
id|local_buf
comma
id|BUS_ID_SIZE
)paren
suffix:semicolon
id|dev_info-&gt;dev.release
op_assign
id|dcssblk_release_segment
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dev_info-&gt;lh
)paren
suffix:semicolon
id|dev_info-&gt;gd
op_assign
id|alloc_disk
c_func
(paren
id|DCSSBLK_MINORS_PER_DISK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_info-&gt;gd
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_dev_info
suffix:semicolon
)brace
id|dev_info-&gt;gd-&gt;major
op_assign
id|dcssblk_major
suffix:semicolon
id|dev_info-&gt;gd-&gt;fops
op_assign
op_amp
id|dcssblk_devops
suffix:semicolon
id|dev_info-&gt;dcssblk_queue
op_assign
id|blk_alloc_queue
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
id|dev_info-&gt;gd-&gt;queue
op_assign
id|dev_info-&gt;dcssblk_queue
suffix:semicolon
id|dev_info-&gt;gd-&gt;private_data
op_assign
id|dev_info
suffix:semicolon
id|dev_info-&gt;gd-&gt;driverfs_dev
op_assign
op_amp
id|dev_info-&gt;dev
suffix:semicolon
multiline_comment|/*&n;&t; * load the segment&n;&t; */
id|rc
op_assign
id|segment_load
c_func
(paren
id|local_buf
comma
id|SEGMENT_SHARED
comma
op_amp
id|dev_info-&gt;start
comma
op_amp
id|dev_info-&gt;end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|dcssblk_segment_warn
c_func
(paren
id|rc
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
r_goto
id|dealloc_gendisk
suffix:semicolon
)brace
id|seg_byte_size
op_assign
(paren
id|dev_info-&gt;end
op_minus
id|dev_info-&gt;start
op_plus
l_int|1
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
id|dev_info-&gt;gd
comma
id|seg_byte_size
op_rshift
l_int|9
)paren
suffix:semicolon
singleline_comment|// size in sectors
id|PRINT_INFO
c_func
(paren
l_string|&quot;Loaded segment %s, size = %lu Byte, &quot;
l_string|&quot;capacity = %lu (512 Byte) sectors&bslash;n&quot;
comma
id|local_buf
comma
id|seg_byte_size
comma
id|seg_byte_size
op_rshift
l_int|9
)paren
suffix:semicolon
id|dev_info-&gt;segment_type
op_assign
id|rc
suffix:semicolon
id|dev_info-&gt;save_pending
op_assign
l_int|0
suffix:semicolon
id|dev_info-&gt;is_shared
op_assign
l_int|1
suffix:semicolon
id|dev_info-&gt;dev.parent
op_assign
id|dcssblk_root_dev
suffix:semicolon
multiline_comment|/*&n;&t; * get minor, add to list&n;&t; */
id|down_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|rc
op_assign
id|dcssblk_assign_free_minor
c_func
(paren
id|dev_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;No free minor number available! &quot;
l_string|&quot;Unloading segment...&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|unload_seg
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|dev_info-&gt;gd-&gt;disk_name
comma
l_string|&quot;dcssblk%d&quot;
comma
id|dev_info-&gt;gd-&gt;first_minor
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|dev_info-&gt;lh
comma
op_amp
id|dcssblk_devices
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|try_module_get
c_func
(paren
id|THIS_MODULE
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|list_del
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * register the device&n;&t; */
id|rc
op_assign
id|device_register
c_func
(paren
op_amp
id|dev_info-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Segment %s could not be registered RC=%d&bslash;n&quot;
comma
id|local_buf
comma
id|rc
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
r_goto
id|list_del
suffix:semicolon
)brace
id|get_device
c_func
(paren
op_amp
id|dev_info-&gt;dev
)paren
suffix:semicolon
id|rc
op_assign
id|device_create_file
c_func
(paren
op_amp
id|dev_info-&gt;dev
comma
op_amp
id|dev_attr_shared
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|unregister_dev
suffix:semicolon
id|rc
op_assign
id|device_create_file
c_func
(paren
op_amp
id|dev_info-&gt;dev
comma
op_amp
id|dev_attr_save
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|unregister_dev
suffix:semicolon
id|add_disk
c_func
(paren
id|dev_info-&gt;gd
)paren
suffix:semicolon
id|blk_queue_make_request
c_func
(paren
id|dev_info-&gt;dcssblk_queue
comma
id|dcssblk_make_request
)paren
suffix:semicolon
id|blk_queue_hardsect_size
c_func
(paren
id|dev_info-&gt;dcssblk_queue
comma
l_int|4096
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev_info-&gt;segment_type
)paren
(brace
r_case
id|SEG_TYPE_SR
suffix:colon
r_case
id|SEG_TYPE_ER
suffix:colon
r_case
id|SEG_TYPE_SC
suffix:colon
id|set_disk_ro
c_func
(paren
id|dev_info-&gt;gd
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|set_disk_ro
c_func
(paren
id|dev_info-&gt;gd
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|PRINT_DEBUG
c_func
(paren
l_string|&quot;Segment %s loaded successfully&bslash;n&quot;
comma
id|local_buf
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|rc
op_assign
id|count
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|unregister_dev
suffix:colon
id|PRINT_ERR
c_func
(paren
l_string|&quot;device_create_file() failed!&bslash;n&quot;
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|dev_info-&gt;lh
)paren
suffix:semicolon
id|blk_put_queue
c_func
(paren
id|dev_info-&gt;dcssblk_queue
)paren
suffix:semicolon
id|dev_info-&gt;gd-&gt;queue
op_assign
l_int|NULL
suffix:semicolon
id|put_disk
c_func
(paren
id|dev_info-&gt;gd
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|dev_info-&gt;dev
)paren
suffix:semicolon
id|segment_unload
c_func
(paren
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|dev_info-&gt;dev
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|list_del
suffix:colon
id|list_del
c_func
(paren
op_amp
id|dev_info-&gt;lh
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|unload_seg
suffix:colon
id|segment_unload
c_func
(paren
id|local_buf
)paren
suffix:semicolon
id|dealloc_gendisk
suffix:colon
id|blk_put_queue
c_func
(paren
id|dev_info-&gt;dcssblk_queue
)paren
suffix:semicolon
id|dev_info-&gt;gd-&gt;queue
op_assign
l_int|NULL
suffix:semicolon
id|put_disk
c_func
(paren
id|dev_info-&gt;gd
)paren
suffix:semicolon
id|free_dev_info
suffix:colon
id|kfree
c_func
(paren
id|dev_info
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|local_buf
)paren
suffix:semicolon
id|out_nobuf
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * device attribute for removing devices&n; */
r_static
id|ssize_t
DECL|function|dcssblk_remove_store
id|dcssblk_remove_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
r_int
id|rc
comma
id|i
suffix:semicolon
r_char
op_star
id|local_buf
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ne
id|dcssblk_root_dev
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|local_buf
op_assign
id|kmalloc
c_func
(paren
id|count
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local_buf
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * parse input&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
op_star
(paren
id|buf
op_plus
id|i
)paren
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_and
(paren
op_star
(paren
id|buf
op_plus
id|i
)paren
op_ne
l_char|&squot;&bslash;n&squot;
)paren
op_logical_and
id|i
OL
id|count
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|local_buf
(braket
id|i
)braket
op_assign
id|toupper
c_func
(paren
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|local_buf
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
l_int|0
)paren
op_logical_or
(paren
id|i
OG
l_int|8
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_goto
id|out_buf
suffix:semicolon
)brace
id|down_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|dev_info
op_assign
id|dcssblk_get_device_by_name
c_func
(paren
id|local_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_info
op_eq
l_int|NULL
)paren
(brace
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Segment %s is not loaded!&bslash;n&quot;
comma
id|local_buf
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out_buf
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev_info-&gt;use_count
)paren
op_ne
l_int|0
)paren
(brace
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Segment %s is in use!&bslash;n&quot;
comma
id|local_buf
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out_buf
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|dev_info-&gt;lh
)paren
suffix:semicolon
id|del_gendisk
c_func
(paren
id|dev_info-&gt;gd
)paren
suffix:semicolon
id|blk_put_queue
c_func
(paren
id|dev_info-&gt;dcssblk_queue
)paren
suffix:semicolon
id|dev_info-&gt;gd-&gt;queue
op_assign
l_int|NULL
suffix:semicolon
id|put_disk
c_func
(paren
id|dev_info-&gt;gd
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|dev_info-&gt;dev
)paren
suffix:semicolon
id|segment_unload
c_func
(paren
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|PRINT_DEBUG
c_func
(paren
l_string|&quot;Segment %s unloaded successfully&bslash;n&quot;
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|dev_info-&gt;dev
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|rc
op_assign
id|count
suffix:semicolon
id|out_buf
suffix:colon
id|kfree
c_func
(paren
id|local_buf
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|dcssblk_open
id|dcssblk_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|dev_info
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|dev_info
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|dev_info-&gt;use_count
)paren
suffix:semicolon
id|inode-&gt;i_bdev-&gt;bd_block_size
op_assign
l_int|4096
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|dcssblk_release
id|dcssblk_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|dev_info
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|dev_info
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|down_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|dev_info-&gt;use_count
)paren
op_logical_and
(paren
id|dev_info-&gt;save_pending
)paren
)paren
(brace
id|PRINT_INFO
c_func
(paren
l_string|&quot;Segment %s became idle and is being saved now&bslash;n&quot;
comma
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|segment_save
c_func
(paren
id|dev_info-&gt;segment_name
)paren
suffix:semicolon
id|dev_info-&gt;save_pending
op_assign
l_int|0
suffix:semicolon
)brace
id|up_write
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|dcssblk_make_request
id|dcssblk_make_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bvec
suffix:semicolon
r_int
r_int
id|index
suffix:semicolon
r_int
r_int
id|page_addr
suffix:semicolon
r_int
r_int
id|source_addr
suffix:semicolon
r_int
r_int
id|bytes_done
suffix:semicolon
r_int
id|i
suffix:semicolon
id|bytes_done
op_assign
l_int|0
suffix:semicolon
id|dev_info
op_assign
id|bio-&gt;bi_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|dev_info
op_eq
l_int|NULL
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bio-&gt;bi_sector
op_amp
l_int|7
)paren
op_ne
l_int|0
op_logical_or
(paren
id|bio-&gt;bi_size
op_amp
l_int|4095
)paren
op_ne
l_int|0
)paren
multiline_comment|/* Request is not page-aligned. */
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|bio-&gt;bi_size
op_rshift
l_int|9
)paren
op_plus
id|bio-&gt;bi_sector
)paren
OG
id|get_capacity
c_func
(paren
id|bio-&gt;bi_bdev-&gt;bd_disk
)paren
)paren
(brace
multiline_comment|/* Request beyond end of DCSS segment. */
r_goto
id|fail
suffix:semicolon
)brace
id|index
op_assign
(paren
id|bio-&gt;bi_sector
op_rshift
l_int|3
)paren
suffix:semicolon
id|bio_for_each_segment
c_func
(paren
id|bvec
comma
id|bio
comma
id|i
)paren
(brace
id|page_addr
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|bvec-&gt;bv_page
)paren
op_plus
id|bvec-&gt;bv_offset
suffix:semicolon
id|source_addr
op_assign
id|dev_info-&gt;start
op_plus
(paren
id|index
op_lshift
l_int|12
)paren
op_plus
id|bytes_done
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|page_addr
op_amp
l_int|4095
)paren
op_ne
l_int|0
op_logical_or
(paren
id|bvec-&gt;bv_len
op_amp
l_int|4095
)paren
op_ne
l_int|0
)paren
singleline_comment|// More paranoia.
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
id|bio_data_dir
c_func
(paren
id|bio
)paren
op_eq
id|READ
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|page_addr
comma
(paren
r_void
op_star
)paren
id|source_addr
comma
id|bvec-&gt;bv_len
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|source_addr
comma
(paren
r_void
op_star
)paren
id|page_addr
comma
id|bvec-&gt;bv_len
)paren
suffix:semicolon
)brace
id|bytes_done
op_add_assign
id|bvec-&gt;bv_len
suffix:semicolon
)brace
id|bio_endio
c_func
(paren
id|bio
comma
id|bytes_done
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|bio_io_error
c_func
(paren
id|bio
comma
id|bytes_done
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|dcssblk_check_params
id|dcssblk_check_params
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
comma
id|i
comma
id|j
comma
id|k
suffix:semicolon
r_char
id|buf
(braket
l_int|9
)braket
suffix:semicolon
r_struct
id|dcssblk_dev_info
op_star
id|dev_info
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|DCSSBLK_PARM_LEN
)paren
op_logical_and
(paren
id|dcssblk_segments
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
id|i
suffix:semicolon
(paren
id|dcssblk_segments
(braket
id|j
)braket
op_ne
l_char|&squot;,&squot;
)paren
op_logical_and
(paren
id|dcssblk_segments
(braket
id|j
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_and
(paren
id|dcssblk_segments
(braket
id|j
)braket
op_ne
l_char|&squot;(&squot;
)paren
op_logical_and
(paren
id|j
op_minus
id|i
)paren
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|buf
(braket
id|j
op_minus
id|i
)braket
op_assign
id|dcssblk_segments
(braket
id|j
)braket
suffix:semicolon
)brace
id|buf
(braket
id|j
op_minus
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|rc
op_assign
id|dcssblk_add_store
c_func
(paren
id|dcssblk_root_dev
comma
id|buf
comma
id|j
op_minus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_ge
l_int|0
)paren
op_logical_and
(paren
id|dcssblk_segments
(braket
id|j
)braket
op_eq
l_char|&squot;(&squot;
)paren
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|buf
(braket
id|k
)braket
op_ne
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|k
op_increment
)paren
id|buf
(braket
id|k
)braket
op_assign
id|toupper
c_func
(paren
id|buf
(braket
id|k
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
op_amp
id|dcssblk_segments
(braket
id|j
)braket
comma
l_string|&quot;(local)&quot;
comma
l_int|7
)paren
)paren
(brace
id|down_read
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|dev_info
op_assign
id|dcssblk_get_device_by_name
c_func
(paren
id|buf
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_info
)paren
id|dcssblk_shared_store
c_func
(paren
op_amp
id|dev_info-&gt;dev
comma
l_string|&quot;0&bslash;n&quot;
comma
l_int|2
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|dcssblk_segments
(braket
id|j
)braket
op_ne
l_char|&squot;,&squot;
)paren
op_logical_and
(paren
id|dcssblk_segments
(braket
id|j
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
)paren
(brace
id|j
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dcssblk_segments
(braket
id|j
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
r_break
suffix:semicolon
id|i
op_assign
id|j
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The init/exit functions.&n; */
r_static
r_void
id|__exit
DECL|function|dcssblk_exit
id|dcssblk_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PRINT_DEBUG
c_func
(paren
l_string|&quot;DCSSBLOCK EXIT...&bslash;n&quot;
)paren
suffix:semicolon
id|s390_root_dev_unregister
c_func
(paren
id|dcssblk_root_dev
)paren
suffix:semicolon
id|rc
op_assign
id|unregister_blkdev
c_func
(paren
id|dcssblk_major
comma
id|DCSSBLK_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;unregister_blkdev() failed!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|PRINT_DEBUG
c_func
(paren
l_string|&quot;...finished!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|dcssblk_init
id|dcssblk_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PRINT_DEBUG
c_func
(paren
l_string|&quot;DCSSBLOCK INIT...&bslash;n&quot;
)paren
suffix:semicolon
id|dcssblk_root_dev
op_assign
id|s390_root_dev_register
c_func
(paren
l_string|&quot;dcssblk&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dcssblk_root_dev
)paren
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;device_register() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|dcssblk_root_dev
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|device_create_file
c_func
(paren
id|dcssblk_root_dev
comma
op_amp
id|dev_attr_add
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;device_create_file(add) failed!&bslash;n&quot;
)paren
suffix:semicolon
id|s390_root_dev_unregister
c_func
(paren
id|dcssblk_root_dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|device_create_file
c_func
(paren
id|dcssblk_root_dev
comma
op_amp
id|dev_attr_remove
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;device_create_file(remove) failed!&bslash;n&quot;
)paren
suffix:semicolon
id|s390_root_dev_unregister
c_func
(paren
id|dcssblk_root_dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|register_blkdev
c_func
(paren
l_int|0
comma
id|DCSSBLK_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Can&squot;t get dynamic major!&bslash;n&quot;
)paren
suffix:semicolon
id|s390_root_dev_unregister
c_func
(paren
id|dcssblk_root_dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|dcssblk_major
op_assign
id|rc
suffix:semicolon
id|init_rwsem
c_func
(paren
op_amp
id|dcssblk_devices_sem
)paren
suffix:semicolon
id|dcssblk_check_params
c_func
(paren
)paren
suffix:semicolon
id|PRINT_DEBUG
c_func
(paren
l_string|&quot;...finished!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|dcssblk_init
id|module_init
c_func
(paren
id|dcssblk_init
)paren
suffix:semicolon
DECL|variable|dcssblk_exit
id|module_exit
c_func
(paren
id|dcssblk_exit
)paren
suffix:semicolon
id|module_param_string
c_func
(paren
id|segments
comma
id|dcssblk_segments
comma
id|DCSSBLK_PARM_LEN
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|segments
comma
l_string|&quot;Name of DCSS segment(s) to be loaded, &quot;
l_string|&quot;comma-separated list, each name max. 8 chars.&bslash;n&quot;
l_string|&quot;Adding &bslash;&quot;(local)&bslash;&quot; to segment name equals echoing 0 to &quot;
l_string|&quot;/sys/devices/dcssblk/&lt;segment name&gt;/shared after loading &quot;
l_string|&quot;the segment - &bslash;n&quot;
l_string|&quot;e.g. segments=&bslash;&quot;mydcss1,mydcss2,mydcss3(local)&bslash;&quot;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
