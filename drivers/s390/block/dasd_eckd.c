multiline_comment|/* &n; * File...........: linux/drivers/s390/block/dasd_eckd.c&n; * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n;                    Carsten Otte &lt;Cotte@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 1999,2000&n;&n; * History of changes (starts July 2000)&n; * 07/11/00 Enabled rotational position sensing&n; * 07/14/00 Reorganized the format process for better ERP&n; * 07/20/00 added experimental support for 2105 control unit (ESS)&n; * 07/24/00 increased expiration time and added the missing zero&n; * 08/07/00 added some bits to define_extent for ESS support&n; * 09/20/00 added reserve and release ioctls&n; * 10/04/00 changed RW-CCWS to R/W Key and Data&n; * 10/10/00 reverted last change according to ESS exploitation&n; * 10/10/00 now dequeuing init_cqr before freeing *ouch*&n; * 26/10/00 fixed ITPM20144ASC (problems when accesing a device formatted by VIF)&n; * 01/23/01 fixed kmalloc statement in dump_sense to be GFP_ATOMIC&n; *          fixed partition handling and HDIO_GETGEO&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;&t;/* HDIO_GETGEO                      */
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/ccwcache.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#include &quot;dasd_int.h&quot;
macro_line|#include &quot;dasd_eckd.h&quot;
macro_line|#ifdef PRINTK_HEADER
DECL|macro|PRINTK_HEADER
macro_line|#undef PRINTK_HEADER
macro_line|#endif&t;&t;&t;&t;/* PRINTK_HEADER */
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER DASD_NAME&quot;(eckd):&quot;
DECL|macro|CDL_PRINTK
macro_line|#undef CDL_PRINTK
DECL|macro|ECKD_C0
mdefine_line|#define ECKD_C0(i) (i-&gt;home_bytes)
DECL|macro|ECKD_F
mdefine_line|#define ECKD_F(i) (i-&gt;formula)
DECL|macro|ECKD_F1
mdefine_line|#define ECKD_F1(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f1):(i-&gt;factors.f_0x02.f1))
DECL|macro|ECKD_F2
mdefine_line|#define ECKD_F2(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f2):(i-&gt;factors.f_0x02.f2))
DECL|macro|ECKD_F3
mdefine_line|#define ECKD_F3(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f3):(i-&gt;factors.f_0x02.f3))
DECL|macro|ECKD_F4
mdefine_line|#define ECKD_F4(i) (ECKD_F(i)==0x02?(i-&gt;factors.f_0x02.f4):0)
DECL|macro|ECKD_F5
mdefine_line|#define ECKD_F5(i) (ECKD_F(i)==0x02?(i-&gt;factors.f_0x02.f5):0)
DECL|macro|ECKD_F6
mdefine_line|#define ECKD_F6(i) (i-&gt;factor6)
DECL|macro|ECKD_F7
mdefine_line|#define ECKD_F7(i) (i-&gt;factor7)
DECL|macro|ECKD_F8
mdefine_line|#define ECKD_F8(i) (i-&gt;factor8)
DECL|variable|dasd_eckd_discipline
id|dasd_discipline_t
id|dasd_eckd_discipline
suffix:semicolon
r_typedef
r_struct
DECL|struct|dasd_eckd_private_t
id|dasd_eckd_private_t
(brace
DECL|member|rdc_data
id|dasd_eckd_characteristics_t
id|rdc_data
suffix:semicolon
DECL|member|conf_data
id|dasd_eckd_confdata_t
id|conf_data
suffix:semicolon
DECL|member|count_area
id|eckd_count_t
id|count_area
(braket
l_int|5
)braket
suffix:semicolon
DECL|member|uses_cdl
r_int
id|uses_cdl
suffix:semicolon
DECL|typedef|dasd_eckd_private_t
)brace
id|dasd_eckd_private_t
suffix:semicolon
macro_line|#ifdef CONFIG_DASD_DYNAMIC
r_static
DECL|variable|dasd_eckd_known_devices
id|devreg_t
id|dasd_eckd_known_devices
(braket
)braket
op_assign
(brace
(brace
id|ci
suffix:colon
(brace
id|hc
suffix:colon
(brace
id|ctype
suffix:colon
l_int|0x3880
comma
id|dtype
suffix:colon
l_int|3390
)brace
)brace
comma
id|flag
suffix:colon
(paren
id|DEVREG_MATCH_CU_TYPE
op_or
id|DEVREG_MATCH_DEV_TYPE
op_or
id|DEVREG_TYPE_DEVCHARS
)paren
comma
id|oper_func
suffix:colon
id|dasd_oper_handler
)brace
comma
(brace
id|ci
suffix:colon
(brace
id|hc
suffix:colon
(brace
id|ctype
suffix:colon
l_int|0x3990
)brace
)brace
comma
id|flag
suffix:colon
(paren
id|DEVREG_MATCH_CU_TYPE
op_or
id|DEVREG_TYPE_DEVCHARS
)paren
comma
id|oper_func
suffix:colon
id|dasd_oper_handler
)brace
comma
(brace
id|ci
suffix:colon
(brace
id|hc
suffix:colon
(brace
id|ctype
suffix:colon
l_int|0x2105
)brace
)brace
comma
id|flag
suffix:colon
(paren
id|DEVREG_MATCH_CU_TYPE
op_or
id|DEVREG_TYPE_DEVCHARS
)paren
comma
id|oper_func
suffix:colon
id|dasd_oper_handler
)brace
comma
(brace
id|ci
suffix:colon
(brace
id|hc
suffix:colon
(brace
id|ctype
suffix:colon
l_int|0x9343
)brace
)brace
comma
id|flag
suffix:colon
(paren
id|DEVREG_MATCH_CU_TYPE
op_or
id|DEVREG_TYPE_DEVCHARS
)paren
comma
id|oper_func
suffix:colon
id|dasd_oper_handler
)brace
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|sizes_trk0
r_int
id|sizes_trk0
(braket
)braket
op_assign
(brace
l_int|28
comma
l_int|148
comma
l_int|84
)brace
suffix:semicolon
DECL|macro|LABEL_SIZE
mdefine_line|#define LABEL_SIZE 140
r_static
r_inline
r_int
r_int
DECL|function|round_up_multiple
id|round_up_multiple
(paren
r_int
r_int
id|no
comma
r_int
r_int
id|mult
)paren
(brace
r_int
id|rem
op_assign
id|no
op_mod
id|mult
suffix:semicolon
r_return
(paren
id|rem
ques
c_cond
id|no
op_minus
id|rem
op_plus
id|mult
suffix:colon
id|no
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|ceil_quot
id|ceil_quot
(paren
r_int
r_int
id|d1
comma
r_int
r_int
id|d2
)paren
(brace
r_return
(paren
id|d1
op_plus
(paren
id|d2
op_minus
l_int|1
)paren
)paren
op_div
id|d2
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|bytes_per_record
id|bytes_per_record
(paren
id|dasd_eckd_characteristics_t
op_star
id|rdc
comma
r_int
id|kl
comma
multiline_comment|/* key length */
r_int
id|dl
multiline_comment|/* data length */
)paren
(brace
r_int
id|bpr
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|rdc-&gt;formula
)paren
(brace
r_case
l_int|0x01
suffix:colon
(brace
r_int
r_int
id|fl1
comma
id|fl2
suffix:semicolon
id|fl1
op_assign
id|round_up_multiple
(paren
id|ECKD_F2
(paren
id|rdc
)paren
op_plus
id|dl
comma
id|ECKD_F1
(paren
id|rdc
)paren
)paren
suffix:semicolon
id|fl2
op_assign
id|round_up_multiple
(paren
id|kl
ques
c_cond
id|ECKD_F2
(paren
id|rdc
)paren
op_plus
id|kl
suffix:colon
l_int|0
comma
id|ECKD_F1
(paren
id|rdc
)paren
)paren
suffix:semicolon
id|bpr
op_assign
id|fl1
op_plus
id|fl2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x02
suffix:colon
(brace
r_int
r_int
id|fl1
comma
id|fl2
comma
id|int1
comma
id|int2
suffix:semicolon
id|int1
op_assign
id|ceil_quot
(paren
id|dl
op_plus
id|ECKD_F6
(paren
id|rdc
)paren
comma
id|ECKD_F5
(paren
id|rdc
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|int2
op_assign
id|ceil_quot
(paren
id|kl
op_plus
id|ECKD_F6
(paren
id|rdc
)paren
comma
id|ECKD_F5
(paren
id|rdc
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|fl1
op_assign
id|round_up_multiple
(paren
id|ECKD_F1
(paren
id|rdc
)paren
op_star
id|ECKD_F2
(paren
id|rdc
)paren
op_plus
(paren
id|dl
op_plus
id|ECKD_F6
(paren
id|rdc
)paren
op_plus
id|ECKD_F4
(paren
id|rdc
)paren
op_star
id|int1
)paren
comma
id|ECKD_F1
(paren
id|rdc
)paren
)paren
suffix:semicolon
id|fl2
op_assign
id|round_up_multiple
(paren
id|ECKD_F1
(paren
id|rdc
)paren
op_star
id|ECKD_F3
(paren
id|rdc
)paren
op_plus
(paren
id|kl
op_plus
id|ECKD_F6
(paren
id|rdc
)paren
op_plus
id|ECKD_F4
(paren
id|rdc
)paren
op_star
id|int2
)paren
comma
id|ECKD_F1
(paren
id|rdc
)paren
)paren
suffix:semicolon
id|bpr
op_assign
id|fl1
op_plus
id|fl2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|INTERNAL_ERROR
(paren
l_string|&quot;unknown formula%d&bslash;n&quot;
comma
id|rdc-&gt;formula
)paren
suffix:semicolon
)brace
r_return
id|bpr
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|bytes_per_track
id|bytes_per_track
(paren
id|dasd_eckd_characteristics_t
op_star
id|rdc
)paren
(brace
r_return
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|rdc-&gt;byte_per_track
)paren
op_rshift
l_int|8
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|recs_per_track
id|recs_per_track
(paren
id|dasd_eckd_characteristics_t
op_star
id|rdc
comma
r_int
r_int
id|kl
comma
r_int
r_int
id|dl
)paren
(brace
r_int
id|rpt
op_assign
l_int|0
suffix:semicolon
r_int
id|dn
suffix:semicolon
r_switch
c_cond
(paren
id|rdc-&gt;dev_type
)paren
(brace
r_case
l_int|0x3380
suffix:colon
r_if
c_cond
(paren
id|kl
)paren
r_return
l_int|1499
op_div
(paren
l_int|15
op_plus
l_int|7
op_plus
id|ceil_quot
(paren
id|kl
op_plus
l_int|12
comma
l_int|32
)paren
op_plus
id|ceil_quot
(paren
id|dl
op_plus
l_int|12
comma
l_int|32
)paren
)paren
suffix:semicolon
r_else
r_return
l_int|1499
op_div
(paren
l_int|15
op_plus
id|ceil_quot
(paren
id|dl
op_plus
l_int|12
comma
l_int|32
)paren
)paren
suffix:semicolon
r_case
l_int|0x3390
suffix:colon
id|dn
op_assign
id|ceil_quot
(paren
id|dl
op_plus
l_int|6
comma
l_int|232
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|kl
)paren
(brace
r_int
id|kn
op_assign
id|ceil_quot
(paren
id|kl
op_plus
l_int|6
comma
l_int|232
)paren
op_plus
l_int|1
suffix:semicolon
r_return
l_int|1729
op_div
(paren
l_int|10
op_plus
l_int|9
op_plus
id|ceil_quot
(paren
id|kl
op_plus
l_int|6
op_star
id|kn
comma
l_int|34
)paren
op_plus
l_int|9
op_plus
id|ceil_quot
(paren
id|dl
op_plus
l_int|6
op_star
id|dn
comma
l_int|34
)paren
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|1729
op_div
(paren
l_int|10
op_plus
l_int|9
op_plus
id|ceil_quot
(paren
id|dl
op_plus
l_int|6
op_star
id|dn
comma
l_int|34
)paren
)paren
suffix:semicolon
r_case
l_int|0x9345
suffix:colon
id|dn
op_assign
id|ceil_quot
(paren
id|dl
op_plus
l_int|6
comma
l_int|232
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|kl
)paren
(brace
r_int
id|kn
op_assign
id|ceil_quot
(paren
id|kl
op_plus
l_int|6
comma
l_int|232
)paren
op_plus
l_int|1
suffix:semicolon
r_return
l_int|1420
op_div
(paren
l_int|18
op_plus
l_int|7
op_plus
id|ceil_quot
(paren
id|kl
op_plus
l_int|6
op_star
id|kn
comma
l_int|34
)paren
op_plus
id|ceil_quot
(paren
id|dl
op_plus
l_int|6
op_star
id|dn
comma
l_int|34
)paren
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|1420
op_div
(paren
l_int|18
op_plus
l_int|7
op_plus
id|ceil_quot
(paren
id|dl
op_plus
l_int|6
op_star
id|dn
comma
l_int|34
)paren
)paren
suffix:semicolon
)brace
r_return
id|rpt
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|define_extent
id|define_extent
(paren
id|ccw1_t
op_star
id|de_ccw
comma
id|DE_eckd_data_t
op_star
id|data
comma
r_int
id|trk
comma
r_int
id|totrk
comma
r_int
id|cmd
comma
id|dasd_device_t
op_star
id|device
comma
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|ch_t
id|geo
comma
id|beg
comma
id|end
suffix:semicolon
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|geo.cyl
op_assign
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
suffix:semicolon
id|geo.head
op_assign
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
id|beg.cyl
op_assign
id|trk
op_div
id|geo.head
suffix:semicolon
id|beg.head
op_assign
id|trk
op_mod
id|geo.head
suffix:semicolon
id|end.cyl
op_assign
id|totrk
op_div
id|geo.head
suffix:semicolon
id|end.head
op_assign
id|totrk
op_mod
id|geo.head
suffix:semicolon
id|memset
(paren
id|de_ccw
comma
l_int|0
comma
r_sizeof
(paren
id|ccw1_t
)paren
)paren
suffix:semicolon
id|de_ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_DEFINE_EXTENT
suffix:semicolon
id|de_ccw-&gt;count
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dasd_set_normalized_cda
(paren
id|de_ccw
comma
id|__pa
(paren
id|data
)paren
comma
id|cqr
comma
id|device
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
id|memset
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
id|DE_eckd_data_t
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DASD_ECKD_CCW_READ_HOME_ADDRESS
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_RECORD_ZERO
suffix:colon
r_case
id|DASD_ECKD_CCW_READ
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_CKD
suffix:colon
multiline_comment|/* Fallthrough */
r_case
id|DASD_ECKD_CCW_READ_CKD_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_KD
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_KD_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_COUNT
suffix:colon
id|data-&gt;mask.perm
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;attributes.operation
op_assign
l_int|0x3
suffix:semicolon
multiline_comment|/* enable seq. caching */
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_KD
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_KD_MT
suffix:colon
id|data-&gt;mask.perm
op_assign
l_int|0x02
suffix:semicolon
id|data-&gt;attributes.operation
op_assign
l_int|0x3
suffix:semicolon
multiline_comment|/* enable seq. caching */
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE_CKD
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_CKD_MT
suffix:colon
id|data-&gt;attributes.operation
op_assign
l_int|0x1
suffix:semicolon
multiline_comment|/* format through cache */
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_ERASE
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_HOME_ADDRESS
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
suffix:colon
id|data-&gt;mask.perm
op_assign
l_int|0x3
suffix:semicolon
id|data-&gt;mask.auth
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;attributes.operation
op_assign
l_int|0x1
suffix:semicolon
multiline_comment|/* format through cache */
r_break
suffix:semicolon
r_default
suffix:colon
id|INTERNAL_ERROR
(paren
l_string|&quot;unknown opcode 0x%x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data-&gt;attributes.mode
op_assign
l_int|0x3
suffix:semicolon
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|rdc_data.cu_type
op_eq
l_int|0x2105
op_logical_and
op_logical_neg
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_logical_and
id|trk
OL
l_int|2
)paren
)paren
(brace
id|data-&gt;reserved
op_or_assign
l_int|0x40
suffix:semicolon
)brace
id|data-&gt;beg_ext.cyl
op_assign
id|beg.cyl
suffix:semicolon
id|data-&gt;beg_ext.head
op_assign
id|beg.head
suffix:semicolon
id|data-&gt;end_ext.cyl
op_assign
id|end.cyl
suffix:semicolon
id|data-&gt;end_ext.head
op_assign
id|end.head
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|locate_record
id|locate_record
(paren
id|ccw1_t
op_star
id|lo_ccw
comma
id|LO_eckd_data_t
op_star
id|data
comma
r_int
id|trk
comma
r_int
id|rec_on_trk
comma
r_int
id|no_rec
comma
r_int
id|cmd
comma
id|dasd_device_t
op_star
id|device
comma
r_int
id|reclen
comma
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|ch_t
id|geo
op_assign
(brace
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
comma
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
)brace
suffix:semicolon
id|ch_t
id|seek
op_assign
(brace
id|trk
op_div
(paren
id|geo.head
)paren
comma
id|trk
op_mod
(paren
id|geo.head
)paren
)brace
suffix:semicolon
r_int
id|sector
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CDL_PRINTK
id|printk
(paren
l_string|&quot;Locate: trk %d, rec %d, no_rec %d, cmd %d, reclen %d&bslash;n&quot;
comma
id|trk
comma
id|rec_on_trk
comma
id|no_rec
comma
id|cmd
comma
id|reclen
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
id|lo_ccw
comma
l_int|0
comma
r_sizeof
(paren
id|ccw1_t
)paren
)paren
suffix:semicolon
id|lo_ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_LOCATE_RECORD
suffix:semicolon
id|lo_ccw-&gt;count
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dasd_set_normalized_cda
(paren
id|lo_ccw
comma
id|__pa
(paren
id|data
)paren
comma
id|cqr
comma
id|device
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
id|memset
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
id|LO_eckd_data_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec_on_trk
)paren
(brace
r_switch
c_cond
(paren
r_private
op_member_access_from_pointer
id|rdc_data.dev_type
)paren
(brace
r_case
l_int|0x3390
suffix:colon
(brace
r_int
id|dn
comma
id|d
suffix:semicolon
id|dn
op_assign
id|ceil_quot
(paren
id|reclen
op_plus
l_int|6
comma
l_int|232
)paren
suffix:semicolon
id|d
op_assign
l_int|9
op_plus
id|ceil_quot
(paren
id|reclen
op_plus
l_int|6
op_star
(paren
id|dn
op_plus
l_int|1
)paren
comma
l_int|34
)paren
suffix:semicolon
id|sector
op_assign
(paren
l_int|49
op_plus
(paren
id|rec_on_trk
op_minus
l_int|1
)paren
op_star
(paren
l_int|10
op_plus
id|d
)paren
)paren
op_div
l_int|8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x3380
suffix:colon
(brace
r_int
id|d
suffix:semicolon
id|d
op_assign
l_int|7
op_plus
id|ceil_quot
(paren
id|reclen
op_plus
l_int|12
comma
l_int|32
)paren
suffix:semicolon
id|sector
op_assign
(paren
l_int|39
op_plus
(paren
id|rec_on_trk
op_minus
l_int|1
)paren
op_star
(paren
l_int|8
op_plus
id|d
)paren
)paren
op_div
l_int|7
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x9345
suffix:colon
r_default
suffix:colon
id|sector
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|data-&gt;sector
op_assign
id|sector
suffix:semicolon
id|data-&gt;count
op_assign
id|no_rec
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DASD_ECKD_CCW_WRITE_HOME_ADDRESS
suffix:colon
id|data-&gt;operation.orientation
op_assign
l_int|0x3
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ_HOME_ADDRESS
suffix:colon
id|data-&gt;operation.orientation
op_assign
l_int|0x3
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
suffix:colon
id|data-&gt;operation.orientation
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x03
suffix:semicolon
id|data-&gt;count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ_RECORD_ZERO
suffix:colon
id|data-&gt;operation.orientation
op_assign
l_int|0x3
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x16
suffix:semicolon
id|data-&gt;count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_KD
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_KD_MT
suffix:colon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE_CKD
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_CKD_MT
suffix:colon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_KD
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_KD_MT
suffix:colon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ_CKD
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_CKD_MT
suffix:colon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ_COUNT
suffix:colon
id|data-&gt;operation.operation
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_ERASE
suffix:colon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x0b
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|INTERNAL_ERROR
(paren
l_string|&quot;unknown opcode 0x%x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
)brace
id|memcpy
(paren
op_amp
(paren
id|data-&gt;seek_addr
)paren
comma
op_amp
id|seek
comma
r_sizeof
(paren
id|ch_t
)paren
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
(paren
id|data-&gt;search_arg
)paren
comma
op_amp
id|seek
comma
r_sizeof
(paren
id|ch_t
)paren
)paren
suffix:semicolon
id|data-&gt;search_arg.record
op_assign
id|rec_on_trk
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_id_check
id|dasd_eckd_id_check
(paren
id|s390_dev_info_t
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;sid_data.cu_type
op_eq
l_int|0x3990
op_logical_or
id|info-&gt;sid_data.cu_type
op_eq
l_int|0x2105
)paren
r_if
c_cond
(paren
id|info-&gt;sid_data.dev_type
op_eq
l_int|0x3390
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;sid_data.cu_type
op_eq
l_int|0x3990
op_logical_or
id|info-&gt;sid_data.cu_type
op_eq
l_int|0x2105
)paren
r_if
c_cond
(paren
id|info-&gt;sid_data.dev_type
op_eq
l_int|0x3380
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;sid_data.cu_type
op_eq
l_int|0x9343
)paren
r_if
c_cond
(paren
id|info-&gt;sid_data.dev_type
op_eq
l_int|0x9345
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_check_characteristics
id|dasd_eckd_check_characteristics
(paren
r_struct
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_void
op_star
id|conf_data
suffix:semicolon
r_void
op_star
id|rdc_data
suffix:semicolon
r_int
id|conf_len
suffix:semicolon
id|dasd_eckd_private_t
op_star
r_private
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Null device pointer passed to characteristics checker&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|device
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|dasd_eckd_private_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;memory allocation failed for private data&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|rdc_data
op_assign
(paren
r_void
op_star
)paren
op_amp
(paren
r_private
op_member_access_from_pointer
id|rdc_data
)paren
suffix:semicolon
id|rc
op_assign
id|read_dev_chars
(paren
id|device-&gt;devinfo.irq
comma
op_amp
id|rdc_data
comma
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Read device characteristics returned error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;%04X on sch %d: %04X/%02X(CU:%04X/%02X) &quot;
l_string|&quot;Cyl:%d Head:%d Sec:%d&bslash;n&quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;devinfo.irq
comma
r_private
op_member_access_from_pointer
id|rdc_data.dev_type
comma
r_private
op_member_access_from_pointer
id|rdc_data.dev_model
comma
r_private
op_member_access_from_pointer
id|rdc_data.cu_type
comma
r_private
op_member_access_from_pointer
id|rdc_data.cu_model.model
comma
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
comma
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
comma
r_private
op_member_access_from_pointer
id|rdc_data.sec_per_trk
)paren
suffix:semicolon
id|rc
op_assign
id|read_conf_data
(paren
id|device-&gt;devinfo.irq
comma
op_amp
id|conf_data
comma
op_amp
id|conf_len
comma
id|LPM_ANYPATH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EOPNOTSUPP
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this one is ok */
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Read configuration data returned error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf_data
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No configuration data retrieved&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
multiline_comment|/* no errror */
)brace
r_if
c_cond
(paren
id|conf_len
op_ne
r_sizeof
(paren
id|dasd_eckd_confdata_t
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;sizes of configuration data mismatch&quot;
l_string|&quot;%d (read) vs %ld (expected)&bslash;n&quot;
comma
id|conf_len
comma
r_sizeof
(paren
id|dasd_eckd_confdata_t
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
multiline_comment|/* no errror */
)brace
id|memcpy
(paren
op_amp
r_private
op_member_access_from_pointer
id|conf_data
comma
id|conf_data
comma
r_sizeof
(paren
id|dasd_eckd_confdata_t
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;%04X on sch %d: %04X/%02X(CU:%04X/%02X): &quot;
l_string|&quot;Configuration data read&bslash;n&quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;devinfo.irq
comma
r_private
op_member_access_from_pointer
id|rdc_data.dev_type
comma
r_private
op_member_access_from_pointer
id|rdc_data.dev_model
comma
r_private
op_member_access_from_pointer
id|rdc_data.cu_type
comma
r_private
op_member_access_from_pointer
id|rdc_data.cu_model.model
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|fail
suffix:colon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|kfree
(paren
id|device
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|device
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|dasd_eckd_cdl_reclen
id|dasd_eckd_cdl_reclen
(paren
id|dasd_device_t
op_star
id|device
comma
r_int
id|recid
)paren
(brace
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|byt_per_blk
op_assign
id|device-&gt;sizes.bp_block
suffix:semicolon
r_int
id|blk_per_trk
op_assign
id|recs_per_track
(paren
op_amp
(paren
r_private
op_member_access_from_pointer
id|rdc_data
)paren
comma
l_int|0
comma
id|byt_per_blk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
l_int|3
)paren
r_return
id|sizes_trk0
(braket
id|recid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
id|blk_per_trk
)paren
r_return
id|byt_per_blk
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
l_int|2
op_star
id|blk_per_trk
)paren
r_return
id|LABEL_SIZE
suffix:semicolon
r_return
id|byt_per_blk
suffix:semicolon
)brace
r_static
id|ccw_req_t
op_star
DECL|function|dasd_eckd_init_analysis
id|dasd_eckd_init_analysis
(paren
r_struct
id|dasd_device_t
op_star
id|device
)paren
(brace
id|ccw_req_t
op_star
id|cqr
op_assign
l_int|NULL
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|DE_eckd_data_t
op_star
id|DE_data
suffix:semicolon
id|LO_eckd_data_t
op_star
id|LO_data
suffix:semicolon
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|eckd_count_t
op_star
id|count_data
op_assign
r_private
op_member_access_from_pointer
id|count_area
suffix:semicolon
id|cqr
op_assign
id|dasd_alloc_request
(paren
id|dasd_eckd_discipline.name
comma
l_int|8
op_plus
l_int|1
comma
r_sizeof
(paren
id|DE_eckd_data_t
)paren
op_plus
l_int|2
op_star
r_sizeof
(paren
id|LO_eckd_data_t
)paren
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No memory to allocate initialization request&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|DE_data
op_assign
id|cqr-&gt;data
suffix:semicolon
id|LO_data
op_assign
id|cqr-&gt;data
op_plus
r_sizeof
(paren
id|DE_eckd_data_t
)paren
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
r_if
c_cond
(paren
id|define_extent
(paren
id|ccw
comma
id|DE_data
comma
l_int|0
comma
l_int|2
comma
id|DASD_ECKD_CCW_READ_COUNT
comma
id|device
comma
id|cqr
)paren
)paren
(brace
r_goto
id|clear_cqr
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|locate_record
(paren
id|ccw
comma
id|LO_data
op_increment
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
id|DASD_ECKD_CCW_READ_COUNT
comma
id|device
comma
l_int|0
comma
id|cqr
)paren
)paren
(brace
r_goto
id|clear_cqr
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_READ_COUNT
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|count_data
op_increment
)paren
comma
id|cqr
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_cqr
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_READ_COUNT
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|count_data
op_increment
)paren
comma
id|cqr
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_cqr
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_READ_COUNT
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|count_data
op_increment
)paren
comma
id|cqr
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_cqr
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_READ_COUNT
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|count_data
op_increment
)paren
comma
id|cqr
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_cqr
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|locate_record
(paren
id|ccw
comma
id|LO_data
op_increment
comma
l_int|2
comma
l_int|0
comma
l_int|1
comma
id|DASD_ECKD_CCW_READ_COUNT
comma
id|device
comma
l_int|0
comma
id|cqr
)paren
)paren
(brace
r_goto
id|clear_cqr
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_READ_COUNT
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|count_data
)paren
comma
id|cqr
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_cqr
suffix:semicolon
)brace
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
id|dasd_chanq_enq
(paren
op_amp
id|device-&gt;queue
comma
id|cqr
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|clear_cqr
suffix:colon
id|dasd_free_request
(paren
id|cqr
comma
id|device
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No memory to allocate initialization request&bslash;n&quot;
)paren
suffix:semicolon
id|cqr
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
r_return
id|cqr
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_do_analysis
id|dasd_eckd_do_analysis
(paren
r_struct
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|sb
comma
id|rpt
suffix:semicolon
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|eckd_count_t
op_star
id|count_area
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|cdl_msg
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
r_private
op_member_access_from_pointer
id|uses_cdl
op_assign
l_int|1
suffix:semicolon
id|status
op_assign
id|device-&gt;init_cqr-&gt;status
suffix:semicolon
id|dasd_chanq_deq
(paren
op_amp
id|device-&gt;queue
comma
id|device-&gt;init_cqr
)paren
suffix:semicolon
id|dasd_free_request
(paren
id|device-&gt;init_cqr
comma
id|device
)paren
suffix:semicolon
multiline_comment|/* Free the cqr and cleanup device-&gt;sizes */
r_if
c_cond
(paren
id|status
op_ne
id|CQR_STATUS_DONE
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;volume analysis returned fatal error&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EMEDIUMTYPE
suffix:semicolon
)brace
multiline_comment|/* Check Track 0 for Compatible Disk Layout */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
OL
l_int|3
)paren
op_logical_and
(paren
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
id|i
)braket
dot
id|kl
op_ne
l_int|4
)paren
op_logical_or
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
id|i
)braket
dot
id|dl
op_ne
id|dasd_eckd_cdl_reclen
(paren
id|device
comma
id|i
)paren
op_minus
l_int|4
)paren
)paren
)paren
(brace
r_private
op_member_access_from_pointer
id|uses_cdl
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|3
)paren
(brace
id|count_area
op_assign
op_amp
r_private
op_member_access_from_pointer
id|count_area
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
id|i
)braket
dot
id|kl
op_ne
l_int|0
)paren
op_logical_or
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
id|i
)braket
dot
id|dl
op_ne
r_private
op_member_access_from_pointer
id|count_area
(braket
l_int|0
)braket
dot
id|dl
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|5
)paren
(brace
id|count_area
op_assign
op_amp
r_private
op_member_access_from_pointer
id|count_area
(braket
l_int|0
)braket
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
l_int|3
)braket
dot
id|record
op_eq
l_int|1
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Trk 0: no records after VTOC!&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|count_area
op_ne
l_int|NULL
op_logical_and
multiline_comment|/* we found notthing violating our disk layout */
id|count_area-&gt;kl
op_eq
l_int|0
)paren
(brace
multiline_comment|/* find out blocksize */
r_switch
c_cond
(paren
id|count_area-&gt;dl
)paren
(brace
r_case
l_int|512
suffix:colon
r_case
l_int|1024
suffix:colon
r_case
l_int|2048
suffix:colon
r_case
l_int|4096
suffix:colon
id|device-&gt;sizes.bp_block
op_assign
id|count_area-&gt;dl
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|device-&gt;sizes.bp_block
op_eq
l_int|0
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Volume has incompatible disk layout&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EMEDIUMTYPE
suffix:semicolon
)brace
id|device-&gt;sizes.s2b_shift
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* bits to shift 512 to get a block */
id|device-&gt;sizes.pt_block
op_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|sb
op_assign
l_int|512
suffix:semicolon
id|sb
OL
id|device-&gt;sizes.bp_block
suffix:semicolon
id|sb
op_assign
id|sb
op_lshift
l_int|1
)paren
id|device-&gt;sizes.s2b_shift
op_increment
suffix:semicolon
id|rpt
op_assign
id|recs_per_track
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|device-&gt;sizes.bp_block
)paren
suffix:semicolon
id|device-&gt;sizes.blocks
op_assign
(paren
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_star
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
op_star
id|recs_per_track
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|device-&gt;sizes.bp_block
)paren
)paren
suffix:semicolon
id|cdl_msg
op_assign
r_private
op_member_access_from_pointer
id|uses_cdl
ques
c_cond
l_string|&quot;compatible disk layout&quot;
suffix:colon
l_string|&quot;classic disk layout&quot;
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;(%dkB blks): %dkB at %dkB/trk %s&quot;
comma
(paren
id|device-&gt;sizes.bp_block
op_rshift
l_int|10
)paren
comma
(paren
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_star
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
op_star
id|recs_per_track
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|device-&gt;sizes.bp_block
)paren
op_star
(paren
id|device-&gt;sizes.bp_block
op_rshift
l_int|9
)paren
)paren
op_rshift
l_int|1
comma
(paren
id|recs_per_track
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|device-&gt;sizes.bp_block
)paren
op_star
id|device-&gt;sizes.bp_block
)paren
op_rshift
l_int|10
comma
id|cdl_msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_fill_geometry
id|dasd_eckd_fill_geometry
(paren
r_struct
id|dasd_device_t
op_star
id|device
comma
r_struct
id|hd_geometry
op_star
id|geo
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_switch
c_cond
(paren
id|device-&gt;sizes.bp_block
)paren
(brace
r_case
l_int|512
suffix:colon
r_case
l_int|1024
suffix:colon
r_case
l_int|2048
suffix:colon
r_case
l_int|4096
suffix:colon
id|geo-&gt;sectors
op_assign
id|recs_per_track
(paren
op_amp
(paren
r_private
op_member_access_from_pointer
id|rdc_data
)paren
comma
l_int|0
comma
id|device-&gt;sizes.bp_block
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|geo-&gt;cylinders
op_assign
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
suffix:semicolon
id|geo-&gt;heads
op_assign
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
id|ccw_req_t
op_star
DECL|function|dasd_eckd_format_device
id|dasd_eckd_format_device
(paren
id|dasd_device_t
op_star
id|device
comma
id|format_data_t
op_star
id|fdata
)paren
(brace
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|fcp
op_assign
l_int|NULL
suffix:semicolon
id|DE_eckd_data_t
op_star
id|DE_data
op_assign
l_int|NULL
suffix:semicolon
id|LO_eckd_data_t
op_star
id|LO_data
op_assign
l_int|NULL
suffix:semicolon
id|eckd_count_t
op_star
id|ct_data
op_assign
l_int|NULL
suffix:semicolon
id|eckd_count_t
op_star
id|r0_data
op_assign
l_int|NULL
suffix:semicolon
id|eckd_home_t
op_star
id|ha_data
op_assign
l_int|NULL
suffix:semicolon
id|ccw1_t
op_star
id|last_ccw
op_assign
l_int|NULL
suffix:semicolon
r_void
op_star
id|last_data
op_assign
l_int|NULL
suffix:semicolon
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|rpt
op_assign
id|recs_per_track
(paren
op_amp
(paren
r_private
op_member_access_from_pointer
id|rdc_data
)paren
comma
l_int|0
comma
id|fdata-&gt;blksize
)paren
suffix:semicolon
r_int
id|cyl
op_assign
id|fdata-&gt;start_unit
op_div
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
r_int
id|head
op_assign
id|fdata-&gt;start_unit
op_mod
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
r_int
id|wrccws
op_assign
id|rpt
suffix:semicolon
r_int
id|datasize
op_assign
r_sizeof
(paren
id|DE_eckd_data_t
)paren
op_plus
r_sizeof
(paren
id|LO_eckd_data_t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fdata-&gt;start_unit
op_ge
(paren
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_star
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
)paren
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;Track no %d too big!&quot;
comma
id|fdata-&gt;start_unit
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fdata-&gt;start_unit
OG
id|fdata-&gt;stop_unit
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;Track %d reached! ending.&quot;
comma
id|fdata-&gt;start_unit
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|fdata-&gt;blksize
)paren
(brace
r_case
l_int|512
suffix:colon
r_case
l_int|1024
suffix:colon
r_case
l_int|2048
suffix:colon
r_case
l_int|4096
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Invalid blocksize %d...terminating!&bslash;n&quot;
comma
id|fdata-&gt;blksize
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|fdata-&gt;intensity
)paren
(brace
r_case
l_int|0x00
suffix:colon
r_case
l_int|0x01
suffix:colon
r_case
l_int|0x03
suffix:colon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* make track invalid */
r_case
l_int|0x08
suffix:colon
r_case
l_int|0x09
suffix:colon
r_case
l_int|0x0b
suffix:colon
r_case
l_int|0x0c
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Invalid flags 0x%x...terminating!&bslash;n&quot;
comma
id|fdata-&gt;intensity
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* print status line */
r_if
c_cond
(paren
(paren
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
OL
l_int|20
)paren
ques
c_cond
(paren
id|fdata-&gt;start_unit
op_mod
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_eq
l_int|0
)paren
suffix:colon
(paren
id|fdata-&gt;start_unit
op_mod
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_eq
l_int|0
op_logical_and
(paren
id|fdata-&gt;start_unit
op_div
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
)paren
op_mod
(paren
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_div
l_int|20
)paren
)paren
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;Format Cylinder: %d Flags: %d&quot;
comma
id|fdata-&gt;start_unit
op_div
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
comma
id|fdata-&gt;intensity
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|fdata-&gt;intensity
op_amp
op_complement
l_int|0x8
)paren
op_amp
l_int|0x04
)paren
(brace
id|wrccws
op_assign
l_int|1
suffix:semicolon
id|rpt
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x1
)paren
(brace
id|wrccws
op_increment
suffix:semicolon
id|datasize
op_add_assign
r_sizeof
(paren
id|eckd_count_t
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x2
)paren
(brace
id|wrccws
op_increment
suffix:semicolon
id|datasize
op_add_assign
r_sizeof
(paren
id|eckd_home_t
)paren
suffix:semicolon
)brace
)brace
id|fcp
op_assign
id|dasd_alloc_request
(paren
id|dasd_eckd_discipline.name
comma
id|wrccws
op_plus
l_int|2
op_plus
l_int|1
comma
id|datasize
op_plus
id|rpt
op_star
r_sizeof
(paren
id|eckd_count_t
)paren
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fcp
op_ne
l_int|NULL
)paren
(brace
id|fcp-&gt;device
op_assign
id|device
suffix:semicolon
id|fcp-&gt;retries
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* set retry counter to enable ERP */
id|last_data
op_assign
id|fcp-&gt;data
suffix:semicolon
id|DE_data
op_assign
(paren
id|DE_eckd_data_t
op_star
)paren
id|last_data
suffix:semicolon
id|last_data
op_assign
(paren
r_void
op_star
)paren
(paren
id|DE_data
op_plus
l_int|1
)paren
suffix:semicolon
id|LO_data
op_assign
(paren
id|LO_eckd_data_t
op_star
)paren
id|last_data
suffix:semicolon
id|last_data
op_assign
(paren
r_void
op_star
)paren
(paren
id|LO_data
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x2
)paren
(brace
id|ha_data
op_assign
(paren
id|eckd_home_t
op_star
)paren
id|last_data
suffix:semicolon
id|last_data
op_assign
(paren
r_void
op_star
)paren
(paren
id|ha_data
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x1
)paren
(brace
id|r0_data
op_assign
(paren
id|eckd_count_t
op_star
)paren
id|last_data
suffix:semicolon
id|last_data
op_assign
(paren
r_void
op_star
)paren
(paren
id|r0_data
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|ct_data
op_assign
(paren
id|eckd_count_t
op_star
)paren
id|last_data
suffix:semicolon
id|last_ccw
op_assign
id|fcp-&gt;cpaddr
suffix:semicolon
r_switch
c_cond
(paren
id|fdata-&gt;intensity
op_amp
op_complement
l_int|0x08
)paren
(brace
r_case
l_int|0x03
suffix:colon
r_if
c_cond
(paren
id|define_extent
(paren
id|last_ccw
comma
id|DE_data
comma
id|fdata-&gt;start_unit
comma
id|fdata-&gt;start_unit
comma
id|DASD_ECKD_CCW_WRITE_HOME_ADDRESS
comma
id|device
comma
id|fcp
)paren
)paren
(brace
r_goto
id|clear_fcp
suffix:semicolon
)brace
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|last_ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|locate_record
(paren
id|last_ccw
comma
id|LO_data
comma
id|fdata-&gt;start_unit
comma
l_int|0
comma
id|wrccws
comma
id|DASD_ECKD_CCW_WRITE_HOME_ADDRESS
comma
id|device
comma
id|device-&gt;sizes.bp_block
comma
id|fcp
)paren
)paren
(brace
r_goto
id|clear_fcp
suffix:semicolon
)brace
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|last_ccw
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
r_if
c_cond
(paren
id|define_extent
(paren
id|last_ccw
comma
id|DE_data
comma
id|fdata-&gt;start_unit
comma
id|fdata-&gt;start_unit
comma
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
comma
id|device
comma
id|fcp
)paren
)paren
(brace
r_goto
id|clear_fcp
suffix:semicolon
)brace
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|last_ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|locate_record
(paren
id|last_ccw
comma
id|LO_data
comma
id|fdata-&gt;start_unit
comma
l_int|0
comma
id|wrccws
comma
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
comma
id|device
comma
id|device-&gt;sizes.bp_block
comma
id|fcp
)paren
)paren
(brace
r_goto
id|clear_fcp
suffix:semicolon
)brace
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|last_ccw
op_increment
suffix:semicolon
id|memset
(paren
id|r0_data
comma
l_int|0
comma
r_sizeof
(paren
id|eckd_count_t
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|fdata-&gt;blksize
op_assign
l_int|8
suffix:semicolon
r_case
l_int|0x00
suffix:colon
r_if
c_cond
(paren
id|define_extent
(paren
id|last_ccw
comma
id|DE_data
comma
id|fdata-&gt;start_unit
comma
id|fdata-&gt;start_unit
comma
id|DASD_ECKD_CCW_WRITE_CKD
comma
id|device
comma
id|fcp
)paren
)paren
(brace
id|dasd_free_request
(paren
id|fcp
comma
id|device
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|last_ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|locate_record
(paren
id|last_ccw
comma
id|LO_data
comma
id|fdata-&gt;start_unit
comma
l_int|0
comma
id|wrccws
comma
id|DASD_ECKD_CCW_WRITE_CKD
comma
id|device
comma
id|fdata-&gt;blksize
comma
id|fcp
)paren
)paren
(brace
r_goto
id|clear_fcp
suffix:semicolon
)brace
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|last_ccw
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_WARN
(paren
l_string|&quot;Unknown format flags...%d&bslash;n&quot;
comma
id|fdata-&gt;intensity
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x02
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Unsupported format flag...%d&bslash;n&quot;
comma
id|fdata-&gt;intensity
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* write record zero */
id|r0_data-&gt;cyl
op_assign
id|cyl
suffix:semicolon
id|r0_data-&gt;head
op_assign
id|head
suffix:semicolon
id|r0_data-&gt;record
op_assign
l_int|0
suffix:semicolon
id|r0_data-&gt;kl
op_assign
l_int|0
suffix:semicolon
id|r0_data-&gt;dl
op_assign
l_int|8
suffix:semicolon
id|last_ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
suffix:semicolon
id|last_ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|last_ccw
comma
id|__pa
(paren
id|r0_data
)paren
comma
id|fcp
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_fcp
suffix:semicolon
)brace
id|last_ccw
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|fdata-&gt;intensity
op_amp
op_complement
l_int|0x08
)paren
op_amp
l_int|0x04
)paren
(brace
multiline_comment|/* erase track */
id|memset
(paren
id|ct_data
comma
l_int|0
comma
r_sizeof
(paren
id|eckd_count_t
)paren
)paren
suffix:semicolon
id|ct_data-&gt;cyl
op_assign
id|cyl
suffix:semicolon
id|ct_data-&gt;head
op_assign
id|head
suffix:semicolon
id|ct_data-&gt;record
op_assign
l_int|1
suffix:semicolon
id|ct_data-&gt;kl
op_assign
l_int|0
suffix:semicolon
id|ct_data-&gt;dl
op_assign
l_int|0
suffix:semicolon
id|last_ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_WRITE_CKD
suffix:semicolon
id|last_ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|last_ccw
comma
id|__pa
(paren
id|ct_data
)paren
comma
id|fcp
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_fcp
suffix:semicolon
)brace
id|last_ccw
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* write remaining records */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rpt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
(paren
id|ct_data
op_plus
id|i
comma
l_int|0
comma
r_sizeof
(paren
id|eckd_count_t
)paren
)paren
suffix:semicolon
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|cyl
op_assign
id|cyl
suffix:semicolon
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|head
op_assign
id|head
suffix:semicolon
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|record
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|kl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x08
)paren
(brace
singleline_comment|// special handling when formatting CDL
r_switch
c_cond
(paren
id|fdata-&gt;start_unit
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|kl
op_assign
l_int|4
suffix:semicolon
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|dl
op_assign
id|sizes_trk0
(braket
id|i
)braket
op_minus
l_int|4
suffix:semicolon
)brace
r_else
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|dl
op_assign
id|fdata-&gt;blksize
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|kl
op_assign
l_int|44
suffix:semicolon
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|dl
op_assign
id|LABEL_SIZE
op_minus
l_int|44
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|dl
op_assign
id|fdata-&gt;blksize
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(paren
id|ct_data
op_plus
id|i
)paren
op_member_access_from_pointer
id|dl
op_assign
id|fdata-&gt;blksize
suffix:semicolon
id|last_ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_WRITE_CKD
suffix:semicolon
id|last_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
suffix:semicolon
id|last_ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|last_ccw
comma
id|__pa
(paren
id|ct_data
op_plus
id|i
)paren
comma
id|fcp
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_fcp
suffix:semicolon
)brace
id|last_ccw
op_increment
suffix:semicolon
)brace
)brace
(paren
id|last_ccw
op_minus
l_int|1
)paren
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
(paren
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_DC
)paren
suffix:semicolon
id|fcp-&gt;device
op_assign
id|device
suffix:semicolon
id|fcp-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
id|clear_fcp
suffix:colon
id|dasd_free_request
(paren
id|fcp
comma
id|device
)paren
suffix:semicolon
id|fcp
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
r_return
id|fcp
suffix:semicolon
)brace
r_static
id|dasd_era_t
DECL|function|dasd_eckd_examine_error
id|dasd_eckd_examine_error
(paren
id|ccw_req_t
op_star
id|cqr
comma
id|devstat_t
op_star
id|stat
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
(paren
id|dasd_device_t
op_star
)paren
id|cqr-&gt;device
suffix:semicolon
r_if
c_cond
(paren
id|stat-&gt;cstat
op_eq
l_int|0x00
op_logical_and
id|stat-&gt;dstat
op_eq
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
r_return
id|dasd_era_none
suffix:semicolon
r_switch
c_cond
(paren
id|device-&gt;devinfo.sid_data.cu_type
)paren
(brace
r_case
l_int|0x3990
suffix:colon
r_case
l_int|0x2105
suffix:colon
r_return
id|dasd_3990_erp_examine
(paren
id|cqr
comma
id|stat
)paren
suffix:semicolon
r_case
l_int|0x9343
suffix:colon
r_return
id|dasd_9343_erp_examine
(paren
id|cqr
comma
id|stat
)paren
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;default (unknown CU type) - RECOVERABLE return &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|dasd_era_recover
suffix:semicolon
)brace
)brace
r_static
id|dasd_erp_action_fn_t
DECL|function|dasd_eckd_erp_action
id|dasd_eckd_erp_action
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
(paren
id|dasd_device_t
op_star
)paren
id|cqr-&gt;device
suffix:semicolon
r_switch
c_cond
(paren
id|device-&gt;devinfo.sid_data.cu_type
)paren
(brace
r_case
l_int|0x3990
suffix:colon
r_case
l_int|0x2105
suffix:colon
r_return
id|dasd_3990_erp_action
suffix:semicolon
r_case
l_int|0x9343
suffix:colon
multiline_comment|/* Return dasd_9343_erp_action; */
r_default
suffix:colon
r_return
id|dasd_default_erp_action
suffix:semicolon
)brace
)brace
r_static
id|dasd_erp_postaction_fn_t
DECL|function|dasd_eckd_erp_postaction
id|dasd_eckd_erp_postaction
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_return
id|dasd_default_erp_postaction
suffix:semicolon
)brace
r_inline
r_int
r_char
DECL|function|dasd_eckd_cdl_cmd
id|dasd_eckd_cdl_cmd
(paren
id|dasd_device_t
op_star
id|device
comma
r_int
id|recid
comma
r_int
id|cmd
)paren
(brace
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|byt_per_blk
op_assign
id|device-&gt;sizes.bp_block
suffix:semicolon
r_int
id|blk_per_trk
op_assign
id|recs_per_track
(paren
op_amp
(paren
r_private
op_member_access_from_pointer
id|rdc_data
)paren
comma
l_int|0
comma
id|byt_per_blk
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|READ
suffix:colon
r_if
c_cond
(paren
id|recid
OL
l_int|3
)paren
r_return
id|DASD_ECKD_CCW_READ_KD_MT
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
id|blk_per_trk
)paren
r_return
id|DASD_ECKD_CCW_READ_MT
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
l_int|2
op_star
id|blk_per_trk
)paren
r_return
id|DASD_ECKD_CCW_READ_KD_MT
suffix:semicolon
r_return
id|DASD_ECKD_CCW_READ_MT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRITE
suffix:colon
r_if
c_cond
(paren
id|recid
OL
l_int|3
)paren
r_return
id|DASD_ECKD_CCW_WRITE_KD_MT
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
id|blk_per_trk
)paren
r_return
id|DASD_ECKD_CCW_WRITE_MT
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
l_int|2
op_star
id|blk_per_trk
)paren
r_return
id|DASD_ECKD_CCW_WRITE_KD_MT
suffix:semicolon
r_return
id|DASD_ECKD_CCW_WRITE_MT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
singleline_comment|// never executed
)brace
r_static
id|ccw_req_t
op_star
DECL|function|dasd_eckd_build_cp_from_req
id|dasd_eckd_build_cp_from_req
(paren
id|dasd_device_t
op_star
id|device
comma
r_struct
id|request
op_star
id|req
)paren
(brace
id|ccw_req_t
op_star
id|rw_cp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rw_cmd
suffix:semicolon
r_int
id|bhct
suffix:semicolon
r_int
id|size
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|DE_eckd_data_t
op_star
id|DE_data
suffix:semicolon
id|LO_eckd_data_t
op_star
id|LO_data
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|dasd_eckd_private_t
op_star
r_private
op_assign
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|byt_per_blk
op_assign
id|device-&gt;sizes.bp_block
suffix:semicolon
r_int
id|shift
op_assign
id|device-&gt;sizes.s2b_shift
suffix:semicolon
r_int
id|blk_per_trk
op_assign
id|recs_per_track
(paren
op_amp
(paren
r_private
op_member_access_from_pointer
id|rdc_data
)paren
comma
l_int|0
comma
id|byt_per_blk
)paren
suffix:semicolon
r_int
id|btrk
op_assign
(paren
id|req-&gt;sector
op_rshift
id|shift
)paren
op_div
id|blk_per_trk
suffix:semicolon
r_int
id|etrk
op_assign
(paren
(paren
id|req-&gt;sector
op_plus
id|req-&gt;nr_sectors
op_minus
l_int|1
)paren
op_rshift
id|shift
)paren
op_div
id|blk_per_trk
suffix:semicolon
r_int
id|recid
op_assign
id|req-&gt;sector
op_rshift
id|shift
suffix:semicolon
r_int
id|locate4k_set
op_assign
l_int|0
suffix:semicolon
r_int
id|nlocs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;cmd
op_eq
id|READ
)paren
(brace
id|rw_cmd
op_assign
id|DASD_ECKD_CCW_READ_MT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|req-&gt;cmd
op_eq
id|WRITE
)paren
(brace
id|rw_cmd
op_assign
id|DASD_ECKD_CCW_WRITE_MT
suffix:semicolon
)brace
r_else
(brace
id|PRINT_ERR
(paren
l_string|&quot;Unknown command %d&bslash;n&quot;
comma
id|req-&gt;cmd
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Build the request */
multiline_comment|/* count bhs to prevent errors, when bh smaller than block */
id|bhct
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_size
OL
id|byt_per_blk
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|bhct
op_add_assign
id|bh-&gt;b_size
op_rshift
(paren
id|device-&gt;sizes.s2b_shift
op_plus
l_int|9
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btrk
OL
l_int|2
op_logical_and
r_private
op_member_access_from_pointer
id|uses_cdl
)paren
(brace
r_if
c_cond
(paren
id|etrk
OL
l_int|2
)paren
id|nlocs
op_assign
id|bhct
suffix:semicolon
r_else
id|nlocs
op_assign
l_int|2
op_star
id|blk_per_trk
op_minus
id|recid
suffix:semicolon
)brace
id|rw_cp
op_assign
id|dasd_alloc_request
(paren
id|dasd_eckd_discipline.name
comma
l_int|2
op_plus
id|nlocs
op_plus
id|bhct
op_plus
l_int|1
comma
r_sizeof
(paren
id|DE_eckd_data_t
)paren
op_plus
(paren
l_int|1
op_plus
id|nlocs
)paren
op_star
r_sizeof
(paren
id|LO_eckd_data_t
)paren
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rw_cp
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|DE_data
op_assign
id|rw_cp-&gt;data
suffix:semicolon
id|LO_data
op_assign
id|rw_cp-&gt;data
op_plus
r_sizeof
(paren
id|DE_eckd_data_t
)paren
suffix:semicolon
id|ccw
op_assign
id|rw_cp-&gt;cpaddr
suffix:semicolon
r_if
c_cond
(paren
id|define_extent
(paren
id|ccw
comma
id|DE_data
comma
id|btrk
comma
id|etrk
comma
id|rw_cmd
comma
id|device
comma
id|rw_cp
)paren
)paren
(brace
r_goto
id|clear_rw_cp
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|byt_per_blk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|locate4k_set
)paren
(brace
singleline_comment|// we need to chain a locate record before our rw-ccw
id|ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|recid
op_div
id|blk_per_trk
)paren
OL
l_int|2
op_logical_and
r_private
op_member_access_from_pointer
id|uses_cdl
)paren
(brace
multiline_comment|/* Do a locate record for our special blocks */
r_int
id|cmd
op_assign
id|dasd_eckd_cdl_cmd
(paren
id|device
comma
id|recid
comma
id|req-&gt;cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|locate_record
(paren
id|ccw
comma
id|LO_data
op_increment
comma
id|recid
op_div
id|blk_per_trk
comma
id|recid
op_mod
id|blk_per_trk
op_plus
l_int|1
comma
l_int|1
comma
id|cmd
comma
id|device
comma
id|dasd_eckd_cdl_reclen
c_func
(paren
id|device
comma
id|recid
)paren
comma
id|rw_cp
)paren
)paren
(brace
r_goto
id|clear_rw_cp
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// Do a locate record for standard blocks */
r_if
c_cond
(paren
id|locate_record
(paren
id|ccw
comma
id|LO_data
op_increment
comma
id|recid
op_div
id|blk_per_trk
comma
id|recid
op_mod
id|blk_per_trk
op_plus
l_int|1
comma
(paren
(paren
(paren
id|req-&gt;sector
op_plus
id|req-&gt;nr_sectors
)paren
op_rshift
id|shift
)paren
op_minus
id|recid
)paren
comma
id|rw_cmd
comma
id|device
comma
id|device-&gt;sizes.bp_block
comma
id|rw_cp
)paren
)paren
(brace
r_goto
id|clear_rw_cp
suffix:semicolon
)brace
id|locate4k_set
op_assign
l_int|1
suffix:semicolon
)brace
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
)brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|locate4k_set
ques
c_cond
id|rw_cmd
suffix:colon
id|dasd_eckd_cdl_cmd
(paren
id|device
comma
id|recid
comma
id|req-&gt;cmd
)paren
suffix:semicolon
id|ccw-&gt;count
op_assign
id|locate4k_set
ques
c_cond
id|byt_per_blk
suffix:colon
id|dasd_eckd_cdl_reclen
(paren
id|device
comma
id|recid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dasd_set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|bh-&gt;b_data
op_plus
id|size
)paren
comma
id|rw_cp
comma
id|device
)paren
)paren
(brace
r_goto
id|clear_rw_cp
suffix:semicolon
)brace
id|recid
op_increment
suffix:semicolon
)brace
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
)brace
id|ccw-&gt;flags
op_and_assign
op_complement
(paren
id|CCW_FLAG_DC
op_or
id|CCW_FLAG_CC
)paren
suffix:semicolon
id|rw_cp-&gt;device
op_assign
id|device
suffix:semicolon
id|rw_cp-&gt;expires
op_assign
l_int|5
op_star
id|TOD_MIN
suffix:semicolon
multiline_comment|/* 5 minutes */
id|rw_cp-&gt;req
op_assign
id|req
suffix:semicolon
id|rw_cp-&gt;lpm
op_assign
id|LPM_ANYPATH
suffix:semicolon
id|rw_cp-&gt;retries
op_assign
l_int|2
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|rw_cp-&gt;buildclk
)paren
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|rw_cp-&gt;status
comma
id|CQR_STATUS_EMPTY
comma
id|CQR_STATUS_FILLED
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|clear_rw_cp
suffix:colon
id|dasd_free_request
(paren
id|rw_cp
comma
id|device
)paren
suffix:semicolon
id|rw_cp
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
r_return
id|rw_cp
suffix:semicolon
)brace
macro_line|#if 0
r_int
id|dasd_eckd_cleanup_request
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|request
op_star
id|req
op_assign
id|cqr-&gt;req
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
r_int
id|byt_per_blk
op_assign
id|device-&gt;sizes.bp_block
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_size
OG
id|byt_per_blk
)paren
(brace
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|byt_per_blk
)paren
(brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|rw_cmd
suffix:semicolon
id|ccw-&gt;count
op_assign
id|byt_per_blk
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|bh-&gt;b_data
op_plus
id|size
)paren
)paren
suffix:semicolon
)brace
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* group N bhs to fit into byt_per_blk */
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|bh
op_ne
l_int|NULL
op_logical_and
id|size
OL
id|byt_per_blk
suffix:semicolon
)paren
(brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_DC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|rw_cmd
suffix:semicolon
id|ccw-&gt;count
op_assign
id|bh-&gt;b_size
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|bh-&gt;b_data
)paren
)paren
suffix:semicolon
id|size
op_add_assign
id|bh-&gt;b_size
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * DASD_ECKD_RESERVE&n; *&n; * DESCRIPTION&n; *    Buils a channel programm to reserve a device.&n; *    Options are set to &squot;synchronous wait for interrupt&squot; and&n; *    &squot;timeout the request&squot;. This leads to an terminate IO if &n; *    the interrupt is outstanding for a certain time. &n; */
id|ccw_req_t
op_star
DECL|function|dasd_eckd_reserve
id|dasd_eckd_reserve
(paren
r_struct
id|dasd_device_t
op_star
id|device
)paren
(brace
id|ccw_req_t
op_star
id|cqr
op_assign
id|dasd_alloc_request
(paren
id|dasd_eckd_discipline.name
comma
l_int|1
op_plus
l_int|1
comma
l_int|0
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No memory to allocate initialization request&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr-&gt;cpaddr-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_RESERVE
suffix:semicolon
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;expires
op_assign
l_int|10
op_star
id|TOD_SEC
suffix:semicolon
id|cqr-&gt;options
op_assign
(paren
id|DOIO_WAIT_FOR_INTERRUPT
op_or
id|DOIO_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* timeout reqest */
id|cqr-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * DASD_ECKD_RELEASE&n; *&n; * DESCRIPTION&n; *    Buils a channel programm to releases a prior reserved &n; *    (see dasd_eckd_reserve) device.&n; */
id|ccw_req_t
op_star
DECL|function|dasd_eckd_release
id|dasd_eckd_release
(paren
r_struct
id|dasd_device_t
op_star
id|device
)paren
(brace
id|ccw_req_t
op_star
id|cqr
op_assign
id|dasd_alloc_request
(paren
id|dasd_eckd_discipline.name
comma
l_int|1
op_plus
l_int|1
comma
l_int|0
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No memory to allocate initialization request&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr-&gt;cpaddr-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_RELEASE
suffix:semicolon
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;expires
op_assign
l_int|10
op_star
id|TOD_SEC
suffix:semicolon
id|cqr-&gt;options
op_assign
(paren
id|DOIO_WAIT_FOR_INTERRUPT
op_or
id|DOIO_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* timeout reqest */
id|cqr-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * DASD_ECKD_STEAL_LOCK&n; *&n; * DESCRIPTION&n; *    Buils a channel programm to break a device&squot;s reservation. &n; *    (unconditional reserve)&n; */
id|ccw_req_t
op_star
DECL|function|dasd_eckd_steal_lock
id|dasd_eckd_steal_lock
(paren
r_struct
id|dasd_device_t
op_star
id|device
)paren
(brace
id|ccw_req_t
op_star
id|cqr
op_assign
id|dasd_alloc_request
(paren
id|dasd_eckd_discipline.name
comma
l_int|1
op_plus
l_int|1
comma
l_int|0
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No memory to allocate initialization request&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr-&gt;cpaddr-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_SLCK
suffix:semicolon
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;expires
op_assign
l_int|10
op_star
id|TOD_SEC
suffix:semicolon
id|cqr-&gt;options
op_assign
(paren
id|DOIO_WAIT_FOR_INTERRUPT
op_or
id|DOIO_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* timeout reqest */
id|cqr-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
r_static
r_inline
id|ccw1_t
op_star
DECL|function|dasd_eckd_find_cmd
id|dasd_eckd_find_cmd
(paren
id|ccw_req_t
op_star
id|cqr
comma
r_int
id|cmd
)paren
(brace
id|ccw1_t
op_star
id|cp
suffix:semicolon
id|cp
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|cp-&gt;cmd_code
op_eq
id|cmd
)paren
r_return
id|cp
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;cmd_code
op_eq
id|CCW_CMD_TIC
)paren
(brace
id|cp
op_assign
(paren
id|ccw1_t
op_star
)paren
(paren
r_int
)paren
id|cp-&gt;cda
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cp-&gt;flags
op_amp
(paren
id|CCW_FLAG_DC
op_or
id|CCW_FLAG_CC
)paren
)paren
(brace
id|cp
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
id|ccw_req_t
op_star
DECL|function|dasd_eckd_merge_cp
id|dasd_eckd_merge_cp
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_fill_info
id|dasd_eckd_fill_info
(paren
id|dasd_device_t
op_star
id|device
comma
id|dasd_information_t
op_star
id|info
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|info-&gt;label_block
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
)paren
op_member_access_from_pointer
id|uses_cdl
)paren
id|info-&gt;FBA_layout
op_assign
l_int|0
suffix:semicolon
r_else
id|info-&gt;FBA_layout
op_assign
l_int|1
suffix:semicolon
id|info-&gt;characteristics_size
op_assign
r_sizeof
(paren
id|dasd_eckd_characteristics_t
)paren
suffix:semicolon
id|memcpy
(paren
id|info-&gt;characteristics
comma
op_amp
(paren
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
)paren
op_member_access_from_pointer
id|rdc_data
comma
r_sizeof
(paren
id|dasd_eckd_characteristics_t
)paren
)paren
suffix:semicolon
id|info-&gt;confdata_size
op_assign
r_sizeof
(paren
id|dasd_eckd_confdata_t
)paren
suffix:semicolon
id|memcpy
(paren
id|info-&gt;configuration_data
comma
op_amp
(paren
(paren
id|dasd_eckd_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
)paren
op_member_access_from_pointer
id|conf_data
comma
r_sizeof
(paren
id|dasd_eckd_confdata_t
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_char
op_star
DECL|function|dasd_eckd_dump_sense
id|dasd_eckd_dump_sense
(paren
r_struct
id|dasd_device_t
op_star
id|device
comma
id|ccw_req_t
op_star
id|req
)paren
(brace
r_char
op_star
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_free_page
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
id|devstat_t
op_star
id|stat
op_assign
op_amp
id|device-&gt;dev_status
suffix:semicolon
r_char
op_star
id|sense
op_assign
id|stat-&gt;ii.sense.data
suffix:semicolon
r_int
id|len
comma
id|sl
comma
id|sct
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;No memory to dump sense data&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|len
op_assign
id|sprintf
(paren
id|page
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;device %04X on irq %d: I/O status report:&bslash;n&quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;devinfo.irq
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;in req: %p CS: 0x%02X DS: 0x%02X&bslash;n&quot;
comma
id|req
comma
id|stat-&gt;cstat
comma
id|stat-&gt;dstat
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;Failing CCW: %p&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|stat-&gt;cpa
)paren
suffix:semicolon
(brace
id|ccw1_t
op_star
id|act
op_assign
id|req-&gt;cpaddr
suffix:semicolon
r_int
id|i
op_assign
id|req-&gt;cplength
suffix:semicolon
r_do
(brace
macro_line|#ifdef ERP_DEBUG
id|printk
(paren
id|KERN_ERR
l_string|&quot;CCW %p: %08X %08X&bslash;n&quot;
comma
id|act
comma
(paren
(paren
r_int
op_star
)paren
id|act
)paren
(braket
l_int|0
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|act
)paren
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_ERR
l_string|&quot;DAT: %08X %08X %08X %08X&bslash;n&quot;
comma
(paren
(paren
r_int
op_star
)paren
id|act-&gt;cda
)paren
(braket
l_int|0
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|act-&gt;cda
)paren
(braket
l_int|1
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|act-&gt;cda
)paren
(braket
l_int|2
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|act-&gt;cda
)paren
(braket
l_int|3
)braket
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ERP_DEBUG */
id|act
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stat-&gt;flag
op_amp
id|DEVSTAT_FLAG_SENSE_AVAIL
)paren
(brace
r_for
c_loop
(paren
id|sl
op_assign
l_int|0
suffix:semicolon
id|sl
OL
l_int|4
suffix:semicolon
id|sl
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;Sense(hex) %2d-%2d:&quot;
comma
(paren
l_int|8
op_star
id|sl
)paren
comma
(paren
(paren
l_int|8
op_star
id|sl
)paren
op_plus
l_int|7
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sct
op_assign
l_int|0
suffix:semicolon
id|sct
OL
l_int|8
suffix:semicolon
id|sct
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot; %02x&quot;
comma
id|sense
(braket
l_int|8
op_star
id|sl
op_plus
id|sct
)braket
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|27
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
(brace
multiline_comment|/* 24 Byte Sense Data */
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;24 Byte: %x MSG %x, %s MSGb to SYSOP&bslash;n&quot;
comma
id|sense
(braket
l_int|7
)braket
op_rshift
l_int|4
comma
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x0f
comma
id|sense
(braket
l_int|1
)braket
op_amp
l_int|0x10
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 32 Byte Sense Data */
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;32 Byte: Format: %x Exception class %x&bslash;n&quot;
comma
id|sense
(braket
l_int|6
)braket
op_amp
l_int|0x0f
comma
id|sense
(braket
l_int|22
)braket
op_rshift
l_int|4
)paren
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;Sense data:&bslash;n%s&quot;
comma
id|page
)paren
suffix:semicolon
id|free_page
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|variable|dasd_eckd_discipline
id|dasd_discipline_t
id|dasd_eckd_discipline
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|name
suffix:colon
l_string|&quot;ECKD&quot;
comma
id|ebcname
suffix:colon
l_string|&quot;ECKD&quot;
comma
id|max_blocks
suffix:colon
l_int|255
comma
id|id_check
suffix:colon
id|dasd_eckd_id_check
comma
id|check_characteristics
suffix:colon
id|dasd_eckd_check_characteristics
comma
id|init_analysis
suffix:colon
id|dasd_eckd_init_analysis
comma
id|do_analysis
suffix:colon
id|dasd_eckd_do_analysis
comma
id|fill_geometry
suffix:colon
id|dasd_eckd_fill_geometry
comma
id|start_IO
suffix:colon
id|dasd_start_IO
comma
id|term_IO
suffix:colon
id|dasd_term_IO
comma
id|format_device
suffix:colon
id|dasd_eckd_format_device
comma
id|examine_error
suffix:colon
id|dasd_eckd_examine_error
comma
id|erp_action
suffix:colon
id|dasd_eckd_erp_action
comma
id|erp_postaction
suffix:colon
id|dasd_eckd_erp_postaction
comma
id|build_cp_from_req
suffix:colon
id|dasd_eckd_build_cp_from_req
comma
id|dump_sense
suffix:colon
id|dasd_eckd_dump_sense
comma
id|int_handler
suffix:colon
id|dasd_int_handler
comma
id|reserve
suffix:colon
id|dasd_eckd_reserve
comma
id|release
suffix:colon
id|dasd_eckd_release
comma
id|steal_lock
suffix:colon
id|dasd_eckd_steal_lock
comma
id|merge_cp
suffix:colon
id|dasd_eckd_merge_cp
comma
id|fill_info
suffix:colon
id|dasd_eckd_fill_info
comma
)brace
suffix:semicolon
r_int
DECL|function|dasd_eckd_init
id|dasd_eckd_init
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;%s discipline initializing&bslash;n&quot;
comma
id|dasd_eckd_discipline.name
)paren
suffix:semicolon
id|ASCEBC
(paren
id|dasd_eckd_discipline.ebcname
comma
l_int|4
)paren
suffix:semicolon
id|dasd_discipline_add
(paren
op_amp
id|dasd_eckd_discipline
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DASD_DYNAMIC
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|dasd_eckd_known_devices
)paren
op_div
r_sizeof
(paren
id|devreg_t
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;We are interested in: CU %04X/%02x&bslash;n&quot;
comma
id|dasd_eckd_known_devices
(braket
id|i
)braket
dot
id|ci.hc.ctype
comma
id|dasd_eckd_known_devices
(braket
id|i
)braket
dot
id|ci.hc.cmode
)paren
suffix:semicolon
id|s390_device_register
(paren
op_amp
id|dasd_eckd_known_devices
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_DASD_DYNAMIC */
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|dasd_eckd_cleanup
id|dasd_eckd_cleanup
(paren
r_void
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;%s discipline cleaning up&bslash;n&quot;
comma
id|dasd_eckd_discipline.name
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DASD_DYNAMIC
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|dasd_eckd_known_devices
)paren
op_div
r_sizeof
(paren
id|devreg_t
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;We were interested in: CU %04X/%02x&bslash;n&quot;
comma
id|dasd_eckd_known_devices
(braket
id|i
)braket
dot
id|ci.hc.ctype
comma
id|dasd_eckd_known_devices
(braket
id|i
)braket
dot
id|ci.hc.cmode
)paren
suffix:semicolon
id|s390_device_unregister
(paren
op_amp
id|dasd_eckd_known_devices
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_DASD_DYNAMIC */
id|dasd_discipline_del
(paren
op_amp
id|dasd_eckd_discipline
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_int
DECL|function|init_module
id|init_module
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|dasd_eckd_init
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
(paren
r_void
)paren
(brace
id|dasd_eckd_cleanup
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 4 &n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -4&n; * c-argdecl-indent: 4&n; * c-label-offset: -4&n; * c-continued-statement-offset: 4&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
