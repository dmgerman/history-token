multiline_comment|/* &n; * File...........: linux/drivers/s390/block/dasd_eckd.c&n; * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n; *&t;&t;    Horst Hummel &lt;Horst.Hummel@de.ibm.com&gt; &n; *&t;&t;    Carsten Otte &lt;Cotte@de.ibm.com&gt;&n; *&t;&t;    Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 1999,2000&n; *&n; * $Revision: 1.68 $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;&t;/* HDIO_GETGEO&t;&t;&t;    */
macro_line|#include &lt;linux/bio.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/todclk.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &quot;dasd_int.h&quot;
macro_line|#include &quot;dasd_eckd.h&quot;
macro_line|#ifdef PRINTK_HEADER
DECL|macro|PRINTK_HEADER
macro_line|#undef PRINTK_HEADER
macro_line|#endif&t;&t;&t;&t;/* PRINTK_HEADER */
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;dasd(eckd):&quot;
DECL|macro|ECKD_C0
mdefine_line|#define ECKD_C0(i) (i-&gt;home_bytes)
DECL|macro|ECKD_F
mdefine_line|#define ECKD_F(i) (i-&gt;formula)
DECL|macro|ECKD_F1
mdefine_line|#define ECKD_F1(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f1):&bslash;&n;&t;&t;    (i-&gt;factors.f_0x02.f1))
DECL|macro|ECKD_F2
mdefine_line|#define ECKD_F2(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f2):&bslash;&n;&t;&t;    (i-&gt;factors.f_0x02.f2))
DECL|macro|ECKD_F3
mdefine_line|#define ECKD_F3(i) (ECKD_F(i)==0x01?(i-&gt;factors.f_0x01.f3):&bslash;&n;&t;&t;    (i-&gt;factors.f_0x02.f3))
DECL|macro|ECKD_F4
mdefine_line|#define ECKD_F4(i) (ECKD_F(i)==0x02?(i-&gt;factors.f_0x02.f4):0)
DECL|macro|ECKD_F5
mdefine_line|#define ECKD_F5(i) (ECKD_F(i)==0x02?(i-&gt;factors.f_0x02.f5):0)
DECL|macro|ECKD_F6
mdefine_line|#define ECKD_F6(i) (i-&gt;factor6)
DECL|macro|ECKD_F7
mdefine_line|#define ECKD_F7(i) (i-&gt;factor7)
DECL|macro|ECKD_F8
mdefine_line|#define ECKD_F8(i) (i-&gt;factor8)
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|dasd_eckd_discipline
r_static
r_struct
id|dasd_discipline
id|dasd_eckd_discipline
suffix:semicolon
DECL|struct|dasd_eckd_private
r_struct
id|dasd_eckd_private
(brace
DECL|member|rdc_data
r_struct
id|dasd_eckd_characteristics
id|rdc_data
suffix:semicolon
DECL|member|conf_data
r_struct
id|dasd_eckd_confdata
id|conf_data
suffix:semicolon
DECL|member|count_area
r_struct
id|eckd_count
id|count_area
(braket
l_int|5
)braket
suffix:semicolon
DECL|member|init_cqr_status
r_int
id|init_cqr_status
suffix:semicolon
DECL|member|uses_cdl
r_int
id|uses_cdl
suffix:semicolon
DECL|member|attrib
r_struct
id|attrib_data_t
id|attrib
suffix:semicolon
multiline_comment|/* e.g. cache operations */
)brace
suffix:semicolon
multiline_comment|/* The ccw bus type uses this table to find devices that it sends to&n; * dasd_eckd_probe */
DECL|variable|dasd_eckd_ids
r_static
r_struct
id|ccw_device_id
id|dasd_eckd_ids
(braket
)braket
op_assign
(brace
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x3990
comma
l_int|0
comma
l_int|0x3390
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x1
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x2105
comma
l_int|0
comma
l_int|0x3390
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x2
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x3880
comma
l_int|0
comma
l_int|0x3390
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x3
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x3990
comma
l_int|0
comma
l_int|0x3380
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x4
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x2105
comma
l_int|0
comma
l_int|0x3380
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x5
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x9343
comma
l_int|0
comma
l_int|0x9345
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x6
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x2107
comma
l_int|0
comma
l_int|0x3390
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x7
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x2107
comma
l_int|0
comma
l_int|0x3380
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x8
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x1750
comma
l_int|0
comma
l_int|0x3390
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0x9
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
(paren
l_int|0x1750
comma
l_int|0
comma
l_int|0x3380
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
l_int|0xa
)brace
comma
(brace
multiline_comment|/* end of list */
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|ccw
comma
id|dasd_eckd_ids
)paren
suffix:semicolon
DECL|variable|dasd_eckd_driver
r_static
r_struct
id|ccw_driver
id|dasd_eckd_driver
suffix:semicolon
multiline_comment|/* see below */
multiline_comment|/* initial attempt at a probe function. this can be simplified once&n; * the other detection code is gone */
r_static
r_int
DECL|function|dasd_eckd_probe
id|dasd_eckd_probe
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|dasd_generic_probe
(paren
id|cdev
comma
op_amp
id|dasd_eckd_discipline
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|ccw_device_set_options
c_func
(paren
id|cdev
comma
id|CCWDEV_DO_PATHGROUP
op_or
id|CCWDEV_ALLOW_FORCE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_set_online
id|dasd_eckd_set_online
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_return
id|dasd_generic_set_online
(paren
id|cdev
comma
op_amp
id|dasd_eckd_discipline
)paren
suffix:semicolon
)brace
DECL|variable|dasd_eckd_driver
r_static
r_struct
id|ccw_driver
id|dasd_eckd_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;dasd-eckd&quot;
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ids
op_assign
id|dasd_eckd_ids
comma
dot
id|probe
op_assign
id|dasd_eckd_probe
comma
dot
id|remove
op_assign
id|dasd_generic_remove
comma
dot
id|set_offline
op_assign
id|dasd_generic_set_offline
comma
dot
id|set_online
op_assign
id|dasd_eckd_set_online
comma
dot
id|notify
op_assign
id|dasd_generic_notify
comma
)brace
suffix:semicolon
DECL|variable|sizes_trk0
r_static
r_const
r_int
id|sizes_trk0
(braket
)braket
op_assign
(brace
l_int|28
comma
l_int|148
comma
l_int|84
)brace
suffix:semicolon
DECL|macro|LABEL_SIZE
mdefine_line|#define LABEL_SIZE 140
r_static
r_inline
r_int
r_int
DECL|function|round_up_multiple
id|round_up_multiple
c_func
(paren
r_int
r_int
id|no
comma
r_int
r_int
id|mult
)paren
(brace
r_int
id|rem
op_assign
id|no
op_mod
id|mult
suffix:semicolon
r_return
(paren
id|rem
ques
c_cond
id|no
op_minus
id|rem
op_plus
id|mult
suffix:colon
id|no
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|ceil_quot
id|ceil_quot
c_func
(paren
r_int
r_int
id|d1
comma
r_int
r_int
id|d2
)paren
(brace
r_return
(paren
id|d1
op_plus
(paren
id|d2
op_minus
l_int|1
)paren
)paren
op_div
id|d2
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|bytes_per_record
id|bytes_per_record
c_func
(paren
r_struct
id|dasd_eckd_characteristics
op_star
id|rdc
comma
r_int
id|kl
comma
r_int
id|dl
)paren
(brace
r_int
r_int
id|fl1
comma
id|fl2
comma
id|int1
comma
id|int2
suffix:semicolon
r_int
id|bpr
suffix:semicolon
r_switch
c_cond
(paren
id|rdc-&gt;formula
)paren
(brace
r_case
l_int|0x01
suffix:colon
id|fl1
op_assign
id|round_up_multiple
c_func
(paren
id|ECKD_F2
c_func
(paren
id|rdc
)paren
op_plus
id|dl
comma
id|ECKD_F1
c_func
(paren
id|rdc
)paren
)paren
suffix:semicolon
id|fl2
op_assign
id|round_up_multiple
c_func
(paren
id|kl
ques
c_cond
id|ECKD_F2
c_func
(paren
id|rdc
)paren
op_plus
id|kl
suffix:colon
l_int|0
comma
id|ECKD_F1
c_func
(paren
id|rdc
)paren
)paren
suffix:semicolon
id|bpr
op_assign
id|fl1
op_plus
id|fl2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|int1
op_assign
id|ceil_quot
c_func
(paren
id|dl
op_plus
id|ECKD_F6
c_func
(paren
id|rdc
)paren
comma
id|ECKD_F5
c_func
(paren
id|rdc
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|int2
op_assign
id|ceil_quot
c_func
(paren
id|kl
op_plus
id|ECKD_F6
c_func
(paren
id|rdc
)paren
comma
id|ECKD_F5
c_func
(paren
id|rdc
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|fl1
op_assign
id|round_up_multiple
c_func
(paren
id|ECKD_F1
c_func
(paren
id|rdc
)paren
op_star
id|ECKD_F2
c_func
(paren
id|rdc
)paren
op_plus
id|dl
op_plus
id|ECKD_F6
c_func
(paren
id|rdc
)paren
op_plus
id|ECKD_F4
c_func
(paren
id|rdc
)paren
op_star
id|int1
comma
id|ECKD_F1
c_func
(paren
id|rdc
)paren
)paren
suffix:semicolon
id|fl2
op_assign
id|round_up_multiple
c_func
(paren
id|ECKD_F1
c_func
(paren
id|rdc
)paren
op_star
id|ECKD_F3
c_func
(paren
id|rdc
)paren
op_plus
id|kl
op_plus
id|ECKD_F6
c_func
(paren
id|rdc
)paren
op_plus
id|ECKD_F4
c_func
(paren
id|rdc
)paren
op_star
id|int2
comma
id|ECKD_F1
c_func
(paren
id|rdc
)paren
)paren
suffix:semicolon
id|bpr
op_assign
id|fl1
op_plus
id|fl2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|bpr
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|bpr
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|bytes_per_track
id|bytes_per_track
c_func
(paren
r_struct
id|dasd_eckd_characteristics
op_star
id|rdc
)paren
(brace
r_return
op_star
(paren
r_int
r_int
op_star
)paren
(paren
id|rdc-&gt;byte_per_track
)paren
op_rshift
l_int|8
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|recs_per_track
id|recs_per_track
c_func
(paren
r_struct
id|dasd_eckd_characteristics
op_star
id|rdc
comma
r_int
r_int
id|kl
comma
r_int
r_int
id|dl
)paren
(brace
r_int
id|dn
comma
id|kn
suffix:semicolon
r_switch
c_cond
(paren
id|rdc-&gt;dev_type
)paren
(brace
r_case
l_int|0x3380
suffix:colon
r_if
c_cond
(paren
id|kl
)paren
r_return
l_int|1499
op_div
(paren
l_int|15
op_plus
l_int|7
op_plus
id|ceil_quot
c_func
(paren
id|kl
op_plus
l_int|12
comma
l_int|32
)paren
op_plus
id|ceil_quot
c_func
(paren
id|dl
op_plus
l_int|12
comma
l_int|32
)paren
)paren
suffix:semicolon
r_else
r_return
l_int|1499
op_div
(paren
l_int|15
op_plus
id|ceil_quot
c_func
(paren
id|dl
op_plus
l_int|12
comma
l_int|32
)paren
)paren
suffix:semicolon
r_case
l_int|0x3390
suffix:colon
id|dn
op_assign
id|ceil_quot
c_func
(paren
id|dl
op_plus
l_int|6
comma
l_int|232
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|kl
)paren
(brace
id|kn
op_assign
id|ceil_quot
c_func
(paren
id|kl
op_plus
l_int|6
comma
l_int|232
)paren
op_plus
l_int|1
suffix:semicolon
r_return
l_int|1729
op_div
(paren
l_int|10
op_plus
l_int|9
op_plus
id|ceil_quot
c_func
(paren
id|kl
op_plus
l_int|6
op_star
id|kn
comma
l_int|34
)paren
op_plus
l_int|9
op_plus
id|ceil_quot
c_func
(paren
id|dl
op_plus
l_int|6
op_star
id|dn
comma
l_int|34
)paren
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|1729
op_div
(paren
l_int|10
op_plus
l_int|9
op_plus
id|ceil_quot
c_func
(paren
id|dl
op_plus
l_int|6
op_star
id|dn
comma
l_int|34
)paren
)paren
suffix:semicolon
r_case
l_int|0x9345
suffix:colon
id|dn
op_assign
id|ceil_quot
c_func
(paren
id|dl
op_plus
l_int|6
comma
l_int|232
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|kl
)paren
(brace
id|kn
op_assign
id|ceil_quot
c_func
(paren
id|kl
op_plus
l_int|6
comma
l_int|232
)paren
op_plus
l_int|1
suffix:semicolon
r_return
l_int|1420
op_div
(paren
l_int|18
op_plus
l_int|7
op_plus
id|ceil_quot
c_func
(paren
id|kl
op_plus
l_int|6
op_star
id|kn
comma
l_int|34
)paren
op_plus
id|ceil_quot
c_func
(paren
id|dl
op_plus
l_int|6
op_star
id|dn
comma
l_int|34
)paren
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|1420
op_div
(paren
l_int|18
op_plus
l_int|7
op_plus
id|ceil_quot
c_func
(paren
id|dl
op_plus
l_int|6
op_star
id|dn
comma
l_int|34
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|check_XRC
id|check_XRC
(paren
r_struct
id|ccw1
op_star
id|de_ccw
comma
r_struct
id|DE_eckd_data
op_star
id|data
comma
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
multiline_comment|/* switch on System Time Stamp - needed for XRC Support */
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|rdc_data.facilities.XRC_supported
)paren
(brace
id|data-&gt;ga_extended
op_or_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* switch on &squot;Time Stamp Valid&squot;   */
id|data-&gt;ga_extended
op_or_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* switch on &squot;Extended Parameter&squot; */
id|data-&gt;ep_sys_time
op_assign
id|get_clock
(paren
)paren
suffix:semicolon
id|de_ccw-&gt;count
op_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
suffix:semicolon
id|de_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_SLI
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* end check_XRC */
r_static
r_inline
r_void
DECL|function|define_extent
id|define_extent
c_func
(paren
r_struct
id|ccw1
op_star
id|ccw
comma
r_struct
id|DE_eckd_data
op_star
id|data
comma
r_int
id|trk
comma
r_int
id|totrk
comma
r_int
id|cmd
comma
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|ch_t
id|geo
comma
id|beg
comma
id|end
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_DEFINE_EXTENT
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|16
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|data
)paren
suffix:semicolon
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DASD_ECKD_CCW_READ_HOME_ADDRESS
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_RECORD_ZERO
suffix:colon
r_case
id|DASD_ECKD_CCW_READ
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_CKD
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_CKD_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_KD
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_KD_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_COUNT
suffix:colon
id|data-&gt;mask.perm
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;attributes.operation
op_assign
r_private
op_member_access_from_pointer
id|attrib.operation
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_KD
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_KD_MT
suffix:colon
id|data-&gt;mask.perm
op_assign
l_int|0x02
suffix:semicolon
id|data-&gt;attributes.operation
op_assign
r_private
op_member_access_from_pointer
id|attrib.operation
suffix:semicolon
id|check_XRC
(paren
id|ccw
comma
id|data
comma
id|device
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE_CKD
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_CKD_MT
suffix:colon
id|data-&gt;attributes.operation
op_assign
id|DASD_BYPASS_CACHE
suffix:semicolon
id|check_XRC
(paren
id|ccw
comma
id|data
comma
id|device
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_ERASE
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_HOME_ADDRESS
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
suffix:colon
id|data-&gt;mask.perm
op_assign
l_int|0x3
suffix:semicolon
id|data-&gt;mask.auth
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;attributes.operation
op_assign
id|DASD_BYPASS_CACHE
suffix:semicolon
id|check_XRC
(paren
id|ccw
comma
id|data
comma
id|device
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;unknown opcode 0x%x&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|data-&gt;attributes.mode
op_assign
l_int|0x3
suffix:semicolon
multiline_comment|/* ECKD */
r_if
c_cond
(paren
(paren
r_private
op_member_access_from_pointer
id|rdc_data.cu_type
op_eq
l_int|0x2105
op_logical_or
r_private
op_member_access_from_pointer
id|rdc_data.cu_type
op_eq
l_int|0x2107
op_logical_or
r_private
op_member_access_from_pointer
id|rdc_data.cu_type
op_eq
l_int|0x1750
)paren
op_logical_and
op_logical_neg
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_logical_and
id|trk
OL
l_int|2
)paren
)paren
id|data-&gt;ga_extended
op_or_assign
l_int|0x40
suffix:semicolon
multiline_comment|/* Regular Data Format Mode */
id|geo.cyl
op_assign
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
suffix:semicolon
id|geo.head
op_assign
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
id|beg.cyl
op_assign
id|trk
op_div
id|geo.head
suffix:semicolon
id|beg.head
op_assign
id|trk
op_mod
id|geo.head
suffix:semicolon
id|end.cyl
op_assign
id|totrk
op_div
id|geo.head
suffix:semicolon
id|end.head
op_assign
id|totrk
op_mod
id|geo.head
suffix:semicolon
multiline_comment|/* check for sequential prestage - enhance cylinder range */
r_if
c_cond
(paren
id|data-&gt;attributes.operation
op_eq
id|DASD_SEQ_PRESTAGE
op_logical_or
id|data-&gt;attributes.operation
op_eq
id|DASD_SEQ_ACCESS
)paren
(brace
r_if
c_cond
(paren
id|end.cyl
op_plus
r_private
op_member_access_from_pointer
id|attrib.nr_cyl
OL
id|geo.cyl
)paren
id|end.cyl
op_add_assign
r_private
op_member_access_from_pointer
id|attrib.nr_cyl
suffix:semicolon
r_else
id|end.cyl
op_assign
(paren
id|geo.cyl
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|data-&gt;beg_ext.cyl
op_assign
id|beg.cyl
suffix:semicolon
id|data-&gt;beg_ext.head
op_assign
id|beg.head
suffix:semicolon
id|data-&gt;end_ext.cyl
op_assign
id|end.cyl
suffix:semicolon
id|data-&gt;end_ext.head
op_assign
id|end.head
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|locate_record
id|locate_record
c_func
(paren
r_struct
id|ccw1
op_star
id|ccw
comma
r_struct
id|LO_eckd_data
op_star
id|data
comma
r_int
id|trk
comma
r_int
id|rec_on_trk
comma
r_int
id|no_rec
comma
r_int
id|cmd
comma
r_struct
id|dasd_device
op_star
id|device
comma
r_int
id|reclen
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_int
id|sector
suffix:semicolon
r_int
id|dn
comma
id|d
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|DBF_DEV_EVENT
c_func
(paren
id|DBF_INFO
comma
id|device
comma
l_string|&quot;Locate: trk %d, rec %d, no_rec %d, cmd %d, reclen %d&quot;
comma
id|trk
comma
id|rec_on_trk
comma
id|no_rec
comma
id|cmd
comma
id|reclen
)paren
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_LOCATE_RECORD
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|16
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|data
)paren
suffix:semicolon
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
)paren
suffix:semicolon
id|sector
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rec_on_trk
)paren
(brace
r_switch
c_cond
(paren
r_private
op_member_access_from_pointer
id|rdc_data.dev_type
)paren
(brace
r_case
l_int|0x3390
suffix:colon
id|dn
op_assign
id|ceil_quot
c_func
(paren
id|reclen
op_plus
l_int|6
comma
l_int|232
)paren
suffix:semicolon
id|d
op_assign
l_int|9
op_plus
id|ceil_quot
c_func
(paren
id|reclen
op_plus
l_int|6
op_star
(paren
id|dn
op_plus
l_int|1
)paren
comma
l_int|34
)paren
suffix:semicolon
id|sector
op_assign
(paren
l_int|49
op_plus
(paren
id|rec_on_trk
op_minus
l_int|1
)paren
op_star
(paren
l_int|10
op_plus
id|d
)paren
)paren
op_div
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x3380
suffix:colon
id|d
op_assign
l_int|7
op_plus
id|ceil_quot
c_func
(paren
id|reclen
op_plus
l_int|12
comma
l_int|32
)paren
suffix:semicolon
id|sector
op_assign
(paren
l_int|39
op_plus
(paren
id|rec_on_trk
op_minus
l_int|1
)paren
op_star
(paren
l_int|8
op_plus
id|d
)paren
)paren
op_div
l_int|7
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|data-&gt;sector
op_assign
id|sector
suffix:semicolon
id|data-&gt;count
op_assign
id|no_rec
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DASD_ECKD_CCW_WRITE_HOME_ADDRESS
suffix:colon
id|data-&gt;operation.orientation
op_assign
l_int|0x3
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ_HOME_ADDRESS
suffix:colon
id|data-&gt;operation.orientation
op_assign
l_int|0x3
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
suffix:colon
id|data-&gt;operation.orientation
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x03
suffix:semicolon
id|data-&gt;count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ_RECORD_ZERO
suffix:colon
id|data-&gt;operation.orientation
op_assign
l_int|0x3
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x16
suffix:semicolon
id|data-&gt;count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_KD
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_KD_MT
suffix:colon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_WRITE_CKD
suffix:colon
r_case
id|DASD_ECKD_CCW_WRITE_CKD_MT
suffix:colon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_MT
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_KD
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_KD_MT
suffix:colon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ_CKD
suffix:colon
r_case
id|DASD_ECKD_CCW_READ_CKD_MT
suffix:colon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_READ_COUNT
suffix:colon
id|data-&gt;operation.operation
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DASD_ECKD_CCW_ERASE
suffix:colon
id|data-&gt;length
op_assign
id|reclen
suffix:semicolon
id|data-&gt;auxiliary.last_bytes_used
op_assign
l_int|0x1
suffix:semicolon
id|data-&gt;operation.operation
op_assign
l_int|0x0b
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;unknown opcode 0x%x&quot;
comma
id|cmd
)paren
suffix:semicolon
)brace
id|data-&gt;seek_addr.cyl
op_assign
id|data-&gt;search_arg.cyl
op_assign
id|trk
op_div
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
id|data-&gt;seek_addr.head
op_assign
id|data-&gt;search_arg.head
op_assign
id|trk
op_mod
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
id|data-&gt;search_arg.record
op_assign
id|rec_on_trk
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns 1 if the block is one of the special blocks that needs&n; * to get read/written with the KD variant of the command.&n; * That is DASD_ECKD_READ_KD_MT instead of DASD_ECKD_READ_MT and&n; * DASD_ECKD_WRITE_KD_MT instead of DASD_ECKD_WRITE_MT.&n; * Luckily the KD variants differ only by one bit (0x08) from the&n; * normal variant. So don&squot;t wonder about code like:&n; * if (dasd_eckd_cdl_special(blk_per_trk, recid))&n; *         ccw-&gt;cmd_code |= 0x8;&n; */
r_static
r_inline
r_int
DECL|function|dasd_eckd_cdl_special
id|dasd_eckd_cdl_special
c_func
(paren
r_int
id|blk_per_trk
comma
r_int
id|recid
)paren
(brace
r_if
c_cond
(paren
id|recid
OL
l_int|3
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
id|blk_per_trk
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|recid
OL
l_int|2
op_star
id|blk_per_trk
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns the record size for the special blocks of the cdl format.&n; * Only returns something useful if dasd_eckd_cdl_special is true&n; * for the recid.&n; */
r_static
r_inline
r_int
DECL|function|dasd_eckd_cdl_reclen
id|dasd_eckd_cdl_reclen
c_func
(paren
r_int
id|recid
)paren
(brace
r_if
c_cond
(paren
id|recid
OL
l_int|3
)paren
r_return
id|sizes_trk0
(braket
id|recid
)braket
suffix:semicolon
r_return
id|LABEL_SIZE
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_check_characteristics
id|dasd_eckd_check_characteristics
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_void
op_star
id|rdc_data
suffix:semicolon
r_void
op_star
id|conf_data
suffix:semicolon
r_int
id|conf_len
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
r_private
op_eq
l_int|NULL
)paren
(brace
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dasd_eckd_private
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
r_private
op_eq
l_int|NULL
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;memory allocation failed for private &quot;
l_string|&quot;data&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|device
op_member_access_from_pointer
r_private
op_assign
(paren
r_void
op_star
)paren
r_private
suffix:semicolon
)brace
multiline_comment|/* Invalidate status of initial analysis. */
r_private
op_member_access_from_pointer
id|init_cqr_status
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Set default cache operations. */
r_private
op_member_access_from_pointer
id|attrib.operation
op_assign
id|DASD_NORMAL_CACHE
suffix:semicolon
r_private
op_member_access_from_pointer
id|attrib.nr_cyl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Read Device Characteristics */
id|rdc_data
op_assign
(paren
r_void
op_star
)paren
op_amp
(paren
r_private
op_member_access_from_pointer
id|rdc_data
)paren
suffix:semicolon
id|rc
op_assign
id|read_dev_chars
c_func
(paren
id|device-&gt;cdev
comma
op_amp
id|rdc_data
comma
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;Read device characteristics returned error %d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;%04X/%02X(CU:%04X/%02X) Cyl:%d Head:%d Sec:%d&quot;
comma
r_private
op_member_access_from_pointer
id|rdc_data.dev_type
comma
r_private
op_member_access_from_pointer
id|rdc_data.dev_model
comma
r_private
op_member_access_from_pointer
id|rdc_data.cu_type
comma
r_private
op_member_access_from_pointer
id|rdc_data.cu_model.model
comma
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
comma
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
comma
r_private
op_member_access_from_pointer
id|rdc_data.sec_per_trk
)paren
suffix:semicolon
multiline_comment|/* Read Configuration Data */
id|rc
op_assign
id|read_conf_data
c_func
(paren
id|device-&gt;cdev
comma
op_amp
id|conf_data
comma
op_amp
id|conf_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_and
id|rc
op_ne
op_minus
id|EOPNOTSUPP
)paren
(brace
multiline_comment|/* -EOPNOTSUPP is ok */
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;Read configuration data returned error %d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf_data
op_eq
l_int|NULL
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;No configuration data retrieved&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no errror */
)brace
r_if
c_cond
(paren
id|conf_len
op_ne
r_sizeof
(paren
r_struct
id|dasd_eckd_confdata
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;sizes of configuration data mismatch&quot;
l_string|&quot;%d (read) vs %ld (expected)&quot;
comma
id|conf_len
comma
r_sizeof
(paren
r_struct
id|dasd_eckd_confdata
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|conf_data
)paren
suffix:semicolon
multiline_comment|/* allocated by read_conf_data() */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no errror */
)brace
id|memcpy
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|conf_data
comma
id|conf_data
comma
r_sizeof
(paren
r_struct
id|dasd_eckd_confdata
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|conf_data
)paren
suffix:semicolon
multiline_comment|/* allocated by read_conf_data() */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_eckd_analysis_ccw
id|dasd_eckd_analysis_ccw
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|eckd_count
op_star
id|count_data
suffix:semicolon
r_struct
id|LO_eckd_data
op_star
id|LO_data
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_int
id|cplength
comma
id|datasize
suffix:semicolon
r_int
id|i
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|cplength
op_assign
l_int|8
suffix:semicolon
id|datasize
op_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
op_plus
l_int|2
op_star
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
suffix:semicolon
id|cqr
op_assign
id|dasd_smalloc_request
c_func
(paren
id|dasd_eckd_discipline.name
comma
id|cplength
comma
id|datasize
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cqr
)paren
)paren
r_return
id|cqr
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
multiline_comment|/* Define extent for the first 3 tracks. */
id|define_extent
c_func
(paren
id|ccw
op_increment
comma
id|cqr-&gt;data
comma
l_int|0
comma
l_int|2
comma
id|DASD_ECKD_CCW_READ_COUNT
comma
id|device
)paren
suffix:semicolon
id|LO_data
op_assign
id|cqr-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
suffix:semicolon
multiline_comment|/* Locate record for the first 4 records on track 0. */
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|locate_record
c_func
(paren
id|ccw
op_increment
comma
id|LO_data
op_increment
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
id|DASD_ECKD_CCW_READ_COUNT
comma
id|device
comma
l_int|0
)paren
suffix:semicolon
id|count_data
op_assign
r_private
op_member_access_from_pointer
id|count_area
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_READ_COUNT
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|count_data
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|count_data
op_increment
suffix:semicolon
)brace
multiline_comment|/* Locate record for the first record on track 2. */
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|locate_record
c_func
(paren
id|ccw
op_increment
comma
id|LO_data
op_increment
comma
l_int|2
comma
l_int|0
comma
l_int|1
comma
id|DASD_ECKD_CCW_READ_COUNT
comma
id|device
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Read count ccw. */
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_READ_COUNT
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|count_data
suffix:semicolon
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the callback function for the init_analysis cqr. It saves&n; * the status of the initial analysis ccw before it frees it and kicks&n; * the device to continue the startup sequence. This will call&n; * dasd_eckd_do_analysis again (if the devices has not been marked&n; * for deletion in the meantime).&n; */
r_static
r_void
DECL|function|dasd_eckd_analysis_callback
id|dasd_eckd_analysis_callback
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|init_cqr
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
id|device
op_assign
id|init_cqr-&gt;device
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_private
op_member_access_from_pointer
id|init_cqr_status
op_assign
id|init_cqr-&gt;status
suffix:semicolon
id|dasd_sfree_request
c_func
(paren
id|init_cqr
comma
id|device
)paren
suffix:semicolon
id|dasd_kick_device
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_start_analysis
id|dasd_eckd_start_analysis
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|init_cqr
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|init_cqr
op_assign
id|dasd_eckd_analysis_ccw
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|init_cqr
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|init_cqr
)paren
suffix:semicolon
id|init_cqr-&gt;callback
op_assign
id|dasd_eckd_analysis_callback
suffix:semicolon
id|init_cqr-&gt;callback_data
op_assign
l_int|NULL
suffix:semicolon
id|init_cqr-&gt;expires
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|dasd_add_request_head
c_func
(paren
id|init_cqr
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_end_analysis
id|dasd_eckd_end_analysis
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|eckd_count
op_star
id|count_area
suffix:semicolon
r_int
r_int
id|sb
comma
id|blk_per_trk
suffix:semicolon
r_int
id|status
comma
id|i
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|status
op_assign
r_private
op_member_access_from_pointer
id|init_cqr_status
suffix:semicolon
r_private
op_member_access_from_pointer
id|init_cqr_status
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|DASD_CQR_DONE
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;volume analysis returned unformatted disk&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EMEDIUMTYPE
suffix:semicolon
)brace
r_private
op_member_access_from_pointer
id|uses_cdl
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Calculate number of blocks/records per track. */
id|blk_per_trk
op_assign
id|recs_per_track
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|device-&gt;bp_block
)paren
suffix:semicolon
multiline_comment|/* Check Track 0 for Compatible Disk Layout */
id|count_area
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
id|i
)braket
dot
id|kl
op_ne
l_int|4
op_logical_or
r_private
op_member_access_from_pointer
id|count_area
(braket
id|i
)braket
dot
id|dl
op_ne
id|dasd_eckd_cdl_reclen
c_func
(paren
id|i
)paren
op_minus
l_int|4
)paren
(brace
r_private
op_member_access_from_pointer
id|uses_cdl
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|3
)paren
id|count_area
op_assign
op_amp
r_private
op_member_access_from_pointer
id|count_area
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
id|i
)braket
dot
id|kl
op_ne
l_int|0
)paren
op_logical_or
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
id|i
)braket
dot
id|dl
op_ne
r_private
op_member_access_from_pointer
id|count_area
(braket
l_int|0
)braket
dot
id|dl
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|5
)paren
id|count_area
op_assign
op_amp
r_private
op_member_access_from_pointer
id|count_area
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|count_area
(braket
l_int|3
)braket
dot
id|record
op_eq
l_int|1
)paren
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Trk 0: no records after VTOC!&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count_area
op_ne
l_int|NULL
op_logical_and
id|count_area-&gt;kl
op_eq
l_int|0
)paren
(brace
multiline_comment|/* we found notthing violating our disk layout */
r_if
c_cond
(paren
id|dasd_check_blocksize
c_func
(paren
id|count_area-&gt;dl
)paren
op_eq
l_int|0
)paren
id|device-&gt;bp_block
op_assign
id|count_area-&gt;dl
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;bp_block
op_eq
l_int|0
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Volume has incompatible disk layout&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EMEDIUMTYPE
suffix:semicolon
)brace
id|device-&gt;s2b_shift
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* bits to shift 512 to get a block */
r_for
c_loop
(paren
id|sb
op_assign
l_int|512
suffix:semicolon
id|sb
OL
id|device-&gt;bp_block
suffix:semicolon
id|sb
op_assign
id|sb
op_lshift
l_int|1
)paren
id|device-&gt;s2b_shift
op_increment
suffix:semicolon
id|blk_per_trk
op_assign
id|recs_per_track
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|device-&gt;bp_block
)paren
suffix:semicolon
id|device-&gt;blocks
op_assign
(paren
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_star
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
op_star
id|blk_per_trk
)paren
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;(%dkB blks): %dkB at %dkB/trk %s&quot;
comma
(paren
id|device-&gt;bp_block
op_rshift
l_int|10
)paren
comma
(paren
(paren
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_star
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
op_star
id|blk_per_trk
op_star
(paren
id|device-&gt;bp_block
op_rshift
l_int|9
)paren
)paren
op_rshift
l_int|1
)paren
comma
(paren
(paren
id|blk_per_trk
op_star
id|device-&gt;bp_block
)paren
op_rshift
l_int|10
)paren
comma
r_private
op_member_access_from_pointer
id|uses_cdl
ques
c_cond
l_string|&quot;compatible disk layout&quot;
suffix:colon
l_string|&quot;linux disk layout&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_do_analysis
id|dasd_eckd_do_analysis
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|init_cqr_status
OL
l_int|0
)paren
r_return
id|dasd_eckd_start_analysis
c_func
(paren
id|device
)paren
suffix:semicolon
r_else
r_return
id|dasd_eckd_end_analysis
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_fill_geometry
id|dasd_eckd_fill_geometry
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
comma
r_struct
id|hd_geometry
op_star
id|geo
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|dasd_check_blocksize
c_func
(paren
id|device-&gt;bp_block
)paren
op_eq
l_int|0
)paren
(brace
id|geo-&gt;sectors
op_assign
id|recs_per_track
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|device-&gt;bp_block
)paren
suffix:semicolon
)brace
id|geo-&gt;cylinders
op_assign
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
suffix:semicolon
id|geo-&gt;heads
op_assign
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_eckd_format_device
id|dasd_eckd_format_device
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
comma
r_struct
id|format_data_t
op_star
id|fdata
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|fcp
suffix:semicolon
r_struct
id|eckd_count
op_star
id|ect
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_void
op_star
id|data
suffix:semicolon
r_int
id|rpt
comma
id|cyl
comma
id|head
suffix:semicolon
r_int
id|cplength
comma
id|datasize
suffix:semicolon
r_int
id|i
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|rpt
op_assign
id|recs_per_track
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|fdata-&gt;blksize
)paren
suffix:semicolon
id|cyl
op_assign
id|fdata-&gt;start_unit
op_div
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
id|head
op_assign
id|fdata-&gt;start_unit
op_mod
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
suffix:semicolon
multiline_comment|/* Sanity checks. */
r_if
c_cond
(paren
id|fdata-&gt;start_unit
op_ge
(paren
r_private
op_member_access_from_pointer
id|rdc_data.no_cyl
op_star
r_private
op_member_access_from_pointer
id|rdc_data.trk_per_cyl
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;Track no %d too big!&quot;
comma
id|fdata-&gt;start_unit
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fdata-&gt;start_unit
OG
id|fdata-&gt;stop_unit
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;Track %d reached! ending.&quot;
comma
id|fdata-&gt;start_unit
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dasd_check_blocksize
c_func
(paren
id|fdata-&gt;blksize
)paren
op_ne
l_int|0
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;Invalid blocksize %d...terminating!&quot;
comma
id|fdata-&gt;blksize
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * fdata-&gt;intensity is a bit string that tells us what to do:&n;&t; *   Bit 0: write record zero&n;&t; *   Bit 1: write home address, currently not supported&n;&t; *   Bit 2: invalidate tracks&n;&t; *   Bit 3: use OS/390 compatible disk layout (cdl)&n;&t; * Only some bit combinations do make sense.&n;&t; */
r_switch
c_cond
(paren
id|fdata-&gt;intensity
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* Normal format */
r_case
l_int|0x08
suffix:colon
multiline_comment|/* Normal format, use cdl. */
id|cplength
op_assign
l_int|2
op_plus
id|rpt
suffix:semicolon
id|datasize
op_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
op_plus
id|rpt
op_star
r_sizeof
(paren
r_struct
id|eckd_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Write record zero and format track. */
r_case
l_int|0x09
suffix:colon
multiline_comment|/* Write record zero and format track, use cdl. */
id|cplength
op_assign
l_int|3
op_plus
id|rpt
suffix:semicolon
id|datasize
op_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|eckd_count
)paren
op_plus
id|rpt
op_star
r_sizeof
(paren
r_struct
id|eckd_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* Invalidate track. */
r_case
l_int|0x0c
suffix:colon
multiline_comment|/* Invalidate track, use cdl. */
id|cplength
op_assign
l_int|3
suffix:semicolon
id|datasize
op_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|eckd_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;Invalid flags 0x%x.&quot;
comma
id|fdata-&gt;intensity
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate the format ccw request. */
id|fcp
op_assign
id|dasd_smalloc_request
c_func
(paren
id|dasd_eckd_discipline.name
comma
id|cplength
comma
id|datasize
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|fcp
)paren
)paren
r_return
id|fcp
suffix:semicolon
id|data
op_assign
id|fcp-&gt;data
suffix:semicolon
id|ccw
op_assign
id|fcp-&gt;cpaddr
suffix:semicolon
r_switch
c_cond
(paren
id|fdata-&gt;intensity
op_amp
op_complement
l_int|0x08
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* Normal format. */
id|define_extent
c_func
(paren
id|ccw
op_increment
comma
(paren
r_struct
id|DE_eckd_data
op_star
)paren
id|data
comma
id|fdata-&gt;start_unit
comma
id|fdata-&gt;start_unit
comma
id|DASD_ECKD_CCW_WRITE_CKD
comma
id|device
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
suffix:semicolon
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|locate_record
c_func
(paren
id|ccw
op_increment
comma
(paren
r_struct
id|LO_eckd_data
op_star
)paren
id|data
comma
id|fdata-&gt;start_unit
comma
l_int|0
comma
id|rpt
comma
id|DASD_ECKD_CCW_WRITE_CKD
comma
id|device
comma
id|fdata-&gt;blksize
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Write record zero + format track. */
id|define_extent
c_func
(paren
id|ccw
op_increment
comma
(paren
r_struct
id|DE_eckd_data
op_star
)paren
id|data
comma
id|fdata-&gt;start_unit
comma
id|fdata-&gt;start_unit
comma
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
comma
id|device
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
suffix:semicolon
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|locate_record
c_func
(paren
id|ccw
op_increment
comma
(paren
r_struct
id|LO_eckd_data
op_star
)paren
id|data
comma
id|fdata-&gt;start_unit
comma
l_int|0
comma
id|rpt
op_plus
l_int|1
comma
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
comma
id|device
comma
id|device-&gt;bp_block
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* Invalidate track. */
id|define_extent
c_func
(paren
id|ccw
op_increment
comma
(paren
r_struct
id|DE_eckd_data
op_star
)paren
id|data
comma
id|fdata-&gt;start_unit
comma
id|fdata-&gt;start_unit
comma
id|DASD_ECKD_CCW_WRITE_CKD
comma
id|device
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
suffix:semicolon
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|locate_record
c_func
(paren
id|ccw
op_increment
comma
(paren
r_struct
id|LO_eckd_data
op_star
)paren
id|data
comma
id|fdata-&gt;start_unit
comma
l_int|0
comma
l_int|1
comma
id|DASD_ECKD_CCW_WRITE_CKD
comma
id|device
comma
l_int|8
)paren
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x01
)paren
(brace
multiline_comment|/* write record zero */
id|ect
op_assign
(paren
r_struct
id|eckd_count
op_star
)paren
id|data
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|eckd_count
)paren
suffix:semicolon
id|ect-&gt;cyl
op_assign
id|cyl
suffix:semicolon
id|ect-&gt;head
op_assign
id|head
suffix:semicolon
id|ect-&gt;record
op_assign
l_int|0
suffix:semicolon
id|ect-&gt;kl
op_assign
l_int|0
suffix:semicolon
id|ect-&gt;dl
op_assign
l_int|8
suffix:semicolon
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_WRITE_RECORD_ZERO
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|ect
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|fdata-&gt;intensity
op_amp
op_complement
l_int|0x08
)paren
op_amp
l_int|0x04
)paren
(brace
multiline_comment|/* erase track */
id|ect
op_assign
(paren
r_struct
id|eckd_count
op_star
)paren
id|data
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|eckd_count
)paren
suffix:semicolon
id|ect-&gt;cyl
op_assign
id|cyl
suffix:semicolon
id|ect-&gt;head
op_assign
id|head
suffix:semicolon
id|ect-&gt;record
op_assign
l_int|1
suffix:semicolon
id|ect-&gt;kl
op_assign
l_int|0
suffix:semicolon
id|ect-&gt;dl
op_assign
l_int|0
suffix:semicolon
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_WRITE_CKD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|ect
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* write remaining records */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rpt
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ect
op_assign
(paren
r_struct
id|eckd_count
op_star
)paren
id|data
suffix:semicolon
id|data
op_add_assign
r_sizeof
(paren
r_struct
id|eckd_count
)paren
suffix:semicolon
id|ect-&gt;cyl
op_assign
id|cyl
suffix:semicolon
id|ect-&gt;head
op_assign
id|head
suffix:semicolon
id|ect-&gt;record
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
id|ect-&gt;kl
op_assign
l_int|0
suffix:semicolon
id|ect-&gt;dl
op_assign
id|fdata-&gt;blksize
suffix:semicolon
multiline_comment|/* Check for special tracks 0-1 when formatting CDL */
r_if
c_cond
(paren
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x08
)paren
op_logical_and
id|fdata-&gt;start_unit
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|3
)paren
(brace
id|ect-&gt;kl
op_assign
l_int|4
suffix:semicolon
id|ect-&gt;dl
op_assign
id|sizes_trk0
(braket
id|i
)braket
op_minus
l_int|4
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|fdata-&gt;intensity
op_amp
l_int|0x08
)paren
op_logical_and
id|fdata-&gt;start_unit
op_eq
l_int|1
)paren
(brace
id|ect-&gt;kl
op_assign
l_int|44
suffix:semicolon
id|ect-&gt;dl
op_assign
id|LABEL_SIZE
op_minus
l_int|44
suffix:semicolon
)brace
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_WRITE_CKD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|ect
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
)brace
id|fcp-&gt;device
op_assign
id|device
suffix:semicolon
id|fcp-&gt;retries
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* set retry counter to enable ERP */
id|fcp-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|fcp-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
r_return
id|fcp
suffix:semicolon
)brace
r_static
id|dasd_era_t
DECL|function|dasd_eckd_examine_error
id|dasd_eckd_examine_error
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
(paren
r_struct
id|dasd_device
op_star
)paren
id|cqr-&gt;device
suffix:semicolon
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|device-&gt;cdev
suffix:semicolon
r_if
c_cond
(paren
id|irb-&gt;scsw.cstat
op_eq
l_int|0x00
op_logical_and
id|irb-&gt;scsw.dstat
op_eq
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
r_return
id|dasd_era_none
suffix:semicolon
r_switch
c_cond
(paren
id|cdev-&gt;id.cu_type
)paren
(brace
r_case
l_int|0x3990
suffix:colon
r_case
l_int|0x2105
suffix:colon
r_case
l_int|0x2107
suffix:colon
r_case
l_int|0x1750
suffix:colon
r_return
id|dasd_3990_erp_examine
c_func
(paren
id|cqr
comma
id|irb
)paren
suffix:semicolon
r_case
l_int|0x9343
suffix:colon
r_return
id|dasd_9343_erp_examine
c_func
(paren
id|cqr
comma
id|irb
)paren
suffix:semicolon
r_case
l_int|0x3880
suffix:colon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;default (unknown CU type) - RECOVERABLE return&quot;
)paren
suffix:semicolon
r_return
id|dasd_era_recover
suffix:semicolon
)brace
)brace
r_static
id|dasd_erp_fn_t
DECL|function|dasd_eckd_erp_action
id|dasd_eckd_erp_action
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
(paren
r_struct
id|dasd_device
op_star
)paren
id|cqr-&gt;device
suffix:semicolon
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|device-&gt;cdev
suffix:semicolon
r_switch
c_cond
(paren
id|cdev-&gt;id.cu_type
)paren
(brace
r_case
l_int|0x3990
suffix:colon
r_case
l_int|0x2105
suffix:colon
r_case
l_int|0x2107
suffix:colon
r_case
l_int|0x1750
suffix:colon
r_return
id|dasd_3990_erp_action
suffix:semicolon
r_case
l_int|0x9343
suffix:colon
r_case
l_int|0x3880
suffix:colon
r_default
suffix:colon
r_return
id|dasd_default_erp_action
suffix:semicolon
)brace
)brace
r_static
id|dasd_erp_fn_t
DECL|function|dasd_eckd_erp_postaction
id|dasd_eckd_erp_postaction
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
)paren
(brace
r_return
id|dasd_default_erp_postaction
suffix:semicolon
)brace
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_eckd_build_cp
id|dasd_eckd_build_cp
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
comma
r_struct
id|request
op_star
id|req
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_int
r_int
op_star
id|idaws
suffix:semicolon
r_struct
id|LO_eckd_data
op_star
id|LO_data
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bv
suffix:semicolon
r_char
op_star
id|dst
suffix:semicolon
r_int
r_int
id|blksize
comma
id|blk_per_trk
comma
id|off
suffix:semicolon
r_int
id|count
comma
id|cidaw
comma
id|cplength
comma
id|datasize
suffix:semicolon
id|sector_t
id|recid
comma
id|first_rec
comma
id|last_rec
suffix:semicolon
id|sector_t
id|first_trk
comma
id|last_trk
suffix:semicolon
r_int
r_int
id|first_offs
comma
id|last_offs
suffix:semicolon
r_int
r_char
id|cmd
comma
id|rcmd
suffix:semicolon
r_int
id|i
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|READ
)paren
id|cmd
op_assign
id|DASD_ECKD_CCW_READ_MT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|WRITE
)paren
id|cmd
op_assign
id|DASD_ECKD_CCW_WRITE_MT
suffix:semicolon
r_else
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* Calculate number of blocks/records per track. */
id|blksize
op_assign
id|device-&gt;bp_block
suffix:semicolon
id|blk_per_trk
op_assign
id|recs_per_track
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|blksize
)paren
suffix:semicolon
multiline_comment|/* Calculate record id of first and last block. */
id|first_rec
op_assign
id|first_trk
op_assign
id|req-&gt;sector
op_rshift
id|device-&gt;s2b_shift
suffix:semicolon
id|first_offs
op_assign
id|sector_div
c_func
(paren
id|first_trk
comma
id|blk_per_trk
)paren
suffix:semicolon
id|last_rec
op_assign
id|last_trk
op_assign
(paren
id|req-&gt;sector
op_plus
id|req-&gt;nr_sectors
op_minus
l_int|1
)paren
op_rshift
id|device-&gt;s2b_shift
suffix:semicolon
id|last_offs
op_assign
id|sector_div
c_func
(paren
id|last_trk
comma
id|blk_per_trk
)paren
suffix:semicolon
multiline_comment|/* Check struct bio and count the number of blocks for the request. */
id|count
op_assign
l_int|0
suffix:semicolon
id|cidaw
op_assign
l_int|0
suffix:semicolon
id|rq_for_each_bio
c_func
(paren
id|bio
comma
id|req
)paren
(brace
id|bio_for_each_segment
c_func
(paren
id|bv
comma
id|bio
comma
id|i
)paren
(brace
r_if
c_cond
(paren
id|bv-&gt;bv_len
op_amp
(paren
id|blksize
op_minus
l_int|1
)paren
)paren
multiline_comment|/* Eckd can only do full blocks. */
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|count
op_add_assign
id|bv-&gt;bv_len
op_rshift
(paren
id|device-&gt;s2b_shift
op_plus
l_int|9
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_ARCH_S390X)
r_if
c_cond
(paren
id|idal_is_needed
(paren
id|page_address
c_func
(paren
id|bv-&gt;bv_page
)paren
comma
id|bv-&gt;bv_len
)paren
)paren
id|cidaw
op_add_assign
id|bv-&gt;bv_len
op_rshift
(paren
id|device-&gt;s2b_shift
op_plus
l_int|9
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/* Paranoia. */
r_if
c_cond
(paren
id|count
op_ne
id|last_rec
op_minus
id|first_rec
op_plus
l_int|1
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* 1x define extent + 1x locate record + number of blocks */
id|cplength
op_assign
l_int|2
op_plus
id|count
suffix:semicolon
multiline_comment|/* 1x define extent + 1x locate record + cidaws*sizeof(long) */
id|datasize
op_assign
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
op_plus
id|cidaw
op_star
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* Find out the number of additional locate record ccws for cdl. */
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_logical_and
id|first_rec
OL
l_int|2
op_star
id|blk_per_trk
)paren
(brace
r_if
c_cond
(paren
id|last_rec
op_ge
l_int|2
op_star
id|blk_per_trk
)paren
id|count
op_assign
l_int|2
op_star
id|blk_per_trk
op_minus
id|first_rec
suffix:semicolon
id|cplength
op_add_assign
id|count
suffix:semicolon
id|datasize
op_add_assign
id|count
op_star
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate the ccw request. */
id|cqr
op_assign
id|dasd_smalloc_request
c_func
(paren
id|dasd_eckd_discipline.name
comma
id|cplength
comma
id|datasize
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cqr
)paren
)paren
r_return
id|cqr
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
multiline_comment|/* First ccw is define extent. */
id|define_extent
c_func
(paren
id|ccw
op_increment
comma
id|cqr-&gt;data
comma
id|first_trk
comma
id|last_trk
comma
id|cmd
comma
id|device
)paren
suffix:semicolon
multiline_comment|/* Build locate_record+read/write/ccws. */
id|idaws
op_assign
(paren
r_int
r_int
op_star
)paren
(paren
id|cqr-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
)paren
suffix:semicolon
id|LO_data
op_assign
(paren
r_struct
id|LO_eckd_data
op_star
)paren
(paren
id|idaws
op_plus
id|cidaw
)paren
suffix:semicolon
id|recid
op_assign
id|first_rec
suffix:semicolon
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_eq
l_int|0
op_logical_or
id|recid
OG
l_int|2
op_star
id|blk_per_trk
)paren
(brace
multiline_comment|/* Only standard blocks so there is just one locate record. */
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|locate_record
c_func
(paren
id|ccw
op_increment
comma
id|LO_data
op_increment
comma
id|first_trk
comma
id|first_offs
op_plus
l_int|1
comma
id|last_rec
op_minus
id|recid
op_plus
l_int|1
comma
id|cmd
comma
id|device
comma
id|blksize
)paren
suffix:semicolon
)brace
id|rq_for_each_bio
c_func
(paren
id|bio
comma
id|req
)paren
id|bio_for_each_segment
c_func
(paren
id|bv
comma
id|bio
comma
id|i
)paren
(brace
id|dst
op_assign
id|page_address
c_func
(paren
id|bv-&gt;bv_page
)paren
op_plus
id|bv-&gt;bv_offset
suffix:semicolon
r_if
c_cond
(paren
id|dasd_page_cache
)paren
(brace
r_char
op_star
id|copy
op_assign
id|kmem_cache_alloc
c_func
(paren
id|dasd_page_cache
comma
id|SLAB_DMA
op_or
id|__GFP_NOWARN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy
op_logical_and
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|WRITE
)paren
id|memcpy
c_func
(paren
id|copy
op_plus
id|bv-&gt;bv_offset
comma
id|dst
comma
id|bv-&gt;bv_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy
)paren
id|dst
op_assign
id|copy
op_plus
id|bv-&gt;bv_offset
suffix:semicolon
)brace
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|bv-&gt;bv_len
suffix:semicolon
id|off
op_add_assign
id|blksize
)paren
(brace
id|sector_t
id|trkid
op_assign
id|recid
suffix:semicolon
r_int
r_int
id|recoffs
op_assign
id|sector_div
c_func
(paren
id|trkid
comma
id|blk_per_trk
)paren
suffix:semicolon
id|rcmd
op_assign
id|cmd
suffix:semicolon
id|count
op_assign
id|blksize
suffix:semicolon
multiline_comment|/* Locate record for cdl special block ? */
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_logical_and
id|recid
OL
l_int|2
op_star
id|blk_per_trk
)paren
(brace
r_if
c_cond
(paren
id|dasd_eckd_cdl_special
c_func
(paren
id|blk_per_trk
comma
id|recid
)paren
)paren
(brace
id|rcmd
op_or_assign
l_int|0x8
suffix:semicolon
id|count
op_assign
id|dasd_eckd_cdl_reclen
c_func
(paren
id|recid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|blksize
)paren
id|memset
c_func
(paren
id|dst
op_plus
id|count
comma
l_int|0xe5
comma
id|blksize
op_minus
id|count
)paren
suffix:semicolon
)brace
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|locate_record
c_func
(paren
id|ccw
op_increment
comma
id|LO_data
op_increment
comma
id|trkid
comma
id|recoffs
op_plus
l_int|1
comma
l_int|1
comma
id|rcmd
comma
id|device
comma
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/* Locate record for standard blocks ? */
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_logical_and
id|recid
op_eq
l_int|2
op_star
id|blk_per_trk
)paren
(brace
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|locate_record
c_func
(paren
id|ccw
op_increment
comma
id|LO_data
op_increment
comma
id|trkid
comma
id|recoffs
op_plus
l_int|1
comma
id|last_rec
op_minus
id|recid
op_plus
l_int|1
comma
id|cmd
comma
id|device
comma
id|count
)paren
suffix:semicolon
)brace
multiline_comment|/* Read/write ccw. */
id|ccw
(braket
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|rcmd
suffix:semicolon
id|ccw-&gt;count
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|idal_is_needed
c_func
(paren
id|dst
comma
id|blksize
)paren
)paren
(brace
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|idaws
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_IDA
suffix:semicolon
id|idaws
op_assign
id|idal_create_words
c_func
(paren
id|idaws
comma
id|dst
comma
id|blksize
)paren
suffix:semicolon
)brace
r_else
(brace
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|dst
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
)brace
id|ccw
op_increment
suffix:semicolon
id|dst
op_add_assign
id|blksize
suffix:semicolon
id|recid
op_increment
suffix:semicolon
)brace
)brace
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|cqr-&gt;expires
op_assign
l_int|5
op_star
l_int|60
op_star
id|HZ
suffix:semicolon
multiline_comment|/* 5 minutes */
id|cqr-&gt;lpm
op_assign
id|LPM_ANYPATH
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|cqr-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_free_cp
id|dasd_eckd_free_cp
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
comma
r_struct
id|request
op_star
id|req
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bv
suffix:semicolon
r_char
op_star
id|dst
comma
op_star
id|cda
suffix:semicolon
r_int
r_int
id|blksize
comma
id|blk_per_trk
comma
id|off
suffix:semicolon
id|sector_t
id|recid
suffix:semicolon
r_int
id|i
comma
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dasd_page_cache
)paren
r_goto
id|out
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|cqr-&gt;device
op_member_access_from_pointer
r_private
suffix:semicolon
id|blksize
op_assign
id|cqr-&gt;device-&gt;bp_block
suffix:semicolon
id|blk_per_trk
op_assign
id|recs_per_track
c_func
(paren
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
l_int|0
comma
id|blksize
)paren
suffix:semicolon
id|recid
op_assign
id|req-&gt;sector
op_rshift
id|cqr-&gt;device-&gt;s2b_shift
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
multiline_comment|/* Skip over define extent &amp; locate record. */
id|ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_eq
l_int|0
op_logical_or
id|recid
OG
l_int|2
op_star
id|blk_per_trk
)paren
id|ccw
op_increment
suffix:semicolon
id|rq_for_each_bio
c_func
(paren
id|bio
comma
id|req
)paren
id|bio_for_each_segment
c_func
(paren
id|bv
comma
id|bio
comma
id|i
)paren
(brace
id|dst
op_assign
id|page_address
c_func
(paren
id|bv-&gt;bv_page
)paren
op_plus
id|bv-&gt;bv_offset
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|bv-&gt;bv_len
suffix:semicolon
id|off
op_add_assign
id|blksize
)paren
(brace
multiline_comment|/* Skip locate record. */
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|uses_cdl
op_logical_and
id|recid
op_le
l_int|2
op_star
id|blk_per_trk
)paren
id|ccw
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dst
)paren
(brace
r_if
c_cond
(paren
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_IDA
)paren
id|cda
op_assign
op_star
(paren
(paren
r_char
op_star
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|ccw-&gt;cda
)paren
)paren
suffix:semicolon
r_else
id|cda
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|ccw-&gt;cda
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst
op_ne
id|cda
)paren
(brace
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|READ
)paren
id|memcpy
c_func
(paren
id|dst
comma
id|cda
comma
id|bv-&gt;bv_len
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|dasd_page_cache
comma
(paren
r_void
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|cda
op_amp
id|PAGE_MASK
)paren
)paren
suffix:semicolon
)brace
id|dst
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_increment
suffix:semicolon
id|recid
op_increment
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|status
op_assign
id|cqr-&gt;status
op_eq
id|DASD_CQR_DONE
suffix:semicolon
id|dasd_sfree_request
c_func
(paren
id|cqr
comma
id|cqr-&gt;device
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_eckd_fill_info
id|dasd_eckd_fill_info
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
comma
r_struct
id|dasd_information2_t
op_star
id|info
)paren
(brace
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|info-&gt;label_block
op_assign
l_int|2
suffix:semicolon
id|info-&gt;FBA_layout
op_assign
r_private
op_member_access_from_pointer
id|uses_cdl
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|info-&gt;format
op_assign
r_private
op_member_access_from_pointer
id|uses_cdl
ques
c_cond
id|DASD_FORMAT_CDL
suffix:colon
id|DASD_FORMAT_LDL
suffix:semicolon
id|info-&gt;characteristics_size
op_assign
r_sizeof
(paren
r_struct
id|dasd_eckd_characteristics
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;characteristics
comma
op_amp
r_private
op_member_access_from_pointer
id|rdc_data
comma
r_sizeof
(paren
r_struct
id|dasd_eckd_characteristics
)paren
)paren
suffix:semicolon
id|info-&gt;confdata_size
op_assign
r_sizeof
(paren
r_struct
id|dasd_eckd_confdata
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;configuration_data
comma
op_amp
r_private
op_member_access_from_pointer
id|conf_data
comma
r_sizeof
(paren
r_struct
id|dasd_eckd_confdata
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * SECTION: ioctl functions for eckd devices.&n; */
multiline_comment|/*&n; * Release device ioctl.&n; * Buils a channel programm to releases a prior reserved &n; * (see dasd_eckd_reserve) device.&n; */
r_static
r_int
DECL|function|dasd_eckd_release
id|dasd_eckd_release
c_func
(paren
r_struct
id|block_device
op_star
id|bdev
comma
r_int
id|no
comma
r_int
id|args
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|device
op_assign
id|bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|cqr
op_assign
id|dasd_smalloc_request
c_func
(paren
id|dasd_eckd_discipline.name
comma
l_int|1
comma
l_int|32
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cqr
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Could not allocate initialization request&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|cqr
)paren
suffix:semicolon
)brace
id|cqr-&gt;cpaddr-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_RELEASE
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;flags
op_or_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;count
op_assign
l_int|32
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|cqr-&gt;data
suffix:semicolon
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|clear_bit
c_func
(paren
id|DASD_CQR_FLAGS_USE_ERP
comma
op_amp
id|cqr-&gt;flags
)paren
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;expires
op_assign
l_int|2
op_star
id|HZ
suffix:semicolon
id|cqr-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
id|rc
op_assign
id|dasd_sleep_on_immediatly
c_func
(paren
id|cqr
)paren
suffix:semicolon
id|dasd_sfree_request
c_func
(paren
id|cqr
comma
id|cqr-&gt;device
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Reserve device ioctl.&n; * Options are set to &squot;synchronous wait for interrupt&squot; and&n; * &squot;timeout the request&squot;. This leads to a terminate IO if &n; * the interrupt is outstanding for a certain time. &n; */
r_static
r_int
DECL|function|dasd_eckd_reserve
id|dasd_eckd_reserve
c_func
(paren
r_struct
id|block_device
op_star
id|bdev
comma
r_int
id|no
comma
r_int
id|args
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|device
op_assign
id|bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|cqr
op_assign
id|dasd_smalloc_request
c_func
(paren
id|dasd_eckd_discipline.name
comma
l_int|1
comma
l_int|32
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cqr
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Could not allocate initialization request&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|cqr
)paren
suffix:semicolon
)brace
id|cqr-&gt;cpaddr-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_RESERVE
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;flags
op_or_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;count
op_assign
l_int|32
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|cqr-&gt;data
suffix:semicolon
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|clear_bit
c_func
(paren
id|DASD_CQR_FLAGS_USE_ERP
comma
op_amp
id|cqr-&gt;flags
)paren
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;expires
op_assign
l_int|2
op_star
id|HZ
suffix:semicolon
id|cqr-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
id|rc
op_assign
id|dasd_sleep_on_immediatly
c_func
(paren
id|cqr
)paren
suffix:semicolon
id|dasd_sfree_request
c_func
(paren
id|cqr
comma
id|cqr-&gt;device
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Steal lock ioctl - unconditional reserve device.&n; * Buils a channel programm to break a device&squot;s reservation. &n; * (unconditional reserve)&n; */
r_static
r_int
DECL|function|dasd_eckd_steal_lock
id|dasd_eckd_steal_lock
c_func
(paren
r_struct
id|block_device
op_star
id|bdev
comma
r_int
id|no
comma
r_int
id|args
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|device
op_assign
id|bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|cqr
op_assign
id|dasd_smalloc_request
c_func
(paren
id|dasd_eckd_discipline.name
comma
l_int|1
comma
l_int|32
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cqr
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Could not allocate initialization request&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|cqr
)paren
suffix:semicolon
)brace
id|cqr-&gt;cpaddr-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_SLCK
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;flags
op_or_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;count
op_assign
l_int|32
suffix:semicolon
id|cqr-&gt;cpaddr-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|cqr-&gt;data
suffix:semicolon
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|clear_bit
c_func
(paren
id|DASD_CQR_FLAGS_USE_ERP
comma
op_amp
id|cqr-&gt;flags
)paren
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;expires
op_assign
l_int|2
op_star
id|HZ
suffix:semicolon
id|cqr-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
id|rc
op_assign
id|dasd_sleep_on_immediatly
c_func
(paren
id|cqr
)paren
suffix:semicolon
id|dasd_sfree_request
c_func
(paren
id|cqr
comma
id|cqr-&gt;device
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Read performance statistics&n; */
r_static
r_int
DECL|function|dasd_eckd_performance
id|dasd_eckd_performance
c_func
(paren
r_struct
id|block_device
op_star
id|bdev
comma
r_int
id|no
comma
r_int
id|args
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
r_struct
id|dasd_psf_prssd_data
op_star
id|prssdp
suffix:semicolon
r_struct
id|dasd_rssd_perf_stats_t
op_star
id|stats
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|device
op_assign
id|bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|cqr
op_assign
id|dasd_smalloc_request
c_func
(paren
id|dasd_eckd_discipline.name
comma
l_int|1
multiline_comment|/* PSF */
op_plus
l_int|1
multiline_comment|/* RSSD */
comma
(paren
r_sizeof
(paren
r_struct
id|dasd_psf_prssd_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|dasd_rssd_perf_stats_t
)paren
)paren
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cqr
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Could not allocate initialization request&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|cqr
)paren
suffix:semicolon
)brace
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|cqr-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|cqr-&gt;expires
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
multiline_comment|/* Prepare for Read Subsystem Data */
id|prssdp
op_assign
(paren
r_struct
id|dasd_psf_prssd_data
op_star
)paren
id|cqr-&gt;data
suffix:semicolon
id|memset
c_func
(paren
id|prssdp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dasd_psf_prssd_data
)paren
)paren
suffix:semicolon
id|prssdp-&gt;order
op_assign
id|PSF_ORDER_PRSSD
suffix:semicolon
id|prssdp-&gt;suborder
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Perfomance Statistics */
id|prssdp-&gt;varies
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* Perf Statistics for the Subsystem */
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_PSF
suffix:semicolon
id|ccw-&gt;count
op_assign
r_sizeof
(paren
r_struct
id|dasd_psf_prssd_data
)paren
suffix:semicolon
id|ccw-&gt;flags
op_or_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|prssdp
suffix:semicolon
multiline_comment|/* Read Subsystem Data - Performance Statistics */
id|stats
op_assign
(paren
r_struct
id|dasd_rssd_perf_stats_t
op_star
)paren
(paren
id|prssdp
op_plus
l_int|1
)paren
suffix:semicolon
id|memset
c_func
(paren
id|stats
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dasd_rssd_perf_stats_t
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_RSSD
suffix:semicolon
id|ccw-&gt;count
op_assign
r_sizeof
(paren
r_struct
id|dasd_rssd_perf_stats_t
)paren
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|stats
suffix:semicolon
id|cqr-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
id|rc
op_assign
id|dasd_sleep_on
c_func
(paren
id|cqr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Prepare for Read Subsystem Data */
id|prssdp
op_assign
(paren
r_struct
id|dasd_psf_prssd_data
op_star
)paren
id|cqr-&gt;data
suffix:semicolon
id|stats
op_assign
(paren
r_struct
id|dasd_rssd_perf_stats_t
op_star
)paren
(paren
id|prssdp
op_plus
l_int|1
)paren
suffix:semicolon
id|rc
op_assign
id|copy_to_user
c_func
(paren
(paren
r_int
id|__user
op_star
)paren
id|args
comma
(paren
r_int
op_star
)paren
id|stats
comma
r_sizeof
(paren
r_struct
id|dasd_rssd_perf_stats_t
)paren
)paren
suffix:semicolon
)brace
id|dasd_sfree_request
c_func
(paren
id|cqr
comma
id|cqr-&gt;device
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Get attributes (cache operations)&n; * Returnes the cache attributes used in Define Extend (DE).&n; */
r_static
r_int
DECL|function|dasd_eckd_get_attrib
id|dasd_eckd_get_attrib
(paren
r_struct
id|block_device
op_star
id|bdev
comma
r_int
id|no
comma
r_int
id|args
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|attrib_data_t
id|attrib
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|args
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|device
op_assign
id|bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|attrib
op_assign
r_private
op_member_access_from_pointer
id|attrib
suffix:semicolon
id|rc
op_assign
id|copy_to_user
c_func
(paren
(paren
r_int
id|__user
op_star
)paren
id|args
comma
(paren
r_int
op_star
)paren
op_amp
id|attrib
comma
r_sizeof
(paren
r_struct
id|attrib_data_t
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Set attributes (cache operations)&n; * Stores the attributes for cache operation to be used in Define Extend (DE).&n; */
r_static
r_int
DECL|function|dasd_eckd_set_attrib
id|dasd_eckd_set_attrib
c_func
(paren
r_struct
id|block_device
op_star
id|bdev
comma
r_int
id|no
comma
r_int
id|args
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
r_struct
id|dasd_eckd_private
op_star
r_private
suffix:semicolon
r_struct
id|attrib_data_t
id|attrib
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|args
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|device
op_assign
id|bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|attrib
comma
(paren
r_void
id|__user
op_star
)paren
id|args
comma
r_sizeof
(paren
r_struct
id|attrib_data_t
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_private
op_assign
(paren
r_struct
id|dasd_eckd_private
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_private
op_member_access_from_pointer
id|attrib
op_assign
id|attrib
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;cache operation mode set to %x (%i cylinder prestage)&quot;
comma
r_private
op_member_access_from_pointer
id|attrib.operation
comma
r_private
op_member_access_from_pointer
id|attrib.nr_cyl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Print sense data and related channel program.&n; * Parts are printed because printk buffer is only 1024 bytes.&n; */
r_static
r_void
DECL|function|dasd_eckd_dump_sense
id|dasd_eckd_dump_sense
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
comma
r_struct
id|dasd_ccw_req
op_star
id|req
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_char
op_star
id|page
suffix:semicolon
r_struct
id|ccw1
op_star
id|act
comma
op_star
id|end
comma
op_star
id|last
suffix:semicolon
r_int
id|len
comma
id|sl
comma
id|sct
comma
id|count
suffix:semicolon
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot; %s&quot;
comma
l_string|&quot;No memory to dump sense data&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; I/O status report for device %s:&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; in req: %p CS: 0x%02X DS: 0x%02X&bslash;n&quot;
comma
id|req
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.dstat
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; device %s: Failing CCW: %p&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
comma
(paren
r_void
op_star
)paren
(paren
id|addr_t
)paren
id|irb-&gt;scsw.cpa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irb-&gt;esw.esw0.erw.cons
)paren
(brace
r_for
c_loop
(paren
id|sl
op_assign
l_int|0
suffix:semicolon
id|sl
OL
l_int|4
suffix:semicolon
id|sl
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; Sense(hex) %2d-%2d:&quot;
comma
(paren
l_int|8
op_star
id|sl
)paren
comma
(paren
(paren
l_int|8
op_star
id|sl
)paren
op_plus
l_int|7
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sct
op_assign
l_int|0
suffix:semicolon
id|sct
OL
l_int|8
suffix:semicolon
id|sct
op_increment
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; %02x&quot;
comma
id|irb-&gt;ecw
(braket
l_int|8
op_star
id|sl
op_plus
id|sct
)braket
)paren
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irb-&gt;ecw
(braket
l_int|27
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
(brace
multiline_comment|/* 24 Byte Sense Data */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; 24 Byte: %x MSG %x, &quot;
l_string|&quot;%s MSGb to SYSOP&bslash;n&quot;
comma
id|irb-&gt;ecw
(braket
l_int|7
)braket
op_rshift
l_int|4
comma
id|irb-&gt;ecw
(braket
l_int|7
)braket
op_amp
l_int|0x0f
comma
id|irb-&gt;ecw
(braket
l_int|1
)braket
op_amp
l_int|0x10
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* 32 Byte Sense Data */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; 32 Byte: Format: %x &quot;
l_string|&quot;Exception class %x&bslash;n&quot;
comma
id|irb-&gt;ecw
(braket
l_int|6
)braket
op_amp
l_int|0x0f
comma
id|irb-&gt;ecw
(braket
l_int|22
)braket
op_rshift
l_int|4
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; SORRY - NO VALID SENSE AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|MESSAGE_LOG
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s&quot;
comma
id|page
op_plus
r_sizeof
(paren
id|KERN_ERR
id|PRINTK_HEADER
)paren
)paren
suffix:semicolon
multiline_comment|/* dump the Channel Program */
multiline_comment|/* print first CCWs (maximum 8) */
id|act
op_assign
id|req-&gt;cpaddr
suffix:semicolon
r_for
c_loop
(paren
id|last
op_assign
id|act
suffix:semicolon
id|last-&gt;flags
op_amp
(paren
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_DC
)paren
suffix:semicolon
id|last
op_increment
)paren
suffix:semicolon
id|end
op_assign
id|min
c_func
(paren
id|act
op_plus
l_int|8
comma
id|last
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; Related CP in req: %p&bslash;n&quot;
comma
id|req
)paren
suffix:semicolon
r_while
c_loop
(paren
id|act
op_le
id|end
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; CCW %p: %08X %08X DAT:&quot;
comma
id|act
comma
(paren
(paren
r_int
op_star
)paren
id|act
)paren
(braket
l_int|0
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|act
)paren
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|32
op_logical_and
id|count
OL
id|act-&gt;count
suffix:semicolon
id|count
op_add_assign
r_sizeof
(paren
r_int
)paren
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; %08X&quot;
comma
(paren
(paren
r_int
op_star
)paren
(paren
id|addr_t
)paren
id|act-&gt;cda
)paren
(braket
(paren
id|count
op_rshift
l_int|2
)paren
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|act
op_increment
suffix:semicolon
)brace
id|MESSAGE_LOG
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s&quot;
comma
id|page
op_plus
r_sizeof
(paren
id|KERN_ERR
id|PRINTK_HEADER
)paren
)paren
suffix:semicolon
multiline_comment|/* print failing CCW area */
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|act
OL
(paren
(paren
r_struct
id|ccw1
op_star
)paren
(paren
id|addr_t
)paren
id|irb-&gt;scsw.cpa
)paren
op_minus
l_int|2
)paren
(brace
id|act
op_assign
(paren
(paren
r_struct
id|ccw1
op_star
)paren
(paren
id|addr_t
)paren
id|irb-&gt;scsw.cpa
)paren
op_minus
l_int|2
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;......&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|end
op_assign
id|min
c_func
(paren
(paren
r_struct
id|ccw1
op_star
)paren
(paren
id|addr_t
)paren
id|irb-&gt;scsw.cpa
op_plus
l_int|2
comma
id|last
)paren
suffix:semicolon
r_while
c_loop
(paren
id|act
op_le
id|end
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; CCW %p: %08X %08X DAT:&quot;
comma
id|act
comma
(paren
(paren
r_int
op_star
)paren
id|act
)paren
(braket
l_int|0
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|act
)paren
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|32
op_logical_and
id|count
OL
id|act-&gt;count
suffix:semicolon
id|count
op_add_assign
r_sizeof
(paren
r_int
)paren
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; %08X&quot;
comma
(paren
(paren
r_int
op_star
)paren
(paren
id|addr_t
)paren
id|act-&gt;cda
)paren
(braket
(paren
id|count
op_rshift
l_int|2
)paren
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|act
op_increment
suffix:semicolon
)brace
multiline_comment|/* print last CCWs */
r_if
c_cond
(paren
id|act
OL
id|last
op_minus
l_int|2
)paren
(brace
id|act
op_assign
id|last
op_minus
l_int|2
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot;......&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|act
op_le
id|last
)paren
(brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
id|KERN_ERR
id|PRINTK_HEADER
l_string|&quot; CCW %p: %08X %08X DAT:&quot;
comma
id|act
comma
(paren
(paren
r_int
op_star
)paren
id|act
)paren
(braket
l_int|0
)braket
comma
(paren
(paren
r_int
op_star
)paren
id|act
)paren
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
l_int|32
op_logical_and
id|count
OL
id|act-&gt;count
suffix:semicolon
id|count
op_add_assign
r_sizeof
(paren
r_int
)paren
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; %08X&quot;
comma
(paren
(paren
r_int
op_star
)paren
(paren
id|addr_t
)paren
id|act-&gt;cda
)paren
(braket
(paren
id|count
op_rshift
l_int|2
)paren
)braket
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|act
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
id|MESSAGE_LOG
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s&quot;
comma
id|page
op_plus
r_sizeof
(paren
id|KERN_ERR
id|PRINTK_HEADER
)paren
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * max_blocks is dependent on the amount of storage that is available&n; * in the static io buffer for each device. Currently each device has&n; * 8192 bytes (=2 pages). For 64 bit one dasd_mchunkt_t structure has&n; * 24 bytes, the struct dasd_ccw_req has 136 bytes and each block can use&n; * up to 16 bytes (8 for the ccw and 8 for the idal pointer). In&n; * addition we have one define extent ccw + 16 bytes of data and one&n; * locate record ccw + 16 bytes of data. That makes:&n; * (8192 - 24 - 136 - 8 - 16 - 8 - 16) / 16 = 499 blocks at maximum.&n; * We want to fit two into the available memory so that we can immediately&n; * start the next request if one finishes off. That makes 249.5 blocks&n; * for one request. Give a little safety and the result is 240.&n; */
DECL|variable|dasd_eckd_discipline
r_static
r_struct
id|dasd_discipline
id|dasd_eckd_discipline
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;ECKD&quot;
comma
dot
id|ebcname
op_assign
l_string|&quot;ECKD&quot;
comma
dot
id|max_blocks
op_assign
l_int|240
comma
dot
id|check_device
op_assign
id|dasd_eckd_check_characteristics
comma
dot
id|do_analysis
op_assign
id|dasd_eckd_do_analysis
comma
dot
id|fill_geometry
op_assign
id|dasd_eckd_fill_geometry
comma
dot
id|start_IO
op_assign
id|dasd_start_IO
comma
dot
id|term_IO
op_assign
id|dasd_term_IO
comma
dot
id|format_device
op_assign
id|dasd_eckd_format_device
comma
dot
id|examine_error
op_assign
id|dasd_eckd_examine_error
comma
dot
id|erp_action
op_assign
id|dasd_eckd_erp_action
comma
dot
id|erp_postaction
op_assign
id|dasd_eckd_erp_postaction
comma
dot
id|build_cp
op_assign
id|dasd_eckd_build_cp
comma
dot
id|free_cp
op_assign
id|dasd_eckd_free_cp
comma
dot
id|dump_sense
op_assign
id|dasd_eckd_dump_sense
comma
dot
id|fill_info
op_assign
id|dasd_eckd_fill_info
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|dasd_eckd_init
id|dasd_eckd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|dasd_ioctl_no_register
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDGATTR
comma
id|dasd_eckd_get_attrib
)paren
suffix:semicolon
id|dasd_ioctl_no_register
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDSATTR
comma
id|dasd_eckd_set_attrib
)paren
suffix:semicolon
id|dasd_ioctl_no_register
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDPSRD
comma
id|dasd_eckd_performance
)paren
suffix:semicolon
id|dasd_ioctl_no_register
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDRLSE
comma
id|dasd_eckd_release
)paren
suffix:semicolon
id|dasd_ioctl_no_register
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDRSRV
comma
id|dasd_eckd_reserve
)paren
suffix:semicolon
id|dasd_ioctl_no_register
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDSLCK
comma
id|dasd_eckd_steal_lock
)paren
suffix:semicolon
id|ASCEBC
c_func
(paren
id|dasd_eckd_discipline.ebcname
comma
l_int|4
)paren
suffix:semicolon
id|ret
op_assign
id|ccw_driver_register
c_func
(paren
op_amp
id|dasd_eckd_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDGATTR
comma
id|dasd_eckd_get_attrib
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDSATTR
comma
id|dasd_eckd_set_attrib
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDPSRD
comma
id|dasd_eckd_performance
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDRLSE
comma
id|dasd_eckd_release
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDRSRV
comma
id|dasd_eckd_reserve
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDSLCK
comma
id|dasd_eckd_steal_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|dasd_generic_auto_online
c_func
(paren
op_amp
id|dasd_eckd_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|dasd_eckd_cleanup
id|dasd_eckd_cleanup
c_func
(paren
r_void
)paren
(brace
id|ccw_driver_unregister
c_func
(paren
op_amp
id|dasd_eckd_driver
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDGATTR
comma
id|dasd_eckd_get_attrib
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDSATTR
comma
id|dasd_eckd_set_attrib
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDPSRD
comma
id|dasd_eckd_performance
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDRLSE
comma
id|dasd_eckd_release
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDRSRV
comma
id|dasd_eckd_reserve
)paren
suffix:semicolon
id|dasd_ioctl_no_unregister
c_func
(paren
id|THIS_MODULE
comma
id|BIODASDSLCK
comma
id|dasd_eckd_steal_lock
)paren
suffix:semicolon
)brace
DECL|variable|dasd_eckd_init
id|module_init
c_func
(paren
id|dasd_eckd_init
)paren
suffix:semicolon
DECL|variable|dasd_eckd_cleanup
id|module_exit
c_func
(paren
id|dasd_eckd_cleanup
)paren
suffix:semicolon
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 4 &n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -4&n; * c-argdecl-indent: 4&n; * c-label-offset: -4&n; * c-continued-statement-offset: 4&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: 1&n; * tab-width: 8&n; * End:&n; */
eof
