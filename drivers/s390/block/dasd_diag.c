multiline_comment|/* &n; * File...........: linux/drivers/s390/block/dasd_diag.c&n; * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n; * Based on.......: linux/drivers/s390/block/mdisk.c&n; * ...............: by Hartmunt Penner &lt;hpenner@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 1999,2000&n;&n; * History of changes&n; * 07/13/00 Added fixup sections for diagnoses ans saved some registers&n; * 07/14/00 fixed constraints in newly generated inline asm&n; * 10/05/00 adapted to &squot;new&squot; DASD driver&n; *          fixed return codes of dia250()&n; *          fixed partition handling and HDIO_GETGEO&n; */
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;&t;/* HDIO_GETGEO                      */
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;asm/ccwcache.h&gt;
macro_line|#include &lt;asm/dasd.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#include &quot;dasd_diag.h&quot;
macro_line|#ifdef PRINTK_HEADER
DECL|macro|PRINTK_HEADER
macro_line|#undef PRINTK_HEADER
macro_line|#endif&t;&t;&t;&t;/* PRINTK_HEADER */
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER DASD_NAME&quot;(diag):&quot;
DECL|variable|dasd_diag_discipline
id|dasd_discipline_t
id|dasd_diag_discipline
suffix:semicolon
r_typedef
r_struct
DECL|struct|dasd_diag_private_t
id|dasd_diag_private_t
(brace
DECL|member|rdc_data
id|dasd_diag_characteristics_t
id|rdc_data
suffix:semicolon
DECL|member|iob
id|diag_rw_io_t
id|iob
suffix:semicolon
DECL|member|iib
id|diag_init_io_t
id|iib
suffix:semicolon
DECL|member|label
r_int
r_int
op_star
id|label
suffix:semicolon
DECL|typedef|dasd_diag_private_t
)brace
id|dasd_diag_private_t
suffix:semicolon
r_static
id|__inline__
r_int
DECL|function|dia210
id|dia210
(paren
r_void
op_star
id|devchar
)paren
(brace
r_int
id|rc
suffix:semicolon
id|__asm__
id|__volatile__
(paren
l_string|&quot;    diag  %1,0,0x210&bslash;n&quot;
l_string|&quot;0:  ipm   %0&bslash;n&quot;
l_string|&quot;    srl   %0,28&bslash;n&quot;
l_string|&quot;1:&bslash;n&quot;
l_string|&quot;.section .fixup,&bslash;&quot;ax&bslash;&quot;&bslash;n&quot;
l_string|&quot;2:  lhi   %0,3&bslash;n&quot;
l_string|&quot;    bras  1,3f&bslash;n&quot;
l_string|&quot;    .long 1b&bslash;n&quot;
l_string|&quot;3:  l     1,0(1)&bslash;n&quot;
l_string|&quot;    br    1&bslash;n&quot;
l_string|&quot;.previous&bslash;n&quot;
l_string|&quot;.section __ex_table,&bslash;&quot;a&bslash;&quot;&bslash;n&quot;
l_string|&quot;    .align 4&bslash;n&quot;
l_string|&quot;    .long 0b,2b&bslash;n&quot;
l_string|&quot;.previous&bslash;n&quot;
suffix:colon
l_string|&quot;=d&quot;
(paren
id|rc
)paren
suffix:colon
l_string|&quot;d&quot;
(paren
(paren
r_void
op_star
)paren
id|__pa
(paren
id|devchar
)paren
)paren
suffix:colon
l_string|&quot;1&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|dia250
id|dia250
(paren
r_void
op_star
id|iob
comma
r_int
id|cmd
)paren
(brace
id|__asm__
id|__volatile__
(paren
l_string|&quot;    lr    0,%1&bslash;n&quot;
l_string|&quot;    diag  0,%0,0x250&bslash;n&quot;
l_string|&quot;0:  ipm   %0&bslash;n&quot;
l_string|&quot;    srl   %0,28&bslash;n&quot;
l_string|&quot;    or    %0,1&bslash;n&quot;
l_string|&quot;1:&bslash;n&quot;
l_string|&quot;.section .fixup,&bslash;&quot;ax&bslash;&quot;&bslash;n&quot;
l_string|&quot;2:  lhi   %0,3&bslash;n&quot;
l_string|&quot;    bras  1,3f&bslash;n&quot;
l_string|&quot;    .long 1b&bslash;n&quot;
l_string|&quot;3:  l     1,0(1)&bslash;n&quot;
l_string|&quot;    br    1&bslash;n&quot;
l_string|&quot;.previous&bslash;n&quot;
l_string|&quot;.section __ex_table,&bslash;&quot;a&bslash;&quot;&bslash;n&quot;
l_string|&quot;    .align 4&bslash;n&quot;
l_string|&quot;    .long 0b,2b&bslash;n&quot;
l_string|&quot;.previous&bslash;n&quot;
suffix:colon
l_string|&quot;+d&quot;
(paren
id|cmd
)paren
suffix:colon
l_string|&quot;d&quot;
(paren
(paren
r_void
op_star
)paren
id|__pa
(paren
id|iob
)paren
)paren
suffix:colon
l_string|&quot;0&quot;
comma
l_string|&quot;1&quot;
comma
l_string|&quot;cc&quot;
)paren
suffix:semicolon
r_return
id|cmd
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|mdsk_init_io
id|mdsk_init_io
(paren
id|dasd_device_t
op_star
id|device
comma
r_int
id|blocksize
comma
r_int
id|offset
comma
r_int
id|size
)paren
(brace
id|dasd_diag_private_t
op_star
r_private
op_assign
(paren
id|dasd_diag_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|diag_init_io_t
op_star
id|iib
op_assign
op_amp
r_private
op_member_access_from_pointer
id|iib
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|memset
(paren
id|iib
comma
l_int|0
comma
r_sizeof
(paren
id|diag_init_io_t
)paren
)paren
suffix:semicolon
id|iib-&gt;dev_nr
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
id|iib-&gt;block_size
op_assign
id|blocksize
suffix:semicolon
id|iib-&gt;offset
op_assign
id|offset
suffix:semicolon
id|iib-&gt;start_block
op_assign
l_int|0
suffix:semicolon
id|iib-&gt;end_block
op_assign
id|size
suffix:semicolon
id|rc
op_assign
id|dia250
(paren
id|iib
comma
id|INIT_BIO
)paren
suffix:semicolon
r_return
id|rc
op_amp
l_int|3
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|mdsk_term_io
id|mdsk_term_io
(paren
id|dasd_device_t
op_star
id|device
)paren
(brace
id|dasd_diag_private_t
op_star
r_private
op_assign
(paren
id|dasd_diag_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|diag_init_io_t
op_star
id|iib
op_assign
op_amp
r_private
op_member_access_from_pointer
id|iib
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|memset
(paren
id|iib
comma
l_int|0
comma
r_sizeof
(paren
id|diag_init_io_t
)paren
)paren
suffix:semicolon
id|iib-&gt;dev_nr
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
id|rc
op_assign
id|dia250
(paren
id|iib
comma
id|TERM_BIO
)paren
suffix:semicolon
r_return
id|rc
op_amp
l_int|3
suffix:semicolon
)brace
r_int
DECL|function|dasd_start_diag
id|dasd_start_diag
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_int
id|rc
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
id|dasd_diag_private_t
op_star
r_private
suffix:semicolon
id|diag_rw_io_t
op_star
id|iob
suffix:semicolon
r_private
op_assign
(paren
id|dasd_diag_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|iob
op_assign
op_amp
r_private
op_member_access_from_pointer
id|iob
suffix:semicolon
id|iob-&gt;dev_nr
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
id|iob-&gt;key
op_assign
l_int|0
suffix:semicolon
id|iob-&gt;flags
op_assign
l_int|2
suffix:semicolon
id|iob-&gt;block_count
op_assign
id|cqr-&gt;cplength
op_rshift
l_int|1
suffix:semicolon
id|iob-&gt;interrupt_params
op_assign
(paren
id|u32
)paren
id|cqr
suffix:semicolon
id|iob-&gt;bio_list
op_assign
id|__pa
(paren
id|cqr-&gt;cpaddr
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|cqr-&gt;startclk
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|dia250
(paren
id|iob
comma
id|RW_BIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|8
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;dia250 returned CC %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_QUEUED
comma
id|CQR_STATUS_ERROR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|check_then_set
c_func
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_QUEUED
comma
id|CQR_STATUS_DONE
)paren
suffix:semicolon
id|dasd_schedule_bh
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|cqr-&gt;expires
)paren
(brace
id|cqr-&gt;expires
op_add_assign
id|cqr-&gt;startclk
suffix:semicolon
)brace
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_QUEUED
comma
id|CQR_STATUS_IN_IO
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|dasd_ext_handler
id|dasd_ext_handler
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
id|__u16
id|code
)paren
(brace
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
r_int
id|ip
op_assign
id|S390_lowcore.ext_params
suffix:semicolon
r_char
id|status
op_assign
op_star
(paren
(paren
r_char
op_star
)paren
id|S390_lowcore.ext_params
op_plus
l_int|5
)paren
suffix:semicolon
id|dasd_device_t
op_star
id|device
suffix:semicolon
r_int
id|done_fast_io
op_assign
l_int|0
suffix:semicolon
r_int
id|devno
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip
)paren
(brace
multiline_comment|/* no intparm: unsolicited interrupt */
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;caught unsolicited interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip
op_amp
l_int|0x80000001
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;caught spurious interrupt with parm %08x&bslash;n&quot;
comma
id|ip
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cqr
op_assign
(paren
id|ccw_req_t
op_star
)paren
id|ip
suffix:semicolon
id|device
op_assign
(paren
id|dasd_device_t
op_star
)paren
id|cqr-&gt;device
suffix:semicolon
id|devno
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot; INT on devno 0x%04X  = /dev/%s (%d:%d)&quot;
l_string|&quot; belongs to NULL device&bslash;n&quot;
comma
id|devno
comma
id|device-&gt;name
comma
id|MAJOR
(paren
id|device-&gt;kdev
)paren
comma
id|MINOR
(paren
id|device-&gt;kdev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
(paren
id|device-&gt;discipline-&gt;ebcname
comma
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
l_int|4
)paren
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;0x%04X : /dev/%s (%d:%d)&quot;
l_string|&quot; magic number of ccw_req_t 0x%08X doesn&squot;t match&quot;
l_string|&quot; discipline 0x%08X&bslash;n&quot;
comma
id|devno
comma
id|device-&gt;name
comma
id|MAJOR
(paren
id|device-&gt;kdev
)paren
comma
id|MINOR
(paren
id|device-&gt;kdev
)paren
comma
id|cqr-&gt;magic
comma
op_star
(paren
r_int
op_star
)paren
(paren
op_amp
id|device-&gt;discipline-&gt;name
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|cqr-&gt;stopclk
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_IN_IO
comma
id|CQR_STATUS_DONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;level
op_eq
id|DASD_DEVICE_LEVEL_ANALYSIS_PENDING
)paren
id|device-&gt;level
op_assign
id|DASD_DEVICE_LEVEL_ANALYSIS_PREPARED
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;next
op_logical_and
(paren
id|cqr-&gt;next-&gt;status
op_eq
id|CQR_STATUS_QUEUED
)paren
)paren
(brace
r_if
c_cond
(paren
id|dasd_start_diag
(paren
id|cqr-&gt;next
)paren
op_eq
l_int|0
)paren
(brace
id|done_fast_io
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
r_case
l_int|0x02
suffix:colon
r_case
l_int|0x03
suffix:colon
r_default
suffix:colon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_IN_IO
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|wake_up
(paren
op_amp
id|device-&gt;wait_q
)paren
suffix:semicolon
id|dasd_schedule_bh
(paren
id|device
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_diag_check_characteristics
id|dasd_diag_check_characteristics
(paren
r_struct
id|dasd_device_t
op_star
id|device
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bsize
suffix:semicolon
r_int
id|label_block
suffix:semicolon
id|dasd_diag_private_t
op_star
r_private
suffix:semicolon
id|dasd_diag_characteristics_t
op_star
id|rdc_data
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
r_int
op_star
id|label
suffix:semicolon
r_int
id|sb
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Null device pointer passed to characteristics checker&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device
op_member_access_from_pointer
r_private
op_ne
l_int|NULL
)paren
(brace
id|kfree
(paren
id|device
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
)brace
id|device
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|dasd_diag_private_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device
op_member_access_from_pointer
r_private
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;memory allocation failed for private data&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_private
op_assign
(paren
id|dasd_diag_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
id|rdc_data
op_assign
(paren
r_void
op_star
)paren
op_amp
(paren
r_private
op_member_access_from_pointer
id|rdc_data
)paren
suffix:semicolon
id|rdc_data-&gt;dev_nr
op_assign
id|device-&gt;devinfo.devno
suffix:semicolon
id|rdc_data-&gt;rdc_len
op_assign
r_sizeof
(paren
id|dasd_diag_characteristics_t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dia210
(paren
id|rdc_data
)paren
op_ne
l_int|0
)paren
(brace
r_goto
id|nodiag
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rdc_data-&gt;vdev_class
op_ne
id|DEV_CLASS_FBA
op_logical_and
id|rdc_data-&gt;vdev_class
op_ne
id|DEV_CLASS_ECKD
op_logical_and
id|rdc_data-&gt;vdev_class
op_ne
id|DEV_CLASS_CKD
)paren
(brace
r_goto
id|nodiag
suffix:semicolon
)brace
macro_line|#if 0
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;%04X: %04X on real %04X/%02X&bslash;n&quot;
comma
id|rdc_data-&gt;dev_nr
comma
id|rdc_data-&gt;vdev_type
comma
id|rdc_data-&gt;rdev_type
comma
id|rdc_data-&gt;rdev_model
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Figure out position of label block */
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|rdc_data.vdev_class
op_eq
id|DEV_CLASS_FBA
)paren
(brace
id|label_block
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|rdc_data.vdev_class
op_eq
id|DEV_CLASS_ECKD
op_logical_or
r_private
op_member_access_from_pointer
id|rdc_data.vdev_class
op_eq
id|DEV_CLASS_CKD
)paren
(brace
id|label_block
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
r_goto
id|nodiag
suffix:semicolon
)brace
r_private
op_member_access_from_pointer
id|label
op_assign
(paren
r_int
op_star
)paren
id|get_free_page
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
id|label
op_assign
r_private
op_member_access_from_pointer
id|label
suffix:semicolon
id|mdsk_term_io
(paren
id|device
)paren
suffix:semicolon
multiline_comment|/* first terminate all outstanding operations */
multiline_comment|/* figure out blocksize of device */
r_for
c_loop
(paren
id|bsize
op_assign
l_int|512
suffix:semicolon
id|bsize
op_le
id|PAGE_SIZE
suffix:semicolon
id|bsize
op_lshift_assign
l_int|1
)paren
(brace
id|diag_bio_t
op_star
id|bio
suffix:semicolon
id|diag_rw_io_t
op_star
id|iob
op_assign
op_amp
r_private
op_member_access_from_pointer
id|iob
suffix:semicolon
id|rc
op_assign
id|mdsk_init_io
(paren
id|device
comma
id|bsize
comma
l_int|0
comma
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|4
)paren
(brace
r_continue
suffix:semicolon
)brace
id|cqr
op_assign
id|ccw_alloc_request
(paren
id|dasd_diag_discipline.name
comma
r_sizeof
(paren
id|diag_bio_t
)paren
op_div
r_sizeof
(paren
id|ccw1_t
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No memory to allocate initialization request&bslash;n&quot;
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
)paren
r_private
op_member_access_from_pointer
id|label
)paren
suffix:semicolon
id|kfree
c_func
(paren
r_private
)paren
suffix:semicolon
id|device
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|bio
op_assign
(paren
id|diag_bio_t
op_star
)paren
(paren
id|cqr-&gt;cpaddr
)paren
suffix:semicolon
id|memset
(paren
id|bio
comma
l_int|0
comma
r_sizeof
(paren
id|diag_bio_t
)paren
)paren
suffix:semicolon
id|bio-&gt;type
op_assign
id|MDSK_READ_REQ
suffix:semicolon
id|bio-&gt;block_number
op_assign
id|label_block
op_plus
l_int|1
suffix:semicolon
id|bio-&gt;buffer
op_assign
id|__pa
(paren
r_private
op_member_access_from_pointer
id|label
)paren
suffix:semicolon
id|cqr-&gt;device
op_assign
id|device
suffix:semicolon
id|cqr-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
id|memset
(paren
id|iob
comma
l_int|0
comma
r_sizeof
(paren
id|diag_rw_io_t
)paren
)paren
suffix:semicolon
id|iob-&gt;dev_nr
op_assign
id|rdc_data-&gt;dev_nr
suffix:semicolon
id|iob-&gt;block_count
op_assign
l_int|1
suffix:semicolon
id|iob-&gt;interrupt_params
op_assign
(paren
id|u32
)paren
id|cqr
suffix:semicolon
id|iob-&gt;bio_list
op_assign
id|__pa
(paren
id|bio
)paren
suffix:semicolon
id|rc
op_assign
id|dia250
(paren
id|iob
comma
id|RW_BIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|label
(braket
l_int|3
)braket
op_ne
id|bsize
)paren
(brace
r_goto
id|nodiag
suffix:semicolon
)brace
r_if
c_cond
(paren
id|label
(braket
l_int|0
)braket
op_ne
l_int|0xc3d4e2f1
)paren
(brace
multiline_comment|/* != CMS1 */
r_goto
id|nodiag
suffix:semicolon
)brace
r_if
c_cond
(paren
id|label
(braket
l_int|13
)braket
op_eq
l_int|0
)paren
(brace
r_goto
id|nodiag
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|mdsk_term_io
(paren
id|device
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bsize
OG
id|PAGE_SIZE
)paren
r_goto
id|nodiag
suffix:semicolon
id|device-&gt;sizes.bp_block
op_assign
id|bsize
suffix:semicolon
id|device-&gt;sizes.s2b_shift
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* bits to shift 512 to get a block */
r_for
c_loop
(paren
id|sb
op_assign
l_int|512
suffix:semicolon
id|sb
OL
id|bsize
suffix:semicolon
id|sb
op_assign
id|sb
op_lshift
l_int|1
)paren
id|device-&gt;sizes.s2b_shift
op_increment
suffix:semicolon
r_goto
id|good
suffix:semicolon
id|nodiag
suffix:colon
id|kfree
c_func
(paren
r_private
)paren
suffix:semicolon
id|device
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|good
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_diag_do_analysis
id|dasd_diag_do_analysis
(paren
r_struct
id|dasd_device_t
op_star
id|device
)paren
(brace
id|dasd_diag_private_t
op_star
r_private
op_assign
(paren
id|dasd_diag_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
op_star
id|label
op_assign
r_private
op_member_access_from_pointer
id|label
suffix:semicolon
multiline_comment|/* real size of the volume */
id|device-&gt;sizes.blocks
op_assign
id|label
(braket
l_int|7
)braket
suffix:semicolon
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|rdc_data.vdev_class
op_eq
id|DEV_CLASS_FBA
)paren
(brace
id|device-&gt;sizes.pt_block
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
r_private
op_member_access_from_pointer
id|rdc_data.vdev_class
op_eq
id|DEV_CLASS_ECKD
op_logical_or
r_private
op_member_access_from_pointer
id|rdc_data.vdev_class
op_eq
id|DEV_CLASS_CKD
)paren
(brace
id|device-&gt;sizes.pt_block
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;/dev/%s (%04X): capacity (%dkB blks): %ldkB&bslash;n&quot;
comma
id|device-&gt;name
comma
id|device-&gt;devinfo.devno
comma
(paren
id|device-&gt;sizes.bp_block
op_rshift
l_int|10
)paren
comma
(paren
id|device-&gt;sizes.blocks
op_lshift
id|device-&gt;sizes.s2b_shift
)paren
op_rshift
l_int|1
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
)paren
r_private
op_member_access_from_pointer
id|label
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|dasd_diag_fill_geometry
id|dasd_diag_fill_geometry
(paren
r_struct
id|dasd_device_t
op_star
id|device
comma
r_struct
id|hd_geometry
op_star
id|geo
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|dasd_diag_private_t
op_star
r_private
op_assign
(paren
id|dasd_diag_private_t
op_star
)paren
id|device
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|sectors
op_assign
id|device-&gt;sizes.blocks
op_lshift
id|device-&gt;sizes.s2b_shift
suffix:semicolon
r_int
r_int
id|tracks
op_assign
id|sectors
op_rshift
l_int|6
suffix:semicolon
r_int
r_int
id|trk_rem
op_assign
id|sectors
op_amp
(paren
(paren
l_int|1
op_lshift
l_int|6
)paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 64k per track */
r_int
r_int
id|cyls
op_assign
id|tracks
op_rshift
l_int|4
suffix:semicolon
r_int
r_int
id|cyls_rem
op_assign
id|tracks
op_amp
(paren
(paren
l_int|1
op_lshift
l_int|4
)paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 16 head per cyl */
r_switch
c_cond
(paren
id|device-&gt;sizes.bp_block
)paren
(brace
r_case
l_int|512
suffix:colon
r_case
l_int|1024
suffix:colon
r_case
l_int|2048
suffix:colon
r_case
l_int|4096
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|geo-&gt;cylinders
op_assign
id|cyls
suffix:semicolon
id|geo-&gt;heads
op_assign
l_int|16
suffix:semicolon
id|geo-&gt;sectors
op_assign
l_int|128
op_rshift
id|device-&gt;sizes.s2b_shift
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
id|dasd_era_t
DECL|function|dasd_diag_examine_error
id|dasd_diag_examine_error
(paren
id|ccw_req_t
op_star
id|cqr
comma
id|devstat_t
op_star
id|stat
)paren
(brace
r_return
id|dasd_era_fatal
suffix:semicolon
)brace
r_static
id|dasd_erp_action_fn_t
DECL|function|dasd_diag_erp_action
id|dasd_diag_erp_action
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_return
id|default_erp_action
suffix:semicolon
)brace
r_static
id|dasd_erp_postaction_fn_t
DECL|function|dasd_diag_erp_postaction
id|dasd_diag_erp_postaction
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
r_if
c_cond
(paren
id|cqr-&gt;function
op_eq
id|default_erp_action
)paren
r_return
id|default_erp_postaction
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;unknown ERP action %p&bslash;n&quot;
comma
id|cqr-&gt;function
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
id|ccw_req_t
op_star
DECL|function|dasd_diag_build_cp_from_req
id|dasd_diag_build_cp_from_req
(paren
id|dasd_device_t
op_star
id|device
comma
r_struct
id|request
op_star
id|req
)paren
(brace
id|ccw_req_t
op_star
id|rw_cp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_int
id|rw_cmd
suffix:semicolon
r_int
id|noblk
op_assign
id|req-&gt;nr_sectors
op_rshift
id|device-&gt;sizes.s2b_shift
suffix:semicolon
r_int
id|byt_per_blk
op_assign
id|device-&gt;sizes.bp_block
suffix:semicolon
r_int
id|block
suffix:semicolon
id|diag_bio_t
op_star
id|bio
suffix:semicolon
r_int
id|bhct
suffix:semicolon
r_int
id|size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|noblk
)paren
(brace
id|PRINT_ERR
(paren
l_string|&quot;No blocks to read/write...returning&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;cmd
op_eq
id|READ
)paren
(brace
id|rw_cmd
op_assign
id|MDSK_READ_REQ
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|req-&gt;cmd
op_eq
id|WRITE
)paren
(brace
id|rw_cmd
op_assign
id|MDSK_WRITE_REQ
suffix:semicolon
)brace
id|bhct
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_size
OG
id|byt_per_blk
)paren
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|byt_per_blk
)paren
id|bhct
op_increment
suffix:semicolon
r_else
id|bhct
op_increment
suffix:semicolon
)brace
multiline_comment|/* Build the request */
id|rw_cp
op_assign
id|dasd_alloc_request
(paren
id|dasd_diag_discipline.name
comma
id|bhct
op_lshift
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rw_cp
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|bio
op_assign
(paren
id|diag_bio_t
op_star
)paren
(paren
id|rw_cp-&gt;cpaddr
)paren
suffix:semicolon
id|block
op_assign
id|req-&gt;sector
op_rshift
id|device-&gt;sizes.s2b_shift
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_size
op_ge
id|byt_per_blk
)paren
(brace
id|memset
(paren
id|bio
comma
l_int|0
comma
r_sizeof
(paren
id|diag_bio_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|byt_per_blk
)paren
(brace
id|bio-&gt;type
op_assign
id|rw_cmd
suffix:semicolon
id|bio-&gt;block_number
op_assign
id|block
op_plus
l_int|1
suffix:semicolon
id|bio-&gt;buffer
op_assign
id|__pa
(paren
id|bh-&gt;b_data
op_plus
id|size
)paren
suffix:semicolon
id|bio
op_increment
suffix:semicolon
id|block
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
id|PRINT_WARN
(paren
l_string|&quot;Cannot fulfill request smaller than block&bslash;n&quot;
)paren
suffix:semicolon
id|ccw_free_request
(paren
id|rw_cp
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|rw_cp-&gt;device
op_assign
id|device
suffix:semicolon
id|rw_cp-&gt;expires
op_assign
l_int|50
op_star
id|TOD_SEC
suffix:semicolon
multiline_comment|/* 50 seconds */
id|rw_cp-&gt;req
op_assign
id|req
suffix:semicolon
id|check_then_set
(paren
op_amp
id|rw_cp-&gt;status
comma
id|CQR_STATUS_EMPTY
comma
id|CQR_STATUS_FILLED
)paren
suffix:semicolon
r_return
id|rw_cp
suffix:semicolon
)brace
r_static
r_char
op_star
DECL|function|dasd_diag_dump_sense
id|dasd_diag_dump_sense
(paren
r_struct
id|dasd_device_t
op_star
id|device
comma
id|ccw_req_t
op_star
id|req
)paren
(brace
r_char
op_star
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_free_page
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|len
op_assign
id|sprintf
(paren
id|page
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;device %04X on irq %d: I/O status report:&bslash;n&quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;devinfo.irq
)paren
suffix:semicolon
r_return
id|page
suffix:semicolon
)brace
DECL|variable|dasd_diag_discipline
id|dasd_discipline_t
id|dasd_diag_discipline
op_assign
(brace
id|name
suffix:colon
l_string|&quot;DIAG&quot;
comma
id|ebcname
suffix:colon
l_string|&quot;DIAG&quot;
comma
id|max_blocks
suffix:colon
id|PAGE_SIZE
op_div
r_sizeof
(paren
id|diag_bio_t
)paren
comma
id|check_characteristics
suffix:colon
id|dasd_diag_check_characteristics
comma
id|do_analysis
suffix:colon
id|dasd_diag_do_analysis
comma
id|fill_geometry
suffix:colon
id|dasd_diag_fill_geometry
comma
id|start_IO
suffix:colon
id|dasd_start_diag
comma
id|examine_error
suffix:colon
id|dasd_diag_examine_error
comma
id|erp_action
suffix:colon
id|dasd_diag_erp_action
comma
id|erp_postaction
suffix:colon
id|dasd_diag_erp_postaction
comma
id|build_cp_from_req
suffix:colon
id|dasd_diag_build_cp_from_req
comma
id|dump_sense
suffix:colon
id|dasd_diag_dump_sense
comma
id|int_handler
suffix:colon
id|dasd_ext_handler
)brace
suffix:semicolon
r_int
DECL|function|dasd_diag_init
id|dasd_diag_init
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|MACHINE_IS_VM
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;%s discipline initializing&bslash;n&quot;
comma
id|dasd_diag_discipline.name
)paren
suffix:semicolon
id|ASCEBC
(paren
id|dasd_diag_discipline.ebcname
comma
l_int|4
)paren
suffix:semicolon
id|ctl_set_bit
(paren
l_int|0
comma
l_int|9
)paren
suffix:semicolon
id|register_external_interrupt
(paren
l_int|0x2603
comma
id|dasd_ext_handler
)paren
suffix:semicolon
id|dasd_discipline_enq
(paren
op_amp
id|dasd_diag_discipline
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;Machine is not VM: %s discipline not initializing&bslash;n&quot;
comma
id|dasd_diag_discipline.name
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|dasd_diag_cleanup
id|dasd_diag_cleanup
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|MACHINE_IS_VM
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;%s discipline cleaning up&bslash;n&quot;
comma
id|dasd_diag_discipline.name
)paren
suffix:semicolon
id|dasd_discipline_deq
c_func
(paren
op_amp
id|dasd_diag_discipline
)paren
suffix:semicolon
id|unregister_external_interrupt
(paren
l_int|0x2603
comma
id|dasd_ext_handler
)paren
suffix:semicolon
id|ctl_clear_bit
(paren
l_int|0
comma
l_int|9
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
(paren
id|KERN_INFO
id|PRINTK_HEADER
l_string|&quot;Machine is not VM: %s discipline not initializing&bslash;n&quot;
comma
id|dasd_diag_discipline.name
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 4 &n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -4&n; * c-argdecl-indent: 4&n; * c-label-offset: -4&n; * c-continued-statement-offset: 4&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
