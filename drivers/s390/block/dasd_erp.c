multiline_comment|/*&n; * File...........: linux/drivers/s390/block/dasd.c&n; * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n; *&t;&t;    Horst Hummel &lt;Horst.Hummel@de.ibm.com&gt;&n; *&t;&t;    Carsten Otte &lt;Cotte@de.ibm.com&gt;&n; *&t;&t;    Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 1999-2001&n; *&n; * $Revision: 1.10 $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/* This is ugly... */
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;dasd_erp:&quot;
macro_line|#include &quot;dasd_int.h&quot;
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_alloc_erp_request
id|dasd_alloc_erp_request
c_func
(paren
r_char
op_star
id|magic
comma
r_int
id|cplength
comma
r_int
id|datasize
comma
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_int
id|size
suffix:semicolon
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|magic
op_eq
l_int|NULL
op_logical_or
id|datasize
OG
id|PAGE_SIZE
op_logical_or
(paren
id|cplength
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
OG
id|PAGE_SIZE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|debug_text_event
(paren
id|dasd_debug_area
comma
l_int|1
comma
l_string|&quot;ALLC&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|dasd_debug_area
comma
l_int|1
comma
id|magic
)paren
suffix:semicolon
id|debug_int_event
(paren
id|dasd_debug_area
comma
l_int|1
comma
id|cplength
)paren
suffix:semicolon
id|debug_int_event
(paren
id|dasd_debug_area
comma
l_int|1
comma
id|datasize
)paren
suffix:semicolon
id|size
op_assign
(paren
r_sizeof
(paren
r_struct
id|dasd_ccw_req
)paren
op_plus
l_int|7L
)paren
op_amp
op_minus
l_int|8L
suffix:semicolon
r_if
c_cond
(paren
id|cplength
OG
l_int|0
)paren
id|size
op_add_assign
id|cplength
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datasize
OG
l_int|0
)paren
id|size
op_add_assign
id|datasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|device-&gt;mem_lock
comma
id|flags
)paren
suffix:semicolon
id|cqr
op_assign
(paren
r_struct
id|dasd_ccw_req
op_star
)paren
id|dasd_alloc_chunk
c_func
(paren
op_amp
id|device-&gt;erp_chunks
comma
id|size
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|device-&gt;mem_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cqr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dasd_ccw_req
)paren
)paren
suffix:semicolon
id|data
op_assign
(paren
r_char
op_star
)paren
id|cqr
op_plus
(paren
(paren
r_sizeof
(paren
r_struct
id|dasd_ccw_req
)paren
op_plus
l_int|7L
)paren
op_amp
op_minus
l_int|8L
)paren
suffix:semicolon
id|cqr-&gt;cpaddr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cplength
OG
l_int|0
)paren
(brace
id|cqr-&gt;cpaddr
op_assign
(paren
r_struct
id|ccw1
op_star
)paren
id|data
suffix:semicolon
id|data
op_add_assign
id|cplength
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cqr-&gt;cpaddr
comma
l_int|0
comma
id|cplength
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
)brace
id|cqr-&gt;data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|datasize
OG
l_int|0
)paren
(brace
id|cqr-&gt;data
op_assign
id|data
suffix:semicolon
id|memset
c_func
(paren
id|cqr-&gt;data
comma
l_int|0
comma
id|datasize
)paren
suffix:semicolon
)brace
id|strncpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
id|magic
comma
l_int|4
)paren
suffix:semicolon
id|ASCEBC
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
l_int|4
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|device-&gt;ref_count
)paren
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
r_void
DECL|function|dasd_free_erp_request
id|dasd_free_erp_request
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
comma
r_struct
id|dasd_device
op_star
id|device
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;dstat
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|cqr-&gt;dstat
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|dasd_debug_area
comma
l_int|1
comma
l_string|&quot;FREE&quot;
)paren
suffix:semicolon
id|debug_int_event
c_func
(paren
id|dasd_debug_area
comma
l_int|1
comma
(paren
r_int
)paren
id|cqr
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|device-&gt;mem_lock
comma
id|flags
)paren
suffix:semicolon
id|dasd_free_chunk
c_func
(paren
op_amp
id|device-&gt;erp_chunks
comma
id|cqr
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|device-&gt;mem_lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|device-&gt;ref_count
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * dasd_default_erp_action just retries the current cqr&n; */
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_default_erp_action
id|dasd_default_erp_action
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
multiline_comment|/* just retry - there is nothing to save ... I got no sense data.... */
r_if
c_cond
(paren
id|cqr-&gt;retries
OG
l_int|0
)paren
(brace
id|DEV_MESSAGE
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;default ERP called (%i retries left)&quot;
comma
id|cqr-&gt;retries
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_QUEUED
suffix:semicolon
)brace
r_else
(brace
id|DEV_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;default ERP called (NO retry left)&quot;
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
id|cqr-&gt;stopclk
op_assign
id|get_clock
(paren
)paren
suffix:semicolon
)brace
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* end dasd_default_erp_action */
multiline_comment|/*&n; * DESCRIPTION&n; *   Frees all ERPs of the current ERP Chain and set the status&n; *   of the original CQR either to DASD_CQR_DONE if ERP was successful&n; *   or to DASD_CQR_FAILED if ERP was NOT successful.&n; *   NOTE: This function is only called if no discipline postaction&n; *&t;   is available&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; *&n; * RETURN VALUES&n; *   cqr&t;&t;pointer to the original CQR&n; */
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_default_erp_postaction
id|dasd_default_erp_postaction
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
r_int
id|success
suffix:semicolon
r_if
c_cond
(paren
id|cqr-&gt;refers
op_eq
l_int|NULL
op_logical_or
id|cqr-&gt;function
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
id|success
op_assign
id|cqr-&gt;status
op_eq
id|DASD_CQR_DONE
suffix:semicolon
multiline_comment|/* free all ERPs - but NOT the original cqr */
r_while
c_loop
(paren
id|cqr-&gt;refers
op_ne
l_int|NULL
)paren
(brace
r_struct
id|dasd_ccw_req
op_star
id|refers
suffix:semicolon
id|refers
op_assign
id|cqr-&gt;refers
suffix:semicolon
multiline_comment|/* remove the request from the device queue */
id|list_del
c_func
(paren
op_amp
id|cqr-&gt;list
)paren
suffix:semicolon
multiline_comment|/* free the finished erp request */
id|dasd_free_erp_request
c_func
(paren
id|cqr
comma
id|device
)paren
suffix:semicolon
id|cqr
op_assign
id|refers
suffix:semicolon
)brace
multiline_comment|/* set corresponding status to original cqr */
r_if
c_cond
(paren
id|success
)paren
id|cqr-&gt;status
op_assign
id|DASD_CQR_DONE
suffix:semicolon
r_else
(brace
id|cqr-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
id|cqr-&gt;stopclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* end default_erp_postaction */
multiline_comment|/*&n; * Print the hex dump of the memory used by a request. This includes&n; * all error recovery ccws that have been chained in from of the &n; * real request.&n; */
r_static
r_inline
r_void
DECL|function|hex_dump_memory
id|hex_dump_memory
c_func
(paren
r_struct
id|dasd_device
op_star
id|device
comma
r_void
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
op_star
id|pint
suffix:semicolon
id|pint
op_assign
(paren
r_int
op_star
)paren
id|data
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%p: %08x %08x %08x %08x&quot;
comma
id|pint
comma
id|pint
(braket
l_int|0
)braket
comma
id|pint
(braket
l_int|1
)braket
comma
id|pint
(braket
l_int|2
)braket
comma
id|pint
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|pint
op_add_assign
l_int|4
suffix:semicolon
id|len
op_sub_assign
l_int|16
suffix:semicolon
)brace
)brace
r_void
DECL|function|dasd_log_sense
id|dasd_log_sense
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
multiline_comment|/* dump sense data */
r_if
c_cond
(paren
id|device-&gt;discipline
op_logical_and
id|device-&gt;discipline-&gt;dump_sense
)paren
id|device-&gt;discipline
op_member_access_from_pointer
id|dump_sense
c_func
(paren
id|device
comma
id|cqr
comma
id|irb
)paren
suffix:semicolon
)brace
r_void
DECL|function|dasd_log_ccw
id|dasd_log_ccw
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
comma
r_int
id|caller
comma
id|__u32
id|cpa
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|lcqr
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_int
id|cplength
suffix:semicolon
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
multiline_comment|/* log the channel program */
r_for
c_loop
(paren
id|lcqr
op_assign
id|cqr
suffix:semicolon
id|lcqr
op_ne
l_int|NULL
suffix:semicolon
id|lcqr
op_assign
id|lcqr-&gt;refers
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;(%s) ERP chain report for req: %p&quot;
comma
id|caller
op_eq
l_int|0
ques
c_cond
l_string|&quot;EXAMINE&quot;
suffix:colon
l_string|&quot;ACTION&quot;
comma
id|lcqr
)paren
suffix:semicolon
id|hex_dump_memory
c_func
(paren
id|device
comma
id|lcqr
comma
r_sizeof
(paren
r_struct
id|dasd_ccw_req
)paren
)paren
suffix:semicolon
id|cplength
op_assign
l_int|1
suffix:semicolon
id|ccw
op_assign
id|lcqr-&gt;cpaddr
suffix:semicolon
r_while
c_loop
(paren
id|ccw
op_increment
op_member_access_from_pointer
id|flags
op_amp
(paren
id|CCW_FLAG_DC
op_or
id|CCW_FLAG_CC
)paren
)paren
id|cplength
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cplength
OG
l_int|40
)paren
(brace
multiline_comment|/* log only parts of the CP */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Start of channel program:&quot;
)paren
suffix:semicolon
id|hex_dump_memory
c_func
(paren
id|device
comma
id|lcqr-&gt;cpaddr
comma
l_int|40
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;End of channel program:&quot;
)paren
suffix:semicolon
id|hex_dump_memory
c_func
(paren
id|device
comma
id|lcqr-&gt;cpaddr
op_plus
id|cplength
op_minus
l_int|10
comma
l_int|10
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* log the whole CP */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Channel program (complete):&quot;
)paren
suffix:semicolon
id|hex_dump_memory
c_func
(paren
id|device
comma
id|lcqr-&gt;cpaddr
comma
id|cplength
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lcqr
op_ne
id|cqr
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Log bytes arround failed CCW but only if we did&n;&t;&t; * not log the whole CP of the CCW is outside the&n;&t;&t; * logged CP. &n;&t;&t; */
r_if
c_cond
(paren
id|cplength
OG
l_int|40
op_logical_or
(paren
(paren
id|addr_t
)paren
id|cpa
template_param
(paren
id|addr_t
)paren
(paren
id|lcqr-&gt;cpaddr
op_plus
id|cplength
op_plus
l_int|4
)paren
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;Failed CCW (%p) (area):&quot;
comma
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|cpa
)paren
suffix:semicolon
id|hex_dump_memory
c_func
(paren
id|device
comma
id|cqr-&gt;cpaddr
op_minus
l_int|10
comma
l_int|20
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* end log_erp_chain */
DECL|variable|dasd_default_erp_action
id|EXPORT_SYMBOL
c_func
(paren
id|dasd_default_erp_action
)paren
suffix:semicolon
DECL|variable|dasd_default_erp_postaction
id|EXPORT_SYMBOL
c_func
(paren
id|dasd_default_erp_postaction
)paren
suffix:semicolon
DECL|variable|dasd_alloc_erp_request
id|EXPORT_SYMBOL
c_func
(paren
id|dasd_alloc_erp_request
)paren
suffix:semicolon
DECL|variable|dasd_free_erp_request
id|EXPORT_SYMBOL
c_func
(paren
id|dasd_free_erp_request
)paren
suffix:semicolon
DECL|variable|dasd_log_sense
id|EXPORT_SYMBOL
c_func
(paren
id|dasd_log_sense
)paren
suffix:semicolon
DECL|variable|dasd_log_ccw
id|EXPORT_SYMBOL
c_func
(paren
id|dasd_log_ccw
)paren
suffix:semicolon
eof
