multiline_comment|/* &n; * File...........: linux/drivers/s390/block/dasd_3990_erp.c&n; * Author(s)......: Horst  Hummel    &lt;Horst.Hummel@de.ibm.com&gt; &n; *                  Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 2000, 2001&n; */
macro_line|#include &lt;asm/ccwcache.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/dasd.h&gt;
macro_line|#include &lt;asm/s390io.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &quot;dasd_eckd.h&quot;
macro_line|#include &quot;dasd_3990_erp.h&quot;
macro_line|#ifdef PRINTK_HEADER
DECL|macro|PRINTK_HEADER
macro_line|#undef PRINTK_HEADER
macro_line|#endif&t;&t;&t;&t;/* PRINTK_HEADER */
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;dasd_erp(3990): &quot;
multiline_comment|/*&n; ***************************************************************************** &n; * SECTION DEBUG ROUTINES&n; ***************************************************************************** &n; */
macro_line|#ifdef ERP_DEBUG
r_void
DECL|function|log_erp_chain
id|log_erp_chain
(paren
id|ccw_req_t
op_star
id|cqr
comma
r_int
id|caller
comma
id|__u32
id|cpa
)paren
(brace
id|ccw_req_t
op_star
id|loop_cqr
op_assign
id|cqr
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
r_char
op_star
id|page
op_assign
(paren
r_char
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_ATOMIC
)paren
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|nl
comma
op_star
id|end_cqr
comma
op_star
id|begin
comma
op_star
id|end
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;No memory to dump ERP chain&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|loop_cqr
op_ne
l_int|NULL
)paren
(brace
id|memset
(paren
id|page
comma
l_int|0
comma
l_int|4096
)paren
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;device %04X on irq %d: (%s) ERP chain report for req: %p&bslash;n&quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;devinfo.irq
comma
id|caller
op_eq
l_int|0
ques
c_cond
l_string|&quot;EXAMINE&quot;
suffix:colon
l_string|&quot;ACTION&quot;
comma
id|loop_cqr
)paren
suffix:semicolon
id|nl
op_assign
(paren
r_char
op_star
)paren
id|loop_cqr
suffix:semicolon
id|end_cqr
op_assign
id|nl
op_plus
r_sizeof
(paren
id|ccw_req_t
)paren
suffix:semicolon
r_while
c_loop
(paren
id|nl
OL
id|end_cqr
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;%p: %02x%02x%02x%02x %02x%02x%02x%02x &quot;
l_string|&quot;%02x%02x%02x%02x %02x%02x%02x%02x&bslash;n&quot;
comma
id|nl
comma
id|nl
(braket
l_int|0
)braket
comma
id|nl
(braket
l_int|1
)braket
comma
id|nl
(braket
l_int|2
)braket
comma
id|nl
(braket
l_int|3
)braket
comma
id|nl
(braket
l_int|4
)braket
comma
id|nl
(braket
l_int|5
)braket
comma
id|nl
(braket
l_int|6
)braket
comma
id|nl
(braket
l_int|7
)braket
comma
id|nl
(braket
l_int|8
)braket
comma
id|nl
(braket
l_int|9
)braket
comma
id|nl
(braket
l_int|10
)braket
comma
id|nl
(braket
l_int|11
)braket
comma
id|nl
(braket
l_int|12
)braket
comma
id|nl
(braket
l_int|13
)braket
comma
id|nl
(braket
l_int|14
)braket
comma
id|nl
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|nl
op_add_assign
l_int|16
suffix:semicolon
)brace
id|nl
op_assign
(paren
r_char
op_star
)paren
id|loop_cqr-&gt;cpaddr
suffix:semicolon
r_if
c_cond
(paren
id|loop_cqr-&gt;cplength
OG
l_int|40
)paren
(brace
multiline_comment|/* log only parts of the CP */
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Start of channel program:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|20
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;%p: %02x%02x%02x%02x %02x%02x%02x%02x &quot;
l_string|&quot;%02x%02x%02x%02x %02x%02x%02x%02x&bslash;n&quot;
comma
id|nl
comma
id|nl
(braket
l_int|0
)braket
comma
id|nl
(braket
l_int|1
)braket
comma
id|nl
(braket
l_int|2
)braket
comma
id|nl
(braket
l_int|3
)braket
comma
id|nl
(braket
l_int|4
)braket
comma
id|nl
(braket
l_int|5
)braket
comma
id|nl
(braket
l_int|6
)braket
comma
id|nl
(braket
l_int|7
)braket
comma
id|nl
(braket
l_int|8
)braket
comma
id|nl
(braket
l_int|9
)braket
comma
id|nl
(braket
l_int|10
)braket
comma
id|nl
(braket
l_int|11
)braket
comma
id|nl
(braket
l_int|12
)braket
comma
id|nl
(braket
l_int|13
)braket
comma
id|nl
(braket
l_int|14
)braket
comma
id|nl
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|nl
op_add_assign
l_int|16
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;End of channel program:&bslash;n&quot;
)paren
suffix:semicolon
id|nl
op_assign
(paren
r_char
op_star
)paren
id|loop_cqr-&gt;cpaddr
suffix:semicolon
id|nl
op_add_assign
(paren
(paren
id|loop_cqr-&gt;cplength
op_minus
l_int|10
)paren
op_star
l_int|8
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|20
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;%p: %02x%02x%02x%02x %02x%02x%02x%02x &quot;
l_string|&quot;%02x%02x%02x%02x %02x%02x%02x%02x&bslash;n&quot;
comma
id|nl
comma
id|nl
(braket
l_int|0
)braket
comma
id|nl
(braket
l_int|1
)braket
comma
id|nl
(braket
l_int|2
)braket
comma
id|nl
(braket
l_int|3
)braket
comma
id|nl
(braket
l_int|4
)braket
comma
id|nl
(braket
l_int|5
)braket
comma
id|nl
(braket
l_int|6
)braket
comma
id|nl
(braket
l_int|7
)braket
comma
id|nl
(braket
l_int|8
)braket
comma
id|nl
(braket
l_int|9
)braket
comma
id|nl
(braket
l_int|10
)braket
comma
id|nl
(braket
l_int|11
)braket
comma
id|nl
(braket
l_int|12
)braket
comma
id|nl
(braket
l_int|13
)braket
comma
id|nl
(braket
l_int|14
)braket
comma
id|nl
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|nl
op_add_assign
l_int|16
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* log the whole CP */
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Channel program (complete):&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|loop_cqr-&gt;cplength
op_plus
l_int|4
)paren
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;%p: %02x%02x%02x%02x %02x%02x%02x%02x &quot;
l_string|&quot;%02x%02x%02x%02x %02x%02x%02x%02x&bslash;n&quot;
comma
id|nl
comma
id|nl
(braket
l_int|0
)braket
comma
id|nl
(braket
l_int|1
)braket
comma
id|nl
(braket
l_int|2
)braket
comma
id|nl
(braket
l_int|3
)braket
comma
id|nl
(braket
l_int|4
)braket
comma
id|nl
(braket
l_int|5
)braket
comma
id|nl
(braket
l_int|6
)braket
comma
id|nl
(braket
l_int|7
)braket
comma
id|nl
(braket
l_int|8
)braket
comma
id|nl
(braket
l_int|9
)braket
comma
id|nl
(braket
l_int|10
)braket
comma
id|nl
(braket
l_int|11
)braket
comma
id|nl
(braket
l_int|12
)braket
comma
id|nl
(braket
l_int|13
)braket
comma
id|nl
(braket
l_int|14
)braket
comma
id|nl
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|nl
op_add_assign
l_int|16
suffix:semicolon
)brace
)brace
multiline_comment|/* log bytes arround failed CCW if not already done */
id|begin
op_assign
(paren
r_char
op_star
)paren
id|loop_cqr-&gt;cpaddr
suffix:semicolon
id|end
op_assign
id|begin
op_plus
(paren
(paren
id|loop_cqr-&gt;cplength
op_plus
l_int|4
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|nl
op_assign
(paren
r_void
op_star
)paren
id|cpa
suffix:semicolon
r_if
c_cond
(paren
id|loop_cqr
op_eq
id|cqr
)paren
(brace
multiline_comment|/* log only once */
r_if
c_cond
(paren
(paren
id|loop_cqr-&gt;cplength
OG
l_int|40
)paren
op_logical_or
multiline_comment|/* not whole CP was logged or */
(paren
(paren
id|nl
OL
id|begin
)paren
op_logical_and
multiline_comment|/* CCW is outside logged CP   */
(paren
id|nl
OG
id|end
)paren
)paren
)paren
(brace
id|nl
op_sub_assign
l_int|10
op_star
l_int|8
suffix:semicolon
multiline_comment|/* start some bytes before */
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Failed CCW (%p) (area):&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|cpa
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|20
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;%p: %02x%02x%02x%02x %02x%02x%02x%02x &quot;
l_string|&quot;%02x%02x%02x%02x %02x%02x%02x%02x&bslash;n&quot;
comma
id|nl
comma
id|nl
(braket
l_int|0
)braket
comma
id|nl
(braket
l_int|1
)braket
comma
id|nl
(braket
l_int|2
)braket
comma
id|nl
(braket
l_int|3
)braket
comma
id|nl
(braket
l_int|4
)braket
comma
id|nl
(braket
l_int|5
)braket
comma
id|nl
(braket
l_int|6
)braket
comma
id|nl
(braket
l_int|7
)braket
comma
id|nl
(braket
l_int|8
)braket
comma
id|nl
(braket
l_int|9
)braket
comma
id|nl
(braket
l_int|10
)braket
comma
id|nl
(braket
l_int|11
)braket
comma
id|nl
(braket
l_int|12
)braket
comma
id|nl
(braket
l_int|13
)braket
comma
id|nl
(braket
l_int|14
)braket
comma
id|nl
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|nl
op_add_assign
l_int|16
suffix:semicolon
)brace
)brace
r_else
(brace
id|len
op_add_assign
id|sprintf
(paren
id|page
op_plus
id|len
comma
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Failed CCW (%p) already logged&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|cpa
)paren
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;%s&quot;
comma
id|page
)paren
suffix:semicolon
id|loop_cqr
op_assign
id|loop_cqr-&gt;refers
suffix:semicolon
)brace
id|free_page
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
)brace
multiline_comment|/* end log_erp_chain */
macro_line|#endif /* ERP_DEBUG */
multiline_comment|/*&n; ***************************************************************************** &n; * SECTION ERP EXAMINATION&n; ***************************************************************************** &n; */
multiline_comment|/*&n; * DASD_3990_ERP_EXAMINE_24 &n; *&n; * DESCRIPTION&n; *   Checks only for fatal (unrecoverable) error. &n; *   A detailed examination of the sense data is done later outside&n; *   the interrupt handler.&n; *&n; *   Each bit configuration leading to an action code 2 (Exit with&n; *   programming error or unusual condition indication)&n; *   are handled as fatal error&#xfffd;s.&n; * &n; *   All other configurations are handled as recoverable errors.&n; *&n; * RETURN VALUES&n; *   dasd_era_fatal     for all fatal (unrecoverable errors)&n; *   dasd_era_recover   for all others.&n; */
id|dasd_era_t
DECL|function|dasd_3990_erp_examine_24
id|dasd_3990_erp_examine_24
(paren
r_char
op_star
id|sense
)paren
(brace
multiline_comment|/* check for &squot;Command Recejct&squot; which is always a fatal error  */
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_CMD_REJECT
)paren
(brace
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
r_return
id|dasd_era_recover
suffix:semicolon
)brace
r_else
(brace
r_return
id|dasd_era_fatal
suffix:semicolon
)brace
)brace
multiline_comment|/* check for &squot;Invalid Track Format&squot;                           */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_INV_TRACK_FORMAT
)paren
(brace
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
r_return
id|dasd_era_recover
suffix:semicolon
)brace
r_else
(brace
r_return
id|dasd_era_fatal
suffix:semicolon
)brace
)brace
multiline_comment|/* check for &squot;No Record Found&squot;                                */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_NO_REC_FOUND
)paren
(brace
r_return
id|dasd_era_fatal
suffix:semicolon
)brace
multiline_comment|/* return recoverable for all others                          */
r_return
id|dasd_era_recover
suffix:semicolon
)brace
multiline_comment|/* END dasd_3990_erp_examine_24 */
multiline_comment|/*&n; * DASD_3990_ERP_EXAMINE_32 &n; *&n; * DESCRIPTION&n; *   Checks only for fatal/no/recoverable error. &n; *   A detailed examination of the sense data is done later outside&n; *   the interrupt handler.&n; *&n; * RETURN VALUES&n; *   dasd_era_none      no error &n; *   dasd_era_fatal     for all fatal (unrecoverable errors)&n; *   dasd_era_recover   for recoverable others.&n; */
id|dasd_era_t
DECL|function|dasd_3990_erp_examine_32
id|dasd_3990_erp_examine_32
(paren
r_char
op_star
id|sense
)paren
(brace
r_switch
c_cond
(paren
id|sense
(braket
l_int|25
)braket
)paren
(brace
r_case
l_int|0x00
suffix:colon
r_return
id|dasd_era_none
suffix:semicolon
r_case
l_int|0x01
suffix:colon
r_return
id|dasd_era_fatal
suffix:semicolon
r_default
suffix:colon
r_return
id|dasd_era_recover
suffix:semicolon
)brace
)brace
multiline_comment|/* end dasd_3990_erp_examine_32 */
multiline_comment|/*&n; * DASD_3990_ERP_EXAMINE &n; *&n; * DESCRIPTION&n; *   Checks only for fatal/no/recover error. &n; *   A detailed examination of the sense data is done later outside&n; *   the interrupt handler.&n; *&n; *   The logic is based on the &squot;IBM 3990 Storage Control  Reference&squot; manual&n; *   &squot;Chapter 7. Error Recovery Procedures&squot;.&n; *&n; * RETURN VALUES&n; *   dasd_era_none      no error &n; *   dasd_era_fatal     for all fatal (unrecoverable errors)&n; *   dasd_era_recover   for all others.&n; */
id|dasd_era_t
DECL|function|dasd_3990_erp_examine
id|dasd_3990_erp_examine
(paren
id|ccw_req_t
op_star
id|cqr
comma
id|devstat_t
op_star
id|stat
)paren
(brace
r_char
op_star
id|sense
op_assign
id|stat-&gt;ii.sense.data
suffix:semicolon
id|dasd_era_t
id|era
op_assign
id|dasd_era_recover
suffix:semicolon
multiline_comment|/* check for successful execution first */
r_if
c_cond
(paren
id|stat-&gt;cstat
op_eq
l_int|0x00
op_logical_and
id|stat-&gt;dstat
op_eq
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
r_return
id|dasd_era_none
suffix:semicolon
multiline_comment|/* distinguish between 24 and 32 byte sense data */
r_if
c_cond
(paren
id|sense
(braket
l_int|27
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
(brace
multiline_comment|/* examine the 24 byte sense data */
id|era
op_assign
id|dasd_3990_erp_examine_24
(paren
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* examine the 32 byte sense data */
id|era
op_assign
id|dasd_3990_erp_examine_32
(paren
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* end distinguish between 24 and 32 byte sense data */
macro_line|#ifdef ERP_DEBUG
r_if
c_cond
(paren
id|era
op_eq
id|dasd_era_fatal
)paren
(brace
id|log_erp_chain
(paren
id|cqr
comma
l_int|0
comma
id|stat-&gt;cpa
)paren
suffix:semicolon
)brace
macro_line|#endif /* ERP_DEBUG */
r_return
id|era
suffix:semicolon
)brace
multiline_comment|/* END dasd_3990_erp_examine */
multiline_comment|/*&n; ***************************************************************************** &n; * SECTION ERP HANDLING&n; ***************************************************************************** &n; */
multiline_comment|/*&n; ***************************************************************************** &n; * 24 and 32 byte sense ERP functions&n; ***************************************************************************** &n; */
multiline_comment|/*&n; * DASD_3990_ERP_BLOCK_QUEUE &n; *&n; * DESCRIPTION&n; *   Block the given device request queue to prevent from further&n; *   processing until the started timer has expired or an related&n; *   interrupt was received.&n; *&n; *  PARAMETER&n; *   erp                request to be blocked&n; *   expires            time to wait until restart (in seconds) &n; *&n; * RETURN VALUES&n; *   void               &n; */
r_void
DECL|function|dasd_3990_erp_block_queue
id|dasd_3990_erp_block_queue
(paren
id|ccw_req_t
op_star
id|erp
comma
r_int
r_int
id|expires
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;blocking request queue for %is&quot;
comma
(paren
r_int
)paren
id|expires
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_PENDING
)paren
suffix:semicolon
multiline_comment|/* restart queue after some time */
id|device-&gt;timer.function
op_assign
id|dasd_3990_erp_restart_queue
suffix:semicolon
id|device-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|erp
suffix:semicolon
id|device-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|expires
op_star
id|HZ
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|device-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_block_queue */
multiline_comment|/*&n; * DASD_3990_ERP_RESTART_QUEUE &n; *&n; * DESCRIPTION&n; *   Restarts request currently in status PENDING.&n; *   This has to be done if either an related interrupt has received, or &n; *   a timer has expired.&n; *   &n; *&n; *  PARAMETER&n; *   erp                pointer to the PENDING ERP&n; *&n; * RETURN VALUES&n; *   void               &n; *&n; */
r_void
DECL|function|dasd_3990_erp_restart_queue
id|dasd_3990_erp_restart_queue
(paren
r_int
r_int
id|erp
)paren
(brace
id|ccw_req_t
op_star
id|cqr
op_assign
(paren
r_void
op_star
)paren
id|erp
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* get the needed locks to modify the request queue */
id|s390irq_spin_lock_irqsave
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* &squot;restart&squot; the device queue */
r_if
c_cond
(paren
id|cqr-&gt;status
op_eq
id|CQR_STATUS_PENDING
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;request queue restarted by MIH&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|cqr-&gt;status
comma
id|CQR_STATUS_PENDING
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
)brace
multiline_comment|/* release the lock */
id|s390irq_spin_unlock_irqrestore
(paren
id|device-&gt;devinfo.irq
comma
id|flags
)paren
suffix:semicolon
id|dasd_schedule_bh
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_restart_queue */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/*&n; * DASD_3990_ERP_INT_REQ &n; *&n; * DESCRIPTION&n; *   Handles &squot;Intervention Required&squot; error.&n; *   This means either device offline or not installed.&n; *&n; * PARAMETER&n; *   erp                current erp&n; * RETURN VALUES&n; *   erp                modified erp&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_int_req
id|dasd_3990_erp_int_req
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
multiline_comment|/* first time set initial retry counter and erp_function */
r_if
c_cond
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_int_req
)paren
(brace
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_int_req
suffix:semicolon
)brace
multiline_comment|/* issue a message and wait for &squot;device ready&squot; interrupt */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;is offline or not installed - &quot;
l_string|&quot;INTERVENTION REQUIRED!!&bslash;n&quot;
)paren
suffix:semicolon
id|dasd_3990_erp_block_queue
(paren
id|erp
comma
l_int|60
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_int_req */
macro_line|#endif /* ERP_FULL_ERP */
multiline_comment|/*&n; * DASD_3990_ERP_ALTERNATE_PATH &n; *&n; * DESCRIPTION&n; *   Repeat the operation on a different channel path.&n; *   If all alternate paths have been tried, the request is posted with a&n; *   permanent error.&n; *&n; *  PARAMETER&n; *   erp                pointer to the current ERP&n; *&n; * RETURN VALUES&n; *   erp                modified pointer to the ERP&n; *&n; */
r_void
DECL|function|dasd_3990_erp_alternate_path
id|dasd_3990_erp_alternate_path
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
r_int
id|irq
op_assign
id|device-&gt;devinfo.irq
suffix:semicolon
multiline_comment|/* dissable current channel path - this causes the use of an other &n;&t;   channel path if there is one.. */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;disable lpu %x&quot;
comma
id|erp-&gt;dstat-&gt;lpum
)paren
suffix:semicolon
multiline_comment|/* try alternate valid path */
id|erp-&gt;lpm
op_and_assign
op_complement
(paren
id|erp-&gt;dstat-&gt;lpum
)paren
suffix:semicolon
id|erp-&gt;options
op_or_assign
id|DOIO_VALID_LPM
suffix:semicolon
multiline_comment|/* use LPM for DO_IO */
r_if
c_cond
(paren
(paren
id|erp-&gt;lpm
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
)paren
op_ne
l_int|0x00
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;try alternate lpm %x&quot;
comma
id|erp-&gt;lpm
)paren
suffix:semicolon
multiline_comment|/* reset status to queued to handle the request again... */
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;No alternate channel path left -&gt; &quot;
l_string|&quot;permanent error&quot;
)paren
suffix:semicolon
multiline_comment|/* post request with permanent error */
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end dasd_3990_erp_alternate_path */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/*&n; * DASD_3990_ERP_DCTL&n; *&n; * DESCRIPTION&n; *   Setup cqr to do the Diagnostic Control (DCTL) command with an &n; *   Inhibit Write subcommand (0x20) and the given modifier.&n; *&n; *  PARAMETER&n; *   erp                pointer to the current ERP&n; *   modifier           subcommand modifier&n; *   &n; * RETURN VALUES&n; *   dctl_cqr           pointer to NEW dctl_cqr &n; *&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_DCTL
id|dasd_3990_erp_DCTL
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
id|modifier
)paren
(brace
id|DCTL_data_t
op_star
id|DCTL_data
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|ccw_req_t
op_star
id|dctl_cqr
op_assign
id|dasd_alloc_request
(paren
(paren
r_char
op_star
)paren
op_amp
id|erp-&gt;magic
comma
l_int|1
comma
r_sizeof
(paren
id|DCTL_data_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dctl_cqr
op_eq
l_int|NULL
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|DCTL_data
op_assign
id|dctl_cqr-&gt;data
suffix:semicolon
id|DCTL_data-&gt;subcommand
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* Inhibit Write */
id|DCTL_data-&gt;modifier
op_assign
id|modifier
suffix:semicolon
id|ccw
op_assign
id|dctl_cqr-&gt;cpaddr
suffix:semicolon
id|memset
(paren
id|ccw
comma
l_int|0
comma
r_sizeof
(paren
id|ccw1_t
)paren
)paren
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|CCW_CMD_DCTL
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|4
suffix:semicolon
id|set_normalized_cda
c_func
(paren
id|ccw
comma
id|__pa
(paren
id|DCTL_data
)paren
)paren
suffix:semicolon
id|dctl_cqr-&gt;function
op_assign
id|dasd_3990_erp_DCTL
suffix:semicolon
id|dctl_cqr-&gt;refers
op_assign
id|erp
suffix:semicolon
id|dctl_cqr-&gt;device
op_assign
id|erp-&gt;device
suffix:semicolon
id|dctl_cqr-&gt;magic
op_assign
id|erp-&gt;magic
suffix:semicolon
id|dctl_cqr-&gt;lpm
op_assign
id|LPM_ANYPATH
suffix:semicolon
id|dctl_cqr-&gt;expires
op_assign
l_int|5
op_star
id|TOD_MIN
suffix:semicolon
id|dctl_cqr-&gt;retries
op_assign
l_int|2
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|dctl_cqr-&gt;buildclk
)paren
)paren
suffix:semicolon
id|dctl_cqr-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
r_return
id|dctl_cqr
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_DCTL */
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/*&n; * DASD_3990_ERP_ACTION_1 &n; *&n; * DESCRIPTION&n; *   Setup ERP to do the ERP action 1 (see Reference manual).&n; *   Repeat the operation on a different channel path.&n; *   If all alternate paths have been tried, the request is posted with a&n; *   permanent error.&n; *   Note: duplex handling is not implemented (yet).&n; *&n; *  PARAMETER&n; *   erp                pointer to the current ERP&n; *&n; * RETURN VALUES&n; *   erp                pointer to the ERP&n; *&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_action_1
id|dasd_3990_erp_action_1
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_1
suffix:semicolon
id|dasd_3990_erp_alternate_path
(paren
id|erp
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_1 */
multiline_comment|/*&n; * DASD_3990_ERP_ACTION_4 &n; *&n; * DESCRIPTION&n; *   Setup ERP to do the ERP action 4 (see Reference manual).&n; *   Set the current request to PENDING to block the CQR queue for that device&n; *   until the state change interrupt appears.&n; *   Use a timer (20 seconds) to retry the cqr if the interrupt is still missing.&n; *&n; *  PARAMETER&n; *   sense              sense data of the actual error&n; *   erp                pointer to the current ERP&n; *&n; * RETURN VALUES&n; *   erp                pointer to the ERP&n; *&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_action_4
id|dasd_3990_erp_action_4
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
multiline_comment|/* first time set initial retry counter and erp_function    */
multiline_comment|/* and retry once without waiting for state change pending  */
multiline_comment|/* interrupt (this enables easier enqueing of the cqr)      */
r_if
c_cond
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_action_4
)paren
(brace
id|erp-&gt;retries
op_assign
l_int|255
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_4
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
l_int|0x1D
)paren
(brace
multiline_comment|/* state change pending */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;waiting for state change pending &quot;
l_string|&quot;int&quot;
)paren
suffix:semicolon
id|dasd_3990_erp_block_queue
(paren
id|erp
comma
l_int|30
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no state change pending - retry */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;no state change pending - retry&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
)brace
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_4 */
multiline_comment|/*&n; ***************************************************************************** &n; * 24 byte sense ERP functions (only)&n; ***************************************************************************** &n; */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/*&n; * DASD_3990_ERP_ACTION_5 &n; *&n; * DESCRIPTION&n; *   Setup ERP to do the ERP action 5 (see Reference manual).&n; *&n; *  PARAMETER&n; *   erp                pointer to the current ERP&n; *&n; * RETURN VALUES&n; *   erp                pointer to the ERP&n; *&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_action_5
id|dasd_3990_erp_action_5
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
multiline_comment|/* first of all retry */
id|erp-&gt;retries
op_assign
l_int|10
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_5
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
multiline_comment|/* further handling is done in xxx_further_erp after the retries */
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_5 */
multiline_comment|/*&n; * DASD_3990_HANDLE_ENV_DATA&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Enviromental data present&squot;.&n; *   Does a analysis of the sense data (message Format)&n; *   and prints the error messages.&n; *&n; * PARAMETER&n; *   sense              current sense data&n; *   &n; * RETURN VALUES&n; *   void&n; */
r_void
DECL|function|dasd_3990_handle_env_data
id|dasd_3990_handle_env_data
(paren
r_char
op_star
id|sense
)paren
(brace
multiline_comment|/* check bytes 7-23 for further information */
r_char
id|msg_format
op_assign
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0xF0
)paren
suffix:semicolon
r_char
id|msg_no
op_assign
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x0F
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|msg_format
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* Format 0 - Program or System Checks */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
l_int|0x10
)paren
(brace
multiline_comment|/* check message to operator bit */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No Message */
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Invalid Command&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Invalid Command Sequence&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - CCW Count less than &quot;
l_string|&quot;required&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Invalid Parameter&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Diagnostic of Sepecial &quot;
l_string|&quot;Command Violates File Mask&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Channel Returned with &quot;
l_string|&quot;Incorrect retry CCW&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Reset Notification&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Storage Path Restart&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Channel requested ... %02x&bslash;n&quot;
comma
id|sense
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Invalid Defective/Alternate &quot;
l_string|&quot;Track Pointer&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - DPS Installation Check&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Command Invalid on Secondary &quot;
l_string|&quot;Address&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Status Not As Required: &quot;
l_string|&quot;reason %02x&bslash;n&quot;
comma
id|sense
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Reseved&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No Message */
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Device Error Source&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Device Fenced - device = &quot;
l_string|&quot;%02x&bslash;n&quot;
comma
id|sense
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Data Pinned for Device&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 0 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
multiline_comment|/* Format 1 - Device Equipment Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No Message */
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Device Status 1 not as &quot;
l_string|&quot;expected&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Index missing&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Interruption cannot be reset&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Device did not respond to &quot;
l_string|&quot;selection&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Device check-2 error or Set &quot;
l_string|&quot;Sector is not complete&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Head address does not compare&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Device status 1 not valid&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Device not ready&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Track physical address did &quot;
l_string|&quot;not compare&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Missing device address bit&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Drive motor switch is off&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0D
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Seek incomplete&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Cylinder address did not &quot;
l_string|&quot;compare&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Offset active cannot be reset&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 1 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
multiline_comment|/* Format 2 - 3990 Equipment Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x08
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 2 - 3990 check-2 error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 2 - Support facility errors&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 2 - Microcode detected error %02x&bslash;n&quot;
comma
id|sense
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 2 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x30
suffix:colon
multiline_comment|/* Format 3 - 3990 Control Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x0F
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 3 - Allegiance terminated&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 3 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
multiline_comment|/* Format 4 - Data Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Home address area error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Count area error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Key area error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Data area error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - No sync byte in home address area&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - No syn byte in count address area&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - No sync byte in key area&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - No syn byte in data area&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Home address area error; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Count area error; offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Key area error; offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Data area error; offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - No sync byte in home address area; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0D
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - No syn byte in count address area; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - No sync byte in key area; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - No syn byte in data area; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 4 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x50
suffix:colon
multiline_comment|/* Format 5 - Data Check with displacement information */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Data Check in the home address area&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Data Check in the count area&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Data Check in the key area&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Data Check in the data area&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Data Check in the home address area; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Data Check in the count area; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Data Check in the key area; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Data Check in the data area; &quot;
l_string|&quot;offset active&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 5 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x60
suffix:colon
multiline_comment|/* Format 6 - Usage Statistics/Overrun Errors */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Overrun on channel A&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Overrun on channel B&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Overrun on channel C&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Overrun on channel D&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Overrun on channel E&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Overrun on channel F&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Overrun on channel G&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Overrun on channel H&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 6 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x70
suffix:colon
multiline_comment|/* Format 7 - Device Connection Control Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - RCC initiated by a connection &quot;
l_string|&quot;check alert&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - RCC 1 sequence not successful&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - RCC 1 and RCC 2 sequences not &quot;
l_string|&quot;successful&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - Invalid tag-in during selection &quot;
l_string|&quot;sequence&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - extra RCC required&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - Invalid DCC selection response &quot;
l_string|&quot;or timeout&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - Missing end operation; device &quot;
l_string|&quot;transfer complete&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - Missing end operation; device &quot;
l_string|&quot;transfer incomplete&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - Invalid tag-in for an immediate &quot;
l_string|&quot;command sequence&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - Invalid tag-in for an extended &quot;
l_string|&quot;command sequence&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - 3990 microcode time out when &quot;
l_string|&quot;stopping selection&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - No response to selection after &quot;
l_string|&quot;a poll interruption&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - Permanent path error (DASD &quot;
l_string|&quot;controller not available)&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0D
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - DASD controller not available on &quot;
l_string|&quot;disconnected command chain&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 7 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x80
suffix:colon
multiline_comment|/* Format 8 - Additional Device Equipment Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No Message */
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - Error correction code hardware &quot;
l_string|&quot;fault&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - Unexpected end operation response &quot;
l_string|&quot;code&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - End operation with transfer count &quot;
l_string|&quot;not zero&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - End operation with transfer &quot;
l_string|&quot;count zero&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - DPS checks after a system reset or &quot;
l_string|&quot;selective reset&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - DPS cannot be filled&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - Short busy time-out during device &quot;
l_string|&quot;selection&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - DASD controller failed to set or &quot;
l_string|&quot;reset the long busy latch&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - No interruption from device during &quot;
l_string|&quot;a command chain&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 8 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x90
suffix:colon
multiline_comment|/* Format 9 - Device Read, Write, and Seek Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* No Message */
r_case
l_int|0x06
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 9 - Device check-2 error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 9 - Head address did not compare&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 9 - Track physical address did not &quot;
l_string|&quot;compare while oriented&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 9 - Cylinder address did not compare&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT 9 - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0xF0
suffix:colon
multiline_comment|/* Format F - Cache Storage Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Operation Terminated&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Subsystem Processing Error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Cache or nonvolatile storage &quot;
l_string|&quot;equipment failure&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Caching terminated&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Cache fast write access not &quot;
l_string|&quot;authorized&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Track format incorrect&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Caching reinitiated&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Nonvolatile storage terminated&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Volume is suspended duplex&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Subsystem status connot be &quot;
l_string|&quot;determined&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0D
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - Caching status reset to default&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT F - DASD Fast Write inhibited&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;FORMAT D - Reserved&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* unknown message format - should not happen */
)brace
multiline_comment|/* end switch message format */
)brace
multiline_comment|/* end dasd_3990_handle_env_data */
multiline_comment|/*&n; * DASD_3990_ERP_COM_REJ&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Command Reject&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; *   sense              current sense data&n; * &n; * RETURN VALUES&n; *   erp                &squot;new&squot; erp_head - pointer to new ERP &n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_com_rej
id|dasd_3990_erp_com_rej
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
op_assign
l_int|NULL
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_com_rej
suffix:semicolon
multiline_comment|/* env data present (ACTION 10 - retry should work) */
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Command Reject - environmental data present&bslash;n&quot;
)paren
suffix:semicolon
id|dasd_3990_handle_env_data
(paren
id|sense
)paren
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fatal error -  set status to FAILED */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Command Reject - Fatal error&bslash;n&quot;
)paren
suffix:semicolon
id|cqr
op_assign
id|erp-&gt;refers
suffix:semicolon
id|dasd_free_request
(paren
id|erp
)paren
suffix:semicolon
id|erp
op_assign
id|cqr
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_com_rej */
multiline_comment|/*&n; * DASD_3990_ERP_BUS_OUT &n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Bus Out Parity Check&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_bus_out
id|dasd_3990_erp_bus_out
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
multiline_comment|/* first time set initial retry counter and erp_function */
r_if
c_cond
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_bus_out
)paren
(brace
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_bus_out
suffix:semicolon
)brace
multiline_comment|/* issue a message and wait for &squot;device ready&squot; interrupt */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;bus out parity error or BOPC requested by channel&bslash;n&quot;
)paren
suffix:semicolon
id|dasd_3990_erp_block_queue
(paren
id|erp
comma
l_int|60
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_bus_out */
macro_line|#endif /* ERP_FULL_ERP */
multiline_comment|/*&n; * DASD_3990_ERP_EQUIP_CHECK&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Equipment Check&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_equip_check
id|dasd_3990_erp_equip_check
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_equip_check
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_WRITE_INHIBITED
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Write inhibited path encountered&quot;
)paren
suffix:semicolon
multiline_comment|/* vary path offline */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Path should be varied off-line. &quot;
l_string|&quot;This is not implemented yet &bslash;n - please report to &quot;
l_string|&quot;linux390@de.ibm.com&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_1
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif /* ERP_FULL_ERP */
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Equipment Check - &quot;
l_string|&quot;environmental data present&quot;
)paren
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
id|dasd_3990_handle_env_data
(paren
id|sense
)paren
suffix:semicolon
macro_line|#endif /* ERP_FULL_ERP */
id|erp
op_assign
id|dasd_3990_erp_action_4
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
)brace
r_else
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_PERM_ERR
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Equipment Check - retry exhausted or &quot;
l_string|&quot;undesirable&bslash;n&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_1
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* all other equipment checks - Action 5 */
multiline_comment|/* rest is done when retries == 0 */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Equipment check or processing error&bslash;n&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_5
(paren
id|erp
)paren
suffix:semicolon
macro_line|#endif /* ERP_FULL_ERP */
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_equip_check */
multiline_comment|/*&n; * DASD_3990_ERP_DATA_CHECK&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Data Check&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_data_check
id|dasd_3990_erp_data_check
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_data_check
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_CORRECTABLE
)paren
(brace
multiline_comment|/* correctable data check */
multiline_comment|/* issue message that the data has been corrected */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Data recovered during retry with PCI &quot;
l_string|&quot;fetch mode active&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* not possible to handle this situation in Linux */
id|panic
c_func
(paren
l_string|&quot;No way to inform appliction about the possibly &quot;
l_string|&quot;incorret data&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Uncorrectable data check recovered secondary &quot;
l_string|&quot;addr of duplex pair&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_4
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_PERM_ERR
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Uncorrectable data check with internal &quot;
l_string|&quot;retry exhausted&bslash;n&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_1
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* all other data checks */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Uncorrectable data check with retry count &quot;
l_string|&quot;exhausted...&bslash;n&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_5
(paren
id|erp
)paren
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Uncorrectable data check recovered secondary &quot;
l_string|&quot;addr of duplex pair&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_4
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
macro_line|#endif /* ERP_FULL_ERP */
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_data_check */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/*&n; * DASD_3990_ERP_OVERRUN&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Overrun&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_overrun
id|dasd_3990_erp_overrun
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_overrun
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Overrun - service overrun or overrun&quot;
l_string|&quot; error requested by channel&bslash;n&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_5
(paren
id|erp
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_overrun */
macro_line|#endif /* ERP_FULL_ERP */
multiline_comment|/*&n; * DASD_3990_ERP_INV_FORMAT&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Invalid Track Format&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_inv_format
id|dasd_3990_erp_inv_format
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_inv_format
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Track format error when destaging or &quot;
l_string|&quot;staging data&quot;
)paren
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
id|dasd_3990_handle_env_data
(paren
id|sense
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_4
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Invalid Track Format - Fatal error should have &quot;
l_string|&quot;been handled within the interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
)brace
macro_line|#else
id|erp
op_assign
id|dasd_3990_erp_action_4
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
macro_line|#endif /* ERP_FULL_ERP */
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_inv_format */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/*&n; * DASD_3990_ERP_EOC&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;End-of-Cylinder&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_EOC
id|dasd_3990_erp_EOC
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_EOC
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;End-of-Cylinder - must never happen&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* implement action 7 */
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_EOC */
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/*&n; * DASD_3990_ERP_ENV_DATA&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Environmental-Data Present&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_env_data
id|dasd_3990_erp_env_data
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_env_data
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Environmental data present&quot;
)paren
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
id|dasd_3990_handle_env_data
(paren
id|sense
)paren
suffix:semicolon
macro_line|#endif /* ERP_FULL_ERP */  
id|erp
op_assign
id|dasd_3990_erp_action_4
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_env_data */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/*&n; * DASD_3990_ERP_NO_REC&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;No Record Found&squot; error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_no_rec
id|dasd_3990_erp_no_rec
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_no_rec
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;No Record Found - Fatal error should &quot;
l_string|&quot;have been handled within the interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_no_rec */
multiline_comment|/*&n; * DASD_3990_ERP_FILE_PROT&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;File Protected&squot; error.&n; *   Note: Seek related recovery is not implemented because&n; *         wee don&squot;t use the seek command yet.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; * RETURN VALUES&n; *   erp                new erp_head - pointer to new ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_file_prot
id|dasd_3990_erp_file_prot
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_file_prot
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;File Protected&bslash;n&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_file_prot */
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/*&n; * DASD_3990_ERP_INSPECT_24 &n; *&n; * DESCRIPTION&n; *   Does a detailed inspection of the 24 byte sense data&n; *   and sets up a related error recovery action.  &n; *&n; * PARAMETER&n; *   sense              sense data of the actual error&n; *   erp                pointer to the currently created default ERP&n; *&n; * RETURN VALUES&n; *   erp                pointer to the (addtitional) ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_inspect_24
id|dasd_3990_erp_inspect_24
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|ccw_req_t
op_star
id|erp_filled
op_assign
l_int|NULL
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
multiline_comment|/* Check sense for ....    */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/* &squot;Command Reject&squot;        */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_CMD_REJECT
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_com_rej
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Intervention Required&squot; */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_INTERVENTION_REQ
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_int_req
(paren
id|erp
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Bus Out Parity Check&squot;  */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_BUS_OUT_CHECK
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_bus_out
(paren
id|erp
)paren
suffix:semicolon
)brace
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/* &squot;Equipment Check&squot;       */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_EQUIPMENT_CHECK
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_equip_check
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Data Check&squot;            */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_DATA_CHECK
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_data_check
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/* &squot;Overrun&squot;               */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_OVERRUN
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_overrun
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/* &squot;Invalid Track Format&squot;  */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_INV_TRACK_FORMAT
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_inv_format
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/* &squot;End-of-Cylinder&squot;       */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_EOC
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_EOC
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/* &squot;Environmental Data&squot;    */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_env_data
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/* &squot;No Record Found&squot;       */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_NO_REC_FOUND
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_no_rec
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;File Protected&squot;        */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_FILE_PROTECTED
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_file_prot
(paren
id|erp
)paren
suffix:semicolon
)brace
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/* other (unknown) error - do default ERP                     */
r_if
c_cond
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;default ERP taken&quot;
)paren
suffix:semicolon
id|erp_filled
op_assign
id|erp
suffix:semicolon
)brace
r_return
id|erp_filled
suffix:semicolon
)brace
multiline_comment|/* END dasd_3990_erp_inspect_24 */
multiline_comment|/*&n; ***************************************************************************** &n; * 32 byte sense ERP functions (only)&n; ***************************************************************************** &n; */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/*&n; * DASD_3990_ERPACTION_10_32 &n; *&n; * DESCRIPTION&n; *   Handles 32 byte &squot;Action 10&squot; of Single Program Action Codes.&n; *   Just retry and if retry doesn&squot;t work, return with error.&n; *&n; * PARAMETER&n; *   erp                current erp_head&n; *   sense              current sense data &n; * RETURN VALUES&n; *   erp                modified erp_head&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_action_10_32
id|dasd_3990_erp_action_10_32
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_10_32
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Perform logging requested&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_10_32 */
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/*&n; * DASD_3990_ERP_ACTION_1B_32&n; *&n; * DESCRIPTION&n; *   Handles 32 byte &squot;Action 1B&squot; of Single Program Action Codes.&n; *   A write operation could not be finished because of an unexpected &n; *   condition.&n; *   The already created &squot;default erp&squot; is used to get the link to &n; *   the erp chain, but it can not be used for this recovery &n; *   action because it contains no DE/LO data space.&n; *&n; * PARAMETER&n; *   default_erp        already created default erp.&n; *   sense              current sense data &n; * RETURN VALUES&n; *   erp                new erp or &n; *                      default_erp in case of imprecise ending or error&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_action_1B_32
id|dasd_3990_erp_action_1B_32
(paren
id|ccw_req_t
op_star
id|default_erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|default_erp-&gt;device
suffix:semicolon
id|__u32
id|cpa
op_assign
l_int|0
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw_req_t
op_star
id|erp
suffix:semicolon
id|DE_eckd_data_t
op_star
id|DE_data
suffix:semicolon
r_char
op_star
id|LO_data
suffix:semicolon
multiline_comment|/* LO_eckd_data_t */
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Write not finsihed because of unexpected condition&quot;
)paren
suffix:semicolon
id|default_erp-&gt;function
op_assign
id|dasd_3990_erp_action_1B_32
suffix:semicolon
multiline_comment|/* determine the original cqr */
id|cqr
op_assign
id|default_erp
suffix:semicolon
r_while
c_loop
(paren
id|cqr-&gt;refers
op_ne
l_int|NULL
)paren
(brace
id|cqr
op_assign
id|cqr-&gt;refers
suffix:semicolon
)brace
multiline_comment|/* for imprecise ending just do default erp */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Imprecise ending is set - just retry&quot;
)paren
suffix:semicolon
r_return
id|default_erp
suffix:semicolon
)brace
multiline_comment|/* determine the address of the CCW to be restarted */
multiline_comment|/* Imprecise ending is not set -&gt; addr from IRB-SCSW */
id|cpa
op_assign
id|default_erp-&gt;refers-&gt;dstat-&gt;cpa
suffix:semicolon
r_if
c_cond
(paren
id|cpa
op_eq
l_int|0
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to determine address of the CCW &quot;
l_string|&quot;to be restarted&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|default_erp-&gt;status
comma
id|CQR_STATUS_FILLED
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_return
id|default_erp
suffix:semicolon
)brace
multiline_comment|/* Build new ERP request including DE/LO */
id|erp
op_assign
id|dasd_alloc_request
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
l_int|2
op_plus
l_int|1
comma
multiline_comment|/* DE/LO + TIC */
r_sizeof
(paren
id|DE_eckd_data_t
)paren
op_plus
r_sizeof
(paren
id|LO_eckd_data_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|erp
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to allocate ERP&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|default_erp-&gt;status
comma
id|CQR_STATUS_FILLED
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_return
id|default_erp
suffix:semicolon
)brace
multiline_comment|/* use original DE */
id|DE_data
op_assign
id|erp-&gt;data
suffix:semicolon
id|memcpy
(paren
id|DE_data
comma
id|cqr-&gt;data
comma
r_sizeof
(paren
id|DE_eckd_data_t
)paren
)paren
suffix:semicolon
multiline_comment|/* create LO */
id|LO_data
op_assign
id|erp-&gt;data
op_plus
r_sizeof
(paren
id|DE_eckd_data_t
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|3
)braket
op_eq
l_int|0x01
)paren
op_logical_and
(paren
id|LO_data
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;BUG - this should not happen&quot;
)paren
suffix:semicolon
singleline_comment|//BUG();    /* check for read count suffixing n.a. */
)brace
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x3F
)paren
op_eq
l_int|0x01
)paren
(brace
multiline_comment|/* operation code is WRITE DATA -&gt; data area orientation */
id|LO_data
(braket
l_int|0
)braket
op_assign
l_int|0x81
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x3F
)paren
op_eq
l_int|0x03
)paren
(brace
multiline_comment|/* operation code is FORMAT WRITE -&gt; index orientation */
id|LO_data
(braket
l_int|0
)braket
op_assign
l_int|0xC3
suffix:semicolon
)brace
r_else
(brace
id|LO_data
(braket
l_int|0
)braket
op_assign
id|sense
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* operation */
)brace
id|LO_data
(braket
l_int|1
)braket
op_assign
id|sense
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* auxiliary */
id|LO_data
(braket
l_int|2
)braket
op_assign
id|sense
(braket
l_int|9
)braket
suffix:semicolon
id|LO_data
(braket
l_int|3
)braket
op_assign
id|sense
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* count */
id|LO_data
(braket
l_int|4
)braket
op_assign
id|sense
(braket
l_int|29
)braket
suffix:semicolon
multiline_comment|/* seek_addr.cyl */
id|LO_data
(braket
l_int|5
)braket
op_assign
id|sense
(braket
l_int|30
)braket
suffix:semicolon
multiline_comment|/* seek_addr.cyl 2nd byte */
id|LO_data
(braket
l_int|7
)braket
op_assign
id|sense
(braket
l_int|31
)braket
suffix:semicolon
multiline_comment|/* seek_addr.head 2nd byte */
id|memcpy
(paren
op_amp
(paren
id|LO_data
(braket
l_int|8
)braket
)paren
comma
op_amp
(paren
id|sense
(braket
l_int|11
)braket
)paren
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* create DE ccw */
id|ccw
op_assign
id|erp-&gt;cpaddr
suffix:semicolon
id|memset
(paren
id|ccw
comma
l_int|0
comma
r_sizeof
(paren
id|ccw1_t
)paren
)paren
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_DEFINE_EXTENT
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|16
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|DE_data
)paren
)paren
suffix:semicolon
multiline_comment|/* create LO ccw */
id|ccw
op_increment
suffix:semicolon
id|memset
(paren
id|ccw
comma
l_int|0
comma
r_sizeof
(paren
id|ccw1_t
)paren
)paren
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_LOCATE_RECORD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|16
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|LO_data
)paren
)paren
suffix:semicolon
multiline_comment|/* TIC to the failed ccw */
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|CCW_CMD_TIC
suffix:semicolon
id|ccw-&gt;cda
op_assign
id|cpa
suffix:semicolon
multiline_comment|/* fill erp related fields */
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_1B_32
suffix:semicolon
id|erp-&gt;refers
op_assign
id|default_erp-&gt;refers
suffix:semicolon
id|erp-&gt;device
op_assign
id|device
suffix:semicolon
id|erp-&gt;magic
op_assign
id|default_erp-&gt;magic
suffix:semicolon
id|erp-&gt;lpm
op_assign
l_int|0xFF
suffix:semicolon
id|erp-&gt;expires
op_assign
l_int|0
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|255
suffix:semicolon
id|erp-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
multiline_comment|/* remove the default erp */
id|dasd_free_request
(paren
id|default_erp
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_1B_32 */
multiline_comment|/*&n; * DASD_3990_UPDATE_1B&n; *&n; * DESCRIPTION&n; *   Handles the update to the 32 byte &squot;Action 1B&squot; of Single Program &n; *   Action Codes in case the first action was not successful.&n; *   The already created &squot;previous_erp&squot; is the currently not successful&n; *   ERP. &n; *&n; * PARAMETER&n; *   previous_erp       already created previous erp.&n; *   sense              current sense data &n; * RETURN VALUES&n; *   erp                modified erp &n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_update_1B
id|dasd_3990_update_1B
(paren
id|ccw_req_t
op_star
id|previous_erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|previous_erp-&gt;device
suffix:semicolon
id|__u32
id|cpa
op_assign
l_int|0
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw_req_t
op_star
id|erp
suffix:semicolon
r_char
op_star
id|LO_data
suffix:semicolon
multiline_comment|/* LO_eckd_data_t */
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Write not finsihed because of unexpected condition&quot;
l_string|&quot; - follow on&quot;
)paren
suffix:semicolon
multiline_comment|/* determine the original cqr */
id|cqr
op_assign
id|previous_erp
suffix:semicolon
r_while
c_loop
(paren
id|cqr-&gt;refers
op_ne
l_int|NULL
)paren
(brace
id|cqr
op_assign
id|cqr-&gt;refers
suffix:semicolon
)brace
multiline_comment|/* for imprecise ending just do default erp */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Imprecise ending is set - just retry&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|previous_erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
r_return
id|previous_erp
suffix:semicolon
)brace
multiline_comment|/* determine the address of the CCW to be restarted */
multiline_comment|/* Imprecise ending is not set -&gt; addr from IRB-SCSW */
id|cpa
op_assign
id|previous_erp-&gt;dstat-&gt;cpa
suffix:semicolon
r_if
c_cond
(paren
id|cpa
op_eq
l_int|0
)paren
(brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
multiline_comment|/* addr of first data transfer */
id|ccw
op_increment
suffix:semicolon
multiline_comment|/* command in domain           */
id|ccw
op_increment
suffix:semicolon
id|cpa
op_assign
(paren
id|__u32
)paren
id|ccw
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpa
op_eq
l_int|0
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to determine address of the CCW &quot;
l_string|&quot;to be restarted&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|previous_erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_return
id|previous_erp
suffix:semicolon
)brace
id|erp
op_assign
id|previous_erp
suffix:semicolon
multiline_comment|/* update the LO with the new returned sense data  */
id|LO_data
op_assign
id|erp-&gt;data
op_plus
r_sizeof
(paren
id|DE_eckd_data_t
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|3
)braket
op_eq
l_int|0x01
)paren
op_logical_and
(paren
id|LO_data
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;BUG - this should not happen&quot;
)paren
suffix:semicolon
singleline_comment|//BUG();    /* check for read count suffixing n.a. */
)brace
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x3F
)paren
op_eq
l_int|0x01
)paren
(brace
multiline_comment|/* operation code is WRITE DATA -&gt; data area orientation */
id|LO_data
(braket
l_int|0
)braket
op_assign
l_int|0x81
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x3F
)paren
op_eq
l_int|0x03
)paren
(brace
multiline_comment|/* operation code is FORMAT WRITE -&gt; index orientation */
id|LO_data
(braket
l_int|0
)braket
op_assign
l_int|0xC3
suffix:semicolon
)brace
r_else
(brace
id|LO_data
(braket
l_int|0
)braket
op_assign
id|sense
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* operation */
)brace
id|LO_data
(braket
l_int|1
)braket
op_assign
id|sense
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* auxiliary */
id|LO_data
(braket
l_int|2
)braket
op_assign
id|sense
(braket
l_int|9
)braket
suffix:semicolon
id|LO_data
(braket
l_int|3
)braket
op_assign
id|sense
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* count */
id|LO_data
(braket
l_int|4
)braket
op_assign
id|sense
(braket
l_int|29
)braket
suffix:semicolon
multiline_comment|/* seek_addr.cyl */
id|LO_data
(braket
l_int|5
)braket
op_assign
id|sense
(braket
l_int|30
)braket
suffix:semicolon
multiline_comment|/* seek_addr.cyl 2nd byte */
id|LO_data
(braket
l_int|7
)braket
op_assign
id|sense
(braket
l_int|31
)braket
suffix:semicolon
multiline_comment|/* seek_addr.head 2nd byte */
id|memcpy
(paren
op_amp
(paren
id|LO_data
(braket
l_int|8
)braket
)paren
comma
op_amp
(paren
id|sense
(braket
l_int|11
)braket
)paren
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* TIC to the failed ccw */
id|ccw
op_assign
id|erp-&gt;cpaddr
suffix:semicolon
multiline_comment|/* addr of DE ccw */
id|ccw
op_increment
suffix:semicolon
multiline_comment|/* addr of LE ccw */
id|ccw
op_increment
suffix:semicolon
multiline_comment|/* addr of TIC ccw */
id|ccw-&gt;cda
op_assign
id|cpa
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_update_1B */
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND_RETRY &n; *&n; * DESCRIPTION&n; *   Handles the compound ERP action retry code.&n; *&n; * PARAMETER&n; *   sense              sense data of the actual error&n; *   erp                pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp                modified ERP pointer&n; *&n; */
r_void
DECL|function|dasd_3990_erp_compound_retry
id|dasd_3990_erp_compound_retry
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_switch
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* no not retry */
id|erp-&gt;retries
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* retry 2 times */
id|erp-&gt;retries
op_assign
l_int|2
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* retry 10 times */
id|erp-&gt;retries
op_assign
l_int|10
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
multiline_comment|/* retry 255 times */
id|erp-&gt;retries
op_assign
l_int|255
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_compound_retry
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound_retry */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND_PATH &n; *&n; * DESCRIPTION&n; *   Handles the compound ERP action for retry on alternate&n; *   channel path.&n; *&n; * PARAMETER&n; *   sense              sense data of the actual error&n; *   erp                pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp                modified ERP pointer&n; *&n; */
r_void
DECL|function|dasd_3990_erp_compound_path
id|dasd_3990_erp_compound_path
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
id|DASD_SENSE_BIT_3
)paren
(brace
id|dasd_3990_erp_alternate_path
(paren
id|erp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp-&gt;status
op_eq
id|CQR_STATUS_FAILED
)paren
(brace
multiline_comment|/* reset the lpm and the status to be able to &n;                         * try further actions. */
id|erp-&gt;lpm
op_assign
id|LPM_ANYPATH
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_FAILED
comma
id|CQR_STATUS_ERROR
)paren
suffix:semicolon
)brace
)brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_compound_path
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound_path */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND_CODE &n; *&n; * DESCRIPTION&n; *   Handles the compound ERP action for retry code.&n; *&n; * PARAMETER&n; *   sense              sense data of the actual error&n; *   erp                pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp                NEW ERP pointer&n; *&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_compound_code
id|dasd_3990_erp_compound_code
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
id|DASD_SENSE_BIT_2
)paren
(brace
r_switch
c_cond
(paren
id|sense
(braket
l_int|28
)braket
)paren
(brace
r_case
l_int|0x17
suffix:colon
multiline_comment|/* issue a Diagnostic Control command with an &n;                         * Inhibit Write subcommand and controler modifier */
id|erp
op_assign
id|dasd_3990_erp_DCTL
(paren
id|erp
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x25
suffix:colon
multiline_comment|/* wait for 5 seconds and retry again */
id|erp-&gt;retries
op_assign
l_int|1
suffix:semicolon
id|dasd_3990_erp_block_queue
(paren
id|erp
comma
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_compound_code
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound_code */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND_CONFIG &n; *&n; * DESCRIPTION&n; *   Handles the compound ERP action for configruation&n; *   dependent error.&n; *   Note: duplex handling is not implemented (yet).&n; *&n; * PARAMETER&n; *   sense              sense data of the actual error&n; *   erp                pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp                modified ERP pointer&n; *&n; */
r_void
DECL|function|dasd_3990_erp_compound_config
id|dasd_3990_erp_compound_config
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|25
)braket
op_amp
id|DASD_SENSE_BIT_1
)paren
op_logical_and
(paren
id|sense
(braket
l_int|26
)braket
op_amp
id|DASD_SENSE_BIT_2
)paren
)paren
(brace
multiline_comment|/* set to suspended duplex state then restart */
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Set device to suspended duplex state should be done!&bslash;n&quot;
l_string|&quot;This is not implemented yet (for compound ERP)&bslash;n&quot;
l_string|&quot; - please report to linux390@de.ibm.com&quot;
)paren
suffix:semicolon
)brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_compound_config
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound_config */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND &n; *&n; * DESCRIPTION&n; *   Does a detailed inspection of the 32 byte sense data&n; *   and sets up a related error recovery action.  &n; *&n; * PARAMETER&n; *   sense              sense data of the actual error&n; *   erp                pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp                (additional) ERP pointer&n; *&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_compound
id|dasd_3990_erp_compound
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_compound_retry
)paren
op_logical_and
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_compound_path
)paren
op_logical_and
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_compound_code
)paren
op_logical_and
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_compound_config
)paren
)paren
(brace
multiline_comment|/* called first time */
id|dasd_3990_erp_compound_retry
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* do further action if no retry is specified / left */
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_retry
)paren
op_logical_and
(paren
id|erp-&gt;status
op_eq
id|CQR_STATUS_ERROR
)paren
)paren
(brace
id|dasd_3990_erp_compound_path
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_path
)paren
op_logical_and
(paren
id|erp-&gt;status
op_eq
id|CQR_STATUS_ERROR
)paren
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_compound_code
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_code
)paren
op_logical_and
(paren
id|erp-&gt;status
op_eq
id|CQR_STATUS_ERROR
)paren
)paren
(brace
id|dasd_3990_erp_compound_config
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* if no compound action ERP specified, the request failed */
r_if
c_cond
(paren
id|erp-&gt;status
op_eq
id|CQR_STATUS_ERROR
)paren
(brace
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound */
macro_line|#endif /* ERP_FULL_ERP */  
multiline_comment|/*&n; * DASD_3990_ERP_INSPECT_32 &n; *&n; * DESCRIPTION&n; *   Does a detailed inspection of the 32 byte sense data&n; *   and sets up a related error recovery action.  &n; *&n; * PARAMETER&n; *   sense              sense data of the actual error&n; *   erp                pointer to the currently created default ERP&n; *&n; * RETURN VALUES&n; *   erp_filled         pointer to the ERP&n; *&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_inspect_32
id|dasd_3990_erp_inspect_32
(paren
id|ccw_req_t
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_inspect_32
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
(brace
multiline_comment|/* compound program action codes (byte25 bit 0 == &squot;1&squot;) */
macro_line|#ifdef ERP_FULL_ERP
id|erp
op_assign
id|dasd_3990_erp_compound
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
macro_line|#else
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;default ERP taken&quot;
)paren
suffix:semicolon
macro_line|#endif /* ERP_FULL_ERP */  
)brace
r_else
(brace
multiline_comment|/* single program action codes (byte25 bit 0 == &squot;0&squot;) */
r_switch
c_cond
(paren
id|sense
(braket
l_int|25
)braket
)paren
(brace
macro_line|#ifdef ERP_FULL_ERP
r_case
l_int|0x00
suffix:colon
multiline_comment|/* success */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;ERP called for successful request %p&quot;
l_string|&quot; - NO ERP necessary&quot;
comma
id|erp
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_DONE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* fatal error */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Fatal error should &quot;
l_string|&quot;have been handled within the interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* intervention required */
r_case
l_int|0x03
suffix:colon
multiline_comment|/* intervention required during dual copy */
id|erp
op_assign
id|dasd_3990_erp_int_req
(paren
id|erp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
multiline_comment|/* length mismatch during update write command */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;update write command error - should not happen; &quot;
l_string|&quot;Please send this message together with the above &quot;
l_string|&quot;sense data to linux390@de.ibm.com&bslash;n&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
multiline_comment|/* logging required for other channel program */
id|erp
op_assign
id|dasd_3990_erp_action_10_32
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x15
suffix:colon
multiline_comment|/* next track outside defined extend */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;next track outside defined extend - should not happen; &quot;
l_string|&quot;Please send this message together with the above &quot;
l_string|&quot;sense data to linux390@de.ibm.com&bslash;n&quot;
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* ERP_FULL_ERP */  
r_case
l_int|0x1B
suffix:colon
multiline_comment|/* unexpected condition during write */
id|erp
op_assign
id|dasd_3990_erp_action_1B_32
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
r_case
l_int|0x1C
suffix:colon
multiline_comment|/* invalid data */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Data recovered during retry with PCI &quot;
l_string|&quot;fetch mode active&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* not possible to handle this situation in Linux */
id|panic
c_func
(paren
l_string|&quot;No way to inform appliction about the possibly &quot;
l_string|&quot;incorret data&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif /* ERP_FULL_ERP */  
r_case
l_int|0x1D
suffix:colon
multiline_comment|/* state-change pending */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;A State change pending condition exists &quot;
l_string|&quot;for the subsystem or device&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_4
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* all others errors */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;default ERP taken&quot;
)paren
suffix:semicolon
)brace
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_inspect_32 */
multiline_comment|/*&n; ***************************************************************************** &n; * main ERP control fuctions (24 and 32 byte sense)&n; ***************************************************************************** &n; */
multiline_comment|/*&n; * DASD_3990_ERP_INSPECT&n; *&n; * DESCRIPTION&n; *   Does a detailed inspection for sense data by calling either&n; *   the 24-byte or the 32-byte inspection routine.&n; *&n; * PARAMETER&n; *   erp                pointer to the currently created default ERP&n; * RETURN VALUES&n; *   erp_new            contens was possibly modified &n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_inspect
id|dasd_3990_erp_inspect
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
id|ccw_req_t
op_star
id|erp_new
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* sense data are located in the refers record of the */
multiline_comment|/* already set up new ERP !                           */
r_char
op_star
id|sense
op_assign
id|erp-&gt;refers-&gt;dstat-&gt;ii.sense.data
suffix:semicolon
multiline_comment|/* distinguish between 24 and 32 byte sense data */
r_if
c_cond
(paren
id|sense
(braket
l_int|27
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
(brace
multiline_comment|/* inspect the 24 byte sense data */
id|erp_new
op_assign
id|dasd_3990_erp_inspect_24
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* inspect the 32 byte sense data */
id|erp_new
op_assign
id|dasd_3990_erp_inspect_32
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* end distinguish between 24 and 32 byte sense data */
r_return
id|erp_new
suffix:semicolon
)brace
multiline_comment|/* END dasd_3990_erp_inspect */
multiline_comment|/*&n; * DASD_3990_ERP_ADD_ERP&n; * &n; * DESCRIPTION&n; *   This funtion adds an additional request block (ERP) to the head of&n; *   the given cqr (or erp).&n; *   This erp is initialized as an default erp (retry TIC)&n; *&n; * PARAMETER&n; *   cqr                head of the current ERP-chain (or single cqr if &n; *                      first error)&n; * RETURN VALUES&n; *   erp                pointer to new ERP-chain head&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_add_erp
id|dasd_3990_erp_add_erp
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
multiline_comment|/* allocate additional request block */
id|ccw_req_t
op_star
id|erp
op_assign
id|dasd_alloc_request
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|erp
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;unable to allocate ERP request&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* initialize request with default TIC to current ERP/CQR */
id|erp-&gt;cpaddr-&gt;cmd_code
op_assign
id|CCW_CMD_TIC
suffix:semicolon
id|erp-&gt;cpaddr-&gt;cda
op_assign
(paren
(paren
id|__u32
)paren
id|cqr-&gt;cpaddr
)paren
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_add_erp
suffix:semicolon
id|erp-&gt;refers
op_assign
id|cqr
suffix:semicolon
id|erp-&gt;device
op_assign
id|cqr-&gt;device
suffix:semicolon
id|erp-&gt;magic
op_assign
id|cqr-&gt;magic
suffix:semicolon
id|erp-&gt;lpm
op_assign
l_int|0xFF
suffix:semicolon
id|erp-&gt;expires
op_assign
l_int|0
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|255
suffix:semicolon
id|erp-&gt;status
op_assign
id|CQR_STATUS_FILLED
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/*&n; * DASD_3990_ERP_ADDITIONAL_ERP &n; * &n; * DESCRIPTION&n; *   An additional ERP is needed to handle the current error.&n; *   Add ERP to the head of the ERP-chain containing the ERP processing&n; *   determined based on the sense data.&n; *&n; * PARAMETER&n; *   cqr                head of the current ERP-chain (or single cqr if &n; *                      first error)&n; *&n; * RETURN VALUES&n; *   erp                pointer to new ERP-chain head&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_additional_erp
id|dasd_3990_erp_additional_erp
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
id|ccw_req_t
op_star
id|erp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* add erp and initialize with default TIC */
id|erp
op_assign
id|dasd_3990_erp_add_erp
(paren
id|cqr
)paren
suffix:semicolon
multiline_comment|/* inspect sense, determine specific ERP if possible */
r_if
c_cond
(paren
id|erp
op_ne
l_int|NULL
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_inspect
(paren
id|erp
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_additional_erp */
multiline_comment|/*&n; * DASD_3990_ERP_ERROR_MATCH&n; *&n; * DESCRIPTION&n; *   check if the the device status of the given cqr is the same.&n; *   This means that the failed CCW and the relevant sense data&n; *   must match.&n; *   I don&squot;t distinguish between 24 and 32 byte sense becaus in case of&n; *   24 byte sense byte 25 and 27 is set as well.&n; *&n; * PARAMETER&n; *   cqr1               first cqr, which will be compared with the &n; *   cqr2               second cqr.&n; *&n; * RETURN VALUES&n; *   match              &squot;boolean&squot; for match found&n; *                      returns 1 if match found, otherwise 0.&n; */
r_int
DECL|function|dasd_3990_erp_error_match
id|dasd_3990_erp_error_match
(paren
id|ccw_req_t
op_star
id|cqr1
comma
id|ccw_req_t
op_star
id|cqr2
)paren
(brace
multiline_comment|/* check failed CCW */
r_if
c_cond
(paren
id|cqr1-&gt;dstat-&gt;cpa
op_ne
id|cqr2-&gt;dstat-&gt;cpa
)paren
(brace
singleline_comment|//&t;return 0;&t;/* CCW doesn&squot;t match */
id|printk
c_func
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;_error_match: CCW doesn&squot;t match -&gt; ignore&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* check sense data; byte 0-2,25,27 */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|strncmp
(paren
id|cqr1-&gt;dstat-&gt;ii.sense.data
comma
id|cqr2-&gt;dstat-&gt;ii.sense.data
comma
l_int|3
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|cqr1-&gt;dstat-&gt;ii.sense.data
(braket
l_int|27
)braket
op_eq
id|cqr2-&gt;dstat-&gt;ii.sense.data
(braket
l_int|27
)braket
)paren
op_logical_and
(paren
id|cqr1-&gt;dstat-&gt;ii.sense.data
(braket
l_int|25
)braket
op_eq
id|cqr2-&gt;dstat-&gt;ii.sense.data
(braket
l_int|25
)braket
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* sense doesn&squot;t match */
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* match */
)brace
multiline_comment|/* end dasd_3990_erp_error_match */
multiline_comment|/*&n; * DASD_3990_ERP_IN_ERP&n; *&n; * DESCRIPTION&n; *   check if the current error already happened before.&n; *   quick exit if current cqr is not an ERP (cqr-&gt;refers=NULL)&n; *&n; * PARAMETER&n; *   cqr                failed cqr (either original cqr or already an erp)&n; *&n; * RETURN VALUES&n; *   erp                erp-pointer to the already defined error recovery procedure OR&n; *                      NULL if a &squot;new&squot; error occurred.&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_in_erp
id|dasd_3990_erp_in_erp
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
id|ccw_req_t
op_star
id|erp_head
op_assign
id|cqr
comma
multiline_comment|/* save erp chain head */
op_star
id|erp_match
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* save erp chain head */
r_int
id|match
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &squot;boolean&squot; for matching error found */
r_if
c_cond
(paren
id|cqr-&gt;refers
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* return if not in erp */
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* check the erp/cqr chain for current error */
r_do
(brace
id|match
op_assign
id|dasd_3990_erp_error_match
(paren
id|erp_head
comma
id|cqr-&gt;refers
)paren
suffix:semicolon
id|erp_match
op_assign
id|cqr
suffix:semicolon
multiline_comment|/* save possible matching erp  */
id|cqr
op_assign
id|cqr-&gt;refers
suffix:semicolon
multiline_comment|/* check next erp/cqr in queue */
)brace
r_while
c_loop
(paren
(paren
id|cqr-&gt;refers
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|match
op_eq
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|match
)paren
(brace
r_return
id|erp_match
suffix:semicolon
multiline_comment|/* return address of matching erp */
)brace
r_else
(brace
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* return NULL to indicate that no match&n;&t;&t;&t;&t;   was found */
)brace
)brace
multiline_comment|/* END dasd_3990_erp_in_erp */
multiline_comment|/*&n; * DASD_3990_ERP_FURTHER_ERP (24 &amp; 32 byte sense)&n; *&n; * DESCRIPTION&n; *   No retry is left for the current ERP. Check what has to be done &n; *   with the ERP.&n; *     - do further defined ERP action or&n; *     - wait for interrupt or  &n; *     - exit with permanent error&n; *&n; * PARAMETER&n; *   erp                ERP which is in progress wiht no retry left&n; *&n; * RETURN VALUES&n; *   erp                modified/additional ERP&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_further_erp
id|dasd_3990_erp_further_erp
(paren
id|ccw_req_t
op_star
id|erp
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
multiline_comment|/* check for 24 byte sense ERP */
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_bus_out
)paren
op_logical_or
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_1
)paren
op_logical_or
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_4
)paren
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_action_1
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_5
)paren
(brace
multiline_comment|/* retries have not been successful */
r_char
op_star
id|sense
op_assign
id|erp-&gt;dstat-&gt;ii.sense.data
suffix:semicolon
multiline_comment|/* prepare erp for retry on different channel path */
id|erp
op_assign
id|dasd_3990_erp_action_1
(paren
id|erp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
)paren
(brace
multiline_comment|/* issue a Diagnostic Control command with an &n;                         * Inhibit Write subcommand */
r_switch
c_cond
(paren
id|sense
(braket
l_int|25
)braket
)paren
(brace
r_case
l_int|0x17
suffix:colon
r_case
l_int|0x57
suffix:colon
(brace
multiline_comment|/* controller */
id|erp
op_assign
id|dasd_3990_erp_DCTL
(paren
id|erp
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x18
suffix:colon
r_case
l_int|0x58
suffix:colon
(brace
multiline_comment|/* channel path */
id|erp
op_assign
id|dasd_3990_erp_DCTL
(paren
id|erp
comma
l_int|0x40
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x19
suffix:colon
r_case
l_int|0x59
suffix:colon
(brace
multiline_comment|/* storage director */
id|erp
op_assign
id|dasd_3990_erp_DCTL
(paren
id|erp
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;invalid subcommand modifier 0x%x for &quot;
l_string|&quot;Diagnostic Control Command&quot;
comma
id|sense
(braket
l_int|25
)braket
)paren
suffix:semicolon
)brace
)brace
singleline_comment|//        /* check for 32 byte sense ERP */
singleline_comment|//&t;} else if ((erp-&gt;function == dasd_3990_erp_xxx){
macro_line|#else
multiline_comment|/* check for 24 byte sense ERP */
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_1
)paren
op_logical_or
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_4
)paren
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_action_1
(paren
id|erp
)paren
suffix:semicolon
macro_line|#endif /* ERP_FULL_ERP */  
)brace
r_else
(brace
multiline_comment|/* no retry left and no additional special handling necessary */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;no retries left for erp %p - &quot;
l_string|&quot;set status to FAILED&quot;
comma
id|erp
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_further_erp */
multiline_comment|/*&n; * DASD_3990_ERP_HANDLE_MATCH_ERP &n; *&n; * DESCRIPTION&n; *   An error occurred again and an ERP has been detected which is already&n; *   used to handle this error (e.g. retries). &n; *   All prior ERP&squot;s are set to status DONE and the retry counter is&n; *   decremented.&n; *   If retry counter is already 0, it has to checked if further action&n; *   is needed (besides retry) or if the ERP has failed.&n; *&n; * PARAMETER&n; *   erp_head           first ERP in ERP-chain&n; *   erp_match          ERP that handles the actual error.&n; *&n; * RETURN VALUES&n; *   none                &n; */
r_void
DECL|function|dasd_3990_erp_handle_match_erp
id|dasd_3990_erp_handle_match_erp
(paren
id|ccw_req_t
op_star
id|erp_head
comma
id|ccw_req_t
op_star
id|erp_match
)paren
(brace
id|dasd_device_t
op_star
id|device
op_assign
id|erp_head-&gt;device
suffix:semicolon
id|ccw_req_t
op_star
id|erp_done
op_assign
id|erp_head
suffix:semicolon
id|ccw_req_t
op_star
id|erp_free
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* req to be freed */
multiline_comment|/* loop over successful ERPs and remove them from chanq */
r_while
c_loop
(paren
(paren
id|erp_done
op_ne
id|erp_match
)paren
op_logical_and
(paren
id|erp_done
op_ne
l_int|NULL
)paren
)paren
(brace
macro_line|#ifdef ERP_DEBUG
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;successful ERP - dequeue and free request %p&quot;
comma
(paren
r_void
op_star
)paren
id|erp_done
)paren
suffix:semicolon
macro_line|#endif /* ERP_DEBUG */
id|check_then_set
(paren
op_amp
id|erp_done-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_DONE
)paren
suffix:semicolon
multiline_comment|/* remove the request from the device queue */
id|dasd_chanq_deq
(paren
op_amp
id|device-&gt;queue
comma
id|erp_done
)paren
suffix:semicolon
id|erp_free
op_assign
id|erp_done
suffix:semicolon
id|erp_done
op_assign
id|erp_done-&gt;refers
suffix:semicolon
multiline_comment|/* free the finished erp request */
id|dasd_free_request
(paren
id|erp_free
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|erp_done
op_eq
l_int|NULL
)paren
multiline_comment|/* erp_done should never be NULL! */
id|panic
(paren
id|PRINTK_HEADER
l_string|&quot;Programming error in ERP! The original &quot;
l_string|&quot;request was lost&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef ERP_DEBUG
multiline_comment|/* handle matching ERP */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;handle matching erp %p&quot;
comma
(paren
r_void
op_star
)paren
id|erp_done
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|erp_done-&gt;retries
OG
l_int|0
)paren
(brace
multiline_comment|/* check for special retries */
r_if
c_cond
(paren
id|erp_done-&gt;function
op_eq
id|dasd_3990_erp_action_4
)paren
(brace
r_char
op_star
id|sense
op_assign
id|erp_done-&gt;dstat-&gt;ii.sense.data
suffix:semicolon
id|erp_done
op_assign
id|dasd_3990_erp_action_4
(paren
id|erp_done
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|erp_done-&gt;function
op_eq
id|dasd_3990_erp_action_1B_32
)paren
(brace
r_char
op_star
id|sense
op_assign
id|erp_done-&gt;dstat-&gt;ii.sense.data
suffix:semicolon
id|erp_done
op_assign
id|dasd_3990_update_1B
(paren
id|erp_done
comma
id|sense
)paren
suffix:semicolon
macro_line|#ifdef ERP_FULL_ERP
)brace
r_else
r_if
c_cond
(paren
id|erp_done-&gt;function
op_eq
id|dasd_3990_erp_int_req
)paren
(brace
id|erp_done
op_assign
id|dasd_3990_erp_int_req
(paren
id|erp_done
)paren
suffix:semicolon
macro_line|#endif /* ERP_FULL_ERP */  
)brace
r_else
(brace
multiline_comment|/* simple retry   */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%i retries left for erp %p&quot;
comma
id|erp_done-&gt;retries
comma
(paren
r_void
op_star
)paren
id|erp_done
)paren
suffix:semicolon
multiline_comment|/* handle the request again... */
id|check_then_set
(paren
op_amp
id|erp_done-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_QUEUED
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* no retry left - check for further necessary action    */
multiline_comment|/* if no further actions, handle rest as permanent error */
id|erp_done
op_assign
id|dasd_3990_erp_further_erp
(paren
id|erp_done
)paren
suffix:semicolon
)brace
id|erp_head
op_assign
id|erp_done
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_handle_match_erp */
multiline_comment|/*&n; * DASD_3990_ERP_ACTION&n; *&n; * DESCRIPTION&n; *   controll routine for 3990 erp actions.&n; *   Has to be called with the queue lock (namely the s390_irq_lock) acquired.&n; *&n; * PARAMETER&n; *   cqr                failed cqr (either original cqr or already an erp)&n; *&n; * RETURN VALUES&n; *   erp                erp-pointer to the head of the ERP action chain.&n; *                      This means:&n; *                       - either a ptr to an additional ERP cqr or&n; *                       - the original given cqr (which&squot;s status might be modified)&n; */
id|ccw_req_t
op_star
DECL|function|dasd_3990_erp_action
id|dasd_3990_erp_action
(paren
id|ccw_req_t
op_star
id|cqr
)paren
(brace
id|ccw_req_t
op_star
id|erp
op_assign
l_int|NULL
suffix:semicolon
id|dasd_device_t
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
macro_line|#ifdef ERP_DEBUG 
id|__u32
id|cpa
op_assign
id|cqr-&gt;dstat-&gt;cpa
suffix:semicolon
macro_line|#endif /* ERP_DEBUG */
macro_line|#ifdef ERP_DEBUG 
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;entering 3990 ERP for &quot;
l_string|&quot;0x%04X on sch %d = /dev/%s &bslash;n&quot;
comma
id|device-&gt;devinfo.devno
comma
id|device-&gt;devinfo.irq
comma
id|device-&gt;name
)paren
suffix:semicolon
multiline_comment|/* print current erp_chain */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ERP chain at BEGINNING of ERP-ACTION&quot;
)paren
suffix:semicolon
(brace
id|ccw_req_t
op_star
id|temp_erp
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|temp_erp
op_assign
id|cqr
suffix:semicolon
id|temp_erp
op_ne
l_int|NULL
suffix:semicolon
id|temp_erp
op_assign
id|temp_erp-&gt;refers
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;      erp %p refers to %p &bslash;n&quot;
comma
id|temp_erp
comma
id|temp_erp-&gt;refers
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* double-check if current erp/cqr was successfull */
r_if
c_cond
(paren
(paren
id|cqr-&gt;dstat-&gt;cstat
op_eq
l_int|0x00
)paren
op_logical_and
(paren
id|cqr-&gt;dstat-&gt;dstat
op_eq
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;ERP called for successful request %p&quot;
l_string|&quot; - NO ERP necessary&quot;
comma
id|cqr
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_DONE
)paren
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* check if sense data are available */
r_if
c_cond
(paren
op_logical_neg
id|cqr-&gt;dstat-&gt;ii.sense.data
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;ERP called witout sense data avail ...&quot;
l_string|&quot;request %p - NO ERP possible&quot;
comma
id|cqr
)paren
suffix:semicolon
id|check_then_set
(paren
op_amp
id|erp-&gt;status
comma
id|CQR_STATUS_ERROR
comma
id|CQR_STATUS_FAILED
)paren
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* check if error happened before */
id|erp
op_assign
id|dasd_3990_erp_in_erp
(paren
id|cqr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no matching erp found - set up erp */
id|erp
op_assign
id|dasd_3990_erp_additional_erp
(paren
id|cqr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* matching erp found - set all leading erp&squot;s to DONE */
id|dasd_3990_erp_handle_match_erp
(paren
id|cqr
comma
id|erp
)paren
suffix:semicolon
id|erp
op_assign
id|cqr
suffix:semicolon
)brace
macro_line|#ifdef ERP_DEBUG
multiline_comment|/* print current erp_chain */
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ERP chain at END of ERP-ACTION&quot;
)paren
suffix:semicolon
(brace
id|ccw_req_t
op_star
id|temp_erp
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|temp_erp
op_assign
id|erp
suffix:semicolon
id|temp_erp
op_ne
l_int|NULL
suffix:semicolon
id|temp_erp
op_assign
id|temp_erp-&gt;refers
)paren
(brace
id|DASD_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;      erp %p refers to %p &bslash;n&quot;
comma
id|temp_erp
comma
id|temp_erp-&gt;refers
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* ERP_DEBUG */
macro_line|#ifdef ERP_DEBUG
r_if
c_cond
(paren
id|erp-&gt;status
op_eq
id|CQR_STATUS_FAILED
)paren
(brace
id|log_erp_chain
(paren
id|erp
comma
l_int|1
comma
id|cpa
)paren
suffix:semicolon
)brace
macro_line|#endif /* ERP_DEBUG */
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action */
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 4 &n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -4&n; * c-argdecl-indent: 4&n; * c-label-offset: -4&n; * c-continued-statement-offset: 4&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
