multiline_comment|/* &n; * File...........: linux/drivers/s390/block/dasd_3990_erp.c&n; * Author(s)......: Horst  Hummel    &lt;Horst.Hummel@de.ibm.com&gt; &n; *&t;&t;    Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 2000, 2001&n; *&n; * $Revision: 1.30 $&n; */
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/todclk.h&gt;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;dasd_erp(3990): &quot;
macro_line|#include &quot;dasd_int.h&quot;
macro_line|#include &quot;dasd_eckd.h&quot;
DECL|struct|DCTL_data
r_struct
id|DCTL_data
(brace
DECL|member|subcommand
r_int
r_char
id|subcommand
suffix:semicolon
multiline_comment|/* e.g Inhibit Write, Enable Write,... */
DECL|member|modifier
r_int
r_char
id|modifier
suffix:semicolon
multiline_comment|/* Subcommand modifier&t;&t;       */
DECL|member|res
r_int
r_int
id|res
suffix:semicolon
multiline_comment|/* reserved */
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; ***************************************************************************** &n; * SECTION ERP EXAMINATION&n; ***************************************************************************** &n; */
multiline_comment|/*&n; * DASD_3990_ERP_EXAMINE_24 &n; *&n; * DESCRIPTION&n; *   Checks only for fatal (unrecoverable) error. &n; *   A detailed examination of the sense data is done later outside&n; *   the interrupt handler.&n; *&n; *   Each bit configuration leading to an action code 2 (Exit with&n; *   programming error or unusual condition indication)&n; *   are handled as fatal error&#xfffd;s.&n; * &n; *   All other configurations are handled as recoverable errors.&n; *&n; * RETURN VALUES&n; *   dasd_era_fatal&t;for all fatal (unrecoverable errors)&n; *   dasd_era_recover&t;for all others.&n; */
r_static
id|dasd_era_t
DECL|function|dasd_3990_erp_examine_24
id|dasd_3990_erp_examine_24
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
multiline_comment|/* check for &squot;Command Reject&squot; */
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_CMD_REJECT
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;EXAMINE 24: Command Reject detected - &quot;
l_string|&quot;fatal error&quot;
)paren
suffix:semicolon
r_return
id|dasd_era_fatal
suffix:semicolon
)brace
multiline_comment|/* check for &squot;Invalid Track Format&squot; */
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_INV_TRACK_FORMAT
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;EXAMINE 24: Invalid Track Format detected &quot;
l_string|&quot;- fatal error&quot;
)paren
suffix:semicolon
r_return
id|dasd_era_fatal
suffix:semicolon
)brace
multiline_comment|/* check for &squot;No Record Found&squot; */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_NO_REC_FOUND
)paren
(brace
multiline_comment|/* FIXME: fatal error ?!? */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;EXAMINE 24: No Record Found detected %s&quot;
comma
id|device-&gt;state
op_le
id|DASD_STATE_BASIC
ques
c_cond
l_string|&quot; &quot;
suffix:colon
l_string|&quot;- fatal error&quot;
)paren
suffix:semicolon
r_return
id|dasd_era_fatal
suffix:semicolon
)brace
multiline_comment|/* return recoverable for all others */
r_return
id|dasd_era_recover
suffix:semicolon
)brace
multiline_comment|/* END dasd_3990_erp_examine_24 */
multiline_comment|/*&n; * DASD_3990_ERP_EXAMINE_32 &n; *&n; * DESCRIPTION&n; *   Checks only for fatal/no/recoverable error. &n; *   A detailed examination of the sense data is done later outside&n; *   the interrupt handler.&n; *&n; * RETURN VALUES&n; *   dasd_era_none&t;no error &n; *   dasd_era_fatal&t;for all fatal (unrecoverable errors)&n; *   dasd_era_recover&t;for recoverable others.&n; */
r_static
id|dasd_era_t
DECL|function|dasd_3990_erp_examine_32
id|dasd_3990_erp_examine_32
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
r_switch
c_cond
(paren
id|sense
(braket
l_int|25
)braket
)paren
(brace
r_case
l_int|0x00
suffix:colon
r_return
id|dasd_era_none
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;EXAMINE 32: fatal error&quot;
)paren
suffix:semicolon
r_return
id|dasd_era_fatal
suffix:semicolon
r_default
suffix:colon
r_return
id|dasd_era_recover
suffix:semicolon
)brace
)brace
multiline_comment|/* end dasd_3990_erp_examine_32 */
multiline_comment|/*&n; * DASD_3990_ERP_EXAMINE &n; *&n; * DESCRIPTION&n; *   Checks only for fatal/no/recover error. &n; *   A detailed examination of the sense data is done later outside&n; *   the interrupt handler.&n; *&n; *   The logic is based on the &squot;IBM 3990 Storage Control  Reference&squot; manual&n; *   &squot;Chapter 7. Error Recovery Procedures&squot;.&n; *&n; * RETURN VALUES&n; *   dasd_era_none&t;no error &n; *   dasd_era_fatal&t;for all fatal (unrecoverable errors)&n; *   dasd_era_recover&t;for all others.&n; */
id|dasd_era_t
DECL|function|dasd_3990_erp_examine
id|dasd_3990_erp_examine
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_char
op_star
id|sense
op_assign
id|irb-&gt;ecw
suffix:semicolon
id|dasd_era_t
id|era
op_assign
id|dasd_era_recover
suffix:semicolon
r_struct
id|dasd_device
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
multiline_comment|/* check for successful execution first */
r_if
c_cond
(paren
id|irb-&gt;scsw.cstat
op_eq
l_int|0x00
op_logical_and
id|irb-&gt;scsw.dstat
op_eq
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
r_return
id|dasd_era_none
suffix:semicolon
multiline_comment|/* distinguish between 24 and 32 byte sense data */
r_if
c_cond
(paren
id|sense
(braket
l_int|27
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
(brace
id|era
op_assign
id|dasd_3990_erp_examine_24
c_func
(paren
id|cqr
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
id|era
op_assign
id|dasd_3990_erp_examine_32
c_func
(paren
id|cqr
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* log the erp chain if fatal error occurred */
r_if
c_cond
(paren
(paren
id|era
op_eq
id|dasd_era_fatal
)paren
op_logical_and
(paren
id|device-&gt;state
op_ge
id|DASD_STATE_READY
)paren
)paren
(brace
id|dasd_log_sense
c_func
(paren
id|cqr
comma
id|irb
)paren
suffix:semicolon
id|dasd_log_ccw
c_func
(paren
id|cqr
comma
l_int|0
comma
id|irb-&gt;scsw.cpa
)paren
suffix:semicolon
)brace
r_return
id|era
suffix:semicolon
)brace
multiline_comment|/* END dasd_3990_erp_examine */
multiline_comment|/*&n; ***************************************************************************** &n; * SECTION ERP HANDLING&n; ***************************************************************************** &n; */
multiline_comment|/*&n; ***************************************************************************** &n; * 24 and 32 byte sense ERP functions&n; ***************************************************************************** &n; */
multiline_comment|/*&n; * DASD_3990_ERP_CLEANUP &n; *&n; * DESCRIPTION&n; *   Removes the already build but not necessary ERP request and sets&n; *   the status of the original cqr / erp to the given (final) status&n; *&n; *  PARAMETER&n; *   erp&t;&t;request to be blocked&n; *   final_status&t;either DASD_CQR_DONE or DASD_CQR_FAILED &n; *&n; * RETURN VALUES&n; *   cqr&t;&t;original cqr&t;&t;   &n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_cleanup
id|dasd_3990_erp_cleanup
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
id|final_status
)paren
(brace
r_struct
id|dasd_ccw_req
op_star
id|cqr
op_assign
id|erp-&gt;refers
suffix:semicolon
id|dasd_free_erp_request
c_func
(paren
id|erp
comma
id|erp-&gt;device
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|final_status
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_cleanup */
multiline_comment|/*&n; * DASD_3990_ERP_BLOCK_QUEUE &n; *&n; * DESCRIPTION&n; *   Block the given device request queue to prevent from further&n; *   processing until the started timer has expired or an related&n; *   interrupt was received.&n; */
r_static
r_void
DECL|function|dasd_3990_erp_block_queue
id|dasd_3990_erp_block_queue
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_int
id|expires
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;blocking request queue for %is&quot;
comma
id|expires
op_div
id|HZ
)paren
suffix:semicolon
id|device-&gt;stopped
op_or_assign
id|DASD_STOPPED_PENDING
suffix:semicolon
id|erp-&gt;status
op_assign
id|DASD_CQR_QUEUED
suffix:semicolon
id|dasd_set_timer
c_func
(paren
id|device
comma
id|expires
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * DASD_3990_ERP_INT_REQ &n; *&n; * DESCRIPTION&n; *   Handles &squot;Intervention Required&squot; error.&n; *   This means either device offline or not installed.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp&n; * RETURN VALUES&n; *   erp&t;&t;modified erp&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_int_req
id|dasd_3990_erp_int_req
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
multiline_comment|/* first time set initial retry counter and erp_function */
multiline_comment|/* and retry once without blocking queue&t;&t; */
multiline_comment|/* (this enables easier enqueing of the cqr)&t;&t; */
r_if
c_cond
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_int_req
)paren
(brace
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_int_req
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* issue a message and wait for &squot;device ready&squot; interrupt */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;is offline or not installed - &quot;
l_string|&quot;INTERVENTION REQUIRED!!&quot;
)paren
suffix:semicolon
id|dasd_3990_erp_block_queue
c_func
(paren
id|erp
comma
l_int|60
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_int_req */
multiline_comment|/*&n; * DASD_3990_ERP_ALTERNATE_PATH &n; *&n; * DESCRIPTION&n; *   Repeat the operation on a different channel path.&n; *   If all alternate paths have been tried, the request is posted with a&n; *   permanent error.&n; *&n; *  PARAMETER&n; *   erp&t;&t;pointer to the current ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;modified pointer to the ERP&n; */
r_static
r_void
DECL|function|dasd_3990_erp_alternate_path
id|dasd_3990_erp_alternate_path
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|__u8
id|opm
suffix:semicolon
multiline_comment|/* try alternate valid path */
id|opm
op_assign
id|ccw_device_get_path_mask
c_func
(paren
id|device-&gt;cdev
)paren
suffix:semicolon
singleline_comment|//FIXME: start with get_opm ?
r_if
c_cond
(paren
id|erp-&gt;lpm
op_eq
l_int|0
)paren
id|erp-&gt;lpm
op_assign
id|LPM_ANYPATH
op_amp
op_complement
(paren
id|erp-&gt;dstat-&gt;esw.esw0.sublog.lpum
)paren
suffix:semicolon
r_else
id|erp-&gt;lpm
op_and_assign
op_complement
(paren
id|erp-&gt;dstat-&gt;esw.esw0.sublog.lpum
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|erp-&gt;lpm
op_amp
id|opm
)paren
op_ne
l_int|0x00
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;try alternate lpm=%x (lpum=%x / opm=%x)&quot;
comma
id|erp-&gt;lpm
comma
id|erp-&gt;dstat-&gt;esw.esw0.sublog.lpum
comma
id|opm
)paren
suffix:semicolon
multiline_comment|/* reset status to queued to handle the request again... */
r_if
c_cond
(paren
id|erp-&gt;status
OG
id|DASD_CQR_QUEUED
)paren
id|erp-&gt;status
op_assign
id|DASD_CQR_QUEUED
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;No alternate channel path left (lpum=%x / &quot;
l_string|&quot;opm=%x) -&gt; permanent error&quot;
comma
id|erp-&gt;dstat-&gt;esw.esw0.sublog.lpum
comma
id|opm
)paren
suffix:semicolon
multiline_comment|/* post request with permanent error */
r_if
c_cond
(paren
id|erp-&gt;status
OG
id|DASD_CQR_QUEUED
)paren
id|erp-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
)brace
)brace
multiline_comment|/* end dasd_3990_erp_alternate_path */
multiline_comment|/*&n; * DASD_3990_ERP_DCTL&n; *&n; * DESCRIPTION&n; *   Setup cqr to do the Diagnostic Control (DCTL) command with an &n; *   Inhibit Write subcommand (0x20) and the given modifier.&n; *&n; *  PARAMETER&n; *   erp&t;&t;pointer to the current (failed) ERP&n; *   modifier&t;&t;subcommand modifier&n; *   &n; * RETURN VALUES&n; *   dctl_cqr&t;&t;pointer to NEW dctl_cqr &n; *&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_DCTL
id|dasd_3990_erp_DCTL
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
id|modifier
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
r_struct
id|DCTL_data
op_star
id|DCTL_data
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|dctl_cqr
suffix:semicolon
id|dctl_cqr
op_assign
id|dasd_alloc_erp_request
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|erp-&gt;magic
comma
l_int|1
comma
r_sizeof
(paren
r_struct
id|DCTL_data
)paren
comma
id|erp-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dctl_cqr
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to allocate DCTL-CQR&quot;
)paren
suffix:semicolon
id|erp-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
id|DCTL_data
op_assign
id|dctl_cqr-&gt;data
suffix:semicolon
id|DCTL_data-&gt;subcommand
op_assign
l_int|0x02
suffix:semicolon
multiline_comment|/* Inhibit Write */
id|DCTL_data-&gt;modifier
op_assign
id|modifier
suffix:semicolon
id|ccw
op_assign
id|dctl_cqr-&gt;cpaddr
suffix:semicolon
id|memset
c_func
(paren
id|ccw
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|CCW_CMD_DCTL
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|4
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|DCTL_data
suffix:semicolon
id|dctl_cqr-&gt;function
op_assign
id|dasd_3990_erp_DCTL
suffix:semicolon
id|dctl_cqr-&gt;refers
op_assign
id|erp
suffix:semicolon
id|dctl_cqr-&gt;device
op_assign
id|erp-&gt;device
suffix:semicolon
id|dctl_cqr-&gt;magic
op_assign
id|erp-&gt;magic
suffix:semicolon
id|dctl_cqr-&gt;expires
op_assign
l_int|5
op_star
l_int|60
op_star
id|HZ
suffix:semicolon
id|dctl_cqr-&gt;retries
op_assign
l_int|2
suffix:semicolon
id|dctl_cqr-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|dctl_cqr-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
r_return
id|dctl_cqr
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_DCTL */
multiline_comment|/*&n; * DASD_3990_ERP_ACTION_1 &n; *&n; * DESCRIPTION&n; *   Setup ERP to do the ERP action 1 (see Reference manual).&n; *   Repeat the operation on a different channel path.&n; *   If all alternate paths have been tried, the request is posted with a&n; *   permanent error.&n; *   Note: duplex handling is not implemented (yet).&n; *&n; *  PARAMETER&n; *   erp&t;&t;pointer to the current ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;pointer to the ERP&n; *&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_action_1
id|dasd_3990_erp_action_1
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_1
suffix:semicolon
id|dasd_3990_erp_alternate_path
c_func
(paren
id|erp
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_1 */
multiline_comment|/*&n; * DASD_3990_ERP_ACTION_4 &n; *&n; * DESCRIPTION&n; *   Setup ERP to do the ERP action 4 (see Reference manual).&n; *   Set the current request to PENDING to block the CQR queue for that device&n; *   until the state change interrupt appears.&n; *   Use a timer (20 seconds) to retry the cqr if the interrupt is still missing.&n; *&n; *  PARAMETER&n; *   sense&t;&t;sense data of the actual error&n; *   erp&t;&t;pointer to the current ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;pointer to the ERP&n; *&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_action_4
id|dasd_3990_erp_action_4
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
multiline_comment|/* first time set initial retry counter and erp_function    */
multiline_comment|/* and retry once without waiting for state change pending  */
multiline_comment|/* interrupt (this enables easier enqueing of the cqr)&t;    */
r_if
c_cond
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_action_4
)paren
(brace
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_4
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_eq
l_int|0x1D
)paren
(brace
multiline_comment|/* state change pending */
id|DEV_MESSAGE
c_func
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;waiting for state change pending &quot;
l_string|&quot;interrupt, %d retries left&quot;
comma
id|erp-&gt;retries
)paren
suffix:semicolon
id|dasd_3990_erp_block_queue
c_func
(paren
id|erp
comma
l_int|30
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no state change pending - retry */
id|DEV_MESSAGE
(paren
id|KERN_INFO
comma
id|device
comma
l_string|&quot;redriving request immediately, &quot;
l_string|&quot;%d retries left&quot;
comma
id|erp-&gt;retries
)paren
suffix:semicolon
id|erp-&gt;status
op_assign
id|DASD_CQR_QUEUED
suffix:semicolon
)brace
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_4 */
multiline_comment|/*&n; ***************************************************************************** &n; * 24 byte sense ERP functions (only)&n; ***************************************************************************** &n; */
multiline_comment|/*&n; * DASD_3990_ERP_ACTION_5 &n; *&n; * DESCRIPTION&n; *   Setup ERP to do the ERP action 5 (see Reference manual).&n; *   NOTE: Further handling is done in xxx_further_erp after the retries.&n; *&n; *  PARAMETER&n; *   erp&t;&t;pointer to the current ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;pointer to the ERP&n; *&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_action_5
id|dasd_3990_erp_action_5
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
multiline_comment|/* first of all retry */
id|erp-&gt;retries
op_assign
l_int|10
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_5
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_5 */
multiline_comment|/*&n; * DASD_3990_HANDLE_ENV_DATA&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Environmental data present&squot;.&n; *   Does a analysis of the sense data (message Format)&n; *   and prints the error messages.&n; *&n; * PARAMETER&n; *   sense&t;&t;current sense data&n; *   &n; * RETURN VALUES&n; *   void&n; */
r_static
r_void
DECL|function|dasd_3990_handle_env_data
id|dasd_3990_handle_env_data
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
r_char
id|msg_format
op_assign
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0xF0
)paren
suffix:semicolon
r_char
id|msg_no
op_assign
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x0F
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|msg_format
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* Format 0 - Program or System Checks */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
l_int|0x10
)paren
(brace
multiline_comment|/* check message to operator bit */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No Message */
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Invalid Command&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Invalid Command &quot;
l_string|&quot;Sequence&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - CCW Count less than &quot;
l_string|&quot;required&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Invalid Parameter&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Diagnostic of Sepecial&quot;
l_string|&quot; Command Violates File Mask&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Channel Returned with &quot;
l_string|&quot;Incorrect retry CCW&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Reset Notification&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Storage Path Restart&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;FORMAT 0 - Channel requested &quot;
l_string|&quot;... %02x&quot;
comma
id|sense
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Invalid Defective/&quot;
l_string|&quot;Alternate Track Pointer&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - DPS Installation &quot;
l_string|&quot;Check&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Command Invalid on &quot;
l_string|&quot;Secondary Address&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;FORMAT 0 - Status Not As &quot;
l_string|&quot;Required: reason %02x&quot;
comma
id|sense
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Reseved&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No Message */
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Device Error Source&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Reserved&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;FORMAT 0 - Device Fenced - &quot;
l_string|&quot;device = %02x&quot;
comma
id|sense
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Data Pinned for &quot;
l_string|&quot;Device&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 0 - Reserved&quot;
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
multiline_comment|/* Format 1 - Device Equipment Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No Message */
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Device Status 1 not as &quot;
l_string|&quot;expected&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Index missing&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Interruption cannot be reset&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Device did not respond to &quot;
l_string|&quot;selection&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Device check-2 error or Set &quot;
l_string|&quot;Sector is not complete&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Head address does not &quot;
l_string|&quot;compare&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Device status 1 not valid&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Device not ready&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Track physical address did &quot;
l_string|&quot;not compare&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Missing device address bit&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Drive motor switch is off&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0D
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Seek incomplete&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Cylinder address did not &quot;
l_string|&quot;compare&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Offset active cannot be &quot;
l_string|&quot;reset&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 1 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
multiline_comment|/* Format 2 - 3990 Equipment Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x08
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 2 - 3990 check-2 error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 2 - Support facility errors&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;FORMAT 2 - Microcode detected error %02x&quot;
comma
id|sense
(braket
l_int|8
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 2 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x30
suffix:colon
multiline_comment|/* Format 3 - 3990 Control Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x0F
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 3 - Allegiance terminated&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 3 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
multiline_comment|/* Format 4 - Data Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Home address area error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Count area error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Key area error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Data area error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - No sync byte in home address &quot;
l_string|&quot;area&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - No sync byte in count address &quot;
l_string|&quot;area&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - No sync byte in key area&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - No sync byte in data area&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Home address area error; &quot;
l_string|&quot;offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Count area error; offset &quot;
l_string|&quot;active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Key area error; offset &quot;
l_string|&quot;active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Data area error; &quot;
l_string|&quot;offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - No sync byte in home &quot;
l_string|&quot;address area; offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0D
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - No syn byte in count &quot;
l_string|&quot;address area; offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - No sync byte in key area; &quot;
l_string|&quot;offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - No syn byte in data area; &quot;
l_string|&quot;offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 4 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x50
suffix:colon
multiline_comment|/* Format 5 - Data Check with displacement information */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Data Check in the &quot;
l_string|&quot;home address area&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Data Check in the count area&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Data Check in the key area&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Data Check in the data area&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Data Check in the &quot;
l_string|&quot;home address area; offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Data Check in the count area; &quot;
l_string|&quot;offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Data Check in the key area; &quot;
l_string|&quot;offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Data Check in the data area; &quot;
l_string|&quot;offset active&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 5 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x60
suffix:colon
multiline_comment|/* Format 6 - Usage Statistics/Overrun Errors */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Overrun on channel A&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Overrun on channel B&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Overrun on channel C&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Overrun on channel D&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Overrun on channel E&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Overrun on channel F&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Overrun on channel G&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Overrun on channel H&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 6 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x70
suffix:colon
multiline_comment|/* Format 7 - Device Connection Control Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - RCC initiated by a connection &quot;
l_string|&quot;check alert&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - RCC 1 sequence not &quot;
l_string|&quot;successful&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - RCC 1 and RCC 2 sequences not &quot;
l_string|&quot;successful&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - Invalid tag-in during &quot;
l_string|&quot;selection sequence&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - extra RCC required&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - Invalid DCC selection &quot;
l_string|&quot;response or timeout&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - Missing end operation; device &quot;
l_string|&quot;transfer complete&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - Missing end operation; device &quot;
l_string|&quot;transfer incomplete&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - Invalid tag-in for an &quot;
l_string|&quot;immediate command sequence&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - Invalid tag-in for an &quot;
l_string|&quot;extended command sequence&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - 3990 microcode time out when &quot;
l_string|&quot;stopping selection&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - No response to selection &quot;
l_string|&quot;after a poll interruption&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - Permanent path error (DASD &quot;
l_string|&quot;controller not available)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0D
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - DASD controller not available&quot;
l_string|&quot; on disconnected command chain&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 7 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x80
suffix:colon
multiline_comment|/* Format 8 - Additional Device Equipment Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No Message */
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - Error correction code &quot;
l_string|&quot;hardware fault&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - Unexpected end operation &quot;
l_string|&quot;response code&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - End operation with transfer &quot;
l_string|&quot;count not zero&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - End operation with transfer &quot;
l_string|&quot;count zero&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - DPS checks after a system &quot;
l_string|&quot;reset or selective reset&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - DPS cannot be filled&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - Short busy time-out during &quot;
l_string|&quot;device selection&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - DASD controller failed to &quot;
l_string|&quot;set or reset the long busy latch&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - No interruption from device &quot;
l_string|&quot;during a command chain&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 8 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x90
suffix:colon
multiline_comment|/* Format 9 - Device Read, Write, and Seek Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* No Message */
r_case
l_int|0x06
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 9 - Device check-2 error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 9 - Head address did not compare&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 9 - Track physical address did &quot;
l_string|&quot;not compare while oriented&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 9 - Cylinder address did not &quot;
l_string|&quot;compare&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT 9 - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0xF0
suffix:colon
multiline_comment|/* Format F - Cache Storage Checks */
r_switch
c_cond
(paren
id|msg_no
)paren
(brace
r_case
l_int|0x00
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Operation Terminated&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Subsystem Processing Error&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Cache or nonvolatile storage &quot;
l_string|&quot;equipment failure&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Caching terminated&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Cache fast write access not &quot;
l_string|&quot;authorized&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x07
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Track format incorrect&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Caching reinitiated&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0A
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Nonvolatile storage &quot;
l_string|&quot;terminated&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0B
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Volume is suspended duplex&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0C
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Subsystem status connot be &quot;
l_string|&quot;determined&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0D
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - Caching status reset to &quot;
l_string|&quot;default&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0E
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT F - DASD Fast Write inhibited&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;FORMAT D - Reserved&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unknown message format - should not happen */
id|DEV_MESSAGE
(paren
id|KERN_WARNING
comma
id|device
comma
l_string|&quot;unknown message format %02x&quot;
comma
id|msg_format
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch message format */
)brace
multiline_comment|/* end dasd_3990_handle_env_data */
multiline_comment|/*&n; * DASD_3990_ERP_COM_REJ&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Command Reject&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; *   sense&t;&t;current sense data&n; * &n; * RETURN VALUES&n; *   erp&t;&t;&squot;new&squot; erp_head - pointer to new ERP &n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_com_rej
id|dasd_3990_erp_com_rej
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_com_rej
suffix:semicolon
multiline_comment|/* env data present (ACTION 10 - retry should work) */
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Command Reject - environmental data present&quot;
)paren
suffix:semicolon
id|dasd_3990_handle_env_data
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fatal error -  set status to FAILED */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Command Reject - Fatal error&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_cleanup
c_func
(paren
id|erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_com_rej */
multiline_comment|/*&n; * DASD_3990_ERP_BUS_OUT &n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Bus Out Parity Check&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; * RETURN VALUES&n; *   erp&t;&t;new erp_head - pointer to new ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_bus_out
id|dasd_3990_erp_bus_out
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
multiline_comment|/* first time set initial retry counter and erp_function */
multiline_comment|/* and retry once without blocking queue&t;&t; */
multiline_comment|/* (this enables easier enqueing of the cqr)&t;&t; */
r_if
c_cond
(paren
id|erp-&gt;function
op_ne
id|dasd_3990_erp_bus_out
)paren
(brace
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_bus_out
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* issue a message and wait for &squot;device ready&squot; interrupt */
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;bus out parity error or BOPC requested by &quot;
l_string|&quot;channel&quot;
)paren
suffix:semicolon
id|dasd_3990_erp_block_queue
c_func
(paren
id|erp
comma
l_int|60
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_bus_out */
multiline_comment|/*&n; * DASD_3990_ERP_EQUIP_CHECK&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Equipment Check&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; * RETURN VALUES&n; *   erp&t;&t;new erp_head - pointer to new ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_equip_check
id|dasd_3990_erp_equip_check
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_equip_check
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_WRITE_INHIBITED
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Write inhibited path encountered&quot;
)paren
suffix:semicolon
multiline_comment|/* vary path offline */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Path should be varied off-line. &quot;
l_string|&quot;This is not implemented yet &bslash;n - please report &quot;
l_string|&quot;to linux390@de.ibm.com&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_1
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Equipment Check - &quot;
l_string|&quot;environmental data present&quot;
)paren
suffix:semicolon
id|dasd_3990_handle_env_data
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_4
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_PERM_ERR
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Equipment Check - retry exhausted or &quot;
l_string|&quot;undesirable&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_1
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* all other equipment checks - Action 5 */
multiline_comment|/* rest is done when retries == 0 */
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Equipment check or processing error&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_5
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_equip_check */
multiline_comment|/*&n; * DASD_3990_ERP_DATA_CHECK&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Data Check&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; * RETURN VALUES&n; *   erp&t;&t;new erp_head - pointer to new ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_data_check
id|dasd_3990_erp_data_check
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_data_check
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_CORRECTABLE
)paren
(brace
multiline_comment|/* correctable data check */
multiline_comment|/* issue message that the data has been corrected */
id|DEV_MESSAGE
c_func
(paren
id|KERN_EMERG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Data recovered during retry with PCI &quot;
l_string|&quot;fetch mode active&quot;
)paren
suffix:semicolon
multiline_comment|/* not possible to handle this situation in Linux */
id|panic
c_func
(paren
l_string|&quot;No way to inform appliction about the possibly &quot;
l_string|&quot;incorret data&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Uncorrectable data check recovered secondary &quot;
l_string|&quot;addr of duplex pair&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_4
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_PERM_ERR
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Uncorrectable data check with internal &quot;
l_string|&quot;retry exhausted&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_1
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* all other data checks */
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Uncorrectable data check with retry count &quot;
l_string|&quot;exhausted...&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_5
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_data_check */
multiline_comment|/*&n; * DASD_3990_ERP_OVERRUN&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Overrun&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; * RETURN VALUES&n; *   erp&t;&t;new erp_head - pointer to new ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_overrun
id|dasd_3990_erp_overrun
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_overrun
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Overrun - service overrun or overrun&quot;
l_string|&quot; error requested by channel&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_5
c_func
(paren
id|erp
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_overrun */
multiline_comment|/*&n; * DASD_3990_ERP_INV_FORMAT&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Invalid Track Format&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; * RETURN VALUES&n; *   erp&t;&t;new erp_head - pointer to new ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_inv_format
id|dasd_3990_erp_inv_format
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_inv_format
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Track format error when destaging or &quot;
l_string|&quot;staging data&quot;
)paren
suffix:semicolon
id|dasd_3990_handle_env_data
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_4
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Invalid Track Format - Fatal error should have &quot;
l_string|&quot;been handled within the interrupt handler&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_cleanup
c_func
(paren
id|erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_inv_format */
multiline_comment|/*&n; * DASD_3990_ERP_EOC&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;End-of-Cylinder&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;already added default erp&n; * RETURN VALUES&n; *   erp&t;&t;pointer to original (failed) cqr.&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_EOC
id|dasd_3990_erp_EOC
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|default_erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|default_erp-&gt;device
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;End-of-Cylinder - must never happen&quot;
)paren
suffix:semicolon
multiline_comment|/* implement action 7 - BUG */
r_return
id|dasd_3990_erp_cleanup
c_func
(paren
id|default_erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_EOC */
multiline_comment|/*&n; * DASD_3990_ERP_ENV_DATA&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;Environmental-Data Present&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; * RETURN VALUES&n; *   erp&t;&t;new erp_head - pointer to new ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_env_data
id|dasd_3990_erp_env_data
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_env_data
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Environmental data present&quot;
)paren
suffix:semicolon
id|dasd_3990_handle_env_data
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
multiline_comment|/* don&squot;t retry on disabled interface */
r_if
c_cond
(paren
id|sense
(braket
l_int|7
)braket
op_ne
l_int|0x0F
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_action_4
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
id|erp
op_assign
id|dasd_3990_erp_cleanup
c_func
(paren
id|erp
comma
id|DASD_CQR_IN_IO
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_env_data */
multiline_comment|/*&n; * DASD_3990_ERP_NO_REC&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;No Record Found&squot; error.&n; *&n; * PARAMETER&n; *   erp&t;&t;already added default ERP&n; *&t;&t;&n; * RETURN VALUES&n; *   erp&t;&t;new erp_head - pointer to new ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_no_rec
id|dasd_3990_erp_no_rec
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|default_erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|default_erp-&gt;device
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;No Record Found - Fatal error should &quot;
l_string|&quot;have been handled within the interrupt handler&quot;
)paren
suffix:semicolon
r_return
id|dasd_3990_erp_cleanup
c_func
(paren
id|default_erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_no_rec */
multiline_comment|/*&n; * DASD_3990_ERP_FILE_PROT&n; *&n; * DESCRIPTION&n; *   Handles 24 byte &squot;File Protected&squot; error.&n; *   Note: Seek related recovery is not implemented because&n; *&t;   wee don&squot;t use the seek command yet.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; * RETURN VALUES&n; *   erp&t;&t;new erp_head - pointer to new ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_file_prot
id|dasd_3990_erp_file_prot
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;File Protected&quot;
)paren
suffix:semicolon
r_return
id|dasd_3990_erp_cleanup
c_func
(paren
id|erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_file_prot */
multiline_comment|/*&n; * DASD_3990_ERP_INSPECT_24 &n; *&n; * DESCRIPTION&n; *   Does a detailed inspection of the 24 byte sense data&n; *   and sets up a related error recovery action.  &n; *&n; * PARAMETER&n; *   sense&t;&t;sense data of the actual error&n; *   erp&t;&t;pointer to the currently created default ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;pointer to the (addtitional) ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_inspect_24
id|dasd_3990_erp_inspect_24
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_ccw_req
op_star
id|erp_filled
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Check sense for ....&t;   */
multiline_comment|/* &squot;Command Reject&squot;&t;   */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_CMD_REJECT
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_com_rej
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Intervention Required&squot; */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_INTERVENTION_REQ
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_int_req
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Bus Out Parity Check&squot;  */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_BUS_OUT_CHECK
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_bus_out
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Equipment Check&squot;&t;   */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_EQUIPMENT_CHECK
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_equip_check
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Data Check&squot;&t;&t;   */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_DATA_CHECK
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_data_check
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Overrun&squot;&t;&t;   */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SNS0_OVERRUN
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_overrun
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Invalid Track Format&squot;  */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_INV_TRACK_FORMAT
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_inv_format
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;End-of-Cylinder&squot;&t;   */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_EOC
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_EOC
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;Environmental Data&squot;&t;   */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SNS2_ENV_DATA_PRESENT
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_env_data
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;No Record Found&squot;&t;   */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_NO_REC_FOUND
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_no_rec
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;File Protected&squot;&t;   */
r_if
c_cond
(paren
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SNS1_FILE_PROTECTED
)paren
)paren
(brace
id|erp_filled
op_assign
id|dasd_3990_erp_file_prot
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
multiline_comment|/* other (unknown) error - do default ERP */
r_if
c_cond
(paren
id|erp_filled
op_eq
l_int|NULL
)paren
(brace
id|erp_filled
op_assign
id|erp
suffix:semicolon
)brace
r_return
id|erp_filled
suffix:semicolon
)brace
multiline_comment|/* END dasd_3990_erp_inspect_24 */
multiline_comment|/*&n; ***************************************************************************** &n; * 32 byte sense ERP functions (only)&n; ***************************************************************************** &n; */
multiline_comment|/*&n; * DASD_3990_ERPACTION_10_32 &n; *&n; * DESCRIPTION&n; *   Handles 32 byte &squot;Action 10&squot; of Single Program Action Codes.&n; *   Just retry and if retry doesn&squot;t work, return with error.&n; *&n; * PARAMETER&n; *   erp&t;&t;current erp_head&n; *   sense&t;&t;current sense data &n; * RETURN VALUES&n; *   erp&t;&t;modified erp_head&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_action_10_32
id|dasd_3990_erp_action_10_32
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_10_32
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Perform logging requested&quot;
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_10_32 */
multiline_comment|/*&n; * DASD_3990_ERP_ACTION_1B_32&n; *&n; * DESCRIPTION&n; *   Handles 32 byte &squot;Action 1B&squot; of Single Program Action Codes.&n; *   A write operation could not be finished because of an unexpected &n; *   condition.&n; *   The already created &squot;default erp&squot; is used to get the link to &n; *   the erp chain, but it can not be used for this recovery &n; *   action because it contains no DE/LO data space.&n; *&n; * PARAMETER&n; *   default_erp&t;already added default erp.&n; *   sense&t;&t;current sense data &n; *&n; * RETURN VALUES&n; *   erp&t;&t;new erp or &n; *&t;&t;&t;default_erp in case of imprecise ending or error&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_action_1B_32
id|dasd_3990_erp_action_1B_32
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|default_erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|default_erp-&gt;device
suffix:semicolon
id|__u32
id|cpa
op_assign
l_int|0
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|erp
suffix:semicolon
r_struct
id|DE_eckd_data
op_star
id|DE_data
suffix:semicolon
r_char
op_star
id|LO_data
suffix:semicolon
multiline_comment|/* LO_eckd_data_t */
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Write not finished because of unexpected condition&quot;
)paren
suffix:semicolon
id|default_erp-&gt;function
op_assign
id|dasd_3990_erp_action_1B_32
suffix:semicolon
multiline_comment|/* determine the original cqr */
id|cqr
op_assign
id|default_erp
suffix:semicolon
r_while
c_loop
(paren
id|cqr-&gt;refers
op_ne
l_int|NULL
)paren
(brace
id|cqr
op_assign
id|cqr-&gt;refers
suffix:semicolon
)brace
multiline_comment|/* for imprecise ending just do default erp */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Imprecise ending is set - just retry&quot;
)paren
suffix:semicolon
r_return
id|default_erp
suffix:semicolon
)brace
multiline_comment|/* determine the address of the CCW to be restarted */
multiline_comment|/* Imprecise ending is not set -&gt; addr from IRB-SCSW */
id|cpa
op_assign
id|default_erp-&gt;refers-&gt;dstat-&gt;scsw.cpa
suffix:semicolon
r_if
c_cond
(paren
id|cpa
op_eq
l_int|0
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to determine address of the CCW &quot;
l_string|&quot;to be restarted&quot;
)paren
suffix:semicolon
r_return
id|dasd_3990_erp_cleanup
c_func
(paren
id|default_erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
)brace
multiline_comment|/* Build new ERP request including DE/LO */
id|erp
op_assign
id|dasd_alloc_erp_request
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
l_int|2
op_plus
l_int|1
comma
multiline_comment|/* DE/LO + TIC */
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|LO_eckd_data
)paren
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|erp
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to allocate ERP&quot;
)paren
suffix:semicolon
r_return
id|dasd_3990_erp_cleanup
c_func
(paren
id|default_erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
)brace
multiline_comment|/* use original DE */
id|DE_data
op_assign
id|erp-&gt;data
suffix:semicolon
id|memcpy
c_func
(paren
id|DE_data
comma
id|cqr-&gt;data
comma
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
)paren
suffix:semicolon
multiline_comment|/* create LO */
id|LO_data
op_assign
id|erp-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|3
)braket
op_eq
l_int|0x01
)paren
op_logical_and
(paren
id|LO_data
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;BUG - this should not happen&quot;
)paren
suffix:semicolon
r_return
id|dasd_3990_erp_cleanup
c_func
(paren
id|default_erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x3F
)paren
op_eq
l_int|0x01
)paren
(brace
multiline_comment|/* operation code is WRITE DATA -&gt; data area orientation */
id|LO_data
(braket
l_int|0
)braket
op_assign
l_int|0x81
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x3F
)paren
op_eq
l_int|0x03
)paren
(brace
multiline_comment|/* operation code is FORMAT WRITE -&gt; index orientation */
id|LO_data
(braket
l_int|0
)braket
op_assign
l_int|0xC3
suffix:semicolon
)brace
r_else
(brace
id|LO_data
(braket
l_int|0
)braket
op_assign
id|sense
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* operation */
)brace
id|LO_data
(braket
l_int|1
)braket
op_assign
id|sense
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* auxiliary */
id|LO_data
(braket
l_int|2
)braket
op_assign
id|sense
(braket
l_int|9
)braket
suffix:semicolon
id|LO_data
(braket
l_int|3
)braket
op_assign
id|sense
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* count */
id|LO_data
(braket
l_int|4
)braket
op_assign
id|sense
(braket
l_int|29
)braket
suffix:semicolon
multiline_comment|/* seek_addr.cyl */
id|LO_data
(braket
l_int|5
)braket
op_assign
id|sense
(braket
l_int|30
)braket
suffix:semicolon
multiline_comment|/* seek_addr.cyl 2nd byte */
id|LO_data
(braket
l_int|7
)braket
op_assign
id|sense
(braket
l_int|31
)braket
suffix:semicolon
multiline_comment|/* seek_addr.head 2nd byte */
id|memcpy
c_func
(paren
op_amp
(paren
id|LO_data
(braket
l_int|8
)braket
)paren
comma
op_amp
(paren
id|sense
(braket
l_int|11
)braket
)paren
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* create DE ccw */
id|ccw
op_assign
id|erp-&gt;cpaddr
suffix:semicolon
id|memset
c_func
(paren
id|ccw
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_DEFINE_EXTENT
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|16
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|DE_data
suffix:semicolon
multiline_comment|/* create LO ccw */
id|ccw
op_increment
suffix:semicolon
id|memset
c_func
(paren
id|ccw
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DASD_ECKD_CCW_LOCATE_RECORD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|16
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
id|__u32
)paren
(paren
id|addr_t
)paren
id|LO_data
suffix:semicolon
multiline_comment|/* TIC to the failed ccw */
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|CCW_CMD_TIC
suffix:semicolon
id|ccw-&gt;cda
op_assign
id|cpa
suffix:semicolon
multiline_comment|/* fill erp related fields */
id|erp-&gt;function
op_assign
id|dasd_3990_erp_action_1B_32
suffix:semicolon
id|erp-&gt;refers
op_assign
id|default_erp-&gt;refers
suffix:semicolon
id|erp-&gt;device
op_assign
id|device
suffix:semicolon
id|erp-&gt;magic
op_assign
id|default_erp-&gt;magic
suffix:semicolon
id|erp-&gt;expires
op_assign
l_int|0
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|cqr-&gt;buildclk
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|erp-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
multiline_comment|/* remove the default erp */
id|dasd_free_erp_request
c_func
(paren
id|default_erp
comma
id|device
)paren
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action_1B_32 */
multiline_comment|/*&n; * DASD_3990_UPDATE_1B&n; *&n; * DESCRIPTION&n; *   Handles the update to the 32 byte &squot;Action 1B&squot; of Single Program &n; *   Action Codes in case the first action was not successful.&n; *   The already created &squot;previous_erp&squot; is the currently not successful&n; *   ERP. &n; *&n; * PARAMETER&n; *   previous_erp&t;already created previous erp.&n; *   sense&t;&t;current sense data &n; * RETURN VALUES&n; *   erp&t;&t;modified erp &n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_update_1B
id|dasd_3990_update_1B
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|previous_erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|previous_erp-&gt;device
suffix:semicolon
id|__u32
id|cpa
op_assign
l_int|0
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|cqr
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|erp
suffix:semicolon
r_char
op_star
id|LO_data
suffix:semicolon
multiline_comment|/* struct LO_eckd_data */
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Write not finished because of unexpected condition&quot;
l_string|&quot; - follow on&quot;
)paren
suffix:semicolon
multiline_comment|/* determine the original cqr */
id|cqr
op_assign
id|previous_erp
suffix:semicolon
r_while
c_loop
(paren
id|cqr-&gt;refers
op_ne
l_int|NULL
)paren
(brace
id|cqr
op_assign
id|cqr-&gt;refers
suffix:semicolon
)brace
multiline_comment|/* for imprecise ending just do default erp */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Imprecise ending is set - just retry&quot;
)paren
suffix:semicolon
id|previous_erp-&gt;status
op_assign
id|DASD_CQR_QUEUED
suffix:semicolon
r_return
id|previous_erp
suffix:semicolon
)brace
multiline_comment|/* determine the address of the CCW to be restarted */
multiline_comment|/* Imprecise ending is not set -&gt; addr from IRB-SCSW */
id|cpa
op_assign
id|previous_erp-&gt;dstat-&gt;scsw.cpa
suffix:semicolon
r_if
c_cond
(paren
id|cpa
op_eq
l_int|0
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to determine address of the CCW &quot;
l_string|&quot;to be restarted&quot;
)paren
suffix:semicolon
id|previous_erp-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
r_return
id|previous_erp
suffix:semicolon
)brace
id|erp
op_assign
id|previous_erp
suffix:semicolon
multiline_comment|/* update the LO with the new returned sense data  */
id|LO_data
op_assign
id|erp-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|DE_eckd_data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|3
)braket
op_eq
l_int|0x01
)paren
op_logical_and
(paren
id|LO_data
(braket
l_int|1
)braket
op_amp
l_int|0x01
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;BUG - this should not happen&quot;
)paren
suffix:semicolon
id|previous_erp-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
r_return
id|previous_erp
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x3F
)paren
op_eq
l_int|0x01
)paren
(brace
multiline_comment|/* operation code is WRITE DATA -&gt; data area orientation */
id|LO_data
(braket
l_int|0
)braket
op_assign
l_int|0x81
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|7
)braket
op_amp
l_int|0x3F
)paren
op_eq
l_int|0x03
)paren
(brace
multiline_comment|/* operation code is FORMAT WRITE -&gt; index orientation */
id|LO_data
(braket
l_int|0
)braket
op_assign
l_int|0xC3
suffix:semicolon
)brace
r_else
(brace
id|LO_data
(braket
l_int|0
)braket
op_assign
id|sense
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* operation */
)brace
id|LO_data
(braket
l_int|1
)braket
op_assign
id|sense
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* auxiliary */
id|LO_data
(braket
l_int|2
)braket
op_assign
id|sense
(braket
l_int|9
)braket
suffix:semicolon
id|LO_data
(braket
l_int|3
)braket
op_assign
id|sense
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* count */
id|LO_data
(braket
l_int|4
)braket
op_assign
id|sense
(braket
l_int|29
)braket
suffix:semicolon
multiline_comment|/* seek_addr.cyl */
id|LO_data
(braket
l_int|5
)braket
op_assign
id|sense
(braket
l_int|30
)braket
suffix:semicolon
multiline_comment|/* seek_addr.cyl 2nd byte */
id|LO_data
(braket
l_int|7
)braket
op_assign
id|sense
(braket
l_int|31
)braket
suffix:semicolon
multiline_comment|/* seek_addr.head 2nd byte */
id|memcpy
c_func
(paren
op_amp
(paren
id|LO_data
(braket
l_int|8
)braket
)paren
comma
op_amp
(paren
id|sense
(braket
l_int|11
)braket
)paren
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* TIC to the failed ccw */
id|ccw
op_assign
id|erp-&gt;cpaddr
suffix:semicolon
multiline_comment|/* addr of DE ccw */
id|ccw
op_increment
suffix:semicolon
multiline_comment|/* addr of LE ccw */
id|ccw
op_increment
suffix:semicolon
multiline_comment|/* addr of TIC ccw */
id|ccw-&gt;cda
op_assign
id|cpa
suffix:semicolon
id|erp-&gt;status
op_assign
id|DASD_CQR_QUEUED
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_update_1B */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND_RETRY &n; *&n; * DESCRIPTION&n; *   Handles the compound ERP action retry code.&n; *   NOTE: At least one retry is done even if zero is specified&n; *&t;   by the sense data. This makes enqueueing of the request&n; *&t;   easier.&n; *&n; * PARAMETER&n; *   sense&t;&t;sense data of the actual error&n; *   erp&t;&t;pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;modified ERP pointer&n; *&n; */
r_static
r_void
DECL|function|dasd_3990_erp_compound_retry
id|dasd_3990_erp_compound_retry
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_switch
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
l_int|0x03
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* no not retry */
id|erp-&gt;retries
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* retry 2 times */
id|erp-&gt;retries
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* retry 10 times */
id|erp-&gt;retries
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
multiline_comment|/* retry 256 times */
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_compound_retry
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound_retry */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND_PATH &n; *&n; * DESCRIPTION&n; *   Handles the compound ERP action for retry on alternate&n; *   channel path.&n; *&n; * PARAMETER&n; *   sense&t;&t;sense data of the actual error&n; *   erp&t;&t;pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;modified ERP pointer&n; *&n; */
r_static
r_void
DECL|function|dasd_3990_erp_compound_path
id|dasd_3990_erp_compound_path
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
id|DASD_SENSE_BIT_3
)paren
(brace
id|dasd_3990_erp_alternate_path
c_func
(paren
id|erp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp-&gt;status
op_eq
id|DASD_CQR_FAILED
)paren
(brace
multiline_comment|/* reset the lpm and the status to be able to &n;&t;&t;&t; * try further actions. */
id|erp-&gt;lpm
op_assign
l_int|0
suffix:semicolon
id|erp-&gt;status
op_assign
id|DASD_CQR_ERROR
suffix:semicolon
)brace
)brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_compound_path
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound_path */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND_CODE &n; *&n; * DESCRIPTION&n; *   Handles the compound ERP action for retry code.&n; *&n; * PARAMETER&n; *   sense&t;&t;sense data of the actual error&n; *   erp&t;&t;pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;NEW ERP pointer&n; *&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_compound_code
id|dasd_3990_erp_compound_code
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
id|DASD_SENSE_BIT_2
)paren
(brace
r_switch
c_cond
(paren
id|sense
(braket
l_int|28
)braket
)paren
(brace
r_case
l_int|0x17
suffix:colon
multiline_comment|/* issue a Diagnostic Control command with an &n;&t;&t;&t; * Inhibit Write subcommand and controler modifier */
id|erp
op_assign
id|dasd_3990_erp_DCTL
c_func
(paren
id|erp
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x25
suffix:colon
multiline_comment|/* wait for 5 seconds and retry again */
id|erp-&gt;retries
op_assign
l_int|1
suffix:semicolon
id|dasd_3990_erp_block_queue
(paren
id|erp
comma
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* should not happen - continue */
r_break
suffix:semicolon
)brace
)brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_compound_code
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound_code */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND_CONFIG &n; *&n; * DESCRIPTION&n; *   Handles the compound ERP action for configruation&n; *   dependent error.&n; *   Note: duplex handling is not implemented (yet).&n; *&n; * PARAMETER&n; *   sense&t;&t;sense data of the actual error&n; *   erp&t;&t;pointer to the currently created ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;modified ERP pointer&n; *&n; */
r_static
r_void
DECL|function|dasd_3990_erp_compound_config
id|dasd_3990_erp_compound_config
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|25
)braket
op_amp
id|DASD_SENSE_BIT_1
)paren
op_logical_and
(paren
id|sense
(braket
l_int|26
)braket
op_amp
id|DASD_SENSE_BIT_2
)paren
)paren
(brace
multiline_comment|/* set to suspended duplex state then restart */
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Set device to suspended duplex state should be &quot;
l_string|&quot;done!&bslash;n&quot;
l_string|&quot;This is not implemented yet (for compound ERP)&quot;
l_string|&quot; - please report to linux390@de.ibm.com&quot;
)paren
suffix:semicolon
)brace
id|erp-&gt;function
op_assign
id|dasd_3990_erp_compound_config
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound_config */
multiline_comment|/*&n; * DASD_3990_ERP_COMPOUND &n; *&n; * DESCRIPTION&n; *   Does the further compound program action if &n; *   compound retry was not successful.&n; *&n; * PARAMETER&n; *   sense&t;&t;sense data of the actual error&n; *   erp&t;&t;pointer to the current (failed) ERP&n; *&n; * RETURN VALUES&n; *   erp&t;&t;(additional) ERP pointer&n; *&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_compound
id|dasd_3990_erp_compound
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_retry
)paren
op_logical_and
(paren
id|erp-&gt;status
op_eq
id|DASD_CQR_ERROR
)paren
)paren
(brace
id|dasd_3990_erp_compound_path
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_path
)paren
op_logical_and
(paren
id|erp-&gt;status
op_eq
id|DASD_CQR_ERROR
)paren
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_compound_code
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_code
)paren
op_logical_and
(paren
id|erp-&gt;status
op_eq
id|DASD_CQR_ERROR
)paren
)paren
(brace
id|dasd_3990_erp_compound_config
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* if no compound action ERP specified, the request failed */
r_if
c_cond
(paren
id|erp-&gt;status
op_eq
id|DASD_CQR_ERROR
)paren
(brace
id|erp-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_compound */
multiline_comment|/*&n; * DASD_3990_ERP_INSPECT_32 &n; *&n; * DESCRIPTION&n; *   Does a detailed inspection of the 32 byte sense data&n; *   and sets up a related error recovery action.  &n; *&n; * PARAMETER&n; *   sense&t;&t;sense data of the actual error&n; *   erp&t;&t;pointer to the currently created default ERP&n; *&n; * RETURN VALUES&n; *   erp_filled&t;&t;pointer to the ERP&n; *&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_inspect_32
id|dasd_3990_erp_inspect_32
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
comma
r_char
op_star
id|sense
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_inspect_32
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|25
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
(brace
multiline_comment|/* compound program action codes (byte25 bit 0 == &squot;1&squot;) */
id|dasd_3990_erp_compound_retry
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* single program action codes (byte25 bit 0 == &squot;0&squot;) */
r_switch
c_cond
(paren
id|sense
(braket
l_int|25
)braket
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* success - use default ERP for retries */
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ERP called for successful request&quot;
l_string|&quot; - just retry&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x01
suffix:colon
multiline_comment|/* fatal error */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Fatal error should have been &quot;
l_string|&quot;handled within the interrupt handler&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_cleanup
c_func
(paren
id|erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* intervention required */
r_case
l_int|0x03
suffix:colon
multiline_comment|/* intervention required during dual copy */
id|erp
op_assign
id|dasd_3990_erp_int_req
c_func
(paren
id|erp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0F
suffix:colon
multiline_comment|/* length mismatch during update write command */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;update write command error - should not &quot;
l_string|&quot;happen;&bslash;n&quot;
l_string|&quot;Please send this message together with &quot;
l_string|&quot;the above sense data to linux390@de.&quot;
l_string|&quot;ibm.com&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_cleanup
c_func
(paren
id|erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x10
suffix:colon
multiline_comment|/* logging required for other channel program */
id|erp
op_assign
id|dasd_3990_erp_action_10_32
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x15
suffix:colon
multiline_comment|/* next track outside defined extend */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;next track outside defined extend - &quot;
l_string|&quot;should not happen;&bslash;n&quot;
l_string|&quot;Please send this message together with &quot;
l_string|&quot;the above sense data to linux390@de.&quot;
l_string|&quot;ibm.com&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_cleanup
c_func
(paren
id|erp
comma
id|DASD_CQR_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1B
suffix:colon
multiline_comment|/* unexpected condition during write */
id|erp
op_assign
id|dasd_3990_erp_action_1B_32
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1C
suffix:colon
multiline_comment|/* invalid data */
id|DEV_MESSAGE
c_func
(paren
id|KERN_EMERG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Data recovered during retry with PCI &quot;
l_string|&quot;fetch mode active&quot;
)paren
suffix:semicolon
multiline_comment|/* not possible to handle this situation in Linux */
id|panic
(paren
l_string|&quot;Invalid data - No way to inform appliction about &quot;
l_string|&quot;the possibly incorret data&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1D
suffix:colon
multiline_comment|/* state-change pending */
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;A State change pending condition exists &quot;
l_string|&quot;for the subsystem or device&quot;
)paren
suffix:semicolon
id|erp
op_assign
id|dasd_3990_erp_action_4
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* all others errors - default erp  */
r_break
suffix:semicolon
)brace
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_inspect_32 */
multiline_comment|/*&n; ***************************************************************************** &n; * main ERP control fuctions (24 and 32 byte sense)&n; ***************************************************************************** &n; */
multiline_comment|/*&n; * DASD_3990_ERP_INSPECT&n; *&n; * DESCRIPTION&n; *   Does a detailed inspection for sense data by calling either&n; *   the 24-byte or the 32-byte inspection routine.&n; *&n; * PARAMETER&n; *   erp&t;&t;pointer to the currently created default ERP&n; * RETURN VALUES&n; *   erp_new&t;&t;contens was possibly modified &n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_inspect
id|dasd_3990_erp_inspect
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
r_struct
id|dasd_ccw_req
op_star
id|erp_new
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* sense data are located in the refers record of the */
multiline_comment|/* already set up new ERP !&t;&t;&t;      */
r_char
op_star
id|sense
op_assign
id|erp-&gt;refers-&gt;dstat-&gt;ecw
suffix:semicolon
multiline_comment|/* distinguish between 24 and 32 byte sense data */
r_if
c_cond
(paren
id|sense
(braket
l_int|27
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
(brace
multiline_comment|/* inspect the 24 byte sense data */
id|erp_new
op_assign
id|dasd_3990_erp_inspect_24
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* inspect the 32 byte sense data */
id|erp_new
op_assign
id|dasd_3990_erp_inspect_32
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
multiline_comment|/* end distinguish between 24 and 32 byte sense data */
r_return
id|erp_new
suffix:semicolon
)brace
multiline_comment|/* END dasd_3990_erp_inspect */
multiline_comment|/*&n; * DASD_3990_ERP_ADD_ERP&n; * &n; * DESCRIPTION&n; *   This funtion adds an additional request block (ERP) to the head of&n; *   the given cqr (or erp).&n; *   This erp is initialized as an default erp (retry TIC)&n; *&n; * PARAMETER&n; *   cqr&t;&t;head of the current ERP-chain (or single cqr if &n; *&t;&t;&t;first error)&n; * RETURN VALUES&n; *   erp&t;&t;pointer to new ERP-chain head&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_add_erp
id|dasd_3990_erp_add_erp
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
multiline_comment|/* allocate additional request block */
r_struct
id|dasd_ccw_req
op_star
id|erp
suffix:semicolon
id|erp
op_assign
id|dasd_alloc_erp_request
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|cqr-&gt;magic
comma
l_int|2
comma
l_int|0
comma
id|cqr-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|erp
)paren
)paren
(brace
r_if
c_cond
(paren
id|cqr-&gt;retries
op_le
l_int|0
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;Unable to allocate ERP request&quot;
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
id|cqr-&gt;stopclk
op_assign
id|get_clock
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEV_MESSAGE
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;Unable to allocate ERP request &quot;
l_string|&quot;(%i retries left)&quot;
comma
id|cqr-&gt;retries
)paren
suffix:semicolon
id|dasd_set_timer
c_func
(paren
id|device
comma
(paren
id|HZ
op_lshift
l_int|3
)paren
)paren
suffix:semicolon
)brace
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* initialize request with default TIC to current ERP/CQR */
id|ccw
op_assign
id|erp-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|CCW_CMD_NOOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|CCW_CMD_TIC
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
)paren
(paren
id|cqr-&gt;cpaddr
)paren
suffix:semicolon
id|erp-&gt;function
op_assign
id|dasd_3990_erp_add_erp
suffix:semicolon
id|erp-&gt;refers
op_assign
id|cqr
suffix:semicolon
id|erp-&gt;device
op_assign
id|cqr-&gt;device
suffix:semicolon
id|erp-&gt;magic
op_assign
id|cqr-&gt;magic
suffix:semicolon
id|erp-&gt;expires
op_assign
l_int|0
suffix:semicolon
id|erp-&gt;retries
op_assign
l_int|256
suffix:semicolon
id|erp-&gt;status
op_assign
id|DASD_CQR_FILLED
suffix:semicolon
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/*&n; * DASD_3990_ERP_ADDITIONAL_ERP &n; * &n; * DESCRIPTION&n; *   An additional ERP is needed to handle the current error.&n; *   Add ERP to the head of the ERP-chain containing the ERP processing&n; *   determined based on the sense data.&n; *&n; * PARAMETER&n; *   cqr&t;&t;head of the current ERP-chain (or single cqr if &n; *&t;&t;&t;first error)&n; *&n; * RETURN VALUES&n; *   erp&t;&t;pointer to new ERP-chain head&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_additional_erp
id|dasd_3990_erp_additional_erp
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
)paren
(brace
r_struct
id|dasd_ccw_req
op_star
id|erp
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* add erp and initialize with default TIC */
id|erp
op_assign
id|dasd_3990_erp_add_erp
c_func
(paren
id|cqr
)paren
suffix:semicolon
multiline_comment|/* inspect sense, determine specific ERP if possible */
r_if
c_cond
(paren
id|erp
op_ne
id|cqr
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_inspect
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_additional_erp */
multiline_comment|/*&n; * DASD_3990_ERP_ERROR_MATCH&n; *&n; * DESCRIPTION&n; *   Check if the device status of the given cqr is the same.&n; *   This means that the failed CCW and the relevant sense data&n; *   must match.&n; *   I don&squot;t distinguish between 24 and 32 byte sense because in case of&n; *   24 byte sense byte 25 and 27 is set as well.&n; *&n; * PARAMETER&n; *   cqr1&t;&t;first cqr, which will be compared with the &n; *   cqr2&t;&t;second cqr.&n; *&n; * RETURN VALUES&n; *   match&t;&t;&squot;boolean&squot; for match found&n; *&t;&t;&t;returns 1 if match found, otherwise 0.&n; */
r_static
r_int
DECL|function|dasd_3990_erp_error_match
id|dasd_3990_erp_error_match
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr1
comma
r_struct
id|dasd_ccw_req
op_star
id|cqr2
)paren
(brace
multiline_comment|/* check failed CCW */
r_if
c_cond
(paren
id|cqr1-&gt;dstat-&gt;scsw.cpa
op_ne
id|cqr2-&gt;dstat-&gt;scsw.cpa
)paren
(brace
singleline_comment|//&t;return 0;&t;/* CCW doesn&squot;t match */
)brace
multiline_comment|/* check sense data; byte 0-2,25,27 */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|memcmp
(paren
id|cqr1-&gt;dstat-&gt;ecw
comma
id|cqr2-&gt;dstat-&gt;ecw
comma
l_int|3
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|cqr1-&gt;dstat-&gt;ecw
(braket
l_int|27
)braket
op_eq
id|cqr2-&gt;dstat-&gt;ecw
(braket
l_int|27
)braket
)paren
op_logical_and
(paren
id|cqr1-&gt;dstat-&gt;ecw
(braket
l_int|25
)braket
op_eq
id|cqr2-&gt;dstat-&gt;ecw
(braket
l_int|25
)braket
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* sense doesn&squot;t match */
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* match */
)brace
multiline_comment|/* end dasd_3990_erp_error_match */
multiline_comment|/*&n; * DASD_3990_ERP_IN_ERP&n; *&n; * DESCRIPTION&n; *   check if the current error already happened before.&n; *   quick exit if current cqr is not an ERP (cqr-&gt;refers=NULL)&n; *&n; * PARAMETER&n; *   cqr&t;&t;failed cqr (either original cqr or already an erp)&n; *&n; * RETURN VALUES&n; *   erp&t;&t;erp-pointer to the already defined error &n; *&t;&t;&t;recovery procedure OR&n; *&t;&t;&t;NULL if a &squot;new&squot; error occurred.&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_in_erp
id|dasd_3990_erp_in_erp
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
)paren
(brace
r_struct
id|dasd_ccw_req
op_star
id|erp_head
op_assign
id|cqr
comma
multiline_comment|/* save erp chain head */
op_star
id|erp_match
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* save erp chain head */
r_int
id|match
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &squot;boolean&squot; for matching error found */
r_if
c_cond
(paren
id|cqr-&gt;refers
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* return if not in erp */
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* check the erp/cqr chain for current error */
r_do
(brace
id|match
op_assign
id|dasd_3990_erp_error_match
c_func
(paren
id|erp_head
comma
id|cqr-&gt;refers
)paren
suffix:semicolon
id|erp_match
op_assign
id|cqr
suffix:semicolon
multiline_comment|/* save possible matching erp  */
id|cqr
op_assign
id|cqr-&gt;refers
suffix:semicolon
multiline_comment|/* check next erp/cqr in queue */
)brace
r_while
c_loop
(paren
(paren
id|cqr-&gt;refers
op_ne
l_int|NULL
)paren
op_logical_and
(paren
op_logical_neg
id|match
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|match
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* no match was found */
)brace
r_return
id|erp_match
suffix:semicolon
multiline_comment|/* return address of matching erp */
)brace
multiline_comment|/* END dasd_3990_erp_in_erp */
multiline_comment|/*&n; * DASD_3990_ERP_FURTHER_ERP (24 &amp; 32 byte sense)&n; *&n; * DESCRIPTION&n; *   No retry is left for the current ERP. Check what has to be done &n; *   with the ERP.&n; *     - do further defined ERP action or&n; *     - wait for interrupt or&t;&n; *     - exit with permanent error&n; *&n; * PARAMETER&n; *   erp&t;&t;ERP which is in progress with no retry left&n; *&n; * RETURN VALUES&n; *   erp&t;&t;modified/additional ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_further_erp
id|dasd_3990_erp_further_erp
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp-&gt;device
suffix:semicolon
r_char
op_star
id|sense
op_assign
id|erp-&gt;dstat-&gt;ecw
suffix:semicolon
multiline_comment|/* check for 24 byte sense ERP */
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_bus_out
)paren
op_logical_or
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_1
)paren
op_logical_or
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_4
)paren
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_action_1
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_5
)paren
(brace
multiline_comment|/* retries have not been successful */
multiline_comment|/* prepare erp for retry on different channel path */
id|erp
op_assign
id|dasd_3990_erp_action_1
c_func
(paren
id|erp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|DASD_SENSE_BIT_0
)paren
)paren
(brace
multiline_comment|/* issue a Diagnostic Control command with an &n;&t;&t;&t; * Inhibit Write subcommand */
r_switch
c_cond
(paren
id|sense
(braket
l_int|25
)braket
)paren
(brace
r_case
l_int|0x17
suffix:colon
r_case
l_int|0x57
suffix:colon
(brace
multiline_comment|/* controller */
id|erp
op_assign
id|dasd_3990_erp_DCTL
c_func
(paren
id|erp
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x18
suffix:colon
r_case
l_int|0x58
suffix:colon
(brace
multiline_comment|/* channel path */
id|erp
op_assign
id|dasd_3990_erp_DCTL
c_func
(paren
id|erp
comma
l_int|0x40
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x19
suffix:colon
r_case
l_int|0x59
suffix:colon
(brace
multiline_comment|/* storage director */
id|erp
op_assign
id|dasd_3990_erp_DCTL
c_func
(paren
id|erp
comma
l_int|0x80
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;invalid subcommand modifier 0x%x &quot;
l_string|&quot;for Diagnostic Control Command&quot;
comma
id|sense
(braket
l_int|25
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* check for 32 byte sense ERP */
)brace
r_else
r_if
c_cond
(paren
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_retry
)paren
op_logical_or
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_path
)paren
op_logical_or
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_code
)paren
op_logical_or
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_compound_config
)paren
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_compound
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no retry left and no additional special handling necessary */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;no retries left for erp %p - &quot;
l_string|&quot;set status to FAILED&quot;
comma
id|erp
)paren
suffix:semicolon
id|erp-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_further_erp */
multiline_comment|/*&n; * DASD_3990_ERP_HANDLE_MATCH_ERP &n; *&n; * DESCRIPTION&n; *   An error occurred again and an ERP has been detected which is already&n; *   used to handle this error (e.g. retries). &n; *   All prior ERP&squot;s are asumed to be successful and therefore removed&n; *   from queue.&n; *   If retry counter of matching erp is already 0, it is checked if further &n; *   action is needed (besides retry) or if the ERP has failed.&n; *&n; * PARAMETER&n; *   erp_head&t;&t;first ERP in ERP-chain&n; *   erp&t;&t;ERP that handles the actual error.&n; *&t;&t;&t;(matching erp)&n; *&n; * RETURN VALUES&n; *   erp&t;&t;modified/additional ERP&n; */
r_static
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_handle_match_erp
id|dasd_3990_erp_handle_match_erp
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|erp_head
comma
r_struct
id|dasd_ccw_req
op_star
id|erp
)paren
(brace
r_struct
id|dasd_device
op_star
id|device
op_assign
id|erp_head-&gt;device
suffix:semicolon
r_struct
id|dasd_ccw_req
op_star
id|erp_done
op_assign
id|erp_head
suffix:semicolon
multiline_comment|/* finished req */
r_struct
id|dasd_ccw_req
op_star
id|erp_free
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* req to be freed */
multiline_comment|/* loop over successful ERPs and remove them from chanq */
r_while
c_loop
(paren
id|erp_done
op_ne
id|erp
)paren
(brace
r_if
c_cond
(paren
id|erp_done
op_eq
l_int|NULL
)paren
multiline_comment|/* end of chain reached */
id|panic
c_func
(paren
id|PRINTK_HEADER
l_string|&quot;Programming error in ERP! The &quot;
l_string|&quot;original request was lost&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* remove the request from the device queue */
id|list_del
c_func
(paren
op_amp
id|erp_done-&gt;list
)paren
suffix:semicolon
id|erp_free
op_assign
id|erp_done
suffix:semicolon
id|erp_done
op_assign
id|erp_done-&gt;refers
suffix:semicolon
multiline_comment|/* free the finished erp request */
id|dasd_free_erp_request
c_func
(paren
id|erp_free
comma
id|erp_free-&gt;device
)paren
suffix:semicolon
)brace
multiline_comment|/* end while */
r_if
c_cond
(paren
id|erp-&gt;retries
OG
l_int|0
)paren
(brace
r_char
op_star
id|sense
op_assign
id|erp-&gt;refers-&gt;dstat-&gt;ecw
suffix:semicolon
multiline_comment|/* check for special retries */
r_if
c_cond
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_4
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_action_4
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_action_1B_32
)paren
(brace
id|erp
op_assign
id|dasd_3990_update_1B
c_func
(paren
id|erp
comma
id|sense
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|erp-&gt;function
op_eq
id|dasd_3990_erp_int_req
)paren
(brace
id|erp
op_assign
id|dasd_3990_erp_int_req
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* simple retry&t;  */
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;%i retries left for erp %p&quot;
comma
id|erp-&gt;retries
comma
id|erp
)paren
suffix:semicolon
multiline_comment|/* handle the request again... */
id|erp-&gt;status
op_assign
id|DASD_CQR_QUEUED
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* no retry left - check for further necessary action&t; */
multiline_comment|/* if no further actions, handle rest as permanent error */
id|erp
op_assign
id|dasd_3990_erp_further_erp
c_func
(paren
id|erp
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_handle_match_erp */
multiline_comment|/*&n; * DASD_3990_ERP_ACTION&n; *&n; * DESCRIPTION&n; *   controll routine for 3990 erp actions.&n; *   Has to be called with the queue lock (namely the s390_irq_lock) acquired.&n; *&n; * PARAMETER&n; *   cqr&t;&t;failed cqr (either original cqr or already an erp)&n; *&n; * RETURN VALUES&n; *   erp&t;&t;erp-pointer to the head of the ERP action chain.&n; *&t;&t;&t;This means:&n; *&t;&t;&t; - either a ptr to an additional ERP cqr or&n; *&t;&t;&t; - the original given cqr (which&squot;s status might &n; *&t;&t;&t;   be modified)&n; */
r_struct
id|dasd_ccw_req
op_star
DECL|function|dasd_3990_erp_action
id|dasd_3990_erp_action
c_func
(paren
r_struct
id|dasd_ccw_req
op_star
id|cqr
)paren
(brace
r_struct
id|dasd_ccw_req
op_star
id|erp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dasd_device
op_star
id|device
op_assign
id|cqr-&gt;device
suffix:semicolon
id|__u32
id|cpa
op_assign
id|cqr-&gt;dstat-&gt;scsw.cpa
suffix:semicolon
macro_line|#ifdef ERP_DEBUG
multiline_comment|/* print current erp_chain */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ERP chain at BEGINNING of ERP-ACTION&quot;
)paren
suffix:semicolon
(brace
r_struct
id|dasd_ccw_req
op_star
id|temp_erp
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|temp_erp
op_assign
id|cqr
suffix:semicolon
id|temp_erp
op_ne
l_int|NULL
suffix:semicolon
id|temp_erp
op_assign
id|temp_erp-&gt;refers
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;   erp %p (%02x) refers to %p&quot;
comma
id|temp_erp
comma
id|temp_erp-&gt;status
comma
id|temp_erp-&gt;refers
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* ERP_DEBUG */
multiline_comment|/* double-check if current erp/cqr was successfull */
r_if
c_cond
(paren
(paren
id|cqr-&gt;dstat-&gt;scsw.cstat
op_eq
l_int|0x00
)paren
op_logical_and
(paren
id|cqr-&gt;dstat-&gt;scsw.dstat
op_eq
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;ERP called for successful request %p&quot;
l_string|&quot; - NO ERP necessary&quot;
comma
id|cqr
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_DONE
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* check if sense data are available */
r_if
c_cond
(paren
op_logical_neg
id|cqr-&gt;dstat-&gt;ecw
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_DEBUG
comma
id|device
comma
l_string|&quot;ERP called witout sense data avail ...&quot;
l_string|&quot;request %p - NO ERP possible&quot;
comma
id|cqr
)paren
suffix:semicolon
id|cqr-&gt;status
op_assign
id|DASD_CQR_FAILED
suffix:semicolon
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/* check if error happened before */
id|erp
op_assign
id|dasd_3990_erp_in_erp
c_func
(paren
id|cqr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no matching erp found - set up erp */
id|erp
op_assign
id|dasd_3990_erp_additional_erp
c_func
(paren
id|cqr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* matching erp found - set all leading erp&squot;s to DONE */
id|erp
op_assign
id|dasd_3990_erp_handle_match_erp
c_func
(paren
id|cqr
comma
id|erp
)paren
suffix:semicolon
)brace
macro_line|#ifdef ERP_DEBUG
multiline_comment|/* print current erp_chain */
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;%s&quot;
comma
l_string|&quot;ERP chain at END of ERP-ACTION&quot;
)paren
suffix:semicolon
(brace
r_struct
id|dasd_ccw_req
op_star
id|temp_erp
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|temp_erp
op_assign
id|erp
suffix:semicolon
id|temp_erp
op_ne
l_int|NULL
suffix:semicolon
id|temp_erp
op_assign
id|temp_erp-&gt;refers
)paren
(brace
id|DEV_MESSAGE
c_func
(paren
id|KERN_ERR
comma
id|device
comma
l_string|&quot;   erp %p (%02x) refers to %p&quot;
comma
id|temp_erp
comma
id|temp_erp-&gt;status
comma
id|temp_erp-&gt;refers
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif&t;&t;&t;&t;/* ERP_DEBUG */
r_if
c_cond
(paren
id|erp-&gt;status
op_eq
id|DASD_CQR_FAILED
)paren
id|dasd_log_ccw
c_func
(paren
id|erp
comma
l_int|1
comma
id|cpa
)paren
suffix:semicolon
multiline_comment|/* enqueue added ERP request */
r_if
c_cond
(paren
id|erp-&gt;status
op_eq
id|DASD_CQR_FILLED
)paren
(brace
id|erp-&gt;status
op_assign
id|DASD_CQR_QUEUED
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|erp-&gt;list
comma
op_amp
id|device-&gt;ccw_queue
)paren
suffix:semicolon
)brace
r_return
id|erp
suffix:semicolon
)brace
multiline_comment|/* end dasd_3990_erp_action */
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 4 &n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -4&n; * c-argdecl-indent: 4&n; * c-label-offset: -4&n; * c-continued-statement-offset: 4&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: 1&n; * tab-width: 8&n; * End:&n; */
eof
