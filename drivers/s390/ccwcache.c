multiline_comment|/* &n; * File...........: linux/drivers/s390/ccwcache.c&n; * Author(s)......: Holger Smolinski &lt;Holger.Smolinski@de.ibm.com&gt;&n; *                  Martin Schiwdefsky &lt;schwidefsky@de.ibm.com&gt;&n; * Bugreports.to..: &lt;Linux390@de.ibm.com&gt;&n; * (C) IBM Corporation, IBM Deutschland Entwicklung GmbH, 2000a&n; &n; * History of changes&n; * 11/14/00 redesign by Martin Schwidefsky&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,98))
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#else
macro_line|#include &lt;asm/spinlock.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/ccwcache.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,98))
DECL|macro|CCW_CACHE_SLAB_TYPE
mdefine_line|#define CCW_CACHE_SLAB_TYPE (SLAB_HWCACHE_ALIGN | SLAB_CACHE_DMA)
DECL|macro|CCW_CACHE_TYPE
mdefine_line|#define CCW_CACHE_TYPE (GFP_ATOMIC | GFP_DMA)
macro_line|#else
DECL|macro|CCW_CACHE_SLAB_TYPE
mdefine_line|#define CCW_CACHE_SLAB_TYPE (SLAB_HWCACHE_ALIGN)
DECL|macro|CCW_CACHE_TYPE
mdefine_line|#define CCW_CACHE_TYPE (GFP_ATOMIC)
DECL|macro|kmem_cache_destroy
mdefine_line|#define kmem_cache_destroy(x) do {} while(0)
macro_line|#endif
DECL|macro|PRINTK_HEADER
macro_line|#undef PRINTK_HEADER
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;ccwcache&quot;
multiline_comment|/* pointer to list of allocated requests */
DECL|variable|ccwreq_actual
r_static
id|ccw_req_t
op_star
id|ccwreq_actual
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|ccwchain_lock
r_static
id|spinlock_t
id|ccwchain_lock
suffix:semicolon
multiline_comment|/* pointer to debug area */
DECL|variable|debug_area
r_static
id|debug_info_t
op_star
id|debug_area
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* SECTION: Handling of the dynamically allocated kmem slabs */
multiline_comment|/* a name template for the cache-names */
DECL|variable|ccw_name_template
r_static
r_char
id|ccw_name_template
(braket
)braket
op_assign
l_string|&quot;ccwcache-&bslash;0&bslash;0&bslash;0&bslash;0&quot;
suffix:semicolon
multiline_comment|/* fill name with zeroes! */
multiline_comment|/* the cache&squot;s names */
DECL|variable|ccw_cache_name
r_static
r_char
id|ccw_cache_name
(braket
id|CCW_NUMBER_CACHES
)braket
(braket
r_sizeof
(paren
id|ccw_name_template
)paren
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* the caches itself*/
DECL|variable|ccw_cache
r_static
id|kmem_cache_t
op_star
id|ccw_cache
(braket
id|CCW_NUMBER_CACHES
)braket
suffix:semicolon
multiline_comment|/* SECTION: (de)allocation of ccw_req_t */
multiline_comment|/* &n; * void enchain ( ccw_req_t *request )&n; * enchains the request to the ringbuffer&n; */
r_static
r_inline
r_void
DECL|function|enchain
id|enchain
(paren
id|ccw_req_t
op_star
id|request
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|request
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ccwchain_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccwreq_actual
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* queue empty */
id|ccwreq_actual
op_assign
id|request
suffix:semicolon
id|request-&gt;int_prev
op_assign
id|ccwreq_actual
suffix:semicolon
id|request-&gt;int_next
op_assign
id|ccwreq_actual
suffix:semicolon
)brace
r_else
(brace
id|request-&gt;int_next
op_assign
id|ccwreq_actual
suffix:semicolon
id|request-&gt;int_prev
op_assign
id|ccwreq_actual-&gt;int_prev
suffix:semicolon
id|request-&gt;int_prev-&gt;int_next
op_assign
id|request
suffix:semicolon
id|request-&gt;int_next-&gt;int_prev
op_assign
id|request
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ccwchain_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * void dechain ( ccw_req_t *request )&n; * dechains the request from the ringbuffer&n; */
r_static
r_inline
r_void
DECL|function|dechain
id|dechain
(paren
id|ccw_req_t
op_star
id|request
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|request
op_eq
l_int|NULL
op_logical_or
id|request-&gt;int_next
op_eq
l_int|NULL
op_logical_or
id|request-&gt;int_prev
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* first deallocate request from list of allocates requests */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ccwchain_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request
op_member_access_from_pointer
id|int_next
op_eq
id|request
op_member_access_from_pointer
id|int_prev
)paren
(brace
id|ccwreq_actual
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ccwreq_actual
op_eq
id|request
)paren
(brace
id|ccwreq_actual
op_assign
id|request-&gt;int_next
suffix:semicolon
)brace
id|request-&gt;int_prev-&gt;int_next
op_assign
id|request-&gt;int_next
suffix:semicolon
id|request-&gt;int_next-&gt;int_prev
op_assign
id|request-&gt;int_prev
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ccwchain_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * ccw_req_t *ccw_alloc_request ( int cplength, int datasize )&n; * allocates a ccw_req_t, that &n; * - can hold a CP of cplength CCWS&n; * - can hold additional data up to datasize &n; */
id|ccw_req_t
op_star
DECL|function|ccw_alloc_request
id|ccw_alloc_request
(paren
r_char
op_star
id|magic
comma
r_int
id|cplength
comma
r_int
id|datasize
)paren
(brace
id|ccw_req_t
op_star
id|request
op_assign
l_int|NULL
suffix:semicolon
r_int
id|size_needed
suffix:semicolon
r_int
id|data_offset
comma
id|ccw_offset
suffix:semicolon
r_int
id|cachind
suffix:semicolon
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|magic
op_eq
l_int|NULL
op_logical_or
id|datasize
OG
id|PAGE_SIZE
op_logical_or
id|cplength
op_eq
l_int|0
op_logical_or
(paren
id|cplength
op_star
r_sizeof
(paren
id|ccw1_t
)paren
)paren
OG
id|PAGE_SIZE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|debug_text_event
(paren
id|debug_area
comma
l_int|1
comma
l_string|&quot;ALLC&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|debug_area
comma
l_int|1
comma
id|magic
)paren
suffix:semicolon
id|debug_int_event
(paren
id|debug_area
comma
l_int|1
comma
id|cplength
)paren
suffix:semicolon
id|debug_int_event
(paren
id|debug_area
comma
l_int|1
comma
id|datasize
)paren
suffix:semicolon
multiline_comment|/* We try to keep things together in memory */
id|size_needed
op_assign
(paren
r_sizeof
(paren
id|ccw_req_t
)paren
op_plus
l_int|7
)paren
op_amp
op_minus
l_int|8
suffix:semicolon
id|data_offset
op_assign
id|ccw_offset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|size_needed
op_plus
id|datasize
op_le
id|PAGE_SIZE
)paren
(brace
multiline_comment|/* Keep data with the request */
id|data_offset
op_assign
id|size_needed
suffix:semicolon
id|size_needed
op_add_assign
(paren
id|datasize
op_plus
l_int|7
)paren
op_amp
op_minus
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size_needed
op_plus
id|cplength
op_star
r_sizeof
(paren
id|ccw1_t
)paren
op_le
id|PAGE_SIZE
)paren
(brace
multiline_comment|/* Keep CCWs with request */
id|ccw_offset
op_assign
id|size_needed
suffix:semicolon
id|size_needed
op_add_assign
id|cplength
op_star
r_sizeof
(paren
id|ccw1_t
)paren
suffix:semicolon
)brace
multiline_comment|/* determine cache index for the requested size */
r_for
c_loop
(paren
id|cachind
op_assign
l_int|0
suffix:semicolon
id|cachind
OL
id|CCW_NUMBER_CACHES
suffix:semicolon
id|cachind
op_increment
)paren
r_if
c_cond
(paren
id|size_needed
OL
(paren
id|SMALLEST_SLAB
op_lshift
id|cachind
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Try to fulfill the request from a cache */
r_if
c_cond
(paren
id|ccw_cache
(braket
id|cachind
)braket
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|request
op_assign
id|kmem_cache_alloc
(paren
id|ccw_cache
(braket
id|cachind
)braket
comma
id|CCW_CACHE_TYPE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
(paren
id|request
comma
l_int|0
comma
(paren
id|SMALLEST_SLAB
op_lshift
id|cachind
)paren
)paren
suffix:semicolon
id|request-&gt;cache
op_assign
id|ccw_cache
(braket
id|cachind
)braket
suffix:semicolon
multiline_comment|/* Allocate memory for the extra data */
r_if
c_cond
(paren
id|data_offset
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Allocated memory for extra data with kmalloc */
id|request-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
id|datasize
comma
id|CCW_CACHE_TYPE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;data
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;Couldn&squot;t allocate data area&bslash;n&quot;
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|request-&gt;cache
comma
id|request
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* Extra data already allocated with the request */
id|request-&gt;data
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|request
op_plus
id|data_offset
)paren
suffix:semicolon
multiline_comment|/* Allocate memory for the channel program */
r_if
c_cond
(paren
id|ccw_offset
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Allocated memory for the channel program with kmalloc */
id|request-&gt;cpaddr
op_assign
(paren
id|ccw1_t
op_star
)paren
id|kmalloc
c_func
(paren
id|cplength
op_star
r_sizeof
(paren
id|ccw1_t
)paren
comma
id|CCW_CACHE_TYPE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;cpaddr
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
id|PRINTK_HEADER
l_string|&quot;Couldn&squot;t allocate ccw area&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_offset
op_eq
l_int|0
)paren
id|kfree
c_func
(paren
id|request-&gt;data
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|request-&gt;cache
comma
id|request
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* Channel program already allocated with the request */
id|request-&gt;cpaddr
op_assign
(paren
id|ccw1_t
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|request
op_plus
id|ccw_offset
)paren
suffix:semicolon
id|memset
(paren
id|request-&gt;data
comma
l_int|0
comma
id|datasize
)paren
suffix:semicolon
id|memset
(paren
id|request-&gt;cpaddr
comma
l_int|0
comma
id|cplength
op_star
r_sizeof
(paren
id|ccw1_t
)paren
)paren
suffix:semicolon
id|strncpy
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|request-&gt;magic
)paren
comma
id|magic
comma
l_int|4
)paren
suffix:semicolon
id|ASCEBC
c_func
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|request-&gt;magic
)paren
comma
l_int|4
)paren
suffix:semicolon
id|request
op_member_access_from_pointer
id|cplength
op_assign
id|cplength
suffix:semicolon
id|request
op_member_access_from_pointer
id|datasize
op_assign
id|datasize
suffix:semicolon
multiline_comment|/* enqueue request to list of allocated requests */
id|enchain
c_func
(paren
id|request
)paren
suffix:semicolon
id|debug_int_event
(paren
id|debug_area
comma
l_int|1
comma
(paren
r_int
)paren
id|request
)paren
suffix:semicolon
r_return
id|request
suffix:semicolon
)brace
multiline_comment|/* &n; * void ccw_free_request ( ccw_req_t * )&n; * deallocates the ccw_req_t, given as argument&n; */
r_void
DECL|function|ccw_free_request
id|ccw_free_request
(paren
id|ccw_req_t
op_star
id|request
)paren
(brace
r_int
id|size_needed
suffix:semicolon
id|debug_text_event
(paren
id|debug_area
comma
l_int|1
comma
l_string|&quot;FREE&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|debug_area
comma
l_int|1
comma
(paren
r_int
)paren
id|request
)paren
suffix:semicolon
multiline_comment|/* Sanity checks */
r_if
c_cond
(paren
id|request
op_eq
l_int|NULL
op_logical_or
id|request-&gt;cache
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|dechain
(paren
id|request
)paren
suffix:semicolon
multiline_comment|/* Free memory allocated with kmalloc&n;         * make the same decisions as in ccw_alloc_requets */
id|size_needed
op_assign
(paren
r_sizeof
(paren
id|ccw_req_t
)paren
op_plus
l_int|7
)paren
op_amp
op_minus
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|size_needed
op_plus
id|request-&gt;datasize
op_le
id|PAGE_SIZE
)paren
multiline_comment|/* We kept the data with the request */
id|size_needed
op_add_assign
(paren
id|request-&gt;datasize
op_plus
l_int|7
)paren
op_amp
op_minus
l_int|8
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|request-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size_needed
op_plus
id|request-&gt;cplength
op_star
r_sizeof
(paren
id|ccw1_t
)paren
OG
id|PAGE_SIZE
)paren
multiline_comment|/* We kept the CCWs with request */
id|kfree
c_func
(paren
id|request-&gt;cpaddr
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|request
op_member_access_from_pointer
id|cache
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/* SECTION: initialization and cleanup functions */
multiline_comment|/* &n; * ccwcache_init&n; * called as an initializer function for the ccw memory management&n; */
r_int
DECL|function|ccwcache_init
id|ccwcache_init
(paren
r_void
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|cachind
suffix:semicolon
multiline_comment|/* initialize variables */
id|spin_lock_init
c_func
(paren
op_amp
id|ccwchain_lock
)paren
suffix:semicolon
multiline_comment|/* allocate a debug area */
id|debug_area
op_assign
id|debug_register
c_func
(paren
l_string|&quot;ccwcache&quot;
comma
l_int|2
comma
l_int|4
comma
r_sizeof
(paren
r_void
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_area
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|debug_area
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|debug_area
comma
op_amp
id|debug_raw_view
)paren
suffix:semicolon
id|debug_text_event
(paren
id|debug_area
comma
l_int|0
comma
l_string|&quot;INIT&quot;
)paren
suffix:semicolon
multiline_comment|/* First allocate the kmem caches */
r_for
c_loop
(paren
id|cachind
op_assign
l_int|0
suffix:semicolon
id|cachind
OL
id|CCW_NUMBER_CACHES
suffix:semicolon
id|cachind
op_increment
)paren
(brace
r_int
id|slabsize
op_assign
id|SMALLEST_SLAB
op_lshift
id|cachind
suffix:semicolon
id|debug_text_event
(paren
id|debug_area
comma
l_int|1
comma
l_string|&quot;allc&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|debug_area
comma
l_int|1
comma
id|slabsize
)paren
suffix:semicolon
id|sprintf
(paren
id|ccw_cache_name
(braket
id|cachind
)braket
comma
l_string|&quot;%s%d%c&quot;
comma
id|ccw_name_template
comma
id|slabsize
comma
l_int|0
)paren
suffix:semicolon
id|ccw_cache
(braket
id|cachind
)braket
op_assign
id|kmem_cache_create
c_func
(paren
id|ccw_cache_name
(braket
id|cachind
)braket
comma
id|slabsize
comma
l_int|0
comma
id|CCW_CACHE_SLAB_TYPE
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|debug_int_event
(paren
id|debug_area
comma
l_int|1
comma
(paren
r_int
)paren
id|ccw_cache
(braket
id|cachind
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccw_cache
(braket
id|cachind
)braket
op_eq
l_int|NULL
)paren
id|panic
(paren
l_string|&quot;Allocation of CCW cache failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* &n; * ccwcache_cleanup&n; * called as a cleanup function for the ccw memory management&n; */
r_void
DECL|function|ccwcache_cleanup
id|ccwcache_cleanup
(paren
r_void
)paren
(brace
r_int
id|cachind
suffix:semicolon
multiline_comment|/* Shrink the caches, if available */
r_for
c_loop
(paren
id|cachind
op_assign
l_int|0
suffix:semicolon
id|cachind
OL
id|CCW_NUMBER_CACHES
suffix:semicolon
id|cachind
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ccw_cache
(braket
id|cachind
)braket
)paren
(brace
r_if
c_cond
(paren
id|kmem_cache_shrink
c_func
(paren
id|ccw_cache
(braket
id|cachind
)braket
)paren
op_eq
l_int|0
)paren
(brace
id|ccw_cache
(braket
id|cachind
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kmem_cache_destroy
c_func
(paren
id|ccw_cache
(braket
id|cachind
)braket
)paren
suffix:semicolon
)brace
)brace
id|debug_unregister
c_func
(paren
id|debug_area
)paren
suffix:semicolon
)brace
DECL|variable|ccw_alloc_request
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_alloc_request
)paren
suffix:semicolon
DECL|variable|ccw_free_request
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_free_request
)paren
suffix:semicolon
eof
