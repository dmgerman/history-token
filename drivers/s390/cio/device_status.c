multiline_comment|/*&n; * drivers/s390/cio/device_status.c&n; *&n; *    Copyright (C) 2002 IBM Deutschland Entwicklung GmbH,&n; *&t;&t;&t; IBM Corporation&n; *    Author(s): Cornelia Huck(cohuck@de.ibm.com)&n; *&t;&t; Martin Schwidefsky (schwidefsky@de.ibm.com)&n; *&n; * Status accumulation and basic sense functions.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/cio.h&gt;
macro_line|#include &quot;cio.h&quot;
macro_line|#include &quot;cio_debug.h&quot;
macro_line|#include &quot;css.h&quot;
macro_line|#include &quot;device.h&quot;
macro_line|#include &quot;ioasm.h&quot;
multiline_comment|/*&n; * Check for any kind of channel or interface control check but don&squot;t&n; * issue the message for the console device&n; */
r_static
r_inline
r_void
DECL|function|ccw_device_msg_control_check
id|ccw_device_msg_control_check
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|irb-&gt;scsw.cstat
op_amp
(paren
id|SCHN_STAT_CHN_DATA_CHK
op_or
id|SCHN_STAT_CHN_CTRL_CHK
op_or
id|SCHN_STAT_INTF_CTRL_CHK
)paren
)paren
)paren
r_return
suffix:semicolon
id|CIO_MSG_EVENT
c_func
(paren
l_int|0
comma
l_string|&quot;Channel-Check or Interface-Control-Check &quot;
l_string|&quot;received&bslash;n&quot;
l_string|&quot; ... device %04X on subchannel %04X, dev_stat &quot;
l_string|&quot;: %02X sch_stat : %02X&bslash;n&quot;
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irq
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.scsw.dstat
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.scsw.cstat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irb-&gt;scsw.cc
op_ne
l_int|3
)paren
(brace
r_char
id|dbf_text
(braket
l_int|15
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;chk%x&quot;
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irq
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|0
comma
id|dbf_text
)paren
suffix:semicolon
id|CIO_HEX_EVENT
c_func
(paren
l_int|0
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb
comma
r_sizeof
(paren
r_struct
id|irb
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Some paths became not operational (pno bit in scsw is set).&n; */
r_static
r_void
DECL|function|ccw_device_path_notoper
id|ccw_device_path_notoper
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|stsch
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
suffix:semicolon
id|CIO_MSG_EVENT
c_func
(paren
l_int|0
comma
l_string|&quot;%s(%04X) - path(s) %02x are &quot;
l_string|&quot;not operational &bslash;n&quot;
comma
id|__FUNCTION__
comma
id|sch-&gt;irq
comma
id|sch-&gt;schib.pmcw.pnom
)paren
suffix:semicolon
id|sch-&gt;lpm
op_and_assign
op_complement
id|sch-&gt;schib.pmcw.pnom
suffix:semicolon
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|DEV_EVENT_VERIFY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy valid bits from the extended control word to device irb.&n; */
r_static
r_inline
r_void
DECL|function|ccw_device_accumulate_ecw
id|ccw_device_accumulate_ecw
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
multiline_comment|/*&n;&t; * Copy extended control bit if it is valid... yes there&n;&t; * are condition that have to be met for the extended control&n;&t; * bit to have meaning. Sick.&n;&t; */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.scsw.ectl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_ALERT_STATUS
)paren
op_logical_and
op_logical_neg
(paren
id|irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_INTER_STATUS
)paren
)paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.scsw.ectl
op_assign
id|irb-&gt;scsw.ectl
suffix:semicolon
multiline_comment|/* Check if extended control word is valid. */
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.scsw.ectl
)paren
r_return
suffix:semicolon
multiline_comment|/* Copy concurrent sense / model dependent information. */
id|memcpy
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.ecw
comma
id|irb-&gt;ecw
comma
r_sizeof
(paren
id|irb-&gt;ecw
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy valid bits from the extended status word to device irb.&n; */
r_static
r_inline
r_void
DECL|function|ccw_device_accumulate_esw
id|ccw_device_accumulate_esw
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|irb
op_star
id|cdev_irb
suffix:semicolon
r_struct
id|sublog
op_star
id|cdev_sublog
comma
op_star
id|sublog
suffix:semicolon
multiline_comment|/* Check if extended status word is valid. */
r_if
c_cond
(paren
id|irb-&gt;scsw.eswf
op_logical_and
id|irb-&gt;scsw.stctl
op_eq
id|SCSW_STCTL_STATUS_PEND
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_INTER_STATUS
op_or
id|SCSW_STCTL_STATUS_PEND
)paren
op_logical_and
op_logical_neg
(paren
id|irb-&gt;scsw.actl
op_amp
id|SCSW_ACTL_SUSPENDED
)paren
)paren
r_return
suffix:semicolon
id|cdev_irb
op_assign
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb
suffix:semicolon
multiline_comment|/* Copy last path used mask. */
id|cdev_irb-&gt;esw.esw1.lpum
op_assign
id|irb-&gt;esw.esw1.lpum
suffix:semicolon
multiline_comment|/* Copy subchannel logout information if esw is of format 0. */
r_if
c_cond
(paren
id|irb-&gt;scsw.eswf
)paren
(brace
id|cdev_sublog
op_assign
op_amp
id|cdev_irb-&gt;esw.esw0.sublog
suffix:semicolon
id|sublog
op_assign
op_amp
id|irb-&gt;esw.esw0.sublog
suffix:semicolon
multiline_comment|/* Copy extended status flags. */
id|cdev_sublog-&gt;esf
op_assign
id|sublog-&gt;esf
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Copy fields that have a meaning for channel data check&n;&t;&t; * channel control check and interface control check.&n;&t;&t; */
r_if
c_cond
(paren
id|irb-&gt;scsw.cstat
op_amp
(paren
id|SCHN_STAT_CHN_DATA_CHK
op_or
id|SCHN_STAT_CHN_CTRL_CHK
op_or
id|SCHN_STAT_INTF_CTRL_CHK
)paren
)paren
(brace
multiline_comment|/* Copy ancillary report bit. */
id|cdev_sublog-&gt;arep
op_assign
id|sublog-&gt;arep
suffix:semicolon
multiline_comment|/* Copy field-validity-flags. */
id|cdev_sublog-&gt;fvf
op_assign
id|sublog-&gt;fvf
suffix:semicolon
multiline_comment|/* Copy storage access code. */
id|cdev_sublog-&gt;sacc
op_assign
id|sublog-&gt;sacc
suffix:semicolon
multiline_comment|/* Copy termination code. */
id|cdev_sublog-&gt;termc
op_assign
id|sublog-&gt;termc
suffix:semicolon
multiline_comment|/* Copy sequence code. */
id|cdev_sublog-&gt;seqc
op_assign
id|sublog-&gt;seqc
suffix:semicolon
)brace
multiline_comment|/* Copy device status check. */
id|cdev_sublog-&gt;devsc
op_assign
id|sublog-&gt;devsc
suffix:semicolon
multiline_comment|/* Copy secondary error. */
id|cdev_sublog-&gt;serr
op_assign
id|sublog-&gt;serr
suffix:semicolon
multiline_comment|/* Copy i/o-error alert. */
id|cdev_sublog-&gt;ioerr
op_assign
id|sublog-&gt;ioerr
suffix:semicolon
multiline_comment|/* Copy channel path timeout bit. */
r_if
c_cond
(paren
id|irb-&gt;scsw.cstat
op_amp
id|SCHN_STAT_INTF_CTRL_CHK
)paren
id|cdev_irb-&gt;esw.esw0.erw.cpt
op_assign
id|irb-&gt;esw.esw0.erw.cpt
suffix:semicolon
multiline_comment|/* Copy failing storage address validity flag. */
id|cdev_irb-&gt;esw.esw0.erw.fsavf
op_assign
id|irb-&gt;esw.esw0.erw.fsavf
suffix:semicolon
r_if
c_cond
(paren
id|cdev_irb-&gt;esw.esw0.erw.fsavf
)paren
(brace
multiline_comment|/* ... and copy the failing storage address. */
id|memcpy
c_func
(paren
id|cdev_irb-&gt;esw.esw0.faddr
comma
id|irb-&gt;esw.esw0.faddr
comma
r_sizeof
(paren
id|irb-&gt;esw.esw0.faddr
)paren
)paren
suffix:semicolon
multiline_comment|/* ... and copy the failing storage address format. */
id|cdev_irb-&gt;esw.esw0.erw.fsaf
op_assign
id|irb-&gt;esw.esw0.erw.fsaf
suffix:semicolon
)brace
multiline_comment|/* Copy secondary ccw address validity bit. */
id|cdev_irb-&gt;esw.esw0.erw.scavf
op_assign
id|irb-&gt;esw.esw0.erw.scavf
suffix:semicolon
r_if
c_cond
(paren
id|irb-&gt;esw.esw0.erw.scavf
)paren
multiline_comment|/* ... and copy the secondary ccw address. */
id|cdev_irb-&gt;esw.esw0.saddr
op_assign
id|irb-&gt;esw.esw0.saddr
suffix:semicolon
)brace
multiline_comment|/* FIXME: DCTI for format 2? */
multiline_comment|/* Copy authorization bit. */
id|cdev_irb-&gt;esw.esw0.erw.auth
op_assign
id|irb-&gt;esw.esw0.erw.auth
suffix:semicolon
multiline_comment|/* Copy path verification required flag. FIXME: how to verify ?? */
id|cdev_irb-&gt;esw.esw0.erw.pvrf
op_assign
id|irb-&gt;esw.esw0.erw.pvrf
suffix:semicolon
multiline_comment|/* Copy concurrent sense bit. */
id|cdev_irb-&gt;esw.esw0.erw.cons
op_assign
id|irb-&gt;esw.esw0.erw.cons
suffix:semicolon
r_if
c_cond
(paren
id|irb-&gt;esw.esw0.erw.cons
)paren
id|cdev_irb-&gt;esw.esw0.erw.scnt
op_assign
id|irb-&gt;esw.esw0.erw.scnt
suffix:semicolon
)brace
multiline_comment|/*&n; * Accumulate status from irb to devstat.&n; */
r_void
DECL|function|ccw_device_accumulate_irb
id|ccw_device_accumulate_irb
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|irb
op_star
id|cdev_irb
suffix:semicolon
multiline_comment|/*&n;&t; * Check if the status pending bit is set in stctl.&n;&t; * If not, the remaining bit have no meaning and we must ignore them.&n;&t; * The esw is not meaningful as well...&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Check for channel checks and interface control checks. */
id|ccw_device_msg_control_check
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
multiline_comment|/* Check for path not operational. */
r_if
c_cond
(paren
id|irb-&gt;scsw.pno
op_logical_and
id|irb-&gt;scsw.fctl
op_ne
l_int|0
op_logical_and
(paren
op_logical_neg
(paren
id|irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_INTER_STATUS
)paren
op_logical_or
(paren
id|irb-&gt;scsw.actl
op_amp
id|SCSW_ACTL_SUSPENDED
)paren
)paren
)paren
id|ccw_device_path_notoper
c_func
(paren
id|cdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Don&squot;t accumulate unsolicited interrupts.&n;&t; */
r_if
c_cond
(paren
id|irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_STATUS_PEND
op_or
id|SCSW_STCTL_ALERT_STATUS
)paren
)paren
r_return
suffix:semicolon
id|cdev_irb
op_assign
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb
suffix:semicolon
multiline_comment|/* Copy bits which are valid only for the start function. */
r_if
c_cond
(paren
id|irb-&gt;scsw.fctl
op_amp
id|SCSW_FCTL_START_FUNC
)paren
(brace
multiline_comment|/* Copy key. */
id|cdev_irb-&gt;scsw.key
op_assign
id|irb-&gt;scsw.key
suffix:semicolon
multiline_comment|/* Copy suspend control bit. */
id|cdev_irb-&gt;scsw.sctl
op_assign
id|irb-&gt;scsw.sctl
suffix:semicolon
multiline_comment|/* Copy deferred condition code. */
id|cdev_irb-&gt;scsw.cc
op_assign
id|irb-&gt;scsw.cc
suffix:semicolon
multiline_comment|/* Copy ccw format bit. */
id|cdev_irb-&gt;scsw.fmt
op_assign
id|irb-&gt;scsw.fmt
suffix:semicolon
multiline_comment|/* Copy prefetch bit. */
id|cdev_irb-&gt;scsw.pfch
op_assign
id|irb-&gt;scsw.pfch
suffix:semicolon
multiline_comment|/* Copy initial-status-interruption-control. */
id|cdev_irb-&gt;scsw.isic
op_assign
id|irb-&gt;scsw.isic
suffix:semicolon
multiline_comment|/* Copy address limit checking control. */
id|cdev_irb-&gt;scsw.alcc
op_assign
id|irb-&gt;scsw.alcc
suffix:semicolon
multiline_comment|/* Copy suppress suspend bit. */
id|cdev_irb-&gt;scsw.ssi
op_assign
id|irb-&gt;scsw.ssi
suffix:semicolon
)brace
multiline_comment|/* Take care of the extended control bit and extended control word. */
id|ccw_device_accumulate_ecw
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
multiline_comment|/* Accumulate function control. */
id|cdev_irb-&gt;scsw.fctl
op_or_assign
id|irb-&gt;scsw.fctl
suffix:semicolon
multiline_comment|/* Copy activity control. */
id|cdev_irb-&gt;scsw.actl
op_assign
id|irb-&gt;scsw.actl
suffix:semicolon
multiline_comment|/* Accumulate status control. */
id|cdev_irb-&gt;scsw.stctl
op_or_assign
id|irb-&gt;scsw.stctl
suffix:semicolon
multiline_comment|/*&n;&t; * Copy ccw address if it is valid. This is a bit simplified&n;&t; * but should be close enough for all practical purposes.&n;&t; */
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_PRIM_STATUS
)paren
op_logical_or
(paren
(paren
id|irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_INTER_STATUS
op_or
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
op_logical_and
(paren
id|irb-&gt;scsw.actl
op_amp
id|SCSW_ACTL_DEVACT
)paren
op_logical_and
(paren
id|irb-&gt;scsw.actl
op_amp
id|SCSW_ACTL_SCHACT
)paren
)paren
op_logical_or
(paren
id|irb-&gt;scsw.actl
op_amp
id|SCSW_ACTL_SUSPENDED
)paren
)paren
id|cdev_irb-&gt;scsw.cpa
op_assign
id|irb-&gt;scsw.cpa
suffix:semicolon
multiline_comment|/* Accumulate device status, but not the device busy flag. */
id|cdev_irb-&gt;scsw.dstat
op_and_assign
op_complement
id|DEV_STAT_BUSY
suffix:semicolon
id|cdev_irb-&gt;scsw.dstat
op_or_assign
id|irb-&gt;scsw.dstat
suffix:semicolon
multiline_comment|/* Accumulate subchannel status. */
id|cdev_irb-&gt;scsw.cstat
op_or_assign
id|irb-&gt;scsw.cstat
suffix:semicolon
multiline_comment|/* Copy residual count if it is valid. */
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_PRIM_STATUS
)paren
op_logical_and
(paren
id|irb-&gt;scsw.cstat
op_amp
op_complement
(paren
id|SCHN_STAT_PCI
op_or
id|SCHN_STAT_INCORR_LEN
)paren
)paren
op_eq
l_int|0
)paren
id|cdev_irb-&gt;scsw.count
op_assign
id|irb-&gt;scsw.count
suffix:semicolon
multiline_comment|/* Take care of bits in the extended status word. */
id|ccw_device_accumulate_esw
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check whether we must issue a SENSE CCW ourselves if there is no&n;&t; * concurrent sense facility installed for the subchannel.&n;&t; * No sense is required if no delayed sense is pending&n;&t; * and we did not get a unit check without sense information.&n;&t; *&n;&t; * Note: We should check for ioinfo[irq]-&gt;flags.consns but VM&n;&t; *&t; violates the ESA/390 architecture and doesn&squot;t present an&n;&t; *&t; operand exception for virtual devices without concurrent&n;&t; *&t; sense facility available/supported when enabling the&n;&t; *&t; concurrent sense facility.&n;&t; */
r_if
c_cond
(paren
(paren
id|cdev_irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
op_logical_and
op_logical_neg
(paren
id|cdev_irb-&gt;esw.esw0.erw.cons
)paren
)paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.dosense
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Do a basic sense.&n; */
r_int
DECL|function|ccw_device_do_sense
id|ccw_device_do_sense
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
multiline_comment|/* A sense is required, can we do it now ? */
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.actl
op_amp
(paren
id|SCSW_ACTL_DEVACT
op_or
id|SCSW_ACTL_SCHACT
)paren
)paren
op_ne
l_int|0
)paren
multiline_comment|/*&n;&t;&t; * we received an Unit Check but we have no final&n;&t;&t; *  status yet, therefore we must delay the SENSE&n;&t;&t; *  processing. We must not report this intermediate&n;&t;&t; *  status to the device interrupt handler.&n;&t;&t; */
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/*&n;&t; * We have ending status but no sense information. Do a basic sense.&n;&t; */
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|sch-&gt;sense_ccw.cmd_code
op_assign
id|CCW_CMD_BASIC_SENSE
suffix:semicolon
id|sch-&gt;sense_ccw.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.ecw
)paren
suffix:semicolon
id|sch-&gt;sense_ccw.count
op_assign
id|SENSE_MAX_COUNT
suffix:semicolon
id|sch-&gt;sense_ccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
multiline_comment|/* 0xe2C5D5E2 == &quot;SENS&quot; in ebcdic */
r_return
id|cio_start
(paren
id|sch
comma
op_amp
id|sch-&gt;sense_ccw
comma
l_int|0xE2C5D5E2
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Add information from basic sense to devstat.&n; */
r_void
DECL|function|ccw_device_accumulate_basic_sense
id|ccw_device_accumulate_basic_sense
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
multiline_comment|/*&n;&t; * Check if the status pending bit is set in stctl.&n;&t; * If not, the remaining bit have no meaning and we must ignore them.&n;&t; * The esw is not meaningful as well...&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Check for channel checks and interface control checks. */
id|ccw_device_msg_control_check
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
multiline_comment|/* Check for path not operational. */
r_if
c_cond
(paren
id|irb-&gt;scsw.pno
op_logical_and
id|irb-&gt;scsw.fctl
op_ne
l_int|0
op_logical_and
(paren
op_logical_neg
(paren
id|irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_INTER_STATUS
)paren
op_logical_or
(paren
id|irb-&gt;scsw.actl
op_amp
id|SCSW_ACTL_SUSPENDED
)paren
)paren
)paren
id|ccw_device_path_notoper
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.esw.esw0.erw.cons
op_assign
l_int|1
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.dosense
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This function accumulates the status into the private devstat and&n; * starts a basic sense if one is needed.&n; */
r_int
DECL|function|ccw_device_accumulate_and_sense
id|ccw_device_accumulate_and_sense
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
id|ccw_device_accumulate_irb
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.actl
op_amp
(paren
id|SCSW_ACTL_DEVACT
op_or
id|SCSW_ACTL_SCHACT
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Check for basic sense. */
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.dosense
op_logical_and
op_logical_neg
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.esw.esw0.erw.cons
op_assign
l_int|1
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.dosense
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.dosense
)paren
(brace
id|ccw_device_do_sense
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
