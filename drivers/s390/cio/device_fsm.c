multiline_comment|/*&n; * drivers/s390/cio/device_fsm.c&n; * finite state machine for device handling&n; *&n; *    Copyright (C) 2002 IBM Deutschland Entwicklung GmbH,&n; *&t;&t;&t; IBM Corporation&n; *    Author(s): Cornelia Huck(cohuck@de.ibm.com)&n; *&t;&t; Martin Schwidefsky (schwidefsky@de.ibm.com)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/qdio.h&gt;
macro_line|#include &quot;cio.h&quot;
macro_line|#include &quot;cio_debug.h&quot;
macro_line|#include &quot;css.h&quot;
macro_line|#include &quot;device.h&quot;
macro_line|#include &quot;chsc.h&quot;
macro_line|#include &quot;ioasm.h&quot;
macro_line|#include &quot;qdio.h&quot;
r_int
DECL|function|device_is_disconnected
id|device_is_disconnected
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;dev.driver_data
)paren
r_return
l_int|0
suffix:semicolon
id|cdev
op_assign
id|sch-&gt;dev.driver_data
suffix:semicolon
r_return
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_DISCONNECTED
op_logical_or
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_DISCONNECTED_SENSE_ID
)paren
suffix:semicolon
)brace
r_void
DECL|function|device_set_disconnected
id|device_set_disconnected
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;dev.driver_data
)paren
r_return
suffix:semicolon
id|cdev
op_assign
id|sch-&gt;dev.driver_data
suffix:semicolon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_DISCONNECTED
suffix:semicolon
)brace
r_void
DECL|function|device_set_waiting
id|device_set_waiting
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;dev.driver_data
)paren
r_return
suffix:semicolon
id|cdev
op_assign
id|sch-&gt;dev.driver_data
suffix:semicolon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|10
op_star
id|HZ
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_WAIT4IO
suffix:semicolon
)brace
multiline_comment|/*&n; * Timeout function. It just triggers a DEV_EVENT_TIMEOUT.&n; */
r_static
r_void
DECL|function|ccw_device_timeout
id|ccw_device_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
id|cdev
op_assign
(paren
r_struct
id|ccw_device
op_star
)paren
id|data
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|DEV_EVENT_TIMEOUT
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set timeout&n; */
r_void
DECL|function|ccw_device_set_timeout
id|ccw_device_set_timeout
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|expires
)paren
(brace
r_if
c_cond
(paren
id|expires
op_eq
l_int|0
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|timer
)paren
)paren
(brace
r_if
c_cond
(paren
id|mod_timer
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|timer
comma
id|jiffies
op_plus
id|expires
)paren
)paren
r_return
suffix:semicolon
)brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|timer.function
op_assign
id|ccw_device_timeout
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|timer.data
op_assign
(paren
r_int
r_int
)paren
id|cdev
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|timer.expires
op_assign
id|jiffies
op_plus
id|expires
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Kill any pending timers after machine check. */
r_void
DECL|function|device_kill_pending_timer
id|device_kill_pending_timer
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;dev.driver_data
)paren
r_return
suffix:semicolon
id|cdev
op_assign
id|sch-&gt;dev.driver_data
suffix:semicolon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Cancel running i/o. This is called repeatedly since halt/clear are&n; * asynchronous operations. We do one try with cio_cancel, two tries&n; * with cio_halt, 255 tries with cio_clear. If everythings fails panic.&n; * Returns 0 if device now idle, -ENODEV for device not operational and&n; * -EBUSY if an interrupt is expected (either from halt/clear or from a&n; * status pending).&n; */
r_int
DECL|function|ccw_device_cancel_halt_clear
id|ccw_device_cancel_halt_clear
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|ret
op_assign
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_or
op_logical_neg
id|sch-&gt;schib.pmcw.dnv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;schib.pmcw.ena
op_logical_or
id|sch-&gt;schib.scsw.actl
op_eq
l_int|0
)paren
multiline_comment|/* Not operational or no activity -&gt; done. */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Stage 1: cancel io. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sch-&gt;schib.scsw.actl
op_amp
id|SCSW_ACTL_HALT_PEND
)paren
op_logical_and
op_logical_neg
(paren
id|sch-&gt;schib.scsw.actl
op_amp
id|SCSW_ACTL_CLEAR_PEND
)paren
)paren
(brace
id|ret
op_assign
id|cio_cancel
c_func
(paren
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
op_minus
id|EINVAL
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* cancel io unsuccessful. From now on it is asynchronous. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|iretry
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* 3 halt retries. */
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sch-&gt;schib.scsw.actl
op_amp
id|SCSW_ACTL_CLEAR_PEND
)paren
)paren
(brace
multiline_comment|/* Stage 2: halt io. */
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|iretry
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|iretry
op_decrement
suffix:semicolon
id|ret
op_assign
id|cio_halt
c_func
(paren
id|sch
)paren
suffix:semicolon
r_return
(paren
id|ret
op_eq
l_int|0
)paren
ques
c_cond
op_minus
id|EBUSY
suffix:colon
id|ret
suffix:semicolon
)brace
multiline_comment|/* halt io unsuccessful. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|iretry
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* 255 clear retries. */
)brace
multiline_comment|/* Stage 3: clear io. */
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|iretry
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|iretry
op_decrement
suffix:semicolon
id|ret
op_assign
id|cio_clear
(paren
id|sch
)paren
suffix:semicolon
r_return
(paren
id|ret
op_eq
l_int|0
)paren
ques
c_cond
op_minus
id|EBUSY
suffix:colon
id|ret
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;Can&squot;t stop i/o on subchannel.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_handle_oper
id|ccw_device_handle_oper
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.recog_done
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Check if cu type and device type still match. If&n;&t; * not, it is certainly another device and we have to&n;&t; * de- and re-register. Also check here for non-matching devno.&n;&t; */
r_if
c_cond
(paren
id|cdev-&gt;id.cu_type
op_ne
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|senseid.cu_type
op_logical_or
id|cdev-&gt;id.cu_model
op_ne
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|senseid.cu_model
op_logical_or
id|cdev-&gt;id.dev_type
op_ne
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|senseid.dev_type
op_logical_or
id|cdev-&gt;id.dev_model
op_ne
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|senseid.dev_model
op_logical_or
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
op_ne
id|sch-&gt;schib.pmcw.dev
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_do_unreg_rereg
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.donotify
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * The machine won&squot;t give us any notification by machine check if a chpid has&n; * been varied online on the SE so we have to find out by magic (i. e. driving&n; * the channel subsystem to device selection and updating our path masks).&n; */
r_static
r_inline
r_void
DECL|function|__recover_lost_chpids
id|__recover_lost_chpids
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
comma
r_int
id|old_lpm
)paren
(brace
r_int
id|mask
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mask
op_assign
l_int|0x80
op_rshift
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sch-&gt;lpm
op_amp
id|mask
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|old_lpm
op_amp
id|mask
)paren
r_continue
suffix:semicolon
id|chpid_is_actually_online
c_func
(paren
id|sch-&gt;schib.pmcw.chpid
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Stop device recognition.&n; */
r_static
r_void
DECL|function|ccw_device_recog_done
id|ccw_device_recog_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|state
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|notify
comma
id|old_lpm
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
id|cio_disable_subchannel
c_func
(paren
id|sch
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now that we tried recognition, we have performed device selection&n;&t; * through ssch() and the path information is up to date.&n;&t; */
id|old_lpm
op_assign
id|sch-&gt;lpm
suffix:semicolon
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
suffix:semicolon
id|sch-&gt;lpm
op_assign
id|sch-&gt;schib.pmcw.pim
op_amp
id|sch-&gt;schib.pmcw.pam
op_amp
id|sch-&gt;schib.pmcw.pom
op_amp
id|sch-&gt;opm
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_DISCONNECTED_SENSE_ID
)paren
multiline_comment|/* Force reprobe on all chpids. */
id|old_lpm
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;lpm
op_ne
id|old_lpm
)paren
id|__recover_lost_chpids
c_func
(paren
id|sch
comma
id|old_lpm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_DISCONNECTED_SENSE_ID
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|DEV_STATE_NOT_OPER
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.recog_done
op_assign
l_int|1
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_DISCONNECTED
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Boxed devices don&squot;t need extra treatment. */
)brace
id|notify
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|DEV_STATE_NOT_OPER
suffix:colon
id|CIO_DEBUG
c_func
(paren
id|KERN_WARNING
comma
l_int|2
comma
l_string|&quot;SenseID : unknown device %04x on subchannel %04x&bslash;n&quot;
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
comma
id|sch-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_OFFLINE
suffix:colon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_DISCONNECTED_SENSE_ID
)paren
(brace
id|ccw_device_handle_oper
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|notify
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* fill out sense information */
id|cdev-&gt;id
op_assign
(paren
r_struct
id|ccw_device_id
)paren
(brace
dot
id|cu_type
op_assign
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|senseid.cu_type
comma
dot
id|cu_model
op_assign
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|senseid.cu_model
comma
dot
id|dev_type
op_assign
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|senseid.dev_type
comma
dot
id|dev_model
op_assign
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|senseid.dev_model
comma
)brace
suffix:semicolon
r_if
c_cond
(paren
id|notify
)paren
(brace
multiline_comment|/* Get device online again. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_OFFLINE
suffix:semicolon
id|ccw_device_online
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Issue device info message. */
id|CIO_DEBUG
c_func
(paren
id|KERN_INFO
comma
l_int|2
comma
l_string|&quot;SenseID : device %04x reports: &quot;
l_string|&quot;CU  Type/Mod = %04X/%02X, Dev Type/Mod = &quot;
l_string|&quot;%04X/%02X&bslash;n&quot;
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
comma
id|cdev-&gt;id.cu_type
comma
id|cdev-&gt;id.cu_model
comma
id|cdev-&gt;id.dev_type
comma
id|cdev-&gt;id.dev_model
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_BOXED
suffix:colon
id|CIO_DEBUG
c_func
(paren
id|KERN_WARNING
comma
l_int|2
comma
l_string|&quot;SenseID : boxed device %04x on subchannel %04x&bslash;n&quot;
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
comma
id|sch-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|state
suffix:semicolon
id|io_subchannel_recog_done
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
id|DEV_STATE_NOT_OPER
)paren
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function called from device_id.c after sense id has completed.&n; */
r_void
DECL|function|ccw_device_sense_id_done
id|ccw_device_sense_id_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|err
)paren
(brace
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
l_int|0
suffix:colon
id|ccw_device_recog_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_OFFLINE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ETIME
suffix:colon
multiline_comment|/* Sense id stopped by timeout. */
id|ccw_device_recog_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_BOXED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ccw_device_recog_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_NOT_OPER
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ccw_device_oper_notify
id|ccw_device_oper_notify
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|cdev
op_assign
(paren
r_struct
id|ccw_device
op_star
)paren
id|data
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|ret
op_assign
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;notify
)paren
ques
c_cond
id|sch-&gt;driver
op_member_access_from_pointer
id|notify
c_func
(paren
op_amp
id|sch-&gt;dev
comma
id|CIO_OPER
)paren
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
multiline_comment|/* Driver doesn&squot;t want device back. */
id|ccw_device_do_unreg_rereg
c_func
(paren
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
r_else
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Finished with online/offline processing.&n; */
r_static
r_void
DECL|function|ccw_device_done
id|ccw_device_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|state
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
id|DEV_STATE_ONLINE
)paren
id|cio_disable_subchannel
c_func
(paren
id|sch
)paren
suffix:semicolon
multiline_comment|/* Reset device status. */
id|memset
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|irb
)paren
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|state
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|DEV_STATE_BOXED
)paren
id|CIO_DEBUG
c_func
(paren
id|KERN_WARNING
comma
l_int|2
comma
l_string|&quot;Boxed device %04x on subchannel %04x&bslash;n&quot;
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
comma
id|sch-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.donotify
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.donotify
op_assign
l_int|0
suffix:semicolon
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_oper_notify
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_notify_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|css_init_done
op_logical_and
id|state
op_ne
id|DEV_STATE_ONLINE
)paren
id|put_device
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function called from device_pgid.c after sense path ground has completed.&n; */
r_void
DECL|function|ccw_device_sense_pgid_done
id|ccw_device_sense_pgid_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|err
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Start Path Group verification. */
id|sch-&gt;vpm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Start with no path groups set. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_VERIFY
suffix:semicolon
id|ccw_device_verify_start
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ETIME
suffix:colon
multiline_comment|/* Sense path group id stopped by timeout. */
r_case
op_minus
id|EUSERS
suffix:colon
multiline_comment|/* device is reserved for someone else. */
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_BOXED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EOPNOTSUPP
suffix:colon
multiline_comment|/* path grouping not supported, just set online. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|options.pgroup
op_assign
l_int|0
suffix:semicolon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_ONLINE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_NOT_OPER
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Start device recognition.&n; */
r_int
DECL|function|ccw_device_recognition
id|ccw_device_recognition
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_NOT_OPER
)paren
op_logical_and
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_BOXED
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|ret
op_assign
id|cio_enable_subchannel
c_func
(paren
id|sch
comma
id|sch-&gt;schib.pmcw.isc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
multiline_comment|/* Couldn&squot;t enable the subchannel for i/o. Sick device. */
r_return
id|ret
suffix:semicolon
multiline_comment|/* After 60s the device recognition is considered to have failed. */
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|60
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We used to start here with a sense pgid to find out whether a device&n;&t; * is locked by someone else. Unfortunately, the sense pgid command&n;&t; * code has other meanings on devices predating the path grouping&n;&t; * algorithm, so we start with sense id and box the device after an&n;&t; * timeout (or if sense pgid during path verification detects the device&n;&t; * is locked, as may happen on newer devices).&n;&t; */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.recog_done
op_assign
l_int|0
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_SENSE_ID
suffix:semicolon
id|ccw_device_sense_id_start
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle timeout in device recognition.&n; */
r_static
r_void
DECL|function|ccw_device_recog_timeout
id|ccw_device_recog_timeout
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|ccw_device_cancel_halt_clear
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
id|ccw_device_recog_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_BOXED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENODEV
suffix:colon
id|ccw_device_recog_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_NOT_OPER
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ccw_device_nopath_notify
id|ccw_device_nopath_notify
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|cdev
op_assign
(paren
r_struct
id|ccw_device
op_star
)paren
id|data
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
multiline_comment|/* Extra sanity. */
r_if
c_cond
(paren
id|sch-&gt;lpm
)paren
r_return
suffix:semicolon
id|ret
op_assign
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;notify
)paren
ques
c_cond
id|sch-&gt;driver
op_member_access_from_pointer
id|notify
c_func
(paren
op_amp
id|sch-&gt;dev
comma
id|CIO_NO_PATH
)paren
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_if
c_cond
(paren
id|get_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
)paren
(brace
multiline_comment|/* Driver doesn&squot;t want to keep device. */
id|cio_disable_subchannel
c_func
(paren
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_call_sch_unregister
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_else
id|put_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cio_disable_subchannel
c_func
(paren
id|sch
)paren
suffix:semicolon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_DISCONNECTED
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|ccw_device_verify_done
id|ccw_device_verify_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|err
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
op_minus
id|EOPNOTSUPP
suffix:colon
multiline_comment|/* path grouping not supported, just set online. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|options.pgroup
op_assign
l_int|0
suffix:semicolon
r_case
l_int|0
suffix:colon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_ONLINE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ETIME
suffix:colon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_BOXED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_nopath_notify
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_notify_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_NOT_OPER
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Get device online.&n; */
r_int
DECL|function|ccw_device_online
id|ccw_device_online
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_OFFLINE
)paren
op_logical_and
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_BOXED
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|css_init_done
op_logical_and
op_logical_neg
id|get_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ret
op_assign
id|cio_enable_subchannel
c_func
(paren
id|sch
comma
id|sch-&gt;schib.pmcw.isc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Couldn&squot;t enable the subchannel for i/o. Sick device. */
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENODEV
)paren
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|DEV_EVENT_NOTOPER
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Do we want to do path grouping? */
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|options.pgroup
)paren
(brace
multiline_comment|/* No, set state online immediately. */
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_ONLINE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Do a SensePGID first. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_SENSE_PGID
suffix:semicolon
id|ccw_device_sense_pgid_start
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|ccw_device_disband_done
id|ccw_device_disband_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|err
)paren
(brace
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
l_int|0
suffix:colon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_OFFLINE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ETIME
suffix:colon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_BOXED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_NOT_OPER
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Shutdown device.&n; */
r_int
DECL|function|ccw_device_offline
id|ccw_device_offline
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_ONLINE
)paren
(brace
r_if
c_cond
(paren
id|sch-&gt;schib.scsw.actl
op_ne
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sch-&gt;schib.scsw.actl
op_ne
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Are we doing path grouping? */
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|options.pgroup
)paren
(brace
multiline_comment|/* No, set state offline immediately. */
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_OFFLINE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Start Set Path Group commands. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_DISBAND_PGID
suffix:semicolon
id|ccw_device_disband_start
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle timeout in device online/offline process.&n; */
r_static
r_void
DECL|function|ccw_device_onoff_timeout
id|ccw_device_onoff_timeout
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|ccw_device_cancel_halt_clear
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_BOXED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENODEV
suffix:colon
id|ccw_device_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_NOT_OPER
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Handle not oper event in device recognition.&n; */
r_static
r_void
DECL|function|ccw_device_recog_notoper
id|ccw_device_recog_notoper
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
id|ccw_device_recog_done
c_func
(paren
id|cdev
comma
id|DEV_STATE_NOT_OPER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle not operational event while offline.&n; */
r_static
r_void
DECL|function|ccw_device_offline_notoper
id|ccw_device_offline_notoper
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_NOT_OPER
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
id|sch-&gt;schib.pmcw.intparm
op_assign
l_int|0
suffix:semicolon
id|cio_modify
c_func
(paren
id|sch
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle not operational event while online.&n; */
r_static
r_void
DECL|function|ccw_device_online_notoper
id|ccw_device_online_notoper
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;driver-&gt;notify
op_logical_and
id|sch-&gt;driver
op_member_access_from_pointer
id|notify
c_func
(paren
op_amp
id|sch-&gt;dev
comma
id|sch-&gt;lpm
ques
c_cond
id|CIO_GONE
suffix:colon
id|CIO_NO_PATH
)paren
)paren
(brace
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_DISCONNECTED
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_NOT_OPER
suffix:semicolon
id|cio_disable_subchannel
c_func
(paren
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;schib.scsw.actl
op_ne
l_int|0
)paren
(brace
singleline_comment|// FIXME: not-oper indication to device driver ?
id|ccw_device_call_handler
c_func
(paren
id|cdev
)paren
suffix:semicolon
)brace
id|device_unregister
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
id|sch-&gt;schib.pmcw.intparm
op_assign
l_int|0
suffix:semicolon
id|cio_modify
c_func
(paren
id|sch
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle path verification event.&n; */
r_static
r_void
DECL|function|ccw_device_online_verify
id|ccw_device_online_verify
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|options.pgroup
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_W4SENSE
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;schib.scsw.actl
op_ne
l_int|0
op_logical_or
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb.scsw.stctl
op_amp
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * No final status yet or final status not yet delivered&n;&t;&t; * to the device driver. Can&squot;t do path verfication now,&n;&t;&t; * delay until final status was delivered.&n;&t;&t; */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Device is idle, we can do the path verification. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_VERIFY
suffix:semicolon
id|ccw_device_verify_start
c_func
(paren
id|cdev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Got an interrupt for a normal io (state online).&n; */
r_static
r_void
DECL|function|ccw_device_irq
id|ccw_device_irq
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|irb
op_star
id|irb
suffix:semicolon
id|irb
op_assign
(paren
r_struct
id|irb
op_star
)paren
id|__LC_IRB
suffix:semicolon
multiline_comment|/* Check for unsolicited interrupt. */
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_STATUS_PEND
op_or
id|SCSW_STCTL_ALERT_STATUS
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|irb-&gt;scsw.cc
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
op_logical_and
op_logical_neg
id|irb-&gt;esw.esw0.erw.cons
)paren
(brace
multiline_comment|/* Unit check but no sense data. Need basic sense. */
r_if
c_cond
(paren
id|ccw_device_do_sense
c_func
(paren
id|cdev
comma
id|irb
)paren
op_ne
l_int|0
)paren
r_goto
id|call_handler_unsol
suffix:semicolon
id|memcpy
c_func
(paren
id|irb
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|irb
comma
r_sizeof
(paren
r_struct
id|irb
)paren
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_W4SENSE
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|intparm
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|call_handler_unsol
suffix:colon
r_if
c_cond
(paren
id|cdev-&gt;handler
)paren
id|cdev-&gt;handler
(paren
id|cdev
comma
l_int|0
comma
id|irb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Accumulate status and find out if a basic sense is needed. */
id|ccw_device_accumulate_irb
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.dosense
)paren
(brace
r_if
c_cond
(paren
id|ccw_device_do_sense
c_func
(paren
id|cdev
comma
id|irb
)paren
op_eq
l_int|0
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_W4SENSE
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Call the handler. */
r_if
c_cond
(paren
id|ccw_device_call_handler
c_func
(paren
id|cdev
)paren
op_logical_and
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
)paren
multiline_comment|/* Start delayed path verification. */
id|ccw_device_online_verify
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Got an timeout in online state.&n; */
r_static
r_void
DECL|function|ccw_device_online_timeout
id|ccw_device_online_timeout
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
id|ccw_device_cancel_halt_clear
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EBUSY
)paren
(brace
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_TIMEOUT_KILL
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENODEV
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;lpm
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_nopath_notify
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_notify_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_else
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|DEV_EVENT_NOTOPER
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cdev-&gt;handler
)paren
id|cdev
op_member_access_from_pointer
id|handler
c_func
(paren
id|cdev
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|intparm
comma
id|ERR_PTR
c_func
(paren
op_minus
id|ETIMEDOUT
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Got an interrupt for a basic sense.&n; */
r_void
DECL|function|ccw_device_w4sense
id|ccw_device_w4sense
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|irb
op_star
id|irb
suffix:semicolon
id|irb
op_assign
(paren
r_struct
id|irb
op_star
)paren
id|__LC_IRB
suffix:semicolon
multiline_comment|/* Check for unsolicited interrupt. */
r_if
c_cond
(paren
id|irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_STATUS_PEND
op_or
id|SCSW_STCTL_ALERT_STATUS
)paren
)paren
(brace
r_if
c_cond
(paren
id|irb-&gt;scsw.cc
op_eq
l_int|1
)paren
multiline_comment|/* Basic sense hasn&squot;t started. Try again. */
id|ccw_device_do_sense
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Huh? %s(%s): unsolicited interrupt...&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;handler
)paren
id|cdev-&gt;handler
(paren
id|cdev
comma
l_int|0
comma
id|irb
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Add basic sense info to irb. */
id|ccw_device_accumulate_basic_sense
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.dosense
)paren
(brace
multiline_comment|/* Another basic sense is needed. */
id|ccw_device_do_sense
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_ONLINE
suffix:semicolon
multiline_comment|/* Call the handler. */
r_if
c_cond
(paren
id|ccw_device_call_handler
c_func
(paren
id|cdev
)paren
op_logical_and
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
)paren
multiline_comment|/* Start delayed path verification. */
id|ccw_device_online_verify
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_clear_verify
id|ccw_device_clear_verify
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|irb
op_star
id|irb
suffix:semicolon
id|irb
op_assign
(paren
r_struct
id|irb
op_star
)paren
id|__LC_IRB
suffix:semicolon
multiline_comment|/* Accumulate status. We don&squot;t do basic sense. */
id|ccw_device_accumulate_irb
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
multiline_comment|/* Try to start delayed device verification. */
id|ccw_device_online_verify
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Note: Don&squot;t call handler for cio initiated clear! */
)brace
r_static
r_void
DECL|function|ccw_device_killing_irq
id|ccw_device_killing_irq
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* OK, i/o is dead now. Call interrupt handler. */
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_ONLINE
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;handler
)paren
id|cdev
op_member_access_from_pointer
id|handler
c_func
(paren
id|cdev
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|intparm
comma
id|ERR_PTR
c_func
(paren
op_minus
id|ETIMEDOUT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;lpm
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_nopath_notify
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_notify_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
)paren
multiline_comment|/* Start delayed path verification. */
id|ccw_device_online_verify
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_killing_timeout
id|ccw_device_killing_timeout
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|ccw_device_cancel_halt_clear
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EBUSY
)paren
(brace
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENODEV
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;lpm
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_nopath_notify
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_notify_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_else
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|DEV_EVENT_NOTOPER
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|//FIXME: Can we get here?
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_ONLINE
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;handler
)paren
id|cdev
op_member_access_from_pointer
id|handler
c_func
(paren
id|cdev
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|intparm
comma
id|ERR_PTR
c_func
(paren
op_minus
id|ETIMEDOUT
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_wait4io_irq
id|ccw_device_wait4io_irq
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|irb
op_star
id|irb
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|irb
op_assign
(paren
r_struct
id|irb
op_star
)paren
id|__LC_IRB
suffix:semicolon
multiline_comment|/*&n;&t; * Accumulate status and find out if a basic sense is needed.&n;&t; * This is fine since we have already adapted the lpm.&n;&t; */
id|ccw_device_accumulate_irb
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.dosense
)paren
(brace
r_if
c_cond
(paren
id|ccw_device_do_sense
c_func
(paren
id|cdev
comma
id|irb
)paren
op_eq
l_int|0
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_W4SENSE
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Iff device is idle, reset timeout. */
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
)paren
r_if
c_cond
(paren
id|sch-&gt;schib.scsw.actl
op_eq
l_int|0
)paren
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Call the handler. */
id|ccw_device_call_handler
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;lpm
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_nopath_notify
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_notify_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
)paren
id|ccw_device_online_verify
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_wait4io_timeout
id|ccw_device_wait4io_timeout
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
id|ccw_device_cancel_halt_clear
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EBUSY
)paren
(brace
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_TIMEOUT_KILL
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENODEV
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;lpm
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_nopath_notify
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_notify_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_else
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|DEV_EVENT_NOTOPER
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cdev-&gt;handler
)paren
id|cdev
op_member_access_from_pointer
id|handler
c_func
(paren
id|cdev
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|intparm
comma
id|ERR_PTR
c_func
(paren
op_minus
id|ETIMEDOUT
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;lpm
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_nopath_notify
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_notify_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
)paren
multiline_comment|/* Start delayed path verification. */
id|ccw_device_online_verify
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_wait4io_verify
id|ccw_device_wait4io_verify
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
multiline_comment|/* When the I/O has terminated, we have to start verification. */
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|options.pgroup
)paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.doverify
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_stlck_done
id|ccw_device_stlck_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|irb
op_star
id|irb
suffix:semicolon
r_switch
c_cond
(paren
id|dev_event
)paren
(brace
r_case
id|DEV_EVENT_INTERRUPT
suffix:colon
id|irb
op_assign
(paren
r_struct
id|irb
op_star
)paren
id|__LC_IRB
suffix:semicolon
multiline_comment|/* Check for unsolicited interrupt. */
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_STATUS_PEND
op_or
id|SCSW_STCTL_ALERT_STATUS
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|irb-&gt;scsw.cc
)paren
)paren
multiline_comment|/* FIXME: we should restart stlck here, but this&n;&t;&t;&t; * is extremely unlikely ... */
r_goto
id|out_wakeup
suffix:semicolon
id|ccw_device_accumulate_irb
c_func
(paren
id|cdev
comma
id|irb
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t care about basic sense etc. */
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* timeout */
r_break
suffix:semicolon
)brace
id|out_wakeup
suffix:colon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_start_id
id|ccw_device_start_id
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cio_enable_subchannel
c_func
(paren
id|sch
comma
id|sch-&gt;schib.pmcw.isc
)paren
op_ne
l_int|0
)paren
multiline_comment|/* Couldn&squot;t enable the subchannel for i/o. Sick device. */
r_return
suffix:semicolon
multiline_comment|/* After 60s the device recognition is considered to have failed. */
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|60
op_star
id|HZ
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_DISCONNECTED_SENSE_ID
suffix:semicolon
id|ccw_device_sense_id_start
c_func
(paren
id|cdev
)paren
suffix:semicolon
)brace
r_void
DECL|function|device_trigger_reprobe
id|device_trigger_reprobe
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;dev.driver_data
)paren
r_return
suffix:semicolon
id|cdev
op_assign
id|sch-&gt;dev.driver_data
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sch-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_DISCONNECTED
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sch-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Update some values. */
r_if
c_cond
(paren
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sch-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The pim, pam, pom values may not be accurate, but they are the best&n;&t; * we have before performing device selection :/&n;&t; */
id|sch-&gt;lpm
op_assign
id|sch-&gt;schib.pmcw.pim
op_amp
id|sch-&gt;schib.pmcw.pam
op_amp
id|sch-&gt;schib.pmcw.pom
op_amp
id|sch-&gt;opm
suffix:semicolon
multiline_comment|/* Re-set some bits in the pmcw that were lost. */
id|sch-&gt;schib.pmcw.isc
op_assign
l_int|3
suffix:semicolon
id|sch-&gt;schib.pmcw.csense
op_assign
l_int|1
suffix:semicolon
id|sch-&gt;schib.pmcw.ena
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sch-&gt;lpm
op_amp
(paren
id|sch-&gt;lpm
op_minus
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
id|sch-&gt;schib.pmcw.mp
op_assign
l_int|1
suffix:semicolon
id|sch-&gt;schib.pmcw.intparm
op_assign
(paren
id|__u32
)paren
(paren
r_int
r_int
)paren
id|sch
suffix:semicolon
multiline_comment|/* We should also udate ssd info, but this has to wait. */
id|ccw_device_start_id
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sch-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_offline_irq
id|ccw_device_offline_irq
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * An interrupt in state offline means a previous disable was not&n;&t; * successful. Try again.&n;&t; */
id|cio_disable_subchannel
c_func
(paren
id|sch
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_change_cmfstate
id|ccw_device_change_cmfstate
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
id|retry_set_schib
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_ONLINE
suffix:semicolon
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|dev_event
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_quiesce_done
id|ccw_device_quiesce_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_event
op_eq
id|DEV_EVENT_NOTOPER
)paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_NOT_OPER
suffix:semicolon
r_else
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_OFFLINE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_quiesce_timeout
id|ccw_device_quiesce_timeout
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|ccw_device_cancel_halt_clear
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_OFFLINE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENODEV
suffix:colon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_NOT_OPER
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * No operation action. This is used e.g. to ignore a timeout event in&n; * state offline.&n; */
r_static
r_void
DECL|function|ccw_device_nop
id|ccw_device_nop
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
)brace
multiline_comment|/*&n; * Bug operation action. &n; */
r_static
r_void
DECL|function|ccw_device_bug
id|ccw_device_bug
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|dev_event
id|dev_event
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;dev_jumptable[%i][%i] == NULL&bslash;n&quot;
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
comma
id|dev_event
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * device statemachine&n; */
DECL|variable|dev_jumptable
id|fsm_func_t
op_star
id|dev_jumptable
(braket
id|NR_DEV_STATES
)braket
(braket
id|NR_DEV_EVENTS
)braket
op_assign
(brace
(braket
id|DEV_STATE_NOT_OPER
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_nop
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_bug
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_nop
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_SENSE_PGID
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_online_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_sense_pgid_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_onoff_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_SENSE_ID
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_recog_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_sense_id_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_recog_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_OFFLINE
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_offline_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_offline_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_nop
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_VERIFY
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_online_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_verify_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_onoff_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_ONLINE
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_online_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_online_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_online_verify
comma
)brace
comma
(braket
id|DEV_STATE_W4SENSE
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_online_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_w4sense
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_nop
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_online_verify
comma
)brace
comma
(braket
id|DEV_STATE_DISBAND_PGID
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_online_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_disband_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_onoff_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_BOXED
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_offline_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_stlck_done
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_stlck_done
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
multiline_comment|/* states to wait for i/o completion before doing something */
(braket
id|DEV_STATE_CLEAR_VERIFY
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_online_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_clear_verify
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_nop
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_TIMEOUT_KILL
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_online_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_killing_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_killing_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
singleline_comment|//FIXME
)brace
comma
(braket
id|DEV_STATE_WAIT4IO
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_online_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_wait4io_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_wait4io_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_wait4io_verify
comma
)brace
comma
(braket
id|DEV_STATE_QUIESCE
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_quiesce_done
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_quiesce_done
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_quiesce_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
multiline_comment|/* special states for devices gone not operational */
(braket
id|DEV_STATE_DISCONNECTED
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_nop
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_start_id
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_bug
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_DISCONNECTED_SENSE_ID
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_recog_notoper
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_sense_id_irq
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_recog_timeout
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_nop
comma
)brace
comma
(braket
id|DEV_STATE_CMFCHANGE
)braket
op_assign
(brace
(braket
id|DEV_EVENT_NOTOPER
)braket
op_assign
id|ccw_device_change_cmfstate
comma
(braket
id|DEV_EVENT_INTERRUPT
)braket
op_assign
id|ccw_device_change_cmfstate
comma
(braket
id|DEV_EVENT_TIMEOUT
)braket
op_assign
id|ccw_device_change_cmfstate
comma
(braket
id|DEV_EVENT_VERIFY
)braket
op_assign
id|ccw_device_change_cmfstate
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * io_subchannel_irq is called for &quot;real&quot; interrupts or for status&n; * pending conditions on msch.&n; */
r_void
DECL|function|io_subchannel_irq
id|io_subchannel_irq
(paren
r_struct
id|device
op_star
id|pdev
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
id|cdev
op_assign
id|to_subchannel
c_func
(paren
id|pdev
)paren
op_member_access_from_pointer
id|dev.driver_data
suffix:semicolon
id|CIO_TRACE_EVENT
(paren
l_int|3
comma
l_string|&quot;IRQ&quot;
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
(paren
l_int|3
comma
id|pdev-&gt;bus_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
)paren
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|DEV_EVENT_INTERRUPT
)paren
suffix:semicolon
)brace
DECL|variable|ccw_device_set_timeout
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|ccw_device_set_timeout
)paren
suffix:semicolon
eof
