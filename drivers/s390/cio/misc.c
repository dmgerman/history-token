multiline_comment|/*&n; *  drivers/s390/s390io.c&n; *   S/390 common I/O routines&n; *   $Revision: 1.4 $&n; *&n; *    Copyright (C) 1999-2002 IBM Deutschland Entwicklung GmbH,&n; *                            IBM Corporation&n; *    Author(s): Ingo Adlung (adlung@de.ibm.com)&n; *               Cornelia Huck (cohuck@de.ibm.com) &n; *&t;&t; Arnd Bergmann (arndb@de.ibm.com)&n; *    ChangeLog: 11/04/2002 Arnd Bergmann Split s390io.c into multiple files,&n; *&t;&t;&t;&t;&t;  see s390io.c for complete list of&n; * &t;&t;&t;&t;&t;  changes.&n; *               05/03/2002 Cornelia Huck  debug cleanup&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/s390io.h&gt;
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#include &lt;asm/s390mach.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &quot;s390io.h&quot;
macro_line|#include &quot;cio_debug.h&quot;
macro_line|#include &quot;ioinfo.h&quot;
macro_line|#include &quot;proc.h&quot;
macro_line|#include &quot;chsc.h&quot;
macro_line|#ifdef CONFIG_DEBUG_CRW
DECL|macro|DBGW
mdefine_line|#define DBGW printk
macro_line|#else
DECL|macro|DBGW
mdefine_line|#define DBGW(args,...) do {} while (0)
macro_line|#endif
DECL|macro|CRW_DEBUG
mdefine_line|#define CRW_DEBUG(printk_level,event_level,msg...) ({&bslash;&n;&t;DBGW(printk_level msg); &bslash;&n;&t;CIO_CRW_EVENT (event_level, msg); &bslash;&n;})
r_static
r_void
DECL|function|s390_process_subchannel_source
id|s390_process_subchannel_source
(paren
r_int
id|irq
)paren
(brace
r_int
id|dev_oper
op_assign
l_int|0
suffix:semicolon
r_int
id|dev_no
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|lock
op_assign
l_int|0
suffix:semicolon
r_int
id|is_owned
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If the device isn&squot;t known yet&n;&t; *   we can&squot;t lock it ...&n;&t; */
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_ne
id|INVALID_STORAGE_AREA
)paren
(brace
id|s390irq_spin_lock
(paren
id|irq
)paren
suffix:semicolon
id|lock
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
(brace
id|dev_oper
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.oper
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.dval
)paren
id|dev_no
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|devno
suffix:semicolon
id|is_owned
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.ready
suffix:semicolon
)brace
)brace
id|CRW_DEBUG
c_func
(paren
id|KERN_DEBUG
comma
l_int|4
comma
l_string|&quot;subchannel validation - start&bslash;n&quot;
)paren
suffix:semicolon
id|s390_validate_subchannel
(paren
id|irq
comma
id|is_owned
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
id|highest_subchannel
)paren
id|highest_subchannel
op_assign
id|irq
suffix:semicolon
id|CRW_DEBUG
c_func
(paren
id|KERN_DEBUG
comma
l_int|4
comma
l_string|&quot;subchannel validation - done&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * After the validate processing&n;&t; *   the ioinfo control block&n;&t; *   should be allocated ...&n;&t; */
r_if
c_cond
(paren
id|lock
)paren
(brace
id|s390irq_spin_unlock
(paren
id|irq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_ne
id|INVALID_STORAGE_AREA
)paren
(brace
macro_line|#ifdef CONFIG_ARCH_S390X
id|CRW_DEBUG
c_func
(paren
id|KERN_DEBUG
comma
l_int|4
comma
l_string|&quot;ioinfo at %08lX&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ioinfo
(braket
id|irq
)braket
)paren
suffix:semicolon
macro_line|#else&t;&t;&t;&t;/* CONFIG_ARCH_S390X */
id|CRW_DEBUG
c_func
(paren
id|KERN_DEBUG
comma
l_int|4
comma
l_string|&quot;ioinfo at %08X&bslash;n&quot;
comma
(paren
r_int
)paren
id|ioinfo
(braket
id|irq
)braket
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* CONFIG_ARCH_S390X */
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.oper
op_eq
l_int|0
)paren
(brace
id|not_oper_handler_func_t
id|nopfunc
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|nopfunc
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * If the device has gone&n;&t;&t;&t; *  call not oper handler               &n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|dev_oper
op_eq
l_int|1
)paren
op_logical_and
(paren
id|nopfunc
op_ne
l_int|NULL
)paren
)paren
(brace
id|free_irq
(paren
id|irq
comma
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|irq_desc.dev_id
)paren
suffix:semicolon
id|nopfunc
(paren
id|irq
comma
id|DEVSTAT_DEVICE_GONE
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|CRW_DEBUG
c_func
(paren
id|KERN_DEBUG
comma
l_int|4
comma
l_string|&quot;device recognition - start&bslash;n&quot;
)paren
suffix:semicolon
id|s390_device_recognition_irq
(paren
id|irq
)paren
suffix:semicolon
id|CRW_DEBUG
c_func
(paren
id|KERN_DEBUG
comma
l_int|4
comma
l_string|&quot;device recognition - done&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * the device became operational&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dev_oper
op_eq
l_int|0
)paren
(brace
id|devreg_t
op_star
id|pdevreg
suffix:semicolon
id|pdevreg
op_assign
id|s390_search_devreg
(paren
id|ioinfo
(braket
id|irq
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdevreg
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pdevreg-&gt;oper_func
op_ne
l_int|NULL
)paren
id|pdevreg
op_member_access_from_pointer
id|oper_func
(paren
id|irq
comma
id|pdevreg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t;&t; * ... it is and was operational, but&n;&t;&t;&t; *      the devno may have changed&n;&t;&t;&t; */
r_else
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|devno
op_ne
id|dev_no
)paren
op_logical_and
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|nopfunc
op_ne
l_int|NULL
)paren
)paren
(brace
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|nopfunc
(paren
id|irq
comma
id|DEVSTAT_REVALIDATE
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*&n; * s390_do_crw_pending&n; *&n; * Called by the machine check handler to process CRW pending&n; *  conditions. It may be a single CRW, or CRWs may be chained.&n; *&n; * Note : we currently process CRWs for subchannel source only&n; */
r_void
DECL|function|s390_do_crw_pending
id|s390_do_crw_pending
(paren
id|crwe_t
op_star
id|pcrwe
)paren
(brace
r_int
id|irq
suffix:semicolon
r_int
id|chpid
suffix:semicolon
id|CRW_DEBUG
c_func
(paren
id|KERN_DEBUG
comma
l_int|2
comma
l_string|&quot;do_crw_pending: starting&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pcrwe
op_ne
l_int|NULL
)paren
(brace
r_switch
c_cond
(paren
id|pcrwe-&gt;crw.rsc
)paren
(brace
r_case
id|CRW_RSC_SCH
suffix:colon
id|irq
op_assign
id|pcrwe-&gt;crw.rsid
suffix:semicolon
id|CRW_DEBUG
c_func
(paren
id|KERN_NOTICE
comma
l_int|2
comma
l_string|&quot;source is subchannel %04X&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|s390_process_subchannel_source
(paren
id|irq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRW_RSC_MONITOR
suffix:colon
id|CRW_DEBUG
c_func
(paren
id|KERN_NOTICE
comma
l_int|2
comma
l_string|&quot;source is monitoring facility&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRW_RSC_CPATH
suffix:colon
id|chpid
op_assign
id|pcrwe-&gt;crw.rsid
suffix:semicolon
id|CRW_DEBUG
c_func
(paren
id|KERN_NOTICE
comma
l_int|2
comma
l_string|&quot;source is channel path %02X&bslash;n&quot;
comma
id|chpid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRW_RSC_CONFIG
suffix:colon
id|CRW_DEBUG
c_func
(paren
id|KERN_NOTICE
comma
l_int|2
comma
l_string|&quot;source is configuration-alert facility&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CRW_RSC_CSS
suffix:colon
id|CRW_DEBUG
c_func
(paren
id|KERN_NOTICE
comma
l_int|2
comma
l_string|&quot;source is channel subsystem&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CHSC
id|s390_process_css
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|CRW_DEBUG
c_func
(paren
id|KERN_NOTICE
comma
l_int|2
comma
l_string|&quot;unknown source&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pcrwe
op_assign
id|pcrwe-&gt;crwe_next
suffix:semicolon
)brace
id|CRW_DEBUG
c_func
(paren
id|KERN_DEBUG
comma
l_int|2
comma
l_string|&quot;do_crw_pending: done&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
eof
