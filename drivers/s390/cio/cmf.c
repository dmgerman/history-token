multiline_comment|/*&n; * linux/drivers/s390/cio/cmf.c ($Revision: 1.16 $)&n; *&n; * Linux on zSeries Channel Measurement Facility support&n; *&n; * Copyright 2000,2003 IBM Corporation&n; *&n; * Author: Arnd Bergmann &lt;arndb@de.ibm.com&gt;&n; *&n; * original idea from Natarajan Krishnaswami &lt;nkrishna@us.ibm.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/cio.h&gt;
macro_line|#include &lt;asm/cmb.h&gt;
macro_line|#include &quot;cio.h&quot;
macro_line|#include &quot;css.h&quot;
macro_line|#include &quot;device.h&quot;
macro_line|#include &quot;ioasm.h&quot;
macro_line|#include &quot;chsc.h&quot;
multiline_comment|/* parameter to enable cmf during boot, possible uses are:&n; *  &quot;s390cmf&quot; -- enable cmf and allocate 2 MB of ram so measuring can be&n; *               used on any subchannel&n; *  &quot;s390cmf=&lt;num&gt;&quot; -- enable cmf and allocate enough memory to measure&n; *                     &lt;num&gt; subchannel, where &lt;num&gt; is an integer&n; *                     between 1 and 65535, default is 1024&n; */
DECL|macro|ARGSTRING
mdefine_line|#define ARGSTRING &quot;s390cmf&quot;
multiline_comment|/* indices for READCMB */
DECL|enum|cmb_index
r_enum
id|cmb_index
(brace
multiline_comment|/* basic and exended format: */
DECL|enumerator|cmb_ssch_rsch_count
id|cmb_ssch_rsch_count
comma
DECL|enumerator|cmb_sample_count
id|cmb_sample_count
comma
DECL|enumerator|cmb_device_connect_time
id|cmb_device_connect_time
comma
DECL|enumerator|cmb_function_pending_time
id|cmb_function_pending_time
comma
DECL|enumerator|cmb_device_disconnect_time
id|cmb_device_disconnect_time
comma
DECL|enumerator|cmb_control_unit_queuing_time
id|cmb_control_unit_queuing_time
comma
DECL|enumerator|cmb_device_active_only_time
id|cmb_device_active_only_time
comma
multiline_comment|/* extended format only: */
DECL|enumerator|cmb_device_busy_time
id|cmb_device_busy_time
comma
DECL|enumerator|cmb_initial_command_response_time
id|cmb_initial_command_response_time
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * enum cmb_format - types of supported measurement block formats&n; *&n; * @CMF_BASIC:      traditional channel measurement blocks supported&n; * &t;&t;    by all machines that we run on&n; * @CMF_EXTENDED:   improved format that was introduced with the z990&n; * &t;&t;    machine&n; * @CMF_AUTODETECT: default: use extended format when running on a z990&n; *                  or later machine, otherwise fall back to basic format&n; **/
DECL|enum|cmb_format
r_enum
id|cmb_format
(brace
DECL|enumerator|CMF_BASIC
id|CMF_BASIC
comma
DECL|enumerator|CMF_EXTENDED
id|CMF_EXTENDED
comma
DECL|enumerator|CMF_AUTODETECT
id|CMF_AUTODETECT
op_assign
op_minus
l_int|1
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * format - actual format for all measurement blocks&n; *&n; * The format module parameter can be set to a value of 0 (zero)&n; * or 1, indicating basic or extended format as described for&n; * enum cmb_format.&n; */
DECL|variable|format
r_static
r_int
id|format
op_assign
id|CMF_AUTODETECT
suffix:semicolon
id|module_param
c_func
(paren
id|format
comma
r_bool
comma
l_int|0444
)paren
suffix:semicolon
multiline_comment|/**&n; * struct cmb_operations - functions to use depending on cmb_format&n; *&n; * all these functions operate on a struct cmf_device. There is only&n; * one instance of struct cmb_operations because all cmf_device&n; * objects are guaranteed to be of the same type.&n; *&n; * @alloc:&t;allocate memory for a channel measurement block,&n; *&t;&t;either with the help of a special pool or with kmalloc&n; * @free:&t;free memory allocated with @alloc&n; * @set:&t;enable or disable measurement&n; * @readall:&t;read a measurement block in a common format&n; * @reset:&t;clear the data in the associated measurement block and&n; *&t;&t;reset its time stamp&n; */
DECL|struct|cmb_operations
r_struct
id|cmb_operations
(brace
DECL|member|alloc
r_int
(paren
op_star
id|alloc
)paren
(paren
r_struct
id|ccw_device
op_star
)paren
suffix:semicolon
DECL|member|free
r_void
(paren
op_star
id|free
)paren
(paren
r_struct
id|ccw_device
op_star
)paren
suffix:semicolon
DECL|member|set
r_int
(paren
op_star
id|set
)paren
(paren
r_struct
id|ccw_device
op_star
comma
id|u32
)paren
suffix:semicolon
DECL|member|read
id|u64
(paren
op_star
id|read
)paren
(paren
r_struct
id|ccw_device
op_star
comma
r_int
)paren
suffix:semicolon
DECL|member|readall
r_int
(paren
op_star
id|readall
)paren
(paren
r_struct
id|ccw_device
op_star
comma
r_struct
id|cmbdata
op_star
)paren
suffix:semicolon
DECL|member|reset
r_void
(paren
op_star
id|reset
)paren
(paren
r_struct
id|ccw_device
op_star
)paren
suffix:semicolon
DECL|member|attr_group
r_struct
id|attribute_group
op_star
id|attr_group
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|cmbops
r_static
r_struct
id|cmb_operations
op_star
id|cmbops
suffix:semicolon
multiline_comment|/* our user interface is designed in terms of nanoseconds,&n; * while the hardware measures total times in its own&n; * unit.*/
DECL|function|time_to_nsec
r_static
r_inline
id|u64
id|time_to_nsec
c_func
(paren
id|u32
id|value
)paren
(brace
r_return
(paren
(paren
id|u64
)paren
id|value
)paren
op_star
l_int|128000ull
suffix:semicolon
)brace
multiline_comment|/*&n; * Users are usually interested in average times,&n; * not accumulated time.&n; * This also helps us with atomicity problems&n; * when reading sinlge values.&n; */
DECL|function|time_to_avg_nsec
r_static
r_inline
id|u64
id|time_to_avg_nsec
c_func
(paren
id|u32
id|value
comma
id|u32
id|count
)paren
(brace
id|u64
id|ret
suffix:semicolon
multiline_comment|/* no samples yet, avoid division by 0 */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* value comes in units of 128 &#xfffd;sec */
id|ret
op_assign
id|time_to_nsec
c_func
(paren
id|value
)paren
suffix:semicolon
id|do_div
c_func
(paren
id|ret
comma
id|count
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* activate or deactivate the channel monitor. When area is NULL,&n; * the monitor is deactivated. The channel monitor needs to&n; * be active in order to measure subchannels, which also need&n; * to be enabled. */
r_static
r_inline
r_void
DECL|function|cmf_activate
id|cmf_activate
c_func
(paren
r_void
op_star
id|area
comma
r_int
r_int
id|onoff
)paren
(brace
r_register
r_void
op_star
id|__gpr2
id|asm
c_func
(paren
l_string|&quot;2&quot;
)paren
suffix:semicolon
r_register
r_int
id|__gpr1
id|asm
c_func
(paren
l_string|&quot;1&quot;
)paren
suffix:semicolon
id|__gpr2
op_assign
id|area
suffix:semicolon
id|__gpr1
op_assign
id|onoff
ques
c_cond
l_int|2
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* activate channel measurement */
id|asm
c_func
(paren
l_string|&quot;schm&quot;
suffix:colon
suffix:colon
l_string|&quot;d&quot;
(paren
id|__gpr2
)paren
comma
l_string|&quot;d&quot;
(paren
id|__gpr1
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_schib
id|set_schib
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
id|u32
id|mme
comma
r_int
id|mbfc
comma
r_int
r_int
id|address
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|retry
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_struct
id|schib
op_star
id|schib
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|schib
op_assign
op_amp
id|sch-&gt;schib
suffix:semicolon
multiline_comment|/* msch can silently fail, so do it again if necessary */
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|3
suffix:semicolon
id|retry
op_increment
)paren
(brace
multiline_comment|/* prepare schib */
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
id|schib
)paren
suffix:semicolon
id|schib-&gt;pmcw.mme
op_assign
id|mme
suffix:semicolon
id|schib-&gt;pmcw.mbfc
op_assign
id|mbfc
suffix:semicolon
multiline_comment|/* address can be either a block address or a block index */
r_if
c_cond
(paren
id|mbfc
)paren
id|schib-&gt;mba
op_assign
id|address
suffix:semicolon
r_else
id|schib-&gt;pmcw.mbi
op_assign
id|address
suffix:semicolon
multiline_comment|/* try to submit it */
r_switch
c_cond
(paren
id|ret
op_assign
id|msch_err
c_func
(paren
id|sch-&gt;irq
comma
id|schib
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_case
l_int|2
suffix:colon
multiline_comment|/* in I/O or status pending */
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* subchannel is no longer valid */
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* msch caught an exception */
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
id|schib
)paren
suffix:semicolon
multiline_comment|/* restore the schib */
r_if
c_cond
(paren
id|ret
)paren
r_break
suffix:semicolon
multiline_comment|/* check if it worked */
r_if
c_cond
(paren
id|schib-&gt;pmcw.mme
op_eq
id|mme
op_logical_and
id|schib-&gt;pmcw.mbfc
op_eq
id|mbfc
op_logical_and
(paren
id|mbfc
ques
c_cond
(paren
id|schib-&gt;mba
op_eq
id|address
)paren
suffix:colon
(paren
id|schib-&gt;pmcw.mbi
op_eq
id|address
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|struct|set_schib_struct
r_struct
id|set_schib_struct
(brace
DECL|member|mme
id|u32
id|mme
suffix:semicolon
DECL|member|mbfc
r_int
id|mbfc
suffix:semicolon
DECL|member|address
r_int
r_int
id|address
suffix:semicolon
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|ret
r_int
id|ret
suffix:semicolon
)brace
suffix:semicolon
DECL|function|set_schib_wait
r_static
r_int
id|set_schib_wait
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
id|u32
id|mme
comma
r_int
id|mbfc
comma
r_int
r_int
id|address
)paren
(brace
r_struct
id|set_schib_struct
id|s
op_assign
(brace
dot
id|mme
op_assign
id|mme
comma
dot
id|mbfc
op_assign
id|mbfc
comma
dot
id|address
op_assign
id|address
comma
dot
id|wait
op_assign
id|__WAIT_QUEUE_HEAD_INITIALIZER
c_func
(paren
id|s.wait
)paren
comma
)brace
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|s.ret
op_assign
id|set_schib
c_func
(paren
id|cdev
comma
id|mme
comma
id|mbfc
comma
id|address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s.ret
op_ne
op_minus
id|EBUSY
)paren
(brace
r_goto
id|out_nowait
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_ONLINE
)paren
(brace
id|s.ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* if the device is not online, don&squot;t even try again */
r_goto
id|out_nowait
suffix:semicolon
)brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_CMFCHANGE
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_wait
op_assign
op_amp
id|s
suffix:semicolon
id|s.ret
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_event_interruptible
c_func
(paren
id|s.wait
comma
id|s.ret
op_ne
l_int|1
)paren
)paren
(brace
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s.ret
op_eq
l_int|1
)paren
(brace
id|s.ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_wait
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_CMFCHANGE
)paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_ONLINE
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
)brace
r_return
id|s.ret
suffix:semicolon
id|out_nowait
suffix:colon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_return
id|s.ret
suffix:semicolon
)brace
DECL|function|retry_set_schib
r_void
id|retry_set_schib
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|set_schib_struct
op_star
id|s
suffix:semicolon
id|s
op_assign
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_wait
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_wait
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
(brace
id|WARN_ON
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|s-&gt;ret
op_assign
id|set_schib
c_func
(paren
id|cdev
comma
id|s-&gt;mme
comma
id|s-&gt;mbfc
comma
id|s-&gt;address
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|s-&gt;wait
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * struct cmb_area - container for global cmb data&n; *&n; * @mem:&t;pointer to CMBs (only in basic measurement mode)&n; * @list:&t;contains a linked list of all subchannels&n; * @lock:&t;protect concurrent access to @mem and @list&n; */
DECL|struct|cmb_area
r_struct
id|cmb_area
(brace
DECL|member|mem
r_struct
id|cmb
op_star
id|mem
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|num_channels
r_int
id|num_channels
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|cmb_area
r_static
r_struct
id|cmb_area
id|cmb_area
op_assign
(brace
dot
id|lock
op_assign
id|SPIN_LOCK_UNLOCKED
comma
dot
id|list
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|cmb_area.list
)paren
comma
dot
id|num_channels
op_assign
l_int|1024
comma
)brace
suffix:semicolon
"&f;"
multiline_comment|/* ****** old style CMB handling ********/
multiline_comment|/** int maxchannels&n; *&n; * Basic channel measurement blocks are allocated in one contiguous&n; * block of memory, which can not be moved as long as any channel&n; * is active. Therefore, a maximum number of subchannels needs to&n; * be defined somewhere. This is a module parameter, defaulting to&n; * a resonable value of 1024, or 32 kb of memory.&n; * Current kernels don&squot;t allow kmalloc with more than 128kb, so the&n; * maximum is 4096&n; */
id|module_param_named
c_func
(paren
id|maxchannels
comma
id|cmb_area.num_channels
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
multiline_comment|/**&n; * struct cmb - basic channel measurement block&n; *&n; * cmb as used by the hardware the fields are described in z/Architecture&n; * Principles of Operation, chapter 17.&n; * The area to be a contiguous array and may not be reallocated or freed.&n; * Only one cmb area can be present in the system.&n; */
DECL|struct|cmb
r_struct
id|cmb
(brace
DECL|member|ssch_rsch_count
id|u16
id|ssch_rsch_count
suffix:semicolon
DECL|member|sample_count
id|u16
id|sample_count
suffix:semicolon
DECL|member|device_connect_time
id|u32
id|device_connect_time
suffix:semicolon
DECL|member|function_pending_time
id|u32
id|function_pending_time
suffix:semicolon
DECL|member|device_disconnect_time
id|u32
id|device_disconnect_time
suffix:semicolon
DECL|member|control_unit_queuing_time
id|u32
id|control_unit_queuing_time
suffix:semicolon
DECL|member|device_active_only_time
id|u32
id|device_active_only_time
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* insert a single device into the cmb_area list&n; * called with cmb_area.lock held from alloc_cmb&n; */
r_static
r_inline
r_int
DECL|function|alloc_cmb_single
id|alloc_cmb_single
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|cmb
op_star
id|cmb
suffix:semicolon
r_struct
id|ccw_device_private
op_star
id|node
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_list
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* find first unused cmb in cmb_area.mem.&n;&t; * this is a little tricky: cmb_area.list&n;&t; * remains sorted by -&gt;cmb pointers */
id|cmb
op_assign
id|cmb_area.mem
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|node
comma
op_amp
id|cmb_area.list
comma
id|cmb_list
)paren
(brace
r_if
c_cond
(paren
(paren
r_struct
id|cmb
op_star
)paren
id|node-&gt;cmb
OG
id|cmb
)paren
r_break
suffix:semicolon
id|cmb
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmb
op_minus
id|cmb_area.mem
op_ge
id|cmb_area.num_channels
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* insert new cmb */
id|list_add_tail
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_list
comma
op_amp
id|node-&gt;cmb_list
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
op_assign
id|cmb
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|alloc_cmb
id|alloc_cmb
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|cmb
op_star
id|mem
suffix:semicolon
id|ssize_t
id|size
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmb_area.mem
)paren
(brace
multiline_comment|/* there is no user yet, so we need a new area */
id|size
op_assign
r_sizeof
(paren
r_struct
id|cmb
)paren
op_star
id|cmb_area.num_channels
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|cmb_area.list
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
id|mem
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmb_area.mem
)paren
(brace
multiline_comment|/* ok, another thread was faster */
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|mem
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
multiline_comment|/* no luck */
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* everything ok */
id|memset
c_func
(paren
id|mem
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|cmb_area.mem
op_assign
id|mem
suffix:semicolon
id|cmf_activate
c_func
(paren
id|cmb_area.mem
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* do the actual allocation */
id|ret
op_assign
id|alloc_cmb_single
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|free_cmb
id|free_cmb
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|ccw_device_private
op_star
id|priv
suffix:semicolon
id|priv
op_assign
id|cdev
op_member_access_from_pointer
r_private
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|priv-&gt;cmb_list
)paren
)paren
(brace
multiline_comment|/* already freed */
r_goto
id|out
suffix:semicolon
)brace
id|priv-&gt;cmb
op_assign
l_int|NULL
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|priv-&gt;cmb_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|cmb_area.list
)paren
)paren
(brace
id|ssize_t
id|size
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|cmb
)paren
op_star
id|cmb_area.num_channels
suffix:semicolon
id|cmf_activate
c_func
(paren
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|cmb_area.mem
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
id|cmb_area.mem
op_assign
l_int|NULL
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_cmb
id|set_cmb
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
id|u32
id|mme
)paren
(brace
id|u16
id|offset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|offset
op_assign
id|mme
ques
c_cond
(paren
r_struct
id|cmb
op_star
)paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
op_minus
id|cmb_area.mem
suffix:colon
l_int|0
suffix:semicolon
r_return
id|set_schib_wait
c_func
(paren
id|cdev
comma
id|mme
comma
l_int|0
comma
id|offset
)paren
suffix:semicolon
)brace
r_static
id|u64
DECL|function|read_cmb
id|read_cmb
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|index
)paren
(brace
multiline_comment|/* yes, we have to put it on the stack&n;&t; * because the cmb must only be accessed&n;&t; * atomically, e.g. with mvc */
r_struct
id|cmb
id|cmb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cmb
op_assign
op_star
(paren
r_struct
id|cmb
op_star
)paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|index
)paren
(brace
r_case
id|cmb_ssch_rsch_count
suffix:colon
r_return
id|cmb.ssch_rsch_count
suffix:semicolon
r_case
id|cmb_sample_count
suffix:colon
r_return
id|cmb.sample_count
suffix:semicolon
r_case
id|cmb_device_connect_time
suffix:colon
id|val
op_assign
id|cmb.device_connect_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_function_pending_time
suffix:colon
id|val
op_assign
id|cmb.function_pending_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_device_disconnect_time
suffix:colon
id|val
op_assign
id|cmb.device_disconnect_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_control_unit_queuing_time
suffix:colon
id|val
op_assign
id|cmb.control_unit_queuing_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_device_active_only_time
suffix:colon
id|val
op_assign
id|cmb.device_active_only_time
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|time_to_avg_nsec
c_func
(paren
id|val
comma
id|cmb.sample_count
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|readall_cmb
id|readall_cmb
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|cmbdata
op_star
id|data
)paren
(brace
multiline_comment|/* yes, we have to put it on the stack&n;&t; * because the cmb must only be accessed&n;&t; * atomically, e.g. with mvc */
r_struct
id|cmb
id|cmb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u64
id|time
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cmb
op_assign
op_star
(paren
r_struct
id|cmb
op_star
)paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
suffix:semicolon
id|time
op_assign
id|get_clock
c_func
(paren
)paren
op_minus
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_start_time
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|cmbdata
)paren
)paren
suffix:semicolon
multiline_comment|/* we only know values before device_busy_time */
id|data-&gt;size
op_assign
m_offsetof
(paren
r_struct
id|cmbdata
comma
id|device_busy_time
)paren
suffix:semicolon
multiline_comment|/* convert to nanoseconds */
id|data-&gt;elapsed_time
op_assign
(paren
id|time
op_star
l_int|1000
)paren
op_rshift
l_int|12
suffix:semicolon
multiline_comment|/* copy data to new structure */
id|data-&gt;ssch_rsch_count
op_assign
id|cmb.ssch_rsch_count
suffix:semicolon
id|data-&gt;sample_count
op_assign
id|cmb.sample_count
suffix:semicolon
multiline_comment|/* time fields are converted to nanoseconds while copying */
id|data-&gt;device_connect_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.device_connect_time
)paren
suffix:semicolon
id|data-&gt;function_pending_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.function_pending_time
)paren
suffix:semicolon
id|data-&gt;device_disconnect_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.device_disconnect_time
)paren
suffix:semicolon
id|data-&gt;control_unit_queuing_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.control_unit_queuing_time
)paren
suffix:semicolon
id|data-&gt;device_active_only_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.device_active_only_time
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|reset_cmb
id|reset_cmb
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|cmb
op_star
id|cmb
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|cmb
op_assign
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
suffix:semicolon
r_if
c_cond
(paren
id|cmb
)paren
id|memset
(paren
id|cmb
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cmb
)paren
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_start_time
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
)brace
DECL|variable|cmf_attr_group
r_static
r_struct
id|attribute_group
id|cmf_attr_group
suffix:semicolon
DECL|variable|cmbops_basic
r_static
r_struct
id|cmb_operations
id|cmbops_basic
op_assign
(brace
dot
id|alloc
op_assign
id|alloc_cmb
comma
dot
id|free
op_assign
id|free_cmb
comma
dot
id|set
op_assign
id|set_cmb
comma
dot
id|read
op_assign
id|read_cmb
comma
dot
id|readall
op_assign
id|readall_cmb
comma
dot
id|reset
op_assign
id|reset_cmb
comma
dot
id|attr_group
op_assign
op_amp
id|cmf_attr_group
comma
)brace
suffix:semicolon
"&f;"
multiline_comment|/* ******** extended cmb handling ********/
multiline_comment|/**&n; * struct cmbe - extended channel measurement block&n; *&n; * cmb as used by the hardware, may be in any 64 bit physical location,&n; * the fields are described in z/Architecture Principles of Operation,&n; * third edition, chapter 17.&n; */
DECL|struct|cmbe
r_struct
id|cmbe
(brace
DECL|member|ssch_rsch_count
id|u32
id|ssch_rsch_count
suffix:semicolon
DECL|member|sample_count
id|u32
id|sample_count
suffix:semicolon
DECL|member|device_connect_time
id|u32
id|device_connect_time
suffix:semicolon
DECL|member|function_pending_time
id|u32
id|function_pending_time
suffix:semicolon
DECL|member|device_disconnect_time
id|u32
id|device_disconnect_time
suffix:semicolon
DECL|member|control_unit_queuing_time
id|u32
id|control_unit_queuing_time
suffix:semicolon
DECL|member|device_active_only_time
id|u32
id|device_active_only_time
suffix:semicolon
DECL|member|device_busy_time
id|u32
id|device_busy_time
suffix:semicolon
DECL|member|initial_command_response_time
id|u32
id|initial_command_response_time
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
(braket
l_int|7
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* kmalloc only guarantees 8 byte alignment, but we need cmbe&n; * pointers to be naturally aligned. Make sure to allocate&n; * enough space for two cmbes */
DECL|function|cmbe_align
r_static
r_inline
r_struct
id|cmbe
op_star
id|cmbe_align
c_func
(paren
r_struct
id|cmbe
op_star
id|c
)paren
(brace
r_int
r_int
id|addr
suffix:semicolon
id|addr
op_assign
(paren
(paren
r_int
r_int
)paren
id|c
op_plus
r_sizeof
(paren
r_struct
id|cmbe
)paren
op_minus
r_sizeof
(paren
r_int
)paren
)paren
op_amp
op_complement
(paren
r_sizeof
(paren
r_struct
id|cmbe
)paren
op_minus
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_return
(paren
r_struct
id|cmbe
op_star
)paren
id|addr
suffix:semicolon
)brace
r_static
r_int
DECL|function|alloc_cmbe
id|alloc_cmbe
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|cmbe
op_star
id|cmbe
suffix:semicolon
id|cmbe
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|cmbe
)paren
op_star
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmbe
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
(brace
id|kfree
c_func
(paren
id|cmbe
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
op_assign
id|cmbe
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
multiline_comment|/* activate global measurement if this is the first channel */
id|spin_lock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|cmb_area.list
)paren
)paren
id|cmf_activate
c_func
(paren
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_list
comma
op_amp
id|cmb_area.list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|free_cmbe
id|free_cmbe
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
id|kfree
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
multiline_comment|/* deactivate global measurement if this is the last channel */
id|spin_lock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|cmb_area.list
)paren
)paren
id|cmf_activate
c_func
(paren
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cmb_area.lock
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|set_cmbe
id|set_cmbe
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
id|u32
id|mme
)paren
(brace
r_int
r_int
id|mba
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|mba
op_assign
id|mme
ques
c_cond
(paren
r_int
r_int
)paren
id|cmbe_align
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
suffix:colon
l_int|0
suffix:semicolon
r_return
id|set_schib_wait
c_func
(paren
id|cdev
comma
id|mme
comma
l_int|1
comma
id|mba
)paren
suffix:semicolon
)brace
id|u64
DECL|function|read_cmbe
id|read_cmbe
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|index
)paren
(brace
multiline_comment|/* yes, we have to put it on the stack&n;&t; * because the cmb must only be accessed&n;&t; * atomically, e.g. with mvc */
r_struct
id|cmbe
id|cmb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cmb
op_assign
op_star
id|cmbe_align
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|index
)paren
(brace
r_case
id|cmb_ssch_rsch_count
suffix:colon
r_return
id|cmb.ssch_rsch_count
suffix:semicolon
r_case
id|cmb_sample_count
suffix:colon
r_return
id|cmb.sample_count
suffix:semicolon
r_case
id|cmb_device_connect_time
suffix:colon
id|val
op_assign
id|cmb.device_connect_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_function_pending_time
suffix:colon
id|val
op_assign
id|cmb.function_pending_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_device_disconnect_time
suffix:colon
id|val
op_assign
id|cmb.device_disconnect_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_control_unit_queuing_time
suffix:colon
id|val
op_assign
id|cmb.control_unit_queuing_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_device_active_only_time
suffix:colon
id|val
op_assign
id|cmb.device_active_only_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_device_busy_time
suffix:colon
id|val
op_assign
id|cmb.device_busy_time
suffix:semicolon
r_break
suffix:semicolon
r_case
id|cmb_initial_command_response_time
suffix:colon
id|val
op_assign
id|cmb.initial_command_response_time
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|time_to_avg_nsec
c_func
(paren
id|val
comma
id|cmb.sample_count
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|readall_cmbe
id|readall_cmbe
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|cmbdata
op_star
id|data
)paren
(brace
multiline_comment|/* yes, we have to put it on the stack&n;&t; * because the cmb must only be accessed&n;&t; * atomically, e.g. with mvc */
r_struct
id|cmbe
id|cmb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u64
id|time
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cmb
op_assign
op_star
id|cmbe_align
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
suffix:semicolon
id|time
op_assign
id|get_clock
c_func
(paren
)paren
op_minus
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_start_time
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
id|memset
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|cmbdata
)paren
)paren
suffix:semicolon
multiline_comment|/* we only know values before device_busy_time */
id|data-&gt;size
op_assign
m_offsetof
(paren
r_struct
id|cmbdata
comma
id|device_busy_time
)paren
suffix:semicolon
multiline_comment|/* conver to nanoseconds */
id|data-&gt;elapsed_time
op_assign
(paren
id|time
op_star
l_int|1000
)paren
op_rshift
l_int|12
suffix:semicolon
multiline_comment|/* copy data to new structure */
id|data-&gt;ssch_rsch_count
op_assign
id|cmb.ssch_rsch_count
suffix:semicolon
id|data-&gt;sample_count
op_assign
id|cmb.sample_count
suffix:semicolon
multiline_comment|/* time fields are converted to nanoseconds while copying */
id|data-&gt;device_connect_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.device_connect_time
)paren
suffix:semicolon
id|data-&gt;function_pending_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.function_pending_time
)paren
suffix:semicolon
id|data-&gt;device_disconnect_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.device_disconnect_time
)paren
suffix:semicolon
id|data-&gt;control_unit_queuing_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.control_unit_queuing_time
)paren
suffix:semicolon
id|data-&gt;device_active_only_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.device_active_only_time
)paren
suffix:semicolon
id|data-&gt;device_busy_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.device_busy_time
)paren
suffix:semicolon
id|data-&gt;initial_command_response_time
op_assign
id|time_to_nsec
c_func
(paren
id|cmb.initial_command_response_time
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|reset_cmbe
id|reset_cmbe
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|cmbe
op_star
id|cmb
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|cmb
op_assign
id|cmbe_align
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmb
)paren
id|memset
(paren
id|cmb
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cmb
)paren
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_start_time
op_assign
id|get_clock
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
)brace
DECL|variable|cmf_attr_group_ext
r_static
r_struct
id|attribute_group
id|cmf_attr_group_ext
suffix:semicolon
DECL|variable|cmbops_extended
r_static
r_struct
id|cmb_operations
id|cmbops_extended
op_assign
(brace
dot
id|alloc
op_assign
id|alloc_cmbe
comma
dot
id|free
op_assign
id|free_cmbe
comma
dot
id|set
op_assign
id|set_cmbe
comma
dot
id|read
op_assign
id|read_cmbe
comma
dot
id|readall
op_assign
id|readall_cmbe
comma
dot
id|reset
op_assign
id|reset_cmbe
comma
dot
id|attr_group
op_assign
op_amp
id|cmf_attr_group_ext
comma
)brace
suffix:semicolon
"&f;"
r_static
id|ssize_t
DECL|function|cmb_show_attr
id|cmb_show_attr
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_enum
id|cmb_index
id|idx
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%lld&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|cmf_read
c_func
(paren
id|to_ccwdev
c_func
(paren
id|dev
)paren
comma
id|idx
)paren
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|cmb_show_avg_sample_interval
id|cmb_show_avg_sample_interval
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_int
id|interval
suffix:semicolon
r_int
r_int
id|count
suffix:semicolon
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|interval
op_assign
id|get_clock
c_func
(paren
)paren
op_minus
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb_start_time
suffix:semicolon
id|count
op_assign
id|cmf_read
c_func
(paren
id|cdev
comma
id|cmb_sample_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
)paren
id|interval
op_div_assign
id|count
suffix:semicolon
r_else
id|interval
op_assign
op_minus
l_int|1
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%ld&bslash;n&quot;
comma
id|interval
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|cmb_show_avg_utilization
id|cmb_show_avg_utilization
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|cmbdata
id|data
suffix:semicolon
id|u64
id|utilization
suffix:semicolon
r_int
r_int
id|t
comma
id|u
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|cmf_readall
c_func
(paren
id|to_ccwdev
c_func
(paren
id|dev
)paren
comma
op_amp
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|utilization
op_assign
id|data.device_connect_time
op_plus
id|data.function_pending_time
op_plus
id|data.device_disconnect_time
suffix:semicolon
multiline_comment|/* shift to avoid long long division */
r_while
c_loop
(paren
op_minus
l_int|1ul
OL
(paren
id|data.elapsed_time
op_or
id|utilization
)paren
)paren
(brace
id|utilization
op_rshift_assign
l_int|8
suffix:semicolon
id|data.elapsed_time
op_rshift_assign
l_int|8
suffix:semicolon
)brace
multiline_comment|/* calculate value in 0.1 percent units */
id|t
op_assign
(paren
r_int
r_int
)paren
id|data.elapsed_time
op_div
l_int|1000
suffix:semicolon
id|u
op_assign
(paren
r_int
r_int
)paren
id|utilization
op_div
id|t
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%02ld.%01ld%%&bslash;n&quot;
comma
id|u
op_div
l_int|10
comma
id|u
op_minus
(paren
id|u
op_div
l_int|10
)paren
op_star
l_int|10
)paren
suffix:semicolon
)brace
DECL|macro|cmf_attr
mdefine_line|#define cmf_attr(name) &bslash;&n;static ssize_t show_ ## name (struct device * dev, char * buf) &bslash;&n;{ return cmb_show_attr((dev), buf, cmb_ ## name); } &bslash;&n;static DEVICE_ATTR(name, 0444, show_ ## name, NULL);
DECL|macro|cmf_attr_avg
mdefine_line|#define cmf_attr_avg(name) &bslash;&n;static ssize_t show_avg_ ## name (struct device * dev, char * buf) &bslash;&n;{ return cmb_show_attr((dev), buf, cmb_ ## name); } &bslash;&n;static DEVICE_ATTR(avg_ ## name, 0444, show_avg_ ## name, NULL);
DECL|variable|ssch_rsch_count
id|cmf_attr
c_func
(paren
id|ssch_rsch_count
)paren
suffix:semicolon
DECL|variable|sample_count
id|cmf_attr
c_func
(paren
id|sample_count
)paren
suffix:semicolon
DECL|variable|device_connect_time
id|cmf_attr_avg
c_func
(paren
id|device_connect_time
)paren
suffix:semicolon
DECL|variable|function_pending_time
id|cmf_attr_avg
c_func
(paren
id|function_pending_time
)paren
suffix:semicolon
DECL|variable|device_disconnect_time
id|cmf_attr_avg
c_func
(paren
id|device_disconnect_time
)paren
suffix:semicolon
DECL|variable|control_unit_queuing_time
id|cmf_attr_avg
c_func
(paren
id|control_unit_queuing_time
)paren
suffix:semicolon
DECL|variable|device_active_only_time
id|cmf_attr_avg
c_func
(paren
id|device_active_only_time
)paren
suffix:semicolon
DECL|variable|device_busy_time
id|cmf_attr_avg
c_func
(paren
id|device_busy_time
)paren
suffix:semicolon
DECL|variable|initial_command_response_time
id|cmf_attr_avg
c_func
(paren
id|initial_command_response_time
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|avg_sample_interval
comma
l_int|0444
comma
id|cmb_show_avg_sample_interval
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|avg_utilization
comma
l_int|0444
comma
id|cmb_show_avg_utilization
comma
l_int|NULL
)paren
suffix:semicolon
DECL|variable|cmf_attributes
r_static
r_struct
id|attribute
op_star
id|cmf_attributes
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_avg_sample_interval.attr
comma
op_amp
id|dev_attr_avg_utilization.attr
comma
op_amp
id|dev_attr_ssch_rsch_count.attr
comma
op_amp
id|dev_attr_sample_count.attr
comma
op_amp
id|dev_attr_avg_device_connect_time.attr
comma
op_amp
id|dev_attr_avg_function_pending_time.attr
comma
op_amp
id|dev_attr_avg_device_disconnect_time.attr
comma
op_amp
id|dev_attr_avg_control_unit_queuing_time.attr
comma
op_amp
id|dev_attr_avg_device_active_only_time.attr
comma
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|cmf_attr_group
r_static
r_struct
id|attribute_group
id|cmf_attr_group
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;cmf&quot;
comma
dot
id|attrs
op_assign
id|cmf_attributes
comma
)brace
suffix:semicolon
DECL|variable|cmf_attributes_ext
r_static
r_struct
id|attribute
op_star
id|cmf_attributes_ext
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_avg_sample_interval.attr
comma
op_amp
id|dev_attr_avg_utilization.attr
comma
op_amp
id|dev_attr_ssch_rsch_count.attr
comma
op_amp
id|dev_attr_sample_count.attr
comma
op_amp
id|dev_attr_avg_device_connect_time.attr
comma
op_amp
id|dev_attr_avg_function_pending_time.attr
comma
op_amp
id|dev_attr_avg_device_disconnect_time.attr
comma
op_amp
id|dev_attr_avg_control_unit_queuing_time.attr
comma
op_amp
id|dev_attr_avg_device_active_only_time.attr
comma
op_amp
id|dev_attr_avg_device_busy_time.attr
comma
op_amp
id|dev_attr_avg_initial_command_response_time.attr
comma
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|cmf_attr_group_ext
r_static
r_struct
id|attribute_group
id|cmf_attr_group_ext
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;cmf&quot;
comma
dot
id|attrs
op_assign
id|cmf_attributes_ext
comma
)brace
suffix:semicolon
DECL|function|cmb_enable_show
r_static
id|ssize_t
id|cmb_enable_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|to_ccwdev
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|cmb
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|cmb_enable_store
r_static
id|ssize_t
id|cmb_enable_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|c
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|buf
(braket
l_int|0
)braket
)paren
(brace
r_case
l_char|&squot;0&squot;
suffix:colon
id|ret
op_assign
id|disable_cmf
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;disable_cmf failed (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;1&squot;
suffix:colon
id|ret
op_assign
id|enable_cmf
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_and
id|ret
op_ne
op_minus
id|EBUSY
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;enable_cmf failed (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|c
suffix:semicolon
)brace
id|DEVICE_ATTR
c_func
(paren
id|cmb_enable
comma
l_int|0644
comma
id|cmb_enable_show
comma
id|cmb_enable_store
)paren
suffix:semicolon
multiline_comment|/* enable_cmf/disable_cmf: module interface for cmf (de)activation */
r_int
DECL|function|enable_cmf
id|enable_cmf
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|cmbops
op_member_access_from_pointer
id|alloc
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|cmbops
op_member_access_from_pointer
id|reset
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|ret
op_assign
id|cmbops
op_member_access_from_pointer
id|set
c_func
(paren
id|cdev
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|cmbops
op_member_access_from_pointer
id|free
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|sysfs_create_group
c_func
(paren
op_amp
id|cdev-&gt;dev.kobj
comma
id|cmbops-&gt;attr_group
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_return
l_int|0
suffix:semicolon
id|cmbops
op_member_access_from_pointer
id|set
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|//FIXME: this can fail
id|cmbops
op_member_access_from_pointer
id|free
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_int
DECL|function|disable_cmf
id|disable_cmf
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|cmbops
op_member_access_from_pointer
id|set
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|cmbops
op_member_access_from_pointer
id|free
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|sysfs_remove_group
c_func
(paren
op_amp
id|cdev-&gt;dev.kobj
comma
id|cmbops-&gt;attr_group
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|u64
DECL|function|cmf_read
id|cmf_read
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|index
)paren
(brace
r_return
id|cmbops
op_member_access_from_pointer
id|read
c_func
(paren
id|cdev
comma
id|index
)paren
suffix:semicolon
)brace
r_int
DECL|function|cmf_readall
id|cmf_readall
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|cmbdata
op_star
id|data
)paren
(brace
r_return
id|cmbops
op_member_access_from_pointer
id|readall
c_func
(paren
id|cdev
comma
id|data
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|init_cmf
id|init_cmf
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|format_string
suffix:semicolon
r_char
op_star
id|detect_string
op_assign
l_string|&quot;parameter&quot;
suffix:semicolon
multiline_comment|/* We cannot really autoprobe this. If the user did not give a parameter,&n;&t;   see if we are running on z990 or up, otherwise fall back to basic mode. */
r_if
c_cond
(paren
id|format
op_eq
id|CMF_AUTODETECT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|css_characteristics_avail
op_logical_or
op_logical_neg
id|css_general_characteristics.ext_mb
)paren
(brace
id|format
op_assign
id|CMF_BASIC
suffix:semicolon
)brace
r_else
(brace
id|format
op_assign
id|CMF_EXTENDED
suffix:semicolon
)brace
id|detect_string
op_assign
l_string|&quot;autodetected&quot;
suffix:semicolon
)brace
r_else
(brace
id|detect_string
op_assign
l_string|&quot;parameter&quot;
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|format
)paren
(brace
r_case
id|CMF_BASIC
suffix:colon
id|format_string
op_assign
l_string|&quot;basic&quot;
suffix:semicolon
id|cmbops
op_assign
op_amp
id|cmbops_basic
suffix:semicolon
r_if
c_cond
(paren
id|cmb_area.num_channels
OG
l_int|4096
op_logical_or
id|cmb_area.num_channels
OL
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Basic channel measurement facility&quot;
l_string|&quot; can only use 1 to 4096 devices&bslash;n&quot;
id|KERN_ERR
l_string|&quot;when the cmf driver is built&quot;
l_string|&quot; as a loadable module&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CMF_EXTENDED
suffix:colon
id|format_string
op_assign
l_string|&quot;extended&quot;
suffix:semicolon
id|cmbops
op_assign
op_amp
id|cmbops_extended
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Invalid format %d for channel &quot;
l_string|&quot;measurement facility&bslash;n&quot;
comma
id|format
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Channel measurement facility using %s format (%s)&bslash;n&quot;
comma
id|format_string
comma
id|detect_string
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|init_cmf
id|module_init
c_func
(paren
id|init_cmf
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Arnd Bergmann &lt;arndb@de.ibm.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;channel measurement facility base driver&bslash;n&quot;
l_string|&quot;Copyright 2003 IBM Corporation&bslash;n&quot;
)paren
suffix:semicolon
DECL|variable|enable_cmf
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|enable_cmf
)paren
suffix:semicolon
DECL|variable|disable_cmf
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|disable_cmf
)paren
suffix:semicolon
DECL|variable|cmf_read
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cmf_read
)paren
suffix:semicolon
DECL|variable|cmf_readall
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|cmf_readall
)paren
suffix:semicolon
eof
