multiline_comment|/*&n; *  drivers/s390/cio/chsc.c&n; *   S/390 common I/O routines -- channel subsystem call&n; *   $Revision: 1.9 $&n; *&n; *    Copyright (C) 1999-2002 IBM Deutschland Entwicklung GmbH,&n; *                            IBM Corporation&n; *    Author(s): Ingo Adlung (adlung@de.ibm.com)&n; *               Cornelia Huck (cohuck@de.ibm.com) &n; *&t;&t; Arnd Bergmann (arndb@de.ibm.com)&n; *    ChangeLog: 11/04/2002 Arnd Bergmann Split s390io.c into multiple files,&n; *&t;&t;&t;&t;&t;  see s390io.c for complete list of&n; *&t;&t;&t;&t;&t;  changes.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/s390io.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &quot;cio_debug.h&quot;
macro_line|#include &quot;s390io.h&quot;
macro_line|#include &quot;proc.h&quot;
macro_line|#include &quot;ioinfo.h&quot;
macro_line|#ifdef CONFIG_DEBUG_CHSC
DECL|macro|DBGC
mdefine_line|#define DBGC printk
macro_line|#else
DECL|macro|DBGC
mdefine_line|#define DBGC(args,...) do {} while (0)
macro_line|#endif
DECL|macro|CHSC_DEBUG
mdefine_line|#define CHSC_DEBUG(printk_level,event_type,event_level,msg...) ({&bslash;&n;&t;if (cio_show_msg) DBGC(printk_level msg); &bslash;&n;&t;CIO_ ## event_type ## _EVENT (event_level, msg); &bslash;&n;})
DECL|variable|chpids
r_static
id|__u64
id|chpids
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* 256 chpids */
DECL|variable|chpids_logical
r_static
id|__u64
id|chpids_logical
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|chpids_known
r_static
id|__u64
id|chpids_known
(braket
l_int|4
)braket
suffix:semicolon
DECL|variable|cio_chsc_desc_avail
r_static
r_int
id|cio_chsc_desc_avail
suffix:semicolon
r_int
DECL|function|chsc_chpid_logical
id|chsc_chpid_logical
(paren
r_int
id|irq
comma
r_int
id|chp
)paren
(brace
r_return
id|test_bit
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.chpid
(braket
id|chp
)braket
comma
op_amp
id|chpids_logical
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME: this is _always_ called for every subchannel. shouldn&squot;t we&n; * &t;  process more than one at a time?*/
r_static
r_int
DECL|function|chsc_get_sch_desc_irq
id|chsc_get_sch_desc_irq
c_func
(paren
r_int
id|irq
)paren
(brace
r_int
id|j
op_assign
l_int|0
suffix:semicolon
r_int
id|ccode
suffix:semicolon
multiline_comment|/* FIXME: chsc_area_sei cannot be on the stack since it needs to&n;&t; * be page-aligned. Implement proper locking or dynamic&n;&t; * allocation or prove that this function does not have to be&n;&t; * reentrant! */
r_static
id|chsc_area_t
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
id|PAGE_SIZE
)paren
)paren
)paren
id|chsc_area_ssd
suffix:semicolon
id|typeof
(paren
id|chsc_area_ssd.response_block.response_block_data.ssd_res
)paren
op_star
id|ssd_res
op_assign
op_amp
id|chsc_area_ssd.response_block.response_block_data.ssd_res
suffix:semicolon
id|chsc_area_ssd
op_assign
(paren
id|chsc_area_t
)paren
(brace
id|request_block
suffix:colon
(brace
id|command_code1
suffix:colon
l_int|0x0010
comma
id|command_code2
suffix:colon
l_int|0x0004
comma
id|request_block_data
suffix:colon
(brace
id|ssd_req
suffix:colon
(brace
id|f_sch
suffix:colon
id|irq
comma
id|l_sch
suffix:colon
id|irq
comma
)brace
)brace
)brace
)brace
suffix:semicolon
id|ccode
op_assign
id|chsc
c_func
(paren
op_amp
id|chsc_area_ssd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cio_show_msg
)paren
id|DBGC
c_func
(paren
id|KERN_DEBUG
l_string|&quot;chsc returned with ccode = %d&bslash;n&quot;
comma
id|ccode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
op_eq
l_int|3
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|chsc_area_ssd.response_block.response_code
)paren
(brace
r_case
l_int|0x0001
suffix:colon
multiline_comment|/* everything ok */
r_break
suffix:semicolon
r_case
l_int|0x0002
suffix:colon
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;Invalid command!&bslash;n&quot;
)paren
suffix:semicolon
r_case
l_int|0x0003
suffix:colon
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;Error in chsc request block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
l_int|0x0004
suffix:colon
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;Model does not provide ssd&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_default
suffix:colon
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;Unknown CHSC response %d&bslash;n&quot;
comma
id|chsc_area_ssd.response_block.response_code
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* ssd_res-&gt;st stores the type of the detected&n;&t; * subchannel, with the following definitions:&n;&t; * &n;&t; * 0: I/O subchannel:&t;  All fields have meaning&n;&t; * 1: CHSC subchannel:&t;  Only sch_val, st and sch&n;&t; * &t;&t;&t;  have meaning&n;&t; * 2: Message subchannel: All fields except unit_addr&n;&t; * &t;&t;&t;  have meaning&n;&t; * 3: ADM subchannel:&t;  Only sch_val, st and sch&n;&t; * &t;&t;&t;  have meaning&n;&t; *&n;&t; * Other types are currently undefined.&n;&t; *&n;&t; */
r_if
c_cond
(paren
id|ssd_res-&gt;st
OG
l_int|3
)paren
(brace
multiline_comment|/* uhm, that looks strange... */
id|CHSC_DEBUG
(paren
id|KERN_DEBUG
comma
id|CRW
comma
l_int|0
comma
l_string|&quot;Strange subchannel type %d&quot;
l_string|&quot; for sch %x&bslash;n&quot;
comma
id|ssd_res-&gt;st
comma
id|irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * There may have been a new subchannel type defined in the &n;&t;&t; * time since this code was written; since we don&squot;t know which&n;&t;&t; * fields have meaning and what to do with it we just jump out&n;&t;&t; */
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_const
r_char
id|type
(braket
l_int|4
)braket
(braket
l_int|8
)braket
op_assign
(brace
l_string|&quot;I/O&quot;
comma
l_string|&quot;chsc&quot;
comma
l_string|&quot;message&quot;
comma
l_string|&quot;ADM&quot;
)brace
suffix:semicolon
id|CHSC_DEBUG
(paren
id|KERN_DEBUG
comma
id|CRW
comma
l_int|6
comma
l_string|&quot;ssd: sch %x is %s subchannel&bslash;n&quot;
comma
id|irq
comma
id|type
(braket
id|ssd_res-&gt;st
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
multiline_comment|/* FIXME: we should do device rec. here... */
r_return
l_int|0
suffix:semicolon
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.valid
op_assign
l_int|1
suffix:semicolon
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.type
op_assign
id|ssd_res-&gt;st
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ssd_res-&gt;st
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* fall through */
r_case
l_int|2
suffix:colon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|0x80
op_rshift
id|j
)paren
op_amp
id|ssd_res-&gt;path_mask
op_amp
id|ssd_res-&gt;fla_valid_mask
)paren
(brace
id|u8
id|chpid
op_assign
id|ssd_res-&gt;chpid
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chpid
op_logical_and
(paren
op_logical_neg
id|test_and_set_bit
(paren
id|chpid
comma
op_amp
id|chpids_known
)paren
)paren
op_logical_and
(paren
id|test_bit
(paren
id|chpid
comma
op_amp
id|chpids_logical
)paren
)paren
)paren
id|set_bit
(paren
id|chpid
comma
op_amp
id|chpids
)paren
suffix:semicolon
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.chpid
(braket
id|j
)braket
op_assign
id|chpid
suffix:semicolon
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.fla
(braket
id|j
)braket
op_assign
id|ssd_res-&gt;fla
(braket
id|j
)braket
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|chsc_get_sch_descriptions
id|chsc_get_sch_descriptions
c_func
(paren
r_void
)paren
(brace
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;gsdesc&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * get information about chpids and link addresses &n;&t; * by executing the chsc command &squot;store subchannel description&squot;&n;&t; */
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
op_le
id|highest_subchannel
suffix:semicolon
id|irq
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * retrieve information for each sch&n;&t;&t; */
id|err
op_assign
id|chsc_get_sch_desc_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_static
r_int
id|cio_chsc_err_msg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cio_chsc_err_msg
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;chsc_get_sch_descriptions:&quot;
l_string|&quot; Error %d while doing chsc; &quot;
l_string|&quot;processing some machine checks may &quot;
l_string|&quot;not work&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|cio_chsc_err_msg
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
)brace
id|cio_chsc_desc_avail
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|chsc_get_sch_descriptions
id|__initcall
c_func
(paren
id|chsc_get_sch_descriptions
)paren
suffix:semicolon
multiline_comment|/* FIXME: don&squot;t iterate all subchannels but use the list of known ones*/
r_static
r_inline
r_void
DECL|function|s390_do_chpid_processing
id|s390_do_chpid_processing
c_func
(paren
id|__u8
id|chpid
)paren
(brace
r_int
id|irq
suffix:semicolon
r_int
id|j
suffix:semicolon
r_int
id|mask
suffix:semicolon
r_char
id|dbf_txt
(braket
l_int|15
)braket
suffix:semicolon
r_int
id|ccode
suffix:semicolon
r_int
id|was_oper
suffix:semicolon
r_int
id|chp
op_assign
l_int|0
suffix:semicolon
r_int
id|mask2
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_txt
comma
l_string|&quot;chpr%x&quot;
comma
id|chpid
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_txt
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * TODO: the chpid may be not the chpid with the link incident,&n;&t; * but the chpid the report came in through. How to handle???&n;&t; */
id|clear_bit
c_func
(paren
id|chpid
comma
op_amp
id|chpids
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_clear_bit
c_func
(paren
id|chpid
comma
op_amp
id|chpids_known
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* we didn&squot;t know the chpid anyway */
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
op_le
id|highest_subchannel
suffix:semicolon
id|irq
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
r_continue
suffix:semicolon
multiline_comment|/* we don&squot;t know the device anyway */
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_continue
suffix:semicolon
multiline_comment|/* non-io subchannel */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.chpid
(braket
id|j
)braket
op_ne
id|chpid
)paren
r_continue
suffix:semicolon
multiline_comment|/* &n; &t;&t;&t; * Note: irq spinlock is grabbed several times&n; &t;&t;&t; * in here&n; &t;&t;&t; */
id|mask2
op_assign
l_int|0x80
op_rshift
id|j
suffix:semicolon
id|s390_send_nop
(paren
id|irq
comma
id|mask2
)paren
suffix:semicolon
id|s390irq_spin_lock
c_func
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * FIXME: is this neccessary?&n;&t;&t;&t; */
id|ccode
op_assign
id|stsch
c_func
(paren
id|irq
comma
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
)paren
(brace
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;do_crw_pending: device on &quot;
l_string|&quot;sch %x is not operational&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.oper
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pim
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pam
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pom
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
)paren
(brace
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
op_le
l_int|7
suffix:semicolon
id|chp
op_increment
)paren
(brace
id|mask2
op_assign
l_int|0x80
op_rshift
id|chp
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_amp
id|mask2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_bit
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.chpid
(braket
id|chp
)braket
comma
op_amp
id|chpids_logical
)paren
)paren
(brace
multiline_comment|/* disable using this path */
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_and_assign
op_complement
id|mask2
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * sh*t, our last path has gone...&n;&t;&t;&t;&t; * Set the device status to not operational&n;&t;&t;&t;&t; * and eventually notify the device driver&n;&t;&t;&t;&t; */
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;do_crw_pending: Last path gone&quot;
l_string|&quot; for device %x, sch %x&bslash;n&quot;
comma
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|devno
comma
id|irq
)paren
suffix:semicolon
id|was_oper
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.oper
suffix:semicolon
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.oper
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|was_oper
op_logical_and
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.ready
)paren
(brace
id|not_oper_handler_func_t
id|nopfunc
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|nopfunc
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|irq_desc.dev_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nopfunc
)paren
id|nopfunc
c_func
(paren
id|irq
comma
id|DEVSTAT_DEVICE_GONE
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.ready
)paren
(brace
multiline_comment|/* &n;&t;&t;&t;&t; * Re-do path verification for the chpid in question&n;&t;&t;&t;&t; * FIXME: is this neccessary?&n;&t;&t;&t;&t; */
id|mask
op_assign
l_int|0x80
op_rshift
id|j
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s390_DevicePathVerification
c_func
(paren
id|irq
comma
id|mask
)paren
)paren
(brace
id|CHSC_DEBUG
(paren
id|KERN_DEBUG
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;DevicePathVerification &quot;
l_string|&quot;successful for Subchannel %x, &quot;
l_string|&quot;chpid %x&bslash;n&quot;
comma
id|irq
comma
id|chpid
)paren
suffix:semicolon
)brace
)brace
id|s390irq_spin_unlock
c_func
(paren
id|irq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* this used to be in s390_process_res_acc_*, FIXME: find a better name&n; * for this function */
r_static
r_int
DECL|function|s390_check_valid_chpid
id|s390_check_valid_chpid
c_func
(paren
id|u8
id|chpid
)paren
(brace
r_char
id|dbf_txt
(braket
l_int|15
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_txt
comma
l_string|&quot;accpr%x&quot;
comma
id|chpid
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_txt
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * I/O resources may have become accessible.&n;&t; * Scan through all subchannels that may be concerned and&n;&t; * do a validation on those.&n;&t; * The more information we have (info), the less scanning&n;&t; * will we have to do.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|cio_chsc_desc_avail
)paren
id|chsc_get_sch_descriptions
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cio_chsc_desc_avail
)paren
(brace
multiline_comment|/*&n;&t;&t; * Something went wrong...&n;&t;&t; */
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|0
comma
l_string|&quot;Error: Could not retrieve &quot;
l_string|&quot;subchannel descriptions, will not process css&quot;
l_string|&quot;machine check...&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|chpid
comma
op_amp
id|chpids_logical
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no need to do the rest */
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|s390_process_res_acc_chpid
id|s390_process_res_acc_chpid
(paren
id|u8
id|chpid
)paren
(brace
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
r_int
id|ccode
suffix:semicolon
r_int
id|chp
suffix:semicolon
r_int
id|mask
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s390_check_valid_chpid
c_func
(paren
id|chpid
)paren
)paren
r_return
suffix:semicolon
id|DBGC
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Looking at chpid %x...&bslash;n&quot;
comma
id|chpid
)paren
suffix:semicolon
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
op_le
id|__MAX_SUBCHANNELS
suffix:semicolon
id|irq
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * We don&squot;t know the device yet, but since a path&n;&t;&t;&t; * may be available now to the device we&squot;ll have&n;&t;&t;&t; * to do recognition again.&n;&t;&t;&t; * Since we don&squot;t have any idea about which chpid&n;&t;&t;&t; * that beast may be on we&squot;ll have to do a stsch&n;&t;&t;&t; * on all devices, grr...&n;&t;&t;&t; */
r_int
id|valret
op_assign
l_int|0
suffix:semicolon
id|valret
op_assign
id|s390_validate_subchannel
c_func
(paren
id|irq
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|valret
op_eq
op_minus
id|ENXIO
)paren
(brace
multiline_comment|/* We&squot;re through */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
OG
id|highest_subchannel
)paren
id|highest_subchannel
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|valret
op_eq
l_int|0
)paren
id|s390_device_recognition_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Send nops down each path to find out&n;&t;&t; * which path is there&n;&t;&t; */
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
op_le
l_int|7
suffix:semicolon
id|chp
op_increment
)paren
(brace
id|mask
op_assign
l_int|0x80
op_rshift
id|chp
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * check if chpid is in information&n;&t;&t;&t; * updated by ssd&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.valid
)paren
op_logical_and
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.chpid
(braket
id|chp
)braket
op_eq
id|chpid
)paren
)paren
id|ret
op_assign
id|s390_send_nop
(paren
id|irq
comma
id|mask
)paren
suffix:semicolon
)brace
id|ccode
op_assign
id|stsch
c_func
(paren
id|irq
comma
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
OG
l_int|0
)paren
(brace
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.oper
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pim
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pam
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pom
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
)paren
(brace
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
op_le
l_int|7
suffix:semicolon
id|chp
op_increment
)paren
(brace
id|mask
op_assign
l_int|0x80
op_rshift
id|chp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_amp
id|mask
)paren
op_logical_and
op_logical_neg
id|test_bit
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.chpid
(braket
id|chp
)braket
comma
op_amp
id|chpids_logical
)paren
)paren
(brace
multiline_comment|/* disable using this path */
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_and_assign
op_complement
id|mask
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.ready
)paren
op_logical_and
(paren
id|chpid
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
)paren
)paren
id|s390_DevicePathVerification
c_func
(paren
id|irq
comma
id|chpid
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|s390_process_res_acc_linkaddr
id|s390_process_res_acc_linkaddr
(paren
id|__u8
id|chpid
comma
id|__u16
id|fla
comma
id|u32
id|fla_mask
)paren
(brace
r_char
id|dbf_txt
(braket
l_int|15
)braket
suffix:semicolon
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
r_int
id|ccode
suffix:semicolon
r_int
id|chp
suffix:semicolon
r_int
id|mask
comma
id|mask2
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|j
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s390_check_valid_chpid
c_func
(paren
id|chpid
)paren
)paren
r_return
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_txt
comma
l_string|&quot;fla%x&quot;
comma
id|fla
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_txt
)paren
suffix:semicolon
id|DBGC
(paren
id|KERN_DEBUG
l_string|&quot;Looking at chpid %x, link addr %x...&bslash;n&quot;
comma
id|chpid
comma
id|fla
)paren
suffix:semicolon
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
op_le
id|__MAX_SUBCHANNELS
suffix:semicolon
id|irq
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
(brace
multiline_comment|/* The full program again (see above), grr... */
r_int
id|valret
op_assign
l_int|0
suffix:semicolon
id|valret
op_assign
id|s390_validate_subchannel
c_func
(paren
id|irq
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|valret
op_eq
op_minus
id|ENXIO
)paren
(brace
multiline_comment|/* We&squot;re done */
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
OG
id|highest_subchannel
)paren
id|highest_subchannel
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|valret
op_eq
l_int|0
)paren
id|s390_device_recognition_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Walk through all subchannels and&n;&t;&t; * look if our chpid and our (masked) link &n;&t;&t; * address are in somewhere&n;&t;&t; * Do a stsch for the found subchannels and&n;&t;&t; * perform path grouping  &n;&t;&t; */
multiline_comment|/* Update our ssd_info */
r_if
c_cond
(paren
id|chsc_get_sch_desc_irq
c_func
(paren
id|irq
)paren
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.chpid
(braket
id|j
)braket
op_eq
id|chpid
)paren
op_logical_and
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.fla
(braket
id|j
)braket
op_amp
id|fla_mask
)paren
op_eq
id|fla
)paren
)paren
(brace
id|mask2
op_assign
l_int|0x80
op_rshift
id|j
suffix:semicolon
id|ret
op_assign
id|s390_send_nop
(paren
id|irq
comma
id|mask2
)paren
suffix:semicolon
id|ccode
op_assign
id|stsch
c_func
(paren
id|irq
comma
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
OG
l_int|0
)paren
r_break
suffix:semicolon
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pim
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pam
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.pom
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
)paren
(brace
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
op_le
l_int|7
suffix:semicolon
id|chp
op_increment
)paren
(brace
id|mask
op_assign
l_int|0x80
op_rshift
id|chp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_amp
id|mask
)paren
op_logical_and
(paren
op_logical_neg
id|test_bit
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.chpid
(braket
id|chp
)braket
comma
op_amp
id|chpids_logical
)paren
)paren
)paren
(brace
multiline_comment|/* disable using this path */
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|opm
op_and_assign
op_complement
id|mask
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.ready
)paren
id|s390_DevicePathVerification
c_func
(paren
id|irq
comma
id|chpid
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_void
DECL|function|s390_process_css
id|s390_process_css
c_func
(paren
r_void
)paren
(brace
r_int
id|ccode
suffix:semicolon
multiline_comment|/* &n;&t; * build the chsc request block for store event information &n;&t; * and do the call &n;&t; */
multiline_comment|/* FIXME: chsc_area_sei cannot be on the stack since it needs to&n;&t; * be page-aligned. Implement proper locking or dynamic&n;&t; * allocation or prove that this function does not have to be&n;&t; * reentrant! */
r_static
id|chsc_area_t
id|chsc_area_sei
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
id|PAGE_SIZE
)paren
)paren
)paren
op_assign
(brace
id|request_block
suffix:colon
(brace
id|command_code1
suffix:colon
l_int|0x0010
comma
id|command_code2
suffix:colon
l_int|0x000e
)brace
)brace
suffix:semicolon
id|typeof
(paren
id|chsc_area_sei.response_block.response_block_data.sei_res
)paren
op_star
id|sei_res
op_assign
op_amp
id|chsc_area_sei.response_block.response_block_data.sei_res
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;prcss&quot;
)paren
suffix:semicolon
id|ccode
op_assign
id|chsc
c_func
(paren
op_amp
id|chsc_area_sei
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
OG
l_int|0
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|chsc_area_sei.response_block.response_code
)paren
(brace
multiline_comment|/* for debug purposes, check for problems */
r_case
l_int|0x0001
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* everything ok */
r_case
l_int|0x0002
suffix:colon
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;s390_process_css:&quot;
l_string|&quot;invalid command!&bslash;n&quot;
)paren
suffix:semicolon
r_case
l_int|0x0003
suffix:colon
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;s390_process_css:&quot;
l_string|&quot; error in chsc request block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x0005
suffix:colon
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;s390_process_css:&quot;
l_string|&quot; no event information stored&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|CHSC_DEBUG
(paren
id|KERN_WARNING
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;s390_process_css:&quot;
l_string|&quot; chsc response %d&bslash;n&quot;
comma
id|chsc_area_sei.response_block.response_code
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CHSC_DEBUG
(paren
id|KERN_DEBUG
comma
id|CRW
comma
l_int|4
comma
l_string|&quot;s390_process_css: &quot;
l_string|&quot;event information successfully stored&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sei_res-&gt;rs
op_ne
l_int|4
)paren
(brace
id|CHSC_DEBUG
(paren
id|KERN_ERR
comma
id|CRW
comma
l_int|2
comma
l_string|&quot;s390_process_css: &quot;
l_string|&quot;reporting source (%04X) isn&squot;t a chpid!&quot;
l_string|&quot;Aborting processing of machine check...&bslash;n&quot;
comma
id|sei_res-&gt;rsid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* which kind of information was stored? */
r_switch
c_cond
(paren
id|sei_res-&gt;cc
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* link incident*/
id|CHSC_DEBUG
(paren
id|KERN_DEBUG
comma
id|CRW
comma
l_int|4
comma
l_string|&quot;s390_process_css: &quot;
l_string|&quot;channel subsystem reports link incident,&quot;
l_string|&quot; source is chpid %x&bslash;n&quot;
comma
id|sei_res-&gt;rsid
)paren
suffix:semicolon
id|s390_do_chpid_processing
c_func
(paren
id|sei_res-&gt;rsid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* i/o resource accessibiliy */
id|CHSC_DEBUG
(paren
id|KERN_DEBUG
comma
id|CRW
comma
l_int|4
comma
l_string|&quot;s390_process_css: &quot;
l_string|&quot;channel subsystem &quot;
l_string|&quot;reports some I/O &quot;
l_string|&quot;devices may have become accessable&bslash;n&quot;
)paren
suffix:semicolon
id|DBGC
(paren
id|KERN_DEBUG
l_string|&quot;Data received after sei: &bslash;n&quot;
)paren
suffix:semicolon
id|DBGC
(paren
id|KERN_DEBUG
l_string|&quot;Validity flags: %x&bslash;n&quot;
comma
id|sei_res-&gt;vf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sei_res-&gt;vf
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|DBGC
(paren
id|KERN_DEBUG
l_string|&quot;chpid: %x&bslash;n&quot;
comma
id|sei_res-&gt;rsid
)paren
suffix:semicolon
id|s390_process_res_acc_chpid
(paren
id|sei_res-&gt;rsid
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sei_res-&gt;vf
op_amp
l_int|0xc0
)paren
op_eq
l_int|0x80
)paren
(brace
id|DBGC
(paren
id|KERN_DEBUG
l_string|&quot;chpid: %x link addr: %x&bslash;n&quot;
comma
id|sei_res-&gt;rsid
comma
id|sei_res-&gt;fla
)paren
suffix:semicolon
id|s390_process_res_acc_linkaddr
(paren
id|sei_res-&gt;rsid
comma
id|sei_res-&gt;fla
comma
l_int|0xff00
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sei_res-&gt;vf
op_amp
l_int|0xc0
)paren
op_eq
l_int|0xc0
)paren
(brace
id|DBGC
(paren
id|KERN_DEBUG
l_string|&quot;chpid: %x full link addr: %x&bslash;n&quot;
comma
id|sei_res-&gt;rsid
comma
id|sei_res-&gt;fla
)paren
suffix:semicolon
id|s390_process_res_acc_linkaddr
(paren
id|sei_res-&gt;rsid
comma
id|sei_res-&gt;fla
comma
l_int|0xffff
)paren
suffix:semicolon
)brace
id|DBGC
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* other stuff */
id|CHSC_DEBUG
(paren
id|KERN_DEBUG
comma
id|CRW
comma
l_int|4
comma
l_string|&quot;s390_process_css: &quot;
l_string|&quot;event %d&bslash;n&quot;
comma
id|sei_res-&gt;cc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_PROC_FS
r_static
r_int
id|s390_vary_chpid
c_func
(paren
id|__u8
id|chpid
comma
r_int
id|on
)paren
suffix:semicolon
multiline_comment|/*&n; * Function: cio_parse_chpids_proc_parameters&n; * parse the stuff piped to /proc/chpids&n; */
r_static
r_inline
r_void
DECL|function|cio_parse_chpids_proc_parameters
id|cio_parse_chpids_proc_parameters
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_int
id|onoff
suffix:semicolon
r_int
id|cp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|buf
comma
l_string|&quot;on &quot;
comma
l_int|3
)paren
)paren
(brace
id|onoff
op_assign
l_int|1
suffix:semicolon
id|buf
op_add_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
(paren
id|buf
comma
l_string|&quot;off &quot;
comma
l_int|4
)paren
)paren
(brace
id|onoff
op_assign
l_int|0
suffix:semicolon
id|buf
op_add_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;/proc/chpids: Parse error; &quot;
l_string|&quot;try using &squot;{on,off} &lt;chpid&gt;&squot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|buf
op_eq
l_char|&squot;0&squot;
)paren
(brace
r_if
c_cond
(paren
op_star
(paren
op_increment
id|buf
)paren
op_eq
l_char|&squot;x&squot;
)paren
multiline_comment|/* strip leading zero */
id|buf
op_increment
suffix:semicolon
multiline_comment|/* strip leading x */
)brace
id|cp
op_assign
id|simple_strtoul
(paren
id|buf
comma
op_amp
id|buf
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* interpret anything as hex */
id|chsc_get_sch_descriptions
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cio_chsc_desc_avail
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Could not get chpid status, &quot;
l_string|&quot;vary on/off not available&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|cp
comma
op_amp
id|chpids
)paren
op_ne
id|onoff
)paren
(brace
r_if
c_cond
(paren
id|s390_vary_chpid
c_func
(paren
id|cp
comma
id|onoff
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;/proc/chpids: &quot;
l_string|&quot;Invalid chpid specified&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;/proc/chpids: &quot;
l_string|&quot;Varied chpid %x logically %sline&bslash;n&quot;
comma
id|cp
comma
id|onoff
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;/proc/chpids: chpid %x is &quot;
l_string|&quot;already %sline&bslash;n&quot;
comma
id|cp
comma
id|onoff
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Function: s390_vary_chpid&n; * Varies the specified chpid online or offline&n; */
r_static
r_int
DECL|function|s390_vary_chpid
id|s390_vary_chpid
c_func
(paren
id|__u8
id|chpid
comma
r_int
id|on
)paren
(brace
r_char
id|dbf_text
(braket
l_int|15
)braket
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|chpid
op_le
l_int|0
)paren
op_logical_or
(paren
id|chpid
op_ge
id|NR_CHPIDS
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
id|on
ques
c_cond
l_string|&quot;varyon%x&quot;
suffix:colon
l_string|&quot;varyoff%x&quot;
comma
id|chpid
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_text
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|chpid
comma
op_amp
id|chpids_known
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t vary unknown chpid %02X&bslash;n&quot;
comma
id|chpid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|on
)paren
(brace
id|set_bit
c_func
(paren
id|chpid
comma
op_amp
id|chpids_logical
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|chpid
comma
op_amp
id|chpids
)paren
suffix:semicolon
)brace
r_else
(brace
id|clear_bit
c_func
(paren
id|chpid
comma
op_amp
id|chpids_logical
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|chpid
comma
op_amp
id|chpids
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Redo PathVerification on the devices the chpid connects to&n;&t; */
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
op_le
id|highest_subchannel
suffix:semicolon
id|irq
op_increment
)paren
(brace
r_int
id|chp
suffix:semicolon
multiline_comment|/* &n;&t;&t; * We don&squot;t need to adjust the opm, as this will be done in&n;&t;&t; * DevicePathVerification...&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
op_logical_or
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
op_logical_or
(paren
op_logical_neg
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.valid
)paren
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
OL
l_int|8
suffix:semicolon
id|chp
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ssd_info.chpid
(braket
id|chp
)braket
op_eq
id|chpid
)paren
(brace
id|DBGC
(paren
id|KERN_DEBUG
l_string|&quot;Calling &quot;
l_string|&quot;DevicePathVerification for irq %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
id|s390_DevicePathVerification
c_func
(paren
id|irq
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc/chpids to display available chpids&n; * vary chpids on/off by piping to it&n; */
r_static
r_int
DECL|function|cio_chpids_read
id|cio_chpids_read
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|chp
op_assign
id|off
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_const
r_int
r_int
id|entry_size
op_assign
l_int|23
suffix:semicolon
multiline_comment|/* longest entry is&n;&t;&t;&t;&t;&t;&t;&quot;0xYZ logically offline&bslash;n&quot; */
id|chsc_get_sch_descriptions
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cio_chsc_desc_avail
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;no info available&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|chp
OL
id|NR_CHPIDS
op_logical_and
id|len
op_plus
id|entry_size
OL
id|count
)paren
(brace
r_if
c_cond
(paren
(paren
id|test_bit
c_func
(paren
id|chp
comma
op_amp
id|chpids
)paren
)paren
op_logical_and
id|test_bit
c_func
(paren
id|chp
comma
op_amp
id|chpids_logical
)paren
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;0x%02X online&bslash;n&quot;
comma
id|chp
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|chp
comma
op_amp
id|chpids_known
)paren
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;0x%02X logically offline&bslash;n&quot;
comma
id|chp
)paren
suffix:semicolon
id|chp
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chp
OL
id|NR_CHPIDS
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
(paren
r_char
op_star
)paren
(paren
id|chp
op_minus
id|off
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_int
DECL|function|cio_chpids_write
id|cio_chpids_write
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|user_buf
comma
r_int
r_int
id|user_len
comma
r_void
op_star
id|data
)paren
(brace
r_char
id|buffer
(braket
l_int|16
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
r_if
c_cond
(paren
id|strncpy_from_user
(paren
id|buffer
comma
id|user_buf
comma
id|min
c_func
(paren
l_int|15ul
comma
id|user_len
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|CHSC_DEBUG
(paren
id|KERN_DEBUG
comma
id|MSG
comma
l_int|2
comma
l_string|&quot;/proc/chpids: &squot;%s&squot;&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
id|cio_parse_chpids_proc_parameters
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
id|user_len
suffix:semicolon
)brace
r_static
r_int
DECL|function|cio_chpids_proc_init
id|cio_chpids_proc_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|entry
suffix:semicolon
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;chpids&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
op_amp
id|proc_root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
r_return
l_int|0
suffix:semicolon
id|entry-&gt;read_proc
op_assign
op_amp
id|cio_chpids_read
suffix:semicolon
id|entry-&gt;write_proc
op_assign
op_amp
id|cio_chpids_write
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|cio_chpids_proc_init
id|__initcall
c_func
(paren
id|cio_chpids_proc_init
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_PROC_FS */
eof
