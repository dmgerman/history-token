multiline_comment|/*&n; *  drivers/s390/cio/chsc.c&n; *   S/390 common I/O routines -- channel subsystem call&n; *   $Revision: 1.92 $&n; *&n; *    Copyright (C) 1999-2002 IBM Deutschland Entwicklung GmbH,&n; *&t;&t;&t;      IBM Corporation&n; *    Author(s): Ingo Adlung (adlung@de.ibm.com)&n; *&t;&t; Cornelia Huck (cohuck@de.ibm.com)&n; *&t;&t; Arnd Bergmann (arndb@de.ibm.com)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/cio.h&gt;
macro_line|#include &quot;css.h&quot;
macro_line|#include &quot;cio.h&quot;
macro_line|#include &quot;cio_debug.h&quot;
macro_line|#include &quot;ioasm.h&quot;
macro_line|#include &quot;chsc.h&quot;
DECL|macro|CHPID_LONGS
mdefine_line|#define CHPID_LONGS (256 / (8 * sizeof(long))) /* 256 chpids */
DECL|variable|chps
r_static
r_struct
id|channel_path
op_star
id|chps
(braket
id|NR_CHPIDS
)braket
suffix:semicolon
r_static
r_int
id|new_channel_path
c_func
(paren
r_int
id|chpid
comma
r_int
id|status
)paren
suffix:semicolon
r_static
r_inline
r_void
DECL|function|set_chp_online
id|set_chp_online
c_func
(paren
r_int
id|chp
comma
r_int
id|onoff
)paren
(brace
id|chps
(braket
id|chp
)braket
op_member_access_from_pointer
id|state.online
op_assign
id|onoff
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|set_chp_logically_online
id|set_chp_logically_online
c_func
(paren
r_int
id|chp
comma
r_int
id|onoff
)paren
(brace
id|chps
(braket
id|chp
)braket
op_member_access_from_pointer
id|state.logically_online
op_assign
id|onoff
suffix:semicolon
)brace
r_static
r_int
DECL|function|get_chp_status
id|get_chp_status
c_func
(paren
r_int
id|chp
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chps
(braket
id|chp
)braket
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
id|chps
(braket
id|chp
)braket
op_member_access_from_pointer
id|state.online
ques
c_cond
id|CHP_ONLINE
suffix:colon
id|CHP_STANDBY
suffix:semicolon
r_return
(paren
id|chps
(braket
id|chp
)braket
op_member_access_from_pointer
id|state.logically_online
ques
c_cond
id|ret
suffix:colon
id|ret
op_or
id|CHP_LOGICALLY_OFFLINE
)paren
suffix:semicolon
)brace
r_void
DECL|function|chsc_validate_chpids
id|chsc_validate_chpids
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_int
id|mask
comma
id|chp
suffix:semicolon
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
op_le
l_int|7
suffix:semicolon
id|chp
op_increment
)paren
(brace
id|mask
op_assign
l_int|0x80
op_rshift
id|chp
suffix:semicolon
r_if
c_cond
(paren
id|get_chp_status
c_func
(paren
id|sch-&gt;schib.pmcw.chpid
(braket
id|chp
)braket
)paren
op_amp
id|CHP_LOGICALLY_OFFLINE
)paren
multiline_comment|/* disable using this path */
id|sch-&gt;opm
op_and_assign
op_complement
id|mask
suffix:semicolon
)brace
)brace
multiline_comment|/* FIXME: this is _always_ called for every subchannel. shouldn&squot;t we&n; *&t;  process more than one at a time? */
r_static
r_int
DECL|function|chsc_get_sch_desc_irq
id|chsc_get_sch_desc_irq
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
comma
r_void
op_star
id|page
)paren
(brace
r_int
id|ccode
comma
id|j
suffix:semicolon
r_struct
(brace
r_struct
id|chsc_header
id|request
suffix:semicolon
id|u16
id|reserved1
suffix:semicolon
id|u16
id|f_sch
suffix:semicolon
multiline_comment|/* first subchannel */
id|u16
id|reserved2
suffix:semicolon
id|u16
id|l_sch
suffix:semicolon
multiline_comment|/* last subchannel */
id|u32
id|reserved3
suffix:semicolon
r_struct
id|chsc_header
id|response
suffix:semicolon
id|u32
id|reserved4
suffix:semicolon
id|u8
id|sch_valid
suffix:colon
l_int|1
suffix:semicolon
id|u8
id|dev_valid
suffix:colon
l_int|1
suffix:semicolon
id|u8
id|st
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* subchannel type */
id|u8
id|zeroes
suffix:colon
l_int|3
suffix:semicolon
id|u8
id|unit_addr
suffix:semicolon
multiline_comment|/* unit address */
id|u16
id|devno
suffix:semicolon
multiline_comment|/* device number */
id|u8
id|path_mask
suffix:semicolon
id|u8
id|fla_valid_mask
suffix:semicolon
id|u16
id|sch
suffix:semicolon
multiline_comment|/* subchannel */
id|u8
id|chpid
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* chpids 0-7 */
id|u16
id|fla
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* full link addresses 0-7 */
)brace
op_star
id|ssd_area
suffix:semicolon
id|ssd_area
op_assign
id|page
suffix:semicolon
id|ssd_area-&gt;request
op_assign
(paren
r_struct
id|chsc_header
)paren
(brace
dot
id|length
op_assign
l_int|0x0010
comma
dot
id|code
op_assign
l_int|0x0004
comma
)brace
suffix:semicolon
id|ssd_area-&gt;f_sch
op_assign
id|sch-&gt;irq
suffix:semicolon
id|ssd_area-&gt;l_sch
op_assign
id|sch-&gt;irq
suffix:semicolon
id|ccode
op_assign
id|chsc
c_func
(paren
id|ssd_area
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
OG
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;chsc returned with ccode = %d&bslash;n&quot;
comma
id|ccode
)paren
suffix:semicolon
r_return
(paren
id|ccode
op_eq
l_int|3
)paren
ques
c_cond
op_minus
id|ENODEV
suffix:colon
op_minus
id|EBUSY
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ssd_area-&gt;response.code
)paren
(brace
r_case
l_int|0x0001
suffix:colon
multiline_comment|/* everything ok */
r_break
suffix:semicolon
r_case
l_int|0x0002
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;Invalid command!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
l_int|0x0003
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;Error in chsc request block!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
l_int|0x0004
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;Model does not provide ssd&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_default
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;Unknown CHSC response %d&bslash;n&quot;
comma
id|ssd_area-&gt;response.code
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * ssd_area-&gt;st stores the type of the detected&n;&t; * subchannel, with the following definitions:&n;&t; *&n;&t; * 0: I/O subchannel:&t;  All fields have meaning&n;&t; * 1: CHSC subchannel:&t;  Only sch_val, st and sch&n;&t; *&t;&t;&t;  have meaning&n;&t; * 2: Message subchannel: All fields except unit_addr&n;&t; *&t;&t;&t;  have meaning&n;&t; * 3: ADM subchannel:&t;  Only sch_val, st and sch&n;&t; *&t;&t;&t;  have meaning&n;&t; *&n;&t; * Other types are currently undefined.&n;&t; */
r_if
c_cond
(paren
id|ssd_area-&gt;st
OG
l_int|3
)paren
(brace
multiline_comment|/* uhm, that looks strange... */
id|CIO_CRW_EVENT
c_func
(paren
l_int|0
comma
l_string|&quot;Strange subchannel type %d&quot;
l_string|&quot; for sch %s&bslash;n&quot;
comma
id|ssd_area-&gt;st
comma
id|sch-&gt;dev.bus_id
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * There may have been a new subchannel type defined in the&n;&t;&t; * time since this code was written; since we don&squot;t know which&n;&t;&t; * fields have meaning and what to do with it we just jump out&n;&t;&t; */
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_const
r_char
op_star
id|type
(braket
l_int|4
)braket
op_assign
(brace
l_string|&quot;I/O&quot;
comma
l_string|&quot;chsc&quot;
comma
l_string|&quot;message&quot;
comma
l_string|&quot;ADM&quot;
)brace
suffix:semicolon
id|CIO_CRW_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;ssd: sch %s is %s subchannel&bslash;n&quot;
comma
id|sch-&gt;dev.bus_id
comma
id|type
(braket
id|ssd_area-&gt;st
)braket
)paren
suffix:semicolon
id|sch-&gt;ssd_info.valid
op_assign
l_int|1
suffix:semicolon
id|sch-&gt;ssd_info.type
op_assign
id|ssd_area-&gt;st
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ssd_area-&gt;st
op_eq
l_int|0
op_logical_or
id|ssd_area-&gt;st
op_eq
l_int|2
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
l_int|0x80
op_rshift
id|j
)paren
op_amp
id|ssd_area-&gt;path_mask
op_amp
id|ssd_area-&gt;fla_valid_mask
)paren
)paren
r_continue
suffix:semicolon
id|sch-&gt;ssd_info.chpid
(braket
id|j
)braket
op_assign
id|ssd_area-&gt;chpid
(braket
id|j
)braket
suffix:semicolon
id|sch-&gt;ssd_info.fla
(braket
id|j
)braket
op_assign
id|ssd_area-&gt;fla
(braket
id|j
)braket
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|css_get_ssd_info
id|css_get_ssd_info
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_int
id|ret
suffix:semicolon
r_void
op_star
id|page
suffix:semicolon
id|page
op_assign
(paren
r_void
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
id|ret
op_assign
id|chsc_get_sch_desc_irq
c_func
(paren
id|sch
comma
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_static
r_int
id|cio_chsc_err_msg
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cio_chsc_err_msg
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;chsc_get_sch_descriptions:&quot;
l_string|&quot; Error %d while doing chsc; &quot;
l_string|&quot;processing some machine checks may &quot;
l_string|&quot;not work&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|cio_chsc_err_msg
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_int
id|j
comma
id|chpid
suffix:semicolon
multiline_comment|/* Allocate channel path structures, if needed. */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
id|chpid
op_assign
id|sch-&gt;ssd_info.chpid
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|chpid
op_logical_and
op_logical_neg
id|get_chp_status
c_func
(paren
id|chpid
)paren
)paren
id|new_channel_path
c_func
(paren
id|chpid
comma
id|CHP_ONLINE
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|s390_subchannel_remove_chpid
id|s390_subchannel_remove_chpid
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|j
suffix:semicolon
r_int
id|mask
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|__u8
op_star
id|chpid
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|dev
)paren
suffix:semicolon
id|chpid
op_assign
id|data
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
id|sch-&gt;schib.pmcw.chpid
(braket
id|j
)braket
op_eq
op_star
id|chpid
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|j
op_ge
l_int|8
)paren
r_return
l_int|0
suffix:semicolon
id|mask
op_assign
l_int|0x80
op_rshift
id|j
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;vpm
op_eq
id|mask
)paren
r_goto
id|out_unreg
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sch-&gt;schib.scsw.actl
op_amp
(paren
id|SCSW_ACTL_CLEAR_PEND
op_or
id|SCSW_ACTL_HALT_PEND
op_or
id|SCSW_ACTL_START_PEND
op_or
id|SCSW_ACTL_RESUME_PEND
)paren
)paren
op_logical_and
(paren
id|sch-&gt;schib.pmcw.lpum
op_eq
id|mask
)paren
)paren
(brace
r_int
id|cc
op_assign
id|cio_cancel
c_func
(paren
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cc
op_eq
op_minus
id|ENODEV
)paren
r_goto
id|out_unreg
suffix:semicolon
r_if
c_cond
(paren
id|cc
op_eq
op_minus
id|EINVAL
)paren
(brace
id|cc
op_assign
id|cio_clear
c_func
(paren
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cc
op_eq
op_minus
id|ENODEV
)paren
r_goto
id|out_unreg
suffix:semicolon
multiline_comment|/* Call handler. */
r_if
c_cond
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;termination
)paren
id|sch-&gt;driver
op_member_access_from_pointer
id|termination
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|sch-&gt;schib.scsw.actl
op_amp
id|SCSW_ACTL_DEVACT
)paren
op_logical_and
(paren
id|sch-&gt;schib.scsw.actl
op_amp
id|SCSW_ACTL_SCHACT
)paren
op_logical_and
(paren
id|sch-&gt;schib.pmcw.lpum
op_eq
id|mask
)paren
)paren
(brace
r_int
id|cc
suffix:semicolon
id|cc
op_assign
id|cio_clear
c_func
(paren
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cc
op_eq
op_minus
id|ENODEV
)paren
r_goto
id|out_unreg
suffix:semicolon
multiline_comment|/* Call handler. */
r_if
c_cond
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;termination
)paren
id|sch-&gt;driver
op_member_access_from_pointer
id|termination
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
multiline_comment|/* trigger path verification. */
r_if
c_cond
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;verify
)paren
id|sch-&gt;driver
op_member_access_from_pointer
id|verify
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_unreg
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;notify
op_logical_and
id|sch-&gt;driver
op_member_access_from_pointer
id|notify
c_func
(paren
op_amp
id|sch-&gt;dev
comma
id|CIO_NO_PATH
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
id|sch-&gt;schib.pmcw.intparm
op_assign
l_int|0
suffix:semicolon
id|cio_modify
c_func
(paren
id|sch
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|s390_set_chpid_offline
id|s390_set_chpid_offline
c_func
(paren
id|__u8
id|chpid
)paren
(brace
r_char
id|dbf_txt
(braket
l_int|15
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_txt
comma
l_string|&quot;chpr%x&quot;
comma
id|chpid
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_txt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_chp_status
c_func
(paren
id|chpid
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* we didn&squot;t know the chpid anyway */
id|set_chp_online
c_func
(paren
id|chpid
comma
l_int|0
)paren
suffix:semicolon
id|bus_for_each_dev
c_func
(paren
op_amp
id|css_bus_type
comma
l_int|NULL
comma
op_amp
id|chpid
comma
id|s390_subchannel_remove_chpid
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|s390_process_res_acc_sch
id|s390_process_res_acc_sch
c_func
(paren
id|u8
id|chpid
comma
id|__u16
id|fla
comma
id|u32
id|fla_mask
comma
r_struct
id|subchannel
op_star
id|sch
comma
r_void
op_star
id|page
)paren
(brace
r_int
id|found
suffix:semicolon
r_int
id|chp
suffix:semicolon
r_int
id|ccode
suffix:semicolon
multiline_comment|/* Update our ssd_info */
r_if
c_cond
(paren
id|chsc_get_sch_desc_irq
c_func
(paren
id|sch
comma
id|page
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
op_le
l_int|7
suffix:semicolon
id|chp
op_increment
)paren
multiline_comment|/*&n;&t;&t; * check if chpid is in information updated by ssd&n;&t;&t; */
r_if
c_cond
(paren
id|sch-&gt;ssd_info.valid
op_logical_and
id|sch-&gt;ssd_info.chpid
(braket
id|chp
)braket
op_eq
id|chpid
op_logical_and
(paren
id|sch-&gt;ssd_info.fla
(braket
id|chp
)braket
op_amp
id|fla_mask
)paren
op_eq
id|fla
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Do a stsch to update our subchannel structure with the&n;&t; * new path information and eventually check for logically&n;&t; * offline chpids.&n;&t; */
id|ccode
op_assign
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|0x80
op_rshift
id|chp
suffix:semicolon
)brace
r_static
r_void
DECL|function|s390_process_res_acc
id|s390_process_res_acc
(paren
id|u8
id|chpid
comma
id|__u16
id|fla
comma
id|u32
id|fla_mask
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|irq
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_char
id|dbf_txt
(braket
l_int|15
)braket
suffix:semicolon
r_void
op_star
id|page
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_txt
comma
l_string|&quot;accpr%x&quot;
comma
id|chpid
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_txt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fla
op_ne
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|dbf_txt
comma
l_string|&quot;fla%x&quot;
comma
id|fla
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_txt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * I/O resources may have become accessible.&n;&t; * Scan through all subchannels that may be concerned and&n;&t; * do a validation on those.&n;&t; * The more information we have (info), the less scanning&n;&t; * will we have to do.&n;&t; */
r_if
c_cond
(paren
id|get_chp_status
c_func
(paren
id|chpid
)paren
op_amp
id|CHP_LOGICALLY_OFFLINE
)paren
r_return
suffix:semicolon
multiline_comment|/* no need to do the rest */
id|page
op_assign
(paren
r_void
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
OL
id|__MAX_SUBCHANNELS
suffix:semicolon
id|irq
op_increment
)paren
(brace
r_int
id|chp_mask
suffix:semicolon
id|sch
op_assign
id|get_subchannel_by_schid
c_func
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * We don&squot;t know the device yet, but since a path&n;&t;&t;&t; * may be available now to the device we&squot;ll have&n;&t;&t;&t; * to do recognition again.&n;&t;&t;&t; * Since we don&squot;t have any idea about which chpid&n;&t;&t;&t; * that beast may be on we&squot;ll have to do a stsch&n;&t;&t;&t; * on all devices, grr...&n;&t;&t;&t; */
id|ret
op_assign
id|css_probe_device
c_func
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENXIO
)paren
multiline_comment|/* We&squot;re through */
r_break
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
id|chp_mask
op_assign
id|s390_process_res_acc_sch
c_func
(paren
id|chpid
comma
id|fla
comma
id|fla_mask
comma
id|sch
comma
id|page
)paren
suffix:semicolon
id|clear_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chp_mask
op_eq
l_int|0
)paren
(brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fla_mask
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_else
r_continue
suffix:semicolon
)brace
id|sch-&gt;lpm
op_assign
(paren
(paren
id|sch-&gt;schib.pmcw.pim
op_amp
id|sch-&gt;schib.pmcw.pam
op_amp
id|sch-&gt;schib.pmcw.pom
)paren
op_or
id|chp_mask
)paren
op_amp
id|sch-&gt;opm
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;verify
)paren
id|sch-&gt;driver
op_member_access_from_pointer
id|verify
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fla_mask
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|page
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|__get_chpid_from_lir
id|__get_chpid_from_lir
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|lir
(brace
id|u8
id|iq
suffix:semicolon
id|u8
id|ic
suffix:semicolon
id|u16
id|sci
suffix:semicolon
multiline_comment|/* incident-node descriptor */
id|u32
id|indesc
(braket
l_int|28
)braket
suffix:semicolon
multiline_comment|/* attached-node descriptor */
id|u32
id|andesc
(braket
l_int|28
)braket
suffix:semicolon
multiline_comment|/* incident-specific information */
id|u32
id|isinfo
(braket
l_int|28
)braket
suffix:semicolon
)brace
op_star
id|lir
suffix:semicolon
id|lir
op_assign
(paren
r_struct
id|lir
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lir-&gt;iq
op_amp
l_int|0x80
)paren
)paren
multiline_comment|/* NULL link incident record */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lir-&gt;indesc
(braket
l_int|0
)braket
op_amp
l_int|0xc0000000
)paren
)paren
multiline_comment|/* node descriptor not valid */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lir-&gt;indesc
(braket
l_int|0
)braket
op_amp
l_int|0x10000000
)paren
)paren
multiline_comment|/* don&squot;t handle device-type nodes - FIXME */
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Byte 3 contains the chpid. Could also be CTCA, but we don&squot;t care */
r_return
(paren
id|u16
)paren
(paren
id|lir-&gt;indesc
(braket
l_int|0
)braket
op_amp
l_int|0x000000ff
)paren
suffix:semicolon
)brace
r_void
DECL|function|chsc_process_crw
id|chsc_process_crw
c_func
(paren
r_void
)paren
(brace
r_int
id|chpid
suffix:semicolon
r_struct
(brace
r_struct
id|chsc_header
id|request
suffix:semicolon
id|u32
id|reserved1
suffix:semicolon
id|u32
id|reserved2
suffix:semicolon
id|u32
id|reserved3
suffix:semicolon
r_struct
id|chsc_header
id|response
suffix:semicolon
id|u32
id|reserved4
suffix:semicolon
id|u8
id|flags
suffix:semicolon
id|u8
id|vf
suffix:semicolon
multiline_comment|/* validity flags */
id|u8
id|rs
suffix:semicolon
multiline_comment|/* reporting source */
id|u8
id|cc
suffix:semicolon
multiline_comment|/* content code */
id|u16
id|fla
suffix:semicolon
multiline_comment|/* full link address */
id|u16
id|rsid
suffix:semicolon
multiline_comment|/* reporting source id */
id|u32
id|reserved5
suffix:semicolon
id|u32
id|reserved6
suffix:semicolon
id|u32
id|ccdf
(braket
l_int|96
)braket
suffix:semicolon
multiline_comment|/* content-code dependent field */
multiline_comment|/* ccdf has to be big enough for a link-incident record */
)brace
op_star
id|sei_area
suffix:semicolon
multiline_comment|/*&n;&t; * build the chsc request block for store event information&n;&t; * and do the call&n;&t; */
id|sei_area
op_assign
(paren
r_void
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sei_area
)paren
(brace
id|CIO_CRW_EVENT
c_func
(paren
l_int|0
comma
l_string|&quot;No memory for sei area!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;prcss&quot;
)paren
suffix:semicolon
r_do
(brace
r_int
id|ccode
suffix:semicolon
id|memset
c_func
(paren
id|sei_area
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sei_area
)paren
)paren
suffix:semicolon
id|sei_area-&gt;request
op_assign
(paren
r_struct
id|chsc_header
)paren
(brace
dot
id|length
op_assign
l_int|0x0010
comma
dot
id|code
op_assign
l_int|0x000e
comma
)brace
suffix:semicolon
id|ccode
op_assign
id|chsc
c_func
(paren
id|sei_area
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccode
OG
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_switch
c_cond
(paren
id|sei_area-&gt;response.code
)paren
(brace
multiline_comment|/* for debug purposes, check for problems */
r_case
l_int|0x0001
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;chsc_process_crw: event information &quot;
l_string|&quot;successfully stored&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* everything ok */
r_case
l_int|0x0002
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;chsc_process_crw: invalid command!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
l_int|0x0003
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;chsc_process_crw: error in chsc &quot;
l_string|&quot;request block!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
l_int|0x0005
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;chsc_process_crw: no event &quot;
l_string|&quot;information stored&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;chsc_process_crw: chsc response %d&bslash;n&quot;
comma
id|sei_area-&gt;response.code
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Check if we might have lost some information. */
r_if
c_cond
(paren
id|sei_area-&gt;flags
op_amp
l_int|0x40
)paren
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;chsc_process_crw: Event information &quot;
l_string|&quot;has been lost due to overflow!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sei_area-&gt;rs
op_ne
l_int|4
)paren
(brace
id|CIO_CRW_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;chsc_process_crw: reporting source &quot;
l_string|&quot;(%04X) isn&squot;t a chpid!&bslash;n&quot;
comma
id|sei_area-&gt;rsid
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* which kind of information was stored? */
r_switch
c_cond
(paren
id|sei_area-&gt;cc
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* link incident*/
id|CIO_CRW_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;chsc_process_crw: &quot;
l_string|&quot;channel subsystem reports link incident,&quot;
l_string|&quot; reporting source is chpid %x&bslash;n&quot;
comma
id|sei_area-&gt;rsid
)paren
suffix:semicolon
id|chpid
op_assign
id|__get_chpid_from_lir
c_func
(paren
id|sei_area-&gt;ccdf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chpid
OL
l_int|0
)paren
id|CIO_CRW_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;%s: Invalid LIR, skipping&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_else
id|s390_set_chpid_offline
c_func
(paren
id|chpid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* i/o resource accessibiliy */
id|CIO_CRW_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;chsc_process_crw: &quot;
l_string|&quot;channel subsystem reports some I/O &quot;
l_string|&quot;devices may have become accessible&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Data received after sei: &bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Validity flags: %x&bslash;n&quot;
comma
id|sei_area-&gt;vf
)paren
suffix:semicolon
multiline_comment|/* allocate a new channel path structure, if needed */
r_if
c_cond
(paren
id|chps
(braket
id|sei_area-&gt;rsid
)braket
op_eq
l_int|NULL
)paren
id|new_channel_path
c_func
(paren
id|sei_area-&gt;rsid
comma
id|CHP_ONLINE
)paren
suffix:semicolon
r_else
id|set_chp_online
c_func
(paren
id|sei_area-&gt;rsid
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sei_area-&gt;vf
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;chpid: %x&bslash;n&quot;
comma
id|sei_area-&gt;rsid
)paren
suffix:semicolon
id|s390_process_res_acc
c_func
(paren
id|sei_area-&gt;rsid
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sei_area-&gt;vf
op_amp
l_int|0xc0
)paren
op_eq
l_int|0x80
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;chpid: %x link addr: %x&bslash;n&quot;
comma
id|sei_area-&gt;rsid
comma
id|sei_area-&gt;fla
)paren
suffix:semicolon
id|s390_process_res_acc
c_func
(paren
id|sei_area-&gt;rsid
comma
id|sei_area-&gt;fla
comma
l_int|0xff00
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|sei_area-&gt;vf
op_amp
l_int|0xc0
)paren
op_eq
l_int|0xc0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;chpid: %x full link addr: %x&bslash;n&quot;
comma
id|sei_area-&gt;rsid
comma
id|sei_area-&gt;fla
)paren
suffix:semicolon
id|s390_process_res_acc
c_func
(paren
id|sei_area-&gt;rsid
comma
id|sei_area-&gt;fla
comma
l_int|0xffff
)paren
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* other stuff */
id|CIO_CRW_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;chsc_process_crw: event %d&bslash;n&quot;
comma
id|sei_area-&gt;cc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|sei_area-&gt;flags
op_amp
l_int|0x80
)paren
suffix:semicolon
id|out
suffix:colon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|sei_area
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|chp_add
id|chp_add
c_func
(paren
r_int
id|chpid
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|irq
comma
id|ret
suffix:semicolon
r_char
id|dbf_txt
(braket
l_int|15
)braket
suffix:semicolon
r_if
c_cond
(paren
id|get_chp_status
c_func
(paren
id|chpid
)paren
op_amp
id|CHP_LOGICALLY_OFFLINE
)paren
r_return
suffix:semicolon
multiline_comment|/* no need to do the rest */
id|sprintf
c_func
(paren
id|dbf_txt
comma
l_string|&quot;cadd%x&quot;
comma
id|chpid
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_txt
)paren
suffix:semicolon
r_for
c_loop
(paren
id|irq
op_assign
l_int|0
suffix:semicolon
id|irq
OL
id|__MAX_SUBCHANNELS
suffix:semicolon
id|irq
op_increment
)paren
(brace
r_int
id|i
suffix:semicolon
id|sch
op_assign
id|get_subchannel_by_schid
c_func
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch
)paren
(brace
id|ret
op_assign
id|css_probe_device
c_func
(paren
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENXIO
)paren
multiline_comment|/* We&squot;re through */
r_return
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|sch-&gt;schib.pmcw.chpid
(braket
id|i
)braket
op_eq
id|chpid
)paren
(brace
r_if
c_cond
(paren
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Endgame. */
id|spin_unlock
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|8
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sch-&gt;lpm
op_assign
(paren
(paren
id|sch-&gt;schib.pmcw.pim
op_amp
id|sch-&gt;schib.pmcw.pam
op_amp
id|sch-&gt;schib.pmcw.pom
)paren
op_or
l_int|0x80
op_rshift
id|i
)paren
op_amp
id|sch-&gt;opm
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;verify
)paren
id|sch-&gt;driver
op_member_access_from_pointer
id|verify
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * Handling of crw machine checks with channel path source.&n; */
r_void
DECL|function|chp_process_crw
id|chp_process_crw
c_func
(paren
r_int
id|chpid
comma
r_int
id|on
)paren
(brace
r_if
c_cond
(paren
id|on
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Path has gone. We use the link incident routine.*/
id|s390_set_chpid_offline
c_func
(paren
id|chpid
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &n;&t;&t; * Path has come. Allocate a new channel path structure,&n;&t;&t; * if needed. &n;&t;&t; */
r_if
c_cond
(paren
id|chps
(braket
id|chpid
)braket
op_eq
l_int|NULL
)paren
id|new_channel_path
c_func
(paren
id|chpid
comma
id|CHP_ONLINE
)paren
suffix:semicolon
r_else
id|set_chp_online
c_func
(paren
id|chpid
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Avoid the extra overhead in process_rec_acc. */
id|chp_add
c_func
(paren
id|chpid
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|__check_for_io_and_kill
id|__check_for_io_and_kill
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
comma
r_int
id|index
)paren
(brace
r_int
id|cc
suffix:semicolon
id|cc
op_assign
id|stsch
c_func
(paren
id|sch-&gt;irq
comma
op_amp
id|sch-&gt;schib
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cc
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;schib.scsw.actl
op_logical_and
id|sch-&gt;schib.pmcw.lpum
op_eq
(paren
l_int|0x80
op_rshift
id|index
)paren
)paren
id|device_set_waiting
c_func
(paren
id|sch
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|__s390_subchannel_vary_chpid
id|__s390_subchannel_vary_chpid
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
comma
id|__u8
id|chpid
comma
r_int
id|on
)paren
(brace
r_int
id|chp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;ssd_info.valid
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
OL
l_int|8
suffix:semicolon
id|chp
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sch-&gt;ssd_info.chpid
(braket
id|chp
)braket
op_eq
id|chpid
)paren
(brace
r_if
c_cond
(paren
id|on
)paren
(brace
id|sch-&gt;opm
op_or_assign
(paren
l_int|0x80
op_rshift
id|chp
)paren
suffix:semicolon
id|sch-&gt;lpm
op_or_assign
(paren
l_int|0x80
op_rshift
id|chp
)paren
suffix:semicolon
)brace
r_else
(brace
id|sch-&gt;opm
op_and_assign
op_complement
(paren
l_int|0x80
op_rshift
id|chp
)paren
suffix:semicolon
id|sch-&gt;lpm
op_and_assign
op_complement
(paren
l_int|0x80
op_rshift
id|chp
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Give running I/O a grace period in which it&n;&t;&t;&t;&t; * can successfully terminate, even using the&n;&t;&t;&t;&t; * just varied off path. Then kill it.&n;&t;&t;&t;&t; */
id|__check_for_io_and_kill
c_func
(paren
id|sch
comma
id|chp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sch-&gt;driver
op_logical_and
id|sch-&gt;driver-&gt;verify
)paren
id|sch-&gt;driver
op_member_access_from_pointer
id|verify
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_static
r_int
DECL|function|s390_subchannel_vary_chpid_off
id|s390_subchannel_vary_chpid_off
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|__u8
op_star
id|chpid
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|dev
)paren
suffix:semicolon
id|chpid
op_assign
id|data
suffix:semicolon
id|__s390_subchannel_vary_chpid
c_func
(paren
id|sch
comma
op_star
id|chpid
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|s390_subchannel_vary_chpid_on
id|s390_subchannel_vary_chpid_on
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|__u8
op_star
id|chpid
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|dev
)paren
suffix:semicolon
id|chpid
op_assign
id|data
suffix:semicolon
id|__s390_subchannel_vary_chpid
c_func
(paren
id|sch
comma
op_star
id|chpid
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Function: s390_vary_chpid&n; * Varies the specified chpid online or offline&n; */
r_static
r_int
DECL|function|s390_vary_chpid
id|s390_vary_chpid
c_func
(paren
id|__u8
id|chpid
comma
r_int
id|on
)paren
(brace
r_char
id|dbf_text
(braket
l_int|15
)braket
suffix:semicolon
r_int
id|status
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
id|on
ques
c_cond
l_string|&quot;varyon%x&quot;
suffix:colon
l_string|&quot;varyoff%x&quot;
comma
id|chpid
)paren
suffix:semicolon
id|CIO_TRACE_EVENT
c_func
(paren
l_int|2
comma
id|dbf_text
)paren
suffix:semicolon
id|status
op_assign
id|get_chp_status
c_func
(paren
id|chpid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Can&squot;t vary unknown chpid %02X&bslash;n&quot;
comma
id|chpid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|on
op_logical_and
op_logical_neg
(paren
id|status
op_amp
id|CHP_LOGICALLY_OFFLINE
)paren
)paren
op_logical_or
(paren
op_logical_neg
id|on
op_logical_and
(paren
id|status
op_amp
id|CHP_LOGICALLY_OFFLINE
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;chpid %x is &quot;
l_string|&quot;already %sline&bslash;n&quot;
comma
id|chpid
comma
id|on
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|set_chp_logically_online
c_func
(paren
id|chpid
comma
id|on
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Redo PathVerification on the devices the chpid connects to&n;&t; */
id|bus_for_each_dev
c_func
(paren
op_amp
id|css_bus_type
comma
l_int|NULL
comma
op_amp
id|chpid
comma
id|on
ques
c_cond
id|s390_subchannel_vary_chpid_on
suffix:colon
id|s390_subchannel_vary_chpid_off
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Files for the channel path entries.&n; */
r_static
id|ssize_t
DECL|function|chp_status_show
id|chp_status_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|channel_path
op_star
id|chp
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|channel_path
comma
id|dev
)paren
suffix:semicolon
r_int
id|state
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chp
)paren
r_return
l_int|0
suffix:semicolon
id|state
op_assign
id|get_chp_status
c_func
(paren
id|chp-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|CHP_STANDBY
)paren
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;n/a&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|state
op_amp
id|CHP_LOGICALLY_OFFLINE
)paren
ques
c_cond
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;logically offline&bslash;n&quot;
)paren
suffix:colon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;online&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|chp_status_write
id|chp_status_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|channel_path
op_star
id|cp
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|channel_path
comma
id|dev
)paren
suffix:semicolon
r_char
id|cmd
(braket
l_int|10
)braket
suffix:semicolon
r_int
id|num_args
suffix:semicolon
r_int
id|error
suffix:semicolon
id|num_args
op_assign
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%5s&quot;
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|num_args
)paren
r_return
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|cmd
comma
l_string|&quot;on&quot;
comma
l_int|2
)paren
)paren
id|error
op_assign
id|s390_vary_chpid
c_func
(paren
id|cp-&gt;id
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|cmd
comma
l_string|&quot;off&quot;
comma
l_int|3
)paren
)paren
id|error
op_assign
id|s390_vary_chpid
c_func
(paren
id|cp-&gt;id
comma
l_int|0
)paren
suffix:semicolon
r_else
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
id|error
OL
l_int|0
ques
c_cond
id|error
suffix:colon
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|status
comma
l_int|0644
comma
id|chp_status_show
comma
id|chp_status_write
)paren
suffix:semicolon
r_static
r_void
DECL|function|chp_release
id|chp_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|channel_path
op_star
id|cp
suffix:semicolon
id|cp
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|channel_path
comma
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Entries for chpids on the system bus.&n; * This replaces /proc/chpids.&n; */
r_static
r_int
DECL|function|new_channel_path
id|new_channel_path
c_func
(paren
r_int
id|chpid
comma
r_int
id|status
)paren
(brace
r_struct
id|channel_path
op_star
id|chp
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|chp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|channel_path
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chp
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|chp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|channel_path
)paren
)paren
suffix:semicolon
id|chps
(braket
id|chpid
)braket
op_assign
id|chp
suffix:semicolon
multiline_comment|/* fill in status, etc. */
id|chp-&gt;id
op_assign
id|chpid
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_case
id|CHP_STANDBY
suffix:colon
id|chp-&gt;state.online
op_assign
l_int|0
suffix:semicolon
id|chp-&gt;state.logically_online
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CHP_LOGICALLY_OFFLINE
suffix:colon
id|chp-&gt;state.logically_online
op_assign
l_int|0
suffix:semicolon
id|chp-&gt;state.online
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CHP_ONLINE
suffix:colon
id|chp-&gt;state.online
op_assign
l_int|1
suffix:semicolon
id|chp-&gt;state.logically_online
op_assign
l_int|1
suffix:semicolon
)brace
id|chp-&gt;dev
op_assign
(paren
r_struct
id|device
)paren
(brace
dot
id|parent
op_assign
op_amp
id|css_bus_device
comma
dot
id|release
op_assign
id|chp_release
comma
)brace
suffix:semicolon
id|snprintf
c_func
(paren
id|chp-&gt;dev.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;chp0.%x&quot;
comma
id|chpid
)paren
suffix:semicolon
multiline_comment|/* make it known to the system */
id|ret
op_assign
id|device_register
c_func
(paren
op_amp
id|chp-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: could not register %02x&bslash;n&quot;
comma
id|__func__
comma
id|chpid
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|device_create_file
c_func
(paren
op_amp
id|chp-&gt;dev
comma
op_amp
id|dev_attr_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|device_unregister
c_func
(paren
op_amp
id|chp-&gt;dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
