multiline_comment|/*&n; *  drivers/s390/cio/device.c&n; *  bus driver for ccw devices&n; *   $Revision: 1.129 $&n; *&n; *    Copyright (C) 2002 IBM Deutschland Entwicklung GmbH,&n; *&t;&t;&t; IBM Corporation&n; *    Author(s): Arnd Bergmann (arndb@de.ibm.com)&n; *&t;&t; Cornelia Huck (cohuck@de.ibm.com)&n; *&t;&t; Martin Schwidefsky (schwidefsky@de.ibm.com)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/cio.h&gt;
macro_line|#include &quot;cio.h&quot;
macro_line|#include &quot;css.h&quot;
macro_line|#include &quot;device.h&quot;
macro_line|#include &quot;ioasm.h&quot;
multiline_comment|/******************* bus type handling ***********************/
multiline_comment|/* The Linux driver model distinguishes between a bus type and&n; * the bus itself. Of course we only have one channel&n; * subsystem driver and one channel system per machine, but&n; * we still use the abstraction. T.R. says it&squot;s a good idea. */
r_static
r_int
DECL|function|ccw_bus_match
id|ccw_bus_match
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|device_driver
op_star
id|drv
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ccw_driver
op_star
id|cdrv
op_assign
id|to_ccwdrv
c_func
(paren
id|drv
)paren
suffix:semicolon
r_const
r_struct
id|ccw_device_id
op_star
id|ids
op_assign
id|cdrv-&gt;ids
comma
op_star
id|found
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ids
)paren
r_return
l_int|0
suffix:semicolon
id|found
op_assign
id|ccw_device_id_match
c_func
(paren
id|ids
comma
op_amp
id|cdev-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
r_return
l_int|0
suffix:semicolon
id|cdev-&gt;id.driver_info
op_assign
id|found-&gt;driver_info
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Hotplugging interface for ccw devices.&n; * Heavily modeled on pci and usb hotplug.&n; */
r_static
r_int
DECL|function|ccw_hotplug
id|ccw_hotplug
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
op_star
id|envp
comma
r_int
id|num_envp
comma
r_char
op_star
id|buffer
comma
r_int
id|buffer_size
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|length
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* what we want to pass to /sbin/hotplug */
id|envp
(braket
id|i
op_increment
)braket
op_assign
id|buffer
suffix:semicolon
id|length
op_add_assign
id|scnprintf
c_func
(paren
id|buffer
comma
id|buffer_size
op_minus
id|length
comma
l_string|&quot;CU_TYPE=%04X&quot;
comma
id|cdev-&gt;id.cu_type
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer_size
op_minus
id|length
op_le
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|num_envp
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
op_increment
id|length
suffix:semicolon
id|buffer
op_add_assign
id|length
suffix:semicolon
id|envp
(braket
id|i
op_increment
)braket
op_assign
id|buffer
suffix:semicolon
id|length
op_add_assign
id|scnprintf
c_func
(paren
id|buffer
comma
id|buffer_size
op_minus
id|length
comma
l_string|&quot;CU_MODEL=%02X&quot;
comma
id|cdev-&gt;id.cu_model
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer_size
op_minus
id|length
op_le
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|num_envp
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
op_increment
id|length
suffix:semicolon
id|buffer
op_add_assign
id|length
suffix:semicolon
multiline_comment|/* The next two can be zero, that&squot;s ok for us */
id|envp
(braket
id|i
op_increment
)braket
op_assign
id|buffer
suffix:semicolon
id|length
op_add_assign
id|scnprintf
c_func
(paren
id|buffer
comma
id|buffer_size
op_minus
id|length
comma
l_string|&quot;DEV_TYPE=%04X&quot;
comma
id|cdev-&gt;id.dev_type
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer_size
op_minus
id|length
op_le
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|num_envp
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
op_increment
id|length
suffix:semicolon
id|buffer
op_add_assign
id|length
suffix:semicolon
id|envp
(braket
id|i
op_increment
)braket
op_assign
id|buffer
suffix:semicolon
id|length
op_add_assign
id|scnprintf
c_func
(paren
id|buffer
comma
id|buffer_size
op_minus
id|length
comma
l_string|&quot;DEV_MODEL=%02X&quot;
comma
id|cdev-&gt;id.dev_model
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer_size
op_minus
id|length
op_le
l_int|0
)paren
op_logical_or
(paren
id|i
op_ge
id|num_envp
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|envp
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ccw_bus_type
r_struct
id|bus_type
id|ccw_bus_type
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ccw&quot;
comma
dot
id|match
op_assign
op_amp
id|ccw_bus_match
comma
dot
id|hotplug
op_assign
op_amp
id|ccw_hotplug
comma
)brace
suffix:semicolon
r_static
r_int
id|io_subchannel_probe
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|io_subchannel_remove
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_void
id|io_subchannel_irq
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_int
id|io_subchannel_notify
c_func
(paren
r_struct
id|device
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|io_subchannel_verify
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|io_subchannel_ioterm
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
r_static
r_void
id|io_subchannel_shutdown
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
DECL|variable|io_subchannel_driver
r_struct
id|css_driver
id|io_subchannel_driver
op_assign
(brace
dot
id|subchannel_type
op_assign
id|SUBCHANNEL_TYPE_IO
comma
dot
id|drv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;io_subchannel&quot;
comma
dot
id|bus
op_assign
op_amp
id|css_bus_type
comma
dot
id|probe
op_assign
op_amp
id|io_subchannel_probe
comma
dot
id|remove
op_assign
op_amp
id|io_subchannel_remove
comma
dot
id|shutdown
op_assign
op_amp
id|io_subchannel_shutdown
comma
)brace
comma
dot
id|irq
op_assign
id|io_subchannel_irq
comma
dot
id|notify
op_assign
id|io_subchannel_notify
comma
dot
id|verify
op_assign
id|io_subchannel_verify
comma
dot
id|termination
op_assign
id|io_subchannel_ioterm
comma
)brace
suffix:semicolon
DECL|variable|ccw_device_work
r_struct
id|workqueue_struct
op_star
id|ccw_device_work
suffix:semicolon
DECL|variable|ccw_device_notify_work
r_struct
id|workqueue_struct
op_star
id|ccw_device_notify_work
suffix:semicolon
DECL|variable|ccw_device_init_wq
r_static
id|wait_queue_head_t
id|ccw_device_init_wq
suffix:semicolon
DECL|variable|ccw_device_init_count
r_static
id|atomic_t
id|ccw_device_init_count
suffix:semicolon
r_static
r_int
id|__init
DECL|function|init_ccw_bus_type
id|init_ccw_bus_type
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ccw_device_init_wq
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ccw_device_init_count
comma
l_int|0
)paren
suffix:semicolon
id|ccw_device_work
op_assign
id|create_singlethread_workqueue
c_func
(paren
l_string|&quot;cio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ccw_device_work
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* FIXME: better errno ? */
id|ccw_device_notify_work
op_assign
id|create_singlethread_workqueue
c_func
(paren
l_string|&quot;cio_notify&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ccw_device_notify_work
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* FIXME: better errno ? */
r_goto
id|out_err
suffix:semicolon
)brace
id|slow_path_wq
op_assign
id|create_singlethread_workqueue
c_func
(paren
l_string|&quot;kslowcrw&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|slow_path_wq
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* FIXME: better errno ? */
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|bus_register
(paren
op_amp
id|ccw_bus_type
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|driver_register
c_func
(paren
op_amp
id|io_subchannel_driver.drv
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
id|wait_event
c_func
(paren
id|ccw_device_init_wq
comma
id|atomic_read
c_func
(paren
op_amp
id|ccw_device_init_count
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|flush_workqueue
c_func
(paren
id|ccw_device_work
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|ccw_device_work
)paren
id|destroy_workqueue
c_func
(paren
id|ccw_device_work
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccw_device_notify_work
)paren
id|destroy_workqueue
c_func
(paren
id|ccw_device_notify_work
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slow_path_wq
)paren
id|destroy_workqueue
c_func
(paren
id|slow_path_wq
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|cleanup_ccw_bus_type
id|cleanup_ccw_bus_type
(paren
r_void
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|io_subchannel_driver.drv
)paren
suffix:semicolon
id|bus_unregister
c_func
(paren
op_amp
id|ccw_bus_type
)paren
suffix:semicolon
id|destroy_workqueue
c_func
(paren
id|ccw_device_notify_work
)paren
suffix:semicolon
id|destroy_workqueue
c_func
(paren
id|ccw_device_work
)paren
suffix:semicolon
)brace
DECL|variable|init_ccw_bus_type
id|subsys_initcall
c_func
(paren
id|init_ccw_bus_type
)paren
suffix:semicolon
DECL|variable|cleanup_ccw_bus_type
id|module_exit
c_func
(paren
id|cleanup_ccw_bus_type
)paren
suffix:semicolon
multiline_comment|/************************ device handling **************************/
multiline_comment|/*&n; * A ccw_device has some interfaces in sysfs in addition to the&n; * standard ones.&n; * The following entries are designed to export the information which&n; * resided in 2.4 in /proc/subchannels. Subchannel and device number&n; * are obvious, so they don&squot;t have an entry :)&n; * TODO: Split chpids and pimpampom up? Where is &quot;in use&quot; in the tree?&n; */
r_static
id|ssize_t
DECL|function|chpids_show
id|chpids_show
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ssd_info
op_star
id|ssd
op_assign
op_amp
id|sch-&gt;ssd_info
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|chp
suffix:semicolon
r_for
c_loop
(paren
id|chp
op_assign
l_int|0
suffix:semicolon
id|chp
OL
l_int|8
suffix:semicolon
id|chp
op_increment
)paren
id|ret
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;%02x &quot;
comma
id|ssd-&gt;chpid
(braket
id|chp
)braket
)paren
suffix:semicolon
id|ret
op_add_assign
id|sprintf
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|min
c_func
(paren
(paren
id|ssize_t
)paren
id|PAGE_SIZE
comma
id|ret
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|pimpampom_show
id|pimpampom_show
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|pmcw
op_star
id|pmcw
op_assign
op_amp
id|sch-&gt;schib.pmcw
suffix:semicolon
r_return
id|sprintf
(paren
id|buf
comma
l_string|&quot;%02x %02x %02x&bslash;n&quot;
comma
id|pmcw-&gt;pim
comma
id|pmcw-&gt;pam
comma
id|pmcw-&gt;pom
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|devtype_show
id|devtype_show
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ccw_device_id
op_star
id|id
op_assign
op_amp
(paren
id|cdev-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;dev_type
op_ne
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%04x/%02x&bslash;n&quot;
comma
id|id-&gt;dev_type
comma
id|id-&gt;dev_model
)paren
suffix:semicolon
r_else
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;n/a&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|cutype_show
id|cutype_show
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ccw_device_id
op_star
id|id
op_assign
op_amp
(paren
id|cdev-&gt;id
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%04x/%02x&bslash;n&quot;
comma
id|id-&gt;cu_type
comma
id|id-&gt;cu_model
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|online_show
id|online_show
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
id|cdev-&gt;online
ques
c_cond
l_string|&quot;1&bslash;n&quot;
suffix:colon
l_string|&quot;0&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_remove_disconnected
id|ccw_device_remove_disconnected
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
multiline_comment|/*&n;&t; * Forced offline in disconnected state means&n;&t; * &squot;throw away device&squot;.&n;&t; */
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Reset intparm to zeroes. */
id|sch-&gt;schib.pmcw.intparm
op_assign
l_int|0
suffix:semicolon
id|cio_modify
c_func
(paren
id|sch
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
)brace
r_int
DECL|function|ccw_device_set_offline
id|ccw_device_set_offline
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;online
op_logical_or
op_logical_neg
id|cdev-&gt;drv
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;drv-&gt;set_offline
)paren
(brace
id|ret
op_assign
id|cdev-&gt;drv
op_member_access_from_pointer
id|set_offline
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
)brace
id|cdev-&gt;online
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|ret
op_assign
id|ccw_device_offline
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|wait_event
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
comma
id|dev_fsm_final_state
c_func
(paren
id|cdev
)paren
)paren
suffix:semicolon
r_else
(brace
id|pr_debug
c_func
(paren
l_string|&quot;ccw_device_offline returned %d, device %s&bslash;n&quot;
comma
id|ret
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|cdev-&gt;online
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_int
DECL|function|ccw_device_set_online
id|ccw_device_set_online
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;online
op_logical_or
op_logical_neg
id|cdev-&gt;drv
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|ret
op_assign
id|ccw_device_online
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|wait_event
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
comma
id|dev_fsm_final_state
c_func
(paren
id|cdev
)paren
)paren
suffix:semicolon
r_else
(brace
id|pr_debug
c_func
(paren
l_string|&quot;ccw_device_online returned %d, device %s&bslash;n&quot;
comma
id|ret
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_ONLINE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;drv-&gt;set_online
op_logical_or
id|cdev-&gt;drv
op_member_access_from_pointer
id|set_online
c_func
(paren
id|cdev
)paren
op_eq
l_int|0
)paren
(brace
id|cdev-&gt;online
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|ret
op_assign
id|ccw_device_offline
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|wait_event
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
comma
id|dev_fsm_final_state
c_func
(paren
id|cdev
)paren
)paren
suffix:semicolon
r_else
id|pr_debug
c_func
(paren
l_string|&quot;ccw_device_offline returned %d, device %s&bslash;n&quot;
comma
id|ret
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_return
(paren
id|ret
op_assign
l_int|0
)paren
ques
c_cond
op_minus
id|ENODEV
suffix:colon
id|ret
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|online_store
id|online_store
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|i
comma
id|force
comma
id|ret
suffix:semicolon
r_char
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|atomic_compare_and_swap
c_func
(paren
l_int|0
comma
l_int|1
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|onoff
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;drv
op_logical_and
op_logical_neg
id|try_module_get
c_func
(paren
id|cdev-&gt;drv-&gt;owner
)paren
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|onoff
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|buf
comma
l_string|&quot;force&bslash;n&quot;
comma
id|count
)paren
)paren
(brace
id|force
op_assign
l_int|1
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|force
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|tmp
comma
l_int|16
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Do device recognition, if needed. */
r_if
c_cond
(paren
id|cdev-&gt;id.cu_type
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
id|ccw_device_recognition
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Couldn&squot;t start recognition &quot;
l_string|&quot;for device %s (ret=%d)&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|wait_event
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.recog_done
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cdev-&gt;drv
op_logical_and
id|cdev-&gt;drv-&gt;set_online
)paren
id|ccw_device_set_online
c_func
(paren
id|cdev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_DISCONNECTED
)paren
id|ccw_device_remove_disconnected
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cdev-&gt;drv
op_logical_and
id|cdev-&gt;drv-&gt;set_offline
)paren
id|ccw_device_set_offline
c_func
(paren
id|cdev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|force
op_logical_and
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_BOXED
)paren
(brace
id|ret
op_assign
id|ccw_device_stlck
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ccw_device_stlck for device %s &quot;
l_string|&quot;returned %d!&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Do device recognition, if needed. */
r_if
c_cond
(paren
id|cdev-&gt;id.cu_type
op_eq
l_int|0
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_NOT_OPER
suffix:semicolon
id|ret
op_assign
id|ccw_device_recognition
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Couldn&squot;t start recognition &quot;
l_string|&quot;for device %s (ret=%d)&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|wait_event
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.recog_done
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cdev-&gt;drv
op_logical_and
id|cdev-&gt;drv-&gt;set_online
)paren
id|ccw_device_set_online
c_func
(paren
id|cdev
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|cdev-&gt;drv
)paren
id|module_put
c_func
(paren
id|cdev-&gt;drv-&gt;owner
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|onoff
comma
l_int|0
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|available_show
id|available_show
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_switch
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
)paren
(brace
r_case
id|DEV_STATE_BOXED
suffix:colon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;boxed&bslash;n&quot;
)paren
suffix:semicolon
r_case
id|DEV_STATE_DISCONNECTED
suffix:colon
r_case
id|DEV_STATE_DISCONNECTED_SENSE_ID
suffix:colon
r_case
id|DEV_STATE_NOT_OPER
suffix:colon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|dev-&gt;parent
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;lpm
)paren
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;no path&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;no device&bslash;n&quot;
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* All other states considered fine. */
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;good&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|chpids
comma
l_int|0444
comma
id|chpids_show
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|pimpampom
comma
l_int|0444
comma
id|pimpampom_show
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|devtype
comma
l_int|0444
comma
id|devtype_show
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|cutype
comma
l_int|0444
comma
id|cutype_show
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|online
comma
l_int|0644
comma
id|online_show
comma
id|online_store
)paren
suffix:semicolon
r_extern
r_struct
id|device_attribute
id|dev_attr_cmb_enable
suffix:semicolon
r_static
id|DEVICE_ATTR
c_func
(paren
id|availability
comma
l_int|0444
comma
id|available_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|variable|subch_attrs
r_static
r_struct
id|attribute
op_star
id|subch_attrs
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_chpids.attr
comma
op_amp
id|dev_attr_pimpampom.attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|subch_attr_group
r_static
r_struct
id|attribute_group
id|subch_attr_group
op_assign
(brace
dot
id|attrs
op_assign
id|subch_attrs
comma
)brace
suffix:semicolon
r_static
r_inline
r_int
DECL|function|subchannel_add_files
id|subchannel_add_files
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
id|sysfs_create_group
c_func
(paren
op_amp
id|dev-&gt;kobj
comma
op_amp
id|subch_attr_group
)paren
suffix:semicolon
)brace
DECL|variable|ccwdev_attrs
r_static
r_struct
id|attribute
op_star
id|ccwdev_attrs
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_devtype.attr
comma
op_amp
id|dev_attr_cutype.attr
comma
op_amp
id|dev_attr_online.attr
comma
op_amp
id|dev_attr_cmb_enable.attr
comma
op_amp
id|dev_attr_availability.attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|ccwdev_attr_group
r_static
r_struct
id|attribute_group
id|ccwdev_attr_group
op_assign
(brace
dot
id|attrs
op_assign
id|ccwdev_attrs
comma
)brace
suffix:semicolon
r_static
r_inline
r_int
DECL|function|device_add_files
id|device_add_files
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
id|sysfs_create_group
c_func
(paren
op_amp
id|dev-&gt;kobj
comma
op_amp
id|ccwdev_attr_group
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|device_remove_files
id|device_remove_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|sysfs_remove_group
c_func
(paren
op_amp
id|dev-&gt;kobj
comma
op_amp
id|ccwdev_attr_group
)paren
suffix:semicolon
)brace
multiline_comment|/* this is a simple abstraction for device_register that sets the&n; * correct bus type and adds the bus specific files */
r_int
DECL|function|ccw_device_register
id|ccw_device_register
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|cdev-&gt;dev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dev-&gt;bus
op_assign
op_amp
id|ccw_bus_type
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|device_add
c_func
(paren
id|dev
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|set_bit
c_func
(paren
l_int|1
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|registered
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|device_add_files
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|registered
)paren
)paren
id|device_del
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_struct
id|ccw_device
op_star
DECL|function|get_disc_ccwdev_by_devno
id|get_disc_ccwdev_by_devno
c_func
(paren
r_int
r_int
id|devno
comma
r_struct
id|ccw_device
op_star
id|sibling
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_struct
id|list_head
op_star
id|entry
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_bus
c_func
(paren
op_amp
id|ccw_bus_type
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|ccw_bus_type.subsys.rwsem
)paren
suffix:semicolon
id|cdev
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each
c_func
(paren
id|entry
comma
op_amp
id|ccw_bus_type.devices.list
)paren
(brace
id|dev
op_assign
id|get_device
c_func
(paren
id|container_of
c_func
(paren
id|entry
comma
r_struct
id|device
comma
id|bus_list
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_continue
suffix:semicolon
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_eq
id|DEV_STATE_DISCONNECTED
)paren
op_logical_and
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
op_eq
id|devno
)paren
op_logical_and
(paren
id|cdev
op_ne
id|sibling
)paren
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_NOT_OPER
suffix:semicolon
r_break
suffix:semicolon
)brace
id|put_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cdev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|ccw_bus_type.subsys.rwsem
)paren
suffix:semicolon
id|put_bus
c_func
(paren
op_amp
id|ccw_bus_type
)paren
suffix:semicolon
r_return
id|cdev
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_add_changed
id|ccw_device_add_changed
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
id|cdev
op_assign
(paren
r_struct
id|ccw_device
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|device_add
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
)paren
(brace
id|put_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|set_bit
c_func
(paren
l_int|1
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|registered
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_add_files
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|registered
)paren
)paren
id|device_unregister
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
)brace
)brace
r_extern
r_int
id|css_get_ssd_info
c_func
(paren
r_struct
id|subchannel
op_star
id|sch
)paren
suffix:semicolon
r_void
DECL|function|ccw_device_do_unreg_rereg
id|ccw_device_do_unreg_rereg
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|need_rename
suffix:semicolon
id|cdev
op_assign
(paren
r_struct
id|ccw_device
op_star
)paren
id|data
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
op_ne
id|sch-&gt;schib.pmcw.dev
)paren
(brace
multiline_comment|/*&n;&t;&t; * The device number has changed. This is usually only when&n;&t;&t; * a device has been detached under VM and then re-appeared&n;&t;&t; * on another subchannel because of a different attachment&n;&t;&t; * order than before. Ideally, we should should just switch&n;&t;&t; * subchannels, but unfortunately, this is not possible with&n;&t;&t; * the current implementation.&n;&t;&t; * Instead, we search for the old subchannel for this device&n;&t;&t; * number and deregister so there are no collisions with the&n;&t;&t; * newly registered ccw_device.&n;&t;&t; * FIXME: Find another solution so the block layer doesn&squot;t&n;&t;&t; *        get possibly sick...&n;&t;&t; */
r_struct
id|ccw_device
op_star
id|other_cdev
suffix:semicolon
id|need_rename
op_assign
l_int|1
suffix:semicolon
id|other_cdev
op_assign
id|get_disc_ccwdev_by_devno
c_func
(paren
id|sch-&gt;schib.pmcw.dev
comma
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other_cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|other_sch
suffix:semicolon
id|other_sch
op_assign
id|to_subchannel
c_func
(paren
id|other_cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_device
c_func
(paren
op_amp
id|other_sch-&gt;dev
)paren
)paren
(brace
id|stsch
c_func
(paren
id|other_sch-&gt;irq
comma
op_amp
id|other_sch-&gt;schib
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other_sch-&gt;schib.pmcw.dnv
)paren
(brace
id|other_sch-&gt;schib.pmcw.intparm
op_assign
l_int|0
suffix:semicolon
id|cio_modify
c_func
(paren
id|other_sch
)paren
suffix:semicolon
)brace
id|device_unregister
c_func
(paren
op_amp
id|other_sch-&gt;dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Update ssd info here. */
id|css_get_ssd_info
c_func
(paren
id|sch
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|devno
op_assign
id|sch-&gt;schib.pmcw.dev
suffix:semicolon
)brace
r_else
id|need_rename
op_assign
l_int|0
suffix:semicolon
id|device_remove_files
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|registered
)paren
)paren
id|device_del
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|need_rename
)paren
id|snprintf
(paren
id|cdev-&gt;dev.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;0.0.%04x&quot;
comma
id|sch-&gt;schib.pmcw.dev
)paren
suffix:semicolon
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_add_changed
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_release
id|ccw_device_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cdev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Register recognized device.&n; */
r_static
r_void
DECL|function|io_subchannel_register
id|io_subchannel_register
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|cdev
op_assign
(paren
r_struct
id|ccw_device
op_star
)paren
id|data
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|sch-&gt;dev.children
)paren
)paren
(brace
id|bus_rescan_devices
c_func
(paren
op_amp
id|ccw_bus_type
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* make it known to the system */
id|ret
op_assign
id|ccw_device_register
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: could not register %s&bslash;n&quot;
comma
id|__func__
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sch-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|sch-&gt;dev.driver_data
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sch-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
(paren
id|cdev
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
id|kfree
(paren
id|cdev
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|ccw_device_init_count
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|ccw_device_init_wq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ret
op_assign
id|subchannel_add_files
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: could not add attributes to %s&bslash;n&quot;
comma
id|__func__
comma
id|sch-&gt;dev.bus_id
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
id|out
suffix:colon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.recog_done
op_assign
l_int|1
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|ccw_device_init_count
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|ccw_device_init_wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|ccw_device_call_sch_unregister
id|ccw_device_call_sch_unregister
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|data
suffix:semicolon
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Reset intparm to zeroes. */
id|sch-&gt;schib.pmcw.intparm
op_assign
l_int|0
suffix:semicolon
id|cio_modify
c_func
(paren
id|sch
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * subchannel recognition done. Called from the state machine.&n; */
r_void
DECL|function|io_subchannel_recog_done
id|io_subchannel_recog_done
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_if
c_cond
(paren
id|css_init_done
op_eq
l_int|0
)paren
(brace
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.recog_done
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
)paren
(brace
r_case
id|DEV_STATE_NOT_OPER
suffix:colon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|flags.recog_done
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Remove device found not operational. */
r_if
c_cond
(paren
op_logical_neg
id|get_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
)paren
r_break
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|cdev-&gt;dev.parent
)paren
suffix:semicolon
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_call_sch_unregister
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|slow_path_wq
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|ccw_device_init_count
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|ccw_device_init_wq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_BOXED
suffix:colon
multiline_comment|/* Device did not respond in time. */
r_case
id|DEV_STATE_OFFLINE
suffix:colon
multiline_comment|/* &n;&t;&t; * We can&squot;t register the device in interrupt context so&n;&t;&t; * we schedule a work item.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|get_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
)paren
r_break
suffix:semicolon
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|io_subchannel_register
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|slow_path_wq
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|io_subchannel_recog
id|io_subchannel_recog
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|ccw_device_private
op_star
id|priv
suffix:semicolon
id|sch-&gt;dev.driver_data
op_assign
id|cdev
suffix:semicolon
id|sch-&gt;driver
op_assign
op_amp
id|io_subchannel_driver
suffix:semicolon
id|cdev-&gt;ccwlock
op_assign
op_amp
id|sch-&gt;lock
suffix:semicolon
multiline_comment|/* Init private data. */
id|priv
op_assign
id|cdev
op_member_access_from_pointer
r_private
suffix:semicolon
id|priv-&gt;devno
op_assign
id|sch-&gt;schib.pmcw.dev
suffix:semicolon
id|priv-&gt;irq
op_assign
id|sch-&gt;irq
suffix:semicolon
id|priv-&gt;state
op_assign
id|DEV_STATE_NOT_OPER
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|priv-&gt;cmb_list
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|priv-&gt;wait_q
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|priv-&gt;timer
)paren
suffix:semicolon
multiline_comment|/* Set an initial name for the device. */
id|snprintf
(paren
id|cdev-&gt;dev.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;0.0.%04x&quot;
comma
id|sch-&gt;schib.pmcw.dev
)paren
suffix:semicolon
multiline_comment|/* Increase counter of devices currently in recognition. */
id|atomic_inc
c_func
(paren
op_amp
id|ccw_device_init_count
)paren
suffix:semicolon
multiline_comment|/* Start async. device sensing. */
id|spin_lock_irq
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_recognition
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|sch-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|ccw_device_init_count
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|ccw_device_init_wq
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|io_subchannel_probe
id|io_subchannel_probe
(paren
r_struct
id|device
op_star
id|pdev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sch-&gt;dev.driver_data
)paren
(brace
multiline_comment|/*&n;&t;&t; * This subchannel already has an associated ccw_device.&n;&t;&t; * Register it and exit. This happens for all early&n;&t;&t; * device, e.g. the console.&n;&t;&t; */
id|cdev
op_assign
id|sch-&gt;dev.driver_data
suffix:semicolon
id|device_initialize
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
id|ccw_device_register
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|subchannel_add_files
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Check if the device is already online. If it is&n;&t;&t; * the reference count needs to be corrected&n;&t;&t; * (see ccw_device_online and css_init_done for the&n;&t;&t; * ugly details).&n;&t;&t; */
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_NOT_OPER
op_logical_and
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_OFFLINE
op_logical_and
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_BOXED
)paren
id|get_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cdev
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|cdev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|cdev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw_device
)paren
)paren
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ccw_device_private
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
op_member_access_from_pointer
r_private
)paren
(brace
id|kfree
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw_device_private
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|onoff
comma
l_int|0
)paren
suffix:semicolon
id|cdev-&gt;dev
op_assign
(paren
r_struct
id|device
)paren
(brace
dot
id|parent
op_assign
id|pdev
comma
dot
id|release
op_assign
id|ccw_device_release
comma
)brace
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work.entry
)paren
suffix:semicolon
multiline_comment|/* Do first half of device_register. */
id|device_initialize
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_device
c_func
(paren
op_amp
id|sch-&gt;dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|cdev-&gt;dev.release
)paren
id|cdev-&gt;dev
dot
id|release
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|io_subchannel_recog
c_func
(paren
id|cdev
comma
id|to_subchannel
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sch-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|sch-&gt;dev.driver_data
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sch-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;dev.release
)paren
id|cdev-&gt;dev
dot
id|release
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|ccw_device_unregister
id|ccw_device_unregister
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
id|cdev
op_assign
(paren
r_struct
id|ccw_device
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|registered
)paren
)paren
id|device_unregister
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|io_subchannel_remove
id|io_subchannel_remove
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;driver_data
)paren
r_return
l_int|0
suffix:semicolon
id|cdev
op_assign
id|dev-&gt;driver_data
suffix:semicolon
multiline_comment|/* Set ccw device to not operational and drop reference. */
id|spin_lock_irqsave
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_NOT_OPER
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|cdev-&gt;ccwlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Put unregistration on workqueue to avoid livelocks on the css bus&n;&t; * semaphore.&n;&t; */
r_if
c_cond
(paren
id|get_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
)paren
(brace
id|PREPARE_WORK
c_func
(paren
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
comma
id|ccw_device_unregister
comma
(paren
r_void
op_star
)paren
id|cdev
)paren
suffix:semicolon
id|queue_work
c_func
(paren
id|ccw_device_work
comma
op_amp
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|kick_work
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|io_subchannel_notify
id|io_subchannel_notify
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_int
id|event
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
id|cdev
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;drv
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;online
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|cdev-&gt;drv-&gt;notify
ques
c_cond
id|cdev-&gt;drv
op_member_access_from_pointer
id|notify
c_func
(paren
id|cdev
comma
id|event
)paren
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|io_subchannel_verify
id|io_subchannel_verify
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
id|cdev
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|cdev
)paren
id|dev_fsm_event
c_func
(paren
id|cdev
comma
id|DEV_EVENT_VERIFY
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|io_subchannel_ioterm
id|io_subchannel_ioterm
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
id|cdev
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_CLEAR_VERIFY
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;handler
)paren
id|cdev
op_member_access_from_pointer
id|handler
c_func
(paren
id|cdev
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|intparm
comma
id|ERR_PTR
c_func
(paren
op_minus
id|EIO
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|io_subchannel_shutdown
id|io_subchannel_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|sch
op_assign
id|to_subchannel
c_func
(paren
id|dev
)paren
suffix:semicolon
id|cdev
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|cio_is_console
c_func
(paren
id|sch-&gt;irq
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sch-&gt;schib.pmcw.ena
)paren
multiline_comment|/* Nothing to do. */
r_return
suffix:semicolon
id|ret
op_assign
id|cio_disable_subchannel
c_func
(paren
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
op_minus
id|EBUSY
)paren
multiline_comment|/* Subchannel is disabled, we&squot;re done. */
r_return
suffix:semicolon
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_assign
id|DEV_STATE_QUIESCE
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;handler
)paren
id|cdev
op_member_access_from_pointer
id|handler
c_func
(paren
id|cdev
comma
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|intparm
comma
id|ERR_PTR
c_func
(paren
op_minus
id|EIO
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|ccw_device_cancel_halt_clear
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EBUSY
)paren
(brace
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
comma
id|dev_fsm_final_state
c_func
(paren
id|cdev
)paren
)paren
suffix:semicolon
)brace
id|cio_disable_subchannel
c_func
(paren
id|sch
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CCW_CONSOLE
DECL|variable|console_cdev
r_static
r_struct
id|ccw_device
id|console_cdev
suffix:semicolon
DECL|variable|console_private
r_static
r_struct
id|ccw_device_private
id|console_private
suffix:semicolon
DECL|variable|console_cdev_in_use
r_static
r_int
id|console_cdev_in_use
suffix:semicolon
r_static
r_int
DECL|function|ccw_device_console_enable
id|ccw_device_console_enable
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|subchannel
op_star
id|sch
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/* Initialize the ccw_device structure. */
id|cdev-&gt;dev
op_assign
(paren
r_struct
id|device
)paren
(brace
dot
id|parent
op_assign
op_amp
id|sch-&gt;dev
comma
)brace
suffix:semicolon
multiline_comment|/* Initialize the subchannel structure */
id|sch-&gt;dev.parent
op_assign
op_amp
id|css_bus_device
suffix:semicolon
id|sch-&gt;dev.bus
op_assign
op_amp
id|css_bus_type
suffix:semicolon
id|rc
op_assign
id|io_subchannel_recog
c_func
(paren
id|cdev
comma
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Now wait for the async. recognition to come to an end. */
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|dev_fsm_final_state
c_func
(paren
id|cdev
)paren
)paren
id|wait_cons_dev
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_OFFLINE
)paren
r_goto
id|out_unlock
suffix:semicolon
id|ccw_device_online
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|dev_fsm_final_state
c_func
(paren
id|cdev
)paren
)paren
id|wait_cons_dev
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|state
op_ne
id|DEV_STATE_ONLINE
)paren
r_goto
id|out_unlock
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_struct
id|ccw_device
op_star
DECL|function|ccw_device_probe_console
id|ccw_device_probe_console
c_func
(paren
r_void
)paren
(brace
r_struct
id|subchannel
op_star
id|sch
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|xchg
c_func
(paren
op_amp
id|console_cdev_in_use
comma
l_int|1
)paren
op_ne
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
id|sch
op_assign
id|cio_probe_console
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|sch
)paren
)paren
(brace
id|console_cdev_in_use
op_assign
l_int|0
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
id|sch
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|console_cdev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw_device
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|console_private
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw_device_private
)paren
)paren
suffix:semicolon
id|console_cdev
dot
r_private
op_assign
op_amp
id|console_private
suffix:semicolon
id|ret
op_assign
id|ccw_device_console_enable
c_func
(paren
op_amp
id|console_cdev
comma
id|sch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|cio_release_console
c_func
(paren
)paren
suffix:semicolon
id|console_cdev_in_use
op_assign
l_int|0
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
id|console_cdev.online
op_assign
l_int|1
suffix:semicolon
r_return
op_amp
id|console_cdev
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * get ccw_device matching the busid, but only if owned by cdrv&n; */
r_struct
id|ccw_device
op_star
DECL|function|get_ccwdev_by_busid
id|get_ccwdev_by_busid
c_func
(paren
r_struct
id|ccw_driver
op_star
id|cdrv
comma
r_const
r_char
op_star
id|bus_id
)paren
(brace
r_struct
id|device
op_star
id|d
comma
op_star
id|dev
suffix:semicolon
r_struct
id|device_driver
op_star
id|drv
suffix:semicolon
id|drv
op_assign
id|get_driver
c_func
(paren
op_amp
id|cdrv-&gt;driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drv
)paren
r_return
l_int|0
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|drv-&gt;bus-&gt;subsys.rwsem
)paren
suffix:semicolon
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|d
comma
op_amp
id|drv-&gt;devices
comma
id|driver_list
)paren
(brace
id|dev
op_assign
id|get_device
c_func
(paren
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_logical_and
op_logical_neg
id|strncmp
c_func
(paren
id|bus_id
comma
id|dev-&gt;bus_id
comma
id|BUS_ID_SIZE
)paren
)paren
r_break
suffix:semicolon
r_else
r_if
c_cond
(paren
id|dev
)paren
(brace
id|put_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|up_read
c_func
(paren
op_amp
id|drv-&gt;bus-&gt;subsys.rwsem
)paren
suffix:semicolon
id|put_driver
c_func
(paren
id|drv
)paren
suffix:semicolon
r_return
id|dev
ques
c_cond
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************** device driver handling ************************/
multiline_comment|/* This is the implementation of the ccw_driver class. The probe, remove&n; * and release methods are initially very similar to the device_driver&n; * implementations, with the difference that they have ccw_device&n; * arguments.&n; *&n; * A ccw driver also contains the information that is needed for&n; * device matching.&n; */
r_static
r_int
DECL|function|ccw_device_probe
id|ccw_device_probe
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ccw_driver
op_star
id|cdrv
op_assign
id|to_ccwdrv
c_func
(paren
id|dev-&gt;driver
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|cdev-&gt;drv
op_assign
id|cdrv
suffix:semicolon
multiline_comment|/* to let the driver call _set_online */
id|ret
op_assign
id|cdrv-&gt;probe
ques
c_cond
id|cdrv
op_member_access_from_pointer
id|probe
c_func
(paren
id|cdev
)paren
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|cdev-&gt;drv
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ccw_device_remove
id|ccw_device_remove
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
op_assign
id|to_ccwdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|ccw_driver
op_star
id|cdrv
op_assign
id|cdev-&gt;drv
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;removing device %s&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdrv-&gt;remove
)paren
id|cdrv
op_member_access_from_pointer
id|remove
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev-&gt;online
)paren
(brace
id|cdev-&gt;online
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
id|ret
op_assign
id|ccw_device_offline
c_func
(paren
id|cdev
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|cdev-&gt;ccwlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|wait_event
c_func
(paren
id|cdev
op_member_access_from_pointer
r_private
op_member_access_from_pointer
id|wait_q
comma
id|dev_fsm_final_state
c_func
(paren
id|cdev
)paren
)paren
suffix:semicolon
r_else
singleline_comment|//FIXME: we can&squot;t fail!
id|pr_debug
c_func
(paren
l_string|&quot;ccw_device_offline returned %d, device %s&bslash;n&quot;
comma
id|ret
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
)brace
id|ccw_device_set_timeout
c_func
(paren
id|cdev
comma
l_int|0
)paren
suffix:semicolon
id|cdev-&gt;drv
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|ccw_driver_register
id|ccw_driver_register
(paren
r_struct
id|ccw_driver
op_star
id|cdriver
)paren
(brace
r_struct
id|device_driver
op_star
id|drv
op_assign
op_amp
id|cdriver-&gt;driver
suffix:semicolon
id|drv-&gt;bus
op_assign
op_amp
id|ccw_bus_type
suffix:semicolon
id|drv-&gt;name
op_assign
id|cdriver-&gt;name
suffix:semicolon
id|drv-&gt;probe
op_assign
id|ccw_device_probe
suffix:semicolon
id|drv-&gt;remove
op_assign
id|ccw_device_remove
suffix:semicolon
r_return
id|driver_register
c_func
(paren
id|drv
)paren
suffix:semicolon
)brace
r_void
DECL|function|ccw_driver_unregister
id|ccw_driver_unregister
(paren
r_struct
id|ccw_driver
op_star
id|cdriver
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|cdriver-&gt;driver
)paren
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|ccw_device_set_online
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_device_set_online
)paren
suffix:semicolon
DECL|variable|ccw_device_set_offline
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_device_set_offline
)paren
suffix:semicolon
DECL|variable|ccw_driver_register
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_driver_register
)paren
suffix:semicolon
DECL|variable|ccw_driver_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_driver_unregister
)paren
suffix:semicolon
DECL|variable|get_ccwdev_by_busid
id|EXPORT_SYMBOL
c_func
(paren
id|get_ccwdev_by_busid
)paren
suffix:semicolon
DECL|variable|ccw_bus_type
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_bus_type
)paren
suffix:semicolon
DECL|variable|ccw_device_work
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_device_work
)paren
suffix:semicolon
DECL|variable|ccw_device_notify_work
id|EXPORT_SYMBOL
c_func
(paren
id|ccw_device_notify_work
)paren
suffix:semicolon
eof
