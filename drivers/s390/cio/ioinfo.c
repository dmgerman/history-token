multiline_comment|/*&n; *  drivers/s390/cio/ioinfo.c&n; *   S/390 common I/O routines -- the ioinfo structure&n; *   $Revision: 1.4 $&n; *&n; *    Copyright (C) 1999-2002 IBM Deutschland Entwicklung GmbH,&n; *                            IBM Corporation&n; *    Author(s): Ingo Adlung (adlung@de.ibm.com)&n; *               Cornelia Huck (cohuck@de.ibm.com) &n; *&t;&t; Arnd Bergmann (arndb@de.ibm.com)&n; *    ChangeLog: 11/04/2002 Arnd Bergmann Split s390io.c into multiple files,&n; *&t;&t;&t;&t;&t;  see s390io.c for complete list of&n; * &t;&t;&t;&t;&t;  changes.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &quot;ioinfo.h&quot;
DECL|variable|highest_subchannel
r_int
r_int
id|highest_subchannel
suffix:semicolon
DECL|variable|ioinfo_head
id|ioinfo_t
op_star
id|ioinfo_head
suffix:semicolon
DECL|variable|ioinfo_tail
id|ioinfo_t
op_star
id|ioinfo_tail
suffix:semicolon
DECL|variable|ioinfo
id|ioinfo_t
op_star
id|ioinfo
(braket
id|__MAX_SUBCHANNELS
)braket
macro_line|#if 1
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
id|__MAX_SUBCHANNELS
op_minus
l_int|1
)paren
)braket
op_assign
id|INVALID_STORAGE_AREA
)brace
multiline_comment|/*FIXME: define this to 0 */
macro_line|#endif
suffix:semicolon
r_static
r_inline
r_int
DECL|function|get_next_available_irq
id|get_next_available_irq
(paren
id|ioinfo_t
op_star
id|pi
)paren
(brace
r_int
id|ret_val
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_while
c_loop
(paren
id|pi
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|pi-&gt;st
)paren
op_logical_and
(paren
id|pi-&gt;ui.flags.oper
)paren
)paren
(brace
id|ret_val
op_assign
id|pi-&gt;irq
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
id|pi
op_assign
id|pi-&gt;next
suffix:semicolon
)brace
)brace
r_return
id|ret_val
suffix:semicolon
)brace
r_int
DECL|function|get_irq_first
id|get_irq_first
(paren
r_void
)paren
(brace
r_int
id|ret_irq
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo_head
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioinfo_head-&gt;ui.flags.oper
)paren
op_logical_and
(paren
op_logical_neg
id|ioinfo_head-&gt;st
)paren
)paren
(brace
id|ret_irq
op_assign
id|ioinfo_head-&gt;irq
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioinfo_head-&gt;next
)paren
(brace
id|ret_irq
op_assign
id|get_next_available_irq
(paren
id|ioinfo_head-&gt;next
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret_irq
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
(brace
id|ret_irq
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|ret_irq
suffix:semicolon
)brace
r_int
DECL|function|get_irq_next
id|get_irq_next
(paren
r_int
id|irq
)paren
(brace
r_int
id|ret_irq
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_ne
id|INVALID_STORAGE_AREA
)paren
(brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|next-&gt;ui.flags.oper
)paren
op_logical_and
(paren
op_logical_neg
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|next-&gt;st
)paren
)paren
(brace
id|ret_irq
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|next-&gt;irq
suffix:semicolon
)brace
r_else
(brace
id|ret_irq
op_assign
id|get_next_available_irq
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|ret_irq
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
(brace
id|ret_irq
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|ret_irq
suffix:semicolon
)brace
r_int
DECL|function|get_dev_info_by_irq
id|get_dev_info_by_irq
(paren
r_int
id|irq
comma
id|s390_dev_info_t
op_star
id|pdi
)paren
(brace
r_if
c_cond
(paren
id|irq
OG
id|highest_subchannel
op_logical_or
id|irq
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|pdi
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pdi-&gt;devno
op_assign
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.dev
suffix:semicolon
id|pdi-&gt;irq
op_assign
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.oper
op_logical_and
op_logical_neg
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.unknown
)paren
(brace
id|pdi-&gt;status
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
op_amp
(paren
id|pdi-&gt;sid_data
)paren
comma
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|senseid
comma
r_sizeof
(paren
id|senseid_t
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.unknown
)paren
(brace
id|pdi-&gt;status
op_assign
id|DEVSTAT_UNKNOWN_DEV
suffix:semicolon
id|memset
(paren
op_amp
(paren
id|pdi-&gt;sid_data
)paren
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
id|senseid_t
)paren
)paren
suffix:semicolon
id|pdi-&gt;sid_data.cu_type
op_assign
l_int|0xFFFF
suffix:semicolon
)brace
r_else
(brace
id|pdi-&gt;status
op_assign
id|DEVSTAT_NOT_OPER
suffix:semicolon
id|memset
(paren
op_amp
(paren
id|pdi-&gt;sid_data
)paren
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
id|senseid_t
)paren
)paren
suffix:semicolon
id|pdi-&gt;sid_data.cu_type
op_assign
l_int|0xFFFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|ui.flags.ready
)paren
id|pdi-&gt;status
op_or_assign
id|DEVSTAT_DEVICE_OWNED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|get_dev_info_by_devno
id|get_dev_info_by_devno
(paren
id|__u16
id|devno
comma
id|s390_dev_info_t
op_star
id|pdi
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|devno
OG
l_int|0x0000ffff
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|pdi
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|highest_subchannel
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|i
)braket
op_ne
id|INVALID_STORAGE_AREA
)paren
op_logical_and
(paren
op_logical_neg
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|st
)paren
op_logical_and
(paren
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|schib.pmcw.dev
op_eq
id|devno
)paren
)paren
(brace
id|pdi-&gt;irq
op_assign
id|i
suffix:semicolon
id|pdi-&gt;devno
op_assign
id|devno
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|ui.flags.oper
op_logical_and
op_logical_neg
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|ui.flags.unknown
)paren
(brace
id|pdi-&gt;status
op_assign
l_int|0
suffix:semicolon
id|memcpy
(paren
op_amp
(paren
id|pdi-&gt;sid_data
)paren
comma
op_amp
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|senseid
comma
r_sizeof
(paren
id|senseid_t
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|ui.flags.unknown
)paren
(brace
id|pdi-&gt;status
op_assign
id|DEVSTAT_UNKNOWN_DEV
suffix:semicolon
id|memset
(paren
op_amp
(paren
id|pdi-&gt;sid_data
)paren
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
id|senseid_t
)paren
)paren
suffix:semicolon
id|pdi-&gt;sid_data.cu_type
op_assign
l_int|0xFFFF
suffix:semicolon
)brace
r_else
(brace
id|pdi-&gt;status
op_assign
id|DEVSTAT_NOT_OPER
suffix:semicolon
id|memset
(paren
op_amp
(paren
id|pdi-&gt;sid_data
)paren
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
id|senseid_t
)paren
)paren
suffix:semicolon
id|pdi-&gt;sid_data.cu_type
op_assign
l_int|0xFFFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|ui.flags.ready
)paren
id|pdi-&gt;status
op_or_assign
id|DEVSTAT_DEVICE_OWNED
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* found */
r_break
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|get_irq_by_devno
id|get_irq_by_devno
(paren
id|__u16
id|devno
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|devno
op_le
l_int|0x0000ffff
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|highest_subchannel
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ioinfo
(braket
id|i
)braket
op_ne
id|INVALID_STORAGE_AREA
)paren
op_logical_and
(paren
op_logical_neg
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|st
)paren
op_logical_and
(paren
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|schib.pmcw.dev
op_eq
id|devno
)paren
op_logical_and
(paren
id|ioinfo
(braket
id|i
)braket
op_member_access_from_pointer
id|schib.pmcw.dnv
op_eq
l_int|1
)paren
)paren
(brace
id|rc
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
r_int
r_int
DECL|function|get_devno_by_irq
id|get_devno_by_irq
(paren
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
(paren
id|irq
OG
id|highest_subchannel
)paren
op_logical_or
(paren
id|irq
OL
l_int|0
)paren
op_logical_or
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * we don&squot;t need to check for the device be operational&n;&t; *  as the initial STSCH will always present the device&n;&t; *  number defined by the IOCDS regardless of the device&n;&t; *  existing or not. However, there could be subchannels&n;&t; *  defined who&squot;s device number isn&squot;t valid ...&n;&t; */
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.dnv
)paren
r_return
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib.pmcw.dev
suffix:semicolon
r_else
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|schib_t
op_star
DECL|function|s390_get_schib
id|s390_get_schib
(paren
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
(paren
id|irq
OG
id|highest_subchannel
)paren
op_logical_or
(paren
id|irq
OL
l_int|0
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
op_amp
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|schib
suffix:semicolon
)brace
multiline_comment|/* these are used only by the tape driver to store per subchannel &n; * private data */
r_int
DECL|function|s390_set_private_data
id|s390_set_private_data
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
id|irq
OG
id|highest_subchannel
op_logical_or
id|irq
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|private_data
op_assign
id|data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
op_star
DECL|function|s390_get_private_data
id|s390_get_private_data
c_func
(paren
r_int
id|irq
)paren
(brace
r_if
c_cond
(paren
(paren
id|irq
OG
id|highest_subchannel
)paren
op_logical_or
(paren
id|irq
OL
l_int|0
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_eq
id|INVALID_STORAGE_AREA
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|st
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|ioinfo
(braket
id|irq
)braket
op_member_access_from_pointer
id|private_data
suffix:semicolon
)brace
DECL|variable|ioinfo
id|EXPORT_SYMBOL
(paren
id|ioinfo
)paren
suffix:semicolon
DECL|variable|get_dev_info_by_irq
id|EXPORT_SYMBOL
(paren
id|get_dev_info_by_irq
)paren
suffix:semicolon
DECL|variable|get_dev_info_by_devno
id|EXPORT_SYMBOL
(paren
id|get_dev_info_by_devno
)paren
suffix:semicolon
DECL|variable|get_irq_by_devno
id|EXPORT_SYMBOL
(paren
id|get_irq_by_devno
)paren
suffix:semicolon
DECL|variable|get_devno_by_irq
id|EXPORT_SYMBOL
(paren
id|get_devno_by_irq
)paren
suffix:semicolon
DECL|variable|get_irq_first
id|EXPORT_SYMBOL
(paren
id|get_irq_first
)paren
suffix:semicolon
DECL|variable|get_irq_next
id|EXPORT_SYMBOL
(paren
id|get_irq_next
)paren
suffix:semicolon
DECL|variable|s390_get_schib
id|EXPORT_SYMBOL
(paren
id|s390_get_schib
)paren
suffix:semicolon
DECL|variable|s390_set_private_data
id|EXPORT_SYMBOL
(paren
id|s390_set_private_data
)paren
suffix:semicolon
DECL|variable|s390_get_private_data
id|EXPORT_SYMBOL
(paren
id|s390_get_private_data
)paren
suffix:semicolon
eof
