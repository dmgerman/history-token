multiline_comment|/*&n; *  linux/drivers/s390/misc/z90main.c&n; *&n; *  z90crypt 1.3.1&n; *&n; *  Copyright (C)  2001, 2004 IBM Corporation&n; *  Author(s): Robert Burroughs (burrough@us.ibm.com)&n; *&t;       Eric Rossman (edrossma@us.ibm.com)&n; *&n; *  Hotplug &amp; misc device support: Jochen Roehrig (roehrig@de.ibm.com)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&t; See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;asm/uaccess.h&gt;       
singleline_comment|// copy_(from|to)_user
macro_line|#include &lt;linux/compat.h&gt;
macro_line|#include &lt;linux/compiler.h&gt;
macro_line|#include &lt;linux/delay.h&gt;       
singleline_comment|// mdelay
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;   
singleline_comment|// for tasklets
macro_line|#include &lt;linux/ioctl32.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/syscalls.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &quot;z90crypt.h&quot;
macro_line|#include &quot;z90common.h&quot;
macro_line|#ifndef Z90CRYPT_USE_HOTPLUG
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#endif
DECL|macro|VERSION_CODE
mdefine_line|#define VERSION_CODE(vers, rel, seq) (((vers)&lt;&lt;16) | ((rel)&lt;&lt;8) | (seq))
macro_line|#if LINUX_VERSION_CODE &lt; VERSION_CODE(2,4,0) /* version &lt; 2.4 */
macro_line|#  error &quot;This kernel is too old: not supported&quot;
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE &gt; VERSION_CODE(2,7,0) /* version &gt; 2.6 */
macro_line|#  error &quot;This kernel is too recent: not supported by this file&quot;
macro_line|#endif
DECL|macro|VERSION_Z90MAIN_C
mdefine_line|#define VERSION_Z90MAIN_C &quot;$Revision: 1.31 $&quot;
DECL|variable|__initdata
r_static
r_char
id|z90cmain_version
(braket
)braket
id|__initdata
op_assign
l_string|&quot;z90main.o (&quot;
id|VERSION_Z90MAIN_C
l_string|&quot;/&quot;
id|VERSION_Z90COMMON_H
l_string|&quot;/&quot;
id|VERSION_Z90CRYPT_H
l_string|&quot;)&quot;
suffix:semicolon
r_extern
r_char
id|z90chardware_version
(braket
)braket
suffix:semicolon
multiline_comment|/**&n; * Defaults that may be modified.&n; */
macro_line|#ifndef Z90CRYPT_USE_HOTPLUG
multiline_comment|/**&n; * You can specify a different minor at compile time.&n; */
macro_line|#ifndef Z90CRYPT_MINOR
DECL|macro|Z90CRYPT_MINOR
mdefine_line|#define Z90CRYPT_MINOR&t;MISC_DYNAMIC_MINOR
macro_line|#endif
macro_line|#else
multiline_comment|/**&n; * You can specify a different major at compile time.&n; */
macro_line|#ifndef Z90CRYPT_MAJOR
DECL|macro|Z90CRYPT_MAJOR
mdefine_line|#define Z90CRYPT_MAJOR&t;0
macro_line|#endif
macro_line|#endif
multiline_comment|/**&n; * You can specify a different domain at compile time or on the insmod&n; * command line.&n; */
macro_line|#ifndef DOMAIN_INDEX
DECL|macro|DOMAIN_INDEX
mdefine_line|#define DOMAIN_INDEX&t;-1
macro_line|#endif
multiline_comment|/**&n; * This is the name under which the device is registered in /proc/modules.&n; */
DECL|macro|REG_NAME
mdefine_line|#define REG_NAME&t;&quot;z90crypt&quot;
multiline_comment|/**&n; * Cleanup should run every CLEANUPTIME seconds and should clean up requests&n; * older than CLEANUPTIME seconds in the past.&n; */
macro_line|#ifndef CLEANUPTIME
DECL|macro|CLEANUPTIME
mdefine_line|#define CLEANUPTIME 15
macro_line|#endif
multiline_comment|/**&n; * Config should run every CONFIGTIME seconds&n; */
macro_line|#ifndef CONFIGTIME
DECL|macro|CONFIGTIME
mdefine_line|#define CONFIGTIME 30
macro_line|#endif
multiline_comment|/**&n; * The first execution of the config task should take place&n; * immediately after initialization&n; */
macro_line|#ifndef INITIAL_CONFIGTIME
DECL|macro|INITIAL_CONFIGTIME
mdefine_line|#define INITIAL_CONFIGTIME 1
macro_line|#endif
multiline_comment|/**&n; * Reader should run every READERTIME milliseconds&n; */
macro_line|#ifndef READERTIME
DECL|macro|READERTIME
mdefine_line|#define READERTIME 2
macro_line|#endif
multiline_comment|/**&n; * turn long device array index into device pointer&n; */
DECL|macro|LONG2DEVPTR
mdefine_line|#define LONG2DEVPTR(ndx) (z90crypt.device_p[(ndx)])
multiline_comment|/**&n; * turn short device array index into long device array index&n; */
DECL|macro|SHRT2LONG
mdefine_line|#define SHRT2LONG(ndx) (z90crypt.overall_device_x.device_index[(ndx)])
multiline_comment|/**&n; * turn short device array index into device pointer&n; */
DECL|macro|SHRT2DEVPTR
mdefine_line|#define SHRT2DEVPTR(ndx) LONG2DEVPTR(SHRT2LONG(ndx))
multiline_comment|/**&n; * Status for a work-element&n; */
DECL|macro|STAT_DEFAULT
mdefine_line|#define STAT_DEFAULT&t;0x00 
singleline_comment|// request has not been processed
DECL|macro|STAT_ROUTED
mdefine_line|#define STAT_ROUTED&t;0x80 
singleline_comment|// bit 7: requests get routed to specific device
singleline_comment|//&t;       else, device is determined each write
DECL|macro|STAT_FAILED
mdefine_line|#define STAT_FAILED&t;0x40 
singleline_comment|// bit 6: this bit is set if the request failed
singleline_comment|//&t;       before being sent to the hardware.
DECL|macro|STAT_WRITTEN
mdefine_line|#define STAT_WRITTEN&t;0x30 
singleline_comment|// bits 5-4: work to be done, not sent to device
singleline_comment|//&t;&t;&t;0x20 // UNUSED state
DECL|macro|STAT_READPEND
mdefine_line|#define STAT_READPEND&t;0x10 
singleline_comment|// bits 5-4: work done, we&squot;re returning data now
DECL|macro|STAT_NOWORK
mdefine_line|#define STAT_NOWORK&t;0x00 
singleline_comment|// bits off: no work on any queue
DECL|macro|STAT_RDWRMASK
mdefine_line|#define STAT_RDWRMASK&t;0x30 
singleline_comment|// mask for bits 5-4
multiline_comment|/**&n; * Macros to check the status RDWRMASK&n; */
DECL|macro|CHK_RDWRMASK
mdefine_line|#define CHK_RDWRMASK(statbyte) ((statbyte) &amp; STAT_RDWRMASK)
DECL|macro|SET_RDWRMASK
mdefine_line|#define SET_RDWRMASK(statbyte, newval) &bslash;&n;&t;{(statbyte) &amp;= ~STAT_RDWRMASK; (statbyte) |= newval;}
multiline_comment|/**&n; * Audit Trail.&t; Progress of a Work element&n; * audit[0]: Unless noted otherwise, these bits are all set by the process&n; */
DECL|macro|FP_COPYFROM
mdefine_line|#define FP_COPYFROM&t;0x80 
singleline_comment|// Caller&squot;s buffer has been copied to work element
DECL|macro|FP_BUFFREQ
mdefine_line|#define FP_BUFFREQ&t;0x40 
singleline_comment|// Low Level buffer requested
DECL|macro|FP_BUFFGOT
mdefine_line|#define FP_BUFFGOT&t;0x20 
singleline_comment|// Low Level buffer obtained
DECL|macro|FP_SENT
mdefine_line|#define FP_SENT&t;&t;0x10 
singleline_comment|// Work element sent to a crypto device
singleline_comment|// (may be set by process or by reader task)
DECL|macro|FP_PENDING
mdefine_line|#define FP_PENDING&t;0x08 
singleline_comment|// Work element placed on pending queue
singleline_comment|// (may be set by process or by reader task)
DECL|macro|FP_REQUEST
mdefine_line|#define FP_REQUEST&t;0x04 
singleline_comment|// Work element placed on request queue
DECL|macro|FP_ASLEEP
mdefine_line|#define FP_ASLEEP&t;0x02 
singleline_comment|// Work element about to sleep
DECL|macro|FP_AWAKE
mdefine_line|#define FP_AWAKE&t;0x01 
singleline_comment|// Work element has been awakened
multiline_comment|/**&n; * audit[1]: These bits are set by the reader task and/or the cleanup task&n; */
DECL|macro|FP_NOTPENDING
mdefine_line|#define FP_NOTPENDING&t;  0x80 
singleline_comment|// Work element removed from pending queue
DECL|macro|FP_AWAKENING
mdefine_line|#define FP_AWAKENING&t;  0x40 
singleline_comment|// Caller about to be awakened
DECL|macro|FP_TIMEDOUT
mdefine_line|#define FP_TIMEDOUT&t;  0x20 
singleline_comment|// Caller timed out
DECL|macro|FP_RESPSIZESET
mdefine_line|#define FP_RESPSIZESET&t;  0x10 
singleline_comment|// Response size copied to work element
DECL|macro|FP_RESPADDRCOPIED
mdefine_line|#define FP_RESPADDRCOPIED 0x08 
singleline_comment|// Response address copied to work element
DECL|macro|FP_RESPBUFFCOPIED
mdefine_line|#define FP_RESPBUFFCOPIED 0x04 
singleline_comment|// Response buffer copied to work element
DECL|macro|FP_REMREQUEST
mdefine_line|#define FP_REMREQUEST&t;  0x02 
singleline_comment|// Work element removed from request queue
DECL|macro|FP_SIGNALED
mdefine_line|#define FP_SIGNALED&t;  0x01 
singleline_comment|// Work element was awakened by a signal
multiline_comment|/**&n; * audit[2]: unused&n; */
multiline_comment|/**&n; * state of the file handle in private_data.status&n; */
DECL|macro|STAT_OPEN
mdefine_line|#define STAT_OPEN 0
DECL|macro|STAT_CLOSED
mdefine_line|#define STAT_CLOSED 1
multiline_comment|/**&n; * PID() expands to the process ID of the current process&n; */
DECL|macro|PID
mdefine_line|#define PID() (current-&gt;pid)
multiline_comment|/**&n; * Selected Constants.&t;The number of APs and the number of devices&n; */
macro_line|#ifndef Z90CRYPT_NUM_APS
DECL|macro|Z90CRYPT_NUM_APS
mdefine_line|#define Z90CRYPT_NUM_APS 64
macro_line|#endif
macro_line|#ifndef Z90CRYPT_NUM_DEVS
DECL|macro|Z90CRYPT_NUM_DEVS
mdefine_line|#define Z90CRYPT_NUM_DEVS Z90CRYPT_NUM_APS
macro_line|#endif
macro_line|#ifndef Z90CRYPT_NUM_TYPES
DECL|macro|Z90CRYPT_NUM_TYPES
mdefine_line|#define Z90CRYPT_NUM_TYPES 3
macro_line|#endif
multiline_comment|/**&n; * Buffer size for receiving responses. The maximum Response Size&n; * is actually the maximum request size, since in an error condition&n; * the request itself may be returned unchanged.&n; */
macro_line|#ifndef MAX_RESPONSE_SIZE
DECL|macro|MAX_RESPONSE_SIZE
mdefine_line|#define MAX_RESPONSE_SIZE 0x0000077C
macro_line|#endif
multiline_comment|/**&n; * A count and status-byte mask&n; */
DECL|struct|status
r_struct
id|status
(brace
DECL|member|st_count
r_int
id|st_count
suffix:semicolon
singleline_comment|// # of enabled devices
DECL|member|disabled_count
r_int
id|disabled_count
suffix:semicolon
singleline_comment|// # of disabled devices
DECL|member|user_disabled_count
r_int
id|user_disabled_count
suffix:semicolon
singleline_comment|// # of devices disabled via proc fs
DECL|member|st_mask
r_int
r_char
id|st_mask
(braket
id|Z90CRYPT_NUM_APS
)braket
suffix:semicolon
singleline_comment|// current status mask
)brace
suffix:semicolon
multiline_comment|/**&n; * The array of device indexes is a mechanism for fast indexing into&n; * a long (and sparse) array.  For instance, if APs 3, 9 and 47 are&n; * installed, z90CDeviceIndex[0] is 3, z90CDeviceIndex[1] is 9, and&n; * z90CDeviceIndex[2] is 47.&n; */
DECL|struct|device_x
r_struct
id|device_x
(brace
DECL|member|device_index
r_int
id|device_index
(braket
id|Z90CRYPT_NUM_DEVS
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * All devices are arranged in a single array: 64 APs&n; */
DECL|struct|device
r_struct
id|device
(brace
DECL|member|dev_type
r_int
id|dev_type
suffix:semicolon
singleline_comment|// PCICA, PCICC, or PCIXCC
DECL|member|dev_stat
r_enum
id|devstat
id|dev_stat
suffix:semicolon
singleline_comment|// current device status
DECL|member|dev_self_x
r_int
id|dev_self_x
suffix:semicolon
singleline_comment|// Index in array
DECL|member|disabled
r_int
id|disabled
suffix:semicolon
singleline_comment|// Set when device is in error
DECL|member|user_disabled
r_int
id|user_disabled
suffix:semicolon
singleline_comment|// Set when device is disabled by user
DECL|member|dev_q_depth
r_int
id|dev_q_depth
suffix:semicolon
singleline_comment|// q depth
DECL|member|dev_resp_p
r_int
r_char
op_star
id|dev_resp_p
suffix:semicolon
singleline_comment|// Response buffer address
DECL|member|dev_resp_l
r_int
id|dev_resp_l
suffix:semicolon
singleline_comment|// Response Buffer length
DECL|member|dev_caller_count
r_int
id|dev_caller_count
suffix:semicolon
singleline_comment|// Number of callers
DECL|member|dev_total_req_cnt
r_int
id|dev_total_req_cnt
suffix:semicolon
singleline_comment|// # requests for device since load
DECL|member|dev_caller_list
r_struct
id|list_head
id|dev_caller_list
suffix:semicolon
singleline_comment|// List of callers
)brace
suffix:semicolon
multiline_comment|/**&n; * There&squot;s a struct status and a struct device_x for each device type.&n; */
DECL|struct|hdware_block
r_struct
id|hdware_block
(brace
DECL|member|hdware_mask
r_struct
id|status
id|hdware_mask
suffix:semicolon
DECL|member|type_mask
r_struct
id|status
id|type_mask
(braket
id|Z90CRYPT_NUM_TYPES
)braket
suffix:semicolon
DECL|member|type_x_addr
r_struct
id|device_x
id|type_x_addr
(braket
id|Z90CRYPT_NUM_TYPES
)braket
suffix:semicolon
DECL|member|device_type_array
r_int
r_char
id|device_type_array
(braket
id|Z90CRYPT_NUM_APS
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * z90crypt is the topmost data structure in the hierarchy.&n; */
DECL|struct|z90crypt
r_struct
id|z90crypt
(brace
DECL|member|max_count
r_int
id|max_count
suffix:semicolon
singleline_comment|// Nr of possible crypto devices
DECL|member|mask
r_struct
id|status
id|mask
suffix:semicolon
DECL|member|q_depth_array
r_int
id|q_depth_array
(braket
id|Z90CRYPT_NUM_DEVS
)braket
suffix:semicolon
DECL|member|dev_type_array
r_int
id|dev_type_array
(braket
id|Z90CRYPT_NUM_DEVS
)braket
suffix:semicolon
DECL|member|overall_device_x
r_struct
id|device_x
id|overall_device_x
suffix:semicolon
singleline_comment|// array device indexes
DECL|member|device_p
r_struct
id|device
op_star
id|device_p
(braket
id|Z90CRYPT_NUM_DEVS
)braket
suffix:semicolon
DECL|member|terminating
r_int
id|terminating
suffix:semicolon
DECL|member|domain_established
r_int
id|domain_established
suffix:semicolon
singleline_comment|// TRUE:  domain has been found
DECL|member|cdx
r_int
id|cdx
suffix:semicolon
singleline_comment|// Crypto Domain Index
DECL|member|len
r_int
id|len
suffix:semicolon
singleline_comment|// Length of this data structure
DECL|member|hdware_info
r_struct
id|hdware_block
op_star
id|hdware_info
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * An array of these structures is pointed to from dev_caller&n; * The length of the array depends on the device type. For APs,&n; * there are 8.&n; *&n; * The caller buffer is allocated to the user at OPEN. At WRITE,&n; * it contains the request; at READ, the response. The function&n; * send_to_crypto_device converts the request to device-dependent&n; * form and use the caller&squot;s OPEN-allocated buffer for the response.&n; */
DECL|struct|caller
r_struct
id|caller
(brace
DECL|member|caller_buf_l
r_int
id|caller_buf_l
suffix:semicolon
singleline_comment|// length of original request
DECL|member|caller_buf_p
r_int
r_char
op_star
id|caller_buf_p
suffix:semicolon
singleline_comment|// Original request on WRITE
DECL|member|caller_dev_dep_req_l
r_int
id|caller_dev_dep_req_l
suffix:semicolon
singleline_comment|// len device dependent request
DECL|member|caller_dev_dep_req_p
r_int
r_char
op_star
id|caller_dev_dep_req_p
suffix:semicolon
singleline_comment|// Device dependent form
DECL|member|caller_id
r_int
r_char
id|caller_id
(braket
l_int|8
)braket
suffix:semicolon
singleline_comment|// caller-supplied message id
DECL|member|caller_liste
r_struct
id|list_head
id|caller_liste
suffix:semicolon
DECL|member|caller_dev_dep_req
r_int
r_char
id|caller_dev_dep_req
(braket
id|MAX_RESPONSE_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * Function prototypes from z90hardware.c&n; */
r_enum
id|hdstat
id|query_online
c_func
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
op_star
comma
r_int
op_star
)paren
suffix:semicolon
r_enum
id|devstat
id|reset_device
c_func
(paren
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
r_enum
id|devstat
id|send_to_AP
c_func
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
r_char
op_star
)paren
suffix:semicolon
r_enum
id|devstat
id|receive_from_AP
c_func
(paren
r_int
comma
r_int
comma
r_int
comma
r_int
r_char
op_star
comma
r_int
r_char
op_star
)paren
suffix:semicolon
r_int
id|convert_request
c_func
(paren
r_int
r_char
op_star
comma
r_int
comma
r_int
comma
r_int
comma
r_int
comma
r_int
op_star
comma
r_int
r_char
op_star
)paren
suffix:semicolon
r_int
id|convert_response
c_func
(paren
r_int
r_char
op_star
comma
r_int
r_char
op_star
comma
r_int
op_star
comma
r_int
r_char
op_star
)paren
suffix:semicolon
multiline_comment|/**&n; * Low level function prototypes&n; */
r_static
r_int
id|create_z90crypt
c_func
(paren
r_int
op_star
)paren
suffix:semicolon
r_static
r_int
id|refresh_z90crypt
c_func
(paren
r_int
op_star
)paren
suffix:semicolon
r_static
r_int
id|find_crypto_devices
c_func
(paren
r_struct
id|status
op_star
)paren
suffix:semicolon
r_static
r_int
id|create_crypto_device
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_int
id|destroy_crypto_device
c_func
(paren
r_int
)paren
suffix:semicolon
r_static
r_void
id|destroy_z90crypt
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|refresh_index_array
c_func
(paren
r_struct
id|status
op_star
comma
r_struct
id|device_x
op_star
)paren
suffix:semicolon
r_static
r_int
id|probe_device_type
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
multiline_comment|/**&n; * proc fs definitions&n; */
DECL|variable|z90crypt_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|z90crypt_entry
suffix:semicolon
multiline_comment|/**&n; * data structures&n; */
multiline_comment|/**&n; * work_element.opener points back to this structure&n; */
DECL|struct|priv_data
r_struct
id|priv_data
(brace
DECL|member|opener_pid
id|pid_t
id|opener_pid
suffix:semicolon
DECL|member|status
r_int
r_char
id|status
suffix:semicolon
singleline_comment|// 0: open  1: closed
)brace
suffix:semicolon
multiline_comment|/**&n; * A work element is allocated for each request&n; */
DECL|struct|work_element
r_struct
id|work_element
(brace
DECL|member|priv_data
r_struct
id|priv_data
op_star
id|priv_data
suffix:semicolon
DECL|member|pid
id|pid_t
id|pid
suffix:semicolon
DECL|member|devindex
r_int
id|devindex
suffix:semicolon
singleline_comment|// index of device processing this w_e
singleline_comment|// (If request did not specify device,
singleline_comment|// -1 until placed onto a queue)
DECL|member|devtype
r_int
id|devtype
suffix:semicolon
DECL|member|liste
r_struct
id|list_head
id|liste
suffix:semicolon
singleline_comment|// used for requestq and pendingq
DECL|member|buffer
r_char
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
singleline_comment|// local copy of user request
DECL|member|buff_size
r_int
id|buff_size
suffix:semicolon
singleline_comment|// size of the buffer for the request
DECL|member|resp_buff
r_char
id|resp_buff
(braket
id|RESPBUFFSIZE
)braket
suffix:semicolon
DECL|member|resp_buff_size
r_int
id|resp_buff_size
suffix:semicolon
DECL|member|resp_addr
r_char
op_star
id|resp_addr
suffix:semicolon
singleline_comment|// address of response in user space
DECL|member|funccode
r_int
r_int
id|funccode
suffix:semicolon
singleline_comment|// function code of request
DECL|member|waitq
id|wait_queue_head_t
id|waitq
suffix:semicolon
DECL|member|requestsent
r_int
r_int
id|requestsent
suffix:semicolon
singleline_comment|// time at which the request was sent
DECL|member|alarmrung
id|atomic_t
id|alarmrung
suffix:semicolon
singleline_comment|// wake-up signal
DECL|member|caller_id
r_int
r_char
id|caller_id
(braket
l_int|8
)braket
suffix:semicolon
singleline_comment|// pid + counter, for this w_e
DECL|member|status
r_int
r_char
id|status
(braket
l_int|1
)braket
suffix:semicolon
singleline_comment|// bits to mark status of the request
DECL|member|audit
r_int
r_char
id|audit
(braket
l_int|3
)braket
suffix:semicolon
singleline_comment|// record of work element&squot;s progress
DECL|member|requestptr
r_int
r_char
op_star
id|requestptr
suffix:semicolon
singleline_comment|// address of request buffer
DECL|member|retcode
r_int
id|retcode
suffix:semicolon
singleline_comment|// return code of request
)brace
suffix:semicolon
multiline_comment|/**&n; * High level function prototypes&n; */
r_static
r_int
id|z90crypt_open
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|z90crypt_release
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
id|ssize_t
id|z90crypt_read
c_func
(paren
r_struct
id|file
op_star
comma
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_static
id|ssize_t
id|z90crypt_write
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|z90crypt_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|z90crypt_reader_task
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|z90crypt_schedule_reader_task
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|z90crypt_config_task
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|z90crypt_cleanup_task
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|z90crypt_status
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
op_star
comma
r_void
op_star
)paren
suffix:semicolon
r_static
r_int
id|z90crypt_status_write
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
r_int
r_int
comma
r_void
op_star
)paren
suffix:semicolon
multiline_comment|/**&n; * Hotplug support&n; */
macro_line|#ifdef Z90CRYPT_USE_HOTPLUG
DECL|macro|Z90CRYPT_HOTPLUG_ADD
mdefine_line|#define Z90CRYPT_HOTPLUG_ADD&t; 1
DECL|macro|Z90CRYPT_HOTPLUG_REMOVE
mdefine_line|#define Z90CRYPT_HOTPLUG_REMOVE&t; 2
r_static
r_void
id|z90crypt_hotplug_event
c_func
(paren
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/**&n; * Storage allocated at initialization and used throughout the life of&n; * this insmod&n; */
macro_line|#ifdef Z90CRYPT_USE_HOTPLUG
DECL|variable|z90crypt_major
r_static
r_int
id|z90crypt_major
op_assign
id|Z90CRYPT_MAJOR
suffix:semicolon
macro_line|#endif
DECL|variable|domain
r_static
r_int
id|domain
op_assign
id|DOMAIN_INDEX
suffix:semicolon
DECL|variable|z90crypt
r_static
r_struct
id|z90crypt
id|z90crypt
suffix:semicolon
DECL|variable|quiesce_z90crypt
r_static
r_int
id|quiesce_z90crypt
suffix:semicolon
DECL|variable|queuespinlock
r_static
id|spinlock_t
id|queuespinlock
suffix:semicolon
DECL|variable|request_list
r_static
r_struct
id|list_head
id|request_list
suffix:semicolon
DECL|variable|requestq_count
r_static
r_int
id|requestq_count
suffix:semicolon
DECL|variable|pending_list
r_static
r_struct
id|list_head
id|pending_list
suffix:semicolon
DECL|variable|pendingq_count
r_static
r_int
id|pendingq_count
suffix:semicolon
DECL|variable|reader_tasklet
r_static
r_struct
id|tasklet_struct
id|reader_tasklet
suffix:semicolon
DECL|variable|reader_timer
r_static
r_struct
id|timer_list
id|reader_timer
suffix:semicolon
DECL|variable|config_timer
r_static
r_struct
id|timer_list
id|config_timer
suffix:semicolon
DECL|variable|cleanup_timer
r_static
r_struct
id|timer_list
id|cleanup_timer
suffix:semicolon
DECL|variable|total_open
r_static
id|atomic_t
id|total_open
suffix:semicolon
DECL|variable|z90crypt_step
r_static
id|atomic_t
id|z90crypt_step
suffix:semicolon
DECL|variable|z90crypt_fops
r_static
r_struct
id|file_operations
id|z90crypt_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|z90crypt_read
comma
dot
id|write
op_assign
id|z90crypt_write
comma
dot
id|ioctl
op_assign
id|z90crypt_ioctl
comma
dot
id|open
op_assign
id|z90crypt_open
comma
dot
id|release
op_assign
id|z90crypt_release
)brace
suffix:semicolon
macro_line|#ifndef Z90CRYPT_USE_HOTPLUG
DECL|variable|z90crypt_misc_device
r_static
r_struct
id|miscdevice
id|z90crypt_misc_device
op_assign
(brace
dot
id|minor
op_assign
id|Z90CRYPT_MINOR
comma
dot
id|name
op_assign
id|DEV_NAME
comma
dot
id|fops
op_assign
op_amp
id|z90crypt_fops
comma
dot
id|devfs_name
op_assign
id|DEV_NAME
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/**&n; * Documentation values.&n; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;zLinux Crypto Team: Robert H. Burroughs, Eric D. Rossman&quot;
l_string|&quot;and Jochen Roehrig&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;zLinux Cryptographic Coprocessor device driver, &quot;
l_string|&quot;Copyright 2001, 2004 IBM Corporation&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|domain
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|domain
comma
l_string|&quot;domain index for device&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_COMPAT
multiline_comment|/**&n; * ioctl32 conversion routines&n; */
DECL|struct|ica_rsa_modexpo_32
r_struct
id|ica_rsa_modexpo_32
(brace
singleline_comment|// For 32-bit callers
DECL|member|inputdata
id|compat_uptr_t
id|inputdata
suffix:semicolon
DECL|member|inputdatalength
r_int
r_int
id|inputdatalength
suffix:semicolon
DECL|member|outputdata
id|compat_uptr_t
id|outputdata
suffix:semicolon
DECL|member|outputdatalength
r_int
r_int
id|outputdatalength
suffix:semicolon
DECL|member|b_key
id|compat_uptr_t
id|b_key
suffix:semicolon
DECL|member|n_modulus
id|compat_uptr_t
id|n_modulus
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|trans_modexpo32
id|trans_modexpo32
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|ica_rsa_modexpo_32
op_star
id|mex32u
op_assign
id|compat_ptr
c_func
(paren
id|arg
)paren
suffix:semicolon
r_struct
id|ica_rsa_modexpo_32
id|mex32k
suffix:semicolon
r_struct
id|ica_rsa_modexpo
op_star
id|mex64
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|mex32u
comma
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo_32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|mex64
op_assign
id|compat_alloc_user_space
c_func
(paren
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|mex64
comma
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|mex32k
comma
id|mex32u
comma
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo_32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|mex32k.inputdata
)paren
comma
op_amp
id|mex64-&gt;inputdata
)paren
op_logical_or
id|__put_user
c_func
(paren
id|mex32k.inputdatalength
comma
op_amp
id|mex64-&gt;inputdatalength
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|mex32k.outputdata
)paren
comma
op_amp
id|mex64-&gt;outputdata
)paren
op_logical_or
id|__put_user
c_func
(paren
id|mex32k.outputdatalength
comma
op_amp
id|mex64-&gt;outputdatalength
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|mex32k.b_key
)paren
comma
op_amp
id|mex64-&gt;b_key
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|mex32k.n_modulus
)paren
comma
op_amp
id|mex64-&gt;n_modulus
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
id|sys_ioctl
c_func
(paren
id|fd
comma
id|cmd
comma
(paren
r_int
r_int
)paren
id|mex64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_if
c_cond
(paren
id|__get_user
c_func
(paren
id|i
comma
op_amp
id|mex64-&gt;outputdatalength
)paren
op_logical_or
id|__put_user
c_func
(paren
id|i
comma
op_amp
id|mex32u-&gt;outputdatalength
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|struct|ica_rsa_modexpo_crt_32
r_struct
id|ica_rsa_modexpo_crt_32
(brace
singleline_comment|// For 32-bit callers
DECL|member|inputdata
id|compat_uptr_t
id|inputdata
suffix:semicolon
DECL|member|inputdatalength
r_int
r_int
id|inputdatalength
suffix:semicolon
DECL|member|outputdata
id|compat_uptr_t
id|outputdata
suffix:semicolon
DECL|member|outputdatalength
r_int
r_int
id|outputdatalength
suffix:semicolon
DECL|member|bp_key
id|compat_uptr_t
id|bp_key
suffix:semicolon
DECL|member|bq_key
id|compat_uptr_t
id|bq_key
suffix:semicolon
DECL|member|np_prime
id|compat_uptr_t
id|np_prime
suffix:semicolon
DECL|member|nq_prime
id|compat_uptr_t
id|nq_prime
suffix:semicolon
DECL|member|u_mult_inv
id|compat_uptr_t
id|u_mult_inv
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|trans_modexpo_crt32
id|trans_modexpo_crt32
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|ica_rsa_modexpo_crt_32
op_star
id|crt32u
op_assign
id|compat_ptr
c_func
(paren
id|arg
)paren
suffix:semicolon
r_struct
id|ica_rsa_modexpo_crt_32
id|crt32k
suffix:semicolon
r_struct
id|ica_rsa_modexpo_crt
op_star
id|crt64
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|crt32u
comma
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo_crt_32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|crt64
op_assign
id|compat_alloc_user_space
c_func
(paren
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo_crt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|crt64
comma
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo_crt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|crt32k
comma
id|crt32u
comma
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo_crt_32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|crt32k.inputdata
)paren
comma
op_amp
id|crt64-&gt;inputdata
)paren
op_logical_or
id|__put_user
c_func
(paren
id|crt32k.inputdatalength
comma
op_amp
id|crt64-&gt;inputdatalength
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|crt32k.outputdata
)paren
comma
op_amp
id|crt64-&gt;outputdata
)paren
op_logical_or
id|__put_user
c_func
(paren
id|crt32k.outputdatalength
comma
op_amp
id|crt64-&gt;outputdatalength
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|crt32k.bp_key
)paren
comma
op_amp
id|crt64-&gt;bp_key
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|crt32k.bq_key
)paren
comma
op_amp
id|crt64-&gt;bq_key
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|crt32k.np_prime
)paren
comma
op_amp
id|crt64-&gt;np_prime
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|crt32k.nq_prime
)paren
comma
op_amp
id|crt64-&gt;nq_prime
)paren
op_logical_or
id|__put_user
c_func
(paren
id|compat_ptr
c_func
(paren
id|crt32k.u_mult_inv
)paren
comma
op_amp
id|crt64-&gt;u_mult_inv
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|sys_ioctl
c_func
(paren
id|fd
comma
id|cmd
comma
(paren
r_int
r_int
)paren
id|crt64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_if
c_cond
(paren
id|__get_user
c_func
(paren
id|i
comma
op_amp
id|crt64-&gt;outputdatalength
)paren
op_logical_or
id|__put_user
c_func
(paren
id|i
comma
op_amp
id|crt32u-&gt;outputdatalength
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|compatible_ioctls
r_static
r_int
id|compatible_ioctls
(braket
)braket
op_assign
(brace
id|ICAZ90STATUS
comma
id|Z90QUIESCE
comma
id|Z90STAT_TOTALCOUNT
comma
id|Z90STAT_PCICACOUNT
comma
id|Z90STAT_PCICCCOUNT
comma
id|Z90STAT_PCIXCCCOUNT
comma
id|Z90STAT_REQUESTQ_COUNT
comma
id|Z90STAT_PENDINGQ_COUNT
comma
id|Z90STAT_TOTALOPEN_COUNT
comma
id|Z90STAT_DOMAIN_INDEX
comma
id|Z90STAT_STATUS_MASK
comma
id|Z90STAT_QDEPTH_MASK
comma
id|Z90STAT_PERDEV_REQCNT
comma
)brace
suffix:semicolon
DECL|function|z90_unregister_ioctl32s
r_static
r_void
id|z90_unregister_ioctl32s
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|ICARSAMODEXPO
)paren
suffix:semicolon
id|unregister_ioctl32_conversion
c_func
(paren
id|ICARSACRT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|compatible_ioctls
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|unregister_ioctl32_conversion
c_func
(paren
id|compatible_ioctls
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|z90_register_ioctl32s
r_static
r_int
id|z90_register_ioctl32s
c_func
(paren
r_void
)paren
(brace
r_int
id|result
comma
id|i
suffix:semicolon
id|result
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|ICARSAMODEXPO
comma
id|trans_modexpo32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|ICARSACRT
comma
id|trans_modexpo_crt32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|compatible_ioctls
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|result
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|compatible_ioctls
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|z90_unregister_ioctl32s
c_func
(paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
macro_line|#else 
singleline_comment|// !CONFIG_COMPAT
DECL|function|z90_unregister_ioctl32s
r_static
r_inline
r_void
id|z90_unregister_ioctl32s
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|z90_register_ioctl32s
r_static
r_inline
r_int
id|z90_register_ioctl32s
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**&n; * The module initialization code.&n; */
r_static
r_int
id|__init
DECL|function|z90crypt_init_module
id|z90crypt_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|result
comma
id|nresult
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|entry
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;PID %d&bslash;n&quot;
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
macro_line|#ifndef Z90CRYPT_USE_HOTPLUG
multiline_comment|/* Register as misc device with given minor (or get a dynamic one). */
id|result
op_assign
id|misc_register
c_func
(paren
op_amp
id|z90crypt_misc_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|PRINTKW
c_func
(paren
id|KERN_ERR
l_string|&quot;misc_register (minor %d) failed with %d&bslash;n&quot;
comma
id|z90crypt_misc_device.minor
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* Register the major (or get a dynamic one). */
id|result
op_assign
id|register_chrdev
c_func
(paren
id|z90crypt_major
comma
id|REG_NAME
comma
op_amp
id|z90crypt_fops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|PRINTKW
c_func
(paren
l_string|&quot;register_chrdev (major %d) failed with %d.&bslash;n&quot;
comma
id|z90crypt_major
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
id|z90crypt_major
op_eq
l_int|0
)paren
id|z90crypt_major
op_assign
id|result
suffix:semicolon
macro_line|#endif
id|PDEBUG
c_func
(paren
l_string|&quot;Registered &quot;
id|DEV_NAME
l_string|&quot; with result %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|result
op_assign
id|create_z90crypt
c_func
(paren
op_amp
id|domain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
(brace
id|PRINTKW
c_func
(paren
l_string|&quot;create_z90crypt (domain index %d) failed with %d.&bslash;n&quot;
comma
id|domain
comma
id|result
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|init_module_cleanup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|PRINTKN
c_func
(paren
l_string|&quot;Version %d.%d.%d loaded, built on %s %s&bslash;n&quot;
comma
id|z90crypt_VERSION
comma
id|z90crypt_RELEASE
comma
id|z90crypt_VARIANT
comma
id|__DATE__
comma
id|__TIME__
)paren
suffix:semicolon
id|PRINTKN
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|z90cmain_version
)paren
suffix:semicolon
id|PRINTKN
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|z90chardware_version
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;create_z90crypt (domain index %d) successful.&bslash;n&quot;
comma
id|domain
)paren
suffix:semicolon
)brace
r_else
id|PRINTK
c_func
(paren
l_string|&quot;No devices at startup&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef Z90CRYPT_USE_HOTPLUG
multiline_comment|/* generate hotplug event for device node generation */
id|z90crypt_hotplug_event
c_func
(paren
id|z90crypt_major
comma
l_int|0
comma
id|Z90CRYPT_HOTPLUG_ADD
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Initialize globals. */
id|spin_lock_init
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|pending_list
)paren
suffix:semicolon
id|pendingq_count
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|request_list
)paren
suffix:semicolon
id|requestq_count
op_assign
l_int|0
suffix:semicolon
id|quiesce_z90crypt
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|total_open
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|z90crypt_step
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set up the cleanup task. */
id|init_timer
c_func
(paren
op_amp
id|cleanup_timer
)paren
suffix:semicolon
id|cleanup_timer.function
op_assign
id|z90crypt_cleanup_task
suffix:semicolon
id|cleanup_timer.data
op_assign
l_int|0
suffix:semicolon
id|cleanup_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|CLEANUPTIME
op_star
id|HZ
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cleanup_timer
)paren
suffix:semicolon
multiline_comment|/* Set up the proc file system */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;driver/z90crypt&quot;
comma
l_int|0644
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
)paren
(brace
id|entry-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|entry-&gt;data
op_assign
l_int|0
suffix:semicolon
id|entry-&gt;read_proc
op_assign
id|z90crypt_status
suffix:semicolon
id|entry-&gt;write_proc
op_assign
id|z90crypt_status_write
suffix:semicolon
)brace
r_else
id|PRINTK
c_func
(paren
l_string|&quot;Couldn&squot;t create z90crypt proc entry&bslash;n&quot;
)paren
suffix:semicolon
id|z90crypt_entry
op_assign
id|entry
suffix:semicolon
multiline_comment|/* Set up the configuration task. */
id|init_timer
c_func
(paren
op_amp
id|config_timer
)paren
suffix:semicolon
id|config_timer.function
op_assign
id|z90crypt_config_task
suffix:semicolon
id|config_timer.data
op_assign
l_int|0
suffix:semicolon
id|config_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|INITIAL_CONFIGTIME
op_star
id|HZ
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|config_timer
)paren
suffix:semicolon
multiline_comment|/* Set up the reader task */
id|tasklet_init
c_func
(paren
op_amp
id|reader_tasklet
comma
id|z90crypt_reader_task
comma
l_int|0
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|reader_timer
)paren
suffix:semicolon
id|reader_timer.function
op_assign
id|z90crypt_schedule_reader_task
suffix:semicolon
id|reader_timer.data
op_assign
l_int|0
suffix:semicolon
id|reader_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|READERTIME
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|reader_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|z90_register_ioctl32s
c_func
(paren
)paren
)paren
)paren
r_goto
id|init_module_cleanup
suffix:semicolon
r_return
l_int|0
suffix:semicolon
singleline_comment|// success
id|init_module_cleanup
suffix:colon
id|z90_unregister_ioctl32s
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifndef Z90CRYPT_USE_HOTPLUG
r_if
c_cond
(paren
(paren
id|nresult
op_assign
id|misc_deregister
c_func
(paren
op_amp
id|z90crypt_misc_device
)paren
)paren
)paren
id|PRINTK
c_func
(paren
l_string|&quot;misc_deregister failed with %d.&bslash;n&quot;
comma
id|nresult
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_string|&quot;misc_deregister successful.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
(paren
id|nresult
op_assign
id|unregister_chrdev
c_func
(paren
id|z90crypt_major
comma
id|REG_NAME
)paren
)paren
)paren
id|PRINTK
c_func
(paren
l_string|&quot;unregister_chrdev failed with %d.&bslash;n&quot;
comma
id|nresult
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_string|&quot;unregister_chrdev successful.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|result
suffix:semicolon
singleline_comment|// failure
)brace
multiline_comment|/**&n; * The module termination code&n; */
r_static
r_void
id|__exit
DECL|function|z90crypt_cleanup_module
id|z90crypt_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|nresult
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;PID %d&bslash;n&quot;
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
id|z90_unregister_ioctl32s
c_func
(paren
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;driver/z90crypt&quot;
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifndef Z90CRYPT_USE_HOTPLUG
r_if
c_cond
(paren
(paren
id|nresult
op_assign
id|misc_deregister
c_func
(paren
op_amp
id|z90crypt_misc_device
)paren
)paren
)paren
id|PRINTK
c_func
(paren
l_string|&quot;misc_deregister failed with %d.&bslash;n&quot;
comma
id|nresult
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_string|&quot;misc_deregister successful.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
id|z90crypt_hotplug_event
c_func
(paren
id|z90crypt_major
comma
l_int|0
comma
id|Z90CRYPT_HOTPLUG_REMOVE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nresult
op_assign
id|unregister_chrdev
c_func
(paren
id|z90crypt_major
comma
id|REG_NAME
)paren
)paren
)paren
id|PRINTK
c_func
(paren
l_string|&quot;unregister_chrdev failed with %d.&bslash;n&quot;
comma
id|nresult
)paren
suffix:semicolon
r_else
id|PDEBUG
c_func
(paren
l_string|&quot;unregister_chrdev successful.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Remove the tasks */
id|tasklet_kill
c_func
(paren
op_amp
id|reader_tasklet
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|reader_timer
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|config_timer
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cleanup_timer
)paren
suffix:semicolon
id|destroy_z90crypt
c_func
(paren
)paren
suffix:semicolon
id|PRINTKN
c_func
(paren
l_string|&quot;Unloaded.&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Functions running under a process id&n; *&n; * The I/O functions:&n; *     z90crypt_open&n; *     z90crypt_release&n; *     z90crypt_read&n; *     z90crypt_write&n; *     z90crypt_ioctl&n; *     z90crypt_status&n; *     z90crypt_status_write&n; *&t; disable_card&n; *&t; enable_card&n; *&t; scan_char&n; *&t; scan_string&n; *&n; * Helper functions:&n; *     z90crypt_rsa&n; *&t; z90crypt_prepare&n; *&t; z90crypt_send&n; *&t; z90crypt_process_results&n; *&n; */
r_static
r_int
DECL|function|z90crypt_open
id|z90crypt_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|priv_data
op_star
id|private_data_p
suffix:semicolon
r_if
c_cond
(paren
id|quiesce_z90crypt
)paren
r_return
op_minus
id|EQUIESCE
suffix:semicolon
id|private_data_p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|priv_data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|private_data_p
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;Memory allocate failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|private_data_p
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|priv_data
)paren
)paren
suffix:semicolon
id|private_data_p-&gt;status
op_assign
id|STAT_OPEN
suffix:semicolon
id|private_data_p-&gt;opener_pid
op_assign
id|PID
c_func
(paren
)paren
suffix:semicolon
id|filp-&gt;private_data
op_assign
id|private_data_p
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|total_open
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|z90crypt_release
id|z90crypt_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|priv_data
op_star
id|private_data_p
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;PID %d (filp %p)&bslash;n&quot;
comma
id|PID
c_func
(paren
)paren
comma
id|filp
)paren
suffix:semicolon
id|private_data_p-&gt;status
op_assign
id|STAT_CLOSED
suffix:semicolon
id|memset
c_func
(paren
id|private_data_p
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|priv_data
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|private_data_p
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|total_open
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * there are two read functions, of which compile options will choose one&n; * without USE_GET_RANDOM_BYTES&n; *   =&gt; read() always returns -EPERM;&n; * otherwise&n; *   =&gt; read() uses get_random_bytes() kernel function&n; */
macro_line|#ifndef USE_GET_RANDOM_BYTES
multiline_comment|/**&n; * z90crypt_read will not be supported beyond z90crypt 1.3.1&n; */
r_static
id|ssize_t
DECL|function|z90crypt_read
id|z90crypt_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|f_pos
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;filp %p (PID %d)&bslash;n&quot;
comma
id|filp
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
macro_line|#else 
singleline_comment|// we want to use get_random_bytes
multiline_comment|/**&n; * read() just returns a string of random bytes.  Since we have no way&n; * to generate these cryptographically, we just execute get_random_bytes&n; * for the length specified.&n; */
macro_line|#include &lt;linux/random.h&gt;
r_static
id|ssize_t
DECL|function|z90crypt_read
id|z90crypt_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|f_pos
)paren
(brace
r_int
r_char
op_star
id|temp_buff
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;filp %p (PID %d)&bslash;n&quot;
comma
id|filp
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|quiesce_z90crypt
)paren
r_return
op_minus
id|EQUIESCE
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;Requested random byte count negative: %ld&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OG
id|RESPBUFFSIZE
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;count[%d] &gt; RESPBUFFSIZE&quot;
comma
id|count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|temp_buff
op_assign
id|kmalloc
c_func
(paren
id|RESPBUFFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|temp_buff
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;Memory allocate failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|get_random_bytes
c_func
(paren
id|temp_buff
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|temp_buff
comma
id|count
)paren
op_ne
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|temp_buff
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|temp_buff
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**&n; * Write is is not allowed&n; */
r_static
id|ssize_t
DECL|function|z90crypt_write
id|z90crypt_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|f_pos
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;filp %p (PID %d)&bslash;n&quot;
comma
id|filp
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/**&n; * New status functions&n; */
r_static
r_inline
r_int
DECL|function|get_status_totalcount
id|get_status_totalcount
c_func
(paren
r_void
)paren
(brace
r_return
id|z90crypt.hdware_info-&gt;hdware_mask.st_count
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_status_PCICAcount
id|get_status_PCICAcount
c_func
(paren
r_void
)paren
(brace
r_return
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|PCICA
)braket
dot
id|st_count
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_status_PCICCcount
id|get_status_PCICCcount
c_func
(paren
r_void
)paren
(brace
r_return
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|PCICC
)braket
dot
id|st_count
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_status_PCIXCCcount
id|get_status_PCIXCCcount
c_func
(paren
r_void
)paren
(brace
r_return
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|PCIXCC
)braket
dot
id|st_count
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_status_requestq_count
id|get_status_requestq_count
c_func
(paren
r_void
)paren
(brace
r_return
id|requestq_count
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_status_pendingq_count
id|get_status_pendingq_count
c_func
(paren
r_void
)paren
(brace
r_return
id|pendingq_count
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_status_totalopen_count
id|get_status_totalopen_count
c_func
(paren
r_void
)paren
(brace
r_return
id|atomic_read
c_func
(paren
op_amp
id|total_open
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_status_domain_index
id|get_status_domain_index
c_func
(paren
r_void
)paren
(brace
r_return
id|z90crypt.cdx
suffix:semicolon
)brace
r_static
r_inline
r_int
r_char
op_star
DECL|function|get_status_status_mask
id|get_status_status_mask
c_func
(paren
r_int
r_char
id|status
(braket
id|Z90CRYPT_NUM_APS
)braket
)paren
(brace
r_int
id|i
comma
id|ix
suffix:semicolon
id|memcpy
c_func
(paren
id|status
comma
id|z90crypt.hdware_info-&gt;device_type_array
comma
id|Z90CRYPT_NUM_APS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|get_status_totalcount
c_func
(paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ix
op_assign
id|SHRT2LONG
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|LONG2DEVPTR
c_func
(paren
id|ix
)paren
op_member_access_from_pointer
id|user_disabled
)paren
id|status
(braket
id|ix
)braket
op_assign
l_int|0x0d
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
r_static
r_inline
r_int
r_char
op_star
DECL|function|get_status_qdepth_mask
id|get_status_qdepth_mask
c_func
(paren
r_int
r_char
id|qdepth
(braket
id|Z90CRYPT_NUM_APS
)braket
)paren
(brace
r_int
id|i
comma
id|ix
suffix:semicolon
id|memset
c_func
(paren
id|qdepth
comma
l_int|0
comma
id|Z90CRYPT_NUM_APS
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|get_status_totalcount
c_func
(paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ix
op_assign
id|SHRT2LONG
c_func
(paren
id|i
)paren
suffix:semicolon
id|qdepth
(braket
id|ix
)braket
op_assign
id|LONG2DEVPTR
c_func
(paren
id|ix
)paren
op_member_access_from_pointer
id|dev_caller_count
suffix:semicolon
)brace
r_return
id|qdepth
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
op_star
DECL|function|get_status_perdevice_reqcnt
id|get_status_perdevice_reqcnt
c_func
(paren
r_int
r_int
id|reqcnt
(braket
id|Z90CRYPT_NUM_APS
)braket
)paren
(brace
r_int
id|i
comma
id|ix
suffix:semicolon
id|memset
c_func
(paren
id|reqcnt
comma
l_int|0
comma
id|Z90CRYPT_NUM_APS
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|get_status_totalcount
c_func
(paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ix
op_assign
id|SHRT2LONG
c_func
(paren
id|i
)paren
suffix:semicolon
id|reqcnt
(braket
id|ix
)braket
op_assign
id|LONG2DEVPTR
c_func
(paren
id|ix
)paren
op_member_access_from_pointer
id|dev_total_req_cnt
suffix:semicolon
)brace
r_return
id|reqcnt
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|init_work_element
id|init_work_element
c_func
(paren
r_struct
id|work_element
op_star
id|we_p
comma
r_struct
id|priv_data
op_star
id|priv_data
comma
id|pid_t
id|pid
)paren
(brace
r_int
id|step
suffix:semicolon
id|we_p-&gt;requestptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|we_p
op_plus
r_sizeof
(paren
r_struct
id|work_element
)paren
suffix:semicolon
multiline_comment|/* Come up with a unique id for this caller. */
id|step
op_assign
id|atomic_inc_return
c_func
(paren
op_amp
id|z90crypt_step
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|we_p-&gt;caller_id
op_plus
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|pid
comma
r_sizeof
(paren
id|pid
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|we_p-&gt;caller_id
op_plus
l_int|4
comma
(paren
r_void
op_star
)paren
op_amp
id|step
comma
r_sizeof
(paren
id|step
)paren
)paren
suffix:semicolon
id|we_p-&gt;pid
op_assign
id|pid
suffix:semicolon
id|we_p-&gt;priv_data
op_assign
id|priv_data
suffix:semicolon
id|we_p-&gt;status
(braket
l_int|0
)braket
op_assign
id|STAT_DEFAULT
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|2
)braket
op_assign
l_int|0x00
suffix:semicolon
id|we_p-&gt;resp_buff_size
op_assign
l_int|0
suffix:semicolon
id|we_p-&gt;retcode
op_assign
l_int|0
suffix:semicolon
id|we_p-&gt;devindex
op_assign
op_minus
l_int|1
suffix:semicolon
singleline_comment|// send_to_crypto selects the device
id|we_p-&gt;devtype
op_assign
op_minus
l_int|1
suffix:semicolon
singleline_comment|// getCryptoBuffer selects the type
id|atomic_set
c_func
(paren
op_amp
id|we_p-&gt;alarmrung
comma
l_int|0
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|we_p-&gt;waitq
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
(paren
id|we_p-&gt;liste
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|allocate_work_element
id|allocate_work_element
c_func
(paren
r_struct
id|work_element
op_star
op_star
id|we_pp
comma
r_struct
id|priv_data
op_star
id|priv_data_p
comma
id|pid_t
id|pid
)paren
(brace
r_struct
id|work_element
op_star
id|we_p
suffix:semicolon
id|we_p
op_assign
(paren
r_struct
id|work_element
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|we_p
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|init_work_element
c_func
(paren
id|we_p
comma
id|priv_data_p
comma
id|pid
)paren
suffix:semicolon
op_star
id|we_pp
op_assign
id|we_p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|remove_device
id|remove_device
c_func
(paren
r_struct
id|device
op_star
id|device_p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|device_p
op_logical_or
id|device_p-&gt;disabled
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|device_p-&gt;disabled
op_assign
l_int|1
suffix:semicolon
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|device_p-&gt;dev_type
)braket
dot
id|disabled_count
op_increment
suffix:semicolon
id|z90crypt.hdware_info-&gt;hdware_mask.disabled_count
op_increment
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|select_device_type
id|select_device_type
c_func
(paren
r_int
op_star
id|dev_type_p
)paren
(brace
r_struct
id|status
op_star
id|stat
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|dev_type_p
op_ne
id|PCICC
)paren
op_logical_and
(paren
op_star
id|dev_type_p
op_ne
id|PCICA
)paren
op_logical_and
(paren
op_star
id|dev_type_p
op_ne
id|PCIXCC
)paren
op_logical_and
(paren
op_star
id|dev_type_p
op_ne
id|ANYDEV
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|dev_type_p
op_ne
id|ANYDEV
)paren
(brace
id|stat
op_assign
op_amp
id|z90crypt.hdware_info-&gt;type_mask
(braket
op_star
id|dev_type_p
)braket
suffix:semicolon
r_if
c_cond
(paren
id|stat-&gt;st_count
OG
id|stat-&gt;disabled_count
op_plus
id|stat-&gt;user_disabled_count
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|stat
op_assign
op_amp
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|PCICA
)braket
suffix:semicolon
r_if
c_cond
(paren
id|stat-&gt;st_count
OG
id|stat-&gt;disabled_count
op_plus
id|stat-&gt;user_disabled_count
)paren
(brace
op_star
id|dev_type_p
op_assign
id|PCICA
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|stat
op_assign
op_amp
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|PCIXCC
)braket
suffix:semicolon
r_if
c_cond
(paren
id|stat-&gt;st_count
OG
id|stat-&gt;disabled_count
op_plus
id|stat-&gt;user_disabled_count
)paren
(brace
op_star
id|dev_type_p
op_assign
id|PCIXCC
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|stat
op_assign
op_amp
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|PCICC
)braket
suffix:semicolon
r_if
c_cond
(paren
id|stat-&gt;st_count
OG
id|stat-&gt;disabled_count
op_plus
id|stat-&gt;user_disabled_count
)paren
(brace
op_star
id|dev_type_p
op_assign
id|PCICC
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * Try the selected number, then the selected type (can be ANYDEV)&n; */
r_static
r_inline
r_int
DECL|function|select_device
id|select_device
c_func
(paren
r_int
op_star
id|dev_type_p
comma
r_int
op_star
id|device_nr_p
)paren
(brace
r_int
id|i
comma
id|indx
comma
id|devTp
comma
id|low_count
comma
id|low_indx
suffix:semicolon
r_struct
id|device_x
op_star
id|index_p
suffix:semicolon
r_struct
id|device
op_star
id|dev_ptr
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;device type = %d, index = %d&bslash;n&quot;
comma
op_star
id|dev_type_p
comma
op_star
id|device_nr_p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|device_nr_p
op_ge
l_int|0
)paren
op_logical_and
(paren
op_star
id|device_nr_p
OL
id|Z90CRYPT_NUM_DEVS
)paren
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;trying index = %d&bslash;n&quot;
comma
op_star
id|device_nr_p
)paren
suffix:semicolon
id|dev_ptr
op_assign
id|z90crypt.device_p
(braket
op_star
id|device_nr_p
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev_ptr
op_logical_and
id|dev_ptr-&gt;dev_stat
op_ne
id|DEV_GONE
op_logical_and
id|dev_ptr-&gt;disabled
op_eq
l_int|0
op_logical_and
id|dev_ptr-&gt;user_disabled
op_eq
l_int|0
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;selected by number, index = %d&bslash;n&quot;
comma
op_star
id|device_nr_p
)paren
suffix:semicolon
op_star
id|dev_type_p
op_assign
id|dev_ptr-&gt;dev_type
suffix:semicolon
r_return
op_star
id|device_nr_p
suffix:semicolon
)brace
)brace
op_star
id|device_nr_p
op_assign
op_minus
l_int|1
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;trying type = %d&bslash;n&quot;
comma
op_star
id|dev_type_p
)paren
suffix:semicolon
id|devTp
op_assign
op_star
id|dev_type_p
suffix:semicolon
r_if
c_cond
(paren
id|select_device_type
c_func
(paren
op_amp
id|devTp
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;failed to select by type&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_string|&quot;selected type = %d&bslash;n&quot;
comma
id|devTp
)paren
suffix:semicolon
id|index_p
op_assign
op_amp
id|z90crypt.hdware_info-&gt;type_x_addr
(braket
id|devTp
)braket
suffix:semicolon
id|low_count
op_assign
l_int|0x0000FFFF
suffix:semicolon
id|low_indx
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|devTp
)braket
dot
id|st_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|indx
op_assign
id|index_p-&gt;device_index
(braket
id|i
)braket
suffix:semicolon
id|dev_ptr
op_assign
id|z90crypt.device_p
(braket
id|indx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev_ptr
op_logical_and
id|dev_ptr-&gt;dev_stat
op_ne
id|DEV_GONE
op_logical_and
id|dev_ptr-&gt;disabled
op_eq
l_int|0
op_logical_and
id|dev_ptr-&gt;user_disabled
op_eq
l_int|0
op_logical_and
id|devTp
op_eq
id|dev_ptr-&gt;dev_type
op_logical_and
id|low_count
OG
id|dev_ptr-&gt;dev_caller_count
)paren
(brace
id|low_count
op_assign
id|dev_ptr-&gt;dev_caller_count
suffix:semicolon
id|low_indx
op_assign
id|indx
suffix:semicolon
)brace
)brace
op_star
id|device_nr_p
op_assign
id|low_indx
suffix:semicolon
r_return
id|low_indx
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|send_to_crypto_device
id|send_to_crypto_device
c_func
(paren
r_struct
id|work_element
op_star
id|we_p
)paren
(brace
r_struct
id|caller
op_star
id|caller_p
suffix:semicolon
r_struct
id|device
op_star
id|device_p
suffix:semicolon
r_int
id|dev_nr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|we_p-&gt;requestptr
)paren
r_return
id|SEN_FATAL_ERROR
suffix:semicolon
id|caller_p
op_assign
(paren
r_struct
id|caller
op_star
)paren
id|we_p-&gt;requestptr
suffix:semicolon
id|dev_nr
op_assign
id|we_p-&gt;devindex
suffix:semicolon
r_if
c_cond
(paren
id|select_device
c_func
(paren
op_amp
id|we_p-&gt;devtype
comma
op_amp
id|dev_nr
)paren
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|z90crypt.hdware_info-&gt;hdware_mask.st_count
op_ne
l_int|0
)paren
r_return
id|SEN_RETRY
suffix:semicolon
r_else
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
)brace
id|we_p-&gt;devindex
op_assign
id|dev_nr
suffix:semicolon
id|device_p
op_assign
id|z90crypt.device_p
(braket
id|dev_nr
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device_p
)paren
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
r_if
c_cond
(paren
id|device_p-&gt;dev_type
op_ne
id|we_p-&gt;devtype
)paren
r_return
id|SEN_RETRY
suffix:semicolon
r_if
c_cond
(paren
id|device_p-&gt;dev_caller_count
op_ge
id|device_p-&gt;dev_q_depth
)paren
r_return
id|SEN_QUEUE_FULL
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;device number prior to send: %d&bslash;n&quot;
comma
id|dev_nr
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|send_to_AP
c_func
(paren
id|dev_nr
comma
id|z90crypt.cdx
comma
id|caller_p-&gt;caller_dev_dep_req_l
comma
id|caller_p-&gt;caller_dev_dep_req_p
)paren
)paren
(brace
r_case
id|DEV_SEN_EXCEPTION
suffix:colon
id|PRINTKC
c_func
(paren
l_string|&quot;Exception during send to device %d&bslash;n&quot;
comma
id|dev_nr
)paren
suffix:semicolon
id|z90crypt.terminating
op_assign
l_int|1
suffix:semicolon
r_return
id|SEN_FATAL_ERROR
suffix:semicolon
r_case
id|DEV_GONE
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;Device %d not available&bslash;n&quot;
comma
id|dev_nr
)paren
suffix:semicolon
id|remove_device
c_func
(paren
id|device_p
)paren
suffix:semicolon
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
r_case
id|DEV_EMPTY
suffix:colon
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
r_case
id|DEV_NO_WORK
suffix:colon
r_return
id|SEN_FATAL_ERROR
suffix:semicolon
r_case
id|DEV_BAD_MESSAGE
suffix:colon
r_return
id|SEN_USER_ERROR
suffix:semicolon
r_case
id|DEV_QUEUE_FULL
suffix:colon
r_return
id|SEN_QUEUE_FULL
suffix:semicolon
r_default
suffix:colon
r_case
id|DEV_ONLINE
suffix:colon
r_break
suffix:semicolon
)brace
id|list_add_tail
c_func
(paren
op_amp
(paren
id|caller_p-&gt;caller_liste
)paren
comma
op_amp
(paren
id|device_p-&gt;dev_caller_list
)paren
)paren
suffix:semicolon
id|device_p-&gt;dev_caller_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Send puts the user&squot;s work on one of two queues:&n; *   the pending queue if the send was successful&n; *   the request queue if the send failed because device full or busy&n; */
r_static
r_inline
r_int
DECL|function|z90crypt_send
id|z90crypt_send
c_func
(paren
r_struct
id|work_element
op_star
id|we_p
comma
r_const
r_char
op_star
id|buf
)paren
(brace
r_int
id|rv
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;PID %d&bslash;n&quot;
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CHK_RDWRMASK
c_func
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
)paren
op_ne
id|STAT_NOWORK
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;PID %d tried to send more work but has outstanding &quot;
l_string|&quot;work.&bslash;n&quot;
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EWORKPEND
suffix:semicolon
)brace
id|we_p-&gt;devindex
op_assign
op_minus
l_int|1
suffix:semicolon
singleline_comment|// Reset device number
id|spin_lock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
id|rv
op_assign
id|send_to_crypto_device
c_func
(paren
id|we_p
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rv
)paren
(brace
r_case
l_int|0
suffix:colon
id|we_p-&gt;requestsent
op_assign
id|jiffies
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_SENT
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|we_p-&gt;liste
comma
op_amp
id|pending_list
)paren
suffix:semicolon
op_increment
id|pendingq_count
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_PENDING
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_BUSY
suffix:colon
r_case
id|SEN_QUEUE_FULL
suffix:colon
id|rv
op_assign
l_int|0
suffix:semicolon
id|we_p-&gt;devindex
op_assign
op_minus
l_int|1
suffix:semicolon
singleline_comment|// any device will do
id|we_p-&gt;requestsent
op_assign
id|jiffies
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|we_p-&gt;liste
comma
op_amp
id|request_list
)paren
suffix:semicolon
op_increment
id|requestq_count
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_REQUEST
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_RETRY
suffix:colon
id|rv
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_NOT_AVAIL
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;*** No devices available.&bslash;n&quot;
)paren
suffix:semicolon
id|rv
op_assign
id|we_p-&gt;retcode
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|we_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REC_OPERAND_INV
suffix:colon
r_case
id|REC_OPERAND_SIZE
suffix:colon
r_case
id|REC_EVEN_MOD
suffix:colon
r_case
id|REC_INVALID_PAD
suffix:colon
id|rv
op_assign
id|we_p-&gt;retcode
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|we_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|we_p-&gt;retcode
op_assign
id|rv
suffix:semicolon
id|we_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rv
op_ne
op_minus
id|ERESTARTSYS
)paren
id|SET_RDWRMASK
c_func
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
comma
id|STAT_WRITTEN
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
op_eq
l_int|0
)paren
id|tasklet_schedule
c_func
(paren
op_amp
id|reader_tasklet
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
multiline_comment|/**&n; * process_results copies the user&squot;s work from kernel space.&n; */
r_static
r_inline
r_int
DECL|function|z90crypt_process_results
id|z90crypt_process_results
c_func
(paren
r_struct
id|work_element
op_star
id|we_p
comma
r_char
op_star
id|buf
)paren
(brace
r_int
id|rv
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;we_p %p (PID %d)&bslash;n&quot;
comma
id|we_p
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
id|LONG2DEVPTR
c_func
(paren
id|we_p-&gt;devindex
)paren
op_member_access_from_pointer
id|dev_total_req_cnt
op_increment
suffix:semicolon
id|SET_RDWRMASK
c_func
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
comma
id|STAT_READPEND
)paren
suffix:semicolon
id|rv
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|we_p-&gt;buffer
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;we_p %p PID %d in STAT_READPEND: buffer NULL.&bslash;n&quot;
comma
id|we_p
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
id|rv
op_assign
op_minus
id|ENOBUFF
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rv
)paren
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|we_p-&gt;buffer
comma
id|we_p-&gt;buff_size
)paren
)paren
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;copy_to_user failed: rv = %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
id|rv
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rv
)paren
id|rv
op_assign
id|we_p-&gt;retcode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rv
)paren
r_if
c_cond
(paren
id|we_p-&gt;resp_buff_size
op_logical_and
id|copy_to_user
c_func
(paren
id|we_p-&gt;resp_addr
comma
id|we_p-&gt;resp_buff
comma
id|we_p-&gt;resp_buff_size
)paren
)paren
id|rv
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|SET_RDWRMASK
c_func
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
comma
id|STAT_NOWORK
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
DECL|variable|NULL_psmid
r_static
r_int
r_char
id|NULL_psmid
(braket
l_int|8
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
multiline_comment|/**&n; * MIN_MOD_SIZE is a PCICC and PCIXCC limit.&n; * MAX_PCICC_MOD_SIZE is a hard limit for the PCICC.&n; * MAX_MOD_SIZE is a hard limit for the PCIXCC and PCICA.&n; */
DECL|macro|MIN_MOD_SIZE
mdefine_line|#define MIN_MOD_SIZE 64
DECL|macro|MAX_PCICC_MOD_SIZE
mdefine_line|#define MAX_PCICC_MOD_SIZE 128
DECL|macro|MAX_MOD_SIZE
mdefine_line|#define MAX_MOD_SIZE 256
multiline_comment|/**&n; * Used in device configuration functions&n; */
DECL|macro|MAX_RESET
mdefine_line|#define MAX_RESET 90
multiline_comment|/**&n; * This is used only for PCICC support&n; */
r_static
r_inline
r_int
DECL|function|is_PKCS11_padded
id|is_PKCS11_padded
c_func
(paren
r_int
r_char
op_star
id|buffer
comma
r_int
id|length
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|0
)braket
op_ne
l_int|0x00
)paren
op_logical_or
(paren
id|buffer
(braket
l_int|1
)braket
op_ne
l_int|0x01
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_ne
l_int|0xFF
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|10
)paren
op_logical_or
(paren
id|i
op_eq
id|length
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_ne
l_int|0x00
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * This is used only for PCICC support&n; */
r_static
r_inline
r_int
DECL|function|is_PKCS12_padded
id|is_PKCS12_padded
c_func
(paren
r_int
r_char
op_star
id|buffer
comma
r_int
id|length
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buffer
(braket
l_int|0
)braket
op_ne
l_int|0x00
)paren
op_logical_or
(paren
id|buffer
(braket
l_int|1
)braket
op_ne
l_int|0x02
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|2
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_eq
l_int|0x00
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
OL
l_int|10
)paren
op_logical_or
(paren
id|i
op_eq
id|length
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|buffer
(braket
id|i
)braket
op_ne
l_int|0x00
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * builds struct caller and converts message from generic format to&n; * device-dependent format&n; * func is ICARSAMODEXPO or ICARSACRT&n; * function is PCI_FUNC_KEY_ENCRYPT or PCI_FUNC_KEY_DECRYPT&n; */
r_static
r_inline
r_int
DECL|function|build_caller
id|build_caller
c_func
(paren
r_struct
id|work_element
op_star
id|we_p
comma
r_int
id|function
)paren
(brace
r_int
id|rv
suffix:semicolon
r_struct
id|caller
op_star
id|caller_p
op_assign
(paren
r_struct
id|caller
op_star
)paren
id|we_p-&gt;requestptr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|we_p-&gt;devtype
op_ne
id|PCICC
)paren
op_logical_and
(paren
id|we_p-&gt;devtype
op_ne
id|PCICA
)paren
op_logical_and
(paren
id|we_p-&gt;devtype
op_ne
id|PCIXCC
)paren
)paren
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
id|memcpy
c_func
(paren
id|caller_p-&gt;caller_id
comma
id|we_p-&gt;caller_id
comma
r_sizeof
(paren
id|caller_p-&gt;caller_id
)paren
)paren
suffix:semicolon
id|caller_p-&gt;caller_dev_dep_req_p
op_assign
id|caller_p-&gt;caller_dev_dep_req
suffix:semicolon
id|caller_p-&gt;caller_dev_dep_req_l
op_assign
id|MAX_RESPONSE_SIZE
suffix:semicolon
id|caller_p-&gt;caller_buf_p
op_assign
id|we_p-&gt;buffer
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
(paren
id|caller_p-&gt;caller_liste
)paren
)paren
suffix:semicolon
id|rv
op_assign
id|convert_request
c_func
(paren
id|we_p-&gt;buffer
comma
id|we_p-&gt;funccode
comma
id|function
comma
id|z90crypt.cdx
comma
id|we_p-&gt;devtype
comma
op_amp
id|caller_p-&gt;caller_dev_dep_req_l
comma
id|caller_p-&gt;caller_dev_dep_req_p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
r_if
c_cond
(paren
id|rv
op_eq
id|SEN_NOT_AVAIL
)paren
id|PDEBUG
c_func
(paren
l_string|&quot;request can&squot;t be processed on hdwr avail&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|PRINTK
c_func
(paren
l_string|&quot;Error from convert_request: %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
op_amp
(paren
id|caller_p-&gt;caller_dev_dep_req_p
(braket
l_int|4
)braket
)paren
comma
id|we_p-&gt;caller_id
comma
l_int|8
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|unbuild_caller
id|unbuild_caller
c_func
(paren
r_struct
id|device
op_star
id|device_p
comma
r_struct
id|caller
op_star
id|caller_p
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|caller_p
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|caller_p-&gt;caller_liste.next
op_logical_and
id|caller_p-&gt;caller_liste.prev
)paren
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|caller_p-&gt;caller_liste
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|caller_p-&gt;caller_liste
)paren
suffix:semicolon
id|device_p-&gt;dev_caller_count
op_decrement
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|caller_p-&gt;caller_liste
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|caller_p-&gt;caller_id
comma
l_int|0
comma
r_sizeof
(paren
id|caller_p-&gt;caller_id
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_crypto_request_buffer
id|get_crypto_request_buffer
c_func
(paren
r_struct
id|work_element
op_star
id|we_p
)paren
(brace
r_struct
id|ica_rsa_modexpo
op_star
id|mex_p
suffix:semicolon
r_struct
id|ica_rsa_modexpo_crt
op_star
id|crt_p
suffix:semicolon
r_int
r_char
op_star
id|temp_buffer
suffix:semicolon
r_int
id|function
suffix:semicolon
r_int
id|rv
suffix:semicolon
id|mex_p
op_assign
(paren
r_struct
id|ica_rsa_modexpo
op_star
)paren
id|we_p-&gt;buffer
suffix:semicolon
id|crt_p
op_assign
(paren
r_struct
id|ica_rsa_modexpo_crt
op_star
)paren
id|we_p-&gt;buffer
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;device type input = %d&bslash;n&quot;
comma
id|we_p-&gt;devtype
)paren
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.terminating
)paren
r_return
id|REC_NO_RESPONSE
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|we_p-&gt;caller_id
comma
id|NULL_psmid
comma
l_int|8
)paren
op_eq
l_int|0
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;psmid zeroes&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SEN_FATAL_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|we_p-&gt;buffer
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;buffer pointer NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SEN_USER_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|we_p-&gt;requestptr
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;caller pointer NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SEN_USER_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|we_p-&gt;devtype
op_ne
id|PCICA
)paren
op_logical_and
(paren
id|we_p-&gt;devtype
op_ne
id|PCICC
)paren
op_logical_and
(paren
id|we_p-&gt;devtype
op_ne
id|PCIXCC
)paren
op_logical_and
(paren
id|we_p-&gt;devtype
op_ne
id|ANYDEV
)paren
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;invalid device type&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|SEN_USER_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mex_p-&gt;inputdatalength
OL
l_int|1
)paren
op_logical_or
(paren
id|mex_p-&gt;inputdatalength
OG
id|MAX_MOD_SIZE
)paren
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;inputdatalength[%d] is not valid&bslash;n&quot;
comma
id|mex_p-&gt;inputdatalength
)paren
suffix:semicolon
r_return
id|SEN_USER_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mex_p-&gt;outputdatalength
OL
id|mex_p-&gt;inputdatalength
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;outputdatalength[%d] &lt; inputdatalength[%d]&bslash;n&quot;
comma
id|mex_p-&gt;outputdatalength
comma
id|mex_p-&gt;inputdatalength
)paren
suffix:semicolon
r_return
id|SEN_USER_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mex_p-&gt;inputdata
op_logical_or
op_logical_neg
id|mex_p-&gt;outputdata
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;inputdata[%p] or outputdata[%p] is NULL&bslash;n&quot;
comma
id|mex_p-&gt;outputdata
comma
id|mex_p-&gt;inputdata
)paren
suffix:semicolon
r_return
id|SEN_USER_ERROR
suffix:semicolon
)brace
multiline_comment|/**&n;&t; * As long as outputdatalength is big enough, we can set the&n;&t; * outputdatalength equal to the inputdatalength, since that is the&n;&t; * number of bytes we will copy in any case&n;&t; */
id|mex_p-&gt;outputdatalength
op_assign
id|mex_p-&gt;inputdatalength
suffix:semicolon
id|rv
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|we_p-&gt;funccode
)paren
(brace
r_case
id|ICARSAMODEXPO
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|mex_p-&gt;b_key
op_logical_or
op_logical_neg
id|mex_p-&gt;n_modulus
)paren
id|rv
op_assign
id|SEN_USER_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICARSACRT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|IS_EVEN
c_func
(paren
id|crt_p-&gt;inputdatalength
)paren
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;inputdatalength[%d] is odd, CRT form&bslash;n&quot;
comma
id|crt_p-&gt;inputdatalength
)paren
suffix:semicolon
id|rv
op_assign
id|SEN_USER_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|crt_p-&gt;bp_key
op_logical_or
op_logical_neg
id|crt_p-&gt;bq_key
op_logical_or
op_logical_neg
id|crt_p-&gt;np_prime
op_logical_or
op_logical_neg
id|crt_p-&gt;nq_prime
op_logical_or
op_logical_neg
id|crt_p-&gt;u_mult_inv
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;CRT form, bad data: %p/%p/%p/%p/%p&bslash;n&quot;
comma
id|crt_p-&gt;bp_key
comma
id|crt_p-&gt;bq_key
comma
id|crt_p-&gt;np_prime
comma
id|crt_p-&gt;nq_prime
comma
id|crt_p-&gt;u_mult_inv
)paren
suffix:semicolon
id|rv
op_assign
id|SEN_USER_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;bad func = %d&bslash;n&quot;
comma
id|we_p-&gt;funccode
)paren
suffix:semicolon
id|rv
op_assign
id|SEN_USER_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rv
op_ne
l_int|0
)paren
r_return
id|rv
suffix:semicolon
r_if
c_cond
(paren
id|select_device_type
c_func
(paren
op_amp
id|we_p-&gt;devtype
)paren
OL
l_int|0
)paren
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
id|temp_buffer
op_assign
(paren
r_int
r_char
op_star
)paren
id|we_p
op_plus
r_sizeof
(paren
r_struct
id|work_element
)paren
op_plus
r_sizeof
(paren
r_struct
id|caller
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|temp_buffer
comma
id|mex_p-&gt;inputdata
comma
id|mex_p-&gt;inputdatalength
)paren
op_ne
l_int|0
)paren
r_return
id|SEN_RELEASED
suffix:semicolon
id|function
op_assign
id|PCI_FUNC_KEY_ENCRYPT
suffix:semicolon
r_switch
c_cond
(paren
id|we_p-&gt;devtype
)paren
(brace
multiline_comment|/* PCICA does everything with a simple RSA mod-expo operation */
r_case
id|PCICA
suffix:colon
id|function
op_assign
id|PCI_FUNC_KEY_ENCRYPT
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/**&n;&t; * PCIXCC does all Mod-Expo form with a simple RSA mod-expo&n;&t; * operation, and all CRT forms with a PKCS-1.2 format decrypt.&n;&t; */
r_case
id|PCIXCC
suffix:colon
multiline_comment|/* Anything less than MIN_MOD_SIZE MUST go to a PCICA */
r_if
c_cond
(paren
id|mex_p-&gt;inputdatalength
OL
id|MIN_MOD_SIZE
)paren
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
r_if
c_cond
(paren
id|we_p-&gt;funccode
op_eq
id|ICARSAMODEXPO
)paren
id|function
op_assign
id|PCI_FUNC_KEY_ENCRYPT
suffix:semicolon
r_else
id|function
op_assign
id|PCI_FUNC_KEY_DECRYPT
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/**&n;&t; * PCICC does everything as a PKCS-1.2 format request&n;&t; */
r_case
id|PCICC
suffix:colon
multiline_comment|/* Anything less than MIN_MOD_SIZE MUST go to a PCICA */
r_if
c_cond
(paren
id|mex_p-&gt;inputdatalength
OL
id|MIN_MOD_SIZE
)paren
(brace
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
)brace
multiline_comment|/* Anythings over MAX_PCICC_MOD_SIZE MUST go to a PCICA */
r_if
c_cond
(paren
id|mex_p-&gt;inputdatalength
OG
id|MAX_PCICC_MOD_SIZE
)paren
(brace
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
)brace
multiline_comment|/* PCICC cannot handle input that is is PKCS#1.1 padded */
r_if
c_cond
(paren
id|is_PKCS11_padded
c_func
(paren
id|temp_buffer
comma
id|mex_p-&gt;inputdatalength
)paren
)paren
(brace
r_return
id|SEN_NOT_AVAIL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|we_p-&gt;funccode
op_eq
id|ICARSAMODEXPO
)paren
(brace
r_if
c_cond
(paren
id|is_PKCS12_padded
c_func
(paren
id|temp_buffer
comma
id|mex_p-&gt;inputdatalength
)paren
)paren
id|function
op_assign
id|PCI_FUNC_KEY_ENCRYPT
suffix:semicolon
r_else
id|function
op_assign
id|PCI_FUNC_KEY_DECRYPT
suffix:semicolon
)brace
r_else
multiline_comment|/* all CRT forms are decrypts */
id|function
op_assign
id|PCI_FUNC_KEY_DECRYPT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_string|&quot;function: %04x&bslash;n&quot;
comma
id|function
)paren
suffix:semicolon
id|rv
op_assign
id|build_caller
c_func
(paren
id|we_p
comma
id|function
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;rv from build_caller = %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|z90crypt_prepare
id|z90crypt_prepare
c_func
(paren
r_struct
id|work_element
op_star
id|we_p
comma
r_int
r_int
id|funccode
comma
r_const
r_char
op_star
id|buffer
)paren
(brace
r_int
id|rv
suffix:semicolon
id|we_p-&gt;devindex
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|funccode
op_eq
id|ICARSAMODEXPO
)paren
id|we_p-&gt;buff_size
op_assign
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo
)paren
suffix:semicolon
r_else
id|we_p-&gt;buff_size
op_assign
r_sizeof
(paren
r_struct
id|ica_rsa_modexpo_crt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|we_p-&gt;buffer
comma
id|buffer
comma
id|we_p-&gt;buff_size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_COPYFROM
suffix:semicolon
id|SET_RDWRMASK
c_func
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
comma
id|STAT_WRITTEN
)paren
suffix:semicolon
id|we_p-&gt;funccode
op_assign
id|funccode
suffix:semicolon
id|we_p-&gt;devtype
op_assign
op_minus
l_int|1
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_BUFFREQ
suffix:semicolon
id|rv
op_assign
id|get_crypto_request_buffer
c_func
(paren
id|we_p
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rv
)paren
(brace
r_case
l_int|0
suffix:colon
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_BUFFGOT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_USER_ERROR
suffix:colon
id|rv
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_QUEUE_FULL
suffix:colon
id|rv
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_RELEASED
suffix:colon
id|rv
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REC_NO_RESPONSE
suffix:colon
id|rv
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_NOT_AVAIL
suffix:colon
id|rv
op_assign
op_minus
id|EGETBUFF
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;rv = %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
id|rv
op_assign
op_minus
id|EGETBUFF
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CHK_RDWRMASK
c_func
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
)paren
op_eq
id|STAT_WRITTEN
)paren
id|SET_RDWRMASK
c_func
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
comma
id|STAT_DEFAULT
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|purge_work_element
id|purge_work_element
c_func
(paren
r_struct
id|work_element
op_star
id|we_p
)paren
(brace
r_struct
id|list_head
op_star
id|lptr
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|lptr
comma
op_amp
id|request_list
)paren
(brace
r_if
c_cond
(paren
id|lptr
op_eq
op_amp
id|we_p-&gt;liste
)paren
(brace
id|list_del
c_func
(paren
id|lptr
)paren
suffix:semicolon
id|requestq_count
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|list_for_each
c_func
(paren
id|lptr
comma
op_amp
id|pending_list
)paren
(brace
r_if
c_cond
(paren
id|lptr
op_eq
op_amp
id|we_p-&gt;liste
)paren
(brace
id|list_del
c_func
(paren
id|lptr
)paren
suffix:semicolon
id|pendingq_count
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Build the request and send it.&n; */
r_static
r_inline
r_int
DECL|function|z90crypt_rsa
id|z90crypt_rsa
c_func
(paren
r_struct
id|priv_data
op_star
id|private_data_p
comma
id|pid_t
id|pid
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|work_element
op_star
id|we_p
suffix:semicolon
r_int
id|rv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|allocate_work_element
c_func
(paren
op_amp
id|we_p
comma
id|private_data_p
comma
id|pid
)paren
)paren
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;PID %d: allocate_work_element returned ENOMEM&bslash;n&quot;
comma
id|pid
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|z90crypt_prepare
c_func
(paren
id|we_p
comma
id|cmd
comma
(paren
r_const
r_char
op_star
)paren
id|arg
)paren
)paren
)paren
id|PDEBUG
c_func
(paren
l_string|&quot;PID %d: rv = %d from z90crypt_prepare&bslash;n&quot;
comma
id|pid
comma
id|rv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rv
)paren
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|z90crypt_send
c_func
(paren
id|we_p
comma
(paren
r_const
r_char
op_star
)paren
id|arg
)paren
)paren
)paren
id|PDEBUG
c_func
(paren
l_string|&quot;PID %d: rv %d from z90crypt_send.&bslash;n&quot;
comma
id|pid
comma
id|rv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rv
)paren
(brace
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_ASLEEP
suffix:semicolon
id|wait_event
c_func
(paren
id|we_p-&gt;waitq
comma
id|atomic_read
c_func
(paren
op_amp
id|we_p-&gt;alarmrung
)paren
)paren
suffix:semicolon
id|we_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_AWAKE
suffix:semicolon
id|rv
op_assign
id|we_p-&gt;retcode
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rv
)paren
id|rv
op_assign
id|z90crypt_process_results
c_func
(paren
id|we_p
comma
(paren
r_char
op_star
)paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
op_amp
id|STAT_FAILED
)paren
)paren
(brace
r_switch
c_cond
(paren
id|rv
)paren
(brace
multiline_comment|/**&n;&t;&t; * EINVAL *after* receive is almost always padding&n;&t;&t; * error issued by a PCICC or PCIXCC. We convert this&n;&t;&t; * return value to -EGETBUFF which should trigger a&n;&t;&t; * fallback to software.&n;&t;&t; */
r_case
op_minus
id|EINVAL
suffix:colon
r_if
c_cond
(paren
(paren
id|we_p-&gt;devtype
op_eq
id|PCICC
)paren
op_logical_or
(paren
id|we_p-&gt;devtype
op_eq
id|PCIXCC
)paren
)paren
id|rv
op_assign
op_minus
id|EGETBUFF
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ETIMEOUT
suffix:colon
r_if
c_cond
(paren
id|z90crypt.mask.st_count
OG
l_int|0
)paren
id|rv
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
singleline_comment|// retry with another
r_else
id|rv
op_assign
op_minus
id|ENODEV
suffix:semicolon
singleline_comment|// no cards left
multiline_comment|/* fall through to clean up request queue */
r_case
op_minus
id|ERESTARTSYS
suffix:colon
r_case
op_minus
id|ERELEASED
suffix:colon
r_switch
c_cond
(paren
id|CHK_RDWRMASK
c_func
(paren
id|we_p-&gt;status
(braket
l_int|0
)braket
)paren
)paren
(brace
r_case
id|STAT_WRITTEN
suffix:colon
id|purge_work_element
c_func
(paren
id|we_p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STAT_READPEND
suffix:colon
r_case
id|STAT_NOWORK
suffix:colon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|we_p-&gt;status
(braket
l_int|0
)braket
op_xor_assign
id|STAT_FAILED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|free_page
c_func
(paren
(paren
r_int
)paren
id|we_p
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
multiline_comment|/**&n; * This function is a little long, but it&squot;s really just one large switch&n; * statement.&n; */
r_static
r_int
DECL|function|z90crypt_ioctl
id|z90crypt_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|priv_data
op_star
id|private_data_p
op_assign
id|filp-&gt;private_data
suffix:semicolon
r_int
r_char
op_star
id|status
suffix:semicolon
r_int
r_char
op_star
id|qdepth
suffix:semicolon
r_int
r_int
op_star
id|reqcnt
suffix:semicolon
r_struct
id|ica_z90_status
op_star
id|pstat
suffix:semicolon
r_int
id|ret
comma
id|i
comma
id|loopLim
comma
id|tempstat
suffix:semicolon
r_static
r_int
id|deprecated_msg_count
op_assign
l_int|0
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;filp %p (PID %d), cmd 0x%08X&bslash;n&quot;
comma
id|filp
comma
id|PID
c_func
(paren
)paren
comma
id|cmd
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;cmd 0x%08X: dir %s, size 0x%04X, type 0x%02X, nr 0x%02X&bslash;n&quot;
comma
id|cmd
comma
op_logical_neg
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
ques
c_cond
l_string|&quot;NO&quot;
suffix:colon
(paren
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
(paren
id|_IOC_READ
op_or
id|_IOC_WRITE
)paren
)paren
ques
c_cond
l_string|&quot;RW&quot;
suffix:colon
(paren
(paren
id|_IOC_DIR
c_func
(paren
id|cmd
)paren
op_eq
id|_IOC_READ
)paren
ques
c_cond
l_string|&quot;RD&quot;
suffix:colon
l_string|&quot;WR&quot;
)paren
)paren
comma
id|_IOC_SIZE
c_func
(paren
id|cmd
)paren
comma
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
comma
id|_IOC_NR
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|cmd
)paren
op_ne
id|Z90_IOCTL_MAGIC
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;cmd 0x%08X contains bad magic&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ICARSAMODEXPO
suffix:colon
r_case
id|ICARSACRT
suffix:colon
r_if
c_cond
(paren
id|quiesce_z90crypt
)paren
(brace
id|ret
op_assign
op_minus
id|EQUIESCE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
singleline_comment|// Default if no devices
id|loopLim
op_assign
id|z90crypt.hdware_info-&gt;hdware_mask.st_count
op_minus
(paren
id|z90crypt.hdware_info-&gt;hdware_mask.disabled_count
op_plus
id|z90crypt.hdware_info-&gt;hdware_mask.user_disabled_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|loopLim
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_assign
id|z90crypt_rsa
c_func
(paren
id|private_data_p
comma
id|PID
c_func
(paren
)paren
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
op_minus
id|ERESTARTSYS
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ERESTARTSYS
)paren
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_TOTALCOUNT
suffix:colon
id|tempstat
op_assign
id|get_status_totalcount
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|tempstat
comma
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_PCICACOUNT
suffix:colon
id|tempstat
op_assign
id|get_status_PCICAcount
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|tempstat
comma
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_PCICCCOUNT
suffix:colon
id|tempstat
op_assign
id|get_status_PCICCcount
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|tempstat
comma
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_PCIXCCCOUNT
suffix:colon
id|tempstat
op_assign
id|get_status_PCIXCCcount
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|tempstat
comma
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_REQUESTQ_COUNT
suffix:colon
id|tempstat
op_assign
id|get_status_requestq_count
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|tempstat
comma
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_PENDINGQ_COUNT
suffix:colon
id|tempstat
op_assign
id|get_status_pendingq_count
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|tempstat
comma
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_TOTALOPEN_COUNT
suffix:colon
id|tempstat
op_assign
id|get_status_totalopen_count
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|tempstat
comma
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_DOMAIN_INDEX
suffix:colon
id|tempstat
op_assign
id|get_status_domain_index
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
op_star
)paren
id|arg
comma
op_amp
id|tempstat
comma
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_STATUS_MASK
suffix:colon
id|status
op_assign
id|kmalloc
c_func
(paren
id|Z90CRYPT_NUM_APS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;kmalloc for status failed!&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|get_status_status_mask
c_func
(paren
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|status
comma
id|Z90CRYPT_NUM_APS
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|kfree
c_func
(paren
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_QDEPTH_MASK
suffix:colon
id|qdepth
op_assign
id|kmalloc
c_func
(paren
id|Z90CRYPT_NUM_APS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|qdepth
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;kmalloc for qdepth failed!&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|get_status_qdepth_mask
c_func
(paren
id|qdepth
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|qdepth
comma
id|Z90CRYPT_NUM_APS
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|kfree
c_func
(paren
id|qdepth
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90STAT_PERDEV_REQCNT
suffix:colon
id|reqcnt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_int
)paren
op_star
id|Z90CRYPT_NUM_APS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reqcnt
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;kmalloc for reqcnt failed!&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|get_status_perdevice_reqcnt
c_func
(paren
id|reqcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|reqcnt
comma
id|Z90CRYPT_NUM_APS
op_star
r_sizeof
(paren
r_int
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|kfree
c_func
(paren
id|reqcnt
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* THIS IS DEPRECATED.&t;USE THE NEW STATUS CALLS */
r_case
id|ICAZ90STATUS
suffix:colon
r_if
c_cond
(paren
id|deprecated_msg_count
OL
l_int|100
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;deprecated call to ioctl (ICAZ90STATUS)!&bslash;n&quot;
)paren
suffix:semicolon
id|deprecated_msg_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|deprecated_msg_count
op_eq
l_int|100
)paren
id|PRINTK
c_func
(paren
l_string|&quot;No longer issuing messages related to &quot;
l_string|&quot;deprecated call to ICAZ90STATUS.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|pstat
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ica_z90_status
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pstat
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;kmalloc for pstat failed!&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pstat-&gt;totalcount
op_assign
id|get_status_totalcount
c_func
(paren
)paren
suffix:semicolon
id|pstat-&gt;leedslitecount
op_assign
id|get_status_PCICAcount
c_func
(paren
)paren
suffix:semicolon
id|pstat-&gt;leeds2count
op_assign
id|get_status_PCICCcount
c_func
(paren
)paren
suffix:semicolon
id|pstat-&gt;requestqWaitCount
op_assign
id|get_status_requestq_count
c_func
(paren
)paren
suffix:semicolon
id|pstat-&gt;pendingqWaitCount
op_assign
id|get_status_pendingq_count
c_func
(paren
)paren
suffix:semicolon
id|pstat-&gt;totalOpenCount
op_assign
id|get_status_totalopen_count
c_func
(paren
)paren
suffix:semicolon
id|pstat-&gt;cryptoDomain
op_assign
id|get_status_domain_index
c_func
(paren
)paren
suffix:semicolon
id|get_status_status_mask
c_func
(paren
id|pstat-&gt;status
)paren
suffix:semicolon
id|get_status_qdepth_mask
c_func
(paren
id|pstat-&gt;qdepth
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_struct
id|ica_z90_status
op_star
)paren
id|arg
comma
id|pstat
comma
r_sizeof
(paren
r_struct
id|ica_z90_status
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|kfree
c_func
(paren
id|pstat
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90QUIESCE
suffix:colon
r_if
c_cond
(paren
id|current-&gt;euid
op_ne
l_int|0
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;QUIESCE fails: euid %d&bslash;n&quot;
comma
id|current-&gt;euid
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EACCES
suffix:semicolon
)brace
r_else
(brace
id|PRINTK
c_func
(paren
l_string|&quot;QUIESCE device from PID %d&bslash;n&quot;
comma
id|PID
c_func
(paren
)paren
)paren
suffix:semicolon
id|quiesce_z90crypt
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* user passed an invalid IOCTL number */
id|PDEBUG
c_func
(paren
l_string|&quot;cmd 0x%08X contains invalid ioctl code&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOTTY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|sprintcl
id|sprintcl
c_func
(paren
r_int
r_char
op_star
id|outaddr
comma
r_int
r_char
op_star
id|addr
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|hl
comma
id|i
suffix:semicolon
id|hl
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|hl
op_add_assign
id|sprintf
c_func
(paren
id|outaddr
op_plus
id|hl
comma
l_string|&quot;%01x&quot;
comma
(paren
r_int
r_int
)paren
id|addr
(braket
id|i
)braket
)paren
suffix:semicolon
id|hl
op_add_assign
id|sprintf
c_func
(paren
id|outaddr
op_plus
id|hl
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
r_return
id|hl
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|sprintrw
id|sprintrw
c_func
(paren
r_int
r_char
op_star
id|outaddr
comma
r_int
r_char
op_star
id|addr
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|hl
comma
id|inl
comma
id|c
comma
id|cx
suffix:semicolon
id|hl
op_assign
id|sprintf
c_func
(paren
id|outaddr
comma
l_string|&quot;&t;   &quot;
)paren
suffix:semicolon
id|inl
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|c
op_assign
l_int|0
suffix:semicolon
id|c
OL
(paren
id|len
op_div
l_int|16
)paren
suffix:semicolon
id|c
op_increment
)paren
(brace
id|hl
op_add_assign
id|sprintcl
c_func
(paren
id|outaddr
op_plus
id|hl
comma
id|addr
op_plus
id|inl
comma
l_int|16
)paren
suffix:semicolon
id|inl
op_add_assign
l_int|16
suffix:semicolon
)brace
id|cx
op_assign
id|len
op_mod
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|cx
)paren
(brace
id|hl
op_add_assign
id|sprintcl
c_func
(paren
id|outaddr
op_plus
id|hl
comma
id|addr
op_plus
id|inl
comma
id|cx
)paren
suffix:semicolon
id|inl
op_add_assign
id|cx
suffix:semicolon
)brace
id|hl
op_add_assign
id|sprintf
c_func
(paren
id|outaddr
op_plus
id|hl
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|hl
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|sprinthx
id|sprinthx
c_func
(paren
r_int
r_char
op_star
id|title
comma
r_int
r_char
op_star
id|outaddr
comma
r_int
r_char
op_star
id|addr
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|hl
comma
id|inl
comma
id|r
comma
id|rx
suffix:semicolon
id|hl
op_assign
id|sprintf
c_func
(paren
id|outaddr
comma
l_string|&quot;&bslash;n%s&bslash;n&quot;
comma
id|title
)paren
suffix:semicolon
id|inl
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
l_int|0
suffix:semicolon
id|r
OL
(paren
id|len
op_div
l_int|64
)paren
suffix:semicolon
id|r
op_increment
)paren
(brace
id|hl
op_add_assign
id|sprintrw
c_func
(paren
id|outaddr
op_plus
id|hl
comma
id|addr
op_plus
id|inl
comma
l_int|64
)paren
suffix:semicolon
id|inl
op_add_assign
l_int|64
suffix:semicolon
)brace
id|rx
op_assign
id|len
op_mod
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|rx
)paren
(brace
id|hl
op_add_assign
id|sprintrw
c_func
(paren
id|outaddr
op_plus
id|hl
comma
id|addr
op_plus
id|inl
comma
id|rx
)paren
suffix:semicolon
id|inl
op_add_assign
id|rx
suffix:semicolon
)brace
id|hl
op_add_assign
id|sprintf
c_func
(paren
id|outaddr
op_plus
id|hl
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|hl
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|sprinthx4
id|sprinthx4
c_func
(paren
r_int
r_char
op_star
id|title
comma
r_int
r_char
op_star
id|outaddr
comma
r_int
r_int
op_star
id|array
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|hl
comma
id|r
suffix:semicolon
id|hl
op_assign
id|sprintf
c_func
(paren
id|outaddr
comma
l_string|&quot;&bslash;n%s&bslash;n&quot;
comma
id|title
)paren
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
l_int|0
suffix:semicolon
id|r
OL
id|len
suffix:semicolon
id|r
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|r
op_mod
l_int|8
)paren
op_eq
l_int|0
)paren
id|hl
op_add_assign
id|sprintf
c_func
(paren
id|outaddr
op_plus
id|hl
comma
l_string|&quot;    &quot;
)paren
suffix:semicolon
id|hl
op_add_assign
id|sprintf
c_func
(paren
id|outaddr
op_plus
id|hl
comma
l_string|&quot;%08X &quot;
comma
id|array
(braket
id|r
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|r
op_mod
l_int|8
)paren
op_eq
l_int|7
)paren
id|hl
op_add_assign
id|sprintf
c_func
(paren
id|outaddr
op_plus
id|hl
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|hl
op_add_assign
id|sprintf
c_func
(paren
id|outaddr
op_plus
id|hl
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|hl
suffix:semicolon
)brace
r_static
r_int
DECL|function|z90crypt_status
id|z90crypt_status
c_func
(paren
r_char
op_star
id|resp_buff
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_char
op_star
id|workarea
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* resp_buff is a page. Use the right half for a work area */
id|workarea
op_assign
id|resp_buff
op_plus
l_int|2000
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;&bslash;nz90crypt version: %d.%d.%d&bslash;n&quot;
comma
id|z90crypt_VERSION
comma
id|z90crypt_RELEASE
comma
id|z90crypt_VARIANT
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;Cryptographic domain: %d&bslash;n&quot;
comma
id|get_status_domain_index
c_func
(paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;Total device count: %d&bslash;n&quot;
comma
id|get_status_totalcount
c_func
(paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;PCICA count: %d&bslash;n&quot;
comma
id|get_status_PCICAcount
c_func
(paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;PCICC count: %d&bslash;n&quot;
comma
id|get_status_PCICCcount
c_func
(paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;PCIXCC count: %d&bslash;n&quot;
comma
id|get_status_PCIXCCcount
c_func
(paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;requestq count: %d&bslash;n&quot;
comma
id|get_status_requestq_count
c_func
(paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;pendingq count: %d&bslash;n&quot;
comma
id|get_status_pendingq_count
c_func
(paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|resp_buff
op_plus
id|len
comma
l_string|&quot;Total open handles: %d&bslash;n&bslash;n&quot;
comma
id|get_status_totalopen_count
c_func
(paren
)paren
)paren
suffix:semicolon
id|len
op_add_assign
id|sprinthx
c_func
(paren
l_string|&quot;Online devices: 1 means PCICA, 2 means PCICC, 3 means PCIXCC&quot;
comma
id|resp_buff
op_plus
id|len
comma
id|get_status_status_mask
c_func
(paren
id|workarea
)paren
comma
id|Z90CRYPT_NUM_APS
)paren
suffix:semicolon
id|len
op_add_assign
id|sprinthx
c_func
(paren
l_string|&quot;Waiting work element counts&quot;
comma
id|resp_buff
op_plus
id|len
comma
id|get_status_qdepth_mask
c_func
(paren
id|workarea
)paren
comma
id|Z90CRYPT_NUM_APS
)paren
suffix:semicolon
id|len
op_add_assign
id|sprinthx4
c_func
(paren
l_string|&quot;Per-device successfully completed request counts&quot;
comma
id|resp_buff
op_plus
id|len
comma
id|get_status_perdevice_reqcnt
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|workarea
)paren
comma
id|Z90CRYPT_NUM_APS
)paren
suffix:semicolon
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|workarea
comma
l_int|0
comma
id|Z90CRYPT_NUM_APS
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|disable_card
id|disable_card
c_func
(paren
r_int
id|card_index
)paren
(brace
r_struct
id|device
op_star
id|devp
suffix:semicolon
id|devp
op_assign
id|LONG2DEVPTR
c_func
(paren
id|card_index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|devp
op_logical_or
id|devp-&gt;user_disabled
)paren
r_return
suffix:semicolon
id|devp-&gt;user_disabled
op_assign
l_int|1
suffix:semicolon
id|z90crypt.hdware_info-&gt;hdware_mask.user_disabled_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|devp-&gt;dev_type
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|devp-&gt;dev_type
)braket
dot
id|user_disabled_count
op_increment
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|enable_card
id|enable_card
c_func
(paren
r_int
id|card_index
)paren
(brace
r_struct
id|device
op_star
id|devp
suffix:semicolon
id|devp
op_assign
id|LONG2DEVPTR
c_func
(paren
id|card_index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|devp
op_logical_or
op_logical_neg
id|devp-&gt;user_disabled
)paren
r_return
suffix:semicolon
id|devp-&gt;user_disabled
op_assign
l_int|0
suffix:semicolon
id|z90crypt.hdware_info-&gt;hdware_mask.user_disabled_count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|devp-&gt;dev_type
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|devp-&gt;dev_type
)braket
dot
id|user_disabled_count
op_decrement
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|scan_char
id|scan_char
c_func
(paren
r_int
r_char
op_star
id|bf
comma
r_int
r_int
id|len
comma
r_int
r_int
op_star
id|offs
comma
r_int
r_int
op_star
id|p_eof
comma
r_int
r_char
id|c
)paren
(brace
r_int
r_int
id|i
comma
id|found
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|bf
(braket
id|i
)braket
op_eq
id|c
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bf
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
(brace
op_star
id|p_eof
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bf
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
op_star
id|offs
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|scan_string
id|scan_string
c_func
(paren
r_int
r_char
op_star
id|bf
comma
r_int
r_int
id|len
comma
r_int
r_int
op_star
id|offs
comma
r_int
r_int
op_star
id|p_eof
comma
r_int
r_char
op_star
id|s
)paren
(brace
r_int
r_int
id|temp_len
comma
id|temp_offs
comma
id|found
comma
id|eof
suffix:semicolon
id|temp_len
op_assign
id|temp_offs
op_assign
id|found
op_assign
id|eof
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|eof
op_logical_and
op_logical_neg
id|found
)paren
(brace
id|found
op_assign
id|scan_char
c_func
(paren
id|bf
op_plus
id|temp_len
comma
id|len
op_minus
id|temp_len
comma
op_amp
id|temp_offs
comma
op_amp
id|eof
comma
op_star
id|s
)paren
suffix:semicolon
id|temp_len
op_add_assign
id|temp_offs
suffix:semicolon
r_if
c_cond
(paren
id|eof
)paren
(brace
id|found
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
(brace
r_if
c_cond
(paren
id|len
op_ge
id|temp_offs
op_plus
id|strlen
c_func
(paren
id|s
)paren
)paren
(brace
id|found
op_assign
op_logical_neg
id|strncmp
c_func
(paren
id|bf
op_plus
id|temp_len
op_minus
l_int|1
comma
id|s
comma
id|strlen
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
(brace
op_star
id|offs
op_assign
id|temp_len
op_plus
id|strlen
c_func
(paren
id|s
)paren
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|found
op_assign
l_int|0
suffix:semicolon
op_star
id|p_eof
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
id|found
suffix:semicolon
)brace
r_static
r_int
DECL|function|z90crypt_status_write
id|z90crypt_status_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
comma
id|j
comma
id|len
comma
id|offs
comma
id|found
comma
id|eof
suffix:semicolon
r_int
r_char
op_star
id|lbuf
suffix:semicolon
r_int
r_int
id|local_count
suffix:semicolon
DECL|macro|LBUFSIZE
mdefine_line|#define LBUFSIZE 600
id|lbuf
op_assign
id|kmalloc
c_func
(paren
id|LBUFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lbuf
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;kmalloc failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|local_count
op_assign
id|UMIN
c_func
(paren
(paren
r_int
r_int
)paren
id|count
comma
id|LBUFSIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|lbuf
comma
id|buffer
comma
id|local_count
)paren
op_ne
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|lbuf
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|lbuf
(braket
id|local_count
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|eof
op_assign
l_int|0
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|eof
)paren
(brace
id|found
op_assign
id|scan_string
c_func
(paren
id|lbuf
op_plus
id|len
comma
id|local_count
op_minus
id|len
comma
op_amp
id|offs
comma
op_amp
id|eof
comma
l_string|&quot;Online devices&quot;
)paren
suffix:semicolon
id|len
op_add_assign
id|offs
suffix:semicolon
r_if
c_cond
(paren
id|found
op_eq
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eof
)paren
(brace
id|kfree
c_func
(paren
id|lbuf
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|found
)paren
id|found
op_assign
id|scan_char
c_func
(paren
id|lbuf
op_plus
id|len
comma
id|local_count
op_minus
id|len
comma
op_amp
id|offs
comma
op_amp
id|eof
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
op_logical_or
id|eof
)paren
(brace
id|kfree
c_func
(paren
id|lbuf
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|len
op_add_assign
id|offs
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|80
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
op_star
(paren
id|lbuf
op_plus
id|len
op_plus
id|i
)paren
)paren
(brace
r_case
l_char|&squot;&bslash;t&squot;
suffix:colon
r_case
l_char|&squot; &squot;
suffix:colon
r_break
suffix:semicolon
r_case
l_char|&squot;&bslash;n&squot;
suffix:colon
r_default
suffix:colon
id|eof
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;0&squot;
suffix:colon
r_case
l_char|&squot;1&squot;
suffix:colon
r_case
l_char|&squot;2&squot;
suffix:colon
r_case
l_char|&squot;3&squot;
suffix:colon
id|j
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;d&squot;
suffix:colon
r_case
l_char|&squot;D&squot;
suffix:colon
id|disable_card
c_func
(paren
id|j
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;e&squot;
suffix:colon
r_case
l_char|&squot;E&squot;
suffix:colon
id|enable_card
c_func
(paren
id|j
)paren
suffix:semicolon
id|j
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eof
)paren
r_break
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|lbuf
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/**&n; * Functions that run under a timer, with no process id&n; *&n; * The task functions:&n; *     z90crypt_reader_task&n; *&t; helper_send_work&n; *&t; helper_handle_work_element&n; *&t; helper_receive_rc&n; *     z90crypt_config_task&n; *     z90crypt_cleanup_task&n; *&n; * Helper functions:&n; *     z90crypt_schedule_reader_timer&n; *     z90crypt_schedule_reader_task&n; *     z90crypt_schedule_config_task&n; *     z90crypt_schedule_cleanup_task&n; */
r_static
r_inline
r_int
DECL|function|receive_from_crypto_device
id|receive_from_crypto_device
c_func
(paren
r_int
id|index
comma
r_int
r_char
op_star
id|psmid
comma
r_int
op_star
id|buff_len_p
comma
r_int
r_char
op_star
id|buff
comma
r_int
r_char
op_star
op_star
id|dest_p_p
)paren
(brace
r_int
id|dv
comma
id|rv
suffix:semicolon
r_struct
id|device
op_star
id|dev_ptr
suffix:semicolon
r_struct
id|caller
op_star
id|caller_p
suffix:semicolon
r_struct
id|ica_rsa_modexpo
op_star
id|icaMsg_p
suffix:semicolon
r_struct
id|list_head
op_star
id|ptr
comma
op_star
id|tptr
suffix:semicolon
id|memcpy
c_func
(paren
id|psmid
comma
id|NULL_psmid
comma
r_sizeof
(paren
id|NULL_psmid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.terminating
)paren
r_return
id|REC_FATAL_ERROR
suffix:semicolon
id|caller_p
op_assign
l_int|0
suffix:semicolon
id|dev_ptr
op_assign
id|z90crypt.device_p
(braket
id|index
)braket
suffix:semicolon
id|rv
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;Dequeue called for device %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_ptr
op_logical_or
id|dev_ptr-&gt;disabled
)paren
(brace
id|rv
op_assign
id|REC_NO_RESPONSE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_ptr-&gt;dev_self_x
op_ne
id|index
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;Corrupt dev ptr in receive_from_AP&bslash;n&quot;
)paren
suffix:semicolon
id|z90crypt.terminating
op_assign
l_int|1
suffix:semicolon
id|rv
op_assign
id|REC_FATAL_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_ptr-&gt;dev_resp_l
op_logical_or
op_logical_neg
id|dev_ptr-&gt;dev_resp_p
)paren
(brace
id|dv
op_assign
id|DEV_REC_EXCEPTION
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;dev_resp_l = %d, dev_resp_p = %p&bslash;n&quot;
comma
id|dev_ptr-&gt;dev_resp_l
comma
id|dev_ptr-&gt;dev_resp_p
)paren
suffix:semicolon
)brace
r_else
(brace
id|dv
op_assign
id|receive_from_AP
c_func
(paren
id|index
comma
id|z90crypt.cdx
comma
id|dev_ptr-&gt;dev_resp_l
comma
id|dev_ptr-&gt;dev_resp_p
comma
id|psmid
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|dv
)paren
(brace
r_case
id|DEV_REC_EXCEPTION
suffix:colon
id|rv
op_assign
id|REC_FATAL_ERROR
suffix:semicolon
id|z90crypt.terminating
op_assign
l_int|1
suffix:semicolon
id|PRINTKC
c_func
(paren
l_string|&quot;Exception in receive from device %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_ONLINE
suffix:colon
id|rv
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_EMPTY
suffix:colon
id|rv
op_assign
id|REC_EMPTY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_NO_WORK
suffix:colon
id|rv
op_assign
id|REC_NO_WORK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_BAD_MESSAGE
suffix:colon
r_case
id|DEV_GONE
suffix:colon
r_case
id|REC_HARDWAR_ERR
suffix:colon
r_default
suffix:colon
id|rv
op_assign
id|REC_NO_RESPONSE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rv
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|dev_ptr-&gt;dev_caller_count
op_le
l_int|0
)paren
(brace
id|rv
op_assign
id|REC_USER_GONE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|list_for_each_safe
c_func
(paren
id|ptr
comma
id|tptr
comma
op_amp
id|dev_ptr-&gt;dev_caller_list
)paren
(brace
id|caller_p
op_assign
id|list_entry
c_func
(paren
id|ptr
comma
r_struct
id|caller
comma
id|caller_liste
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|caller_p-&gt;caller_id
comma
id|psmid
comma
r_sizeof
(paren
id|caller_p-&gt;caller_id
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|caller_p-&gt;caller_liste
)paren
)paren
(brace
id|list_del
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|dev_ptr-&gt;dev_caller_count
op_decrement
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|caller_p-&gt;caller_liste
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|caller_p
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|caller_p
)paren
(brace
id|rv
op_assign
id|REC_USER_GONE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_string|&quot;caller_p after successful receive: %p&bslash;n&quot;
comma
id|caller_p
)paren
suffix:semicolon
id|rv
op_assign
id|convert_response
c_func
(paren
id|dev_ptr-&gt;dev_resp_p
comma
id|caller_p-&gt;caller_buf_p
comma
id|buff_len_p
comma
id|buff
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rv
)paren
(brace
r_case
id|REC_OPERAND_INV
suffix:colon
id|PDEBUG
c_func
(paren
l_string|&quot;dev %d: user error %d&bslash;n&quot;
comma
id|index
comma
id|rv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WRONG_DEVICE_TYPE
suffix:colon
r_case
id|REC_HARDWAR_ERR
suffix:colon
r_case
id|REC_BAD_MESSAGE
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;dev %d: hardware error %d&bslash;n&quot;
comma
id|index
comma
id|rv
)paren
suffix:semicolon
id|rv
op_assign
id|REC_NO_RESPONSE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REC_RELEASED
suffix:colon
id|PDEBUG
c_func
(paren
l_string|&quot;dev %d: REC_RELEASED = %d&bslash;n&quot;
comma
id|index
comma
id|rv
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_string|&quot;dev %d: rv = %d&bslash;n&quot;
comma
id|index
comma
id|rv
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rv
)paren
(brace
r_case
l_int|0
suffix:colon
id|PDEBUG
c_func
(paren
l_string|&quot;Successful receive from device %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
id|icaMsg_p
op_assign
(paren
r_struct
id|ica_rsa_modexpo
op_star
)paren
id|caller_p-&gt;caller_buf_p
suffix:semicolon
op_star
id|dest_p_p
op_assign
id|icaMsg_p-&gt;outputdata
suffix:semicolon
r_if
c_cond
(paren
op_star
id|buff_len_p
op_eq
l_int|0
)paren
id|PRINTK
c_func
(paren
l_string|&quot;Zero *buff_len_p&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REC_NO_RESPONSE
suffix:colon
id|remove_device
c_func
(paren
id|dev_ptr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|caller_p
)paren
id|unbuild_caller
c_func
(paren
id|dev_ptr
comma
id|caller_p
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|helper_send_work
id|helper_send_work
c_func
(paren
r_int
id|index
)paren
(brace
r_struct
id|work_element
op_star
id|rq_p
suffix:semicolon
r_int
id|rv
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|request_list
)paren
)paren
r_return
suffix:semicolon
id|requestq_count
op_decrement
suffix:semicolon
id|rq_p
op_assign
id|list_entry
c_func
(paren
id|request_list.next
comma
r_struct
id|work_element
comma
id|liste
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|rq_p-&gt;liste
)paren
suffix:semicolon
id|rq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_REMREQUEST
suffix:semicolon
r_if
c_cond
(paren
id|rq_p-&gt;devtype
op_eq
id|SHRT2DEVPTR
c_func
(paren
id|index
)paren
op_member_access_from_pointer
id|dev_type
)paren
(brace
id|rq_p-&gt;devindex
op_assign
id|SHRT2LONG
c_func
(paren
id|index
)paren
suffix:semicolon
id|rv
op_assign
id|send_to_crypto_device
c_func
(paren
id|rq_p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
op_eq
l_int|0
)paren
(brace
id|rq_p-&gt;requestsent
op_assign
id|jiffies
suffix:semicolon
id|rq_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_SENT
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|rq_p-&gt;liste
comma
op_amp
id|pending_list
)paren
suffix:semicolon
op_increment
id|pendingq_count
suffix:semicolon
id|rq_p-&gt;audit
(braket
l_int|0
)braket
op_or_assign
id|FP_PENDING
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|rv
)paren
(brace
r_case
id|REC_OPERAND_INV
suffix:colon
r_case
id|REC_OPERAND_SIZE
suffix:colon
r_case
id|REC_EVEN_MOD
suffix:colon
r_case
id|REC_INVALID_PAD
suffix:colon
id|rq_p-&gt;retcode
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEN_NOT_AVAIL
suffix:colon
r_case
id|SEN_RETRY
suffix:colon
r_case
id|REC_NO_RESPONSE
suffix:colon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|z90crypt.mask.st_count
OG
l_int|1
)paren
id|rq_p-&gt;retcode
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_else
id|rq_p-&gt;retcode
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rq_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
id|rq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_AWAKENING
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rq_p-&gt;alarmrung
comma
l_int|1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|rq_p-&gt;waitq
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|z90crypt.mask.st_count
OG
l_int|1
)paren
id|rq_p-&gt;retcode
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_else
id|rq_p-&gt;retcode
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|rq_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
id|rq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_AWAKENING
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rq_p-&gt;alarmrung
comma
l_int|1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|rq_p-&gt;waitq
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|helper_handle_work_element
id|helper_handle_work_element
c_func
(paren
r_int
id|index
comma
r_int
r_char
id|psmid
(braket
l_int|8
)braket
comma
r_int
id|rc
comma
r_int
id|buff_len
comma
r_int
r_char
op_star
id|buff
comma
r_int
r_char
op_star
id|resp_addr
)paren
(brace
r_struct
id|work_element
op_star
id|pq_p
suffix:semicolon
r_struct
id|list_head
op_star
id|lptr
comma
op_star
id|tptr
suffix:semicolon
id|pq_p
op_assign
l_int|0
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|lptr
comma
id|tptr
comma
op_amp
id|pending_list
)paren
(brace
id|pq_p
op_assign
id|list_entry
c_func
(paren
id|lptr
comma
r_struct
id|work_element
comma
id|liste
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|pq_p-&gt;caller_id
comma
id|psmid
comma
r_sizeof
(paren
id|pq_p-&gt;caller_id
)paren
)paren
)paren
(brace
id|list_del
c_func
(paren
id|lptr
)paren
suffix:semicolon
id|pendingq_count
op_decrement
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_NOTPENDING
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pq_p
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|pq_p
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;device %d has work but no caller exists on pending Q&bslash;n&quot;
comma
id|SHRT2LONG
c_func
(paren
id|index
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rc
)paren
(brace
r_case
l_int|0
suffix:colon
id|pq_p-&gt;resp_buff_size
op_assign
id|buff_len
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_RESPSIZESET
suffix:semicolon
r_if
c_cond
(paren
id|buff_len
)paren
(brace
id|pq_p-&gt;resp_addr
op_assign
id|resp_addr
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_RESPADDRCOPIED
suffix:semicolon
id|memcpy
c_func
(paren
id|pq_p-&gt;resp_buff
comma
id|buff
comma
id|buff_len
)paren
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_RESPBUFFCOPIED
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|REC_OPERAND_INV
suffix:colon
r_case
id|REC_OPERAND_SIZE
suffix:colon
r_case
id|REC_EVEN_MOD
suffix:colon
r_case
id|REC_INVALID_PAD
suffix:colon
id|PDEBUG
c_func
(paren
l_string|&quot;-EINVAL after application error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|pq_p-&gt;retcode
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|pq_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REC_NO_RESPONSE
suffix:colon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|z90crypt.mask.st_count
OG
l_int|1
)paren
id|pq_p-&gt;retcode
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_else
id|pq_p-&gt;retcode
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|pq_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pq_p-&gt;status
(braket
l_int|0
)braket
op_ne
id|STAT_FAILED
)paren
op_logical_or
(paren
id|pq_p-&gt;retcode
op_ne
op_minus
id|ERELEASED
)paren
)paren
(brace
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_AWAKENING
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|pq_p-&gt;alarmrung
comma
l_int|1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|pq_p-&gt;waitq
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * return TRUE if the work element should be removed from the queue&n; */
r_static
r_inline
r_int
DECL|function|helper_receive_rc
id|helper_receive_rc
c_func
(paren
r_int
id|index
comma
r_int
op_star
id|rc_p
comma
r_int
op_star
id|workavail_p
)paren
(brace
r_switch
c_cond
(paren
op_star
id|rc_p
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
id|REC_OPERAND_INV
suffix:colon
r_case
id|REC_OPERAND_SIZE
suffix:colon
r_case
id|REC_EVEN_MOD
suffix:colon
r_case
id|REC_INVALID_PAD
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|REC_BUSY
suffix:colon
r_case
id|REC_NO_WORK
suffix:colon
r_case
id|REC_EMPTY
suffix:colon
r_case
id|REC_RETRY_DEV
suffix:colon
r_case
id|REC_FATAL_ERROR
suffix:colon
r_break
suffix:semicolon
r_case
id|REC_NO_RESPONSE
suffix:colon
op_star
id|workavail_p
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;rc %d, device %d&bslash;n&quot;
comma
op_star
id|rc_p
comma
id|SHRT2LONG
c_func
(paren
id|index
)paren
)paren
suffix:semicolon
op_star
id|rc_p
op_assign
id|REC_NO_RESPONSE
suffix:semicolon
op_star
id|workavail_p
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|z90crypt_schedule_reader_timer
id|z90crypt_schedule_reader_timer
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|reader_timer
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|mod_timer
c_func
(paren
op_amp
id|reader_timer
comma
id|jiffies
op_plus
(paren
id|READERTIME
op_star
id|HZ
op_div
l_int|1000
)paren
)paren
op_ne
l_int|0
)paren
id|PRINTK
c_func
(paren
l_string|&quot;Timer pending while modifying reader timer&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|z90crypt_reader_task
id|z90crypt_reader_task
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
id|workavail
comma
id|remaining
comma
id|index
comma
id|rc
comma
id|buff_len
suffix:semicolon
r_int
r_char
id|psmid
(braket
l_int|8
)braket
comma
op_star
id|resp_addr
suffix:semicolon
r_static
r_int
r_char
id|buff
(braket
l_int|1024
)braket
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;jiffies %ld&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
multiline_comment|/**&n;&t; * we use workavail = 2 to ensure 2 passes with nothing dequeued before&n;&t; * exiting the loop. If remaining == 0 after the loop, there is no work&n;&t; * remaining on the queues.&n;&t; */
id|resp_addr
op_assign
l_int|0
suffix:semicolon
id|workavail
op_assign
l_int|2
suffix:semicolon
id|remaining
op_assign
l_int|0
suffix:semicolon
id|buff_len
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|workavail
)paren
(brace
id|workavail
op_decrement
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0x00
comma
r_sizeof
(paren
id|buff
)paren
)paren
suffix:semicolon
multiline_comment|/* Dequeue once from each device in round robin. */
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|z90crypt.mask.st_count
suffix:semicolon
id|index
op_increment
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;About to receive.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|receive_from_crypto_device
c_func
(paren
id|SHRT2LONG
c_func
(paren
id|index
)paren
comma
id|psmid
comma
op_amp
id|buff_len
comma
id|buff
comma
op_amp
id|resp_addr
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;Dequeued: rc = %d.&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|helper_receive_rc
c_func
(paren
id|index
comma
op_amp
id|rc
comma
op_amp
id|workavail
)paren
)paren
(brace
r_if
c_cond
(paren
id|rc
op_ne
id|REC_NO_RESPONSE
)paren
(brace
id|helper_send_work
c_func
(paren
id|index
)paren
suffix:semicolon
id|workavail
op_assign
l_int|2
suffix:semicolon
)brace
id|helper_handle_work_element
c_func
(paren
id|index
comma
id|psmid
comma
id|rc
comma
id|buff_len
comma
id|buff
comma
id|resp_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
id|REC_FATAL_ERROR
)paren
id|remaining
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rc
op_ne
id|REC_NO_RESPONSE
)paren
id|remaining
op_add_assign
id|SHRT2DEVPTR
c_func
(paren
id|index
)paren
op_member_access_from_pointer
id|dev_caller_count
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|remaining
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
id|z90crypt_schedule_reader_timer
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|z90crypt_schedule_config_task
id|z90crypt_schedule_config_task
c_func
(paren
r_int
r_int
id|expiration
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|config_timer
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|mod_timer
c_func
(paren
op_amp
id|config_timer
comma
id|jiffies
op_plus
(paren
id|expiration
op_star
id|HZ
)paren
)paren
op_ne
l_int|0
)paren
id|PRINTK
c_func
(paren
l_string|&quot;Timer pending while modifying config timer&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|z90crypt_config_task
id|z90crypt_config_task
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
id|rc
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;jiffies %ld&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|refresh_z90crypt
c_func
(paren
op_amp
id|z90crypt.cdx
)paren
)paren
)paren
id|PRINTK
c_func
(paren
l_string|&quot;Error %d detected in refresh_z90crypt.&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
multiline_comment|/* If return was fatal, don&squot;t bother reconfiguring */
r_if
c_cond
(paren
(paren
id|rc
op_ne
id|TSQ_FATAL_ERROR
)paren
op_logical_and
(paren
id|rc
op_ne
id|RSQ_FATAL_ERROR
)paren
)paren
id|z90crypt_schedule_config_task
c_func
(paren
id|CONFIGTIME
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|z90crypt_schedule_cleanup_task
id|z90crypt_schedule_cleanup_task
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|cleanup_timer
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|mod_timer
c_func
(paren
op_amp
id|cleanup_timer
comma
id|jiffies
op_plus
(paren
id|CLEANUPTIME
op_star
id|HZ
)paren
)paren
op_ne
l_int|0
)paren
id|PRINTK
c_func
(paren
l_string|&quot;Timer pending while modifying cleanup timer&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|helper_drain_queues
id|helper_drain_queues
c_func
(paren
r_void
)paren
(brace
r_struct
id|work_element
op_star
id|pq_p
suffix:semicolon
r_struct
id|list_head
op_star
id|lptr
comma
op_star
id|tptr
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|lptr
comma
id|tptr
comma
op_amp
id|pending_list
)paren
(brace
id|pq_p
op_assign
id|list_entry
c_func
(paren
id|lptr
comma
r_struct
id|work_element
comma
id|liste
)paren
suffix:semicolon
id|pq_p-&gt;retcode
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|pq_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
id|unbuild_caller
c_func
(paren
id|LONG2DEVPTR
c_func
(paren
id|pq_p-&gt;devindex
)paren
comma
(paren
r_struct
id|caller
op_star
)paren
id|pq_p-&gt;requestptr
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|lptr
)paren
suffix:semicolon
id|pendingq_count
op_decrement
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_NOTPENDING
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_AWAKENING
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|pq_p-&gt;alarmrung
comma
l_int|1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|pq_p-&gt;waitq
)paren
suffix:semicolon
)brace
id|list_for_each_safe
c_func
(paren
id|lptr
comma
id|tptr
comma
op_amp
id|request_list
)paren
(brace
id|pq_p
op_assign
id|list_entry
c_func
(paren
id|lptr
comma
r_struct
id|work_element
comma
id|liste
)paren
suffix:semicolon
id|pq_p-&gt;retcode
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|pq_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
id|list_del
c_func
(paren
id|lptr
)paren
suffix:semicolon
id|requestq_count
op_decrement
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_REMREQUEST
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_AWAKENING
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|pq_p-&gt;alarmrung
comma
l_int|1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|pq_p-&gt;waitq
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|helper_timeout_requests
id|helper_timeout_requests
c_func
(paren
r_void
)paren
(brace
r_struct
id|work_element
op_star
id|pq_p
suffix:semicolon
r_struct
id|list_head
op_star
id|lptr
comma
op_star
id|tptr
suffix:semicolon
r_int
id|timelimit
suffix:semicolon
id|timelimit
op_assign
id|jiffies
op_minus
(paren
id|CLEANUPTIME
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* The list is in strict chronological order */
id|list_for_each_safe
c_func
(paren
id|lptr
comma
id|tptr
comma
op_amp
id|pending_list
)paren
(brace
id|pq_p
op_assign
id|list_entry
c_func
(paren
id|lptr
comma
r_struct
id|work_element
comma
id|liste
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pq_p-&gt;requestsent
op_ge
id|timelimit
)paren
r_break
suffix:semicolon
id|pq_p-&gt;retcode
op_assign
op_minus
id|ETIMEOUT
suffix:semicolon
id|pq_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
multiline_comment|/* get this off any caller queue it may be on */
id|unbuild_caller
c_func
(paren
id|LONG2DEVPTR
c_func
(paren
id|pq_p-&gt;devindex
)paren
comma
(paren
r_struct
id|caller
op_star
)paren
id|pq_p-&gt;requestptr
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|lptr
)paren
suffix:semicolon
id|pendingq_count
op_decrement
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_TIMEDOUT
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_NOTPENDING
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_AWAKENING
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|pq_p-&gt;alarmrung
comma
l_int|1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|pq_p-&gt;waitq
)paren
suffix:semicolon
)brace
multiline_comment|/**&n;&t; * If pending count is zero, items left on the request queue may&n;&t; * never be processed.&n;&t; */
r_if
c_cond
(paren
id|pendingq_count
op_le
l_int|0
)paren
(brace
id|list_for_each_safe
c_func
(paren
id|lptr
comma
id|tptr
comma
op_amp
id|request_list
)paren
(brace
id|pq_p
op_assign
id|list_entry
c_func
(paren
id|lptr
comma
r_struct
id|work_element
comma
id|liste
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pq_p-&gt;requestsent
op_ge
id|timelimit
)paren
r_break
suffix:semicolon
id|pq_p-&gt;retcode
op_assign
op_minus
id|ETIMEOUT
suffix:semicolon
id|pq_p-&gt;status
(braket
l_int|0
)braket
op_or_assign
id|STAT_FAILED
suffix:semicolon
id|list_del
c_func
(paren
id|lptr
)paren
suffix:semicolon
id|requestq_count
op_decrement
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_TIMEDOUT
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_REMREQUEST
suffix:semicolon
id|pq_p-&gt;audit
(braket
l_int|1
)braket
op_or_assign
id|FP_AWAKENING
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|pq_p-&gt;alarmrung
comma
l_int|1
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|pq_p-&gt;waitq
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|z90crypt_cleanup_task
id|z90crypt_cleanup_task
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;jiffies %ld&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.mask.st_count
op_le
l_int|0
)paren
singleline_comment|// no devices!
id|helper_drain_queues
c_func
(paren
)paren
suffix:semicolon
r_else
id|helper_timeout_requests
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
id|z90crypt_schedule_cleanup_task
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|z90crypt_schedule_reader_task
id|z90crypt_schedule_reader_task
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|reader_tasklet
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Lowlevel Functions:&n; *&n; *   create_z90crypt:  creates and initializes basic data structures&n; *   refresh_z90crypt:&t;re-initializes basic data structures&n; *   find_crypto_devices: returns a count and mask of hardware status&n; *   create_crypto_device:  builds the descriptor for a device&n; *   destroy_crypto_device:  unallocates the descriptor for a device&n; *   destroy_z90crypt:&t;drains all work, unallocates structs&n; */
multiline_comment|/**&n; * build the z90crypt root structure using the given domain index&n; */
r_static
r_int
DECL|function|create_z90crypt
id|create_z90crypt
c_func
(paren
r_int
op_star
id|cdx_p
)paren
(brace
r_struct
id|hdware_block
op_star
id|hdware_blk_p
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|z90crypt
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|z90crypt
)paren
)paren
suffix:semicolon
id|z90crypt.domain_established
op_assign
l_int|0
suffix:semicolon
id|z90crypt.len
op_assign
r_sizeof
(paren
r_struct
id|z90crypt
)paren
suffix:semicolon
id|z90crypt.max_count
op_assign
id|Z90CRYPT_NUM_DEVS
suffix:semicolon
id|z90crypt.cdx
op_assign
op_star
id|cdx_p
suffix:semicolon
id|hdware_blk_p
op_assign
(paren
r_struct
id|hdware_block
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hdware_block
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdware_blk_p
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;kmalloc for hardware block failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hdware_blk_p
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|hdware_block
)paren
)paren
suffix:semicolon
id|z90crypt.hdware_info
op_assign
id|hdware_blk_p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|helper_scan_devices
id|helper_scan_devices
c_func
(paren
r_int
id|cdx_array
(braket
l_int|16
)braket
comma
r_int
op_star
id|cdx_p
comma
r_int
op_star
id|correct_cdx_found
)paren
(brace
r_enum
id|hdstat
id|hd_stat
suffix:semicolon
r_int
id|q_depth
comma
id|dev_type
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|q_depth
op_assign
id|dev_type
op_assign
id|k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|z90crypt.max_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hd_stat
op_assign
id|HD_NOT_THERE
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
l_int|15
suffix:semicolon
id|cdx_array
(braket
id|j
op_increment
)braket
op_assign
op_minus
l_int|1
)paren
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
l_int|15
suffix:semicolon
id|j
op_increment
)paren
(brace
id|hd_stat
op_assign
id|query_online
c_func
(paren
id|i
comma
id|j
comma
id|MAX_RESET
comma
op_amp
id|q_depth
comma
op_amp
id|dev_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd_stat
op_eq
id|HD_TSQ_EXCEPTION
)paren
(brace
id|z90crypt.terminating
op_assign
l_int|1
suffix:semicolon
id|PRINTKC
c_func
(paren
l_string|&quot;exception taken!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hd_stat
op_eq
id|HD_ONLINE
)paren
(brace
id|cdx_array
(braket
id|k
op_increment
)braket
op_assign
id|j
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cdx_p
op_eq
id|j
)paren
(brace
op_star
id|correct_cdx_found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
(paren
op_star
id|correct_cdx_found
op_eq
l_int|1
)paren
op_logical_or
(paren
id|k
op_ne
l_int|0
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.terminating
)paren
r_break
suffix:semicolon
)brace
r_return
id|k
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|probe_crypto_domain
id|probe_crypto_domain
c_func
(paren
r_int
op_star
id|cdx_p
)paren
(brace
r_int
id|cdx_array
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|correct_cdx_found
comma
id|k
suffix:semicolon
id|correct_cdx_found
op_assign
l_int|0
suffix:semicolon
id|k
op_assign
id|helper_scan_devices
c_func
(paren
id|cdx_array
comma
id|cdx_p
comma
op_amp
id|correct_cdx_found
)paren
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.terminating
)paren
r_return
id|TSQ_FATAL_ERROR
suffix:semicolon
r_if
c_cond
(paren
id|correct_cdx_found
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|k
op_eq
l_int|0
)paren
(brace
op_star
id|cdx_p
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|cdx_p
op_eq
op_minus
l_int|1
)paren
op_logical_or
op_logical_neg
id|z90crypt.domain_established
)paren
(brace
op_star
id|cdx_p
op_assign
id|cdx_array
(braket
l_int|0
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|cdx_p
op_ne
id|cdx_array
(braket
l_int|0
)braket
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;incorrect domain: specified = %d, found = %d&bslash;n&quot;
comma
op_star
id|cdx_p
comma
id|cdx_array
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
id|Z90C_INCORRECT_DOMAIN
suffix:semicolon
)brace
)brace
r_return
id|Z90C_AMBIGUOUS_DOMAIN
suffix:semicolon
)brace
r_static
r_int
DECL|function|refresh_z90crypt
id|refresh_z90crypt
c_func
(paren
r_int
op_star
id|cdx_p
)paren
(brace
r_int
id|i
comma
id|j
comma
id|indx
comma
id|rv
suffix:semicolon
r_struct
id|status
id|local_mask
suffix:semicolon
r_struct
id|device
op_star
id|devPtr
suffix:semicolon
r_int
r_char
id|oldStat
comma
id|newStat
suffix:semicolon
r_int
id|return_unchanged
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.len
op_ne
r_sizeof
(paren
id|z90crypt
)paren
)paren
r_return
id|ENOTINIT
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.terminating
)paren
r_return
id|TSQ_FATAL_ERROR
suffix:semicolon
id|rv
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|z90crypt.hdware_info-&gt;hdware_mask.st_count
op_logical_and
op_logical_neg
id|z90crypt.domain_established
)paren
id|rv
op_assign
id|probe_crypto_domain
c_func
(paren
id|cdx_p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.terminating
)paren
r_return
id|TSQ_FATAL_ERROR
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
r_switch
c_cond
(paren
id|rv
)paren
(brace
r_case
id|Z90C_AMBIGUOUS_DOMAIN
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;ambiguous domain detected&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90C_INCORRECT_DOMAIN
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;incorrect domain specified&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;probe domain returned %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rv
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|cdx_p
)paren
(brace
id|z90crypt.cdx
op_assign
op_star
id|cdx_p
suffix:semicolon
id|z90crypt.domain_established
op_assign
l_int|1
suffix:semicolon
)brace
id|rv
op_assign
id|find_crypto_devices
c_func
(paren
op_amp
id|local_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;find crypto devices returned %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|local_mask
comma
op_amp
id|z90crypt.hdware_info-&gt;hdware_mask
comma
r_sizeof
(paren
r_struct
id|status
)paren
)paren
)paren
(brace
id|return_unchanged
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|Z90CRYPT_NUM_TYPES
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/**&n;&t;&t;&t; * Check for disabled cards.  If any device is marked&n;&t;&t;&t; * disabled, destroy it.&n;&t;&t;&t; */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|i
)braket
dot
id|st_count
suffix:semicolon
id|j
op_increment
)paren
(brace
id|indx
op_assign
id|z90crypt.hdware_info-&gt;type_x_addr
(braket
id|i
)braket
dot
id|device_index
(braket
id|j
)braket
suffix:semicolon
id|devPtr
op_assign
id|z90crypt.device_p
(braket
id|indx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devPtr
op_logical_and
id|devPtr-&gt;disabled
)paren
(brace
id|local_mask.st_mask
(braket
id|indx
)braket
op_assign
id|HD_NOT_THERE
suffix:semicolon
id|return_unchanged
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|return_unchanged
op_eq
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|z90crypt.max_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|oldStat
op_assign
id|z90crypt.hdware_info-&gt;hdware_mask.st_mask
(braket
id|i
)braket
suffix:semicolon
id|newStat
op_assign
id|local_mask.st_mask
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|oldStat
op_eq
id|HD_ONLINE
)paren
op_logical_and
(paren
id|newStat
op_ne
id|HD_ONLINE
)paren
)paren
id|destroy_crypto_device
c_func
(paren
id|i
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|oldStat
op_ne
id|HD_ONLINE
)paren
op_logical_and
(paren
id|newStat
op_eq
id|HD_ONLINE
)paren
)paren
(brace
id|rv
op_assign
id|create_crypto_device
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
op_ge
id|REC_FATAL_ERROR
)paren
r_return
id|rv
suffix:semicolon
r_if
c_cond
(paren
id|rv
op_ne
l_int|0
)paren
(brace
id|local_mask.st_mask
(braket
id|i
)braket
op_assign
id|HD_NOT_THERE
suffix:semicolon
id|local_mask.st_count
op_decrement
suffix:semicolon
)brace
)brace
)brace
id|memcpy
c_func
(paren
id|z90crypt.hdware_info-&gt;hdware_mask.st_mask
comma
id|local_mask.st_mask
comma
r_sizeof
(paren
id|local_mask.st_mask
)paren
)paren
suffix:semicolon
id|z90crypt.hdware_info-&gt;hdware_mask.st_count
op_assign
id|local_mask.st_count
suffix:semicolon
id|z90crypt.hdware_info-&gt;hdware_mask.disabled_count
op_assign
id|local_mask.disabled_count
suffix:semicolon
id|refresh_index_array
c_func
(paren
op_amp
id|z90crypt.mask
comma
op_amp
id|z90crypt.overall_device_x
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|Z90CRYPT_NUM_TYPES
suffix:semicolon
id|i
op_increment
)paren
id|refresh_index_array
c_func
(paren
op_amp
(paren
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|i
)braket
)paren
comma
op_amp
(paren
id|z90crypt.hdware_info-&gt;type_x_addr
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|queuespinlock
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
r_static
r_int
DECL|function|find_crypto_devices
id|find_crypto_devices
c_func
(paren
r_struct
id|status
op_star
id|deviceMask
)paren
(brace
r_int
id|i
comma
id|q_depth
comma
id|dev_type
suffix:semicolon
r_enum
id|hdstat
id|hd_stat
suffix:semicolon
id|deviceMask-&gt;st_count
op_assign
l_int|0
suffix:semicolon
id|deviceMask-&gt;disabled_count
op_assign
l_int|0
suffix:semicolon
id|deviceMask-&gt;user_disabled_count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|z90crypt.max_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hd_stat
op_assign
id|query_online
c_func
(paren
id|i
comma
id|z90crypt.cdx
comma
id|MAX_RESET
comma
op_amp
id|q_depth
comma
op_amp
id|dev_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hd_stat
op_eq
id|HD_TSQ_EXCEPTION
)paren
(brace
id|z90crypt.terminating
op_assign
l_int|1
suffix:semicolon
id|PRINTKC
c_func
(paren
l_string|&quot;Exception during probe for crypto devices&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TSQ_FATAL_ERROR
suffix:semicolon
)brace
id|deviceMask-&gt;st_mask
(braket
id|i
)braket
op_assign
id|hd_stat
suffix:semicolon
r_if
c_cond
(paren
id|hd_stat
op_eq
id|HD_ONLINE
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;Got an online crypto!: %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;Got a queue depth of %d&bslash;n&quot;
comma
id|q_depth
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;Got a device type of %d&bslash;n&quot;
comma
id|dev_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q_depth
op_le
l_int|0
)paren
r_return
id|TSQ_FATAL_ERROR
suffix:semicolon
id|deviceMask-&gt;st_count
op_increment
suffix:semicolon
id|z90crypt.q_depth_array
(braket
id|i
)braket
op_assign
id|q_depth
suffix:semicolon
id|z90crypt.dev_type_array
(braket
id|i
)braket
op_assign
id|dev_type
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|refresh_index_array
id|refresh_index_array
c_func
(paren
r_struct
id|status
op_star
id|status_str
comma
r_struct
id|device_x
op_star
id|index_array
)paren
(brace
r_int
id|i
comma
id|count
suffix:semicolon
r_enum
id|devstat
id|stat
suffix:semicolon
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|stat
op_assign
id|status_str-&gt;st_mask
(braket
op_increment
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_eq
id|DEV_ONLINE
)paren
id|index_array-&gt;device_index
(braket
id|count
op_increment
)braket
op_assign
id|i
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|i
OL
id|Z90CRYPT_NUM_DEVS
)paren
op_logical_and
(paren
id|count
OL
id|status_str-&gt;st_count
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
r_int
DECL|function|create_crypto_device
id|create_crypto_device
c_func
(paren
r_int
id|index
)paren
(brace
r_int
id|rv
comma
id|devstat
comma
id|total_size
suffix:semicolon
r_struct
id|device
op_star
id|dev_ptr
suffix:semicolon
r_struct
id|status
op_star
id|type_str_p
suffix:semicolon
r_int
id|deviceType
suffix:semicolon
id|dev_ptr
op_assign
id|z90crypt.device_p
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_ptr
)paren
(brace
id|total_size
op_assign
r_sizeof
(paren
r_struct
id|device
)paren
op_plus
id|z90crypt.q_depth_array
(braket
id|index
)braket
op_star
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|dev_ptr
op_assign
(paren
r_struct
id|device
op_star
)paren
id|kmalloc
c_func
(paren
id|total_size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_ptr
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;kmalloc device %d failed&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_return
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dev_ptr
comma
l_int|0
comma
id|total_size
)paren
suffix:semicolon
id|dev_ptr-&gt;dev_resp_p
op_assign
id|kmalloc
c_func
(paren
id|MAX_RESPONSE_SIZE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_ptr-&gt;dev_resp_p
)paren
(brace
id|kfree
c_func
(paren
id|dev_ptr
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;kmalloc device %d rec buffer failed&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_return
id|ENOMEM
suffix:semicolon
)brace
id|dev_ptr-&gt;dev_resp_l
op_assign
id|MAX_RESPONSE_SIZE
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
(paren
id|dev_ptr-&gt;dev_caller_list
)paren
)paren
suffix:semicolon
)brace
id|devstat
op_assign
id|reset_device
c_func
(paren
id|index
comma
id|z90crypt.cdx
comma
id|MAX_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devstat
op_eq
id|DEV_RSQ_EXCEPTION
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;exception during reset device %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_ptr-&gt;dev_resp_p
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_ptr
)paren
suffix:semicolon
r_return
id|RSQ_FATAL_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devstat
op_eq
id|DEV_ONLINE
)paren
(brace
id|dev_ptr-&gt;dev_self_x
op_assign
id|index
suffix:semicolon
id|dev_ptr-&gt;dev_type
op_assign
id|z90crypt.dev_type_array
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev_ptr-&gt;dev_type
op_eq
id|NILDEV
)paren
(brace
id|rv
op_assign
id|probe_device_type
c_func
(paren
id|dev_ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;rv = %d from probe_device_type %d&bslash;n&quot;
comma
id|rv
comma
id|index
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_ptr-&gt;dev_resp_p
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_ptr
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
)brace
id|deviceType
op_assign
id|dev_ptr-&gt;dev_type
suffix:semicolon
id|z90crypt.dev_type_array
(braket
id|index
)braket
op_assign
id|deviceType
suffix:semicolon
r_if
c_cond
(paren
id|deviceType
op_eq
id|PCICA
)paren
id|z90crypt.hdware_info-&gt;device_type_array
(braket
id|index
)braket
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|deviceType
op_eq
id|PCICC
)paren
id|z90crypt.hdware_info-&gt;device_type_array
(braket
id|index
)braket
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|deviceType
op_eq
id|PCIXCC
)paren
id|z90crypt.hdware_info-&gt;device_type_array
(braket
id|index
)braket
op_assign
l_int|3
suffix:semicolon
r_else
id|z90crypt.hdware_info-&gt;device_type_array
(braket
id|index
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n;&t; * &squot;q_depth&squot; returned by the hardware is one less than&n;&t; * the actual depth&n;&t; */
id|dev_ptr-&gt;dev_q_depth
op_assign
id|z90crypt.q_depth_array
(braket
id|index
)braket
suffix:semicolon
id|dev_ptr-&gt;dev_type
op_assign
id|z90crypt.dev_type_array
(braket
id|index
)braket
suffix:semicolon
id|dev_ptr-&gt;dev_stat
op_assign
id|devstat
suffix:semicolon
id|dev_ptr-&gt;disabled
op_assign
l_int|0
suffix:semicolon
id|z90crypt.device_p
(braket
id|index
)braket
op_assign
id|dev_ptr
suffix:semicolon
r_if
c_cond
(paren
id|devstat
op_eq
id|DEV_ONLINE
)paren
(brace
r_if
c_cond
(paren
id|z90crypt.mask.st_mask
(braket
id|index
)braket
op_ne
id|DEV_ONLINE
)paren
(brace
id|z90crypt.mask.st_mask
(braket
id|index
)braket
op_assign
id|DEV_ONLINE
suffix:semicolon
id|z90crypt.mask.st_count
op_increment
suffix:semicolon
)brace
id|deviceType
op_assign
id|dev_ptr-&gt;dev_type
suffix:semicolon
id|type_str_p
op_assign
op_amp
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|deviceType
)braket
suffix:semicolon
r_if
c_cond
(paren
id|type_str_p-&gt;st_mask
(braket
id|index
)braket
op_ne
id|DEV_ONLINE
)paren
(brace
id|type_str_p-&gt;st_mask
(braket
id|index
)braket
op_assign
id|DEV_ONLINE
suffix:semicolon
id|type_str_p-&gt;st_count
op_increment
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|destroy_crypto_device
id|destroy_crypto_device
c_func
(paren
r_int
id|index
)paren
(brace
r_struct
id|device
op_star
id|dev_ptr
suffix:semicolon
r_int
id|t
comma
id|disabledFlag
suffix:semicolon
id|dev_ptr
op_assign
id|z90crypt.device_p
(braket
id|index
)braket
suffix:semicolon
multiline_comment|/* remember device type; get rid of device struct */
r_if
c_cond
(paren
id|dev_ptr
)paren
(brace
id|disabledFlag
op_assign
id|dev_ptr-&gt;disabled
suffix:semicolon
id|t
op_assign
id|dev_ptr-&gt;dev_type
suffix:semicolon
r_if
c_cond
(paren
id|dev_ptr-&gt;dev_resp_p
)paren
id|kfree
c_func
(paren
id|dev_ptr-&gt;dev_resp_p
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev_ptr
)paren
suffix:semicolon
)brace
r_else
(brace
id|disabledFlag
op_assign
l_int|0
suffix:semicolon
id|t
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|z90crypt.device_p
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if the type is valid, remove the device from the type_mask */
r_if
c_cond
(paren
(paren
id|t
op_ne
op_minus
l_int|1
)paren
op_logical_and
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|t
)braket
dot
id|st_mask
(braket
id|index
)braket
)paren
(brace
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|t
)braket
dot
id|st_mask
(braket
id|index
)braket
op_assign
l_int|0x00
suffix:semicolon
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|t
)braket
dot
id|st_count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|disabledFlag
op_eq
l_int|1
)paren
id|z90crypt.hdware_info-&gt;type_mask
(braket
id|t
)braket
dot
id|disabled_count
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|z90crypt.mask.st_mask
(braket
id|index
)braket
op_ne
id|DEV_GONE
)paren
(brace
id|z90crypt.mask.st_mask
(braket
id|index
)braket
op_assign
id|DEV_GONE
suffix:semicolon
id|z90crypt.mask.st_count
op_decrement
suffix:semicolon
)brace
id|z90crypt.hdware_info-&gt;device_type_array
(braket
id|index
)braket
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|destroy_z90crypt
id|destroy_z90crypt
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|z90crypt.max_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|z90crypt.device_p
(braket
id|i
)braket
)paren
id|destroy_crypto_device
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|z90crypt.hdware_info
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|z90crypt.hdware_info
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
op_amp
id|z90crypt
comma
l_int|0
comma
r_sizeof
(paren
id|z90crypt
)paren
)paren
suffix:semicolon
)brace
DECL|variable|static_testmsg
r_static
r_int
r_char
id|static_testmsg
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x02
comma
l_int|0x03
comma
l_int|0x04
comma
l_int|0x05
comma
l_int|0x06
comma
l_int|0x07
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x06
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x58
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x43
comma
l_int|0x43
comma
l_int|0x41
comma
l_int|0x2d
comma
l_int|0x41
comma
l_int|0x50
comma
l_int|0x50
comma
l_int|0x4c
comma
l_int|0x20
comma
l_int|0x20
comma
l_int|0x20
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x50
comma
l_int|0x4b
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x1c
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x05
comma
l_int|0xb8
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x70
comma
l_int|0x00
comma
l_int|0x41
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x54
comma
l_int|0x32
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0xa0
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xb8
comma
l_int|0x05
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x0a
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x08
comma
l_int|0x00
comma
l_int|0x49
comma
l_int|0x43
comma
l_int|0x53
comma
l_int|0x46
comma
l_int|0x20
comma
l_int|0x20
comma
l_int|0x20
comma
l_int|0x20
comma
l_int|0x50
comma
l_int|0x4b
comma
l_int|0x0a
comma
l_int|0x00
comma
l_int|0x50
comma
l_int|0x4b
comma
l_int|0x43
comma
l_int|0x53
comma
l_int|0x2d
comma
l_int|0x31
comma
l_int|0x2e
comma
l_int|0x32
comma
l_int|0x37
comma
l_int|0x00
comma
l_int|0x11
comma
l_int|0x22
comma
l_int|0x33
comma
l_int|0x44
comma
l_int|0x55
comma
l_int|0x66
comma
l_int|0x77
comma
l_int|0x88
comma
l_int|0x99
comma
l_int|0x00
comma
l_int|0x11
comma
l_int|0x22
comma
l_int|0x33
comma
l_int|0x44
comma
l_int|0x55
comma
l_int|0x66
comma
l_int|0x77
comma
l_int|0x88
comma
l_int|0x99
comma
l_int|0x00
comma
l_int|0x11
comma
l_int|0x22
comma
l_int|0x33
comma
l_int|0x44
comma
l_int|0x55
comma
l_int|0x66
comma
l_int|0x77
comma
l_int|0x88
comma
l_int|0x99
comma
l_int|0x00
comma
l_int|0x11
comma
l_int|0x22
comma
l_int|0x33
comma
l_int|0x44
comma
l_int|0x55
comma
l_int|0x66
comma
l_int|0x77
comma
l_int|0x88
comma
l_int|0x99
comma
l_int|0x00
comma
l_int|0x11
comma
l_int|0x22
comma
l_int|0x33
comma
l_int|0x44
comma
l_int|0x55
comma
l_int|0x66
comma
l_int|0x77
comma
l_int|0x88
comma
l_int|0x99
comma
l_int|0x00
comma
l_int|0x11
comma
l_int|0x22
comma
l_int|0x33
comma
l_int|0x5d
comma
l_int|0x00
comma
l_int|0x5b
comma
l_int|0x00
comma
l_int|0x77
comma
l_int|0x88
comma
l_int|0x1e
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x57
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x04
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x4f
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x03
comma
l_int|0x02
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x40
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0xce
comma
l_int|0x02
comma
l_int|0x68
comma
l_int|0x2d
comma
l_int|0x5f
comma
l_int|0xa9
comma
l_int|0xde
comma
l_int|0x0c
comma
l_int|0xf6
comma
l_int|0xd2
comma
l_int|0x7b
comma
l_int|0x58
comma
l_int|0x4b
comma
l_int|0xf9
comma
l_int|0x28
comma
l_int|0x68
comma
l_int|0x3d
comma
l_int|0xb4
comma
l_int|0xf4
comma
l_int|0xef
comma
l_int|0x78
comma
l_int|0xd5
comma
l_int|0xbe
comma
l_int|0x66
comma
l_int|0x63
comma
l_int|0x42
comma
l_int|0xef
comma
l_int|0xf8
comma
l_int|0xfd
comma
l_int|0xa4
comma
l_int|0xf8
comma
l_int|0xb0
comma
l_int|0x8e
comma
l_int|0x29
comma
l_int|0xc2
comma
l_int|0xc9
comma
l_int|0x2e
comma
l_int|0xd8
comma
l_int|0x45
comma
l_int|0xb8
comma
l_int|0x53
comma
l_int|0x8c
comma
l_int|0x6f
comma
l_int|0x4e
comma
l_int|0x72
comma
l_int|0x8f
comma
l_int|0x6c
comma
l_int|0x04
comma
l_int|0x9c
comma
l_int|0x88
comma
l_int|0xfc
comma
l_int|0x1e
comma
l_int|0xc5
comma
l_int|0x83
comma
l_int|0x55
comma
l_int|0x57
comma
l_int|0xf7
comma
l_int|0xdd
comma
l_int|0xfd
comma
l_int|0x4f
comma
l_int|0x11
comma
l_int|0x36
comma
l_int|0x95
comma
l_int|0x5d
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
r_static
r_int
DECL|function|probe_device_type
id|probe_device_type
c_func
(paren
r_struct
id|device
op_star
id|devPtr
)paren
(brace
r_int
id|rv
comma
id|dv
comma
id|i
comma
id|index
comma
id|length
suffix:semicolon
r_int
r_char
id|psmid
(braket
l_int|8
)braket
suffix:semicolon
r_static
r_int
r_char
id|loc_testmsg
(braket
l_int|384
)braket
suffix:semicolon
id|index
op_assign
id|devPtr-&gt;dev_self_x
suffix:semicolon
id|rv
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|memcpy
c_func
(paren
id|loc_testmsg
comma
id|static_testmsg
comma
r_sizeof
(paren
id|static_testmsg
)paren
)paren
suffix:semicolon
id|length
op_assign
r_sizeof
(paren
id|static_testmsg
)paren
op_minus
l_int|24
suffix:semicolon
multiline_comment|/* the -24 allows for the header */
id|dv
op_assign
id|send_to_AP
c_func
(paren
id|index
comma
id|z90crypt.cdx
comma
id|length
comma
id|loc_testmsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dv
)paren
(brace
id|PDEBUG
c_func
(paren
l_string|&quot;dv returned by send during probe: %d&bslash;n&quot;
comma
id|dv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dv
op_eq
id|DEV_SEN_EXCEPTION
)paren
(brace
id|rv
op_assign
id|SEN_FATAL_ERROR
suffix:semicolon
id|PRINTKC
c_func
(paren
l_string|&quot;exception in send to AP %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|PDEBUG
c_func
(paren
l_string|&quot;return value from send_to_AP: %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dv
)paren
(brace
r_case
id|DEV_GONE
suffix:colon
id|PDEBUG
c_func
(paren
l_string|&quot;dev %d not available&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
id|rv
op_assign
id|SEN_NOT_AVAIL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_ONLINE
suffix:colon
id|rv
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_EMPTY
suffix:colon
id|rv
op_assign
id|SEN_NOT_AVAIL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_NO_WORK
suffix:colon
id|rv
op_assign
id|SEN_FATAL_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_BAD_MESSAGE
suffix:colon
id|rv
op_assign
id|SEN_USER_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_QUEUE_FULL
suffix:colon
id|rv
op_assign
id|SEN_QUEUE_FULL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINTK
c_func
(paren
l_string|&quot;unknown dv=%d for dev %d&bslash;n&quot;
comma
id|dv
comma
id|index
)paren
suffix:semicolon
id|rv
op_assign
id|SEN_NOT_AVAIL
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rv
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mdelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
id|dv
op_assign
id|receive_from_AP
c_func
(paren
id|index
comma
id|z90crypt.cdx
comma
id|devPtr-&gt;dev_resp_l
comma
id|devPtr-&gt;dev_resp_p
comma
id|psmid
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_string|&quot;dv returned by DQ = %d&bslash;n&quot;
comma
id|dv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dv
op_eq
id|DEV_REC_EXCEPTION
)paren
(brace
id|rv
op_assign
id|REC_FATAL_ERROR
suffix:semicolon
id|PRINTKC
c_func
(paren
l_string|&quot;exception in dequeue %d&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|dv
)paren
(brace
r_case
id|DEV_ONLINE
suffix:colon
id|rv
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_EMPTY
suffix:colon
id|rv
op_assign
id|REC_EMPTY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_NO_WORK
suffix:colon
id|rv
op_assign
id|REC_NO_WORK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_BAD_MESSAGE
suffix:colon
r_case
id|DEV_GONE
suffix:colon
r_default
suffix:colon
id|rv
op_assign
id|REC_NO_RESPONSE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rv
op_ne
l_int|0
)paren
op_logical_and
(paren
id|rv
op_ne
id|REC_NO_WORK
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rv
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rv
)paren
r_break
suffix:semicolon
id|rv
op_assign
(paren
id|devPtr-&gt;dev_resp_p
(braket
l_int|0
)braket
op_eq
l_int|0x00
)paren
op_logical_and
(paren
id|devPtr-&gt;dev_resp_p
(braket
l_int|1
)braket
op_eq
l_int|0x86
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
id|devPtr-&gt;dev_type
op_assign
id|PCICC
suffix:semicolon
r_else
id|devPtr-&gt;dev_type
op_assign
id|PCICA
suffix:semicolon
id|rv
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* In a general error case, the card is not marked online */
r_return
id|rv
suffix:semicolon
)brace
macro_line|#ifdef Z90CRYPT_USE_HOTPLUG
r_void
DECL|function|z90crypt_hotplug_event
id|z90crypt_hotplug_event
c_func
(paren
r_int
id|dev_major
comma
r_int
id|dev_minor
comma
r_int
id|action
)paren
(brace
macro_line|#ifdef CONFIG_HOTPLUG
r_char
op_star
id|argv
(braket
l_int|3
)braket
suffix:semicolon
r_char
op_star
id|envp
(braket
l_int|6
)braket
suffix:semicolon
r_char
id|major
(braket
l_int|20
)braket
suffix:semicolon
r_char
id|minor
(braket
l_int|20
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|major
comma
l_string|&quot;MAJOR=%d&quot;
comma
id|dev_major
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|minor
comma
l_string|&quot;MINOR=%d&quot;
comma
id|dev_minor
)paren
suffix:semicolon
id|argv
(braket
l_int|0
)braket
op_assign
id|hotplug_path
suffix:semicolon
id|argv
(braket
l_int|1
)braket
op_assign
l_string|&quot;z90crypt&quot;
suffix:semicolon
id|argv
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
id|envp
(braket
l_int|0
)braket
op_assign
l_string|&quot;HOME=/&quot;
suffix:semicolon
id|envp
(braket
l_int|1
)braket
op_assign
l_string|&quot;PATH=/sbin:/bin:/usr/sbin:/usr/bin&quot;
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|Z90CRYPT_HOTPLUG_ADD
suffix:colon
id|envp
(braket
l_int|2
)braket
op_assign
l_string|&quot;ACTION=add&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Z90CRYPT_HOTPLUG_REMOVE
suffix:colon
id|envp
(braket
l_int|2
)braket
op_assign
l_string|&quot;ACTION=remove&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|envp
(braket
l_int|3
)braket
op_assign
id|major
suffix:semicolon
id|envp
(braket
l_int|4
)braket
op_assign
id|minor
suffix:semicolon
id|envp
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|call_usermodehelper
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
id|argv
comma
id|envp
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
DECL|variable|z90crypt_init_module
id|module_init
c_func
(paren
id|z90crypt_init_module
)paren
suffix:semicolon
DECL|variable|z90crypt_cleanup_module
id|module_exit
c_func
(paren
id|z90crypt_cleanup_module
)paren
suffix:semicolon
eof
