multiline_comment|/**&n; * $Id: fsm.c,v 1.6 2003/10/15 11:37:29 mschwide Exp $&n; *&n; * A generic FSM based on fsm used in isdn4linux&n; *&n; */
macro_line|#include &quot;fsm.h&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;(C) 2000 IBM Corp. by Fritz Elfert (felfert@millenux.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Finite state machine helper functions&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|fsm_instance
op_star
DECL|function|init_fsm
id|init_fsm
c_func
(paren
r_char
op_star
id|name
comma
r_const
r_char
op_star
op_star
id|state_names
comma
r_const
r_char
op_star
op_star
id|event_names
comma
r_int
id|nr_states
comma
r_int
id|nr_events
comma
r_const
id|fsm_node
op_star
id|tmpl
comma
r_int
id|tmpl_len
comma
r_int
id|order
)paren
(brace
r_int
id|i
suffix:semicolon
id|fsm_instance
op_star
id|this
suffix:semicolon
id|fsm_function_t
op_star
id|m
suffix:semicolon
id|fsm
op_star
id|f
suffix:semicolon
id|this
op_assign
(paren
id|fsm_instance
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|fsm_instance
)paren
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|this
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;fsm(%s): init_fsm: Couldn&squot;t alloc instance&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|this
comma
l_int|0
comma
r_sizeof
(paren
id|fsm_instance
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|this-&gt;name
comma
id|name
comma
r_sizeof
(paren
id|this-&gt;name
)paren
)paren
suffix:semicolon
id|f
op_assign
(paren
id|fsm
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|fsm
)paren
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;fsm(%s): init_fsm: Couldn&squot;t alloc fsm&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|kfree_fsm
c_func
(paren
id|this
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|f
comma
l_int|0
comma
r_sizeof
(paren
id|fsm
)paren
)paren
suffix:semicolon
id|f-&gt;nr_events
op_assign
id|nr_events
suffix:semicolon
id|f-&gt;nr_states
op_assign
id|nr_states
suffix:semicolon
id|f-&gt;event_names
op_assign
id|event_names
suffix:semicolon
id|f-&gt;state_names
op_assign
id|state_names
suffix:semicolon
id|this-&gt;f
op_assign
id|f
suffix:semicolon
id|m
op_assign
(paren
id|fsm_function_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|fsm_function_t
)paren
op_star
id|nr_states
op_star
id|nr_events
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;fsm(%s): init_fsm: Couldn&squot;t alloc jumptable&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|kfree_fsm
c_func
(paren
id|this
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|m
comma
l_int|0
comma
r_sizeof
(paren
id|fsm_function_t
)paren
op_star
id|f-&gt;nr_states
op_star
id|f-&gt;nr_events
)paren
suffix:semicolon
id|f-&gt;jumpmatrix
op_assign
id|m
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tmpl_len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmpl
(braket
id|i
)braket
dot
id|cond_state
op_ge
id|nr_states
)paren
op_logical_or
(paren
id|tmpl
(braket
id|i
)braket
dot
id|cond_event
op_ge
id|nr_events
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;fsm(%s): init_fsm: Bad template l=%d st(%ld/%ld) ev(%ld/%ld)&bslash;n&quot;
comma
id|name
comma
id|i
comma
(paren
r_int
)paren
id|tmpl
(braket
id|i
)braket
dot
id|cond_state
comma
(paren
r_int
)paren
id|f-&gt;nr_states
comma
(paren
r_int
)paren
id|tmpl
(braket
id|i
)braket
dot
id|cond_event
comma
(paren
r_int
)paren
id|f-&gt;nr_events
)paren
suffix:semicolon
id|kfree_fsm
c_func
(paren
id|this
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
id|m
(braket
id|nr_states
op_star
id|tmpl
(braket
id|i
)braket
dot
id|cond_event
op_plus
id|tmpl
(braket
id|i
)braket
dot
id|cond_state
)braket
op_assign
id|tmpl
(braket
id|i
)braket
dot
id|function
suffix:semicolon
)brace
r_return
id|this
suffix:semicolon
)brace
r_void
DECL|function|kfree_fsm
id|kfree_fsm
c_func
(paren
id|fsm_instance
op_star
id|this
)paren
(brace
r_if
c_cond
(paren
id|this
)paren
(brace
r_if
c_cond
(paren
id|this-&gt;f
)paren
(brace
r_if
c_cond
(paren
id|this-&gt;f-&gt;jumpmatrix
)paren
id|kfree
c_func
(paren
id|this-&gt;f-&gt;jumpmatrix
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|this-&gt;f
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|this
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;fsm: kfree_fsm called with NULL argument&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if FSM_DEBUG_HISTORY
r_void
DECL|function|fsm_print_history
id|fsm_print_history
c_func
(paren
id|fsm_instance
op_star
id|fi
)paren
(brace
r_int
id|idx
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;history_size
op_ge
id|FSM_HISTORY_SIZE
)paren
id|idx
op_assign
id|fi-&gt;history_index
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fsm(%s): History:&bslash;n&quot;
comma
id|fi-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fi-&gt;history_size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|e
op_assign
id|fi-&gt;history
(braket
id|idx
)braket
dot
id|event
suffix:semicolon
r_int
id|s
op_assign
id|fi-&gt;history
(braket
id|idx
op_increment
)braket
dot
id|state
suffix:semicolon
id|idx
op_mod_assign
id|FSM_HISTORY_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|e
op_eq
op_minus
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  S=%s&bslash;n&quot;
comma
id|fi-&gt;f-&gt;state_names
(braket
id|s
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;  S=%s E=%s&bslash;n&quot;
comma
id|fi-&gt;f-&gt;state_names
(braket
id|s
)braket
comma
id|fi-&gt;f-&gt;event_names
(braket
id|e
)braket
)paren
suffix:semicolon
)brace
id|fi-&gt;history_size
op_assign
id|fi-&gt;history_index
op_assign
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|fsm_record_history
id|fsm_record_history
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|state
comma
r_int
id|event
)paren
(brace
id|fi-&gt;history
(braket
id|fi-&gt;history_index
)braket
dot
id|state
op_assign
id|state
suffix:semicolon
id|fi-&gt;history
(braket
id|fi-&gt;history_index
op_increment
)braket
dot
id|event
op_assign
id|event
suffix:semicolon
id|fi-&gt;history_index
op_mod_assign
id|FSM_HISTORY_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|fi-&gt;history_size
OL
id|FSM_HISTORY_SIZE
)paren
id|fi-&gt;history_size
op_increment
suffix:semicolon
)brace
macro_line|#endif
r_const
r_char
op_star
DECL|function|fsm_getstate_str
id|fsm_getstate_str
c_func
(paren
id|fsm_instance
op_star
id|fi
)paren
(brace
r_int
id|st
op_assign
id|atomic_read
c_func
(paren
op_amp
id|fi-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|st
op_ge
id|fi-&gt;f-&gt;nr_states
)paren
r_return
l_string|&quot;Invalid&quot;
suffix:semicolon
r_return
id|fi-&gt;f-&gt;state_names
(braket
id|st
)braket
suffix:semicolon
)brace
r_static
r_void
DECL|function|fsm_expire_timer
id|fsm_expire_timer
c_func
(paren
id|fsm_timer
op_star
id|this
)paren
(brace
macro_line|#if FSM_TIMER_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fsm(%s): Timer %p expired&bslash;n&quot;
comma
id|this-&gt;fi-&gt;name
comma
id|this
)paren
suffix:semicolon
macro_line|#endif
id|fsm_event
c_func
(paren
id|this-&gt;fi
comma
id|this-&gt;expire_event
comma
id|this-&gt;event_arg
)paren
suffix:semicolon
)brace
r_void
DECL|function|fsm_settimer
id|fsm_settimer
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
id|fsm_timer
op_star
id|this
)paren
(brace
id|this-&gt;fi
op_assign
id|fi
suffix:semicolon
id|this-&gt;tl.function
op_assign
(paren
r_void
op_star
)paren
id|fsm_expire_timer
suffix:semicolon
id|this-&gt;tl.data
op_assign
(paren
r_int
)paren
id|this
suffix:semicolon
macro_line|#if FSM_TIMER_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fsm(%s): Create timer %p&bslash;n&quot;
comma
id|fi-&gt;name
comma
id|this
)paren
suffix:semicolon
macro_line|#endif
id|init_timer
c_func
(paren
op_amp
id|this-&gt;tl
)paren
suffix:semicolon
)brace
r_void
DECL|function|fsm_deltimer
id|fsm_deltimer
c_func
(paren
id|fsm_timer
op_star
id|this
)paren
(brace
macro_line|#if FSM_TIMER_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fsm(%s): Delete timer %p&bslash;n&quot;
comma
id|this-&gt;fi-&gt;name
comma
id|this
)paren
suffix:semicolon
macro_line|#endif
id|del_timer
c_func
(paren
op_amp
id|this-&gt;tl
)paren
suffix:semicolon
)brace
r_int
DECL|function|fsm_addtimer
id|fsm_addtimer
c_func
(paren
id|fsm_timer
op_star
id|this
comma
r_int
id|millisec
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
macro_line|#if FSM_TIMER_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fsm(%s): Add timer %p %dms&bslash;n&quot;
comma
id|this-&gt;fi-&gt;name
comma
id|this
comma
id|millisec
)paren
suffix:semicolon
macro_line|#endif
id|init_timer
c_func
(paren
op_amp
id|this-&gt;tl
)paren
suffix:semicolon
id|this-&gt;tl.function
op_assign
(paren
r_void
op_star
)paren
id|fsm_expire_timer
suffix:semicolon
id|this-&gt;tl.data
op_assign
(paren
r_int
)paren
id|this
suffix:semicolon
id|this-&gt;expire_event
op_assign
id|event
suffix:semicolon
id|this-&gt;event_arg
op_assign
id|arg
suffix:semicolon
id|this-&gt;tl.expires
op_assign
id|jiffies
op_plus
(paren
id|millisec
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|this-&gt;tl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME: this function is never used, why */
r_void
DECL|function|fsm_modtimer
id|fsm_modtimer
c_func
(paren
id|fsm_timer
op_star
id|this
comma
r_int
id|millisec
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
macro_line|#if FSM_TIMER_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fsm(%s): Restart timer %p %dms&bslash;n&quot;
comma
id|this-&gt;fi-&gt;name
comma
id|this
comma
id|millisec
)paren
suffix:semicolon
macro_line|#endif
id|del_timer
c_func
(paren
op_amp
id|this-&gt;tl
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|this-&gt;tl
)paren
suffix:semicolon
id|this-&gt;tl.function
op_assign
(paren
r_void
op_star
)paren
id|fsm_expire_timer
suffix:semicolon
id|this-&gt;tl.data
op_assign
(paren
r_int
)paren
id|this
suffix:semicolon
id|this-&gt;expire_event
op_assign
id|event
suffix:semicolon
id|this-&gt;event_arg
op_assign
id|arg
suffix:semicolon
id|this-&gt;tl.expires
op_assign
id|jiffies
op_plus
(paren
id|millisec
op_star
id|HZ
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|this-&gt;tl
)paren
suffix:semicolon
)brace
DECL|variable|init_fsm
id|EXPORT_SYMBOL
c_func
(paren
id|init_fsm
)paren
suffix:semicolon
DECL|variable|kfree_fsm
id|EXPORT_SYMBOL
c_func
(paren
id|kfree_fsm
)paren
suffix:semicolon
DECL|variable|fsm_settimer
id|EXPORT_SYMBOL
c_func
(paren
id|fsm_settimer
)paren
suffix:semicolon
DECL|variable|fsm_deltimer
id|EXPORT_SYMBOL
c_func
(paren
id|fsm_deltimer
)paren
suffix:semicolon
DECL|variable|fsm_addtimer
id|EXPORT_SYMBOL
c_func
(paren
id|fsm_addtimer
)paren
suffix:semicolon
DECL|variable|fsm_modtimer
id|EXPORT_SYMBOL
c_func
(paren
id|fsm_modtimer
)paren
suffix:semicolon
DECL|variable|fsm_getstate_str
id|EXPORT_SYMBOL
c_func
(paren
id|fsm_getstate_str
)paren
suffix:semicolon
macro_line|#if FSM_DEBUG_HISTORY
DECL|variable|fsm_print_history
id|EXPORT_SYMBOL
c_func
(paren
id|fsm_print_history
)paren
suffix:semicolon
DECL|variable|fsm_record_history
id|EXPORT_SYMBOL
c_func
(paren
id|fsm_record_history
)paren
suffix:semicolon
macro_line|#endif
eof
