multiline_comment|/*&n; *  drivers/s390/net/iucv.c&n; *    Support for VM IUCV functions for use by other part of the&n; *    kernel or loadable modules.&n; *&n; *  S390 version&n; *    Copyright (C) 2000 IBM Corporation&n; *    Author(s): Xenia Tkatschow (xenia@us.ibm.com)&n; *               Alan Altmark (Alan_Altmark@us.ibm.com)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &quot;iucv.h&quot;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/s390_ext.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
DECL|macro|KERN_DEBUG
macro_line|#undef KERN_DEBUG
DECL|macro|KERN_DEBUG
mdefine_line|#define KERN_DEBUG KERN_EMERG
singleline_comment|//#define DEBUG3
singleline_comment|//#define DEBUG         /* Turns Printk&squot;s on                         */
singleline_comment|//#define DEBUG2        /* This prints the parameter list before and */
multiline_comment|/* after the b2f0 call to cp                 */
DECL|macro|NULL
macro_line|#undef NULL
DECL|macro|NULL
mdefine_line|#define NULL 0
DECL|macro|ADDED_STOR
mdefine_line|#define ADDED_STOR 64&t;&t;/* ADDITIONAL STORAGE FOR PATHID @&squot;S */
DECL|variable|declare_flag
id|ulong
id|declare_flag
op_assign
l_int|0
suffix:semicolon
DECL|variable|iucv_external_int_buffer
r_static
id|uchar
id|iucv_external_int_buffer
(braket
l_int|40
)braket
suffix:semicolon
DECL|variable|short_task
r_struct
id|tq_struct
id|short_task
suffix:semicolon
multiline_comment|/* automatically initialized to zero */
DECL|variable|my_ops
r_static
id|iucv_interrupt_ops_t
id|my_ops
suffix:semicolon
DECL|variable|lock
id|spinlock_t
id|lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_static
r_void
id|do_int
(paren
id|iucv_ConnectionPending
op_star
)paren
suffix:semicolon
multiline_comment|/***************INTERRUPT HANDLING DEFINITIONS***************/
DECL|struct|_iucv_packet
r_typedef
r_struct
id|_iucv_packet
(brace
DECL|member|next
r_struct
id|_iucv_packet
op_star
id|next
suffix:semicolon
DECL|member|data
id|uchar
id|data
(braket
l_int|40
)braket
suffix:semicolon
DECL|typedef|iucv_packet
)brace
id|iucv_packet
suffix:semicolon
DECL|variable|short_task
r_struct
id|tq_struct
id|short_task
suffix:semicolon
DECL|variable|iucv_packets_lock
r_static
id|spinlock_t
id|iucv_packets_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|iucv_packets_head
DECL|variable|iucv_packets_tail
id|iucv_packet
op_star
id|iucv_packets_head
comma
op_star
id|iucv_packets_tail
suffix:semicolon
DECL|variable|bh_scheduled
r_static
id|atomic_t
id|bh_scheduled
op_assign
id|ATOMIC_INIT
(paren
l_int|0
)paren
suffix:semicolon
r_void
id|bottom_half_interrupt
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/************FUNCTION ID&squot;S****************************/
DECL|macro|accept
mdefine_line|#define accept          10
DECL|macro|connect
mdefine_line|#define connect         11
DECL|macro|declare_buffer
mdefine_line|#define declare_buffer  12
DECL|macro|purge
mdefine_line|#define purge           9
DECL|macro|query
mdefine_line|#define query           0
DECL|macro|quiesc
mdefine_line|#define quiesc          13
DECL|macro|receive
mdefine_line|#define receive         5
DECL|macro|reject
mdefine_line|#define reject          8
DECL|macro|reply
mdefine_line|#define reply           6
DECL|macro|resume
mdefine_line|#define resume          14
DECL|macro|retrieve_buffer
mdefine_line|#define retrieve_buffer 2
DECL|macro|send
mdefine_line|#define send            4
DECL|macro|setmask
mdefine_line|#define setmask         16
DECL|macro|sever
mdefine_line|#define sever           15
multiline_comment|/*****************************************************************/
multiline_comment|/*  Structure: handler                                           */
multiline_comment|/*  members: next - is a pointer to next handler on chain        */
multiline_comment|/*           prev - is a pointer to prev handler on chain        */
multiline_comment|/*           vmid - 8 char array of machine identification       */
multiline_comment|/*           user_data - 16 char array for user identification   */
multiline_comment|/*           mask - 24 char array used to compare the 2 previous */
multiline_comment|/*           interrupt_table - functions for interrupts          */
multiline_comment|/*           start - pointer to start of block of pointers to    */
multiline_comment|/*                   handler_table_entries                       */
multiline_comment|/*           end - pointer to end of block of pointers to        */
multiline_comment|/*                 handler_table_entries                         */
multiline_comment|/*           size - ulong, size of block                         */
multiline_comment|/*           pgm_data - ulong, program data                      */
multiline_comment|/* NOTE: Keep vmid and user_data together in this order          */
multiline_comment|/*****************************************************************/
r_typedef
r_struct
(brace
DECL|member|next
id|ulong
op_star
id|next
suffix:semicolon
DECL|member|prev
id|ulong
op_star
id|prev
suffix:semicolon
DECL|member|vmid
id|uchar
id|vmid
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|user_data
id|uchar
id|user_data
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|mask
id|uchar
id|mask
(braket
l_int|24
)braket
suffix:semicolon
DECL|member|interrupt_table
id|iucv_interrupt_ops_t
op_star
id|interrupt_table
suffix:semicolon
DECL|member|start
id|ulong
op_star
id|start
suffix:semicolon
DECL|member|end
id|ulong
op_star
id|end
suffix:semicolon
DECL|member|size
id|ulong
id|size
suffix:semicolon
DECL|member|pgm_data
id|ulong
id|pgm_data
suffix:semicolon
DECL|typedef|handler
)brace
id|handler
suffix:semicolon
multiline_comment|/*******************************************************************/
multiline_comment|/* Structure: handler_table_entry                                  */
multiline_comment|/* members: addrs - pointer to a handler                           */
multiline_comment|/*          pathid - ushort containing path identification         */
multiline_comment|/*          pgm_data - ulong, program data                         */
multiline_comment|/*******************************************************************/
r_typedef
r_struct
(brace
DECL|member|addrs
id|handler
op_star
id|addrs
suffix:semicolon
DECL|member|pathid
id|ushort
id|pathid
suffix:semicolon
DECL|member|pgm_data
id|ulong
id|pgm_data
suffix:semicolon
DECL|typedef|handler_table_entry
)brace
id|handler_table_entry
suffix:semicolon
multiline_comment|/* main_table: array of pointers to handler_tables         */
DECL|variable|main_table
r_static
id|handler_table_entry
op_star
id|main_table
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* handler_anchor: points to first handler on chain        */
DECL|variable|handler_anchor
r_static
id|handler
op_star
id|handler_anchor
suffix:semicolon
multiline_comment|/****************FIVE  STRUCTURES************************************/
multiline_comment|/* Data struct 1: iparml_control                                    */
multiline_comment|/*                Used for iucv_accept                              */
multiline_comment|/*                         iucv_connect                             */
multiline_comment|/*                         iucv_quiesce                             */
multiline_comment|/*                         iucv_resume                              */
multiline_comment|/*                         iucv_sever                               */
multiline_comment|/*                         iucv_retrieve_buffer                     */
multiline_comment|/* Data struct 2: iparml_dpl  (data in parameter list)              */
multiline_comment|/*                Used for iucv_send_prmmsg                         */
multiline_comment|/*                         iucv_send2way_prmmsg                     */
multiline_comment|/*                         iucv_send2way_prmmsg_array               */
multiline_comment|/*                         iucv_reply_prmmsg                        */
multiline_comment|/* Data struct 3: iparml_db    (data in a buffer)                   */
multiline_comment|/*                Used for iucv_receive                             */
multiline_comment|/*                         iucv_receive_array                       */
multiline_comment|/*                         iucv_receive_simple                      */
multiline_comment|/*                         iucv_reject                              */
multiline_comment|/*                         iucv_reply                               */
multiline_comment|/*                         iucv_reply_array                         */
multiline_comment|/*                         iucv_send                                */
multiline_comment|/*                         iucv_send_simple                         */
multiline_comment|/*                         iucv_send_array                          */
multiline_comment|/*                         iucv_send2way                            */
multiline_comment|/*                         iucv_send2way_array                      */
multiline_comment|/*                         iucv_declare_buffer                      */
multiline_comment|/* Data struct 4: iparml_purge                                      */
multiline_comment|/*                Used for iucv_purge                               */
multiline_comment|/*                         iucv_query                               */
multiline_comment|/* Data struct 5: iparml_set_mask                                   */
multiline_comment|/*                Used for iucv_set_mask                            */
multiline_comment|/********************************************************************/
r_typedef
r_struct
(brace
DECL|member|ippathid
id|ushort
id|ippathid
suffix:semicolon
DECL|member|ipflags1
id|uchar
id|ipflags1
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|ipmsglim
id|ushort
id|ipmsglim
suffix:semicolon
DECL|member|res1
id|ushort
id|res1
suffix:semicolon
DECL|member|ipvmid
id|uchar
id|ipvmid
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|ipuser
id|uchar
id|ipuser
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|iptarget
id|uchar
id|iptarget
(braket
l_int|8
)braket
suffix:semicolon
DECL|typedef|iparml_control
)brace
id|iparml_control
suffix:semicolon
multiline_comment|/******************/
r_typedef
r_struct
(brace
DECL|member|ippathid
id|ushort
id|ippathid
suffix:semicolon
DECL|member|ipflags1
id|uchar
id|ipflags1
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|ipmsgid
id|ulong
id|ipmsgid
suffix:semicolon
DECL|member|iptrgcls
id|ulong
id|iptrgcls
suffix:semicolon
DECL|member|iprmmsg
id|uchar
id|iprmmsg
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|ipsrccls
id|ulong
id|ipsrccls
suffix:semicolon
DECL|member|ipmsgtag
id|ulong
id|ipmsgtag
suffix:semicolon
DECL|member|ipbfadr2
id|ulong
id|ipbfadr2
suffix:semicolon
DECL|member|ipbfln2f
id|ulong
id|ipbfln2f
suffix:semicolon
DECL|member|res
id|ulong
id|res
suffix:semicolon
DECL|typedef|iparml_dpl
)brace
id|iparml_dpl
suffix:semicolon
multiline_comment|/*******************/
r_typedef
r_struct
(brace
DECL|member|ippathid
id|ushort
id|ippathid
suffix:semicolon
DECL|member|ipflags1
id|uchar
id|ipflags1
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|ipmsgid
id|ulong
id|ipmsgid
suffix:semicolon
DECL|member|iptrgcls
id|ulong
id|iptrgcls
suffix:semicolon
DECL|member|ipbfadr1
id|ulong
id|ipbfadr1
suffix:semicolon
DECL|member|ipbfln1f
id|ulong
id|ipbfln1f
suffix:semicolon
DECL|member|ipsrccls
id|ulong
id|ipsrccls
suffix:semicolon
DECL|member|ipmsgtag
id|ulong
id|ipmsgtag
suffix:semicolon
DECL|member|ipbfadr2
id|ulong
id|ipbfadr2
suffix:semicolon
DECL|member|ipbfln2f
id|ulong
id|ipbfln2f
suffix:semicolon
DECL|member|res
id|ulong
id|res
suffix:semicolon
DECL|typedef|iparml_db
)brace
id|iparml_db
suffix:semicolon
multiline_comment|/********************/
r_typedef
r_struct
(brace
DECL|member|ippathid
id|ushort
id|ippathid
suffix:semicolon
DECL|member|ipflags1
id|uchar
id|ipflags1
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|ipmsgid
id|ulong
id|ipmsgid
suffix:semicolon
DECL|member|ipaudit
id|uchar
id|ipaudit
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|res1
id|uchar
id|res1
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|res2
id|ulong
id|res2
suffix:semicolon
DECL|member|ipsrccls
id|ulong
id|ipsrccls
suffix:semicolon
DECL|member|ipmsgtag
id|ulong
id|ipmsgtag
suffix:semicolon
DECL|member|res3
id|ulong
id|res3
(braket
l_int|3
)braket
suffix:semicolon
DECL|typedef|iparml_purge
)brace
id|iparml_purge
suffix:semicolon
multiline_comment|/*******************/
r_typedef
r_struct
(brace
DECL|member|ipmask
id|uchar
id|ipmask
suffix:semicolon
DECL|member|res1
id|uchar
id|res1
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|res2
id|ulong
id|res2
(braket
l_int|9
)braket
suffix:semicolon
DECL|typedef|iparml_set_mask
)brace
id|iparml_set_mask
suffix:semicolon
multiline_comment|/*********************INTERNAL FUNCTIONS*****************************/
multiline_comment|/********************************************************************/
multiline_comment|/* Name: b2f0                                                       */
multiline_comment|/* Purpose: this function calls cp to execute iucv commands.        */
multiline_comment|/* Input: code - int, identifier of iucv call to cp.                */
multiline_comment|/*        parm - void *, pointer to 40 byte iparml area passed to cp */
multiline_comment|/* Output: iprcode- return code from iucv call to cp                */
multiline_comment|/********************************************************************/
multiline_comment|/* Assembler code performing iucv call                             */
multiline_comment|/*******************************************************************/
r_inline
id|ulong
DECL|function|b2f0
id|b2f0
(paren
r_int
id|code
comma
r_void
op_star
id|parm
)paren
(brace
id|uchar
op_star
id|iprcode
suffix:semicolon
multiline_comment|/* used to extract iprcode */
macro_line|#ifdef DEBUG2
r_int
id|i
suffix:semicolon
id|uchar
op_star
id|prt_parm
suffix:semicolon
id|prt_parm
op_assign
(paren
id|uchar
op_star
)paren
(paren
id|parm
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;parameter list before b2f0 call&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%02x &quot;
comma
id|prt_parm
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|asm
r_volatile
(paren
l_string|&quot;LRA   1,0(%1)&bslash;n&bslash;t&quot;
l_string|&quot;LR    0,%0&bslash;n&bslash;t&quot;
l_string|&quot;.long 0xb2f01000&quot;
suffix:colon
suffix:colon
l_string|&quot;d&quot;
(paren
id|code
)paren
comma
l_string|&quot;a&quot;
(paren
id|parm
)paren
suffix:colon
l_string|&quot;0&quot;
comma
l_string|&quot;1&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG2
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;parameter list after b2f0 call&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%02x &quot;
comma
id|prt_parm
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|iprcode
op_assign
(paren
id|uchar
op_star
)paren
(paren
id|parm
op_plus
l_int|3
)paren
suffix:semicolon
r_return
(paren
id|ulong
)paren
(paren
op_star
id|iprcode
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_retrieve_buffer                                 */
multiline_comment|/* Purpose: terminates all use of iucv                        */
multiline_comment|/* Input: void                                                */
multiline_comment|/* Output: Return code from CP                                */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_retrieve_buffer
id|iucv_retrieve_buffer
(paren
r_void
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_retrieve_buffer&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|retrieve_buffer
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
op_eq
l_int|NULL
)paren
id|declare_flag
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_retrieve_buffer&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_declare_buffer                                  */
multiline_comment|/* Purpose: specifies the guests real address of an external  */
multiline_comment|/*          interrupt.                                        */
multiline_comment|/* Input: bfr - pointer to  buffer                            */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/* Note : See output options for b2f0 call                    */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_declare_buffer
id|iucv_declare_buffer
(paren
id|uchar
op_star
id|bfr
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Entering iucv_declare_buffer&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipbfadr1
op_assign
id|virt_to_phys
(paren
id|bfr
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|declare_buffer
comma
op_amp
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Address of EIB = %p&bslash;n&quot;
comma
id|bfr
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Exiting iucv_declare_buffer&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: add_pathid                                           */
multiline_comment|/* Purpose: adds a path id to the system                      */
multiline_comment|/* Input: pathid - ushort, pathid to enter system             */
multiline_comment|/*        handle - iucv_handle_t, address of handler to add to */
multiline_comment|/*        pgm_data - ulong, pathid identifier.                */
multiline_comment|/* Output: 0: successful addition of pathid                   */
multiline_comment|/**************************************************************/
r_int
DECL|function|add_pathid
id|add_pathid
(paren
id|ushort
id|pathid
comma
id|iucv_handle_t
id|handle
comma
id|ulong
id|pgm_data
)paren
(brace
id|ulong
id|index1
comma
id|index2
suffix:semicolon
multiline_comment|/* index1 into main_table */
id|ulong
id|add_flag
op_assign
l_int|0
suffix:semicolon
id|ulong
id|old_size
op_assign
l_int|0
comma
id|new_size
op_assign
l_int|0
suffix:semicolon
id|uchar
op_star
id|to
comma
op_star
id|from
suffix:semicolon
multiline_comment|/* pointer for copying the table */
id|handler_table_entry
op_star
id|P
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*P is a pointer to H_T_E */
id|handler
op_star
id|Q
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*Q is a pointer to handler */
id|ulong
op_star
id|X
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*Points to array of pointers */
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering add_pathid&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|Q
op_assign
(paren
id|handler
op_star
)paren
id|handle
suffix:semicolon
multiline_comment|/* Q points to a handler    */
multiline_comment|/*&n;&t; * main_table has 128 entries.&n;&t; * 128*512 = 65536 maximum number of pathid&squot;s allowed&n;&t; */
id|index1
op_assign
(paren
(paren
id|ulong
)paren
id|pathid
)paren
op_div
l_int|512
suffix:semicolon
id|index2
op_assign
(paren
(paren
id|ulong
)paren
id|pathid
)paren
op_mod
l_int|512
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;index1 = %d&bslash;n &quot;
comma
(paren
r_int
)paren
id|index1
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;index2 = %d&bslash;n &quot;
comma
(paren
r_int
)paren
id|index2
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Q is pointing to %p &quot;
comma
id|Q
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If NULL then handler table does not exist and need to get storage&n;&t; *  and have main_table[index1] point to it&n;&t; * If allocating storage failed, return&n;&t; */
r_if
c_cond
(paren
id|main_table
(braket
id|index1
)braket
op_eq
l_int|NULL
)paren
(brace
id|main_table
(braket
id|index1
)braket
op_assign
(paren
id|handler_table_entry
op_star
)paren
id|kmalloc
(paren
l_int|512
op_star
r_sizeof
(paren
id|handler_table_entry
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|main_table
(braket
id|index1
)braket
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
(paren
id|main_table
(braket
id|index1
)braket
comma
l_int|0
comma
l_int|512
op_star
r_sizeof
(paren
id|handler_table_entry
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;address of table H_T is %p &bslash;n&quot;
comma
id|main_table
(braket
id|index1
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;&t; * P points to a handler table entry (H_T_E) in which all entries in&n;&t; * that structure should be NULL. If they&squot;re not NULL, then there&n;&t; * is a bad pointer and it will return(-2) immediately, otherwise&n;&t; * data will be entered into H_T_E.&n;&t; */
id|P
op_assign
id|main_table
(braket
id|index1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|addrs
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;main_table[index1] = %p &bslash;n&quot;
comma
id|main_table
(braket
id|index1
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;P+index2 = %p &bslash;n&quot;
comma
id|P
op_plus
id|index2
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;(P+index2)-&gt;addrs is %p &bslash;n&quot;
comma
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|addrs
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;bad pointer1&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|addrs
op_assign
id|handle
suffix:semicolon
multiline_comment|/*&n;&t; * checking if address of handle is valid, if it&squot;s not valid,&n;&t; * unlock the lock and return(-2) immediately.&n;&t; */
r_if
c_cond
(paren
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|addrs
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;bad pointer2&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pathid
op_assign
id|pathid
suffix:semicolon
r_if
c_cond
(paren
id|pgm_data
)paren
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
op_assign
id|pgm_data
suffix:semicolon
r_else
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
op_assign
id|Q-&gt;pgm_data
suffix:semicolon
multiline_comment|/*&n;&t; * Step thru the table of addresses of pathid&squot;s to find the first&n;&t; * available entry (NULL). If an entry is found, add the pathid,&n;&t; * unlock and exit. If an available entry is not found, allocate a&n;&t; * new, larger table, copy over the old table and deallocate the&n;&t; * old table and add the pathid.&n;&t; */
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;address of handle is %p&bslash;n&quot;
comma
id|handle
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&amp;(Q-&gt;start) is %p&bslash;n&quot;
comma
op_amp
(paren
id|Q-&gt;start
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&amp;(Q-&gt;end) is %p&bslash;n&quot;
comma
op_amp
(paren
id|Q-&gt;end
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;start of pathid table is %p&bslash;n&quot;
comma
(paren
id|Q-&gt;start
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;end of pathid table is %p&bslash;n&quot;
comma
(paren
id|Q-&gt;end
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|X
op_assign
(paren
id|Q-&gt;start
)paren
suffix:semicolon
id|X
OL
(paren
id|Q-&gt;end
)paren
suffix:semicolon
id|X
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;X = %p &quot;
comma
id|X
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|X
op_assign
(paren
id|Q-&gt;start
)paren
suffix:semicolon
id|X
OL
(paren
id|Q-&gt;end
)paren
suffix:semicolon
id|X
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|X
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;adding pathid, %p = P+index2&bslash;n&quot;
comma
(paren
id|P
op_plus
id|index2
)paren
)paren
suffix:semicolon
macro_line|#endif
op_star
id|X
op_assign
(paren
id|ulong
)paren
(paren
id|P
op_plus
id|index2
)paren
suffix:semicolon
id|add_flag
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|add_flag
op_eq
l_int|1
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|add_flag
op_eq
l_int|0
)paren
(brace
multiline_comment|/* element not added to list */
id|X
op_assign
id|Q-&gt;start
suffix:semicolon
id|old_size
op_assign
id|Q-&gt;size
suffix:semicolon
id|new_size
op_assign
id|old_size
op_plus
id|ADDED_STOR
suffix:semicolon
multiline_comment|/* size of new table */
id|from
op_assign
(paren
id|uchar
op_star
)paren
(paren
id|Q-&gt;start
)paren
suffix:semicolon
multiline_comment|/* address of old table */
id|Q.start
op_assign
id|kmalloc
(paren
id|new_size
op_star
r_sizeof
(paren
id|ulong
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|Q-&gt;start
)paren
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
(paren
id|Q.start
comma
l_int|0
comma
id|new_size
op_star
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
id|to
op_assign
(paren
id|uchar
op_star
)paren
(paren
id|Q-&gt;start
)paren
suffix:semicolon
multiline_comment|/* address of new table */
multiline_comment|/* copy old table to new  */
id|memcpy
(paren
id|to
comma
id|from
comma
id|old_size
op_star
(paren
r_sizeof
(paren
id|ulong
)paren
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Getting a new pathid table&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;to is %p &bslash;n&quot;
comma
id|to
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;from is %p &bslash;n&quot;
comma
id|from
)paren
suffix:semicolon
macro_line|#endif
id|Q-&gt;size
op_assign
id|new_size
suffix:semicolon
multiline_comment|/* storing new size of table */
id|Q-&gt;end
op_assign
(paren
id|Q-&gt;start
)paren
op_plus
(paren
id|Q-&gt;size
)paren
suffix:semicolon
id|X
op_assign
id|Q-&gt;start
op_plus
id|old_size
suffix:semicolon
multiline_comment|/* next blank in table */
op_star
id|X
op_assign
(paren
id|ulong
)paren
(paren
id|P
op_plus
id|index2
)paren
suffix:semicolon
multiline_comment|/* adding element to new table */
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Q-&gt;size is %u &bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|Q-&gt;size
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Q-&gt;end is %p &bslash;n&quot;
comma
id|Q-&gt;end
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Q-&gt;start is %p &bslash;n&quot;
comma
id|Q-&gt;start
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;X is %p &bslash;n&quot;
comma
id|X
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;*X is %u &bslash;n&quot;
comma
(paren
r_int
)paren
(paren
op_star
id|X
)paren
)paren
suffix:semicolon
macro_line|#endif
id|kfree
(paren
id|from
)paren
suffix:semicolon
multiline_comment|/* free old table */
)brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting add_pathid&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* end of add_pathid function */
multiline_comment|/***********************EXTERNAL FUNCTIONS***************************/
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_query                                           */
multiline_comment|/* Purpose: determines how large an external interrupt buffer */
multiline_comment|/*          IUCV requires to store information                */
multiline_comment|/* Input : bufsize - ulong: size of interrupt buffer          */
multiline_comment|/*         - filled in by function and returned to caller     */
multiline_comment|/*         conmax  - ulong: maximum number of connections that */
multiline_comment|/*           can be outstanding for this VM                   */
multiline_comment|/*         - filled in by function and returned to caller     */
multiline_comment|/* Output: void                                               */
multiline_comment|/**************************************************************/
r_void
DECL|function|iucv_query
id|iucv_query
(paren
id|ulong
op_star
id|bufsize
comma
id|ulong
op_star
id|conmax
)paren
(brace
id|iparml_purge
id|parm
suffix:semicolon
multiline_comment|/* DOESN&squot;T MATTER WHICH IPARML IS USED    */
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_purge&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Assembler instruction calling b2f0  and storing R0 and R1&n;&t; */
id|asm
r_volatile
(paren
l_string|&quot;LRA   1,0(%3)&bslash;n&bslash;t&quot;
l_string|&quot;LR    0,%2&bslash;n&bslash;t&quot;
l_string|&quot;.long 0xb2f01000&bslash;n&bslash;t&quot;
l_string|&quot;ST    0,%0&bslash;n&bslash;t&quot;
l_string|&quot;ST    1,%1&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
op_star
id|bufsize
)paren
comma
l_string|&quot;=m&quot;
(paren
op_star
id|conmax
)paren
suffix:colon
l_string|&quot;d&quot;
(paren
id|query
)paren
comma
l_string|&quot;a&quot;
(paren
op_amp
id|parm
)paren
suffix:colon
l_string|&quot;0&quot;
comma
l_string|&quot;1&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_purge                                           */
multiline_comment|/* Purpose: cancels a message you have sent                   */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong, mid of message                      */
multiline_comment|/*        srccls - ulong, sourse message class                */
multiline_comment|/*        audit  - uchar[4], info about ansync. error condit. */
multiline_comment|/*                 filled in by function and passed back      */
multiline_comment|/* Output: void                                               */
multiline_comment|/* NOTE: pathid is required, flag is always turned on         */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_purge
id|iucv_purge
(paren
id|ulong
id|msgid
comma
id|ushort
id|pathid
comma
id|ulong
id|srccls
comma
id|uchar
id|audit
(braket
l_int|4
)braket
)paren
(brace
id|iparml_purge
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_purge&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|specify_pathid
suffix:semicolon
multiline_comment|/* pathid id flag */
r_if
c_cond
(paren
id|parm.ipmsgid
)paren
id|parm.ipflags1
op_or_assign
id|specify_msgid
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipsrccls
)paren
id|parm.ipflags1
op_or_assign
id|source_class
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|purge
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
op_ne
l_int|NULL
)paren
r_return
id|b2f0_result
suffix:semicolon
id|memcpy
(paren
id|audit
comma
id|parm.ipaudit
comma
l_int|4
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_purge&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_quiesce                                         */
multiline_comment|/* Purpose: temporarily suspends incoming messages            */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        user_data - uchar[16], user id                      */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/* NOTE: see b2f0 output list                                 */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_quiesce
id|iucv_quiesce
(paren
id|ushort
id|pathid
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_quiesce&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
l_int|16
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|quiesc
comma
op_amp
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_quiesce&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_resume                                          */
multiline_comment|/* Purpose: restores communication over a quiesced path       */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        user_data - uchar[16], user id                      */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/* NOTE: see b2f0 output list                                 */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_resume
id|iucv_resume
(paren
id|ushort
id|pathid
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_resume&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
l_int|16
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|resume
comma
op_amp
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_resume&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_reject                                          */
multiline_comment|/* Purpose: rejects a message                                 */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong, mid of message                      */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/* NOTE: pathid is required field, flag always turned on      */
multiline_comment|/*       RESTRICTION: target class cannot be zero             */
multiline_comment|/* NOTE: see b2f0 output list                                 */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_reject
id|iucv_reject
(paren
id|ushort
id|pathid
comma
id|ulong
id|msgid
comma
id|ulong
id|trgcls
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_reject&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|specify_pathid
suffix:semicolon
multiline_comment|/* flag for pathid */
r_if
c_cond
(paren
id|parm.ipmsgid
)paren
id|parm.ipflags1
op_or_assign
id|specify_msgid
suffix:semicolon
r_if
c_cond
(paren
id|parm.iptrgcls
)paren
id|parm.ipflags1
op_or_assign
id|target_class
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|reject
comma
op_amp
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_reject&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_setmask                                         */
multiline_comment|/* Purpose: enables or disables certain iucv external interr. */
multiline_comment|/* Input: non_priority_interrupts - uchar                     */
multiline_comment|/*        priority_interrupts - uchar                         */
multiline_comment|/*        non_priority_completion_interrupts - uchar          */
multiline_comment|/*        priority_completion_interrupts) - uchar             */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/* NOTE: see b2f0 output list                                 */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_setmask
id|iucv_setmask
(paren
id|uchar
id|non_priority_interrupts
comma
id|uchar
id|priority_interrupts
comma
id|uchar
id|non_priority_completion_interrupts
comma
id|uchar
id|priority_completion_interrupts
)paren
(brace
id|iparml_set_mask
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_setmask&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|non_priority_interrupts
)paren
id|parm.ipmask
op_or_assign
l_int|0x80
suffix:semicolon
r_if
c_cond
(paren
id|priority_interrupts
)paren
id|parm.ipmask
op_or_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|non_priority_completion_interrupts
)paren
id|parm.ipmask
op_or_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|priority_completion_interrupts
)paren
id|parm.ipmask
op_or_assign
l_int|0x10
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|setmask
comma
op_amp
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_setmask&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_sever                                           */
multiline_comment|/* Purpose: terminates an iucv path to another machine        */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        user_data - uchar[16], user id                      */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/* NOTE: see b2f0 output list                                 */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_sever
id|iucv_sever
(paren
id|ushort
id|pathid
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
)paren
(brace
id|ulong
id|index1
comma
id|index2
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|handler_table_entry
op_star
id|P
op_assign
l_int|0
suffix:semicolon
id|handler
op_star
id|Q
op_assign
l_int|0
suffix:semicolon
id|ulong
op_star
id|X
suffix:semicolon
id|iparml_control
id|parm
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_sever&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
l_int|16
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|sever
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
)paren
r_return
id|b2f0_result
suffix:semicolon
id|index1
op_assign
(paren
(paren
id|ulong
)paren
id|pathid
)paren
op_div
l_int|512
suffix:semicolon
id|index2
op_assign
(paren
(paren
id|ulong
)paren
id|pathid
)paren
op_mod
l_int|512
suffix:semicolon
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
id|P
op_assign
id|main_table
(braket
id|index1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|addrs
)paren
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* called from interrupt code */
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* bad pointer */
)brace
id|Q
op_assign
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|addrs
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;pathid is %d&bslash;n&quot;
comma
id|pathid
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;index1 is %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|index1
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;index2 is %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|index2
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;H_T_E is %p&bslash;n&quot;
comma
id|P
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;address of handler is %p&bslash;n&quot;
comma
id|Q
)paren
suffix:semicolon
r_for
c_loop
(paren
id|X
op_assign
(paren
id|Q.start
)paren
suffix:semicolon
id|X
OL
(paren
id|Q.end
)paren
suffix:semicolon
id|X
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; %x &quot;
comma
(paren
r_int
)paren
(paren
op_star
id|X
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n above is pathid table&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/********************************************************************/
multiline_comment|/* Searching the pathid address table for matching address, once    */
multiline_comment|/* found, NULL the field. Then Null the H_T_E fields.               */
multiline_comment|/********************************************************************/
r_for
c_loop
(paren
id|X
op_assign
(paren
id|Q.start
)paren
suffix:semicolon
id|X
OL
(paren
id|Q.end
)paren
suffix:semicolon
id|X
op_increment
)paren
r_if
c_cond
(paren
op_star
id|X
op_eq
(paren
id|ulong
)paren
(paren
id|P
op_plus
id|index2
)paren
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;found a path to sever&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;severing %d &bslash;n&quot;
comma
(paren
r_int
)paren
(paren
op_star
id|X
)paren
)paren
suffix:semicolon
macro_line|#endif
op_star
id|X
op_assign
l_int|NULL
suffix:semicolon
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|addrs
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*clearing the fields */
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pathid
op_assign
l_int|0
suffix:semicolon
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_sever&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_receive                                         */
multiline_comment|/* Purpose: receives incoming message                         */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - *ulong, mid of message                     */
multiline_comment|/*        trgcls - *ulong, target message class               */
multiline_comment|/*        buffer - pointer of buffer                          */
multiline_comment|/*        buflen - length of buffer                           */
multiline_comment|/*        adds_curr_buffer - pointer to updated buffer address*/
multiline_comment|/*                           to write to                      */
multiline_comment|/*        adds_curr_length - pointer to updated length in     */
multiline_comment|/*                           buffer available to write to     */
multiline_comment|/*        reply_required - uchar *, flag                      */
multiline_comment|/*        priority_msg - uchar *, flag                        */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/* NOTE: pathid must be specified, flag being turned on       */
multiline_comment|/* RESTRICTIONS: target class CANNOT be zero because the code */
multiline_comment|/* checks for a non-NULL value to turn flag on, therefore if  */
multiline_comment|/* target class = zero, flag will not be turned on.           */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_receive
id|iucv_receive
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
op_star
id|trgcls
comma
r_void
op_star
id|buffer
comma
id|ulong
id|buflen
comma
id|uchar
op_star
id|reply_required
comma
id|uchar
op_star
id|priority_msg
comma
id|ulong
op_star
id|adds_curr_buffer
comma
id|ulong
op_star
id|adds_curr_length
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_receive&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipmsgid
op_assign
op_star
id|msgid
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
op_star
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|specify_pathid
suffix:semicolon
multiline_comment|/* turning pathid flag */
r_if
c_cond
(paren
id|parm.ipmsgid
)paren
id|parm.ipflags1
op_or_assign
l_int|0x05
suffix:semicolon
r_if
c_cond
(paren
id|parm.iptrgcls
)paren
id|parm.ipflags1
op_or_assign
id|target_class
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln1f
op_assign
id|buflen
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|receive
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
)paren
r_return
id|b2f0_result
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
r_if
c_cond
(paren
id|trgcls
)paren
op_star
id|trgcls
op_assign
id|parm.iptrgcls
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipflags1
op_amp
id|prior_msg
)paren
r_if
c_cond
(paren
id|priority_msg
)paren
op_star
id|priority_msg
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/*yes, priority msg */
r_if
c_cond
(paren
op_logical_neg
(paren
id|parm.ipflags1
op_amp
l_int|0x10
)paren
)paren
multiline_comment|/*&amp; with X&squot;10&squot;     */
r_if
c_cond
(paren
id|reply_required
)paren
op_star
id|reply_required
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/*yes, reply required */
r_if
c_cond
(paren
op_logical_neg
(paren
id|parm.ipflags1
op_amp
id|parm_data
)paren
)paren
(brace
multiline_comment|/*msg not in parmlist */
r_if
c_cond
(paren
id|adds_curr_length
)paren
op_star
id|adds_curr_length
op_assign
id|parm.ipbfln1f
suffix:semicolon
r_if
c_cond
(paren
id|adds_curr_buffer
)paren
op_star
id|adds_curr_buffer
op_assign
id|parm.ipbfadr1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|buflen
)paren
op_ge
l_int|8
)paren
(brace
r_if
c_cond
(paren
id|buffer
)paren
id|memcpy
(paren
(paren
r_char
op_star
)paren
id|buffer
comma
(paren
r_char
op_star
)paren
id|parm.ipbfadr1
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adds_curr_length
)paren
op_star
id|adds_curr_length
op_assign
(paren
(paren
id|buflen
)paren
op_minus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adds_curr_buffer
)paren
op_star
id|adds_curr_buffer
op_assign
(paren
id|ulong
)paren
id|buffer
op_plus
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|parm.iprcode
op_or_assign
l_int|0x05
suffix:semicolon
id|b2f0_result
op_assign
(paren
id|ulong
)paren
id|parm.iprcode
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_receive&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_receive_simple                                  */
multiline_comment|/* Purpose: receives fully-qualified message                  */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong, id of message                       */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        buffer - pointer of buffer                          */
multiline_comment|/*        buflen - length of buffer                           */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_receive_simple
id|iucv_receive_simple
(paren
id|ushort
id|pathid
comma
id|ulong
id|msgid
comma
id|ulong
id|trgcls
comma
r_void
op_star
id|buffer
comma
id|ulong
id|buflen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;entering iucv_receive_simple&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_assign
id|IPFGMID
op_plus
id|IPFGPID
op_plus
id|IPFGMCL
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln1f
op_assign
id|buflen
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|receive
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
)paren
r_return
id|b2f0_result
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipflags1
op_amp
id|IPRMDATA
)paren
(brace
multiline_comment|/*msg in parmlist */
r_if
c_cond
(paren
(paren
id|buflen
)paren
op_ge
l_int|8
)paren
id|memcpy
(paren
(paren
r_char
op_star
)paren
id|buffer
comma
(paren
r_char
op_star
)paren
id|parm.ipbfadr1
comma
l_int|8
)paren
suffix:semicolon
r_else
id|b2f0_result
op_assign
l_int|5
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;exiting iucv_receive_simple&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_receive_array                                   */
multiline_comment|/* Purpose: receives incoming message                         */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  -* ulong, mid of message                     */
multiline_comment|/*        trgcls -* ulong, target message class               */
multiline_comment|/*        buffer - pointer of iucv_array_t                    */
multiline_comment|/*        buflen - ulong , length of buffer                   */
multiline_comment|/*        reply_required - uchar *, flag returned to caller   */
multiline_comment|/*        priority_msg - uchar *, flag returned to caller     */
multiline_comment|/*        adds_curr_buffer - pointer to updated buffer array  */
multiline_comment|/*                   to write to                              */
multiline_comment|/*        adds_curr_length - pointer to updated length in     */
multiline_comment|/*                   buffer available to write to             */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/* NOTE: pathid must be specified, flag being turned on       */
multiline_comment|/* RESTRICTIONS: target class CANNOT be zero because the code */
multiline_comment|/* checks for a non-NULL value to turn flag on, therefore if  */
multiline_comment|/* target class = if target class = zero flag will not be     */
multiline_comment|/* turned on, therefore if target class is specified it cannot */
multiline_comment|/* be zero.                                                   */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_receive_array
id|iucv_receive_array
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
op_star
id|trgcls
comma
id|iucv_array_t
op_star
id|buffer
comma
id|ulong
op_star
id|buflen
comma
id|uchar
op_star
id|reply_required
comma
id|uchar
op_star
id|priority_msg
comma
id|ulong
op_star
id|adds_curr_buffer
comma
id|ulong
op_star
id|adds_curr_length
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_receive_array&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipmsgid
op_assign
op_star
id|msgid
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
op_star
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|array
suffix:semicolon
multiline_comment|/* using an address list  */
id|parm.ipflags1
op_or_assign
id|specify_pathid
suffix:semicolon
multiline_comment|/*turning on pathid flag */
r_if
c_cond
(paren
id|parm.ipmsgid
)paren
id|parm.ipflags1
op_or_assign
l_int|0x05
suffix:semicolon
r_if
c_cond
(paren
id|parm.iptrgcls
)paren
id|parm.ipflags1
op_or_assign
id|target_class
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln1f
op_assign
op_star
id|buflen
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|receive
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
)paren
r_return
id|b2f0_result
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
r_if
c_cond
(paren
id|trgcls
)paren
op_star
id|trgcls
op_assign
id|parm.iptrgcls
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipflags1
op_amp
id|prior_msg
)paren
r_if
c_cond
(paren
id|priority_msg
)paren
op_star
id|priority_msg
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/*yes, priority msg */
r_if
c_cond
(paren
op_logical_neg
(paren
id|parm.ipflags1
op_amp
l_int|0x10
)paren
)paren
multiline_comment|/*&amp; with X&squot;10&squot;     */
r_if
c_cond
(paren
id|reply_required
)paren
op_star
id|reply_required
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/*yes, reply required */
r_if
c_cond
(paren
op_logical_neg
(paren
id|parm.ipflags1
op_amp
id|parm_data
)paren
)paren
(brace
multiline_comment|/*msg not in parmlist */
r_if
c_cond
(paren
id|adds_curr_length
)paren
op_star
id|adds_curr_length
op_assign
id|parm.ipbfln1f
suffix:semicolon
r_if
c_cond
(paren
id|adds_curr_buffer
)paren
op_star
id|adds_curr_buffer
op_assign
id|parm.ipbfadr1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|buffer-&gt;length
)paren
op_ge
l_int|8
)paren
(brace
id|memcpy
(paren
(paren
r_char
op_star
)paren
id|buffer-&gt;address
comma
(paren
r_char
op_star
)paren
id|parm.ipbfadr1
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adds_curr_buffer
)paren
op_star
id|adds_curr_buffer
op_assign
(paren
id|ulong
)paren
(paren
(paren
id|buffer-&gt;address
)paren
op_plus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adds_curr_length
)paren
op_star
id|adds_curr_length
op_assign
(paren
(paren
id|buffer-&gt;length
)paren
op_minus
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|parm.iprcode
op_or_assign
l_int|0x05
suffix:semicolon
id|b2f0_result
op_assign
(paren
id|ulong
)paren
id|parm.iprcode
suffix:semicolon
)brace
)brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_receive&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_send                                            */
multiline_comment|/* Purpose: sends messages                                    */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong *, id of message returned to caller  */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        srccls - ulong, source message class                */
multiline_comment|/*        msgtag - ulong, message tag                         */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        buffer - pointer to buffer                          */
multiline_comment|/*        buflen - ulong, length of buffer                    */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/*         msgid - returns message id                         */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_send
id|iucv_send
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
id|trgcls
comma
id|ulong
id|srccls
comma
id|ulong
id|msgtag
comma
id|uchar
id|priority_msg
comma
r_void
op_star
id|buffer
comma
id|ulong
id|buflen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_send&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln1f
op_assign
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|one_way_msg
suffix:semicolon
multiline_comment|/* one way message */
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|send
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
)paren
r_return
id|b2f0_result
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_send&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_send_array                                      */
multiline_comment|/* Purpose: sends messages in buffer array                    */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong *, id of message returned to caller  */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        srccls - ulong, source message class                */
multiline_comment|/*        msgtag - ulong, message tag                         */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        buffer - pointer to iucv_array_t                    */
multiline_comment|/*        buflen - ulong, length of buffer                    */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/*         msgid - returns message id                         */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_send_array
id|iucv_send_array
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
id|trgcls
comma
id|ulong
id|srccls
comma
id|ulong
id|msgtag
comma
id|uchar
id|priority_msg
comma
id|iucv_array_t
op_star
id|buffer
comma
id|ulong
id|buflen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_send_array&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln1f
op_assign
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|one_way_msg
suffix:semicolon
multiline_comment|/* one way message */
id|parm.ipflags1
op_or_assign
id|array
suffix:semicolon
multiline_comment|/* one way w/ array */
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|send
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_send_array&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_send_prmmsg                                     */
multiline_comment|/* Purpose: sends messages in parameter list                  */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong *, id of message                     */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        srccls - ulong, source message class                */
multiline_comment|/*        msgtag - ulong, message tag                         */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        prmmsg - uchar[8], message being sent               */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/*         msgid - returns message id                         */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_send_prmmsg
id|iucv_send_prmmsg
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
id|trgcls
comma
id|ulong
id|srccls
comma
id|ulong
id|msgtag
comma
id|uchar
id|priority_msg
comma
id|uchar
id|prmmsg
(braket
l_int|8
)braket
)paren
(brace
id|iparml_dpl
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_send_prmmsg&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|parm_data
suffix:semicolon
multiline_comment|/* message in prmlist */
id|parm.ipflags1
op_or_assign
id|one_way_msg
suffix:semicolon
multiline_comment|/* one way message */
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|memcpy
(paren
id|parm.iprmmsg
comma
id|prmmsg
comma
l_int|8
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|send
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_send_prmmsg&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_send2way                                        */
multiline_comment|/* Purpose: sends messages in both directions                 */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong *, id of message                     */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        srccls - ulong, source message class                */
multiline_comment|/*        msgtag - ulong, message tag                         */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        buffer - pointer to buffer                          */
multiline_comment|/*        buflen - ulong, length of buffer                    */
multiline_comment|/*        ansbuf - pointer to buffer on reply                 */
multiline_comment|/*        anslen - length of ansbuf buffer                    */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/*         msgid - returns message id                         */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_send2way
id|iucv_send2way
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
id|trgcls
comma
id|ulong
id|srccls
comma
id|ulong
id|msgtag
comma
id|uchar
id|priority_msg
comma
r_void
op_star
id|buffer
comma
id|ulong
id|buflen
comma
r_void
op_star
id|ansbuf
comma
id|ulong
id|anslen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_send2way&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln1f
op_assign
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipbfadr2
op_assign
(paren
id|ulong
)paren
id|ansbuf
suffix:semicolon
id|parm.ipbfln2f
op_assign
id|anslen
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|send
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_send2way&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_send2way_array                                  */
multiline_comment|/* Purpose: sends messages in both directions in arrays       */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong *, id of message                     */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        srccls - ulong, source message class                */
multiline_comment|/*        msgtag - ulong, message tag                         */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        buffer - pointer to iucv_array_t                    */
multiline_comment|/*        buflen - ulong, length of buffer                    */
multiline_comment|/*        ansbuf - pointer to iucv_array_t on reply           */
multiline_comment|/*        anslen - length of ansbuf buffer                    */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/*         msgid - returns message id                         */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_send2way_array
id|iucv_send2way_array
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
id|trgcls
comma
id|ulong
id|srccls
comma
id|ulong
id|msgtag
comma
id|uchar
id|priority_msg
comma
id|iucv_array_t
op_star
id|buffer
comma
id|ulong
id|buflen
comma
id|iucv_array_t
op_star
id|ansbuf
comma
id|ulong
id|anslen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_send2way_array&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln1f
op_assign
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipbfadr2
op_assign
(paren
id|ulong
)paren
id|ansbuf
suffix:semicolon
id|parm.ipbfln2f
op_assign
id|anslen
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|array
suffix:semicolon
multiline_comment|/* send  w/ array  */
id|parm.ipflags1
op_or_assign
id|reply_array
suffix:semicolon
multiline_comment|/* reply w/ array  */
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|send
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_send2way_array&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_send2way_prmmsg                                 */
multiline_comment|/* Purpose: sends messages in both directions w/parameter lst */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong *, id of message                     */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        srccls - ulong, source message class                */
multiline_comment|/*        msgtag - ulong, message tag                         */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        prmmsg - uchar[8], message being sent in parameter  */
multiline_comment|/*        ansbuf - pointer to buffer                          */
multiline_comment|/*        anslen - length of ansbuf buffer                    */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/*         msgid - returns message id                         */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_send2way_prmmsg
id|iucv_send2way_prmmsg
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
id|trgcls
comma
id|ulong
id|srccls
comma
id|ulong
id|msgtag
comma
id|uchar
id|priority_msg
comma
id|uchar
id|prmmsg
(braket
l_int|8
)braket
comma
r_void
op_star
id|ansbuf
comma
id|ulong
id|anslen
)paren
(brace
id|iparml_dpl
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_send2way_prmmsg&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipbfadr2
op_assign
(paren
id|ulong
)paren
id|ansbuf
suffix:semicolon
id|parm.ipbfln2f
op_assign
id|anslen
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|parm_data
suffix:semicolon
multiline_comment|/* message in prmlist */
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|memcpy
(paren
id|parm.iprmmsg
comma
id|prmmsg
comma
l_int|8
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|send
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_send2way_prmmsg&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_reply                                           */
multiline_comment|/* Purpose: responds to the two-way messages that you receive */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong, id of message                       */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        buf    - pointer, address of buffer                 */
multiline_comment|/*        buflen - length of buffer                           */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_reply
id|iucv_reply
(paren
id|ushort
id|pathid
comma
id|ulong
id|msgid
comma
id|ulong
id|trgcls
comma
id|uchar
id|priority_msg
comma
r_void
op_star
id|buf
comma
id|ulong
id|buflen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_reply&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr2
op_assign
(paren
id|ulong
)paren
id|buf
suffix:semicolon
id|parm.ipbfln2f
op_assign
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|reply
comma
op_amp
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_reply&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_reply_array                                     */
multiline_comment|/* Purpose: responds to the two-way messages that you receive */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong, id of message                       */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        buf    - pointer, address of array                  */
multiline_comment|/*        buflen - length of buffer                           */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_reply_array
id|iucv_reply_array
(paren
id|ushort
id|pathid
comma
id|ulong
id|msgid
comma
id|ulong
id|trgcls
comma
id|uchar
id|priority_msg
comma
id|iucv_array_t
op_star
id|buffer
comma
id|ulong
id|buflen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_reply_array&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr2
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln2f
op_assign
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipflags1
op_or_assign
id|reply_array
suffix:semicolon
multiline_comment|/* reply w/ array  */
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|reply
comma
op_amp
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_reply_array&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_reply_prmmsg                                    */
multiline_comment|/* Purpose: responds to the two-way messages in parameter list */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong, id of message                       */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        prmmsg - uchar[8], message in parameter list        */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_reply_prmmsg
id|iucv_reply_prmmsg
(paren
id|ushort
id|pathid
comma
id|ulong
id|msgid
comma
id|ulong
id|trgcls
comma
id|uchar
id|priority_msg
comma
id|uchar
id|prmmsg
(braket
l_int|8
)braket
)paren
(brace
id|iparml_dpl
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_reply_prmmsg&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|memcpy
(paren
id|parm.iprmmsg
comma
id|prmmsg
comma
l_int|8
)paren
suffix:semicolon
id|parm.ipflags1
op_or_assign
id|parm_data
suffix:semicolon
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|reply
comma
op_amp
id|parm
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_reply_prmmsg&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_connect                                         */
multiline_comment|/* Purpose: establishes an IUCV path to another vm            */
multiline_comment|/* Input: pathid - ushort *, pathid returned to user          */
multiline_comment|/*        msglim - ushort, limit of outstanding messages      */
multiline_comment|/*        user_data - uchar[16], user data                    */
multiline_comment|/*        userid - uchar[8], user&squot;s id                        */
multiline_comment|/*        system_name - uchar[8], system identification       */
multiline_comment|/*        priority_requested - uchar- flag                    */
multiline_comment|/*        prmdata - uchar, flag prgrm can handler messages    */
multiline_comment|/*                  in parameter list                         */
multiline_comment|/*        quiesce - uchar, flag to quiesce a path being establ */
multiline_comment|/*        control - uchar, flag, option not used              */
multiline_comment|/*        local   - uchar, flag, establish connection only on */
multiline_comment|/*                  local system                              */
multiline_comment|/*        priority_permitted - uchar *, flag returned to user */
multiline_comment|/*        handle - address of handler                         */
multiline_comment|/*        pgm_data - ulong                                    */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_connect
id|iucv_connect
(paren
id|ushort
op_star
id|pathid
comma
id|ushort
id|msglim
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
comma
id|uchar
id|userid
(braket
l_int|8
)braket
comma
id|uchar
id|system_name
(braket
l_int|8
)braket
comma
id|uchar
id|priority_requested
comma
id|uchar
id|prmdata
comma
id|uchar
id|quiesce
comma
id|uchar
id|control
comma
id|uchar
id|local
comma
id|uchar
op_star
id|priority_permitted
comma
id|iucv_handle_t
id|handle
comma
id|ulong
id|pgm_data
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
r_int
id|add_pathid_result
comma
id|rc
suffix:semicolon
id|handler
op_star
id|R
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_connect&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|declare_flag
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
id|iucv_declare_buffer
(paren
id|iucv_external_int_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IUCV: registration failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;rc from declare buffer is: %i&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
r_else
id|declare_flag
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Checking if handle is valid  */
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
r_if
c_cond
(paren
id|R
op_eq
id|handle
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|R
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;iucv_connect: Invalid Handle&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pathid
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;iucv_connect: invalid pathid pointer&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
op_minus
l_int|3
)paren
suffix:semicolon
)brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
id|parm.ipmsglim
op_assign
id|msglim
suffix:semicolon
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.ipvmid
comma
id|userid
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.iptarget
comma
id|system_name
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parm.iptarget
)paren
id|ASCEBC
(paren
id|parm.iptarget
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipvmid
)paren
(brace
id|ASCEBC
(paren
id|parm.ipvmid
comma
l_int|8
)paren
suffix:semicolon
id|EBC_TOUPPER
c_func
(paren
id|parm.ipvmid
comma
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priority_requested
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
r_if
c_cond
(paren
id|prmdata
)paren
id|parm.ipflags1
op_or_assign
id|parm_data
suffix:semicolon
multiline_comment|/*data in parameter list */
r_if
c_cond
(paren
id|quiesce
)paren
id|parm.ipflags1
op_or_assign
id|quiesce_msg
suffix:semicolon
r_if
c_cond
(paren
id|control
)paren
(brace
multiline_comment|/* do nothing at the time being  */
multiline_comment|/*control not provided yet */
)brace
r_if
c_cond
(paren
id|local
)paren
id|parm.ipflags1
op_or_assign
id|local_conn
suffix:semicolon
multiline_comment|/*connect on local system */
id|b2f0_result
op_assign
id|b2f0
(paren
id|connect
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
)paren
r_return
id|b2f0_result
suffix:semicolon
id|add_pathid_result
op_assign
id|add_pathid
(paren
id|parm.ippathid
comma
id|handle
comma
id|pgm_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|add_pathid_result
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;iucv_connect: add_pathid failed &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|add_pathid_result
)paren
suffix:semicolon
)brace
op_star
id|pathid
op_assign
id|parm.ippathid
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipflags1
op_amp
id|prior_msg
)paren
r_if
c_cond
(paren
id|priority_permitted
)paren
op_star
id|priority_permitted
op_assign
l_int|0x01
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_connect&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_accept                                          */
multiline_comment|/* Purpose: completes the iucv communication path             */
multiline_comment|/* Input: pathid - ushort , pathid                            */
multiline_comment|/*        msglim - ushort, limit of outstanding messages      */
multiline_comment|/*        user_data - uchar[16], user data                    */
multiline_comment|/*        priority_requested - uchar- flag                    */
multiline_comment|/*        prmdata - uchar, flag prgrm can handler messages    */
multiline_comment|/*                  in parameter list                         */
multiline_comment|/*        quiesce - uchar, flag to quiesce a path being establ*/
multiline_comment|/*        control - uchar, flag, option not used              */
multiline_comment|/*        priority_permitted -uchar *, flag returned to caller*/
multiline_comment|/*        handle - address of handler                         */
multiline_comment|/*        pgm_data - ulong                                    */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_accept
id|iucv_accept
(paren
id|ushort
id|pathid
comma
id|ushort
id|msglim
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
comma
id|uchar
id|priority_requested
comma
id|uchar
id|prmdata
comma
id|uchar
id|quiesce
comma
id|uchar
id|control
comma
id|uchar
op_star
id|priority_permitted
comma
id|iucv_handle_t
id|handle
comma
id|ulong
id|pgm_data
)paren
(brace
id|ulong
id|index1
comma
id|index2
suffix:semicolon
id|handler_table_entry
op_star
id|P
op_assign
l_int|0
suffix:semicolon
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_accept&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsglim
op_assign
id|msglim
suffix:semicolon
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priority_requested
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
r_if
c_cond
(paren
id|prmdata
)paren
id|parm.ipflags1
op_or_assign
id|parm_data
suffix:semicolon
multiline_comment|/*data in parameter list */
r_if
c_cond
(paren
id|quiesce
)paren
id|parm.ipflags1
op_or_assign
id|quiesce_msg
suffix:semicolon
r_if
c_cond
(paren
id|control
)paren
(brace
multiline_comment|/* do nothing at the time being  */
multiline_comment|/*control not provided yet */
)brace
id|b2f0_result
op_assign
id|b2f0
(paren
id|accept
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
)paren
r_return
id|b2f0_result
suffix:semicolon
id|index1
op_assign
(paren
(paren
id|ulong
)paren
id|pathid
)paren
op_div
l_int|512
suffix:semicolon
id|index2
op_assign
(paren
(paren
id|ulong
)paren
id|pathid
)paren
op_mod
l_int|512
suffix:semicolon
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pgm_data
)paren
(brace
id|P
op_assign
id|main_table
(braket
id|index1
)braket
suffix:semicolon
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
op_assign
id|pgm_data
suffix:semicolon
)brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipflags1
op_amp
id|prior_msg
)paren
r_if
c_cond
(paren
id|priority_permitted
)paren
op_star
id|priority_permitted
op_assign
l_int|0x01
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_accept&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_send2way_prmmsg_array                           */
multiline_comment|/* Purpose: sends messages in both directions w/parameter lst */
multiline_comment|/* Input: pathid - ushort, pathid                             */
multiline_comment|/*        msgid  - ulong *, id of message returned to caller  */
multiline_comment|/*        trgcls - ulong, target message class                */
multiline_comment|/*        srccls - ulong, source message class                */
multiline_comment|/*        msgtag - ulong, message tag                         */
multiline_comment|/*        priority_msg - uchar, flag                          */
multiline_comment|/*        prmmsg - uchar[8], message being sent in parameter  */
multiline_comment|/*        ansbuf - pointer to array of buffers                */
multiline_comment|/*        anslen - length of ansbuf buffer                    */
multiline_comment|/* Output: iprcode - return code from b2f0 call               */
multiline_comment|/*         msgid - returns message id                         */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_send2way_prmmsg_array
id|iucv_send2way_prmmsg_array
(paren
id|ushort
id|pathid
comma
id|ulong
op_star
id|msgid
comma
id|ulong
id|trgcls
comma
id|ulong
id|srccls
comma
id|ulong
id|msgtag
comma
id|uchar
id|priority_msg
comma
id|uchar
id|prmmsg
(braket
l_int|8
)braket
comma
id|iucv_array_t
op_star
id|ansbuf
comma
id|ulong
id|anslen
)paren
(brace
id|iparml_dpl
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;entering iucv_send2way_prmmsg&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|memset
(paren
op_amp
(paren
id|parm
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipbfadr2
op_assign
(paren
id|ulong
)paren
id|ansbuf
suffix:semicolon
id|parm.ipbfln2f
op_assign
id|anslen
suffix:semicolon
id|parm.ipflags1
op_or_assign
l_int|0x88
suffix:semicolon
multiline_comment|/* message in prmlist */
r_if
c_cond
(paren
id|priority_msg
)paren
id|parm.ipflags1
op_or_assign
id|prior_msg
suffix:semicolon
multiline_comment|/* priority message */
id|memcpy
(paren
id|parm.iprmmsg
comma
id|prmmsg
comma
l_int|8
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|send
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msgid
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exiting iucv_send2way_prmmsg&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/******************************************************************/
multiline_comment|/* Name: top_half_handler                                         */
multiline_comment|/* Purpose: handle minimum amount of interrupt in fastest time    */
multiline_comment|/*  possible and then pass interrupt to bottom half handler.      */
multiline_comment|/* Input: external interrupt buffer                               */
multiline_comment|/* Output: void                                                   */
multiline_comment|/******************************************************************/
r_inline
r_void
DECL|function|top_half_interrupt
id|top_half_interrupt
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
id|__u16
id|code
)paren
(brace
id|iucv_packet
op_star
id|pkt
suffix:semicolon
id|pkt
op_assign
(paren
id|iucv_packet
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|iucv_packet
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
(paren
id|pkt-&gt;data
comma
id|iucv_external_int_buffer
comma
l_int|40
)paren
suffix:semicolon
macro_line|#ifdef DEBUG3
id|printk
(paren
id|KERN_EMERG
l_string|&quot;TH: Got INT: %08x&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|pkt-&gt;data
op_plus
l_int|4
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* put new packet on the list */
id|spin_lock
(paren
op_amp
id|iucv_packets_lock
)paren
suffix:semicolon
id|pkt-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|iucv_packets_tail
op_ne
l_int|NULL
)paren
id|iucv_packets_tail-&gt;next
op_assign
id|pkt
suffix:semicolon
r_else
id|iucv_packets_head
op_assign
id|pkt
suffix:semicolon
id|iucv_packets_tail
op_assign
id|pkt
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|iucv_packets_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_compare_and_swap
(paren
l_int|0
comma
l_int|1
comma
op_amp
id|bh_scheduled
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG3
id|printk
(paren
id|KERN_EMERG
l_string|&quot;TH: Queuing BH&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|short_task.list
)paren
suffix:semicolon
id|short_task.sync
op_assign
l_int|0
suffix:semicolon
id|short_task.routine
op_assign
(paren
r_void
op_star
)paren
id|bottom_half_interrupt
suffix:semicolon
id|queue_task
(paren
op_amp
id|short_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*******************************************************************/
multiline_comment|/* Name: bottom_half_interrupt                                     */
multiline_comment|/* Purpose: Handle interrupt at a more safer time                  */
multiline_comment|/* Input: void                                                     */
multiline_comment|/* Output: void                                                    */
multiline_comment|/*******************************************************************/
r_void
DECL|function|bottom_half_interrupt
id|bottom_half_interrupt
(paren
r_void
)paren
(brace
id|iucv_packet
op_star
id|iucv_packet_list
suffix:semicolon
id|iucv_packet
op_star
id|tmp
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|atomic_set
(paren
op_amp
id|bh_scheduled
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|iucv_packets_lock
comma
id|flags
)paren
suffix:semicolon
id|iucv_packet_list
op_assign
id|iucv_packets_head
suffix:semicolon
id|iucv_packets_head
op_assign
id|iucv_packets_tail
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_packets_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* now process all the request in the iucv_packet_list */
macro_line|#ifdef DEBUG3
id|printk
(paren
id|KERN_EMERG
l_string|&quot;BH: Process all packets&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|iucv_packet_list
op_ne
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG3
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;BH:&gt;  %08x&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|iucv_packet_list-&gt;data
op_plus
l_int|4
)paren
)paren
suffix:semicolon
macro_line|#endif
id|do_int
(paren
(paren
id|iucv_ConnectionPending
op_star
)paren
id|iucv_packet_list-&gt;data
)paren
suffix:semicolon
macro_line|#ifdef DEBUG3
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;BH:&lt;  %08x&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|iucv_packet_list-&gt;data
op_plus
l_int|4
)paren
)paren
suffix:semicolon
macro_line|#endif
id|tmp
op_assign
id|iucv_packet_list
suffix:semicolon
id|iucv_packet_list
op_assign
id|iucv_packet_list-&gt;next
suffix:semicolon
id|kfree
(paren
id|tmp
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUG3
id|printk
(paren
id|KERN_EMERG
l_string|&quot;BH: Done&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*******************************************************************/
multiline_comment|/* Name: do_int                                                    */
multiline_comment|/* Purpose: Handle interrupt in a more safe environment            */
multiline_comment|/* Inuput: int_buf - pointer to copy of external interrupt buffer  */
multiline_comment|/* Output: void                                                    */
multiline_comment|/*******************************************************************/
r_void
DECL|function|do_int
id|do_int
(paren
id|iucv_ConnectionPending
op_star
id|int_buf
)paren
(brace
id|ulong
id|index1
op_assign
l_int|0
comma
id|index2
op_assign
l_int|0
suffix:semicolon
id|handler_table_entry
op_star
id|P
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* P is a pointer */
id|handler
op_star
id|Q
op_assign
l_int|0
comma
op_star
id|R
suffix:semicolon
multiline_comment|/* Q and R are pointers */
id|iucv_interrupt_ops_t
op_star
id|interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* interrupt addresses */
id|uchar
id|temp_buff1
(braket
l_int|24
)braket
comma
id|temp_buff2
(braket
l_int|24
)braket
suffix:semicolon
multiline_comment|/* masked handler id. */
r_int
id|add_pathid_result
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|uchar
id|no_listener
(braket
l_int|16
)braket
op_assign
l_string|&quot;NO LISTENER&quot;
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
id|i
suffix:semicolon
id|uchar
op_star
id|prt_parm
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUG3
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;BH:-  Entered do_int &quot;
l_string|&quot;pathid %d, type %02X&bslash;n&quot;
comma
id|int_buf-&gt;ippathid
comma
id|int_buf-&gt;iptype
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUG
id|prt_parm
op_assign
(paren
id|uchar
op_star
)paren
(paren
id|int_buf
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;External Interrupt Buffer&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|40
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%02x &quot;
comma
id|prt_parm
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ASCEBC
(paren
id|no_listener
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|int_buf-&gt;iptype
op_ne
l_int|01
)paren
(brace
id|index1
op_assign
(paren
(paren
id|ulong
)paren
(paren
id|int_buf-&gt;ippathid
)paren
)paren
op_div
l_int|512
suffix:semicolon
id|index2
op_assign
(paren
(paren
id|ulong
)paren
(paren
id|int_buf-&gt;ippathid
)paren
)paren
op_mod
l_int|512
suffix:semicolon
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
id|P
op_assign
id|main_table
(braket
id|index1
)braket
suffix:semicolon
id|Q
op_assign
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|addrs
suffix:semicolon
id|interrupt
op_assign
id|Q-&gt;interrupt_table
suffix:semicolon
multiline_comment|/* interrupt functions */
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Handler is: &bslash;n&quot;
)paren
suffix:semicolon
id|prt_parm
op_assign
(paren
id|uchar
op_star
)paren
id|Q
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|handler
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; %02x &quot;
comma
id|prt_parm
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* end of if statement */
r_switch
c_cond
(paren
id|int_buf-&gt;iptype
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* connection pending */
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
(brace
id|memcpy
(paren
id|temp_buff1
comma
op_amp
(paren
id|int_buf-&gt;ipvmid
)paren
comma
l_int|24
)paren
suffix:semicolon
id|memcpy
(paren
id|temp_buff2
comma
op_amp
(paren
id|R-&gt;vmid
)paren
comma
l_int|24
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|24
suffix:semicolon
id|j
op_increment
)paren
(brace
id|temp_buff1
(braket
id|j
)braket
op_assign
(paren
id|temp_buff1
(braket
id|j
)braket
)paren
op_amp
(paren
id|R-&gt;mask
)paren
(braket
id|j
)braket
suffix:semicolon
id|temp_buff2
(braket
id|j
)braket
op_assign
(paren
id|temp_buff2
(braket
id|j
)braket
)paren
op_amp
(paren
id|R-&gt;mask
)paren
(braket
id|j
)braket
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|temp_buff1
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; %c &quot;
comma
id|temp_buff1
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|temp_buff2
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; %c &quot;
comma
id|temp_buff2
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|memcmp
c_func
(paren
(paren
r_void
op_star
)paren
id|temp_buff1
comma
(paren
r_void
op_star
)paren
id|temp_buff2
comma
l_int|24
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;found a matching handler&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|R
)paren
(brace
multiline_comment|/* ADD PATH TO PATHID TABLE */
id|add_pathid_result
op_assign
id|add_pathid
(paren
id|int_buf-&gt;ippathid
comma
id|R
comma
id|R-&gt;pgm_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|add_pathid_result
op_eq
l_int|NULL
)paren
(brace
id|interrupt
op_assign
id|R-&gt;interrupt_table
suffix:semicolon
r_if
c_cond
(paren
id|interrupt.ConnectionPending
)paren
(brace
id|EBCASC
(paren
id|int_buf-&gt;ipvmid
comma
l_int|8
)paren
suffix:semicolon
(paren
id|interrupt
op_member_access_from_pointer
id|ConnectionPending
)paren
(paren
id|int_buf
comma
id|R-&gt;pgm_data
)paren
suffix:semicolon
)brace
r_else
(brace
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end if if(add_p...... */
r_else
(brace
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;add_pathid failed with rc = %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|add_pathid_result
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/*connection complete */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt.ConnectionComplete
)paren
(paren
id|interrupt.ConnectionComplete
)paren
(paren
(paren
id|iucv_ConnectionComplete
op_star
)paren
id|int_buf
comma
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
)paren
suffix:semicolon
r_else
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;ConnectionComplete not called&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;routine@ is %p&bslash;n&quot;
comma
id|interrupt.ConnectionComplete
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
multiline_comment|/* connection severed */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt.ConnectionSevered
)paren
(paren
id|interrupt.ConnectionSevered
)paren
(paren
(paren
id|iucv_ConnectionSevered
op_star
)paren
id|int_buf
comma
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
)paren
suffix:semicolon
r_else
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
)brace
r_else
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* connection quiesced */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt.ConnectionQuiesced
)paren
(paren
id|interrupt.ConnectionQuiesced
)paren
(paren
(paren
id|iucv_ConnectionQuiesced
op_star
)paren
id|int_buf
comma
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
)paren
suffix:semicolon
r_else
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;ConnectionQuiesced not called&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;routine@ is %p&bslash;n&quot;
comma
id|interrupt.ConnectionQuiesced
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
multiline_comment|/* connection resumed */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt.ConnectionResumed
)paren
(paren
id|interrupt.ConnectionResumed
)paren
(paren
(paren
id|iucv_ConnectionResumed
op_star
)paren
id|int_buf
comma
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
)paren
suffix:semicolon
r_else
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;ConnectionResumed not called&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;routine@ is %p&bslash;n&quot;
comma
id|interrupt.ConnectionResumed
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
multiline_comment|/* priority message complete */
r_case
l_int|0x07
suffix:colon
multiline_comment|/* nonpriority message complete */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt.MessageComplete
)paren
(paren
id|interrupt.MessageComplete
)paren
(paren
(paren
id|iucv_MessageComplete
op_star
)paren
id|int_buf
comma
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
)paren
suffix:semicolon
r_else
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;MessageComplete not called&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;routine@ is %p&bslash;n&quot;
comma
id|interrupt.MessageComplete
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* priority message pending  */
r_case
l_int|0x09
suffix:colon
multiline_comment|/* nonpriority message pending  */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt.MessagePending
)paren
(paren
id|interrupt.MessagePending
)paren
(paren
(paren
id|iucv_MessagePending
op_star
)paren
id|int_buf
comma
(paren
id|P
op_plus
id|index2
)paren
op_member_access_from_pointer
id|pgm_data
)paren
suffix:semicolon
r_else
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;MessagePending not called&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;routine@ is %p&bslash;n&quot;
comma
id|interrupt.MessagePending
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unknown iucv type */
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;unknown iucv interrupt &bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
macro_line|#ifdef DEBUG3
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;BH:-  Exiting do_int &quot;
l_string|&quot;pathid %d, type %02X&bslash;n&quot;
comma
id|int_buf-&gt;ippathid
comma
id|int_buf-&gt;iptype
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* end of function call */
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_register_program                                */
multiline_comment|/* Purpose: registers a new handler                           */
multiline_comment|/* Input: pgmname- uchar[16], user id                         */
multiline_comment|/*        userid - uchar[8], machine id                       */
multiline_comment|/*        prmmask- mask                                       */
multiline_comment|/*        ops    - pointer to iucv_interrupt_ops buffer       */
multiline_comment|/* Output: new_handler - address of new handler               */
multiline_comment|/**************************************************************/
id|iucv_handle_t
DECL|function|iucv_register_program
id|iucv_register_program
(paren
id|uchar
id|pgmname
(braket
l_int|16
)braket
comma
id|uchar
id|userid
(braket
l_int|8
)braket
comma
id|uchar
id|pgmmask
(braket
l_int|24
)braket
comma
id|iucv_interrupt_ops_t
op_star
id|ops
comma
id|ulong
id|pgm_data
)paren
(brace
r_int
id|rc
suffix:semicolon
id|handler
op_star
id|new_handler
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
r_int
id|i
suffix:semicolon
id|uchar
op_star
id|prt_parm
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;enter iucv_register_program&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|my_ops
op_assign
op_star
id|ops
suffix:semicolon
multiline_comment|/* Allocate handler table */
id|new_handler
op_assign
(paren
id|handler
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|handler
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_handler
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IUCV: returned NULL address for new handle &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* fill in handler table */
id|memcpy
(paren
id|new_handler-&gt;user_data
comma
id|pgmname
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
(paren
id|new_handler-&gt;vmid
comma
id|userid
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
(paren
id|new_handler-&gt;mask
comma
id|pgmmask
comma
l_int|24
)paren
suffix:semicolon
id|new_handler-&gt;pgm_data
op_assign
id|pgm_data
suffix:semicolon
multiline_comment|/* Convert from ASCII to EBCDIC */
r_if
c_cond
(paren
id|new_handler-&gt;vmid
)paren
(brace
id|ASCEBC
(paren
id|new_handler-&gt;vmid
comma
l_int|8
)paren
suffix:semicolon
id|EBC_TOUPPER
c_func
(paren
id|new_handler-&gt;vmid
comma
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* fill in handler table */
id|new_handler-&gt;interrupt_table
op_assign
id|ops
suffix:semicolon
id|new_handler-&gt;size
op_assign
id|ADDED_STOR
suffix:semicolon
multiline_comment|/* Allocate storage for pathid table */
id|new_handler-&gt;start
op_assign
id|kmalloc
(paren
id|ADDED_STOR
op_star
r_sizeof
(paren
id|ulong
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_handler-&gt;start
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;IUCV: returned NULL address for pathid table,&quot;
l_string|&quot; exiting&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|kfree
c_func
(paren
id|new_handler
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
(paren
id|new_handler-&gt;start
comma
l_int|0
comma
id|ADDED_STOR
op_star
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
id|new_handler-&gt;end
op_assign
id|new_handler.start
op_plus
id|ADDED_STOR
suffix:semicolon
id|new_handler-&gt;next
op_assign
l_int|0
suffix:semicolon
id|new_handler-&gt;prev
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Place handler at beginning of chain */
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|handler_anchor
op_eq
l_int|NULL
)paren
id|handler_anchor
op_assign
id|new_handler
suffix:semicolon
r_else
(brace
id|handler_anchor-&gt;prev
op_assign
(paren
id|ulong
op_star
)paren
id|new_handler
suffix:semicolon
id|new_handler-&gt;next
op_assign
(paren
id|ulong
op_star
)paren
id|handler_anchor
suffix:semicolon
id|handler_anchor
op_assign
id|new_handler
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;adding a another handler to list&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;handler_anchor-&gt;prev is %p &bslash;n&quot;
comma
id|handler_anchor-&gt;prev
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;new_handler-&gt;next is %p &bslash;n&quot;
comma
id|new_handler-&gt;next
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;handler_anchor is %p &bslash;n&quot;
comma
id|handler_anchor
)paren
suffix:semicolon
macro_line|#endif
)brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|declare_flag
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
id|iucv_declare_buffer
(paren
id|iucv_external_int_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|declare_flag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* request the 0x4000 external interrupt */
id|rc
op_assign
id|register_external_interrupt
(paren
l_int|0x4000
comma
id|top_half_interrupt
)paren
suffix:semicolon
)brace
r_else
(brace
id|panic
(paren
l_string|&quot;Registration failed&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;rc from declare buffer is: %i&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;address of handle is %p &quot;
comma
id|new_handler
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;size of handle is %d &quot;
comma
(paren
r_int
)paren
(paren
r_sizeof
(paren
id|handler
)paren
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exit iucv_register_program&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;main_table is %p &bslash;n&quot;
comma
id|main_table
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;handler_anchor is %p &bslash;n&quot;
comma
id|handler_anchor
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Handler is: &bslash;n&quot;
)paren
suffix:semicolon
id|prt_parm
op_assign
(paren
id|uchar
op_star
)paren
id|new_handler
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|handler
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot; %02x &quot;
comma
id|prt_parm
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|new_handler
suffix:semicolon
multiline_comment|/* send buffer address back */
)brace
multiline_comment|/* end of register function */
multiline_comment|/**************************************************************/
multiline_comment|/* Name: iucv_unregister                                      */
multiline_comment|/* Purpose: remove handler from chain and sever all paths     */
multiline_comment|/* Input: handle - address of handler to be severed           */
multiline_comment|/* Output: returns 0                                          */
multiline_comment|/**************************************************************/
r_int
DECL|function|iucv_unregister
id|iucv_unregister
(paren
id|iucv_handle_t
id|handle
)paren
(brace
id|handler
op_star
id|temp_next
op_assign
l_int|0
comma
op_star
id|temp_prev
op_assign
l_int|0
suffix:semicolon
id|handler
op_star
id|Q
op_assign
l_int|0
comma
op_star
id|R
suffix:semicolon
id|handler_table_entry
op_star
id|H_T_E
op_assign
l_int|0
suffix:semicolon
id|ulong
op_star
id|S
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*points to the beginning of block of h_t_e&squot;s*/
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;enter iucv_unregister&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;address of handle is %p &quot;
comma
id|handle
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;size of handle is %u &quot;
comma
(paren
r_int
)paren
(paren
r_sizeof
(paren
id|handle
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
id|Q
op_assign
(paren
id|handler
op_star
)paren
id|handle
suffix:semicolon
multiline_comment|/*&n;&t; * Checking if handle is still registered: if yes, continue&n;&t; *  if not registered, return.&n;&t; */
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
r_if
c_cond
(paren
id|Q
op_eq
id|R
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;found a matching handler&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|R
)paren
(brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|S
op_assign
id|Q-&gt;start
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Q is handle? %p &quot;
comma
id|Q
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Q-&gt;start is %p &quot;
comma
id|Q-&gt;start
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&amp;(Q-&gt;start) is %p &quot;
comma
op_amp
(paren
id|Q-&gt;start
)paren
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Q-&gt;end is %p &quot;
comma
id|Q-&gt;end
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;&amp;(Q-&gt;end) is %p &quot;
comma
op_amp
(paren
id|Q-&gt;end
)paren
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|S
OL
(paren
id|Q-&gt;end
)paren
)paren
(brace
multiline_comment|/* index thru table */
r_if
c_cond
(paren
op_star
id|S
)paren
(brace
id|H_T_E
op_assign
(paren
id|handler_table_entry
op_star
)paren
(paren
op_star
id|S
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Pointer to H_T_E is %p &quot;
comma
id|H_T_E
)paren
suffix:semicolon
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;Address of handle in H_T_E is %p&quot;
comma
(paren
id|H_T_E-&gt;addrs
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|H_T_E-&gt;addrs
)paren
op_ne
id|handle
)paren
(brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|2
)paren
suffix:semicolon
multiline_comment|/*handler addresses don&squot;t match */
)brace
r_else
(brace
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
id|iucv_sever
(paren
id|H_T_E-&gt;pathid
comma
id|Q-&gt;user_data
)paren
suffix:semicolon
id|spin_lock
(paren
op_amp
id|lock
)paren
suffix:semicolon
)brace
)brace
id|S
op_increment
suffix:semicolon
multiline_comment|/* index by size of ulong */
)brace
id|kfree
(paren
id|Q-&gt;start
)paren
suffix:semicolon
id|temp_next
op_assign
(paren
id|handler
op_star
)paren
id|Q-&gt;next
suffix:semicolon
multiline_comment|/* address of next handler on list */
id|temp_prev
op_assign
(paren
id|handler
op_star
)paren
id|Q-&gt;prev
suffix:semicolon
multiline_comment|/* address of prev handler on list */
r_if
c_cond
(paren
(paren
id|temp_next
op_ne
l_int|NULL
)paren
op_amp
(paren
id|temp_prev
op_ne
l_int|NULL
)paren
)paren
(brace
id|temp_next.prev
op_assign
(paren
id|ulong
op_star
)paren
id|temp_prev
suffix:semicolon
id|temp_prev.next
op_assign
(paren
id|ulong
op_star
)paren
id|temp_next
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|temp_next
op_ne
l_int|NULL
)paren
op_amp
(paren
id|temp_prev
op_eq
l_int|NULL
)paren
)paren
(brace
id|temp_next.prev
op_assign
l_int|NULL
suffix:semicolon
id|handler_anchor
op_assign
id|temp_next
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|temp_next
op_eq
l_int|NULL
)paren
op_amp
(paren
id|temp_prev
op_ne
l_int|NULL
)paren
)paren
id|temp_prev.next
op_assign
l_int|NULL
suffix:semicolon
r_else
id|handler_anchor
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|handler_anchor
op_eq
l_int|NULL
)paren
id|iucv_retrieve_buffer
(paren
)paren
suffix:semicolon
id|kfree
(paren
id|handle
)paren
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|lock
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;exit iucv_unregister&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|iucv_accept
id|EXPORT_SYMBOL
(paren
id|iucv_accept
)paren
suffix:semicolon
DECL|variable|iucv_connect
id|EXPORT_SYMBOL
(paren
id|iucv_connect
)paren
suffix:semicolon
DECL|variable|iucv_purge
id|EXPORT_SYMBOL
(paren
id|iucv_purge
)paren
suffix:semicolon
DECL|variable|iucv_query
id|EXPORT_SYMBOL
(paren
id|iucv_query
)paren
suffix:semicolon
DECL|variable|iucv_quiesce
id|EXPORT_SYMBOL
(paren
id|iucv_quiesce
)paren
suffix:semicolon
DECL|variable|iucv_receive
id|EXPORT_SYMBOL
(paren
id|iucv_receive
)paren
suffix:semicolon
DECL|variable|iucv_receive_simple
id|EXPORT_SYMBOL
(paren
id|iucv_receive_simple
)paren
suffix:semicolon
DECL|variable|iucv_receive_array
id|EXPORT_SYMBOL
(paren
id|iucv_receive_array
)paren
suffix:semicolon
DECL|variable|iucv_reject
id|EXPORT_SYMBOL
(paren
id|iucv_reject
)paren
suffix:semicolon
DECL|variable|iucv_reply
id|EXPORT_SYMBOL
(paren
id|iucv_reply
)paren
suffix:semicolon
DECL|variable|iucv_reply_array
id|EXPORT_SYMBOL
(paren
id|iucv_reply_array
)paren
suffix:semicolon
DECL|variable|iucv_reply_prmmsg
id|EXPORT_SYMBOL
(paren
id|iucv_reply_prmmsg
)paren
suffix:semicolon
DECL|variable|iucv_resume
id|EXPORT_SYMBOL
(paren
id|iucv_resume
)paren
suffix:semicolon
DECL|variable|iucv_send
id|EXPORT_SYMBOL
(paren
id|iucv_send
)paren
suffix:semicolon
DECL|variable|iucv_send2way
id|EXPORT_SYMBOL
(paren
id|iucv_send2way
)paren
suffix:semicolon
DECL|variable|iucv_send2way_array
id|EXPORT_SYMBOL
(paren
id|iucv_send2way_array
)paren
suffix:semicolon
DECL|variable|iucv_send_array
id|EXPORT_SYMBOL
(paren
id|iucv_send_array
)paren
suffix:semicolon
DECL|variable|iucv_send2way_prmmsg
id|EXPORT_SYMBOL
(paren
id|iucv_send2way_prmmsg
)paren
suffix:semicolon
DECL|variable|iucv_send2way_prmmsg_array
id|EXPORT_SYMBOL
(paren
id|iucv_send2way_prmmsg_array
)paren
suffix:semicolon
DECL|variable|iucv_send_prmmsg
id|EXPORT_SYMBOL
(paren
id|iucv_send_prmmsg
)paren
suffix:semicolon
DECL|variable|iucv_setmask
id|EXPORT_SYMBOL
(paren
id|iucv_setmask
)paren
suffix:semicolon
DECL|variable|iucv_sever
id|EXPORT_SYMBOL
(paren
id|iucv_sever
)paren
suffix:semicolon
DECL|variable|iucv_register_program
id|EXPORT_SYMBOL
(paren
id|iucv_register_program
)paren
suffix:semicolon
DECL|variable|iucv_unregister
id|EXPORT_SYMBOL
(paren
id|iucv_unregister
)paren
suffix:semicolon
eof
