multiline_comment|/*                                                                                             &n; *   drivers/s390/net/iucv.c&n; *    Support for VM IUCV functions for use by other part of the&n; *    kernel or loadable modules.&n; *&n; *  S390 version&n; *    Copyright (C) 2000 IBM Corporation&n; *    Author(s): Alan Altmark (Alan_Altmark@us.ibm.com)&n; *               Xenia Tkatschow (xenia@us.ibm.com)&n; * Functionality:                                                    &n; * To explore any of the IUCV functions, one must first register     &n; * their program using iucv_register(). Once your program has        &n; * successfully completed a register, it can use the other functions.&n; * For furthur reference on all IUCV functionality, refer to the     &n; * CP Programming Services book, also available on the web            &n; * thru www.ibm.com/s390/vm/pubs , manual # SC24-5760.               &n; *                                                                    &n; *      Definition of Return Codes                                    &n; *      -All positive return codes including zero are reflected back &n; *       from CP and the definition can be found in CP Programming    &n; *       Services book.                  &n; *      - (-ENOMEM) Out of memory&n; *      - (-EINVAL) Invalid value                             &n;*/
multiline_comment|/* #define DEBUG 1 */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &quot;iucv.h&quot;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/s390_ext.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#ifndef min
DECL|macro|min
mdefine_line|#define min(a,b) (((a)&lt;(b))?(a):(b))
macro_line|#endif
macro_line|#ifndef max
DECL|macro|max
mdefine_line|#define max(a,b) (((a)&gt;(b))?(a):(b))
macro_line|#endif
macro_line|#ifdef DEBUG
DECL|macro|KERN_INFO
macro_line|#undef KERN_INFO
DECL|macro|KERN_DEBUG
macro_line|#undef KERN_DEBUG
DECL|macro|KERN_INFO
mdefine_line|#define KERN_INFO KERN_EMERG
DECL|macro|KERN_DEBUG
mdefine_line|#define KERN_DEBUG KERN_EMERG
macro_line|#endif
DECL|macro|NULL
macro_line|#undef NULL
DECL|macro|NULL
mdefine_line|#define NULL 0
DECL|macro|PRRTY_PRMTD
mdefine_line|#define PRRTY_PRMTD    0x01&t;/* priority permitted */
DECL|macro|RPY_RQRD
mdefine_line|#define RPY_RQRD       0x01&t;/* reply required */
DECL|macro|ADDED_STOR
mdefine_line|#define ADDED_STOR  64&t;&t;/* ADDITIONAL STORAGE FOR PATHID @&squot;S */
DECL|macro|BUFFER_SIZE
mdefine_line|#define BUFFER_SIZE 40&t;&t;/* Size of 31-bit iparml */
multiline_comment|/* FLAGS:&n; * All flags are defined in the field IPFLAGS1 of each function&n; * and can be found in CP Programming Services.&n; * IPSRCCLS - Indicates you have specified a source class&n; * IPFGMCL  - Indicates you have specified a target class&n; * IPFGPID  - Indicates you have specified a pathid&n; * IPFGMID  - Indicates you have specified a message ID&n; * IPANSLST - Indicates that you are using an address list for&n; *            reply data&n; * IPBUFLST - Indicates that you are using an address list for&n; *            message data&n; */
DECL|macro|IPSRCCLS
mdefine_line|#define IPSRCCLS &t;0x01
DECL|macro|IPFGMCL
mdefine_line|#define IPFGMCL         0x01
DECL|macro|IPFGPID
mdefine_line|#define IPFGPID         0x02
DECL|macro|IPFGMID
mdefine_line|#define IPFGMID         0x04
DECL|macro|IPANSLST
mdefine_line|#define IPANSLST        0x08
DECL|macro|IPBUFLST
mdefine_line|#define IPBUFLST        0x40
DECL|variable|iucv_external_int_buffer
r_static
id|uchar
id|iucv_external_int_buffer
(braket
l_int|40
)braket
suffix:semicolon
multiline_comment|/* Spin Lock declaration */
DECL|variable|short_task
r_struct
id|tq_struct
id|short_task
suffix:semicolon
multiline_comment|/* automatically initialized to zero */
DECL|variable|iucv_lock
r_static
id|spinlock_t
id|iucv_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* General IUCV interrupt structure */
r_typedef
r_struct
(brace
DECL|member|ippathid
id|u16
id|ippathid
suffix:semicolon
DECL|member|res1
id|uchar
id|res1
suffix:semicolon
DECL|member|iptype
id|uchar
id|iptype
suffix:semicolon
DECL|member|res2
id|u32
id|res2
suffix:semicolon
DECL|member|ipvmid
id|uchar
id|ipvmid
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|res3
id|uchar
id|res3
(braket
l_int|24
)braket
suffix:semicolon
DECL|typedef|iucv_GeneralInterrupt
)brace
id|iucv_GeneralInterrupt
suffix:semicolon
multiline_comment|/***************INTERRUPT HANDLING DEFINITIONS***************/
DECL|struct|_iucv_packet
r_typedef
r_struct
id|_iucv_packet
(brace
DECL|member|next
r_struct
id|_iucv_packet
op_star
id|next
suffix:semicolon
DECL|member|data
id|uchar
id|data
(braket
l_int|40
)braket
suffix:semicolon
DECL|typedef|iucv_packet
)brace
id|iucv_packet
suffix:semicolon
DECL|variable|short_task
r_struct
id|tq_struct
id|short_task
suffix:semicolon
DECL|variable|iucv_packets_lock
r_static
id|spinlock_t
id|iucv_packets_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|iucv_packets_head
DECL|variable|iucv_packets_tail
id|iucv_packet
op_star
id|iucv_packets_head
comma
op_star
id|iucv_packets_tail
suffix:semicolon
DECL|variable|bh_scheduled
r_static
id|atomic_t
id|bh_scheduled
op_assign
id|ATOMIC_INIT
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* &n; *Internal function prototypes &n; */
r_static
id|ulong
id|iucv_vmsize
(paren
r_void
)paren
suffix:semicolon
r_int
id|iucv_declare_buffer
(paren
r_void
)paren
suffix:semicolon
r_int
id|iucv_retrieve_buffer
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|iucv_add_pathid
(paren
id|u16
id|pathid
comma
id|iucv_handle_t
id|handle
comma
r_void
op_star
id|pgm_data
)paren
suffix:semicolon
r_static
r_void
id|iucv_remove_pathid
(paren
id|u16
id|pathid
)paren
suffix:semicolon
r_void
id|bottom_half_interrupt
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|do_int
(paren
id|iucv_GeneralInterrupt
op_star
)paren
suffix:semicolon
r_inline
r_void
id|top_half_interrupt
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
id|__u16
id|code
)paren
suffix:semicolon
multiline_comment|/************FUNCTION ID&squot;S****************************/
DECL|macro|ACCEPT
mdefine_line|#define ACCEPT          10
DECL|macro|CONNECT
mdefine_line|#define CONNECT         11
DECL|macro|DECLARE_BUFFER
mdefine_line|#define DECLARE_BUFFER  12
DECL|macro|PURGE
mdefine_line|#define PURGE           9
DECL|macro|QUERY
mdefine_line|#define QUERY           0
DECL|macro|QUIESCE
mdefine_line|#define QUIESCE         13
DECL|macro|RECEIVE
mdefine_line|#define RECEIVE         5
DECL|macro|REJECT
mdefine_line|#define REJECT          8
DECL|macro|REPLY
mdefine_line|#define REPLY           6
DECL|macro|RESUME
mdefine_line|#define RESUME          14
DECL|macro|RETRIEVE_BUFFER
mdefine_line|#define RETRIEVE_BUFFER 2
DECL|macro|SEND
mdefine_line|#define SEND            4
DECL|macro|SETMASK
mdefine_line|#define SETMASK         16
DECL|macro|SEVER
mdefine_line|#define SEVER           15
multiline_comment|/*                                                               &n; * Structure: handler                                            &n; * members: next - is a pointer to next handler on chain         &n; *          prev - is a pointer to prev handler on chain         &n; *          structure: id                                        &n; *             vmid - 8 char array of machine identification     &n; *             user_data - 16 char array for user identification &n; *             mask - 24 char array used to compare the 2 previous  &n; *          interrupt_table - vector of interrupt functions.     &n; *          pathid_head - pointer to start of user_pathid_table  &n; *          pathid_tail - pointer to end of user_pathid_table    &n; *          entries -  ulong, size of user_pathid_table          &n; *          pgm_data -  ulong, application data that is passed   &n; *                      to the interrupt handlers                &n;*/
r_typedef
r_struct
(brace
DECL|member|next
id|ulong
op_star
id|next
suffix:semicolon
DECL|member|prev
id|ulong
op_star
id|prev
suffix:semicolon
r_struct
(brace
DECL|member|userid
id|uchar
id|userid
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|user_data
id|uchar
id|user_data
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|mask
id|uchar
id|mask
(braket
l_int|24
)braket
suffix:semicolon
DECL|member|id
)brace
id|id
suffix:semicolon
DECL|member|interrupt_table
id|iucv_interrupt_ops_t
op_star
id|interrupt_table
suffix:semicolon
DECL|member|pathid_head
id|ulong
op_star
id|pathid_head
suffix:semicolon
DECL|member|pathid_tail
id|ulong
op_star
id|pathid_tail
suffix:semicolon
DECL|member|entries
id|ulong
id|entries
suffix:semicolon
DECL|member|pgm_data
r_void
op_star
id|pgm_data
suffix:semicolon
DECL|typedef|handler
)brace
id|handler
suffix:semicolon
multiline_comment|/*                                                         &n; * Structure: handler_table_entry                          &n; * members: addrs - pointer to a handler                   &n; *          pathid - ushort containing path identification &n; *          pgm_data - ulong, application data that is     &n; *                     passed to the interrupt handlers    &n; *          ops - pointer to iucv interrupt vector         &n; */
r_typedef
r_struct
(brace
DECL|member|addrs
id|handler
op_star
id|addrs
suffix:semicolon
DECL|member|pathid
id|u16
id|pathid
suffix:semicolon
DECL|member|pgm_data
r_void
op_star
id|pgm_data
suffix:semicolon
DECL|member|ops
id|iucv_interrupt_ops_t
op_star
id|ops
suffix:semicolon
DECL|typedef|handler_table_entry
)brace
id|handler_table_entry
suffix:semicolon
multiline_comment|/* &n; * Internal function prototypes &n; */
r_static
r_int
id|iucv_add_handler
(paren
id|handler
op_star
id|new_handler
)paren
suffix:semicolon
r_static
r_void
id|iucv_remove_handler
(paren
id|handler
op_star
id|users_handler
)paren
suffix:semicolon
multiline_comment|/* handler_anchor: points to first handler on chain */
multiline_comment|/* handler_tail: points to last handler on chain */
multiline_comment|/* handler_table_anchor: points to beginning of handler_table_entries*/
DECL|variable|handler_anchor
r_static
id|handler
op_star
id|handler_anchor
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|handler_tail
r_static
id|handler
op_star
id|handler_tail
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|handler_table_anchor
r_static
id|handler_table_entry
op_star
id|handler_table_anchor
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* declare_flag: is 0 when iucv_declare_buffer has not been called */
DECL|variable|declare_flag
r_static
id|ulong
id|declare_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/****************FIVE 40-BYTE PARAMETER STRUCTURES******************/
multiline_comment|/* Data struct 1: iparml_control                                      &n; * Used for iucv_accept                                               &n; *          iucv_connect                                              &n; *          iucv_quiesce                                              &n; *          iucv_resume                                               &n; *          iucv_sever                                                &n; *          iucv_retrieve_buffer                                      &n; * Data struct 2: iparml_dpl     (data in parameter list)             &n; * Used for iucv_send_prmmsg                                          &n; *          iucv_send2way_prmmsg                                      &n; *          iucv_send2way_prmmsg_array                                &n; *          iucv_reply_prmmsg                                         &n; * Data struct 3: iparml_db       (data in a buffer)                  &n; * Used for iucv_receive                                              &n; *          iucv_receive_array                                        &n; *          iucv_reject                                               &n; *          iucv_reply                                                &n; *          iucv_reply_array                &n; *          iucv_send                       &n; *          iucv_send_array                 &n; *          iucv_send2way                   &n; *          iucv_send2way_array             &n; *          iucv_declare_buffer             &n; * Data struct 4: iparml_purge              &n; * Used for iucv_purge                      &n; *          iucv_query                      &n; * Data struct 5: iparml_set_mask           &n; * Used for iucv_set_mask                   &n;*/
r_typedef
r_struct
(brace
DECL|member|ippathid
id|u16
id|ippathid
suffix:semicolon
DECL|member|ipflags1
id|uchar
id|ipflags1
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|ipmsglim
id|u16
id|ipmsglim
suffix:semicolon
DECL|member|res1
id|u16
id|res1
suffix:semicolon
DECL|member|ipvmid
id|uchar
id|ipvmid
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|ipuser
id|uchar
id|ipuser
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|iptarget
id|uchar
id|iptarget
(braket
l_int|8
)braket
suffix:semicolon
DECL|typedef|iparml_control
)brace
id|iparml_control
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ippathid
id|u16
id|ippathid
suffix:semicolon
DECL|member|ipflags1
id|uchar
id|ipflags1
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|ipmsgid
id|u32
id|ipmsgid
suffix:semicolon
DECL|member|iptrgcls
id|u32
id|iptrgcls
suffix:semicolon
DECL|member|iprmmsg
id|uchar
id|iprmmsg
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|ipsrccls
id|u32
id|ipsrccls
suffix:semicolon
DECL|member|ipmsgtag
id|u32
id|ipmsgtag
suffix:semicolon
DECL|member|ipbfadr2
id|u32
id|ipbfadr2
suffix:semicolon
DECL|member|ipbfln2f
id|u32
id|ipbfln2f
suffix:semicolon
DECL|member|res
id|u32
id|res
suffix:semicolon
DECL|typedef|iparml_dpl
)brace
id|iparml_dpl
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ippathid
id|u16
id|ippathid
suffix:semicolon
DECL|member|ipflags1
id|uchar
id|ipflags1
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|ipmsgid
id|u32
id|ipmsgid
suffix:semicolon
DECL|member|iptrgcls
id|u32
id|iptrgcls
suffix:semicolon
DECL|member|ipbfadr1
id|u32
id|ipbfadr1
suffix:semicolon
DECL|member|ipbfln1f
id|u32
id|ipbfln1f
suffix:semicolon
DECL|member|ipsrccls
id|u32
id|ipsrccls
suffix:semicolon
DECL|member|ipmsgtag
id|u32
id|ipmsgtag
suffix:semicolon
DECL|member|ipbfadr2
id|u32
id|ipbfadr2
suffix:semicolon
DECL|member|ipbfln2f
id|u32
id|ipbfln2f
suffix:semicolon
DECL|member|res
id|u32
id|res
suffix:semicolon
DECL|typedef|iparml_db
)brace
id|iparml_db
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ippathid
id|u16
id|ippathid
suffix:semicolon
DECL|member|ipflags1
id|uchar
id|ipflags1
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|ipmsgid
id|u32
id|ipmsgid
suffix:semicolon
DECL|member|ipaudit
id|uchar
id|ipaudit
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|res1
id|uchar
id|res1
(braket
l_int|5
)braket
suffix:semicolon
DECL|member|res2
id|u32
id|res2
suffix:semicolon
DECL|member|ipsrccls
id|u32
id|ipsrccls
suffix:semicolon
DECL|member|ipmsgtag
id|u32
id|ipmsgtag
suffix:semicolon
DECL|member|res3
id|u32
id|res3
(braket
l_int|3
)braket
suffix:semicolon
DECL|typedef|iparml_purge
)brace
id|iparml_purge
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|ipmask
id|uchar
id|ipmask
suffix:semicolon
DECL|member|res1
id|uchar
id|res1
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|iprcode
id|uchar
id|iprcode
suffix:semicolon
DECL|member|res2
id|u32
id|res2
(braket
l_int|9
)braket
suffix:semicolon
DECL|typedef|iparml_set_mask
)brace
id|iparml_set_mask
suffix:semicolon
multiline_comment|/*********************INTERNAL FUNCTIONS*****************************/
r_static
id|ulong
DECL|function|iucv_vmsize
id|iucv_vmsize
(paren
r_void
)paren
(brace
r_extern
r_int
r_int
id|memory_size
suffix:semicolon
r_return
id|memory_size
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: dumpit                                                     &n; * Purpose: print to the console buffers of a given length          &n; * Input: buf - (* uchar) - pointer to buffer to be printed         &n; *        len - int - length of buffer being printed                &n; * Output: void                                                     &n; */
macro_line|#ifdef DEBUG
r_static
r_void
DECL|function|iucv_dumpit
id|iucv_dumpit
(paren
id|uchar
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_mod
l_int|16
)paren
op_logical_and
id|i
op_ne
l_int|0
)paren
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_mod
l_int|4
)paren
op_logical_and
id|i
op_ne
l_int|0
)paren
id|printk
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;%02X&quot;
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
op_mod
l_int|16
)paren
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#else
r_static
r_void
DECL|function|iucv_dumpit
id|iucv_dumpit
(paren
id|uchar
op_star
id|buf
comma
r_int
id|len
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/*&n; * Name iucv_add_handler&n; * Purpose: Place new handle on handler_anchor chain, if identical handler is not&n; *&t;    found. Handlers are ordered with largest mask integer value first.&n; * Input: new_handler - handle that is being entered into chain&n; * Return: int&n; *&t;   0 - handler added&n; *&t;   1 - identical handler found, handler not added to chain&n;*/
r_int
DECL|function|iucv_add_handler
id|iucv_add_handler
(paren
id|handler
op_star
id|new_handler
)paren
(brace
id|handler
op_star
id|R
op_assign
id|new_handler
suffix:semicolon
r_int
id|rc
op_assign
l_int|1
comma
id|comp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* return code (rc = 1 not added) or (rc = 0 added) */
id|ulong
id|flags
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_add_handler: entering&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|new_handler
comma
r_sizeof
(paren
id|handler
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|handler_anchor
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* add to beginning of chain */
id|handler_anchor
op_assign
id|handler_tail
op_assign
id|new_handler
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
(brace
id|comp
op_assign
id|memcmp
(paren
(paren
r_void
op_star
)paren
op_amp
(paren
id|new_handler-&gt;id
)paren
comma
(paren
r_void
op_star
)paren
op_amp
(paren
id|R-&gt;id
)paren
comma
r_sizeof
(paren
id|R-&gt;id
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;comp = %d&bslash;n&quot;
comma
id|comp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|comp
op_eq
l_int|0
)paren
multiline_comment|/* identicle handler found */
r_break
suffix:semicolon
multiline_comment|/* break out of for loop */
r_else
r_if
c_cond
(paren
id|comp
OG
l_int|0
)paren
(brace
multiline_comment|/* new_handler &gt; R */
id|pr_debug
(paren
l_string|&quot;iucv_add_handler: Found a place to add,&quot;
l_string|&quot;R is&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|R
comma
r_sizeof
(paren
id|handler
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|R-&gt;prev
op_ne
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* add to middle of chain */
id|pr_debug
(paren
l_string|&quot;iucv_add_handler: added to middle&bslash;n&quot;
)paren
suffix:semicolon
id|new_handler-&gt;prev
op_assign
id|R-&gt;prev
suffix:semicolon
id|new_handler-&gt;next
op_assign
(paren
id|ulong
op_star
)paren
id|R
suffix:semicolon
(paren
(paren
id|handler
op_star
)paren
(paren
id|R-&gt;prev
)paren
)paren
op_member_access_from_pointer
id|next
op_assign
(paren
id|ulong
op_star
)paren
id|new_handler
suffix:semicolon
id|R-&gt;prev
op_assign
(paren
id|ulong
op_star
)paren
id|new_handler
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* break out of FOR loop */
)brace
r_else
(brace
multiline_comment|/* R-&gt;prev == NULL */
multiline_comment|/* add to start of chain;  */
id|pr_debug
(paren
l_string|&quot;iucv_add_handler:&quot;
l_string|&quot;added to beginning&bslash;n&quot;
)paren
suffix:semicolon
id|R-&gt;prev
op_assign
(paren
id|ulong
op_star
)paren
id|new_handler
suffix:semicolon
id|new_handler-&gt;next
op_assign
(paren
id|ulong
op_star
)paren
id|R
suffix:semicolon
id|handler_anchor
op_assign
id|new_handler
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* break out of FOR loop */
)brace
)brace
multiline_comment|/* end of else if */
)brace
multiline_comment|/* end of for loop */
r_if
c_cond
(paren
id|R
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* add to end of chain */
id|pr_debug
(paren
l_string|&quot;iucv_add_handler: added to end&bslash;n&quot;
)paren
suffix:semicolon
id|handler_tail-&gt;next
op_assign
(paren
id|ulong
op_star
)paren
id|new_handler
suffix:semicolon
id|new_handler-&gt;prev
op_assign
(paren
id|ulong
op_star
)paren
id|handler_tail
suffix:semicolon
id|handler_tail
op_assign
id|new_handler
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;Current Chain of handlers is&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|R
comma
(paren
r_int
)paren
r_sizeof
(paren
id|handler
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_add_handler: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* &n; * Name: iucv_remove_handler&n; * Purpose: Remove handler when application unregisters.&n; * Input: users_handler - handler to be removed&n; * Output: void&n;*/
r_void
DECL|function|iucv_remove_handler
id|iucv_remove_handler
(paren
id|handler
op_star
id|users_handler
)paren
(brace
id|handler
op_star
id|R
suffix:semicolon
multiline_comment|/* used for Debugging */
id|pr_debug
(paren
l_string|&quot;iucv_remove_handler: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|users_handler-&gt;next
op_ne
l_int|NULL
)paren
op_amp
(paren
id|users_handler-&gt;prev
op_ne
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* remove from middle of chain */
(paren
(paren
id|handler
op_star
)paren
(paren
id|users_handler-&gt;next
)paren
)paren
op_member_access_from_pointer
id|prev
op_assign
(paren
id|ulong
op_star
)paren
id|users_handler-&gt;prev
suffix:semicolon
(paren
(paren
id|handler
op_star
)paren
(paren
id|users_handler-&gt;prev
)paren
)paren
op_member_access_from_pointer
id|next
op_assign
(paren
id|ulong
op_star
)paren
id|users_handler-&gt;next
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|users_handler-&gt;next
op_ne
l_int|NULL
)paren
op_amp
(paren
id|users_handler-&gt;prev
op_eq
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* remove from start of chain */
(paren
(paren
id|handler
op_star
)paren
(paren
id|users_handler-&gt;next
)paren
)paren
op_member_access_from_pointer
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|handler_anchor
op_assign
(paren
id|handler
op_star
)paren
id|users_handler-&gt;next
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|users_handler-&gt;next
op_eq
l_int|NULL
)paren
op_amp
(paren
id|users_handler-&gt;prev
op_ne
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* remove from end of chain */
(paren
(paren
id|handler
op_star
)paren
(paren
id|users_handler-&gt;prev
)paren
)paren
op_member_access_from_pointer
id|next
op_assign
l_int|NULL
suffix:semicolon
id|handler_tail
op_assign
(paren
id|handler
op_star
)paren
id|users_handler-&gt;prev
suffix:semicolon
)brace
r_else
(brace
id|handler_anchor
op_assign
l_int|NULL
suffix:semicolon
id|handler_tail
op_assign
l_int|NULL
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;Current Chain of handlers is&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|R
comma
(paren
r_int
)paren
r_sizeof
(paren
id|handler
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_remove_handler: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: b2f0&n; * Purpose: This function calls CP to execute IUCV commands.&n; * Input: code -  identifier of IUCV call to CP.&n; *        parm -  pointer to 40 byte iparml area&n; *               passed to CP&n; * Output: iprcode- return code from CP&squot;s IUCV call&n; * NOTE: Assembler code performing IUCV call&n;*/
r_inline
id|ulong
DECL|function|b2f0
id|b2f0
(paren
id|u32
id|code
comma
r_void
op_star
id|parm
)paren
(brace
id|uchar
op_star
id|iprcode
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iparml before b2f0 call&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|parm
comma
(paren
r_int
)paren
id|BUFFER_SIZE
)paren
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;LRA   1,0(%1)&bslash;n&bslash;t&quot;
l_string|&quot;LR    0,%0&bslash;n&bslash;t&quot;
l_string|&quot;.long 0xb2f01000&quot;
op_scope_resolution
l_string|&quot;d&quot;
(paren
id|code
)paren
comma
l_string|&quot;a&quot;
(paren
id|parm
)paren
suffix:colon
l_string|&quot;0&quot;
comma
l_string|&quot;1&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iparml after b2f0 call&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|parm
comma
(paren
r_int
)paren
id|BUFFER_SIZE
)paren
suffix:semicolon
id|iprcode
op_assign
(paren
id|uchar
op_star
)paren
(paren
id|parm
op_plus
l_int|3
)paren
suffix:semicolon
r_return
(paren
id|ulong
)paren
(paren
op_star
id|iprcode
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_add_pathid                                            &n; * Purpose: Adds a path id to the system.                       &n; * Input: pathid -  pathid that is going to be entered into system              &n; *        handle -  address of handler that the pathid will be associated&n; *&t;&t;   with.&n; *        pgm_data - token passed in by application.                &n; * Output: 0: successful addition of pathid&n; *&t;   - EINVAL - pathid entry is being used by another application&n; *&t;   - ENOMEM - storage allocation for a new pathid table failed      &n;*/
r_int
DECL|function|iucv_add_pathid
id|iucv_add_pathid
(paren
id|u16
id|pathid
comma
id|iucv_handle_t
id|handle
comma
r_void
op_star
id|pgm_data
)paren
(brace
id|ulong
id|add_flag
op_assign
l_int|0
suffix:semicolon
id|ulong
id|old_size
op_assign
l_int|0
comma
id|new_size
op_assign
l_int|0
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|uchar
op_star
id|to
comma
op_star
id|from
suffix:semicolon
multiline_comment|/* pointer for copying the table */
id|handler_table_entry
op_star
id|P
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*P is a pointer to the users H_T_E */
id|handler
op_star
id|users_handler
op_assign
l_int|0
suffix:semicolon
id|ulong
op_star
id|X
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Points to array of pointers to H-T_E */
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: entering&bslash;n&quot;
)paren
suffix:semicolon
id|users_handler
op_assign
(paren
id|handler
op_star
)paren
id|handle
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: users_handler is pointing to %p &quot;
comma
id|users_handler
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * P points to the users handler table entry (H_T_E) in which all entries in&n;&t; * that structure should be NULL. If they&squot;re not NULL, then there&n;&t; * is a bad pointer and it will return(-EINVAL) immediately, otherwise users&n;&t; * data will be entered into H_T_E.&n;&t; */
id|P
op_assign
id|handler_table_anchor
op_plus
id|pathid
suffix:semicolon
multiline_comment|/* index into users handler table */
id|pr_debug
(paren
l_string|&quot;handler_table_anchor is %p&bslash;n&quot;
comma
id|handler_table_anchor
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;P=handler_table_anchor+pathid = %p&bslash;n&quot;
comma
id|P
)paren
suffix:semicolon
r_if
c_cond
(paren
id|P-&gt;addrs
)paren
(brace
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: P = %p &bslash;n&quot;
comma
id|P
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: P-&gt;addrs is %p &bslash;n&quot;
comma
id|P-&gt;addrs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* This message should be sent to syslog */
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_add_pathid: Pathid being used,&quot;
l_string|&quot;error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|P-&gt;addrs
op_assign
id|handle
suffix:semicolon
id|P-&gt;pathid
op_assign
id|pathid
suffix:semicolon
multiline_comment|/*&n;&t; * pgm_data provided in iucv_register may be overwritten on a connect, accept. &n;&t; */
r_if
c_cond
(paren
id|pgm_data
)paren
id|P-&gt;pgm_data
op_assign
id|pgm_data
suffix:semicolon
r_else
id|P-&gt;pgm_data
op_assign
id|users_handler-&gt;pgm_data
suffix:semicolon
multiline_comment|/*&n;&t; * Address of pathid&squot;s iucv_interrupt_ops is taken from the associated handler&n;&t; * and added here for quicker access to the interrupt tables during interrupt&n;&t; * handling.&n;&t; */
id|P-&gt;ops
op_assign
(paren
id|P-&gt;addrs
)paren
op_member_access_from_pointer
id|interrupt_table
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;Complete users H_T_E is&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|P
comma
r_sizeof
(paren
id|handler_table_entry
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Step thru the table of addresses of pathid&squot;s to find the first&n;&t; * available entry (NULL). If an entry is found, add the pathid,&n;&t; * unlock and exit. If an available entry is not found, allocate a&n;&t; * new, larger table, copy over the old table to the new table. De-allocate the&n;&t; * old table and enter the new pathid.&n;&t; */
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: address of handle is %p&bslash;n&quot;
comma
id|handle
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: &amp;(users_handler-&gt;pathid_head) is %p&bslash;n&quot;
comma
op_amp
(paren
id|users_handler-&gt;pathid_head
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: &amp;(users_handler-&gt;pathid_tail) is %p&bslash;n&quot;
comma
op_amp
(paren
id|users_handler-&gt;pathid_tail
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: start of pathid table is %p&bslash;n&quot;
comma
(paren
id|users_handler-&gt;pathid_head
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_add_pathid: end of pathid table is %p&bslash;n&quot;
comma
(paren
id|users_handler-&gt;pathid_tail
)paren
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|users_handler-&gt;pathid_head
comma
(paren
r_int
)paren
(paren
id|users_handler-&gt;pathid_tail
op_minus
id|users_handler-&gt;pathid_head
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|X
op_assign
(paren
id|users_handler-&gt;pathid_head
)paren
suffix:semicolon
id|X
OL
(paren
id|users_handler-&gt;pathid_head
op_plus
id|users_handler-&gt;entries
op_star
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
id|X
op_increment
)paren
r_if
c_cond
(paren
op_star
id|X
op_eq
l_int|NULL
)paren
(brace
id|pr_debug
(paren
l_string|&quot;adding pathid, %p = P&bslash;n&quot;
comma
id|P
)paren
suffix:semicolon
op_star
id|X
op_assign
(paren
id|ulong
)paren
id|P
suffix:semicolon
id|add_flag
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* breaks out of for loop */
)brace
id|pr_debug
(paren
l_string|&quot;Addresses of HTE&squot;s are&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|users_handler-&gt;pathid_head
comma
id|users_handler-&gt;entries
op_star
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|add_flag
op_eq
l_int|0
)paren
(brace
multiline_comment|/* element not added to list: must get a new table */
id|X
op_assign
id|users_handler-&gt;pathid_head
suffix:semicolon
id|old_size
op_assign
id|users_handler-&gt;entries
suffix:semicolon
id|new_size
op_assign
id|old_size
op_plus
id|ADDED_STOR
suffix:semicolon
multiline_comment|/*number of entries of new table */
id|from
op_assign
(paren
id|uchar
op_star
)paren
(paren
id|users_handler-&gt;pathid_head
)paren
suffix:semicolon
multiline_comment|/*address of old table */
id|users_handler-&gt;pathid_head
op_assign
id|kmalloc
(paren
id|new_size
op_star
r_sizeof
(paren
id|ulong
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|users_handler-&gt;pathid_head
op_eq
l_int|NULL
)paren
(brace
id|users_handler-&gt;pathid_head
op_assign
id|X
suffix:semicolon
multiline_comment|/*setting old condition */
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_add_pathid: storage allocation&quot;
l_string|&quot;failed for new pathid table &bslash;n &quot;
)paren
suffix:semicolon
id|memset
(paren
id|P
comma
l_int|0
comma
r_sizeof
(paren
id|handler_table_entry
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|users_handler-&gt;pathid_head
comma
l_int|0
comma
id|new_size
op_star
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
id|to
op_assign
(paren
id|uchar
op_star
)paren
(paren
id|users_handler-&gt;pathid_head
)paren
suffix:semicolon
multiline_comment|/* address of new table */
multiline_comment|/* copy old table to new  */
id|memcpy
(paren
id|to
comma
id|from
comma
id|old_size
op_star
(paren
r_sizeof
(paren
id|ulong
)paren
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv: add_pathid: Getting a new pathid table&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv: add_pathid: to is %p &bslash;n&quot;
comma
id|to
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv: add_pathid: from is %p &bslash;n&quot;
comma
id|from
)paren
suffix:semicolon
id|users_handler-&gt;entries
op_assign
id|new_size
suffix:semicolon
multiline_comment|/* storing new size of table */
id|users_handler-&gt;pathid_tail
op_assign
(paren
id|users_handler-&gt;pathid_head
)paren
op_plus
(paren
id|users_handler-&gt;entries
)paren
suffix:semicolon
id|X
op_assign
id|users_handler-&gt;pathid_head
op_plus
id|old_size
suffix:semicolon
op_star
id|X
op_assign
(paren
id|ulong
)paren
id|P
suffix:semicolon
multiline_comment|/* adding element to new table */
id|pr_debug
(paren
l_string|&quot;iucv: add_pathid: users_handler-&gt;entries is %u &bslash;n&quot;
comma
(paren
r_int
)paren
(paren
id|users_handler-&gt;entries
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv: add_pathid: users_handler-&gt;pathid_tail is %p&bslash;n&quot;
comma
id|users_handler-&gt;pathid_tail
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;users_handler-&gt;pathid_head is %p &bslash;n&quot;
comma
id|users_handler-&gt;pathid_head
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv: add_pathid: X is %p &bslash;n&quot;
comma
id|X
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv: add_pathid: *X is %u &bslash;n&quot;
comma
(paren
r_int
)paren
(paren
op_star
id|X
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;Addresses of HTE&squot;s after getting new table is&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|users_handler-&gt;pathid_head
comma
id|users_handler-&gt;entries
op_star
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;New handler is&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|users_handler
comma
r_sizeof
(paren
id|handler
)paren
)paren
suffix:semicolon
id|kfree
(paren
id|from
)paren
suffix:semicolon
multiline_comment|/* free old table */
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_dd_pathid: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* end of add_pathid function */
multiline_comment|/*&n; * Name: iucv_declare_buffer                                    &n; * Purpose: Specifies the guests real address of an external  &n; *          interrupt.                                        &n; * Input: void                             &n; * Output: iprcode - return code from b2f0 call               &n;*/
r_int
DECL|function|iucv_declare_buffer
id|iucv_declare_buffer
(paren
r_void
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_declare_buffer: entering&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipbfadr1
op_assign
id|virt_to_phys
(paren
(paren
id|uchar
op_star
)paren
id|iucv_external_int_buffer
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|DECLARE_BUFFER
comma
op_amp
id|parm
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_declare_buffer: Address of EIB = %p&bslash;n&quot;
comma
id|iucv_external_int_buffer
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_declare_buffer: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_retrieve_buffer&n; * Purpose: Terminates all use of IUCV.&n; * Input: void&n; * Output:&n; *      b2f0_result: return code from CP&n;*/
r_int
DECL|function|iucv_retrieve_buffer
id|iucv_retrieve_buffer
(paren
r_void
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_retrieve_buffer: entering&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|RETRIEVE_BUFFER
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
op_eq
l_int|NULL
)paren
(brace
id|kfree
(paren
id|handler_table_anchor
)paren
suffix:semicolon
id|handler_table_anchor
op_assign
l_int|NULL
suffix:semicolon
id|declare_flag
op_assign
l_int|0
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;iucv_retrieve_buffer: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_register_program&n; * Purpose: Registers an application with IUCV.   &n; * Input: prmname - user identification&n; *        userid  - machine identification&n; *        pgmmask - indicates which bits in the prmname and userid combined will be used&n; *&t;   to determine who is given control&n; *        ops - address of vector of interrupt handlers&n; *        pgm_data- application data passed to interrupt handlers&n; * Output: NA&n; * Return: type: iucv_handle_t&n; *          address of handler&n; *         (0) - registration failed&n; *&t;       - Machine size &gt; 2GB&n; *&t;       - new_handler kmalloc failed&n; * &t;       - pgmname was not provided&n; *&t;       - pathid_table kmalloc failed&n; *             - application with identical pgmname, userid, and pgmmask is registered&n; * &t;       - iucv_declare_buffer failed&n; * NOTE: pgmmask&n; *&t;When pgmname, userid, pgmmask is provided, mask is entered into the handler&n; *&t;as is.&n; *&t;When pgmname, userid is provided, pgmmask is all 0xff&squot;s&n; *&t;When pgmname, pgmmask is provided, the first 8 bytes = 0x00 and the last 16&n; *      bytes are as provided by pgmmask. &n; *&t;When pgmname is provided is provided, the first 8 bytes = 0x00 and the last&n; *&t;16 bytes are 0xff.   &n;*/
id|iucv_handle_t
DECL|function|iucv_register_program
id|iucv_register_program
(paren
id|uchar
id|pgmname
(braket
l_int|16
)braket
comma
id|uchar
id|userid
(braket
l_int|8
)braket
comma
id|uchar
id|pgmmask
(braket
l_int|24
)braket
comma
id|iucv_interrupt_ops_t
op_star
id|ops
comma
r_void
op_star
id|pgm_data
)paren
(brace
id|ulong
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* return code from function calls */
id|ulong
id|machine_size
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* size of virtual machine */
r_static
id|u32
id|maxconn1
suffix:semicolon
id|handler
op_star
id|new_handler
op_assign
l_int|NULL
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_register_program:entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ops
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* interrupt table is not defined */
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_program:&quot;
l_string|&quot;Interrupt table is not defined, exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|declare_flag
op_eq
l_int|0
)paren
(brace
multiline_comment|/* check size of virtual machine */
r_if
c_cond
(paren
(paren
id|machine_size
op_assign
id|iucv_vmsize
(paren
)paren
)paren
OG
l_int|0x100000000
)paren
(brace
multiline_comment|/* 2GB */
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_progam: Virtual&quot;
l_string|&quot;storage = %lx hex,&quot;
l_string|&quot;exiting&bslash;n&quot;
comma
id|machine_size
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;machine_size is %lx&bslash;n&quot;
comma
id|machine_size
)paren
suffix:semicolon
id|maxconn1
op_assign
id|iucv_query_maxconn
(paren
)paren
suffix:semicolon
id|handler_table_anchor
op_assign
id|kmalloc
(paren
id|maxconn1
op_star
r_sizeof
(paren
id|handler_table_entry
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|handler_table_anchor
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_program:&quot;
l_string|&quot;handler_table_anchor&quot;
l_string|&quot;storage allocation failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
(paren
id|handler_table_anchor
comma
l_int|0
comma
id|maxconn1
op_star
r_sizeof
(paren
id|handler_table_entry
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate handler table */
id|new_handler
op_assign
(paren
id|handler
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|handler
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_handler
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_program: storage allocation&quot;
l_string|&quot;for new handler failed. &bslash;n &quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
(paren
id|new_handler
comma
l_int|0
comma
r_sizeof
(paren
id|handler
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pgmname
)paren
(brace
id|memcpy
(paren
id|new_handler-&gt;id.user_data
comma
id|pgmname
comma
r_sizeof
(paren
id|new_handler-&gt;id.user_data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|userid
)paren
(brace
id|memcpy
(paren
id|new_handler-&gt;id.userid
comma
id|userid
comma
r_sizeof
(paren
id|new_handler-&gt;id.userid
)paren
)paren
suffix:semicolon
id|ASCEBC
(paren
id|new_handler-&gt;id.userid
comma
r_sizeof
(paren
id|new_handler-&gt;id.userid
)paren
)paren
suffix:semicolon
id|EBC_TOUPPER
(paren
id|new_handler-&gt;id.userid
comma
r_sizeof
(paren
id|new_handler-&gt;id.userid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pgmmask
)paren
(brace
id|memcpy
(paren
id|new_handler-&gt;id.mask
comma
id|pgmmask
comma
r_sizeof
(paren
id|new_handler-&gt;id.mask
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
(paren
id|new_handler-&gt;id.mask
comma
l_int|0xFF
comma
r_sizeof
(paren
id|new_handler-&gt;id.mask
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|pgmmask
)paren
(brace
id|memcpy
(paren
id|new_handler-&gt;id.mask
comma
id|pgmmask
comma
r_sizeof
(paren
id|new_handler-&gt;id.mask
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
(paren
id|new_handler-&gt;id.mask
comma
l_int|0xFF
comma
r_sizeof
(paren
id|new_handler-&gt;id.mask
)paren
)paren
suffix:semicolon
)brace
id|memset
(paren
id|new_handler-&gt;id.mask
comma
l_int|0x00
comma
r_sizeof
(paren
id|new_handler-&gt;id.userid
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|kfree
(paren
id|new_handler
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_program: pgmname not&quot;
l_string|&quot;provided&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* fill in the rest of handler */
id|new_handler-&gt;pgm_data
op_assign
id|pgm_data
suffix:semicolon
id|new_handler-&gt;interrupt_table
op_assign
id|ops
suffix:semicolon
id|new_handler-&gt;entries
op_assign
id|ADDED_STOR
suffix:semicolon
multiline_comment|/* Allocate storage for pathid table */
id|new_handler-&gt;pathid_head
op_assign
id|kmalloc
(paren
id|new_handler-&gt;entries
op_star
r_sizeof
(paren
id|ulong
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_handler-&gt;pathid_head
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_program: storage allocation&quot;
l_string|&quot;failed&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|new_handler
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
(paren
id|new_handler-&gt;pathid_head
comma
l_int|0
comma
id|new_handler-&gt;entries
op_star
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
id|new_handler-&gt;pathid_tail
op_assign
id|new_handler-&gt;pathid_head
op_plus
id|new_handler-&gt;entries
suffix:semicolon
multiline_comment|/* &n;&t; * Check if someone else is registered with same pgmname, userid, and mask. &n;&t; * If someone is already registered with same pgmname, userid, and mask &n;&t; * registration will fail and NULL will be returned to the application. &n;&t; * If identical handler not found, then handler is added to list.&n;&t; */
id|rc
op_assign
id|iucv_add_handler
(paren
id|new_handler
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_program: Someone already&quot;
l_string|&quot;registered with same pgmname, userid, pgmmask&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|new_handler-&gt;pathid_head
)paren
suffix:semicolon
id|kfree
(paren
id|new_handler
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|declare_flag
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|iucv_declare_buffer
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|kfree
(paren
id|handler_table_anchor
)paren
suffix:semicolon
id|kfree
(paren
id|new_handler-&gt;pathid_head
)paren
suffix:semicolon
id|kfree
(paren
id|new_handler
)paren
suffix:semicolon
id|handler_table_anchor
op_assign
l_int|NULL
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_program: rc from&quot;
l_string|&quot;iucv_declare_buffer is:% ld &bslash;n &quot;
comma
id|rc
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* request the 0x4000 external interrupt */
id|rc
op_assign
id|register_external_interrupt
(paren
l_int|0x4000
comma
id|top_half_interrupt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|iucv_retrieve_buffer
(paren
)paren
suffix:semicolon
id|kfree
(paren
id|new_handler-&gt;pathid_head
)paren
suffix:semicolon
id|kfree
(paren
id|new_handler
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_register_program: rc from&quot;
l_string|&quot;register_external_interrupt is:% ld &bslash;n &quot;
comma
id|rc
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|declare_flag
op_assign
l_int|1
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;iucv_register_program: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|new_handler
suffix:semicolon
)brace
multiline_comment|/* end of register function */
multiline_comment|/*&n; * Name: iucv_unregister_program&n; * Purpose: Unregister application with IUCV.&n; * Input: handle address of handler&n; * Output: NA&n; * Return: (0) - Normal return&n; *         (-EINVAL)- Matching handler was not found&n;*/
r_int
DECL|function|iucv_unregister_program
id|iucv_unregister_program
(paren
id|iucv_handle_t
id|handle
)paren
(brace
id|handler
op_star
id|users_handler
op_assign
l_int|0
comma
op_star
id|R
suffix:semicolon
id|handler_table_entry
op_star
id|H_T_E
op_assign
l_int|0
suffix:semicolon
id|ulong
op_star
id|S
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*points to the beginning of block of h_t_e&squot;s */
id|ulong
id|flags
suffix:semicolon
id|u16
id|pathid_sever
op_assign
l_int|0
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_unregister_program: entering&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_unregister_program: address of handle is %p&bslash;n&quot;
comma
id|handle
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
id|users_handler
op_assign
(paren
id|handler
op_star
)paren
id|handle
suffix:semicolon
multiline_comment|/* &n;&t; * Checking if handle is still registered: if yes, continue&n;&t; *  if not registered, return.&n;&t; */
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
r_if
c_cond
(paren
id|users_handler
op_eq
id|R
)paren
(brace
id|pr_debug
(paren
l_string|&quot;iucv_unregister_program: found a matching&quot;
l_string|&quot;handler&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|R
)paren
(brace
id|pr_debug
(paren
l_string|&quot;You are not registered&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|S
op_assign
id|users_handler-&gt;pathid_head
suffix:semicolon
r_while
c_loop
(paren
id|S
OL
(paren
id|users_handler-&gt;pathid_tail
)paren
)paren
(brace
multiline_comment|/* index thru table */
r_if
c_cond
(paren
op_star
id|S
)paren
(brace
id|H_T_E
op_assign
(paren
id|handler_table_entry
op_star
)paren
(paren
op_star
id|S
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_unregister_program: pointer to H_T_E is&quot;
l_string|&quot;%p&bslash;n&quot;
comma
id|H_T_E
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_unregister_program: address of handle in&quot;
l_string|&quot;H_T_E is %p&quot;
comma
(paren
id|H_T_E-&gt;addrs
)paren
)paren
suffix:semicolon
id|pathid_sever
op_assign
id|H_T_E-&gt;pathid
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
id|iucv_sever
(paren
id|pathid_sever
comma
id|users_handler-&gt;id.user_data
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|S
op_increment
suffix:semicolon
multiline_comment|/* index by address */
)brace
id|kfree
(paren
id|users_handler-&gt;pathid_head
)paren
suffix:semicolon
id|iucv_remove_handler
(paren
id|users_handler
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
(paren
id|handle
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_unregister_program: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_accept&n; * Purpose: This function is issued after the user receives a Connection Pending external&n; *          interrupt and now wishes to complete the IUCV communication path.&n; * Input:  pathid - u16 , path identification number   &n; *         msglim_reqstd - u16, The number of outstanding messages requested.&n; *         user_data - uchar[16], Data specified by the iucv_connect function.&n; *&t;   flags1 - int, Contains options for this path.&n; *           -IPPRTY - 0x20- Specifies if you want to send priority message.&n; *           -IPRMDATA - 0x80, Specifies whether your program can handle a message&n; *            &t;in  the parameter list.&n; *           -IPQUSCE - 0x40, Specifies whether you want to quiesce the path being&n; *&t;&t;established.&n; *         handle - iucv_handle_t, Address of handler.&n; *         pgm_data - ulong, Application data passed to interrupt handlers.&n; *&t;   flags1_out - int *, Options for path.&n; *           IPPRTY - 0x20 - Indicates you may send a priority message.&n; *         priority_permitted -uchar *, Indicates you may send priority messages.&n; *         msglim - *u16, Number of outstanding messages.&n; * Output: b2f0_result - return code from CP&n;*/
r_int
DECL|function|iucv_accept
id|iucv_accept
(paren
id|u16
id|pathid
comma
id|u16
id|msglim_reqstd
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
comma
r_int
id|flags1
comma
id|iucv_handle_t
id|handle
comma
r_void
op_star
id|pgm_data
comma
r_int
op_star
id|flags1_out
comma
id|u16
op_star
id|msglim
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|handler
op_star
id|R
op_assign
l_int|NULL
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_accept: entering &bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_accept: pathid = %d&bslash;n&quot;
comma
id|pathid
)paren
suffix:semicolon
multiline_comment|/* Checking if handle is valid  */
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
r_if
c_cond
(paren
id|R
op_eq
id|handle
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|R
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_connect: NULL handle passed by&quot;
l_string|&quot;application&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsglim
op_assign
id|msglim_reqstd
suffix:semicolon
r_if
c_cond
(paren
id|user_data
)paren
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
r_sizeof
(paren
id|parm.ipuser
)paren
)paren
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|uchar
)paren
id|flags1
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|ACCEPT
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pgm_data
)paren
(paren
id|handler_table_anchor
op_plus
id|pathid
)paren
op_member_access_from_pointer
id|pgm_data
op_assign
id|pgm_data
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipflags1
op_amp
id|IPPRTY
)paren
r_if
c_cond
(paren
id|flags1_out
)paren
(brace
id|pr_debug
(paren
l_string|&quot;*flags1_out = %d&bslash;n&quot;
comma
op_star
id|flags1_out
)paren
suffix:semicolon
op_star
id|flags1_out
op_assign
l_int|0
suffix:semicolon
op_star
id|flags1_out
op_or_assign
id|IPPRTY
suffix:semicolon
id|pr_debug
(paren
l_string|&quot; *flags1_out = %d&bslash;n&quot;
comma
op_star
id|flags1_out
)paren
suffix:semicolon
)brace
)brace
id|pr_debug
(paren
l_string|&quot;iucv_accept: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_connect                                         &n; * Purpose: This function establishes an IUCV path. Although the connect may complete&n; *&t;    successfully, you are not able to use the path until you receive an IUCV &n; *          Connection Complete external interrupt.            &n; * Input: pathid - u16 *, path identification number          &n; *        msglim_reqstd - u16, number of outstanding messages requested       &n; *        user_data - uchar[16], 16-byte user data                    &n; *        userid - uchar[8], 8-byte of user identification                        &n; *        system_name - uchar[8], 8-byte identifying the system name &n; *        flags1 - int, Contains options for this path.&n; *          -IPPRTY - 0x20- Specifies if you want to send priority message.&n; *          -IPRMDATA - 0x80, Specifies whether your program can handle a message&n; *               in  the parameter list.&n; *          -IPQUSCE - 0x40, Specifies whether you want to quiesce the path being&n; *              established.&n; *          -IPLOCAL - 0X01, allows an application to force the partner to be on the&n; *              local system. If local is specified then target class cannot be&n; *              specified.  &n; *         flags1_out - int *, Options for path. &n; *           IPPRTY - 0x20 - Indicates you may send a priority message.&n; *        msglim - * u16, number of outstanding messages&n; *        handle - iucv_handle_t, address of handler                         &n; *        pgm_data - *void, application data passed to interrupt handlers                  &n; * Output: b2f0_result - return code from CP&n; *         -ENOMEM&n; *         rc - return code from iucv_declare_buffer&n; *         -EINVAL - invalid handle passed by application &n; *         -EINVAL - pathid address is NULL &n; *&t;   -ENOMEM - pathid table storage allocation failed&n; *         add_pathid_result - return code from internal function add_pathid             &n;*/
r_int
DECL|function|iucv_connect
id|iucv_connect
(paren
id|u16
op_star
id|pathid
comma
id|u16
id|msglim_reqstd
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
comma
id|uchar
id|userid
(braket
l_int|8
)braket
comma
id|uchar
id|system_name
(braket
l_int|8
)braket
comma
r_int
id|flags1
comma
r_int
op_star
id|flags1_out
comma
id|u16
op_star
id|msglim
comma
id|iucv_handle_t
id|handle
comma
r_void
op_star
id|pgm_data
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_int
id|add_pathid_result
op_assign
l_int|0
suffix:semicolon
id|handler
op_star
id|R
op_assign
l_int|NULL
suffix:semicolon
id|uchar
id|no_memory
(braket
l_int|16
)braket
op_assign
l_string|&quot;NO MEMORY&quot;
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_connect: entering &bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Checking if handle is valid  */
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
r_if
c_cond
(paren
id|R
op_eq
id|handle
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|R
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_connect: NULL handle passed by&quot;
l_string|&quot;application&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pathid
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_connect: NULL pathid pointer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|iparml_control
)paren
)paren
suffix:semicolon
id|parm.ipmsglim
op_assign
id|msglim_reqstd
suffix:semicolon
r_if
c_cond
(paren
id|user_data
)paren
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
r_sizeof
(paren
id|parm.ipuser
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|userid
)paren
(brace
id|memcpy
(paren
id|parm.ipvmid
comma
id|userid
comma
r_sizeof
(paren
id|parm.ipvmid
)paren
)paren
suffix:semicolon
id|ASCEBC
(paren
id|parm.ipvmid
comma
r_sizeof
(paren
id|parm.ipvmid
)paren
)paren
suffix:semicolon
id|EBC_TOUPPER
(paren
id|parm.ipvmid
comma
r_sizeof
(paren
id|parm.ipvmid
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|system_name
)paren
(brace
id|memcpy
(paren
id|parm.iptarget
comma
id|system_name
comma
r_sizeof
(paren
id|parm.iptarget
)paren
)paren
suffix:semicolon
id|ASCEBC
(paren
id|parm.iptarget
comma
r_sizeof
(paren
id|parm.iptarget
)paren
)paren
suffix:semicolon
id|EBC_TOUPPER
(paren
id|parm.iptarget
comma
r_sizeof
(paren
id|parm.iptarget
)paren
)paren
suffix:semicolon
)brace
id|parm.ipflags1
op_assign
(paren
id|uchar
)paren
id|flags1
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|CONNECT
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
)paren
r_return
id|b2f0_result
suffix:semicolon
id|add_pathid_result
op_assign
id|iucv_add_pathid
(paren
id|parm.ippathid
comma
id|handle
comma
id|pgm_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|add_pathid_result
)paren
(brace
id|iucv_sever
(paren
id|parm.ippathid
comma
id|no_memory
)paren
suffix:semicolon
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv_connect: add_pathid failed with rc =&quot;
l_string|&quot;%d&bslash;n&quot;
comma
id|add_pathid_result
)paren
suffix:semicolon
r_return
(paren
id|add_pathid_result
)paren
suffix:semicolon
)brace
op_star
id|pathid
op_assign
id|parm.ippathid
suffix:semicolon
r_if
c_cond
(paren
id|msglim
)paren
op_star
id|msglim
op_assign
id|parm.ipmsglim
suffix:semicolon
r_if
c_cond
(paren
id|parm.ipflags1
op_amp
id|IPPRTY
)paren
r_if
c_cond
(paren
id|flags1_out
)paren
(brace
op_star
id|flags1_out
op_assign
l_int|0
suffix:semicolon
op_star
id|flags1_out
op_or_assign
id|IPPRTY
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;iucv_connect: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_purge                                           &n; * Purpose: Cancels a message you have sent.                   &n; * Input: pathid -   address of pathid                                  &n; *        msgid  -   address of message identification             &n; *        srccls -   address of source message class                     &n; *        audit  -  contains information about                              &n; *                 asynchronous error that may have affected                           &n; *                 the normal completion of this message.                  &n; * Output:b2f0_result - return code from CP                   &n;*/
r_int
DECL|function|iucv_purge
id|iucv_purge
(paren
id|u16
id|pathid
comma
id|u32
id|msgid
comma
id|u32
id|srccls
comma
id|uchar
id|audit
(braket
l_int|3
)braket
)paren
(brace
id|iparml_purge
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_purge: entering&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_purge: pathid = %d &bslash;n&quot;
comma
id|pathid
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipflags1
op_or_assign
(paren
id|IPSRCCLS
op_or
id|IPFGMID
op_or
id|IPFGPID
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|PURGE
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_and
(paren
id|audit
)paren
)paren
id|memcpy
(paren
id|audit
comma
id|parm.ipaudit
comma
r_sizeof
(paren
id|parm.ipaudit
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_purge: b2f0_result = %ld &bslash;n&quot;
comma
id|b2f0_result
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_purge: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_query_maxconn                                            &n; * Purpose: Determines the maximum number of connections thay may be established.&n; * Output: maxconn - ulong: Maximum number of connections that can be.     &n;*/
id|ulong
DECL|function|iucv_query_maxconn
id|iucv_query_maxconn
(paren
r_void
)paren
(brace
id|iparml_purge
id|parm
suffix:semicolon
multiline_comment|/* DOESN&squot;T MATTER WHICH IPARML IS USED    */
r_static
id|u32
id|maxconn1
comma
id|bufsize1
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_query_maxconn: entering&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
multiline_comment|/* Assembler instruction calling b2f0  and storing R0 and R1 */
id|asm
r_volatile
(paren
l_string|&quot;LRA   1,0(%3)&bslash;n&bslash;t&quot;
l_string|&quot;LR    0,%2&bslash;n&bslash;t&quot;
l_string|&quot;.long 0xb2f01000&bslash;n&bslash;t&quot;
l_string|&quot;ST    0,%0&bslash;n&bslash;t&quot;
l_string|&quot;ST    1,%1&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|bufsize1
)paren
comma
l_string|&quot;=m&quot;
(paren
id|maxconn1
)paren
suffix:colon
l_string|&quot;d&quot;
(paren
id|QUERY
)paren
comma
l_string|&quot;a&quot;
(paren
op_amp
id|parm
)paren
suffix:colon
l_string|&quot;0&quot;
comma
l_string|&quot;1&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot; bufsize1 = %d and maxconn1 = %d &bslash;n&quot;
comma
id|bufsize1
comma
id|maxconn1
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_query_maxconn: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|maxconn1
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_query_bufsize&n; * Purpose: Determines the size of the external interrupt buffer.&n; * Output: bufsize - ulong: Size of external interrupt buffer.&n; */
id|ulong
DECL|function|iucv_query_bufsize
id|iucv_query_bufsize
(paren
r_void
)paren
(brace
id|iparml_purge
id|parm
suffix:semicolon
multiline_comment|/* DOESN&squot;T MATTER WHICH IPARML IS USED    */
r_static
id|u32
id|maxconn1
comma
id|bufsize1
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_query_bufsize: entering&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_query_maxconn: entering&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
multiline_comment|/* Assembler instruction calling b2f0  and storing R0 and R1 */
id|asm
r_volatile
(paren
l_string|&quot;LRA   1,0(%3)&bslash;n&bslash;t&quot;
l_string|&quot;LR    0,%2&bslash;n&bslash;t&quot;
l_string|&quot;.long 0xb2f01000&bslash;n&bslash;t&quot;
l_string|&quot;ST    0,%0&bslash;n&bslash;t&quot;
l_string|&quot;ST    1,%1&bslash;n&bslash;t&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|bufsize1
)paren
comma
l_string|&quot;=m&quot;
(paren
id|maxconn1
)paren
suffix:colon
l_string|&quot;d&quot;
(paren
id|QUERY
)paren
comma
l_string|&quot;a&quot;
(paren
op_amp
id|parm
)paren
suffix:colon
l_string|&quot;0&quot;
comma
l_string|&quot;1&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot; bufsize1 = %d and maxconn1 = %d &bslash;n&quot;
comma
id|bufsize1
comma
id|maxconn1
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_query_bufsize: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|bufsize1
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_quiesce                                         &n; * Purpose: temporarily suspends incoming messages on an IUCV path.&n; *          You can later reactivate the path by invoking the iucv_resume function        &n; * Input: pathid - u16, path identification number                             &n; *        user_data - uchar[16], 16-byte user data                      &n; * Output: b2f0_result - return code from CP               &n; */
r_int
DECL|function|iucv_quiesce
id|iucv_quiesce
(paren
id|u16
id|pathid
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_quiesce: entering &bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_quiesce: pathid = %d&bslash;n&quot;
comma
id|pathid
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
r_sizeof
(paren
id|parm.ipuser
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|QUIESCE
comma
op_amp
id|parm
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_quiesce: b2f0_result = %ld&bslash;n&quot;
comma
id|b2f0_result
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_quiesce: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_receive&n; * Purpose: This function receives messages that are being sent to you&n; *          over established paths. &n; * Input:&n; *        pathid - path identification number&n; *        buffer - address of buffer to receive&n; *        buflen - length of buffer to receive&n; *        msgid - specifies the message ID.&n; *        trgcls - specifies target class&n; * Output:&n; *&t; flags1_out: Options for path.&n; *         IPNORPY - 0x10 specifies whether a reply is required&n; *         IPPRTY - 0x20 specifies if you want to send priority message&n; *         IPRMDATA - 0x80 specifies the data is contained in the parameter list&n; *       residual_buffer - address of buffer updated by the number&n; *                         of bytes you have received.&n; *       residual_length - &n; *&t;&t;Contains one of the following values, if the receive buffer is:&n; *&t;&t; The same length as the message, this field is zero.&n; *&t;&t; Longer than the message, this field contains the number of&n; *&t;&t;  bytes remaining in the buffer.&n; *&t;&t; Shorter than the message, this field contains the residual&n; *&t;&t;  count (that is, the number of bytes remaining in the&n; *&t;&t;  message that does not fit into the buffer. In this&n; *&t;&t;  case b2f0_result = 5. &n; * Return: b2f0_result - return code from CP IUCV call.&n; *         (-EINVAL) - buffer address is pointing to NULL&n; */
r_int
DECL|function|iucv_receive
id|iucv_receive
(paren
id|u16
id|pathid
comma
id|u32
id|msgid
comma
id|u32
id|trgcls
comma
r_void
op_star
id|buffer
comma
id|ulong
id|buflen
comma
r_int
op_star
id|flags1_out
comma
id|ulong
op_star
id|residual_buffer
comma
id|ulong
op_star
id|residual_length
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
r_int
id|moved
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of bytes moved from parmlist to buffer */
id|pr_debug
(paren
l_string|&quot;iucv_receive: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|u32
)paren
id|buffer
suffix:semicolon
id|parm.ipbfln1f
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|buflen
)paren
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPFGPID
op_or
id|IPFGMID
op_or
id|IPFGMCL
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|RECEIVE
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
op_eq
l_int|0
op_logical_or
id|b2f0_result
op_eq
l_int|5
)paren
(brace
r_if
c_cond
(paren
id|flags1_out
)paren
(brace
id|pr_debug
(paren
l_string|&quot;*flags1_out = %d&bslash;n&quot;
comma
op_star
id|flags1_out
)paren
suffix:semicolon
op_star
id|flags1_out
op_assign
(paren
id|parm.ipflags1
op_amp
(paren
op_complement
l_int|0x07
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;*flags1_out = %d&bslash;n&quot;
comma
op_star
id|flags1_out
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|parm.ipflags1
op_amp
id|IPRMDATA
)paren
)paren
(brace
multiline_comment|/*msg not in parmlist */
r_if
c_cond
(paren
id|residual_length
)paren
op_star
id|residual_length
op_assign
id|parm.ipbfln1f
suffix:semicolon
r_if
c_cond
(paren
id|residual_buffer
)paren
op_star
id|residual_buffer
op_assign
id|parm.ipbfadr1
suffix:semicolon
)brace
r_else
(brace
id|moved
op_assign
id|min
(paren
id|buflen
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
(paren
(paren
r_char
op_star
)paren
id|buffer
comma
(paren
r_char
op_star
)paren
op_amp
id|parm.ipbfadr1
comma
id|moved
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflen
OL
l_int|8
)paren
id|b2f0_result
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|residual_length
)paren
op_star
id|residual_length
op_assign
id|abs
(paren
id|buflen
op_minus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|residual_buffer
)paren
op_star
id|residual_buffer
op_assign
(paren
id|ulong
)paren
(paren
id|buffer
op_plus
id|moved
)paren
suffix:semicolon
)brace
)brace
id|pr_debug
(paren
l_string|&quot;iucv_receive: exiting &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_receive_array&n; * Purpose: This function receives messages that are being sent to you&n; *          over established paths. &n; * Input: pathid - path identification number&n; *        buffer - address of array of buffers&n; *        buflen - total length of buffers&n; *        msgid - specifies the message ID.&n; *        trgcls - specifies target class&n; * Output:&n; *        flags1_out: Options for path.&n; *          IPNORPY - 0x10 specifies whether a reply is required&n; *          IPPRTY - 0x20 specifies if you want to send priority message&n; *         IPRMDATA - 0x80 specifies the data is contained in the parameter list&n; *       residual_buffer - address points to the current list entry IUCV&n; *                         is working on.&n; *       residual_length -&n; *              Contains one of the following values, if the receive buffer is:&n; *               The same length as the message, this field is zero.&n; *               Longer than the message, this field contains the number of&n; *                bytes remaining in the buffer.&n; *               Shorter than the message, this field contains the residual&n; *                count (that is, the number of bytes remaining in the&n; *                message that does not fit into the buffer. In this case&n; *&t;&t;  b2f0_result = 5.&n; * Return: b2f0_result - return code from CP&n; *         (-EINVAL) - buffer address is NULL&n; */
r_int
DECL|function|iucv_receive_array
id|iucv_receive_array
(paren
id|u16
id|pathid
comma
id|u32
id|msgid
comma
id|u32
id|trgcls
comma
id|iucv_array_t
op_star
id|buffer
comma
id|ulong
id|buflen
comma
r_int
op_star
id|flags1_out
comma
id|ulong
op_star
id|residual_buffer
comma
id|ulong
op_star
id|residual_length
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|moved
op_assign
l_int|0
comma
id|need_to_move
op_assign
l_int|8
comma
id|dyn_len
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_receive_array: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|buffer
)paren
suffix:semicolon
id|parm.ipbfln1f
op_assign
(paren
id|u32
)paren
id|buflen
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPBUFLST
op_or
id|IPFGPID
op_or
id|IPFGMID
op_or
id|IPFGMCL
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|RECEIVE
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b2f0_result
op_eq
l_int|0
op_logical_or
id|b2f0_result
op_eq
l_int|5
)paren
(brace
r_if
c_cond
(paren
id|flags1_out
)paren
(brace
id|pr_debug
(paren
l_string|&quot;*flags1_out = %d&bslash;n&quot;
comma
op_star
id|flags1_out
)paren
suffix:semicolon
op_star
id|flags1_out
op_assign
(paren
id|parm.ipflags1
op_amp
(paren
op_complement
l_int|0x07
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;*flags1_out = %d&bslash;n&quot;
comma
op_star
id|flags1_out
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|parm.ipflags1
op_amp
id|IPRMDATA
)paren
)paren
(brace
multiline_comment|/*msg not in parmlist */
r_if
c_cond
(paren
id|residual_length
)paren
op_star
id|residual_length
op_assign
id|parm.ipbfln1f
suffix:semicolon
r_if
c_cond
(paren
id|residual_buffer
)paren
op_star
id|residual_buffer
op_assign
id|parm.ipbfadr1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* copy msg from parmlist to users array. */
r_while
c_loop
(paren
(paren
id|moved
OL
l_int|8
)paren
op_logical_and
(paren
id|moved
OL
id|buflen
)paren
)paren
(brace
id|dyn_len
op_assign
id|min
(paren
(paren
id|buffer
op_plus
id|i
)paren
op_member_access_from_pointer
id|length
comma
id|need_to_move
)paren
suffix:semicolon
id|memcpy
(paren
(paren
r_char
op_star
)paren
(paren
(paren
id|ulong
)paren
(paren
(paren
id|buffer
op_plus
id|i
)paren
op_member_access_from_pointer
id|address
)paren
)paren
comma
(paren
(paren
r_char
op_star
)paren
op_amp
id|parm.ipbfadr1
)paren
op_plus
id|moved
comma
id|dyn_len
)paren
suffix:semicolon
id|moved
op_add_assign
id|dyn_len
suffix:semicolon
id|need_to_move
op_sub_assign
id|dyn_len
suffix:semicolon
(paren
id|buffer
op_plus
id|i
)paren
op_member_access_from_pointer
id|address
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
(paren
id|uchar
op_star
)paren
(paren
(paren
id|ulong
)paren
(paren
id|buffer
op_plus
id|i
)paren
op_member_access_from_pointer
id|address
)paren
op_plus
id|dyn_len
)paren
suffix:semicolon
(paren
id|buffer
op_plus
id|i
)paren
op_member_access_from_pointer
id|length
op_sub_assign
id|dyn_len
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|need_to_move
)paren
multiline_comment|/* buflen &lt; 8 bytes */
id|b2f0_result
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|residual_length
)paren
op_star
id|residual_length
op_assign
id|abs
(paren
id|buflen
op_minus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|residual_buffer
)paren
(brace
r_if
c_cond
(paren
id|moved
op_eq
l_int|0
)paren
op_star
id|residual_buffer
op_assign
(paren
id|ulong
)paren
id|buffer
suffix:semicolon
r_else
op_star
id|residual_buffer
op_assign
(paren
id|ulong
)paren
(paren
id|buffer
op_plus
(paren
id|i
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|pr_debug
(paren
l_string|&quot;iucv_receive_array: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_reject                                          &n; * Purpose: Refuses a specified message. Between the time you are notified of a &n; *          message and the time that you complete the message, the message may&n; *          be rejected.                                 &n; * Input: pathid - u16, path identification number.                            &n; *        msgid  - u32, specifies the message ID.&n; *        trgcls - u32, specifies target class.                &n; * Output: b2f0_result - return code from CP&n; * NOTE: see b2f0 output list                                 &n;*/
r_int
DECL|function|iucv_reject
id|iucv_reject
(paren
id|u16
id|pathid
comma
id|u32
id|msgid
comma
id|u32
id|trgcls
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_reject: entering &bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_reject: pathid = %d&bslash;n&quot;
comma
id|pathid
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPFGMCL
op_or
id|IPFGMID
op_or
id|IPFGPID
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|REJECT
comma
op_amp
id|parm
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_reject: b2f0_result = %ld&bslash;n&quot;
comma
id|b2f0_result
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_reject: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/* &n; * Name: iucv_reply&n; * Purpose: This function responds to the two-way messages that you&n; *          receive. You must identify completely the message to&n; *          which you wish to reply. ie, pathid, msgid, and trgcls.&n; * Input: pathid - path identification number&n; *        msgid - specifies the message ID. &n; *        trgcls - specifies target class&n; *        flags1 - option for path&n; *                 IPPRTY- 0x20 - specifies if you want to send priority message&n; *        buffer - address of reply buffer&n; *        buflen - length of reply buffer&n; * Output: ipbfadr2 - Address of buffer updated by the number&n; *                    of bytes you have moved.&n; *         ipbfln2f - Contains on the the following values&n; *              If the answer buffer is the same length as the reply, this field&n; *               contains zero.&n; *              If the answer buffer is longer than the reply, this field contains&n; *               the number of bytes remaining in the buffer.&n; *              If the answer buffer is shorter than the reply, this field contains&n; *               a residual count (that is, the number of bytes remianing in the&n; *               reply that does not fit into the buffer. In this&n; *                case b2f0_result = 5.&n; * Return: b2f0_result - return code from CP&n; *         (-EINVAL) - buffer address is NULL&n; */
r_int
DECL|function|iucv_reply
id|iucv_reply
(paren
id|u16
id|pathid
comma
id|u32
id|msgid
comma
id|u32
id|trgcls
comma
r_int
id|flags1
comma
r_void
op_star
id|buffer
comma
id|ulong
id|buflen
comma
id|ulong
op_star
id|ipbfadr2
comma
id|ulong
op_star
id|ipbfln2f
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_reply: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipbfadr2
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|buffer
)paren
suffix:semicolon
id|parm.ipbfln2f
op_assign
(paren
id|u32
)paren
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|uchar
)paren
id|flags1
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|REPLY
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_or
(paren
id|b2f0_result
op_eq
l_int|5
)paren
)paren
(brace
r_if
c_cond
(paren
id|ipbfadr2
)paren
op_star
id|ipbfadr2
op_assign
id|parm.ipbfadr2
suffix:semicolon
r_if
c_cond
(paren
id|ipbfln2f
)paren
op_star
id|ipbfln2f
op_assign
id|parm.ipbfln2f
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;iucv_reply: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_reply_array&n; * Purpose: This function responds to the two-way messages that you&n; *          receive. You must identify completely the message to   &n; *          which you wish to reply. ie, pathid, msgid, and trgcls.&n; *          The array identifies a list of addresses and lengths of&n; *          discontiguous buffers that contains the reply data.&n; * Input: pathid - path identification number&n; *        msgid - specifies the message ID. &n; *        trgcls - specifies target class &n; *        flags1 - option for path&n; *                 IPPRTY- specifies if you want to send priority message&n; *        buffer - address of array of reply buffers&n; *        buflen - total length of reply buffers&n; * Output: ipbfadr2 - Address of buffer which IUCV is currently working on.&n; *         ipbfln2f - Contains on the the following values&n; *              If the answer buffer is the same length as the reply, this field&n; *               contains zero.&n; *              If the answer buffer is longer than the reply, this field contains&n; *               the number of bytes remaining in the buffer.&n; *              If the answer buffer is shorter than the reply, this field contains&n; *               a residual count (that is, the number of bytes remianing in the&n; *               reply that does not fit into the buffer. In this&n; *               case b2f0_result = 5.&n; * Return: b2f0_result - return code from CP&n; *             (-EINVAL) - buffer address is NULL&n;*/
r_int
DECL|function|iucv_reply_array
id|iucv_reply_array
(paren
id|u16
id|pathid
comma
id|u32
id|msgid
comma
id|u32
id|trgcls
comma
r_int
id|flags1
comma
id|iucv_array_t
op_star
id|buffer
comma
id|ulong
id|buflen
comma
id|ulong
op_star
id|ipbfadr2
comma
id|ulong
op_star
id|ipbfln2f
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_reply_array: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipbfadr2
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|buffer
)paren
suffix:semicolon
id|parm.ipbfln2f
op_assign
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPANSLST
op_or
id|flags1
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|REPLY
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_or
(paren
id|b2f0_result
op_eq
l_int|5
)paren
)paren
(brace
r_if
c_cond
(paren
id|ipbfadr2
)paren
op_star
id|ipbfadr2
op_assign
id|parm.ipbfadr2
suffix:semicolon
r_if
c_cond
(paren
id|ipbfln2f
)paren
op_star
id|ipbfln2f
op_assign
id|parm.ipbfln2f
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;iucv_reply_array: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_reply_prmmsg&n; * Purpose: This function responds to the two-way messages that you&n; *          receive. You must identify completely the message to&n; *          which you wish to reply. ie, pathid, msgid, and trgcls.&n; *          Prmmsg signifies the data is moved into the&n; *          parameter list.&n; * Input: pathid - path identification number&n; *        msgid - specifies the message ID. &n; *        trgcls - specifies target class&n; *        flags1 - option for path&n; *                 IPPRTY- specifies if you want to send priority message&n; *        prmmsg - 8-bytes of data to be placed into the parameter&n; *                 list.&n; * Output: NA&n; * Return: b2f0_result - return code from CP&n;*/
r_int
DECL|function|iucv_reply_prmmsg
id|iucv_reply_prmmsg
(paren
id|u16
id|pathid
comma
id|u32
id|msgid
comma
id|u32
id|trgcls
comma
r_int
id|flags1
comma
id|uchar
id|prmmsg
(braket
l_int|8
)braket
)paren
(brace
id|iparml_dpl
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_reply_prmmsg: entering&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.ipmsgid
op_assign
id|msgid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|memcpy
(paren
id|parm.iprmmsg
comma
id|prmmsg
comma
r_sizeof
(paren
id|parm.iprmmsg
)paren
)paren
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPRMDATA
op_or
id|flags1
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|REPLY
comma
op_amp
id|parm
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_reply_prmmsg: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_resume                                          &n; * Purpose: This function restores communication over a quiesced path.       &n; * Input: pathid - u16, path identification number                             &n; *        user_data - uchar[16], 16-byte of user data                     &n; * Output: b2f0_result - return code from CP               &n; */
r_int
DECL|function|iucv_resume
id|iucv_resume
(paren
id|u16
id|pathid
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_resume: entering&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_resume: pathid = %d&bslash;n&quot;
comma
id|pathid
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
r_sizeof
(paren
op_star
id|user_data
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|RESUME
comma
op_amp
id|parm
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_resume: exiting &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_send                                             &n; * Purpose: sends messages                                    &n; * Input: pathid - ushort, pathid                            &n; *        msgid  - ulong *, id of message returned to caller   &n; *        trgcls - ulong, target message class              &n; *        srccls - ulong, source message class              &n; *        msgtag - ulong, message tag                    &n; *&t;  flags1  - Contains options for this path.&n; *&t;&t;IPPRTY - Ox20 - specifies if you want to send a priority message.&n; *        buffer - pointer to buffer                           &n; *        buflen - ulong, length of buffer                     &n; * Output: b2f0_result - return code from b2f0 call               &n; *         msgid - returns message id                         &n; */
r_int
DECL|function|iucv_send
id|iucv_send
(paren
id|u16
id|pathid
comma
id|u32
op_star
id|msgid
comma
id|u32
id|trgcls
comma
id|u32
id|srccls
comma
id|u32
id|msgtag
comma
r_int
id|flags1
comma
r_void
op_star
id|buffer
comma
id|ulong
id|buflen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|buffer
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfln1f
op_assign
(paren
id|u32
)paren
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPNORPY
op_or
id|flags1
)paren
suffix:semicolon
multiline_comment|/* one way priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|SEND
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_and
(paren
id|msgid
)paren
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_send_array&n; * Purpose: This function transmits data to another application.&n; *          The contents of buffer is the address of the array of&n; *          addresses and lengths of discontiguous buffers that hold&n; *          the message text. This is a one-way message and the&n; *          receiver will not reply to the message.&n; * Input: pathid - path identification number&n; *        trgcls - specifies target class&n; *        srccls - specifies the source message class&n; *        msgtag - specifies a tag to be associated witht the message&n; *        flags1 - option for path&n; *                 IPPRTY- specifies if you want to send priority message&n; *        buffer - address of array of send buffers&n; *        buflen - total length of send buffers&n; * Output: msgid - specifies the message ID.&n; * Return: b2f0_result - return code from CP &n; *         (-EINVAL) - buffer address is NULL&n; */
r_int
DECL|function|iucv_send_array
id|iucv_send_array
(paren
id|u16
id|pathid
comma
id|u32
op_star
id|msgid
comma
id|u32
id|trgcls
comma
id|u32
id|srccls
comma
id|u32
id|msgtag
comma
r_int
id|flags1
comma
id|iucv_array_t
op_star
id|buffer
comma
id|ulong
id|buflen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send_array: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|buffer
)paren
suffix:semicolon
id|parm.ipbfln1f
op_assign
(paren
id|u32
)paren
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPNORPY
op_or
id|IPBUFLST
op_or
id|flags1
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|SEND
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_and
(paren
id|msgid
)paren
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send_array: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_send_prmmsg&n; * Purpose: This function transmits data to another application. &n; *          Prmmsg specifies that the 8-bytes of data are to be moved&n; *          into the parameter list. This is a one-way message and the&n; *          receiver will not reply to the message.&n; * Input: pathid - path identification number&n; *        trgcls - specifies target class&n; *        srccls - specifies the source message class&n; *        msgtag - specifies a tag to be associated with the message&n; *        flags1 - option for path&n; *                 IPPRTY- specifies if you want to send priority message&n; *        prmmsg - 8-bytes of data to be placed into parameter list&n; * Output: msgid - specifies the message ID.   &n; * Return: b2f0_result - return code from CP&n;*/
r_int
DECL|function|iucv_send_prmmsg
id|iucv_send_prmmsg
(paren
id|u16
id|pathid
comma
id|u32
op_star
id|msgid
comma
id|u32
id|trgcls
comma
id|u32
id|srccls
comma
id|u32
id|msgtag
comma
r_int
id|flags1
comma
id|uchar
id|prmmsg
(braket
l_int|8
)braket
)paren
(brace
id|iparml_dpl
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send_prmmsg: entering&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPRMDATA
op_or
id|IPNORPY
op_or
id|flags1
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.iprmmsg
comma
id|prmmsg
comma
r_sizeof
(paren
id|parm.iprmmsg
)paren
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|SEND
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_and
(paren
id|msgid
)paren
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send_prmmsg: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_send2way&n; * Purpose: This function transmits data to another application.&n; *          Data to be transmitted is in a buffer. The receiver&n; *          of the send is expected to reply to the message and&n; *          a buffer is provided into which IUCV moves the reply &n; *          to this message.&n; * Input: pathid - path identification number&n; *        trgcls - specifies target class&n; *        srccls - specifies the source message class&n; *        msgtag - specifies a tag associated with the message&n; *        flags1 - option for path&n; *                 IPPRTY- specifies if you want to send priority message&n; *        buffer - address of send buffer&n; *        buflen - length of send buffer&n; *        ansbuf - address of buffer to reply with&n; *        anslen - length of buffer to reply with&n; * Output: msgid - specifies the message ID.&n; * Return: b2f0_result - return code from CP&n; *         (-EINVAL) - buffer or ansbuf address is NULL&n; */
r_int
DECL|function|iucv_send2way
id|iucv_send2way
(paren
id|u16
id|pathid
comma
id|u32
op_star
id|msgid
comma
id|u32
id|trgcls
comma
id|u32
id|srccls
comma
id|u32
id|msgtag
comma
r_int
id|flags1
comma
r_void
op_star
id|buffer
comma
id|ulong
id|buflen
comma
r_void
op_star
id|ansbuf
comma
id|ulong
id|anslen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send2way: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
op_logical_or
op_logical_neg
id|ansbuf
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|buffer
)paren
suffix:semicolon
id|parm.ipbfln1f
op_assign
(paren
id|u32
)paren
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipbfadr2
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|ansbuf
)paren
suffix:semicolon
id|parm.ipbfln2f
op_assign
(paren
id|u32
)paren
id|anslen
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_assign
id|flags1
suffix:semicolon
multiline_comment|/* priority message */
id|b2f0_result
op_assign
id|b2f0
(paren
id|SEND
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_and
(paren
id|msgid
)paren
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send2way: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_send2way_array&n; * Purpose: This function transmits data to another application.&n; *          The contents of buffer is the address of the array of&n; *          addresses and lengths of discontiguous buffers that hold&n; *          the message text. The receiver of the send is expected to&n; *          reply to the message and a buffer is provided into which&n; *          IUCV moves the reply to this message.&n; * Input: pathid - path identification number&n; *        trgcls - specifies target class&n; *        srccls - specifies the source message class&n; *        msgtag - spcifies a tag to be associated with the message&n; *        flags1 - option for path&n; *                 IPPRTY- specifies if you want to send priority message&n; *        buffer - address of array of send buffers&n; *        buflen - total length of send buffers&n; *        ansbuf - address of buffer to reply with                       &n; *        anslen - length of buffer to reply with     &n; * Output: msgid - specifies the message ID.&n; * Return: b2f0_result - return code from CP&n; *         (-EINVAL) - buffer address is NULL&n; */
r_int
DECL|function|iucv_send2way_array
id|iucv_send2way_array
(paren
id|u16
id|pathid
comma
id|u32
op_star
id|msgid
comma
id|u32
id|trgcls
comma
id|u32
id|srccls
comma
id|u32
id|msgtag
comma
r_int
id|flags1
comma
id|iucv_array_t
op_star
id|buffer
comma
id|ulong
id|buflen
comma
id|iucv_array_t
op_star
id|ansbuf
comma
id|ulong
id|anslen
)paren
(brace
id|iparml_db
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send2way_array: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
op_logical_or
op_logical_neg
id|ansbuf
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipbfadr1
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|buffer
)paren
suffix:semicolon
id|parm.ipbfln1f
op_assign
(paren
id|u32
)paren
id|buflen
suffix:semicolon
multiline_comment|/* length of message */
id|parm.ipbfadr2
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|ansbuf
)paren
suffix:semicolon
id|parm.ipbfln2f
op_assign
(paren
id|u32
)paren
id|anslen
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPBUFLST
op_or
id|IPANSLST
op_or
id|flags1
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|SEND
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_and
(paren
id|msgid
)paren
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send2way_array: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_send2way_prmmsg&n; * Purpose: This function transmits data to another application.&n; *          Prmmsg specifies that the 8-bytes of data are to be moved&n; *          into the parameter list. This is a two-way message and the&n; *          receiver of the message is expected to reply. A buffer&n; *          is provided into which IUCV moves the reply to this&n; *          message.&n; * Input: pathid - path identification number  &n; *        trgcls - specifies target class&n; *        srccls - specifies the source message class&n; *        msgtag - specifies a tag to be associated with the message&n; *        flags1 - option for path&n; *                 IPPRTY- specifies if you want to send priority message&n; *        prmmsg - 8-bytes of data to be placed in parameter list&n; *        ansbuf - address of buffer to reply with                       &n; *        anslen - length of buffer to reply with     &n; * Output: msgid - specifies the message ID.&n; * Return: b2f0_result - return code from CP&n; *         (-EINVAL) - buffer address is NULL&n;*/
r_int
DECL|function|iucv_send2way_prmmsg
id|iucv_send2way_prmmsg
(paren
id|u16
id|pathid
comma
id|u32
op_star
id|msgid
comma
id|u32
id|trgcls
comma
id|u32
id|srccls
comma
id|u32
id|msgtag
comma
id|ulong
id|flags1
comma
id|uchar
id|prmmsg
(braket
l_int|8
)braket
comma
r_void
op_star
id|ansbuf
comma
id|ulong
id|anslen
)paren
(brace
id|iparml_dpl
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send2way_prmmsg: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ansbuf
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipbfadr2
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|ansbuf
)paren
suffix:semicolon
id|parm.ipbfln2f
op_assign
(paren
id|u32
)paren
id|anslen
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPRMDATA
op_or
id|flags1
)paren
suffix:semicolon
multiline_comment|/* message in prmlist */
id|memcpy
(paren
id|parm.iprmmsg
comma
id|prmmsg
comma
r_sizeof
(paren
id|parm.iprmmsg
)paren
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|SEND
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_and
(paren
id|msgid
)paren
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send2way_prmmsg: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_send2way_prmmsg_array&n; * Purpose: This function transmits data to another application.&n; *          Prmmsg specifies that the 8-bytes of data are to be moved&n; *          into the parameter list. This is a two-way message and the&n; *          receiver of the message is expected to reply. A buffer&n; *          is provided into which IUCV moves the reply to this&n; *          message. The contents of ansbuf is the address of the&n; *          array of addresses and lengths of discontiguous buffers&n; *          that contain the reply.&n; * Input: pathid - path identification number&n; *        trgcls - specifies target class&n; *        srccls - specifies the source message class   &n; *        msgtag - specifies a tag to be associated with the message&n; *        flags1 - option for path&n; *                 IPPRTY- specifies if you want to send priority message&n; *        prmmsg - 8-bytes of data to be placed into the parameter list&n; *        ansbuf - address of buffer to reply with                       &n; *        anslen - length of buffer to reply with     &n; * Output: msgid - specifies the message ID.&n; * Return: b2f0_result - return code from CP&n; *         (-EINVAL) - ansbuf address is NULL&n; */
r_int
DECL|function|iucv_send2way_prmmsg_array
id|iucv_send2way_prmmsg_array
(paren
id|u16
id|pathid
comma
id|u32
op_star
id|msgid
comma
id|u32
id|trgcls
comma
id|u32
id|srccls
comma
id|u32
id|msgtag
comma
r_int
id|flags1
comma
id|uchar
id|prmmsg
(braket
l_int|8
)braket
comma
id|iucv_array_t
op_star
id|ansbuf
comma
id|ulong
id|anslen
)paren
(brace
id|iparml_dpl
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send2way_prmmsg_array: entering&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ansbuf
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|parm.iptrgcls
op_assign
id|trgcls
suffix:semicolon
id|parm.ipsrccls
op_assign
id|srccls
suffix:semicolon
id|parm.ipmsgtag
op_assign
id|msgtag
suffix:semicolon
id|parm.ipbfadr2
op_assign
(paren
id|u32
)paren
(paren
(paren
id|ulong
)paren
id|ansbuf
)paren
suffix:semicolon
id|parm.ipbfln2f
op_assign
(paren
id|u32
)paren
id|anslen
suffix:semicolon
id|parm.ipflags1
op_assign
(paren
id|IPRMDATA
op_or
id|IPANSLST
op_or
id|flags1
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.iprmmsg
comma
id|prmmsg
comma
r_sizeof
(paren
id|parm.iprmmsg
)paren
)paren
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|SEND
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b2f0_result
op_eq
l_int|0
)paren
op_logical_and
(paren
id|msgid
)paren
)paren
op_star
id|msgid
op_assign
id|parm.ipmsgid
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_send2way_prmmsg_array: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_setmask&n; * Purpose: This function enables or disables the following IUCV   &n; *          external interruptions: Nonpriority and priority message&n; *          interrupts, nonpriority and priority reply interrupts.&n; * Input: SetMaskFlag - options for interrupts&n; *           0x80 - Nonpriority_MessagePendingInterruptsFlag&n; *           0x40 - Priority_MessagePendingInterruptsFlag&n; *           0x20 - Nonpriority_MessageCompletionInterruptsFlag&n; *           0x10 - Priority_MessageCompletionInterruptsFlag&n; * Output: NA&n; * Return: b2f0_result - return code from CP&n;*/
r_int
DECL|function|iucv_setmask
id|iucv_setmask
(paren
r_int
id|SetMaskFlag
)paren
(brace
id|iparml_set_mask
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_setmask: entering &bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|parm.ipmask
op_assign
(paren
id|uchar
)paren
id|SetMaskFlag
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|SETMASK
comma
op_amp
id|parm
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_setmask: b2f0_result = %ld&bslash;n&quot;
comma
id|b2f0_result
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_setmask: exiting&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: iucv_sever                                           &n; * Purpose: This function terminates an iucv path         &n; * Input: pathid - u16, path identification number                             &n; *        user_data - uchar[16], 16-byte of user data                     &n; * Output: b2f0_result - return code from CP          &n; *         -EINVAL - NULL address found for handler                                 &n; */
r_int
DECL|function|iucv_sever
id|iucv_sever
(paren
id|u16
id|pathid
comma
id|uchar
id|user_data
(braket
l_int|16
)braket
)paren
(brace
id|iparml_control
id|parm
suffix:semicolon
id|ulong
id|b2f0_result
op_assign
l_int|0
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_sever: entering&bslash;n&quot;
)paren
suffix:semicolon
id|memset
(paren
op_amp
id|parm
comma
l_int|0
comma
r_sizeof
(paren
id|parm
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|parm.ipuser
comma
id|user_data
comma
r_sizeof
(paren
id|parm.ipuser
)paren
)paren
suffix:semicolon
id|parm.ippathid
op_assign
id|pathid
suffix:semicolon
id|b2f0_result
op_assign
id|b2f0
(paren
id|SEVER
comma
op_amp
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b2f0_result
)paren
id|iucv_remove_pathid
(paren
id|pathid
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_sever: exiting &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|b2f0_result
suffix:semicolon
)brace
r_static
r_void
DECL|function|iucv_remove_pathid
id|iucv_remove_pathid
(paren
id|u16
id|pathid
)paren
(brace
id|handler_table_entry
op_star
id|users_hte
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*users handler_table_entry */
id|handler
op_star
id|users_handler
op_assign
l_int|NULL
suffix:semicolon
id|ulong
op_star
id|users_pathid
op_assign
l_int|NULL
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
id|users_hte
op_assign
id|handler_table_anchor
op_plus
(paren
r_int
)paren
id|pathid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|users_hte-&gt;addrs
)paren
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* wild pointer has been found */
)brace
id|users_handler
op_assign
id|users_hte-&gt;addrs
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_sever: pathid is %d&bslash;n&quot;
comma
id|pathid
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_sever: H_T_E is %p&bslash;n&quot;
comma
id|users_hte
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_sever: address of handler is %p&bslash;n&quot;
comma
id|users_handler
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_sever: below is pathid table&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|users_handler-&gt;pathid_head
comma
(paren
r_int
)paren
id|users_handler-&gt;entries
op_star
r_sizeof
(paren
id|ulong
)paren
)paren
suffix:semicolon
multiline_comment|/*&n; * Searching the pathid address table for matching address, once    &n; * found, NULL the handler_table_entry field and then zero the H_T_E fields.               &n; */
r_for
c_loop
(paren
id|users_pathid
op_assign
(paren
id|users_handler-&gt;pathid_head
)paren
suffix:semicolon
id|users_pathid
OL
(paren
id|users_handler-&gt;pathid_tail
)paren
suffix:semicolon
id|users_pathid
op_increment
)paren
r_if
c_cond
(paren
op_star
id|users_pathid
op_eq
(paren
id|ulong
)paren
id|users_hte
)paren
(brace
id|pr_debug
(paren
l_string|&quot;iucv_sever: found a path to remove from&quot;
l_string|&quot;table&bslash;n&quot;
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv_sever: removing %d &bslash;n&quot;
comma
(paren
r_int
)paren
(paren
op_star
id|users_pathid
)paren
)paren
suffix:semicolon
op_star
id|users_pathid
op_assign
l_int|NULL
suffix:semicolon
id|memset
(paren
id|users_hte
comma
l_int|0
comma
r_sizeof
(paren
id|handler_table_entry
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt Handling Functions&n; * &t;top_half_interrupt&n; * &t;bottom_half_interrupt&n; * &t;do_int&n; */
multiline_comment|/*&n; * Name: top_half_interrupt                                         &n; * Purpose: Handles interrupts coming in from CP.  Places the interrupt on a queue and  &n; * &t;    calls bottom_half_interrupt          &n; * Input: external interrupt buffer                                &n; * Output: void                                                    &n; */
r_inline
r_void
DECL|function|top_half_interrupt
id|top_half_interrupt
(paren
r_struct
id|pt_regs
op_star
id|regs
comma
id|__u16
id|code
)paren
(brace
id|iucv_packet
op_star
id|pkt
suffix:semicolon
r_int
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|irq_enter
c_func
(paren
id|cpu
comma
l_int|0x4000
)paren
suffix:semicolon
id|pkt
op_assign
(paren
id|iucv_packet
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|iucv_packet
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv:top_half_interrupt: out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|irq_exit
c_func
(paren
id|cpu
comma
l_int|0x4000
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
(paren
id|pkt-&gt;data
comma
id|iucv_external_int_buffer
comma
id|BUFFER_SIZE
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;TH: Got INT: %08x&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|pkt-&gt;data
op_plus
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* put new packet on the list */
id|spin_lock
(paren
op_amp
id|iucv_packets_lock
)paren
suffix:semicolon
id|pkt-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|iucv_packets_tail
op_ne
l_int|NULL
)paren
id|iucv_packets_tail-&gt;next
op_assign
id|pkt
suffix:semicolon
r_else
id|iucv_packets_head
op_assign
id|pkt
suffix:semicolon
id|iucv_packets_tail
op_assign
id|pkt
suffix:semicolon
id|spin_unlock
(paren
op_amp
id|iucv_packets_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_compare_and_swap
(paren
l_int|0
comma
l_int|1
comma
op_amp
id|bh_scheduled
)paren
op_eq
l_int|0
)paren
(brace
id|short_task.routine
op_assign
(paren
r_void
op_star
)paren
id|bottom_half_interrupt
suffix:semicolon
id|queue_task
(paren
op_amp
id|short_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
id|irq_exit
c_func
(paren
id|cpu
comma
l_int|0x4000
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: bottom_half_interrupt                                      &n; * Purpose: Handle interrupt at a more safer time                  &n; * Input: void                                                     &n; * Output: void                                                    &n; */
r_void
DECL|function|bottom_half_interrupt
id|bottom_half_interrupt
(paren
r_void
)paren
(brace
id|iucv_packet
op_star
id|iucv_packet_list
suffix:semicolon
id|iucv_packet
op_star
id|tmp
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|atomic_set
(paren
op_amp
id|bh_scheduled
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|iucv_packets_lock
comma
id|flags
)paren
suffix:semicolon
id|iucv_packet_list
op_assign
id|iucv_packets_head
suffix:semicolon
id|iucv_packets_head
op_assign
id|iucv_packets_tail
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_packets_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* now process all the request in the iucv_packet_list */
id|pr_debug
(paren
l_string|&quot;BH: Process all packets&bslash;n&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|iucv_packet_list
op_ne
l_int|NULL
)paren
(brace
id|pr_debug
(paren
l_string|&quot;BH:&gt;  %08x&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|iucv_packet_list-&gt;data
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|do_int
(paren
(paren
id|iucv_GeneralInterrupt
op_star
)paren
id|iucv_packet_list-&gt;data
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;BH:&lt;  %08x&bslash;n&quot;
comma
op_star
(paren
r_int
op_star
)paren
(paren
id|iucv_packet_list-&gt;data
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|tmp
op_assign
id|iucv_packet_list
suffix:semicolon
id|iucv_packet_list
op_assign
id|iucv_packet_list-&gt;next
suffix:semicolon
id|kfree
(paren
id|tmp
)paren
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;BH: Done&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Name: do_int                                                     &n; * Purpose: Handles the interrupts in a more safe environment             &n; * Input: int_buf - pointer to copy of external interrupt buffer  &n; * Output: void                                                     &n; */
r_void
DECL|function|do_int
id|do_int
(paren
id|iucv_GeneralInterrupt
op_star
id|int_buf
)paren
(brace
id|handler_table_entry
op_star
id|P
op_assign
l_int|0
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|handler
op_star
id|Q
op_assign
l_int|0
comma
op_star
id|R
suffix:semicolon
id|iucv_interrupt_ops_t
op_star
id|interrupt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* interrupt addresses */
id|uchar
id|temp_buff1
(braket
l_int|24
)braket
comma
id|temp_buff2
(braket
l_int|24
)braket
suffix:semicolon
multiline_comment|/* masked handler id. */
r_int
id|add_pathid_result
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|uchar
id|no_listener
(braket
l_int|16
)braket
op_assign
l_string|&quot;NO LISTENER&quot;
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;IUCV: BHI: -  Entered do_int &quot;
l_string|&quot;pathid %d, type %02X&bslash;n&quot;
comma
id|int_buf-&gt;ippathid
comma
id|int_buf-&gt;iptype
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;BHI:External Interrupt Buffer&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|int_buf
comma
r_sizeof
(paren
id|iucv_GeneralInterrupt
)paren
)paren
suffix:semicolon
id|ASCEBC
(paren
id|no_listener
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|int_buf-&gt;iptype
op_ne
l_int|01
)paren
(brace
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
id|P
op_assign
id|handler_table_anchor
op_plus
id|int_buf-&gt;ippathid
suffix:semicolon
id|Q
op_assign
id|P-&gt;addrs
suffix:semicolon
id|interrupt
op_assign
id|P-&gt;ops
suffix:semicolon
multiline_comment|/* interrupt functions */
id|pr_debug
(paren
l_string|&quot;iucv: do_int: Handler&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
(paren
id|uchar
op_star
)paren
id|Q
comma
r_sizeof
(paren
id|handler
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* end of if statement */
r_switch
c_cond
(paren
id|int_buf-&gt;iptype
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* connection pending */
id|spin_lock_irqsave
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|R
op_assign
id|handler_anchor
suffix:semicolon
id|R
op_ne
l_int|NULL
suffix:semicolon
id|R
op_assign
(paren
id|handler
op_star
)paren
id|R-&gt;next
)paren
(brace
id|memcpy
(paren
id|temp_buff1
comma
op_amp
(paren
id|int_buf-&gt;ipvmid
)paren
comma
l_int|24
)paren
suffix:semicolon
id|memcpy
(paren
id|temp_buff2
comma
op_amp
(paren
id|R-&gt;id.userid
)paren
comma
l_int|24
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|24
suffix:semicolon
id|j
op_increment
)paren
(brace
id|temp_buff1
(braket
id|j
)braket
op_assign
(paren
id|temp_buff1
(braket
id|j
)braket
)paren
op_amp
(paren
id|R-&gt;id.mask
)paren
(braket
id|j
)braket
suffix:semicolon
id|temp_buff2
(braket
id|j
)braket
op_assign
(paren
id|temp_buff2
(braket
id|j
)braket
)paren
op_amp
(paren
id|R-&gt;id.mask
)paren
(braket
id|j
)braket
suffix:semicolon
)brace
id|pr_debug
(paren
l_string|&quot;iucv:do_int: temp_buff1&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
id|temp_buff1
comma
r_sizeof
(paren
id|temp_buff1
)paren
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv:do_int: temp_buff2&bslash;n&quot;
)paren
suffix:semicolon
id|iucv_dumpit
(paren
id|temp_buff2
comma
r_sizeof
(paren
id|temp_buff2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
(paren
(paren
r_void
op_star
)paren
id|temp_buff1
comma
(paren
r_void
op_star
)paren
id|temp_buff2
comma
l_int|24
)paren
op_eq
l_int|0
)paren
(brace
id|pr_debug
(paren
l_string|&quot;iucv:do_int: found a matching handler&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|iucv_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|R
)paren
(brace
multiline_comment|/* ADD PATH TO PATHID TABLE */
id|add_pathid_result
op_assign
id|iucv_add_pathid
(paren
id|int_buf-&gt;ippathid
comma
id|R
comma
id|R-&gt;pgm_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|add_pathid_result
op_eq
l_int|NULL
)paren
(brace
id|interrupt
op_assign
id|R-&gt;interrupt_table
suffix:semicolon
r_if
c_cond
(paren
id|interrupt-&gt;ConnectionPending
)paren
(brace
id|EBCASC
(paren
id|int_buf-&gt;ipvmid
comma
l_int|8
)paren
suffix:semicolon
(paren
id|interrupt-&gt;ConnectionPending
)paren
(paren
(paren
id|iucv_ConnectionPending
op_star
)paren
id|int_buf
comma
(paren
id|R-&gt;pgm_data
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end of if(add_p...... */
r_else
(brace
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
id|pr_debug
(paren
l_string|&quot;iucv:do_int:add_pathid failed&quot;
l_string|&quot;with rc = %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|add_pathid_result
)paren
suffix:semicolon
)brace
)brace
r_else
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/*connection complete */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt-&gt;ConnectionComplete
)paren
(paren
id|interrupt-&gt;ConnectionComplete
)paren
(paren
(paren
id|iucv_ConnectionComplete
op_star
)paren
id|int_buf
comma
(paren
id|P-&gt;pgm_data
)paren
)paren
suffix:semicolon
r_else
id|pr_debug
(paren
l_string|&quot;iucv:do_int:&quot;
l_string|&quot;ConnectionComplete not called&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x03
suffix:colon
multiline_comment|/* connection severed */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt-&gt;ConnectionSevered
)paren
(paren
id|interrupt-&gt;ConnectionSevered
)paren
(paren
(paren
id|iucv_ConnectionSevered
op_star
)paren
id|int_buf
comma
(paren
id|P-&gt;pgm_data
)paren
)paren
suffix:semicolon
r_else
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
)brace
r_else
id|iucv_sever
(paren
id|int_buf-&gt;ippathid
comma
id|no_listener
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x04
suffix:colon
multiline_comment|/* connection quiesced */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt-&gt;ConnectionQuiesced
)paren
(paren
id|interrupt-&gt;ConnectionQuiesced
)paren
(paren
(paren
id|iucv_ConnectionQuiesced
op_star
)paren
id|int_buf
comma
(paren
id|P-&gt;pgm_data
)paren
)paren
suffix:semicolon
r_else
id|pr_debug
(paren
l_string|&quot;iucv:do_int:&quot;
l_string|&quot;ConnectionQuiesced not called&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x05
suffix:colon
multiline_comment|/* connection resumed */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt-&gt;ConnectionResumed
)paren
(paren
id|interrupt-&gt;ConnectionResumed
)paren
(paren
(paren
id|iucv_ConnectionResumed
op_star
)paren
id|int_buf
comma
(paren
id|P-&gt;pgm_data
)paren
)paren
suffix:semicolon
r_else
id|pr_debug
(paren
l_string|&quot;iucv:do_int:&quot;
l_string|&quot;ConnectionResumed not called&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x06
suffix:colon
multiline_comment|/* priority message complete */
r_case
l_int|0x07
suffix:colon
multiline_comment|/* nonpriority message complete */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt-&gt;MessageComplete
)paren
(paren
id|interrupt-&gt;MessageComplete
)paren
(paren
(paren
id|iucv_MessageComplete
op_star
)paren
id|int_buf
comma
(paren
id|P-&gt;pgm_data
)paren
)paren
suffix:semicolon
r_else
id|pr_debug
(paren
l_string|&quot;iucv:do_int:&quot;
l_string|&quot;MessageComplete not called&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* priority message pending  */
r_case
l_int|0x09
suffix:colon
multiline_comment|/* nonpriority message pending  */
r_if
c_cond
(paren
id|Q
)paren
(brace
r_if
c_cond
(paren
id|interrupt-&gt;MessagePending
)paren
(paren
id|interrupt-&gt;MessagePending
)paren
(paren
(paren
id|iucv_MessagePending
op_star
)paren
id|int_buf
comma
(paren
id|P-&gt;pgm_data
)paren
)paren
suffix:semicolon
r_else
id|pr_debug
(paren
l_string|&quot;iucv:do_int:&quot;
l_string|&quot;MessagePending not called&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unknown iucv type */
id|printk
(paren
id|KERN_WARNING
l_string|&quot;iucv:do_int: unknown iucv interrupt &bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* end switch */
id|pr_debug
(paren
l_string|&quot;BH:-  Exiting do_int &quot;
l_string|&quot;pathid %d, type %02X&bslash;n&quot;
comma
id|int_buf-&gt;ippathid
comma
id|int_buf-&gt;iptype
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* end of function call */
DECL|variable|iucv_accept
id|EXPORT_SYMBOL
(paren
id|iucv_accept
)paren
suffix:semicolon
DECL|variable|iucv_connect
id|EXPORT_SYMBOL
(paren
id|iucv_connect
)paren
suffix:semicolon
DECL|variable|iucv_purge
id|EXPORT_SYMBOL
(paren
id|iucv_purge
)paren
suffix:semicolon
DECL|variable|iucv_query_maxconn
id|EXPORT_SYMBOL
(paren
id|iucv_query_maxconn
)paren
suffix:semicolon
DECL|variable|iucv_query_bufsize
id|EXPORT_SYMBOL
(paren
id|iucv_query_bufsize
)paren
suffix:semicolon
DECL|variable|iucv_quiesce
id|EXPORT_SYMBOL
(paren
id|iucv_quiesce
)paren
suffix:semicolon
DECL|variable|iucv_receive
id|EXPORT_SYMBOL
(paren
id|iucv_receive
)paren
suffix:semicolon
DECL|variable|iucv_receive_array
id|EXPORT_SYMBOL
(paren
id|iucv_receive_array
)paren
suffix:semicolon
DECL|variable|iucv_reject
id|EXPORT_SYMBOL
(paren
id|iucv_reject
)paren
suffix:semicolon
DECL|variable|iucv_reply
id|EXPORT_SYMBOL
(paren
id|iucv_reply
)paren
suffix:semicolon
DECL|variable|iucv_reply_array
id|EXPORT_SYMBOL
(paren
id|iucv_reply_array
)paren
suffix:semicolon
DECL|variable|iucv_reply_prmmsg
id|EXPORT_SYMBOL
(paren
id|iucv_reply_prmmsg
)paren
suffix:semicolon
DECL|variable|iucv_resume
id|EXPORT_SYMBOL
(paren
id|iucv_resume
)paren
suffix:semicolon
DECL|variable|iucv_send
id|EXPORT_SYMBOL
(paren
id|iucv_send
)paren
suffix:semicolon
DECL|variable|iucv_send2way
id|EXPORT_SYMBOL
(paren
id|iucv_send2way
)paren
suffix:semicolon
DECL|variable|iucv_send2way_array
id|EXPORT_SYMBOL
(paren
id|iucv_send2way_array
)paren
suffix:semicolon
DECL|variable|iucv_send_array
id|EXPORT_SYMBOL
(paren
id|iucv_send_array
)paren
suffix:semicolon
DECL|variable|iucv_send2way_prmmsg
id|EXPORT_SYMBOL
(paren
id|iucv_send2way_prmmsg
)paren
suffix:semicolon
DECL|variable|iucv_send2way_prmmsg_array
id|EXPORT_SYMBOL
(paren
id|iucv_send2way_prmmsg_array
)paren
suffix:semicolon
DECL|variable|iucv_send_prmmsg
id|EXPORT_SYMBOL
(paren
id|iucv_send_prmmsg
)paren
suffix:semicolon
DECL|variable|iucv_setmask
id|EXPORT_SYMBOL
(paren
id|iucv_setmask
)paren
suffix:semicolon
DECL|variable|iucv_sever
id|EXPORT_SYMBOL
(paren
id|iucv_sever
)paren
suffix:semicolon
DECL|variable|iucv_register_program
id|EXPORT_SYMBOL
(paren
id|iucv_register_program
)paren
suffix:semicolon
DECL|variable|iucv_unregister_program
id|EXPORT_SYMBOL
(paren
id|iucv_unregister_program
)paren
suffix:semicolon
eof
