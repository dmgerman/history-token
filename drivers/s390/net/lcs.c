multiline_comment|/*&n; *  linux/drivers/s390/net/lcs.c&n; *&n; *  Linux for S/390 Lan Channel Station Network Driver&n; *&n; *  Copyright (C)  1999-2001 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): DJ Barrow (djbarrow@de.ibm.com,barrow_dj@yahoo.com) &n; *               Frank Pavlic (pavlic@de.ibm.com)&n; *&n; *    $Revision: 1.128 $    $Date: 2002/03/01 16:56:47 $&n; * &n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
multiline_comment|/*&n; &t;Thanks to Uli Hild, Martin Schwidefsky,&n;&t;&amp; Ingo who probably will never let it down that &n;&t;he found the braindamage with my offset calculations on &n;&t;the IO buffers.&n;&t;( for quality of effort, advise, support &amp; sanity checking )&n;&t;Alex, Boas &amp; the rest of the team for the opportunity to work here.&n;&n;DRIVER OPERATION OVERVIEW README FIRST&n;======================================&n;&n;The lcs driver currently supports Ethernet &amp; Token Ring, FDDI is still&n;experimental.&n;&n;The lan channel station(lcs) network interface has two channels one read&n;channel one  write channel. This is very similar to the S390 CTC interface&n;&n;The read channel is recognised by having an even cuu number &amp; model 0x3088&n;The write channel is recognised by the formula write cuu=read cuu number + 1&n;&amp; also a model of 0x3088 only certain cuu models are supported so as not to&n;clash with a CTC control unit model.&n;&n;The driver always has a read outstanding on the read subchannel this is used&n;to receive both command replys &amp; network packets ( these are differenciated by&n;checking the type field in the lcs header structure ), network packets may&n;come in during the startup &amp; shutdown sequence these have to be discarded.&n;During normal network I/O the driver will intermittently retry reads to&n;permanently keep reads outstanding on the read channel if an -EBUSY or&n;similar occurs (otherwise the driver would stop receiving network packets).&n;&n;The channel progam used work as described below&n;===============================================&n;The write subchannel has a hack in /net/core/skbuff.c which makes&n;sure there is enough head &amp; tailroom to write packets directly out of the&n;socket buffer (If their isn&squot;t the code will still work). &n;&n;If the write subchannel is busy network packets are&n;aggregated together into a &amp; queued for transmission, the reason I&squot;m doing&n;this is to minimise start subchannels &amp; interrupts which I have been told&n;&amp; have proven to be very expensive.&n;&n;e.g. a ping -f -s 1400 -c 20000 &lt;gateway_addr&gt; &gt;/dev/null used take 40 secs,&n;on my machine &amp; a ping -f -s 100 -c 20000 &lt;gateway_addr&gt; &gt;/dev/null took 27&n;secs, over token ring with a single buffer this has improved a lot with the&n;queueing technique (I also made sure that the delay wasn&squot;t caused by waiting&n;for the free token).&n;&n;The new program works as follows&n;================================&n;The read &amp; channel program consists of of 8 read ccw commands &n;followed by a transfer in channel back to the 1st read ccw. &n;A moving suspend bit is switched on in the read&n;ccw of the last buffer processed with pci&squot;s switched on in the&n;remaining ccw&squot;s. This way I recieve buffers with pci&squot;s without&n;having to issue excess resumes or ssch&squot;s &amp; only&n;need to issue a resume if the read program gets suspended when&n;all the buffers are filled.&n;&n;The write program consists of 4 to 9 write ccw commands folled&n;by a transfer in channel back to the 1st write ccw.&n;All unfilled buffers all have the suspend bit on &amp; the&n;suspend bit is taken off when buffers are either filled or partially&n;filled &amp; the write channel is no longer busy.&n;&n;The lan channel is started as follows&n;1) A halt subchannel is issued to the read &amp; write subchannel&n;2) A startup primitive is sent to the lan &amp; the reply is read from the read&n;subchannel.&n;3) Every possible relative adapter number issued a startlan primative with&n;attempts to configure it as token ring ethernet &amp; fddi at some stage in the&n;boot sequence or when the module is being inserted.&n;The relative adapter number is normally equal to the low byte of the read&n;channel cuu/2 &amp; hence the reason for the hint field to speed up lcs_detect.&n;5) On success of a startlan we  know whether the osa card is configured as&n;token ring, ethernet or fddi, a lanstat primative is issued to get the&n;mac address.&n;6) The device is now ready for network io.&n;&n;The shutdown is similar to the startup just a stoplan primative followed&n;by a shutdown.&n;&n;The driver instance globals lcs_drvr_globals are held in the priv element of&n;the device structure &amp; these in turn point to a lcs_chan_globals structure&n;for the read &amp; write channel. The read &amp; write chan_globals &amp; driver&n;globals have their own state machine, so that the interrupt handler can&n;make decisions on whether to send packets read to the network layer, or&n;whether it is should wake up a process currently issuing lan commands.&n;&n;*/
DECL|macro|TRUE
mdefine_line|#define TRUE 1
DECL|macro|FALSE
mdefine_line|#define FALSE 0
DECL|macro|ERETRY
mdefine_line|#define ERETRY 255
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#if LINUX_VERSION_CODE&lt;KERNEL_VERSION(2,3,0)
macro_line|#include &lt;linux/kcomp.h&gt;
macro_line|#endif
macro_line|#if CONFIG_NET_ETHERNET
macro_line|#include &lt;linux/etherdevice.h&gt;
r_extern
r_int
id|ethif_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
macro_line|#include &lt;linux/trdevice.h&gt;
r_extern
r_int
id|trif_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FDDI
macro_line|#include &lt;linux/fddidevice.h&gt;
r_extern
r_int
id|fddiif_probe
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/queue.h&gt;
DECL|macro|LCS_CHANDEV
mdefine_line|#define LCS_CHANDEV CONFIG_CHANDEV
macro_line|#if LCS_CHANDEV
macro_line|#include &lt;asm/chandev.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_IP_MULTICAST
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/igmp.h&gt;
macro_line|#endif
macro_line|#include &lt;net/pkt_sched.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/dst.h&gt;
DECL|macro|LCS_USE_IDALS
mdefine_line|#define LCS_USE_IDALS  (LINUX_VERSION_CODE&gt;KERNEL_VERSION(2,2,16))
macro_line|#if (!CONFIG_ARCH_S390X) || (LCS_USE_IDALS)
DECL|macro|lcs_dev_alloc_skb
mdefine_line|#define lcs_dev_alloc_skb(length) dev_alloc_skb((length))
macro_line|#endif
macro_line|#if LCS_USE_IDALS
macro_line|#  include &lt;asm/idals.h&gt;
macro_line|#else
DECL|macro|set_normalized_cda
mdefine_line|#define set_normalized_cda(ccw, addr) ((ccw)-&gt;cda = (addr),0)
DECL|macro|clear_normalized_cda
mdefine_line|#define clear_normalized_cda(ccw)
macro_line|#endif
macro_line|#if (LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,2,18))
DECL|macro|LCS_DEBUG
mdefine_line|#define LCS_DEBUG 1
macro_line|#else
DECL|macro|LCS_DEBUG
mdefine_line|#define LCS_DEBUG 0
macro_line|#endif
DECL|macro|LCS_PRINTK_DEBUG
mdefine_line|#define LCS_PRINTK_DEBUG   0
DECL|macro|LCS_ZERO_COPY_READ
mdefine_line|#define LCS_ZERO_COPY_READ 0
macro_line|#if LCS_DEBUG &amp;&amp; !LCS_PRINTK_DEBUG
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#endif
macro_line|#if !defined(CONFIG_NET_ETHERNET)&amp;&amp;!defined(CONFIG_TR)&amp;&amp;!defined(CONFIG_FDDI)
macro_line|#error Cannot compile lcs.c without some net devices switched on.
macro_line|#endif
DECL|macro|lcs_inline
mdefine_line|#define lcs_inline inline
macro_line|#if LINUX_VERSION_CODE&lt;=KERNEL_VERSION(2,2,16)
DECL|macro|lcs_daemonize
mdefine_line|#define lcs_daemonize(name,mask,use_init_fs) s390_daemonize(name,mask)
macro_line|#else
DECL|macro|lcs_daemonize
mdefine_line|#define lcs_daemonize(noargs...)
macro_line|#endif
multiline_comment|/* for the proc filesystem */
DECL|variable|cardname
r_static
r_const
r_char
op_star
id|cardname
op_assign
l_string|&quot;S390 Lan Channel Station Interface&quot;
suffix:semicolon
multiline_comment|/* lcs ccw command codes */
r_enum
(brace
DECL|enumerator|ccw_write
id|ccw_write
op_assign
l_int|0x1
comma
DECL|enumerator|ccw_read
id|ccw_read
op_assign
l_int|0x2
comma
DECL|enumerator|ccw_read_backward
id|ccw_read_backward
op_assign
l_int|0xc
comma
DECL|enumerator|ccw_control
id|ccw_control
op_assign
l_int|0x3
comma
DECL|enumerator|ccw_sense
id|ccw_sense
op_assign
l_int|0x4
comma
DECL|enumerator|ccw_sense_id
id|ccw_sense_id
op_assign
l_int|0xe4
comma
DECL|enumerator|ccw_transfer_in_channel0
id|ccw_transfer_in_channel0
op_assign
l_int|0x8
comma
DECL|enumerator|ccw_transfer_in_channel1
id|ccw_transfer_in_channel1
op_assign
l_int|0x8
comma
DECL|enumerator|ccw_set_x_mode
id|ccw_set_x_mode
op_assign
l_int|0xc3
comma
singleline_comment|// according to uli&squot;s lan notes
DECL|enumerator|ccw_nop
id|ccw_nop
op_assign
l_int|0x3
singleline_comment|// according to uli&squot;s notes again
singleline_comment|// n.b. ccw_control clashes with this
singleline_comment|// so I presume its a special case of
singleline_comment|// control
)brace
suffix:semicolon
multiline_comment|/* startup &amp; shutdown primatives */
r_typedef
r_enum
(brace
DECL|enumerator|lcs_startlan
id|lcs_startlan
op_assign
l_int|1
comma
DECL|enumerator|lcs_stoplan
id|lcs_stoplan
op_assign
l_int|2
comma
DECL|enumerator|lcs_lanstat
id|lcs_lanstat
op_assign
l_int|4
comma
DECL|enumerator|lcs_startup
id|lcs_startup
op_assign
l_int|7
comma
DECL|enumerator|lcs_shutdown
id|lcs_shutdown
op_assign
l_int|8
comma
macro_line|#ifdef CONFIG_IP_MULTICAST
DECL|enumerator|lcs_qipassist
id|lcs_qipassist
op_assign
l_int|0xb2
comma
DECL|enumerator|lcs_setipm
id|lcs_setipm
op_assign
l_int|0xb4
comma
DECL|enumerator|lcs_delipm
id|lcs_delipm
op_assign
l_int|0xb5
macro_line|#endif
DECL|typedef|lcs_cmd
)brace
id|lcs_cmd
suffix:semicolon
r_typedef
r_enum
(brace
DECL|enumerator|command_reject
id|command_reject
op_assign
l_int|0x80
comma
DECL|enumerator|intervention_required
id|intervention_required
op_assign
l_int|0x40
comma
DECL|enumerator|bus_out_check
id|bus_out_check
op_assign
l_int|0x20
comma
DECL|enumerator|equipment_check
id|equipment_check
op_assign
l_int|0x10
comma
DECL|enumerator|interface_disconnect
id|interface_disconnect
op_assign
l_int|0x01
comma
DECL|typedef|lcs_sense_byte_0
)brace
id|lcs_sense_byte_0
suffix:semicolon
r_typedef
r_enum
(brace
DECL|enumerator|resetting_event
id|resetting_event
op_assign
l_int|0x0080
comma
DECL|enumerator|device_online
id|device_online
op_assign
l_int|0x0020
comma
DECL|typedef|lcs_sense_byte_1
)brace
id|lcs_sense_byte_1
suffix:semicolon
multiline_comment|/* The type of packet we are transmitting or receiving from the lcs */
r_typedef
r_enum
(brace
DECL|enumerator|lcs_control_frame_type
id|lcs_control_frame_type
op_assign
l_int|0
comma
multiline_comment|/* for startup shutdown etc */
DECL|enumerator|lcs_enet_type
id|lcs_enet_type
op_assign
l_int|1
comma
multiline_comment|/* the rest are for normal network io */
DECL|enumerator|lcs_token_ring_type
id|lcs_token_ring_type
op_assign
l_int|2
comma
DECL|enumerator|lcs_fddi_type
id|lcs_fddi_type
op_assign
l_int|7
comma
DECL|enumerator|lcs_autodetect_type
id|lcs_autodetect_type
op_assign
op_minus
l_int|1
comma
DECL|typedef|lcs_frame_type
)brace
id|lcs_frame_type
suffix:semicolon
DECL|macro|LCS_ILLEGAL_OFFSET
mdefine_line|#define LCS_ILLEGAL_OFFSET 0xffff
DECL|variable|use_hw_stats
r_static
r_int
id|use_hw_stats
op_assign
l_int|0
suffix:semicolon
DECL|variable|checksum_received_ip_pkts
r_static
r_int
id|checksum_received_ip_pkts
op_assign
l_int|0
suffix:semicolon
macro_line|#if !LCS_CHANDEV
multiline_comment|/* Max number of cuu models we can detect */
DECL|macro|LCS_CURR_NUM_MODELS
mdefine_line|#define LCS_CURR_NUM_MODELS   4
DECL|macro|LCS_ADDITIONAL_MODELS
mdefine_line|#define LCS_ADDITIONAL_MODELS 12
DECL|macro|LCS_ADDITIONAL_MODELS_X2_STR
mdefine_line|#define LCS_ADDITIONAL_MODELS_X2_STR &quot;24&quot;
DECL|macro|LCS_MAX_NUM_MODELS
mdefine_line|#define LCS_MAX_NUM_MODELS  (LCS_CURR_NUM_MODELS+LCS_ADDITIONAL_MODELS)
multiline_comment|/* max number of parms that can be sent to lcs_setup */
DECL|macro|LCS_MAX_NUM_PARMS
mdefine_line|#define LCS_MAX_NUM_PARMS ((LCS_MAX_NUM_MODELS&lt;&lt;1)+2)
multiline_comment|/* configuration parms for the lcs card */
r_typedef
r_struct
(brace
DECL|member|cu_model
r_int
id|cu_model
suffix:semicolon
DECL|member|max_rel_adapter_no
r_int
id|max_rel_adapter_no
suffix:semicolon
DECL|typedef|lcs_model_info
)brace
id|lcs_model_info
suffix:semicolon
multiline_comment|/* The models supported currently used in probing */
DECL|macro|LCS_CUTYPE
mdefine_line|#define LCS_CUTYPE 0x3088
multiline_comment|/* default configuration parms */
DECL|variable|lcs_models
r_static
id|lcs_model_info
id|lcs_models
(braket
id|LCS_CURR_NUM_MODELS
)braket
id|__attribute__
(paren
(paren
id|section
c_func
(paren
l_string|&quot;.data&quot;
)paren
)paren
)paren
op_assign
(brace
(brace
l_int|0x1
comma
l_int|15
)brace
comma
multiline_comment|/* P390/Planter 3172 emulation assume maximum 16 to be safe. */
(brace
l_int|0x8
comma
l_int|15
)brace
comma
multiline_comment|/* 3172/2216 Paralell the 2216 allows 16 ports per card */
multiline_comment|/* the original 3172 only allows 4 we will assume the max of 16 */
(brace
l_int|0x60
comma
l_int|1
)brace
comma
multiline_comment|/* Only 2 ports allowed on OSA2 cards model 0x60 */
(brace
l_int|0x1F
comma
l_int|15
)brace
comma
multiline_comment|/* 3172/2216 Escon serial the 2216 allows 16 ports per card  */
multiline_comment|/* the original 3172 only allows 4 we will assume the max of 16 */
)brace
suffix:semicolon
DECL|variable|additional_model_info
r_static
r_int
id|additional_model_info
(braket
id|LCS_ADDITIONAL_MODELS
op_lshift
l_int|1
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
multiline_comment|/* Set this to one to stop autodetection */
DECL|variable|noauto
DECL|variable|ignore_sense
r_static
r_int
id|noauto
op_assign
l_int|0
comma
id|ignore_sense
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * The lcs header &n; * offset=the offset of the next cmd/network packet &n; * type=command ethernet token ring fddi frame &n; * slot=relative adapter no&n; */
DECL|macro|LCS_MAX_FORCED_DEVNOS
mdefine_line|#define LCS_MAX_FORCED_DEVNOS 12
DECL|macro|LCS_MAX_FORCED_DEVNOS_X2_STR
mdefine_line|#define LCS_MAX_FORCED_DEVNOS_X2_STR &quot;24&quot;
r_typedef
r_struct
(brace
DECL|member|devno
r_int
id|devno
suffix:semicolon
DECL|member|portno
r_int
id|portno
suffix:semicolon
DECL|typedef|lcs_dev_portno_pair
)brace
id|lcs_dev_portno_pair
suffix:semicolon
DECL|variable|devno_portno_pairs
r_static
r_int
id|devno_portno_pairs
(braket
id|LCS_MAX_FORCED_DEVNOS
op_lshift
l_int|1
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
(paren
(paren
id|LCS_MAX_FORCED_DEVNOS
op_lshift
l_int|1
)paren
op_minus
l_int|1
)paren
)braket
l_int|2
comma
)brace
suffix:semicolon
DECL|variable|lcs_dev_portno
r_static
id|lcs_dev_portno_pair
op_star
id|lcs_dev_portno
op_assign
(paren
id|lcs_dev_portno_pair
op_star
)paren
op_amp
id|devno_portno_pairs
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#endif
DECL|macro|lcs_header
mdefine_line|#define lcs_header           &bslash;&n;u16&t;&t;offset;      &bslash;&n;u8&t;&t;type;        &bslash;&n;u8&t;&t;slot;
r_typedef
r_struct
(brace
DECL|typedef|lcs_header_type
id|lcs_header
)brace
id|lcs_header_type
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
r_enum
(brace
DECL|enumerator|lcs_390_initiated
id|lcs_390_initiated
comma
DECL|enumerator|lcs_lgw_initiated
id|lcs_lgw_initiated
)brace
suffix:semicolon
multiline_comment|/*&n; * lcs startup &amp; shutdown commands &n; */
DECL|macro|lcs_base_cmd
mdefine_line|#define lcs_base_cmd         &bslash;&n;u8&t;&t;cmd_code;    &bslash;&n;u8&t;&t;initiator;   &bslash;&n;u16&t;&t;sequence_no; &bslash;&n;u16&t;&t;return_code; &bslash;&n;
r_typedef
r_struct
(brace
DECL|member|lan_type
id|lcs_header
id|lcs_base_cmd
id|u8
id|lan_type
suffix:semicolon
DECL|member|rel_adapter_no
id|u8
id|rel_adapter_no
suffix:semicolon
DECL|member|parameter_count
id|u16
id|parameter_count
suffix:semicolon
DECL|member|operator_flags
id|u8
id|operator_flags
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|reserved
id|u8
id|reserved
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|command_data
id|u8
id|command_data
(braket
l_int|0
)braket
suffix:semicolon
DECL|typedef|lcs_std_cmd
)brace
id|lcs_std_cmd
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|unused1
id|lcs_header
id|lcs_base_cmd
id|u16
id|unused1
suffix:semicolon
DECL|member|buff_size
id|u16
id|buff_size
suffix:semicolon
DECL|member|unused2
id|u8
id|unused2
(braket
l_int|6
)braket
suffix:semicolon
DECL|typedef|lcs_startup_cmd
)brace
id|lcs_startup_cmd
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|macro|LCS_ADDR_LEN
mdefine_line|#define LCS_ADDR_LEN 6
macro_line|#ifdef CONFIG_IP_MULTICAST
r_typedef
r_struct
(brace
DECL|member|ip_addr
id|u32
id|ip_addr
suffix:semicolon
DECL|member|mac_address
id|u8
id|mac_address
(braket
id|LCS_ADDR_LEN
)braket
suffix:semicolon
DECL|member|reserved
id|u8
id|reserved
(braket
l_int|2
)braket
suffix:semicolon
DECL|typedef|lcs_ip_mac_addr_pair
)brace
id|lcs_ip_mac_addr_pair
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
r_typedef
r_enum
(brace
DECL|enumerator|ipm_set_required
id|ipm_set_required
comma
DECL|enumerator|ipm_delete_required
id|ipm_delete_required
comma
DECL|enumerator|ipm_on_card
id|ipm_on_card
DECL|typedef|lcs_ipm_state
)brace
id|lcs_ipm_state
suffix:semicolon
DECL|typedef|lcs_ipm_list
r_typedef
r_struct
id|lcs_ipm_list
id|lcs_ipm_list
suffix:semicolon
DECL|struct|lcs_ipm_list
r_struct
id|lcs_ipm_list
(brace
DECL|member|next
r_struct
id|lcs_ipm_list
op_star
id|next
suffix:semicolon
DECL|member|ipm
id|lcs_ip_mac_addr_pair
id|ipm
suffix:semicolon
DECL|member|ipm_state
id|lcs_ipm_state
id|ipm_state
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|MAX_IP_MAC_PAIRS
mdefine_line|#define MAX_IP_MAC_PAIRS      32
r_typedef
r_struct
(brace
DECL|member|lan_type
id|lcs_header
id|lcs_base_cmd
id|u8
id|lan_type
suffix:semicolon
DECL|member|rel_adapter_no
id|u8
id|rel_adapter_no
suffix:semicolon
multiline_comment|/* OSA only will only support one IP Multicast entry at a time */
DECL|member|num_ipm_pairs
id|u16
id|num_ipm_pairs
suffix:semicolon
DECL|member|ip_assists_supported
id|u16
id|ip_assists_supported
suffix:semicolon
multiline_comment|/* returned by OSA  */
DECL|member|ip_assists_enabled
id|u16
id|ip_assists_enabled
suffix:semicolon
multiline_comment|/* returned by OSA */
DECL|member|version
id|u16
id|version
suffix:semicolon
multiline_comment|/* IP version i.e. 4 */
DECL|member|ip_mac_pair
id|lcs_ip_mac_addr_pair
id|ip_mac_pair
(braket
id|MAX_IP_MAC_PAIRS
)braket
suffix:semicolon
DECL|member|response_data
id|u32
id|response_data
suffix:semicolon
DECL|typedef|lcs_ipm_ctlmsg
)brace
id|lcs_ipm_ctlmsg
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|lan_type
id|lcs_header
id|lcs_base_cmd
id|u8
id|lan_type
suffix:semicolon
DECL|member|rel_adapter_no
id|u8
id|rel_adapter_no
suffix:semicolon
DECL|member|num_ip_pairs
id|u16
id|num_ip_pairs
suffix:semicolon
multiline_comment|/* should be 0 */
DECL|member|ip_assists_supported
id|u16
id|ip_assists_supported
suffix:semicolon
multiline_comment|/* returned by OSA  */
DECL|member|ip_assists_enabled
id|u16
id|ip_assists_enabled
suffix:semicolon
multiline_comment|/* returned by OSA */
DECL|member|version
id|u16
id|version
suffix:semicolon
multiline_comment|/* IP version i.e. 4 */
DECL|typedef|lcs_qipassist_ctlmsg
)brace
id|lcs_qipassist_ctlmsg
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
r_typedef
r_enum
(brace
multiline_comment|/* Not supported by LCS */
DECL|enumerator|lcs_arp_processing
id|lcs_arp_processing
op_assign
l_int|0x0001
comma
DECL|enumerator|lcs_inbound_checksum_support
id|lcs_inbound_checksum_support
op_assign
l_int|0x0002
comma
DECL|enumerator|lcs_outbound_checksum_support
id|lcs_outbound_checksum_support
op_assign
l_int|0x0004
comma
DECL|enumerator|lcs_ip_frag_reassembly
id|lcs_ip_frag_reassembly
op_assign
l_int|0x0008
comma
DECL|enumerator|lcs_ip_filtering
id|lcs_ip_filtering
op_assign
l_int|0x0010
comma
multiline_comment|/* Supported by lcs 3172 */
DECL|enumerator|lcs_ip_v6_support
id|lcs_ip_v6_support
op_assign
l_int|0x0020
comma
DECL|enumerator|lcs_multicast_support
id|lcs_multicast_support
op_assign
l_int|0x0040
DECL|typedef|lcs_assists
)brace
id|lcs_assists
suffix:semicolon
DECL|macro|LANCMD_DEFAULT_MCAST_PARMS
mdefine_line|#define LANCMD_DEFAULT_MCAST_PARMS ,0,NULL
macro_line|#else
DECL|macro|LANCMD_DEFAULT_MCAST_PARMS
mdefine_line|#define LANCMD_DEFAULT_MCAST_PARMS
macro_line|#endif
r_typedef
r_struct
(brace
DECL|member|lan_type
id|lcs_header
id|lcs_base_cmd
id|u8
id|lan_type
suffix:semicolon
DECL|member|rel_adapter_no
id|u8
id|rel_adapter_no
suffix:semicolon
DECL|member|unused1
id|u8
id|unused1
(braket
l_int|10
)braket
suffix:semicolon
DECL|member|mac_address
id|u8
id|mac_address
(braket
id|LCS_ADDR_LEN
)braket
suffix:semicolon
DECL|member|num_packets_deblocked
id|u32
id|num_packets_deblocked
suffix:semicolon
DECL|member|num_packets_blocked
id|u32
id|num_packets_blocked
suffix:semicolon
DECL|member|num_packets_tx_on_lan
id|u32
id|num_packets_tx_on_lan
suffix:semicolon
DECL|member|num_tx_errors_detected
id|u32
id|num_tx_errors_detected
suffix:semicolon
DECL|member|num_tx_packets_disgarded
id|u32
id|num_tx_packets_disgarded
suffix:semicolon
DECL|member|num_packets_rx_from_lan
id|u32
id|num_packets_rx_from_lan
suffix:semicolon
DECL|member|num_rx_errors_detected
id|u32
id|num_rx_errors_detected
suffix:semicolon
DECL|member|num_rx_discarded_nobuffs_avail
id|u32
id|num_rx_discarded_nobuffs_avail
suffix:semicolon
DECL|member|num_rx_packets_too_large
id|u32
id|num_rx_packets_too_large
suffix:semicolon
DECL|typedef|lcs_lanstat_reply
)brace
id|lcs_lanstat_reply
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
multiline_comment|/* This buffer sizes are used by MVS so they should be reasonable */
DECL|macro|LCS_IOBUFFSIZE
mdefine_line|#define LCS_IOBUFFSIZE     0x5000
DECL|macro|LCS_NUM_TX_BUFFS
mdefine_line|#define LCS_NUM_TX_BUFFS    8
DECL|macro|LCS_NUM_RX_BUFFS
mdefine_line|#define LCS_NUM_RX_BUFFS    8
DECL|macro|LCS_INVALID_LOCK_OWNER
mdefine_line|#define LCS_INVALID_LOCK_OWNER            -1
macro_line|#if LINUX_VERSION_CODE&lt;KERNEL_VERSION(2,2,18)
DECL|typedef|wait_queue_head_t
r_typedef
r_struct
id|wait_queue
op_star
id|wait_queue_head_t
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE&lt;KERNEL_VERSION(2,4,0)
DECL|typedef|s390_dev_info_t
r_typedef
id|dev_info_t
id|s390_dev_info_t
suffix:semicolon
macro_line|#endif
r_typedef
r_enum
(brace
DECL|enumerator|chan_dead
id|chan_dead
comma
DECL|enumerator|chan_idle
id|chan_idle
comma
DECL|enumerator|chan_busy
id|chan_busy
comma
DECL|enumerator|chan_starting_up
id|chan_starting_up
comma
DECL|enumerator|chan_started_successfully
id|chan_started_successfully
DECL|typedef|lcs_chan_busy_state
)brace
id|lcs_chan_busy_state
suffix:semicolon
DECL|macro|LCS_MAGIC
mdefine_line|#define LCS_MAGIC&t;&t;&t;0x05A22A05&t;/* OSA2 to you */
DECL|macro|LCS_CHAN_GLOBALS
mdefine_line|#define LCS_CHAN_GLOBALS(num_io_buffs)      &bslash;&n;u32                  irq_allocated_magic;   &bslash;&n;u16 subchannel;                             &bslash;&n;u16 devno;                                  &bslash;&n;struct lcs_drvr_globals *drvr_globals;      &bslash;&n;atomic_t             sleeping_on_io;        &bslash;&n;unsigned long        flags;                 &bslash;&n;int                  rc;                    &bslash;&n;int                  lock_owner;            &bslash;&n;int                  lock_cnt;              &bslash;&n;wait_queue_head_t    wait;                  &bslash;&n;struct  tq_struct    retry_task;            &bslash;&n;devstat_t&t;     devstat;               &bslash;&n;lcs_chan_busy_state  chan_busy_state;       &bslash;&n;ccw1_t               ccw[num_io_buffs+1];   &bslash;&n;
r_typedef
r_struct
(brace
id|LCS_CHAN_GLOBALS
c_func
(paren
l_int|0
)paren
DECL|typedef|lcs_chan_globals
)brace
id|lcs_chan_globals
suffix:semicolon
r_typedef
r_struct
(brace
id|LCS_CHAN_GLOBALS
c_func
(paren
id|LCS_NUM_RX_BUFFS
)paren
macro_line|#if LCS_ZERO_COPY_READ
r_struct
id|sk_buff
op_star
id|skb_buff
(braket
id|LCS_NUM_RX_BUFFS
)braket
suffix:semicolon
macro_line|#else
id|u8
op_star
id|iobuff
(braket
id|LCS_NUM_RX_BUFFS
)braket
suffix:semicolon
macro_line|#endif
DECL|member|lancmd_reply_ptr
id|lcs_std_cmd
op_star
id|lancmd_reply_ptr
suffix:semicolon
multiline_comment|/* only used by read channel */
DECL|member|rx_idx
id|u32
id|rx_idx
suffix:semicolon
DECL|member|pad
id|u8
id|pad
(braket
l_int|0
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* so the next structure&n;&t;&t;&t;&t;&t;&t;   will be aligned */
DECL|typedef|lcs_read_globals
)brace
id|lcs_read_globals
suffix:semicolon
r_typedef
r_struct
(brace
id|LCS_CHAN_GLOBALS
c_func
(paren
id|LCS_NUM_TX_BUFFS
)paren
id|u8
op_star
id|iobuff
(braket
id|LCS_NUM_TX_BUFFS
)braket
suffix:semicolon
DECL|member|prepare_idx
id|u32
id|prepare_idx
suffix:semicolon
multiline_comment|/* current buffer being prepared */
DECL|member|tx_idx
id|u32
id|tx_idx
suffix:semicolon
multiline_comment|/* last buffer successfully transmitted */
DECL|member|pkts_still_being_txed
r_int
r_int
id|pkts_still_being_txed
suffix:semicolon
DECL|member|bytes_still_being_txed
r_int
r_int
id|bytes_still_being_txed
suffix:semicolon
DECL|member|resume_task
r_struct
id|tq_struct
id|resume_task
suffix:semicolon
DECL|member|resume_queued
r_int
id|resume_queued
suffix:semicolon
DECL|member|resume_loopcnt
r_int
id|resume_loopcnt
suffix:semicolon
DECL|member|last_lcs_txpacket_time
r_uint64
id|last_lcs_txpacket_time
suffix:semicolon
DECL|member|last_resume_time
r_uint64
id|last_resume_time
suffix:semicolon
DECL|member|adjusted_last_bytes_still_being_txed
r_uint64
id|adjusted_last_bytes_still_being_txed
suffix:semicolon
DECL|typedef|lcs_write_globals
)brace
id|lcs_write_globals
suffix:semicolon
DECL|macro|LCS_READ_ALLOCSIZE
mdefine_line|#define LCS_READ_ALLOCSIZE      LCS_IOBUFFSIZE
multiline_comment|/*&n; * drvr_globals main state machine &n; */
r_typedef
r_enum
(brace
DECL|enumerator|lcs_idle
id|lcs_idle
comma
DECL|enumerator|lcs_halting_subchannels
id|lcs_halting_subchannels
comma
DECL|enumerator|lcs_doing_io
id|lcs_doing_io
comma
DECL|enumerator|lcs_idle_requesting_channels_for_lancmds
id|lcs_idle_requesting_channels_for_lancmds
comma
DECL|enumerator|lcs_requesting_channels_for_lancmds
id|lcs_requesting_channels_for_lancmds
comma
DECL|enumerator|lcs_got_write_channel_for_lancmds
id|lcs_got_write_channel_for_lancmds
comma
DECL|enumerator|lcs_doing_lancmds
id|lcs_doing_lancmds
comma
DECL|enumerator|lcs_interrupted
id|lcs_interrupted
DECL|typedef|lcs_state
)brace
id|lcs_state
suffix:semicolon
r_enum
(brace
DECL|enumerator|lcs_invalid_adapter_no
id|lcs_invalid_adapter_no
op_assign
op_minus
l_int|1
)brace
suffix:semicolon
DECL|typedef|lcs_drvr_globals
r_typedef
r_struct
id|lcs_drvr_globals
id|lcs_drvr_globals
suffix:semicolon
DECL|struct|lcs_drvr_globals
r_struct
id|lcs_drvr_globals
(brace
DECL|member|next
r_struct
id|lcs_drvr_globals
op_star
id|next
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
DECL|member|usage_cnt
id|atomic_t
id|usage_cnt
suffix:semicolon
multiline_comment|/* used by drvr_globals_valid &n;&t;&t;&t;&t; * &amp; lcs_usage_free_drvr_globals */
DECL|member|lan_type
id|u8
id|lan_type
suffix:semicolon
DECL|member|cmd_code
id|u8
id|cmd_code
suffix:semicolon
DECL|member|lan_type_trans
r_int
r_int
(paren
op_star
id|lan_type_trans
)paren
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
DECL|member|lanstat_wait
id|wait_queue_head_t
id|lanstat_wait
suffix:semicolon
multiline_comment|/* processes asleep awaiting &n;&t;&t;&t;&t;&t; * lanstat results */
DECL|member|doing_lanstat
r_int
id|doing_lanstat
suffix:semicolon
DECL|member|up
r_int
id|up
suffix:semicolon
DECL|member|state
id|lcs_state
id|state
suffix:semicolon
DECL|member|read
id|lcs_read_globals
op_star
id|read
suffix:semicolon
DECL|member|write
id|lcs_write_globals
op_star
id|write
suffix:semicolon
DECL|member|sequence_no
id|u16
id|sequence_no
suffix:semicolon
DECL|member|rel_adapter_no
id|s16
id|rel_adapter_no
suffix:semicolon
DECL|member|slow_hw
r_int
id|slow_hw
suffix:semicolon
multiline_comment|/* To insure only one kernel thread runs at a time */
DECL|member|kernel_thread_lock
id|atomic_t
id|kernel_thread_lock
suffix:semicolon
DECL|member|kernel_thread_routine
r_int
(paren
op_star
id|kernel_thread_routine
)paren
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
suffix:semicolon
DECL|member|kernel_thread_task
r_struct
id|tq_struct
id|kernel_thread_task
suffix:semicolon
DECL|member|lgw_sequence_no
id|u16
id|lgw_sequence_no
suffix:semicolon
multiline_comment|/* this isn&squot;t required just being thorough */
DECL|member|retry_cnt
id|atomic_t
id|retry_cnt
suffix:semicolon
DECL|member|stats
r_struct
id|net_device_stats
id|stats
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|4
)paren
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
DECL|member|ipm_lock
id|spinlock_t
id|ipm_lock
suffix:semicolon
DECL|member|ipm_list
id|lcs_ipm_list
op_star
id|ipm_list
suffix:semicolon
macro_line|#endif
multiline_comment|/* So I can use atomic atomic_t for stats if required  */
DECL|member|pad
id|u8
id|pad
(braket
l_int|0
)braket
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* CCW&squot;s need 8 byte alignment ( Thanks Martin ) */
)brace
id|__attribute__
(paren
(paren
id|aligned
c_func
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* &n; * A token ring header can be 40 bytes if you include the llc &amp; rcf so we &n; * leave a small bit extra.&n; */
DECL|macro|LCS_TX_HIWATERMARK
mdefine_line|#define LCS_TX_HIWATERMARK          LCS_IOBUFFSIZE-60
DECL|macro|LCS_ALLOCSIZE
mdefine_line|#define LCS_ALLOCSIZE (sizeof(lcs_drvr_globals)+sizeof(lcs_read_globals)+sizeof(lcs_write_globals))
multiline_comment|/* Function prototypes */
r_static
r_int
id|lcs_rxpacket
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
id|u8
op_star
id|start_buff
comma
id|lcs_std_cmd
op_star
op_star
id|lancmd_reply
macro_line|#if LCS_ZERO_COPY_READ
comma
id|u32
id|curr_idx
macro_line|#endif
)paren
suffix:semicolon
r_static
r_int
id|lcs_txpacket
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|lcs_detect
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
id|s16
id|forced_port_no
comma
id|u8
id|hint_port_no
comma
id|u8
id|max_port_no
comma
id|lcs_frame_type
id|frame_type
comma
id|u8
op_star
id|mac_address
)paren
suffix:semicolon
r_static
r_int
id|lcs_check_reset
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
suffix:semicolon
r_static
r_void
id|lcs_restartreadio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
suffix:semicolon
r_static
r_void
id|lcs_restartwriteio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
suffix:semicolon
r_static
r_void
id|lcs_queued_restartreadio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
suffix:semicolon
r_static
r_void
id|lcs_queued_restartwriteio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
suffix:semicolon
r_static
r_void
id|lcs_resume_writetask
c_func
(paren
id|lcs_write_globals
op_star
id|write
)paren
suffix:semicolon
macro_line|#ifdef MODULE
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_MULTICAST
r_static
r_int
id|lcs_fix_multicast_list
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
suffix:semicolon
macro_line|#endif
DECL|macro|lcs_debug_initmessage
mdefine_line|#define lcs_debug_initmessage      char *message=NULL;
DECL|macro|lcs_debug_setmessage
mdefine_line|#define lcs_debug_setmessage(string) message=string
macro_line|#if LCS_DEBUG
macro_line|#if LCS_PRINTK_DEBUG
DECL|macro|lcs_debug_event
mdefine_line|#define lcs_debug_event(level,args...)      printk(##args)
DECL|macro|lcs_debug_exception
mdefine_line|#define lcs_debug_exception(level,args...)  printk(##args)
DECL|macro|lcs_bad_news
mdefine_line|#define lcs_bad_news(args...)         printk(KERN_CRIT ##args);
DECL|macro|lcs_good_news
mdefine_line|#define lcs_good_news(args...)         printk(##args);
macro_line|#else
DECL|variable|lcs_id
r_static
id|debug_info_t
op_star
id|lcs_id
op_assign
l_int|NULL
suffix:semicolon
DECL|macro|lcs_debug_event
mdefine_line|#define lcs_debug_event(args...)      debug_sprintf_event(lcs_id,##args)
DECL|macro|lcs_debug_exception
mdefine_line|#define lcs_debug_exception(args...)  debug_sprintf_exception(lcs_id,##args)
multiline_comment|/* &amp;formatstr[3] is to get over the KERN_CRIT prefix */
DECL|macro|lcs_bad_news
mdefine_line|#define lcs_bad_news(format,args...)                   &bslash;&n;{                                                      &bslash;&n;        char *formatstr= KERN_CRIT format;             &bslash;&n;&t;lcs_debug_exception(0,&amp;formatstr[3] ,## args); &bslash;&n;&t;printk(formatstr ,## args);                    &bslash;&n;}
DECL|macro|lcs_good_news
mdefine_line|#define lcs_good_news(format,args...)                  &bslash;&n;{                                                      &bslash;&n;        char *formatstr=format;                        &bslash;&n;&t;lcs_debug_event(0,formatstr ,## args);         &bslash;&n;&t;printk(formatstr ,## args);                    &bslash;&n;}
macro_line|#endif
DECL|macro|lcs_debugchannel
mdefine_line|#define lcs_debugchannel(message,chan_globals) &bslash;&n;lcs_debugchannel_func((message),(lcs_chan_globals *)(chan_globals))
r_static
r_void
DECL|function|lcs_debugchannel_func
id|lcs_debugchannel_func
c_func
(paren
r_char
op_star
id|message
comma
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
suffix:semicolon
r_if
c_cond
(paren
id|message
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs: %s&bslash;n&quot;
comma
id|message
)paren
suffix:semicolon
)brace
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs  irq=%04x devno=%04x %s&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;subchannel
comma
(paren
r_int
)paren
id|chan_globals-&gt;devno
comma
(paren
id|message
ques
c_cond
id|message
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;chan globals=%p&bslash;n&quot;
comma
id|chan_globals
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_globals
)paren
(brace
id|drvr_globals
op_assign
id|chan_globals-&gt;drvr_globals
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals
)paren
(brace
r_if
c_cond
(paren
id|drvr_globals-&gt;read
op_ne
(paren
id|lcs_read_globals
op_star
)paren
id|chan_globals
op_logical_and
id|drvr_globals-&gt;write
op_ne
(paren
id|lcs_write_globals
op_star
)paren
id|chan_globals
)paren
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;drvr globals inconsistent&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;drvr_globals=%p:state=%d&bslash;n&quot;
comma
id|drvr_globals
comma
id|drvr_globals-&gt;state
)paren
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;chan globals sleeping_on_io=%d&quot;
l_string|&quot; busy_state=%d lock_owner=%d &quot;
l_string|&quot;lock_cnt=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|chan_globals
op_member_access_from_pointer
id|sleeping_on_io
)paren
comma
id|chan_globals-&gt;chan_busy_state
comma
id|chan_globals-&gt;lock_owner
comma
id|chan_globals-&gt;lock_cnt
)paren
suffix:semicolon
)brace
)brace
id|lcs_debug_exception
c_func
(paren
l_int|0
comma
l_string|&quot;leaving lcs_debugchannel&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_debug_display_read_buff
id|lcs_debug_display_read_buff
c_func
(paren
r_char
op_star
id|message
comma
id|lcs_std_cmd
op_star
id|lancmd_reply_ptr
)paren
(brace
r_int
op_star
id|read_buff
op_assign
(paren
r_int
op_star
)paren
id|lancmd_reply_ptr
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;%s %08x %08x %08x&bslash;n&quot;
comma
id|message
comma
id|read_buff
(braket
l_int|0
)braket
comma
id|read_buff
(braket
l_int|1
)braket
comma
id|read_buff
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|lcs_debug_event
mdefine_line|#define lcs_debug_event(noargs...)
DECL|macro|lcs_debug_exception
mdefine_line|#define lcs_debug_exception(noargs...)
DECL|macro|lcs_bad_news
mdefine_line|#define lcs_bad_news(args...)  printk(KERN_CRIT ##args)
DECL|macro|lcs_good_news
mdefine_line|#define lcs_good_news(args...)  printk(##args)
DECL|macro|lcs_debugchannel
mdefine_line|#define lcs_debugchannel(message,chan_globals)   &bslash;&n;printk(&quot;lcs  irq=%04x devno=%04x %s&bslash;n&quot;,(int)chan_globals-&gt;subchannel, &bslash;&n;(int)chan_globals-&gt;devno,(message ? message:&quot;&quot;))
DECL|macro|lcs_debug_display_read_buff
mdefine_line|#define lcs_debug_display_read_buff(noargs...)
macro_line|#endif
macro_line|#if (!LCS_USE_IDALS) &amp;&amp; (CONFIG_ARCH_S390X)
r_static
r_inline
r_struct
id|sk_buff
op_star
DECL|function|lcs_dev_alloc_skb
id|lcs_dev_alloc_skb
c_func
(paren
r_int
r_int
id|length
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|length
op_plus
l_int|16
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|skb_reserve
c_func
(paren
id|skb
comma
l_int|16
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
macro_line|#endif
r_static
r_void
id|lcs_inline
DECL|function|lcs_resetstate
id|lcs_resetstate
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
id|drvr_globals-&gt;state
op_assign
id|lcs_idle
suffix:semicolon
)brace
multiline_comment|/* &n; * Primatives used to put the process to sleep or wake it up during startup &n; * or shutdown.&n; */
r_static
id|lcs_inline
r_void
DECL|function|lcs_initqueue_func
id|lcs_initqueue_func
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|chan_globals-&gt;sleeping_on_io
comma
id|TRUE
)paren
suffix:semicolon
id|chan_globals-&gt;rc
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
id|init_waitqueue_head
c_func
(paren
op_amp
id|chan_globals-&gt;wait
)paren
suffix:semicolon
macro_line|#else
id|chan_globals-&gt;wait
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
DECL|macro|lcs_initqueue
mdefine_line|#define lcs_initqueue(chan_globals) &bslash;&n;&t;lcs_initqueue_func((lcs_chan_globals *)chan_globals)
r_static
r_void
DECL|function|lcs_wakeup_func
id|lcs_wakeup_func
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
comma
r_int
id|rc
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_wakeup called sch=%04x rc=%d&bslash;n,&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;subchannel
comma
id|rc
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|chan_globals-&gt;sleeping_on_io
comma
id|FALSE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_globals-&gt;rc
op_eq
l_int|0
)paren
id|chan_globals-&gt;rc
op_assign
id|rc
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|chan_globals-&gt;wait
)paren
suffix:semicolon
)brace
DECL|macro|TOD_SHIFT_TO_USECS
mdefine_line|#define TOD_SHIFT_TO_USECS 12
r_static
r_inline
r_uint64
DECL|function|lcs_get_tod
id|lcs_get_tod
c_func
(paren
r_void
)paren
(brace
r_uint64
id|cc
suffix:semicolon
id|asm
r_volatile
(paren
l_string|&quot;STCK %0&quot;
suffix:colon
l_string|&quot;=m&quot;
(paren
id|cc
)paren
)paren
suffix:semicolon
r_return
(paren
id|cc
)paren
suffix:semicolon
)brace
DECL|macro|lcs_wakeup
mdefine_line|#define lcs_wakeup(chan_globals,rc) &bslash;&n;&t;lcs_wakeup_func((lcs_chan_globals *)chan_globals,(rc))
r_static
r_int
DECL|function|lcs_sleepon_func
id|lcs_sleepon_func
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
comma
r_int
id|extratime
)paren
(brace
multiline_comment|/*&n;&t;   We have a miniscule chance of sleeping here for 1 second&n;&t;   we have to unfortunately live with it as down_interruptible&n;&t;   dosen&squot;t wake up for timers just signals.&n;&t; */
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_sleepon called sch=%04x&bslash;n,&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;subchannel
)paren
suffix:semicolon
macro_line|#warning FIXME: [kj] Using sleep_on derivative, is racy. consider using wait_event instead
id|sleep_on_timeout
c_func
(paren
op_amp
id|chan_globals-&gt;wait
comma
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chan_globals-&gt;sleeping_on_io
)paren
op_logical_and
id|chan_globals-&gt;rc
op_eq
l_int|0
op_logical_and
id|extratime
)paren
(brace
id|lcs_bad_news
(paren
l_string|&quot;lcs_sleepon network card taking time responding &quot;
l_string|&quot;irq=%04x devno=%04x,&bslash;n&quot;
l_string|&quot;please be patient, ctrl-c will exit if shell prompt &quot;
l_string|&quot;is available.&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;subchannel
comma
(paren
r_int
)paren
id|chan_globals-&gt;devno
)paren
suffix:semicolon
macro_line|#warning FIXME: [kj] Using sleep_on derivative, is racy. consider using wait_event instead
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|chan_globals-&gt;wait
comma
id|extratime
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chan_globals-&gt;sleeping_on_io
)paren
op_logical_and
id|chan_globals-&gt;rc
op_eq
l_int|0
)paren
(brace
id|chan_globals-&gt;drvr_globals-&gt;state
op_assign
id|lcs_interrupted
suffix:semicolon
id|rc
op_assign
(paren
id|test_thread_flag
c_func
(paren
id|TIF_SIGPENDING
)paren
ques
c_cond
op_minus
id|EINTR
suffix:colon
op_minus
id|ETIMEDOUT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan_globals-&gt;rc
)paren
id|rc
op_assign
id|chan_globals-&gt;rc
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_sleepon sch=%04x devno=%04x rc=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;subchannel
comma
(paren
r_int
)paren
id|chan_globals-&gt;devno
comma
id|rc
)paren
suffix:semicolon
r_return
(paren
id|rc
)paren
suffix:semicolon
)brace
DECL|macro|lcs_sleepon
mdefine_line|#define lcs_sleepon(chan_globals,extratime) &bslash;&n;&t;lcs_sleepon_func((lcs_chan_globals *)chan_globals,extratime)
r_static
r_void
DECL|function|lcs_chan_lock_func
id|lcs_chan_lock_func
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_globals-&gt;lock_owner
op_ne
id|smp_processor_id
c_func
(paren
)paren
)paren
(brace
id|s390irq_spin_lock_irqsave
c_func
(paren
id|chan_globals-&gt;subchannel
comma
id|chan_globals-&gt;flags
)paren
suffix:semicolon
id|chan_globals-&gt;lock_cnt
op_assign
l_int|1
suffix:semicolon
id|chan_globals-&gt;lock_owner
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|chan_globals-&gt;lock_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|chan_globals-&gt;lock_cnt
template_param
l_int|100
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;bad lock_cnt %d in lcs_chan_lock chan_globals=%p&quot;
l_string|&quot; devno=%04x returnaddrs=%p,%p cpu=%d&bslash;n&quot;
comma
id|chan_globals-&gt;lock_cnt
comma
id|chan_globals
comma
(paren
r_int
)paren
id|chan_globals-&gt;devno
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
comma
id|__builtin_return_address
c_func
(paren
l_int|1
)paren
comma
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|chan_globals-&gt;lock_cnt
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|lcs_chan_unlock_func
id|lcs_chan_unlock_func
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
r_if
c_cond
(paren
id|chan_globals-&gt;lock_cnt
op_le
l_int|0
)paren
(brace
id|lcs_bad_news
(paren
l_string|&quot;bad lock_cnt %d in lcs_chan_unlock chan_globals=%p&quot;
l_string|&quot; devno=%04x returnaddrs=%p,%p cpu=%d&bslash;n&quot;
comma
id|chan_globals-&gt;lock_cnt
comma
id|chan_globals
comma
(paren
r_int
)paren
id|chan_globals-&gt;devno
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
comma
id|__builtin_return_address
c_func
(paren
l_int|1
)paren
comma
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|chan_globals-&gt;lock_cnt
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|chan_globals-&gt;lock_cnt
op_eq
l_int|0
)paren
(brace
id|chan_globals-&gt;lock_owner
op_assign
id|LCS_INVALID_LOCK_OWNER
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|chan_globals-&gt;subchannel
comma
id|chan_globals-&gt;flags
)paren
suffix:semicolon
)brace
)brace
DECL|macro|lcs_chan_lock
mdefine_line|#define lcs_chan_lock(chan_globals) &bslash;&n;&t;lcs_chan_lock_func((lcs_chan_globals *)chan_globals)
DECL|macro|lcs_chan_unlock
mdefine_line|#define lcs_chan_unlock(chan_globals) &bslash;&n;&t;lcs_chan_unlock_func((lcs_chan_globals *)chan_globals)
r_static
r_int
r_inline
DECL|function|lcs_getbuffs_filled
id|lcs_getbuffs_filled
c_func
(paren
id|lcs_write_globals
op_star
id|write
)paren
(brace
r_return
(paren
(paren
id|write-&gt;prepare_idx
op_minus
id|write-&gt;tx_idx
)paren
op_plus
(paren
id|write-&gt;prepare_idx
OG
id|write-&gt;tx_idx
ques
c_cond
op_minus
l_int|1
suffix:colon
(paren
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
)paren
)paren
op_plus
(paren
id|write-&gt;ccw
(braket
id|write-&gt;prepare_idx
)braket
dot
id|count
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * A little utility routine to make a ccw chain.&n; */
r_static
r_void
DECL|function|initccws
id|initccws
c_func
(paren
id|ccw1_t
op_star
id|ccws
comma
id|u8
op_star
id|iobuff
(braket
)braket
comma
r_int
id|num_ccws
comma
id|u8
id|cmd_code
comma
id|u16
id|count
comma
id|u8
id|flags
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|ccw1_t
op_star
id|origccws
op_assign
id|ccws
suffix:semicolon
id|memset
c_func
(paren
id|ccws
comma
l_int|0
comma
r_sizeof
(paren
id|ccw1_t
)paren
op_star
id|num_ccws
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|num_ccws
suffix:semicolon
id|cnt
op_increment
comma
id|ccws
op_increment
)paren
(brace
id|ccws-&gt;cmd_code
op_assign
id|cmd_code
suffix:semicolon
id|ccws-&gt;count
op_assign
id|count
suffix:semicolon
id|ccws-&gt;flags
op_assign
id|flags
suffix:semicolon
multiline_comment|/* ccw addresses are 32 bit */
(paren
id|u32
)paren
id|ccws-&gt;cda
op_assign
(paren
id|u32
)paren
id|virt_to_phys
c_func
(paren
id|iobuff
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
id|ccws-&gt;cmd_code
op_assign
id|ccw_transfer_in_channel1
suffix:semicolon
(paren
id|u32
)paren
id|ccws-&gt;cda
op_assign
(paren
id|u32
)paren
id|virt_to_phys
c_func
(paren
id|origccws
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * linked list used to hold all the lcs_drvr_globals so they can be&n; * freed up when the driver is finished &n; */
DECL|variable|lcs_card_list_lock
r_static
id|spinlock_t
id|lcs_card_list_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|lcs_card_list
r_static
id|lcs_drvr_globals
op_star
id|lcs_card_list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;  This function is required for kernel threads &amp; timers&n;  going off after the driver is closed &amp; long gone &amp; causing mischef.&n;  ( thanks Ingo for making me aware that this was happening :-) )&n; */
r_static
r_int
DECL|function|lcs_drvr_globals_valid
id|lcs_drvr_globals_valid
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_int
id|in_list
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|lcs_card_list_lock
)paren
suffix:semicolon
id|in_list
op_assign
id|is_in_list
c_func
(paren
(paren
id|list
op_star
)paren
id|lcs_card_list
comma
(paren
id|list
op_star
)paren
id|drvr_globals
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_list
)paren
id|atomic_inc
c_func
(paren
op_amp
id|drvr_globals-&gt;usage_cnt
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lcs_card_list_lock
)paren
suffix:semicolon
)brace
r_return
(paren
id|in_list
)paren
suffix:semicolon
)brace
r_static
r_void
op_star
DECL|function|lcs_dma_alloc
id|lcs_dma_alloc
c_func
(paren
r_int
id|allocsize
)paren
(brace
r_void
op_star
id|newalloc
op_assign
id|kmalloc
c_func
(paren
id|allocsize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newalloc
)paren
id|memset
c_func
(paren
id|newalloc
comma
l_int|0
comma
id|allocsize
)paren
suffix:semicolon
r_return
(paren
id|newalloc
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_usage_free_drvr_globals
id|lcs_usage_free_drvr_globals
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
macro_line|#if LCS_ZERO_COPY_READ
r_struct
id|sk_buff
op_star
op_star
id|skb_buff
suffix:semicolon
macro_line|#endif
id|u8
op_star
op_star
id|iobuff
suffix:semicolon
r_int
id|cnt
comma
id|refcnt
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_usage_free_drvr_globals_called %p&bslash;n&quot;
comma
id|drvr_globals
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals
)paren
(brace
id|lcs_read_globals
op_star
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
id|refcnt
op_assign
id|atomic_dec_return
c_func
(paren
op_amp
id|drvr_globals-&gt;usage_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|refcnt
OL
l_int|0
)paren
id|lcs_bad_news
c_func
(paren
l_string|&quot;bad ref cnt drvr_globals %p ref %d&bslash;n&quot;
comma
id|drvr_globals
comma
id|refcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|refcnt
op_le
l_int|0
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|lcs_card_list_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|remove_from_list
(paren
(paren
id|list
op_star
op_star
)paren
op_amp
id|lcs_card_list
comma
(paren
id|list
op_star
)paren
id|drvr_globals
)paren
)paren
id|lcs_bad_news
c_func
(paren
l_string|&quot;drvr globals not in list %p&bslash;n&quot;
comma
id|drvr_globals
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lcs_card_list_lock
)paren
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;freeing drvr globals&bslash;n&quot;
)paren
suffix:semicolon
id|iobuff
op_assign
id|drvr_globals-&gt;write-&gt;iobuff
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_TX_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|iobuff
(braket
id|cnt
)braket
)paren
id|kfree
c_func
(paren
id|iobuff
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
macro_line|#if LCS_ZERO_COPY_READ
id|skb_buff
op_assign
id|read-&gt;skb_buff
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_RX_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|clear_normalized_cda
c_func
(paren
op_amp
id|read-&gt;ccw
(braket
id|cnt
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_buff
(braket
id|cnt
)braket
)paren
id|dev_kfree_skb
c_func
(paren
id|skb_buff
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
macro_line|#else
id|iobuff
op_assign
id|read-&gt;iobuff
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_RX_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|clear_normalized_cda
c_func
(paren
op_amp
id|read-&gt;ccw
(braket
id|cnt
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iobuff
(braket
id|cnt
)braket
)paren
id|kfree
c_func
(paren
id|iobuff
(braket
id|cnt
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|drvr_globals-&gt;dev
)paren
id|drvr_globals-&gt;dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef  CONFIG_IP_MULTICAST
r_while
c_loop
(paren
id|drvr_globals-&gt;ipm_list
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
id|remove_from_list
c_func
(paren
(paren
id|list
op_star
op_star
)paren
op_amp
id|drvr_globals
op_member_access_from_pointer
id|ipm_list
comma
(paren
id|list
op_star
)paren
id|drvr_globals
op_member_access_from_pointer
id|ipm_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drvr_globals-&gt;ipm_list
)paren
suffix:semicolon
)brace
macro_line|#endif
id|memset
c_func
(paren
id|drvr_globals
comma
l_int|0
comma
id|LCS_ALLOCSIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|lcs_kernel_thread
id|lcs_kernel_thread
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
macro_line|#if LINUX_VERSION_CODE&lt;=KERNEL_VERSION(2,2,16)
multiline_comment|/* tq_scheduler sometimes leaves interrupts disabled from do&n;&t; * bottom half */
id|__sti
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|kernel_thread
c_func
(paren
(paren
r_int
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|drvr_globals-&gt;kernel_thread_routine
comma
(paren
r_void
op_star
)paren
id|drvr_globals
comma
id|SIGCHLD
)paren
OL
l_int|0
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_lock
comma
l_int|1
)paren
suffix:semicolon
id|lcs_debug_exception
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_kernel_thread failed to launch a new &quot;
l_string|&quot;thread drvr_globals=%p routine=%p&quot;
comma
id|drvr_globals
comma
id|drvr_globals-&gt;kernel_thread_routine
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|lcs_initreadccws
id|lcs_initreadccws
c_func
(paren
id|lcs_read_globals
op_star
id|read
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|ccw1_t
op_star
id|origccws
comma
op_star
id|ccws
suffix:semicolon
macro_line|#if LCS_ZERO_COPY_READ
r_struct
id|sk_buff
op_star
id|curr_skb
suffix:semicolon
macro_line|#else
id|u8
op_star
id|curr_iobuff
suffix:semicolon
macro_line|#endif
id|origccws
op_assign
id|ccws
op_assign
id|read-&gt;ccw
suffix:semicolon
id|memset
c_func
(paren
id|ccws
comma
l_int|0
comma
r_sizeof
(paren
id|ccw1_t
)paren
op_star
id|LCS_NUM_RX_BUFFS
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_RX_BUFFS
suffix:semicolon
id|cnt
op_increment
comma
id|ccws
op_increment
)paren
(brace
id|ccws-&gt;cmd_code
op_assign
id|ccw_read
suffix:semicolon
macro_line|#if LCS_ZERO_COPY_READ
id|curr_skb
op_assign
id|read-&gt;skb_buff
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|set_normalized_cda
c_func
(paren
id|ccws
comma
id|curr_skb-&gt;data
)paren
)paren
r_return
op_minus
id|ENOMEM
macro_line|#else
id|curr_iobuff
op_assign
id|read-&gt;iobuff
(braket
id|cnt
)braket
suffix:semicolon
r_if
c_cond
(paren
id|set_normalized_cda
c_func
(paren
id|ccws
comma
id|curr_iobuff
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
macro_line|#endif
)brace
id|ccws-&gt;cmd_code
op_assign
id|ccw_transfer_in_channel1
suffix:semicolon
(paren
id|u32
)paren
id|ccws-&gt;cda
op_assign
(paren
id|u32
)paren
id|virt_to_phys
c_func
(paren
id|origccws
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Allocates driver instance globals &n; */
r_static
id|lcs_drvr_globals
op_star
DECL|function|lcs_alloc_drvr_globals
id|lcs_alloc_drvr_globals
c_func
(paren
r_void
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
suffix:semicolon
id|lcs_write_globals
op_star
id|write
suffix:semicolon
id|lcs_read_globals
op_star
id|read
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_struct
id|tq_struct
op_star
id|lcs_tq
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_alloc_drvr_globals called&bslash;n&quot;
)paren
suffix:semicolon
id|drvr_globals
op_assign
id|lcs_dma_alloc
c_func
(paren
id|LCS_ALLOCSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drvr_globals
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;usage_cnt
comma
l_int|1
)paren
suffix:semicolon
id|drvr_globals-&gt;rel_adapter_no
op_assign
id|lcs_invalid_adapter_no
suffix:semicolon
id|read
op_assign
id|drvr_globals-&gt;read
op_assign
(paren
id|lcs_read_globals
op_star
)paren
(paren
id|drvr_globals
op_plus
l_int|1
)paren
suffix:semicolon
id|write
op_assign
id|drvr_globals-&gt;write
op_assign
(paren
id|lcs_write_globals
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|read
op_plus
r_sizeof
(paren
id|lcs_read_globals
)paren
)paren
suffix:semicolon
id|write-&gt;lock_owner
op_assign
id|drvr_globals-&gt;read-&gt;lock_owner
op_assign
id|LCS_INVALID_LOCK_OWNER
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_TX_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|write-&gt;iobuff
(braket
id|cnt
)braket
op_assign
id|lcs_dma_alloc
c_func
(paren
id|LCS_IOBUFFSIZE
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|Fail
suffix:semicolon
)brace
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_RX_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
macro_line|#if LCS_ZERO_COPY_READ
r_if
c_cond
(paren
(paren
id|read-&gt;skb_buff
(braket
id|cnt
)braket
op_assign
id|lcs_dev_alloc_skb
c_func
(paren
id|LCS_READ_ALLOCSIZE
)paren
)paren
op_eq
l_int|NULL
)paren
macro_line|#else
r_if
c_cond
(paren
(paren
id|read-&gt;iobuff
(braket
id|cnt
)braket
op_assign
id|kmalloc
c_func
(paren
id|LCS_READ_ALLOCSIZE
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
)paren
op_eq
l_int|NULL
)paren
macro_line|#endif
r_goto
id|Fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lcs_initreadccws
c_func
(paren
id|read
)paren
)paren
r_goto
id|Fail
suffix:semicolon
id|read-&gt;drvr_globals
op_assign
id|drvr_globals
suffix:semicolon
id|write-&gt;drvr_globals
op_assign
id|drvr_globals
suffix:semicolon
id|lcs_resetstate
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|lcs_tq
op_assign
op_amp
id|drvr_globals-&gt;kernel_thread_task
suffix:semicolon
id|lcs_tq-&gt;routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|lcs_kernel_thread
suffix:semicolon
id|lcs_tq-&gt;data
op_assign
(paren
r_void
op_star
)paren
id|drvr_globals
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE&gt;KERNEL_VERSION(2,3,0)
id|lcs_tq-&gt;sync
op_assign
id|read-&gt;retry_task.sync
op_assign
id|write-&gt;retry_task.sync
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|lcs_tq-&gt;list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|read-&gt;retry_task.list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|write-&gt;retry_task.list
)paren
suffix:semicolon
macro_line|#endif
id|read-&gt;retry_task.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|lcs_queued_restartreadio
suffix:semicolon
id|write-&gt;retry_task.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|lcs_queued_restartwriteio
suffix:semicolon
id|write-&gt;retry_task.data
op_assign
id|read-&gt;retry_task.data
op_assign
(paren
r_void
op_star
)paren
id|drvr_globals
suffix:semicolon
id|write-&gt;resume_task.routine
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|lcs_resume_writetask
suffix:semicolon
id|write-&gt;resume_task.data
op_assign
(paren
r_void
op_star
)paren
id|write
suffix:semicolon
id|read-&gt;chan_busy_state
op_assign
id|write-&gt;chan_busy_state
op_assign
id|chan_dead
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_lock
comma
l_int|1
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lcs_card_list_lock
)paren
suffix:semicolon
id|add_to_list
c_func
(paren
(paren
id|list
op_star
op_star
)paren
op_amp
id|lcs_card_list
comma
(paren
id|list
op_star
)paren
id|drvr_globals
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lcs_card_list_lock
)paren
suffix:semicolon
id|drvr_globals-&gt;up
op_assign
id|FALSE
suffix:semicolon
r_return
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Fail
suffix:colon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_retry
id|lcs_retry
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_retry subchannel %04x scheduling retry&bslash;n&quot;
comma
id|chan_globals-&gt;subchannel
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE&gt;KERNEL_VERSION(2,2,16)
id|schedule_task
c_func
(paren
op_amp
id|chan_globals-&gt;retry_task
)paren
suffix:semicolon
macro_line|#else
id|queue_task
c_func
(paren
op_amp
id|chan_globals-&gt;retry_task
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
macro_line|#endif
)brace
r_static
r_int
DECL|function|lcs_doio_func
id|lcs_doio_func
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|rc
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_doio subchannel=%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;subchannel
)paren
suffix:semicolon
id|lcs_chan_lock
c_func
(paren
id|chan_globals
)paren
suffix:semicolon
id|rc
op_assign
id|do_IO
c_func
(paren
id|chan_globals-&gt;subchannel
comma
op_amp
id|chan_globals-&gt;ccw
(braket
l_int|0
)braket
comma
(paren
id|addr_t
)paren
id|chan_globals
comma
l_int|0
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
macro_line|#if LCS_DEBUG
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_doio do_IO returned %d for &quot;
"&bslash;"
l_string|&quot;subchannel %X&bslash;n&quot;
comma
id|rc
comma
id|chan_globals-&gt;subchannel
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
id|chan_globals-&gt;chan_busy_state
op_assign
id|chan_dead
suffix:semicolon
r_else
id|lcs_retry
c_func
(paren
id|chan_globals
)paren
suffix:semicolon
)brace
r_else
id|chan_globals-&gt;chan_busy_state
op_assign
id|chan_started_successfully
suffix:semicolon
id|lcs_chan_unlock
c_func
(paren
id|chan_globals
)paren
suffix:semicolon
r_return
(paren
id|rc
)paren
suffix:semicolon
)brace
DECL|macro|lcs_doio
mdefine_line|#define lcs_doio(chan_globals,flags)  &bslash;&n;&t;lcs_doio_func((lcs_chan_globals *)(chan_globals),(flags))
multiline_comment|/* &n; * halt subchannel wrapper used during driver startup &n; */
r_static
r_int
DECL|function|lcs_hsch_func
id|lcs_hsch_func
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_hsch subchannel=%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;subchannel
)paren
suffix:semicolon
id|lcs_chan_lock
c_func
(paren
id|chan_globals
)paren
suffix:semicolon
id|lcs_initqueue
c_func
(paren
id|chan_globals
)paren
suffix:semicolon
id|chan_globals-&gt;drvr_globals-&gt;state
op_assign
id|lcs_halting_subchannels
suffix:semicolon
id|rc
op_assign
id|halt_IO
c_func
(paren
id|chan_globals-&gt;subchannel
comma
(paren
id|addr_t
)paren
id|chan_globals
comma
l_int|0
)paren
suffix:semicolon
id|lcs_chan_unlock
c_func
(paren
id|chan_globals
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
id|lcs_sleepon_func
c_func
(paren
id|chan_globals
comma
l_int|0
)paren
suffix:semicolon
r_else
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_hsch subchannel=%x rc=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;subchannel
comma
id|rc
)paren
suffix:semicolon
r_return
(paren
id|rc
)paren
suffix:semicolon
)brace
DECL|macro|lcs_hsch
mdefine_line|#define lcs_hsch(chan_globals) &bslash;&n;&t;lcs_hsch_func((lcs_chan_globals *)(chan_globals))
r_static
r_void
DECL|function|wait_on_write
id|wait_on_write
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
id|lcs_write_globals
op_star
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
)paren
(brace
r_if
c_cond
(paren
id|drvr_globals-&gt;dev
)paren
id|netif_stop_queue
c_func
(paren
id|drvr_globals-&gt;dev
)paren
suffix:semicolon
id|lcs_chan_lock
c_func
(paren
id|write
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
op_logical_and
(paren
id|write-&gt;chan_busy_state
op_eq
id|chan_busy
op_logical_or
id|write-&gt;resume_queued
)paren
)paren
(brace
id|lcs_initqueue
c_func
(paren
id|write
)paren
suffix:semicolon
id|drvr_globals-&gt;state
op_assign
id|lcs_requesting_channels_for_lancmds
suffix:semicolon
id|lcs_chan_unlock
c_func
(paren
id|write
)paren
suffix:semicolon
id|lcs_sleepon
c_func
(paren
id|write
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|lcs_chan_unlock
c_func
(paren
id|write
)paren
suffix:semicolon
)brace
id|drvr_globals-&gt;state
op_assign
id|lcs_doing_lancmds
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_getcmdsize
id|lcs_getcmdsize
c_func
(paren
id|u8
id|cmd_code
)paren
(brace
r_int
id|cmdsize
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_code
)paren
(brace
r_case
id|lcs_startlan
suffix:colon
r_case
id|lcs_stoplan
suffix:colon
r_case
id|lcs_lanstat
suffix:colon
r_case
id|lcs_shutdown
suffix:colon
id|cmdsize
op_assign
r_sizeof
(paren
id|lcs_std_cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_startup
suffix:colon
id|cmdsize
op_assign
r_sizeof
(paren
id|lcs_startup_cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
r_case
id|lcs_setipm
suffix:colon
r_case
id|lcs_delipm
suffix:colon
id|cmdsize
op_assign
r_sizeof
(paren
id|lcs_ipm_ctlmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_qipassist
suffix:colon
id|cmdsize
op_assign
r_sizeof
(paren
id|lcs_qipassist_ctlmsg
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;illegal lan cmd %d in lcs_getcmdsize&bslash;n&quot;
comma
id|cmd_code
)paren
suffix:semicolon
id|cmdsize
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmdsize
op_ne
op_minus
id|EINVAL
)paren
id|cmdsize
op_sub_assign
r_sizeof
(paren
id|lcs_header_type
)paren
suffix:semicolon
r_return
(paren
id|cmdsize
)paren
suffix:semicolon
)brace
r_static
id|lcs_header_type
op_star
DECL|function|lcs_getfreetxbuff
id|lcs_getfreetxbuff
c_func
(paren
id|lcs_write_globals
op_star
id|write
comma
id|u8
id|type
comma
id|u8
id|slot
comma
r_int
id|len
)paren
(brace
id|ccw1_t
op_star
id|curr_ccw
suffix:semicolon
r_int
id|new_buff
op_assign
id|FALSE
suffix:semicolon
id|lcs_header_type
op_star
id|retbuff
suffix:semicolon
id|u32
id|virt_cda
suffix:semicolon
id|curr_ccw
op_assign
op_amp
id|write-&gt;ccw
(braket
id|write-&gt;prepare_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|curr_ccw-&gt;count
op_eq
l_int|0
)paren
id|new_buff
op_assign
id|TRUE
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|curr_ccw-&gt;count
op_plus
id|len
op_plus
r_sizeof
(paren
id|lcs_header_type
)paren
op_plus
r_sizeof
(paren
id|u16
)paren
)paren
OG
id|LCS_IOBUFFSIZE
)paren
(brace
r_if
c_cond
(paren
id|write-&gt;prepare_idx
op_eq
id|write-&gt;tx_idx
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|write-&gt;prepare_idx
op_assign
(paren
(paren
id|write-&gt;prepare_idx
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|curr_ccw-&gt;flags
op_and_assign
op_complement
id|CCW_FLAG_SUSPEND
suffix:semicolon
id|new_buff
op_assign
id|TRUE
suffix:semicolon
id|curr_ccw
op_assign
op_amp
id|write-&gt;ccw
(braket
id|write-&gt;prepare_idx
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_buff
)paren
(brace
r_if
c_cond
(paren
(paren
id|curr_ccw-&gt;flags
op_amp
id|CCW_FLAG_SUSPEND
)paren
op_eq
l_int|0
)paren
(brace
id|lcs_bad_news
(paren
l_string|&quot;Bug/Race condition detected in &quot;
l_string|&quot;lcs_getfreetxbuff &quot;
l_string|&quot;CCW_FLAG_SUSPEND not set for&bslash;n&quot;
l_string|&quot;for ccw at %p&quot;
comma
id|curr_ccw
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curr_ccw-&gt;count
op_ne
l_int|0
)paren
(brace
id|lcs_bad_news
(paren
l_string|&quot;Bug/Race condition detected in &quot;
l_string|&quot;lcs_getfreetxbuff &quot;
l_string|&quot;count!=0 in new buffer&bslash;n&quot;
l_string|&quot;for ccw at %p&quot;
comma
id|curr_ccw
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
id|len
op_add_assign
r_sizeof
(paren
id|lcs_header_type
)paren
suffix:semicolon
id|virt_cda
op_assign
(paren
id|u32
)paren
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|curr_ccw-&gt;cda
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_buff
)paren
(brace
id|retbuff
op_assign
(paren
id|lcs_header_type
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|virt_cda
)paren
suffix:semicolon
id|curr_ccw-&gt;count
op_assign
id|len
op_plus
r_sizeof
(paren
id|u16
)paren
suffix:semicolon
)brace
r_else
(brace
id|retbuff
op_assign
(paren
id|lcs_header_type
op_star
)paren
(paren
id|virt_cda
op_plus
id|curr_ccw-&gt;count
op_minus
r_sizeof
(paren
id|u16
)paren
)paren
suffix:semicolon
id|curr_ccw-&gt;count
op_add_assign
id|len
suffix:semicolon
id|len
op_assign
id|curr_ccw-&gt;count
op_minus
r_sizeof
(paren
id|u16
)paren
suffix:semicolon
)brace
id|retbuff-&gt;offset
op_assign
id|len
suffix:semicolon
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
(paren
id|addr_t
)paren
(paren
id|virt_cda
op_plus
id|len
)paren
)paren
)paren
op_assign
l_int|0
suffix:semicolon
id|retbuff-&gt;type
op_assign
id|type
suffix:semicolon
id|retbuff-&gt;slot
op_assign
id|slot
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_getfreetxbuff write=%p prepare_idx=%u &quot;
l_string|&quot;tx_idx=%u len=%d&bslash;n&quot;
comma
id|write
comma
id|write-&gt;prepare_idx
comma
id|write-&gt;tx_idx
comma
id|len
)paren
suffix:semicolon
r_return
(paren
id|retbuff
)paren
suffix:semicolon
)brace
r_static
id|lcs_std_cmd
op_star
DECL|function|lcs_prepare_lancmd
id|lcs_prepare_lancmd
c_func
(paren
id|lcs_write_globals
op_star
id|write
comma
id|u8
id|cmd_code
comma
id|u8
id|rel_adapter_no
comma
id|u8
id|initiator
comma
id|u8
id|lan_type
)paren
(brace
id|lcs_std_cmd
op_star
id|writecmd
suffix:semicolon
r_int
id|cmdsize
op_assign
id|lcs_getcmdsize
c_func
(paren
id|cmd_code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmdsize
OL
l_int|0
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Force a fresh ccw buff */
id|writecmd
op_assign
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_getfreetxbuff
c_func
(paren
id|write
comma
id|lcs_control_frame_type
comma
l_int|0
comma
id|cmdsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|writecmd
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
(paren
(paren
(paren
id|addr_t
)paren
id|writecmd
)paren
op_plus
r_sizeof
(paren
id|lcs_header_type
)paren
)paren
comma
l_int|0
comma
id|cmdsize
)paren
suffix:semicolon
id|writecmd-&gt;cmd_code
op_assign
id|cmd_code
suffix:semicolon
id|writecmd-&gt;initiator
op_assign
id|initiator
suffix:semicolon
r_switch
c_cond
(paren
id|cmd_code
)paren
(brace
r_case
id|lcs_startlan
suffix:colon
r_case
id|lcs_stoplan
suffix:colon
r_case
id|lcs_lanstat
suffix:colon
macro_line|#ifdef CONFIG_IP_MULTICAST
r_case
id|lcs_setipm
suffix:colon
r_case
id|lcs_delipm
suffix:colon
r_case
id|lcs_qipassist
suffix:colon
macro_line|#endif
id|writecmd-&gt;lan_type
op_assign
id|lan_type
suffix:semicolon
id|writecmd-&gt;rel_adapter_no
op_assign
id|rel_adapter_no
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_startup
suffix:colon
(paren
(paren
id|lcs_startup_cmd
op_star
)paren
id|writecmd
)paren
op_member_access_from_pointer
id|buff_size
op_assign
id|LCS_IOBUFFSIZE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_shutdown
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
(paren
id|writecmd
)paren
suffix:semicolon
)brace
macro_line|#if LCS_DEBUG_RESUME
DECL|variable|lcs_read_resume_cnt
DECL|variable|lcs_write_resume_cnt
r_int
id|lcs_read_resume_cnt
comma
id|lcs_write_resume_cnt
suffix:semicolon
macro_line|#endif
r_static
r_void
DECL|function|lcs_interrupt_resume_read
id|lcs_interrupt_resume_read
c_func
(paren
id|lcs_read_globals
op_star
id|read
)paren
(brace
r_int
id|rc
suffix:semicolon
id|ccw1_t
op_star
id|curr_ccw
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_interrupt_resume_read entered&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|read-&gt;ccw
(braket
(paren
id|read-&gt;rx_idx
op_minus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_RX_BUFFS
op_minus
l_int|1
)paren
)braket
dot
id|flags
op_amp
id|CCW_FLAG_SUSPEND
)paren
op_eq
l_int|0
)paren
id|lcs_bad_news
(paren
l_string|&quot;lcs_interrupt_resume_read detected possible lack of &quot;
l_string|&quot;suspend bug&bslash;n&quot;
)paren
suffix:semicolon
id|curr_ccw
op_assign
op_amp
id|read-&gt;ccw
(braket
id|read-&gt;rx_idx
)braket
suffix:semicolon
id|curr_ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_PCI
macro_line|#if LCS_USE_IDALS
op_or
(paren
id|curr_ccw-&gt;flags
op_amp
id|CCW_FLAG_IDA
)paren
macro_line|#endif
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|resume_IO
c_func
(paren
id|read-&gt;subchannel
)paren
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#if LCS_DEBUG_RESUME
id|lcs_read_resume_cnt
op_increment
suffix:semicolon
macro_line|#endif
id|read-&gt;chan_busy_state
op_assign
id|chan_busy
suffix:semicolon
)brace
r_else
id|lcs_bad_news
(paren
l_string|&quot;lcs_interrupt_resume_read returned %d for &quot;
l_string|&quot;subchannel %X&bslash;n&quot;
comma
id|rc
comma
id|read-&gt;subchannel
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_resume_read
id|lcs_resume_read
c_func
(paren
id|lcs_read_globals
op_star
id|read
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_resume_read entered&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_chan_lock
c_func
(paren
id|read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read-&gt;chan_busy_state
op_eq
id|chan_idle
)paren
id|lcs_interrupt_resume_read
c_func
(paren
id|read
)paren
suffix:semicolon
id|read-&gt;lancmd_reply_ptr
op_assign
l_int|NULL
suffix:semicolon
id|lcs_chan_unlock
c_func
(paren
id|read
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_resume_write
id|lcs_resume_write
c_func
(paren
id|lcs_write_globals
op_star
id|write
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_resume_write entered write=%p&bslash;n&quot;
comma
id|write
)paren
suffix:semicolon
id|lcs_chan_lock
c_func
(paren
id|write
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write-&gt;chan_busy_state
op_eq
id|chan_idle
op_logical_and
id|lcs_getbuffs_filled
c_func
(paren
id|write
)paren
)paren
(brace
id|write-&gt;ccw
(braket
id|write-&gt;prepare_idx
)braket
dot
id|flags
op_and_assign
op_complement
id|CCW_FLAG_SUSPEND
suffix:semicolon
id|write-&gt;prepare_idx
op_assign
(paren
(paren
id|write-&gt;prepare_idx
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|resume_IO
c_func
(paren
id|write-&gt;subchannel
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_resume_write resume_IO &quot;
l_string|&quot;successful prepare_idx=%u &quot;
l_string|&quot;tx_idx=%u&bslash;n&quot;
comma
id|write-&gt;prepare_idx
comma
id|write-&gt;tx_idx
)paren
suffix:semicolon
macro_line|#if LCS_DEBUG_RESUME
id|lcs_write_resume_cnt
op_increment
suffix:semicolon
macro_line|#endif
id|write-&gt;chan_busy_state
op_assign
id|chan_busy
suffix:semicolon
multiline_comment|/* the &lt;&lt; TOD_SHIFT_TO_USECS is to adjust &n;&t;&t;&t;   the inequality to microseconds &n;&t;&t;&t;   for the tod in lcs_tx_is_busy&n;&t;&t;&t;   The extra is adjustment is&n;&t;&t;&t;   so that the tx_is_busy will weigh &n;&t;&t;&t;   in favour of large transmission buffers.&n;&t;&t;&t; */
id|write-&gt;adjusted_last_bytes_still_being_txed
op_assign
(paren
r_uint64
)paren
(paren
(paren
id|write-&gt;bytes_still_being_txed
op_plus
l_int|500
)paren
op_lshift
id|TOD_SHIFT_TO_USECS
)paren
suffix:semicolon
id|write-&gt;last_resume_time
op_assign
id|lcs_get_tod
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
id|lcs_bad_news
(paren
l_string|&quot;lcs_resume_write returned %d for &quot;
l_string|&quot;subchannel %X&bslash;n&quot;
comma
id|rc
comma
id|write-&gt;subchannel
)paren
suffix:semicolon
)brace
id|lcs_chan_unlock
c_func
(paren
id|write
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n;  Unfortunately we don&squot;t know if the lcs interface is busy&n;  simply by knowing we have started a transmission &amp; not&n;  recieved a interrupt yet because the osa microcode simply&n;  copies the packet into its own internal buffers.&n;  I estimate whether the interface maybe busy by assuming&n;  an extremely optimistic 30MB/sec transmission rate ( might&n;  happen on a gigabit ethernet card ), i.e. if this routine&n;  returns true the interface is almost definitely busy.&n; */
r_static
r_int
DECL|function|lcs_tx_is_busy
id|lcs_tx_is_busy
c_func
(paren
id|lcs_write_globals
op_star
id|write
comma
r_uint64
id|tod
)paren
(brace
r_uint64
id|delta_tx
op_assign
id|tod
op_minus
id|write-&gt;last_resume_time
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* 30MB/sec = 30 bytes per usec */
r_if
c_cond
(paren
id|write-&gt;adjusted_last_bytes_still_being_txed
OL
(paren
l_int|30
op_star
id|delta_tx
)paren
)paren
id|rc
op_assign
id|FALSE
suffix:semicolon
r_else
id|rc
op_assign
id|TRUE
suffix:semicolon
macro_line|#if 0
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;%s being txed %08X tod %08X last resume=%08X &quot;
l_string|&quot;delta_tx %08X&bslash;n&quot;
comma
(paren
id|rc
ques
c_cond
l_string|&quot;lcs busy&quot;
suffix:colon
l_string|&quot;lcs not busy&quot;
)paren
comma
(paren
r_int
)paren
(paren
(paren
id|write
op_member_access_from_pointer
id|adjusted_last_bytes_still_being_txed
op_rshift
id|TOD_SHIFT_TO_USECS
)paren
)paren
comma
(paren
r_int
)paren
(paren
id|tod
op_rshift
id|TOD_SHIFT_TO_USECS
)paren
comma
(paren
r_int
)paren
(paren
id|write
op_member_access_from_pointer
id|last_resume_time
op_rshift
id|TOD_SHIFT_TO_USECS
)paren
comma
(paren
r_int
)paren
(paren
(paren
id|delta_tx
)paren
op_rshift
id|TOD_SHIFT_TO_USECS
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|rc
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_queue_write
id|lcs_queue_write
c_func
(paren
id|lcs_write_globals
op_star
id|write
)paren
(brace
multiline_comment|/* wait on write in shutdown func should avoid this &n;&t; * needing mod usage counts */
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_queue_write write=%p&bslash;n&quot;
comma
id|write
)paren
suffix:semicolon
id|write-&gt;resume_queued
op_assign
id|TRUE
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|write-&gt;resume_task
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_queue_write_if_necessary
id|lcs_queue_write_if_necessary
c_func
(paren
id|lcs_write_globals
op_star
id|write
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_queue_write_if_necessary write=%p&bslash;n&quot;
comma
id|write
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|write-&gt;resume_queued
)paren
(brace
id|write-&gt;resume_loopcnt
op_assign
l_int|0
suffix:semicolon
id|lcs_queue_write
c_func
(paren
id|write
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|lcs_should_queue_write
id|lcs_should_queue_write
c_func
(paren
id|lcs_write_globals
op_star
id|write
comma
r_uint64
id|tod
)paren
(brace
r_if
c_cond
(paren
id|lcs_getbuffs_filled
c_func
(paren
id|write
)paren
OL
(paren
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
)paren
op_logical_and
(paren
id|lcs_tx_is_busy
c_func
(paren
id|write
comma
id|tod
)paren
op_logical_or
(paren
(paren
id|tod
op_minus
id|write-&gt;last_lcs_txpacket_time
)paren
OL
(paren
l_int|25
op_lshift
id|TOD_SHIFT_TO_USECS
)paren
)paren
)paren
)paren
r_return
(paren
id|TRUE
)paren
suffix:semicolon
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_resume_writetask
id|lcs_resume_writetask
c_func
(paren
id|lcs_write_globals
op_star
id|write
)paren
(brace
r_uint64
id|tod
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_resume_writetask write=%p&bslash;n&quot;
comma
id|write
)paren
suffix:semicolon
id|lcs_chan_lock
c_func
(paren
id|write
)paren
suffix:semicolon
id|tod
op_assign
id|lcs_get_tod
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write-&gt;resume_loopcnt
OL
l_int|20
op_logical_and
id|lcs_should_queue_write
c_func
(paren
id|write
comma
id|tod
)paren
)paren
(brace
id|write-&gt;resume_loopcnt
op_increment
suffix:semicolon
id|lcs_queue_write
c_func
(paren
id|write
)paren
suffix:semicolon
id|lcs_chan_unlock
c_func
(paren
id|write
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
macro_line|#if 0
r_if
c_cond
(paren
id|write-&gt;resume_loopcnt
OG
l_int|10
)paren
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_resume_writetask bad &quot;
l_string|&quot;loopcnt %d&bslash;n&quot;
comma
id|write-&gt;resume_loopcnt
)paren
suffix:semicolon
macro_line|#endif
id|lcs_resume_write
c_func
(paren
id|write
)paren
suffix:semicolon
)brace
id|write-&gt;resume_queued
op_assign
id|FALSE
suffix:semicolon
id|lcs_chan_unlock
c_func
(paren
id|write
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_calcsleeptime
id|lcs_calcsleeptime
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
id|u8
id|cmd_code
)paren
(brace
r_if
c_cond
(paren
(paren
id|cmd_code
op_eq
id|lcs_startlan
op_logical_or
id|cmd_code
op_eq
id|lcs_stoplan
)paren
)paren
r_return
(paren
id|drvr_globals-&gt;slow_hw
ques
c_cond
l_int|60
suffix:colon
l_int|5
)paren
suffix:semicolon
r_else
r_return
(paren
id|drvr_globals-&gt;slow_hw
ques
c_cond
l_int|5
suffix:colon
l_int|5
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_resumeandwait
id|lcs_resumeandwait
c_func
(paren
id|lcs_write_globals
op_star
id|write
comma
id|u8
id|cmd_code
)paren
(brace
r_int
id|rc
suffix:semicolon
id|lcs_initqueue
c_func
(paren
id|write
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|lcs_resume_write
c_func
(paren
id|write
)paren
)paren
)paren
r_return
(paren
id|rc
)paren
suffix:semicolon
r_return
(paren
id|lcs_sleepon
(paren
id|write
comma
id|lcs_calcsleeptime
c_func
(paren
id|write-&gt;drvr_globals
comma
id|cmd_code
)paren
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_lgw_common
id|lcs_lgw_common
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
id|u8
id|cmd_code
)paren
(brace
id|lcs_write_globals
op_star
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
id|lcs_std_cmd
op_star
id|writecmd
suffix:semicolon
id|wait_on_write
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|writecmd
op_assign
id|lcs_prepare_lancmd
c_func
(paren
id|write
comma
id|cmd_code
comma
id|drvr_globals-&gt;rel_adapter_no
comma
id|lcs_lgw_initiated
comma
id|drvr_globals-&gt;lan_type
)paren
suffix:semicolon
id|writecmd-&gt;sequence_no
op_assign
id|drvr_globals-&gt;lgw_sequence_no
suffix:semicolon
r_return
(paren
id|lcs_resumeandwait
c_func
(paren
id|write
comma
id|cmd_code
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_start_doing_io
id|lcs_start_doing_io
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|drvr_globals-&gt;dev
)paren
suffix:semicolon
id|drvr_globals-&gt;state
op_assign
id|lcs_doing_io
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_lgw_stoplan
id|lcs_lgw_stoplan
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|lcs_daemonize
c_func
(paren
l_string|&quot;lcs_lgw_stoplan&quot;
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lcs_drvr_globals_valid
c_func
(paren
id|drvr_globals
)paren
)paren
r_goto
id|Done2
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_ne
id|lcs_doing_io
)paren
r_goto
id|Done1
suffix:semicolon
id|dev
op_assign
id|drvr_globals-&gt;dev
suffix:semicolon
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs problems detected %s temporarily unavailable.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lcs_lgw_common
c_func
(paren
id|drvr_globals
comma
id|lcs_stoplan
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|drvr_globals-&gt;state
op_assign
id|lcs_doing_io
suffix:semicolon
id|Done1
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_lock
comma
l_int|1
)paren
suffix:semicolon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done2
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_lgw_startlan
id|lcs_lgw_startlan
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|lcs_daemonize
c_func
(paren
l_string|&quot;lcs_lgw_startlan&quot;
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lcs_drvr_globals_valid
c_func
(paren
id|drvr_globals
)paren
)paren
r_goto
id|Done2
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_ne
id|lcs_doing_io
)paren
r_goto
id|Done1
suffix:semicolon
id|dev
op_assign
id|drvr_globals-&gt;dev
suffix:semicolon
id|lcs_good_news
c_func
(paren
l_string|&quot;lcs device %s restarted.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|lcs_lgw_common
c_func
(paren
id|drvr_globals
comma
id|lcs_startlan
)paren
suffix:semicolon
id|lcs_start_doing_io
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done1
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_lock
comma
l_int|1
)paren
suffix:semicolon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done2
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_lgw_resetlan
id|lcs_lgw_resetlan
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|retrycnt
suffix:semicolon
id|lcs_daemonize
c_func
(paren
l_string|&quot;lcs_lgw_resetlan&quot;
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lcs_drvr_globals_valid
c_func
(paren
id|drvr_globals
)paren
)paren
r_goto
id|Done2
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_ne
id|lcs_doing_io
)paren
r_goto
id|Done1
suffix:semicolon
id|dev
op_assign
id|drvr_globals-&gt;dev
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs reset %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|retrycnt
op_assign
l_int|0
suffix:semicolon
id|retrycnt
OL
l_int|10
suffix:semicolon
id|retrycnt
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lcs_detect
c_func
(paren
id|drvr_globals
comma
id|drvr_globals-&gt;rel_adapter_no
comma
l_int|0
comma
l_int|0
comma
id|drvr_globals-&gt;lan_type
comma
id|dev-&gt;dev_addr
)paren
op_eq
l_int|0
)paren
(brace
id|lcs_start_doing_io
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|lcs_good_news
c_func
(paren
l_string|&quot;lcs reset %s successfully.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_goto
id|Done1
suffix:semicolon
)brace
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs_resetlan retrycnt %d&bslash;n&quot;
comma
id|retrycnt
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
comma
l_int|0
)paren
suffix:semicolon
)brace
id|lcs_resetstate
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs problems occured restarting after reset %s.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|Done1
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_lock
comma
l_int|1
)paren
suffix:semicolon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done2
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_queue_thread
id|lcs_queue_thread
c_func
(paren
r_int
(paren
op_star
id|routine
)paren
(paren
id|lcs_drvr_globals
op_star
)paren
comma
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_lock
)paren
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|drvr_globals-&gt;dev
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|drvr_globals-&gt;kernel_thread_routine
op_assign
id|routine
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE&lt;=KERNEL_VERSION(2,2,16)
id|queue_task
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_task
comma
op_amp
id|tq_scheduler
)paren
suffix:semicolon
macro_line|#else
id|schedule_task
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_task
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_queue_thread busy drvr_globals=%p &quot;
l_string|&quot;routine=%p&quot;
comma
id|drvr_globals
comma
id|routine
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_check_reset
id|lcs_check_reset
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
id|chan_globals-&gt;drvr_globals
suffix:semicolon
id|devstat_t
op_star
id|devstat
op_assign
op_amp
id|chan_globals-&gt;devstat
suffix:semicolon
r_if
c_cond
(paren
id|devstat-&gt;flag
op_amp
id|DEVSTAT_FLAG_SENSE_AVAIL
)paren
(brace
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
op_logical_and
(paren
id|devstat-&gt;scnt
op_ge
l_int|1
)paren
op_logical_and
(paren
(paren
id|lcs_sense_byte_1
)paren
(paren
id|devstat-&gt;ii.sense.data
(braket
l_int|1
)braket
)paren
)paren
op_eq
id|resetting_event
)paren
(brace
id|lcs_debug_exception
c_func
(paren
l_int|0
comma
l_string|&quot;lcs reseting event occuring &quot;
l_string|&quot;devno=%04x&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;devno
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
comma
l_int|0
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|drvr_globals-&gt;state
)paren
(brace
r_case
id|lcs_idle_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_got_write_channel_for_lancmds
suffix:colon
r_case
id|lcs_doing_lancmds
suffix:colon
id|lcs_wakeup
c_func
(paren
id|drvr_globals-&gt;read
comma
op_minus
id|ERETRY
)paren
suffix:semicolon
id|lcs_wakeup
c_func
(paren
id|drvr_globals-&gt;write
comma
op_minus
id|ERETRY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_doing_io
suffix:colon
id|lcs_queue_thread
c_func
(paren
id|lcs_lgw_resetlan
comma
id|drvr_globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|devstat-&gt;scnt
op_ge
l_int|1
)paren
op_logical_and
(paren
(paren
id|lcs_sense_byte_0
)paren
(paren
id|devstat-&gt;ii.sense
dot
id|data
(braket
l_int|0
)braket
)paren
op_eq
(paren
id|intervention_required
op_or
id|interface_disconnect
)paren
)paren
)paren
id|lcs_debug_exception
c_func
(paren
l_int|0
comma
l_string|&quot;lcs intervention_required &quot;
l_string|&quot;&amp; interface_disconnect &quot;
l_string|&quot;detected devno=0x%04x&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;devno
)paren
suffix:semicolon
r_else
(brace
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs unknown sense data &quot;
l_string|&quot;devno=0x%04x&bslash;n&quot;
l_string|&quot;sense_cnt=%d sense_data=&bslash;n&quot;
l_string|&quot;%08x %08x %08x %08x&bslash;n&quot;
l_string|&quot;%08x %08x %08x %08x&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan_globals-&gt;devno
comma
(paren
r_int
)paren
id|devstat-&gt;scnt
comma
(paren
(paren
r_int
op_star
)paren
op_amp
id|devstat
op_member_access_from_pointer
id|ii.sense.data
)paren
(braket
l_int|0
)braket
comma
(paren
(paren
r_int
op_star
)paren
op_amp
id|devstat
op_member_access_from_pointer
id|ii.sense.data
)paren
(braket
l_int|1
)braket
comma
(paren
(paren
r_int
op_star
)paren
op_amp
id|devstat
op_member_access_from_pointer
id|ii.sense.data
)paren
(braket
l_int|2
)braket
comma
(paren
(paren
r_int
op_star
)paren
op_amp
id|devstat
op_member_access_from_pointer
id|ii.sense.data
)paren
(braket
l_int|3
)braket
comma
(paren
(paren
r_int
op_star
)paren
op_amp
id|devstat
op_member_access_from_pointer
id|ii.sense.data
)paren
(braket
l_int|4
)braket
comma
(paren
(paren
r_int
op_star
)paren
op_amp
id|devstat
op_member_access_from_pointer
id|ii.sense.data
)paren
(braket
l_int|5
)braket
comma
(paren
(paren
r_int
op_star
)paren
op_amp
id|devstat
op_member_access_from_pointer
id|ii.sense.data
)paren
(braket
l_int|6
)braket
comma
(paren
(paren
r_int
op_star
)paren
op_amp
id|devstat
op_member_access_from_pointer
id|ii.sense.data
)paren
(braket
l_int|7
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devstat-&gt;scnt
OG
l_int|2
op_logical_or
(paren
id|devstat-&gt;ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0
op_logical_and
id|devstat-&gt;ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0
)paren
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs sense data &quot;
l_string|&quot;looks like rubbish &quot;
l_string|&quot;ignoring it&bslash;n&quot;
)paren
suffix:semicolon
id|devstat-&gt;flag
op_and_assign
op_complement
id|DEVSTAT_FLAG_SENSE_AVAIL
suffix:semicolon
)brace
)brace
)brace
)brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
macro_line|#if LCS_ZERO_COPY_READ
r_static
r_inline
r_void
DECL|function|lcs_rxskb
id|lcs_rxskb
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u16
id|pkt_len
comma
id|u16
id|offset
comma
r_struct
id|net_device_stats
op_star
id|stats
)paren
(brace
id|stats-&gt;rx_bytes
op_add_assign
id|pkt_len
suffix:semicolon
r_if
c_cond
(paren
id|use_hw_stats
op_eq
id|FALSE
)paren
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;netif_rx called&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;received %u bytes rx_bytes=%lu&bslash;n&quot;
comma
(paren
r_int
)paren
id|pkt_len
comma
id|stats-&gt;rx_bytes
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|lcs_header_type
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|pkt_len
)paren
suffix:semicolon
multiline_comment|/* Horrible horrible kludge to fix bug in some socket code */
multiline_comment|/* usage of skb-&gt;truesize hopefully this bug will be fixed in */
multiline_comment|/* upper layers soon */
id|skb-&gt;truesize
op_assign
id|skb-&gt;len
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|drvr_globals
op_member_access_from_pointer
id|lan_type_trans
c_func
(paren
id|skb
comma
id|skb-&gt;dev
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|lcs_rxpacket
id|lcs_rxpacket
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
id|u8
op_star
id|start_lcs_buff
comma
id|lcs_std_cmd
op_star
op_star
id|lancmd_reply
macro_line|#if LCS_ZERO_COPY_READ
comma
id|u32
id|curr_idx
macro_line|#endif
)paren
(brace
id|lcs_read_globals
op_star
id|read
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
id|curr_skb
macro_line|#if LCS_ZERO_COPY_READ
comma
op_star
id|prev_skb
macro_line|#endif
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
l_int|NULL
suffix:semicolon
id|lcs_header_type
op_star
id|lcs_header_ptr
op_assign
(paren
id|lcs_header_type
op_star
)paren
id|start_lcs_buff
suffix:semicolon
id|u16
id|curr_offset
comma
id|curr_pkt_len
macro_line|#if  LCS_ZERO_COPY_READ
comma
id|prev_pkt_len
comma
id|curr_skb_offset
comma
id|prev_skb_offset
macro_line|#endif
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;Entering lcs_rxpacket&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals
op_eq
l_int|NULL
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;drvr_globals=NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|dev
op_assign
id|drvr_globals-&gt;dev
suffix:semicolon
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
macro_line|#if LCS_ZERO_COPY_READ
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
id|skb_datarefp
c_func
(paren
id|read-&gt;skb_buff
(braket
id|curr_idx
)braket
)paren
)paren
op_ne
l_int|1
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_rxpacket skb-&gt;refcnt=%d start_lcs_buff=%p&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
id|skb_datarefp
(paren
id|read-&gt;skb_buff
(braket
id|curr_idx
)braket
)paren
)paren
comma
id|start_lcs_buff
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#endif
id|stats
op_assign
op_amp
id|drvr_globals-&gt;stats
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;We appear to have received a packet buff=%p&bslash;n&quot;
comma
id|lcs_header_ptr
)paren
suffix:semicolon
macro_line|#if LCS_ZERO_COPY_READ
id|curr_skb
op_assign
l_int|NULL
suffix:semicolon
id|curr_pkt_len
op_assign
id|curr_skb_offset
op_assign
macro_line|#endif
id|curr_offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|lcs_header_ptr-&gt;offset
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|3
comma
l_string|&quot;lcs_header_ptr=%p curroffset=%d&bslash;n&quot;
comma
id|lcs_header_ptr
comma
id|curr_offset
)paren
suffix:semicolon
macro_line|#if LCS_ZERO_COPY_READ
id|prev_pkt_len
op_assign
id|curr_pkt_len
suffix:semicolon
id|prev_skb
op_assign
id|curr_skb
suffix:semicolon
id|prev_skb_offset
op_assign
id|curr_skb_offset
suffix:semicolon
macro_line|#endif
macro_line|#if 0
r_static
r_int
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|idx
op_amp
l_int|0x1ff
)paren
op_eq
l_int|0
)paren
(brace
id|lcs_header_ptr-&gt;type
op_assign
id|lcs_control_frame_type
suffix:semicolon
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|initiator
op_assign
id|lcs_lgw_initiated
suffix:semicolon
(paren
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|cmd_code
)paren
op_assign
id|lcs_startup
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|lcs_header_ptr-&gt;offset
OG
id|LCS_IOBUFFSIZE
op_logical_or
id|lcs_header_ptr-&gt;offset
OL
id|curr_offset
)paren
(brace
r_if
c_cond
(paren
id|use_hw_stats
op_eq
id|FALSE
)paren
(brace
id|stats-&gt;rx_length_errors
op_increment
suffix:semicolon
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
)brace
id|lcs_bad_news
(paren
l_string|&quot;lcs whacko rx_buffer read_globals=%p &quot;
l_string|&quot;curr_offset=%d new_offset=%d&bslash;n&quot;
comma
id|read
comma
(paren
r_int
)paren
id|curr_offset
comma
(paren
r_int
)paren
id|lcs_header_ptr-&gt;offset
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lcs_header_ptr-&gt;type
op_eq
id|lcs_control_frame_type
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|initiator
op_eq
id|lcs_lgw_initiated
op_logical_and
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
)paren
(brace
id|drvr_globals-&gt;lgw_sequence_no
op_assign
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|sequence_no
suffix:semicolon
id|lcs_debug_display_read_buff
(paren
l_string|&quot;lgw_initiated_command read buff&quot;
comma
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
r_int
)paren
(paren
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|cmd_code
)paren
)paren
(brace
r_case
id|lcs_startup
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|lcs_queue_thread
c_func
(paren
id|lcs_lgw_resetlan
comma
id|drvr_globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_startlan
suffix:colon
id|lcs_queue_thread
c_func
(paren
id|lcs_lgw_startlan
comma
id|drvr_globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_stoplan
suffix:colon
id|lcs_queue_thread
c_func
(paren
id|lcs_lgw_stoplan
comma
id|drvr_globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|lcs_debug_exception
c_func
(paren
l_int|1
comma
l_string|&quot;lcs &quot;
l_string|&quot;unrecognised lgw command &quot;
l_string|&quot;received 0x%02x on &quot;
l_string|&quot;devno=%04x&bslash;n&quot;
comma
(paren
r_int
)paren
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|cmd_code
comma
(paren
r_int
)paren
id|read-&gt;devno
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_lancmds
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|sequence_no
op_eq
id|drvr_globals-&gt;sequence_no
)paren
)paren
op_logical_and
(paren
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|cmd_code
op_eq
id|drvr_globals-&gt;cmd_code
)paren
)paren
(brace
op_star
id|lancmd_reply
op_assign
id|read-&gt;lancmd_reply_ptr
op_assign
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;got a valid &quot;
l_string|&quot;lancommand %p &quot;
l_string|&quot;cmd_code=%02x &quot;
l_string|&quot;sequence_no=%d&bslash;n&quot;
comma
id|read-&gt;lancmd_reply_ptr
comma
(paren
r_int
)paren
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|cmd_code
comma
(paren
r_int
)paren
(paren
(paren
id|lcs_std_cmd
op_star
)paren
id|lcs_header_ptr
)paren
op_member_access_from_pointer
id|sequence_no
)paren
suffix:semicolon
id|lcs_wakeup
c_func
(paren
(paren
id|lcs_chan_globals
op_star
)paren
id|read
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|dev
op_logical_and
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
)paren
(brace
multiline_comment|/* the packet is for tcpip */
multiline_comment|/* dev_alloc_skb allocs with GFP_ATOMIC currently */
multiline_comment|/* so this should be okay under interrupt */
multiline_comment|/* hopefully .... */
macro_line|#if LCS_ZERO_COPY_READ
r_if
c_cond
(paren
id|curr_skb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* We need to detach the buffer */
r_struct
id|sk_buff
op_star
id|new_skb
suffix:semicolon
id|ccw1_t
id|temp_ccw
op_assign
id|read-&gt;ccw
(braket
id|curr_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|set_normalized_cda
(paren
op_amp
id|temp_ccw
comma
id|new_skb-&gt;data
)paren
)paren
(brace
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
id|lcs_bad_news
(paren
l_string|&quot;%s: Memory squeeze, &quot;
l_string|&quot;dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|new_skb
op_assign
id|lcs_dev_alloc_skb
c_func
(paren
id|LCS_READ_ALLOCSIZE
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|clear_normalized_cda
c_func
(paren
op_amp
id|temp_ccw
)paren
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
id|lcs_bad_news
(paren
l_string|&quot;%s: Memory squeeze, &quot;
l_string|&quot;dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|curr_skb
op_assign
id|read-&gt;skb_buff
(braket
id|curr_idx
)braket
suffix:semicolon
id|curr_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|curr_skb-&gt;ip_summed
op_assign
(paren
id|checksum_received_ip_pkts
ques
c_cond
id|CHECKSUM_NONE
suffix:colon
id|CHECKSUM_UNNECESSARY
)paren
suffix:semicolon
id|clear_normalized_cda
c_func
(paren
op_amp
id|read-&gt;ccw
(braket
id|curr_idx
)braket
)paren
suffix:semicolon
id|read-&gt;skb_buff
(braket
id|curr_idx
)braket
op_assign
id|new_skb
suffix:semicolon
id|read-&gt;ccw
(braket
id|curr_idx
)braket
op_assign
id|temp_ccw
suffix:semicolon
)brace
r_else
(brace
id|curr_skb
op_assign
id|skb_clone
c_func
(paren
id|prev_skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curr_skb
op_eq
l_int|NULL
)paren
(brace
id|curr_skb
op_assign
id|prev_skb
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
id|lcs_bad_news
c_func
(paren
l_string|&quot;%s: Memory squeeze, &quot;
l_string|&quot;dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|curr_skb_offset
op_assign
id|curr_offset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prev_skb
)paren
id|lcs_rxskb
c_func
(paren
id|drvr_globals
comma
id|prev_skb
comma
id|prev_pkt_len
comma
id|prev_skb_offset
comma
id|stats
)paren
suffix:semicolon
id|curr_pkt_len
op_assign
id|lcs_header_ptr-&gt;offset
op_minus
id|curr_skb_offset
op_minus
r_sizeof
(paren
id|lcs_header_type
)paren
suffix:semicolon
macro_line|#else
id|curr_pkt_len
op_assign
id|lcs_header_ptr-&gt;offset
op_minus
id|curr_offset
op_minus
r_sizeof
(paren
id|lcs_header_type
)paren
suffix:semicolon
id|curr_skb
op_assign
id|lcs_dev_alloc_skb
c_func
(paren
id|curr_pkt_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curr_skb
)paren
(brace
id|curr_skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|curr_skb
comma
id|curr_pkt_len
)paren
comma
id|lcs_header_ptr
op_plus
l_int|1
comma
id|curr_pkt_len
)paren
suffix:semicolon
id|curr_skb-&gt;protocol
op_assign
id|drvr_globals
op_member_access_from_pointer
id|lan_type_trans
c_func
(paren
id|curr_skb
comma
id|dev
)paren
suffix:semicolon
id|curr_skb-&gt;ip_summed
op_assign
(paren
id|checksum_received_ip_pkts
ques
c_cond
id|CHECKSUM_NONE
suffix:colon
id|CHECKSUM_UNNECESSARY
)paren
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|curr_pkt_len
suffix:semicolon
r_if
c_cond
(paren
id|use_hw_stats
op_eq
id|FALSE
)paren
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;netif_rx called&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;received %u bytes &quot;
"&bslash;"
l_string|&quot;rx_bytes=%lu&bslash;n&quot;
comma
(paren
r_int
)paren
id|curr_pkt_len
comma
id|stats-&gt;rx_bytes
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|curr_skb
)paren
suffix:semicolon
id|curr_skb-&gt;dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
(brace
id|lcs_bad_news
(paren
l_string|&quot;%s: Memory squeeze, dropping packet.&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
macro_line|#endif
)brace
id|curr_offset
op_assign
id|lcs_header_ptr-&gt;offset
suffix:semicolon
(paren
(paren
id|addr_t
)paren
id|lcs_header_ptr
)paren
op_assign
id|start_lcs_buff
op_plus
id|curr_offset
suffix:semicolon
)brace
macro_line|#if LCS_ZERO_COPY_READ
r_if
c_cond
(paren
id|curr_skb
)paren
id|lcs_rxskb
c_func
(paren
id|drvr_globals
comma
id|curr_skb
comma
id|curr_pkt_len
comma
id|curr_skb_offset
comma
id|stats
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the main interrupt handler it does a lot of sanity checking &amp;&n; * wakes up a process if doing startup or shutdown or calls &n; * queues lcs_rxpacket if a network packet is received or&n; * resets transmit busy a network packet has been transmitted &amp;&n; * marks the bottom half so that networking knows it can transmit more packets &n; * N.B. if we decide to call ssch directly or indirectly from the irq_handler &n; * we had better increment chan_globals-&gt;lock_cnt &amp; decrement it when done to avoid&n; * deadlocks ( this count can be over 2 inside the interrupt handler ),&n; * but not in normal tasks.&n; */
r_static
r_void
DECL|function|lcs_handle_irq
id|lcs_handle_irq
c_func
(paren
r_int
id|irq
comma
id|devstat_t
op_star
id|devstat
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_union
(brace
id|lcs_read_globals
op_star
id|read
suffix:semicolon
id|lcs_write_globals
op_star
id|write
suffix:semicolon
id|lcs_chan_globals
op_star
id|globals
suffix:semicolon
)brace
id|chan
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
l_int|NULL
suffix:semicolon
id|lcs_debug_initmessage
r_struct
id|net_device_stats
op_star
id|stats
suffix:semicolon
id|ccw1_t
op_star
id|curr_ccw
suffix:semicolon
id|lcs_header_type
op_star
id|lcs_hdr
suffix:semicolon
id|u32
id|curr_ccwidx
comma
id|curr_ccwidx2
comma
id|curr_idx
suffix:semicolon
r_int
id|chan_globals_valid
op_assign
id|FALSE
suffix:semicolon
id|chan.globals
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|devstat
)paren
r_goto
id|lcs_int_spurious
suffix:semicolon
id|chan.globals
op_assign
(paren
id|lcs_chan_globals
op_star
)paren
id|devstat-&gt;intparm
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chan.globals
op_logical_or
(paren
id|irq
op_ne
id|chan.globals-&gt;subchannel
)paren
)paren
r_goto
id|lcs_int_spurious
suffix:semicolon
id|chan_globals_valid
op_assign
id|TRUE
suffix:semicolon
id|drvr_globals
op_assign
id|chan.globals-&gt;drvr_globals
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_handle_irq irq=%x chan_globals=%p drvr_globals=%p&quot;
l_string|&quot; drvr_state=%d devstat=%p irb=%p cpu=%d &quot;
l_string|&quot;chan_busy_state=%d&bslash;n&quot;
comma
id|irq
comma
id|chan.globals
comma
id|drvr_globals
comma
id|drvr_globals-&gt;state
comma
op_amp
id|chan.globals-&gt;devstat
comma
op_amp
id|chan.globals-&gt;devstat.ii.irb
comma
id|smp_processor_id
c_func
(paren
)paren
comma
id|chan.globals-&gt;chan_busy_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan.globals-&gt;lock_cnt
)paren
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_handle_irq lock owner %d lock_cnt=%d&bslash;n&quot;
comma
id|chan.globals-&gt;lock_owner
comma
id|chan.globals-&gt;lock_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_interrupted
)paren
(brace
id|lcs_wakeup
c_func
(paren
id|chan.globals
comma
op_minus
id|EINTR
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|lcs_check_reset
c_func
(paren
id|chan.globals
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|chan.globals-&gt;irq_allocated_magic
op_ne
id|LCS_MAGIC
)paren
r_goto
id|lcs_int_spurious
suffix:semicolon
)brace
id|dev
op_assign
id|drvr_globals-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_and
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
)paren
(brace
id|lcs_debug_setmessage
c_func
(paren
l_string|&quot;dev=NULL in handle irq&quot;
)paren
suffix:semicolon
r_goto
id|lcs_int_debug_info
suffix:semicolon
)brace
id|stats
op_assign
op_amp
id|drvr_globals-&gt;stats
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_halting_subchannels
)paren
(brace
id|lcs_wakeup
c_func
(paren
id|chan.globals
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|chan.globals-&gt;lock_owner
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|chan.globals-&gt;lock_cnt
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;read
op_eq
id|chan.read
)paren
(brace
r_if
c_cond
(paren
id|devstat-&gt;dstat
op_ne
l_int|0
op_logical_or
(paren
id|devstat-&gt;cstat
op_amp
op_complement
id|SCHN_STAT_PCI
)paren
op_ne
l_int|0
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs_handle_irq dstat=%02x cstat=%02x &quot;
l_string|&quot;drvr_globals_state=%d&bslash;n&quot;
comma
id|devstat-&gt;dstat
comma
id|devstat-&gt;cstat
comma
id|drvr_globals-&gt;state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|drvr_globals-&gt;state
)paren
(brace
r_case
id|lcs_idle_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_got_write_channel_for_lancmds
suffix:colon
r_case
id|lcs_doing_lancmds
suffix:colon
id|lcs_restartreadio
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_doing_io
suffix:colon
id|lcs_retry
c_func
(paren
id|chan.globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_goto
id|lcs_normal_ret
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|chan.read-&gt;chan_busy_state
)paren
(brace
r_case
id|chan_busy
suffix:colon
(brace
r_int
id|rxerr
op_assign
l_int|0
suffix:semicolon
id|lcs_std_cmd
op_star
id|lancmd_reply_ptr
suffix:semicolon
r_switch
c_cond
(paren
id|drvr_globals-&gt;state
)paren
(brace
r_case
id|lcs_doing_io
suffix:colon
r_case
id|lcs_doing_lancmds
suffix:colon
id|curr_idx
op_assign
(paren
(paren
id|ccw1_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|devstat-&gt;cpa
)paren
op_minus
op_amp
id|chan.read-&gt;ccw
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t need to divide by&n;&t;&t;&t;&t; * sizeof(ccw1_t) here as we are&n;&t;&t;&t;&t; * doing pointer arithmetic */
id|curr_ccwidx
op_assign
(paren
(paren
id|curr_idx
op_minus
l_int|2
)paren
op_amp
(paren
id|LCS_NUM_RX_BUFFS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|curr_ccwidx2
op_assign
(paren
(paren
id|curr_idx
op_minus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_RX_BUFFS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|curr_idx
op_assign
id|chan.read-&gt;rx_idx
suffix:semicolon
id|curr_idx
op_ne
id|curr_ccwidx2
suffix:semicolon
id|curr_idx
op_assign
(paren
(paren
id|curr_idx
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_RX_BUFFS
op_minus
l_int|1
)paren
)paren
)paren
(brace
macro_line|#if LCS_ZERO_COPY_READ
id|lcs_hdr
op_assign
(paren
id|lcs_header_type
op_star
)paren
(paren
id|chan.read
op_member_access_from_pointer
id|skb_buff
(braket
id|curr_idx
)braket
op_member_access_from_pointer
id|data
)paren
suffix:semicolon
macro_line|#else
id|lcs_hdr
op_assign
(paren
id|lcs_header_type
op_star
)paren
(paren
id|chan.read
op_member_access_from_pointer
id|iobuff
(braket
id|curr_idx
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lcs_hdr-&gt;offset
op_ne
id|LCS_ILLEGAL_OFFSET
)paren
(brace
multiline_comment|/* Detect duplicate interrupts &n;&t;&t;&t;&t;&t;&t;   unfilled buffers etc. */
id|lancmd_reply_ptr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rxerr
op_ne
op_minus
id|ENOMEM
)paren
id|rxerr
op_assign
id|lcs_rxpacket
(paren
id|drvr_globals
comma
(paren
id|u8
op_star
)paren
id|lcs_hdr
comma
op_amp
id|lancmd_reply_ptr
macro_line|#if LCS_ZERO_COPY_READ
comma
id|curr_idx
macro_line|#endif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lancmd_reply_ptr
op_eq
l_int|NULL
)paren
(brace
macro_line|#if LCS_ZERO_COPY_READ
id|lcs_hdr
op_assign
(paren
id|lcs_header_type
op_star
)paren
(paren
id|chan.read
op_member_access_from_pointer
id|skb_buff
(braket
id|curr_idx
)braket
op_member_access_from_pointer
id|data
)paren
suffix:semicolon
macro_line|#endif
id|lcs_hdr-&gt;offset
op_assign
id|LCS_ILLEGAL_OFFSET
suffix:semicolon
)brace
)brace
r_else
(brace
id|lcs_bad_news
(paren
l_string|&quot;lcs_handle_irq race &quot;
l_string|&quot;condition Illegal&quot;
l_string|&quot; offset buffer &quot;
l_string|&quot;for ccw=%p&bslash;n&quot;
comma
op_amp
id|chan.read
op_member_access_from_pointer
id|ccw
(braket
id|curr_idx
)braket
)paren
suffix:semicolon
r_goto
id|lcs_int_debug_info
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|chan.read-&gt;rx_idx
op_ne
id|curr_ccwidx2
)paren
(brace
id|curr_ccw
op_assign
op_amp
id|chan.read-&gt;ccw
(braket
id|curr_ccwidx
)braket
suffix:semicolon
id|curr_ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SUSPEND
macro_line|#if LCS_USE_IDALS
op_or
(paren
id|curr_ccw-&gt;flags
op_amp
id|CCW_FLAG_IDA
)paren
macro_line|#endif
suffix:semicolon
id|curr_idx
op_assign
(paren
id|chan.read-&gt;rx_idx
op_minus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_RX_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
id|curr_ccw
op_assign
op_amp
id|chan.read-&gt;ccw
(braket
id|curr_idx
)braket
suffix:semicolon
id|curr_ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_PCI
macro_line|#if LCS_USE_IDALS
op_or
(paren
id|curr_ccw-&gt;flags
op_amp
id|CCW_FLAG_IDA
)paren
macro_line|#endif
suffix:semicolon
id|chan.read-&gt;rx_idx
op_assign
id|curr_ccwidx2
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|chan_started_successfully
suffix:colon
id|chan.read-&gt;chan_busy_state
op_assign
id|chan_busy
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;   We need to suspend if till the lancmd reply is consumed.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|chan.read-&gt;chan_busy_state
op_eq
id|chan_busy
op_logical_or
id|chan.read-&gt;chan_busy_state
op_eq
id|chan_idle
)paren
op_logical_and
macro_line|#if 0
id|devstat-&gt;flag
op_amp
id|DEVSTAT_SUSPENDED
macro_line|#else
id|devstat-&gt;ii.irb.scsw.actl
op_amp
id|SCSW_ACTL_SUSPENDED
macro_line|#endif
)paren
(brace
id|chan.read-&gt;chan_busy_state
op_assign
id|chan_idle
suffix:semicolon
r_if
c_cond
(paren
id|chan.read-&gt;lancmd_reply_ptr
op_eq
l_int|NULL
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;resume called from &quot;
l_string|&quot;interrupt handler.&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_interrupt_resume_read
c_func
(paren
id|chan.read
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|devstat-&gt;dstat
op_ne
l_int|0
op_logical_or
id|devstat-&gt;flag
op_amp
id|DEVSTAT_FLAG_SENSE_AVAIL
op_logical_or
id|devstat-&gt;cstat
op_ne
l_int|0
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs_handle_irq write channel &quot;
l_string|&quot;dstat=%02x flag=%x cstat=%02x &quot;
l_string|&quot;drvr_globals_state=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|devstat-&gt;dstat
comma
(paren
r_int
)paren
id|devstat-&gt;flag
comma
(paren
r_int
)paren
id|devstat-&gt;cstat
comma
id|drvr_globals-&gt;state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|drvr_globals-&gt;state
)paren
(brace
r_case
id|lcs_idle_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_got_write_channel_for_lancmds
suffix:colon
r_case
id|lcs_doing_lancmds
suffix:colon
id|lcs_restartwriteio
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_doing_io
suffix:colon
id|lcs_queue_thread
c_func
(paren
id|lcs_lgw_resetlan
comma
id|drvr_globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_goto
id|lcs_normal_ret
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|chan.write-&gt;chan_busy_state
)paren
(brace
r_case
id|chan_started_successfully
suffix:colon
id|chan.write-&gt;chan_busy_state
op_assign
id|chan_idle
suffix:semicolon
r_break
suffix:semicolon
r_case
id|chan_busy
suffix:colon
id|chan.write-&gt;chan_busy_state
op_assign
id|chan_idle
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|devstat-&gt;flag
op_amp
id|DEVSTAT_SUSPENDED
)paren
macro_line|#else
r_if
c_cond
(paren
id|devstat-&gt;ii.irb.scsw.actl
op_amp
id|SCSW_ACTL_SUSPENDED
)paren
macro_line|#endif
(brace
r_switch
c_cond
(paren
id|drvr_globals-&gt;state
)paren
(brace
r_case
id|lcs_doing_io
suffix:colon
r_case
id|lcs_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_doing_lancmds
suffix:colon
id|curr_idx
op_assign
(paren
(paren
id|ccw1_t
op_star
)paren
id|phys_to_virt
c_func
(paren
id|devstat-&gt;cpa
)paren
op_minus
op_amp
id|chan.write-&gt;ccw
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|curr_ccwidx
op_assign
(paren
(paren
id|curr_idx
op_minus
l_int|2
)paren
op_amp
(paren
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|curr_ccwidx2
op_assign
(paren
(paren
id|curr_idx
op_minus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curr_ccwidx
op_eq
id|chan.write-&gt;tx_idx
)paren
(brace
id|lcs_bad_news
(paren
l_string|&quot;lcs_handle_irq race &quot;
l_string|&quot;tx_idx=%d=curr_ccwidx &quot;
l_string|&quot;prepare_idx=%u &quot;
l_string|&quot;write_globals=%p&bslash;n&quot;
comma
id|chan.write-&gt;tx_idx
comma
id|chan.write-&gt;prepare_idx
comma
id|chan.write
)paren
suffix:semicolon
r_goto
id|lcs_int_debug_info
suffix:semicolon
)brace
r_for
c_loop
(paren
id|curr_idx
op_assign
(paren
(paren
id|chan.write-&gt;tx_idx
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|curr_idx
op_ne
id|curr_ccwidx2
suffix:semicolon
id|curr_idx
op_assign
(paren
(paren
id|curr_idx
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|curr_ccw
op_assign
op_amp
id|chan.write-&gt;ccw
(braket
id|curr_idx
)braket
suffix:semicolon
id|curr_ccw-&gt;flags
op_or_assign
id|CCW_FLAG_SUSPEND
suffix:semicolon
id|curr_ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
id|chan.write-&gt;tx_idx
op_assign
id|curr_ccwidx
suffix:semicolon
id|curr_ccw
op_assign
op_amp
id|chan.write-&gt;ccw
(braket
id|chan.write
op_member_access_from_pointer
id|prepare_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|curr_ccw
op_ne
op_amp
id|chan.write-&gt;ccw
(braket
id|curr_ccwidx
)braket
)paren
(brace
r_if
c_cond
(paren
id|curr_ccw-&gt;count
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Tx the buffer currently&n;&t;&t;&t;&t;&t;&t; * being prepared */
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
op_logical_and
id|lcs_should_queue_write
(paren
id|chan.write
comma
id|lcs_get_tod
c_func
(paren
)paren
)paren
)paren
id|lcs_queue_write_if_necessary
(paren
id|chan.write
)paren
suffix:semicolon
r_else
id|lcs_resume_write
(paren
id|chan.write
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|lcs_bad_news
(paren
l_string|&quot;lcs_handle_irq race &quot;
l_string|&quot;tx_idx=%u=prepare_idx &quot;
l_string|&quot;write_globals=%p&bslash;n&quot;
comma
(paren
r_int
)paren
id|chan.write
op_member_access_from_pointer
id|prepare_idx
comma
id|chan.write
)paren
suffix:semicolon
r_goto
id|lcs_normal_ret
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chan.write-&gt;chan_busy_state
op_eq
id|chan_idle
)paren
(brace
r_switch
c_cond
(paren
id|drvr_globals-&gt;state
)paren
(brace
r_case
id|lcs_idle_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_requesting_channels_for_lancmds
suffix:colon
id|drvr_globals-&gt;state
op_assign
id|lcs_got_write_channel_for_lancmds
suffix:semicolon
r_case
id|lcs_doing_lancmds
suffix:colon
id|lcs_wakeup
c_func
(paren
id|chan.globals
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_doing_io
suffix:colon
id|stats-&gt;tx_bytes
op_add_assign
id|chan.write-&gt;bytes_still_being_txed
suffix:semicolon
id|chan.write-&gt;bytes_still_being_txed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_hw_stats
)paren
id|stats-&gt;tx_packets
op_add_assign
id|chan.write-&gt;pkts_still_being_txed
suffix:semicolon
id|chan.write-&gt;pkts_still_being_txed
op_assign
l_int|0
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
)brace
r_goto
id|lcs_normal_ret
suffix:semicolon
id|lcs_int_spurious
suffix:colon
id|lcs_debug_setmessage
c_func
(paren
l_string|&quot;received spurious interrupt&quot;
)paren
suffix:semicolon
id|lcs_int_debug_info
suffix:colon
id|lcs_debugchannel
c_func
(paren
id|message
comma
id|chan.globals
)paren
suffix:semicolon
id|lcs_normal_ret
suffix:colon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs irq exited irq=%x&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_globals_valid
)paren
(brace
id|chan.globals-&gt;lock_owner
op_assign
id|LCS_INVALID_LOCK_OWNER
suffix:semicolon
id|chan.globals-&gt;lock_cnt
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * Wrappers to allocate irqs if these fail the io channel is probably&n; * being used by another device.&n; */
r_static
r_int
DECL|function|lcs_allocirq_func
id|lcs_allocirq_func
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
r_int
id|rc
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_allocirq called chan_globals=%p&bslash;n&quot;
comma
id|chan_globals
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chan_globals-&gt;irq_allocated_magic
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_allocirq irq already allocated&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
id|chan_globals-&gt;devstat.intparm
op_assign
(paren
id|addr_t
)paren
id|chan_globals
suffix:semicolon
id|rc
op_assign
macro_line|#if LCS_CHANDEV
id|chandev_request_irq
macro_line|#else
id|request_irq
macro_line|#endif
(paren
id|chan_globals-&gt;subchannel
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_int
comma
r_void
op_star
comma
r_struct
id|pt_regs
op_star
)paren
)paren
id|lcs_handle_irq
comma
l_int|0
comma
id|cardname
comma
op_amp
id|chan_globals-&gt;devstat
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|chan_globals-&gt;irq_allocated_magic
op_assign
id|LCS_MAGIC
suffix:semicolon
macro_line|#if LCS_DEBUG
r_else
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;request irq failed error code %d &quot;
l_string|&quot;subchannel %2X&bslash;n&quot;
comma
id|rc
comma
id|chan_globals-&gt;subchannel
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
)brace
DECL|macro|lcs_allocirq
mdefine_line|#define lcs_allocirq(chan_globals) &bslash;&n;&t;lcs_allocirq_func((lcs_chan_globals *)(chan_globals))
r_static
r_void
DECL|function|lcs_freeirq
id|lcs_freeirq
c_func
(paren
id|lcs_chan_globals
op_star
id|chan_globals
)paren
(brace
r_if
c_cond
(paren
id|chan_globals-&gt;irq_allocated_magic
)paren
(brace
macro_line|#if LCS_CHANDEV
id|chandev_free_irq
c_func
(paren
id|chan_globals-&gt;subchannel
comma
op_amp
id|chan_globals-&gt;devstat
)paren
suffix:semicolon
macro_line|#else
id|free_irq
c_func
(paren
id|chan_globals-&gt;subchannel
comma
op_amp
id|chan_globals-&gt;devstat
)paren
suffix:semicolon
macro_line|#endif
id|chan_globals-&gt;irq_allocated_magic
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_static
id|lcs_inline
r_void
DECL|function|lcs_freeallirqs
id|lcs_freeallirqs
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_freeallirqs called %p&bslash;n&quot;
comma
id|drvr_globals
)paren
suffix:semicolon
id|lcs_freeirq
c_func
(paren
(paren
id|lcs_chan_globals
op_star
)paren
id|drvr_globals-&gt;read
)paren
suffix:semicolon
id|lcs_freeirq
c_func
(paren
(paren
id|lcs_chan_globals
op_star
)paren
id|drvr_globals-&gt;write
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Generic routine for sending all startup &amp; shutdown command primatives  &n; * to lcs.&n; * A unit check with a sense code of 0x42 may be presented here if this&n; * happens we restart the startup procedure, currently the osa card has been&n; * seen to present the unit check very late in the startup sequence &n; * &amp; resend outstanding buffers already read, the source of this problem is&n; * unknown, this problem is handled basically by checking sequence&n; * numbers &amp; disgarding packets already received.&n; */
r_static
r_int
DECL|function|lcs_lancmd
id|lcs_lancmd
c_func
(paren
id|lcs_cmd
id|cmd_code
comma
id|u8
id|rel_adapter_no
comma
id|lcs_drvr_globals
op_star
id|drvr_globals
macro_line|#ifdef CONFIG_IP_MULTICAST
comma
id|u16
id|num_ipm_pairs
comma
id|lcs_ip_mac_addr_pair
op_star
id|ip_mac_pairs
macro_line|#endif
)paren
(brace
id|lcs_std_cmd
op_star
id|readcmd
comma
op_star
id|writecmd
suffix:semicolon
id|lcs_read_globals
op_star
id|read
suffix:semicolon
id|lcs_write_globals
op_star
id|write
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|retry_cnt
op_assign
l_int|0
suffix:semicolon
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
id|lcs_debug_exception
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_lancmd cmd code=%02x drvr_globals=%p&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd_code
comma
id|drvr_globals
)paren
suffix:semicolon
id|wait_on_write
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Retry
suffix:colon
id|read-&gt;lancmd_reply_ptr
op_assign
l_int|NULL
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
(paren
id|writecmd
op_assign
id|lcs_prepare_lancmd
c_func
(paren
id|write
comma
id|cmd_code
comma
id|rel_adapter_no
comma
id|lcs_390_initiated
comma
id|drvr_globals-&gt;lan_type
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lancmd2 lcs_prepare_cmd failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_lancmd writecmd=%p&bslash;n&quot;
comma
id|writecmd
)paren
suffix:semicolon
id|read-&gt;lancmd_reply_ptr
op_assign
l_int|NULL
suffix:semicolon
id|lcs_initqueue
c_func
(paren
id|read
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
r_if
c_cond
(paren
id|cmd_code
op_eq
id|lcs_setipm
op_logical_or
id|cmd_code
op_eq
id|lcs_delipm
)paren
(brace
(paren
(paren
id|lcs_ipm_ctlmsg
op_star
)paren
id|writecmd
)paren
op_member_access_from_pointer
id|version
op_assign
l_int|4
suffix:semicolon
(paren
(paren
id|lcs_ipm_ctlmsg
op_star
)paren
id|writecmd
)paren
op_member_access_from_pointer
id|num_ipm_pairs
op_assign
id|num_ipm_pairs
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
(paren
(paren
id|lcs_ipm_ctlmsg
op_star
)paren
id|writecmd
)paren
op_member_access_from_pointer
id|ip_mac_pair
(braket
l_int|0
)braket
comma
id|ip_mac_pairs
comma
r_sizeof
(paren
id|lcs_ip_mac_addr_pair
)paren
op_star
id|num_ipm_pairs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd_code
op_eq
id|lcs_qipassist
)paren
(brace
(paren
(paren
id|lcs_qipassist_ctlmsg
op_star
)paren
id|writecmd
)paren
op_member_access_from_pointer
id|num_ip_pairs
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|lcs_qipassist_ctlmsg
op_star
)paren
id|writecmd
)paren
op_member_access_from_pointer
id|version
op_assign
l_int|4
suffix:semicolon
)brace
macro_line|#endif
id|writecmd-&gt;sequence_no
op_assign
op_increment
id|drvr_globals-&gt;sequence_no
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;sequence_no=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|drvr_globals-&gt;sequence_no
)paren
suffix:semicolon
id|drvr_globals-&gt;cmd_code
op_assign
id|cmd_code
suffix:semicolon
id|rc
op_assign
id|lcs_resumeandwait
c_func
(paren
id|write
comma
id|cmd_code
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rc
op_eq
op_minus
id|EAGAIN
op_logical_and
id|retry_cnt
op_increment
OL
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|Done
suffix:semicolon
id|rc
op_assign
id|lcs_sleepon
c_func
(paren
id|read
comma
id|lcs_calcsleeptime
c_func
(paren
id|drvr_globals
comma
id|cmd_code
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ERETRY
)paren
r_goto
id|Done
suffix:semicolon
r_if
c_cond
(paren
(paren
id|readcmd
op_assign
id|read-&gt;lancmd_reply_ptr
)paren
op_eq
l_int|NULL
op_logical_or
id|rc
op_eq
op_minus
id|EAGAIN
)paren
(brace
r_if
c_cond
(paren
id|retry_cnt
op_increment
OL
l_int|3
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;retrying cmd_code=0x02 read_cmd=%p &quot;
l_string|&quot;rc=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd_code
comma
id|readcmd
comma
id|rc
)paren
suffix:semicolon
r_goto
id|Retry
suffix:semicolon
)brace
r_else
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_lancmd retry count &quot;
l_string|&quot;exceeded giving up&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|Done
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|readcmd-&gt;cmd_code
op_ne
id|cmd_code
op_logical_or
(paren
id|writecmd-&gt;sequence_no
op_minus
id|readcmd-&gt;sequence_no
)paren
OG
l_int|3
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;readcmd=%p read_cmd_code=%02x write_cmd_code=%02x &quot;
l_string|&quot;read_seq=%04x write_seq=%04x&bslash;n&quot;
comma
id|readcmd
comma
(paren
r_int
)paren
id|readcmd-&gt;cmd_code
comma
(paren
r_int
)paren
id|cmd_code
comma
(paren
r_int
)paren
id|readcmd-&gt;sequence_no
comma
(paren
r_int
)paren
id|writecmd-&gt;sequence_no
)paren
suffix:semicolon
r_goto
id|Fail
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|cmd_code
)paren
(brace
r_case
id|lcs_lanstat
suffix:colon
r_if
c_cond
(paren
id|readcmd-&gt;rel_adapter_no
op_ne
id|rel_adapter_no
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;rel adapters differ&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|Fail
suffix:semicolon
)brace
multiline_comment|/* I got back a funny rel adapter no from stoplan &n;&t;&t;&t; * so I&squot;ll assume it&squot;s broke */
r_case
id|lcs_startlan
suffix:colon
r_if
c_cond
(paren
id|readcmd-&gt;lan_type
op_ne
id|writecmd-&gt;lan_type
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lan types differ&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|Fail
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readcmd-&gt;return_code
op_ne
l_int|0
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;readcmd_return_code=%02x&bslash;n&quot;
comma
(paren
r_int
)paren
id|readcmd-&gt;return_code
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|Done
suffix:semicolon
)brace
r_case
id|lcs_stoplan
suffix:colon
multiline_comment|/* the stoplan primative should return the&n;&t;&t;&t; * adapter type */
multiline_comment|/* it dosen&squot;t appar to though */
r_case
id|lcs_startup
suffix:colon
r_case
id|lcs_shutdown
suffix:colon
macro_line|#ifdef CONFIG_IP_MULTICAST
r_case
id|lcs_setipm
suffix:colon
r_case
id|lcs_delipm
suffix:colon
r_case
id|lcs_qipassist
suffix:colon
macro_line|#endif
r_if
c_cond
(paren
id|readcmd-&gt;return_code
op_ne
l_int|0
)paren
r_goto
id|Fail
suffix:semicolon
)brace
)brace
id|Done
suffix:colon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_lancmd cmd_code=%02x rc=%d reply_ptr=%p&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd_code
comma
id|rc
comma
id|read-&gt;lancmd_reply_ptr
)paren
suffix:semicolon
macro_line|#if LCS_DEBUG
r_if
c_cond
(paren
id|rc
op_logical_and
id|read-&gt;lancmd_reply_ptr
)paren
id|lcs_debug_display_read_buff
c_func
(paren
l_string|&quot;reply&quot;
comma
id|read-&gt;lancmd_reply_ptr
)paren
suffix:semicolon
macro_line|#endif
id|drvr_globals-&gt;state
op_assign
id|lcs_idle
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|cmd_code
op_ne
id|lcs_lanstat
macro_line|#ifdef CONFIG_IP_MULTICAST
op_logical_and
id|cmd_code
op_ne
id|lcs_qipassist
macro_line|#endif
)paren
)paren
id|lcs_resume_read
c_func
(paren
id|read
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
id|Fail
suffix:colon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|Done
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_MULTICAST
r_static
r_int
DECL|function|lcs_print_ipassists
id|lcs_print_ipassists
c_func
(paren
id|lcs_qipassist_ctlmsg
op_star
id|reply
comma
r_char
op_star
id|name
comma
r_char
op_star
id|ipassist_str
comma
id|lcs_assists
id|mask
)paren
(brace
id|lcs_good_news
c_func
(paren
l_string|&quot;%s: %s supported %s enabled %s&bslash;n&quot;
comma
id|name
comma
id|ipassist_str
comma
id|reply-&gt;ip_assists_supported
op_amp
id|mask
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|reply-&gt;ip_assists_enabled
op_amp
id|mask
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
r_return
(paren
(paren
id|reply-&gt;ip_assists_supported
op_amp
id|reply
op_member_access_from_pointer
id|ip_assists_enabled
op_amp
id|mask
)paren
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_check_multicast_supported
id|lcs_check_multicast_supported
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
id|lcs_qipassist_ctlmsg
op_star
id|lcs_reply
suffix:semicolon
r_char
op_star
id|name
op_assign
id|drvr_globals-&gt;dev-&gt;name
suffix:semicolon
r_int
id|rc
op_assign
id|FALSE
suffix:semicolon
r_if
c_cond
(paren
id|lcs_lancmd
c_func
(paren
id|lcs_qipassist
comma
id|drvr_globals-&gt;rel_adapter_no
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
op_eq
l_int|0
)paren
(brace
id|lcs_reply
op_assign
(paren
id|lcs_qipassist_ctlmsg
op_star
)paren
id|drvr_globals-&gt;read-&gt;lancmd_reply_ptr
suffix:semicolon
r_if
c_cond
(paren
id|lcs_reply
)paren
(brace
id|lcs_print_ipassists
c_func
(paren
id|lcs_reply
comma
id|name
comma
l_string|&quot;ip v6&quot;
comma
id|lcs_ip_v6_support
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_print_ipassists
c_func
(paren
id|lcs_reply
comma
id|name
comma
l_string|&quot;multicast&quot;
comma
id|lcs_multicast_support
)paren
suffix:semicolon
)brace
)brace
r_else
id|lcs_good_news
c_func
(paren
l_string|&quot;qipassist failed, ipassists assumed &quot;
l_string|&quot;unsupported for %s&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|lcs_resume_read
c_func
(paren
id|drvr_globals-&gt;read
)paren
suffix:semicolon
r_return
(paren
id|rc
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* &n; * Update network statistics from hardware.&n; */
r_static
r_int
DECL|function|lcs_gethwinfo
id|lcs_gethwinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
(paren
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|lcs_lanstat_reply
op_star
id|lcs_reply
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|lcs_read_globals
op_star
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_lanstat
comma
id|drvr_globals-&gt;rel_adapter_no
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|lcs_reply
op_assign
(paren
id|lcs_lanstat_reply
op_star
)paren
id|read-&gt;lancmd_reply_ptr
suffix:semicolon
r_if
c_cond
(paren
id|lcs_reply
)paren
(brace
id|stats
op_assign
op_amp
id|drvr_globals-&gt;stats
suffix:semicolon
id|stats-&gt;rx_packets
op_assign
id|lcs_reply-&gt;num_packets_rx_from_lan
suffix:semicolon
id|stats-&gt;rx_errors
op_assign
id|lcs_reply-&gt;num_rx_errors_detected
suffix:semicolon
id|stats-&gt;rx_length_errors
op_assign
id|lcs_reply-&gt;num_rx_packets_too_large
suffix:semicolon
id|stats-&gt;rx_missed_errors
op_assign
id|lcs_reply-&gt;num_rx_discarded_nobuffs_avail
suffix:semicolon
id|stats-&gt;tx_packets
op_assign
id|lcs_reply-&gt;num_packets_tx_on_lan
suffix:semicolon
id|stats-&gt;tx_errors
op_assign
id|lcs_reply-&gt;num_tx_errors_detected
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_assign
id|lcs_reply-&gt;num_tx_packets_disgarded
suffix:semicolon
)brace
)brace
macro_line|#if LCS_DEBUG
r_else
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;gethwinfo failed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|lcs_resume_read
c_func
(paren
id|read
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Displays the mac address etc. on startup.&n; */
r_static
r_void
DECL|function|lcs_displayinfo
id|lcs_displayinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
(paren
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|u8
op_star
id|mac_address
op_assign
id|dev-&gt;dev_addr
suffix:semicolon
id|lcs_read_globals
op_star
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
id|lcs_write_globals
op_star
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
id|lcs_good_news
(paren
l_string|&quot;&bslash;nlcs: %s configured as follows read subchannel=%x &quot;
l_string|&quot;write subchannel=%x&bslash;n&quot;
l_string|&quot;read_devno=%04x write_devno=%04x&bslash;n&quot;
l_string|&quot;hw_address=%02X:%02X:%02X:%02X:%02X:%02X rel_adapter_no=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|read-&gt;subchannel
comma
id|write-&gt;subchannel
comma
(paren
r_int
)paren
id|read-&gt;devno
comma
(paren
r_int
)paren
id|write-&gt;devno
comma
(paren
r_int
)paren
id|mac_address
(braket
l_int|0
)braket
comma
(paren
r_int
)paren
id|mac_address
(braket
l_int|1
)braket
comma
(paren
r_int
)paren
id|mac_address
(braket
l_int|2
)braket
comma
(paren
r_int
)paren
id|mac_address
(braket
l_int|3
)braket
comma
(paren
r_int
)paren
id|mac_address
(braket
l_int|4
)braket
comma
(paren
r_int
)paren
id|mac_address
(braket
l_int|5
)braket
comma
id|drvr_globals-&gt;rel_adapter_no
)paren
suffix:semicolon
)brace
multiline_comment|/* shutdown osa card */
r_static
r_int
DECL|function|lcs_halt_channels
id|lcs_halt_channels
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
r_int
id|delay
)paren
(brace
r_int
id|rc
comma
id|rc2
suffix:semicolon
r_if
c_cond
(paren
id|delay
op_amp
l_int|1
)paren
(brace
multiline_comment|/* [arnd] maybe better rethink/rewrite this whole function */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|lcs_hsch
c_func
(paren
id|drvr_globals-&gt;read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delay
op_amp
l_int|2
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
id|drvr_globals-&gt;read-&gt;chan_busy_state
op_assign
id|chan_dead
suffix:semicolon
id|rc2
op_assign
id|lcs_hsch
c_func
(paren
id|drvr_globals-&gt;write
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delay
op_amp
l_int|4
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
id|drvr_globals-&gt;write-&gt;chan_busy_state
op_assign
id|chan_dead
suffix:semicolon
r_return
(paren
id|rc
ques
c_cond
id|rc
suffix:colon
id|rc2
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_stopcard
id|lcs_stopcard
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_int
id|rc1
comma
id|rc2
comma
id|rc3
suffix:semicolon
id|rc1
op_assign
id|rc2
op_assign
id|rc3
op_assign
l_int|0
suffix:semicolon
id|drvr_globals-&gt;up
op_assign
id|FALSE
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_stopcard called&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_interrupted
)paren
id|drvr_globals-&gt;state
op_assign
id|lcs_idle
suffix:semicolon
multiline_comment|/* Make sure that we don&squot;t attempt to resume a channel */
multiline_comment|/* that was halted or dead to avoid the -ENOTCONNECTED */
multiline_comment|/* errors reported from Ingo on resume_IO */
r_if
c_cond
(paren
id|drvr_globals-&gt;read-&gt;chan_busy_state
op_ne
id|chan_dead
op_logical_and
id|drvr_globals-&gt;write-&gt;chan_busy_state
op_ne
id|chan_dead
)paren
(brace
id|rc1
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_stoplan
comma
id|drvr_globals-&gt;rel_adapter_no
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
suffix:semicolon
multiline_comment|/* We probably haven&squot;t got a good relative adapter no */
r_if
c_cond
(paren
id|drvr_globals-&gt;rel_adapter_no
op_ne
id|lcs_invalid_adapter_no
)paren
id|rc2
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_shutdown
comma
l_int|0
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
suffix:semicolon
)brace
id|lcs_resetstate
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|rc3
op_assign
id|lcs_halt_channels
c_func
(paren
id|drvr_globals
comma
l_int|7
)paren
suffix:semicolon
id|lcs_resetstate
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_return
(paren
id|rc1
ques
c_cond
id|rc1
suffix:colon
(paren
id|rc2
ques
c_cond
id|rc2
suffix:colon
id|rc3
)paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_initwriteccws
id|lcs_initwriteccws
c_func
(paren
id|lcs_write_globals
op_star
id|write
)paren
(brace
id|initccws
c_func
(paren
id|write-&gt;ccw
comma
id|write-&gt;iobuff
comma
id|LCS_NUM_TX_BUFFS
comma
id|ccw_write
comma
l_int|0
comma
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SUSPEND
)paren
suffix:semicolon
id|write-&gt;prepare_idx
op_assign
l_int|0
suffix:semicolon
id|write-&gt;tx_idx
op_assign
id|LCS_NUM_TX_BUFFS
op_minus
l_int|1
suffix:semicolon
id|write-&gt;resume_queued
op_assign
id|FALSE
suffix:semicolon
id|write-&gt;bytes_still_being_txed
op_assign
id|write-&gt;pkts_still_being_txed
op_assign
l_int|0
suffix:semicolon
id|write-&gt;adjusted_last_bytes_still_being_txed
op_assign
l_int|0
suffix:semicolon
id|write-&gt;last_resume_time
op_assign
id|lcs_get_tod
c_func
(paren
)paren
suffix:semicolon
id|write-&gt;chan_busy_state
op_assign
id|chan_starting_up
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_startreadio
id|lcs_startreadio
c_func
(paren
id|lcs_read_globals
op_star
id|read
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|ccw1_t
op_star
id|ccws
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs_startreadio read_globals=%p&bslash;n&quot;
comma
id|read
)paren
suffix:semicolon
id|ccws
op_assign
id|read-&gt;ccw
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_RX_BUFFS
suffix:semicolon
id|cnt
op_increment
comma
id|ccws
op_increment
)paren
(brace
id|ccws-&gt;count
op_assign
id|LCS_IOBUFFSIZE
suffix:semicolon
id|ccws-&gt;flags
op_assign
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
op_or
(paren
id|cnt
op_eq
(paren
id|LCS_NUM_RX_BUFFS
op_minus
l_int|1
)paren
ques
c_cond
id|CCW_FLAG_SUSPEND
suffix:colon
id|CCW_FLAG_PCI
)paren
macro_line|#if LCS_USE_IDALS
op_or
(paren
id|ccws-&gt;flags
op_amp
id|CCW_FLAG_IDA
)paren
macro_line|#endif
suffix:semicolon
macro_line|#if LCS_ZERO_COPY_READ
(paren
(paren
id|lcs_header_type
op_star
)paren
id|read-&gt;skb_buff
(braket
id|cnt
)braket
op_member_access_from_pointer
id|data
)paren
op_member_access_from_pointer
id|offset
op_assign
id|LCS_ILLEGAL_OFFSET
suffix:semicolon
macro_line|#else
(paren
(paren
id|lcs_header_type
op_star
)paren
id|read-&gt;iobuff
(braket
id|cnt
)braket
)paren
op_member_access_from_pointer
id|offset
op_assign
id|LCS_ILLEGAL_OFFSET
suffix:semicolon
macro_line|#endif
)brace
id|read-&gt;lancmd_reply_ptr
op_assign
l_int|NULL
suffix:semicolon
id|read-&gt;rx_idx
op_assign
l_int|0
suffix:semicolon
id|read-&gt;chan_busy_state
op_assign
id|chan_starting_up
suffix:semicolon
id|lcs_doio
c_func
(paren
id|read
comma
id|DOIO_DENY_PREFETCH
op_or
id|DOIO_ALLOW_SUSPEND
multiline_comment|/*|DOIO_REPORT_ALL */
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_startwriteio
id|lcs_startwriteio
c_func
(paren
id|lcs_write_globals
op_star
id|write
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs_startwriteio write_globals=%p&bslash;n&quot;
comma
id|write
)paren
suffix:semicolon
id|lcs_initwriteccws
c_func
(paren
id|write
)paren
suffix:semicolon
id|lcs_doio
c_func
(paren
id|write
comma
id|DOIO_DENY_PREFETCH
op_or
id|DOIO_ALLOW_SUSPEND
multiline_comment|/* | DOIO_REPORT_ALL */
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_restartreadio
id|lcs_restartreadio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_restartreadio&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_wakeup
c_func
(paren
id|drvr_globals-&gt;read
comma
op_minus
id|EAGAIN
)paren
suffix:semicolon
id|lcs_startreadio
c_func
(paren
id|drvr_globals-&gt;read
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_queued_restartreadio
id|lcs_queued_restartreadio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lcs_drvr_globals_valid
c_func
(paren
id|drvr_globals
)paren
)paren
r_goto
id|Done2
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_idle
op_logical_or
id|drvr_globals-&gt;state
op_eq
id|lcs_halting_subchannels
)paren
r_goto
id|Done1
suffix:semicolon
id|lcs_restartreadio
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done1
suffix:colon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done2
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_restartwriteio
id|lcs_restartwriteio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
id|lcs_write_globals
op_star
id|write
suffix:semicolon
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
id|write-&gt;bytes_still_being_txed
op_assign
l_int|0
suffix:semicolon
id|drvr_globals-&gt;stats.tx_dropped
op_add_assign
id|write-&gt;pkts_still_being_txed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_hw_stats
)paren
id|drvr_globals-&gt;stats.tx_errors
op_add_assign
id|write-&gt;pkts_still_being_txed
suffix:semicolon
id|write-&gt;pkts_still_being_txed
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|drvr_globals-&gt;state
)paren
(brace
r_case
id|lcs_doing_io
suffix:colon
id|netif_wake_queue
c_func
(paren
id|drvr_globals-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_idle_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_requesting_channels_for_lancmds
suffix:colon
r_case
id|lcs_got_write_channel_for_lancmds
suffix:colon
id|lcs_wakeup
c_func
(paren
id|write
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|lcs_doing_lancmds
suffix:colon
id|lcs_wakeup
c_func
(paren
id|write
comma
op_minus
id|EAGAIN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|lcs_startwriteio
c_func
(paren
id|write
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_queued_restartwriteio
id|lcs_queued_restartwriteio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lcs_drvr_globals_valid
c_func
(paren
id|drvr_globals
)paren
)paren
r_goto
id|Done2
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_idle
op_logical_or
id|drvr_globals-&gt;state
op_eq
id|lcs_halting_subchannels
)paren
r_goto
id|Done1
suffix:semicolon
id|lcs_restartwriteio
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done1
suffix:colon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done2
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_startallio
id|lcs_startallio
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
r_if
c_cond
(paren
id|drvr_globals-&gt;dev
)paren
id|netif_stop_queue
c_func
(paren
id|drvr_globals-&gt;dev
)paren
suffix:semicolon
id|drvr_globals-&gt;state
op_assign
id|lcs_idle_requesting_channels_for_lancmds
suffix:semicolon
id|lcs_startreadio
c_func
(paren
id|drvr_globals-&gt;read
)paren
suffix:semicolon
id|lcs_initqueue
c_func
(paren
id|drvr_globals-&gt;write
)paren
suffix:semicolon
id|lcs_startwriteio
c_func
(paren
id|drvr_globals-&gt;write
)paren
suffix:semicolon
id|lcs_sleepon
c_func
(paren
id|drvr_globals-&gt;write
comma
l_int|0
)paren
suffix:semicolon
id|drvr_globals-&gt;state
op_assign
id|lcs_doing_lancmds
suffix:semicolon
)brace
multiline_comment|/*&n; * The osa detection/startup routine called from lcs_probe on&n; * bootup &amp; lcs_open this is called after the irq&squot;s are allocated &amp;&n; * successful sensing of the read &amp; write subchannels.&n; */
r_static
r_int
DECL|function|lcs_detect
id|lcs_detect
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
id|s16
id|forced_port_no
comma
id|u8
id|hint_port_no
comma
id|u8
id|max_port_no
comma
id|lcs_frame_type
id|frame_type
comma
id|u8
op_star
id|mac_address
)paren
(brace
r_int
id|rc
op_assign
l_int|0
comma
id|successful_startup
op_assign
id|FALSE
suffix:semicolon
r_int
id|rel_adapter_no
comma
id|rel_adapter_idx
suffix:semicolon
id|lcs_read_globals
op_star
id|read
suffix:semicolon
id|lcs_write_globals
op_star
id|write
suffix:semicolon
id|lcs_lanstat_reply
op_star
id|lcs_reply
suffix:semicolon
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
id|spin_lock_init
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
macro_line|#endif
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;Entering detect read subchannel=%X&bslash;n&quot;
comma
(paren
r_int
)paren
id|drvr_globals-&gt;read-&gt;subchannel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;dev
)paren
id|netif_stop_queue
c_func
(paren
id|drvr_globals-&gt;dev
)paren
suffix:semicolon
r_do
(brace
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_detect retry_cnt=%d&bslash;n&quot;
comma
id|drvr_globals-&gt;retry_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
)paren
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
)paren
OG
l_int|0
)paren
id|lcs_resetstate
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
)paren
OG
l_int|1
op_logical_and
id|rc
op_ne
op_minus
id|ERETRY
)paren
(brace
multiline_comment|/* Time to change tactics */
id|rc
op_assign
id|lcs_stopcard
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
)brace
r_else
id|rc
op_assign
id|lcs_halt_channels
c_func
(paren
id|drvr_globals
comma
(paren
id|atomic_read
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
)paren
op_eq
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_continue
suffix:semicolon
id|lcs_startallio
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_startup
comma
l_int|0
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
)paren
)paren
r_continue
suffix:semicolon
r_else
id|successful_startup
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|lcs_lgw_common
c_func
(paren
id|drvr_globals
comma
id|lcs_startup
)paren
)paren
)paren
r_continue
suffix:semicolon
r_else
id|successful_startup
op_assign
id|TRUE
suffix:semicolon
r_for
c_loop
(paren
id|rel_adapter_idx
op_assign
l_int|0
suffix:semicolon
id|rel_adapter_idx
op_le
id|max_port_no
op_logical_and
(paren
id|rc
op_eq
op_minus
id|ENXIO
op_logical_or
id|rel_adapter_idx
op_eq
l_int|0
)paren
suffix:semicolon
id|rel_adapter_idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|forced_port_no
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|rel_adapter_idx
OG
l_int|0
)paren
r_break
suffix:semicolon
id|rel_adapter_no
op_assign
id|forced_port_no
suffix:semicolon
)brace
r_else
(brace
id|rel_adapter_no
op_assign
(paren
id|rel_adapter_idx
op_eq
l_int|0
ques
c_cond
id|hint_port_no
suffix:colon
(paren
id|rel_adapter_idx
op_eq
id|hint_port_no
ques
c_cond
l_int|0
suffix:colon
id|rel_adapter_idx
)paren
)paren
suffix:semicolon
)brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;Trying startlan rel adapter no %u&bslash;n&quot;
comma
(paren
r_int
)paren
id|rel_adapter_no
)paren
suffix:semicolon
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|frame_type
op_eq
id|lcs_autodetect_type
)paren
(brace
macro_line|#ifdef CONFIG_NET_ETHERNET
id|drvr_globals-&gt;lan_type
op_assign
id|lcs_enet_type
suffix:semicolon
id|rc
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_startlan
comma
id|rel_adapter_no
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_goto
id|lcs_good_detect
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
id|drvr_globals-&gt;lan_type
op_assign
id|lcs_token_ring_type
suffix:semicolon
id|rc
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_startlan
comma
id|rel_adapter_no
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_goto
id|lcs_good_detect
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FDDI
id|drvr_globals-&gt;lan_type
op_assign
id|lcs_fddi_type
suffix:semicolon
id|rc
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_startlan
comma
id|rel_adapter_no
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|drvr_globals-&gt;lan_type
op_assign
id|frame_type
suffix:semicolon
id|rc
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_startlan
comma
id|rel_adapter_no
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
suffix:semicolon
)brace
id|lcs_good_detect
suffix:colon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;Found relative adapter &quot;
l_string|&quot;number %d&bslash;n&quot;
comma
id|rel_adapter_no
)paren
suffix:semicolon
id|drvr_globals-&gt;rel_adapter_no
op_assign
id|rel_adapter_no
suffix:semicolon
id|lcs_do_lanstat
suffix:colon
id|rc
op_assign
id|lcs_lancmd
c_func
(paren
id|lcs_lanstat
comma
id|drvr_globals-&gt;rel_adapter_no
comma
id|drvr_globals
id|LANCMD_DEFAULT_MCAST_PARMS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|lcs_reply
op_assign
(paren
id|lcs_lanstat_reply
op_star
)paren
id|drvr_globals-&gt;read
op_member_access_from_pointer
id|lancmd_reply_ptr
suffix:semicolon
r_if
c_cond
(paren
id|lcs_reply
op_eq
l_int|NULL
)paren
r_goto
id|lcs_do_lanstat
suffix:semicolon
id|memcpy
c_func
(paren
id|mac_address
comma
id|lcs_reply-&gt;mac_address
comma
id|LCS_ADDR_LEN
)paren
suffix:semicolon
id|lcs_resume_read
c_func
(paren
id|drvr_globals-&gt;read
)paren
suffix:semicolon
id|drvr_globals-&gt;up
op_assign
id|TRUE
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_while
c_loop
(paren
(paren
id|rc
op_eq
op_minus
id|EAGAIN
op_logical_or
id|rc
op_eq
op_minus
id|ETIMEDOUT
op_logical_or
id|rc
op_eq
op_minus
id|ERETRY
)paren
op_logical_and
id|atomic_inc_return
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
)paren
OL
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|successful_startup
op_logical_and
id|rc
)paren
id|lcs_bad_news
(paren
l_string|&quot;A partially successful startup read_devno=%04x &quot;
l_string|&quot;write_devno=%4x was detected rc=%d&bslash;n&quot;
l_string|&quot;please check your configuration parameters,cables &quot;
l_string|&quot;&amp; connection to the network.&bslash;n&quot;
comma
id|drvr_globals-&gt;read-&gt;devno
comma
id|drvr_globals-&gt;write-&gt;devno
comma
id|rc
)paren
suffix:semicolon
r_return
(paren
id|rc
op_eq
id|EINTR
ques
c_cond
op_minus
id|EINTR
suffix:colon
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
multiline_comment|/* Called by user doing ifconfig &lt;network_device e.g. tr0&gt; up */
r_static
r_int
DECL|function|lcs_open
id|lcs_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|lcs_drvr_globals
op_star
id|drvr_globals
suffix:semicolon
id|lcs_read_globals
op_star
id|read
suffix:semicolon
id|lcs_write_globals
op_star
id|write
suffix:semicolon
macro_line|#if LCS_DEBUG_RESUME
id|lcs_read_resume_cnt
op_assign
id|lcs_write_resume_cnt
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|drvr_globals
op_assign
(paren
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
id|drvr_globals-&gt;state
op_assign
id|lcs_idle
suffix:semicolon
r_if
c_cond
(paren
id|use_hw_stats
op_eq
id|FALSE
)paren
id|memset
c_func
(paren
op_amp
id|drvr_globals-&gt;stats
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device_stats
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|lcs_detect
c_func
(paren
id|drvr_globals
comma
id|drvr_globals-&gt;rel_adapter_no
comma
l_int|0
comma
l_int|0
comma
id|drvr_globals-&gt;lan_type
comma
id|dev-&gt;dev_addr
)paren
)paren
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;Opening %s failed errcode=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|rc
)paren
suffix:semicolon
id|lcs_resetstate
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
)brace
r_else
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|lcs_start_doing_io
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;Successfully opened %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#if LCS_DEBUG &amp;&amp; !LCS_PRINTK_DEBUG
multiline_comment|/* When debugging we are usually only intrested till&n;&t;&t; * the device is open. */
r_if
c_cond
(paren
id|lcs_id
op_logical_and
id|lcs_id-&gt;level
op_ne
id|DEBUG_MAX_LEVEL
)paren
id|debug_set_level
c_func
(paren
id|lcs_id
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Called by user doing ifconfig &lt;network_device e.g. tr0&gt; down */
r_static
r_int
DECL|function|lcs_close
id|lcs_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_close called&bslash;n&quot;
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lcs_stopcard
c_func
(paren
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_txpacket
id|lcs_txpacket
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
suffix:semicolon
id|lcs_write_globals
op_star
id|write
suffix:semicolon
id|u16
id|pkt_len
suffix:semicolon
id|lcs_header_type
op_star
id|tx_lcs_header_ptr
suffix:semicolon
r_uint64
id|tod
comma
id|delta_tx
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_txpacket&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs txpacket detected sick code&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|drvr_globals
op_assign
(paren
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
id|tod
op_assign
id|lcs_get_tod
c_func
(paren
)paren
suffix:semicolon
id|delta_tx
op_assign
id|tod
op_minus
id|write-&gt;last_lcs_txpacket_time
suffix:semicolon
id|write-&gt;last_lcs_txpacket_time
op_assign
id|tod
suffix:semicolon
id|stats
op_assign
op_amp
id|drvr_globals-&gt;stats
suffix:semicolon
r_if
c_cond
(paren
id|write-&gt;chan_busy_state
op_ne
id|chan_busy
op_logical_and
id|write-&gt;chan_busy_state
op_ne
id|chan_idle
)paren
(brace
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_hw_stats
)paren
(brace
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_carrier_errors
op_increment
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_txpacket netif_is_busy dev=%p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_txpacket skb=NULL dev=%p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_hw_stats
)paren
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;skb_len %d&bslash;n&quot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|pkt_len
op_assign
id|skb-&gt;len
suffix:semicolon
macro_line|#if 0
multiline_comment|/* This apparently can be omitted &amp; saves us a lot of hassle */
id|pkt_len
op_assign
(paren
id|ETH_ZLEN
OL
id|skb-&gt;len
ques
c_cond
id|skb-&gt;len
suffix:colon
id|ETH_ZLEN
)paren
suffix:semicolon
macro_line|#endif
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|lcs_chan_lock
c_func
(paren
id|write
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tx_lcs_header_ptr
op_assign
id|lcs_getfreetxbuff
c_func
(paren
id|write
comma
id|drvr_globals-&gt;lan_type
comma
id|drvr_globals-&gt;rel_adapter_no
comma
id|pkt_len
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|stats-&gt;tx_dropped
op_increment
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;lcs_txpacket no tx buffers &quot;
l_string|&quot;available dev=%p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
id|lcs_resume_write
c_func
(paren
id|write
)paren
suffix:semicolon
id|lcs_chan_unlock
c_func
(paren
id|write
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|write-&gt;bytes_still_being_txed
op_add_assign
id|pkt_len
suffix:semicolon
id|write-&gt;pkts_still_being_txed
op_increment
suffix:semicolon
id|memcpy
c_func
(paren
op_increment
id|tx_lcs_header_ptr
comma
id|skb-&gt;data
comma
id|pkt_len
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcs_should_queue_write
c_func
(paren
id|write
comma
id|tod
)paren
)paren
(brace
id|lcs_queue_write_if_necessary
c_func
(paren
id|write
)paren
suffix:semicolon
)brace
r_else
(brace
id|lcs_resume_write
c_func
(paren
id|write
)paren
suffix:semicolon
)brace
id|lcs_chan_unlock
c_func
(paren
id|write
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Used by ifconfig &amp; the proc filesystem to receive network statistics&n; */
r_static
r_struct
id|net_device_stats
op_star
DECL|function|lcs_getstats
id|lcs_getstats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;lcs_enet_stats&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
op_logical_or
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* shouldn&squot;t happen */
r_if
c_cond
(paren
id|use_hw_stats
)paren
(brace
r_if
c_cond
(paren
id|drvr_globals-&gt;doing_lanstat
)paren
macro_line|#warning FIXME: [kj] Using sleep_on derivative, is racy. consider using wait_event instead
id|interruptible_sleep_on
c_func
(paren
op_amp
id|drvr_globals-&gt;lanstat_wait
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
)paren
(brace
id|drvr_globals-&gt;doing_lanstat
op_assign
id|TRUE
suffix:semicolon
id|lcs_gethwinfo
c_func
(paren
id|dev
)paren
suffix:semicolon
id|drvr_globals-&gt;doing_lanstat
op_assign
id|FALSE
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Gracefully start the lan again */
id|drvr_globals-&gt;state
op_assign
id|lcs_doing_io
suffix:semicolon
multiline_comment|/* Wake up processes awaiting&n;&t;&t;&t;&t; * lanstat results */
id|wake_up_interruptible
c_func
(paren
op_amp
id|drvr_globals
op_member_access_from_pointer
id|lanstat_wait
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
op_amp
(paren
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats
suffix:semicolon
)brace
macro_line|#if !LCS_CHANDEV
multiline_comment|/*&n; * Used to setup kernel parameters for the osa card&n; * read the printk&squot;s in the function for a description of how it&n; * should be called.&n; */
r_static
id|__inline__
id|lcs_model_info
op_star
DECL|function|lcs_get_model_info_by_idx
id|lcs_get_model_info_by_idx
c_func
(paren
r_int
id|idx
)paren
(brace
r_return
(paren
id|idx
OL
id|LCS_CURR_NUM_MODELS
ques
c_cond
op_amp
id|lcs_models
(braket
id|idx
)braket
suffix:colon
(paren
id|lcs_model_info
op_star
)paren
op_amp
id|additional_model_info
(braket
(paren
id|idx
op_minus
id|LCS_CURR_NUM_MODELS
)paren
op_lshift
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_display_conf
id|lcs_display_conf
c_func
(paren
r_void
)paren
(brace
r_int
id|cu_idx
suffix:semicolon
id|lcs_model_info
op_star
id|model_info
suffix:semicolon
id|lcs_good_news
c_func
(paren
l_string|&quot;&bslash;nlcs configured to use %s statistics,&bslash;n&quot;
l_string|&quot;ip checksumming of received packets is %s.&bslash;n&quot;
l_string|&quot;autodetection is %s ignore sense is %s.&bslash;n&quot;
comma
(paren
id|use_hw_stats
ques
c_cond
l_string|&quot;hw&quot;
suffix:colon
l_string|&quot;sw&quot;
)paren
comma
(paren
id|checksum_received_ip_pkts
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
comma
(paren
id|noauto
ques
c_cond
l_string|&quot;off&quot;
suffix:colon
l_string|&quot;on&quot;
)paren
comma
(paren
id|ignore_sense
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
)paren
suffix:semicolon
id|lcs_good_news
c_func
(paren
l_string|&quot;configured to detect&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cu_idx
op_assign
l_int|0
suffix:semicolon
id|cu_idx
OL
id|LCS_MAX_NUM_MODELS
suffix:semicolon
id|cu_idx
op_increment
)paren
(brace
id|model_info
op_assign
id|lcs_get_model_info_by_idx
c_func
(paren
id|cu_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|model_info-&gt;max_rel_adapter_no
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
id|lcs_good_news
c_func
(paren
l_string|&quot;cu_model 0x%02X,%d rel_adapter(s)&bslash;n&quot;
comma
id|model_info-&gt;cu_model
comma
id|model_info-&gt;max_rel_adapter_no
)paren
suffix:semicolon
)brace
)brace
id|MODULE_AUTHOR
(paren
l_string|&quot;(C) 1999 IBM Corp. by DJ Barrow &lt;djbarrow@de.ibm.com,barrow_dj@yahoo.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux for S/390 Lan Channel Station Network Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MODULE_PARM
c_func
(paren
id|use_hw_stats
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|use_hw_stats
comma
l_string|&quot;Get network stats from LANSTAT lcs primitive as opposed to &quot;
l_string|&quot;doing it in software&bslash;n&quot;
l_string|&quot;this isn&squot;t used by MVS not recommended &quot;
l_string|&quot;&amp; dosen&squot;t appear to work usually&bslash;n&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|checksum_received_ip_pkts
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|checksum_received_ip_pkts
comma
l_string|&quot;Do ip checksumming on inbound packets&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|additional_model_info
comma
l_string|&quot;0-&quot;
id|LCS_ADDITIONAL_MODELS_X2_STR
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|additional_model_info
comma
l_string|&quot;This is made up of sets of model/max rel adapter no pairs&bslash;n&quot;
l_string|&quot;e.g. insmod additional_model_info=0x70,3 will look for &quot;
l_string|&quot;2 ports on a model 0x70.&bslash;n&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|devno_portno_pairs
comma
l_string|&quot;0-&quot;
id|LCS_MAX_FORCED_DEVNOS_X2_STR
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|devno_portno_pairs
comma
l_string|&quot;devno,rel_adapter_no pairs&bslash;n&quot;
l_string|&quot;rel adapter no of -1 indicates don&squot;t use this adapter.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|noauto
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|noauto
comma
l_string|&quot;set this equal to 1 if you want autodetection off, &quot;
l_string|&quot;this means you have&bslash;n&quot;
l_string|&quot;explicitly configure LCS devices with the &quot;
l_string|&quot;devno_portno_pairs module parameter&bslash;n.&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ignore_sense
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ignore_sense
comma
l_string|&quot;set this to 1 if you wish to ignore sense information &quot;
l_string|&quot;from the device layer for&bslash;n&quot;
l_string|&quot;non auto detected devices.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#else
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_static
r_int
id|__init
DECL|function|lcs_setup_models
id|lcs_setup_models
c_func
(paren
r_char
op_star
id|str
)paren
macro_line|#else
r_void
id|__init
id|lcs_setup_models
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
macro_line|#endif
(brace
r_int
id|max_parms
op_assign
id|LCS_MAX_NUM_PARMS
op_minus
(paren
id|LCS_CURR_NUM_MODELS
op_lshift
l_int|1
)paren
suffix:semicolon
r_int
id|num_new_models
suffix:semicolon
macro_line|#if  LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_int
id|ints
(braket
(paren
id|LCS_ADDITIONAL_MODELS
op_lshift
l_int|1
)paren
op_plus
l_int|1
)braket
suffix:semicolon
id|get_options
c_func
(paren
id|str
comma
(paren
id|LCS_ADDITIONAL_MODELS
op_lshift
l_int|1
)paren
comma
id|ints
)paren
suffix:semicolon
macro_line|#endif
id|num_new_models
op_assign
(paren
id|ints
(braket
l_int|0
)braket
op_minus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_new_models
OL
l_int|0
)paren
id|num_new_models
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|num_new_models
op_amp
l_int|1
)paren
id|num_new_models
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
id|num_new_models
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|1
op_logical_and
id|ints
(braket
l_int|0
)braket
op_le
id|max_parms
)paren
op_logical_and
id|num_new_models
op_ge
l_int|0
)paren
(brace
id|use_hw_stats
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_ge
l_int|2
)paren
id|checksum_received_ip_pkts
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|num_new_models
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|additional_model_info
(braket
l_int|0
)braket
comma
op_amp
id|ints
(braket
l_int|3
)braket
comma
id|num_new_models
op_star
r_sizeof
(paren
id|lcs_model_info
)paren
)paren
suffix:semicolon
)brace
id|lcs_display_conf
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_setup: incorrect number of arguments&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Usage: lcs=hw-stats,ip-checksumming,additional &quot;
l_string|&quot;cu model/max rel adapter no. pairs. &bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  The driver now auto detects how the card is &quot;
l_string|&quot;configured.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  e.g lcs=1,1,0x60,2&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  Will collect network stats from LANSTAT lcs &quot;
l_string|&quot;primitive as opposed&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  to doing it in software for ifconfig (this isn&squot;t &quot;
l_string|&quot;used by MVS &amp; doesn&squot;t&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  to be widely supported, ip checksum received &quot;
l_string|&quot;packets&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  and detect 0x3088 model 0x60 devices&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  will look for 2 ports per card associated with &quot;
l_string|&quot;this model.&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  The default is to use sw stats, with ip &quot;
l_string|&quot;checksumming off,&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  this improves performance, network hw uses &quot;
l_string|&quot;a crc32&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  ( crc64 for fddi ) which should be adequete to &quot;
l_string|&quot;gaurantee&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  integrity for normal use&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  however, financial institutions etc. may like &quot;
l_string|&quot;the additional&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  security of ip checksumming.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_return
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_static
r_int
id|__init
DECL|function|lcs_setup_devnos
id|lcs_setup_devnos
c_func
(paren
r_char
op_star
id|str
)paren
macro_line|#else
r_void
id|__init
id|lcs_setup_devnos
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
macro_line|#endif
(brace
r_int
id|fixed_devnos
suffix:semicolon
macro_line|#if  LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_int
id|ints
(braket
(paren
id|LCS_MAX_FORCED_DEVNOS
op_lshift
l_int|1
)paren
op_plus
l_int|1
)braket
suffix:semicolon
id|get_options
c_func
(paren
id|str
comma
(paren
id|LCS_MAX_FORCED_DEVNOS
op_lshift
l_int|1
)paren
comma
id|ints
)paren
suffix:semicolon
macro_line|#endif
id|fixed_devnos
op_assign
id|ints
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fixed_devnos
op_amp
l_int|1
)paren
op_eq
l_int|0
op_logical_and
id|fixed_devnos
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|devno_portno_pairs
comma
op_amp
id|ints
(braket
l_int|1
)braket
comma
r_sizeof
(paren
r_int
)paren
op_star
id|fixed_devnos
)paren
suffix:semicolon
)brace
r_else
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_setup: incorrect number of arguments&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;usage lcs_devno=devno,rel_adapter_no pairs&bslash;n&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot;rel adapter no of -1 indicates don&squot;t use this adapter.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_return
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_static
r_int
id|__init
DECL|function|lcs_noauto
id|lcs_noauto
c_func
(paren
r_char
op_star
id|str
)paren
macro_line|#else
r_void
id|__init
id|lcs_noauto
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
macro_line|#endif
(brace
id|noauto
op_assign
l_int|1
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_return
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_static
r_int
id|__init
DECL|function|lcs_ignore_sense
id|lcs_ignore_sense
c_func
(paren
r_char
op_star
id|str
)paren
macro_line|#else
r_void
id|__init
id|lcs_ignore_sense
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
macro_line|#endif
(brace
id|ignore_sense
op_assign
l_int|1
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
r_return
(paren
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,3,0)
id|__setup
c_func
(paren
l_string|&quot;lcs_devno=&quot;
comma
id|lcs_setup_devnos
)paren
suffix:semicolon
id|__setup
c_func
(paren
l_string|&quot;lcs=&quot;
comma
id|lcs_setup_models
)paren
suffix:semicolon
id|__setup
c_func
(paren
l_string|&quot;lcs_noauto&quot;
comma
id|lcs_noauto
)paren
suffix:semicolon
id|__setup
c_func
(paren
l_string|&quot;lcs_ignore_sense&quot;
comma
id|lcs_ignore_sense
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_static
id|lcs_inline
r_int
DECL|function|lcs_model_supported
id|lcs_model_supported
c_func
(paren
id|s390_dev_info_t
op_star
id|dev_info_ptr
comma
r_int
op_star
id|forced_rel_adapter_no
)paren
(brace
r_int
id|cu_idx
comma
id|dev_port_idx
suffix:semicolon
id|lcs_model_info
op_star
id|model_info
suffix:semicolon
id|lcs_dev_portno_pair
op_star
id|dev_portno
suffix:semicolon
op_star
id|forced_rel_adapter_no
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|dev_port_idx
op_assign
l_int|0
suffix:semicolon
id|dev_port_idx
OL
id|LCS_MAX_FORCED_DEVNOS
suffix:semicolon
id|dev_port_idx
op_increment
)paren
(brace
id|dev_portno
op_assign
op_amp
id|lcs_dev_portno
(braket
id|dev_port_idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev_portno-&gt;portno
op_eq
op_minus
l_int|2
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;   Check are we dealing with the device passed in as&n;&t;&t;   a parameter.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|dev_portno-&gt;devno
op_amp
l_int|0xfffe
)paren
op_eq
(paren
id|dev_info_ptr-&gt;devno
op_amp
l_int|0xfffe
)paren
)paren
(brace
multiline_comment|/* portno=-1 we want to ignore this device */
r_if
c_cond
(paren
id|dev_portno-&gt;portno
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_else
(brace
op_star
id|forced_rel_adapter_no
op_assign
id|dev_portno-&gt;portno
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|noauto
op_logical_and
op_star
id|forced_rel_adapter_no
op_eq
op_minus
l_int|1
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ignore_sense
)paren
r_return
(paren
op_star
id|forced_rel_adapter_no
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_info_ptr-&gt;sid_data.cu_type
op_ne
id|LCS_CUTYPE
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cu_idx
op_assign
l_int|0
suffix:semicolon
id|cu_idx
OL
id|LCS_MAX_NUM_MODELS
suffix:semicolon
id|cu_idx
op_increment
)paren
(brace
id|model_info
op_assign
id|lcs_get_model_info_by_idx
c_func
(paren
id|cu_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|model_info-&gt;max_rel_adapter_no
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|model_info-&gt;cu_model
op_eq
id|dev_info_ptr-&gt;sid_data.cu_model
)paren
(brace
r_if
c_cond
(paren
op_star
id|forced_rel_adapter_no
op_eq
op_minus
l_int|1
)paren
r_return
(paren
id|model_info-&gt;max_rel_adapter_no
)paren
suffix:semicolon
r_else
r_return
(paren
op_star
id|forced_rel_adapter_no
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* LCS_CHANDEV */
macro_line|#if !LCS_CHANDEV
r_void
DECL|function|lcs_unregister
id|lcs_unregister
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|u8
id|lan_type
)paren
(brace
r_if
c_cond
(paren
id|dev
)paren
(brace
r_switch
c_cond
(paren
id|lan_type
)paren
(brace
macro_line|#ifdef CONFIG_FDDI
r_case
id|lcs_fddi_type
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NET_ETHERNET
r_case
id|lcs_enet_type
suffix:colon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
r_case
id|lcs_token_ring_type
suffix:colon
id|unregister_trdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|lcs_bad_news
(paren
l_string|&quot;lcs_unregister attempt to unregister %p &quot;
l_string|&quot;unknown device type&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_MULTICAST
r_static
r_int
DECL|function|lcs_fix_multicast_list
id|lcs_fix_multicast_list
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
)paren
(brace
id|lcs_ipm_list
op_star
id|curr_lmem
suffix:semicolon
id|lcs_state
id|oldstate
suffix:semicolon
id|lcs_daemonize
c_func
(paren
l_string|&quot;lcs_fix_multi&quot;
comma
l_int|0
comma
id|TRUE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lcs_drvr_globals_valid
c_func
(paren
id|drvr_globals
)paren
)paren
r_goto
id|Done2
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals-&gt;up
op_eq
id|FALSE
)paren
r_goto
id|Done1
suffix:semicolon
id|oldstate
op_assign
id|drvr_globals-&gt;state
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|curr_lmem
op_assign
id|drvr_globals-&gt;ipm_list
suffix:semicolon
id|curr_lmem
suffix:semicolon
id|curr_lmem
op_assign
id|curr_lmem-&gt;next
)paren
(brace
r_switch
c_cond
(paren
id|curr_lmem-&gt;ipm_state
)paren
(brace
r_case
id|ipm_set_required
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcs_lancmd
(paren
id|lcs_setipm
comma
id|drvr_globals-&gt;rel_adapter_no
comma
id|drvr_globals
comma
l_int|1
comma
op_amp
id|curr_lmem-&gt;ipm
)paren
)paren
(brace
id|lcs_good_news
c_func
(paren
l_string|&quot;lcs_fix_multicast_list &quot;
l_string|&quot;failed to add multicast &quot;
l_string|&quot;entry %x multicast address &quot;
l_string|&quot;table possibly full.&bslash;n&quot;
comma
(paren
id|u32
)paren
id|curr_lmem-&gt;ipm.ip_addr
)paren
suffix:semicolon
)brace
r_else
id|curr_lmem-&gt;ipm_state
op_assign
id|ipm_on_card
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ipm_delete_required
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
id|lcs_lancmd
c_func
(paren
id|lcs_delipm
comma
id|drvr_globals-&gt;rel_adapter_no
comma
id|drvr_globals
comma
l_int|1
comma
op_amp
id|curr_lmem-&gt;ipm
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remove_from_list
c_func
(paren
(paren
id|list
op_star
op_star
)paren
op_amp
id|drvr_globals-&gt;ipm_list
comma
(paren
id|list
op_star
)paren
id|curr_lmem
)paren
)paren
id|kfree
c_func
(paren
id|curr_lmem
)paren
suffix:semicolon
r_else
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_fix_multicast_list &quot;
l_string|&quot;detected nonexistant entry&quot;
l_string|&quot; ipm_list=%p member %p&bslash;n&quot;
comma
id|drvr_globals-&gt;ipm_list
comma
id|curr_lmem
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ipm_on_card
suffix:colon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
id|drvr_globals-&gt;state
op_assign
id|oldstate
suffix:semicolon
r_if
c_cond
(paren
id|oldstate
op_eq
id|lcs_doing_io
op_logical_and
id|drvr_globals-&gt;dev
)paren
id|netif_wake_queue
c_func
(paren
id|drvr_globals-&gt;dev
)paren
suffix:semicolon
id|Done1
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;kernel_thread_lock
comma
l_int|1
)paren
suffix:semicolon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|Done2
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|lcs_get_mac_for_ipm
id|lcs_get_mac_for_ipm
c_func
(paren
id|__u32
id|ipm
comma
r_char
op_star
id|mac
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
macro_line|#ifdef CONFIG_TR
r_if
c_cond
(paren
id|dev-&gt;type
op_eq
id|ARPHRD_IEEE802_TR
)paren
id|ip_tr_mc_map
c_func
(paren
id|ipm
comma
id|mac
)paren
suffix:semicolon
r_else
macro_line|#endif
macro_line|#if defined(CONFIG_NET_ETHERNET) || defined (CONFIG_FDDI)
id|ip_eth_mc_map
c_func
(paren
id|ipm
comma
id|mac
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n;  Owing to a quirk in the osa microcode it is incompatible with its API&squot;s &n;  &amp; we can only add or delete a single ipm entry at a time.&n;  We are also called with the spin_lock_bh held meaning we in_interrupt is true&n;  to add &amp; delete multicast entries to get around this we indirectly start&n;  a kernel thread which executes the io commands necessary at a later&n;  time.&n;  We also need ip addresses for the setipm &amp; delipm primatives&n;  to do this we use lcs_get_mac_for_ipm.&n;  N.B. We even need to kmalloc GFP_ATOMIC here&n;&n; */
r_static
r_void
DECL|function|lcs_set_multicast_list
id|lcs_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
suffix:semicolon
r_struct
id|ip_mc_list
op_star
id|im4
suffix:semicolon
r_struct
id|in_device
op_star
id|in4_dev
suffix:semicolon
r_int
id|addr_in_list
suffix:semicolon
macro_line|#if 0&t;&t;&t;&t;/* LCS doesn&squot;t do IPV6 yet. */
r_struct
id|ifmcaddr6
op_star
id|im6
suffix:semicolon
r_struct
id|inet6_dev
op_star
id|in6_dev
suffix:semicolon
macro_line|#endif
r_char
id|buf
(braket
id|MAX_ADDR_LEN
)braket
suffix:semicolon
id|lcs_ipm_list
op_star
id|curr_lmem
comma
op_star
id|new_lmem
suffix:semicolon
id|lcs_state
id|oldstate
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|dev-&gt;priv
op_eq
l_int|NULL
)paren
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;invalid dev=%p in lcs_set_multicast_list&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|drvr_globals
op_assign
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|oldstate
op_assign
id|drvr_globals-&gt;state
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &gt;=KERNEL_VERSION(2,3,0)
r_if
c_cond
(paren
(paren
id|in4_dev
op_assign
id|in_dev_get
c_func
(paren
id|dev
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|in4_dev-&gt;lock
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
(paren
id|in4_dev
op_assign
id|dev-&gt;ip_ptr
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
macro_line|#endif
multiline_comment|/* Pass 1 find the entries to be deleted */
multiline_comment|/* This is done first to avoid overflowing the cards */
multiline_comment|/* onboard multicast list. */
id|spin_lock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|curr_lmem
op_assign
id|drvr_globals-&gt;ipm_list
suffix:semicolon
id|curr_lmem
suffix:semicolon
id|curr_lmem
op_assign
id|curr_lmem-&gt;next
)paren
(brace
id|addr_in_list
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|im4
op_assign
id|in4_dev-&gt;mc_list
suffix:semicolon
id|im4
suffix:semicolon
id|im4
op_assign
id|im4-&gt;next
)paren
(brace
id|lcs_get_mac_for_ipm
c_func
(paren
id|im4-&gt;multiaddr
comma
id|buf
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|memcmp
c_func
(paren
id|buf
comma
op_amp
id|curr_lmem-&gt;ipm.mac_address
comma
id|LCS_ADDR_LEN
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|curr_lmem-&gt;ipm.ip_addr
op_eq
id|im4-&gt;multiaddr
)paren
)paren
(brace
id|addr_in_list
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|addr_in_list
)paren
id|curr_lmem-&gt;ipm_state
op_assign
id|ipm_delete_required
suffix:semicolon
)brace
multiline_comment|/* Pass 2 find the new entries to be added */
r_for
c_loop
(paren
id|im4
op_assign
id|in4_dev-&gt;mc_list
suffix:semicolon
id|im4
suffix:semicolon
id|im4
op_assign
id|im4-&gt;next
)paren
(brace
id|lcs_get_mac_for_ipm
c_func
(paren
id|im4-&gt;multiaddr
comma
id|buf
comma
id|dev
)paren
suffix:semicolon
id|addr_in_list
op_assign
id|FALSE
suffix:semicolon
r_for
c_loop
(paren
id|curr_lmem
op_assign
id|drvr_globals-&gt;ipm_list
suffix:semicolon
id|curr_lmem
suffix:semicolon
id|curr_lmem
op_assign
id|curr_lmem-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|memcmp
(paren
id|buf
comma
op_amp
id|curr_lmem-&gt;ipm.mac_address
comma
id|LCS_ADDR_LEN
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|curr_lmem-&gt;ipm.ip_addr
op_eq
id|im4-&gt;multiaddr
)paren
)paren
(brace
id|addr_in_list
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|addr_in_list
)paren
(brace
id|new_lmem
op_assign
(paren
id|lcs_ipm_list
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|lcs_ipm_list
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_lmem
)paren
(brace
id|lcs_good_news
(paren
l_string|&quot;lcs_set_multicast_list failed to add &quot;
l_string|&quot;multicast entry %x not enough memory.&bslash;n&quot;
comma
(paren
id|u32
)paren
id|im4-&gt;multiaddr
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|memset
c_func
(paren
id|new_lmem
comma
l_int|0
comma
r_sizeof
(paren
id|lcs_ipm_list
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|new_lmem-&gt;ipm.mac_address
comma
id|buf
comma
id|LCS_ADDR_LEN
)paren
suffix:semicolon
id|new_lmem-&gt;ipm.ip_addr
op_assign
id|im4-&gt;multiaddr
suffix:semicolon
id|new_lmem-&gt;ipm_state
op_assign
id|ipm_set_required
suffix:semicolon
id|add_to_list
c_func
(paren
(paren
id|list
op_star
op_star
)paren
op_amp
id|drvr_globals-&gt;ipm_list
comma
(paren
id|list
op_star
)paren
id|new_lmem
)paren
suffix:semicolon
)brace
)brace
macro_line|#if LINUX_VERSION_CODE &gt;=KERNEL_VERSION(2,3,0)
id|read_unlock
c_func
(paren
op_amp
id|in4_dev-&gt;lock
)paren
suffix:semicolon
id|in_dev_put
c_func
(paren
id|in4_dev
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 0&t;&t;&t;&t;/* LCS doesn&squot;t do IPV6 yet */
r_if
c_cond
(paren
(paren
id|in6_dev
op_assign
id|in6_dev_get
c_func
(paren
id|dev
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|in6_dev-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im6
op_assign
id|in6_dev-&gt;mc_list
suffix:semicolon
id|im6
suffix:semicolon
id|im6
op_assign
id|im6-&gt;next
)paren
(brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|in4_dev-&gt;lock
)paren
suffix:semicolon
id|in6_dev_put
c_func
(paren
id|idev
)paren
suffix:semicolon
macro_line|#endif
id|done
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|drvr_globals-&gt;ipm_lock
)paren
suffix:semicolon
id|lcs_queue_thread
c_func
(paren
id|lcs_fix_multicast_list
comma
id|drvr_globals
)paren
suffix:semicolon
)brace
macro_line|#endif
r_static
r_void
DECL|function|lcs_set_slow_hw
id|lcs_set_slow_hw
c_func
(paren
id|lcs_drvr_globals
op_star
id|drvr_globals
comma
id|u16
id|cu_type
comma
id|u8
id|cu_model
)paren
(brace
id|drvr_globals-&gt;slow_hw
op_assign
(paren
(paren
id|cu_type
op_eq
l_int|0x3088
op_logical_and
(paren
id|cu_model
op_eq
l_int|0x8
op_logical_or
id|cu_model
op_eq
l_int|0x1f
)paren
)paren
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
)paren
suffix:semicolon
)brace
macro_line|#if LCS_DEBUG &amp;&amp; !LCS_PRINTK_DEBUG
r_static
r_void
DECL|function|lcs_debug_register
id|lcs_debug_register
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|lcs_id
op_eq
l_int|NULL
)paren
(brace
id|lcs_id
op_assign
id|debug_register
c_func
(paren
l_string|&quot;lcs&quot;
comma
l_int|1
comma
l_int|16
comma
l_int|16
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|lcs_id
comma
op_amp
id|debug_sprintf_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|lcs_id
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n; * The main device detection routine called  on bootup or module installation&n; * to do. An unfortunately unwieldly function which dosen&squot;t lend itself&n; * easily to being broken into smaller functional blocks &amp; my reason for&n; * hating tabs of 8. &n; */
macro_line|#if LCS_CHANDEV
r_static
r_int
DECL|function|lcs_probe
id|lcs_probe
c_func
(paren
id|chandev_probeinfo
op_star
id|probeinfo
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|lcs_write_globals
op_star
id|write
suffix:semicolon
id|lcs_read_globals
op_star
id|read
suffix:semicolon
id|u8
id|mac_address
(braket
id|LCS_ADDR_LEN
)braket
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|basename
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device
op_star
(paren
op_star
id|init_netdevfunc
)paren
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|sizeof_priv
)paren
op_assign
l_int|NULL
suffix:semicolon
r_void
(paren
op_star
id|unreg_netdevfunc
)paren
(paren
r_struct
id|net_device
op_star
id|dev
)paren
op_assign
l_int|NULL
suffix:semicolon
id|drvr_globals
op_assign
id|lcs_alloc_drvr_globals
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drvr_globals
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_probe kmalloc failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
id|read-&gt;subchannel
op_assign
id|probeinfo-&gt;read.irq
suffix:semicolon
id|write-&gt;subchannel
op_assign
id|probeinfo-&gt;write.irq
suffix:semicolon
id|read-&gt;devno
op_assign
id|probeinfo-&gt;read.devno
suffix:semicolon
id|write-&gt;devno
op_assign
id|probeinfo-&gt;write.devno
suffix:semicolon
id|lcs_set_slow_hw
c_func
(paren
id|drvr_globals
comma
id|probeinfo-&gt;read.cu_type
comma
id|probeinfo-&gt;read.cu_model
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcs_allocirq
c_func
(paren
id|read
)paren
op_logical_or
id|lcs_allocirq
c_func
(paren
id|write
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|Fail
suffix:semicolon
)brace
id|checksum_received_ip_pkts
op_assign
id|probeinfo-&gt;checksum_received_ip_pkts
suffix:semicolon
id|use_hw_stats
op_assign
id|probeinfo-&gt;use_hw_stats
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
comma
l_int|0
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_detect
c_func
(paren
id|drvr_globals
comma
(paren
id|probeinfo-&gt;device_forced
ques
c_cond
id|probeinfo
op_member_access_from_pointer
id|port_protocol_no
suffix:colon
op_minus
l_int|1
)paren
comma
id|probeinfo-&gt;hint_port_no
comma
id|probeinfo-&gt;max_port_no
comma
id|lcs_autodetect_type
comma
id|mac_address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|lcs_stopcard
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_goto
id|Fail
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*Fill in the fields of the device structure &n;&t;&t; * with interface specific values.&n;&t;&t; */
r_switch
c_cond
(paren
id|drvr_globals-&gt;lan_type
)paren
(brace
macro_line|#ifdef CONFIG_NET_ETHERNET
r_case
id|lcs_enet_type
suffix:colon
id|init_netdevfunc
op_assign
id|init_etherdev
suffix:semicolon
id|unreg_netdevfunc
op_assign
id|unregister_netdev
suffix:semicolon
id|basename
op_assign
l_string|&quot;eth&quot;
suffix:semicolon
id|drvr_globals-&gt;lan_type_trans
op_assign
id|eth_type_trans
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
r_case
id|lcs_token_ring_type
suffix:colon
id|init_netdevfunc
op_assign
id|init_trdev
suffix:semicolon
id|unreg_netdevfunc
op_assign
id|unregister_netdev
suffix:semicolon
id|basename
op_assign
l_string|&quot;tr&quot;
suffix:semicolon
id|drvr_globals-&gt;lan_type_trans
op_assign
id|tr_type_trans
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FDDI
r_case
id|lcs_fddi_type
suffix:colon
id|init_netdevfunc
op_assign
id|init_fddidev
suffix:semicolon
id|unreg_netdevfunc
op_assign
id|unregister_netdev
suffix:semicolon
id|basename
op_assign
l_string|&quot;fddi&quot;
suffix:semicolon
id|drvr_globals-&gt;lan_type_trans
op_assign
id|fddi_type_trans
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
id|probeinfo-&gt;memory_usage_in_k
op_assign
op_minus
(paren
(paren
(paren
id|LCS_READ_ALLOCSIZE
op_star
id|LCS_NUM_RX_BUFFS
)paren
op_plus
(paren
id|LCS_NUM_TX_BUFFS
op_star
id|LCS_IOBUFFSIZE
)paren
)paren
op_div
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|chandev_initnetdevice
c_func
(paren
id|probeinfo
comma
id|drvr_globals-&gt;rel_adapter_no
comma
l_int|NULL
comma
l_int|0
comma
id|basename
comma
id|init_netdevfunc
comma
id|unreg_netdevfunc
)paren
)paren
op_eq
l_int|0
)paren
r_goto
id|Fail
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|mac_address
comma
id|LCS_ADDR_LEN
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|lcs_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|lcs_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|lcs_txpacket
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|lcs_getstats
suffix:semicolon
id|drvr_globals-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;priv
op_assign
id|drvr_globals
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
id|dev-&gt;set_multicast_list
op_assign
(paren
id|lcs_check_multicast_supported
c_func
(paren
id|drvr_globals
)paren
ques
c_cond
id|lcs_set_multicast_list
suffix:colon
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
id|lcs_stopcard
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lcs_displayinfo
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lcs_debug_exception
c_func
(paren
l_int|0
comma
l_string|&quot;device structure=%p drvr globals=%p&bslash;n&quot;
l_string|&quot;read=%p write=%p&bslash;n&quot;
l_string|&quot;read_ccws=%p  write_cwws=%p&bslash;n&quot;
comma
id|dev
comma
id|drvr_globals
comma
id|drvr_globals-&gt;read
comma
id|drvr_globals-&gt;write
comma
op_amp
id|drvr_globals-&gt;read-&gt;ccw
(braket
l_int|0
)braket
comma
op_amp
id|drvr_globals-&gt;write-&gt;ccw
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|Fail
suffix:colon
r_if
c_cond
(paren
id|drvr_globals
)paren
(brace
id|lcs_freeallirqs
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
)brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;osa_probe error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#else
r_int
id|__init
DECL|function|lcs_probe
id|lcs_probe
c_func
(paren
r_void
)paren
(brace
r_int
id|read_irq
comma
id|write_irq
suffix:semicolon
id|s390_dev_info_t
id|read_devinfo
comma
id|write_devinfo
suffix:semicolon
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
l_int|NULL
suffix:semicolon
r_int
id|hint
comma
id|detect_error
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_int
id|max_rel_adapter_no
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|forced_rel_adapter_no
suffix:semicolon
r_int
id|lcs_loopcnt
op_assign
l_int|0
suffix:semicolon
id|u8
id|mac_address
(braket
id|LCS_ADDR_LEN
)braket
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|lcs_frame_type
id|lan_type
op_assign
id|lcs_autodetect_type
suffix:semicolon
id|lcs_write_globals
op_star
id|write
suffix:semicolon
id|lcs_read_globals
op_star
id|read
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|1
comma
l_string|&quot;Starting lcs_probe dev=%p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|read_irq
op_assign
id|get_irq_first
c_func
(paren
)paren
suffix:semicolon
id|read_irq
op_ge
l_int|0
suffix:semicolon
id|read_irq
op_assign
id|get_irq_next
c_func
(paren
id|read_irq
)paren
)paren
(brace
multiline_comment|/* check read channel&n;&t;&t; * we had to do the cu_model check also because ctc devices&n;&t;&t; * have the same cutype &amp; after asking some people&n;&t;&t; * the model numbers are given out pseudo randomly so&n;&t;&t; * we can&squot;t just take a range of them also the &n;&t;&t; * dev_type &amp; models are 0&n;&t;&t; */
id|lcs_loopcnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|lcs_loopcnt
OG
l_int|0x10000
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs probe detected infinite loop &quot;
l_string|&quot;bug in get_irq_next&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|Fail
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|get_dev_info_by_irq
c_func
(paren
id|read_irq
comma
op_amp
id|read_devinfo
)paren
)paren
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_probe get_dev_info_by_irq &quot;
l_string|&quot;reported err=%X on irq %d&bslash;n&quot;
l_string|&quot;should not happen&bslash;n&quot;
comma
id|err
comma
id|read_irq
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|read_devinfo.status
op_amp
id|DEVSTAT_DEVICE_OWNED
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|read_devinfo.devno
op_amp
l_int|1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|max_rel_adapter_no
op_assign
id|lcs_model_supported
c_func
(paren
op_amp
id|read_devinfo
comma
op_amp
id|forced_rel_adapter_no
)paren
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|get_dev_info_by_devno
(paren
id|read_devinfo.devno
op_plus
l_int|1
comma
op_amp
id|write_devinfo
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|write_devinfo.status
op_amp
id|DEVSTAT_DEVICE_OWNED
)paren
r_continue
suffix:semicolon
id|write_irq
op_assign
id|write_devinfo.irq
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ignore_sense
op_eq
id|FALSE
op_logical_and
id|forced_rel_adapter_no
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
(paren
id|write_devinfo.sid_data.cu_type
op_ne
id|read_devinfo.sid_data.cu_type
)paren
op_logical_or
(paren
id|write_devinfo.sid_data.cu_model
op_ne
id|read_devinfo.sid_data.cu_model
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|drvr_globals
op_eq
l_int|NULL
)paren
(brace
id|drvr_globals
op_assign
id|lcs_alloc_drvr_globals
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drvr_globals
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;lcs_probe kmalloc failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|read
op_assign
id|drvr_globals-&gt;read
suffix:semicolon
id|write
op_assign
id|drvr_globals-&gt;write
suffix:semicolon
id|read-&gt;subchannel
op_assign
id|read_irq
suffix:semicolon
id|write-&gt;subchannel
op_assign
id|write_irq
suffix:semicolon
id|read-&gt;devno
op_assign
id|read_devinfo.devno
suffix:semicolon
id|write-&gt;devno
op_assign
id|write_devinfo.devno
suffix:semicolon
id|lcs_set_slow_hw
c_func
(paren
id|drvr_globals
comma
id|read_devinfo.sid_data.cu_type
comma
id|read_devinfo.sid_data.cu_model
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcs_allocirq
c_func
(paren
id|read
)paren
op_logical_or
id|lcs_allocirq
c_func
(paren
id|write
)paren
)paren
(brace
id|lcs_freeallirqs
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
multiline_comment|/* We may find another card further up the chain */
)brace
r_else
(brace
r_if
c_cond
(paren
id|forced_rel_adapter_no
op_eq
op_minus
l_int|1
)paren
(brace
id|hint
op_assign
(paren
id|read_devinfo.devno
op_amp
l_int|0xFF
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* The card is possibly emulated e.g P/390 */
multiline_comment|/* or possibly configured to use a shared */
multiline_comment|/* port configured by osa-sf. */
r_if
c_cond
(paren
id|hint
OG
id|max_rel_adapter_no
)paren
(brace
id|hint
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|hint
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|detect_error
op_assign
id|lcs_detect
c_func
(paren
id|drvr_globals
comma
id|forced_rel_adapter_no
comma
id|hint
comma
id|max_rel_adapter_no
comma
id|lan_type
comma
id|mac_address
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|detect_error
)paren
(brace
id|lcs_stopcard
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|lcs_freeallirqs
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Fill in the fields of the device structure &n;&t;&t;&t;&t; * with interface specific values.&n;&t;&t;&t;&t; */
r_switch
c_cond
(paren
id|drvr_globals-&gt;lan_type
)paren
(brace
macro_line|#ifdef CONFIG_NET_ETHERNET
r_case
id|lcs_enet_type
suffix:colon
id|dev
op_assign
id|init_etherdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|drvr_globals-&gt;lan_type_trans
op_assign
id|eth_type_trans
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
r_case
id|lcs_token_ring_type
suffix:colon
id|dev
op_assign
id|init_trdev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|drvr_globals-&gt;lan_type_trans
op_assign
id|tr_type_trans
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FDDI
r_case
id|lcs_fddi_type
suffix:colon
multiline_comment|/* I&squot;m not sure whether this&n;&t;&t;&t;&t;&t; * function is &n;&t;&t;&t;&t;&t; * in the generic kernel anymore */
id|dev
op_assign
id|init_fddidev
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|drvr_globals-&gt;lan_type_trans
op_assign
id|fddi_type_trans
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|dev
)paren
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|mac_address
comma
id|LCS_ADDR_LEN
)paren
suffix:semicolon
r_else
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|Fail
suffix:semicolon
)brace
id|dev-&gt;open
op_assign
id|lcs_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|lcs_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|lcs_txpacket
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|lcs_getstats
suffix:semicolon
id|drvr_globals-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;priv
op_assign
id|drvr_globals
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
id|dev-&gt;set_multicast_list
op_assign
(paren
id|lcs_check_multicast_supported
c_func
(paren
id|drvr_globals
)paren
ques
c_cond
id|lcs_set_multicast_list
suffix:colon
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
id|lcs_stopcard
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lcs_displayinfo
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;device structure=%p &quot;
l_string|&quot;drvr globals=%p&bslash;n&quot;
l_string|&quot;read=%p write=%p&bslash;n&quot;
l_string|&quot;read_ccws=%p  write_cwws=%p&bslash;n&quot;
comma
id|dev
comma
id|drvr_globals
comma
id|drvr_globals-&gt;read
comma
id|drvr_globals-&gt;write
comma
op_amp
id|drvr_globals-&gt;read-&gt;ccw
(braket
l_int|0
)braket
comma
op_amp
id|drvr_globals-&gt;write-&gt;ccw
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
id|Fail
suffix:colon
r_if
c_cond
(paren
id|drvr_globals
)paren
(brace
id|lcs_freeallirqs
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
)brace
id|lcs_debug_event
c_func
(paren
l_int|2
comma
l_string|&quot;osa_probe error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if LCS_CHANDEV || MODULE
r_static
r_int
DECL|function|lcs_shutdown_card
id|lcs_shutdown_card
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
(paren
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
)paren
suffix:semicolon
macro_line|#if !LCS_CHANDEV
id|lcs_unregister
c_func
(paren
id|dev
comma
id|drvr_globals-&gt;lan_type
)paren
suffix:semicolon
multiline_comment|/* unregister_netdev calls close */
macro_line|#endif
id|lcs_freeallirqs
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|lcs_usage_free_drvr_globals
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if LCS_CHANDEV
r_static
r_void
DECL|function|lcs_msck_notification_func
id|lcs_msck_notification_func
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|msck_irq
comma
id|chandev_msck_status
id|prevstatus
comma
id|chandev_msck_status
id|newstatus
)paren
(brace
id|lcs_drvr_globals
op_star
id|drvr_globals
op_assign
(paren
id|lcs_drvr_globals
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|lcs_debug_event
c_func
(paren
l_int|0
comma
l_string|&quot;lcs_msck_notifcation_func drvr_globals=%p &quot;
l_string|&quot;msck_irq=%d prevstatus=%d newstatus=%d&quot;
comma
id|drvr_globals
comma
id|msck_irq
comma
id|prevstatus
comma
id|newstatus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drvr_globals
)paren
(brace
id|lcs_debug_exception
c_func
(paren
l_int|0
comma
l_string|&quot;lcs_msck_notification_func &quot;
l_string|&quot;drvr_globals=NULL&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|drvr_globals-&gt;state
op_eq
id|lcs_doing_io
)paren
(brace
r_if
c_cond
(paren
id|newstatus
op_eq
id|chandev_status_good
op_logical_or
id|newstatus
op_eq
id|chandev_status_all_chans_good
)paren
(brace
r_switch
c_cond
(paren
id|prevstatus
)paren
(brace
r_case
id|chandev_status_no_path
suffix:colon
r_case
id|chandev_status_gone
suffix:colon
r_case
id|chandev_status_not_oper
suffix:colon
r_if
c_cond
(paren
id|msck_irq
op_eq
id|drvr_globals-&gt;read-&gt;subchannel
)paren
id|lcs_restartreadio
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_else
id|lcs_restartwriteio
c_func
(paren
id|drvr_globals
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|msck_irq
op_eq
id|drvr_globals-&gt;write-&gt;subchannel
op_logical_and
id|newstatus
op_ne
id|chandev_status_revalidate
)paren
id|drvr_globals-&gt;write-&gt;chan_busy_state
op_assign
id|chan_dead
suffix:semicolon
)brace
r_else
multiline_comment|/* Allow lcs_detect loop a few more times */
id|atomic_set
c_func
(paren
op_amp
id|drvr_globals-&gt;retry_cnt
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if MODULE
r_static
r_void
DECL|function|lcs_cleanup
id|lcs_cleanup
c_func
(paren
r_void
)paren
(brace
macro_line|#if LCS_CHANDEV
id|chandev_unregister
c_func
(paren
id|lcs_probe
comma
id|TRUE
)paren
suffix:semicolon
macro_line|#else
r_while
c_loop
(paren
id|lcs_card_list
)paren
id|lcs_shutdown_card
c_func
(paren
id|lcs_card_list-&gt;dev
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#endif
macro_line|#if MODULE
r_int
DECL|function|init_module
id|init_module
c_func
(paren
r_void
)paren
macro_line|#else
macro_line|#if LINUX_VERSION_CODE &gt;=KERNEL_VERSION(2,3,0)
r_static
macro_line|#endif
r_int
id|__init
id|lcs_init
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
r_int
id|cardsfound
op_assign
l_int|0
suffix:semicolon
macro_line|#if MODULE &amp;&amp; LINUX_VERSION_CODE&gt;KERNEL_VERSION(2,4,5)
r_int
id|persist
op_assign
id|chandev_persist
c_func
(paren
id|chandev_type_lcs
)paren
suffix:semicolon
macro_line|#endif
r_static
r_char
id|initstr
(braket
)braket
op_assign
l_string|&quot;Starting lcs &quot;
macro_line|#ifdef MODULE
l_string|&quot;module &quot;
macro_line|#else
l_string|&quot;compiled into kernel &quot;
macro_line|#endif
l_string|&quot; $Revision: 1.128 $ $Date: 2002/03/01 16:56:47 $ &bslash;n&quot;
macro_line|#if LCS_CHANDEV
l_string|&quot;with&quot;
macro_line|#else
l_string|&quot;without&quot;
macro_line|#endif
l_string|&quot; chandev support,&quot;
macro_line|#ifdef CONFIG_IP_MULTICAST
l_string|&quot;with&quot;
macro_line|#else
l_string|&quot;without&quot;
macro_line|#endif
l_string|&quot; multicast support, &quot;
macro_line|#ifdef CONFIG_NET_ETHERNET
l_string|&quot;with&quot;
macro_line|#else
l_string|&quot;without&quot;
macro_line|#endif
l_string|&quot; ethernet support, &quot;
macro_line|#ifdef CONFIG_TR
l_string|&quot;with&quot;
macro_line|#else
l_string|&quot;without&quot;
macro_line|#endif
l_string|&quot; token ring support&quot;
macro_line|#if 0
l_string|&quot;, &quot;
macro_line|#ifdef CONFIG_FDDI
l_string|&quot;with&quot;
macro_line|#else
l_string|&quot;without&quot;
macro_line|#endif
l_string|&quot; fddi support&quot;
macro_line|#endif
l_string|&quot;.&bslash;n&quot;
suffix:semicolon
id|lcs_good_news
c_func
(paren
id|initstr
)paren
suffix:semicolon
macro_line|#if LCS_DEBUG &amp;&amp; !LCS_PRINTK_DEBUG
id|lcs_debug_register
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if LCS_CHANDEV
id|cardsfound
op_assign
id|chandev_register_and_probe
c_func
(paren
id|lcs_probe
comma
(paren
id|chandev_shutdownfunc
)paren
id|lcs_shutdown_card
comma
(paren
id|chandev_msck_notification_func
)paren
id|lcs_msck_notification_func
comma
id|chandev_type_lcs
)paren
suffix:semicolon
macro_line|#else
r_while
c_loop
(paren
(paren
id|lcs_probe
c_func
(paren
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|cardsfound
op_increment
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|cardsfound
op_le
l_int|0
)paren
(brace
id|lcs_bad_news
c_func
(paren
l_string|&quot;No lcs capable cards found&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if MODULE
macro_line|#if LINUX_VERSION_CODE&gt;KERNEL_VERSION(2,4,5)
r_if
c_cond
(paren
op_logical_neg
id|persist
)paren
macro_line|#endif
id|cleanup_module
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#if !LCS_CHANDEV
r_else
(brace
id|lcs_display_conf
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
(paren
id|cardsfound
ques
c_cond
l_int|0
suffix:colon
(paren
macro_line|#if MODULE &amp;&amp; LINUX_VERSION_CODE&gt;KERNEL_VERSION(2,4,5)
id|persist
ques
c_cond
l_int|0
suffix:colon
macro_line|#endif
op_minus
id|ENODEV
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Code for module loading &amp; unloading&n; */
macro_line|#ifdef MODULE
r_void
DECL|function|cleanup_module
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|lcs_good_news
c_func
(paren
l_string|&quot;Terminating lcs module.&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_cleanup
c_func
(paren
)paren
suffix:semicolon
macro_line|#if LCS_DEBUG &amp;&amp; !LCS_PRINTK_DEBUG
r_if
c_cond
(paren
id|lcs_id
)paren
(brace
id|debug_unregister_view
c_func
(paren
id|lcs_id
comma
op_amp
id|debug_sprintf_view
)paren
suffix:semicolon
id|debug_unregister
c_func
(paren
id|lcs_id
)paren
suffix:semicolon
id|lcs_id
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#else
macro_line|#if LINUX_VERSION_CODE&gt;=KERNEL_VERSION(2,2,18)
DECL|variable|lcs_init
id|__initcall
c_func
(paren
id|lcs_init
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
eof
