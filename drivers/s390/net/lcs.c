multiline_comment|/*&n; *  linux/drivers/s390/net/lcs.c&n; *&n; *  Linux for S/390 Lan Channel Station Network Driver&n; *&n; *  Copyright (C)  1999-2001 IBM Deutschland Entwicklung GmbH,&n; *&t;&t;&t;     IBM Corporation&n; *    Author(s): Original Code written by&n; *&t;&t;&t;  DJ Barrow (djbarrow@de.ibm.com,barrow_dj@yahoo.com)&n; *&t;&t; Rewritten by&n; *&t;&t;&t;  Frank Pavlic (pavlic@de.ibm.com) and&n; *&t;&t; &t;  Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; *&n; *    $Revision: 1.61 $&t; $Date: 2003/12/02 15:18:50 $&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&t; See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/if.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/trdevice.h&gt;
macro_line|#include &lt;linux/fddidevice.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/igmp.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/timex.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/ccwgroup.h&gt;
macro_line|#include &quot;lcs.h&quot;
macro_line|#include &quot;cu3088.h&quot;
macro_line|#if !defined(CONFIG_NET_ETHERNET) &amp;&amp; &bslash;&n;    !defined(CONFIG_TR) &amp;&amp; !defined(CONFIG_FDDI)
macro_line|#error Cannot compile lcs.c without some net devices switched on.
macro_line|#endif
multiline_comment|/**&n; * initialization string for output&n; */
DECL|macro|VERSION_LCS_C
mdefine_line|#define VERSION_LCS_C  &quot;$Revision: 1.61 $&quot;
DECL|variable|__initdata
r_static
r_char
id|version
(braket
)braket
id|__initdata
op_assign
l_string|&quot;LCS driver (&quot;
id|VERSION_LCS_C
l_string|&quot;/&quot;
id|VERSION_LCS_H
l_string|&quot;)&quot;
suffix:semicolon
multiline_comment|/**&n; * Some prototypes.&n; */
r_static
r_void
id|lcs_tasklet
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|lcs_start_kernel_thread
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
suffix:semicolon
r_static
r_void
id|lcs_get_frames_cb
c_func
(paren
r_struct
id|lcs_channel
op_star
comma
r_struct
id|lcs_buffer
op_star
)paren
suffix:semicolon
multiline_comment|/**&n; * Debug Facility Stuff&n; */
DECL|variable|lcs_dbf_setup
r_static
id|debug_info_t
op_star
id|lcs_dbf_setup
suffix:semicolon
DECL|variable|lcs_dbf_trace
r_static
id|debug_info_t
op_star
id|lcs_dbf_trace
suffix:semicolon
multiline_comment|/**&n; *  LCS Debug Facility functions&n; */
r_static
r_void
DECL|function|lcs_unregister_debug_facility
id|lcs_unregister_debug_facility
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|lcs_dbf_setup
)paren
id|debug_unregister
c_func
(paren
id|lcs_dbf_setup
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcs_dbf_trace
)paren
id|debug_unregister
c_func
(paren
id|lcs_dbf_trace
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_register_debug_facility
id|lcs_register_debug_facility
c_func
(paren
r_void
)paren
(brace
id|lcs_dbf_setup
op_assign
id|debug_register
c_func
(paren
l_string|&quot;lcs_setup&quot;
comma
l_int|1
comma
l_int|1
comma
l_int|8
)paren
suffix:semicolon
id|lcs_dbf_trace
op_assign
id|debug_register
c_func
(paren
l_string|&quot;lcs_trace&quot;
comma
l_int|1
comma
l_int|2
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcs_dbf_setup
op_eq
l_int|NULL
op_logical_or
id|lcs_dbf_trace
op_eq
l_int|NULL
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Not enough memory for debug facility.&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_unregister_debug_facility
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|debug_register_view
c_func
(paren
id|lcs_dbf_setup
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|lcs_dbf_setup
comma
l_int|5
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|lcs_dbf_trace
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|lcs_dbf_trace
comma
l_int|3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Allocate io buffers.&n; */
r_static
r_int
DECL|function|lcs_alloc_channel
id|lcs_alloc_channel
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;ichalloc&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
multiline_comment|/* alloc memory fo iobuffer */
id|channel-&gt;iob
(braket
id|cnt
)braket
dot
id|data
op_assign
(paren
r_void
op_star
)paren
id|kmalloc
c_func
(paren
id|LCS_IOBUFFERSIZE
comma
id|GFP_DMA
op_or
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;iob
(braket
id|cnt
)braket
dot
id|data
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|memset
c_func
(paren
id|channel-&gt;iob
(braket
id|cnt
)braket
dot
id|data
comma
l_int|0
comma
id|LCS_IOBUFFERSIZE
)paren
suffix:semicolon
id|channel-&gt;iob
(braket
id|cnt
)braket
dot
id|state
op_assign
id|BUF_STATE_EMPTY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
OL
id|LCS_NUM_BUFFS
)paren
(brace
multiline_comment|/* Not all io buffers could be allocated. */
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;echalloc&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
OG
l_int|0
)paren
id|kfree
c_func
(paren
id|channel-&gt;iob
(braket
id|cnt
)braket
dot
id|data
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Free io buffers.&n; */
r_static
r_void
DECL|function|lcs_free_channel
id|lcs_free_channel
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;ichfree&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
id|kfree
c_func
(paren
id|channel-&gt;iob
(braket
id|cnt
)braket
dot
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS alloc memory for card and channels&n; */
r_static
r_struct
id|lcs_card
op_star
DECL|function|lcs_alloc_card
id|lcs_alloc_card
c_func
(paren
r_void
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;alloclcs&quot;
)paren
suffix:semicolon
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|lcs_card
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|lcs_card
)paren
)paren
suffix:semicolon
id|card-&gt;lan_type
op_assign
id|LCS_FRAME_TYPE_AUTO
suffix:semicolon
id|card-&gt;lancmd_timeout
op_assign
id|LCS_LANCMD_TIMEOUT_DEFAULT
suffix:semicolon
r_return
id|card
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS free memory for card and channels.&n; */
r_static
r_void
DECL|function|lcs_free_card
id|lcs_free_card
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;remcard&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup read channel.&n; */
r_static
r_void
DECL|function|lcs_setup_read_ccws
id|lcs_setup_read_ccws
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;ireadccw&quot;
)paren
suffix:semicolon
multiline_comment|/* Setup read ccws. */
id|memset
c_func
(paren
id|card-&gt;read.ccws
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
op_star
(paren
id|LCS_NUM_BUFFS
op_plus
l_int|1
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|card-&gt;read.ccws
(braket
id|cnt
)braket
dot
id|cmd_code
op_assign
id|LCS_CCW_READ
suffix:semicolon
id|card-&gt;read.ccws
(braket
id|cnt
)braket
dot
id|count
op_assign
id|LCS_IOBUFFERSIZE
suffix:semicolon
id|card-&gt;read.ccws
(braket
id|cnt
)braket
dot
id|flags
op_assign
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_PCI
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Note: we have allocated the buffer with GFP_DMA, so&n;&t;&t; * we do not need to do set_normalized_cda.&n;&t;&t; */
id|card-&gt;read.ccws
(braket
id|cnt
)braket
dot
id|cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|card-&gt;read.iob
(braket
id|cnt
)braket
dot
id|data
)paren
suffix:semicolon
(paren
(paren
r_struct
id|lcs_header
op_star
)paren
id|card-&gt;read.iob
(braket
id|cnt
)braket
dot
id|data
)paren
op_member_access_from_pointer
id|offset
op_assign
id|LCS_ILLEGAL_OFFSET
suffix:semicolon
id|card-&gt;read.iob
(braket
id|cnt
)braket
dot
id|callback
op_assign
id|lcs_get_frames_cb
suffix:semicolon
id|card-&gt;read.iob
(braket
id|cnt
)braket
dot
id|state
op_assign
id|BUF_STATE_READY
suffix:semicolon
id|card-&gt;read.iob
(braket
id|cnt
)braket
dot
id|count
op_assign
id|LCS_IOBUFFERSIZE
suffix:semicolon
)brace
id|card-&gt;read.ccws
(braket
l_int|0
)braket
dot
id|flags
op_and_assign
op_complement
id|CCW_FLAG_PCI
suffix:semicolon
id|card-&gt;read.ccws
(braket
id|LCS_NUM_BUFFS
op_minus
l_int|1
)braket
dot
id|flags
op_and_assign
op_complement
id|CCW_FLAG_PCI
suffix:semicolon
id|card-&gt;read.ccws
(braket
id|LCS_NUM_BUFFS
op_minus
l_int|1
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_SUSPEND
suffix:semicolon
multiline_comment|/* Last ccw is a tic (transfer in channel). */
id|card-&gt;read.ccws
(braket
id|LCS_NUM_BUFFS
)braket
dot
id|cmd_code
op_assign
id|LCS_CCW_TRANSFER
suffix:semicolon
id|card-&gt;read.ccws
(braket
id|LCS_NUM_BUFFS
)braket
dot
id|cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|card-&gt;read.ccws
)paren
suffix:semicolon
multiline_comment|/* Setg initial state of the read channel. */
id|card-&gt;read.state
op_assign
id|CH_STATE_INIT
suffix:semicolon
id|card-&gt;read.io_idx
op_assign
l_int|0
suffix:semicolon
id|card-&gt;read.buf_idx
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_setup_read
id|lcs_setup_read
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;readirq&quot;
)paren
suffix:semicolon
multiline_comment|/* Allocate io buffers for the read channel. */
id|rc
op_assign
id|lcs_alloc_channel
c_func
(paren
op_amp
id|card-&gt;read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;iccwerr&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|lcs_setup_read_ccws
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* Initialize read channel tasklet. */
id|card-&gt;read.irq_tasklet.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|card-&gt;read
suffix:semicolon
id|card-&gt;read.irq_tasklet.func
op_assign
id|lcs_tasklet
suffix:semicolon
multiline_comment|/* Initialize waitqueue. */
id|init_waitqueue_head
c_func
(paren
op_amp
id|card-&gt;read.wait_q
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup write channel.&n; */
r_static
r_void
DECL|function|lcs_setup_write_ccws
id|lcs_setup_write_ccws
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|cnt
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;iwritccw&quot;
)paren
suffix:semicolon
multiline_comment|/* Setup write ccws. */
id|memset
c_func
(paren
id|card-&gt;write.ccws
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
op_star
id|LCS_NUM_BUFFS
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|0
suffix:semicolon
id|cnt
OL
id|LCS_NUM_BUFFS
suffix:semicolon
id|cnt
op_increment
)paren
(brace
id|card-&gt;write.ccws
(braket
id|cnt
)braket
dot
id|cmd_code
op_assign
id|LCS_CCW_WRITE
suffix:semicolon
id|card-&gt;write.ccws
(braket
id|cnt
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|card-&gt;write.ccws
(braket
id|cnt
)braket
dot
id|flags
op_assign
id|CCW_FLAG_SUSPEND
op_or
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_SLI
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Note: we have allocated the buffer with GFP_DMA, so&n;&t;&t; * we do not need to do set_normalized_cda.&n;&t;&t; */
id|card-&gt;write.ccws
(braket
id|cnt
)braket
dot
id|cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|card-&gt;write.iob
(braket
id|cnt
)braket
dot
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/* Last ccw is a tic (transfer in channel). */
id|card-&gt;write.ccws
(braket
id|LCS_NUM_BUFFS
)braket
dot
id|cmd_code
op_assign
id|LCS_CCW_TRANSFER
suffix:semicolon
id|card-&gt;write.ccws
(braket
id|LCS_NUM_BUFFS
)braket
dot
id|cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|card-&gt;write.ccws
)paren
suffix:semicolon
multiline_comment|/* Set initial state of the write channel. */
id|card-&gt;read.state
op_assign
id|CH_STATE_INIT
suffix:semicolon
id|card-&gt;write.io_idx
op_assign
l_int|0
suffix:semicolon
id|card-&gt;write.buf_idx
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_setup_write
id|lcs_setup_write
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;writeirq&quot;
)paren
suffix:semicolon
multiline_comment|/* Allocate io buffers for the write channel. */
id|rc
op_assign
id|lcs_alloc_channel
c_func
(paren
op_amp
id|card-&gt;write
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;iccwerr&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|lcs_setup_write_ccws
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* Initialize write channel tasklet. */
id|card-&gt;write.irq_tasklet.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|card-&gt;write
suffix:semicolon
id|card-&gt;write.irq_tasklet.func
op_assign
id|lcs_tasklet
suffix:semicolon
multiline_comment|/* Initialize waitqueue. */
id|init_waitqueue_head
c_func
(paren
op_amp
id|card-&gt;write.wait_q
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Cleanup channel.&n; */
r_static
r_void
DECL|function|lcs_cleanup_channel
id|lcs_cleanup_channel
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
)paren
(brace
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;cleanch&quot;
)paren
suffix:semicolon
multiline_comment|/* Kill write channel tasklets. */
id|tasklet_kill
c_func
(paren
op_amp
id|channel-&gt;irq_tasklet
)paren
suffix:semicolon
multiline_comment|/* Free channel buffers. */
id|lcs_free_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Initialize channels,card and state machines.&n; */
r_static
r_int
DECL|function|lcs_setup_card
id|lcs_setup_card
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;initcard&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_setup_read
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Could not initialize read channel&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|lcs_setup_write
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Could not initialize write channel&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_cleanup_channel
c_func
(paren
op_amp
id|card-&gt;read
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Set cards initial state. */
id|card-&gt;state
op_assign
id|DEV_STATE_DOWN
suffix:semicolon
id|card-&gt;tx_buffer
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;tx_emitted
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Initialize kernel thread task used for LGW commands. */
id|INIT_WORK
c_func
(paren
op_amp
id|card-&gt;kernel_thread_starter
comma
(paren
r_void
op_star
)paren
id|lcs_start_kernel_thread
comma
id|card
)paren
suffix:semicolon
id|card-&gt;thread_mask
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|card-&gt;ipm_list
)paren
suffix:semicolon
macro_line|#endif
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|card-&gt;lancmd_waiters
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Cleanup channels,card and state machines.&n; */
r_static
r_void
DECL|function|lcs_cleanup_card
id|lcs_cleanup_card
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
r_struct
id|lcs_ipm_list
op_star
id|ipm_list
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;cleancrd&quot;
)paren
suffix:semicolon
macro_line|#ifdef&t;CONFIG_IP_MULTICAST
multiline_comment|/* Free multicast list. */
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|card-&gt;ipm_list
)paren
(brace
id|ipm_list
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|lcs_ipm_list
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ipm_list-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ipm_list
)paren
suffix:semicolon
)brace
macro_line|#endif
id|kfree
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Cleanup channels. */
id|lcs_cleanup_channel
c_func
(paren
op_amp
id|card-&gt;write
)paren
suffix:semicolon
id|lcs_cleanup_channel
c_func
(paren
op_amp
id|card-&gt;read
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Start channel.&n; */
r_static
r_int
DECL|function|lcs_start_channel
id|lcs_start_channel
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
)paren
(brace
r_char
id|dbf_text
(braket
l_int|15
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;ssch%s&quot;
comma
id|channel-&gt;ccwdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|channel-&gt;ccwdev
comma
id|channel-&gt;ccws
op_plus
id|channel-&gt;io_idx
comma
l_int|0
comma
l_int|0
comma
id|DOIO_DENY_PREFETCH
op_or
id|DOIO_ALLOW_SUSPEND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|channel-&gt;state
op_assign
id|CH_STATE_RUNNING
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;essc%s&quot;
comma
id|channel-&gt;ccwdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Error in starting channel, rc=%d!&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * Stop channel.&n; */
r_static
r_int
DECL|function|lcs_stop_channel
id|lcs_stop_channel
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
)paren
(brace
r_char
id|dbf_text
(braket
l_int|15
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;state
op_eq
id|CH_STATE_STOPPED
)paren
r_return
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;hsch%s&quot;
comma
id|channel-&gt;ccwdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
id|channel-&gt;ccwdev
comma
(paren
id|addr_t
)paren
id|channel
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;ehsc%s&quot;
comma
id|channel-&gt;ccwdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Asynchronous halt initialted. Wait for its completion. */
id|wait_event
c_func
(paren
id|channel-&gt;wait_q
comma
(paren
id|channel-&gt;state
op_eq
id|CH_STATE_HALTED
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * start read and write channel&n; */
r_static
r_int
DECL|function|lcs_start_channels
id|lcs_start_channels
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;chstart&quot;
)paren
suffix:semicolon
multiline_comment|/* start read channel */
id|rc
op_assign
id|lcs_start_channel
c_func
(paren
op_amp
id|card-&gt;read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* start write channel */
id|rc
op_assign
id|lcs_start_channel
c_func
(paren
op_amp
id|card-&gt;write
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|lcs_stop_channel
c_func
(paren
op_amp
id|card-&gt;read
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * stop read and write channel&n; */
r_static
r_int
DECL|function|lcs_stop_channels
id|lcs_stop_channels
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;chhalt&quot;
)paren
suffix:semicolon
id|lcs_stop_channel
c_func
(paren
op_amp
id|card-&gt;read
)paren
suffix:semicolon
id|lcs_stop_channel
c_func
(paren
op_amp
id|card-&gt;write
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Get empty buffer.&n; */
r_static
r_struct
id|lcs_buffer
op_star
DECL|function|__lcs_get_buffer
id|__lcs_get_buffer
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
)paren
(brace
r_int
id|index
suffix:semicolon
id|index
op_assign
id|channel-&gt;io_idx
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|channel-&gt;iob
(braket
id|index
)braket
dot
id|state
op_eq
id|BUF_STATE_EMPTY
)paren
(brace
id|channel-&gt;iob
(braket
id|index
)braket
dot
id|state
op_assign
id|BUF_STATE_LOCKED
suffix:semicolon
r_return
id|channel-&gt;iob
op_plus
id|index
suffix:semicolon
)brace
id|index
op_assign
(paren
id|index
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|index
op_ne
id|channel-&gt;io_idx
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_struct
id|lcs_buffer
op_star
DECL|function|lcs_get_buffer
id|lcs_get_buffer
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|buffer
op_assign
id|__lcs_get_buffer
c_func
(paren
id|channel
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
multiline_comment|/**&n; * Resume channel program if the channel is suspended.&n; */
r_static
r_int
DECL|function|__lcs_resume_channel
id|__lcs_resume_channel
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
)paren
(brace
r_char
id|dbf_text
(braket
l_int|15
)braket
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;state
op_ne
id|CH_STATE_SUSPENDED
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;ccws
(braket
id|channel-&gt;io_idx
)braket
dot
id|flags
op_amp
id|CCW_FLAG_SUSPEND
)paren
r_return
l_int|0
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;rsch%s&quot;
comma
id|channel-&gt;ccwdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_resume
c_func
(paren
id|channel-&gt;ccwdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;ersc%s&quot;
comma
id|channel-&gt;ccwdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Error in lcs_resume_channel: rc=%d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
id|channel-&gt;state
op_assign
id|CH_STATE_RUNNING
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * Make a buffer ready for processing.&n; */
r_static
r_inline
r_void
DECL|function|__lcs_ready_buffer_bits
id|__lcs_ready_buffer_bits
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
comma
r_int
id|index
)paren
(brace
r_int
id|prev
comma
id|next
suffix:semicolon
id|prev
op_assign
(paren
id|index
op_minus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
id|next
op_assign
(paren
id|index
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Check if we may clear the suspend bit of this buffer. */
r_if
c_cond
(paren
id|channel-&gt;ccws
(braket
id|next
)braket
dot
id|flags
op_amp
id|CCW_FLAG_SUSPEND
)paren
(brace
multiline_comment|/* Check if we have to set the PCI bit. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|channel-&gt;ccws
(braket
id|prev
)braket
dot
id|flags
op_amp
id|CCW_FLAG_SUSPEND
)paren
)paren
multiline_comment|/* Suspend bit of the previous buffer is not set. */
id|channel-&gt;ccws
(braket
id|index
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_PCI
suffix:semicolon
multiline_comment|/* Suspend bit of the next buffer is set. */
id|channel-&gt;ccws
(braket
id|index
)braket
dot
id|flags
op_and_assign
op_complement
id|CCW_FLAG_SUSPEND
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|lcs_ready_buffer
id|lcs_ready_buffer
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
comma
r_struct
id|lcs_buffer
op_star
id|buffer
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|index
comma
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|buffer-&gt;state
op_ne
id|BUF_STATE_LOCKED
op_logical_and
id|buffer-&gt;state
op_ne
id|BUF_STATE_PROCESSED
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|buffer-&gt;state
op_assign
id|BUF_STATE_READY
suffix:semicolon
id|index
op_assign
id|buffer
op_minus
id|channel-&gt;iob
suffix:semicolon
multiline_comment|/* Set length. */
id|channel-&gt;ccws
(braket
id|index
)braket
dot
id|count
op_assign
id|buffer-&gt;count
suffix:semicolon
multiline_comment|/* Check relevant PCI/suspend bits. */
id|__lcs_ready_buffer_bits
c_func
(paren
id|channel
comma
id|index
)paren
suffix:semicolon
id|rc
op_assign
id|__lcs_resume_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * Mark the buffer as processed. Take care of the suspend bit&n; * of the previous buffer. This function is called from&n; * interrupt context, so the lock must not be taken.&n; */
r_static
r_int
DECL|function|__lcs_processed_buffer
id|__lcs_processed_buffer
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
comma
r_struct
id|lcs_buffer
op_star
id|buffer
)paren
(brace
r_int
id|index
comma
id|prev
comma
id|next
suffix:semicolon
r_if
c_cond
(paren
id|buffer-&gt;state
op_ne
id|BUF_STATE_READY
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|buffer-&gt;state
op_assign
id|BUF_STATE_PROCESSED
suffix:semicolon
id|index
op_assign
id|buffer
op_minus
id|channel-&gt;iob
suffix:semicolon
id|prev
op_assign
(paren
id|index
op_minus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
id|next
op_assign
(paren
id|index
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Set the suspend bit and clear the PCI bit of this buffer. */
id|channel-&gt;ccws
(braket
id|index
)braket
dot
id|flags
op_or_assign
id|CCW_FLAG_SUSPEND
suffix:semicolon
id|channel-&gt;ccws
(braket
id|index
)braket
dot
id|flags
op_and_assign
op_complement
id|CCW_FLAG_PCI
suffix:semicolon
multiline_comment|/* Check the suspend bit of the previous buffer. */
r_if
c_cond
(paren
id|channel-&gt;iob
(braket
id|prev
)braket
dot
id|state
op_eq
id|BUF_STATE_READY
)paren
(brace
multiline_comment|/*&n;&t;&t; * Previous buffer is in state ready. It might have&n;&t;&t; * happened in lcs_ready_buffer that the suspend bit&n;&t;&t; * has not been cleared to avoid an endless loop.&n;&t;&t; * Do it now.&n;&t;&t; */
id|__lcs_ready_buffer_bits
c_func
(paren
id|channel
comma
id|prev
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear PCI bit of next buffer. */
id|channel-&gt;ccws
(braket
id|next
)braket
dot
id|flags
op_and_assign
op_complement
id|CCW_FLAG_PCI
suffix:semicolon
r_return
id|__lcs_resume_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Put a processed buffer back to state empty.&n; */
r_static
r_void
DECL|function|lcs_release_buffer
id|lcs_release_buffer
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
comma
r_struct
id|lcs_buffer
op_star
id|buffer
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|buffer-&gt;state
op_ne
id|BUF_STATE_LOCKED
op_logical_and
id|buffer-&gt;state
op_ne
id|BUF_STATE_PROCESSED
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|buffer-&gt;state
op_assign
id|BUF_STATE_EMPTY
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Get buffer for a lan command.&n; */
r_static
r_struct
id|lcs_buffer
op_star
DECL|function|lcs_get_lancmd
id|lcs_get_lancmd
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_int
id|count
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
multiline_comment|/* Get buffer and wait if none is available. */
id|wait_event
c_func
(paren
id|card-&gt;write.wait_q
comma
(paren
(paren
id|buffer
op_assign
id|lcs_get_buffer
c_func
(paren
op_amp
id|card-&gt;write
)paren
)paren
op_ne
l_int|NULL
)paren
)paren
suffix:semicolon
id|count
op_add_assign
r_sizeof
(paren
r_struct
id|lcs_header
)paren
suffix:semicolon
op_star
(paren
id|__u16
op_star
)paren
(paren
id|buffer-&gt;data
op_plus
id|count
)paren
op_assign
l_int|0
suffix:semicolon
id|buffer-&gt;count
op_assign
id|count
op_plus
r_sizeof
(paren
id|__u16
)paren
suffix:semicolon
id|buffer-&gt;callback
op_assign
id|lcs_release_buffer
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;offset
op_assign
id|count
suffix:semicolon
id|cmd-&gt;type
op_assign
id|LCS_FRAME_TYPE_CONTROL
suffix:semicolon
id|cmd-&gt;slot
op_assign
l_int|0
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
multiline_comment|/**&n; * Notifier function for lancmd replies. Called from read irq.&n; */
r_static
r_void
DECL|function|lcs_notify_lancmd_waiters
id|lcs_notify_lancmd_waiters
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|lcs_cmd
op_star
id|cmd
)paren
(brace
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
r_struct
id|lcs_reply
op_star
id|reply
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|card-&gt;lancmd_waiters
)paren
(brace
id|reply
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|lcs_reply
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reply-&gt;sequence_no
op_eq
id|cmd-&gt;sequence_no
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|reply-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reply-&gt;callback
op_ne
l_int|NULL
)paren
id|reply
op_member_access_from_pointer
id|callback
c_func
(paren
id|card
comma
id|cmd
)paren
suffix:semicolon
id|reply-&gt;received
op_assign
l_int|1
suffix:semicolon
id|reply-&gt;rc
op_assign
id|cmd-&gt;return_code
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|reply-&gt;wait_q
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Emit buffer of a lan comand.&n; */
r_void
DECL|function|lcs_lancmd_timeout
id|lcs_lancmd_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|lcs_reply
op_star
id|reply
suffix:semicolon
id|reply
op_assign
(paren
r_struct
id|lcs_reply
op_star
)paren
id|data
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|reply-&gt;list
)paren
suffix:semicolon
id|reply-&gt;received
op_assign
l_int|1
suffix:semicolon
id|reply-&gt;rc
op_assign
op_minus
id|ETIME
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|reply-&gt;wait_q
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_send_lancmd
id|lcs_send_lancmd
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|lcs_buffer
op_star
id|buffer
comma
r_void
(paren
op_star
id|reply_callback
)paren
(paren
r_struct
id|lcs_card
op_star
comma
r_struct
id|lcs_cmd
op_star
)paren
)paren
(brace
r_struct
id|lcs_reply
id|reply
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
r_struct
id|timer_list
id|timer
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;sequence_no
op_assign
op_increment
id|card-&gt;sequence_no
suffix:semicolon
id|cmd-&gt;return_code
op_assign
l_int|0
suffix:semicolon
id|reply.sequence_no
op_assign
id|cmd-&gt;sequence_no
suffix:semicolon
id|reply.callback
op_assign
id|reply_callback
suffix:semicolon
id|reply.received
op_assign
l_int|0
suffix:semicolon
id|reply.rc
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|reply.wait_q
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|reply.list
comma
op_amp
id|card-&gt;lancmd_waiters
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|buffer-&gt;callback
op_assign
id|lcs_release_buffer
suffix:semicolon
id|rc
op_assign
id|lcs_ready_buffer
c_func
(paren
op_amp
id|card-&gt;write
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|timer.function
op_assign
id|lcs_lancmd_timeout
suffix:semicolon
id|timer.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|reply
suffix:semicolon
id|timer.expires
op_assign
id|jiffies
op_plus
id|HZ
op_star
id|card-&gt;lancmd_timeout
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|reply.wait_q
comma
id|reply.received
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
r_return
id|reply.rc
ques
c_cond
op_minus
id|EIO
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS startup command&n; */
r_static
r_int
DECL|function|lcs_send_startup
id|lcs_send_startup
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
id|__u8
id|initiator
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;startup&quot;
)paren
suffix:semicolon
id|buffer
op_assign
id|lcs_get_lancmd
c_func
(paren
id|card
comma
id|LCS_STD_CMD_SIZE
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;cmd_code
op_assign
id|LCS_CMD_STARTUP
suffix:semicolon
id|cmd-&gt;initiator
op_assign
id|initiator
suffix:semicolon
id|cmd-&gt;cmd.lcs_startup.buff_size
op_assign
id|LCS_IOBUFFERSIZE
suffix:semicolon
r_return
id|lcs_send_lancmd
c_func
(paren
id|card
comma
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS shutdown command&n; */
r_static
r_int
DECL|function|lcs_send_shutdown
id|lcs_send_shutdown
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;shutdown&quot;
)paren
suffix:semicolon
id|buffer
op_assign
id|lcs_get_lancmd
c_func
(paren
id|card
comma
id|LCS_STD_CMD_SIZE
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;cmd_code
op_assign
id|LCS_CMD_SHUTDOWN
suffix:semicolon
id|cmd-&gt;initiator
op_assign
id|LCS_INITIATOR_TCPIP
suffix:semicolon
r_return
id|lcs_send_lancmd
c_func
(paren
id|card
comma
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS lanstat command&n; */
r_static
r_void
DECL|function|__lcs_lanstat_cb
id|__lcs_lanstat_cb
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|lcs_cmd
op_star
id|cmd
)paren
(brace
id|memcpy
c_func
(paren
id|card-&gt;mac
comma
id|cmd-&gt;cmd.lcs_lanstat_cmd.mac_addr
comma
id|LCS_MAC_LENGTH
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_send_lanstat
id|lcs_send_lanstat
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;cmdstat&quot;
)paren
suffix:semicolon
id|buffer
op_assign
id|lcs_get_lancmd
c_func
(paren
id|card
comma
id|LCS_STD_CMD_SIZE
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
multiline_comment|/* Setup lanstat command. */
id|cmd-&gt;cmd_code
op_assign
id|LCS_CMD_LANSTAT
suffix:semicolon
id|cmd-&gt;initiator
op_assign
id|LCS_INITIATOR_TCPIP
suffix:semicolon
id|cmd-&gt;cmd.lcs_std_cmd.lan_type
op_assign
id|card-&gt;lan_type
suffix:semicolon
id|cmd-&gt;cmd.lcs_std_cmd.portno
op_assign
id|card-&gt;portno
suffix:semicolon
r_return
id|lcs_send_lancmd
c_func
(paren
id|card
comma
id|buffer
comma
id|__lcs_lanstat_cb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * send stoplan command&n; */
r_static
r_int
DECL|function|lcs_send_stoplan
id|lcs_send_stoplan
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
id|__u8
id|initiator
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;cmdstpln&quot;
)paren
suffix:semicolon
id|buffer
op_assign
id|lcs_get_lancmd
c_func
(paren
id|card
comma
id|LCS_STD_CMD_SIZE
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;cmd_code
op_assign
id|LCS_CMD_STOPLAN
suffix:semicolon
id|cmd-&gt;initiator
op_assign
id|initiator
suffix:semicolon
id|cmd-&gt;cmd.lcs_std_cmd.lan_type
op_assign
id|card-&gt;lan_type
suffix:semicolon
id|cmd-&gt;cmd.lcs_std_cmd.portno
op_assign
id|card-&gt;portno
suffix:semicolon
r_return
id|lcs_send_lancmd
c_func
(paren
id|card
comma
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * send startlan command&n; */
r_static
r_void
DECL|function|__lcs_send_startlan_cb
id|__lcs_send_startlan_cb
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|lcs_cmd
op_star
id|cmd
)paren
(brace
id|card-&gt;lan_type
op_assign
id|cmd-&gt;cmd.lcs_std_cmd.lan_type
suffix:semicolon
id|card-&gt;portno
op_assign
id|cmd-&gt;cmd.lcs_std_cmd.portno
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_send_startlan
id|lcs_send_startlan
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
id|__u8
id|initiator
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;cmdstpln&quot;
)paren
suffix:semicolon
id|buffer
op_assign
id|lcs_get_lancmd
c_func
(paren
id|card
comma
id|LCS_STD_CMD_SIZE
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;cmd_code
op_assign
id|LCS_CMD_STARTLAN
suffix:semicolon
id|cmd-&gt;initiator
op_assign
id|initiator
suffix:semicolon
id|cmd-&gt;cmd.lcs_std_cmd.lan_type
op_assign
id|card-&gt;lan_type
suffix:semicolon
id|cmd-&gt;cmd.lcs_std_cmd.portno
op_assign
id|card-&gt;portno
suffix:semicolon
r_return
id|lcs_send_lancmd
c_func
(paren
id|card
comma
id|buffer
comma
id|__lcs_send_startlan_cb
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IP_MULTICAST
multiline_comment|/**&n; * send setipm command (Multicast)&n; */
r_static
r_int
DECL|function|lcs_send_setipm
id|lcs_send_setipm
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|lcs_ipm_list
op_star
id|ipm_list
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;cmdsetim&quot;
)paren
suffix:semicolon
id|buffer
op_assign
id|lcs_get_lancmd
c_func
(paren
id|card
comma
id|LCS_MULTICAST_CMD_SIZE
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;cmd_code
op_assign
id|LCS_CMD_SETIPM
suffix:semicolon
id|cmd-&gt;initiator
op_assign
id|LCS_INITIATOR_TCPIP
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.lan_type
op_assign
id|card-&gt;lan_type
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.portno
op_assign
id|card-&gt;portno
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.version
op_assign
l_int|4
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.num_ip_pairs
op_assign
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;cmd.lcs_qipassist.lcs_ipass_ctlmsg.ip_mac_pair
comma
op_amp
id|ipm_list-&gt;ipm
comma
r_sizeof
(paren
r_struct
id|lcs_ip_mac_pair
)paren
)paren
suffix:semicolon
r_return
id|lcs_send_lancmd
c_func
(paren
id|card
comma
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * send delipm command (Multicast)&n; */
r_static
r_int
DECL|function|lcs_send_delipm
id|lcs_send_delipm
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|lcs_ipm_list
op_star
id|ipm_list
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;cmddelim&quot;
)paren
suffix:semicolon
id|buffer
op_assign
id|lcs_get_lancmd
c_func
(paren
id|card
comma
id|LCS_MULTICAST_CMD_SIZE
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;cmd_code
op_assign
id|LCS_CMD_DELIPM
suffix:semicolon
id|cmd-&gt;initiator
op_assign
id|LCS_INITIATOR_TCPIP
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.lan_type
op_assign
id|card-&gt;lan_type
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.portno
op_assign
id|card-&gt;portno
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.version
op_assign
l_int|4
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.num_ip_pairs
op_assign
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;cmd.lcs_qipassist.lcs_ipass_ctlmsg.ip_mac_pair
comma
op_amp
id|ipm_list-&gt;ipm
comma
r_sizeof
(paren
r_struct
id|lcs_ip_mac_pair
)paren
)paren
suffix:semicolon
r_return
id|lcs_send_lancmd
c_func
(paren
id|card
comma
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * check if multicast is supported by LCS&n; */
r_static
r_void
DECL|function|__lcs_check_multicast_cb
id|__lcs_check_multicast_cb
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|lcs_cmd
op_star
id|cmd
)paren
(brace
id|card-&gt;ip_assists_supported
op_assign
id|cmd-&gt;cmd.lcs_qipassist.ip_assists_supported
suffix:semicolon
id|card-&gt;ip_assists_enabled
op_assign
id|cmd-&gt;cmd.lcs_qipassist.ip_assists_enabled
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_check_multicast_support
id|lcs_check_multicast_support
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_struct
id|lcs_buffer
op_star
id|buffer
suffix:semicolon
r_struct
id|lcs_cmd
op_star
id|cmd
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;cmdqipa&quot;
)paren
suffix:semicolon
multiline_comment|/* Send query ipassist. */
id|buffer
op_assign
id|lcs_get_lancmd
c_func
(paren
id|card
comma
id|LCS_STD_CMD_SIZE
)paren
suffix:semicolon
id|cmd
op_assign
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
id|cmd-&gt;cmd_code
op_assign
id|LCS_CMD_QIPASSIST
suffix:semicolon
id|cmd-&gt;initiator
op_assign
id|LCS_INITIATOR_TCPIP
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.lan_type
op_assign
id|card-&gt;lan_type
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.portno
op_assign
id|card-&gt;portno
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.version
op_assign
l_int|4
suffix:semicolon
id|cmd-&gt;cmd.lcs_qipassist.num_ip_pairs
op_assign
l_int|1
suffix:semicolon
id|rc
op_assign
id|lcs_send_lancmd
c_func
(paren
id|card
comma
id|buffer
comma
id|__lcs_check_multicast_cb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Query IPAssist failed. Assuming unsupported!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/* Print out supported assists: IPv6 */
id|PRINT_INFO
c_func
(paren
l_string|&quot;LCS device %s %s IPv6 support&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
comma
(paren
id|card-&gt;ip_assists_supported
op_amp
id|LCS_IPASS_IPV6_SUPPORT
)paren
ques
c_cond
l_string|&quot;with&quot;
suffix:colon
l_string|&quot;without&quot;
)paren
suffix:semicolon
multiline_comment|/* Print out supported assist: Multicast */
id|PRINT_INFO
c_func
(paren
l_string|&quot;LCS device %s %s Multicast support&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
comma
(paren
id|card-&gt;ip_assists_supported
op_amp
id|LCS_IPASS_MULTICAST_SUPPORT
)paren
ques
c_cond
l_string|&quot;with&quot;
suffix:colon
l_string|&quot;without&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ip_assists_supported
op_amp
id|LCS_IPASS_MULTICAST_SUPPORT
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
multiline_comment|/**&n; * set or del multicast address on LCS card&n; */
r_static
r_int
DECL|function|lcs_fix_multicast_list
id|lcs_fix_multicast_list
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
r_struct
id|lcs_ipm_list
op_star
id|ipm
suffix:semicolon
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|data
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;fixipm&quot;
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|5
comma
id|trace
comma
l_string|&quot;fixipm&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|card-&gt;ipm_list
)paren
(brace
id|ipm
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|lcs_ipm_list
comma
id|list
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ipm-&gt;ipm_state
)paren
(brace
r_case
id|LCS_IPM_STATE_SET_REQUIRED
suffix:colon
r_if
c_cond
(paren
id|lcs_send_setipm
c_func
(paren
id|card
comma
id|ipm
)paren
)paren
id|PRINT_INFO
c_func
(paren
l_string|&quot;Adding multicast address failed.&quot;
l_string|&quot;Table possibly full!&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|ipm-&gt;ipm_state
op_assign
id|LCS_IPM_STATE_ON_CARD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCS_IPM_STATE_DEL_REQUIRED
suffix:colon
id|lcs_send_delipm
c_func
(paren
id|card
comma
id|ipm
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|ipm-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ipm
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCS_IPM_STATE_ON_CARD
suffix:colon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|card-&gt;state
op_eq
id|DEV_STATE_UP
)paren
id|netif_wake_queue
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * get mac address for the relevant Multicast address&n; */
r_static
r_void
DECL|function|lcs_get_mac_for_ipm
id|lcs_get_mac_for_ipm
c_func
(paren
id|__u32
id|ipm
comma
r_char
op_star
id|mac
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;type
op_eq
id|ARPHRD_IEEE802_TR
)paren
id|ip_tr_mc_map
c_func
(paren
id|ipm
comma
id|mac
)paren
suffix:semicolon
r_else
id|ip_eth_mc_map
c_func
(paren
id|ipm
comma
id|mac
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * function called by net device to handle multicast address relevant things&n; */
r_static
r_void
DECL|function|lcs_set_multicast_list
id|lcs_set_multicast_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_char
id|buf
(braket
id|MAX_ADDR_LEN
)braket
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|ip_mc_list
op_star
id|im4
suffix:semicolon
r_struct
id|in_device
op_star
id|in4_dev
suffix:semicolon
r_struct
id|lcs_ipm_list
op_star
id|ipm
comma
op_star
id|tmp
suffix:semicolon
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|5
comma
id|trace
comma
l_string|&quot;setmulti&quot;
)paren
suffix:semicolon
id|in4_dev
op_assign
id|in_dev_get
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in4_dev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|in4_dev-&gt;lock
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Check for multicast addresses to be removed. */
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|card-&gt;ipm_list
)paren
(brace
id|ipm
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|lcs_ipm_list
comma
id|list
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im4
op_assign
id|in4_dev-&gt;mc_list
suffix:semicolon
id|im4
op_ne
l_int|NULL
suffix:semicolon
id|im4
op_assign
id|im4-&gt;next
)paren
(brace
id|lcs_get_mac_for_ipm
c_func
(paren
id|im4-&gt;multiaddr
comma
id|buf
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|buf
comma
op_amp
id|ipm-&gt;ipm.mac_addr
comma
id|LCS_MAC_LENGTH
)paren
op_eq
l_int|0
op_logical_and
id|ipm-&gt;ipm.ip_addr
op_eq
id|im4-&gt;multiaddr
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|im4
op_eq
l_int|NULL
)paren
id|ipm-&gt;ipm_state
op_assign
id|LCS_IPM_STATE_DEL_REQUIRED
suffix:semicolon
)brace
multiline_comment|/* Check for multicast addresses to be added. */
r_for
c_loop
(paren
id|im4
op_assign
id|in4_dev-&gt;mc_list
suffix:semicolon
id|im4
suffix:semicolon
id|im4
op_assign
id|im4-&gt;next
)paren
(brace
id|lcs_get_mac_for_ipm
c_func
(paren
id|im4-&gt;multiaddr
comma
id|buf
comma
id|dev
)paren
suffix:semicolon
id|ipm
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|card-&gt;ipm_list
)paren
(brace
id|tmp
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|lcs_ipm_list
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|buf
comma
op_amp
id|tmp-&gt;ipm.mac_addr
comma
id|LCS_MAC_LENGTH
)paren
op_eq
l_int|0
op_logical_and
id|tmp-&gt;ipm.ip_addr
op_eq
id|im4-&gt;multiaddr
)paren
(brace
id|ipm
op_assign
id|tmp
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ipm
op_ne
l_int|NULL
)paren
r_continue
suffix:semicolon
multiline_comment|/* Address already in list. */
id|ipm
op_assign
(paren
r_struct
id|lcs_ipm_list
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|lcs_ipm_list
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipm
op_eq
l_int|NULL
)paren
(brace
id|PRINT_INFO
c_func
(paren
l_string|&quot;Not enough memory to add &quot;
l_string|&quot;new multicast entry!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ipm
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|lcs_ipm_list
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ipm-&gt;ipm.mac_addr
comma
id|buf
comma
id|LCS_MAC_LENGTH
)paren
suffix:semicolon
id|ipm-&gt;ipm.ip_addr
op_assign
id|im4-&gt;multiaddr
suffix:semicolon
id|ipm-&gt;ipm_state
op_assign
id|LCS_IPM_STATE_SET_REQUIRED
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|ipm-&gt;list
comma
op_amp
id|card-&gt;ipm_list
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|in4_dev-&gt;lock
)paren
suffix:semicolon
id|set_bit
c_func
(paren
l_int|3
comma
op_amp
id|card-&gt;thread_mask
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|card-&gt;kernel_thread_starter
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_IP_MULTICAST */
multiline_comment|/**&n; * IRQ Handler for LCS channels&n; */
r_static
r_void
DECL|function|lcs_irq
id|lcs_irq
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
r_int
id|intparm
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_char
id|dbf_text
(braket
l_int|15
)braket
suffix:semicolon
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_struct
id|lcs_channel
op_star
id|channel
suffix:semicolon
r_int
id|index
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|cdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;read.ccwdev
op_eq
id|cdev
)paren
id|channel
op_assign
op_amp
id|card-&gt;read
suffix:semicolon
r_else
id|channel
op_assign
op_amp
id|card-&gt;write
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;Rint%s&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|5
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;%4x%4x&quot;
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.dstat
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|5
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
multiline_comment|/* How far in the ccw chain have we processed? */
r_if
c_cond
(paren
id|channel-&gt;state
op_ne
id|CH_STATE_INIT
)paren
(brace
id|index
op_assign
(paren
r_struct
id|ccw1
op_star
)paren
id|__va
c_func
(paren
(paren
id|addr_t
)paren
id|irb-&gt;scsw.cpa
)paren
op_minus
id|channel-&gt;ccws
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.actl
op_amp
id|SCSW_ACTL_SUSPENDED
)paren
op_logical_or
(paren
id|irb-&gt;scsw.cstat
op_or
id|SCHN_STAT_PCI
)paren
)paren
multiline_comment|/* Bloody io subsystem tells us lies about cpa... */
id|index
op_assign
(paren
id|index
op_minus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|channel-&gt;io_idx
op_ne
id|index
)paren
(brace
id|__lcs_processed_buffer
c_func
(paren
id|channel
comma
id|channel-&gt;iob
op_plus
id|channel-&gt;io_idx
)paren
suffix:semicolon
id|channel-&gt;io_idx
op_assign
(paren
id|channel-&gt;io_idx
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_DEV_END
)paren
op_logical_or
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_CHN_END
)paren
op_logical_or
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
)paren
multiline_comment|/* Mark channel as stopped. */
id|channel-&gt;state
op_assign
id|CH_STATE_STOPPED
suffix:semicolon
r_else
r_if
c_cond
(paren
id|irb-&gt;scsw.actl
op_amp
id|SCSW_ACTL_SUSPENDED
)paren
multiline_comment|/* CCW execution stopped on a suspend bit. */
id|channel-&gt;state
op_assign
id|CH_STATE_SUSPENDED
suffix:semicolon
r_if
c_cond
(paren
id|irb-&gt;scsw.fctl
op_amp
id|SCSW_FCTL_HALT_FUNC
)paren
multiline_comment|/* The channel has been stopped by halt_IO. */
id|channel-&gt;state
op_assign
id|CH_STATE_HALTED
suffix:semicolon
multiline_comment|/* Do the rest in the tasklet. */
id|tasklet_schedule
c_func
(paren
op_amp
id|channel-&gt;irq_tasklet
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Tasklet for IRQ handler&n; */
r_static
r_void
DECL|function|lcs_tasklet
id|lcs_tasklet
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_char
id|dbf_text
(braket
l_int|15
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|lcs_channel
op_star
id|channel
suffix:semicolon
r_struct
id|lcs_buffer
op_star
id|iob
suffix:semicolon
r_int
id|buf_idx
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|channel
op_assign
(paren
r_struct
id|lcs_channel
op_star
)paren
id|data
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_text
comma
l_string|&quot;tlet%s&quot;
comma
id|channel-&gt;ccwdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|5
comma
id|trace
comma
id|dbf_text
)paren
suffix:semicolon
multiline_comment|/* Check for processed buffers. */
id|iob
op_assign
id|channel-&gt;iob
suffix:semicolon
id|buf_idx
op_assign
id|channel-&gt;buf_idx
suffix:semicolon
r_while
c_loop
(paren
id|iob
(braket
id|buf_idx
)braket
dot
id|state
op_eq
id|BUF_STATE_PROCESSED
)paren
(brace
multiline_comment|/* Do the callback thing. */
r_if
c_cond
(paren
id|iob
(braket
id|buf_idx
)braket
dot
id|callback
op_ne
l_int|NULL
)paren
id|iob
(braket
id|buf_idx
)braket
dot
id|callback
c_func
(paren
id|channel
comma
id|iob
op_plus
id|buf_idx
)paren
suffix:semicolon
id|buf_idx
op_assign
(paren
id|buf_idx
op_plus
l_int|1
)paren
op_amp
(paren
id|LCS_NUM_BUFFS
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|channel-&gt;buf_idx
op_assign
id|buf_idx
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;state
op_eq
id|CH_STATE_STOPPED
)paren
singleline_comment|// FIXME: what if rc != 0 ??
id|rc
op_assign
id|lcs_start_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel-&gt;state
op_eq
id|CH_STATE_SUSPENDED
op_logical_and
id|channel-&gt;iob
(braket
id|channel-&gt;io_idx
)braket
dot
id|state
op_eq
id|BUF_STATE_READY
)paren
(brace
singleline_comment|// FIXME: what if rc != 0 ??
id|rc
op_assign
id|__lcs_resume_channel
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|channel-&gt;ccwdev
)paren
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Something happened on the channel. Wake up waiters. */
id|wake_up
c_func
(paren
op_amp
id|channel-&gt;wait_q
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Finish current tx buffer and make it ready for transmit.&n; */
r_static
r_void
DECL|function|__lcs_emit_txbuffer
id|__lcs_emit_txbuffer
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
op_star
(paren
id|__u16
op_star
)paren
(paren
id|card-&gt;tx_buffer-&gt;data
op_plus
id|card-&gt;tx_buffer-&gt;count
)paren
op_assign
l_int|0
suffix:semicolon
id|card-&gt;tx_buffer-&gt;count
op_add_assign
l_int|2
suffix:semicolon
id|lcs_ready_buffer
c_func
(paren
op_amp
id|card-&gt;write
comma
id|card-&gt;tx_buffer
)paren
suffix:semicolon
id|card-&gt;tx_buffer
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;tx_emitted
op_increment
suffix:semicolon
)brace
multiline_comment|/**&n; * Callback for finished tx buffers.&n; */
r_static
r_void
DECL|function|lcs_txbuffer_cb
id|lcs_txbuffer_cb
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
comma
r_struct
id|lcs_buffer
op_star
id|buffer
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
multiline_comment|/* Put buffer back to pool. */
id|lcs_release_buffer
c_func
(paren
id|channel
comma
id|buffer
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|channel
op_minus
m_offsetof
(paren
r_struct
id|lcs_card
comma
id|write
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|card-&gt;tx_emitted
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tx_emitted
op_le
l_int|0
op_logical_and
id|card-&gt;tx_buffer
op_ne
l_int|NULL
)paren
multiline_comment|/*&n;&t;&t; * Last running tx buffer has finished. Submit partially&n;&t;&t; * filled current buffer.&n;&t;&t; */
id|__lcs_emit_txbuffer
c_func
(paren
id|card
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Packet transmit function called by network stack&n; */
r_static
r_int
DECL|function|__lcs_start_xmit
id|__lcs_start_xmit
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lcs_header
op_star
id|header
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|card-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|card-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;state
op_ne
id|DEV_STATE_UP
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|card-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|card-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|card-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
(brace
id|card-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|card-&gt;tx_buffer
op_ne
l_int|NULL
op_logical_and
id|card-&gt;tx_buffer-&gt;count
op_plus
r_sizeof
(paren
r_struct
id|lcs_header
)paren
op_plus
id|skb-&gt;len
op_plus
r_sizeof
(paren
id|u16
)paren
OG
id|LCS_IOBUFFERSIZE
)paren
multiline_comment|/* skb too big for current tx buffer. */
id|__lcs_emit_txbuffer
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tx_buffer
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Get new tx buffer */
id|card-&gt;tx_buffer
op_assign
id|lcs_get_buffer
c_func
(paren
op_amp
id|card-&gt;write
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tx_buffer
op_eq
l_int|NULL
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|card-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|card-&gt;tx_buffer-&gt;callback
op_assign
id|lcs_txbuffer_cb
suffix:semicolon
id|card-&gt;tx_buffer-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
id|header
op_assign
(paren
r_struct
id|lcs_header
op_star
)paren
(paren
id|card-&gt;tx_buffer-&gt;data
op_plus
id|card-&gt;tx_buffer-&gt;count
)paren
suffix:semicolon
id|card-&gt;tx_buffer-&gt;count
op_add_assign
id|skb-&gt;len
op_plus
r_sizeof
(paren
r_struct
id|lcs_header
)paren
suffix:semicolon
id|header-&gt;offset
op_assign
id|card-&gt;tx_buffer-&gt;count
suffix:semicolon
id|header-&gt;type
op_assign
id|card-&gt;lan_type
suffix:semicolon
id|header-&gt;slot
op_assign
id|card-&gt;portno
suffix:semicolon
id|memcpy
c_func
(paren
id|header
op_plus
l_int|1
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|card-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|card-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;tx_emitted
op_le
l_int|0
)paren
multiline_comment|/* If this is the first tx buffer emit it immediately. */
id|__lcs_emit_txbuffer
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_start_xmit
id|lcs_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|5
comma
id|trace
comma
l_string|&quot;pktxmit&quot;
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|rc
op_assign
id|__lcs_start_xmit
c_func
(paren
id|card
comma
id|skb
comma
id|dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * send startlan and lanstat command to make LCS device ready&n; */
r_static
r_int
DECL|function|lcs_startlan_auto
id|lcs_startlan_auto
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|rc
suffix:semicolon
macro_line|#ifdef CONFIG_NET_ETHERNET
id|card-&gt;lan_type
op_assign
id|LCS_FRAME_TYPE_ENET
suffix:semicolon
id|rc
op_assign
id|lcs_send_startlan
c_func
(paren
id|card
comma
id|LCS_INITIATOR_TCPIP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
id|card-&gt;lan_type
op_assign
id|LCS_FRAME_TYPE_TR
suffix:semicolon
id|rc
op_assign
id|lcs_send_startlan
c_func
(paren
id|card
comma
id|LCS_INITIATOR_TCPIP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FDDI
id|card-&gt;lan_type
op_assign
id|LCS_FRAME_TYPE_FDDI
suffix:semicolon
id|rc
op_assign
id|lcs_send_startlan
c_func
(paren
id|card
comma
id|LCS_INITIATOR_TCPIP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_static
r_int
DECL|function|lcs_startlan
id|lcs_startlan
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|rc
comma
id|i
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;startlan&quot;
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;portno
op_ne
id|LCS_INVALID_PORT_NO
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;lan_type
op_eq
id|LCS_FRAME_TYPE_AUTO
)paren
id|rc
op_assign
id|lcs_startlan_auto
c_func
(paren
id|card
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|lcs_send_startlan
c_func
(paren
id|card
comma
id|LCS_INITIATOR_TCPIP
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|card-&gt;max_port_no
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;portno
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;lan_type
op_ne
id|LCS_FRAME_TYPE_AUTO
)paren
id|rc
op_assign
id|lcs_send_startlan
c_func
(paren
id|card
comma
id|LCS_INITIATOR_TCPIP
)paren
suffix:semicolon
r_else
multiline_comment|/* autodetecting lan type */
id|rc
op_assign
id|lcs_startlan_auto
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_return
id|lcs_send_lanstat
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS detect function&n; * setup channels and make them I/O ready&n; */
r_static
r_int
DECL|function|lcs_detect
id|lcs_detect
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot; lcsdetct&quot;
)paren
suffix:semicolon
multiline_comment|/* start/reset card */
r_if
c_cond
(paren
id|card-&gt;dev
)paren
id|netif_stop_queue
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
id|card-&gt;write.state
op_assign
id|CH_STATE_INIT
suffix:semicolon
id|card-&gt;read.state
op_assign
id|CH_STATE_INIT
suffix:semicolon
id|rc
op_assign
id|lcs_stop_channels
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|lcs_start_channels
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|lcs_send_startup
c_func
(paren
id|card
comma
id|LCS_INITIATOR_TCPIP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
id|lcs_startlan
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|card-&gt;state
op_assign
id|DEV_STATE_UP
suffix:semicolon
)brace
r_else
(brace
id|card-&gt;state
op_assign
id|DEV_STATE_DOWN
suffix:semicolon
id|card-&gt;write.state
op_assign
id|CH_STATE_INIT
suffix:semicolon
id|card-&gt;read.state
op_assign
id|CH_STATE_INIT
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * reset card&n; */
r_static
r_int
DECL|function|lcs_resetcard
id|lcs_resetcard
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|retries
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;rescard&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|retries
op_assign
l_int|0
suffix:semicolon
id|retries
OL
l_int|10
suffix:semicolon
id|retries
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lcs_detect
c_func
(paren
id|card
)paren
op_eq
l_int|0
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|DEV_STATE_UP
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;LCS device %s successfully restarted!&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|schedule_timeout
c_func
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
)brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Error in Reseting LCS card!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS Stop card&n; */
r_static
r_int
DECL|function|lcs_stopcard
id|lcs_stopcard
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;stopcard&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;read.state
op_ne
id|CH_STATE_STOPPED
op_logical_and
id|card-&gt;write.state
op_ne
id|CH_STATE_STOPPED
op_logical_and
id|card-&gt;state
op_eq
id|DEV_STATE_UP
)paren
id|rc
op_assign
id|lcs_send_stoplan
c_func
(paren
id|card
comma
id|LCS_INITIATOR_TCPIP
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_send_shutdown
c_func
(paren
id|card
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_stop_channels
c_func
(paren
id|card
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|DEV_STATE_DOWN
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * LGW initiated commands&n; */
r_static
r_int
DECL|function|lcs_lgw_startlan_thread
id|lcs_lgw_startlan_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|data
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;lgwstpln&quot;
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;lgwstpln&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;dev
)paren
id|netif_stop_queue
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcs_startlan
c_func
(paren
id|card
)paren
op_eq
l_int|0
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|DEV_STATE_UP
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;LCS Startlan for device %s succeeded!&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
id|PRINT_ERR
c_func
(paren
l_string|&quot;LCS Startlan for device %s failed!&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Send startup command initiated by Lan Gateway&n; */
r_static
r_int
DECL|function|lcs_lgw_startup_thread
id|lcs_lgw_startup_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|data
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;lgwstpln&quot;
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;lgwstpln&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;dev
)paren
id|netif_stop_queue
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_send_startup
c_func
(paren
id|card
comma
id|LCS_INITIATOR_LGW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Startup for LCS device %s initiated &quot;
"&bslash;"
l_string|&quot;by LGW failed!&bslash;nReseting card ...&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* do a card reset */
id|rc
op_assign
id|lcs_resetcard
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_goto
id|Done
suffix:semicolon
)brace
id|rc
op_assign
id|lcs_startlan
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|netif_wake_queue
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|DEV_STATE_UP
suffix:semicolon
)brace
id|Done
suffix:colon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|PRINT_INFO
c_func
(paren
l_string|&quot;LCS Startup for device %s succeeded!&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
r_else
id|PRINT_ERR
c_func
(paren
l_string|&quot;LCS Startup for device %s failed!&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * send stoplan command initiated by Lan Gateway&n; */
r_static
r_int
DECL|function|lcs_lgw_stoplan_thread
id|lcs_lgw_stoplan_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|data
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;lgwstop&quot;
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;lgwstop&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;dev
)paren
id|netif_stop_queue
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lcs_send_stoplan
c_func
(paren
id|card
comma
id|LCS_INITIATOR_LGW
)paren
op_eq
l_int|0
)paren
id|PRINT_INFO
c_func
(paren
l_string|&quot;Stoplan for %s initiated by LGW succeeded!&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
r_else
id|PRINT_ERR
c_func
(paren
l_string|&quot;Stoplan %s initiated by LGW failed!&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/*Try to reset the card, stop it on failure */
id|rc
op_assign
id|lcs_resetcard
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
id|rc
op_assign
id|lcs_stopcard
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * Kernel Thread helper functions for LGW initiated commands&n; */
r_static
r_void
DECL|function|lcs_start_kernel_thread
id|lcs_start_kernel_thread
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
)paren
(brace
id|LCS_DBF_TEXT
c_func
(paren
l_int|5
comma
id|trace
comma
l_string|&quot;krnthrd&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|card-&gt;thread_mask
)paren
)paren
id|kernel_thread
c_func
(paren
id|lcs_lgw_startup_thread
comma
(paren
r_void
op_star
)paren
id|card
comma
id|SIGCHLD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|card-&gt;thread_mask
)paren
)paren
id|kernel_thread
c_func
(paren
id|lcs_lgw_startlan_thread
comma
(paren
r_void
op_star
)paren
id|card
comma
id|SIGCHLD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|2
comma
op_amp
id|card-&gt;thread_mask
)paren
)paren
id|kernel_thread
c_func
(paren
id|lcs_lgw_stoplan_thread
comma
(paren
r_void
op_star
)paren
id|card
comma
id|SIGCHLD
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
l_int|3
comma
op_amp
id|card-&gt;thread_mask
)paren
)paren
id|kernel_thread
c_func
(paren
id|lcs_fix_multicast_list
comma
(paren
r_void
op_star
)paren
id|card
comma
id|SIGCHLD
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/**&n; * Process control frames.&n; */
r_static
r_void
DECL|function|lcs_get_control
id|lcs_get_control
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_struct
id|lcs_cmd
op_star
id|cmd
)paren
(brace
r_if
c_cond
(paren
id|cmd-&gt;initiator
op_eq
id|LCS_INITIATOR_LGW
)paren
(brace
r_switch
c_cond
(paren
id|cmd-&gt;cmd_code
)paren
(brace
r_case
id|LCS_CMD_STARTUP
suffix:colon
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|card-&gt;thread_mask
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|card-&gt;kernel_thread_starter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCS_CMD_STARTLAN
suffix:colon
id|set_bit
c_func
(paren
l_int|1
comma
op_amp
id|card-&gt;thread_mask
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|card-&gt;kernel_thread_starter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LCS_CMD_STOPLAN
suffix:colon
id|set_bit
c_func
(paren
l_int|2
comma
op_amp
id|card-&gt;thread_mask
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|card-&gt;kernel_thread_starter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_INFO
c_func
(paren
l_string|&quot;UNRECOGNIZED LGW COMMAND&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
id|lcs_notify_lancmd_waiters
c_func
(paren
id|card
comma
id|cmd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Unpack network packet.&n; */
r_static
r_void
DECL|function|lcs_get_skb
id|lcs_get_skb
c_func
(paren
r_struct
id|lcs_card
op_star
id|card
comma
r_char
op_star
id|skb_data
comma
r_int
r_int
id|skb_len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;dev
op_eq
l_int|NULL
op_logical_or
id|card-&gt;state
op_ne
id|DEV_STATE_UP
)paren
multiline_comment|/* The card isn&squot;t up. Ignore the packet. */
r_return
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|skb_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;LCS: alloc_skb failed for device=%s&bslash;n&quot;
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
id|card-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|card-&gt;dev
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|skb_len
)paren
comma
id|skb_data
comma
id|skb_len
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|card
op_member_access_from_pointer
id|lan_type_trans
c_func
(paren
id|skb
comma
id|card-&gt;dev
)paren
suffix:semicolon
id|card-&gt;stats.rx_bytes
op_add_assign
id|skb_len
suffix:semicolon
id|card-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS main routine to get packets and lancmd replies from the buffers&n; */
r_static
r_void
DECL|function|lcs_get_frames_cb
id|lcs_get_frames_cb
c_func
(paren
r_struct
id|lcs_channel
op_star
id|channel
comma
r_struct
id|lcs_buffer
op_star
id|buffer
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_struct
id|lcs_header
op_star
id|lcs_hdr
suffix:semicolon
id|__u16
id|offset
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|5
comma
id|trace
comma
l_string|&quot;lcsgtpkt&quot;
)paren
suffix:semicolon
id|lcs_hdr
op_assign
(paren
r_struct
id|lcs_header
op_star
)paren
id|buffer-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|lcs_hdr-&gt;offset
op_eq
id|LCS_ILLEGAL_OFFSET
)paren
(brace
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;-eiogpkt&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|channel
op_minus
m_offsetof
(paren
r_struct
id|lcs_card
comma
id|read
)paren
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|lcs_hdr-&gt;offset
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|lcs_hdr-&gt;offset
op_le
l_int|0
op_logical_or
id|lcs_hdr-&gt;offset
OG
id|LCS_IOBUFFERSIZE
op_logical_or
id|lcs_hdr-&gt;offset
OL
id|offset
)paren
(brace
multiline_comment|/* Offset invalid. */
id|card-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
id|card-&gt;stats.rx_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* What kind of frame is it? */
r_if
c_cond
(paren
id|lcs_hdr-&gt;type
op_eq
id|LCS_FRAME_TYPE_CONTROL
)paren
multiline_comment|/* Control frame. */
id|lcs_get_control
c_func
(paren
id|card
comma
(paren
r_struct
id|lcs_cmd
op_star
)paren
id|lcs_hdr
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|lcs_hdr-&gt;type
op_eq
id|LCS_FRAME_TYPE_ENET
op_logical_or
id|lcs_hdr-&gt;type
op_eq
id|LCS_FRAME_TYPE_TR
op_logical_or
id|lcs_hdr-&gt;type
op_eq
id|LCS_FRAME_TYPE_FDDI
)paren
multiline_comment|/* Normal network packet. */
id|lcs_get_skb
c_func
(paren
id|card
comma
(paren
r_char
op_star
)paren
(paren
id|lcs_hdr
op_plus
l_int|1
)paren
comma
id|lcs_hdr-&gt;offset
op_minus
id|offset
op_minus
r_sizeof
(paren
r_struct
id|lcs_header
)paren
)paren
suffix:semicolon
r_else
multiline_comment|/* Unknown frame type. */
suffix:semicolon
singleline_comment|// FIXME: error message ?
multiline_comment|/* Proceed to next frame. */
id|offset
op_assign
id|lcs_hdr-&gt;offset
suffix:semicolon
id|lcs_hdr-&gt;offset
op_assign
id|LCS_ILLEGAL_OFFSET
suffix:semicolon
id|lcs_hdr
op_assign
(paren
r_struct
id|lcs_header
op_star
)paren
(paren
id|buffer-&gt;data
op_plus
id|offset
)paren
suffix:semicolon
)brace
multiline_comment|/* The buffer is now empty. Make it ready again. */
id|lcs_ready_buffer
c_func
(paren
op_amp
id|card-&gt;read
comma
id|buffer
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * get network statistics for ifconfig and other user programs&n; */
r_static
r_struct
id|net_device_stats
op_star
DECL|function|lcs_getstats
id|lcs_getstats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;netstats&quot;
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|card-&gt;stats
suffix:semicolon
)brace
multiline_comment|/**&n; * stop lcs device&n; * This function will be called by user doing ifconfig xxx down&n; */
r_static
r_int
DECL|function|lcs_stop_device
id|lcs_stop_device
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;stopdev&quot;
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_stopcard
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|PRINT_ERR
c_func
(paren
l_string|&quot;Try it again!&bslash;n &quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * start lcs device and make it runnable&n; * This function will be called by user doing ifconfig xxx up&n; */
r_static
r_int
DECL|function|lcs_open_device
id|lcs_open_device
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;opendev&quot;
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* initialize statistics */
id|rc
op_assign
id|lcs_detect
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;LCS:Error in opening device!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|card-&gt;state
op_assign
id|DEV_STATE_UP
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * show function for portno called by cat or similar things&n; */
r_static
id|ssize_t
DECL|function|lcs_portno_show
id|lcs_portno_show
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|card-&gt;portno
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * store the value which is piped to file portno&n; */
r_static
id|ssize_t
DECL|function|lcs_portno_store
id|lcs_portno_store
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_int
id|value
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
l_int|0
suffix:semicolon
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%u&quot;
comma
op_amp
id|value
)paren
suffix:semicolon
multiline_comment|/* TODO: sanity checks */
id|card-&gt;portno
op_assign
id|value
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|portno
comma
l_int|0644
comma
id|lcs_portno_show
comma
id|lcs_portno_store
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|lcs_type_show
id|lcs_type_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ccwgroup_device
op_star
id|cgdev
suffix:semicolon
id|cgdev
op_assign
id|to_ccwgroupdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cgdev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|cu3088_type
(braket
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|id.driver_info
)braket
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|type
comma
l_int|0444
comma
id|lcs_type_show
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|lcs_timeout_show
id|lcs_timeout_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
r_return
id|card
ques
c_cond
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|card-&gt;lancmd_timeout
)paren
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|lcs_timeout_store
id|lcs_timeout_store
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_int
id|value
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
l_int|0
suffix:semicolon
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%u&quot;
comma
op_amp
id|value
)paren
suffix:semicolon
multiline_comment|/* TODO: sanity checks */
id|card-&gt;lancmd_timeout
op_assign
id|value
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|DEVICE_ATTR
c_func
(paren
id|lancmd_timeout
comma
l_int|0644
comma
id|lcs_timeout_show
comma
id|lcs_timeout_store
)paren
suffix:semicolon
DECL|variable|lcs_attrs
r_static
r_struct
id|attribute
op_star
id|lcs_attrs
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_portno.attr
comma
op_amp
id|dev_attr_type.attr
comma
op_amp
id|dev_attr_lancmd_timeout.attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|lcs_attr_group
r_static
r_struct
id|attribute_group
id|lcs_attr_group
op_assign
(brace
dot
id|attrs
op_assign
id|lcs_attrs
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * lcs_probe_device is called on establishing a new ccwgroup_device.&n; */
r_static
r_int
DECL|function|lcs_probe_device
id|lcs_probe_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|ccwgdev
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_device
c_func
(paren
op_amp
id|ccwgdev-&gt;dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;add_dev&quot;
)paren
suffix:semicolon
id|card
op_assign
id|lcs_alloc_card
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Allocation of lcs card failed&bslash;n&quot;
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|ccwgdev-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ret
op_assign
id|sysfs_create_group
c_func
(paren
op_amp
id|ccwgdev-&gt;dev.kobj
comma
op_amp
id|lcs_attr_group
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Creating attributes failed&quot;
)paren
suffix:semicolon
id|lcs_free_card
c_func
(paren
id|card
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|ccwgdev-&gt;dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ccwgdev-&gt;dev.driver_data
op_assign
id|card
suffix:semicolon
id|ccwgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
id|card
suffix:semicolon
id|ccwgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|handler
op_assign
id|lcs_irq
suffix:semicolon
id|ccwgdev-&gt;cdev
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
id|card
suffix:semicolon
id|ccwgdev-&gt;cdev
(braket
l_int|1
)braket
op_member_access_from_pointer
id|handler
op_assign
id|lcs_irq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * lcs_new_device will be called by setting the group device online.&n; */
r_static
r_int
DECL|function|lcs_new_device
id|lcs_new_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|ccwgdev
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|ccwgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|card-&gt;read.ccwdev
op_assign
id|ccwgdev-&gt;cdev
(braket
l_int|0
)braket
suffix:semicolon
id|card-&gt;write.ccwdev
op_assign
id|ccwgdev-&gt;cdev
(braket
l_int|1
)braket
suffix:semicolon
id|ccw_device_set_online
c_func
(paren
id|card-&gt;read.ccwdev
)paren
suffix:semicolon
id|ccw_device_set_online
c_func
(paren
id|card-&gt;write.ccwdev
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;lcsnewdv&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_setup_card
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;errinit&quot;
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;LCS card Initialization failed&bslash;n&quot;
)paren
suffix:semicolon
id|lcs_free_card
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|lcs_detect
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|lcs_stopcard
c_func
(paren
id|card
)paren
suffix:semicolon
id|lcs_cleanup_card
c_func
(paren
id|card
)paren
suffix:semicolon
id|lcs_free_card
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|card-&gt;lan_type
)paren
(brace
macro_line|#ifdef CONFIG_NET_ETHERNET
r_case
id|LCS_FRAME_TYPE_ENET
suffix:colon
id|card-&gt;lan_type_trans
op_assign
id|eth_type_trans
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_TR
r_case
id|LCS_FRAME_TYPE_TR
suffix:colon
id|card-&gt;lan_type_trans
op_assign
id|tr_type_trans
suffix:semicolon
id|dev
op_assign
id|alloc_trdev
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_FDDI
r_case
id|LCS_FRAME_TYPE_FDDI
suffix:colon
id|card-&gt;lan_type_trans
op_assign
id|fddi_type_trans
suffix:semicolon
id|dev
op_assign
id|alloc_fddidev
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;errinit&quot;
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;LCS: Initialization failed&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;LCS: No device found!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|card-&gt;mac
comma
id|LCS_MAC_LENGTH
)paren
suffix:semicolon
id|card-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;priv
op_assign
id|card
suffix:semicolon
id|dev-&gt;open
op_assign
id|lcs_open_device
suffix:semicolon
id|dev-&gt;stop
op_assign
id|lcs_stop_device
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|lcs_start_xmit
suffix:semicolon
macro_line|#ifdef CONFIG_IP_MULTICAST
r_if
c_cond
(paren
id|lcs_check_multicast_support
c_func
(paren
id|card
)paren
)paren
id|dev-&gt;set_multicast_list
op_assign
id|lcs_set_multicast_list
suffix:semicolon
macro_line|#endif
id|dev-&gt;get_stats
op_assign
id|lcs_getstats
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Create symlinks. */
r_if
c_cond
(paren
id|sysfs_create_link
c_func
(paren
op_amp
id|ccwgdev-&gt;dev.kobj
comma
op_amp
id|dev-&gt;class_dev.kobj
comma
id|dev-&gt;name
)paren
)paren
(brace
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sysfs_create_link
c_func
(paren
op_amp
id|dev-&gt;class_dev.kobj
comma
op_amp
id|ccwgdev-&gt;dev.kobj
comma
id|ccwgdev-&gt;dev.bus_id
)paren
)paren
(brace
id|sysfs_remove_link
c_func
(paren
op_amp
id|ccwgdev-&gt;dev.kobj
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|lcs_stopcard
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|lcs_cleanup_channel
c_func
(paren
op_amp
id|card-&gt;read
)paren
suffix:semicolon
id|lcs_cleanup_channel
c_func
(paren
op_amp
id|card-&gt;write
)paren
suffix:semicolon
id|lcs_free_card
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/**&n; * lcs_shutdown_device, called when setting the group device offline.&n; */
r_static
r_int
DECL|function|lcs_shutdown_device
id|lcs_shutdown_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|ccwgdev
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;shtdndev&quot;
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|ccwgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ret
op_assign
id|lcs_stop_device
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|sysfs_remove_link
c_func
(paren
op_amp
id|card-&gt;dev-&gt;class_dev.kobj
comma
id|ccwgdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|sysfs_remove_link
c_func
(paren
op_amp
id|ccwgdev-&gt;dev.kobj
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * lcs_remove_device, free buffers and card&n; */
r_static
r_void
DECL|function|lcs_remove_device
id|lcs_remove_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|ccwgdev
)paren
(brace
r_struct
id|lcs_card
op_star
id|card
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|3
comma
id|setup
comma
l_string|&quot;remdev&quot;
)paren
suffix:semicolon
id|card
op_assign
(paren
r_struct
id|lcs_card
op_star
)paren
id|ccwgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|ccwgdev-&gt;state
op_eq
id|CCWGROUP_ONLINE
)paren
(brace
id|lcs_stop_device
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Ignore rc. */
id|sysfs_remove_link
c_func
(paren
op_amp
id|card-&gt;dev-&gt;class_dev.kobj
comma
id|ccwgdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|sysfs_remove_link
c_func
(paren
op_amp
id|ccwgdev-&gt;dev.kobj
comma
id|card-&gt;dev-&gt;name
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|card-&gt;dev
)paren
suffix:semicolon
)brace
id|sysfs_remove_group
c_func
(paren
op_amp
id|ccwgdev-&gt;dev.kobj
comma
op_amp
id|lcs_attr_group
)paren
suffix:semicolon
id|lcs_cleanup_card
c_func
(paren
id|card
)paren
suffix:semicolon
id|lcs_free_card
c_func
(paren
id|card
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|ccwgdev-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * LCS ccwgroup driver registration&n; */
DECL|variable|lcs_group_driver
r_static
r_struct
id|ccwgroup_driver
id|lcs_group_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;lcs&quot;
comma
dot
id|max_slaves
op_assign
l_int|2
comma
dot
id|driver_id
op_assign
l_int|0xD3C3E2
comma
dot
id|probe
op_assign
id|lcs_probe_device
comma
dot
id|remove
op_assign
id|lcs_remove_device
comma
dot
id|set_online
op_assign
id|lcs_new_device
comma
dot
id|set_offline
op_assign
id|lcs_shutdown_device
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *  LCS Module/Kernel initialization function&n; */
r_static
r_int
DECL|function|lcs_init_module
id|__init
id|lcs_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|0
comma
id|setup
comma
l_string|&quot;lcsinit&quot;
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;Loading %s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|rc
op_assign
id|lcs_register_debug_facility
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Initialization failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|register_cu3088_discipline
c_func
(paren
op_amp
id|lcs_group_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;Initialization failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *  LCS module cleanup function&n; */
r_static
r_void
DECL|function|lcs_cleanup_module
id|__exit
id|lcs_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|PRINT_INFO
c_func
(paren
l_string|&quot;Terminating lcs module.&bslash;n&quot;
)paren
suffix:semicolon
id|LCS_DBF_TEXT
c_func
(paren
l_int|0
comma
id|trace
comma
l_string|&quot;cleanup&quot;
)paren
suffix:semicolon
id|unregister_cu3088_discipline
c_func
(paren
op_amp
id|lcs_group_driver
)paren
suffix:semicolon
id|lcs_unregister_debug_facility
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|lcs_init_module
id|module_init
c_func
(paren
id|lcs_init_module
)paren
suffix:semicolon
DECL|variable|lcs_cleanup_module
id|module_exit
c_func
(paren
id|lcs_cleanup_module
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Frank Pavlic &lt;pavlic@de.ibm.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
