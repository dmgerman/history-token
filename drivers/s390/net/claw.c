multiline_comment|/*&n; *  drivers/s390/net/claw.c&n; *    ESCON CLAW network driver&n; *&n; *    $Revision: 1.35 $ $Date: 2005/03/24 12:25:38 $&n; *&n; *  Linux fo zSeries version&n; *    Copyright (C) 2002,2005 IBM Corporation&n; *  Author(s) Original code written by:&n; *              Kazuo Iimura (iimura@jp.ibm.com)&n; *   &t;      Rewritten by&n; *              Andy Richter (richtera@us.ibm.com)&n; *              Marc Price (mwprice@us.ibm.com)&n; *&n; *    sysfs parms:&n; *   group x.x.rrrr,x.x.wwww&n; *   read_buffer nnnnnnn&n; *   write_buffer nnnnnn&n; *   host_name  aaaaaaaa&n; *   adapter_name aaaaaaaa&n; *   api_type    aaaaaaaa&n; *&n; *  eg.&n; *   group  0.0.0200 0.0.0201&n; *   read_buffer 25&n; *   write_buffer 20&n; *   host_name LINUX390&n; *   adapter_name RS6K&n; *   api_type     TCPIP&n; *&n; *  where&n; *&n; *   The device id is decided by the order entries&n; *   are added to the group the first is claw0 the second claw1&n; *   up to CLAW_MAX_DEV&n; *&n; *   rrrr     -&t;the first of 2 consecutive device addresses used for the&n; *&t;&t;CLAW protocol.&n; *&t;&t;The specified address is always used as the input (Read)&n; *&t;&t;channel and the next address is used as the output channel.&n; *&n; *   wwww     -&t;the second of 2 consecutive device addresses used for&n; *&t;&t;the CLAW protocol.&n; *              The specified address is always used as the output&n; *&t;&t;channel and the previous address is used as the input channel.&n; *&n; *   read_buffer&t;-       specifies number of input buffers to allocate.&n; *   write_buffer       -       specifies number of output buffers to allocate.&n; *   host_name          -       host name&n; *   adaptor_name       -       adaptor name&n; *   api_type           -       API type TCPIP or API will be sent and expected&n; *&t;&t;&t;&t;as ws_name&n; *&n; *   Note the following requirements:&n; *   1)  host_name must match the configured adapter_name on the remote side&n; *   2)  adaptor_name must match the configured host name on the remote side&n; *&n; *  Change History&n; *    1.00  Initial release shipped&n; *    1.10  Changes for Buffer allocation&n; *    1.15  Changed for 2.6 Kernel  No longer compiles on 2.4 or lower&n; *    1.25  Added Packing support&n; */
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/ccwgroup.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &quot;cu3088.h&quot;
macro_line|#include &quot;claw.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Andy Richter &lt;richtera@us.ibm.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux for zSeries CLAW Driver&bslash;n&quot;
"&bslash;"
l_string|&quot;Copyright 2000,2005 IBM Corporation&bslash;n&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Debugging is based on DEBUGMSG, IOTRACE, or FUNCTRACE  options:&n;   DEBUGMSG  - Enables output of various debug messages in the code&n;   IOTRACE   - Enables output of CCW and other IO related traces&n;   FUNCTRACE - Enables output of function entry/exit trace&n;   Define any combination of above options to enable tracing&n;&n;   CLAW also uses the s390dbf file system  see claw_trace and claw_setup&n;*/
multiline_comment|/* following enables tracing */
singleline_comment|//#define DEBUGMSG
singleline_comment|//#define IOTRACE
singleline_comment|//#define FUNCTRACE
macro_line|#ifdef DEBUGMSG
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#endif
macro_line|#ifdef IOTRACE
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#endif
macro_line|#ifdef FUNCTRACE
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#endif
DECL|variable|debug_buffer
r_char
id|debug_buffer
(braket
l_int|255
)braket
suffix:semicolon
multiline_comment|/**&n; * Debug Facility Stuff&n; */
DECL|variable|claw_dbf_setup
r_static
id|debug_info_t
op_star
id|claw_dbf_setup
suffix:semicolon
DECL|variable|claw_dbf_trace
r_static
id|debug_info_t
op_star
id|claw_dbf_trace
suffix:semicolon
multiline_comment|/**&n; *  CLAW Debug Facility functions&n; */
r_static
r_void
DECL|function|claw_unregister_debug_facility
id|claw_unregister_debug_facility
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|claw_dbf_setup
)paren
id|debug_unregister
c_func
(paren
id|claw_dbf_setup
)paren
suffix:semicolon
r_if
c_cond
(paren
id|claw_dbf_trace
)paren
id|debug_unregister
c_func
(paren
id|claw_dbf_trace
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|claw_register_debug_facility
id|claw_register_debug_facility
c_func
(paren
r_void
)paren
(brace
id|claw_dbf_setup
op_assign
id|debug_register
c_func
(paren
l_string|&quot;claw_setup&quot;
comma
l_int|1
comma
l_int|1
comma
l_int|8
)paren
suffix:semicolon
id|claw_dbf_trace
op_assign
id|debug_register
c_func
(paren
l_string|&quot;claw_trace&quot;
comma
l_int|1
comma
l_int|2
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|claw_dbf_setup
op_eq
l_int|NULL
op_logical_or
id|claw_dbf_trace
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Not enough memory for debug facility.&bslash;n&quot;
)paren
suffix:semicolon
id|claw_unregister_debug_facility
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|debug_register_view
c_func
(paren
id|claw_dbf_setup
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|claw_dbf_setup
comma
l_int|2
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|claw_dbf_trace
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|claw_dbf_trace
comma
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|claw_set_busy
id|claw_set_busy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
(paren
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tbusy
op_assign
l_int|1
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|claw_clear_busy
id|claw_clear_busy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
(paren
(paren
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tbusy
)paren
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|eieio
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|claw_check_busy
id|claw_check_busy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|eieio
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tbusy
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|claw_setbit_busy
id|claw_setbit_busy
c_func
(paren
r_int
id|nr
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|nr
comma
(paren
r_void
op_star
)paren
op_amp
(paren
(paren
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tbusy
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|claw_clearbit_busy
id|claw_clearbit_busy
c_func
(paren
r_int
id|nr
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|clear_bit
c_func
(paren
id|nr
comma
(paren
r_void
op_star
)paren
op_amp
(paren
(paren
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tbusy
)paren
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|claw_test_and_setbit_busy
id|claw_test_and_setbit_busy
c_func
(paren
r_int
id|nr
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|test_and_set_bit
c_func
(paren
id|nr
comma
(paren
r_void
op_star
)paren
op_amp
(paren
(paren
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tbusy
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Functions for the DEV methods */
r_static
r_int
id|claw_probe
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
suffix:semicolon
r_static
r_void
id|claw_remove_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
suffix:semicolon
r_static
r_void
id|claw_purge_skb_queue
c_func
(paren
r_struct
id|sk_buff_head
op_star
id|q
)paren
suffix:semicolon
r_static
r_int
id|claw_new_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
suffix:semicolon
r_static
r_int
id|claw_shutdown_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
suffix:semicolon
r_static
r_int
id|claw_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
id|claw_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
suffix:semicolon
r_static
r_int
id|claw_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|claw_irq_handler
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
r_int
id|intparm
comma
r_struct
id|irb
op_star
id|irb
)paren
suffix:semicolon
r_static
r_void
id|claw_irq_tasklet
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_int
id|claw_release
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|claw_write_retry
(paren
r_struct
id|chbk
op_star
id|p_ch
)paren
suffix:semicolon
r_static
r_void
id|claw_write_next
(paren
r_struct
id|chbk
op_star
id|p_ch
)paren
suffix:semicolon
r_static
r_void
id|claw_timer
(paren
r_struct
id|chbk
op_star
id|p_ch
)paren
suffix:semicolon
multiline_comment|/* Functions */
r_static
r_int
id|add_claw_reads
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ccwbk
op_star
id|p_first
comma
r_struct
id|ccwbk
op_star
id|p_last
)paren
suffix:semicolon
r_static
r_void
r_inline
id|ccw_check_return_code
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|return_code
)paren
suffix:semicolon
r_static
r_void
r_inline
id|ccw_check_unit_check
(paren
r_struct
id|chbk
op_star
id|p_ch
comma
r_int
r_char
id|sense
)paren
suffix:semicolon
r_static
r_int
id|find_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|host_name
comma
r_char
op_star
id|ws_name
)paren
suffix:semicolon
r_static
r_int
id|claw_hw_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|linkid
)paren
suffix:semicolon
r_static
r_int
id|init_ccw_bk
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|probe_error
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
suffix:semicolon
r_static
r_struct
id|net_device_stats
op_star
id|claw_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_int
r_inline
id|pages_to_order_of_mag
c_func
(paren
r_int
id|num_of_pages
)paren
suffix:semicolon
r_static
r_struct
id|sk_buff
op_star
id|claw_pack_skb
c_func
(paren
r_struct
id|claw_privbk
op_star
id|privptr
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_static
r_void
id|dumpit
(paren
r_char
op_star
id|buf
comma
r_int
id|len
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* sysfs Functions */
r_static
id|ssize_t
id|claw_hname_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_hname_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_adname_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_adname_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_apname_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_apname_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_wbuff_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_wbuff_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_rbuff_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
suffix:semicolon
r_static
id|ssize_t
id|claw_rbuff_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|claw_add_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|claw_remove_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*   Functions for System Validate  */
r_static
r_int
id|claw_process_control
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ccwbk
op_star
id|p_ccw
)paren
suffix:semicolon
r_static
r_int
id|claw_send_control
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u8
id|type
comma
id|__u8
id|link
comma
id|__u8
id|correlator
comma
id|__u8
id|rc
comma
r_char
op_star
id|local_name
comma
r_char
op_star
id|remote_name
)paren
suffix:semicolon
r_static
r_int
id|claw_snd_conn_req
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u8
id|link
)paren
suffix:semicolon
r_static
r_int
id|claw_snd_disc
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|clawctl
op_star
id|p_ctl
)paren
suffix:semicolon
r_static
r_int
id|claw_snd_sys_validate_rsp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|clawctl
op_star
id|p_ctl
comma
id|__u32
id|return_code
)paren
suffix:semicolon
r_static
r_int
id|claw_strt_conn_req
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|claw_strt_read
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|lock
)paren
suffix:semicolon
r_static
r_void
id|claw_strt_out_IO
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|claw_free_wrt_buf
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* Functions for unpack reads   */
r_static
r_void
id|unpack_read
(paren
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* ccwgroup table  */
DECL|variable|claw_group_driver
r_static
r_struct
id|ccwgroup_driver
id|claw_group_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;claw&quot;
comma
dot
id|max_slaves
op_assign
l_int|2
comma
dot
id|driver_id
op_assign
l_int|0xC3D3C1E6
comma
dot
id|probe
op_assign
id|claw_probe
comma
dot
id|remove
op_assign
id|claw_remove_device
comma
dot
id|set_online
op_assign
id|claw_new_device
comma
dot
id|set_offline
op_assign
id|claw_shutdown_device
comma
)brace
suffix:semicolon
multiline_comment|/*&n;*&n;*       Key functions&n;*/
multiline_comment|/*----------------------------------------------------------------*&n; *   claw_probe                                                   *&n; *      this function is called for each CLAW device.             *&n; *----------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_probe
id|claw_probe
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Enter&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;probe&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: variable cgdev =&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|cgdev
comma
r_sizeof
(paren
r_struct
id|ccwgroup_device
)paren
)paren
suffix:semicolon
macro_line|#endif
id|privptr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|claw_privbk
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr
op_eq
l_int|NULL
)paren
(brace
id|probe_error
c_func
(paren
id|cgdev
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Out of memory %s %s Exit Line %d &bslash;n&quot;
comma
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev.bus_id
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;probex%d&quot;
comma
op_minus
id|ENOMEM
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|privptr
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|claw_privbk
)paren
)paren
suffix:semicolon
id|privptr-&gt;p_mtc_envelope
op_assign
id|kmalloc
c_func
(paren
id|MAX_ENVELOPE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|privptr-&gt;p_env
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|claw_env
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|privptr-&gt;p_mtc_envelope
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|privptr-&gt;p_env
op_eq
l_int|NULL
)paren
)paren
(brace
id|probe_error
c_func
(paren
id|cgdev
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Out of memory %s %s Exit Line %d &bslash;n&quot;
comma
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev.bus_id
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;probex%d&quot;
comma
op_minus
id|ENOMEM
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|privptr-&gt;p_mtc_envelope
comma
l_int|0x00
comma
id|MAX_ENVELOPE_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|privptr-&gt;p_env
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|claw_env
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|privptr-&gt;p_env-&gt;adapter_name
comma
id|WS_NAME_NOT_DEF
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|privptr-&gt;p_env-&gt;host_name
comma
id|WS_NAME_NOT_DEF
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|privptr-&gt;p_env-&gt;api_type
comma
id|WS_NAME_NOT_DEF
comma
l_int|8
)paren
suffix:semicolon
id|privptr-&gt;p_env-&gt;packing
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;p_env-&gt;write_buffers
op_assign
l_int|5
suffix:semicolon
id|privptr-&gt;p_env-&gt;read_buffers
op_assign
l_int|5
suffix:semicolon
id|privptr-&gt;p_env-&gt;read_size
op_assign
id|CLAW_FRAME_SIZE
suffix:semicolon
id|privptr-&gt;p_env-&gt;write_size
op_assign
id|CLAW_FRAME_SIZE
suffix:semicolon
id|rc
op_assign
id|claw_add_files
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|probe_error
c_func
(paren
id|cgdev
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;add_files failed %s %s Exit Line %d &bslash;n&quot;
comma
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev.bus_id
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;probex%d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: sysfs files added for %s&bslash;n&quot;
comma
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev.bus_id
)paren
suffix:semicolon
id|privptr-&gt;p_env-&gt;p_priv
op_assign
id|privptr
suffix:semicolon
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|handler
op_assign
id|claw_irq_handler
suffix:semicolon
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
op_member_access_from_pointer
id|handler
op_assign
id|claw_irq_handler
suffix:semicolon
id|cgdev-&gt;dev.driver_data
op_assign
id|privptr
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw:%s exit on line %d, &quot;
l_string|&quot;rc = 0&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;prbext 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*  end of claw_probe       */
multiline_comment|/*-------------------------------------------------------------------*&n; *   claw_tx                                                         *&n; *-------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_tx
id|claw_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|saveflags
suffix:semicolon
r_struct
id|chbk
op_star
id|p_ch
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;claw_tx&quot;
)paren
suffix:semicolon
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: null pointer passed as sk_buffer&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|privptr-&gt;stats.tx_dropped
op_increment
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() exit on line %d, rc = EIO&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;clawtx%d&quot;
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable sk_buff=&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|skb
comma
r_sizeof
(paren
r_struct
id|sk_buff
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev=&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|p_ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|rc
op_assign
id|claw_hw_tx
c_func
(paren
id|skb
comma
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|p_ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s exit on line %d, rc = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;clawtx%d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*  end of claw_tx */
multiline_comment|/*------------------------------------------------------------------*&n; *  pack the collect queue into an skb and return it                *&n; *   If not packing just return the top skb from the queue          *&n; *------------------------------------------------------------------*/
r_static
r_struct
id|sk_buff
op_star
DECL|function|claw_pack_skb
id|claw_pack_skb
c_func
(paren
r_struct
id|claw_privbk
op_star
id|privptr
)paren
(brace
r_struct
id|sk_buff
op_star
id|new_skb
comma
op_star
id|held_skb
suffix:semicolon
r_struct
id|chbk
op_star
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
op_assign
id|privptr-&gt;p_env
suffix:semicolon
r_int
id|pkt_cnt
comma
id|pk_ind
comma
id|so_far
suffix:semicolon
id|new_skb
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* assume no dice */
id|pkt_cnt
op_assign
l_int|0
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;PackSKBe&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|p_ch-&gt;collect_queue
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/* some data */
id|held_skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|p_ch-&gt;collect_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_env-&gt;packing
op_ne
id|DO_PACKED
)paren
r_return
id|held_skb
suffix:semicolon
r_if
c_cond
(paren
id|held_skb
)paren
id|atomic_dec
c_func
(paren
op_amp
id|held_skb-&gt;users
)paren
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
multiline_comment|/* get a new SKB we will pack at least one */
id|new_skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|p_env-&gt;write_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_skb
op_eq
l_int|NULL
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|held_skb-&gt;users
)paren
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|p_ch-&gt;collect_queue
comma
id|held_skb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* we have packed packet and a place to put it  */
id|pk_ind
op_assign
l_int|1
suffix:semicolon
id|so_far
op_assign
l_int|0
suffix:semicolon
id|new_skb-&gt;cb
(braket
l_int|1
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
multiline_comment|/* every skb on queue has pack header */
r_while
c_loop
(paren
(paren
id|pk_ind
)paren
op_logical_and
(paren
id|held_skb
op_ne
l_int|NULL
)paren
)paren
(brace
r_if
c_cond
(paren
id|held_skb-&gt;len
op_plus
id|so_far
op_le
id|p_env-&gt;write_size
op_minus
l_int|8
)paren
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|new_skb
comma
id|held_skb-&gt;len
)paren
comma
id|held_skb-&gt;data
comma
id|held_skb-&gt;len
)paren
suffix:semicolon
id|privptr-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|so_far
op_add_assign
id|held_skb-&gt;len
suffix:semicolon
id|pkt_cnt
op_increment
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|held_skb
)paren
suffix:semicolon
id|held_skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|p_ch-&gt;collect_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|held_skb
)paren
id|atomic_dec
c_func
(paren
op_amp
id|held_skb-&gt;users
)paren
suffix:semicolon
)brace
r_else
(brace
id|pk_ind
op_assign
l_int|0
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|held_skb-&gt;users
)paren
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|p_ch-&gt;collect_queue
comma
id|held_skb
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() Packed %d len %d&bslash;n&quot;
comma
id|p_env-&gt;ndev-&gt;name
comma
id|__FUNCTION__
comma
id|pkt_cnt
comma
id|new_skb-&gt;len
)paren
suffix:semicolon
macro_line|#endif
)brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;PackSKBx&quot;
)paren
suffix:semicolon
r_return
id|new_skb
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*&n; *   claw_change_mtu                                                 *&n; *                                                                   *&n; *-------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_change_mtu
id|claw_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|buff_size
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;variable dev =&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;variable new_mtu = %d&bslash;n&quot;
comma
id|new_mtu
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;setmtu&quot;
)paren
suffix:semicolon
id|buff_size
op_assign
id|privptr-&gt;p_env-&gt;write_size
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|60
)paren
op_logical_or
(paren
id|new_mtu
OG
id|buff_size
)paren
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc=EINVAL&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*   end of claw_change_mtu */
multiline_comment|/*-------------------------------------------------------------------*&n; *   claw_open                                                       *&n; *                                                                   *&n; *-------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_open
id|claw_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|saveflags
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|parm
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|timer_list
id|timer
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_buf
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;open&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_or
(paren
id|dev-&gt;name
(braket
l_int|0
)braket
op_eq
l_int|0x00
)paren
)paren
(brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;BadDev&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: Bad device at open failing &bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/*   allocate and initialize CCW blocks */
r_if
c_cond
(paren
id|privptr-&gt;buffs_alloc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|init_ccw_bk
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc=ENOMEM&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;openmem&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|privptr-&gt;system_validate_comp
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;release_pend
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|privptr-&gt;p_env-&gt;api_type
comma
id|WS_APPL_NAME_PACKED
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|privptr-&gt;p_env-&gt;read_size
op_assign
id|DEF_PACK_BUFSIZE
suffix:semicolon
id|privptr-&gt;p_env-&gt;write_size
op_assign
id|DEF_PACK_BUFSIZE
suffix:semicolon
id|privptr-&gt;p_env-&gt;packing
op_assign
id|PACKING_ASK
suffix:semicolon
)brace
r_else
(brace
id|privptr-&gt;p_env-&gt;packing
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;p_env-&gt;read_size
op_assign
id|CLAW_FRAME_SIZE
suffix:semicolon
id|privptr-&gt;p_env-&gt;write_size
op_assign
id|CLAW_FRAME_SIZE
suffix:semicolon
)brace
id|claw_set_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|tasklet
comma
id|claw_irq_tasklet
comma
(paren
r_int
r_int
)paren
op_amp
id|privptr-&gt;channel
(braket
id|READ
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;opn_ch%d&quot;
comma
id|i
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|wait
)paren
suffix:semicolon
multiline_comment|/* skb_queue_head_init(&amp;p_ch-&gt;io_queue); */
r_if
c_cond
(paren
id|i
op_eq
id|WRITE
)paren
id|skb_queue_head_init
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|collect_queue
)paren
suffix:semicolon
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|flag_a
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|IO_active
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|flag
op_and_assign
op_complement
id|CLAW_TIMER
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|timer.function
op_assign
(paren
r_void
op_star
)paren
id|claw_timer
suffix:semicolon
id|timer.data
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
)paren
suffix:semicolon
id|timer.expires
op_assign
id|jiffies
op_plus
l_int|15
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|parm
op_assign
(paren
r_int
r_int
)paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
suffix:semicolon
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|claw_state
op_assign
id|CLAW_START_HALT_IO
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
(paren
r_struct
id|ccw_device
op_star
)paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
comma
id|parm
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|ccw_check_return_code
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
comma
id|rc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|flag
op_amp
id|CLAW_TIMER
)paren
op_eq
l_int|0x00
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
(paren
(paren
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|last_dstat
op_or
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|last_dstat
)paren
op_amp
op_complement
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
op_ne
l_int|0x00
)paren
op_logical_or
(paren
(paren
(paren
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|flag
op_or
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|flag
)paren
op_amp
id|CLAW_TIMER
)paren
op_ne
l_int|0x00
)paren
)paren
(brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: channel problems during open - read:&quot;
l_string|&quot; %02x -  write: %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|last_dstat
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|last_dstat
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: remote side is not ready&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;notrdy&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|parm
op_assign
(paren
r_int
r_int
)paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
suffix:semicolon
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|claw_state
op_assign
id|CLAW_STOP
suffix:semicolon
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
(paren
r_struct
id|ccw_device
op_star
)paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
comma
id|parm
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|ccw_check_return_code
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_ccw
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_ccw_num
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;read_size
OL
id|PAGE_SIZE
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_read
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_read_num
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|p_buf
op_assign
id|privptr-&gt;p_read_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|p_buf-&gt;p_buffer
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perread
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;write_size
OL
id|PAGE_SIZE
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_write
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_write_num
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|p_buf
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|p_buf-&gt;p_buffer
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perwrite
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
)brace
id|privptr-&gt;buffs_alloc
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|flag
op_assign
l_int|0x00
suffix:semicolon
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|flag
op_assign
l_int|0x00
suffix:semicolon
id|privptr-&gt;p_buff_ccw
op_assign
l_int|NULL
suffix:semicolon
id|privptr-&gt;p_buff_read
op_assign
l_int|NULL
suffix:semicolon
id|privptr-&gt;p_buff_write
op_assign
l_int|NULL
suffix:semicolon
id|claw_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc=EIO&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;open EIO&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*   Send SystemValidate command */
id|claw_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc=0&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;openok&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*     end of claw_open    */
multiline_comment|/*-------------------------------------------------------------------*&n;*                                                                    *&n;*       claw_irq_handler                                             *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_irq_handler
id|claw_irq_handler
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
r_int
id|intparm
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|chbk
op_star
id|p_ch
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_struct
id|chbk
op_star
id|p_ch_r
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s enter  &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;clawirq&quot;
)paren
suffix:semicolon
multiline_comment|/* Bypass all &squot;unsolicited interrupts&squot; */
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;dev.driver_data
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: unsolicited interrupt for device:&quot;
l_string|&quot;%s received c-%02x d-%02x&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.dstat
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: %s() &quot;
l_string|&quot;exit on line %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;badirq&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
id|cdev-&gt;dev.driver_data
suffix:semicolon
multiline_comment|/* Try to extract channel from driver data. */
r_if
c_cond
(paren
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|cdev
op_eq
id|cdev
)paren
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|READ
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|cdev
op_eq
id|cdev
)paren
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: Can&squot;t determine channel for &quot;
l_string|&quot;interrupt, device %s&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;badchan&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;IRQCH=%d&quot;
comma
id|p_ch-&gt;flag
)paren
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
(paren
id|p_ch-&gt;ndev
)paren
suffix:semicolon
id|p_env
op_assign
id|privptr-&gt;p_env
suffix:semicolon
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interrupt for device: %04x &quot;
l_string|&quot;received c-%02x d-%02x state-%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ch-&gt;devno
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.dstat
comma
id|p_ch-&gt;claw_state
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Copy interruption response block. */
id|memcpy
c_func
(paren
id|p_ch-&gt;irb
comma
id|irb
comma
r_sizeof
(paren
r_struct
id|irb
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for good subchannel return code, otherwise error message */
r_if
c_cond
(paren
id|irb-&gt;scsw.cstat
op_logical_and
op_logical_neg
(paren
id|irb-&gt;scsw.cstat
op_amp
id|SCHN_STAT_PCI
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: subchannel check for device: %04x -&quot;
l_string|&quot; Sch Stat %02x  Dev Stat %02x CPA - %04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ch-&gt;devno
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.dstat
comma
id|irb-&gt;scsw.cpa
)paren
suffix:semicolon
macro_line|#ifdef IOTRACE
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|irb
comma
r_sizeof
(paren
r_struct
id|irb
)paren
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
(paren
r_int
r_int
)paren
id|irb-&gt;scsw.cpa
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;chanchk&quot;
)paren
suffix:semicolon
multiline_comment|/* return; */
)brace
multiline_comment|/* Check the reason-code of a unit check */
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
id|ccw_check_unit_check
c_func
(paren
id|p_ch
comma
id|irb-&gt;ecw
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* State machine to bring the connection up, down and to restart */
id|p_ch-&gt;last_dstat
op_assign
id|irb-&gt;scsw.dstat
suffix:semicolon
r_switch
c_cond
(paren
id|p_ch-&gt;claw_state
)paren
(brace
r_case
id|CLAW_STOP
suffix:colon
multiline_comment|/* HALT_IO by claw_release (halt sequence) */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CLAW_STOP enter&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_SEC_STATUS
)paren
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_eq
id|SCSW_STCTL_STATUS_PEND
)paren
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_ALERT_STATUS
op_or
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
)paren
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
id|wake_up
c_func
(paren
op_amp
id|p_ch-&gt;wait
)paren
suffix:semicolon
multiline_comment|/* wake up claw_release */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CLAW_STOP exit&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;stop&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|CLAW_START_HALT_IO
suffix:colon
multiline_comment|/* HALT_IO issued by claw_open  */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: process CLAW_STAT_HALT_IO&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_SEC_STATUS
)paren
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_eq
id|SCSW_STCTL_STATUS_PEND
)paren
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_ALERT_STATUS
op_or
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
)paren
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;haltio&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_ch-&gt;flag
op_eq
id|CLAW_READ
)paren
(brace
id|p_ch-&gt;claw_state
op_assign
id|CLAW_START_READ
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|p_ch-&gt;wait
)paren
suffix:semicolon
multiline_comment|/* wake claw_open (READ)*/
)brace
r_else
r_if
c_cond
(paren
id|p_ch-&gt;flag
op_eq
id|CLAW_WRITE
)paren
(brace
id|p_ch-&gt;claw_state
op_assign
id|CLAW_START_WRITE
suffix:semicolon
multiline_comment|/*      send SYSTEM_VALIDATE                    */
id|claw_strt_read
c_func
(paren
id|dev
comma
id|LOCK_NO
)paren
suffix:semicolon
id|claw_send_control
c_func
(paren
id|dev
comma
id|SYSTEM_VALIDATE_REQUEST
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|p_env-&gt;host_name
comma
id|p_env-&gt;adapter_name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: unsolicited &quot;
l_string|&quot;interrupt for device:&quot;
l_string|&quot;%s received c-%02x d-%02x&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.dstat
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: process CLAW_STAT_HALT_IO exit&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;haltio&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|CLAW_START_READ
suffix:colon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;ReadIRQ&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_ch-&gt;irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;IO_active
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p_ch-&gt;irb-&gt;ecw
(braket
l_int|0
)braket
op_amp
l_int|0x41
)paren
op_eq
l_int|0x41
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;ecw
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
op_eq
l_int|0x40
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;ecw
(braket
l_int|0
)braket
)paren
op_eq
l_int|0
)paren
(brace
id|privptr-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Restart is &quot;
l_string|&quot;required after remote &quot;
l_string|&quot;side recovers &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;notrdy&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p_ch-&gt;irb-&gt;scsw.cstat
op_amp
id|SCHN_STAT_PCI
)paren
op_logical_and
(paren
id|p_ch-&gt;irb-&gt;scsw.dstat
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|CLAW_BH_ACTIVE
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;flag_a
)paren
op_eq
l_int|0
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|p_ch-&gt;tasklet
)paren
suffix:semicolon
)brace
r_else
(brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;PCINoBH&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;PCI_read&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_SEC_STATUS
)paren
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_eq
id|SCSW_STCTL_STATUS_PEND
)paren
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_ALERT_STATUS
op_or
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
)paren
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;SPend_rd&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;IO_active
)paren
suffix:semicolon
id|claw_clearbit_busy
c_func
(paren
id|TB_RETRY
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|CLAW_BH_ACTIVE
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;flag_a
)paren
op_eq
l_int|0
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|p_ch-&gt;tasklet
)paren
suffix:semicolon
)brace
r_else
(brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;RdBHAct&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: process CLAW_START_READ exit&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;RdIRQXit&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|CLAW_START_WRITE
suffix:colon
r_if
c_cond
(paren
id|p_ch-&gt;irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unit Check Occured in &quot;
l_string|&quot;write channel&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;IO_active
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_ch-&gt;irb-&gt;ecw
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Resetting Event &quot;
l_string|&quot;occurred:&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|p_ch-&gt;timer
)paren
suffix:semicolon
id|p_ch-&gt;timer.function
op_assign
(paren
r_void
op_star
)paren
id|claw_write_retry
suffix:semicolon
id|p_ch-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|p_ch
suffix:semicolon
id|p_ch-&gt;timer.expires
op_assign
id|jiffies
op_plus
l_int|10
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|p_ch-&gt;timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: write connection &quot;
l_string|&quot;restarting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;rstrtwrt&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_ch-&gt;irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_EXCEP
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;IO_active
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unit Exception &quot;
l_string|&quot;Occured in write channel&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_SEC_STATUS
)paren
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_eq
id|SCSW_STCTL_STATUS_PEND
)paren
op_logical_or
(paren
id|p_ch-&gt;irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_ALERT_STATUS
op_or
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
)paren
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;writeUE&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;IO_active
)paren
suffix:semicolon
r_if
c_cond
(paren
id|claw_test_and_setbit_busy
c_func
(paren
id|TB_TX
comma
id|dev
)paren
op_eq
l_int|0
)paren
(brace
id|claw_write_next
c_func
(paren
id|p_ch
)paren
suffix:semicolon
id|claw_clearbit_busy
c_func
(paren
id|TB_TX
comma
id|dev
)paren
suffix:semicolon
id|claw_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|p_ch_r
op_assign
(paren
r_struct
id|chbk
op_star
)paren
op_amp
id|privptr-&gt;channel
(braket
id|READ
)braket
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|CLAW_BH_ACTIVE
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch_r-&gt;flag_a
)paren
op_eq
l_int|0
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|p_ch_r-&gt;tasklet
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: process CLAW_START_WRITE exit&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;StWtExit&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: wrong selection code - irq &quot;
l_string|&quot;state=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ch-&gt;claw_state
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;badIRQ&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/*   end of claw_irq_handler    */
multiline_comment|/*-------------------------------------------------------------------*&n;*       claw_irq_tasklet                                             *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_irq_tasklet
id|claw_irq_tasklet
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|chbk
op_star
id|p_ch
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
id|p_ch
op_assign
(paren
r_struct
id|chbk
op_star
)paren
id|data
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|p_ch-&gt;ndev
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable p_ch =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ch
comma
r_sizeof
(paren
r_struct
id|chbk
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;IRQtask&quot;
)paren
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: bh routine - state-%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ch-&gt;claw_state
)paren
suffix:semicolon
macro_line|#endif
id|unpack_read
c_func
(paren
id|dev
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|CLAW_BH_ACTIVE
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;flag_a
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;TskletXt&quot;
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*    end of claw_irq_bh    */
multiline_comment|/*-------------------------------------------------------------------*&n;*       claw_release                                                 *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_release
id|claw_release
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|saveflags
suffix:semicolon
r_int
r_int
id|parm
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_this_ccw
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_buf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|0
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|privptr
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;release&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Priv Buffalloc %d&bslash;n&quot;
comma
id|privptr-&gt;buffs_alloc
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Priv p_buff_ccw = %p&bslash;n&quot;
comma
op_amp
id|privptr-&gt;p_buff_ccw
)paren
suffix:semicolon
macro_line|#endif
id|privptr-&gt;release_pend
op_assign
l_int|1
suffix:semicolon
id|claw_setbit_busy
c_func
(paren
id|TB_STOP
comma
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
multiline_comment|/*   del_timer(&amp;privptr-&gt;channel[READ].timer);  */
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|claw_state
op_assign
id|CLAW_STOP
suffix:semicolon
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|IO_active
op_assign
l_int|0
suffix:semicolon
id|parm
op_assign
(paren
r_int
r_int
)paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|WRITE
)paren
id|claw_purge_skb_queue
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|collect_queue
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_halt
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
comma
id|parm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;system_validate_comp
op_eq
l_int|0x00
)paren
multiline_comment|/* never opened? */
id|init_waitqueue_head
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|wait
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|ccw_check_return_code
c_func
(paren
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|cdev
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|privptr-&gt;pk_skb
op_ne
l_int|NULL
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|privptr-&gt;pk_skb
)paren
suffix:semicolon
id|privptr-&gt;pk_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|privptr-&gt;buffs_alloc
op_ne
l_int|1
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;none2fre&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;freebufs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_buff_ccw
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_ccw
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_ccw_num
)paren
)paren
suffix:semicolon
)brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;freeread&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;read_size
OL
id|PAGE_SIZE
)paren
(brace
r_if
c_cond
(paren
id|privptr-&gt;p_buff_read
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_read
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_read_num
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|p_buf
op_assign
id|privptr-&gt;p_read_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|p_buf-&gt;p_buffer
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perread
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
)brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;freewrit&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;write_size
OL
id|PAGE_SIZE
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_write
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_write_num
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|p_buf
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|p_buf-&gt;p_buffer
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perwrite
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
)brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;clearptr&quot;
)paren
suffix:semicolon
id|privptr-&gt;buffs_alloc
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;p_buff_ccw
op_assign
l_int|NULL
suffix:semicolon
id|privptr-&gt;p_buff_read
op_assign
l_int|NULL
suffix:semicolon
id|privptr-&gt;p_buff_write
op_assign
l_int|NULL
suffix:semicolon
id|privptr-&gt;system_validate_comp
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;release_pend
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      Remove any writes that were pending and reset all reads   */
id|p_this_ccw
op_assign
id|privptr-&gt;p_read_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_this_ccw
op_ne
l_int|NULL
)paren
(brace
id|p_this_ccw-&gt;header.length
op_assign
l_int|0xffff
suffix:semicolon
id|p_this_ccw-&gt;header.opcode
op_assign
l_int|0xff
suffix:semicolon
id|p_this_ccw-&gt;header.flag
op_assign
l_int|0x00
suffix:semicolon
id|p_this_ccw
op_assign
id|p_this_ccw-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
id|privptr-&gt;p_write_active_first
op_ne
l_int|NULL
)paren
(brace
id|p_this_ccw
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
id|p_this_ccw-&gt;header.flag
op_assign
id|CLAW_PENDING
suffix:semicolon
id|privptr-&gt;p_write_active_first
op_assign
id|p_this_ccw-&gt;next
suffix:semicolon
id|p_this_ccw-&gt;next
op_assign
id|privptr-&gt;p_write_free_chain
suffix:semicolon
id|privptr-&gt;p_write_free_chain
op_assign
id|p_this_ccw
suffix:semicolon
op_increment
id|privptr-&gt;write_free_count
suffix:semicolon
)brace
id|privptr-&gt;p_write_active_last
op_assign
l_int|NULL
suffix:semicolon
id|privptr-&gt;mtc_logical_link
op_assign
op_minus
l_int|1
suffix:semicolon
id|privptr-&gt;mtc_skipping
op_assign
l_int|1
suffix:semicolon
id|privptr-&gt;mtc_offset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|last_dstat
op_or
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|last_dstat
)paren
op_amp
op_complement
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
)paren
)paren
op_ne
l_int|0x00
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: channel problems during close - &quot;
l_string|&quot;read: %02x -  write: %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|last_dstat
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|last_dstat
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;badclose&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;rlsexit&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end of claw_release     */
multiline_comment|/*-------------------------------------------------------------------*&n;*       claw_write_retry                                             *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_write_retry
id|claw_write_retry
(paren
r_struct
id|chbk
op_star
id|p_ch
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|p_ch-&gt;ndev
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: variable p_ch =&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ch
comma
r_sizeof
(paren
r_struct
id|chbk
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;w_retry&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_ch-&gt;claw_state
op_eq
id|CLAW_STOP
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s  state-%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|p_ch-&gt;claw_state
)paren
suffix:semicolon
macro_line|#endif
id|claw_strt_out_IO
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;rtry_xit&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* end of claw_write_retry      */
multiline_comment|/*-------------------------------------------------------------------*&n;*       claw_write_next                                              *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_write_next
id|claw_write_next
(paren
r_struct
id|chbk
op_star
id|p_ch
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
id|pk_skb
suffix:semicolon
r_int
id|rc
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter  &bslash;n&quot;
comma
id|p_ch-&gt;ndev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable p_ch =&bslash;n&quot;
comma
id|p_ch-&gt;ndev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ch
comma
r_sizeof
(paren
r_struct
id|chbk
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;claw_wrt&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_ch-&gt;claw_state
op_eq
id|CLAW_STOP
)paren
r_return
suffix:semicolon
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|p_ch-&gt;ndev
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|claw_free_wrt_buf
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|privptr-&gt;write_free_count
OG
l_int|0
)paren
op_logical_and
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|p_ch-&gt;collect_queue
)paren
OG
l_int|0
)paren
)paren
(brace
id|pk_skb
op_assign
id|claw_pack_skb
c_func
(paren
id|privptr
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pk_skb
op_ne
l_int|NULL
)paren
(brace
id|rc
op_assign
id|claw_hw_tx
c_func
(paren
id|pk_skb
comma
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;write_free_count
OG
l_int|0
)paren
(brace
id|pk_skb
op_assign
id|claw_pack_skb
c_func
(paren
id|privptr
)paren
suffix:semicolon
)brace
r_else
id|pk_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|privptr-&gt;p_write_active_first
op_ne
l_int|NULL
)paren
(brace
id|claw_strt_out_IO
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* end of claw_write_next      */
multiline_comment|/*-------------------------------------------------------------------*&n;*                                                                    *&n;*       claw_timer                                                   *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_timer
id|claw_timer
(paren
r_struct
id|chbk
op_star
id|p_ch
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Entry&bslash;n&quot;
comma
id|p_ch-&gt;ndev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable p_ch =&bslash;n&quot;
comma
id|p_ch-&gt;ndev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ch
comma
r_sizeof
(paren
r_struct
id|chbk
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;timer&quot;
)paren
suffix:semicolon
id|p_ch-&gt;flag
op_or_assign
id|CLAW_TIMER
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|p_ch-&gt;wait
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|p_ch-&gt;ndev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/* end of claw_timer  */
multiline_comment|/*&n;*&n;*       functions&n;*/
multiline_comment|/*-------------------------------------------------------------------*&n;*                                                                    *&n;*     pages_to_order_of_mag                                          *&n;*                                                                    *&n;*    takes a number of pages from 1 to 512 and returns the           *&n;*    log(num_pages)/log(2) get_free_pages() needs a base 2 order     *&n;*    of magnitude get_free_pages() has an upper order of 9           *&n;*--------------------------------------------------------------------*/
r_static
r_int
r_inline
DECL|function|pages_to_order_of_mag
id|pages_to_order_of_mag
c_func
(paren
r_int
id|num_of_pages
)paren
(brace
r_int
id|order_of_mag
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* assume 2 pages */
r_int
id|nump
op_assign
l_int|2
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Enter pages = %d &bslash;n&quot;
comma
id|__FUNCTION__
comma
id|num_of_pages
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|5
comma
id|trace
comma
l_string|&quot;pages%d&quot;
comma
id|num_of_pages
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_of_pages
op_eq
l_int|1
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* magnitude of 0 = 1 page */
multiline_comment|/* 512 pages = 2Meg on 4k page systems */
r_if
c_cond
(paren
id|num_of_pages
op_ge
l_int|512
)paren
(brace
r_return
l_int|9
suffix:semicolon
)brace
multiline_comment|/* we have two or more pages order is at least 1 */
r_for
c_loop
(paren
id|nump
op_assign
l_int|2
suffix:semicolon
id|nump
op_le
l_int|512
suffix:semicolon
id|nump
op_mul_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|num_of_pages
op_le
id|nump
)paren
r_break
suffix:semicolon
id|order_of_mag
op_add_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|order_of_mag
OG
l_int|9
)paren
(brace
id|order_of_mag
op_assign
l_int|9
suffix:semicolon
)brace
multiline_comment|/* I know it&squot;s paranoid */
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Exit on line %d, order = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|__LINE__
comma
id|order_of_mag
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|5
comma
id|trace
comma
l_string|&quot;mag%d&quot;
comma
id|order_of_mag
)paren
suffix:semicolon
r_return
id|order_of_mag
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*&n;*                                                                    *&n;*     add_claw_reads                                                 *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|add_claw_reads
id|add_claw_reads
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ccwbk
op_star
id|p_first
comma
r_struct
id|ccwbk
op_star
id|p_last
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_struct
id|ccw1
id|temp_ccw
suffix:semicolon
r_struct
id|endccw
op_star
id|p_end
suffix:semicolon
macro_line|#ifdef IOTRACE
r_struct
id|ccwbk
op_star
id|p_buf
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;dev&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;p_first&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_first
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;p_last&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_last
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;addreads&quot;
)paren
suffix:semicolon
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|p_end
op_assign
id|privptr-&gt;p_end_ccw
suffix:semicolon
multiline_comment|/* first CCW and last CCW contains a new set of read channel programs&n;        *       to apend the running channel programs&n;        */
r_if
c_cond
(paren
id|p_first
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;addexit&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set up ending CCW sequence for this segment */
r_if
c_cond
(paren
id|p_end-&gt;read1
)paren
(brace
id|p_end-&gt;read1
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/*  second ending CCW is now active */
multiline_comment|/*      reset ending CCWs and setup TIC CCWs              */
id|p_end-&gt;read2_nop2.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_end-&gt;read2_nop2.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SKIP
suffix:semicolon
id|p_last-&gt;r_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_end-&gt;read2_nop1
)paren
suffix:semicolon
id|p_last-&gt;r_TIC_2.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_end-&gt;read2_nop1
)paren
suffix:semicolon
id|p_end-&gt;read2_nop2.cda
op_assign
l_int|0
suffix:semicolon
id|p_end-&gt;read2_nop2.count
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|p_end-&gt;read1
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* first ending CCW is now active */
multiline_comment|/*      reset ending CCWs and setup TIC CCWs          */
id|p_end-&gt;read1_nop2.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_end-&gt;read1_nop2.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SKIP
suffix:semicolon
id|p_last-&gt;r_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_end-&gt;read1_nop1
)paren
suffix:semicolon
id|p_last-&gt;r_TIC_2.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_end-&gt;read1_nop1
)paren
suffix:semicolon
id|p_end-&gt;read1_nop2.cda
op_assign
l_int|0
suffix:semicolon
id|p_end-&gt;read1_nop2.count
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|privptr
op_member_access_from_pointer
id|p_read_active_first
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s p_read_active_frist == NULL &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Read active first/last changed &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|privptr
op_member_access_from_pointer
id|p_read_active_first
op_assign
id|p_first
suffix:semicolon
multiline_comment|/*    set new first */
id|privptr
op_member_access_from_pointer
id|p_read_active_last
op_assign
id|p_last
suffix:semicolon
multiline_comment|/*    set new last  */
)brace
r_else
(brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Read in progress &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* set up TIC ccw  */
id|temp_ccw.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first-&gt;read
)paren
suffix:semicolon
id|temp_ccw.count
op_assign
l_int|0
suffix:semicolon
id|temp_ccw.flags
op_assign
l_int|0
suffix:semicolon
id|temp_ccw.cmd_code
op_assign
id|CCW_CLAW_CMD_TIC
suffix:semicolon
r_if
c_cond
(paren
id|p_end-&gt;read1
)paren
(brace
multiline_comment|/* first set of CCW&squot;s is chained to the new read              */
multiline_comment|/* chain, so the second set is chained to the active chain.   */
multiline_comment|/* Therefore modify the second set to point to the new        */
multiline_comment|/* read chain set up TIC CCWs                                 */
multiline_comment|/* make sure we update the CCW so channel doesn&squot;t fetch it    */
multiline_comment|/* when it&squot;s only half done                                   */
id|memcpy
c_func
(paren
op_amp
id|p_end-&gt;read2_nop2
comma
op_amp
id|temp_ccw
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
id|privptr-&gt;p_read_active_last-&gt;r_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first-&gt;read
)paren
suffix:semicolon
id|privptr-&gt;p_read_active_last-&gt;r_TIC_2.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first-&gt;read
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* make sure we update the CCW so channel doesn&squot;t   */
multiline_comment|/* fetch it when it is only half done               */
id|memcpy
c_func
(paren
op_amp
id|p_end-&gt;read1_nop2
comma
op_amp
id|temp_ccw
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
id|privptr-&gt;p_read_active_last-&gt;r_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first-&gt;read
)paren
suffix:semicolon
id|privptr-&gt;p_read_active_last-&gt;r_TIC_2.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first-&gt;read
)paren
suffix:semicolon
)brace
multiline_comment|/*      chain in new set of blocks                              */
id|privptr-&gt;p_read_active_last-&gt;next
op_assign
id|p_first
suffix:semicolon
id|privptr-&gt;p_read_active_last
op_assign
id|p_last
suffix:semicolon
)brace
multiline_comment|/* end of if ( privptr-&gt; p_read_active_first ==NULL)  */
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s  dump p_last CCW BK &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_last
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s  dump p_end CCW BK &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_end
comma
r_sizeof
(paren
r_struct
id|endccw
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s dump p_first CCW BK &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_first
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Dump Active CCW chain &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|p_buf
op_assign
id|privptr-&gt;p_read_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;addexit&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*     end of add_claw_reads   */
multiline_comment|/*-------------------------------------------------------------------*&n; *   ccw_check_return_code                                           *&n; *                                                                   *&n; *-------------------------------------------------------------------*/
r_static
r_void
r_inline
DECL|function|ccw_check_return_code
id|ccw_check_return_code
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|return_code
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; enter  &bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;ccwret&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;variable cdev =&bslash;n&quot;
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|cdev
comma
r_sizeof
(paren
r_struct
id|ccw_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;variable return_code = %d&bslash;n&quot;
comma
id|return_code
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|return_code
op_ne
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|return_code
)paren
(brace
r_case
op_minus
id|EBUSY
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Busy !&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENODEV
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;%s: Missing device called &quot;
l_string|&quot;for IO ENODEV&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EIO
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;%s: Status pending... EIO &bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EINVAL
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;%s: Invalid Dev State EINVAL &bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;%s: Unknown error in &quot;
l_string|&quot;Do_IO %d&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|return_code
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; exit on line %d&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;ccwret&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*    end of ccw_check_return_code   */
multiline_comment|/*-------------------------------------------------------------------*&n;*       ccw_check_unit_check                                         *&n;*--------------------------------------------------------------------*/
r_static
r_void
r_inline
DECL|function|ccw_check_unit_check
id|ccw_check_unit_check
c_func
(paren
r_struct
id|chbk
op_star
id|p_ch
comma
r_int
r_char
id|sense
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|p_ch-&gt;ndev
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable sense =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|sense
comma
l_int|2
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;unitchek&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Unit Check with sense byte:0x%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|sense
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense
op_amp
l_int|0x40
)paren
(brace
r_if
c_cond
(paren
id|sense
op_amp
l_int|0x01
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Interface disconnect or &quot;
l_string|&quot;Selective reset &quot;
l_string|&quot;occurred (remote side)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: System reset occured&quot;
l_string|&quot; (remote side)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sense
op_amp
l_int|0x20
)paren
(brace
r_if
c_cond
(paren
id|sense
op_amp
l_int|0x04
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Data-streaming &quot;
l_string|&quot;timeout)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Data-transfer parity&quot;
l_string|&quot; error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sense
op_amp
l_int|0x10
)paren
(brace
r_if
c_cond
(paren
id|sense
op_amp
l_int|0x20
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Hardware malfunction &quot;
l_string|&quot;(remote side)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: read-data parity error &quot;
l_string|&quot;(remote side)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*    end of ccw_check_unit_check    */
multiline_comment|/*-------------------------------------------------------------------*&n;* Dump buffer format                                                 *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
macro_line|#ifdef DEBUG
r_static
r_void
DECL|function|dumpit
id|dumpit
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
id|__u32
id|ct
comma
id|sw
comma
id|rm
comma
id|dup
suffix:semicolon
r_char
op_star
id|ptr
comma
op_star
id|rptr
suffix:semicolon
r_char
id|tbuf
(braket
l_int|82
)braket
comma
id|tdup
(braket
l_int|82
)braket
suffix:semicolon
macro_line|#if (CONFIG_ARCH_S390X)
r_char
id|addr
(braket
l_int|22
)braket
suffix:semicolon
macro_line|#else
r_char
id|addr
(braket
l_int|12
)braket
suffix:semicolon
macro_line|#endif
r_char
id|boff
(braket
l_int|12
)braket
suffix:semicolon
r_char
id|bhex
(braket
l_int|82
)braket
comma
id|duphex
(braket
l_int|82
)braket
suffix:semicolon
r_char
id|basc
(braket
l_int|40
)braket
suffix:semicolon
id|sw
op_assign
l_int|0
suffix:semicolon
id|rptr
op_assign
id|ptr
op_assign
id|buf
suffix:semicolon
id|rm
op_assign
l_int|16
suffix:semicolon
id|duphex
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
id|dup
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ct
op_assign
l_int|0
suffix:semicolon
id|ct
OL
id|len
suffix:semicolon
id|ct
op_increment
comma
id|ptr
op_increment
comma
id|rptr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sw
op_eq
l_int|0
)paren
(brace
macro_line|#if (CONFIG_ARCH_S390X)
id|sprintf
c_func
(paren
id|addr
comma
l_string|&quot;%16.16lX&quot;
comma
(paren
r_int
r_int
)paren
id|rptr
)paren
suffix:semicolon
macro_line|#else
id|sprintf
c_func
(paren
id|addr
comma
l_string|&quot;%8.8X&quot;
comma
(paren
id|__u32
)paren
id|rptr
)paren
suffix:semicolon
macro_line|#endif
id|sprintf
c_func
(paren
id|boff
comma
l_string|&quot;%4.4X&quot;
comma
(paren
id|__u32
)paren
id|ct
)paren
suffix:semicolon
id|bhex
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|basc
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sw
op_eq
l_int|4
)paren
op_logical_or
(paren
id|sw
op_eq
l_int|12
)paren
)paren
(brace
id|strcat
c_func
(paren
id|bhex
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sw
op_eq
l_int|8
)paren
(brace
id|strcat
c_func
(paren
id|bhex
comma
l_string|&quot;  &quot;
)paren
suffix:semicolon
)brace
macro_line|#if (CONFIG_ARCH_S390X)
id|sprintf
c_func
(paren
id|tbuf
comma
l_string|&quot;%2.2lX&quot;
comma
(paren
r_int
r_int
)paren
op_star
id|ptr
)paren
suffix:semicolon
macro_line|#else
id|sprintf
c_func
(paren
id|tbuf
comma
l_string|&quot;%2.2X&quot;
comma
(paren
id|__u32
)paren
op_star
id|ptr
)paren
suffix:semicolon
macro_line|#endif
id|tbuf
(braket
l_int|2
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strcat
c_func
(paren
id|bhex
comma
id|tbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|0
op_ne
id|isprint
c_func
(paren
op_star
id|ptr
)paren
)paren
op_logical_and
(paren
op_star
id|ptr
op_ge
l_int|0x20
)paren
)paren
(brace
id|basc
(braket
id|sw
)braket
op_assign
op_star
id|ptr
suffix:semicolon
)brace
r_else
(brace
id|basc
(braket
id|sw
)braket
op_assign
l_char|&squot;.&squot;
suffix:semicolon
)brace
id|basc
(braket
id|sw
op_plus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|sw
op_increment
suffix:semicolon
id|rm
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|sw
op_eq
l_int|16
)paren
(brace
r_if
c_cond
(paren
(paren
id|strcmp
c_func
(paren
id|duphex
comma
id|bhex
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|dup
op_ne
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|tdup
comma
l_string|&quot;Duplicate as above to&quot;
l_string|&quot; %s&quot;
comma
id|addr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;                 &quot;
l_string|&quot;   --- %s ---&bslash;n&quot;
comma
id|tdup
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;   %s (+%s) : %s  [%s]&bslash;n&quot;
comma
id|addr
comma
id|boff
comma
id|bhex
comma
id|basc
)paren
suffix:semicolon
id|dup
op_assign
l_int|0
suffix:semicolon
id|strcpy
c_func
(paren
id|duphex
comma
id|bhex
)paren
suffix:semicolon
)brace
r_else
(brace
id|dup
op_increment
suffix:semicolon
)brace
id|sw
op_assign
l_int|0
suffix:semicolon
id|rm
op_assign
l_int|16
suffix:semicolon
)brace
)brace
multiline_comment|/* endfor */
r_if
c_cond
(paren
id|sw
op_ne
l_int|0
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|rm
OG
l_int|0
suffix:semicolon
id|rm
op_decrement
comma
id|sw
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|sw
op_eq
l_int|4
)paren
op_logical_or
(paren
id|sw
op_eq
l_int|12
)paren
)paren
id|strcat
c_func
(paren
id|bhex
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sw
op_eq
l_int|8
)paren
id|strcat
c_func
(paren
id|bhex
comma
l_string|&quot;  &quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|bhex
comma
l_string|&quot;  &quot;
)paren
suffix:semicolon
id|strcat
c_func
(paren
id|basc
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dup
op_ne
l_int|0
)paren
(brace
id|sprintf
c_func
(paren
id|tdup
comma
l_string|&quot;Duplicate as above to %s&quot;
comma
id|addr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;                    --- %s ---&bslash;n&quot;
comma
id|tdup
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;   %s (+%s) : %s  [%s]&bslash;n&quot;
comma
id|addr
comma
id|boff
comma
id|bhex
comma
id|basc
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dup
op_ge
l_int|1
)paren
(brace
id|sprintf
c_func
(paren
id|tdup
comma
l_string|&quot;Duplicate as above to %s&quot;
comma
id|addr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;                    --- %s ---&bslash;n&quot;
comma
id|tdup
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dup
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;   %s (+%s) : %s  [%s]&bslash;n&quot;
comma
id|addr
comma
id|boff
comma
id|bhex
comma
id|basc
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*   end of dumpit  */
macro_line|#endif
multiline_comment|/*-------------------------------------------------------------------*&n;*               find_link                                            *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|find_link
id|find_link
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_char
op_star
id|host_name
comma
r_char
op_star
id|ws_name
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s &gt; enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;findlink&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev = &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable host_name = %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|host_name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable ws_name = %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ws_name
)paren
suffix:semicolon
macro_line|#endif
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|p_env
op_assign
id|privptr-&gt;p_env
suffix:semicolon
r_switch
c_cond
(paren
id|p_env-&gt;packing
)paren
(brace
r_case
id|PACKING_ASK
suffix:colon
r_if
c_cond
(paren
(paren
id|memcmp
c_func
(paren
id|WS_APPL_NAME_PACKED
comma
id|host_name
comma
l_int|8
)paren
op_ne
l_int|0
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
id|WS_APPL_NAME_PACKED
comma
id|ws_name
comma
l_int|8
)paren
op_ne
l_int|0
)paren
)paren
id|rc
op_assign
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DO_PACKED
suffix:colon
r_case
id|PACK_SEND
suffix:colon
r_if
c_cond
(paren
(paren
id|memcmp
c_func
(paren
id|WS_APPL_NAME_IP_NAME
comma
id|host_name
comma
l_int|8
)paren
op_ne
l_int|0
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
id|WS_APPL_NAME_IP_NAME
comma
id|ws_name
comma
l_int|8
)paren
op_ne
l_int|0
)paren
)paren
id|rc
op_assign
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|memcmp
c_func
(paren
id|HOST_APPL_NAME
comma
id|host_name
comma
l_int|8
)paren
op_ne
l_int|0
)paren
op_logical_or
(paren
id|memcmp
c_func
(paren
id|p_env-&gt;api_type
comma
id|ws_name
comma
l_int|8
)paren
op_ne
l_int|0
)paren
)paren
id|rc
op_assign
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*    end of find_link    */
multiline_comment|/*-------------------------------------------------------------------*&n; *   claw_hw_tx                                                      *&n; *                                                                   *&n; *                                                                   *&n; *-------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_hw_tx
id|claw_hw_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|linkid
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_this_ccw
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_first_ccw
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_last_ccw
suffix:semicolon
id|__u32
id|numBuffers
suffix:semicolon
r_int
r_int
id|len_of_data
suffix:semicolon
r_int
r_int
id|bytesInThisBuffer
suffix:semicolon
r_int
r_char
op_star
id|pDataAddress
suffix:semicolon
r_struct
id|endccw
op_star
id|pEnd
suffix:semicolon
r_struct
id|ccw1
id|tempCCW
suffix:semicolon
r_struct
id|chbk
op_star
id|p_ch
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_int
id|lock
suffix:semicolon
r_struct
id|clawph
op_star
id|pk_head
suffix:semicolon
r_struct
id|chbk
op_star
id|ch
suffix:semicolon
macro_line|#ifdef IOTRACE
r_struct
id|ccwbk
op_star
id|p_buf
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;hw_tx&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev skb =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|skb
comma
r_sizeof
(paren
r_struct
id|sk_buff
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable linkid = %ld&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|linkid
)paren
suffix:semicolon
macro_line|#endif
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|p_ch
op_assign
(paren
r_struct
id|chbk
op_star
)paren
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
id|p_env
op_assign
id|privptr-&gt;p_env
suffix:semicolon
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() dump sk_buff  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|skb
comma
r_sizeof
(paren
r_struct
id|sk_buff
)paren
)paren
suffix:semicolon
macro_line|#endif
id|claw_free_wrt_buf
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Clean up free chain if posible */
multiline_comment|/*  scan the write queue to free any completed write packets   */
id|p_first_ccw
op_assign
l_int|NULL
suffix:semicolon
id|p_last_ccw
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p_env-&gt;packing
op_ge
id|PACK_SEND
)paren
op_logical_and
(paren
id|skb-&gt;cb
(braket
l_int|1
)braket
op_ne
l_char|&squot;P&squot;
)paren
)paren
(brace
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|clawph
)paren
)paren
suffix:semicolon
id|pk_head
op_assign
(paren
r_struct
id|clawph
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|pk_head-&gt;len
op_assign
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|clawph
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pk_head-&gt;len
op_mod
l_int|4
)paren
(brace
id|pk_head-&gt;len
op_add_assign
l_int|4
op_minus
(paren
id|pk_head-&gt;len
op_mod
l_int|4
)paren
suffix:semicolon
id|skb_pad
c_func
(paren
id|skb
comma
l_int|4
op_minus
(paren
id|pk_head-&gt;len
op_mod
l_int|4
)paren
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
l_int|4
op_minus
(paren
id|pk_head-&gt;len
op_mod
l_int|4
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_env-&gt;packing
op_eq
id|DO_PACKED
)paren
id|pk_head-&gt;link_num
op_assign
id|linkid
suffix:semicolon
r_else
id|pk_head-&gt;link_num
op_assign
l_int|0
suffix:semicolon
id|pk_head-&gt;flag
op_assign
l_int|0x00
suffix:semicolon
id|skb_pad
c_func
(paren
id|skb
comma
l_int|4
)paren
suffix:semicolon
id|skb-&gt;cb
(braket
l_int|1
)braket
op_assign
l_char|&squot;P&squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkid
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|claw_check_busy
c_func
(paren
id|dev
)paren
)paren
(brace
r_if
c_cond
(paren
id|privptr-&gt;write_free_count
op_ne
l_int|0
)paren
(brace
id|claw_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|claw_strt_out_IO
c_func
(paren
id|dev
)paren
suffix:semicolon
id|claw_free_wrt_buf
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;write_free_count
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: &quot;
l_string|&quot;(claw_check_busy) no free write &quot;
l_string|&quot;buffers&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|ch-&gt;collect_queue
comma
id|skb
)paren
suffix:semicolon
r_goto
id|Done
suffix:semicolon
)brace
r_else
(brace
id|claw_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*  tx lock  */
r_if
c_cond
(paren
id|claw_test_and_setbit_busy
c_func
(paren
id|TB_TX
comma
id|dev
)paren
)paren
(brace
multiline_comment|/* set to busy */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  busy  (claw_test_and_setbit_&quot;
l_string|&quot;busy)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
id|ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|ch-&gt;collect_queue
comma
id|skb
)paren
suffix:semicolon
id|claw_strt_out_IO
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|Done2
suffix:semicolon
)brace
)brace
multiline_comment|/*      See how many write buffers are required to hold this data */
id|numBuffers
op_assign
(paren
id|skb-&gt;len
op_plus
id|privptr-&gt;p_env-&gt;write_size
op_minus
l_int|1
)paren
op_div
(paren
id|privptr-&gt;p_env-&gt;write_size
)paren
suffix:semicolon
multiline_comment|/*      If that number of buffers isn&squot;t available, give up for now */
r_if
c_cond
(paren
id|privptr-&gt;write_free_count
OL
id|numBuffers
op_logical_or
id|privptr-&gt;p_write_free_chain
op_eq
l_int|NULL
)paren
(brace
id|claw_setbit_busy
c_func
(paren
id|TB_NOBUFFER
comma
id|dev
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  busy  (claw_setbit_busy&quot;
l_string|&quot;(TB_NOBUFFER))&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;       free_count: %d, numBuffers : %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|privptr-&gt;write_free_count
comma
(paren
r_int
)paren
id|numBuffers
)paren
suffix:semicolon
macro_line|#endif
id|ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|ch-&gt;collect_queue
comma
id|skb
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;clawbusy&quot;
)paren
suffix:semicolon
r_goto
id|Done2
suffix:semicolon
)brace
id|pDataAddress
op_assign
id|skb-&gt;data
suffix:semicolon
id|len_of_data
op_assign
id|skb-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|len_of_data
OG
l_int|0
)paren
(brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() length-of-data is %ld &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|len_of_data
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|pDataAddress
comma
l_int|64
)paren
suffix:semicolon
macro_line|#endif
id|p_this_ccw
op_assign
id|privptr-&gt;p_write_free_chain
suffix:semicolon
multiline_comment|/* get a block */
r_if
c_cond
(paren
id|p_this_ccw
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* lost the race */
id|ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|ch-&gt;collect_queue
comma
id|skb
)paren
suffix:semicolon
r_goto
id|Done2
suffix:semicolon
)brace
id|privptr-&gt;p_write_free_chain
op_assign
id|p_this_ccw-&gt;next
suffix:semicolon
id|p_this_ccw-&gt;next
op_assign
l_int|NULL
suffix:semicolon
op_decrement
id|privptr-&gt;write_free_count
suffix:semicolon
multiline_comment|/* -1 */
id|bytesInThisBuffer
op_assign
id|len_of_data
suffix:semicolon
id|memcpy
c_func
(paren
id|p_this_ccw-&gt;p_buffer
comma
id|pDataAddress
comma
id|bytesInThisBuffer
)paren
suffix:semicolon
id|len_of_data
op_sub_assign
id|bytesInThisBuffer
suffix:semicolon
id|pDataAddress
op_add_assign
(paren
r_int
r_int
)paren
id|bytesInThisBuffer
suffix:semicolon
multiline_comment|/*      setup write CCW         */
id|p_this_ccw-&gt;write.cmd_code
op_assign
(paren
id|linkid
op_star
l_int|8
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len_of_data
OG
l_int|0
)paren
(brace
id|p_this_ccw-&gt;write.cmd_code
op_add_assign
id|MORE_to_COME_FLAG
suffix:semicolon
)brace
id|p_this_ccw-&gt;write.count
op_assign
id|bytesInThisBuffer
suffix:semicolon
multiline_comment|/*      now add to end of this chain    */
r_if
c_cond
(paren
id|p_first_ccw
op_eq
l_int|NULL
)paren
(brace
id|p_first_ccw
op_assign
id|p_this_ccw
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_last_ccw
op_ne
l_int|NULL
)paren
(brace
id|p_last_ccw-&gt;next
op_assign
id|p_this_ccw
suffix:semicolon
multiline_comment|/*      set up TIC ccws         */
id|p_last_ccw-&gt;w_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_this_ccw-&gt;write
)paren
suffix:semicolon
)brace
id|p_last_ccw
op_assign
id|p_this_ccw
suffix:semicolon
multiline_comment|/* save new last block */
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; CCW and Buffer %ld bytes long &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|bytesInThisBuffer
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_this_ccw
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_this_ccw-&gt;p_buffer
comma
l_int|64
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*      FirstCCW and LastCCW now contain a new set of write channel&n;        *       programs to append to the running channel program&n;        */
r_if
c_cond
(paren
id|p_first_ccw
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/*      setup ending ccw sequence for this segment              */
id|pEnd
op_assign
id|privptr-&gt;p_end_ccw
suffix:semicolon
r_if
c_cond
(paren
id|pEnd-&gt;write1
)paren
(brace
id|pEnd-&gt;write1
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/* second end ccw is now active */
multiline_comment|/*      set up Tic CCWs         */
id|p_last_ccw-&gt;w_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|pEnd-&gt;write2_nop1
)paren
suffix:semicolon
id|pEnd-&gt;write2_nop2.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|pEnd-&gt;write2_nop2.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SKIP
suffix:semicolon
id|pEnd-&gt;write2_nop2.cda
op_assign
l_int|0
suffix:semicolon
id|pEnd-&gt;write2_nop2.count
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*  end of if (pEnd-&gt;write1)*/
id|pEnd-&gt;write1
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* first end ccw is now active */
multiline_comment|/*      set up Tic CCWs         */
id|p_last_ccw-&gt;w_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|pEnd-&gt;write1_nop1
)paren
suffix:semicolon
id|pEnd-&gt;write1_nop2.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|pEnd-&gt;write1_nop2.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SKIP
suffix:semicolon
id|pEnd-&gt;write1_nop2.cda
op_assign
l_int|0
suffix:semicolon
id|pEnd-&gt;write1_nop2.count
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* end if if (pEnd-&gt;write1) */
r_if
c_cond
(paren
id|privptr-&gt;p_write_active_first
op_eq
l_int|NULL
)paren
(brace
id|privptr-&gt;p_write_active_first
op_assign
id|p_first_ccw
suffix:semicolon
id|privptr-&gt;p_write_active_last
op_assign
id|p_last_ccw
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*      set up Tic CCWs         */
id|tempCCW.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first_ccw-&gt;write
)paren
suffix:semicolon
id|tempCCW.count
op_assign
l_int|0
suffix:semicolon
id|tempCCW.flags
op_assign
l_int|0
suffix:semicolon
id|tempCCW.cmd_code
op_assign
id|CCW_CLAW_CMD_TIC
suffix:semicolon
r_if
c_cond
(paren
id|pEnd-&gt;write1
)paren
(brace
multiline_comment|/*&n;                 * first set of ending CCW&squot;s is chained to the new write&n;                 * chain, so the second set is chained to the active chain&n;                 * Therefore modify the second set to point the new write chain.&n;                 * make sure we update the CCW atomically&n;                 * so channel does not fetch it when it&squot;s only half done&n;                 */
id|memcpy
c_func
(paren
op_amp
id|pEnd-&gt;write2_nop2
comma
op_amp
id|tempCCW
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
id|privptr-&gt;p_write_active_last-&gt;w_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first_ccw-&gt;write
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*make sure we update the CCW atomically&n;                         *so channel does not fetch it when it&squot;s only half done&n;                         */
id|memcpy
c_func
(paren
op_amp
id|pEnd-&gt;write1_nop2
comma
op_amp
id|tempCCW
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
id|privptr-&gt;p_write_active_last-&gt;w_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first_ccw-&gt;write
)paren
suffix:semicolon
)brace
multiline_comment|/* end if if (pEnd-&gt;write1) */
id|privptr-&gt;p_write_active_last-&gt;next
op_assign
id|p_first_ccw
suffix:semicolon
id|privptr-&gt;p_write_active_last
op_assign
id|p_last_ccw
suffix:semicolon
)brace
)brace
multiline_comment|/* endif (p_first_ccw!=NULL)  */
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt;  Dump Active CCW chain &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|p_buf
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
id|p_buf
op_assign
(paren
r_struct
id|ccwbk
op_star
)paren
id|privptr-&gt;p_end_ccw
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|endccw
)paren
)paren
suffix:semicolon
macro_line|#endif
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|linkid
op_eq
l_int|0
)paren
(brace
id|lock
op_assign
id|LOCK_NO
suffix:semicolon
)brace
r_else
(brace
id|lock
op_assign
id|LOCK_YES
suffix:semicolon
)brace
id|claw_strt_out_IO
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/*      if write free count is zero , set NOBUFFER       */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; free_count is %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
(paren
r_int
)paren
id|privptr-&gt;write_free_count
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|privptr-&gt;write_free_count
op_eq
l_int|0
)paren
(brace
id|claw_setbit_busy
c_func
(paren
id|TB_NOBUFFER
comma
id|dev
)paren
suffix:semicolon
)brace
id|Done2
suffix:colon
id|claw_clearbit_busy
c_func
(paren
id|TB_TX
comma
id|dev
)paren
suffix:semicolon
id|Done
suffix:colon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; exit on line %d, rc = %d &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*    end of claw_hw_tx    */
multiline_comment|/*-------------------------------------------------------------------*&n;*                                                                    *&n;*     init_ccw_bk                                                    *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|init_ccw_bk
id|init_ccw_bk
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|__u32
id|ccw_blocks_required
suffix:semicolon
id|__u32
id|ccw_blocks_perpage
suffix:semicolon
id|__u32
id|ccw_pages_required
suffix:semicolon
id|__u32
id|claw_reads_perpage
op_assign
l_int|1
suffix:semicolon
id|__u32
id|claw_read_pages
suffix:semicolon
id|__u32
id|claw_writes_perpage
op_assign
l_int|1
suffix:semicolon
id|__u32
id|claw_write_pages
suffix:semicolon
r_void
op_star
id|p_buff
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_free_chain
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_buf
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_last_CCWB
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_first_CCWB
suffix:semicolon
r_struct
id|endccw
op_star
id|p_endccw
op_assign
l_int|NULL
suffix:semicolon
id|addr_t
id|real_address
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|clawh
op_star
id|pClawH
op_assign
l_int|NULL
suffix:semicolon
id|addr_t
id|real_TIC_address
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;init_ccw&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*  initialize  statistics field */
id|privptr-&gt;active_link_ID
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  initialize  ccwbk pointers  */
id|privptr-&gt;p_write_free_chain
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to free ccw chain*/
id|privptr-&gt;p_write_active_first
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to the first write ccw*/
id|privptr-&gt;p_write_active_last
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to the last write ccw*/
id|privptr-&gt;p_read_active_first
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to the first read ccw*/
id|privptr-&gt;p_read_active_last
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to the last read ccw */
id|privptr-&gt;p_end_ccw
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to ending ccw        */
id|privptr-&gt;p_claw_signal_blk
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* pointer to signal block      */
id|privptr-&gt;buffs_alloc
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|privptr-&gt;end_ccw
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|endccw
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|privptr-&gt;ctl_bk
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
multiline_comment|/*  initialize  free write ccwbk counter  */
id|privptr-&gt;write_free_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* number of free bufs on write chain */
id|p_last_CCWB
op_assign
l_int|NULL
suffix:semicolon
id|p_first_CCWB
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;        *  We need 1 CCW block for each read buffer, 1 for each&n;        *  write buffer, plus 1 for ClawSignalBlock&n;        */
id|ccw_blocks_required
op_assign
id|privptr-&gt;p_env-&gt;read_buffers
op_plus
id|privptr-&gt;p_env-&gt;write_buffers
op_plus
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &quot;
l_string|&quot;ccw_blocks_required=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|ccw_blocks_required
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &quot;
l_string|&quot;PAGE_SIZE=0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
(paren
r_int
r_int
)paren
id|PAGE_SIZE
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; &quot;
l_string|&quot;PAGE_MASK=0x%x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
(paren
r_int
r_int
)paren
id|PAGE_MASK
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;        * compute number of CCW blocks that will fit in a page&n;        */
id|ccw_blocks_perpage
op_assign
id|PAGE_SIZE
op_div
id|CCWBK_SIZE
suffix:semicolon
id|ccw_pages_required
op_assign
(paren
id|ccw_blocks_required
op_plus
id|ccw_blocks_perpage
op_minus
l_int|1
)paren
op_div
id|ccw_blocks_perpage
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; ccw_blocks_perpage=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|ccw_blocks_perpage
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; ccw_pages_required=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|ccw_pages_required
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;         *  read and write sizes are set by 2 constants in claw.h&n;&t; *  4k and 32k.  Unpacked values other than 4k are not going to&n;&t; * provide good performance. With packing buffers support 32k&n;&t; * buffers are used.&n;         */
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;read_size
OL
id|PAGE_SIZE
)paren
(brace
id|claw_reads_perpage
op_assign
id|PAGE_SIZE
op_div
id|privptr-&gt;p_env-&gt;read_size
suffix:semicolon
id|claw_read_pages
op_assign
(paren
id|privptr-&gt;p_env-&gt;read_buffers
op_plus
id|claw_reads_perpage
op_minus
l_int|1
)paren
op_div
id|claw_reads_perpage
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &gt; or equal  */
id|privptr-&gt;p_buff_pages_perread
op_assign
(paren
id|privptr-&gt;p_env-&gt;read_size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
id|claw_read_pages
op_assign
id|privptr-&gt;p_env-&gt;read_buffers
op_star
id|privptr-&gt;p_buff_pages_perread
suffix:semicolon
)brace
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;write_size
OL
id|PAGE_SIZE
)paren
(brace
id|claw_writes_perpage
op_assign
id|PAGE_SIZE
op_div
id|privptr-&gt;p_env-&gt;write_size
suffix:semicolon
id|claw_write_pages
op_assign
(paren
id|privptr-&gt;p_env-&gt;write_buffers
op_plus
id|claw_writes_perpage
op_minus
l_int|1
)paren
op_div
id|claw_writes_perpage
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* &gt;  or equal  */
id|privptr-&gt;p_buff_pages_perwrite
op_assign
(paren
id|privptr-&gt;p_env-&gt;read_size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
id|claw_write_pages
op_assign
id|privptr-&gt;p_env-&gt;write_buffers
op_star
id|privptr-&gt;p_buff_pages_perwrite
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;read_size
OL
id|PAGE_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() reads_perpage=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|claw_reads_perpage
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() pages_perread=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|privptr-&gt;p_buff_pages_perread
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() read_pages=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|claw_read_pages
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;write_size
OL
id|PAGE_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() writes_perpage=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|claw_writes_perpage
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() pages_perwrite=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|privptr-&gt;p_buff_pages_perwrite
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() write_pages=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|claw_write_pages
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;        *               allocate ccw_pages_required&n;        */
r_if
c_cond
(paren
id|privptr-&gt;p_buff_ccw
op_eq
l_int|NULL
)paren
(brace
id|privptr-&gt;p_buff_ccw
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|__GFP_DMA
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|ccw_pages_required
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_buff_ccw
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s()  &quot;
l_string|&quot;__get_free_pages for CCWs failed : &quot;
l_string|&quot;pages is %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|ccw_pages_required
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; &quot;
l_string|&quot;exit on line %d, rc = ENOMEM&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|privptr-&gt;p_buff_ccw_num
op_assign
id|ccw_pages_required
suffix:semicolon
)brace
id|memset
c_func
(paren
id|privptr-&gt;p_buff_ccw
comma
l_int|0x00
comma
id|privptr-&gt;p_buff_ccw_num
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/*&n;        *               obtain ending ccw block address&n;        *&n;        */
id|privptr-&gt;p_end_ccw
op_assign
(paren
r_struct
id|endccw
op_star
)paren
op_amp
id|privptr-&gt;end_ccw
suffix:semicolon
id|real_address
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|privptr-&gt;p_end_ccw
)paren
suffix:semicolon
multiline_comment|/*                              Initialize ending CCW block       */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() begin initialize ending CCW blocks&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|p_endccw
op_assign
id|privptr-&gt;p_end_ccw
suffix:semicolon
id|p_endccw-&gt;real
op_assign
id|real_address
suffix:semicolon
id|p_endccw-&gt;write1
op_assign
l_int|0x00
suffix:semicolon
id|p_endccw-&gt;read1
op_assign
l_int|0x00
suffix:semicolon
multiline_comment|/*      write1_nop1                                     */
id|p_endccw-&gt;write1_nop1.cmd_code
op_assign
id|CCW_CLAW_CMD_NOP
suffix:semicolon
id|p_endccw-&gt;write1_nop1.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_endccw-&gt;write1_nop1.count
op_assign
l_int|1
suffix:semicolon
id|p_endccw-&gt;write1_nop1.cda
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      write1_nop2                                     */
id|p_endccw-&gt;write1_nop2.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_endccw-&gt;write1_nop2.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SKIP
suffix:semicolon
id|p_endccw-&gt;write1_nop2.count
op_assign
l_int|1
suffix:semicolon
id|p_endccw-&gt;write1_nop2.cda
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      write2_nop1                                     */
id|p_endccw-&gt;write2_nop1.cmd_code
op_assign
id|CCW_CLAW_CMD_NOP
suffix:semicolon
id|p_endccw-&gt;write2_nop1.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_endccw-&gt;write2_nop1.count
op_assign
l_int|1
suffix:semicolon
id|p_endccw-&gt;write2_nop1.cda
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      write2_nop2                                     */
id|p_endccw-&gt;write2_nop2.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_endccw-&gt;write2_nop2.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SKIP
suffix:semicolon
id|p_endccw-&gt;write2_nop2.count
op_assign
l_int|1
suffix:semicolon
id|p_endccw-&gt;write2_nop2.cda
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      read1_nop1                                      */
id|p_endccw-&gt;read1_nop1.cmd_code
op_assign
id|CCW_CLAW_CMD_NOP
suffix:semicolon
id|p_endccw-&gt;read1_nop1.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_endccw-&gt;read1_nop1.count
op_assign
l_int|1
suffix:semicolon
id|p_endccw-&gt;read1_nop1.cda
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      read1_nop2                                      */
id|p_endccw-&gt;read1_nop2.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_endccw-&gt;read1_nop2.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SKIP
suffix:semicolon
id|p_endccw-&gt;read1_nop2.count
op_assign
l_int|1
suffix:semicolon
id|p_endccw-&gt;read1_nop2.cda
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      read2_nop1                                      */
id|p_endccw-&gt;read2_nop1.cmd_code
op_assign
id|CCW_CLAW_CMD_NOP
suffix:semicolon
id|p_endccw-&gt;read2_nop1.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_endccw-&gt;read2_nop1.count
op_assign
l_int|1
suffix:semicolon
id|p_endccw-&gt;read2_nop1.cda
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*      read2_nop2                                      */
id|p_endccw-&gt;read2_nop2.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_endccw-&gt;read2_nop2.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_SKIP
suffix:semicolon
id|p_endccw-&gt;read2_nop2.count
op_assign
l_int|1
suffix:semicolon
id|p_endccw-&gt;read2_nop2.cda
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() dump claw ending CCW BK &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_endccw
comma
r_sizeof
(paren
r_struct
id|endccw
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;        *                               Build a chain of CCWs&n;        *&n;        */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s()  Begin build a chain of CCW buffer &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|p_buff
op_assign
id|privptr-&gt;p_buff_ccw
suffix:semicolon
id|p_free_chain
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ccw_pages_required
suffix:semicolon
id|i
op_increment
)paren
(brace
id|real_address
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|p_buff
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buff
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|ccw_blocks_perpage
suffix:semicolon
id|j
op_increment
)paren
(brace
id|p_buf-&gt;next
op_assign
id|p_free_chain
suffix:semicolon
id|p_free_chain
op_assign
id|p_buf
suffix:semicolon
id|p_buf-&gt;real
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|p_buf
)paren
suffix:semicolon
op_increment
id|p_buf
suffix:semicolon
)brace
id|p_buff
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &quot;
l_string|&quot;End build a chain of CCW buffer &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_free_chain
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;        *                               Initialize ClawSignalBlock&n;        *&n;        */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &quot;
l_string|&quot;Begin initialize ClawSignalBlock &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|privptr-&gt;p_claw_signal_blk
op_eq
l_int|NULL
)paren
(brace
id|privptr-&gt;p_claw_signal_blk
op_assign
id|p_free_chain
suffix:semicolon
id|p_free_chain
op_assign
id|p_free_chain-&gt;next
suffix:semicolon
id|pClawH
op_assign
(paren
r_struct
id|clawh
op_star
)paren
id|privptr-&gt;p_claw_signal_blk
suffix:semicolon
id|pClawH-&gt;length
op_assign
l_int|0xffff
suffix:semicolon
id|pClawH-&gt;opcode
op_assign
l_int|0xff
suffix:semicolon
id|pClawH-&gt;flag
op_assign
id|CLAW_BUSY
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt;  End initialize &quot;
l_string|&quot;ClawSignalBlock&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|privptr-&gt;p_claw_signal_blk
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;        *               allocate write_pages_required and add to free chain&n;        */
r_if
c_cond
(paren
id|privptr-&gt;p_buff_write
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;write_size
OL
id|PAGE_SIZE
)paren
(brace
id|privptr-&gt;p_buff_write
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|__GFP_DMA
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|claw_write_pages
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_buff_write
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() __get_free_pages for write&quot;
l_string|&quot; bufs failed : get is for %d pages&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|claw_write_pages
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_ccw
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_ccw_num
)paren
)paren
suffix:semicolon
id|privptr-&gt;p_buff_ccw
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; exit on line %d,&quot;
l_string|&quot;rc = ENOMEM&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n;                *                               Build CLAW write free chain&n;                *&n;                */
id|memset
c_func
(paren
id|privptr-&gt;p_buff_write
comma
l_int|0x00
comma
id|ccw_pages_required
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() Begin build claw write free &quot;
l_string|&quot;chain &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|privptr-&gt;p_write_free_chain
op_assign
l_int|NULL
suffix:semicolon
id|p_buff
op_assign
id|privptr-&gt;p_buff_write
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|privptr-&gt;p_env-&gt;write_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p_buf
op_assign
id|p_free_chain
suffix:semicolon
multiline_comment|/*  get a CCW */
id|p_free_chain
op_assign
id|p_buf-&gt;next
suffix:semicolon
id|p_buf-&gt;next
op_assign
id|privptr-&gt;p_write_free_chain
suffix:semicolon
id|privptr-&gt;p_write_free_chain
op_assign
id|p_buf
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|p_buffer
op_assign
(paren
r_struct
id|clawbuf
op_star
)paren
id|p_buff
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|write.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|p_buff
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|write.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_read_FF.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_read_FF.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_read_FF.count
op_assign
l_int|1
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_read_FF.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_buf
op_member_access_from_pointer
id|header.flag
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_TIC_1.cmd_code
op_assign
id|CCW_CLAW_CMD_TIC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_TIC_1.flags
op_assign
l_int|0
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_TIC_1.count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
id|p_buff
op_plus
id|privptr-&gt;p_env-&gt;write_size
)paren
op_ge
(paren
(paren
r_int
r_int
)paren
(paren
id|p_buff
op_plus
l_int|2
op_star
(paren
id|privptr-&gt;p_env-&gt;write_size
)paren
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
)paren
)paren
(brace
id|p_buff
op_assign
id|p_buff
op_plus
id|privptr-&gt;p_env-&gt;write_size
suffix:semicolon
)brace
)brace
)brace
r_else
multiline_comment|/*  Buffers are =&gt; PAGE_SIZE. 1 buff per get_free_pages */
(brace
id|privptr-&gt;p_write_free_chain
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|privptr-&gt;p_env-&gt;write_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p_buff
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|__GFP_DMA
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perwrite
)paren
)paren
suffix:semicolon
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s __get_free_pages &quot;
l_string|&quot;for writes buf: get for %d pages&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|privptr-&gt;p_buff_pages_perwrite
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|p_buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s __get_free_pages&quot;
l_string|&quot;for writes buf failed : get is for %d pages&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|privptr-&gt;p_buff_pages_perwrite
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_ccw
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_ccw_num
)paren
)paren
suffix:semicolon
id|privptr-&gt;p_buff_ccw
op_assign
l_int|NULL
suffix:semicolon
id|p_buf
op_assign
id|privptr-&gt;p_buff_write
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|p_buf-&gt;p_buffer
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perwrite
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s exit on line %d, rc = ENOMEM&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Error on get_pages   */
id|memset
c_func
(paren
id|p_buff
comma
l_int|0x00
comma
id|privptr-&gt;p_env-&gt;write_size
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_free_chain
suffix:semicolon
id|p_free_chain
op_assign
id|p_buf-&gt;next
suffix:semicolon
id|p_buf-&gt;next
op_assign
id|privptr-&gt;p_write_free_chain
suffix:semicolon
id|privptr-&gt;p_write_free_chain
op_assign
id|p_buf
suffix:semicolon
id|privptr-&gt;p_buff_write
op_assign
id|p_buf
suffix:semicolon
id|p_buf-&gt;p_buffer
op_assign
(paren
r_struct
id|clawbuf
op_star
)paren
id|p_buff
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|write.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|p_buff
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|write.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_read_FF.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_read_FF.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_read_FF.count
op_assign
l_int|1
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_read_FF.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_buf
op_member_access_from_pointer
id|header.flag
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_TIC_1.cmd_code
op_assign
id|CCW_CLAW_CMD_TIC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_TIC_1.flags
op_assign
l_int|0
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|w_TIC_1.count
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* for all write_buffers   */
)brace
multiline_comment|/* else buffers are PAGE_SIZE or bigger */
)brace
id|privptr-&gt;p_buff_write_num
op_assign
id|claw_write_pages
suffix:semicolon
id|privptr-&gt;write_free_count
op_assign
id|privptr-&gt;p_env-&gt;write_buffers
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s  End build claw write free chain &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|p_buf
op_assign
id|privptr-&gt;p_write_free_chain
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;        *               allocate read_pages_required and chain to free chain&n;        */
r_if
c_cond
(paren
id|privptr-&gt;p_buff_read
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;read_size
OL
id|PAGE_SIZE
)paren
(brace
id|privptr-&gt;p_buff_read
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|__GFP_DMA
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|claw_read_pages
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_buff_read
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &quot;
l_string|&quot;__get_free_pages for read buf failed : &quot;
l_string|&quot;get is for %d pages&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|claw_read_pages
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_ccw
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_ccw_num
)paren
)paren
suffix:semicolon
multiline_comment|/* free the write pages size is &lt; page size  */
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_write
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_write_num
)paren
)paren
suffix:semicolon
id|privptr-&gt;p_buff_ccw
op_assign
l_int|NULL
suffix:semicolon
id|privptr-&gt;p_buff_write
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; exit on line %d, rc =&quot;
l_string|&quot; ENOMEM&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|privptr-&gt;p_buff_read
comma
l_int|0x00
comma
id|claw_read_pages
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
id|privptr-&gt;p_buff_read_num
op_assign
id|claw_read_pages
suffix:semicolon
multiline_comment|/*&n;                *                               Build CLAW read free chain&n;                *&n;                */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() Begin build claw read free chain &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|p_buff
op_assign
id|privptr-&gt;p_buff_read
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|privptr-&gt;p_env-&gt;read_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p_buf
op_assign
id|p_free_chain
suffix:semicolon
id|p_free_chain
op_assign
id|p_buf-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|p_last_CCWB
op_eq
l_int|NULL
)paren
(brace
id|p_buf-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|real_TIC_address
op_assign
l_int|0
suffix:semicolon
id|p_last_CCWB
op_assign
id|p_buf
suffix:semicolon
)brace
r_else
(brace
id|p_buf-&gt;next
op_assign
id|p_first_CCWB
suffix:semicolon
id|real_TIC_address
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
id|p_first_CCWB
op_member_access_from_pointer
id|read
)paren
suffix:semicolon
)brace
id|p_first_CCWB
op_assign
id|p_buf
suffix:semicolon
id|p_buf-&gt;p_buffer
op_assign
(paren
r_struct
id|clawbuf
op_star
)paren
id|p_buff
suffix:semicolon
multiline_comment|/*  initialize read command */
id|p_buf
op_member_access_from_pointer
id|read.cmd_code
op_assign
id|CCW_CLAW_CMD_READ
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|p_buff
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read.count
op_assign
id|privptr-&gt;p_env-&gt;read_size
suffix:semicolon
multiline_comment|/*  initialize read_h command */
id|p_buf
op_member_access_from_pointer
id|read_h.cmd_code
op_assign
id|CCW_CLAW_CMD_READHEADER
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read_h.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
(paren
id|p_buf-&gt;header
)paren
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read_h.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read_h.count
op_assign
r_sizeof
(paren
r_struct
id|clawh
)paren
suffix:semicolon
multiline_comment|/*  initialize Signal command */
id|p_buf
op_member_access_from_pointer
id|signal.cmd_code
op_assign
id|CCW_CLAW_CMD_SIGNAL_SMOD
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|signal.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
(paren
id|pClawH-&gt;flag
)paren
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|signal.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|signal.count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*  initialize r_TIC_1 command */
id|p_buf
op_member_access_from_pointer
id|r_TIC_1.cmd_code
op_assign
id|CCW_CLAW_CMD_TIC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|real_TIC_address
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_TIC_1.flags
op_assign
l_int|0
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_TIC_1.count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  initialize r_read_FF command */
id|p_buf
op_member_access_from_pointer
id|r_read_FF.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_read_FF.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
(paren
id|pClawH-&gt;flag
)paren
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_read_FF.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_PCI
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_read_FF.count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*    initialize r_TIC_2          */
id|memcpy
c_func
(paren
op_amp
id|p_buf-&gt;r_TIC_2
comma
op_amp
id|p_buf-&gt;r_TIC_1
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
multiline_comment|/*     initialize Header     */
id|p_buf-&gt;header.length
op_assign
l_int|0xffff
suffix:semicolon
id|p_buf-&gt;header.opcode
op_assign
l_int|0xff
suffix:semicolon
id|p_buf-&gt;header.flag
op_assign
id|CLAW_PENDING
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
id|p_buff
op_plus
id|privptr-&gt;p_env-&gt;read_size
)paren
op_ge
(paren
(paren
r_int
r_int
)paren
(paren
id|p_buff
op_plus
l_int|2
op_star
(paren
id|privptr-&gt;p_env-&gt;read_size
)paren
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
)paren
)paren
(brace
id|p_buff
op_assign
id|p_buff
op_plus
id|privptr-&gt;p_env-&gt;read_size
suffix:semicolon
)brace
r_else
(brace
id|p_buff
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_int
r_int
)paren
(paren
id|p_buff
op_plus
l_int|2
op_star
(paren
id|privptr-&gt;p_env-&gt;read_size
)paren
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* for read_buffers   */
)brace
multiline_comment|/* read_size &lt; PAGE_SIZE  */
r_else
(brace
multiline_comment|/* read Size &gt;= PAGE_SIZE  */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() Begin build claw read free chain &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|privptr-&gt;p_env-&gt;read_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p_buff
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|__GFP_DMA
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perread
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() __get_free_pages for read &quot;
l_string|&quot;buf failed : get is for %d pages&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|privptr-&gt;p_buff_pages_perread
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|privptr-&gt;p_buff_ccw
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_ccw_num
)paren
)paren
suffix:semicolon
multiline_comment|/* free the write pages  */
id|p_buf
op_assign
id|privptr-&gt;p_buff_write
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|p_buf-&gt;p_buffer
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perwrite
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
multiline_comment|/* free any read pages already alloc  */
id|p_buf
op_assign
id|privptr-&gt;p_buff_read
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|p_buf-&gt;p_buffer
comma
(paren
r_int
)paren
id|pages_to_order_of_mag
c_func
(paren
id|privptr-&gt;p_buff_pages_perread
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
id|privptr-&gt;p_buff_ccw
op_assign
l_int|NULL
suffix:semicolon
id|privptr-&gt;p_buff_write
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() exit on line %d, rc = ENOMEM&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p_buff
comma
l_int|0x00
comma
id|privptr-&gt;p_env-&gt;read_size
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_free_chain
suffix:semicolon
id|privptr-&gt;p_buff_read
op_assign
id|p_buf
suffix:semicolon
id|p_free_chain
op_assign
id|p_buf-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|p_last_CCWB
op_eq
l_int|NULL
)paren
(brace
id|p_buf-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|real_TIC_address
op_assign
l_int|0
suffix:semicolon
id|p_last_CCWB
op_assign
id|p_buf
suffix:semicolon
)brace
r_else
(brace
id|p_buf-&gt;next
op_assign
id|p_first_CCWB
suffix:semicolon
id|real_TIC_address
op_assign
(paren
id|addr_t
)paren
id|__pa
c_func
(paren
op_amp
id|p_first_CCWB
op_member_access_from_pointer
id|read
)paren
suffix:semicolon
)brace
id|p_first_CCWB
op_assign
id|p_buf
suffix:semicolon
multiline_comment|/* save buff address */
id|p_buf-&gt;p_buffer
op_assign
(paren
r_struct
id|clawbuf
op_star
)paren
id|p_buff
suffix:semicolon
multiline_comment|/*  initialize read command */
id|p_buf
op_member_access_from_pointer
id|read.cmd_code
op_assign
id|CCW_CLAW_CMD_READ
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|p_buff
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read.count
op_assign
id|privptr-&gt;p_env-&gt;read_size
suffix:semicolon
multiline_comment|/*  initialize read_h command */
id|p_buf
op_member_access_from_pointer
id|read_h.cmd_code
op_assign
id|CCW_CLAW_CMD_READHEADER
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read_h.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
(paren
id|p_buf-&gt;header
)paren
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read_h.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|read_h.count
op_assign
r_sizeof
(paren
r_struct
id|clawh
)paren
suffix:semicolon
multiline_comment|/*  initialize Signal command */
id|p_buf
op_member_access_from_pointer
id|signal.cmd_code
op_assign
id|CCW_CLAW_CMD_SIGNAL_SMOD
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|signal.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
(paren
id|pClawH-&gt;flag
)paren
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|signal.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|signal.count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*  initialize r_TIC_1 command */
id|p_buf
op_member_access_from_pointer
id|r_TIC_1.cmd_code
op_assign
id|CCW_CLAW_CMD_TIC
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_TIC_1.cda
op_assign
(paren
id|__u32
)paren
id|real_TIC_address
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_TIC_1.flags
op_assign
l_int|0
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_TIC_1.count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  initialize r_read_FF command */
id|p_buf
op_member_access_from_pointer
id|r_read_FF.cmd_code
op_assign
id|CCW_CLAW_CMD_READFF
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_read_FF.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
op_amp
(paren
id|pClawH-&gt;flag
)paren
)paren
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_read_FF.flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
op_or
id|CCW_FLAG_PCI
suffix:semicolon
id|p_buf
op_member_access_from_pointer
id|r_read_FF.count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*    initialize r_TIC_2          */
id|memcpy
c_func
(paren
op_amp
id|p_buf-&gt;r_TIC_2
comma
op_amp
id|p_buf-&gt;r_TIC_1
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
multiline_comment|/*     initialize Header     */
id|p_buf-&gt;header.length
op_assign
l_int|0xffff
suffix:semicolon
id|p_buf-&gt;header.opcode
op_assign
l_int|0xff
suffix:semicolon
id|p_buf-&gt;header.flag
op_assign
id|CLAW_PENDING
suffix:semicolon
)brace
multiline_comment|/* For read_buffers   */
)brace
multiline_comment|/*  read_size &gt;= PAGE_SIZE   */
)brace
multiline_comment|/*  pBuffread = NULL */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt;  End build claw read free chain &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_first_CCWB
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
macro_line|#endif
id|add_claw_reads
c_func
(paren
id|dev
comma
id|p_first_CCWB
comma
id|p_last_CCWB
)paren
suffix:semicolon
id|privptr-&gt;buffs_alloc
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*    end of init_ccw_bk */
multiline_comment|/*-------------------------------------------------------------------*&n;*                                                                    *&n;*       probe_error                                                  *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|probe_error
id|probe_error
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s enter  &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;proberr&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s variable cgdev =&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|cgdev
comma
r_sizeof
(paren
r_struct
id|ccwgroup_device
)paren
)paren
suffix:semicolon
macro_line|#endif
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
id|cgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
id|privptr
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|privptr-&gt;p_env
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|privptr-&gt;p_env
)paren
suffix:semicolon
id|privptr-&gt;p_env
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|privptr-&gt;p_mtc_envelope
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|privptr-&gt;p_mtc_envelope
)paren
suffix:semicolon
id|privptr-&gt;p_mtc_envelope
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|privptr
)paren
suffix:semicolon
id|privptr
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s &gt; exit on line %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*    probe_error    */
multiline_comment|/*-------------------------------------------------------------------*&n;*    claw_process_control                                            *&n;*                                                                    *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_process_control
id|claw_process_control
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ccwbk
op_star
id|p_ccw
)paren
(brace
r_struct
id|clawbuf
op_star
id|p_buf
suffix:semicolon
r_struct
id|clawctl
id|ctlbk
suffix:semicolon
r_struct
id|clawctl
op_star
id|p_ctlbk
suffix:semicolon
r_char
id|temp_host_name
(braket
l_int|8
)braket
suffix:semicolon
r_char
id|temp_ws_name
(braket
l_int|8
)braket
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_struct
id|sysval
op_star
id|p_sysval
suffix:semicolon
r_struct
id|conncmd
op_star
id|p_connect
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_struct
id|chbk
op_star
id|p_ch
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;clw_cntl&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable p_ccw =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ccw
comma
r_sizeof
(paren
r_struct
id|ccwbk
op_star
)paren
)paren
suffix:semicolon
macro_line|#endif
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* Wait a ms for the control packets to&n;&t;&t;&t;*catch up to each other */
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|p_env
op_assign
id|privptr-&gt;p_env
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|temp_host_name
comma
id|p_env-&gt;host_name
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|temp_ws_name
comma
id|p_env-&gt;adapter_name
comma
l_int|8
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CLAW device %.8s: &quot;
l_string|&quot;Received Control Packet&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|temp_ws_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;release_pend
op_eq
l_int|1
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() &gt; &quot;
l_string|&quot;exit on line %d, rc=0&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|p_buf
op_assign
id|p_ccw-&gt;p_buffer
suffix:semicolon
id|p_ctlbk
op_assign
op_amp
id|ctlbk
suffix:semicolon
r_if
c_cond
(paren
id|p_env-&gt;packing
op_eq
id|DO_PACKED
)paren
(brace
multiline_comment|/* packing in progress?*/
id|memcpy
c_func
(paren
id|p_ctlbk
comma
op_amp
id|p_buf-&gt;buffer
(braket
l_int|4
)braket
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|p_ctlbk
comma
id|p_buf
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: dump claw control data inbound&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ctlbk
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|p_ctlbk-&gt;command
)paren
(brace
r_case
id|SYSTEM_VALIDATE_REQUEST
suffix:colon
r_if
c_cond
(paren
id|p_ctlbk-&gt;version
op_ne
id|CLAW_VERSION_ID
)paren
(brace
id|claw_snd_sys_validate_rsp
c_func
(paren
id|dev
comma
id|p_ctlbk
comma
id|CLAW_RC_WRONG_VERSION
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %d is wrong version id. &quot;
l_string|&quot;Expected %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;version
comma
id|CLAW_VERSION_ID
)paren
suffix:semicolon
)brace
id|p_sysval
op_assign
(paren
r_struct
id|sysval
op_star
)paren
op_amp
(paren
id|p_ctlbk-&gt;data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Recv Sys Validate Request: &quot;
l_string|&quot;Vers=%d,link_id=%d,Corr=%d,WS name=%.&quot;
l_string|&quot;8s,Host name=%.8s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;version
comma
id|p_ctlbk-&gt;linkid
comma
id|p_ctlbk-&gt;correlator
comma
id|p_sysval-&gt;WS_name
comma
id|p_sysval-&gt;host_name
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|memcmp
c_func
(paren
id|temp_host_name
comma
id|p_sysval-&gt;host_name
comma
l_int|8
)paren
)paren
(brace
id|claw_snd_sys_validate_rsp
c_func
(paren
id|dev
comma
id|p_ctlbk
comma
id|CLAW_RC_NAME_MISMATCH
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;HSTBAD&quot;
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|p_sysval-&gt;host_name
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|temp_host_name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  Host name mismatch&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received :%s: &quot;
l_string|&quot;expected :%s: &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_sysval-&gt;host_name
comma
id|temp_host_name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_ne
id|memcmp
c_func
(paren
id|temp_ws_name
comma
id|p_sysval-&gt;WS_name
comma
l_int|8
)paren
)paren
(brace
id|claw_snd_sys_validate_rsp
c_func
(paren
id|dev
comma
id|p_ctlbk
comma
id|CLAW_RC_NAME_MISMATCH
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;WSNBAD&quot;
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|p_sysval-&gt;WS_name
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|temp_ws_name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: WS name mismatch&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Received :%s: &quot;
l_string|&quot;expected :%s: &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_sysval-&gt;WS_name
comma
id|temp_ws_name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p_sysval-&gt;write_frame_size
OL
id|p_env-&gt;write_size
)paren
op_logical_and
(paren
id|p_env-&gt;packing
op_eq
l_int|0
)paren
)paren
(brace
id|claw_snd_sys_validate_rsp
c_func
(paren
id|dev
comma
id|p_ctlbk
comma
id|CLAW_RC_HOST_RCV_TOO_SMALL
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: host write size is too &quot;
l_string|&quot;small&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;wrtszbad&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|p_sysval-&gt;read_frame_size
OL
id|p_env-&gt;read_size
)paren
op_logical_and
(paren
id|p_env-&gt;packing
op_eq
l_int|0
)paren
)paren
(brace
id|claw_snd_sys_validate_rsp
c_func
(paren
id|dev
comma
id|p_ctlbk
comma
id|CLAW_RC_HOST_RCV_TOO_SMALL
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: host read size is too &quot;
l_string|&quot;small&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;rdsizbad&quot;
)paren
suffix:semicolon
)brace
id|claw_snd_sys_validate_rsp
c_func
(paren
id|dev
comma
id|p_ctlbk
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: CLAW device %.8s: System validate&quot;
l_string|&quot; completed.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|temp_ws_name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: sys Validate Rsize:%d Wsize:%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_sysval-&gt;read_frame_size
comma
id|p_sysval-&gt;write_frame_size
)paren
suffix:semicolon
id|privptr-&gt;system_validate_comp
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|p_env-&gt;api_type
comma
id|WS_APPL_NAME_PACKED
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|p_env-&gt;packing
op_assign
id|PACKING_ASK
suffix:semicolon
)brace
id|claw_strt_conn_req
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SYSTEM_VALIDATE_RESPONSE
suffix:colon
id|p_sysval
op_assign
(paren
r_struct
id|sysval
op_star
)paren
op_amp
(paren
id|p_ctlbk-&gt;data
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Recv Sys Validate Resp: Vers=%d,Corr=%d,RC=%d,&quot;
l_string|&quot;WS name=%.8s,Host name=%.8s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;version
comma
id|p_ctlbk-&gt;correlator
comma
id|p_ctlbk-&gt;rc
comma
id|p_sysval-&gt;WS_name
comma
id|p_sysval-&gt;host_name
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|p_ctlbk-&gt;rc
)paren
(brace
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CLAW device &quot;
l_string|&quot;%.8s: System validate &quot;
l_string|&quot;completed.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|temp_ws_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;system_validate_comp
op_eq
l_int|0
)paren
id|claw_strt_conn_req
c_func
(paren
id|dev
)paren
suffix:semicolon
id|privptr-&gt;system_validate_comp
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLAW_RC_NAME_MISMATCH
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sys Validate &quot;
l_string|&quot;Resp : Host, WS name is &quot;
l_string|&quot;mismatch&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLAW_RC_WRONG_VERSION
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sys Validate &quot;
l_string|&quot;Resp : Wrong version&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLAW_RC_HOST_RCV_TOO_SMALL
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sys Validate &quot;
l_string|&quot;Resp : bad frame size&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sys Validate &quot;
l_string|&quot;error code=%d &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;rc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CONNECTION_REQUEST
suffix:colon
id|p_connect
op_assign
(paren
r_struct
id|conncmd
op_star
)paren
op_amp
(paren
id|p_ctlbk-&gt;data
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Recv Conn Req: Vers=%d,link_id=%d,&quot;
l_string|&quot;Corr=%d,HOST appl=%.8s,WS appl=%.8s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;version
comma
id|p_ctlbk-&gt;linkid
comma
id|p_ctlbk-&gt;correlator
comma
id|p_connect-&gt;host_name
comma
id|p_connect-&gt;WS_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;active_link_ID
op_ne
l_int|0
)paren
(brace
id|claw_snd_disc
c_func
(paren
id|dev
comma
id|p_ctlbk
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Conn Req error : &quot;
l_string|&quot;already logical link is active &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_ctlbk-&gt;linkid
op_ne
l_int|1
)paren
(brace
id|claw_snd_disc
c_func
(paren
id|dev
comma
id|p_ctlbk
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Conn Req error : &quot;
l_string|&quot;req logical link id is not 1&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|find_link
c_func
(paren
id|dev
comma
id|p_connect-&gt;host_name
comma
id|p_connect-&gt;WS_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|claw_snd_disc
c_func
(paren
id|dev
comma
id|p_ctlbk
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Conn Req error : &quot;
l_string|&quot;req appl name does not match&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|claw_send_control
c_func
(paren
id|dev
comma
id|CONNECTION_CONFIRM
comma
id|p_ctlbk-&gt;linkid
comma
id|p_ctlbk-&gt;correlator
comma
l_int|0
comma
id|p_connect-&gt;host_name
comma
id|p_connect-&gt;WS_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_env-&gt;packing
op_eq
id|PACKING_ASK
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Now Pack ask&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p_env-&gt;packing
op_assign
id|PACK_SEND
suffix:semicolon
id|claw_snd_conn_req
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CLAW device %.8s: Connection &quot;
l_string|&quot;completed link_id=%d.&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|temp_ws_name
comma
id|p_ctlbk-&gt;linkid
)paren
suffix:semicolon
id|privptr-&gt;active_link_ID
op_assign
id|p_ctlbk-&gt;linkid
suffix:semicolon
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|p_ch-&gt;wait
)paren
suffix:semicolon
multiline_comment|/* wake up claw_open ( WRITE) */
r_break
suffix:semicolon
r_case
id|CONNECTION_RESPONSE
suffix:colon
id|p_connect
op_assign
(paren
r_struct
id|conncmd
op_star
)paren
op_amp
(paren
id|p_ctlbk-&gt;data
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Revc Conn Resp: Vers=%d,link_id=%d,&quot;
l_string|&quot;Corr=%d,RC=%d,Host appl=%.8s, WS appl=%.8s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;version
comma
id|p_ctlbk-&gt;linkid
comma
id|p_ctlbk-&gt;correlator
comma
id|p_ctlbk-&gt;rc
comma
id|p_connect-&gt;host_name
comma
id|p_connect-&gt;WS_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_ctlbk-&gt;rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Conn Resp error: rc=%d &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;rc
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|rc
op_assign
id|find_link
c_func
(paren
id|dev
comma
id|p_connect-&gt;host_name
comma
id|p_connect-&gt;WS_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|claw_snd_disc
c_func
(paren
id|dev
comma
id|p_ctlbk
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Conn Resp error: &quot;
l_string|&quot;req appl name does not match&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* should be until CONNECTION_CONFIRM */
id|privptr-&gt;active_link_ID
op_assign
op_minus
(paren
id|p_ctlbk-&gt;linkid
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CONNECTION_CONFIRM
suffix:colon
id|p_connect
op_assign
(paren
r_struct
id|conncmd
op_star
)paren
op_amp
(paren
id|p_ctlbk-&gt;data
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Recv Conn Confirm:Vers=%d,link_id=%d,&quot;
l_string|&quot;Corr=%d,Host appl=%.8s,WS appl=%.8s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;version
comma
id|p_ctlbk-&gt;linkid
comma
id|p_ctlbk-&gt;correlator
comma
id|p_connect-&gt;host_name
comma
id|p_connect-&gt;WS_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_ctlbk-&gt;linkid
op_eq
op_minus
(paren
id|privptr-&gt;active_link_ID
)paren
)paren
(brace
id|privptr-&gt;active_link_ID
op_assign
id|p_ctlbk-&gt;linkid
suffix:semicolon
r_if
c_cond
(paren
id|p_env-&gt;packing
OG
id|PACKING_ASK
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Confirmed Now packing&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p_env-&gt;packing
op_assign
id|DO_PACKED
suffix:semicolon
)brace
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|p_ch-&gt;wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Conn confirm: &quot;
l_string|&quot;unexpected linkid=%d &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;linkid
)paren
suffix:semicolon
id|claw_snd_disc
c_func
(paren
id|dev
comma
id|p_ctlbk
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DISCONNECT
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Disconnect: &quot;
l_string|&quot;Vers=%d,link_id=%d,Corr=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;version
comma
id|p_ctlbk-&gt;linkid
comma
id|p_ctlbk-&gt;correlator
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p_ctlbk-&gt;linkid
op_eq
l_int|2
)paren
op_logical_and
(paren
id|p_env-&gt;packing
op_eq
id|PACK_SEND
)paren
)paren
(brace
id|privptr-&gt;active_link_ID
op_assign
l_int|1
suffix:semicolon
id|p_env-&gt;packing
op_assign
id|DO_PACKED
suffix:semicolon
)brace
r_else
id|privptr-&gt;active_link_ID
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLAW_ERROR
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: CLAW ERROR detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  Unexpected command code=%d &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_ctlbk-&gt;command
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() exit on line %d, rc = 0&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*    end of claw_process_control    */
multiline_comment|/*-------------------------------------------------------------------*&n;*               claw_send_control                                    *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_send_control
id|claw_send_control
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u8
id|type
comma
id|__u8
id|link
comma
id|__u8
id|correlator
comma
id|__u8
id|rc
comma
r_char
op_star
id|local_name
comma
r_char
op_star
id|remote_name
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_struct
id|clawctl
op_star
id|p_ctl
suffix:semicolon
r_struct
id|sysval
op_star
id|p_sysval
suffix:semicolon
r_struct
id|conncmd
op_star
id|p_connect
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s &gt; enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;sndcntl&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Sending Control Packet &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable type = 0x%X, link = &quot;
l_string|&quot;%d, correlator = %d, rc = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|type
comma
id|link
comma
id|correlator
comma
id|rc
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable local_name = %s, &quot;
l_string|&quot;remote_name = %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|local_name
comma
id|remote_name
)paren
suffix:semicolon
macro_line|#endif
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|p_ctl
op_assign
(paren
r_struct
id|clawctl
op_star
)paren
op_amp
id|privptr-&gt;ctl_bk
suffix:semicolon
id|p_ctl-&gt;command
op_assign
id|type
suffix:semicolon
id|p_ctl-&gt;version
op_assign
id|CLAW_VERSION_ID
suffix:semicolon
id|p_ctl-&gt;linkid
op_assign
id|link
suffix:semicolon
id|p_ctl-&gt;correlator
op_assign
id|correlator
suffix:semicolon
id|p_ctl-&gt;rc
op_assign
id|rc
suffix:semicolon
id|p_sysval
op_assign
(paren
r_struct
id|sysval
op_star
)paren
op_amp
id|p_ctl-&gt;data
suffix:semicolon
id|p_connect
op_assign
(paren
r_struct
id|conncmd
op_star
)paren
op_amp
id|p_ctl-&gt;data
suffix:semicolon
r_switch
c_cond
(paren
id|p_ctl-&gt;command
)paren
(brace
r_case
id|SYSTEM_VALIDATE_REQUEST
suffix:colon
r_case
id|SYSTEM_VALIDATE_RESPONSE
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|p_sysval-&gt;host_name
comma
id|local_name
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|p_sysval-&gt;WS_name
comma
id|remote_name
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;packing
OG
l_int|0
)paren
(brace
id|p_sysval-&gt;read_frame_size
op_assign
id|DEF_PACK_BUFSIZE
suffix:semicolon
id|p_sysval-&gt;write_frame_size
op_assign
id|DEF_PACK_BUFSIZE
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* how big is the piggest group of packets */
id|p_sysval-&gt;read_frame_size
op_assign
id|privptr-&gt;p_env-&gt;read_size
suffix:semicolon
id|p_sysval-&gt;write_frame_size
op_assign
id|privptr-&gt;p_env-&gt;write_size
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|p_sysval-&gt;reserved
comma
l_int|0x00
comma
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CONNECTION_REQUEST
suffix:colon
r_case
id|CONNECTION_RESPONSE
suffix:colon
r_case
id|CONNECTION_CONFIRM
suffix:colon
r_case
id|DISCONNECT
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|p_sysval-&gt;host_name
comma
id|local_name
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|p_sysval-&gt;WS_name
comma
id|remote_name
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;packing
OG
l_int|0
)paren
(brace
multiline_comment|/* How big is the biggest packet */
id|p_connect-&gt;reserved1
(braket
l_int|0
)braket
op_assign
id|CLAW_FRAME_SIZE
suffix:semicolon
id|p_connect-&gt;reserved1
(braket
l_int|1
)braket
op_assign
id|CLAW_FRAME_SIZE
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
op_amp
id|p_connect-&gt;reserved1
comma
l_int|0x00
comma
l_int|4
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|p_connect-&gt;reserved2
comma
l_int|0x00
comma
l_int|4
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/*      write Control Record to the device                   */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s:%s low on mem, returning...&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit, rc = ENOMEM&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
comma
id|p_ctl
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: outbnd claw cntl data &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ctl
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;packing
op_ge
id|PACK_SEND
)paren
id|claw_hw_tx
c_func
(paren
id|skb
comma
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_else
id|claw_hw_tx
c_func
(paren
id|skb
comma
id|dev
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*   end of claw_send_control  */
multiline_comment|/*-------------------------------------------------------------------*&n;*               claw_snd_conn_req                                    *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_snd_conn_req
id|claw_snd_conn_req
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u8
id|link
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|clawctl
op_star
id|p_ctl
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;snd_conn&quot;
)paren
suffix:semicolon
macro_line|#ifdef  DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable link = %X, dev =&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|link
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
l_int|1
suffix:semicolon
id|p_ctl
op_assign
(paren
r_struct
id|clawctl
op_star
)paren
op_amp
id|privptr-&gt;ctl_bk
suffix:semicolon
id|p_ctl-&gt;linkid
op_assign
id|link
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;system_validate_comp
op_eq
l_int|0x00
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc = 1&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;packing
op_eq
id|PACKING_ASK
)paren
id|rc
op_assign
id|claw_send_control
c_func
(paren
id|dev
comma
id|CONNECTION_REQUEST
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|WS_APPL_NAME_PACKED
comma
id|WS_APPL_NAME_PACKED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;packing
op_eq
id|PACK_SEND
)paren
(brace
id|rc
op_assign
id|claw_send_control
c_func
(paren
id|dev
comma
id|CONNECTION_REQUEST
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|WS_APPL_NAME_IP_NAME
comma
id|WS_APPL_NAME_IP_NAME
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|privptr-&gt;p_env-&gt;packing
op_eq
l_int|0
)paren
id|rc
op_assign
id|claw_send_control
c_func
(paren
id|dev
comma
id|CONNECTION_REQUEST
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|HOST_APPL_NAME
comma
id|privptr-&gt;p_env-&gt;api_type
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*  end of claw_snd_conn_req */
multiline_comment|/*-------------------------------------------------------------------*&n;*               claw_snd_disc                                        *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_snd_disc
id|claw_snd_disc
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|clawctl
op_star
id|p_ctl
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|conncmd
op_star
id|p_connect
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;snd_dsc&quot;
)paren
suffix:semicolon
macro_line|#ifdef  DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable p_ctl&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ctl
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
macro_line|#endif
id|p_connect
op_assign
(paren
r_struct
id|conncmd
op_star
)paren
op_amp
id|p_ctl-&gt;data
suffix:semicolon
id|rc
op_assign
id|claw_send_control
c_func
(paren
id|dev
comma
id|DISCONNECT
comma
id|p_ctl-&gt;linkid
comma
id|p_ctl-&gt;correlator
comma
l_int|0
comma
id|p_connect-&gt;host_name
comma
id|p_connect-&gt;WS_name
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*   end of claw_snd_disc    */
multiline_comment|/*-------------------------------------------------------------------*&n;*               claw_snd_sys_validate_rsp                            *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_snd_sys_validate_rsp
id|claw_snd_sys_validate_rsp
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|clawctl
op_star
id|p_ctl
comma
id|__u32
id|return_code
)paren
(brace
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_int
id|rc
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;chkresp&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable return_code = %d, dev =&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|return_code
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable p_ctl =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_ctl
comma
r_sizeof
(paren
r_struct
id|clawctl
)paren
)paren
suffix:semicolon
macro_line|#endif
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|p_env
op_assign
id|privptr-&gt;p_env
suffix:semicolon
id|rc
op_assign
id|claw_send_control
c_func
(paren
id|dev
comma
id|SYSTEM_VALIDATE_RESPONSE
comma
id|p_ctl-&gt;linkid
comma
id|p_ctl-&gt;correlator
comma
id|return_code
comma
id|p_env-&gt;host_name
comma
id|p_env-&gt;adapter_name
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*    end of claw_snd_sys_validate_rsp    */
multiline_comment|/*-------------------------------------------------------------------*&n;*               claw_strt_conn_req                                   *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_int
DECL|function|claw_strt_conn_req
id|claw_strt_conn_req
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;conn_req&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable dev =&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
id|claw_snd_conn_req
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d, rc = %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*   end of claw_strt_conn_req   */
multiline_comment|/*-------------------------------------------------------------------*&n; *   claw_stats                                                      *&n; *-------------------------------------------------------------------*/
r_static
r_struct
DECL|function|claw_stats
id|net_device_stats
op_star
id|claw_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;stats&quot;
)paren
suffix:semicolon
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_amp
id|privptr-&gt;stats
suffix:semicolon
)brace
multiline_comment|/*   end of claw_stats   */
multiline_comment|/*-------------------------------------------------------------------*&n;*       unpack_read                                                  *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|unpack_read
id|unpack_read
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_this_ccw
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_first_ccw
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_last_ccw
suffix:semicolon
r_struct
id|clawph
op_star
id|p_packh
suffix:semicolon
r_void
op_star
id|p_packd
suffix:semicolon
r_struct
id|clawctl
op_star
id|p_ctlrec
op_assign
l_int|NULL
suffix:semicolon
id|__u32
id|len_of_data
suffix:semicolon
id|__u32
id|pack_off
suffix:semicolon
id|__u8
id|link_num
suffix:semicolon
id|__u8
id|mtc_this_frm
op_assign
l_int|0
suffix:semicolon
id|__u32
id|bytes_to_mov
suffix:semicolon
r_struct
id|chbk
op_star
id|p_ch
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|p
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;unpkread&quot;
)paren
suffix:semicolon
id|p_first_ccw
op_assign
l_int|NULL
suffix:semicolon
id|p_last_ccw
op_assign
l_int|NULL
suffix:semicolon
id|p_packh
op_assign
l_int|NULL
suffix:semicolon
id|p_packd
op_assign
l_int|NULL
suffix:semicolon
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|p_env
op_assign
id|privptr-&gt;p_env
suffix:semicolon
id|p_this_ccw
op_assign
id|privptr-&gt;p_read_active_first
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|p_this_ccw
op_ne
l_int|NULL
op_logical_and
id|p_this_ccw-&gt;header.flag
op_ne
id|CLAW_PENDING
)paren
(brace
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s p_this_ccw &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_this_ccw
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s Inbound p_this_ccw-&gt;p_buffer(64)&quot;
l_string|&quot; pk=%d &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_env-&gt;packing
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_this_ccw-&gt;p_buffer
comma
l_int|64
)paren
suffix:semicolon
macro_line|#endif
id|pack_off
op_assign
l_int|0
suffix:semicolon
id|p
op_assign
l_int|0
suffix:semicolon
id|p_this_ccw-&gt;header.flag
op_assign
id|CLAW_PENDING
suffix:semicolon
id|privptr-&gt;p_read_active_first
op_assign
id|p_this_ccw-&gt;next
suffix:semicolon
id|p_this_ccw-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|p_packh
op_assign
(paren
r_struct
id|clawph
op_star
)paren
id|p_this_ccw-&gt;p_buffer
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p_env-&gt;packing
op_eq
id|PACK_SEND
)paren
op_logical_and
(paren
id|p_packh-&gt;len
op_eq
l_int|32
)paren
op_logical_and
(paren
id|p_packh-&gt;link_num
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* is it a packed ctl rec? */
id|p_packh
op_increment
suffix:semicolon
multiline_comment|/* peek past pack header */
id|p_ctlrec
op_assign
(paren
r_struct
id|clawctl
op_star
)paren
id|p_packh
suffix:semicolon
id|p_packh
op_decrement
suffix:semicolon
multiline_comment|/* un peek */
r_if
c_cond
(paren
(paren
id|p_ctlrec-&gt;command
op_eq
id|CONNECTION_RESPONSE
)paren
op_logical_or
(paren
id|p_ctlrec-&gt;command
op_eq
id|CONNECTION_CONFIRM
)paren
)paren
id|p_env-&gt;packing
op_assign
id|DO_PACKED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_env-&gt;packing
op_eq
id|DO_PACKED
)paren
id|link_num
op_assign
id|p_packh-&gt;link_num
suffix:semicolon
r_else
id|link_num
op_assign
id|p_this_ccw-&gt;header.opcode
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p_this_ccw-&gt;header.opcode
op_amp
id|MORE_to_COME_FLAG
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s &gt; More_to_come is ON&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|mtc_this_frm
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|p_this_ccw-&gt;header.length
op_ne
id|privptr-&gt;p_env-&gt;read_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot; %s: Invalid frame detected &quot;
l_string|&quot;length is %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_this_ccw-&gt;header.length
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|privptr-&gt;mtc_skipping
)paren
(brace
multiline_comment|/*&n;                        *   We&squot;re in the mode of skipping past a&n;&t;&t;&t;*   multi-frame message&n;                        *   that we can&squot;t process for some reason or other.&n;                        *   The first frame without the More-To-Come flag is&n;&t;&t;&t;*   the last frame of the skipped message.&n;                        */
multiline_comment|/*  in case of More-To-Come not set in this frame */
r_if
c_cond
(paren
id|mtc_this_frm
op_eq
l_int|0
)paren
(brace
id|privptr-&gt;mtc_skipping
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ok, the end */
id|privptr-&gt;mtc_logical_link
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s goto next &quot;
l_string|&quot;frame from MoretoComeSkip &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|NextFrame
suffix:semicolon
)brace
r_if
c_cond
(paren
id|link_num
op_eq
l_int|0
)paren
(brace
id|claw_process_control
c_func
(paren
id|dev
comma
id|p_this_ccw
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s goto next &quot;
l_string|&quot;frame from claw_process_control &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;UnpkCntl&quot;
)paren
suffix:semicolon
r_goto
id|NextFrame
suffix:semicolon
)brace
id|unpack_next
suffix:colon
r_if
c_cond
(paren
id|p_env-&gt;packing
op_eq
id|DO_PACKED
)paren
(brace
r_if
c_cond
(paren
id|pack_off
OG
id|p_env-&gt;read_size
)paren
r_goto
id|NextFrame
suffix:semicolon
id|p_packd
op_assign
id|p_this_ccw-&gt;p_buffer
op_plus
id|pack_off
suffix:semicolon
id|p_packh
op_assign
(paren
r_struct
id|clawph
op_star
)paren
id|p_packd
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p_packh-&gt;len
op_eq
l_int|0
)paren
op_logical_or
multiline_comment|/* all done with this frame? */
(paren
id|p_packh-&gt;flag
op_ne
l_int|0
)paren
)paren
r_goto
id|NextFrame
suffix:semicolon
id|bytes_to_mov
op_assign
id|p_packh-&gt;len
suffix:semicolon
id|pack_off
op_add_assign
id|bytes_to_mov
op_plus
r_sizeof
(paren
r_struct
id|clawph
)paren
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
r_else
(brace
id|bytes_to_mov
op_assign
id|p_this_ccw-&gt;header.length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|privptr-&gt;mtc_logical_link
OL
l_int|0
)paren
(brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s mtc_logical_link &lt; 0  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;                *  if More-To-Come is set in this frame then we don&squot;t know&n;                *  length of entire message, and hence have to allocate&n;&t;&t;*  large buffer   */
multiline_comment|/*      We are starting a new envelope  */
id|privptr-&gt;mtc_offset
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;mtc_logical_link
op_assign
id|link_num
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bytes_to_mov
OG
(paren
id|MAX_ENVELOPE_SIZE
op_minus
id|privptr-&gt;mtc_offset
)paren
)paren
(brace
multiline_comment|/*      error     */
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s &gt; goto next &quot;
l_string|&quot;frame from MoretoComeSkip &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;      bytes_to_mov %d &gt; (MAX_ENVELOPE_&quot;
l_string|&quot;SIZE-privptr-&gt;mtc_offset %d)&bslash;n&quot;
comma
id|bytes_to_mov
comma
(paren
id|MAX_ENVELOPE_SIZE
op_minus
id|privptr-&gt;mtc_offset
)paren
)paren
suffix:semicolon
macro_line|#endif
id|privptr-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_goto
id|NextFrame
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_env-&gt;packing
op_eq
id|DO_PACKED
)paren
(brace
id|memcpy
c_func
(paren
id|privptr-&gt;p_mtc_envelope
op_plus
id|privptr-&gt;mtc_offset
comma
id|p_packd
op_plus
r_sizeof
(paren
r_struct
id|clawph
)paren
comma
id|bytes_to_mov
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|privptr-&gt;p_mtc_envelope
op_plus
id|privptr-&gt;mtc_offset
comma
id|p_this_ccw-&gt;p_buffer
comma
id|bytes_to_mov
)paren
suffix:semicolon
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() received data &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_env-&gt;packing
op_eq
id|DO_PACKED
)paren
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_packd
op_plus
r_sizeof
(paren
r_struct
id|clawph
)paren
comma
l_int|32
)paren
suffix:semicolon
r_else
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_this_ccw-&gt;p_buffer
comma
l_int|32
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() bytelength %d &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|bytes_to_mov
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|mtc_this_frm
op_eq
l_int|0
)paren
(brace
id|len_of_data
op_assign
id|privptr-&gt;mtc_offset
op_plus
id|bytes_to_mov
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len_of_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len_of_data
)paren
comma
id|privptr-&gt;p_mtc_envelope
comma
id|len_of_data
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
id|privptr-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|privptr-&gt;stats.rx_bytes
op_add_assign
id|len_of_data
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s() netif_&quot;
l_string|&quot;rx(skb) completed &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|privptr-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: %s() low on memory&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|privptr-&gt;mtc_offset
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;mtc_logical_link
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|privptr-&gt;mtc_offset
op_add_assign
id|bytes_to_mov
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_env-&gt;packing
op_eq
id|DO_PACKED
)paren
r_goto
id|unpack_next
suffix:semicolon
id|NextFrame
suffix:colon
multiline_comment|/*&n;                *   Remove ThisCCWblock from active read queue, and add it&n;                *   to queue of free blocks to be reused.&n;                */
id|i
op_increment
suffix:semicolon
id|p_this_ccw-&gt;header.length
op_assign
l_int|0xffff
suffix:semicolon
id|p_this_ccw-&gt;header.opcode
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;                *       add this one to the free queue for later reuse&n;                */
r_if
c_cond
(paren
id|p_first_ccw
op_eq
l_int|NULL
)paren
(brace
id|p_first_ccw
op_assign
id|p_this_ccw
suffix:semicolon
)brace
r_else
(brace
id|p_last_ccw-&gt;next
op_assign
id|p_this_ccw
suffix:semicolon
)brace
id|p_last_ccw
op_assign
id|p_this_ccw
suffix:semicolon
multiline_comment|/*&n;                *       chain to next block on active read queue&n;                */
id|p_this_ccw
op_assign
id|privptr-&gt;p_read_active_first
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;rxpkt %d&quot;
comma
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* end of while */
multiline_comment|/*      check validity                  */
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s processed frame is %d &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s  F:%lx L:%lx&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
(paren
r_int
r_int
)paren
id|p_first_ccw
comma
(paren
r_int
r_int
)paren
id|p_last_ccw
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;rxfrm %d&quot;
comma
id|i
)paren
suffix:semicolon
id|add_claw_reads
c_func
(paren
id|dev
comma
id|p_first_ccw
comma
id|p_last_ccw
)paren
suffix:semicolon
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|READ
)braket
suffix:semicolon
id|claw_strt_read
c_func
(paren
id|dev
comma
id|LOCK_YES
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*  end of unpack_read   */
multiline_comment|/*-------------------------------------------------------------------*&n;*       claw_strt_read                                               *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_strt_read
id|claw_strt_read
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|lock
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|__u32
id|parm
suffix:semicolon
r_int
r_int
id|saveflags
op_assign
l_int|0
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_ccwbk
suffix:semicolon
r_struct
id|chbk
op_star
id|p_ch
suffix:semicolon
r_struct
id|clawh
op_star
id|p_clawh
suffix:semicolon
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|READ
)braket
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter  &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: variable lock = %d, dev =&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|lock
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|dev
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;StRdNter&quot;
)paren
suffix:semicolon
id|p_clawh
op_assign
(paren
r_struct
id|clawh
op_star
)paren
id|privptr-&gt;p_claw_signal_blk
suffix:semicolon
id|p_clawh-&gt;flag
op_assign
id|CLAW_IDLE
suffix:semicolon
multiline_comment|/* 0x00 */
r_if
c_cond
(paren
(paren
id|privptr-&gt;p_write_active_first
op_ne
l_int|NULL
op_logical_and
id|privptr-&gt;p_write_active_first-&gt;header.flag
op_ne
id|CLAW_PENDING
)paren
op_logical_or
(paren
id|privptr-&gt;p_read_active_first
op_ne
l_int|NULL
op_logical_and
id|privptr-&gt;p_read_active_first-&gt;header.flag
op_ne
id|CLAW_PENDING
)paren
)paren
(brace
id|p_clawh-&gt;flag
op_assign
id|CLAW_BUSY
suffix:semicolon
multiline_comment|/* 0xff */
)brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s state-%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|p_ch-&gt;claw_state
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lock
op_eq
id|LOCK_YES
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|p_ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;IO_active
)paren
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: HOT READ started in %s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|p_clawh
op_assign
(paren
r_struct
id|clawh
op_star
)paren
id|privptr-&gt;p_claw_signal_blk
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|p_clawh-&gt;flag
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;HotRead&quot;
)paren
suffix:semicolon
id|p_ccwbk
op_assign
id|privptr-&gt;p_read_active_first
suffix:semicolon
id|parm
op_assign
(paren
r_int
r_int
)paren
id|p_ch
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
(paren
id|p_ch-&gt;cdev
comma
op_amp
id|p_ccwbk-&gt;read
comma
id|parm
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|ccw_check_return_code
c_func
(paren
id|p_ch-&gt;cdev
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No READ started by %s() In progress&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;ReadAct&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lock
op_eq
id|LOCK_YES
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|p_ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;StRdExit&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*    end of claw_strt_read    */
multiline_comment|/*-------------------------------------------------------------------*&n;*       claw_strt_out_IO                                             *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_strt_out_IO
id|claw_strt_out_IO
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|parm
suffix:semicolon
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_struct
id|chbk
op_star
id|p_ch
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_first_ccw
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
r_return
suffix:semicolon
)brace
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|WRITE
)braket
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s state-%02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|p_ch-&gt;claw_state
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;strt_io&quot;
)paren
suffix:semicolon
id|p_first_ccw
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
r_if
c_cond
(paren
id|p_ch-&gt;claw_state
op_eq
id|CLAW_STOP
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|p_first_ccw
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
op_amp
id|p_ch-&gt;IO_active
)paren
op_eq
l_int|0
)paren
(brace
id|parm
op_assign
(paren
r_int
r_int
)paren
id|p_ch
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s do_io &bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_first_ccw
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;StWrtIO&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
(paren
id|p_ch-&gt;cdev
comma
op_amp
id|p_first_ccw-&gt;write
comma
id|parm
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|ccw_check_return_code
c_func
(paren
id|p_ch-&gt;cdev
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*    end of claw_strt_out_IO    */
multiline_comment|/*-------------------------------------------------------------------*&n;*       Free write buffers                                           *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_free_wrt_buf
id|claw_free_wrt_buf
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
op_assign
(paren
r_struct
id|claw_privbk
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_first_ccw
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_last_ccw
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_this_ccw
suffix:semicolon
r_struct
id|ccwbk
op_star
id|p_next_ccw
suffix:semicolon
macro_line|#ifdef IOTRACE
r_struct
id|ccwbk
op_star
id|p_buf
suffix:semicolon
macro_line|#endif
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: free count = %d  variable dev =&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|privptr-&gt;write_free_count
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;freewrtb&quot;
)paren
suffix:semicolon
multiline_comment|/*  scan the write queue to free any completed write packets   */
id|p_first_ccw
op_assign
l_int|NULL
suffix:semicolon
id|p_last_ccw
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:  Dump current CCW chain &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p_buf
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_buf
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: privptr-&gt;p_write_&quot;
l_string|&quot;active_first==NULL&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|p_buf
op_assign
(paren
r_struct
id|ccwbk
op_star
)paren
id|privptr-&gt;p_end_ccw
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|endccw
)paren
)paren
suffix:semicolon
macro_line|#endif
id|p_this_ccw
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p_this_ccw
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|p_this_ccw-&gt;header.flag
op_ne
id|CLAW_PENDING
)paren
)paren
(brace
id|p_next_ccw
op_assign
id|p_this_ccw-&gt;next
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|p_next_ccw
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|p_next_ccw-&gt;header.flag
op_ne
id|CLAW_PENDING
)paren
)paren
op_logical_or
(paren
(paren
id|p_this_ccw
op_eq
id|privptr-&gt;p_write_active_last
)paren
op_logical_and
(paren
id|p_this_ccw-&gt;header.flag
op_ne
id|CLAW_PENDING
)paren
)paren
)paren
(brace
multiline_comment|/* The next CCW is OK or this is  */
multiline_comment|/* the last CCW...free it   @A1A  */
id|privptr-&gt;p_write_active_first
op_assign
id|p_this_ccw-&gt;next
suffix:semicolon
id|p_this_ccw-&gt;header.flag
op_assign
id|CLAW_PENDING
suffix:semicolon
id|p_this_ccw-&gt;next
op_assign
id|privptr-&gt;p_write_free_chain
suffix:semicolon
id|privptr-&gt;p_write_free_chain
op_assign
id|p_this_ccw
suffix:semicolon
op_increment
id|privptr-&gt;write_free_count
suffix:semicolon
id|privptr-&gt;stats.tx_bytes
op_add_assign
id|p_this_ccw-&gt;write.count
suffix:semicolon
id|p_this_ccw
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
id|privptr-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|privptr-&gt;write_free_count
op_ne
l_int|0
)paren
(brace
id|claw_clearbit_busy
c_func
(paren
id|TB_NOBUFFER
comma
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*   whole chain removed?   */
r_if
c_cond
(paren
id|privptr-&gt;p_write_active_first
op_eq
l_int|NULL
)paren
(brace
id|privptr-&gt;p_write_active_last
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef DEBUGMSG
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s p_write_&quot;
l_string|&quot;active_first==NULL&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef IOTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Dump arranged CCW chain &bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|p_buf
op_assign
id|privptr-&gt;p_write_active_first
suffix:semicolon
r_while
c_loop
(paren
id|p_buf
op_ne
l_int|NULL
)paren
(brace
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|ccwbk
)paren
)paren
suffix:semicolon
id|p_buf
op_assign
id|p_buf-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p_buf
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: privptr-&gt;p_write_active_&quot;
l_string|&quot;first==NULL&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
id|p_buf
op_assign
(paren
r_struct
id|ccwbk
op_star
)paren
id|privptr-&gt;p_end_ccw
suffix:semicolon
id|dumpit
c_func
(paren
(paren
r_char
op_star
)paren
id|p_buf
comma
r_sizeof
(paren
r_struct
id|endccw
)paren
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;FWC=%d&quot;
comma
id|privptr-&gt;write_free_count
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d free_count =%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
comma
id|__LINE__
comma
id|privptr-&gt;write_free_count
)paren
suffix:semicolon
macro_line|#endif
r_return
suffix:semicolon
)brace
multiline_comment|/*-------------------------------------------------------------------*&n;*       claw free netdevice                                          *&n;*                                                                    *&n;*--------------------------------------------------------------------*/
r_static
r_void
DECL|function|claw_free_netdevice
id|claw_free_netdevice
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|free_dev
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;free_dev&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_RUNNING
)paren
id|claw_release
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr
)paren
(brace
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|ndev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* say it&squot;s free */
)brace
id|dev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef MODULE
r_if
c_cond
(paren
id|free_dev
)paren
(brace
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;feee_ok&quot;
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/**&n; * Claw init netdevice&n; * Initialize everything of the net device except the name and the&n; * channel structs.&n; */
r_static
r_void
DECL|function|claw_init_netdevice
id|claw_init_netdevice
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;init_dev&quot;
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw:%s BAD Device exit line %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;baddev&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev-&gt;mtu
op_assign
id|CLAW_DEFAULT_MTU_SIZE
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|claw_tx
suffix:semicolon
id|dev-&gt;open
op_assign
id|claw_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|claw_release
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|claw_stats
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|claw_change_mtu
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_SLIP
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|1300
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_POINTOPOINT
op_or
id|IFF_NOARP
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;initok&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**&n; * Init a new channel in the privptr-&gt;channel[i].&n; *&n; * @param cdev  The ccw_device to be added.&n; *&n; * @return 0 on success, !0 on error.&n; */
r_static
r_int
DECL|function|add_channel
id|add_channel
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
id|i
comma
r_struct
id|claw_privbk
op_star
id|privptr
)paren
(brace
r_struct
id|chbk
op_star
id|p_ch
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Enter&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|privptr-&gt;channel
(braket
id|i
)braket
dot
id|flag
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Read is 1 Write is 2 */
id|p_ch
op_assign
op_amp
id|privptr-&gt;channel
(braket
id|i
)braket
suffix:semicolon
id|p_ch-&gt;cdev
op_assign
id|cdev
suffix:semicolon
id|snprintf
c_func
(paren
id|p_ch-&gt;id
comma
id|CLAW_ID_SIZE
comma
l_string|&quot;cl-%s&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|sscanf
c_func
(paren
id|cdev-&gt;dev.bus_id
op_plus
l_int|4
comma
l_string|&quot;%x&quot;
comma
op_amp
id|p_ch-&gt;devno
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p_ch-&gt;irb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|irb
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s Out of memory in %s for irb&bslash;n&quot;
comma
id|p_ch-&gt;id
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|p_ch-&gt;id
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p_ch-&gt;irb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|irb
)paren
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:%s Exit on line %d&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&n; * Setup an interface.&n; *&n; * @param cgdev  Device to be setup.&n; *&n; * @returns 0 on success, !0 on failure.&n; */
r_static
r_int
DECL|function|claw_new_device
id|claw_new_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_struct
id|claw_privbk
op_star
id|privptr
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s() called&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: add for %s&bslash;n&quot;
comma
id|cgdev-&gt;cdev
(braket
id|READ
)braket
op_member_access_from_pointer
id|dev.bus_id
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;new_dev&quot;
)paren
suffix:semicolon
id|privptr
op_assign
id|cgdev-&gt;dev.driver_data
suffix:semicolon
id|cgdev-&gt;cdev
(braket
id|READ
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
id|privptr
suffix:semicolon
id|cgdev-&gt;cdev
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
id|privptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|privptr
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|privptr-&gt;p_env
suffix:semicolon
id|sscanf
c_func
(paren
id|cgdev-&gt;cdev
(braket
id|READ
)braket
op_member_access_from_pointer
id|dev.bus_id
op_plus
l_int|4
comma
l_string|&quot;%x&quot;
comma
op_amp
id|p_env-&gt;devno
(braket
id|READ
)braket
)paren
suffix:semicolon
id|sscanf
c_func
(paren
id|cgdev-&gt;cdev
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|dev.bus_id
op_plus
l_int|4
comma
l_string|&quot;%x&quot;
comma
op_amp
id|p_env-&gt;devno
(braket
id|WRITE
)braket
)paren
suffix:semicolon
id|ret
op_assign
id|add_channel
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
comma
l_int|0
comma
id|privptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|ret
op_assign
id|add_channel
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
comma
l_int|1
comma
id|privptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;add channel failed &quot;
l_string|&quot;with ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|ccw_device_set_online
c_func
(paren
id|cgdev-&gt;cdev
(braket
id|READ
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: ccw_device_set_online %s READ failed &quot;
l_string|&quot;with ret = %d&bslash;n&quot;
comma
id|cgdev-&gt;cdev
(braket
id|READ
)braket
op_member_access_from_pointer
id|dev.bus_id
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|ccw_device_set_online
c_func
(paren
id|cgdev-&gt;cdev
(braket
id|WRITE
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: ccw_device_set_online %s WRITE failed &quot;
l_string|&quot;with ret = %d&bslash;n&quot;
comma
id|cgdev-&gt;cdev
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|dev.bus_id
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dev
op_assign
id|alloc_netdev
c_func
(paren
l_int|0
comma
l_string|&quot;claw%d&quot;
comma
id|claw_init_netdevice
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s:alloc_netdev failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
id|privptr
suffix:semicolon
id|cgdev-&gt;dev.driver_data
op_assign
id|privptr
suffix:semicolon
id|cgdev-&gt;cdev
(braket
id|READ
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
id|privptr
suffix:semicolon
id|cgdev-&gt;cdev
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
id|privptr
suffix:semicolon
multiline_comment|/* sysfs magic */
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|claw_free_netdevice
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;regfail&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;buffs_alloc
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
id|init_ccw_bk
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: init_ccw_bk failed with ret=%d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|claw_free_netdevice
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|trace
comma
l_string|&quot;ccwmem&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|privptr-&gt;channel
(braket
id|READ
)braket
dot
id|ndev
op_assign
id|dev
suffix:semicolon
id|privptr-&gt;channel
(braket
id|WRITE
)braket
dot
id|ndev
op_assign
id|dev
suffix:semicolon
id|privptr-&gt;p_env-&gt;ndev
op_assign
id|dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:readsize=%d  writesize=%d &quot;
l_string|&quot;readbuffer=%d writebuffer=%d read=0x%04x write=0x%04x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_env-&gt;read_size
comma
id|p_env-&gt;write_size
comma
id|p_env-&gt;read_buffers
comma
id|p_env-&gt;write_buffers
comma
id|p_env-&gt;devno
(braket
id|READ
)braket
comma
id|p_env-&gt;devno
(braket
id|WRITE
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:host_name:%.8s, adapter_name &quot;
l_string|&quot;:%.8s api_type: %.8s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|p_env-&gt;host_name
comma
id|p_env-&gt;adapter_name
comma
id|p_env-&gt;api_type
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|ccw_device_set_offline
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ccw_device_set_offline
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_void
DECL|function|claw_purge_skb_queue
id|claw_purge_skb_queue
c_func
(paren
r_struct
id|sk_buff_head
op_star
id|q
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|4
comma
id|trace
comma
l_string|&quot;purgque&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
id|q
)paren
)paren
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Shutdown an interface.&n; *&n; * @param cgdev  Device to be shut down.&n; *&n; * @returns 0 on success, !0 on failure.&n; */
r_static
r_int
DECL|function|claw_shutdown_device
id|claw_shutdown_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s() called&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|cgdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|priv
op_assign
id|cgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ndev
op_assign
id|priv-&gt;channel
(braket
id|READ
)braket
dot
id|ndev
suffix:semicolon
r_if
c_cond
(paren
id|ndev
)paren
(brace
multiline_comment|/* Close the device */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: shuting down &bslash;n&quot;
comma
id|ndev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ndev-&gt;flags
op_amp
id|IFF_RUNNING
)paren
id|ret
op_assign
id|claw_release
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|ndev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|ndev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* cgdev data, not ndev&squot;s to free */
id|claw_free_netdevice
c_func
(paren
id|ndev
comma
l_int|1
)paren
suffix:semicolon
id|priv-&gt;channel
(braket
id|READ
)braket
dot
id|ndev
op_assign
l_int|NULL
suffix:semicolon
id|priv-&gt;channel
(braket
id|WRITE
)braket
dot
id|ndev
op_assign
l_int|NULL
suffix:semicolon
id|priv-&gt;p_env-&gt;ndev
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ccw_device_set_offline
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ccw_device_set_offline
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|claw_remove_device
id|claw_remove_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s() called&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|cgdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|priv
op_assign
id|cgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: %s() no Priv exiting&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: %s() called %s will be removed.&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev.bus_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cgdev-&gt;state
op_eq
id|CCWGROUP_ONLINE
)paren
id|claw_shutdown_device
c_func
(paren
id|cgdev
)paren
suffix:semicolon
id|claw_remove_files
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;p_mtc_envelope
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|priv-&gt;p_mtc_envelope
)paren
suffix:semicolon
id|priv-&gt;p_mtc_envelope
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;p_env
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|priv-&gt;p_env
)paren
suffix:semicolon
id|priv-&gt;p_env
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;channel
(braket
l_int|0
)braket
dot
id|irb
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|priv-&gt;channel
(braket
l_int|0
)braket
dot
id|irb
)paren
suffix:semicolon
id|priv-&gt;channel
(braket
l_int|0
)braket
dot
id|irb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;channel
(braket
l_int|1
)braket
dot
id|irb
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|priv-&gt;channel
(braket
l_int|1
)braket
dot
id|irb
)paren
suffix:semicolon
id|priv-&gt;channel
(braket
l_int|1
)braket
dot
id|irb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|priv
)paren
suffix:semicolon
id|cgdev-&gt;dev.driver_data
op_assign
l_int|NULL
suffix:semicolon
id|cgdev-&gt;cdev
(braket
id|READ
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
l_int|NULL
suffix:semicolon
id|cgdev-&gt;cdev
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
l_int|NULL
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * sysfs attributes&n; */
r_static
id|ssize_t
DECL|function|claw_hname_show
id|claw_hname_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|p_env-&gt;host_name
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|claw_hname_write
id|claw_hname_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|MAX_NAME_LEN
op_plus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
id|p_env-&gt;host_name
comma
l_int|0x20
comma
id|MAX_NAME_LEN
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|p_env-&gt;host_name
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|p_env-&gt;host_name
(braket
id|count
op_minus
l_int|1
)braket
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* clear extra 0x0a */
id|p_env-&gt;host_name
(braket
id|MAX_NAME_LEN
)braket
op_assign
l_int|0x00
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;HstnSet&quot;
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|p_env-&gt;host_name
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|host_name
comma
l_int|0644
comma
id|claw_hname_show
comma
id|claw_hname_write
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|claw_adname_show
id|claw_adname_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|p_env-&gt;adapter_name
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|claw_adname_write
id|claw_adname_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|MAX_NAME_LEN
op_plus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
id|p_env-&gt;adapter_name
comma
l_int|0x20
comma
id|MAX_NAME_LEN
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|p_env-&gt;adapter_name
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|p_env-&gt;adapter_name
(braket
id|count
op_minus
l_int|1
)braket
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* clear extra 0x0a */
id|p_env-&gt;adapter_name
(braket
id|MAX_NAME_LEN
)braket
op_assign
l_int|0x00
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;AdnSet&quot;
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|p_env-&gt;adapter_name
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|adapter_name
comma
l_int|0644
comma
id|claw_adname_show
comma
id|claw_adname_write
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|claw_apname_show
id|claw_apname_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|p_env-&gt;api_type
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|claw_apname_write
id|claw_apname_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|MAX_NAME_LEN
op_plus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
id|p_env-&gt;api_type
comma
l_int|0x20
comma
id|MAX_NAME_LEN
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|p_env-&gt;api_type
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|p_env-&gt;api_type
(braket
id|count
op_minus
l_int|1
)braket
op_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* we get a loose 0x0a */
id|p_env-&gt;api_type
(braket
id|MAX_NAME_LEN
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|p_env-&gt;api_type
comma
id|WS_APPL_NAME_PACKED
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|p_env-&gt;read_size
op_assign
id|DEF_PACK_BUFSIZE
suffix:semicolon
id|p_env-&gt;write_size
op_assign
id|DEF_PACK_BUFSIZE
suffix:semicolon
id|p_env-&gt;packing
op_assign
id|PACKING_ASK
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;PACKING&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|p_env-&gt;packing
op_assign
l_int|0
suffix:semicolon
id|p_env-&gt;read_size
op_assign
id|CLAW_FRAME_SIZE
suffix:semicolon
id|p_env-&gt;write_size
op_assign
id|CLAW_FRAME_SIZE
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;ApiSet&quot;
)paren
suffix:semicolon
)brace
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;%s&quot;
comma
id|p_env-&gt;api_type
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|api_type
comma
l_int|0644
comma
id|claw_apname_show
comma
id|claw_apname_write
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|claw_wbuff_show
id|claw_wbuff_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|p_env-&gt;write_buffers
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|claw_wbuff_write
id|claw_wbuff_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_int
id|nnn
comma
id|max
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%i&quot;
comma
op_amp
id|nnn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_env-&gt;packing
)paren
(brace
id|max
op_assign
l_int|64
suffix:semicolon
)brace
r_else
(brace
id|max
op_assign
l_int|512
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|nnn
OG
id|max
)paren
op_logical_or
(paren
id|nnn
OL
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|p_env-&gt;write_buffers
op_assign
id|nnn
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;Wbufset&quot;
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;WB=%d&quot;
comma
id|p_env-&gt;write_buffers
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|write_buffer
comma
l_int|0644
comma
id|claw_wbuff_show
comma
id|claw_wbuff_write
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|claw_rbuff_show
id|claw_rbuff_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|p_env-&gt;read_buffers
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|claw_rbuff_write
id|claw_rbuff_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|claw_privbk
op_star
id|priv
suffix:semicolon
r_struct
id|claw_env
op_star
id|p_env
suffix:semicolon
r_int
id|nnn
comma
id|max
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|p_env
op_assign
id|priv-&gt;p_env
suffix:semicolon
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%i&quot;
comma
op_amp
id|nnn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p_env-&gt;packing
)paren
(brace
id|max
op_assign
l_int|64
suffix:semicolon
)brace
r_else
(brace
id|max
op_assign
l_int|512
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|nnn
OG
id|max
)paren
op_logical_or
(paren
id|nnn
OL
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|p_env-&gt;read_buffers
op_assign
id|nnn
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;Rbufset&quot;
)paren
suffix:semicolon
id|CLAW_DBF_TEXT_
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;RB=%d&quot;
comma
id|p_env-&gt;read_buffers
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|read_buffer
comma
l_int|0644
comma
id|claw_rbuff_show
comma
id|claw_rbuff_write
)paren
suffix:semicolon
DECL|variable|claw_attr
r_static
r_struct
id|attribute
op_star
id|claw_attr
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_read_buffer.attr
comma
op_amp
id|dev_attr_write_buffer.attr
comma
op_amp
id|dev_attr_adapter_name.attr
comma
op_amp
id|dev_attr_api_type.attr
comma
op_amp
id|dev_attr_host_name.attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|claw_attr_group
r_static
r_struct
id|attribute_group
id|claw_attr_group
op_assign
(brace
dot
id|attrs
op_assign
id|claw_attr
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|claw_add_files
id|claw_add_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s() called&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;add_file&quot;
)paren
suffix:semicolon
r_return
id|sysfs_create_group
c_func
(paren
op_amp
id|dev-&gt;kobj
comma
op_amp
id|claw_attr_group
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|claw_remove_files
id|claw_remove_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s() called&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;rem_file&quot;
)paren
suffix:semicolon
id|sysfs_remove_group
c_func
(paren
op_amp
id|dev-&gt;kobj
comma
op_amp
id|claw_attr_group
)paren
suffix:semicolon
)brace
multiline_comment|/*--------------------------------------------------------------------*&n;*    claw_init  and cleanup                                           *&n;*---------------------------------------------------------------------*/
r_static
r_void
id|__exit
DECL|function|claw_cleanup
id|claw_cleanup
c_func
(paren
r_void
)paren
(brace
id|unregister_cu3088_discipline
c_func
(paren
op_amp
id|claw_group_driver
)paren
suffix:semicolon
id|claw_unregister_debug_facility
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: Driver unloaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Initialize module.&n; * This is called just after the module is loaded.&n; *&n; * @return 0 on success, !0 on error.&n; */
r_static
r_int
id|__init
DECL|function|claw_init
id|claw_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: starting driver &quot;
macro_line|#ifdef MODULE
l_string|&quot;module &quot;
macro_line|#else
l_string|&quot;compiled into kernel &quot;
macro_line|#endif
l_string|&quot; $Revision: 1.35 $ $Date: 2005/03/24 12:25:38 $ &bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: %s() enter &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
id|ret
op_assign
id|claw_register_debug_facility
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw: %s() debug_register failed %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|CLAW_DBF_TEXT
c_func
(paren
l_int|2
comma
id|setup
comma
l_string|&quot;init_mod&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|register_cu3088_discipline
c_func
(paren
op_amp
id|claw_group_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|claw_unregister_debug_facility
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;claw; %s() cu3088 register failed %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ret
)paren
suffix:semicolon
)brace
macro_line|#ifdef FUNCTRACE
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;claw: %s() exit &bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|claw_init
id|module_init
c_func
(paren
id|claw_init
)paren
suffix:semicolon
DECL|variable|claw_cleanup
id|module_exit
c_func
(paren
id|claw_cleanup
)paren
suffix:semicolon
multiline_comment|/*--------------------------------------------------------------------*&n;*    End of File                                                      *&n;*---------------------------------------------------------------------*/
eof
