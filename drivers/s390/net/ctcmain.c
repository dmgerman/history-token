multiline_comment|/*&n; * $Id: ctcmain.c,v 1.36 2003/02/18 09:15:14 mschwide Exp $&n; *&n; * CTC / ESCON network driver&n; *&n; * Copyright (C) 2001 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; * Author(s): Fritz Elfert (elfert@de.ibm.com, felfert@millenux.com)&n; * Fixes by : Jochen R&#xfffd;hrig (roehrig@de.ibm.com)&n; *            Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n; * Driver Model stuff by : Cornelia Huck &lt;cohuck@de.ibm.com&gt;&n; *&n; * Documentation used:&n; *  - Principles of Operation (IBM doc#: SA22-7201-06)&n; *  - Common IO/-Device Commands and Self Description (IBM doc#: SA22-7204-02)&n; *  - Common IO/-Device Commands and Self Description (IBM doc#: SN22-5535)&n; *  - ESCON Channel-to-Channel Adapter (IBM doc#: SA22-7203-00)&n; *  - ESCON I/O Interface (IBM doc#: SA22-7202-029&n; *&n; * and the source of the original CTC driver by:&n; *  Dieter Wellerdiek (wel@de.ibm.com)&n; *  Martin Schwidefsky (schwidefsky@de.ibm.com)&n; *  Denis Joseph Barrow (djbarrow@de.ibm.com,barrow_dj@yahoo.com)&n; *  Jochen R&#xfffd;hrig (roehrig@de.ibm.com)&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * RELEASE-TAG: CTC/ESCON network driver $Revision: 1.36 $&n; *&n; */
"&f;"
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;net/dst.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/ccwgroup.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &quot;ctctty.h&quot;
macro_line|#include &quot;fsm.h&quot;
macro_line|#include &quot;cu3088.h&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;(C) 2000 IBM Corp. by Fritz Elfert (felfert@millenux.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux for S/390 CTC/Escon Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/**&n; * CCW commands, used in this driver.&n; */
DECL|macro|CCW_CMD_WRITE
mdefine_line|#define CCW_CMD_WRITE&t;&t;0x01
DECL|macro|CCW_CMD_READ
mdefine_line|#define CCW_CMD_READ&t;&t;0x02
DECL|macro|CCW_CMD_SET_EXTENDED
mdefine_line|#define CCW_CMD_SET_EXTENDED&t;0xc3
DECL|macro|CCW_CMD_PREPARE
mdefine_line|#define CCW_CMD_PREPARE&t;&t;0xe3
DECL|macro|CTC_PROTO_S390
mdefine_line|#define CTC_PROTO_S390          0
DECL|macro|CTC_PROTO_LINUX
mdefine_line|#define CTC_PROTO_LINUX         1
DECL|macro|CTC_PROTO_LINUX_TTY
mdefine_line|#define CTC_PROTO_LINUX_TTY     2
DECL|macro|CTC_PROTO_OS390
mdefine_line|#define CTC_PROTO_OS390         3
DECL|macro|CTC_PROTO_MAX
mdefine_line|#define CTC_PROTO_MAX           3
DECL|macro|CTC_BUFSIZE_LIMIT
mdefine_line|#define CTC_BUFSIZE_LIMIT       65535
DECL|macro|CTC_BUFSIZE_DEFAULT
mdefine_line|#define CTC_BUFSIZE_DEFAULT     32768
DECL|macro|CTC_TIMEOUT_5SEC
mdefine_line|#define CTC_TIMEOUT_5SEC        5000
DECL|macro|CTC_INITIAL_BLOCKLEN
mdefine_line|#define CTC_INITIAL_BLOCKLEN    2
DECL|macro|READ
mdefine_line|#define READ&t;&t;&t;0
DECL|macro|WRITE
mdefine_line|#define WRITE&t;&t;&t;1
DECL|macro|CTC_ID_SIZE
mdefine_line|#define CTC_ID_SIZE             DEVICE_ID_SIZE+3
"&f;"
DECL|struct|ctc_profile
r_struct
id|ctc_profile
(brace
DECL|member|maxmulti
r_int
r_int
id|maxmulti
suffix:semicolon
DECL|member|maxcqueue
r_int
r_int
id|maxcqueue
suffix:semicolon
DECL|member|doios_single
r_int
r_int
id|doios_single
suffix:semicolon
DECL|member|doios_multi
r_int
r_int
id|doios_multi
suffix:semicolon
DECL|member|txlen
r_int
r_int
id|txlen
suffix:semicolon
DECL|member|tx_time
r_int
r_int
id|tx_time
suffix:semicolon
DECL|member|send_stamp
r_struct
id|timespec
id|send_stamp
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * Definition of one channel&n; */
DECL|struct|channel
r_struct
id|channel
(brace
multiline_comment|/**&n;&t; * Pointer to next channel in list.&n;&t; */
DECL|member|next
r_struct
id|channel
op_star
id|next
suffix:semicolon
DECL|member|id
r_char
id|id
(braket
id|CTC_ID_SIZE
)braket
suffix:semicolon
DECL|member|cdev
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
multiline_comment|/**&n;&t; * Type of this channel.&n;&t; * CTC/A or Escon for valid channels.&n;&t; */
DECL|member|type
r_enum
id|channel_types
id|type
suffix:semicolon
multiline_comment|/**&n;&t; * Misc. flags. See CHANNEL_FLAGS_... below&n;&t; */
DECL|member|flags
id|__u32
id|flags
suffix:semicolon
multiline_comment|/**&n;&t; * The protocol of this channel&n;&t; */
DECL|member|protocol
id|__u16
id|protocol
suffix:semicolon
multiline_comment|/**&n;&t; * I/O and irq related stuff&n;&t; */
DECL|member|ccw
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
DECL|member|irb
r_struct
id|irb
op_star
id|irb
suffix:semicolon
multiline_comment|/**&n;&t; * RX/TX buffer size&n;&t; */
DECL|member|max_bufsize
r_int
id|max_bufsize
suffix:semicolon
multiline_comment|/**&n;&t; * Transmit/Receive buffer.&n;&t; */
DECL|member|trans_skb
r_struct
id|sk_buff
op_star
id|trans_skb
suffix:semicolon
multiline_comment|/**&n;&t; * Universal I/O queue.&n;&t; */
DECL|member|io_queue
r_struct
id|sk_buff_head
id|io_queue
suffix:semicolon
multiline_comment|/**&n;&t; * TX queue for collecting skb&squot;s during busy.&n;&t; */
DECL|member|collect_queue
r_struct
id|sk_buff_head
id|collect_queue
suffix:semicolon
multiline_comment|/**&n;&t; * Amount of data in collect_queue.&n;&t; */
DECL|member|collect_len
r_int
id|collect_len
suffix:semicolon
multiline_comment|/**&n;&t; * spinlock for collect_queue and collect_len&n;&t; */
DECL|member|collect_lock
id|spinlock_t
id|collect_lock
suffix:semicolon
multiline_comment|/**&n;&t; * Timer for detecting unresposive&n;&t; * I/O operations.&n;&t; */
DECL|member|timer
id|fsm_timer
id|timer
suffix:semicolon
multiline_comment|/**&n;&t; * Retry counter for misc. operations.&n;&t; */
DECL|member|retry
r_int
id|retry
suffix:semicolon
multiline_comment|/**&n;&t; * The finite state machine of this channel&n;&t; */
DECL|member|fsm
id|fsm_instance
op_star
id|fsm
suffix:semicolon
multiline_comment|/**&n;&t; * The corresponding net_device this channel&n;&t; * belongs to.&n;&t; */
DECL|member|netdev
r_struct
id|net_device
op_star
id|netdev
suffix:semicolon
DECL|member|prof
r_struct
id|ctc_profile
id|prof
suffix:semicolon
DECL|member|trans_skb_data
r_int
r_char
op_star
id|trans_skb_data
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|CHANNEL_FLAGS_READ
mdefine_line|#define CHANNEL_FLAGS_READ            0
DECL|macro|CHANNEL_FLAGS_WRITE
mdefine_line|#define CHANNEL_FLAGS_WRITE           1
DECL|macro|CHANNEL_FLAGS_INUSE
mdefine_line|#define CHANNEL_FLAGS_INUSE           2
DECL|macro|CHANNEL_FLAGS_BUFSIZE_CHANGED
mdefine_line|#define CHANNEL_FLAGS_BUFSIZE_CHANGED 4
DECL|macro|CHANNEL_FLAGS_RWMASK
mdefine_line|#define CHANNEL_FLAGS_RWMASK 1
DECL|macro|CHANNEL_DIRECTION
mdefine_line|#define CHANNEL_DIRECTION(f) (f &amp; CHANNEL_FLAGS_RWMASK)
multiline_comment|/**&n; * Linked list of all detected channels.&n; */
DECL|variable|channels
r_static
r_struct
id|channel
op_star
id|channels
op_assign
l_int|NULL
suffix:semicolon
DECL|struct|ctc_priv
r_struct
id|ctc_priv
(brace
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|tbusy
r_int
r_int
id|tbusy
suffix:semicolon
multiline_comment|/**&n;&t; * The finite state machine of this interface.&n;&t; */
DECL|member|fsm
id|fsm_instance
op_star
id|fsm
suffix:semicolon
multiline_comment|/**&n;&t; * The protocol of this device&n;&t; */
DECL|member|protocol
id|__u16
id|protocol
suffix:semicolon
multiline_comment|/**&n; &t; * Timer for restarting after I/O Errors&n; &t; */
DECL|member|restart_timer
id|fsm_timer
id|restart_timer
suffix:semicolon
DECL|member|channel
r_struct
id|channel
op_star
id|channel
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * Definition of our link level header.&n; */
DECL|struct|ll_header
r_struct
id|ll_header
(brace
DECL|member|length
id|__u16
id|length
suffix:semicolon
DECL|member|type
id|__u16
id|type
suffix:semicolon
DECL|member|unused
id|__u16
id|unused
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|LL_HEADER_LENGTH
mdefine_line|#define LL_HEADER_LENGTH (sizeof(struct ll_header))
multiline_comment|/**&n; * Compatibility macros for busy handling&n; * of network devices.&n; */
r_static
id|__inline__
r_void
DECL|function|ctc_clear_busy
id|ctc_clear_busy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tbusy
)paren
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
id|__inline__
r_int
DECL|function|ctc_test_and_set_busy
id|ctc_test_and_set_busy
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|tbusy
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Print Banner.&n; */
r_static
r_void
DECL|function|print_banner
id|print_banner
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|printed
op_assign
l_int|0
suffix:semicolon
r_char
id|vbuf
(braket
)braket
op_assign
l_string|&quot;$Revision: 1.36 $&quot;
suffix:semicolon
r_char
op_star
id|version
op_assign
id|vbuf
suffix:semicolon
r_if
c_cond
(paren
id|printed
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|version
op_assign
id|strchr
c_func
(paren
id|version
comma
l_char|&squot;:&squot;
)paren
)paren
)paren
(brace
r_char
op_star
id|p
op_assign
id|strchr
c_func
(paren
id|version
op_plus
l_int|1
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
op_star
id|p
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
r_else
id|version
op_assign
l_string|&quot; ??? &quot;
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CTC driver Version%s&quot;
macro_line|#ifdef DEBUG
l_string|&quot; (DEBUG-VERSION, &quot;
id|__DATE__
id|__TIME__
l_string|&quot;)&quot;
macro_line|#endif
l_string|&quot; initialized&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|printed
op_assign
l_int|1
suffix:semicolon
)brace
"&f;"
multiline_comment|/**&n; * Return type of a detected device.&n; */
r_static
r_enum
id|channel_types
DECL|function|get_channel_type
id|get_channel_type
c_func
(paren
r_struct
id|ccw_device_id
op_star
id|id
)paren
(brace
r_enum
id|channel_types
id|type
op_assign
(paren
r_enum
id|channel_types
)paren
id|id-&gt;driver_info
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|channel_type_ficon
)paren
id|type
op_assign
id|channel_type_escon
suffix:semicolon
r_return
id|type
suffix:semicolon
)brace
"&f;"
multiline_comment|/**&n; * States of the interface statemachine.&n; */
DECL|enum|dev_states
r_enum
id|dev_states
(brace
DECL|enumerator|DEV_STATE_STOPPED
id|DEV_STATE_STOPPED
comma
DECL|enumerator|DEV_STATE_STARTWAIT_RXTX
id|DEV_STATE_STARTWAIT_RXTX
comma
DECL|enumerator|DEV_STATE_STARTWAIT_RX
id|DEV_STATE_STARTWAIT_RX
comma
DECL|enumerator|DEV_STATE_STARTWAIT_TX
id|DEV_STATE_STARTWAIT_TX
comma
DECL|enumerator|DEV_STATE_STOPWAIT_RXTX
id|DEV_STATE_STOPWAIT_RXTX
comma
DECL|enumerator|DEV_STATE_STOPWAIT_RX
id|DEV_STATE_STOPWAIT_RX
comma
DECL|enumerator|DEV_STATE_STOPWAIT_TX
id|DEV_STATE_STOPWAIT_TX
comma
DECL|enumerator|DEV_STATE_RUNNING
id|DEV_STATE_RUNNING
comma
multiline_comment|/**&n;&t; * MUST be always the last element!!&n;&t; */
DECL|enumerator|NR_DEV_STATES
id|NR_DEV_STATES
)brace
suffix:semicolon
DECL|variable|dev_state_names
r_static
r_const
r_char
op_star
id|dev_state_names
(braket
)braket
op_assign
(brace
l_string|&quot;Stopped&quot;
comma
l_string|&quot;StartWait RXTX&quot;
comma
l_string|&quot;StartWait RX&quot;
comma
l_string|&quot;StartWait TX&quot;
comma
l_string|&quot;StopWait RXTX&quot;
comma
l_string|&quot;StopWait RX&quot;
comma
l_string|&quot;StopWait TX&quot;
comma
l_string|&quot;Running&quot;
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * Events of the interface statemachine.&n; */
DECL|enum|dev_events
r_enum
id|dev_events
(brace
DECL|enumerator|DEV_EVENT_START
id|DEV_EVENT_START
comma
DECL|enumerator|DEV_EVENT_STOP
id|DEV_EVENT_STOP
comma
DECL|enumerator|DEV_EVENT_RXUP
id|DEV_EVENT_RXUP
comma
DECL|enumerator|DEV_EVENT_TXUP
id|DEV_EVENT_TXUP
comma
DECL|enumerator|DEV_EVENT_RXDOWN
id|DEV_EVENT_RXDOWN
comma
DECL|enumerator|DEV_EVENT_TXDOWN
id|DEV_EVENT_TXDOWN
comma
DECL|enumerator|DEV_EVENT_RESTART
id|DEV_EVENT_RESTART
comma
multiline_comment|/**&n;&t; * MUST be always the last element!!&n;&t; */
DECL|enumerator|NR_DEV_EVENTS
id|NR_DEV_EVENTS
)brace
suffix:semicolon
DECL|variable|dev_event_names
r_static
r_const
r_char
op_star
id|dev_event_names
(braket
)braket
op_assign
(brace
l_string|&quot;Start&quot;
comma
l_string|&quot;Stop&quot;
comma
l_string|&quot;RX up&quot;
comma
l_string|&quot;TX up&quot;
comma
l_string|&quot;RX down&quot;
comma
l_string|&quot;TX down&quot;
comma
l_string|&quot;Restart&quot;
comma
)brace
suffix:semicolon
"&f;"
multiline_comment|/**&n; * Events of the channel statemachine&n; */
DECL|enum|ch_events
r_enum
id|ch_events
(brace
multiline_comment|/**&n;&t; * Events, representing return code of&n;&t; * I/O operations (ccw_device_start, ccw_device_halt et al.)&n;&t; */
DECL|enumerator|CH_EVENT_IO_SUCCESS
id|CH_EVENT_IO_SUCCESS
comma
DECL|enumerator|CH_EVENT_IO_EBUSY
id|CH_EVENT_IO_EBUSY
comma
DECL|enumerator|CH_EVENT_IO_ENODEV
id|CH_EVENT_IO_ENODEV
comma
DECL|enumerator|CH_EVENT_IO_EIO
id|CH_EVENT_IO_EIO
comma
DECL|enumerator|CH_EVENT_IO_UNKNOWN
id|CH_EVENT_IO_UNKNOWN
comma
DECL|enumerator|CH_EVENT_ATTNBUSY
id|CH_EVENT_ATTNBUSY
comma
DECL|enumerator|CH_EVENT_ATTN
id|CH_EVENT_ATTN
comma
DECL|enumerator|CH_EVENT_BUSY
id|CH_EVENT_BUSY
comma
multiline_comment|/**&n;&t; * Events, representing unit-check&n;&t; */
DECL|enumerator|CH_EVENT_UC_RCRESET
id|CH_EVENT_UC_RCRESET
comma
DECL|enumerator|CH_EVENT_UC_RSRESET
id|CH_EVENT_UC_RSRESET
comma
DECL|enumerator|CH_EVENT_UC_TXTIMEOUT
id|CH_EVENT_UC_TXTIMEOUT
comma
DECL|enumerator|CH_EVENT_UC_TXPARITY
id|CH_EVENT_UC_TXPARITY
comma
DECL|enumerator|CH_EVENT_UC_HWFAIL
id|CH_EVENT_UC_HWFAIL
comma
DECL|enumerator|CH_EVENT_UC_RXPARITY
id|CH_EVENT_UC_RXPARITY
comma
DECL|enumerator|CH_EVENT_UC_ZERO
id|CH_EVENT_UC_ZERO
comma
DECL|enumerator|CH_EVENT_UC_UNKNOWN
id|CH_EVENT_UC_UNKNOWN
comma
multiline_comment|/**&n;&t; * Events, representing subchannel-check&n;&t; */
DECL|enumerator|CH_EVENT_SC_UNKNOWN
id|CH_EVENT_SC_UNKNOWN
comma
multiline_comment|/**&n;&t; * Events, representing machine checks&n;&t; */
DECL|enumerator|CH_EVENT_MC_FAIL
id|CH_EVENT_MC_FAIL
comma
DECL|enumerator|CH_EVENT_MC_GOOD
id|CH_EVENT_MC_GOOD
comma
multiline_comment|/**&n;&t; * Event, representing normal IRQ&n;&t; */
DECL|enumerator|CH_EVENT_IRQ
id|CH_EVENT_IRQ
comma
DECL|enumerator|CH_EVENT_FINSTAT
id|CH_EVENT_FINSTAT
comma
multiline_comment|/**&n;&t; * Event, representing timer expiry.&n;&t; */
DECL|enumerator|CH_EVENT_TIMER
id|CH_EVENT_TIMER
comma
multiline_comment|/**&n;&t; * Events, representing commands from upper levels.&n;&t; */
DECL|enumerator|CH_EVENT_START
id|CH_EVENT_START
comma
DECL|enumerator|CH_EVENT_STOP
id|CH_EVENT_STOP
comma
multiline_comment|/**&n;&t; * MUST be always the last element!!&n;&t; */
DECL|enumerator|NR_CH_EVENTS
id|NR_CH_EVENTS
comma
)brace
suffix:semicolon
DECL|variable|ch_event_names
r_static
r_const
r_char
op_star
id|ch_event_names
(braket
)braket
op_assign
(brace
l_string|&quot;do_IO success&quot;
comma
l_string|&quot;do_IO busy&quot;
comma
l_string|&quot;do_IO enodev&quot;
comma
l_string|&quot;do_IO ioerr&quot;
comma
l_string|&quot;do_IO unknown&quot;
comma
l_string|&quot;Status ATTN &amp; BUSY&quot;
comma
l_string|&quot;Status ATTN&quot;
comma
l_string|&quot;Status BUSY&quot;
comma
l_string|&quot;Unit check remote reset&quot;
comma
l_string|&quot;Unit check remote system reset&quot;
comma
l_string|&quot;Unit check TX timeout&quot;
comma
l_string|&quot;Unit check TX parity&quot;
comma
l_string|&quot;Unit check Hardware failure&quot;
comma
l_string|&quot;Unit check RX parity&quot;
comma
l_string|&quot;Unit check ZERO&quot;
comma
l_string|&quot;Unit check Unknown&quot;
comma
l_string|&quot;SubChannel check Unknown&quot;
comma
l_string|&quot;Machine check failure&quot;
comma
l_string|&quot;Machine check operational&quot;
comma
l_string|&quot;IRQ normal&quot;
comma
l_string|&quot;IRQ final&quot;
comma
l_string|&quot;Timer&quot;
comma
l_string|&quot;Start&quot;
comma
l_string|&quot;Stop&quot;
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * States of the channel statemachine.&n; */
DECL|enum|ch_states
r_enum
id|ch_states
(brace
multiline_comment|/**&n;&t; * Channel not assigned to any device,&n;&t; * initial state, direction invalid&n;&t; */
DECL|enumerator|CH_STATE_IDLE
id|CH_STATE_IDLE
comma
multiline_comment|/**&n;&t; * Channel assigned but not operating&n;&t; */
DECL|enumerator|CH_STATE_STOPPED
id|CH_STATE_STOPPED
comma
DECL|enumerator|CH_STATE_STARTWAIT
id|CH_STATE_STARTWAIT
comma
DECL|enumerator|CH_STATE_STARTRETRY
id|CH_STATE_STARTRETRY
comma
DECL|enumerator|CH_STATE_SETUPWAIT
id|CH_STATE_SETUPWAIT
comma
DECL|enumerator|CH_STATE_RXINIT
id|CH_STATE_RXINIT
comma
DECL|enumerator|CH_STATE_TXINIT
id|CH_STATE_TXINIT
comma
DECL|enumerator|CH_STATE_RX
id|CH_STATE_RX
comma
DECL|enumerator|CH_STATE_TX
id|CH_STATE_TX
comma
DECL|enumerator|CH_STATE_RXIDLE
id|CH_STATE_RXIDLE
comma
DECL|enumerator|CH_STATE_TXIDLE
id|CH_STATE_TXIDLE
comma
DECL|enumerator|CH_STATE_RXERR
id|CH_STATE_RXERR
comma
DECL|enumerator|CH_STATE_TXERR
id|CH_STATE_TXERR
comma
DECL|enumerator|CH_STATE_TERM
id|CH_STATE_TERM
comma
DECL|enumerator|CH_STATE_DTERM
id|CH_STATE_DTERM
comma
DECL|enumerator|CH_STATE_NOTOP
id|CH_STATE_NOTOP
comma
multiline_comment|/**&n;&t; * MUST be always the last element!!&n;&t; */
DECL|enumerator|NR_CH_STATES
id|NR_CH_STATES
comma
)brace
suffix:semicolon
DECL|variable|ch_state_names
r_static
r_const
r_char
op_star
id|ch_state_names
(braket
)braket
op_assign
(brace
l_string|&quot;Idle&quot;
comma
l_string|&quot;Stopped&quot;
comma
l_string|&quot;StartWait&quot;
comma
l_string|&quot;StartRetry&quot;
comma
l_string|&quot;SetupWait&quot;
comma
l_string|&quot;RX init&quot;
comma
l_string|&quot;TX init&quot;
comma
l_string|&quot;RX&quot;
comma
l_string|&quot;TX&quot;
comma
l_string|&quot;RX idle&quot;
comma
l_string|&quot;TX idle&quot;
comma
l_string|&quot;RX error&quot;
comma
l_string|&quot;TX error&quot;
comma
l_string|&quot;Terminating&quot;
comma
l_string|&quot;Restarting&quot;
comma
l_string|&quot;Not operational&quot;
comma
)brace
suffix:semicolon
"&f;"
macro_line|#ifdef DEBUG
multiline_comment|/**&n; * Dump header and first 16 bytes of an sk_buff for debugging purposes.&n; *&n; * @param skb    The sk_buff to dump.&n; * @param offset Offset relative to skb-data, where to start the dump.&n; */
r_static
r_void
DECL|function|ctc_dump_skb
id|ctc_dump_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|offset
)paren
(brace
r_int
r_char
op_star
id|p
op_assign
id|skb-&gt;data
suffix:semicolon
id|__u16
id|bl
suffix:semicolon
r_struct
id|ll_header
op_star
id|header
suffix:semicolon
r_int
id|i
suffix:semicolon
id|p
op_add_assign
id|offset
suffix:semicolon
id|bl
op_assign
op_star
(paren
(paren
id|__u16
op_star
)paren
id|p
)paren
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
id|header
op_assign
(paren
r_struct
id|ll_header
op_star
)paren
id|p
suffix:semicolon
id|p
op_sub_assign
l_int|2
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dump:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;blocklen=%d %04x&bslash;n&quot;
comma
id|bl
comma
id|bl
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;h-&gt;length=%d %04x&bslash;n&quot;
comma
id|header-&gt;length
comma
id|header-&gt;length
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;h-&gt;type=%04x&bslash;n&quot;
comma
id|header-&gt;type
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;h-&gt;unused=%04x&bslash;n&quot;
comma
id|header-&gt;unused
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bl
OG
l_int|16
)paren
id|bl
op_assign
l_int|16
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;data: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bl
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x%s&quot;
comma
op_star
id|p
op_increment
comma
(paren
id|i
op_mod
l_int|16
)paren
ques
c_cond
l_string|&quot; &quot;
suffix:colon
l_string|&quot;&bslash;n&lt;7&gt;&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#else
r_static
r_inline
r_void
DECL|function|ctc_dump_skb
id|ctc_dump_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|offset
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/**&n; * Unpack a just received skb and hand it over to&n; * upper layers.&n; *&n; * @param ch The channel where this skb has been received.&n; * @param pskb The received skb.&n; */
r_static
id|__inline__
r_void
DECL|function|ctc_unpack_skb
id|ctc_unpack_skb
c_func
(paren
r_struct
id|channel
op_star
id|ch
comma
r_struct
id|sk_buff
op_star
id|pskb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|__u16
id|len
op_assign
op_star
(paren
(paren
id|__u16
op_star
)paren
id|pskb-&gt;data
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|pskb
comma
l_int|2
op_plus
id|LL_HEADER_LENGTH
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|pskb
comma
l_int|2
)paren
suffix:semicolon
id|pskb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|pskb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ll_header
op_star
id|header
op_assign
(paren
r_struct
id|ll_header
op_star
)paren
id|pskb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|pskb
comma
id|LL_HEADER_LENGTH
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;protocol
op_eq
id|CTC_PROTO_S390
)paren
op_logical_and
(paren
id|header-&gt;type
op_ne
id|ETH_P_IP
)paren
)paren
(brace
multiline_comment|/**&n;&t;&t;&t; * Check packet type only if we stick strictly&n;&t;&t;&t; * to S/390&squot;s protocol of OS390. This only&n;&t;&t;&t; * supports IP. Otherwise allow any packet&n;&t;&t;&t; * type.&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s Illegal packet type 0x%04x &quot;
l_string|&quot;received, dropping&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|header-&gt;type
)paren
suffix:semicolon
id|ctc_dump_skb
c_func
(paren
id|pskb
comma
op_minus
l_int|6
)paren
suffix:semicolon
id|privptr-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|privptr-&gt;stats.rx_frame_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pskb-&gt;protocol
op_assign
id|ntohs
c_func
(paren
id|header-&gt;type
)paren
suffix:semicolon
id|header-&gt;length
op_sub_assign
id|LL_HEADER_LENGTH
suffix:semicolon
r_if
c_cond
(paren
(paren
id|header-&gt;length
op_eq
l_int|0
)paren
op_logical_or
(paren
id|header-&gt;length
OG
id|skb_tailroom
c_func
(paren
id|pskb
)paren
)paren
op_logical_or
(paren
id|header-&gt;length
OG
id|len
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s Illegal packet size %d &quot;
l_string|&quot;received (MTU=%d blocklen=%d), &quot;
l_string|&quot;dropping&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|header-&gt;length
comma
id|dev-&gt;mtu
comma
id|len
)paren
suffix:semicolon
id|ctc_dump_skb
c_func
(paren
id|pskb
comma
op_minus
l_int|6
)paren
suffix:semicolon
id|privptr-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|privptr-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|header-&gt;length
OG
id|skb_tailroom
c_func
(paren
id|pskb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s Illegal packet size %d &quot;
l_string|&quot;(beyond the end of received data), &quot;
l_string|&quot;dropping&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|header-&gt;length
)paren
suffix:semicolon
id|ctc_dump_skb
c_func
(paren
id|pskb
comma
op_minus
l_int|6
)paren
suffix:semicolon
id|privptr-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|privptr-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|pskb
comma
id|header-&gt;length
)paren
suffix:semicolon
id|pskb-&gt;mac.raw
op_assign
id|pskb-&gt;data
suffix:semicolon
id|len
op_sub_assign
(paren
id|LL_HEADER_LENGTH
op_plus
id|header-&gt;length
)paren
suffix:semicolon
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|pskb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s Out of memory in ctc_unpack_skb&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|privptr-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|pskb-&gt;len
)paren
comma
id|pskb-&gt;data
comma
id|pskb-&gt;len
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|pskb-&gt;dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|pskb-&gt;protocol
suffix:semicolon
id|pskb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;protocol
op_eq
id|CTC_PROTO_LINUX_TTY
)paren
id|ctc_tty_netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
r_else
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
id|privptr-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|privptr-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|skb_pull
c_func
(paren
id|pskb
comma
id|header-&gt;length
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|pskb
comma
id|LL_HEADER_LENGTH
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * Check return code of a preceeding do_IO, halt_IO etc...&n; *&n; * @param ch          The channel, the error belongs to.&n; * @param return_code The error code to inspect.&n; */
r_static
r_void
r_inline
DECL|function|ccw_check_return_code
id|ccw_check_return_code
c_func
(paren
r_struct
id|channel
op_star
id|ch
comma
r_int
id|return_code
)paren
(brace
r_switch
c_cond
(paren
id|return_code
)paren
(brace
r_case
l_int|0
suffix:colon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_IO_SUCCESS
comma
id|ch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EBUSY
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Busy !&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_IO_EBUSY
comma
id|ch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENODEV
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;%s: Invalid device called for IO&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_IO_ENODEV
comma
id|ch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EIO
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;%s: Status pending... &bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_IO_EIO
comma
id|ch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;%s: Unknown error in do_IO %04x&bslash;n&quot;
comma
id|ch-&gt;id
comma
id|return_code
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_IO_UNKNOWN
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Check sense of a unit check.&n; *&n; * @param ch    The channel, the sense code belongs to.&n; * @param sense The sense code to inspect.&n; */
r_static
r_void
r_inline
DECL|function|ccw_unit_check
id|ccw_unit_check
c_func
(paren
r_struct
id|channel
op_star
id|ch
comma
r_int
r_char
id|sense
)paren
(brace
r_if
c_cond
(paren
id|sense
op_amp
id|SNS0_INTERVENTION_REQ
)paren
(brace
r_if
c_cond
(paren
id|sense
op_amp
l_int|0x01
)paren
(brace
r_if
c_cond
(paren
id|ch-&gt;protocol
op_ne
id|CTC_PROTO_LINUX_TTY
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Interface disc. or Sel. reset &quot;
l_string|&quot;(remote)&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_UC_RCRESET
comma
id|ch
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: System reset (remote)&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_UC_RSRESET
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sense
op_amp
id|SNS0_EQUIPMENT_CHECK
)paren
(brace
r_if
c_cond
(paren
id|sense
op_amp
id|SNS0_BUS_OUT_CHECK
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Hardware malfunction (remote)&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_UC_HWFAIL
comma
id|ch
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Read-data parity error (remote)&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_UC_RXPARITY
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sense
op_amp
id|SNS0_BUS_OUT_CHECK
)paren
(brace
r_if
c_cond
(paren
id|sense
op_amp
l_int|0x04
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Data-streaming timeout)&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_UC_TXTIMEOUT
comma
id|ch
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Data-transfer parity error&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_UC_TXPARITY
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sense
op_amp
id|SNS0_CMD_REJECT
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Command reject&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sense
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Unit check ZERO&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_UC_ZERO
comma
id|ch
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unit Check with sense code: %02x&bslash;n&quot;
comma
id|ch-&gt;id
comma
id|sense
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_UC_UNKNOWN
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ctc_purge_skb_queue
id|ctc_purge_skb_queue
c_func
(paren
r_struct
id|sk_buff_head
op_star
id|q
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
id|q
)paren
)paren
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_static
id|__inline__
r_int
DECL|function|ctc_checkalloc_buffer
id|ctc_checkalloc_buffer
c_func
(paren
r_struct
id|channel
op_star
id|ch
comma
r_int
id|warn
)paren
(brace
r_if
c_cond
(paren
(paren
id|ch-&gt;trans_skb
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|ch-&gt;flags
op_amp
id|CHANNEL_FLAGS_BUFSIZE_CHANGED
)paren
)paren
(brace
r_if
c_cond
(paren
id|ch-&gt;trans_skb
op_ne
l_int|NULL
)paren
id|dev_kfree_skb
c_func
(paren
id|ch-&gt;trans_skb
)paren
suffix:semicolon
id|clear_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ch-&gt;trans_skb
op_assign
id|__dev_alloc_skb
c_func
(paren
id|ch-&gt;max_bufsize
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;trans_skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|warn
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Couldn&squot;t alloc %s trans_skb&bslash;n&quot;
comma
id|ch-&gt;id
comma
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
ques
c_cond
l_string|&quot;RX&quot;
suffix:colon
l_string|&quot;TX&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
id|ch-&gt;max_bufsize
suffix:semicolon
r_if
c_cond
(paren
id|set_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|1
)braket
comma
id|ch-&gt;trans_skb-&gt;data
)paren
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|ch-&gt;trans_skb
)paren
suffix:semicolon
id|ch-&gt;trans_skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|warn
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: set_normalized_cda for %s &quot;
l_string|&quot;trans_skb failed, dropping packets&bslash;n&quot;
comma
id|ch-&gt;id
comma
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
ques
c_cond
l_string|&quot;RX&quot;
suffix:colon
l_string|&quot;TX&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;trans_skb_data
op_assign
id|ch-&gt;trans_skb-&gt;data
suffix:semicolon
id|ch-&gt;flags
op_and_assign
op_complement
id|CHANNEL_FLAGS_BUFSIZE_CHANGED
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Dummy NOP action for statemachines&n; */
r_static
r_void
DECL|function|fsm_action_nop
id|fsm_action_nop
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
)brace
"&f;"
multiline_comment|/**&n; * Actions for channel - statemachines.&n; *****************************************************************************/
multiline_comment|/**&n; * Normal data has been send. Free the corresponding&n; * skb (it&squot;s in io_queue), reset dev-&gt;tbusy and&n; * revert to idle state.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_txdone
id|ch_action_txdone
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|first
op_assign
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|timespec
id|done_stamp
op_assign
id|xtime
suffix:semicolon
r_int
r_int
id|duration
op_assign
(paren
id|done_stamp.tv_sec
op_minus
id|ch-&gt;prof.send_stamp.tv_sec
)paren
op_star
l_int|1000000
op_plus
(paren
id|done_stamp.tv_nsec
op_minus
id|ch-&gt;prof.send_stamp.tv_nsec
)paren
op_div
l_int|1000
suffix:semicolon
r_if
c_cond
(paren
id|duration
OG
id|ch-&gt;prof.tx_time
)paren
id|ch-&gt;prof.tx_time
op_assign
id|duration
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;irb-&gt;scsw.count
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: TX not complete, remaining %d bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ch-&gt;irb-&gt;scsw.count
)paren
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
)paren
)paren
(brace
id|privptr-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|privptr-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
op_minus
id|LL_HEADER_LENGTH
suffix:semicolon
r_if
c_cond
(paren
id|first
)paren
(brace
id|privptr-&gt;stats.tx_bytes
op_add_assign
l_int|2
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|ch-&gt;collect_lock
)paren
suffix:semicolon
id|clear_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;collect_len
OG
l_int|0
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|ctc_checkalloc_buffer
c_func
(paren
id|ch
comma
l_int|1
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|ch-&gt;collect_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ch-&gt;trans_skb-&gt;tail
op_assign
id|ch-&gt;trans_skb-&gt;data
op_assign
id|ch-&gt;trans_skb_data
suffix:semicolon
id|ch-&gt;trans_skb-&gt;len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;prof.maxmulti
OL
(paren
id|ch-&gt;collect_len
op_plus
l_int|2
)paren
)paren
id|ch-&gt;prof.maxmulti
op_assign
id|ch-&gt;collect_len
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;prof.maxcqueue
OL
id|skb_queue_len
c_func
(paren
op_amp
id|ch-&gt;collect_queue
)paren
)paren
id|ch-&gt;prof.maxcqueue
op_assign
id|skb_queue_len
c_func
(paren
op_amp
id|ch-&gt;collect_queue
)paren
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
id|skb_put
c_func
(paren
id|ch-&gt;trans_skb
comma
l_int|2
)paren
)paren
op_assign
id|ch-&gt;collect_len
op_plus
l_int|2
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|ch-&gt;collect_queue
)paren
)paren
)paren
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|ch-&gt;trans_skb
comma
id|skb-&gt;len
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|privptr-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|privptr-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
op_minus
id|LL_HEADER_LENGTH
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
id|ch-&gt;collect_len
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ch-&gt;collect_lock
)paren
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
id|ch-&gt;trans_skb-&gt;len
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
id|ch-&gt;prof.send_stamp
op_assign
id|xtime
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|ch-&gt;cdev
comma
op_amp
id|ch-&gt;ccw
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
)paren
id|ch
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
id|ch-&gt;prof.doios_multi
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|privptr-&gt;stats.tx_dropped
op_add_assign
id|i
suffix:semicolon
id|privptr-&gt;stats.tx_errors
op_add_assign
id|i
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|spin_unlock
c_func
(paren
op_amp
id|ch-&gt;collect_lock
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_TXIDLE
)paren
suffix:semicolon
)brace
id|ctc_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Initial data is sent.&n; * Notify device statemachine that we are up and&n; * running.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_txidle
id|ch_action_txidle
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_TXIDLE
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|ch-&gt;netdev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXUP
comma
id|ch-&gt;netdev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Got normal data, check for sanity, queue it up, allocate new buffer&n; * trigger bottom half, and initiate next read.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_rx
id|ch_action_rx
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|len
op_assign
id|ch-&gt;max_bufsize
op_minus
id|ch-&gt;irb-&gt;scsw.count
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|ch-&gt;trans_skb
suffix:semicolon
id|__u16
id|block_len
op_assign
op_star
(paren
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
r_int
id|check_len
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: got packet with length %d &lt; 8&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
)paren
suffix:semicolon
id|privptr-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|privptr-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
id|ch-&gt;max_bufsize
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: got packet with length %d &gt; %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|len
comma
id|ch-&gt;max_bufsize
)paren
suffix:semicolon
id|privptr-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|privptr-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
multiline_comment|/**&n;&t; * VM TCP seems to have a bug sending 2 trailing bytes of garbage.&n;&t; */
r_switch
c_cond
(paren
id|ch-&gt;protocol
)paren
(brace
r_case
id|CTC_PROTO_S390
suffix:colon
r_case
id|CTC_PROTO_OS390
suffix:colon
id|check_len
op_assign
id|block_len
op_plus
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|check_len
op_assign
id|block_len
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|len
OL
id|block_len
)paren
op_logical_or
(paren
id|len
OG
id|check_len
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: got block length %d != rx length %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|block_len
comma
id|len
)paren
suffix:semicolon
id|ctc_dump_skb
c_func
(paren
id|skb
comma
l_int|0
)paren
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
op_assign
id|len
suffix:semicolon
id|privptr-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|privptr-&gt;stats.rx_length_errors
op_increment
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
id|block_len
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|block_len
OG
l_int|0
)paren
(brace
op_star
(paren
(paren
id|__u16
op_star
)paren
id|skb-&gt;data
)paren
op_assign
id|block_len
suffix:semicolon
id|ctc_unpack_skb
c_func
(paren
id|ch
comma
id|skb
)paren
suffix:semicolon
)brace
id|again
suffix:colon
id|skb-&gt;data
op_assign
id|skb-&gt;tail
op_assign
id|ch-&gt;trans_skb_data
suffix:semicolon
id|skb-&gt;len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ctc_checkalloc_buffer
c_func
(paren
id|ch
comma
l_int|1
)paren
)paren
r_return
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
id|ch-&gt;max_bufsize
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|ch-&gt;cdev
comma
op_amp
id|ch-&gt;ccw
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
)paren
id|ch
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
r_static
r_void
id|ch_action_rxidle
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
suffix:semicolon
multiline_comment|/**&n; * Initialize connection by sending a __u16 of value 0.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_firstio
id|ch_action_firstio
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|fsm_getstate
c_func
(paren
id|fi
)paren
op_eq
id|CH_STATE_TXIDLE
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: remote side issued READ?, &quot;
l_string|&quot;init ...&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctc_checkalloc_buffer
c_func
(paren
id|ch
comma
l_int|1
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fsm_getstate
c_func
(paren
id|fi
)paren
op_eq
id|CH_STATE_SETUPWAIT
)paren
op_logical_and
(paren
id|ch-&gt;protocol
op_eq
id|CTC_PROTO_OS390
)paren
)paren
(brace
multiline_comment|/* OS/390 resp. z/OS */
r_if
c_cond
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
(brace
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ch-&gt;trans_skb-&gt;data
)paren
op_assign
id|CTC_INITIAL_BLOCKLEN
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
id|ch_action_rxidle
c_func
(paren
id|fi
comma
id|event
comma
id|arg
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_TXIDLE
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXUP
comma
id|dev
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/**&n;&t; * Don&#xfffd;t setup a timer for receiving the initial RX frame&n;&t; * if in compatibility mode, since VM TCP delays the initial&n;&t; * frame until it has some data to send.&n;&t; */
r_if
c_cond
(paren
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|WRITE
)paren
op_logical_or
(paren
id|ch-&gt;protocol
op_ne
id|CTC_PROTO_S390
)paren
)paren
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ch-&gt;trans_skb-&gt;data
)paren
op_assign
id|CTC_INITIAL_BLOCKLEN
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* Transfer only length */
id|fsm_newstate
c_func
(paren
id|fi
comma
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
ques
c_cond
id|CH_STATE_RXINIT
suffix:colon
id|CH_STATE_TXINIT
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|ch-&gt;cdev
comma
op_amp
id|ch-&gt;ccw
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
)paren
id|ch
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_SETUPWAIT
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
multiline_comment|/**&n;&t; * If in compatibility mode since we don&#xfffd;t setup a timer, we&n;&t; * also signal RX channel up immediately. This enables us&n;&t; * to send packets early which in turn usually triggers some&n;&t; * reply from VM TCP which brings up the RX channel to it&#xfffd;s&n;&t; * final state.&n;&t; */
r_if
c_cond
(paren
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
op_logical_and
(paren
id|ch-&gt;protocol
op_eq
id|CTC_PROTO_S390
)paren
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXUP
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Got initial data, check it. If OK,&n; * notify device statemachine that we are up and&n; * running.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_rxidle
id|ch_action_rxidle
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|__u16
id|buflen
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|buflen
op_assign
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ch-&gt;trans_skb-&gt;data
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: Initial RX count %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|buflen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflen
op_ge
id|CTC_INITIAL_BLOCKLEN
)paren
(brace
r_if
c_cond
(paren
id|ctc_checkalloc_buffer
c_func
(paren
id|ch
comma
l_int|1
)paren
)paren
r_return
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
id|ch-&gt;max_bufsize
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_RXIDLE
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|ch-&gt;cdev
comma
op_amp
id|ch-&gt;ccw
(braket
l_int|0
)braket
comma
(paren
r_int
r_int
)paren
id|ch
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_RXINIT
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXUP
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Initial RX count %d not %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|buflen
comma
id|CTC_INITIAL_BLOCKLEN
)paren
suffix:semicolon
id|ch_action_firstio
c_func
(paren
id|fi
comma
id|event
comma
id|arg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Set channel into extended mode.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_setmode
id|ch_action_setmode
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_int
id|saveflags
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_SETUPWAIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_TIMER
)paren
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|ch-&gt;cdev
comma
op_amp
id|ch-&gt;ccw
(braket
l_int|6
)braket
comma
(paren
r_int
r_int
)paren
id|ch
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_TIMER
)paren
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_STARTWAIT
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
id|ch-&gt;retry
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Setup channel.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_start
id|ch_action_start
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_int
r_int
id|saveflags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ch_action_start ch=NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch-&gt;netdev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ch_action_start dev=NULL, id=%s&bslash;n&quot;
comma
id|ch-&gt;id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: %s channel start&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
ques
c_cond
l_string|&quot;RX&quot;
suffix:colon
l_string|&quot;TX&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;trans_skb
op_ne
l_int|NULL
)paren
(brace
id|clear_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ch-&gt;trans_skb
)paren
suffix:semicolon
id|ch-&gt;trans_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
(brace
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|cmd_code
op_assign
id|CCW_CMD_READ
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|cmd_code
op_assign
id|CCW_CMD_WRITE
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctc_checkalloc_buffer
c_func
(paren
id|ch
comma
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: Could not allocate %s trans_skb, delaying &quot;
l_string|&quot;allocation until first transfer&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
ques
c_cond
l_string|&quot;RX&quot;
suffix:colon
l_string|&quot;TX&quot;
)paren
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|0
)braket
dot
id|cmd_code
op_assign
id|CCW_CMD_PREPARE
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|0
)braket
dot
id|flags
op_assign
id|CCW_FLAG_SLI
op_or
id|CCW_FLAG_CC
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|0
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|0
)braket
dot
id|cda
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|2
)braket
dot
id|cmd_code
op_assign
id|CCW_CMD_NOOP
suffix:semicolon
multiline_comment|/* jointed CE + DE */
id|ch-&gt;ccw
(braket
l_int|2
)braket
dot
id|flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|2
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|2
)braket
dot
id|cda
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|3
)braket
comma
op_amp
id|ch-&gt;ccw
(braket
l_int|0
)braket
comma
r_sizeof
(paren
r_struct
id|ccw1
)paren
op_star
l_int|3
)paren
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|4
)braket
dot
id|cda
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|4
)braket
dot
id|flags
op_and_assign
op_complement
id|CCW_FLAG_IDA
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_STARTWAIT
)paren
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
l_int|1000
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
id|ch-&gt;cdev
comma
(paren
r_int
r_int
)paren
id|ch
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;ctc: %s(): leaving&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Shutdown a channel.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_haltio
id|ch_action_haltio
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_int
r_int
id|saveflags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|oldstate
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_STOP
)paren
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|oldstate
op_assign
id|fsm_getstate
c_func
(paren
id|fi
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_TERM
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
id|ch-&gt;cdev
comma
(paren
r_int
r_int
)paren
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_STOP
)paren
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|oldstate
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * A channel has successfully been halted.&n; * Cleanup it&squot;s queue and notify interface statemachine.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_stopped
id|ch_action_stopped
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_STOPPED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;trans_skb
op_ne
l_int|NULL
)paren
(brace
id|clear_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ch-&gt;trans_skb
)paren
suffix:semicolon
id|ch-&gt;trans_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
(brace
id|skb_queue_purge
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|ctc_purge_skb_queue
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ch-&gt;collect_lock
)paren
suffix:semicolon
id|ctc_purge_skb_queue
c_func
(paren
op_amp
id|ch-&gt;collect_queue
)paren
suffix:semicolon
id|ch-&gt;collect_len
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ch-&gt;collect_lock
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * A stop command from device statemachine arrived and we are in&n; * not operational mode. Set state to stopped.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_stop
id|ch_action_stop
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_STOPPED
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * A machine check for no path, not operational status or gone device has&n; * happened.&n; * Cleanup queue and notify interface statemachine.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_fail
id|ch_action_fail
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_NOTOP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
(brace
id|skb_queue_purge
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|ctc_purge_skb_queue
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ch-&gt;collect_lock
)paren
suffix:semicolon
id|ctc_purge_skb_queue
c_func
(paren
op_amp
id|ch-&gt;collect_queue
)paren
suffix:semicolon
id|ch-&gt;collect_len
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ch-&gt;collect_lock
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Handle error during setup of channel.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_setuperr
id|ch_action_setuperr
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
multiline_comment|/**&n;&t; * Special case: Got UC_RCRESET on setmode.&n;&t; * This means that remote side isn&squot;t setup. In this case&n;&t; * simply retry after some 10 secs...&n;&t; */
r_if
c_cond
(paren
(paren
id|fsm_getstate
c_func
(paren
id|fi
)paren
op_eq
id|CH_STATE_SETUPWAIT
)paren
op_logical_and
(paren
(paren
id|event
op_eq
id|CH_EVENT_UC_RCRESET
)paren
op_logical_or
(paren
id|event
op_eq
id|CH_EVENT_UC_RSRESET
)paren
)paren
)paren
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_STARTRETRY
)paren
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
(brace
r_int
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
id|ch-&gt;cdev
comma
(paren
r_int
r_int
)paren
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Error %s during %s channel setup state=%s&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ch_event_names
(braket
id|event
)braket
comma
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
ques
c_cond
l_string|&quot;RX&quot;
suffix:colon
l_string|&quot;TX&quot;
comma
id|fsm_getstate_str
c_func
(paren
id|fi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_RXERR
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_TXERR
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Restart a channel after an error.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_restart
id|ch_action_restart
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_int
r_int
id|saveflags
suffix:semicolon
r_int
id|oldstate
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: %s channel restart&bslash;n&quot;
comma
id|dev-&gt;name
comma
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
ques
c_cond
l_string|&quot;RX&quot;
suffix:colon
l_string|&quot;TX&quot;
)paren
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
id|oldstate
op_assign
id|fsm_getstate
c_func
(paren
id|fi
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_STARTWAIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_TIMER
)paren
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
id|ch-&gt;cdev
comma
(paren
r_int
r_int
)paren
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_TIMER
)paren
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|oldstate
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Handle error during RX initial handshake (exchange of&n; * 0-length block header)&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_rxiniterr
id|ch_action_rxiniterr
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_TIMER
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Timeout during RX init handshake&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;retry
op_increment
OL
l_int|3
)paren
id|ch_action_restart
c_func
(paren
id|fi
comma
id|event
comma
id|arg
)paren
suffix:semicolon
r_else
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_RXERR
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Error during RX init handshake&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Notify device statemachine if we gave up initialization&n; * of RX channel.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_rxinitfail
id|ch_action_rxinitfail
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_RXERR
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: RX initialization failed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: RX &lt;-&gt; RX connection detected&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Handle RX Unit check remote reset (remote disconnected)&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_rxdisc
id|ch_action_rxdisc
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|channel
op_star
id|ch2
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Got remote disconnect, re-initializing ...&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/**&n;&t; * Notify device statemachine&n;&t; */
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXDOWN
comma
id|dev
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXDOWN
comma
id|dev
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_DTERM
)paren
suffix:semicolon
id|ch2
op_assign
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|channel
(braket
id|WRITE
)braket
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|ch2-&gt;fsm
comma
id|CH_STATE_DTERM
)paren
suffix:semicolon
id|ccw_device_halt
c_func
(paren
id|ch-&gt;cdev
comma
(paren
r_int
r_int
)paren
id|ch
)paren
suffix:semicolon
id|ccw_device_halt
c_func
(paren
id|ch2-&gt;cdev
comma
(paren
r_int
r_int
)paren
id|ch2
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Handle error during TX channel initialization.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_txiniterr
id|ch_action_txiniterr
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_TIMER
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Timeout during TX init handshake&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;retry
op_increment
OL
l_int|3
)paren
id|ch_action_restart
c_func
(paren
id|fi
comma
id|event
comma
id|arg
)paren
suffix:semicolon
r_else
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_TXERR
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Error during TX init handshake&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Handle TX timeout by retrying operation.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_txretry
id|ch_action_txretry
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
r_int
r_int
id|saveflags
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;retry
op_increment
OG
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: TX retry failed, restarting channel&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXDOWN
comma
id|dev
)paren
suffix:semicolon
id|ch_action_restart
c_func
(paren
id|fi
comma
id|event
comma
id|arg
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: TX retry %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ch-&gt;retry
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
)paren
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|clear_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|4
)braket
dot
id|count
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|set_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|4
)braket
comma
id|skb-&gt;data
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: IDAL alloc failed, &quot;
l_string|&quot;restarting channel&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXDOWN
comma
id|dev
)paren
suffix:semicolon
id|ch_action_restart
c_func
(paren
id|fi
comma
id|event
comma
id|arg
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
l_int|1000
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_TIMER
)paren
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|ch-&gt;cdev
comma
op_amp
id|ch-&gt;ccw
(braket
l_int|3
)braket
comma
(paren
r_int
r_int
)paren
id|ch
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|CH_EVENT_TIMER
)paren
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
id|ctc_purge_skb_queue
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/**&n; * Handle fatal errors during an I/O command.&n; *&n; * @param fi    An instance of a channel statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from channel * upon call.&n; */
r_static
r_void
DECL|function|ch_action_iofatal
id|ch_action_iofatal
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CHANNEL_DIRECTION
c_func
(paren
id|ch-&gt;flags
)paren
op_eq
id|READ
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: RX I/O error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_RXERR
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_RXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: TX I/O error&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|CH_STATE_TXERR
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_TXDOWN
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ch_action_reinit
id|ch_action_reinit
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|ch_action_iofatal
c_func
(paren
id|fi
comma
id|event
comma
id|arg
)paren
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|privptr-&gt;restart_timer
comma
l_int|1000
comma
id|DEV_EVENT_RESTART
comma
id|dev
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/**&n; * The statemachine for a channel.&n; */
DECL|variable|ch_fsm
r_static
r_const
id|fsm_node
id|ch_fsm
(braket
)braket
op_assign
(brace
(brace
id|CH_STATE_STOPPED
comma
id|CH_EVENT_STOP
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_STOPPED
comma
id|CH_EVENT_START
comma
id|ch_action_start
)brace
comma
(brace
id|CH_STATE_STOPPED
comma
id|CH_EVENT_FINSTAT
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_STOPPED
comma
id|CH_EVENT_MC_FAIL
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_NOTOP
comma
id|CH_EVENT_STOP
comma
id|ch_action_stop
)brace
comma
(brace
id|CH_STATE_NOTOP
comma
id|CH_EVENT_START
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_NOTOP
comma
id|CH_EVENT_FINSTAT
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_NOTOP
comma
id|CH_EVENT_MC_FAIL
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_NOTOP
comma
id|CH_EVENT_MC_GOOD
comma
id|ch_action_start
)brace
comma
(brace
id|CH_STATE_STARTWAIT
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_STARTWAIT
comma
id|CH_EVENT_START
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_STARTWAIT
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_setmode
)brace
comma
(brace
id|CH_STATE_STARTWAIT
comma
id|CH_EVENT_TIMER
comma
id|ch_action_setuperr
)brace
comma
(brace
id|CH_STATE_STARTWAIT
comma
id|CH_EVENT_IO_ENODEV
comma
id|ch_action_iofatal
)brace
comma
(brace
id|CH_STATE_STARTWAIT
comma
id|CH_EVENT_IO_EIO
comma
id|ch_action_reinit
)brace
comma
(brace
id|CH_STATE_STARTWAIT
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_STARTRETRY
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_STARTRETRY
comma
id|CH_EVENT_TIMER
comma
id|ch_action_setmode
)brace
comma
(brace
id|CH_STATE_STARTRETRY
comma
id|CH_EVENT_FINSTAT
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_STARTRETRY
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_START
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_firstio
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_UC_RCRESET
comma
id|ch_action_setuperr
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_UC_RSRESET
comma
id|ch_action_setuperr
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_TIMER
comma
id|ch_action_setmode
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_IO_ENODEV
comma
id|ch_action_iofatal
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_IO_EIO
comma
id|ch_action_reinit
)brace
comma
(brace
id|CH_STATE_SETUPWAIT
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_START
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_rxidle
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_UC_RCRESET
comma
id|ch_action_rxiniterr
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_UC_RSRESET
comma
id|ch_action_rxiniterr
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_TIMER
comma
id|ch_action_rxiniterr
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_ATTNBUSY
comma
id|ch_action_rxinitfail
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_IO_ENODEV
comma
id|ch_action_iofatal
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_IO_EIO
comma
id|ch_action_reinit
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_UC_ZERO
comma
id|ch_action_firstio
)brace
comma
(brace
id|CH_STATE_RXINIT
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_RXIDLE
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_RXIDLE
comma
id|CH_EVENT_START
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_RXIDLE
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_rx
)brace
comma
(brace
id|CH_STATE_RXIDLE
comma
id|CH_EVENT_UC_RCRESET
comma
id|ch_action_rxdisc
)brace
comma
singleline_comment|//      { CH_STATE_RXIDLE,     CH_EVENT_UC_RSRESET, ch_action_rxretry    },
(brace
id|CH_STATE_RXIDLE
comma
id|CH_EVENT_IO_ENODEV
comma
id|ch_action_iofatal
)brace
comma
(brace
id|CH_STATE_RXIDLE
comma
id|CH_EVENT_IO_EIO
comma
id|ch_action_reinit
)brace
comma
(brace
id|CH_STATE_RXIDLE
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_RXIDLE
comma
id|CH_EVENT_UC_ZERO
comma
id|ch_action_rx
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_START
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_txidle
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_UC_RCRESET
comma
id|ch_action_txiniterr
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_UC_RSRESET
comma
id|ch_action_txiniterr
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_TIMER
comma
id|ch_action_txiniterr
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_IO_ENODEV
comma
id|ch_action_iofatal
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_IO_EIO
comma
id|ch_action_reinit
)brace
comma
(brace
id|CH_STATE_TXINIT
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_TXIDLE
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_TXIDLE
comma
id|CH_EVENT_START
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_TXIDLE
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_firstio
)brace
comma
(brace
id|CH_STATE_TXIDLE
comma
id|CH_EVENT_UC_RCRESET
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_TXIDLE
comma
id|CH_EVENT_UC_RSRESET
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_TXIDLE
comma
id|CH_EVENT_IO_ENODEV
comma
id|ch_action_iofatal
)brace
comma
(brace
id|CH_STATE_TXIDLE
comma
id|CH_EVENT_IO_EIO
comma
id|ch_action_reinit
)brace
comma
(brace
id|CH_STATE_TXIDLE
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_TERM
comma
id|CH_EVENT_STOP
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_TERM
comma
id|CH_EVENT_START
comma
id|ch_action_restart
)brace
comma
(brace
id|CH_STATE_TERM
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_stopped
)brace
comma
(brace
id|CH_STATE_TERM
comma
id|CH_EVENT_UC_RCRESET
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_TERM
comma
id|CH_EVENT_UC_RSRESET
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_TERM
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_DTERM
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_DTERM
comma
id|CH_EVENT_START
comma
id|ch_action_restart
)brace
comma
(brace
id|CH_STATE_DTERM
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_setmode
)brace
comma
(brace
id|CH_STATE_DTERM
comma
id|CH_EVENT_UC_RCRESET
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_DTERM
comma
id|CH_EVENT_UC_RSRESET
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_DTERM
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_START
comma
id|fsm_action_nop
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_FINSTAT
comma
id|ch_action_txdone
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_UC_RCRESET
comma
id|ch_action_txretry
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_UC_RSRESET
comma
id|ch_action_txretry
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_TIMER
comma
id|ch_action_txretry
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_IO_ENODEV
comma
id|ch_action_iofatal
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_IO_EIO
comma
id|ch_action_reinit
)brace
comma
(brace
id|CH_STATE_TX
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_RXERR
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_TXERR
comma
id|CH_EVENT_STOP
comma
id|ch_action_haltio
)brace
comma
(brace
id|CH_STATE_TXERR
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
(brace
id|CH_STATE_RXERR
comma
id|CH_EVENT_MC_FAIL
comma
id|ch_action_fail
)brace
comma
)brace
suffix:semicolon
DECL|variable|CH_FSM_LEN
r_static
r_const
r_int
id|CH_FSM_LEN
op_assign
r_sizeof
(paren
id|ch_fsm
)paren
op_div
r_sizeof
(paren
id|fsm_node
)paren
suffix:semicolon
"&f;"
multiline_comment|/**&n; * Functions related to setup and device detection.&n; *****************************************************************************/
r_static
r_inline
r_int
DECL|function|less_than
id|less_than
c_func
(paren
r_char
op_star
id|id1
comma
r_char
op_star
id|id2
)paren
(brace
r_int
id|dev1
comma
id|dev2
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|id1
op_increment
suffix:semicolon
id|id2
op_increment
suffix:semicolon
)brace
id|dev1
op_assign
id|simple_strtoul
c_func
(paren
id|id1
comma
op_amp
id|id1
comma
l_int|16
)paren
suffix:semicolon
id|dev2
op_assign
id|simple_strtoul
c_func
(paren
id|id2
comma
op_amp
id|id2
comma
l_int|16
)paren
suffix:semicolon
r_return
(paren
id|dev1
OL
id|dev2
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Add a new channel to the list of channels.&n; * Keeps the channel list sorted.&n; *&n; * @param cdev  The ccw_device to be added.&n; * @param type  The type class of the new channel.&n; *&n; * @return 0 on success, !0 on error.&n; */
r_static
r_int
DECL|function|add_channel
id|add_channel
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_enum
id|channel_types
id|type
)paren
(brace
r_struct
id|channel
op_star
op_star
id|c
op_assign
op_amp
id|channels
suffix:semicolon
r_struct
id|channel
op_star
id|ch
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|channel
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ctc: Out of memory in add_channel&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ch
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|channel
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;ccw
op_assign
(paren
r_struct
id|ccw1
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ccw1
)paren
op_star
l_int|8
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|ch
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ctc: Out of memory in add_channel&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n;&t; * &quot;static&quot; ccws are used in the following way:&n;&t; *&n;&t; * ccw[0..2] (Channel program for generic I/O):&n;&t; *           0: prepare&n;&t; *           1: read or write (depending on direction) with fixed&n;&t; *              buffer (idal allocated once when buffer is allocated)&n;&t; *           2: nop&n;&t; * ccw[3..5] (Channel program for direct write of packets)&n;&t; *           3: prepare&n;&t; *           4: write (idal allocated on every write).&n;&t; *           5: nop&n;&t; * ccw[6..7] (Channel program for initial channel setup):&n;&t; *           3: set extended mode&n;&t; *           4: nop&n;&t; *&n;&t; * ch-&gt;ccw[0..5] are initialized in ch_action_start because&n;&t; * the channel&squot;s direction is yet unknown here.&n;&t; */
id|ch-&gt;ccw
(braket
l_int|6
)braket
dot
id|cmd_code
op_assign
id|CCW_CMD_SET_EXTENDED
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|6
)braket
dot
id|flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|6
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|6
)braket
dot
id|cda
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|7
)braket
dot
id|cmd_code
op_assign
id|CCW_CMD_NOOP
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|7
)braket
dot
id|flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|7
)braket
dot
id|count
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|7
)braket
dot
id|cda
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;cdev
op_assign
id|cdev
suffix:semicolon
id|snprintf
c_func
(paren
id|ch-&gt;id
comma
id|DEVICE_ID_SIZE
comma
l_string|&quot;ch-%s&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|ch-&gt;type
op_assign
id|type
suffix:semicolon
id|ch-&gt;fsm
op_assign
id|init_fsm
c_func
(paren
id|ch-&gt;id
comma
id|ch_state_names
comma
id|ch_event_names
comma
id|NR_CH_STATES
comma
id|NR_CH_EVENTS
comma
id|ch_fsm
comma
id|CH_FSM_LEN
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;fsm
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ctc: Could not create FSM in add_channel&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ch
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|fsm_newstate
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_STATE_IDLE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch-&gt;irb
op_assign
(paren
r_struct
id|irb
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|irb
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ctc: Out of memory in add_channel&bslash;n&quot;
)paren
suffix:semicolon
id|kfree_fsm
c_func
(paren
id|ch-&gt;fsm
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ch
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ch-&gt;irb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|irb
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|c
op_logical_and
id|less_than
c_func
(paren
(paren
op_star
id|c
)paren
op_member_access_from_pointer
id|id
comma
id|ch-&gt;id
)paren
)paren
id|c
op_assign
op_amp
(paren
op_star
id|c
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
(paren
op_star
id|c
)paren
op_member_access_from_pointer
id|id
comma
id|ch-&gt;id
comma
id|CTC_ID_SIZE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ctc: add_channel: device %s already in list, &quot;
l_string|&quot;using old entry&bslash;n&quot;
comma
(paren
op_star
id|c
)paren
op_member_access_from_pointer
id|id
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ch-&gt;irb
)paren
suffix:semicolon
id|kfree_fsm
c_func
(paren
id|ch-&gt;fsm
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ch
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|fsm_settimer
c_func
(paren
id|ch-&gt;fsm
comma
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|ch-&gt;collect_queue
)paren
suffix:semicolon
id|ch-&gt;next
op_assign
op_star
id|c
suffix:semicolon
op_star
id|c
op_assign
id|ch
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Release a specific channel in the channel list.&n; *&n; * @param ch Pointer to channel struct to be released.&n; */
r_static
r_void
DECL|function|channel_free
id|channel_free
c_func
(paren
r_struct
id|channel
op_star
id|ch
)paren
(brace
id|ch-&gt;flags
op_and_assign
op_complement
id|CHANNEL_FLAGS_INUSE
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_STATE_IDLE
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Remove a specific channel in the channel list.&n; *&n; * @param ch Pointer to channel struct to be released.&n; */
r_static
r_void
DECL|function|channel_remove
id|channel_remove
c_func
(paren
r_struct
id|channel
op_star
id|ch
)paren
(brace
r_struct
id|channel
op_star
op_star
id|c
op_assign
op_amp
id|channels
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|channel_free
c_func
(paren
id|ch
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|c
)paren
(brace
r_if
c_cond
(paren
op_star
id|c
op_eq
id|ch
)paren
(brace
op_star
id|c
op_assign
id|ch-&gt;next
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|kfree_fsm
c_func
(paren
id|ch-&gt;fsm
)paren
suffix:semicolon
id|clear_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;trans_skb
op_ne
l_int|NULL
)paren
(brace
id|clear_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|ch-&gt;trans_skb
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ch-&gt;ccw
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|c
op_assign
op_amp
(paren
(paren
op_star
id|c
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Get a specific channel from the channel list.&n; *&n; * @param type Type of channel we are interested in.&n; * @param id Id of channel we are interested in.&n; * @param direction Direction we want to use this channel for.&n; *&n; * @return Pointer to a channel or NULL if no matching channel available.&n; */
r_static
r_struct
id|channel
op_star
DECL|function|channel_get
id|channel_get
c_func
(paren
r_enum
id|channel_types
id|type
comma
r_char
op_star
id|id
comma
r_int
id|direction
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
id|channels
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;ctc: %s(): searching for ch with id %d and type %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|id
comma
id|type
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ch
op_logical_and
(paren
(paren
id|strncmp
c_func
(paren
id|ch-&gt;id
comma
id|id
comma
id|CTC_ID_SIZE
)paren
)paren
op_logical_or
(paren
id|ch-&gt;type
op_ne
id|type
)paren
)paren
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;ctc: %s(): ch=0x%p (id=%s, type=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ch
comma
id|ch-&gt;id
comma
id|ch-&gt;type
)paren
suffix:semicolon
id|ch
op_assign
id|ch-&gt;next
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;ctc: %s(): ch=0x%pq (id=%s, type=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ch
comma
id|ch-&gt;id
comma
id|ch-&gt;type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ch
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ctc: %s(): channel with id %s &quot;
l_string|&quot;and type %d not found in channel list&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|id
comma
id|type
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ch-&gt;flags
op_amp
id|CHANNEL_FLAGS_INUSE
)paren
id|ch
op_assign
l_int|NULL
suffix:semicolon
r_else
(brace
id|ch-&gt;flags
op_or_assign
id|CHANNEL_FLAGS_INUSE
suffix:semicolon
id|ch-&gt;flags
op_and_assign
op_complement
id|CHANNEL_FLAGS_RWMASK
suffix:semicolon
id|ch-&gt;flags
op_or_assign
(paren
id|direction
op_eq
id|WRITE
)paren
ques
c_cond
id|CHANNEL_FLAGS_WRITE
suffix:colon
id|CHANNEL_FLAGS_READ
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_STATE_STOPPED
)paren
suffix:semicolon
)brace
)brace
r_return
id|ch
suffix:semicolon
)brace
multiline_comment|/**&n; * Return the channel type by name.&n; *&n; * @param name Name of network interface.&n; *&n; * @return Type class of channel to be used for that interface.&n; */
r_static
r_enum
id|channel_types
r_inline
DECL|function|extract_channel_media
id|extract_channel_media
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_enum
id|channel_types
id|ret
op_assign
id|channel_type_unknown
suffix:semicolon
r_if
c_cond
(paren
id|name
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|name
comma
l_string|&quot;ctc&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
id|ret
op_assign
id|channel_type_parallel
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|name
comma
l_string|&quot;escon&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
id|ret
op_assign
id|channel_type_escon
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * Main IRQ handler.&n; *&n; * @param cdev    The ccw_device the interrupt is for.&n; * @param intparm interruption parameter.&n; * @param irb     interruption response block.&n; */
r_static
r_void
DECL|function|ctc_irq_handler
id|ctc_irq_handler
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
r_int
id|intparm
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|channel
op_star
id|ch
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|priv
suffix:semicolon
multiline_comment|/* Check for unsolicited interrupts. */
r_if
c_cond
(paren
op_logical_neg
id|cdev-&gt;dev.driver_data
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ctc: Got unsolicited irq: %s c-%02x d-%02x&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.dstat
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|priv
op_assign
id|cdev-&gt;dev.driver_data
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|channel
op_star
)paren
id|intparm
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ch
op_ne
id|priv-&gt;channel
(braket
id|READ
)braket
)paren
op_logical_and
(paren
id|ch
op_ne
id|priv-&gt;channel
(braket
id|WRITE
)braket
)paren
)paren
id|ch
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ch
)paren
(brace
multiline_comment|/* Try to extract channel from driver data. */
r_if
c_cond
(paren
id|priv-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|cdev
op_eq
id|cdev
)paren
id|ch
op_assign
id|priv-&gt;channel
(braket
id|READ
)braket
suffix:semicolon
r_else
r_if
c_cond
(paren
id|priv-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|cdev
op_eq
id|cdev
)paren
id|ch
op_assign
id|priv-&gt;channel
(braket
id|READ
)braket
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ctc: Can&squot;t determine channel for interrupt, &quot;
l_string|&quot;device %s&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
(paren
id|ch-&gt;netdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;ctc: ctc_irq_handler dev = NULL bus_id=%s, ch=0x%p&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
comma
id|ch
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: interrupt for device: %s received c-%02x d-%02x&bslash;n&quot;
id|dev-&gt;name
comma
id|ch-&gt;id
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.dstat
)paren
suffix:semicolon
multiline_comment|/* Copy interruption response block. */
id|memcpy
c_func
(paren
id|ch-&gt;irb
comma
id|irb
comma
r_sizeof
(paren
r_struct
id|irb
)paren
)paren
suffix:semicolon
multiline_comment|/* Check for good subchannel return code, otherwise error message */
r_if
c_cond
(paren
id|ch-&gt;irb-&gt;scsw.cstat
)paren
(brace
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_SC_UNKNOWN
comma
id|ch
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: subchannel check for device: %s - %02x %02x&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|ch-&gt;id
comma
id|ch-&gt;irb-&gt;scsw.cstat
comma
id|ch-&gt;irb-&gt;scsw.dstat
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Check the reason-code of a unit check */
r_if
c_cond
(paren
id|ch-&gt;irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
id|ccw_unit_check
c_func
(paren
id|ch
comma
id|ch-&gt;irb-&gt;ecw
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch-&gt;irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_BUSY
)paren
(brace
r_if
c_cond
(paren
id|ch-&gt;irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_ATTENTION
)paren
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_ATTNBUSY
comma
id|ch
)paren
suffix:semicolon
r_else
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_BUSY
comma
id|ch
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch-&gt;irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_ATTENTION
)paren
(brace
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_ATTN
comma
id|ch
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ch-&gt;irb-&gt;scsw.stctl
op_amp
id|SCSW_STCTL_SEC_STATUS
)paren
op_logical_or
(paren
id|ch-&gt;irb-&gt;scsw.stctl
op_eq
id|SCSW_STCTL_STATUS_PEND
)paren
op_logical_or
(paren
id|ch-&gt;irb-&gt;scsw.stctl
op_eq
(paren
id|SCSW_STCTL_ALERT_STATUS
op_or
id|SCSW_STCTL_STATUS_PEND
)paren
)paren
)paren
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_FINSTAT
comma
id|ch
)paren
suffix:semicolon
r_else
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_IRQ
comma
id|ch
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/**&n; * Actions for interface - statemachine.&n; *****************************************************************************/
multiline_comment|/**&n; * Startup channels by sending CH_EVENT_START to each channel.&n; *&n; * @param fi    An instance of an interface statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from struct net_device * upon call.&n; */
r_static
r_void
DECL|function|dev_action_start
id|dev_action_start
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|direction
suffix:semicolon
id|fsm_deltimer
c_func
(paren
op_amp
id|privptr-&gt;restart_timer
)paren
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STARTWAIT_RXTX
)paren
suffix:semicolon
r_for
c_loop
(paren
id|direction
op_assign
id|READ
suffix:semicolon
id|direction
op_le
id|WRITE
suffix:semicolon
id|direction
op_increment
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
id|privptr-&gt;channel
(braket
id|direction
)braket
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_START
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Shutdown channels by sending CH_EVENT_STOP to each channel.&n; *&n; * @param fi    An instance of an interface statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from struct net_device * upon call.&n; */
r_static
r_void
DECL|function|dev_action_stop
id|dev_action_stop
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_int
id|direction
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STOPWAIT_RXTX
)paren
suffix:semicolon
r_for
c_loop
(paren
id|direction
op_assign
id|READ
suffix:semicolon
id|direction
op_le
id|WRITE
suffix:semicolon
id|direction
op_increment
)paren
(brace
r_struct
id|channel
op_star
id|ch
op_assign
id|privptr-&gt;channel
(braket
id|direction
)braket
suffix:semicolon
id|fsm_event
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_EVENT_STOP
comma
id|ch
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|dev_action_restart
id|dev_action_restart
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: Restarting&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|dev_action_stop
c_func
(paren
id|fi
comma
id|event
comma
id|arg
)paren
suffix:semicolon
id|fsm_event
c_func
(paren
id|privptr-&gt;fsm
comma
id|DEV_EVENT_STOP
comma
id|dev
)paren
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|privptr-&gt;restart_timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|DEV_EVENT_START
comma
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Called from channel statemachine&n; * when a channel is up and running.&n; *&n; * @param fi    An instance of an interface statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from struct net_device * upon call.&n; */
r_static
r_void
DECL|function|dev_action_chup
id|dev_action_chup
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_switch
c_cond
(paren
id|fsm_getstate
c_func
(paren
id|fi
)paren
)paren
(brace
r_case
id|DEV_STATE_STARTWAIT_RXTX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_RXUP
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STARTWAIT_TX
)paren
suffix:semicolon
r_else
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STARTWAIT_RX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_STARTWAIT_RX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_RXUP
)paren
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_RUNNING
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: connected with remote side&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;protocol
op_eq
id|CTC_PROTO_LINUX_TTY
)paren
id|ctc_tty_setcarrier
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|ctc_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DEV_STATE_STARTWAIT_TX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_TXUP
)paren
(brace
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_RUNNING
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: connected with remote side&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;protocol
op_eq
id|CTC_PROTO_LINUX_TTY
)paren
id|ctc_tty_setcarrier
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|ctc_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DEV_STATE_STOPWAIT_TX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_RXUP
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STOPWAIT_RXTX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_STOPWAIT_RX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_TXUP
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STOPWAIT_RXTX
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * Called from channel statemachine&n; * when a channel has been shutdown.&n; *&n; * @param fi    An instance of an interface statemachine.&n; * @param event The event, just happened.&n; * @param arg   Generic pointer, casted from struct net_device * upon call.&n; */
r_static
r_void
DECL|function|dev_action_chdown
id|dev_action_chdown
c_func
(paren
id|fsm_instance
op_star
id|fi
comma
r_int
id|event
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_switch
c_cond
(paren
id|fsm_getstate
c_func
(paren
id|fi
)paren
)paren
(brace
r_case
id|DEV_STATE_RUNNING
suffix:colon
r_if
c_cond
(paren
id|privptr-&gt;protocol
op_eq
id|CTC_PROTO_LINUX_TTY
)paren
id|ctc_tty_setcarrier
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_TXDOWN
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STARTWAIT_TX
)paren
suffix:semicolon
r_else
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STARTWAIT_RX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_STARTWAIT_RX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_TXDOWN
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STARTWAIT_RXTX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_STARTWAIT_TX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_RXDOWN
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STARTWAIT_RXTX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_STOPWAIT_RXTX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_TXDOWN
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STOPWAIT_RX
)paren
suffix:semicolon
r_else
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STOPWAIT_TX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_STOPWAIT_RX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_RXDOWN
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STOPPED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DEV_STATE_STOPWAIT_TX
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|DEV_EVENT_TXDOWN
)paren
id|fsm_newstate
c_func
(paren
id|fi
comma
id|DEV_STATE_STOPPED
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|dev_fsm
r_static
r_const
id|fsm_node
id|dev_fsm
(braket
)braket
op_assign
(brace
(brace
id|DEV_STATE_STOPPED
comma
id|DEV_EVENT_START
comma
id|dev_action_start
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RXTX
comma
id|DEV_EVENT_START
comma
id|dev_action_start
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RXTX
comma
id|DEV_EVENT_RXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RXTX
comma
id|DEV_EVENT_TXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RXTX
comma
id|DEV_EVENT_RESTART
comma
id|dev_action_restart
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RX
comma
id|DEV_EVENT_START
comma
id|dev_action_start
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RX
comma
id|DEV_EVENT_RXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RX
comma
id|DEV_EVENT_TXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RX
comma
id|DEV_EVENT_RXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_RX
comma
id|DEV_EVENT_RESTART
comma
id|dev_action_restart
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_TX
comma
id|DEV_EVENT_START
comma
id|dev_action_start
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_TX
comma
id|DEV_EVENT_RXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_TX
comma
id|DEV_EVENT_TXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_TX
comma
id|DEV_EVENT_TXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_STOPWAIT_TX
comma
id|DEV_EVENT_RESTART
comma
id|dev_action_restart
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RXTX
comma
id|DEV_EVENT_STOP
comma
id|dev_action_stop
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RXTX
comma
id|DEV_EVENT_RXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RXTX
comma
id|DEV_EVENT_TXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RXTX
comma
id|DEV_EVENT_RXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RXTX
comma
id|DEV_EVENT_TXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RXTX
comma
id|DEV_EVENT_RESTART
comma
id|dev_action_restart
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_TX
comma
id|DEV_EVENT_STOP
comma
id|dev_action_stop
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_TX
comma
id|DEV_EVENT_RXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_TX
comma
id|DEV_EVENT_TXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_TX
comma
id|DEV_EVENT_RXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_TX
comma
id|DEV_EVENT_RESTART
comma
id|dev_action_restart
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RX
comma
id|DEV_EVENT_STOP
comma
id|dev_action_stop
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RX
comma
id|DEV_EVENT_RXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RX
comma
id|DEV_EVENT_TXUP
comma
id|dev_action_chup
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RX
comma
id|DEV_EVENT_TXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_STARTWAIT_RX
comma
id|DEV_EVENT_RESTART
comma
id|dev_action_restart
)brace
comma
(brace
id|DEV_STATE_RUNNING
comma
id|DEV_EVENT_STOP
comma
id|dev_action_stop
)brace
comma
(brace
id|DEV_STATE_RUNNING
comma
id|DEV_EVENT_RXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_RUNNING
comma
id|DEV_EVENT_TXDOWN
comma
id|dev_action_chdown
)brace
comma
(brace
id|DEV_STATE_RUNNING
comma
id|DEV_EVENT_TXUP
comma
id|fsm_action_nop
)brace
comma
(brace
id|DEV_STATE_RUNNING
comma
id|DEV_EVENT_RXUP
comma
id|fsm_action_nop
)brace
comma
(brace
id|DEV_STATE_RUNNING
comma
id|DEV_EVENT_RESTART
comma
id|dev_action_restart
)brace
comma
)brace
suffix:semicolon
DECL|variable|DEV_FSM_LEN
r_static
r_const
r_int
id|DEV_FSM_LEN
op_assign
r_sizeof
(paren
id|dev_fsm
)paren
op_div
r_sizeof
(paren
id|fsm_node
)paren
suffix:semicolon
multiline_comment|/**&n; * Transmit a packet.&n; * This is a helper function for ctc_tx().&n; *&n; * @param ch Channel to be used for sending.&n; * @param skb Pointer to struct sk_buff of packet to send.&n; *            The linklevel header has already been set up&n; *            by ctc_tx().&n; *&n; * @return 0 on success, -ERRNO on failure. (Never fails.)&n; */
r_static
r_int
DECL|function|transmit_skb
id|transmit_skb
c_func
(paren
r_struct
id|channel
op_star
id|ch
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
r_int
id|saveflags
suffix:semicolon
r_struct
id|ll_header
id|header
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fsm_getstate
c_func
(paren
id|ch-&gt;fsm
)paren
op_ne
id|CH_STATE_TXIDLE
)paren
(brace
r_int
id|l
op_assign
id|skb-&gt;len
op_plus
id|LL_HEADER_LENGTH
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ch-&gt;collect_lock
comma
id|saveflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ch-&gt;collect_len
op_plus
id|l
OG
id|ch-&gt;max_bufsize
op_minus
l_int|2
)paren
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|header.length
op_assign
id|l
suffix:semicolon
id|header.type
op_assign
id|skb-&gt;protocol
suffix:semicolon
id|header.unused
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
id|LL_HEADER_LENGTH
)paren
comma
op_amp
id|header
comma
id|LL_HEADER_LENGTH
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|ch-&gt;collect_queue
comma
id|skb
)paren
suffix:semicolon
id|ch-&gt;collect_len
op_add_assign
id|l
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ch-&gt;collect_lock
comma
id|saveflags
)paren
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|block_len
suffix:semicolon
r_int
id|ccw_idx
suffix:semicolon
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_int
r_int
id|hi
suffix:semicolon
multiline_comment|/**&n;&t;&t; * Protect skb against beeing free&squot;d by upper&n;&t;&t; * layers.&n;&t;&t; */
id|atomic_inc
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|ch-&gt;prof.txlen
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|header.length
op_assign
id|skb-&gt;len
op_plus
id|LL_HEADER_LENGTH
suffix:semicolon
id|header.type
op_assign
id|skb-&gt;protocol
suffix:semicolon
id|header.unused
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
id|LL_HEADER_LENGTH
)paren
comma
op_amp
id|header
comma
id|LL_HEADER_LENGTH
)paren
suffix:semicolon
id|block_len
op_assign
id|skb-&gt;len
op_plus
l_int|2
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
)paren
op_assign
id|block_len
suffix:semicolon
multiline_comment|/**&n;&t;&t; * IDAL support in CTC is broken, so we have to&n;&t;&t; * care about skb&squot;s above 2G ourselves.&n;&t;&t; */
id|hi
op_assign
(paren
(paren
r_int
r_int
)paren
id|skb-&gt;tail
op_plus
id|LL_HEADER_LENGTH
)paren
op_rshift
l_int|31
suffix:semicolon
r_if
c_cond
(paren
id|hi
)paren
(brace
id|nskb
op_assign
id|alloc_skb
c_func
(paren
id|skb-&gt;len
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|LL_HEADER_LENGTH
op_plus
l_int|2
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|nskb
comma
id|skb-&gt;len
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|nskb-&gt;users
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|nskb
suffix:semicolon
)brace
)brace
id|ch-&gt;ccw
(braket
l_int|4
)braket
dot
id|count
op_assign
id|block_len
suffix:semicolon
r_if
c_cond
(paren
id|set_normalized_cda
c_func
(paren
op_amp
id|ch-&gt;ccw
(braket
l_int|4
)braket
comma
id|skb-&gt;data
)paren
)paren
(brace
multiline_comment|/**&n;&t;&t;&t; * idal allocation failed, try via copying to&n;&t;&t;&t; * trans_skb. trans_skb usually has a pre-allocated&n;&t;&t;&t; * idal.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|ctc_checkalloc_buffer
c_func
(paren
id|ch
comma
l_int|1
)paren
)paren
(brace
multiline_comment|/**&n;&t;&t;&t;&t; * Remove our header. It gets added&n;&t;&t;&t;&t; * again on retransmit.&n;&t;&t;&t;&t; */
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|LL_HEADER_LENGTH
op_plus
l_int|2
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ch-&gt;trans_skb-&gt;tail
op_assign
id|ch-&gt;trans_skb-&gt;data
suffix:semicolon
id|ch-&gt;trans_skb-&gt;len
op_assign
l_int|0
suffix:semicolon
id|ch-&gt;ccw
(braket
l_int|1
)braket
dot
id|count
op_assign
id|skb-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|ch-&gt;trans_skb
comma
id|skb-&gt;len
)paren
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|skb-&gt;users
)paren
suffix:semicolon
id|dev_kfree_skb_irq
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ccw_idx
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|skb_queue_tail
c_func
(paren
op_amp
id|ch-&gt;io_queue
comma
id|skb
)paren
suffix:semicolon
id|ccw_idx
op_assign
l_int|3
suffix:semicolon
)brace
id|ch-&gt;retry
op_assign
l_int|0
suffix:semicolon
id|fsm_newstate
c_func
(paren
id|ch-&gt;fsm
comma
id|CH_STATE_TX
)paren
suffix:semicolon
id|fsm_addtimer
c_func
(paren
op_amp
id|ch-&gt;timer
comma
id|CTC_TIMEOUT_5SEC
comma
id|CH_EVENT_TIMER
comma
id|ch
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
id|ch-&gt;prof.send_stamp
op_assign
id|xtime
suffix:semicolon
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|ch-&gt;cdev
comma
op_amp
id|ch-&gt;ccw
(braket
id|ccw_idx
)braket
comma
(paren
r_int
r_int
)paren
id|ch
comma
l_int|0xff
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|ch-&gt;cdev
)paren
comma
id|saveflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccw_idx
op_eq
l_int|3
)paren
id|ch-&gt;prof.doios_single
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|fsm_deltimer
c_func
(paren
op_amp
id|ch-&gt;timer
)paren
suffix:semicolon
id|ccw_check_return_code
c_func
(paren
id|ch
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccw_idx
op_eq
l_int|3
)paren
id|skb_dequeue_tail
c_func
(paren
op_amp
id|ch-&gt;io_queue
)paren
suffix:semicolon
multiline_comment|/**&n;&t;&t;&t; * Remove our header. It gets added&n;&t;&t;&t; * again on retransmit.&n;&t;&t;&t; */
id|skb_pull
c_func
(paren
id|skb
comma
id|LL_HEADER_LENGTH
op_plus
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ccw_idx
op_eq
l_int|0
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ch-&gt;netdev
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
id|privptr-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|privptr-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
op_minus
id|LL_HEADER_LENGTH
suffix:semicolon
)brace
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
"&f;"
multiline_comment|/**&n; * Interface API for upper network layers&n; *****************************************************************************/
multiline_comment|/**&n; * Open an interface.&n; * Called from generic network layer when ifconfig up is run.&n; *&n; * @param dev Pointer to interface struct.&n; *&n; * @return 0 on success, -ERRNO on failure. (Never fails.)&n; */
r_static
r_int
DECL|function|ctc_open
id|ctc_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_START
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Close an interface.&n; * Called from generic network layer when ifconfig down is run.&n; *&n; * @param dev Pointer to interface struct.&n; *&n; * @return 0 on success, -ERRNO on failure. (Never fails.)&n; */
r_static
r_int
DECL|function|ctc_close
id|ctc_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|fsm_event
c_func
(paren
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|fsm
comma
id|DEV_EVENT_STOP
comma
id|dev
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Start transmission of a packet.&n; * Called from generic network device layer.&n; *&n; * @param skb Pointer to buffer containing the packet.&n; * @param dev Pointer to interface struct.&n; *&n; * @return 0 if packet consumed, !0 if packet rejected.&n; *         Note: If we return !0, then the packet is free&squot;d by&n; *               the generic network layer.&n; */
r_static
r_int
DECL|function|ctc_tx
id|ctc_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/**&n;&t; * Some sanity checks ...&n;&t; */
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: NULL sk_buff passed&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|privptr-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
(paren
id|LL_HEADER_LENGTH
op_plus
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Got sk_buff with head room &lt; %ld bytes&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|LL_HEADER_LENGTH
op_plus
l_int|2
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|privptr-&gt;stats.tx_dropped
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n;&t; * If channels are not running, try to restart them&n;&t; * notify anybody about a link failure and throw&n;&t; * away packet. &n;&t; */
r_if
c_cond
(paren
id|fsm_getstate
c_func
(paren
id|privptr-&gt;fsm
)paren
op_ne
id|DEV_STATE_RUNNING
)paren
(brace
id|fsm_event
c_func
(paren
id|privptr-&gt;fsm
comma
id|DEV_EVENT_START
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;protocol
op_eq
id|CTC_PROTO_LINUX_TTY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|dst_link_failure
c_func
(paren
id|skb
)paren
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|privptr-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|privptr-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|privptr-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctc_test_and_set_busy
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|transmit_skb
c_func
(paren
id|privptr-&gt;channel
(braket
id|WRITE
)braket
comma
id|skb
)paren
op_ne
l_int|0
)paren
id|rc
op_assign
l_int|1
suffix:semicolon
id|ctc_clear_busy
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; * Sets MTU of an interface.&n; *&n; * @param dev     Pointer to interface struct.&n; * @param new_mtu The new MTU to use for this interface.&n; *&n; * @return 0 on success, -EINVAL if MTU is out of valid range.&n; *         (valid range is 576 .. 65527). If VM is on the&n; *         remote side, maximum MTU is 32760, however this is&n; *         &lt;em&gt;not&lt;/em&gt; checked here.&n; */
r_static
r_int
DECL|function|ctc_change_mtu
id|ctc_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|576
)paren
op_logical_or
(paren
id|new_mtu
OG
l_int|65527
)paren
op_logical_or
(paren
id|new_mtu
OG
(paren
id|privptr-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|max_bufsize
op_minus
id|LL_HEADER_LENGTH
op_minus
l_int|2
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|LL_HEADER_LENGTH
op_plus
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Returns interface statistics of a device.&n; *&n; * @param dev Pointer to interface struct.&n; *&n; * @return Pointer to stats struct of this interface.&n; */
r_static
r_struct
id|net_device_stats
op_star
DECL|function|ctc_stats
id|ctc_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
op_amp
(paren
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats
suffix:semicolon
)brace
multiline_comment|/*&n; * sysfs attributes&n; */
DECL|macro|CTRL_BUFSIZE
mdefine_line|#define CTRL_BUFSIZE 40
r_static
id|ssize_t
DECL|function|buffer_show
id|buffer_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ctc_priv
op_star
id|priv
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|priv-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|max_bufsize
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|buffer_write
id|buffer_write
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|ctc_priv
op_star
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
suffix:semicolon
r_int
id|bs1
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ndev
op_assign
id|priv-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|netdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ndev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%u&quot;
comma
op_amp
id|bs1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bs1
OG
id|CTC_BUFSIZE_LIMIT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ndev-&gt;flags
op_amp
id|IFF_RUNNING
)paren
op_logical_and
(paren
id|bs1
OL
(paren
id|ndev-&gt;mtu
op_plus
id|LL_HEADER_LENGTH
op_plus
l_int|2
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|bs1
OL
(paren
l_int|576
op_plus
id|LL_HEADER_LENGTH
op_plus
l_int|2
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|priv-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|max_bufsize
op_assign
id|priv-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|max_bufsize
op_assign
id|bs1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ndev-&gt;flags
op_amp
id|IFF_RUNNING
)paren
)paren
id|ndev-&gt;mtu
op_assign
id|bs1
op_minus
id|LL_HEADER_LENGTH
op_minus
l_int|2
suffix:semicolon
id|priv-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|flags
op_or_assign
id|CHANNEL_FLAGS_BUFSIZE_CHANGED
suffix:semicolon
id|priv-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|flags
op_or_assign
id|CHANNEL_FLAGS_BUFSIZE_CHANGED
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|buffer
comma
l_int|0644
comma
id|buffer_show
comma
id|buffer_write
)paren
suffix:semicolon
r_static
r_int
DECL|function|ctc_add_attributes
id|ctc_add_attributes
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
id|device_create_file
c_func
(paren
id|dev
comma
op_amp
id|dev_attr_buffer
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ctc_remove_attributes
id|ctc_remove_attributes
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|device_remove_file
c_func
(paren
id|dev
comma
op_amp
id|dev_attr_buffer
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* FIXME: This has to be converted to another interface, as we can only have one&n; *        value per file and can&squot;t have atomicity then */
mdefine_line|#define STATS_BUFSIZE 2048
r_static
r_int
id|ctc_stat_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|file-&gt;private_data
op_assign
id|kmalloc
c_func
(paren
id|STATS_BUFSIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;private_data
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|ctc_stat_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|kfree
c_func
(paren
id|file-&gt;private_data
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
id|ctc_stat_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|pde
op_assign
id|PDE
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|find_netdev_by_ino
c_func
(paren
id|pde
)paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.maxmulti
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.maxcqueue
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.doios_single
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.doios_multi
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.txlen
op_assign
l_int|0
suffix:semicolon
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.tx_time
op_assign
l_int|0
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|ssize_t
id|ctc_stat_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|pde
op_assign
id|PDE
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
suffix:semicolon
r_char
op_star
id|sbuf
op_assign
(paren
r_char
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|p
op_assign
id|sbuf
suffix:semicolon
r_int
id|l
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|find_netdev_by_ino
c_func
(paren
id|pde
)paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_pos
op_eq
l_int|0
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Device FSM state: %s&bslash;n&quot;
comma
id|fsm_getstate_str
c_func
(paren
id|privptr-&gt;fsm
)paren
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;RX channel FSM state: %s&bslash;n&quot;
comma
id|fsm_getstate_str
c_func
(paren
id|privptr-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|fsm
)paren
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;TX channel FSM state: %s&bslash;n&quot;
comma
id|fsm_getstate_str
c_func
(paren
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|fsm
)paren
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Max. TX buffer used: %ld&bslash;n&quot;
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.maxmulti
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Max. chained SKBs: %ld&bslash;n&quot;
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.maxcqueue
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;TX single write ops: %ld&bslash;n&quot;
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.doios_single
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;TX multi write ops: %ld&bslash;n&quot;
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.doios_multi
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Netto bytes written: %ld&bslash;n&quot;
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.txlen
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;Max. TX IO-time: %ld&bslash;n&quot;
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|prof.tx_time
)paren
suffix:semicolon
)brace
id|l
op_assign
id|strlen
c_func
(paren
id|sbuf
)paren
suffix:semicolon
id|p
op_assign
id|sbuf
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_pos
OL
id|l
)paren
(brace
id|p
op_add_assign
id|file-&gt;f_pos
suffix:semicolon
id|l
op_assign
id|strlen
c_func
(paren
id|p
)paren
suffix:semicolon
id|ret
op_assign
(paren
id|count
OG
id|l
)paren
ques
c_cond
id|l
suffix:colon
id|count
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|p
comma
id|ret
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|file-&gt;f_pos
op_add_assign
id|ret
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_struct
id|file_operations
id|ctc_stat_fops
op_assign
(brace
dot
id|read
op_assign
id|ctc_stat_read
comma
dot
id|write
op_assign
id|ctc_stat_write
comma
dot
id|open
op_assign
id|ctc_stat_open
comma
dot
id|release
op_assign
id|ctc_stat_close
comma
)brace
suffix:semicolon
macro_line|#endif
"&f;"
r_static
r_void
DECL|function|ctc_netdev_unregister
id|ctc_netdev_unregister
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ctc_priv
op_star
id|privptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|privptr
op_assign
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;protocol
op_ne
id|CTC_PROTO_LINUX_TTY
)paren
id|unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
id|ctc_tty_unregister_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ctc_netdev_register
id|ctc_netdev_register
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ctc_priv
op_star
id|privptr
op_assign
(paren
r_struct
id|ctc_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;protocol
op_ne
id|CTC_PROTO_LINUX_TTY
)paren
r_return
id|register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_else
r_return
id|ctc_tty_register_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ctc_free_netdevice
id|ctc_free_netdevice
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|free_dev
)paren
(brace
r_struct
id|ctc_priv
op_star
id|privptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|privptr
op_assign
id|dev-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|privptr
)paren
(brace
r_if
c_cond
(paren
id|privptr-&gt;fsm
)paren
id|kfree_fsm
c_func
(paren
id|privptr-&gt;fsm
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|privptr
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_if
c_cond
(paren
id|free_dev
)paren
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/**&n; * Initialize everything of the net device except the name and the&n; * channel structs.&n; */
r_static
r_struct
id|net_device
op_star
DECL|function|ctc_init_netdevice
id|ctc_init_netdevice
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|alloc_device
comma
r_struct
id|ctc_priv
op_star
id|privptr
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|privptr
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|alloc_device
)paren
(brace
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|net_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|net_device
)paren
)paren
suffix:semicolon
)brace
id|dev-&gt;priv
op_assign
id|privptr
suffix:semicolon
id|privptr-&gt;fsm
op_assign
id|init_fsm
c_func
(paren
l_string|&quot;ctcdev&quot;
comma
id|dev_state_names
comma
id|dev_event_names
comma
id|NR_DEV_STATES
comma
id|NR_DEV_EVENTS
comma
id|dev_fsm
comma
id|DEV_FSM_LEN
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;fsm
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|alloc_device
)paren
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|fsm_newstate
c_func
(paren
id|privptr-&gt;fsm
comma
id|DEV_STATE_STOPPED
)paren
suffix:semicolon
id|fsm_settimer
c_func
(paren
id|privptr-&gt;fsm
comma
op_amp
id|privptr-&gt;restart_timer
)paren
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|CTC_BUFSIZE_DEFAULT
op_minus
id|LL_HEADER_LENGTH
op_minus
l_int|2
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ctc_tx
suffix:semicolon
id|dev-&gt;open
op_assign
id|ctc_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ctc_close
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ctc_stats
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|ctc_change_mtu
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|LL_HEADER_LENGTH
op_plus
l_int|2
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_SLIP
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|100
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_POINTOPOINT
op_or
id|IFF_NOARP
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|ctc_proto_show
id|ctc_proto_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|ctc_priv
op_star
id|priv
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|priv-&gt;protocol
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|ctc_proto_store
id|ctc_proto_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|ctc_priv
op_star
id|priv
suffix:semicolon
r_int
id|value
suffix:semicolon
id|priv
op_assign
id|dev-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sscanf
c_func
(paren
id|buf
comma
l_string|&quot;%u&quot;
comma
op_amp
id|value
)paren
suffix:semicolon
multiline_comment|/* TODO: sanity checks */
id|priv-&gt;protocol
op_assign
id|value
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|protocol
comma
l_int|0644
comma
id|ctc_proto_show
comma
id|ctc_proto_store
)paren
suffix:semicolon
r_static
r_int
DECL|function|ctc_add_files
id|ctc_add_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
id|device_create_file
c_func
(paren
id|dev
comma
op_amp
id|dev_attr_protocol
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ctc_remove_files
id|ctc_remove_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|device_remove_file
c_func
(paren
id|dev
comma
op_amp
id|dev_attr_protocol
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Add ctc specific attributes.&n; * Add ctc private data.&n; * &n; * @param cgdev pointer to ccwgroup_device just added&n; *&n; * @returns 0 on success, !0 on failure.&n; */
r_static
r_int
DECL|function|ctc_probe_device
id|ctc_probe_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_struct
id|ctc_priv
op_star
id|priv
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ctc_priv
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Out of memory&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|priv
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ctc_priv
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ctc_add_files
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|kfree
c_func
(paren
id|priv
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|handler
op_assign
id|ctc_irq_handler
suffix:semicolon
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
op_member_access_from_pointer
id|handler
op_assign
id|ctc_irq_handler
suffix:semicolon
id|cgdev-&gt;dev.driver_data
op_assign
id|priv
suffix:semicolon
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
id|priv
suffix:semicolon
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dev.driver_data
op_assign
id|priv
suffix:semicolon
id|snprintf
c_func
(paren
id|cgdev-&gt;dev.name
comma
id|DEVICE_NAME_SIZE
comma
l_string|&quot;%s&quot;
comma
id|cu3088_type
(braket
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|id.driver_info
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&n; * Setup an interface.&n; *&n; * @param cgdev  Device to be setup.&n; *&n; * @returns 0 on success, !0 on failure.&n; */
r_static
r_int
DECL|function|ctc_new_device
id|ctc_new_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_char
id|read_id
(braket
id|CTC_ID_SIZE
)braket
suffix:semicolon
r_char
id|write_id
(braket
id|CTC_ID_SIZE
)braket
suffix:semicolon
r_int
id|direction
suffix:semicolon
r_enum
id|channel_types
id|type
suffix:semicolon
r_struct
id|ctc_priv
op_star
id|privptr
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|privptr
op_assign
id|cgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|privptr
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|type
op_assign
id|get_channel_type
c_func
(paren
op_amp
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|id
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|read_id
comma
id|DEVICE_ID_SIZE
comma
l_string|&quot;ch-%s&quot;
comma
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
op_member_access_from_pointer
id|dev.bus_id
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|write_id
comma
id|DEVICE_ID_SIZE
comma
l_string|&quot;ch-%s&quot;
comma
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
op_member_access_from_pointer
id|dev.bus_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|add_channel
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
comma
id|type
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|add_channel
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
comma
id|type
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ccw_device_set_online
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ccw_device_set_online
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|dev
op_assign
id|ctc_init_netdevice
c_func
(paren
l_int|NULL
comma
l_int|1
comma
id|privptr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ctc_init_netdevice failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|privptr-&gt;protocol
op_eq
id|CTC_PROTO_LINUX_TTY
)paren
id|snprintf
c_func
(paren
id|dev-&gt;name
comma
l_int|8
comma
l_string|&quot;ctctty%%d&quot;
)paren
suffix:semicolon
r_else
id|snprintf
c_func
(paren
id|dev-&gt;name
comma
l_int|8
comma
l_string|&quot;ctc%%d&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|direction
op_assign
id|READ
suffix:semicolon
id|direction
op_le
id|WRITE
suffix:semicolon
id|direction
op_increment
)paren
(brace
id|privptr-&gt;channel
(braket
id|direction
)braket
op_assign
id|channel_get
c_func
(paren
id|type
comma
id|direction
op_eq
id|READ
ques
c_cond
id|read_id
suffix:colon
id|write_id
comma
id|direction
)paren
suffix:semicolon
r_if
c_cond
(paren
id|privptr-&gt;channel
(braket
id|direction
)braket
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|direction
op_eq
id|WRITE
)paren
id|channel_free
c_func
(paren
id|privptr-&gt;channel
(braket
id|READ
)braket
)paren
suffix:semicolon
id|ctc_free_netdevice
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|privptr-&gt;channel
(braket
id|direction
)braket
op_member_access_from_pointer
id|netdev
op_assign
id|dev
suffix:semicolon
id|privptr-&gt;channel
(braket
id|direction
)braket
op_member_access_from_pointer
id|protocol
op_assign
id|privptr-&gt;protocol
suffix:semicolon
id|privptr-&gt;channel
(braket
id|direction
)braket
op_member_access_from_pointer
id|max_bufsize
op_assign
id|CTC_BUFSIZE_DEFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctc_netdev_register
c_func
(paren
id|dev
)paren
op_ne
l_int|0
)paren
(brace
id|ctc_free_netdevice
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ctc_add_attributes
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|privptr-&gt;fsm-&gt;name
comma
id|dev-&gt;name
comma
r_sizeof
(paren
id|privptr-&gt;fsm-&gt;name
)paren
)paren
suffix:semicolon
id|print_banner
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: read: %s, write: %s, proto: %d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|privptr-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|id
comma
id|privptr-&gt;channel
(braket
id|WRITE
)braket
op_member_access_from_pointer
id|id
comma
id|privptr-&gt;protocol
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|ccw_device_set_offline
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ccw_device_set_offline
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/**&n; * Shutdown an interface.&n; *&n; * @param cgdev  Device to be shut down.&n; *&n; * @returns 0 on success, !0 on failure.&n; */
r_static
r_int
DECL|function|ctc_shutdown_device
id|ctc_shutdown_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_struct
id|ctc_priv
op_star
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|ndev
suffix:semicolon
id|priv
op_assign
id|cgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ndev
op_assign
id|priv-&gt;channel
(braket
id|READ
)braket
op_member_access_from_pointer
id|netdev
suffix:semicolon
multiline_comment|/* Close the device */
id|ctc_close
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|ndev-&gt;flags
op_and_assign
op_complement
id|IFF_RUNNING
suffix:semicolon
id|ctc_remove_attributes
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
id|channel_free
c_func
(paren
id|priv-&gt;channel
(braket
id|READ
)braket
)paren
suffix:semicolon
id|channel_free
c_func
(paren
id|priv-&gt;channel
(braket
id|WRITE
)braket
)paren
suffix:semicolon
id|ctc_netdev_unregister
c_func
(paren
id|ndev
)paren
suffix:semicolon
id|ndev-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|ctc_free_netdevice
c_func
(paren
id|ndev
comma
l_int|1
)paren
suffix:semicolon
id|kfree_fsm
c_func
(paren
id|priv-&gt;fsm
)paren
suffix:semicolon
id|ccw_device_set_offline
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ccw_device_set_offline
c_func
(paren
id|cgdev-&gt;cdev
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|channel_remove
c_func
(paren
id|priv-&gt;channel
(braket
id|READ
)braket
)paren
suffix:semicolon
id|channel_remove
c_func
(paren
id|priv-&gt;channel
(braket
id|WRITE
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|ctc_remove_device
id|ctc_remove_device
c_func
(paren
r_struct
id|ccwgroup_device
op_star
id|cgdev
)paren
(brace
r_struct
id|ctc_priv
op_star
id|priv
suffix:semicolon
id|priv
op_assign
id|cgdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
l_int|0
suffix:semicolon
id|ctc_remove_files
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
id|cgdev-&gt;dev.driver_data
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|priv
)paren
suffix:semicolon
id|put_device
c_func
(paren
op_amp
id|cgdev-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ctc_group_driver
r_static
r_struct
id|ccwgroup_driver
id|ctc_group_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ctc&quot;
comma
dot
id|max_slaves
op_assign
l_int|2
comma
dot
id|driver_id
op_assign
l_int|0xC3E3C3
comma
dot
id|probe
op_assign
id|ctc_probe_device
comma
dot
id|remove
op_assign
id|ctc_remove_device
comma
dot
id|set_online
op_assign
id|ctc_new_device
comma
dot
id|set_offline
op_assign
id|ctc_shutdown_device
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * Module related routines&n; *****************************************************************************/
multiline_comment|/**&n; * Prepare to be unloaded. Free IRQ&squot;s and release all resources.&n; * This is called just before this module is unloaded. It is&n; * &lt;em&gt;not&lt;/em&gt; called, if the usage count is !0, so we don&squot;t need to check&n; * for that.&n; */
r_static
r_void
id|__exit
DECL|function|ctc_exit
id|ctc_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_cu3088_discipline
c_func
(paren
op_amp
id|ctc_group_driver
)paren
suffix:semicolon
id|ctc_tty_cleanup
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;CTC driver unloaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Initialize module.&n; * This is called just after the module is loaded.&n; *&n; * @return 0 on success, !0 on error.&n; */
r_static
r_int
id|__init
DECL|function|ctc_init
id|ctc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|print_banner
c_func
(paren
)paren
suffix:semicolon
id|ctc_tty_init
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|register_cu3088_discipline
c_func
(paren
op_amp
id|ctc_group_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|ctc_tty_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|ctc_init
id|module_init
c_func
(paren
id|ctc_init
)paren
suffix:semicolon
DECL|variable|ctc_exit
id|module_exit
c_func
(paren
id|ctc_exit
)paren
suffix:semicolon
multiline_comment|/* --- This is the END my friend --- */
eof
