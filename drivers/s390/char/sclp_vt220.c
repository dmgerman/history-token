multiline_comment|/*&n; *  drivers/s390/char/sclp_vt220.c&n; *    SCLP VT220 terminal driver.&n; *&n; *  S390 version&n; *    Copyright (C) 2003 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Peter Oberparleiter &lt;Peter.Oberparleiter@de.ibm.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;sclp.h&quot;
DECL|macro|SCLP_VT220_PRINT_HEADER
mdefine_line|#define SCLP_VT220_PRINT_HEADER &t;&quot;sclp vt220 tty driver: &quot;
DECL|macro|SCLP_VT220_MAJOR
mdefine_line|#define SCLP_VT220_MAJOR&t;&t;TTY_MAJOR
DECL|macro|SCLP_VT220_MINOR
mdefine_line|#define SCLP_VT220_MINOR&t;&t;65
DECL|macro|SCLP_VT220_DRIVER_NAME
mdefine_line|#define SCLP_VT220_DRIVER_NAME&t;&t;&quot;sclp_vt220&quot;
DECL|macro|SCLP_VT220_DEVICE_NAME
mdefine_line|#define SCLP_VT220_DEVICE_NAME&t;&t;&quot;ttysclp&quot;
DECL|macro|SCLP_VT220_CONSOLE_NAME
mdefine_line|#define SCLP_VT220_CONSOLE_NAME&t;&t;&quot;ttyS&quot;
DECL|macro|SCLP_VT220_CONSOLE_INDEX
mdefine_line|#define SCLP_VT220_CONSOLE_INDEX&t;1&t;/* console=ttyS1 */
DECL|macro|SCLP_VT220_BUF_SIZE
mdefine_line|#define SCLP_VT220_BUF_SIZE&t;&t;80
multiline_comment|/* Representation of a single write request */
DECL|struct|sclp_vt220_request
r_struct
id|sclp_vt220_request
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|sclp_req
r_struct
id|sclp_req
id|sclp_req
suffix:semicolon
DECL|member|retry_count
r_int
id|retry_count
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* VT220 SCCB */
DECL|struct|sclp_vt220_sccb
r_struct
id|sclp_vt220_sccb
(brace
DECL|member|header
r_struct
id|sccb_header
id|header
suffix:semicolon
DECL|member|evbuf
r_struct
id|evbuf_header
id|evbuf
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|SCLP_VT220_MAX_CHARS_PER_BUFFER
mdefine_line|#define SCLP_VT220_MAX_CHARS_PER_BUFFER&t;(PAGE_SIZE - &bslash;&n;&t;&t;&t;&t;&t; sizeof(struct sclp_vt220_request) - &bslash;&n;&t;&t;&t;&t;&t; sizeof(struct sclp_vt220_sccb))
multiline_comment|/* Structures and data needed to register tty driver */
DECL|variable|sclp_vt220_driver
r_static
r_struct
id|tty_driver
op_star
id|sclp_vt220_driver
suffix:semicolon
multiline_comment|/* The tty_struct that the kernel associated with us */
DECL|variable|sclp_vt220_tty
r_static
r_struct
id|tty_struct
op_star
id|sclp_vt220_tty
suffix:semicolon
multiline_comment|/* Lock to protect internal data from concurrent access */
DECL|variable|sclp_vt220_lock
r_static
id|spinlock_t
id|sclp_vt220_lock
suffix:semicolon
multiline_comment|/* List of empty pages to be used as write request buffers */
DECL|variable|sclp_vt220_empty
r_static
r_struct
id|list_head
id|sclp_vt220_empty
suffix:semicolon
multiline_comment|/* List of pending requests */
DECL|variable|sclp_vt220_outqueue
r_static
r_struct
id|list_head
id|sclp_vt220_outqueue
suffix:semicolon
multiline_comment|/* Number of requests in outqueue */
DECL|variable|sclp_vt220_outqueue_count
r_static
r_int
id|sclp_vt220_outqueue_count
suffix:semicolon
multiline_comment|/* Wait queue used to delay write requests while we&squot;ve run out of buffers */
DECL|variable|sclp_vt220_waitq
r_static
id|wait_queue_head_t
id|sclp_vt220_waitq
suffix:semicolon
multiline_comment|/* Timer used for delaying write requests to merge subsequent messages into&n; * a single buffer */
DECL|variable|sclp_vt220_timer
r_static
r_struct
id|timer_list
id|sclp_vt220_timer
suffix:semicolon
multiline_comment|/* Pointer to current request buffer which has been partially filled but not&n; * yet sent */
DECL|variable|sclp_vt220_current_request
r_static
r_struct
id|sclp_vt220_request
op_star
id|sclp_vt220_current_request
suffix:semicolon
multiline_comment|/* Number of characters in current request buffer */
DECL|variable|sclp_vt220_buffered_chars
r_static
r_int
id|sclp_vt220_buffered_chars
suffix:semicolon
multiline_comment|/* Flag indicating whether this driver has already been initialized */
DECL|variable|sclp_vt220_initialized
r_static
r_int
id|sclp_vt220_initialized
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Flag indicating that sclp_vt220_current_request should really&n; * have been already queued but wasn&squot;t because the SCLP was processing&n; * another buffer */
DECL|variable|sclp_vt220_flush_later
r_static
r_int
id|sclp_vt220_flush_later
suffix:semicolon
r_static
r_void
id|sclp_vt220_receiver_fn
c_func
(paren
r_struct
id|evbuf_header
op_star
id|evbuf
)paren
suffix:semicolon
r_static
r_int
id|__sclp_vt220_emit
c_func
(paren
r_struct
id|sclp_vt220_request
op_star
id|request
)paren
suffix:semicolon
r_static
r_void
id|sclp_vt220_emit_current
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Registration structure for our interest in SCLP event buffers */
DECL|variable|sclp_vt220_register
r_static
r_struct
id|sclp_register
id|sclp_vt220_register
op_assign
(brace
dot
id|send_mask
op_assign
id|EvTyp_VT220Msg_Mask
comma
dot
id|receive_mask
op_assign
id|EvTyp_VT220Msg_Mask
comma
dot
id|state_change_fn
op_assign
l_int|NULL
comma
dot
id|receiver_fn
op_assign
id|sclp_vt220_receiver_fn
)brace
suffix:semicolon
multiline_comment|/*&n; * Put provided request buffer back into queue and check emit pending&n; * buffers if necessary.&n; */
r_static
r_void
DECL|function|sclp_vt220_process_queue
id|sclp_vt220_process_queue
c_func
(paren
r_struct
id|sclp_vt220_request
op_star
id|request
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_void
op_star
id|page
suffix:semicolon
r_do
(brace
multiline_comment|/* Put buffer back to list of empty buffers */
id|page
op_assign
id|request-&gt;sclp_req.sccb
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Move request from outqueue to empty queue */
id|list_del
c_func
(paren
op_amp
id|request-&gt;list
)paren
suffix:semicolon
id|sclp_vt220_outqueue_count
op_decrement
suffix:semicolon
id|list_add_tail
c_func
(paren
(paren
r_struct
id|list_head
op_star
)paren
id|page
comma
op_amp
id|sclp_vt220_empty
)paren
suffix:semicolon
multiline_comment|/* Check if there is a pending buffer on the out queue. */
id|request
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|sclp_vt220_outqueue
)paren
)paren
id|request
op_assign
id|list_entry
c_func
(paren
id|sclp_vt220_outqueue.next
comma
r_struct
id|sclp_vt220_request
comma
id|list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|request
op_logical_and
id|__sclp_vt220_emit
c_func
(paren
id|request
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request
op_eq
l_int|NULL
op_logical_and
id|sclp_vt220_flush_later
)paren
id|sclp_vt220_emit_current
c_func
(paren
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|sclp_vt220_waitq
)paren
suffix:semicolon
multiline_comment|/* Check if the tty needs a wake up call */
r_if
c_cond
(paren
id|sclp_vt220_tty
op_ne
l_int|NULL
)paren
(brace
id|tty_wakeup
c_func
(paren
id|sclp_vt220_tty
)paren
suffix:semicolon
)brace
)brace
DECL|macro|SCLP_BUFFER_MAX_RETRY
mdefine_line|#define SCLP_BUFFER_MAX_RETRY&t;&t;1
multiline_comment|/*&n; * Callback through which the result of a write request is reported by the&n; * SCLP.&n; */
r_static
r_void
DECL|function|sclp_vt220_callback
id|sclp_vt220_callback
c_func
(paren
r_struct
id|sclp_req
op_star
id|request
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|sclp_vt220_request
op_star
id|vt220_request
suffix:semicolon
r_struct
id|sclp_vt220_sccb
op_star
id|sccb
suffix:semicolon
id|vt220_request
op_assign
(paren
r_struct
id|sclp_vt220_request
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;status
op_eq
id|SCLP_REQ_FAILED
)paren
(brace
id|sclp_vt220_process_queue
c_func
(paren
id|vt220_request
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sccb
op_assign
(paren
r_struct
id|sclp_vt220_sccb
op_star
)paren
id|vt220_request-&gt;sclp_req.sccb
suffix:semicolon
multiline_comment|/* Check SCLP response code and choose suitable action&t;*/
r_switch
c_cond
(paren
id|sccb-&gt;header.response_code
)paren
(brace
r_case
l_int|0x0020
suffix:colon
r_break
suffix:semicolon
r_case
l_int|0x05f0
suffix:colon
multiline_comment|/* Target resource in improper state */
r_break
suffix:semicolon
r_case
l_int|0x0340
suffix:colon
multiline_comment|/* Contained SCLP equipment check */
r_if
c_cond
(paren
op_increment
id|vt220_request-&gt;retry_count
OG
id|SCLP_BUFFER_MAX_RETRY
)paren
r_break
suffix:semicolon
multiline_comment|/* Remove processed buffers and requeue rest */
r_if
c_cond
(paren
id|sclp_remove_processed
c_func
(paren
(paren
r_struct
id|sccb_header
op_star
)paren
id|sccb
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/* Not all buffers were processed */
id|sccb-&gt;header.response_code
op_assign
l_int|0x0000
suffix:semicolon
id|vt220_request-&gt;sclp_req.status
op_assign
id|SCLP_REQ_FILLED
suffix:semicolon
r_if
c_cond
(paren
id|sclp_add_request
c_func
(paren
id|request
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x0040
suffix:colon
multiline_comment|/* SCLP equipment check */
r_if
c_cond
(paren
op_increment
id|vt220_request-&gt;retry_count
OG
id|SCLP_BUFFER_MAX_RETRY
)paren
r_break
suffix:semicolon
id|sccb-&gt;header.response_code
op_assign
l_int|0x0000
suffix:semicolon
id|vt220_request-&gt;sclp_req.status
op_assign
id|SCLP_REQ_FILLED
suffix:semicolon
r_if
c_cond
(paren
id|sclp_add_request
c_func
(paren
id|request
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|sclp_vt220_process_queue
c_func
(paren
id|vt220_request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Emit vt220 request buffer to SCLP. Return zero on success, non-zero&n; * otherwise.&n; */
r_static
r_int
DECL|function|__sclp_vt220_emit
id|__sclp_vt220_emit
c_func
(paren
r_struct
id|sclp_vt220_request
op_star
id|request
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sclp_vt220_register.sclp_send_mask
op_amp
id|EvTyp_VT220Msg_Mask
)paren
)paren
(brace
id|request-&gt;sclp_req.status
op_assign
id|SCLP_REQ_FAILED
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|request-&gt;sclp_req.command
op_assign
id|SCLP_CMDW_WRITEDATA
suffix:semicolon
id|request-&gt;sclp_req.status
op_assign
id|SCLP_REQ_FILLED
suffix:semicolon
id|request-&gt;sclp_req.callback
op_assign
id|sclp_vt220_callback
suffix:semicolon
id|request-&gt;sclp_req.callback_data
op_assign
(paren
r_void
op_star
)paren
id|request
suffix:semicolon
r_return
id|sclp_add_request
c_func
(paren
op_amp
id|request-&gt;sclp_req
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Queue and emit given request.&n; */
r_static
r_void
DECL|function|sclp_vt220_emit
id|sclp_vt220_emit
c_func
(paren
r_struct
id|sclp_vt220_request
op_star
id|request
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|request-&gt;list
comma
op_amp
id|sclp_vt220_outqueue
)paren
suffix:semicolon
id|count
op_assign
id|sclp_vt220_outqueue_count
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Emit only the first buffer immediately - callback takes care of&n;&t; * the rest */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
op_logical_and
id|__sclp_vt220_emit
c_func
(paren
id|request
)paren
)paren
id|sclp_vt220_process_queue
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Queue and emit current request. Return zero on success, non-zero otherwise.&n; */
r_static
r_void
DECL|function|sclp_vt220_emit_current
id|sclp_vt220_emit_current
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sclp_vt220_request
op_star
id|request
suffix:semicolon
r_struct
id|sclp_vt220_sccb
op_star
id|sccb
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
id|request
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sclp_vt220_current_request
op_ne
l_int|NULL
)paren
(brace
id|sccb
op_assign
(paren
r_struct
id|sclp_vt220_sccb
op_star
)paren
id|sclp_vt220_current_request-&gt;sclp_req.sccb
suffix:semicolon
multiline_comment|/* Only emit buffers with content */
r_if
c_cond
(paren
id|sccb-&gt;header.length
op_ne
r_sizeof
(paren
r_struct
id|sclp_vt220_sccb
)paren
)paren
(brace
id|request
op_assign
id|sclp_vt220_current_request
suffix:semicolon
id|sclp_vt220_current_request
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|sclp_vt220_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|sclp_vt220_timer
)paren
suffix:semicolon
)brace
id|sclp_vt220_flush_later
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request
op_ne
l_int|NULL
)paren
id|sclp_vt220_emit
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
DECL|macro|SCLP_NORMAL_WRITE
mdefine_line|#define SCLP_NORMAL_WRITE&t;0x00
multiline_comment|/*&n; * Helper function to initialize a page with the sclp request structure.&n; */
r_static
r_struct
id|sclp_vt220_request
op_star
DECL|function|sclp_vt220_initialize_page
id|sclp_vt220_initialize_page
c_func
(paren
r_void
op_star
id|page
)paren
(brace
r_struct
id|sclp_vt220_request
op_star
id|request
suffix:semicolon
r_struct
id|sclp_vt220_sccb
op_star
id|sccb
suffix:semicolon
multiline_comment|/* Place request structure at end of page */
id|request
op_assign
(paren
(paren
r_struct
id|sclp_vt220_request
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|page
op_plus
id|PAGE_SIZE
)paren
)paren
op_minus
l_int|1
suffix:semicolon
id|request-&gt;retry_count
op_assign
l_int|0
suffix:semicolon
id|request-&gt;sclp_req.sccb
op_assign
id|page
suffix:semicolon
multiline_comment|/* SCCB goes at start of page */
id|sccb
op_assign
(paren
r_struct
id|sclp_vt220_sccb
op_star
)paren
id|page
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|sccb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sclp_vt220_sccb
)paren
)paren
suffix:semicolon
id|sccb-&gt;header.length
op_assign
r_sizeof
(paren
r_struct
id|sclp_vt220_sccb
)paren
suffix:semicolon
id|sccb-&gt;header.function_code
op_assign
id|SCLP_NORMAL_WRITE
suffix:semicolon
id|sccb-&gt;header.response_code
op_assign
l_int|0x0000
suffix:semicolon
id|sccb-&gt;evbuf.type
op_assign
id|EvTyp_VT220Msg
suffix:semicolon
id|sccb-&gt;evbuf.length
op_assign
r_sizeof
(paren
r_struct
id|evbuf_header
)paren
suffix:semicolon
r_return
id|request
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|sclp_vt220_space_left
id|sclp_vt220_space_left
c_func
(paren
r_struct
id|sclp_vt220_request
op_star
id|request
)paren
(brace
r_struct
id|sclp_vt220_sccb
op_star
id|sccb
suffix:semicolon
id|sccb
op_assign
(paren
r_struct
id|sclp_vt220_sccb
op_star
)paren
id|request-&gt;sclp_req.sccb
suffix:semicolon
r_return
id|PAGE_SIZE
op_minus
r_sizeof
(paren
r_struct
id|sclp_vt220_request
)paren
op_minus
id|sccb-&gt;header.length
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|sclp_vt220_chars_stored
id|sclp_vt220_chars_stored
c_func
(paren
r_struct
id|sclp_vt220_request
op_star
id|request
)paren
(brace
r_struct
id|sclp_vt220_sccb
op_star
id|sccb
suffix:semicolon
id|sccb
op_assign
(paren
r_struct
id|sclp_vt220_sccb
op_star
)paren
id|request-&gt;sclp_req.sccb
suffix:semicolon
r_return
id|sccb-&gt;evbuf.length
op_minus
r_sizeof
(paren
r_struct
id|evbuf_header
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Add msg to buffer associated with request. Return the number of characters&n; * added.&n; */
r_static
r_int
DECL|function|sclp_vt220_add_msg
id|sclp_vt220_add_msg
c_func
(paren
r_struct
id|sclp_vt220_request
op_star
id|request
comma
r_const
r_int
r_char
op_star
id|msg
comma
r_int
id|count
comma
r_int
id|convertlf
)paren
(brace
r_struct
id|sclp_vt220_sccb
op_star
id|sccb
suffix:semicolon
r_void
op_star
id|buffer
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_int
id|from
suffix:semicolon
r_int
id|to
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|sclp_vt220_space_left
c_func
(paren
id|request
)paren
)paren
id|count
op_assign
id|sclp_vt220_space_left
c_func
(paren
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|sccb
op_assign
(paren
r_struct
id|sclp_vt220_sccb
op_star
)paren
id|request-&gt;sclp_req.sccb
suffix:semicolon
id|buffer
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|sccb
op_plus
id|sccb-&gt;header.length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|convertlf
)paren
(brace
multiline_comment|/* Perform Linefeed conversion (0x0a -&gt; 0x0a 0x0d)*/
r_for
c_loop
(paren
id|from
op_assign
l_int|0
comma
id|to
op_assign
l_int|0
suffix:semicolon
(paren
id|from
OL
id|count
)paren
op_logical_and
(paren
id|to
OL
id|sclp_vt220_space_left
c_func
(paren
id|request
)paren
)paren
suffix:semicolon
id|from
op_increment
)paren
(brace
multiline_comment|/* Retrieve character */
id|c
op_assign
id|msg
(braket
id|from
)braket
suffix:semicolon
multiline_comment|/* Perform conversion */
r_if
c_cond
(paren
id|c
op_eq
l_int|0x0a
)paren
(brace
r_if
c_cond
(paren
id|to
op_plus
l_int|1
OL
id|sclp_vt220_space_left
c_func
(paren
id|request
)paren
)paren
(brace
(paren
(paren
r_int
r_char
op_star
)paren
id|buffer
)paren
(braket
id|to
op_increment
)braket
op_assign
id|c
suffix:semicolon
(paren
(paren
r_int
r_char
op_star
)paren
id|buffer
)paren
(braket
id|to
op_increment
)braket
op_assign
l_int|0x0d
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
)brace
r_else
(paren
(paren
r_int
r_char
op_star
)paren
id|buffer
)paren
(braket
id|to
op_increment
)braket
op_assign
id|c
suffix:semicolon
)brace
id|sccb-&gt;header.length
op_add_assign
id|to
suffix:semicolon
id|sccb-&gt;evbuf.length
op_add_assign
id|to
suffix:semicolon
r_return
id|from
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|buffer
comma
(paren
r_const
r_void
op_star
)paren
id|msg
comma
id|count
)paren
suffix:semicolon
id|sccb-&gt;header.length
op_add_assign
id|count
suffix:semicolon
id|sccb-&gt;evbuf.length
op_add_assign
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Emit buffer after having waited long enough for more data to arrive.&n; */
r_static
r_void
DECL|function|sclp_vt220_timeout
id|sclp_vt220_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|sclp_vt220_emit_current
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|macro|BUFFER_MAX_DELAY
mdefine_line|#define BUFFER_MAX_DELAY&t;HZ/2
multiline_comment|/* &n; * Internal implementation of the write function. Write COUNT bytes of data&n; * from memory at BUF&n; * to the SCLP interface. In case that the data does not fit into the current&n; * write buffer, emit the current one and allocate a new one. If there are no&n; * more empty buffers available, wait until one gets emptied. If DO_SCHEDULE&n; * is non-zero, the buffer will be scheduled for emitting after a timeout -&n; * otherwise the user has to explicitly call the flush function.&n; * A non-zero CONVERTLF parameter indicates that 0x0a characters in the message&n; * buffer should be converted to 0x0a 0x0d. After completion, return the number&n; * of bytes written.&n; */
r_static
r_int
DECL|function|__sclp_vt220_write
id|__sclp_vt220_write
c_func
(paren
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|do_schedule
comma
r_int
id|convertlf
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_void
op_star
id|page
suffix:semicolon
r_int
id|written
suffix:semicolon
r_int
id|overall_written
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|overall_written
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* Create a sclp output buffer if none exists yet */
r_if
c_cond
(paren
id|sclp_vt220_current_request
op_eq
l_int|NULL
)paren
(brace
r_while
c_loop
(paren
id|list_empty
c_func
(paren
op_amp
id|sclp_vt220_empty
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
id|sclp_sync_wait
c_func
(paren
)paren
suffix:semicolon
r_else
id|wait_event
c_func
(paren
id|sclp_vt220_waitq
comma
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|sclp_vt220_empty
)paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|page
op_assign
(paren
r_void
op_star
)paren
id|sclp_vt220_empty.next
suffix:semicolon
id|list_del
c_func
(paren
(paren
r_struct
id|list_head
op_star
)paren
id|page
)paren
suffix:semicolon
id|sclp_vt220_current_request
op_assign
id|sclp_vt220_initialize_page
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
multiline_comment|/* Try to write the string to the current request buffer */
id|written
op_assign
id|sclp_vt220_add_msg
c_func
(paren
id|sclp_vt220_current_request
comma
id|buf
comma
id|count
comma
id|convertlf
)paren
suffix:semicolon
id|overall_written
op_add_assign
id|written
suffix:semicolon
r_if
c_cond
(paren
id|written
op_eq
id|count
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Not all characters could be written to the current&n;&t;&t; * output buffer. Emit the buffer, create a new buffer&n;&t;&t; * and then output the rest of the string.&n;&t;&t; */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
id|sclp_vt220_emit_current
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
id|buf
op_add_assign
id|written
suffix:semicolon
id|count
op_sub_assign
id|written
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Setup timer to output current console buffer after some time */
r_if
c_cond
(paren
id|sclp_vt220_current_request
op_ne
l_int|NULL
op_logical_and
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|sclp_vt220_timer
)paren
op_logical_and
id|do_schedule
)paren
(brace
id|sclp_vt220_timer.function
op_assign
id|sclp_vt220_timeout
suffix:semicolon
id|sclp_vt220_timer.data
op_assign
l_int|0UL
suffix:semicolon
id|sclp_vt220_timer.expires
op_assign
id|jiffies
op_plus
id|BUFFER_MAX_DELAY
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sclp_vt220_timer
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|overall_written
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called by the kernel to write a series of&n; * characters to the tty device.  The characters may come from&n; * user space or kernel space.  This routine will return the&n; * number of characters actually accepted for writing.&n; */
r_static
r_int
DECL|function|sclp_vt220_write
id|sclp_vt220_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_return
id|__sclp_vt220_write
c_func
(paren
id|buf
comma
id|count
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|macro|SCLP_VT220_SESSION_ENDED
mdefine_line|#define SCLP_VT220_SESSION_ENDED&t;0x01
DECL|macro|SCLP_VT220_SESSION_STARTED
mdefine_line|#define&t;SCLP_VT220_SESSION_STARTED&t;0x80
DECL|macro|SCLP_VT220_SESSION_DATA
mdefine_line|#define SCLP_VT220_SESSION_DATA&t;&t;0x00
multiline_comment|/*&n; * Called by the SCLP to report incoming event buffers.&n; */
r_static
r_void
DECL|function|sclp_vt220_receiver_fn
id|sclp_vt220_receiver_fn
c_func
(paren
r_struct
id|evbuf_header
op_star
id|evbuf
)paren
(brace
r_char
op_star
id|buffer
suffix:semicolon
r_int
r_int
id|count
suffix:semicolon
multiline_comment|/* Ignore input if device is not open */
r_if
c_cond
(paren
id|sclp_vt220_tty
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|buffer
op_assign
(paren
r_char
op_star
)paren
(paren
(paren
id|addr_t
)paren
id|evbuf
op_plus
r_sizeof
(paren
r_struct
id|evbuf_header
)paren
)paren
suffix:semicolon
id|count
op_assign
id|evbuf-&gt;length
op_minus
r_sizeof
(paren
r_struct
id|evbuf_header
)paren
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|buffer
)paren
(brace
r_case
id|SCLP_VT220_SESSION_ENDED
suffix:colon
r_case
id|SCLP_VT220_SESSION_STARTED
suffix:colon
r_break
suffix:semicolon
r_case
id|SCLP_VT220_SESSION_DATA
suffix:colon
multiline_comment|/* Send input to line discipline */
id|buffer
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
multiline_comment|/* Prevent buffer overrun by discarding input. Note that&n;&t;&t; * because buffer_push works asynchronously, we cannot wait&n;&t;&t; * for the buffer to be emptied. */
r_if
c_cond
(paren
id|count
op_plus
id|sclp_vt220_tty-&gt;flip.count
OG
id|TTY_FLIPBUF_SIZE
)paren
id|count
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|sclp_vt220_tty-&gt;flip.count
suffix:semicolon
id|memcpy
c_func
(paren
id|sclp_vt220_tty-&gt;flip.char_buf_ptr
comma
id|buffer
comma
id|count
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sclp_vt220_tty-&gt;flip.flag_buf_ptr
comma
id|TTY_NORMAL
comma
id|count
)paren
suffix:semicolon
id|sclp_vt220_tty-&gt;flip.char_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|sclp_vt220_tty-&gt;flip.flag_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|sclp_vt220_tty-&gt;flip.count
op_add_assign
id|count
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|sclp_vt220_tty
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This routine is called when a particular tty device is opened.&n; */
r_static
r_int
DECL|function|sclp_vt220_open
id|sclp_vt220_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
(brace
id|sclp_vt220_tty
op_assign
id|tty
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|kmalloc
c_func
(paren
id|SCLP_VT220_BUF_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver_data
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|tty-&gt;low_latency
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called when a particular tty device is closed.&n; */
r_static
r_void
DECL|function|sclp_vt220_close
id|sclp_vt220_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
(brace
id|sclp_vt220_tty
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|tty-&gt;driver_data
)paren
suffix:semicolon
id|tty-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This routine is called by the kernel to write a single&n; * character to the tty device.  If the kernel uses this routine,&n; * it must call the flush_chars() routine (if defined) when it is&n; * done stuffing characters into the driver.&n; *&n; * NOTE: include/linux/tty_driver.h specifies that a character should be&n; * ignored if there is no room in the queue. This driver implements a different&n; * semantic in that it will block when there is no more room left.&n; */
r_static
r_void
DECL|function|sclp_vt220_put_char
id|sclp_vt220_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
id|__sclp_vt220_write
c_func
(paren
op_amp
id|ch
comma
l_int|1
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called by the kernel after it has written a&n; * series of characters to the tty device using put_char().  &n; */
r_static
r_void
DECL|function|sclp_vt220_flush_chars
id|sclp_vt220_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_if
c_cond
(paren
id|sclp_vt220_outqueue_count
op_eq
l_int|0
)paren
id|sclp_vt220_emit_current
c_func
(paren
)paren
suffix:semicolon
r_else
id|sclp_vt220_flush_later
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine returns the numbers of characters the tty driver&n; * will accept for queuing to be written.  This number is subject&n; * to change as output buffers get emptied, or if the output flow&n; * control is acted.&n; */
r_static
r_int
DECL|function|sclp_vt220_write_room
id|sclp_vt220_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
id|count
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sclp_vt220_current_request
op_ne
l_int|NULL
)paren
id|count
op_assign
id|sclp_vt220_space_left
c_func
(paren
id|sclp_vt220_current_request
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|sclp_vt220_empty
)paren
id|count
op_add_assign
id|SCLP_VT220_MAX_CHARS_PER_BUFFER
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; * Return number of buffered chars.&n; */
r_static
r_int
DECL|function|sclp_vt220_chars_in_buffer
id|sclp_vt220_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|sclp_vt220_request
op_star
id|r
suffix:semicolon
r_int
id|count
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sclp_vt220_current_request
op_ne
l_int|NULL
)paren
id|count
op_assign
id|sclp_vt220_chars_stored
c_func
(paren
id|sclp_vt220_current_request
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|sclp_vt220_outqueue
)paren
(brace
id|r
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|sclp_vt220_request
comma
id|list
)paren
suffix:semicolon
id|count
op_add_assign
id|sclp_vt220_chars_stored
c_func
(paren
id|r
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
r_void
DECL|function|__sclp_vt220_flush_buffer
id|__sclp_vt220_flush_buffer
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|sclp_vt220_emit_current
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|sclp_vt220_timer
)paren
)paren
id|del_timer
c_func
(paren
op_amp
id|sclp_vt220_timer
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sclp_vt220_outqueue_count
OG
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
id|sclp_sync_wait
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sclp_vt220_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Pass on all buffers to the hardware. Return only when there are no more&n; * buffers pending.&n; */
r_static
r_void
DECL|function|sclp_vt220_flush_buffer
id|sclp_vt220_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|sclp_vt220_emit_current
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize all relevant components and register driver with system.&n; */
r_static
r_int
DECL|function|__sclp_vt220_init
id|__sclp_vt220_init
c_func
(paren
r_int
id|early
)paren
(brace
r_void
op_star
id|page
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|sclp_vt220_initialized
)paren
r_return
l_int|0
suffix:semicolon
id|sclp_vt220_initialized
op_assign
l_int|1
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|sclp_vt220_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sclp_vt220_empty
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sclp_vt220_outqueue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sclp_vt220_waitq
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|sclp_vt220_timer
)paren
suffix:semicolon
id|sclp_vt220_current_request
op_assign
l_int|NULL
suffix:semicolon
id|sclp_vt220_buffered_chars
op_assign
l_int|0
suffix:semicolon
id|sclp_vt220_outqueue_count
op_assign
l_int|0
suffix:semicolon
id|sclp_vt220_tty
op_assign
l_int|NULL
suffix:semicolon
id|sclp_vt220_flush_later
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Allocate pages for output buffering */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|early
ques
c_cond
id|MAX_CONSOLE_PAGES
suffix:colon
id|MAX_KMEM_PAGES
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|early
)paren
id|page
op_assign
id|alloc_bootmem_low_pages
c_func
(paren
id|PAGE_SIZE
)paren
suffix:semicolon
r_else
id|page
op_assign
(paren
r_void
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|list_add_tail
c_func
(paren
(paren
r_struct
id|list_head
op_star
)paren
id|page
comma
op_amp
id|sclp_vt220_empty
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sclp_vt220_ops
r_static
r_struct
id|tty_operations
id|sclp_vt220_ops
op_assign
(brace
dot
id|open
op_assign
id|sclp_vt220_open
comma
dot
id|close
op_assign
id|sclp_vt220_close
comma
dot
id|write
op_assign
id|sclp_vt220_write
comma
dot
id|put_char
op_assign
id|sclp_vt220_put_char
comma
dot
id|flush_chars
op_assign
id|sclp_vt220_flush_chars
comma
dot
id|write_room
op_assign
id|sclp_vt220_write_room
comma
dot
id|chars_in_buffer
op_assign
id|sclp_vt220_chars_in_buffer
comma
dot
id|flush_buffer
op_assign
id|sclp_vt220_flush_buffer
)brace
suffix:semicolon
multiline_comment|/*&n; * Register driver with SCLP and Linux and initialize internal tty structures.&n; */
r_int
id|__init
DECL|function|sclp_vt220_tty_init
id|sclp_vt220_tty_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty_driver
op_star
id|driver
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Note: we&squot;re not testing for CONSOLE_IS_SCLP here to preserve&n;&t; * symmetry between VM and LPAR systems regarding ttyS1. */
id|driver
op_assign
id|alloc_tty_driver
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|rc
op_assign
id|__sclp_vt220_init
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|put_tty_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|sclp_register
c_func
(paren
op_amp
id|sclp_vt220_register
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|SCLP_VT220_PRINT_HEADER
l_string|&quot;could not register tty - &quot;
l_string|&quot;sclp_register returned %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|driver-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|driver-&gt;driver_name
op_assign
id|SCLP_VT220_DRIVER_NAME
suffix:semicolon
id|driver-&gt;name
op_assign
id|SCLP_VT220_DEVICE_NAME
suffix:semicolon
id|driver-&gt;major
op_assign
id|SCLP_VT220_MAJOR
suffix:semicolon
id|driver-&gt;minor_start
op_assign
id|SCLP_VT220_MINOR
suffix:semicolon
id|driver-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SYSTEM
suffix:semicolon
id|driver-&gt;subtype
op_assign
id|SYSTEM_TYPE_TTY
suffix:semicolon
id|driver-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|driver-&gt;flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|tty_set_operations
c_func
(paren
id|driver
comma
op_amp
id|sclp_vt220_ops
)paren
suffix:semicolon
id|rc
op_assign
id|tty_register_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|SCLP_VT220_PRINT_HEADER
l_string|&quot;could not register tty - &quot;
l_string|&quot;tty_register_driver returned %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|sclp_vt220_driver
op_assign
id|driver
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sclp_vt220_tty_init
id|module_init
c_func
(paren
id|sclp_vt220_tty_init
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SCLP_VT220_CONSOLE
r_static
r_void
DECL|function|sclp_vt220_con_write
id|sclp_vt220_con_write
c_func
(paren
r_struct
id|console
op_star
id|con
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
id|__sclp_vt220_write
c_func
(paren
(paren
r_const
r_int
r_char
op_star
)paren
id|buf
comma
id|count
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_struct
id|tty_driver
op_star
DECL|function|sclp_vt220_con_device
id|sclp_vt220_con_device
c_func
(paren
r_struct
id|console
op_star
id|c
comma
r_int
op_star
id|index
)paren
(brace
op_star
id|index
op_assign
l_int|0
suffix:semicolon
r_return
id|sclp_vt220_driver
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called from panic when the kernel is going to give up.&n; * We have to make sure that all buffers will be flushed to the SCLP.&n; * Note that this function may be called from within an interrupt context.&n; */
r_static
r_void
DECL|function|sclp_vt220_con_unblank
id|sclp_vt220_con_unblank
c_func
(paren
r_void
)paren
(brace
id|__sclp_vt220_flush_buffer
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Structure needed to register with printk */
DECL|variable|sclp_vt220_console
r_static
r_struct
id|console
id|sclp_vt220_console
op_assign
(brace
dot
id|name
op_assign
id|SCLP_VT220_CONSOLE_NAME
comma
dot
id|write
op_assign
id|sclp_vt220_con_write
comma
dot
id|device
op_assign
id|sclp_vt220_con_device
comma
dot
id|unblank
op_assign
id|sclp_vt220_con_unblank
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
id|SCLP_VT220_CONSOLE_INDEX
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|sclp_vt220_con_init
id|sclp_vt220_con_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|CONSOLE_IS_SCLP
)paren
r_return
l_int|0
suffix:semicolon
id|rc
op_assign
id|__sclp_vt220_init
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Attach linux console */
id|register_console
c_func
(paren
op_amp
id|sclp_vt220_console
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sclp_vt220_con_init
id|console_initcall
c_func
(paren
id|sclp_vt220_con_init
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SCLP_VT220_CONSOLE */
eof
