multiline_comment|/*&n; *  drivers/s390/char/tape_core.c&n; *    basic function of the tape device driver&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001,2002 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *&t;&t; Michael Holzheu &lt;holzheu@de.ibm.com&gt;&n; *&t;&t; Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&t;&t; Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;&t;     
singleline_comment|// for kernel parameters
macro_line|#include &lt;linux/kmod.h&gt;&t;     
singleline_comment|// for requesting modules
macro_line|#include &lt;linux/spinlock.h&gt;  
singleline_comment|// for locks
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/types.h&gt;&t;     
singleline_comment|// for variable types
macro_line|#include &quot;tape.h&quot;
macro_line|#include &quot;tape_std.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;T390:&quot;
r_static
r_void
id|tape_do_irq
(paren
r_struct
id|ccw_device
op_star
comma
r_int
r_int
comma
r_struct
id|irb
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * One list to contain all tape devices of all disciplines, so&n; * we can assign the devices to minor numbers of the same major&n; * The list is protected by the rwlock&n; */
DECL|variable|tape_device_list
r_static
r_struct
id|list_head
id|tape_device_list
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|tape_device_list
)paren
suffix:semicolon
DECL|variable|tape_device_lock
r_static
id|rwlock_t
id|tape_device_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * Wait queue for tape_delete_device waits.&n; */
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|tape_delete_wq
)paren
suffix:semicolon
multiline_comment|/*&n; * Pointer to debug area.&n; */
DECL|variable|tape_dbf_area
id|debug_info_t
op_star
id|tape_dbf_area
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; * Printable strings for tape enumerations.&n; */
DECL|variable|tape_state_verbose
r_const
r_char
op_star
id|tape_state_verbose
(braket
id|TS_SIZE
)braket
op_assign
(brace
(braket
id|TS_UNUSED
)braket
op_assign
l_string|&quot;UNUSED&quot;
comma
(braket
id|TS_IN_USE
)braket
op_assign
l_string|&quot;IN_USE&quot;
comma
(braket
id|TS_INIT
)braket
op_assign
l_string|&quot;INIT  &quot;
comma
(braket
id|TS_NOT_OPER
)braket
op_assign
l_string|&quot;NOT_OP&quot;
)brace
suffix:semicolon
DECL|variable|tape_op_verbose
r_const
r_char
op_star
id|tape_op_verbose
(braket
id|TO_SIZE
)braket
op_assign
(brace
(braket
id|TO_BLOCK
)braket
op_assign
l_string|&quot;BLK&quot;
comma
(braket
id|TO_BSB
)braket
op_assign
l_string|&quot;BSB&quot;
comma
(braket
id|TO_BSF
)braket
op_assign
l_string|&quot;BSF&quot;
comma
(braket
id|TO_DSE
)braket
op_assign
l_string|&quot;DSE&quot;
comma
(braket
id|TO_FSB
)braket
op_assign
l_string|&quot;FSB&quot;
comma
(braket
id|TO_FSF
)braket
op_assign
l_string|&quot;FSF&quot;
comma
(braket
id|TO_LBL
)braket
op_assign
l_string|&quot;LBL&quot;
comma
(braket
id|TO_NOP
)braket
op_assign
l_string|&quot;NOP&quot;
comma
(braket
id|TO_RBA
)braket
op_assign
l_string|&quot;RBA&quot;
comma
(braket
id|TO_RBI
)braket
op_assign
l_string|&quot;RBI&quot;
comma
(braket
id|TO_RFO
)braket
op_assign
l_string|&quot;RFO&quot;
comma
(braket
id|TO_REW
)braket
op_assign
l_string|&quot;REW&quot;
comma
(braket
id|TO_RUN
)braket
op_assign
l_string|&quot;RUN&quot;
comma
(braket
id|TO_WRI
)braket
op_assign
l_string|&quot;WRI&quot;
comma
(braket
id|TO_WTM
)braket
op_assign
l_string|&quot;WTM&quot;
comma
(braket
id|TO_MSEN
)braket
op_assign
l_string|&quot;MSN&quot;
comma
(braket
id|TO_LOAD
)braket
op_assign
l_string|&quot;LOA&quot;
comma
(braket
id|TO_READ_CONFIG
)braket
op_assign
l_string|&quot;RCF&quot;
comma
(braket
id|TO_READ_ATTMSG
)braket
op_assign
l_string|&quot;RAT&quot;
comma
(braket
id|TO_DIS
)braket
op_assign
l_string|&quot;DIS&quot;
comma
(braket
id|TO_ASSIGN
)braket
op_assign
l_string|&quot;ASS&quot;
comma
(braket
id|TO_UNASSIGN
)braket
op_assign
l_string|&quot;UAS&quot;
)brace
suffix:semicolon
multiline_comment|/*&n; * Tape state functions&n; */
r_static
r_void
DECL|function|tape_state_set
id|tape_state_set
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_enum
id|tape_state
id|newstate
)paren
(brace
r_const
r_char
op_star
id|str
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
op_eq
id|TS_NOT_OPER
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;ts_set err: not oper&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|DBF_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;ts. dev:&t;%x&bslash;n&quot;
comma
id|device-&gt;first_minor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
OL
id|TO_SIZE
op_logical_and
id|device-&gt;tape_state
op_ge
l_int|0
)paren
id|str
op_assign
id|tape_state_verbose
(braket
id|device-&gt;tape_state
)braket
suffix:semicolon
r_else
id|str
op_assign
l_string|&quot;UNKNOWN TS&quot;
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;old ts:&t;%s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
OL
id|TO_SIZE
op_logical_and
id|device-&gt;tape_state
op_ge
l_int|0
)paren
id|str
op_assign
id|tape_state_verbose
(braket
id|device-&gt;tape_state
)braket
suffix:semicolon
r_else
id|str
op_assign
l_string|&quot;UNKNOWN TS&quot;
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;new ts:&bslash;t&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newstate
OL
id|TO_SIZE
op_logical_and
id|newstate
op_ge
l_int|0
)paren
id|str
op_assign
id|tape_state_verbose
(braket
id|newstate
)braket
suffix:semicolon
r_else
id|str
op_assign
l_string|&quot;UNKNOWN TS&quot;
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
id|device-&gt;tape_state
op_assign
id|newstate
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|device-&gt;state_change_wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape_med_state_set
id|tape_med_state_set
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_enum
id|tape_medium_state
id|newstate
)paren
(brace
r_if
c_cond
(paren
id|device-&gt;medium_state
op_eq
id|newstate
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|newstate
)paren
(brace
r_case
id|MS_UNLOADED
suffix:colon
id|device-&gt;tape_generic_status
op_or_assign
id|GMT_DR_OPEN
c_func
(paren
op_complement
l_int|0
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;(%s): Tape is unloaded&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MS_LOADED
suffix:colon
id|device-&gt;tape_generic_status
op_and_assign
op_complement
id|GMT_DR_OPEN
c_func
(paren
op_complement
l_int|0
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;(%s): Tape has been mounted&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
singleline_comment|// print nothing
r_break
suffix:semicolon
)brace
id|device-&gt;medium_state
op_assign
id|newstate
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|device-&gt;state_change_wq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Stop running ccw. Has to be called with the device lock held.&n; */
r_static
r_inline
r_int
DECL|function|__tape_halt_io
id|__tape_halt_io
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
)paren
(brace
r_int
id|retries
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Check if interrupt has already been processed */
r_if
c_cond
(paren
id|request-&gt;callback
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|retries
op_assign
l_int|0
suffix:semicolon
id|retries
OL
l_int|5
suffix:semicolon
id|retries
op_increment
)paren
(brace
r_if
c_cond
(paren
id|retries
OL
l_int|2
)paren
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
id|device-&gt;cdev
comma
(paren
r_int
)paren
id|request
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|ccw_device_clear
c_func
(paren
id|device-&gt;cdev
comma
(paren
r_int
)paren
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* termination successful */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
id|DBF_EXCEPTION
c_func
(paren
l_int|2
comma
l_string|&quot;device gone, retry&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EIO
)paren
id|DBF_EXCEPTION
c_func
(paren
l_int|2
comma
l_string|&quot;I/O error, retry&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EBUSY
)paren
id|DBF_EXCEPTION
c_func
(paren
l_int|2
comma
l_string|&quot;device busy, retry late&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|request-&gt;status
op_assign
id|TAPE_REQUEST_DONE
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Add device into the sorted list, giving it the first&n; * available minor number.&n; */
r_static
r_int
DECL|function|tape_assign_minor
id|tape_assign_minor
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_struct
id|tape_device
op_star
id|tmp
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|minor
op_assign
l_int|0
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|tape_device_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp
comma
op_amp
id|tape_device_list
comma
id|node
)paren
(brace
r_if
c_cond
(paren
id|minor
OL
id|tmp-&gt;first_minor
)paren
r_break
suffix:semicolon
id|minor
op_add_assign
id|TAPE_MINORS_PER_DEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|minor
op_ge
(paren
l_int|1
op_lshift
id|KDEV_MINOR_BITS
)paren
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|tape_device_lock
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|device-&gt;first_minor
op_assign
id|minor
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|device-&gt;node
comma
op_amp
id|tmp-&gt;node
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|tape_device_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* remove device from the list */
r_static
r_void
DECL|function|tape_remove_minor
id|tape_remove_minor
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
id|write_lock
c_func
(paren
op_amp
id|tape_device_lock
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|device-&gt;node
)paren
suffix:semicolon
id|device-&gt;first_minor
op_assign
op_minus
l_int|1
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|tape_device_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Enable tape device&n; */
r_int
DECL|function|tape_enable_device
id|tape_enable_device
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_discipline
op_star
id|discipline
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
op_ne
id|TS_INIT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Let the discipline have a go at the device. */
id|device-&gt;discipline
op_assign
id|discipline
suffix:semicolon
id|rc
op_assign
id|discipline
op_member_access_from_pointer
id|setup_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
id|tape_assign_minor
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out_discipline
suffix:semicolon
id|rc
op_assign
id|tapechar_setup_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out_minor
suffix:semicolon
id|rc
op_assign
id|tapeblock_setup_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out_char
suffix:semicolon
id|tape_state_set
c_func
(paren
id|device
comma
id|TS_UNUSED
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_char
suffix:colon
id|tapechar_cleanup_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|out_discipline
suffix:colon
id|device-&gt;discipline
op_member_access_from_pointer
id|cleanup_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|device-&gt;discipline
op_assign
l_int|NULL
suffix:semicolon
id|out_minor
suffix:colon
id|tape_remove_minor
c_func
(paren
id|device
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Disable tape device. Check if there is a running request and&n; * terminate it. Post all queued requests with -EIO.&n; */
r_void
DECL|function|tape_disable_device
id|tape_disable_device
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
id|tape_state_set
c_func
(paren
id|device
comma
id|TS_NOT_OPER
)paren
suffix:semicolon
multiline_comment|/* Post remaining requests with -EIO */
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|device-&gt;req_queue
)paren
(brace
id|request
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|tape_request
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;status
op_eq
id|TAPE_REQUEST_IN_IO
)paren
id|__tape_halt_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|request-&gt;list
)paren
suffix:semicolon
multiline_comment|/* Decrease ref_count for removed request. */
id|tape_put_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|request-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;callback
op_ne
l_int|NULL
)paren
id|request
op_member_access_from_pointer
id|callback
c_func
(paren
id|request
comma
id|request-&gt;callback_data
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
id|tapeblock_cleanup_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|tapechar_cleanup_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|device-&gt;discipline
op_member_access_from_pointer
id|cleanup_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|tape_remove_minor
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate memory for a new device structure.&n; */
r_static
r_struct
id|tape_device
op_star
DECL|function|tape_alloc_device
id|tape_alloc_device
c_func
(paren
r_void
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
id|device
op_assign
(paren
r_struct
id|tape_device
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|tape_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|2
comma
l_string|&quot;ti:no mem&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_INFO
(paren
l_string|&quot;can&squot;t allocate memory for &quot;
l_string|&quot;tape info structure&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|device
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tape_device
)paren
)paren
suffix:semicolon
id|device-&gt;modeset_byte
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
l_int|1
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;modeset_byte
op_eq
l_int|NULL
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|2
comma
l_string|&quot;ti:no mem&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;can&squot;t allocate memory for modeset byte&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|device
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|device-&gt;req_queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|device-&gt;node
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|device-&gt;state_change_wq
)paren
suffix:semicolon
id|device-&gt;tape_state
op_assign
id|TS_INIT
suffix:semicolon
id|device-&gt;medium_state
op_assign
id|MS_UNKNOWN
suffix:semicolon
op_star
id|device-&gt;modeset_byte
op_assign
l_int|0
suffix:semicolon
r_return
id|device
suffix:semicolon
)brace
multiline_comment|/*&n; * Free memory of a device structure.&n; */
r_static
r_void
DECL|function|tape_free_device
id|tape_free_device
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
id|kfree
c_func
(paren
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Find tape device by a device index.&n; */
r_struct
id|tape_device
op_star
DECL|function|tape_get_device
id|tape_get_device
c_func
(paren
r_int
id|devindex
)paren
(brace
r_struct
id|tape_device
op_star
id|device
comma
op_star
id|tmp
suffix:semicolon
id|device
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tape_device_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp
comma
op_amp
id|tape_device_list
comma
id|node
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;first_minor
op_star
id|TAPE_MINORS_PER_DEV
op_eq
id|devindex
)paren
(brace
id|device
op_assign
id|tmp
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|device-&gt;ref_count
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|tape_device_lock
)paren
suffix:semicolon
r_return
id|device
suffix:semicolon
)brace
multiline_comment|/*&n; * Decrease the reference counter of a devices structure. If the&n; * reference counter reaches zero free the device structure and&n; * wake up sleepers.&n; */
r_void
DECL|function|tape_put_device
id|tape_put_device
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_return
c_func
(paren
op_amp
id|device-&gt;ref_count
)paren
OG
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Reference counter dropped to zero. This means&n;&t; * that the device is deleted and the last user&n;&t; * of the device structure is gone. That is what&n;&t; * tape_delete_device is waiting for. Do a wake up.&n;&t; */
id|wake_up
c_func
(paren
op_amp
id|tape_delete_wq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Driverfs tape probe function.&n; */
r_int
DECL|function|tape_generic_probe
id|tape_generic_probe
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
r_char
op_star
id|bus_id
op_assign
id|cdev-&gt;dev.bus_id
suffix:semicolon
id|device
op_assign
id|tape_alloc_device
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|device
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;tape device %s found&bslash;n&quot;
comma
id|bus_id
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|device-&gt;ref_count
)paren
suffix:semicolon
id|cdev-&gt;dev.driver_data
op_assign
id|device
suffix:semicolon
id|device-&gt;cdev
op_assign
id|cdev
suffix:semicolon
id|cdev-&gt;handler
op_assign
id|tape_do_irq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Driverfs tape remove function.&n; */
r_int
DECL|function|tape_generic_remove
id|tape_generic_remove
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
id|device
op_assign
id|cdev-&gt;dev.driver_data
suffix:semicolon
id|cdev-&gt;dev.driver_data
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|device
op_ne
l_int|NULL
)paren
(brace
id|tape_put_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|tape_delete_wq
comma
id|atomic_read
c_func
(paren
op_amp
id|device-&gt;ref_count
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|tape_free_device
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new tape ccw request&n; */
r_struct
id|tape_request
op_star
DECL|function|tape_alloc_request
id|tape_alloc_request
c_func
(paren
r_int
id|cplength
comma
r_int
id|datasize
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_if
c_cond
(paren
id|datasize
OG
id|PAGE_SIZE
op_logical_or
(paren
id|cplength
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
OG
id|PAGE_SIZE
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|request
op_assign
(paren
r_struct
id|tape_request
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|tape_request
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request
op_eq
l_int|NULL
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|1
comma
l_string|&quot;cqra nomem&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|request
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tape_request
)paren
)paren
suffix:semicolon
multiline_comment|/* allocate channel program */
r_if
c_cond
(paren
id|cplength
OG
l_int|0
)paren
(brace
id|request-&gt;cpaddr
op_assign
id|kmalloc
c_func
(paren
id|cplength
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
comma
id|GFP_ATOMIC
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;cpaddr
op_eq
l_int|NULL
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|1
comma
l_string|&quot;cqra nomem&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|request-&gt;cpaddr
comma
l_int|0
comma
id|cplength
op_star
r_sizeof
(paren
r_struct
id|ccw1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* alloc small kernel buffer */
r_if
c_cond
(paren
id|datasize
OG
l_int|0
)paren
(brace
id|request-&gt;cpdata
op_assign
id|kmalloc
c_func
(paren
id|datasize
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;cpdata
op_eq
l_int|NULL
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|1
comma
l_string|&quot;cqra nomem&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;cpaddr
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|request-&gt;cpaddr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|request-&gt;cpdata
comma
l_int|0
comma
id|datasize
)paren
suffix:semicolon
)brace
r_return
id|request
suffix:semicolon
)brace
multiline_comment|/*&n; * Free tape ccw request&n; */
r_void
DECL|function|tape_free_request
id|tape_free_request
(paren
r_struct
id|tape_request
op_star
id|request
)paren
(brace
r_if
c_cond
(paren
id|request-&gt;device
op_ne
l_int|NULL
)paren
(brace
id|tape_put_device
c_func
(paren
id|request-&gt;device
)paren
suffix:semicolon
id|request-&gt;device
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request-&gt;cpdata
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|request-&gt;cpdata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;cpaddr
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|request-&gt;cpaddr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Write sense data to console/dbf&n; */
r_void
DECL|function|tape_dump_sense
id|tape_dump_sense
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_int
r_int
op_star
id|sptr
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;-------------------------------------------------&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;DSTAT : %02x  CSTAT: %02x&t;CPA: %04x&bslash;n&quot;
comma
id|irb-&gt;scsw.dstat
comma
id|irb-&gt;scsw.cstat
comma
id|irb-&gt;scsw.cpa
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;DEVICE: %s&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request
op_ne
l_int|NULL
)paren
id|PRINT_INFO
c_func
(paren
l_string|&quot;OP&t;  : %s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
)paren
suffix:semicolon
id|sptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|irb-&gt;ecw
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;Sense data: %08X %08X %08X %08X &bslash;n&quot;
comma
id|sptr
(braket
l_int|0
)braket
comma
id|sptr
(braket
l_int|1
)braket
comma
id|sptr
(braket
l_int|2
)braket
comma
id|sptr
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;Sense data: %08X %08X %08X %08X &bslash;n&quot;
comma
id|sptr
(braket
l_int|4
)braket
comma
id|sptr
(braket
l_int|5
)braket
comma
id|sptr
(braket
l_int|6
)braket
comma
id|sptr
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;--------------------------------------------------&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Write sense data to dbf&n; */
r_void
DECL|function|tape_dump_sense_dbf
id|tape_dump_sense_dbf
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_int
r_int
op_star
id|sptr
suffix:semicolon
r_const
r_char
op_star
id|op
suffix:semicolon
r_if
c_cond
(paren
id|request
op_ne
l_int|NULL
)paren
id|op
op_assign
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
suffix:semicolon
r_else
id|op
op_assign
l_string|&quot;---&quot;
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;DSTAT : %02x   CSTAT: %02x&bslash;n&quot;
comma
id|irb-&gt;scsw.dstat
comma
id|irb-&gt;scsw.cstat
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;DEVICE: %s OP&bslash;t: %s&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
comma
id|op
)paren
suffix:semicolon
id|sptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|irb-&gt;ecw
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x %08x&bslash;n&quot;
comma
id|sptr
(braket
l_int|0
)braket
comma
id|sptr
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x %08x&bslash;n&quot;
comma
id|sptr
(braket
l_int|2
)braket
comma
id|sptr
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x %08x&bslash;n&quot;
comma
id|sptr
(braket
l_int|4
)braket
comma
id|sptr
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x %08x&bslash;n&quot;
comma
id|sptr
(braket
l_int|6
)braket
comma
id|sptr
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * I/O helper function. Adds the request to the request queue&n; * and starts it if the tape is idle. Has to be called with&n; * the device lock held.&n; */
r_static
r_inline
r_int
DECL|function|__tape_do_io
id|__tape_do_io
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
op_ne
id|TS_IN_USE
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Increase use count of device for the added request. */
id|atomic_inc
c_func
(paren
op_amp
id|device-&gt;ref_count
)paren
suffix:semicolon
id|request-&gt;device
op_assign
id|device
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|device-&gt;req_queue
)paren
)paren
(brace
multiline_comment|/* No other requests are on the queue. Start this one. */
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_BLOCK
)paren
id|device-&gt;discipline
op_member_access_from_pointer
id|check_locate
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|device-&gt;cdev
comma
id|request-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|request
comma
l_int|0x00
comma
id|request-&gt;options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|1
comma
l_string|&quot;tape: DOIO failed with rc = %i&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|request-&gt;list
comma
op_amp
id|device-&gt;req_queue
)paren
suffix:semicolon
id|request-&gt;status
op_assign
id|TAPE_REQUEST_IN_IO
suffix:semicolon
)brace
r_else
(brace
id|list_add_tail
c_func
(paren
op_amp
id|request-&gt;list
comma
op_amp
id|device-&gt;req_queue
)paren
suffix:semicolon
id|request-&gt;status
op_assign
id|TAPE_REQUEST_QUEUED
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Add the request to the request queue, try to start it if the&n; * tape is idle. Return without waiting for end of i/o.&n; */
r_int
DECL|function|tape_do_io_async
id|tape_do_io_async
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
)paren
(brace
r_int
id|rc
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
multiline_comment|/* Add request to request queue and try to start it. */
id|rc
op_assign
id|__tape_do_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * tape_do_io/__tape_wake_up&n; * Add the request to the request queue, try to start it if the&n; * tape is idle and wait uninterruptible for its completion.&n; */
r_static
r_void
DECL|function|__tape_wake_up
id|__tape_wake_up
c_func
(paren
r_struct
id|tape_request
op_star
id|request
comma
r_void
op_star
id|data
)paren
(brace
id|request-&gt;callback
op_assign
l_int|NULL
suffix:semicolon
id|wake_up
c_func
(paren
(paren
id|wait_queue_head_t
op_star
)paren
id|data
)paren
suffix:semicolon
)brace
r_int
DECL|function|tape_do_io
id|tape_do_io
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
)paren
(brace
id|wait_queue_head_t
id|wq
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|wq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup callback */
id|request-&gt;callback
op_assign
id|__tape_wake_up
suffix:semicolon
id|request-&gt;callback_data
op_assign
op_amp
id|wq
suffix:semicolon
multiline_comment|/* Add request to request queue and try to start it. */
id|rc
op_assign
id|__tape_do_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Request added to the queue. Wait for its completion. */
id|wait_event
c_func
(paren
id|wq
comma
(paren
id|request-&gt;callback
op_eq
l_int|NULL
)paren
)paren
suffix:semicolon
multiline_comment|/* Get rc from request */
r_return
id|request-&gt;rc
suffix:semicolon
)brace
multiline_comment|/*&n; * tape_do_io_interruptible/__tape_wake_up_interruptible&n; * Add the request to the request queue, try to start it if the&n; * tape is idle and wait uninterruptible for its completion.&n; */
r_static
r_void
DECL|function|__tape_wake_up_interruptible
id|__tape_wake_up_interruptible
c_func
(paren
r_struct
id|tape_request
op_star
id|request
comma
r_void
op_star
id|data
)paren
(brace
id|request-&gt;callback
op_assign
l_int|NULL
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
(paren
id|wait_queue_head_t
op_star
)paren
id|data
)paren
suffix:semicolon
)brace
r_int
DECL|function|tape_do_io_interruptible
id|tape_do_io_interruptible
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
)paren
(brace
id|wait_queue_head_t
id|wq
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|wq
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
multiline_comment|/* Setup callback */
id|request-&gt;callback
op_assign
id|__tape_wake_up_interruptible
suffix:semicolon
id|request-&gt;callback_data
op_assign
op_amp
id|wq
suffix:semicolon
id|rc
op_assign
id|__tape_do_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Request added to the queue. Wait for its completion. */
id|rc
op_assign
id|wait_event_interruptible
c_func
(paren
id|wq
comma
(paren
id|request-&gt;callback
op_eq
l_int|NULL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
op_minus
id|ERESTARTSYS
)paren
multiline_comment|/* Request finished normally. */
r_return
id|request-&gt;rc
suffix:semicolon
multiline_comment|/* Interrupted by a signal. We have to stop the current request. */
id|spin_lock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|__tape_halt_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;IO stopped on %s&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|__tape_do_io_list
id|__tape_do_io_list
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
op_ne
id|TS_IN_USE
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Try to start each request on request queue until one is&n;&t; * started successful.&n;&t; */
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|device-&gt;req_queue
)paren
(brace
id|request
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|tape_request
comma
id|list
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_BLOCK
)paren
id|device-&gt;discipline
op_member_access_from_pointer
id|check_locate
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|device-&gt;cdev
comma
id|request-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|request
comma
l_int|0x00
comma
id|request-&gt;options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|request-&gt;status
op_assign
id|TAPE_REQUEST_IN_IO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Start failed. Remove request and indicate failure. */
id|DBF_EVENT
c_func
(paren
l_int|1
comma
l_string|&quot;tape: DOIO failed with er = %i&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|request-&gt;list
)paren
suffix:semicolon
multiline_comment|/* Set ending status and do callback. */
id|request-&gt;rc
op_assign
id|rc
suffix:semicolon
id|request-&gt;status
op_assign
id|TAPE_REQUEST_DONE
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;callback
op_ne
l_int|NULL
)paren
id|request
op_member_access_from_pointer
id|callback
c_func
(paren
id|request
comma
id|request-&gt;callback_data
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Tape interrupt routine, called from the ccw_device layer&n; */
r_static
r_void
DECL|function|tape_do_irq
id|tape_do_irq
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
r_int
id|intparm
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_int
id|final
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|device
op_assign
(paren
r_struct
id|tape_device
op_star
)paren
id|cdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
(brace
id|PRINT_ERR
c_func
(paren
l_string|&quot;could not get device structure for bus_id %s &quot;
l_string|&quot;in interrupt&bslash;n&quot;
comma
id|cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|request
op_assign
(paren
r_struct
id|tape_request
op_star
)paren
id|intparm
suffix:semicolon
multiline_comment|/* May be an unsolicited irq */
r_if
c_cond
(paren
id|request
op_ne
l_int|NULL
)paren
(brace
id|request-&gt;rescnt
op_assign
id|irb-&gt;scsw.count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_ne
l_int|0x0c
)paren
(brace
multiline_comment|/* Set the &squot;ONLINE&squot; flag depending on sense byte 1 */
r_if
c_cond
(paren
op_star
(paren
(paren
(paren
id|__u8
op_star
)paren
id|irb-&gt;ecw
)paren
op_plus
l_int|1
)paren
op_amp
id|SENSE_DRIVE_ONLINE
)paren
(brace
id|device-&gt;tape_generic_status
op_or_assign
id|GMT_ONLINE
c_func
(paren
op_complement
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|device-&gt;tape_generic_status
op_and_assign
op_complement
id|GMT_ONLINE
c_func
(paren
op_complement
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Any request that does not come back with channel end&n;&t;&t; * and device end is unusual. Log the sense data.&n;&t;&t; */
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;-- Tape Interrupthandler --&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense_dbf
c_func
(paren
id|device
comma
id|request
comma
id|irb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Upon normal completion the device _is_ online */
id|device-&gt;tape_generic_status
op_or_assign
id|GMT_ONLINE
c_func
(paren
op_complement
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;tape_state
op_eq
id|TS_NOT_OPER
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;tape:device is not operational&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rc
op_assign
id|device-&gt;discipline
op_member_access_from_pointer
id|irq
c_func
(paren
id|device
comma
id|request
comma
id|irb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * rc &lt; 0 : request finished unsuccessfully.&n;&t; * rc == TAPE_IO_SUCCESS: request finished successfully.&n;&t; * rc == TAPE_IO_PENDING: request is still running. Ignore rc.&n;&t; * rc == TAPE_IO_RETRY: request finished but needs another go.&n;&t; * rc == TAPE_IO_STOP: request needs to get terminated.&n;&t; */
id|final
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|rc
)paren
(brace
r_case
id|TAPE_IO_SUCCESS
suffix:colon
id|final
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TAPE_IO_PENDING
suffix:colon
r_break
suffix:semicolon
r_case
id|TAPE_IO_RETRY
suffix:colon
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_BLOCK
)paren
id|device-&gt;discipline
op_member_access_from_pointer
id|check_locate
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
macro_line|#endif
id|rc
op_assign
id|ccw_device_start
c_func
(paren
id|cdev
comma
id|request-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|request
comma
l_int|0x00
comma
id|request-&gt;options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|1
comma
l_string|&quot;tape: DOIO failed with er = %i&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|final
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TAPE_IO_STOP
suffix:colon
id|__tape_halt_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|final
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|rc
OG
l_int|0
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;xunknownrc&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Invalid return code from discipline &quot;
l_string|&quot;interrupt function.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|final
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|final
)paren
(brace
multiline_comment|/* May be an unsolicited irq */
r_if
c_cond
(paren
id|request
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* Set ending status. */
id|request-&gt;rc
op_assign
id|rc
suffix:semicolon
id|request-&gt;status
op_assign
id|TAPE_REQUEST_DONE
suffix:semicolon
multiline_comment|/* Remove from request queue. */
id|list_del
c_func
(paren
op_amp
id|request-&gt;list
)paren
suffix:semicolon
multiline_comment|/* Do callback. */
r_if
c_cond
(paren
id|request-&gt;callback
op_ne
l_int|NULL
)paren
id|request
op_member_access_from_pointer
id|callback
c_func
(paren
id|request
comma
id|request-&gt;callback_data
)paren
suffix:semicolon
)brace
multiline_comment|/* Start next request. */
id|__tape_do_io_list
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Lock a shared tape for our exclusive use.&n; */
r_int
DECL|function|tape_assign
id|tape_assign
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|device-&gt;discipline
op_member_access_from_pointer
id|assign
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;(%s): assign failed - device might be busy&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;(%s): assign failed - device might be busy&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;(%s): assign lpum = %02x&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
comma
l_int|0
multiline_comment|/* FIXME: device-&gt;devstat.lpum */
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Unlock a shared tape.&n; */
r_int
DECL|function|tape_unassign
id|tape_unassign
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|device-&gt;discipline
op_member_access_from_pointer
id|unassign
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;(%s): unassign failed&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;(%s): unassign failed&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;(%s): unassign lpum = %02x&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
comma
l_int|0
multiline_comment|/* FIXME: device-&gt;devstat.lpum */
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device open function used by tape_char &amp; tape_block frontends.&n; */
r_int
DECL|function|tape_open
id|tape_open
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_int
id|rc
suffix:semicolon
id|spin_lock
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
op_eq
id|TS_NOT_OPER
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;TAPE:nodev&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|device-&gt;tape_state
op_eq
id|TS_IN_USE
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;TAPE:dbusy&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|device-&gt;discipline
op_ne
l_int|NULL
op_logical_and
op_logical_neg
id|try_module_get
c_func
(paren
id|device-&gt;discipline-&gt;owner
)paren
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;TAPE:nodisc&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
id|tape_state_set
c_func
(paren
id|device
comma
id|TS_IN_USE
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device release function used by tape_char &amp; tape_block frontends.&n; */
r_int
DECL|function|tape_release
id|tape_release
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
id|spin_lock
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
op_eq
id|TS_IN_USE
)paren
id|tape_state_set
c_func
(paren
id|device
comma
id|TS_UNUSED
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|device-&gt;discipline-&gt;owner
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Execute a magnetic tape command a number of times.&n; */
r_int
DECL|function|tape_mtop
id|tape_mtop
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_op
comma
r_int
id|mt_count
)paren
(brace
id|tape_mtop_fn
id|fn
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;TAPE:mtio&bslash;n&quot;
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;TAPE:ioop: %x&bslash;n&quot;
comma
id|mt_op
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;TAPE:arg:&t; %x&bslash;n&quot;
comma
id|mt_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mt_op
OL
l_int|0
op_logical_or
id|mt_op
op_ge
id|TAPE_NR_MTOPS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|fn
op_assign
id|device-&gt;discipline-&gt;mtop_array
(braket
id|mt_op
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fn
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* We assume that the backends can handle count up to 500. */
r_if
c_cond
(paren
id|mt_op
op_eq
id|MTBSR
op_logical_or
id|mt_op
op_eq
id|MTFSR
op_logical_or
id|mt_op
op_eq
id|MTFSF
op_logical_or
id|mt_op
op_eq
id|MTBSR
op_logical_or
id|mt_op
op_eq
id|MTFSFM
op_logical_or
id|mt_op
op_eq
id|MTBSFM
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|mt_count
OG
l_int|500
suffix:semicolon
id|mt_count
op_sub_assign
l_int|500
)paren
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|fn
c_func
(paren
id|device
comma
l_int|500
)paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
id|fn
c_func
(paren
id|device
comma
id|mt_count
)paren
suffix:semicolon
)brace
r_else
id|rc
op_assign
id|fn
c_func
(paren
id|device
comma
id|mt_count
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape init function.&n; */
r_static
r_int
DECL|function|tape_init
id|tape_init
(paren
r_void
)paren
(brace
id|tape_dbf_area
op_assign
id|debug_register
(paren
l_string|&quot;tape&quot;
comma
l_int|1
comma
l_int|2
comma
l_int|3
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|tape_dbf_area
comma
op_amp
id|debug_sprintf_view
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;tape init: ($Revision: 1.25 $)&bslash;n&quot;
)paren
suffix:semicolon
id|tape_proc_init
c_func
(paren
)paren
suffix:semicolon
id|tapechar_init
(paren
)paren
suffix:semicolon
id|tapeblock_init
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape exit function.&n; */
r_static
r_void
DECL|function|tape_exit
id|tape_exit
c_func
(paren
r_void
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;tape exit&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Get rid of the frontends */
id|tapechar_exit
c_func
(paren
)paren
suffix:semicolon
id|tapeblock_exit
c_func
(paren
)paren
suffix:semicolon
id|tape_proc_cleanup
c_func
(paren
)paren
suffix:semicolon
id|debug_unregister
(paren
id|tape_dbf_area
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;(C) 2001 IBM Deutschland Entwicklung GmbH by Carsten Otte and &quot;
l_string|&quot;Michael Holzheu (cotte@de.ibm.com,holzheu@de.ibm.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux on zSeries channel attached &quot;
l_string|&quot;tape device driver ($Revision: 1.25 $)&quot;
)paren
suffix:semicolon
DECL|variable|tape_init
id|module_init
c_func
(paren
id|tape_init
)paren
suffix:semicolon
DECL|variable|tape_exit
id|module_exit
c_func
(paren
id|tape_exit
)paren
suffix:semicolon
DECL|variable|tape_dbf_area
id|EXPORT_SYMBOL
c_func
(paren
id|tape_dbf_area
)paren
suffix:semicolon
DECL|variable|tape_generic_remove
id|EXPORT_SYMBOL
c_func
(paren
id|tape_generic_remove
)paren
suffix:semicolon
DECL|variable|tape_disable_device
id|EXPORT_SYMBOL
c_func
(paren
id|tape_disable_device
)paren
suffix:semicolon
DECL|variable|tape_generic_probe
id|EXPORT_SYMBOL
c_func
(paren
id|tape_generic_probe
)paren
suffix:semicolon
DECL|variable|tape_enable_device
id|EXPORT_SYMBOL
c_func
(paren
id|tape_enable_device
)paren
suffix:semicolon
DECL|variable|tape_put_device
id|EXPORT_SYMBOL
c_func
(paren
id|tape_put_device
)paren
suffix:semicolon
DECL|variable|tape_state_verbose
id|EXPORT_SYMBOL
c_func
(paren
id|tape_state_verbose
)paren
suffix:semicolon
DECL|variable|tape_op_verbose
id|EXPORT_SYMBOL
c_func
(paren
id|tape_op_verbose
)paren
suffix:semicolon
DECL|variable|tape_state_set
id|EXPORT_SYMBOL
c_func
(paren
id|tape_state_set
)paren
suffix:semicolon
DECL|variable|tape_med_state_set
id|EXPORT_SYMBOL
c_func
(paren
id|tape_med_state_set
)paren
suffix:semicolon
DECL|variable|tape_alloc_request
id|EXPORT_SYMBOL
c_func
(paren
id|tape_alloc_request
)paren
suffix:semicolon
DECL|variable|tape_free_request
id|EXPORT_SYMBOL
c_func
(paren
id|tape_free_request
)paren
suffix:semicolon
DECL|variable|tape_dump_sense
id|EXPORT_SYMBOL
c_func
(paren
id|tape_dump_sense
)paren
suffix:semicolon
DECL|variable|tape_dump_sense_dbf
id|EXPORT_SYMBOL
c_func
(paren
id|tape_dump_sense_dbf
)paren
suffix:semicolon
DECL|variable|tape_do_io
id|EXPORT_SYMBOL
c_func
(paren
id|tape_do_io
)paren
suffix:semicolon
DECL|variable|tape_do_io_async
id|EXPORT_SYMBOL
c_func
(paren
id|tape_do_io_async
)paren
suffix:semicolon
DECL|variable|tape_do_io_interruptible
id|EXPORT_SYMBOL
c_func
(paren
id|tape_do_io_interruptible
)paren
suffix:semicolon
DECL|variable|tape_mtop
id|EXPORT_SYMBOL
c_func
(paren
id|tape_mtop
)paren
suffix:semicolon
eof
