multiline_comment|/*&n; *  IBM/3270 Driver -- Copyright (C) 2000, 2001 UTS Global LLC&n; *&n; *  tubtty.c -- Linemode tty driver&n; *&n; *&n; *&n; *&n; *&n; *  Author:  Richard Hitt&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &quot;tubio.h&quot;
multiline_comment|/* Initialization &amp; uninitialization for tubtty */
r_int
id|tty3270_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|tty3270_fini
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Interface routines from the upper tty layer to the tty driver */
r_static
r_int
id|tty3270_open
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_void
id|tty3270_close
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_write
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_int
comma
r_const
r_int
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|tty3270_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_int
r_char
)paren
suffix:semicolon
r_static
r_void
id|tty3270_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|tty3270_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
comma
r_struct
id|termios
op_star
)paren
suffix:semicolon
r_static
r_void
id|tty3270_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_void
id|tty3270_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_read_proc
c_func
(paren
r_char
op_star
comma
r_char
op_star
op_star
comma
id|off_t
comma
r_int
comma
r_int
op_star
comma
r_void
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_write_proc
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
r_int
r_int
comma
r_void
op_star
)paren
suffix:semicolon
multiline_comment|/* tty3270 utility functions */
r_static
r_void
id|tty3270_bh
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_void
id|tty3270_sched_bh
c_func
(paren
id|tub_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_wait
c_func
(paren
id|tub_t
op_star
comma
r_int
op_star
)paren
suffix:semicolon
r_void
id|tty3270_int
c_func
(paren
id|tub_t
op_star
comma
id|devstat_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_try_logging
c_func
(paren
id|tub_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|tty3270_start_input
c_func
(paren
id|tub_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|tty3270_do_input
c_func
(paren
id|tub_t
op_star
)paren
suffix:semicolon
r_static
r_void
id|tty3270_do_enter
c_func
(paren
id|tub_t
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|tty3270_do_showi
c_func
(paren
id|tub_t
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_int
id|tty3270_io
c_func
(paren
id|tub_t
op_star
)paren
suffix:semicolon
r_static
r_int
id|tty3270_show_tube
c_func
(paren
r_int
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|tty3270_major
r_static
r_int
id|tty3270_major
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|tty3270_driver
r_struct
id|tty_driver
id|tty3270_driver
suffix:semicolon
DECL|variable|tty3270_refcount
r_static
r_int
id|tty3270_refcount
suffix:semicolon
DECL|variable|tty3270_table
r_static
r_struct
id|tty_struct
op_star
id|tty3270_table
(braket
id|TUBMAXMINS
)braket
suffix:semicolon
DECL|variable|tty3270_termios
r_static
r_struct
id|termios
op_star
id|tty3270_termios
(braket
id|TUBMAXMINS
)braket
suffix:semicolon
DECL|variable|tty3270_termios_locked
r_static
r_struct
id|termios
op_star
id|tty3270_termios_locked
(braket
id|TUBMAXMINS
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_TN3270_CONSOLE
DECL|variable|con3270_major
r_static
r_int
id|con3270_major
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|con3270_driver
r_static
r_struct
id|tty_driver
id|con3270_driver
suffix:semicolon
macro_line|#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0))
DECL|variable|con3270_refcount
r_static
r_int
id|con3270_refcount
suffix:semicolon
DECL|variable|con3270_table
r_static
r_struct
id|tty_struct
op_star
id|con3270_table
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|con3270_termios
r_static
r_struct
id|termios
op_star
id|con3270_termios
(braket
l_int|1
)braket
suffix:semicolon
DECL|variable|con3270_termios_locked
r_static
r_struct
id|termios
op_star
id|con3270_termios_locked
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#endif
macro_line|#endif /* CONFIG_TN3270_CONSOLE */
DECL|variable|tty3270_proc_index
r_static
r_int
id|tty3270_proc_index
suffix:semicolon
DECL|variable|tty3270_proc_data
r_static
r_int
id|tty3270_proc_data
suffix:semicolon
DECL|variable|tty3270_proc_misc
r_static
r_int
id|tty3270_proc_misc
suffix:semicolon
DECL|variable|tty3270_proc_what
r_static
r_enum
id|tubwhat
id|tty3270_proc_what
suffix:semicolon
multiline_comment|/*&n; * tty3270_init() -- Register the tty3270 driver&n; */
r_int
DECL|function|tty3270_init
id|tty3270_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty_driver
op_star
id|td
op_assign
op_amp
id|tty3270_driver
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Initialize for tty driver */
id|td-&gt;magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|td-&gt;driver_name
op_assign
l_string|&quot;tty3270&quot;
suffix:semicolon
id|td-&gt;name
op_assign
l_string|&quot;tty3270&quot;
suffix:semicolon
id|td-&gt;major
op_assign
id|IBM_TTY3270_MAJOR
suffix:semicolon
id|td-&gt;minor_start
op_assign
l_int|0
suffix:semicolon
id|td-&gt;num
op_assign
id|TUBMAXMINS
suffix:semicolon
id|td-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SYSTEM
suffix:semicolon
id|td-&gt;subtype
op_assign
id|SYSTEM_TYPE_TTY
suffix:semicolon
id|td-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|td-&gt;flags
op_assign
id|TTY_DRIVER_RESET_TERMIOS
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|td-&gt;flags
op_or_assign
id|TTY_DRIVER_NO_DEVFS
suffix:semicolon
macro_line|#endif
id|td-&gt;refcount
op_assign
op_amp
id|tty3270_refcount
suffix:semicolon
id|td-&gt;table
op_assign
id|tty3270_table
suffix:semicolon
id|td-&gt;termios
op_assign
id|tty3270_termios
suffix:semicolon
id|td-&gt;termios_locked
op_assign
id|tty3270_termios_locked
suffix:semicolon
id|td-&gt;open
op_assign
id|tty3270_open
suffix:semicolon
id|td-&gt;close
op_assign
id|tty3270_close
suffix:semicolon
id|td-&gt;write
op_assign
id|tty3270_write
suffix:semicolon
id|td-&gt;put_char
op_assign
id|tty3270_put_char
suffix:semicolon
id|td-&gt;flush_chars
op_assign
id|tty3270_flush_chars
suffix:semicolon
id|td-&gt;write_room
op_assign
id|tty3270_write_room
suffix:semicolon
id|td-&gt;chars_in_buffer
op_assign
id|tty3270_chars_in_buffer
suffix:semicolon
id|td-&gt;ioctl
op_assign
id|tty3270_ioctl
suffix:semicolon
id|td-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;set_termios
op_assign
id|tty3270_set_termios
suffix:semicolon
id|td-&gt;throttle
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;unthrottle
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;stop
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;start
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;hangup
op_assign
id|tty3270_hangup
suffix:semicolon
id|td-&gt;break_ctl
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;flush_buffer
op_assign
id|tty3270_flush_buffer
suffix:semicolon
id|td-&gt;set_ldisc
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;wait_until_sent
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;send_xchar
op_assign
l_int|NULL
suffix:semicolon
id|td-&gt;read_proc
op_assign
id|tty3270_read_proc
suffix:semicolon
id|td-&gt;write_proc
op_assign
id|tty3270_write_proc
suffix:semicolon
id|rc
op_assign
id|tty_register_driver
c_func
(paren
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;tty3270 registration failed with %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
(brace
id|tty3270_major
op_assign
id|IBM_TTY3270_MAJOR
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;proc_entry
op_ne
l_int|NULL
)paren
id|td-&gt;proc_entry-&gt;mode
op_assign
id|S_IRUGO
op_or
id|S_IWUGO
suffix:semicolon
)brace
macro_line|#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0))
macro_line|#ifdef CONFIG_TN3270_CONSOLE
r_if
c_cond
(paren
id|CONSOLE_IS_3270
)paren
(brace
id|tty3270_con_driver
op_assign
op_star
id|td
suffix:semicolon
id|td
op_assign
op_amp
id|tty3270_con_driver
suffix:semicolon
id|td-&gt;driver_name
op_assign
l_string|&quot;con3270&quot;
suffix:semicolon
id|td-&gt;name
op_assign
l_string|&quot;con3270&quot;
suffix:semicolon
id|td-&gt;major
op_assign
id|MAJOR
c_func
(paren
id|S390_CONSOLE_DEV
)paren
suffix:semicolon
id|td-&gt;minor_start
op_assign
id|MINOR
c_func
(paren
id|S390_CONSOLE_DEV
)paren
suffix:semicolon
id|td-&gt;num
op_assign
l_int|1
suffix:semicolon
id|td-&gt;refcount
op_assign
op_amp
id|con3270_refcount
suffix:semicolon
id|td-&gt;table
op_assign
id|con3270_table
suffix:semicolon
id|td-&gt;termios
op_assign
id|con3270_termios
suffix:semicolon
id|td-&gt;termios_locked
op_assign
id|con3270_termios_locked
suffix:semicolon
id|rc
op_assign
id|tty_register_driver
c_func
(paren
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;con3270 registration failed with %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
r_else
(brace
id|con3270_major
op_assign
id|MAJOR
c_func
(paren
id|S390_CONSOLE_DEV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;proc_entry
op_ne
l_int|NULL
)paren
id|td-&gt;proc_entry-&gt;mode
op_assign
id|S_IRUGO
op_or
id|S_IWUGO
suffix:semicolon
)brace
)brace
macro_line|#endif /* ifdef CONFIG_TN3270_CONSOLE */
macro_line|#endif /* if LINUX_VERSION_CODE */
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * tty3270_fini() -- Uninitialize linemode tubes&n; */
r_void
DECL|function|tty3270_fini
id|tty3270_fini
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|tty3270_major
op_ne
op_minus
l_int|1
)paren
(brace
id|tty_unregister_driver
c_func
(paren
op_amp
id|tty3270_driver
)paren
suffix:semicolon
id|tty3270_major
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_TN3270_CONSOLE
r_if
c_cond
(paren
id|CONSOLE_IS_3270
op_logical_and
id|con3270_major
op_ne
op_minus
l_int|1
)paren
(brace
id|tty_unregister_driver
c_func
(paren
op_amp
id|con3270_driver
)paren
suffix:semicolon
id|con3270_major
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
)brace
r_static
r_int
DECL|function|tty3270_open
id|tty3270_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|cmd
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|TTY2TUB
c_func
(paren
id|tty
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|tub_inc_use_count
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_wait
c_func
(paren
id|tubp
comma
op_amp
id|flags
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|do_fail
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;lnopen
OG
l_int|0
)paren
(brace
id|tubp-&gt;lnopen
op_increment
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tubp-&gt;flags
op_amp
id|TUB_OPEN_STET
)paren
(brace
id|cmd
op_assign
id|TBC_UPDLOG
suffix:semicolon
)brace
r_else
(brace
id|cmd
op_assign
id|TBC_OPEN
suffix:semicolon
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_SIZED
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_size
c_func
(paren
id|tubp
comma
op_amp
id|flags
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|do_fail
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_rcl_init
c_func
(paren
id|tubp
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|do_fail
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_aid_init
c_func
(paren
id|tubp
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|do_fail
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_scl_init
c_func
(paren
id|tubp
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|do_fail
suffix:semicolon
id|tubp-&gt;mode
op_assign
id|TBM_LN
suffix:semicolon
id|tubp-&gt;intv
op_assign
id|tty3270_int
suffix:semicolon
id|tubp-&gt;tty
op_assign
id|tty
suffix:semicolon
id|tubp-&gt;lnopen
op_assign
l_int|1
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|tubp
suffix:semicolon
id|tty-&gt;winsize.ws_row
op_assign
id|tubp-&gt;geom_rows
suffix:semicolon
id|tty-&gt;winsize.ws_col
op_assign
id|tubp-&gt;geom_cols
suffix:semicolon
id|tubp-&gt;tty_inattr
op_assign
id|TF_INPUT
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|cmd
suffix:semicolon
id|tty3270_build
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|do_fail
suffix:colon
id|tty3270_scl_fini
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tty3270_aid_fini
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tty3270_rcl_fini
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|tub_dec_use_count
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_close
id|tty3270_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty3270_wait
c_func
(paren
id|tubp
comma
op_amp
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|tubp-&gt;lnopen
OG
l_int|0
)paren
r_goto
id|do_return
suffix:semicolon
id|tubp-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|tty-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
id|tty3270_aid_fini
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tty3270_rcl_fini
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tty3270_scl_fini
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|do_return
suffix:colon
id|tub_dec_use_count
c_func
(paren
)paren
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tty3270_write
id|tty3270_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|fromuser
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|bcb_t
id|obcb
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_TN3270_CONSOLE
r_if
c_cond
(paren
id|CONSOLE_IS_3270
op_logical_and
id|tub3270_con_tubp
op_eq
id|tubp
)paren
id|tub3270_con_copy
c_func
(paren
id|tubp
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_TN3270_CONSOLE */
id|obcb.bc_buf
op_assign
(paren
r_char
op_star
)paren
id|buf
suffix:semicolon
id|obcb.bc_len
op_assign
id|obcb.bc_cnt
op_assign
id|obcb.bc_wr
op_assign
id|count
suffix:semicolon
id|obcb.bc_rd
op_assign
l_int|0
suffix:semicolon
id|TUBLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|tub3270_movedata
c_func
(paren
op_amp
id|obcb
comma
op_amp
id|tubp-&gt;tty_bcb
comma
id|fromuser
)paren
suffix:semicolon
id|tty3270_try_logging
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_put_char
id|tty3270_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
r_int
id|flags
suffix:semicolon
id|tub_t
op_star
id|tubp
suffix:semicolon
id|bcb_t
op_star
id|ob
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|TUBLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|ob
op_assign
op_amp
id|tubp-&gt;tty_bcb
suffix:semicolon
r_if
c_cond
(paren
id|ob-&gt;bc_cnt
OL
id|ob-&gt;bc_len
)paren
(brace
id|ob-&gt;bc_buf
(braket
id|ob-&gt;bc_wr
op_increment
)braket
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|ob-&gt;bc_wr
op_eq
id|ob-&gt;bc_len
)paren
id|ob-&gt;bc_wr
op_assign
l_int|0
suffix:semicolon
id|ob-&gt;bc_cnt
op_increment
suffix:semicolon
)brace
id|tty3270_try_logging
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_flush_chars
id|tty3270_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|TUBLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|tty3270_try_logging
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tty3270_write_room
id|tty3270_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
id|bcb_t
op_star
id|ob
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ob
op_assign
op_amp
id|tubp-&gt;tty_bcb
suffix:semicolon
r_return
id|ob-&gt;bc_len
op_minus
id|ob-&gt;bc_cnt
suffix:semicolon
)brace
r_static
r_int
DECL|function|tty3270_chars_in_buffer
id|tty3270_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
id|bcb_t
op_star
id|ob
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ob
op_assign
op_amp
id|tubp-&gt;tty_bcb
suffix:semicolon
r_return
id|ob-&gt;bc_cnt
suffix:semicolon
)brace
r_static
r_int
DECL|function|tty3270_ioctl
id|tty3270_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|termios
id|termios
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|TUBLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flags
op_star
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCGETS
suffix:colon
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_case
id|TCFLSH
suffix:colon
multiline_comment|/* arg:  2 or 0 */
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_case
id|TCSETSF
suffix:colon
r_if
c_cond
(paren
id|user_termios_to_kernel_termios
c_func
(paren
op_amp
id|termios
comma
(paren
r_struct
id|termios
op_star
)paren
id|arg
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_case
id|TCGETA
suffix:colon
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_case
id|TCSETA
suffix:colon
r_if
c_cond
(paren
id|user_termio_to_kernel_termios
c_func
(paren
op_amp
id|termios
comma
(paren
r_struct
id|termio
op_star
)paren
id|arg
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
id|do_return
suffix:colon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_set_termios
id|tty3270_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
r_new
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tty3270_wait
c_func
(paren
id|tubp
comma
op_amp
id|flags
)paren
op_ne
l_int|0
)paren
(brace
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_new
op_assign
id|L_ICANON
c_func
(paren
id|tty
)paren
ques
c_cond
id|L_ECHO
c_func
(paren
id|tty
)paren
ques
c_cond
id|TF_INPUT
suffix:colon
id|TF_INPUTN
suffix:colon
id|tubp-&gt;tty_inattr
suffix:semicolon
r_if
c_cond
(paren
r_new
op_ne
id|tubp-&gt;tty_inattr
)paren
(brace
id|tubp-&gt;tty_inattr
op_assign
r_new
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_CLRINPUT
suffix:semicolon
id|tty3270_build
c_func
(paren
id|tubp
)paren
suffix:semicolon
)brace
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_flush_buffer
id|tty3270_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
id|bcb_t
op_star
id|ob
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;mode
op_eq
id|TBM_FS
op_logical_and
id|tubp-&gt;fs_pid
op_ne
l_int|0
)paren
(brace
id|kill_proc
c_func
(paren
id|tubp-&gt;fs_pid
comma
id|SIGHUP
comma
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tubp-&gt;flags
op_amp
id|TUB_OPEN_STET
)paren
op_eq
l_int|0
)paren
(brace
id|ob
op_assign
op_amp
id|tubp-&gt;tty_bcb
suffix:semicolon
id|TUBLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
id|ob-&gt;bc_rd
op_assign
l_int|0
suffix:semicolon
id|ob-&gt;bc_wr
op_assign
l_int|0
suffix:semicolon
id|ob-&gt;bc_cnt
op_assign
l_int|0
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tty3270_read_proc
id|tty3270_read_proc
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_int
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tty3270_proc_what
op_eq
id|TW_CONFIG
)paren
(brace
multiline_comment|/*&n;&t;&t; * Describe the 3270 configuration in ascii lines.&n;&t;&t; * Line 1:&t;&t;0 &lt;fsmajor&gt; 0&n;&t;&t; * Console line:&t;&lt;devnum&gt; CONSOLE &lt;minor&gt;&n;&t;&t; * Other lines:&t;&t;&lt;devnum&gt; &lt;ttymajor&gt; &lt;minor&gt;&n;&t;&t; */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;0 %d 0&bslash;n&quot;
comma
id|fs3270_major
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|tubnummins
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tubp
op_assign
(paren
op_star
id|tubminors
)paren
(braket
id|i
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_TN3270_CONSOLE
r_if
c_cond
(paren
id|CONSOLE_IS_3270
op_logical_and
id|tubp
op_eq
id|tub3270_con_tubp
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%.4x CONSOLE %d&bslash;n&quot;
comma
id|tubp-&gt;devno
comma
id|i
)paren
suffix:semicolon
r_else
macro_line|#endif
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;%.4x %d %d&bslash;n&quot;
comma
id|tubp-&gt;devno
comma
id|tty3270_major
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|begin
op_plus
id|len
OG
id|off
op_plus
id|count
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|begin
op_plus
id|len
OL
id|off
)paren
(brace
id|begin
op_add_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
OG
id|tubnummins
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ge
id|begin
op_plus
id|len
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|start
op_assign
id|buf
op_plus
id|off
op_minus
id|begin
suffix:semicolon
id|rc
op_assign
id|MIN
c_func
(paren
id|count
comma
id|begin
op_plus
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|eof
op_logical_and
id|rc
op_eq
l_int|0
)paren
id|tty3270_proc_what
op_assign
id|TW_BOGUS
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;There are %d devices.  fs major is %d, &quot;
l_string|&quot;tty major is %d.&bslash;n&quot;
comma
id|tubnummins
comma
id|fs3270_major
comma
id|tty3270_major
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;        index=%d data=%d misc=%d&bslash;n&quot;
comma
id|tty3270_proc_index
comma
id|tty3270_proc_data
comma
id|tty3270_proc_misc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Display info for the tube with minor nr in index&n;&t; */
id|len
op_add_assign
id|tty3270_show_tube
c_func
(paren
id|tty3270_proc_index
comma
id|buf
op_plus
id|len
comma
id|count
op_minus
id|len
)paren
suffix:semicolon
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|off
op_ge
id|begin
op_plus
id|len
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|start
op_assign
id|buf
op_plus
id|off
op_minus
id|begin
suffix:semicolon
r_return
id|MIN
c_func
(paren
id|count
comma
id|begin
op_plus
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tty3270_write_proc
id|tty3270_write_proc
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_char
id|mybuf
(braket
id|GEOM_MAXINPLEN
)braket
suffix:semicolon
r_int
id|mycount
suffix:semicolon
id|tub_t
op_star
id|tubp
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|mycount
op_assign
id|MIN
c_func
(paren
id|count
comma
r_sizeof
id|mybuf
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|mybuf
comma
id|buffer
comma
id|mycount
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|mybuf
(braket
id|mycount
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/*&n;&t; * User-mode settings affect only the current tty ---&n;&t; */
id|tubp
op_assign
l_int|NULL
suffix:semicolon
id|tty
op_assign
id|current-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
(brace
r_if
c_cond
(paren
id|tub_major
c_func
(paren
id|tty-&gt;device
)paren
op_eq
id|IBM_TTY3270_MAJOR
)paren
id|tubp
op_assign
(paren
op_star
id|tubminors
)paren
(braket
id|tub_minor
c_func
(paren
id|tty-&gt;device
)paren
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_TN3270_CONSOLE
macro_line|#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(2,3,0))
r_if
c_cond
(paren
id|CONSOLE_IS_3270
op_logical_and
id|tty-&gt;device
op_eq
id|S390_CONSOLE_DEV
)paren
id|tubp
op_assign
id|tub3270_con_tubp
suffix:semicolon
macro_line|#endif /* LINUX_VERSION_CODE */
macro_line|#endif /* CONFIG_TN3270_CONSOLE */
)brace
r_if
c_cond
(paren
id|tubp
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_aid_set
c_func
(paren
id|tubp
comma
id|mybuf
comma
id|mycount
op_plus
l_int|1
)paren
)paren
)paren
r_return
id|rc
OG
l_int|0
ques
c_cond
id|count
suffix:colon
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_rcl_set
c_func
(paren
id|tubp
comma
id|mybuf
comma
id|mycount
op_plus
l_int|1
)paren
)paren
)paren
r_return
id|rc
OG
l_int|0
ques
c_cond
id|count
suffix:colon
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_scl_set
c_func
(paren
id|tubp
comma
id|mybuf
comma
id|mycount
op_plus
l_int|1
)paren
)paren
)paren
r_return
id|rc
OG
l_int|0
ques
c_cond
id|count
suffix:colon
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Superuser-mode settings affect the driver overall ---&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TTY_CONFIG
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|mybuf
comma
l_string|&quot;index=&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|tty3270_proc_index
op_assign
id|simple_strtoul
c_func
(paren
id|mybuf
op_plus
l_int|6
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|mybuf
comma
l_string|&quot;data=&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|tty3270_proc_data
op_assign
id|simple_strtoul
c_func
(paren
id|mybuf
op_plus
l_int|5
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|mybuf
comma
l_string|&quot;misc=&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|tty3270_proc_misc
op_assign
id|simple_strtoul
c_func
(paren
id|mybuf
op_plus
l_int|5
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|mybuf
comma
l_string|&quot;what=&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|mybuf
op_plus
l_int|5
comma
l_string|&quot;bogus&quot;
)paren
op_eq
l_int|0
)paren
id|tty3270_proc_what
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|mybuf
op_plus
l_int|5
comma
l_string|&quot;config&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
id|tty3270_proc_what
op_assign
id|TW_CONFIG
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|tty3270_hangup
id|tty3270_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_extern
r_void
id|fs3270_release
c_func
(paren
id|tub_t
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp
op_assign
id|tty-&gt;driver_data
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty3270_rcl_purge
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tty3270_aid_reinit
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|fs3270_release
c_func
(paren
id|tubp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * tty3270_bh(tubp) -- Perform back-half processing&n; */
r_static
r_void
DECL|function|tty3270_bh
id|tty3270_bh
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
id|ioinfo_t
op_star
id|ioinfop
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|ioinfop
op_assign
id|ioinfo
(braket
(paren
id|tubp
op_assign
id|data
)paren
op_member_access_from_pointer
id|irq
)braket
suffix:semicolon
r_while
c_loop
(paren
id|TUBTRYLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ioinfop-&gt;ui.flags.unready
op_eq
l_int|1
)paren
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioinfop-&gt;ui.flags.unready
op_eq
l_int|1
op_logical_or
id|ioinfop-&gt;ui.flags.ready
op_eq
l_int|0
)paren
r_goto
id|do_unlock
suffix:semicolon
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_BHPENDING
suffix:semicolon
id|tty
op_assign
id|tubp-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;flags
op_amp
id|TUB_UNSOL_DE
)paren
(brace
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_UNSOL_DE
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_ne
l_int|NULL
)paren
(brace
id|tty_hangup
c_func
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tubp-&gt;waitq
)paren
suffix:semicolon
r_goto
id|do_unlock
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tubp-&gt;flags
op_amp
id|TUB_IACTIVE
)paren
(brace
multiline_comment|/* If read ended, */
id|tty3270_do_input
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_IACTIVE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tubp-&gt;flags
op_amp
id|TUB_WORKING
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|tubp-&gt;flags
op_amp
id|TUB_ATTN
)paren
(brace
id|tty3270_start_input
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_ATTN
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tty3270_try_logging
c_func
(paren
id|tubp
)paren
op_eq
l_int|0
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|tubp-&gt;waitq
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tty
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
op_ne
l_int|NULL
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
id|do_unlock
suffix:colon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * tty3270_sched_bh(tubp) -- Schedule the back half&n; * Irq lock must be held on entry and remains held on exit.&n; */
r_void
DECL|function|tty3270_sched_bh
id|tty3270_sched_bh
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
r_if
c_cond
(paren
id|tubp-&gt;flags
op_amp
id|TUB_BHPENDING
)paren
r_return
suffix:semicolon
id|tubp-&gt;flags
op_or_assign
id|TUB_BHPENDING
suffix:semicolon
id|tubp-&gt;tqueue.routine
op_assign
id|tty3270_bh
suffix:semicolon
id|tubp-&gt;tqueue.data
op_assign
id|tubp
suffix:semicolon
id|queue_task
c_func
(paren
op_amp
id|tubp-&gt;tqueue
comma
op_amp
id|tq_immediate
)paren
suffix:semicolon
id|mark_bh
c_func
(paren
id|IMMEDIATE_BH
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * tty3270_io() -- Perform line-mode reads and writes here&n; */
r_int
DECL|function|tty3270_io
id|tty3270_io
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
r_int
id|rc
suffix:semicolon
id|ccw1_t
op_star
id|ccwp
suffix:semicolon
id|tubp-&gt;flags
op_or_assign
id|TUB_WORKING
suffix:semicolon
id|tubp-&gt;dstat
op_assign
l_int|0
suffix:semicolon
id|ccwp
op_assign
op_amp
id|tubp-&gt;ttyccw
suffix:semicolon
id|rc
op_assign
id|do_IO
c_func
(paren
id|tubp-&gt;irq
comma
id|ccwp
comma
id|tubp-&gt;irq
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * tty3270_wait(tubp) -- Wait until TUB_WORKING is off&n; * On entry the lock must not be held; on exit it is held.&n; */
r_static
r_int
DECL|function|tty3270_wait
id|tty3270_wait
c_func
(paren
id|tub_t
op_star
id|tubp
comma
r_int
op_star
id|flags
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|TUBLOCK
c_func
(paren
id|tubp-&gt;irq
comma
op_star
id|flags
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|tubp-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_and
(paren
id|tubp-&gt;flags
op_amp
id|TUB_WORKING
)paren
op_ne
l_int|0
)paren
(brace
macro_line|#warning FIXME: [kj] use set_current_state instead of current-&gt;state=
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
op_star
id|flags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
macro_line|#warning FIXME: [kj] use set_current_state instead of current-&gt;state=
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|TUBLOCK
c_func
(paren
id|tubp-&gt;irq
comma
op_star
id|flags
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|tubp-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
id|signal_pending
c_func
(paren
id|current
)paren
ques
c_cond
op_minus
id|ERESTARTSYS
suffix:colon
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|tty3270_int
id|tty3270_int
c_func
(paren
id|tub_t
op_star
id|tubp
comma
id|devstat_t
op_star
id|dsp
)paren
(brace
DECL|macro|DEV_UE_BUSY
mdefine_line|#define&t;DEV_UE_BUSY &bslash;&n;&t;(DEV_STAT_CHN_END | DEV_STAT_DEV_END | DEV_STAT_UNIT_EXCEP)
DECL|macro|DEV_NOT_WORKING
mdefine_line|#define DEV_NOT_WORKING &bslash;&n;&t;(DEV_STAT_ATTENTION | DEV_STAT_DEV_END | DEV_STAT_UNIT_CHECK)
id|tubp-&gt;dstat
op_assign
id|dsp-&gt;dstat
suffix:semicolon
multiline_comment|/* Handle CE-DE-UE and subsequent UDE */
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_eq
id|DEV_UE_BUSY
)paren
(brace
id|tubp-&gt;flags
op_or_assign
id|TUB_UE_BUSY
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tubp-&gt;flags
op_amp
id|TUB_UE_BUSY
)paren
(brace
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_UE_BUSY
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_eq
id|DEV_STAT_DEV_END
op_logical_and
(paren
id|tubp-&gt;flags
op_amp
id|TUB_WORKING
)paren
op_ne
l_int|0
)paren
(brace
id|tty3270_io
c_func
(paren
id|tubp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Handle ATTN */
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_STAT_ATTENTION
)paren
id|tubp-&gt;flags
op_or_assign
id|TUB_ATTN
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_STAT_CHN_END
)paren
(brace
id|tubp-&gt;cswl
op_assign
id|dsp-&gt;rescnt
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_STAT_DEV_END
)paren
op_eq
l_int|0
)paren
id|tubp-&gt;flags
op_or_assign
id|TUB_EXPECT_DE
suffix:semicolon
r_else
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_EXPECT_DE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_STAT_DEV_END
)paren
(brace
r_if
c_cond
(paren
(paren
id|tubp-&gt;flags
op_amp
id|TUB_EXPECT_DE
)paren
op_eq
l_int|0
)paren
id|tubp-&gt;flags
op_or_assign
id|TUB_UNSOL_DE
suffix:semicolon
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_EXPECT_DE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_NOT_WORKING
)paren
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_WORKING
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
id|tubp-&gt;sense
op_assign
id|dsp-&gt;ii.sense
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tubp-&gt;flags
op_amp
id|TUB_WORKING
)paren
op_eq
l_int|0
)paren
id|tty3270_sched_bh
c_func
(paren
id|tubp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * tty3270_refresh(), called by fs3270_close() when tubp-&gt;fsopen == 0.&n; * On entry, lock is held.&n; */
r_void
DECL|function|tty3270_refresh
id|tty3270_refresh
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
r_if
c_cond
(paren
id|tubp-&gt;lnopen
)paren
(brace
id|tubp-&gt;mode
op_assign
id|TBM_LN
suffix:semicolon
id|tubp-&gt;intv
op_assign
id|tty3270_int
suffix:semicolon
id|tty3270_scl_resettimer
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_UPDATE
suffix:semicolon
id|tty3270_build
c_func
(paren
id|tubp
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|tty3270_try_logging
id|tty3270_try_logging
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
r_if
c_cond
(paren
id|tubp-&gt;flags
op_amp
id|TUB_WORKING
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;mode
op_eq
id|TBM_FS
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;stat
op_eq
id|TBS_HOLD
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;stat
op_eq
id|TBS_MORE
)paren
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_TN3270_CONSOLE
r_if
c_cond
(paren
id|CONSOLE_IS_3270
op_logical_and
id|tub3270_con_tubp
op_eq
id|tubp
)paren
id|tub3270_con_copy
c_func
(paren
id|tubp
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_TN3270_CONSOLE */
r_if
c_cond
(paren
id|tubp-&gt;tty_bcb.bc_cnt
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;intv
op_ne
id|tty3270_int
)paren
r_return
l_int|0
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_UPDLOG
suffix:semicolon
r_return
id|tty3270_build
c_func
(paren
id|tubp
)paren
suffix:semicolon
)brace
multiline_comment|/* tty3270 utility functions */
r_static
r_void
DECL|function|tty3270_start_input
id|tty3270_start_input
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
id|tubp-&gt;ttyccw.cda
op_assign
id|virt_to_phys
c_func
(paren
op_amp
id|tubp-&gt;tty_input
)paren
suffix:semicolon
id|tubp-&gt;ttyccw.cmd_code
op_assign
id|TC_READMOD
suffix:semicolon
id|tubp-&gt;ttyccw.count
op_assign
id|GEOM_INPLEN
suffix:semicolon
id|tubp-&gt;ttyccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|tty3270_io
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tubp-&gt;flags
op_or_assign
id|TUB_IACTIVE
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_do_input
id|tty3270_do_input
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
r_int
id|count
suffix:semicolon
r_char
op_star
id|in
suffix:semicolon
r_int
id|aidflags
suffix:semicolon
r_char
op_star
id|aidstring
suffix:semicolon
id|count
op_assign
id|GEOM_INPLEN
op_minus
id|tubp-&gt;cswl
suffix:semicolon
id|in
op_assign
id|tubp-&gt;tty_input
suffix:semicolon
id|tty3270_aid_get
c_func
(paren
id|tubp
comma
id|in
(braket
l_int|0
)braket
comma
op_amp
id|aidflags
comma
op_amp
id|aidstring
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aidflags
op_amp
id|TA_CLEARKEY
)paren
(brace
id|tubp-&gt;stat
op_assign
id|TBS_RUNNING
suffix:semicolon
id|tty3270_scl_resettimer
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_UPDATE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|aidflags
op_amp
id|TA_CLEARLOG
)paren
(brace
id|tubp-&gt;stat
op_assign
id|TBS_RUNNING
suffix:semicolon
id|tty3270_scl_resettimer
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_CLRUPDLOG
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|aidflags
op_amp
id|TA_DOENTER
)paren
(brace
r_if
c_cond
(paren
id|count
op_le
l_int|6
)paren
(brace
r_switch
c_cond
(paren
id|tubp-&gt;stat
)paren
(brace
r_case
id|TBS_MORE
suffix:colon
id|tubp-&gt;stat
op_assign
id|TBS_HOLD
suffix:semicolon
id|tty3270_scl_resettimer
c_func
(paren
id|tubp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TBS_HOLD
suffix:colon
id|tubp-&gt;stat
op_assign
id|TBS_MORE
suffix:semicolon
id|tty3270_scl_settimer
c_func
(paren
id|tubp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TBS_RUNNING
suffix:colon
id|tty3270_do_enter
c_func
(paren
id|tubp
comma
id|in
op_plus
l_int|6
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tubp-&gt;cmd
op_assign
id|TBC_UPDSTAT
suffix:semicolon
r_goto
id|do_build
suffix:semicolon
)brace
id|in
op_add_assign
l_int|6
suffix:semicolon
id|count
op_sub_assign
l_int|6
suffix:semicolon
id|TUB_EBCASC
c_func
(paren
id|in
comma
id|count
)paren
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_CLRINPUT
suffix:semicolon
id|tty3270_do_enter
c_func
(paren
id|tubp
comma
id|in
comma
id|count
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|aidflags
op_amp
id|TA_DOSTRING
)paren
op_ne
l_int|0
op_logical_and
id|aidstring
op_ne
l_int|NULL
)paren
(brace
id|tubp-&gt;cmd
op_assign
id|TBC_KRUPDLOG
suffix:semicolon
id|tty3270_do_enter
c_func
(paren
id|tubp
comma
id|aidstring
comma
id|strlen
c_func
(paren
id|aidstring
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|aidflags
op_amp
id|TA_DOSTRINGD
)paren
op_ne
l_int|0
op_logical_and
id|aidstring
op_ne
l_int|NULL
)paren
(brace
id|tty3270_do_showi
c_func
(paren
id|tubp
comma
id|aidstring
comma
id|strlen
c_func
(paren
id|aidstring
)paren
)paren
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_UPDINPUT
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|in
(braket
l_int|0
)braket
op_ne
l_int|0x60
)paren
id|tubp-&gt;flags
op_or_assign
id|TUB_ALARM
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_KRUPDLOG
suffix:semicolon
)brace
id|do_build
suffix:colon
id|tty3270_build
c_func
(paren
id|tubp
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_do_enter
id|tty3270_do_enter
c_func
(paren
id|tub_t
op_star
id|tubp
comma
r_char
op_star
id|cp
comma
r_int
id|count
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|func
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty
op_assign
id|tubp-&gt;tty
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|2
op_logical_and
(paren
id|cp
(braket
l_int|0
)braket
op_eq
l_char|&squot;^&squot;
op_logical_or
id|cp
(braket
l_int|0
)braket
op_eq
l_char|&squot;&bslash;252&squot;
)paren
)paren
(brace
r_switch
c_cond
(paren
id|cp
(braket
l_int|1
)braket
)paren
(brace
r_case
l_char|&squot;c&squot;
suffix:colon
r_case
l_char|&squot;C&squot;
suffix:colon
id|func
op_assign
id|INTR_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;d&squot;
suffix:colon
r_case
l_char|&squot;D&squot;
suffix:colon
id|func
op_assign
id|EOF_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;z&squot;
suffix:colon
r_case
l_char|&squot;Z&squot;
suffix:colon
id|func
op_assign
id|SUSP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|count
op_eq
l_int|2
op_logical_and
id|cp
(braket
l_int|0
)braket
op_eq
l_int|0x1b
)paren
(brace
multiline_comment|/* if ESC */
r_int
id|inc
op_assign
l_int|0
suffix:semicolon
r_char
id|buf
(braket
id|GEOM_INPLEN
op_plus
l_int|1
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
r_switch
c_cond
(paren
id|cp
(braket
l_int|1
)braket
)paren
(brace
r_case
l_char|&squot;k&squot;
suffix:colon
r_case
l_char|&squot;K&squot;
suffix:colon
id|inc
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;j&squot;
suffix:colon
r_case
l_char|&squot;J&squot;
suffix:colon
id|inc
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inc
op_eq
l_int|0
)paren
r_goto
id|not_rcl
suffix:semicolon
id|len
op_assign
id|tty3270_rcl_get
c_func
(paren
id|tubp
comma
id|buf
comma
r_sizeof
id|buf
comma
id|inc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
id|tubp-&gt;flags
op_or_assign
id|TUB_ALARM
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tty3270_do_showi
c_func
(paren
id|tubp
comma
id|buf
comma
id|len
)paren
suffix:semicolon
id|tubp-&gt;cmd
op_assign
id|TBC_UPDINPUT
suffix:semicolon
r_return
suffix:semicolon
)brace
id|not_rcl
suffix:colon
r_if
c_cond
(paren
id|func
op_ne
op_minus
l_int|1
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_NORMAL
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|func
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
r_else
(brace
id|tty3270_rcl_put
c_func
(paren
id|tubp
comma
id|cp
comma
id|count
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tty-&gt;flip.char_buf_ptr
comma
id|cp
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* Add newline unless line ends with &quot;^n&quot; */
r_if
c_cond
(paren
id|count
OL
l_int|2
op_logical_or
id|cp
(braket
id|count
op_minus
l_int|1
)braket
op_ne
l_char|&squot;n&squot;
op_logical_or
(paren
id|cp
(braket
id|count
op_minus
l_int|2
)braket
op_ne
l_char|&squot;^&squot;
op_logical_and
id|cp
(braket
id|count
op_minus
l_int|2
)braket
op_ne
l_char|&squot;&bslash;252&squot;
)paren
)paren
(brace
id|tty-&gt;flip.char_buf_ptr
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|count
op_increment
suffix:semicolon
)brace
r_else
(brace
id|count
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* Lop trailing &quot;^n&quot; from text */
)brace
id|memset
c_func
(paren
id|tty-&gt;flip.flag_buf_ptr
comma
id|TTY_NORMAL
comma
id|count
)paren
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.count
op_add_assign
id|count
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_do_showi
id|tty3270_do_showi
c_func
(paren
id|tub_t
op_star
id|tubp
comma
r_char
op_star
id|cp
comma
r_int
id|cl
)paren
(brace
r_if
c_cond
(paren
id|cl
OG
id|GEOM_INPLEN
)paren
id|cl
op_assign
id|GEOM_INPLEN
suffix:semicolon
id|memset
c_func
(paren
id|tubp-&gt;tty_input
comma
l_int|0
comma
id|GEOM_INPLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|tubp-&gt;tty_input
comma
id|cp
comma
id|cl
)paren
suffix:semicolon
id|TUB_ASCEBC
c_func
(paren
id|tubp-&gt;tty_input
comma
id|cl
)paren
suffix:semicolon
)brace
multiline_comment|/* Debugging routine */
r_static
r_int
DECL|function|tty3270_show_tube
id|tty3270_show_tube
c_func
(paren
r_int
id|minor
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|tub_t
op_star
id|tubp
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_struct
id|termios
op_star
id|mp
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/*012345678901234567890123456789012345678901234567890123456789       */
multiline_comment|/*Info for tub_t[dd] at xxxxxxxx:                                    */
multiline_comment|/*    geom:  rows=dd cols=dd model=d                                 */
multiline_comment|/*    lnopen=dd     fsopen=dd   waitq=xxxxxxxx                       */
multiline_comment|/*    dstat=xx      mode=dd     stat=dd     flags=xxxx               */
multiline_comment|/*    oucount=dddd  ourd=ddddd  ouwr=ddddd  nextlogx=ddddd           */
multiline_comment|/*    tty=xxxxxxxx                                                   */
multiline_comment|/*    write_wait=xxxxxxxx read_wait=xxxxxxxx                         */
multiline_comment|/*    iflag=xxxxxxxx oflag=xxxxxxxx cflag=xxxxxxxx lflag=xxxxxxxx    */
r_if
c_cond
(paren
id|minor
template_param
id|tubnummins
op_logical_or
(paren
id|tubp
op_assign
(paren
op_star
id|tubminors
)paren
(braket
id|minor
)braket
)paren
op_eq
l_int|NULL
)paren
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;No tube at index=%d&bslash;n&quot;
comma
id|minor
)paren
suffix:semicolon
id|tty
op_assign
id|tubp-&gt;tty
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;Info for tub_t[%d] at %p:&bslash;n&quot;
comma
id|minor
comma
id|tubp
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;inattr is at %p&bslash;n&quot;
comma
op_amp
id|tubp-&gt;tty_inattr
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    geom:  rows=%.2d cols=%.2d model=%.1d&bslash;n&quot;
comma
id|tubp-&gt;geom_rows
comma
id|tubp-&gt;geom_cols
comma
id|tubp-&gt;tubiocb.model
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    lnopen=%-2d     fsopen=%-2d   waitq=%p&bslash;n&quot;
comma
id|tubp-&gt;lnopen
comma
id|tubp-&gt;fsopen
comma
op_amp
id|tubp-&gt;waitq
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    dstat=%.2x      mode=%-2d     &quot;
l_string|&quot;stat=%-2d     flags=%-4x&bslash;n&quot;
comma
id|tubp-&gt;dstat
comma
id|tubp-&gt;mode
comma
id|tubp-&gt;stat
comma
id|tubp-&gt;flags
)paren
suffix:semicolon
macro_line|#ifdef RBH_FIXTHIS
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    oucount=%-4d  ourd=%-5d  ouwr=%-5d&quot;
l_string|&quot;  nextlogx=%-5d&bslash;n&quot;
comma
id|tubp-&gt;tty_oucount
comma
id|tubp-&gt;tty_ourd
comma
id|tubp-&gt;tty_ouwr
comma
id|tubp-&gt;tty_nextlogx
)paren
suffix:semicolon
macro_line|#endif
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    tty=%p&bslash;n&quot;
comma
id|tubp-&gt;tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    write_wait=%p read_wait=%p&bslash;n&quot;
comma
op_amp
id|tty-&gt;write_wait
comma
op_amp
id|tty-&gt;read_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_logical_and
(paren
(paren
id|mp
op_assign
id|tty-&gt;termios
)paren
)paren
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|len
comma
l_string|&quot;    iflag=%.8x oflag=%.8x &quot;
l_string|&quot;cflag=%.8x lflag=%.8x&bslash;n&quot;
comma
id|mp-&gt;c_iflag
comma
id|mp-&gt;c_oflag
comma
id|mp-&gt;c_cflag
comma
id|mp-&gt;c_lflag
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
eof
