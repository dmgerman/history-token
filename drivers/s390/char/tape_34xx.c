multiline_comment|/*&n; *  drivers/s390/char/tape_34xx.c&n; *    tape device discipline for 3480/3490 tapes.&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001,2002 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *&t;&t; Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&t;&t; Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/bio.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &quot;tape.h&quot;
macro_line|#include &quot;tape_std.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;TAPE_34XX: &quot;
DECL|enum|tape_34xx_type
r_enum
id|tape_34xx_type
(brace
DECL|enumerator|tape_3480
id|tape_3480
comma
DECL|enumerator|tape_3490
id|tape_3490
comma
)brace
suffix:semicolon
DECL|macro|TAPE34XX_FMT_3480
mdefine_line|#define TAPE34XX_FMT_3480&t;0
DECL|macro|TAPE34XX_FMT_3480_2_XF
mdefine_line|#define TAPE34XX_FMT_3480_2_XF&t;1
DECL|macro|TAPE34XX_FMT_3480_XF
mdefine_line|#define TAPE34XX_FMT_3480_XF&t;2
DECL|struct|tape_34xx_block_id
r_struct
id|tape_34xx_block_id
(brace
DECL|member|wrap
r_int
r_int
id|wrap
suffix:colon
l_int|1
suffix:semicolon
DECL|member|segment
r_int
r_int
id|segment
suffix:colon
l_int|7
suffix:semicolon
DECL|member|format
r_int
r_int
id|format
suffix:colon
l_int|2
suffix:semicolon
DECL|member|block
r_int
r_int
id|block
suffix:colon
l_int|22
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * A list of block ID&squot;s is used to faster seek blocks.&n; */
DECL|struct|tape_34xx_sbid
r_struct
id|tape_34xx_sbid
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|bid
r_struct
id|tape_34xx_block_id
id|bid
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|tape_34xx_delete_sbid_from
c_func
(paren
r_struct
id|tape_device
op_star
comma
r_int
)paren
suffix:semicolon
multiline_comment|/*&n; * Medium sense for 34xx tapes. There is no &squot;real&squot; medium sense call.&n; * So we just do a normal sense.&n; */
r_static
r_int
DECL|function|tape_34xx_medium_sense
id|tape_34xx_medium_sense
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_int
r_char
op_star
id|sense
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|1
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|6
comma
l_string|&quot;MSEN fail&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
id|request-&gt;op
op_assign
id|TO_MSEN
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
comma
id|SENSE
comma
l_int|32
comma
id|request-&gt;cpdata
)paren
suffix:semicolon
id|rc
op_assign
id|tape_do_io_interruptible
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;rc
op_eq
l_int|0
)paren
(brace
id|sense
op_assign
id|request-&gt;cpdata
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This isn&squot;t quite correct. But since INTERVENTION_REQUIRED&n;&t;&t; * means that the drive is &squot;neither ready nor on-line&squot; it is&n;&t;&t; * only slightly inaccurate to say there is no tape loaded if&n;&t;&t; * the drive isn&squot;t online...&n;&t;&t; */
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_INTERVENTION_REQUIRED
)paren
id|tape_med_state_set
c_func
(paren
id|device
comma
id|MS_UNLOADED
)paren
suffix:semicolon
r_else
id|tape_med_state_set
c_func
(paren
id|device
comma
id|MS_LOADED
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_WRITE_PROTECT
)paren
id|device-&gt;tape_generic_status
op_or_assign
id|GMT_WR_PROT
c_func
(paren
op_complement
l_int|0
)paren
suffix:semicolon
r_else
id|device-&gt;tape_generic_status
op_and_assign
op_complement
id|GMT_WR_PROT
c_func
(paren
op_complement
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBF_EVENT
c_func
(paren
l_int|4
comma
l_string|&quot;tape_34xx: medium sense failed with rc=%d&bslash;n&quot;
comma
id|request-&gt;rc
)paren
suffix:semicolon
)brace
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * These functions are currently used only to schedule a medium_sense for&n; * later execution. This is because we get an interrupt whenever a medium&n; * is inserted but cannot call tape_do_io* from an interrupt context.&n; * Maybe that&squot;s useful for other actions we want to start from the&n; * interrupt handler.&n; */
r_static
r_void
DECL|function|tape_34xx_work_handler
id|tape_34xx_work_handler
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
r_enum
id|tape_op
id|op
suffix:semicolon
r_struct
id|work_struct
id|work
suffix:semicolon
)brace
op_star
id|p
op_assign
id|data
suffix:semicolon
r_switch
c_cond
(paren
id|p-&gt;op
)paren
(brace
r_case
id|TO_MSEN
suffix:colon
id|tape_34xx_medium_sense
c_func
(paren
id|p-&gt;device
)paren
suffix:semicolon
r_default
suffix:colon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;T34XX: internal error: unknown work&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|p-&gt;device
op_assign
id|tape_put_device
c_func
(paren
id|p-&gt;device
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tape_34xx_schedule_work
id|tape_34xx_schedule_work
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_enum
id|tape_op
id|op
)paren
(brace
r_struct
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
r_enum
id|tape_op
id|op
suffix:semicolon
r_struct
id|work_struct
id|work
suffix:semicolon
)brace
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|p
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|p-&gt;work
comma
id|tape_34xx_work_handler
comma
id|p
)paren
suffix:semicolon
id|p-&gt;device
op_assign
id|tape_get_device_reference
c_func
(paren
id|device
)paren
suffix:semicolon
id|p-&gt;op
op_assign
id|op
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|p-&gt;work
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Done Handler is called when dev stat = DEVICE-END (successful operation)&n; */
r_static
r_inline
r_int
DECL|function|tape_34xx_done
id|tape_34xx_done
c_func
(paren
r_struct
id|tape_request
op_star
id|request
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;%s done&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|request-&gt;op
)paren
(brace
r_case
id|TO_DSE
suffix:colon
r_case
id|TO_RUN
suffix:colon
r_case
id|TO_WRI
suffix:colon
r_case
id|TO_WTM
suffix:colon
r_case
id|TO_ASSIGN
suffix:colon
r_case
id|TO_UNASSIGN
suffix:colon
id|tape_34xx_delete_sbid_from
c_func
(paren
id|request-&gt;device
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
suffix:semicolon
)brace
r_return
id|TAPE_IO_SUCCESS
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|tape_34xx_erp_failed
id|tape_34xx_erp_failed
c_func
(paren
r_struct
id|tape_request
op_star
id|request
comma
r_int
id|rc
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;Error recovery failed for %s (RC=%d)&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|tape_34xx_erp_succeeded
id|tape_34xx_erp_succeeded
c_func
(paren
r_struct
id|tape_request
op_star
id|request
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;Error Recovery successful for %s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
)paren
suffix:semicolon
r_return
id|tape_34xx_done
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|tape_34xx_erp_retry
id|tape_34xx_erp_retry
c_func
(paren
r_struct
id|tape_request
op_star
id|request
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;xerp retr %s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
)paren
suffix:semicolon
r_return
id|TAPE_IO_RETRY
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called, when no request is outstanding and we get an&n; * interrupt&n; */
r_static
r_int
DECL|function|tape_34xx_unsolicited_irq
id|tape_34xx_unsolicited_irq
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_eq
l_int|0x85
multiline_comment|/* READY */
)paren
(brace
multiline_comment|/* A medium was inserted in the drive. */
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;xuud med&bslash;n&quot;
)paren
suffix:semicolon
id|tape_34xx_delete_sbid_from
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
id|tape_34xx_schedule_work
c_func
(paren
id|device
comma
id|TO_MSEN
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;unsol.irq! dev end: %08x&bslash;n&quot;
comma
id|device-&gt;cdev_id
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Unsolicited IRQ (Device End) caught.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
c_func
(paren
id|device
comma
l_int|NULL
comma
id|irb
)paren
suffix:semicolon
)brace
r_return
id|TAPE_IO_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * Read Opposite Error Recovery Function:&n; * Used, when Read Forward does not work&n; */
r_static
r_int
DECL|function|tape_34xx_erp_read_opposite
id|tape_34xx_erp_read_opposite
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
)paren
(brace
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_RFO
)paren
(brace
multiline_comment|/*&n;&t;&t; * We did read forward, but the data could not be read&n;&t;&t; * *correctly*. We transform the request to a read backward&n;&t;&t; * and try again.&n;&t;&t; */
id|tape_std_read_backward
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request-&gt;op
op_ne
id|TO_RBA
)paren
id|PRINT_ERR
c_func
(paren
l_string|&quot;read_opposite called with state:%s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We tried to read forward and backward, but hat no&n;&t; * success -&gt; failed.&n;&t; */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tape_34xx_erp_bug
id|tape_34xx_erp_bug
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
comma
r_struct
id|irb
op_star
id|irb
comma
r_int
id|no
)paren
(brace
r_if
c_cond
(paren
id|request-&gt;op
op_ne
id|TO_ASSIGN
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;An unexpected condition #%d was caught in &quot;
l_string|&quot;tape error recovery.&bslash;n&quot;
comma
id|no
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Please report this incident.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request
)paren
id|PRINT_WARN
c_func
(paren
l_string|&quot;Operation of tape:%s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
)paren
suffix:semicolon
id|tape_dump_sense
c_func
(paren
id|device
comma
id|request
comma
id|irb
)paren
suffix:semicolon
)brace
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle data overrun between cu and drive. The channel speed might&n; * be too slow.&n; */
r_static
r_int
DECL|function|tape_34xx_erp_overrun
id|tape_34xx_erp_overrun
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_if
c_cond
(paren
id|irb-&gt;ecw
(braket
l_int|3
)braket
op_eq
l_int|0x40
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Data overrun error between control-unit &quot;
l_string|&quot;and drive. Use a faster channel connection, &quot;
l_string|&quot;if possible! &bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handle record sequence error.&n; */
r_static
r_int
DECL|function|tape_34xx_erp_sequence
id|tape_34xx_erp_sequence
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_if
c_cond
(paren
id|irb-&gt;ecw
(braket
l_int|3
)braket
op_eq
l_int|0x41
)paren
(brace
multiline_comment|/*&n;&t;&t; * cu detected incorrect block-id sequence on tape.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Illegal block-id sequence found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Record sequence error bit is set, but erpa does not&n;&t; * show record sequence error.&n;&t; */
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
op_minus
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function analyses the tape&squot;s sense-data in case of a unit-check.&n; * If possible, it tries to recover from the error. Else the user is&n; * informed about the problem.&n; */
r_static
r_int
DECL|function|tape_34xx_unit_check
id|tape_34xx_unit_check
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_int
id|inhibit_cu_recovery
suffix:semicolon
id|__u8
op_star
id|sense
suffix:semicolon
id|inhibit_cu_recovery
op_assign
(paren
op_star
id|device-&gt;modeset_byte
op_amp
l_int|0x80
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|sense
op_assign
id|irb-&gt;ecw
suffix:semicolon
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_BLOCK
)paren
(brace
multiline_comment|/*&n;&t;&t; * Recovery for block device requests. Set the block_position&n;&t;&t; * to something invalid and retry.&n;&t;&t; */
id|device-&gt;blk_data.block_position
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;retries
op_decrement
op_le
l_int|0
)paren
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_else
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_COMMAND_REJECT
op_logical_and
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_WRITE_PROTECT
)paren
(brace
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_DSE
op_logical_or
id|request-&gt;op
op_eq
id|TO_WRI
op_logical_or
id|request-&gt;op
op_eq
id|TO_WTM
)paren
(brace
multiline_comment|/* medium is write protected */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EACCES
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
op_minus
l_int|3
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Special cases for various tape-states when reaching&n;&t; * end of recorded area&n;&t; *&n;&t; * FIXME: Maybe a special case of the special case:&n;&t; *        sense[0] == SENSE_EQUIPMENT_CHECK &amp;&amp;&n;&t; *        sense[1] == SENSE_DRIVE_ONLINE    &amp;&amp;&n;&t; *        sense[3] == 0x47 (Volume Fenced)&n;&t; *&n;&t; *        This was caused by continued FSF or FSR after an&n;&t; *        &squot;End Of Data&squot;.&n;&t; */
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_eq
id|SENSE_DATA_CHECK
op_logical_or
id|sense
(braket
l_int|0
)braket
op_eq
id|SENSE_EQUIPMENT_CHECK
op_logical_or
id|sense
(braket
l_int|0
)braket
op_eq
id|SENSE_EQUIPMENT_CHECK
op_plus
id|SENSE_DEFERRED_UNIT_CHECK
)paren
op_logical_and
(paren
id|sense
(braket
l_int|1
)braket
op_eq
id|SENSE_DRIVE_ONLINE
op_logical_or
id|sense
(braket
l_int|1
)braket
op_eq
id|SENSE_BEGINNING_OF_TAPE
op_plus
id|SENSE_WRITE_MODE
)paren
)paren
(brace
r_switch
c_cond
(paren
id|request-&gt;op
)paren
(brace
multiline_comment|/*&n;&t;&t; * sense[0] == SENSE_DATA_CHECK   &amp;&amp;&n;&t;&t; * sense[1] == SENSE_DRIVE_ONLINE&n;&t;&t; * sense[3] == 0x36 (End Of Data)&n;&t;&t; *&n;&t;&t; * Further seeks might return a &squot;Volume Fenced&squot;.&n;&t;&t; */
r_case
id|TO_FSF
suffix:colon
r_case
id|TO_FSB
suffix:colon
multiline_comment|/* Trying to seek beyond end of recorded area */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_case
id|TO_BSB
suffix:colon
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * sense[0] == SENSE_DATA_CHECK   &amp;&amp;&n;&t;&t; * sense[1] == SENSE_DRIVE_ONLINE &amp;&amp;&n;&t;&t; * sense[3] == 0x36 (End Of Data)&n;&t;&t; */
r_case
id|TO_LBL
suffix:colon
multiline_comment|/* Block could not be located. */
id|tape_34xx_delete_sbid_from
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
id|TO_RFO
suffix:colon
multiline_comment|/* Read beyond end of recorded area -&gt; 0 bytes read */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * sense[0] == SENSE_EQUIPMENT_CHECK &amp;&amp;&n;&t;&t; * sense[1] == SENSE_DRIVE_ONLINE    &amp;&amp;&n;&t;&t; * sense[3] == 0x38 (Physical End Of Volume)&n;&t;&t; */
r_case
id|TO_WRI
suffix:colon
multiline_comment|/* Writing at physical end of volume */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_default
suffix:colon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Invalid op in %s:%i&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Sensing special bits */
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_BUS_OUT_CHECK
)paren
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_DATA_CHECK
)paren
(brace
multiline_comment|/*&n;&t;&t; * hardware failure, damaged tape or improper&n;&t;&t; * operating conditions&n;&t;&t; */
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x23
suffix:colon
multiline_comment|/* a read data check occurred */
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SENSE_TAPE_SYNC_MODE
)paren
op_logical_or
id|inhibit_cu_recovery
)paren
singleline_comment|// data check is not permanent, may be
singleline_comment|// recovered. We always use async-mode with
singleline_comment|// cu-recovery, so this should *never* happen.
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
op_minus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* data check is permanent, CU recovery has failed */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Permanent read error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x25
suffix:colon
singleline_comment|// a write data check occurred
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SENSE_TAPE_SYNC_MODE
)paren
op_logical_or
id|inhibit_cu_recovery
)paren
singleline_comment|// data check is not permanent, may be
singleline_comment|// recovered. We always use async-mode with
singleline_comment|// cu-recovery, so this should *never* happen.
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
op_minus
l_int|5
)paren
suffix:semicolon
singleline_comment|// data check is permanent, cu-recovery has failed
id|PRINT_WARN
c_func
(paren
l_string|&quot;Permanent write error&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x26
suffix:colon
multiline_comment|/* Data Check (read opposite) occurred. */
r_return
id|tape_34xx_erp_read_opposite
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_case
l_int|0x28
suffix:colon
multiline_comment|/* ID-Mark at tape start couldn&squot;t be written */
id|PRINT_WARN
c_func
(paren
l_string|&quot;ID-Mark could not be written.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x31
suffix:colon
multiline_comment|/* Tape void. Tried to read beyond end of device. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Read beyond end of recorded area.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_case
l_int|0x41
suffix:colon
multiline_comment|/* Record sequence error. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Invalid block-id sequence found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* all data checks for 3480 should result in one of&n;&t;&t;&t; * the above erpa-codes. For 3490, other data-check&n;&t;&t;&t; * conditions do exist. */
r_if
c_cond
(paren
id|device-&gt;cdev-&gt;id.driver_info
op_eq
id|tape_3480
)paren
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
op_minus
l_int|6
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_OVERRUN
)paren
r_return
id|tape_34xx_erp_overrun
c_func
(paren
id|device
comma
id|request
comma
id|irb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_RECORD_SEQUENCE_ERR
)paren
r_return
id|tape_34xx_erp_sequence
c_func
(paren
id|device
comma
id|request
comma
id|irb
)paren
suffix:semicolon
multiline_comment|/* Sensing erpa codes */
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* Unit check with erpa code 0. Report and ignore. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Non-error sense was found. &quot;
l_string|&quot;Unit-check will be ignored.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|TAPE_IO_SUCCESS
suffix:semicolon
r_case
l_int|0x21
suffix:colon
multiline_comment|/*&n;&t;&t; * Data streaming not operational. CU will switch to&n;&t;&t; * interlock mode. Reissue the command.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Data streaming not operational. &quot;
l_string|&quot;Switching to interlock-mode.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x22
suffix:colon
multiline_comment|/*&n;&t;&t; * Path equipment check. Might be drive adapter error, buffer&n;&t;&t; * error on the lower interface, internal path not usable,&n;&t;&t; * or error during cartridge load.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;A path equipment check occurred. One of the &quot;
l_string|&quot;following conditions occurred:&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;drive adapter error, buffer error on the lower &quot;
l_string|&quot;interface, internal path not usable, error &quot;
l_string|&quot;during cartridge load.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x24
suffix:colon
multiline_comment|/*&n;&t;&t; * Load display check. Load display was command was issued,&n;&t;&t; * but the drive is displaying a drive check message. Can&n;&t;&t; * be threated as &quot;device end&quot;.&n;&t;&t; */
r_return
id|tape_34xx_erp_succeeded
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x27
suffix:colon
multiline_comment|/*&n;&t;&t; * Command reject. May indicate illegal channel program or&n;&t;&t; * buffer over/underrun. Since all channel programs are&n;&t;&t; * issued by this driver and ought be correct, we assume a&n;&t;&t; * over/underrun situation and retry the channel program.&n;&t;&t; */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x29
suffix:colon
multiline_comment|/*&n;&t;&t; * Function incompatible. Either the tape is idrc compressed&n;&t;&t; * but the hardware isn&squot;t capable to do idrc, or a perform&n;&t;&t; * subsystem func is issued and the CU is not on-line.&n;&t;&t; */
id|PRINT_WARN
(paren
l_string|&quot;Function incompatible. Try to switch off idrc&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x2a
suffix:colon
multiline_comment|/*&n;&t;&t; * Unsolicited environmental data. An internal counter&n;&t;&t; * overflows, we can ignore this and reissue the cmd.&n;&t;&t; */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x2b
suffix:colon
multiline_comment|/*&n;&t;&t; * Environmental data present. Indicates either unload&n;&t;&t; * completed ok or read buffered log command completed ok.&n;&t;&t; */
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_RUN
)paren
(brace
multiline_comment|/* Rewind unload completed ok. */
id|tape_med_state_set
c_func
(paren
id|device
comma
id|MS_UNLOADED
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_succeeded
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/* tape_34xx doesn&squot;t use read buffered log commands. */
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_case
l_int|0x2c
suffix:colon
multiline_comment|/*&n;&t;&t; * Permanent equipment check. CU has tried recovery, but&n;&t;&t; * did not succeed.&n;&t;&t; */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x2d
suffix:colon
multiline_comment|/* Data security erase failure. */
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_DSE
)paren
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* Data security erase failure, but no such command issued. */
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_case
l_int|0x2e
suffix:colon
multiline_comment|/*&n;&t;&t; * Not capable. This indicates either that the drive fails&n;&t;&t; * reading the format id mark or that that format specified&n;&t;&t; * is not supported by the drive.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Drive not capable processing the tape format!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EMEDIUMTYPE
)paren
suffix:semicolon
r_case
l_int|0x30
suffix:colon
multiline_comment|/* The medium is write protected. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Medium is write protected!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EACCES
)paren
suffix:semicolon
r_case
l_int|0x32
suffix:colon
singleline_comment|// Tension loss. We cannot recover this, it&squot;s an I/O error.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive lost tape tension.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x33
suffix:colon
multiline_comment|/*&n;&t;&t; * Load Failure. The cartridge was not inserted correctly or&n;&t;&t; * the tape is not threaded correctly.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Cartridge load failure. Reload the cartridge &quot;
l_string|&quot;and try again.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_34xx_delete_sbid_from
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x34
suffix:colon
multiline_comment|/*&n;&t;&t; * Unload failure. The drive cannot maintain tape tension&n;&t;&t; * and control tape movement during an unload operation.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Failure during cartridge unload. &quot;
l_string|&quot;Please try manually.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_RUN
)paren
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_case
l_int|0x35
suffix:colon
multiline_comment|/*&n;&t;&t; * Drive equipment check. One of the following:&n;&t;&t; * - cu cannot recover from a drive detected error&n;&t;&t; * - a check code message is shown on drive display&n;&t;&t; * - the cartridge loader does not respond correctly&n;&t;&t; * - a failure occurs during an index, load, or unload cycle&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Equipment check! Please check the drive and &quot;
l_string|&quot;the cartridge loader.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x36
suffix:colon
r_if
c_cond
(paren
id|device-&gt;cdev-&gt;id.driver_info
op_eq
id|tape_3490
)paren
multiline_comment|/* End of data. */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
multiline_comment|/* This erpa is reserved for 3480 */
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_case
l_int|0x37
suffix:colon
multiline_comment|/*&n;&t;&t; * Tape length error. The tape is shorter than reported in&n;&t;&t; * the beginning-of-tape data.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape length error.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x38
suffix:colon
multiline_comment|/*&n;&t;&t; * Physical end of tape. A read/write operation reached&n;&t;&t; * the physical end of tape.&n;&t;&t; */
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_WRI
op_logical_or
id|request-&gt;op
op_eq
id|TO_DSE
op_logical_or
id|request-&gt;op
op_eq
id|TO_WTM
)paren
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x39
suffix:colon
multiline_comment|/* Backward at Beginning of tape. */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x3a
suffix:colon
multiline_comment|/* Drive switched to not ready. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Drive not ready. Turn the ready/not ready switch &quot;
l_string|&quot;to ready position and try again.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x3b
suffix:colon
multiline_comment|/* Manual rewind or unload. This causes an I/O error. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Medium was rewound or unloaded manually.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_34xx_delete_sbid_from
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x42
suffix:colon
multiline_comment|/*&n;&t;&t; * Degraded mode. A condition that can cause degraded&n;&t;&t; * performance is detected.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Subsystem is running in degraded mode.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x43
suffix:colon
multiline_comment|/* Drive not ready. */
id|tape_34xx_delete_sbid_from
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
id|tape_med_state_set
c_func
(paren
id|device
comma
id|MS_UNLOADED
)paren
suffix:semicolon
multiline_comment|/* Some commands commands are successful even in this case */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_DRIVE_ONLINE
)paren
(brace
r_switch
c_cond
(paren
id|request-&gt;op
)paren
(brace
r_case
id|TO_ASSIGN
suffix:colon
r_case
id|TO_UNASSIGN
suffix:colon
r_case
id|TO_DIS
suffix:colon
r_case
id|TO_NOP
suffix:colon
r_return
id|tape_34xx_done
c_func
(paren
id|request
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is not ready.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|ENOMEDIUM
)paren
suffix:semicolon
r_case
l_int|0x44
suffix:colon
multiline_comment|/* Locate Block unsuccessful. */
r_if
c_cond
(paren
id|request-&gt;op
op_ne
id|TO_BLOCK
op_logical_and
id|request-&gt;op
op_ne
id|TO_LBL
)paren
multiline_comment|/* No locate block was issued. */
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x45
suffix:colon
multiline_comment|/* The drive is assigned to a different channel path. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is assigned elsewhere.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x46
suffix:colon
multiline_comment|/*&n;&t;&t; * Drive not on-line. Drive may be switched offline,&n;&t;&t; * the power supply may be switched off or&n;&t;&t; * the drive address may not be set correctly.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is not on-line.&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x47
suffix:colon
multiline_comment|/* Volume fenced. CU reports volume integrity is lost. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Volume fenced. The volume integrity is lost.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_34xx_delete_sbid_from
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x48
suffix:colon
multiline_comment|/* Log sense data and retry request. */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x49
suffix:colon
multiline_comment|/* Bus out check. A parity check error on the bus was found. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Bus out check. A data transfer over the bus &quot;
l_string|&quot;has been corrupted.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x4a
suffix:colon
multiline_comment|/* Control unit erp failed. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;The control unit I/O error recovery failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x4b
suffix:colon
multiline_comment|/*&n;&t;&t; * CU and drive incompatible. The drive requests micro-program&n;&t;&t; * patches, which are not available on the CU.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive needs microprogram patches from the &quot;
l_string|&quot;control unit, which are not available.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x4c
suffix:colon
multiline_comment|/*&n;&t;&t; * Recovered Check-One failure. Cu develops a hardware error,&n;&t;&t; * but is able to recover.&n;&t;&t; */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x4d
suffix:colon
r_if
c_cond
(paren
id|device-&gt;cdev-&gt;id.driver_info
op_eq
id|tape_3490
)paren
multiline_comment|/*&n;&t;&t;&t; * Resetting event received. Since the driver does&n;&t;&t;&t; * not support resetting event recovery (which has to&n;&t;&t;&t; * be handled by the I/O Layer), retry our command.&n;&t;&t;&t; */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
multiline_comment|/* This erpa is reserved for 3480. */
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_case
l_int|0x4e
suffix:colon
r_if
c_cond
(paren
id|device-&gt;cdev-&gt;id.driver_info
op_eq
id|tape_3490
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Maximum block size exceeded. This indicates, that&n;&t;&t;&t; * the block to be written is larger than allowed for&n;&t;&t;&t; * buffered mode.&n;&t;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Maximum block size for buffered &quot;
l_string|&quot;mode exceeded.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|ENOBUFS
)paren
suffix:semicolon
)brace
multiline_comment|/* This erpa is reserved for 3480. */
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_case
l_int|0x50
suffix:colon
multiline_comment|/*&n;&t;&t; * Read buffered log (Overflow). CU is running in extended&n;&t;&t; * buffered log mode, and a counter overflows. This should&n;&t;&t; * never happen, since we&squot;re never running in extended&n;&t;&t; * buffered log mode.&n;&t;&t; */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x51
suffix:colon
multiline_comment|/*&n;&t;&t; * Read buffered log (EOV). EOF processing occurs while the&n;&t;&t; * CU is in extended buffered log mode. This should never&n;&t;&t; * happen, since we&squot;re never running in extended buffered&n;&t;&t; * log mode.&n;&t;&t; */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x52
suffix:colon
multiline_comment|/* End of Volume complete. Rewind unload completed ok. */
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_RUN
)paren
(brace
id|tape_med_state_set
c_func
(paren
id|device
comma
id|MS_UNLOADED
)paren
suffix:semicolon
id|tape_34xx_delete_sbid_from
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_succeeded
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_case
l_int|0x53
suffix:colon
multiline_comment|/* Global command intercept. */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x54
suffix:colon
multiline_comment|/* Channel interface recovery (temporary). */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
r_case
l_int|0x55
suffix:colon
multiline_comment|/* Channel interface recovery (permanent). */
id|PRINT_WARN
c_func
(paren
l_string|&quot;A permanent channel interface error occurred.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x56
suffix:colon
multiline_comment|/* Channel protocol error. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;A channel protocol error occurred.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x57
suffix:colon
r_if
c_cond
(paren
id|device-&gt;cdev-&gt;id.driver_info
op_eq
id|tape_3480
)paren
(brace
multiline_comment|/* Attention intercept. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;An attention intercept occurred, &quot;
l_string|&quot;which will be recovered.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Global status intercept. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;An global status intercept was received, &quot;
l_string|&quot;which will be recovered.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
r_case
l_int|0x5a
suffix:colon
multiline_comment|/*&n;&t;&t; * Tape length incompatible. The tape inserted is too long,&n;&t;&t; * which could cause damage to the tape or the drive.&n;&t;&t; */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape Length Incompatible&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape length exceeds IBM enhanced capacity &quot;
l_string|&quot;cartdridge length or a medium&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;with EC-CST identification mark has been mounted &quot;
l_string|&quot;in a device that writes&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;3480 or 3480 XF format.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x5b
suffix:colon
multiline_comment|/* Format 3480 XF incompatible */
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_BEGINNING_OF_TAPE
)paren
multiline_comment|/* The tape will get overwritten. */
r_return
id|tape_34xx_erp_retry
c_func
(paren
id|request
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Format 3480 XF Incompatible&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Medium has been created in 3480 format. &quot;
l_string|&quot;To change the format writes&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;must be issued at BOT.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x5c
suffix:colon
multiline_comment|/* Format 3480-2 XF incompatible */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Format 3480-2 XF Incompatible&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Device can only read 3480 or 3480 XF format.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EIO
)paren
suffix:semicolon
r_case
l_int|0x5d
suffix:colon
multiline_comment|/* Tape length violation. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape Length Violation&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;The mounted tape exceeds IBM Enhanced Capacity &quot;
l_string|&quot;Cartdridge System Tape length.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;This may cause damage to the drive or tape when &quot;
l_string|&quot;processing to the EOV&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EMEDIUMTYPE
)paren
suffix:semicolon
r_case
l_int|0x5e
suffix:colon
multiline_comment|/* Compaction algorithm incompatible. */
id|PRINT_WARN
c_func
(paren
l_string|&quot;Compaction Algorithm Incompatible&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;The volume is recorded using an incompatible &quot;
l_string|&quot;compaction algorithm,&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;which is not supported by the device.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|EMEDIUMTYPE
)paren
suffix:semicolon
multiline_comment|/* The following erpas should have been covered earlier. */
r_case
l_int|0x23
suffix:colon
multiline_comment|/* Read data check. */
r_case
l_int|0x25
suffix:colon
multiline_comment|/* Write data check. */
r_case
l_int|0x26
suffix:colon
multiline_comment|/* Data check (read opposite). */
r_case
l_int|0x28
suffix:colon
multiline_comment|/* Write id mark check. */
r_case
l_int|0x31
suffix:colon
multiline_comment|/* Tape void. */
r_case
l_int|0x40
suffix:colon
multiline_comment|/* Overrun error. */
r_case
l_int|0x41
suffix:colon
multiline_comment|/* Record sequence error. */
multiline_comment|/* All other erpas are reserved for future use. */
r_default
suffix:colon
r_return
id|tape_34xx_erp_bug
c_func
(paren
id|device
comma
id|request
comma
id|irb
comma
id|sense
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * 3480/3490 interrupt handler&n; */
r_static
r_int
DECL|function|tape_34xx_irq
id|tape_34xx_irq
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_if
c_cond
(paren
id|request
op_eq
l_int|NULL
)paren
r_return
id|tape_34xx_unsolicited_irq
c_func
(paren
id|device
comma
id|irb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_EXCEP
)paren
op_logical_and
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_DEV_END
)paren
op_logical_and
(paren
id|request-&gt;op
op_eq
id|TO_WRI
)paren
)paren
(brace
multiline_comment|/* Write at end of volume */
id|PRINT_INFO
c_func
(paren
l_string|&quot;End of volume&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX */
r_return
id|tape_34xx_erp_failed
c_func
(paren
id|request
comma
op_minus
id|ENOSPC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
r_return
id|tape_34xx_unit_check
c_func
(paren
id|device
comma
id|request
comma
id|irb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_DEV_END
)paren
(brace
multiline_comment|/*&n;&t;&t; * A unit exception occurs on skipping over a tapemark block.&n;&t;&t; */
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_EXCEP
)paren
(brace
r_if
c_cond
(paren
id|request-&gt;op
op_eq
id|TO_BSB
op_logical_or
id|request-&gt;op
op_eq
id|TO_FSB
)paren
id|request-&gt;rescnt
op_increment
suffix:semicolon
r_else
id|DBF_EVENT
c_func
(paren
l_int|5
comma
l_string|&quot;Unit Exception!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|tape_34xx_done
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;xunknownirq&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Unexpected interrupt.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Current op is: %s&quot;
comma
id|tape_op_verbose
(braket
id|request-&gt;op
)braket
)paren
suffix:semicolon
id|tape_dump_sense
c_func
(paren
id|device
comma
id|request
comma
id|irb
)paren
suffix:semicolon
r_return
id|TAPE_IO_STOP
suffix:semicolon
)brace
multiline_comment|/*&n; * ioctl_overload&n; */
r_static
r_int
DECL|function|tape_34xx_ioctl
id|tape_34xx_ioctl
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|TAPE390_DISPLAY
)paren
(brace
r_struct
id|display_struct
id|disp
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|disp
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|disp
)paren
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|tape_std_display
c_func
(paren
id|device
comma
op_amp
id|disp
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|tape_34xx_append_new_sbid
id|tape_34xx_append_new_sbid
c_func
(paren
r_struct
id|tape_34xx_block_id
id|bid
comma
r_struct
id|list_head
op_star
id|l
)paren
(brace
r_struct
id|tape_34xx_sbid
op_star
id|new_sbid
suffix:semicolon
id|new_sbid
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|new_sbid
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_sbid
)paren
r_return
suffix:semicolon
id|new_sbid-&gt;bid
op_assign
id|bid
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|new_sbid-&gt;list
comma
id|l
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Build up the search block ID list. The block ID consists of a logical&n; * block number and a hardware specific part. The hardware specific part&n; * helps the tape drive to speed up searching for a specific block.&n; */
r_static
r_void
DECL|function|tape_34xx_add_sbid
id|tape_34xx_add_sbid
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_34xx_block_id
id|bid
)paren
(brace
r_struct
id|list_head
op_star
id|sbid_list
suffix:semicolon
r_struct
id|tape_34xx_sbid
op_star
id|sbid
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
multiline_comment|/*&n;&t; * immediately return if there is no list at all or the block to add&n;&t; * is located in segment 1 of wrap 0 because this position is used&n;&t; * if no hardware position data is supplied.&n;&t; */
id|sbid_list
op_assign
(paren
r_struct
id|list_head
op_star
)paren
id|device-&gt;discdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbid_list
op_logical_or
(paren
id|bid.segment
OL
l_int|2
op_logical_and
id|bid.wrap
op_eq
l_int|0
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Search the position where to insert the new entry. Hardware&n;&t; * acceleration uses only the segment and wrap number. So we&n;&t; * need only one entry for a specific wrap/segment combination.&n;&t; * If there is a block with a lower number but the same hard-&n;&t; * ware position data we just update the block number in the&n;&t; * existing entry.&n;&t; */
id|list_for_each
c_func
(paren
id|l
comma
id|sbid_list
)paren
(brace
id|sbid
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|tape_34xx_sbid
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sbid-&gt;bid.segment
op_eq
id|bid.segment
)paren
op_logical_and
(paren
id|sbid-&gt;bid.wrap
op_eq
id|bid.wrap
)paren
)paren
(brace
r_if
c_cond
(paren
id|bid.block
OL
id|sbid-&gt;bid.block
)paren
id|sbid-&gt;bid
op_assign
id|bid
suffix:semicolon
r_else
r_return
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Sort in according to logical block number. */
r_if
c_cond
(paren
id|bid.block
OL
id|sbid-&gt;bid.block
)paren
(brace
id|tape_34xx_append_new_sbid
c_func
(paren
id|bid
comma
id|l-&gt;prev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* List empty or new block bigger than last entry. */
r_if
c_cond
(paren
id|l
op_eq
id|sbid_list
)paren
id|tape_34xx_append_new_sbid
c_func
(paren
id|bid
comma
id|l-&gt;prev
)paren
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|4
comma
l_string|&quot;Current list is:&bslash;n&quot;
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
id|sbid_list
)paren
(brace
id|sbid
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|tape_34xx_sbid
comma
id|list
)paren
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|4
comma
l_string|&quot;%d:%03d@%05d&bslash;n&quot;
comma
id|sbid-&gt;bid.wrap
comma
id|sbid-&gt;bid.segment
comma
id|sbid-&gt;bid.block
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Delete all entries from the search block ID list that belong to tape blocks&n; * equal or higher than the given number.&n; */
r_static
r_void
DECL|function|tape_34xx_delete_sbid_from
id|tape_34xx_delete_sbid_from
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|from
)paren
(brace
r_struct
id|list_head
op_star
id|sbid_list
suffix:semicolon
r_struct
id|tape_34xx_sbid
op_star
id|sbid
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|list_head
op_star
id|n
suffix:semicolon
id|sbid_list
op_assign
(paren
r_struct
id|list_head
op_star
)paren
id|device-&gt;discdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbid_list
)paren
r_return
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
id|sbid_list
)paren
(brace
id|sbid
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|tape_34xx_sbid
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbid-&gt;bid.block
op_ge
id|from
)paren
(brace
id|DBF_LH
c_func
(paren
l_int|4
comma
l_string|&quot;Delete sbid %d:%03d@%05d&bslash;n&quot;
comma
id|sbid-&gt;bid.wrap
comma
id|sbid-&gt;bid.segment
comma
id|sbid-&gt;bid.block
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|l
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sbid
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Merge hardware position data into a block id.&n; */
r_static
r_void
DECL|function|tape_34xx_merge_sbid
id|tape_34xx_merge_sbid
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_34xx_block_id
op_star
id|bid
)paren
(brace
r_struct
id|tape_34xx_sbid
op_star
id|sbid
suffix:semicolon
r_struct
id|tape_34xx_sbid
op_star
id|sbid_to_use
suffix:semicolon
r_struct
id|list_head
op_star
id|sbid_list
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|sbid_list
op_assign
(paren
r_struct
id|list_head
op_star
)paren
id|device-&gt;discdata
suffix:semicolon
id|bid-&gt;wrap
op_assign
l_int|0
suffix:semicolon
id|bid-&gt;segment
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbid_list
op_logical_or
id|list_empty
c_func
(paren
id|sbid_list
)paren
)paren
r_return
suffix:semicolon
id|sbid_to_use
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
id|sbid_list
)paren
(brace
id|sbid
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|tape_34xx_sbid
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbid-&gt;bid.block
op_ge
id|bid-&gt;block
)paren
r_break
suffix:semicolon
id|sbid_to_use
op_assign
id|sbid
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbid_to_use
)paren
(brace
id|bid-&gt;wrap
op_assign
id|sbid_to_use-&gt;bid.wrap
suffix:semicolon
id|bid-&gt;segment
op_assign
id|sbid_to_use-&gt;bid.segment
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|4
comma
l_string|&quot;Use %d:%03d@%05d for %05d&bslash;n&quot;
comma
id|sbid_to_use-&gt;bid.wrap
comma
id|sbid_to_use-&gt;bid.segment
comma
id|sbid_to_use-&gt;bid.block
comma
id|bid-&gt;block
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|tape_34xx_setup_device
id|tape_34xx_setup_device
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|list_head
op_star
id|discdata
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;34xx device setup&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tape_std_assign
c_func
(paren
id|device
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tape_34xx_medium_sense
c_func
(paren
id|device
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DBF_LH
c_func
(paren
l_int|3
comma
l_string|&quot;34xx medium sense returned %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
)brace
id|discdata
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|list_head
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|discdata
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
id|discdata
)paren
suffix:semicolon
id|device-&gt;discdata
op_assign
id|discdata
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|tape_34xx_cleanup_device
id|tape_34xx_cleanup_device
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
id|tape_std_unassign
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;discdata
)paren
(brace
id|tape_34xx_delete_sbid_from
c_func
(paren
id|device
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|device-&gt;discdata
)paren
suffix:semicolon
id|device-&gt;discdata
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * MTTELL: Tell block. Return the number of block relative to current file.&n; */
r_static
r_int
DECL|function|tape_34xx_mttell
id|tape_34xx_mttell
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
(brace
r_struct
id|tape_34xx_block_id
id|cbid
suffix:semicolon
r_struct
id|tape_34xx_block_id
id|dbid
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
id|block_id
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|tape_std_read_block_id
c_func
(paren
id|device
comma
(paren
id|__u64
op_star
)paren
op_amp
id|block_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|tape_34xx_add_sbid
c_func
(paren
id|device
comma
id|block_id.cbid
)paren
suffix:semicolon
r_return
id|block_id.cbid.block
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSEEK: seek to the specified block.&n; */
r_static
r_int
DECL|function|tape_34xx_mtseek
id|tape_34xx_mtseek
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|tape_34xx_block_id
op_star
id|bid
suffix:semicolon
r_if
c_cond
(paren
id|mt_count
OG
l_int|0x3fffff
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|6
comma
l_string|&quot;xsee parm&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|3
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
multiline_comment|/* setup ccws */
id|request-&gt;op
op_assign
id|TO_LBL
suffix:semicolon
id|bid
op_assign
(paren
r_struct
id|tape_34xx_block_id
op_star
)paren
id|request-&gt;cpdata
suffix:semicolon
id|bid-&gt;format
op_assign
(paren
op_star
id|device-&gt;modeset_byte
op_amp
l_int|0x08
)paren
ques
c_cond
id|TAPE34XX_FMT_3480_XF
suffix:colon
id|TAPE34XX_FMT_3480
suffix:semicolon
id|bid-&gt;block
op_assign
id|mt_count
suffix:semicolon
id|tape_34xx_merge_sbid
c_func
(paren
id|device
comma
id|bid
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|LOCATE
comma
l_int|4
comma
id|request-&gt;cpdata
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|2
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
multiline_comment|/*&n; * Tape block read for 34xx.&n; */
r_static
r_struct
id|tape_request
op_star
DECL|function|tape_34xx_bread
id|tape_34xx_bread
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|request
op_star
id|req
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_int
id|count
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_int
id|off
suffix:semicolon
r_char
op_star
id|dst
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bv
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
r_struct
id|tape_34xx_block_id
op_star
id|start_block
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;xBREDid:&quot;
)paren
suffix:semicolon
multiline_comment|/* Count the number of blocks for the request. */
id|rq_for_each_bio
c_func
(paren
id|bio
comma
id|req
)paren
(brace
id|bio_for_each_segment
c_func
(paren
id|bv
comma
id|bio
comma
id|i
)paren
(brace
id|count
op_add_assign
id|bv-&gt;bv_len
op_rshift
(paren
id|TAPEBLOCK_HSEC_S2B
op_plus
l_int|9
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Allocate the ccw request. */
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|3
op_plus
id|count
op_plus
l_int|1
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|request
suffix:semicolon
multiline_comment|/* Setup ccws. */
id|request-&gt;op
op_assign
id|TO_BLOCK
suffix:semicolon
id|start_block
op_assign
(paren
r_struct
id|tape_34xx_block_id
op_star
)paren
id|request-&gt;cpdata
suffix:semicolon
id|start_block-&gt;block
op_assign
id|req-&gt;sector
op_rshift
id|TAPEBLOCK_HSEC_S2B
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;start_block = %i&bslash;n&quot;
comma
id|start_block-&gt;block
)paren
suffix:semicolon
id|ccw
op_assign
id|request-&gt;cpaddr
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We always setup a nop after the mode set ccw. This slot is&n;&t; * used in tape_std_check_locate to insert a locate ccw if the&n;&t; * current tape position doesn&squot;t match the start block to be read.&n;&t; * The second nop will be filled with a read block id which is in&n;&t; * turn used by tape_34xx_free_bread to populate the segment bid&n;&t; * table.&n;&t; */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|rq_for_each_bio
c_func
(paren
id|bio
comma
id|req
)paren
(brace
id|bio_for_each_segment
c_func
(paren
id|bv
comma
id|bio
comma
id|i
)paren
(brace
id|dst
op_assign
id|kmap
c_func
(paren
id|bv-&gt;bv_page
)paren
op_plus
id|bv-&gt;bv_offset
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|bv-&gt;bv_len
suffix:semicolon
id|off
op_add_assign
id|TAPEBLOCK_HSEC_SIZE
)paren
(brace
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_FORWARD
suffix:semicolon
id|ccw-&gt;count
op_assign
id|TAPEBLOCK_HSEC_SIZE
suffix:semicolon
id|set_normalized_cda
c_func
(paren
id|ccw
comma
(paren
r_void
op_star
)paren
id|__pa
c_func
(paren
id|dst
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|dst
op_add_assign
id|TAPEBLOCK_HSEC_SIZE
suffix:semicolon
)brace
)brace
)brace
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;xBREDccwg&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|request
suffix:semicolon
)brace
r_static
r_void
DECL|function|tape_34xx_free_bread
id|tape_34xx_free_bread
(paren
r_struct
id|tape_request
op_star
id|request
)paren
(brace
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
id|ccw
op_assign
id|request-&gt;cpaddr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ccw
op_plus
l_int|2
)paren
op_member_access_from_pointer
id|cmd_code
op_eq
id|READ_BLOCK_ID
)paren
(brace
r_struct
(brace
r_struct
id|tape_34xx_block_id
id|cbid
suffix:semicolon
r_struct
id|tape_34xx_block_id
id|dbid
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
op_star
id|rbi_data
suffix:semicolon
id|rbi_data
op_assign
id|request-&gt;cpdata
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;device
)paren
id|tape_34xx_add_sbid
c_func
(paren
id|request-&gt;device
comma
id|rbi_data-&gt;cbid
)paren
suffix:semicolon
)brace
multiline_comment|/* Last ccw is a nop and doesn&squot;t need clear_normalized_cda */
r_for
c_loop
(paren
suffix:semicolon
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
)paren
r_if
c_cond
(paren
id|ccw-&gt;cmd_code
op_eq
id|READ_FORWARD
)paren
id|clear_normalized_cda
c_func
(paren
id|ccw
)paren
suffix:semicolon
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * check_locate is called just before the tape request is passed to&n; * the common io layer for execution. It has to check the current&n; * tape position and insert a locate ccw if it doesn&squot;t match the&n; * start block for the request.&n; */
r_static
r_void
DECL|function|tape_34xx_check_locate
id|tape_34xx_check_locate
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
)paren
(brace
r_struct
id|tape_34xx_block_id
op_star
id|start_block
suffix:semicolon
id|start_block
op_assign
(paren
r_struct
id|tape_34xx_block_id
op_star
)paren
id|request-&gt;cpdata
suffix:semicolon
r_if
c_cond
(paren
id|start_block-&gt;block
op_eq
id|device-&gt;blk_data.block_position
)paren
r_return
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|4
comma
l_string|&quot;Block seek(%06d+%06d)&bslash;n&quot;
comma
id|start_block-&gt;block
comma
id|device-&gt;bof
)paren
suffix:semicolon
id|start_block-&gt;wrap
op_assign
l_int|0
suffix:semicolon
id|start_block-&gt;segment
op_assign
l_int|1
suffix:semicolon
id|start_block-&gt;format
op_assign
(paren
op_star
id|device-&gt;modeset_byte
op_amp
l_int|0x08
)paren
ques
c_cond
id|TAPE34XX_FMT_3480_XF
suffix:colon
id|TAPE34XX_FMT_3480
suffix:semicolon
id|start_block-&gt;block
op_assign
id|start_block-&gt;block
op_plus
id|device-&gt;bof
suffix:semicolon
id|tape_34xx_merge_sbid
c_func
(paren
id|device
comma
id|start_block
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|LOCATE
comma
l_int|4
comma
id|request-&gt;cpdata
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|2
comma
id|READ_BLOCK_ID
comma
l_int|8
comma
id|request-&gt;cpdata
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * List of 3480/3490 magnetic tape commands.&n; */
DECL|variable|tape_34xx_mtop
r_static
id|tape_mtop_fn
id|tape_34xx_mtop
(braket
id|TAPE_NR_MTOPS
)braket
op_assign
(brace
(braket
id|MTRESET
)braket
op_assign
id|tape_std_mtreset
comma
(braket
id|MTFSF
)braket
op_assign
id|tape_std_mtfsf
comma
(braket
id|MTBSF
)braket
op_assign
id|tape_std_mtbsf
comma
(braket
id|MTFSR
)braket
op_assign
id|tape_std_mtfsr
comma
(braket
id|MTBSR
)braket
op_assign
id|tape_std_mtbsr
comma
(braket
id|MTWEOF
)braket
op_assign
id|tape_std_mtweof
comma
(braket
id|MTREW
)braket
op_assign
id|tape_std_mtrew
comma
(braket
id|MTOFFL
)braket
op_assign
id|tape_std_mtoffl
comma
(braket
id|MTNOP
)braket
op_assign
id|tape_std_mtnop
comma
(braket
id|MTRETEN
)braket
op_assign
id|tape_std_mtreten
comma
(braket
id|MTBSFM
)braket
op_assign
id|tape_std_mtbsfm
comma
(braket
id|MTFSFM
)braket
op_assign
id|tape_std_mtfsfm
comma
(braket
id|MTEOM
)braket
op_assign
id|tape_std_mteom
comma
(braket
id|MTERASE
)braket
op_assign
id|tape_std_mterase
comma
(braket
id|MTRAS1
)braket
op_assign
l_int|NULL
comma
(braket
id|MTRAS2
)braket
op_assign
l_int|NULL
comma
(braket
id|MTRAS3
)braket
op_assign
l_int|NULL
comma
(braket
id|MTSETBLK
)braket
op_assign
id|tape_std_mtsetblk
comma
(braket
id|MTSETDENSITY
)braket
op_assign
l_int|NULL
comma
(braket
id|MTSEEK
)braket
op_assign
id|tape_34xx_mtseek
comma
(braket
id|MTTELL
)braket
op_assign
id|tape_34xx_mttell
comma
(braket
id|MTSETDRVBUFFER
)braket
op_assign
l_int|NULL
comma
(braket
id|MTFSS
)braket
op_assign
l_int|NULL
comma
(braket
id|MTBSS
)braket
op_assign
l_int|NULL
comma
(braket
id|MTWSM
)braket
op_assign
l_int|NULL
comma
(braket
id|MTLOCK
)braket
op_assign
l_int|NULL
comma
(braket
id|MTUNLOCK
)braket
op_assign
l_int|NULL
comma
(braket
id|MTLOAD
)braket
op_assign
id|tape_std_mtload
comma
(braket
id|MTUNLOAD
)braket
op_assign
id|tape_std_mtunload
comma
(braket
id|MTCOMPRESSION
)braket
op_assign
id|tape_std_mtcompression
comma
(braket
id|MTSETPART
)braket
op_assign
l_int|NULL
comma
(braket
id|MTMKPART
)braket
op_assign
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; * Tape discipline structure for 3480 and 3490.&n; */
DECL|variable|tape_discipline_34xx
r_static
r_struct
id|tape_discipline
id|tape_discipline_34xx
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|setup_device
op_assign
id|tape_34xx_setup_device
comma
dot
id|cleanup_device
op_assign
id|tape_34xx_cleanup_device
comma
dot
id|process_eov
op_assign
id|tape_std_process_eov
comma
dot
id|irq
op_assign
id|tape_34xx_irq
comma
dot
id|read_block
op_assign
id|tape_std_read_block
comma
dot
id|write_block
op_assign
id|tape_std_write_block
comma
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
dot
id|bread
op_assign
id|tape_34xx_bread
comma
dot
id|free_bread
op_assign
id|tape_34xx_free_bread
comma
dot
id|check_locate
op_assign
id|tape_34xx_check_locate
comma
macro_line|#endif
dot
id|ioctl_fn
op_assign
id|tape_34xx_ioctl
comma
dot
id|mtop_array
op_assign
id|tape_34xx_mtop
)brace
suffix:semicolon
DECL|variable|tape_34xx_ids
r_static
r_struct
id|ccw_device_id
id|tape_34xx_ids
(braket
)braket
op_assign
(brace
(brace
id|CCW_DEVICE_DEVTYPE
c_func
(paren
l_int|0x3480
comma
l_int|0
comma
l_int|0x3480
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
id|tape_3480
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
c_func
(paren
l_int|0x3490
comma
l_int|0
comma
l_int|0x3490
comma
l_int|0
)paren
comma
id|driver_info
suffix:colon
id|tape_3490
)brace
comma
(brace
multiline_comment|/* end of list */
)brace
)brace
suffix:semicolon
r_static
r_int
DECL|function|tape_34xx_online
id|tape_34xx_online
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_return
id|tape_generic_online
c_func
(paren
id|cdev-&gt;dev.driver_data
comma
op_amp
id|tape_discipline_34xx
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tape_34xx_offline
id|tape_34xx_offline
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_return
id|tape_generic_offline
c_func
(paren
id|cdev-&gt;dev.driver_data
)paren
suffix:semicolon
)brace
DECL|variable|tape_34xx_driver
r_static
r_struct
id|ccw_driver
id|tape_34xx_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;tape_34xx&quot;
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ids
op_assign
id|tape_34xx_ids
comma
dot
id|probe
op_assign
id|tape_generic_probe
comma
dot
id|remove
op_assign
id|tape_generic_remove
comma
dot
id|set_online
op_assign
id|tape_34xx_online
comma
dot
id|set_offline
op_assign
id|tape_34xx_offline
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|tape_34xx_init
id|tape_34xx_init
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;34xx init: $Revision: 1.19 $&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Register driver for 3480/3490 tapes. */
id|rc
op_assign
id|ccw_driver_register
c_func
(paren
op_amp
id|tape_34xx_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;34xx init failed&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;34xx registered&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|tape_34xx_exit
id|tape_34xx_exit
c_func
(paren
r_void
)paren
(brace
id|ccw_driver_unregister
c_func
(paren
op_amp
id|tape_34xx_driver
)paren
suffix:semicolon
)brace
id|MODULE_DEVICE_TABLE
c_func
(paren
id|ccw
comma
id|tape_34xx_ids
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;(C) 2001-2002 IBM Deutschland Entwicklung GmbH&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux on zSeries channel attached 3480 tape &quot;
l_string|&quot;device driver ($Revision: 1.19 $)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|tape_34xx_init
id|module_init
c_func
(paren
id|tape_34xx_init
)paren
suffix:semicolon
DECL|variable|tape_34xx_exit
id|module_exit
c_func
(paren
id|tape_34xx_exit
)paren
suffix:semicolon
eof
