multiline_comment|/*&n; *  drivers/s390/char/tape_block.c&n; *    block device frontend for tape device driver&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001,2003 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *&t;&t; Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&t;&t; Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; *&t;&t; Stefan Bader &lt;shbader@de.ibm.com&gt;&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/buffer_head.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &quot;tape.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;TAPE_BLOCK: &quot;
DECL|macro|TAPEBLOCK_MAX_SEC
mdefine_line|#define TAPEBLOCK_MAX_SEC&t;100
DECL|macro|TAPEBLOCK_MIN_REQUEUE
mdefine_line|#define TAPEBLOCK_MIN_REQUEUE&t;3
multiline_comment|/*&n; * 2003/11/25  Stefan Bader &lt;shbader@de.ibm.com&gt;&n; *&n; * In 2.5/2.6 the block device request function is very likely to be called&n; * with disabled interrupts (e.g. generic_unplug_device). So the driver can&squot;t&n; * just call any function that tries to allocate CCW requests from that con-&n; * text since it might sleep. There are two choices to work around this:&n; *&t;a) do not allocate with kmalloc but use its own memory pool&n; *      b) take requests from the queue outside that context, knowing that&n; *         allocation might sleep&n; */
multiline_comment|/*&n; * file operation structure for tape block frontend&n; */
r_static
r_int
id|tapeblock_open
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|tapeblock_release
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|tapeblock_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|tapeblock_medium_changed
c_func
(paren
r_struct
id|gendisk
op_star
)paren
suffix:semicolon
r_static
r_int
id|tapeblock_revalidate_disk
c_func
(paren
r_struct
id|gendisk
op_star
)paren
suffix:semicolon
DECL|variable|tapeblock_fops
r_static
r_struct
id|block_device_operations
id|tapeblock_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|tapeblock_open
comma
dot
id|release
op_assign
id|tapeblock_release
comma
dot
id|ioctl
op_assign
id|tapeblock_ioctl
comma
dot
id|media_changed
op_assign
id|tapeblock_medium_changed
comma
dot
id|revalidate_disk
op_assign
id|tapeblock_revalidate_disk
comma
)brace
suffix:semicolon
DECL|variable|tapeblock_major
r_static
r_int
id|tapeblock_major
op_assign
l_int|0
suffix:semicolon
r_static
r_void
DECL|function|tapeblock_trigger_requeue
id|tapeblock_trigger_requeue
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
multiline_comment|/* Protect against rescheduling. */
r_if
c_cond
(paren
id|atomic_compare_and_swap
c_func
(paren
l_int|0
comma
l_int|1
comma
op_amp
id|device-&gt;blk_data.requeue_scheduled
)paren
)paren
r_return
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|device-&gt;blk_data.requeue_task
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Post finished request.&n; */
r_static
r_inline
r_void
DECL|function|tapeblock_end_request
id|tapeblock_end_request
c_func
(paren
r_struct
id|request
op_star
id|req
comma
r_int
id|uptodate
)paren
(brace
r_if
c_cond
(paren
id|end_that_request_first
c_func
(paren
id|req
comma
id|uptodate
comma
id|req-&gt;hard_nr_sectors
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|end_that_request_last
c_func
(paren
id|req
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|__tapeblock_end_request
id|__tapeblock_end_request
c_func
(paren
r_struct
id|tape_request
op_star
id|ccw_req
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|6
comma
l_string|&quot;__tapeblock_end_request()&bslash;n&quot;
)paren
suffix:semicolon
id|device
op_assign
id|ccw_req-&gt;device
suffix:semicolon
id|req
op_assign
(paren
r_struct
id|request
op_star
)paren
id|data
suffix:semicolon
id|tapeblock_end_request
c_func
(paren
id|req
comma
id|ccw_req-&gt;rc
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ccw_req-&gt;rc
op_eq
l_int|0
)paren
multiline_comment|/* Update position. */
id|device-&gt;blk_data.block_position
op_assign
(paren
id|req-&gt;sector
op_plus
id|req-&gt;nr_sectors
)paren
op_rshift
id|TAPEBLOCK_HSEC_S2B
suffix:semicolon
r_else
multiline_comment|/* We lost the position information due to an error. */
id|device-&gt;blk_data.block_position
op_assign
op_minus
l_int|1
suffix:semicolon
id|device-&gt;discipline
op_member_access_from_pointer
id|free_bread
c_func
(paren
id|ccw_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|device-&gt;req_queue
)paren
op_logical_or
id|elv_next_request
c_func
(paren
id|device-&gt;blk_data.request_queue
)paren
)paren
id|tapeblock_trigger_requeue
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Feed the tape device CCW queue with requests supplied in a list.&n; */
r_static
r_inline
r_int
DECL|function|tapeblock_start_request
id|tapeblock_start_request
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|request
op_star
id|req
)paren
(brace
r_struct
id|tape_request
op_star
id|ccw_req
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|6
comma
l_string|&quot;tapeblock_start_request(%p, %p)&bslash;n&quot;
comma
id|device
comma
id|req
)paren
suffix:semicolon
id|ccw_req
op_assign
id|device-&gt;discipline
op_member_access_from_pointer
id|bread
c_func
(paren
id|device
comma
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|ccw_req
)paren
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|1
comma
l_string|&quot;TBLOCK: bread failed&bslash;n&quot;
)paren
suffix:semicolon
id|tapeblock_end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|ccw_req
)paren
suffix:semicolon
)brace
id|ccw_req-&gt;callback
op_assign
id|__tapeblock_end_request
suffix:semicolon
id|ccw_req-&gt;callback_data
op_assign
(paren
r_void
op_star
)paren
id|req
suffix:semicolon
id|ccw_req-&gt;retries
op_assign
id|TAPEBLOCK_RETRIES
suffix:semicolon
id|rc
op_assign
id|tape_do_io_async
c_func
(paren
id|device
comma
id|ccw_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/*&n;&t;&t; * Start/enqueueing failed. No retries in&n;&t;&t; * this case.&n;&t;&t; */
id|tapeblock_end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
id|device-&gt;discipline
op_member_access_from_pointer
id|free_bread
c_func
(paren
id|ccw_req
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Move requests from the block device request queue to the tape device ccw&n; * queue.&n; */
r_static
r_void
DECL|function|tapeblock_requeue
id|tapeblock_requeue
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
id|request_queue_t
op_star
id|queue
suffix:semicolon
r_int
id|nr_queued
suffix:semicolon
r_struct
id|request
op_star
id|req
suffix:semicolon
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|device
op_assign
(paren
r_struct
id|tape_device
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
r_return
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
id|queue
op_assign
id|device-&gt;blk_data.request_queue
suffix:semicolon
multiline_comment|/* Count number of requests on ccw queue. */
id|nr_queued
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|device-&gt;req_queue
)paren
id|nr_queued
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|device-&gt;blk_data.request_queue_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|blk_queue_plugged
c_func
(paren
id|queue
)paren
op_logical_and
id|elv_next_request
c_func
(paren
id|queue
)paren
op_logical_and
id|nr_queued
OL
id|TAPEBLOCK_MIN_REQUEUE
)paren
(brace
id|req
op_assign
id|elv_next_request
c_func
(paren
id|queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|req
)paren
op_eq
id|WRITE
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|1
comma
l_string|&quot;TBLOCK: Rejecting write request&bslash;n&quot;
)paren
suffix:semicolon
id|blkdev_dequeue_request
c_func
(paren
id|req
)paren
suffix:semicolon
id|tapeblock_end_request
c_func
(paren
id|req
comma
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|device-&gt;blk_data.request_queue_lock
)paren
suffix:semicolon
id|rc
op_assign
id|tapeblock_start_request
c_func
(paren
id|device
comma
id|req
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|device-&gt;blk_data.request_queue_lock
)paren
suffix:semicolon
id|blkdev_dequeue_request
c_func
(paren
id|req
)paren
suffix:semicolon
id|nr_queued
op_increment
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|device-&gt;blk_data.request_queue_lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|device-&gt;blk_data.requeue_scheduled
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape request queue function. Called from ll_rw_blk.c&n; */
r_static
r_void
DECL|function|tapeblock_request_fn
id|tapeblock_request_fn
c_func
(paren
id|request_queue_t
op_star
id|queue
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
id|device
op_assign
(paren
r_struct
id|tape_device
op_star
)paren
id|queue-&gt;queuedata
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|6
comma
l_string|&quot;tapeblock_request_fn(device=%p)&bslash;n&quot;
comma
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|tapeblock_trigger_requeue
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called for every new tapedevice&n; */
r_int
DECL|function|tapeblock_setup_device
id|tapeblock_setup_device
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_struct
id|tape_blk_data
op_star
id|blkdat
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|blkdat
op_assign
op_amp
id|device-&gt;blk_data
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|blkdat-&gt;request_queue_lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|blkdat-&gt;requeue_scheduled
comma
l_int|0
)paren
suffix:semicolon
id|blkdat-&gt;request_queue
op_assign
id|blk_init_queue
c_func
(paren
id|tapeblock_request_fn
comma
op_amp
id|blkdat-&gt;request_queue_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|blkdat-&gt;request_queue
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|elevator_exit
c_func
(paren
id|blkdat-&gt;request_queue
)paren
suffix:semicolon
id|rc
op_assign
id|elevator_init
c_func
(paren
id|blkdat-&gt;request_queue
comma
op_amp
id|elevator_noop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|cleanup_queue
suffix:semicolon
id|blk_queue_hardsect_size
c_func
(paren
id|blkdat-&gt;request_queue
comma
id|TAPEBLOCK_HSEC_SIZE
)paren
suffix:semicolon
id|blk_queue_max_sectors
c_func
(paren
id|blkdat-&gt;request_queue
comma
id|TAPEBLOCK_MAX_SEC
)paren
suffix:semicolon
id|blk_queue_max_phys_segments
c_func
(paren
id|blkdat-&gt;request_queue
comma
op_minus
l_int|1L
)paren
suffix:semicolon
id|blk_queue_max_hw_segments
c_func
(paren
id|blkdat-&gt;request_queue
comma
op_minus
l_int|1L
)paren
suffix:semicolon
id|blk_queue_max_segment_size
c_func
(paren
id|blkdat-&gt;request_queue
comma
op_minus
l_int|1L
)paren
suffix:semicolon
id|blk_queue_segment_boundary
c_func
(paren
id|blkdat-&gt;request_queue
comma
op_minus
l_int|1L
)paren
suffix:semicolon
id|disk
op_assign
id|alloc_disk
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup_queue
suffix:semicolon
)brace
id|disk-&gt;major
op_assign
id|tapeblock_major
suffix:semicolon
id|disk-&gt;first_minor
op_assign
id|device-&gt;first_minor
suffix:semicolon
id|disk-&gt;fops
op_assign
op_amp
id|tapeblock_fops
suffix:semicolon
id|disk-&gt;private_data
op_assign
id|tape_get_device_reference
c_func
(paren
id|device
)paren
suffix:semicolon
id|disk-&gt;queue
op_assign
id|blkdat-&gt;request_queue
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
l_int|0
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
l_string|&quot;btibm%d&quot;
comma
id|device-&gt;first_minor
op_div
id|TAPE_MINORS_PER_DEV
)paren
suffix:semicolon
id|blkdat-&gt;disk
op_assign
id|disk
suffix:semicolon
id|blkdat-&gt;medium_changed
op_assign
l_int|1
suffix:semicolon
id|blkdat-&gt;request_queue-&gt;queuedata
op_assign
id|tape_get_device_reference
c_func
(paren
id|device
)paren
suffix:semicolon
id|add_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|blkdat-&gt;requeue_task
comma
id|tapeblock_requeue
comma
id|tape_get_device_reference
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
multiline_comment|/* Will vanish */
id|tape_hotplug_event
c_func
(paren
id|device
comma
id|tapeblock_major
comma
id|TAPE_HOTPLUG_BLOCK_ADD
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|cleanup_queue
suffix:colon
id|blk_cleanup_queue
c_func
(paren
id|blkdat-&gt;request_queue
)paren
suffix:semicolon
id|blkdat-&gt;request_queue
op_assign
l_int|NULL
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|tapeblock_cleanup_device
id|tapeblock_cleanup_device
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
id|tape_hotplug_event
c_func
(paren
id|device
comma
id|tapeblock_major
comma
id|TAPE_HOTPLUG_BLOCK_REMOVE
)paren
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
id|device-&gt;blk_data.requeue_task.data
op_assign
id|tape_put_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|del_gendisk
c_func
(paren
id|device-&gt;blk_data.disk
)paren
suffix:semicolon
id|device-&gt;blk_data.disk-&gt;private_data
op_assign
id|tape_put_device
c_func
(paren
id|device-&gt;blk_data.disk-&gt;private_data
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|device-&gt;blk_data.disk
)paren
suffix:semicolon
id|device-&gt;blk_data.disk
op_assign
l_int|NULL
suffix:semicolon
id|device-&gt;blk_data.request_queue-&gt;queuedata
op_assign
id|tape_put_device
c_func
(paren
id|device
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|device-&gt;blk_data.request_queue
)paren
suffix:semicolon
id|device-&gt;blk_data.request_queue
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Detect number of blocks of the tape.&n; * FIXME: can we extent this to detect the blocks size as well ?&n; */
r_static
r_int
DECL|function|tapeblock_revalidate_disk
id|tapeblock_revalidate_disk
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
r_int
r_int
id|nr_of_blks
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|device
op_assign
(paren
r_struct
id|tape_device
op_star
)paren
id|disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device-&gt;blk_data.medium_changed
)paren
r_return
l_int|0
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;Detecting media size...&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTFSFM
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTTELL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|3
comma
l_string|&quot;Image file ends at %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|nr_of_blks
op_assign
id|rc
suffix:semicolon
multiline_comment|/* This will fail for the first file. Catch the error by checking the&n;&t; * position. */
id|tape_mtop
c_func
(paren
id|device
comma
id|MTBSF
comma
l_int|1
)paren
suffix:semicolon
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTTELL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
id|nr_of_blks
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|3
comma
l_string|&quot;Image file starts at %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|device-&gt;bof
op_assign
id|rc
suffix:semicolon
id|nr_of_blks
op_sub_assign
id|rc
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;Found %i blocks on media&bslash;n&quot;
comma
id|nr_of_blks
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
id|device-&gt;blk_data.disk
comma
id|nr_of_blks
op_star
(paren
id|TAPEBLOCK_HSEC_SIZE
op_div
l_int|512
)paren
)paren
suffix:semicolon
id|device-&gt;blk_data.block_position
op_assign
l_int|0
suffix:semicolon
id|device-&gt;blk_data.medium_changed
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|tapeblock_medium_changed
id|tapeblock_medium_changed
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
id|device
op_assign
(paren
r_struct
id|tape_device
op_star
)paren
id|disk-&gt;private_data
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|6
comma
l_string|&quot;tapeblock_medium_changed(%p) = %d&bslash;n&quot;
comma
id|device
comma
id|device-&gt;blk_data.medium_changed
)paren
suffix:semicolon
r_return
id|device-&gt;blk_data.medium_changed
suffix:semicolon
)brace
multiline_comment|/*&n; * Block frontend tape device open function.&n; */
r_static
r_int
DECL|function|tapeblock_open
id|tapeblock_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
suffix:semicolon
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk
suffix:semicolon
id|device
op_assign
id|tape_get_device_reference
c_func
(paren
id|disk-&gt;private_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;required_tapemarks
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|2
comma
l_string|&quot;TBLOCK: missing tapemarks&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;TBLOCK: Refusing to open tape with missing&quot;
l_string|&quot; end of file marks.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|put_device
suffix:semicolon
)brace
id|rc
op_assign
id|tape_open
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|put_device
suffix:semicolon
id|rc
op_assign
id|tapeblock_revalidate_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|release
suffix:semicolon
multiline_comment|/*&n;&t; * Note: The reference to &lt;device&gt; is hold until the release function&n;&t; *       is called.&n;&t; */
id|tape_state_set
c_func
(paren
id|device
comma
id|TS_BLKUSE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|release
suffix:colon
id|tape_release
c_func
(paren
id|device
)paren
suffix:semicolon
id|put_device
suffix:colon
id|tape_put_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Block frontend tape device release function.&n; *&n; * Note: One reference to the tape device was made by the open function. So&n; *       we just get the pointer here and release the reference.&n; */
r_static
r_int
DECL|function|tapeblock_release
id|tapeblock_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk
suffix:semicolon
r_struct
id|tape_device
op_star
id|device
op_assign
id|disk-&gt;private_data
suffix:semicolon
id|tape_state_set
c_func
(paren
id|device
comma
id|TS_IN_USE
)paren
suffix:semicolon
id|tape_release
c_func
(paren
id|device
)paren
suffix:semicolon
id|tape_put_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Support of some generic block device IOCTLs.&n; */
r_static
r_int
DECL|function|tapeblock_ioctl
id|tapeblock_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|command
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
id|minor
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk
suffix:semicolon
r_struct
id|tape_device
op_star
id|device
op_assign
id|disk-&gt;private_data
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|device
op_assign
id|disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|6
comma
l_string|&quot;tapeblock_ioctl(0x%0x)&bslash;n&quot;
comma
id|command
)paren
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|6
comma
l_string|&quot;device = %d:%d&bslash;n&quot;
comma
id|tapeblock_major
comma
id|minor
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
multiline_comment|/* Refuse some IOCTL calls without complaining (mount). */
r_case
l_int|0x5310
suffix:colon
multiline_comment|/* CDROMMULTISESSION */
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;invalid ioctl 0x%x&bslash;n&quot;
comma
id|command
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize block device frontend.&n; */
r_int
DECL|function|tapeblock_init
id|tapeblock_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/* Register the tape major number to the kernel */
id|rc
op_assign
id|register_blkdev
c_func
(paren
id|tapeblock_major
comma
l_string|&quot;tBLK&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|tapeblock_major
op_eq
l_int|0
)paren
id|tapeblock_major
op_assign
id|rc
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;tape gets major %d for block device&bslash;n&quot;
comma
id|tapeblock_major
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Deregister major for block device frontend&n; */
r_void
DECL|function|tapeblock_exit
id|tapeblock_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_blkdev
c_func
(paren
id|tapeblock_major
comma
l_string|&quot;tBLK&quot;
)paren
suffix:semicolon
)brace
eof
