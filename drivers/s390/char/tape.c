multiline_comment|/***********************************************************************&n; *  drivers/s390/char/tape.c&n; *    tape device driver for S/390 and zSeries tapes.&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001 IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *               Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&n; ***********************************************************************&n; */
macro_line|#include &quot;tapedefs.h&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/ccwcache.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#ifdef MODULE
macro_line|#include &lt;linux/module.h&gt;
macro_line|#endif   
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#ifdef CONFIG_S390_TAPE_DYNAMIC
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#endif
macro_line|#include &quot;tape.h&quot;
macro_line|#ifdef CONFIG_S390_TAPE_3490
macro_line|#include &quot;tape3490.h&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_3480
macro_line|#include &quot;tape3480.h&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
macro_line|#include &quot;tapeblock.h&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_CHAR
macro_line|#include &quot;tapechar.h&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#endif
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;T390:&quot;
multiline_comment|/* state handling routines */
r_inline
r_void
id|tapestate_set
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|newstate
)paren
suffix:semicolon
r_inline
r_int
id|tapestate_get
(paren
id|tape_info_t
op_star
id|ti
)paren
suffix:semicolon
r_void
id|tapestate_event
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|event
)paren
suffix:semicolon
multiline_comment|/* our globals */
DECL|variable|first_tape_info
id|tape_info_t
op_star
id|first_tape_info
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|first_discipline
id|tape_discipline_t
op_star
id|first_discipline
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|first_frontend
id|tape_frontend_t
op_star
id|first_frontend
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|tape_devreg
id|devreg_t
op_star
id|tape_devreg
(braket
l_int|128
)braket
suffix:semicolon
DECL|variable|devregct
r_int
id|devregct
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
DECL|variable|tape_debug_area
id|debug_info_t
op_star
id|tape_debug_area
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
DECL|variable|state_verbose
r_char
op_star
id|state_verbose
(braket
id|TS_SIZE
)braket
op_assign
initialization_block
suffix:semicolon
DECL|variable|event_verbose
r_char
op_star
id|event_verbose
(braket
id|TE_SIZE
)braket
op_assign
(brace
l_string|&quot;TE_START&quot;
comma
l_string|&quot;TE_DONE&quot;
comma
l_string|&quot;TE_FAILED&quot;
comma
l_string|&quot;TE_ERROR&quot;
comma
l_string|&quot;TE_OTHER&quot;
)brace
suffix:semicolon
multiline_comment|/* our root devfs handle */
macro_line|#ifdef CONFIG_DEVFS_FS
DECL|variable|tape_devfs_root_entry
id|devfs_handle_t
id|tape_devfs_root_entry
suffix:semicolon
r_inline
r_void
DECL|function|tape_mkdevfsroots
id|tape_mkdevfsroots
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
r_char
id|devno
(braket
l_int|5
)braket
suffix:semicolon
id|sprintf
(paren
id|devno
comma
l_string|&quot;%04x&quot;
comma
id|ti-&gt;devinfo.devno
)paren
suffix:semicolon
id|ti-&gt;devfs_dir
op_assign
id|devfs_mk_dir
(paren
id|tape_devfs_root_entry
comma
id|devno
comma
id|ti
)paren
suffix:semicolon
)brace
r_inline
r_void
DECL|function|tape_rmdevfsroots
id|tape_rmdevfsroots
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
id|devfs_unregister
(paren
id|ti-&gt;devfs_dir
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/* our proc tapedevices entry */
DECL|variable|tape_devices_entry
r_static
r_struct
id|proc_dir_entry
op_star
id|tape_devices_entry
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|data
r_char
op_star
id|data
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
DECL|typedef|tempinfo_t
)brace
id|tempinfo_t
suffix:semicolon
r_static
r_int
DECL|function|tape_devices_open
id|tape_devices_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|size
op_assign
l_int|80
suffix:semicolon
id|tape_info_t
op_star
id|ti
suffix:semicolon
id|tempinfo_t
op_star
id|tempinfo
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_int
id|pos
op_assign
l_int|0
suffix:semicolon
id|tempinfo
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|tempinfo_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tempinfo
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|ti
op_assign
id|first_tape_info
suffix:semicolon
id|ti
op_ne
l_int|NULL
suffix:semicolon
id|ti
op_assign
id|ti-&gt;next
)paren
id|size
op_add_assign
l_int|80
suffix:semicolon
singleline_comment|// FIXME: Guess better!
id|data
op_assign
id|vmalloc
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
id|kfree
(paren
id|tempinfo
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|pos
op_add_assign
id|sprintf
c_func
(paren
id|data
op_plus
id|pos
comma
l_string|&quot;TapeNo&bslash;tDevNo&bslash;tCuType&bslash;tCuModel&bslash;tDevType&bslash;tDevModel&bslash;tState&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ti
op_assign
id|first_tape_info
suffix:semicolon
id|ti
op_ne
l_int|NULL
suffix:semicolon
id|ti
op_assign
id|ti-&gt;next
)paren
(brace
id|pos
op_add_assign
id|sprintf
c_func
(paren
id|data
op_plus
id|pos
comma
l_string|&quot;%d&bslash;t%04X&bslash;t%04X&bslash;t%02X&bslash;t%04X&bslash;t%02X&bslash;t&bslash;t%s&bslash;n&quot;
comma
id|ti-&gt;rew_minor
op_div
l_int|2
comma
id|ti-&gt;devinfo.devno
comma
id|ti-&gt;devinfo.sid_data.cu_type
comma
id|ti-&gt;devinfo.sid_data.cu_model
comma
id|ti-&gt;devinfo.sid_data.dev_type
comma
id|ti-&gt;devinfo.sid_data.dev_model
comma
(paren
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ge
l_int|0
)paren
op_logical_and
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;TS UNKNOWN&quot;
)paren
suffix:semicolon
)brace
id|tempinfo-&gt;len
op_assign
id|pos
suffix:semicolon
id|tempinfo-&gt;data
op_assign
id|data
suffix:semicolon
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
id|tempinfo
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|tape_devices_read
id|tape_devices_read
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|user_buf
comma
r_int
id|user_len
comma
id|loff_t
op_star
id|offset
)paren
(brace
id|loff_t
id|len
suffix:semicolon
id|tempinfo_t
op_star
id|p_info
op_assign
(paren
id|tempinfo_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_star
id|offset
op_ge
id|p_info-&gt;len
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* EOF */
)brace
r_else
(brace
id|len
op_assign
id|user_len
OL
(paren
id|p_info-&gt;len
op_minus
op_star
id|offset
)paren
ques
c_cond
id|user_len
suffix:colon
(paren
id|p_info-&gt;len
op_minus
op_star
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|user_buf
comma
op_amp
(paren
id|p_info-&gt;data
(braket
op_star
id|offset
)braket
)paren
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
(paren
op_star
id|offset
)paren
op_add_assign
id|len
suffix:semicolon
r_return
id|len
suffix:semicolon
multiline_comment|/* number of bytes &quot;read&quot; */
)brace
)brace
r_static
r_int
DECL|function|tape_devices_release
id|tape_devices_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|tempinfo_t
op_star
id|p_info
op_assign
(paren
id|tempinfo_t
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|p_info
)paren
(brace
r_if
c_cond
(paren
id|p_info-&gt;data
)paren
id|vfree
(paren
id|p_info-&gt;data
)paren
suffix:semicolon
id|kfree
(paren
id|p_info
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|tape_devices_file_ops
r_static
r_struct
id|file_operations
id|tape_devices_file_ops
op_assign
(brace
id|read
suffix:colon
id|tape_devices_read
comma
multiline_comment|/* read */
id|open
suffix:colon
id|tape_devices_open
comma
multiline_comment|/* open */
id|release
suffix:colon
id|tape_devices_release
comma
multiline_comment|/* close */
)brace
suffix:semicolon
DECL|variable|tape_devices_inode_ops
r_static
r_struct
id|inode_operations
id|tape_devices_inode_ops
op_assign
(brace
macro_line|#if !(LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,98))
id|default_file_ops
suffix:colon
op_amp
id|tape_devices_file_ops
multiline_comment|/* file ops */
macro_line|#endif&t;&t;&t;&t;/* LINUX_IS_24 */
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PROC_FS */
multiline_comment|/* SECTION: Parameters for tape */
DECL|variable|tape
r_char
op_star
id|tape
(braket
l_int|256
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
macro_line|#ifndef MODULE
DECL|variable|__initdata
r_static
r_char
id|tape_parm_string
(braket
l_int|1024
)braket
id|__initdata
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
r_static
r_void
DECL|function|tape_split_parm_string
id|tape_split_parm_string
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|tmp
op_assign
id|str
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
l_int|NULL
op_logical_and
op_star
id|tmp
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
r_char
op_star
id|end
suffix:semicolon
r_int
id|len
suffix:semicolon
id|end
op_assign
id|strchr
(paren
id|tmp
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
op_eq
l_int|NULL
)paren
(brace
id|len
op_assign
id|strlen
(paren
id|tmp
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
(paren
r_int
)paren
id|end
op_minus
(paren
r_int
)paren
id|tmp
op_plus
l_int|1
suffix:semicolon
op_star
id|end
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|end
op_increment
suffix:semicolon
)brace
id|tape
(braket
id|count
)braket
op_assign
id|kmalloc
(paren
id|len
op_star
r_sizeof
(paren
r_char
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tape
(braket
id|count
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;can&squot;t store tape= parameter no %d&bslash;n&quot;
comma
id|count
op_plus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memset
(paren
id|tape
(braket
id|count
)braket
comma
l_int|0
comma
id|len
op_star
r_sizeof
(paren
r_char
)paren
)paren
suffix:semicolon
id|memcpy
(paren
id|tape
(braket
id|count
)braket
comma
id|tmp
comma
id|len
op_star
r_sizeof
(paren
r_char
)paren
)paren
suffix:semicolon
id|count
op_increment
suffix:semicolon
id|tmp
op_assign
id|end
suffix:semicolon
)brace
suffix:semicolon
)brace
r_void
id|__init
DECL|function|tape_parm_setup
id|tape_parm_setup
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
r_int
id|len
op_assign
id|strlen
(paren
id|tape_parm_string
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
l_int|0
)paren
(brace
id|strcat
(paren
id|tape_parm_string
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
)brace
id|strcat
(paren
id|tape_parm_string
comma
id|str
)paren
suffix:semicolon
)brace
r_int
id|__init
DECL|function|tape_parm_call_setup
id|tape_parm_call_setup
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|dummy
suffix:semicolon
id|tape_parm_setup
(paren
id|str
comma
op_amp
id|dummy
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,2,16))
id|__setup
c_func
(paren
l_string|&quot;tape=&quot;
comma
id|tape_parm_call_setup
)paren
suffix:semicolon
macro_line|#endif   /* kernel &lt;2.2.19 */
macro_line|#endif   /* not defined MODULE */
r_static
r_inline
r_int
DECL|function|tape_parm_strtoul
id|tape_parm_strtoul
(paren
r_char
op_star
id|str
comma
r_char
op_star
op_star
id|stra
)paren
(brace
r_char
op_star
id|temp
op_assign
id|str
suffix:semicolon
r_int
id|val
suffix:semicolon
r_if
c_cond
(paren
op_star
id|temp
op_eq
l_char|&squot;0&squot;
)paren
(brace
id|temp
op_increment
suffix:semicolon
multiline_comment|/* strip leading zero */
r_if
c_cond
(paren
op_star
id|temp
op_eq
l_char|&squot;x&squot;
)paren
id|temp
op_increment
suffix:semicolon
multiline_comment|/* strip leading x */
)brace
id|val
op_assign
id|simple_strtoul
(paren
id|temp
comma
op_amp
id|temp
comma
l_int|16
)paren
suffix:semicolon
multiline_comment|/* interpret anything as hex */
op_star
id|stra
op_assign
id|temp
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
r_static
r_inline
id|devreg_t
op_star
DECL|function|tape_create_devreg
id|tape_create_devreg
(paren
r_int
id|devno
)paren
(brace
id|devreg_t
op_star
id|devreg
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|devreg_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devreg
op_ne
l_int|NULL
)paren
(brace
id|memset
(paren
id|devreg
comma
l_int|0
comma
r_sizeof
(paren
id|devreg_t
)paren
)paren
suffix:semicolon
id|devreg-&gt;ci.devno
op_assign
id|devno
suffix:semicolon
id|devreg-&gt;flag
op_assign
id|DEVREG_TYPE_DEVNO
suffix:semicolon
id|devreg-&gt;oper_func
op_assign
id|tape_oper_handler
suffix:semicolon
)brace
r_return
id|devreg
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|tape_parm_parse
id|tape_parm_parse
(paren
r_char
op_star
op_star
id|str
)paren
(brace
r_char
op_star
id|temp
suffix:semicolon
r_int
id|from
comma
id|to
comma
id|i
comma
id|irq
op_assign
l_int|0
comma
id|rc
comma
id|retries
op_assign
l_int|0
comma
id|tape_num
op_assign
l_int|0
suffix:semicolon
id|s390_dev_info_t
id|dinfo
suffix:semicolon
id|tape_info_t
op_star
id|ti
comma
op_star
id|tempti
suffix:semicolon
id|tape_discipline_t
op_star
id|disc
suffix:semicolon
r_int
id|lockflags
suffix:semicolon
r_if
c_cond
(paren
op_star
id|str
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* no params present -&gt; leave */
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|str
)paren
(brace
id|temp
op_assign
op_star
id|str
suffix:semicolon
id|from
op_assign
l_int|0
suffix:semicolon
id|to
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* turn off autodetect mode, if any range is present */
id|from
op_assign
id|tape_parm_strtoul
(paren
id|temp
comma
op_amp
id|temp
)paren
suffix:semicolon
id|to
op_assign
id|from
suffix:semicolon
r_if
c_cond
(paren
op_star
id|temp
op_eq
l_char|&squot;-&squot;
)paren
(brace
id|temp
op_increment
suffix:semicolon
id|to
op_assign
id|tape_parm_strtoul
(paren
id|temp
comma
op_amp
id|temp
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|from
suffix:semicolon
id|i
op_le
id|to
suffix:semicolon
id|i
op_increment
)paren
(brace
id|retries
op_assign
l_int|0
suffix:semicolon
singleline_comment|// register for attch/detach of a devno
id|tape_devreg
(braket
id|devregct
)braket
op_assign
id|tape_create_devreg
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tape_devreg
(braket
id|devregct
)braket
op_eq
l_int|NULL
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Could not create devreg for devno %04x, dyn. attach for this devno deactivated.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
id|s390_device_register
(paren
id|tape_devreg
(braket
id|devregct
op_increment
)braket
)paren
suffix:semicolon
)brace
singleline_comment|// we are activating a device if it is present
r_for
c_loop
(paren
id|irq
op_assign
id|get_irq_first
c_func
(paren
)paren
suffix:semicolon
id|irq
op_ne
op_minus
id|ENODEV
suffix:semicolon
id|irq
op_assign
id|get_irq_next
c_func
(paren
id|irq
)paren
)paren
(brace
id|rc
op_assign
id|get_dev_info_by_irq
(paren
id|irq
comma
op_amp
id|dinfo
)paren
suffix:semicolon
id|disc
op_assign
id|first_discipline
suffix:semicolon
r_while
c_loop
(paren
(paren
id|dinfo.devno
op_eq
id|i
)paren
op_logical_and
(paren
id|disc
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|disc-&gt;cu_type
op_ne
id|dinfo.sid_data.cu_type
)paren
)paren
id|disc
op_assign
(paren
id|tape_discipline_t
op_star
)paren
(paren
id|disc-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|disc
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
op_logical_or
(paren
id|i
op_ne
id|dinfo.devno
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;det irq:  &quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|3
comma
id|irq
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;cu:       &quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|3
comma
id|disc-&gt;cu_type
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_INFO
(paren
l_string|&quot;using devno %04x with discipline %04x on irq %d as tape device %d&bslash;n&quot;
comma
id|dinfo.devno
comma
id|dinfo.sid_data.cu_type
comma
id|irq
comma
id|tape_num
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Allocate tape structure  */
id|ti
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|tape_info_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;ti:no mem &quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_INFO
(paren
l_string|&quot;tape: can&squot;t allocate memory for &quot;
l_string|&quot;tape info structure&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ti
comma
l_int|0
comma
r_sizeof
(paren
id|tape_info_t
)paren
)paren
suffix:semicolon
id|ti-&gt;discipline
op_assign
id|disc
suffix:semicolon
id|disc-&gt;tape
op_assign
id|ti
suffix:semicolon
id|rc
op_assign
id|tape_setup
(paren
id|ti
comma
id|irq
comma
id|tape_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;tsetup err&quot;
)paren
suffix:semicolon
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|kfree
(paren
id|ti
)paren
suffix:semicolon
)brace
r_else
(brace
id|s390irq_spin_lock_irqsave
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_tape_info
op_eq
l_int|NULL
)paren
(brace
id|first_tape_info
op_assign
id|ti
suffix:semicolon
)brace
r_else
(brace
id|tempti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
id|tempti-&gt;next
op_ne
l_int|NULL
)paren
id|tempti
op_assign
id|tempti-&gt;next
suffix:semicolon
id|tempti-&gt;next
op_assign
id|ti
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
)brace
)brace
id|tape_num
op_add_assign
l_int|2
suffix:semicolon
)brace
id|str
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* SECTION: Managing wrappers for ccwcache */
DECL|macro|TAPE_EMERGENCY_REQUESTS
mdefine_line|#define TAPE_EMERGENCY_REQUESTS 16
DECL|variable|tape_emergency_req
r_static
id|ccw_req_t
op_star
id|tape_emergency_req
(braket
id|TAPE_EMERGENCY_REQUESTS
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|tape_emergency_req_lock
r_static
id|spinlock_t
id|tape_emergency_req_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_static
r_void
DECL|function|tape_init_emergency_req
id|tape_init_emergency_req
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TAPE_EMERGENCY_REQUESTS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tape_emergency_req
(braket
id|i
)braket
op_assign
(paren
id|ccw_req_t
op_star
)paren
id|get_free_page
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef MODULE 
singleline_comment|// We only cleanup the emergency requests on module unload.
r_static
r_void
DECL|function|tape_cleanup_emergency_req
id|tape_cleanup_emergency_req
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TAPE_EMERGENCY_REQUESTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tape_emergency_req
(braket
id|i
)braket
)paren
id|free_page
(paren
(paren
r_int
)paren
(paren
id|tape_emergency_req
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
r_else
id|printk
(paren
id|KERN_WARNING
id|PRINTK_HEADER
l_string|&quot;losing one page for &squot;in-use&squot; emergency request&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|ccw_req_t
op_star
DECL|function|tape_alloc_request
id|tape_alloc_request
(paren
r_char
op_star
id|magic
comma
r_int
id|cplength
comma
r_int
id|datasize
)paren
(brace
id|ccw_req_t
op_star
id|rv
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rv
op_assign
id|ccw_alloc_request
(paren
id|magic
comma
id|cplength
comma
id|datasize
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_return
id|rv
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cplength
op_star
r_sizeof
(paren
id|ccw1_t
)paren
op_plus
id|datasize
op_plus
r_sizeof
(paren
id|ccw_req_t
)paren
OG
id|PAGE_SIZE
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_lock
(paren
op_amp
id|tape_emergency_req_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|TAPE_EMERGENCY_REQUESTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tape_emergency_req
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|rv
op_assign
id|tape_emergency_req
(braket
id|i
)braket
suffix:semicolon
id|tape_emergency_req
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|spin_unlock
(paren
op_amp
id|tape_emergency_req_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|memset
(paren
id|rv
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|rv-&gt;cache
op_assign
(paren
id|kmem_cache_t
op_star
)paren
(paren
id|tape_emergency_req
op_plus
id|i
)paren
suffix:semicolon
id|strncpy
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|rv-&gt;magic
)paren
comma
id|magic
comma
l_int|4
)paren
suffix:semicolon
id|ASCEBC
(paren
(paren
r_char
op_star
)paren
(paren
op_amp
id|rv-&gt;magic
)paren
comma
l_int|4
)paren
suffix:semicolon
id|rv-&gt;cplength
op_assign
id|cplength
suffix:semicolon
id|rv-&gt;datasize
op_assign
id|datasize
suffix:semicolon
id|rv-&gt;data
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_int
)paren
id|rv
op_plus
id|PAGE_SIZE
op_minus
id|datasize
)paren
suffix:semicolon
id|rv-&gt;cpaddr
op_assign
(paren
id|ccw1_t
op_star
)paren
(paren
(paren
r_int
)paren
id|rv
op_plus
r_sizeof
(paren
id|ccw_req_t
)paren
)paren
suffix:semicolon
)brace
r_return
id|rv
suffix:semicolon
)brace
r_void
DECL|function|tape_free_request
id|tape_free_request
(paren
id|ccw_req_t
op_star
id|request
)paren
(brace
r_if
c_cond
(paren
id|request-&gt;cache
op_ge
(paren
id|kmem_cache_t
op_star
)paren
id|tape_emergency_req
op_logical_and
id|request-&gt;cache
op_le
(paren
id|kmem_cache_t
op_star
)paren
(paren
id|tape_emergency_req
op_plus
id|TAPE_EMERGENCY_REQUESTS
)paren
)paren
(brace
op_star
(paren
(paren
id|ccw_req_t
op_star
op_star
)paren
(paren
id|request-&gt;cache
)paren
)paren
op_assign
id|request
suffix:semicolon
)brace
r_else
(brace
id|clear_normalized_cda
(paren
(paren
id|ccw1_t
op_star
)paren
(paren
id|request-&gt;cpaddr
)paren
)paren
suffix:semicolon
singleline_comment|// avoid memory leak caused by modeset_byte
id|ccw_free_request
(paren
id|request
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Allocate a ccw request and reserve it for tape driver&n; */
r_inline
id|ccw_req_t
op_star
DECL|function|tape_alloc_ccw_req
id|tape_alloc_ccw_req
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|cplength
comma
r_int
id|datasize
)paren
(brace
r_char
id|tape_magic_id
(braket
)braket
op_assign
l_string|&quot;tape&quot;
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ti
)paren
r_return
l_int|NULL
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_request
(paren
id|tape_magic_id
comma
id|cplength
comma
id|datasize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|PRINT_WARN
(paren
l_string|&quot;empty CQR generated&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|cqr-&gt;magic
op_assign
id|TAPE_MAGIC
suffix:semicolon
multiline_comment|/* sets an identifier for tape driver   */
id|cqr-&gt;device
op_assign
id|ti
suffix:semicolon
multiline_comment|/* save pointer to tape info    */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the tape_info_t structure associated with irq&n; */
r_static
r_inline
id|tape_info_t
op_star
DECL|function|tapedev_find_info
id|tapedev_find_info
(paren
r_int
id|irq
)paren
(brace
id|tape_info_t
op_star
id|ti
suffix:semicolon
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_ne
l_int|NULL
)paren
r_do
(brace
r_if
c_cond
(paren
id|ti-&gt;devinfo.irq
op_eq
id|irq
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|ti
op_assign
(paren
id|tape_info_t
op_star
)paren
id|ti-&gt;next
)paren
op_ne
l_int|NULL
)paren
suffix:semicolon
r_return
id|ti
suffix:semicolon
)brace
DECL|macro|QUEUE_THRESHOLD
mdefine_line|#define QUEUE_THRESHOLD 5
multiline_comment|/*&n; * Tape interrupt routine, called from Ingo&squot;s I/O layer&n; */
r_void
DECL|function|tape_irq
id|tape_irq
(paren
r_int
id|irq
comma
r_void
op_star
id|int_parm
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|tape_info_t
op_star
id|ti
op_assign
id|tapedev_find_info
(paren
id|irq
)paren
suffix:semicolon
multiline_comment|/* analyse devstat and fire event */
r_if
c_cond
(paren
id|ti-&gt;devstat.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
id|tapestate_event
(paren
id|ti
comma
id|TE_ERROR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ti-&gt;devstat.dstat
op_amp
(paren
id|DEV_STAT_DEV_END
)paren
)paren
(brace
id|tapestate_event
(paren
id|ti
comma
id|TE_DONE
)paren
suffix:semicolon
)brace
r_else
id|tapestate_event
(paren
id|ti
comma
id|TE_OTHER
)paren
suffix:semicolon
)brace
r_int
DECL|function|tape_oper_handler
id|tape_oper_handler
(paren
r_int
id|irq
comma
r_struct
id|_devreg
op_star
id|dreg
)paren
(brace
id|tape_info_t
op_star
id|ti
op_assign
id|first_tape_info
suffix:semicolon
id|tape_info_t
op_star
id|newtape
suffix:semicolon
r_int
id|rc
comma
id|tape_num
comma
id|retries
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|s390_dev_info_t
id|dinfo
suffix:semicolon
id|tape_discipline_t
op_star
id|disc
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|tape_frontend_t
op_star
id|frontend
suffix:semicolon
macro_line|#endif
r_int
id|lockflags
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ti
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ti-&gt;devinfo.irq
op_ne
id|irq
)paren
)paren
id|ti
op_assign
id|ti-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_ne
l_int|NULL
)paren
(brace
singleline_comment|// irq is (still) used by tape. tell ingo to try again later
id|PRINT_WARN
(paren
l_string|&quot;Oper handler for irq %d called while irq still (internaly?) used.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
singleline_comment|// irq is not used by tape
id|rc
op_assign
id|get_dev_info_by_irq
(paren
id|irq
comma
op_amp
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
(brace
id|retries
op_increment
suffix:semicolon
id|rc
op_assign
id|get_dev_info_by_irq
(paren
id|irq
comma
op_amp
id|dinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retries
OG
l_int|5
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;No device information for new dev. could be retrieved.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
id|disc
op_assign
id|first_discipline
suffix:semicolon
r_while
c_loop
(paren
(paren
id|disc
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|disc-&gt;cu_type
op_ne
id|dinfo.sid_data.cu_type
)paren
)paren
id|disc
op_assign
(paren
id|tape_discipline_t
op_star
)paren
(paren
id|disc-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disc
op_eq
l_int|NULL
)paren
id|PRINT_WARN
(paren
l_string|&quot;No matching discipline for cu_type %x found, ignoring device %04x.&bslash;n&quot;
comma
id|dinfo.sid_data.cu_type
comma
id|dinfo.devno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
id|PRINT_WARN
(paren
l_string|&quot;No device information for new dev. could be retrieved.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|disc
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Allocate tape structure  */
id|ti
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|tape_info_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
(brace
id|PRINT_INFO
(paren
l_string|&quot;tape: can&squot;t allocate memory for &quot;
l_string|&quot;tape info structure&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ti
comma
l_int|0
comma
r_sizeof
(paren
id|tape_info_t
)paren
)paren
suffix:semicolon
id|ti-&gt;discipline
op_assign
id|disc
suffix:semicolon
id|disc-&gt;tape
op_assign
id|ti
suffix:semicolon
id|tape_num
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|tape
)paren
(brace
singleline_comment|// we have static device ranges, so fingure out the tape_num of the attached tape
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devregct
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|tape_devreg
(braket
id|i
)braket
op_member_access_from_pointer
id|ci.devno
op_eq
id|dinfo.devno
)paren
(brace
id|tape_num
op_assign
l_int|2
op_star
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// we are running in autoprobe mode, find a free tape_num
id|newtape
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
id|newtape
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|newtape-&gt;rew_minor
op_eq
id|tape_num
)paren
(brace
singleline_comment|// tape num in use. try next one
id|tape_num
op_add_assign
l_int|2
suffix:semicolon
id|newtape
op_assign
id|first_tape_info
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// tape num not used by newtape. look at next tape info
id|newtape
op_assign
id|newtape-&gt;next
suffix:semicolon
)brace
)brace
)brace
id|rc
op_assign
id|tape_setup
(paren
id|ti
comma
id|irq
comma
id|tape_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|kfree
(paren
id|ti
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_DEVFS_FS
r_for
c_loop
(paren
id|frontend
op_assign
id|first_frontend
suffix:semicolon
id|frontend
op_ne
l_int|NULL
suffix:semicolon
id|frontend
op_assign
id|frontend-&gt;next
)paren
id|frontend
op_member_access_from_pointer
id|mkdevfstree
c_func
(paren
id|ti
)paren
suffix:semicolon
macro_line|#endif
id|s390irq_spin_lock_irqsave
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_tape_info
op_eq
l_int|NULL
)paren
(brace
id|first_tape_info
op_assign
id|ti
suffix:semicolon
)brace
r_else
(brace
id|newtape
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
id|newtape-&gt;next
op_ne
l_int|NULL
)paren
id|newtape
op_assign
id|newtape-&gt;next
suffix:semicolon
id|newtape-&gt;next
op_assign
id|ti
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|tape_noper_handler
id|tape_noper_handler
(paren
r_int
id|irq
comma
r_int
id|status
)paren
(brace
id|tape_info_t
op_star
id|ti
op_assign
id|first_tape_info
suffix:semicolon
id|tape_info_t
op_star
id|lastti
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|tape_frontend_t
op_star
id|frontend
suffix:semicolon
macro_line|#endif
r_int
id|lockflags
suffix:semicolon
id|s390irq_spin_lock_irqsave
c_func
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ti
op_ne
l_int|NULL
op_logical_and
id|ti-&gt;devinfo.irq
op_ne
id|irq
)paren
id|ti
op_assign
id|ti-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_UNUSED
)paren
(brace
singleline_comment|// device is in use!
id|PRINT_WARN
(paren
l_string|&quot;Tape #%d was detached while it was busy. Expect errors!&quot;
comma
id|ti-&gt;blk_minor
op_div
l_int|2
)paren
suffix:semicolon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_NOT_OPER
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
)paren
(brace
r_case
id|TS_REW_RELEASE_INIT
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_NOT_OPER
)paren
suffix:semicolon
id|wake_up
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
r_case
id|TS_BLOCK_INIT
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_NOT_OPER
)paren
suffix:semicolon
id|schedule_tapeblock_exec_IO
c_func
(paren
id|ti
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_NOT_OPER
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// device is unused!
id|PRINT_WARN
(paren
l_string|&quot;Tape #%d was detached.&bslash;n&quot;
comma
id|ti-&gt;blk_minor
op_div
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
id|first_tape_info
)paren
(brace
id|first_tape_info
op_assign
id|ti-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|lastti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
id|lastti-&gt;next
op_ne
id|ti
)paren
id|lastti
op_assign
id|lastti-&gt;next
suffix:semicolon
id|lastti-&gt;next
op_assign
id|ti-&gt;next
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_DEVFS_FS
r_for
c_loop
(paren
id|frontend
op_assign
id|first_frontend
suffix:semicolon
id|frontend
op_ne
l_int|NULL
suffix:semicolon
id|frontend
op_assign
id|frontend-&gt;next
)paren
id|frontend
op_member_access_from_pointer
id|rmdevfstree
c_func
(paren
id|ti
)paren
suffix:semicolon
id|tape_rmdevfsroots
c_func
(paren
id|ti
)paren
suffix:semicolon
macro_line|#endif
id|kfree
c_func
(paren
id|ti
)paren
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|tape_dump_sense
id|tape_dump_sense
(paren
id|devstat_t
op_star
id|stat
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
r_int
id|sl
suffix:semicolon
macro_line|#endif
macro_line|#if 0
id|PRINT_WARN
(paren
l_string|&quot;------------I/O resulted in unit check:-----------&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sl
op_assign
l_int|0
suffix:semicolon
id|sl
OL
l_int|4
suffix:semicolon
id|sl
op_increment
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Sense:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sct
op_assign
l_int|0
suffix:semicolon
id|sct
OL
l_int|8
suffix:semicolon
id|sct
op_increment
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot; %2d:0x%02X&quot;
comma
l_int|8
op_star
id|sl
op_plus
id|sct
comma
id|stat-&gt;ii.sense.data
(braket
l_int|8
op_star
id|sl
op_plus
id|sct
)braket
)paren
suffix:semicolon
)brace
id|PRINT_WARN
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|PRINT_INFO
(paren
l_string|&quot;Sense data: %02X%02X%02X%02X %02X%02X%02X%02X &quot;
l_string|&quot; %02X%02X%02X%02X %02X%02X%02X%02X &bslash;n&quot;
comma
id|stat-&gt;ii.sense.data
(braket
l_int|0
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|1
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|2
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|3
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|4
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|5
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|6
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|7
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|8
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|9
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|10
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|11
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|12
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|13
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|14
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|PRINT_INFO
(paren
l_string|&quot;Sense data: %02X%02X%02X%02X %02X%02X%02X%02X &quot;
l_string|&quot; %02X%02X%02X%02X %02X%02X%02X%02X &bslash;n&quot;
comma
id|stat-&gt;ii.sense.data
(braket
l_int|16
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|17
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|18
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|19
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|20
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|21
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|22
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|23
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|24
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|25
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|26
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|27
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|28
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|29
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|30
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|31
)braket
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;SENSE:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sl
op_assign
l_int|0
suffix:semicolon
id|sl
OL
l_int|31
suffix:semicolon
id|sl
op_increment
)paren
(brace
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|3
comma
id|stat-&gt;ii.sense.data
(braket
id|sl
)braket
)paren
suffix:semicolon
)brace
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|stat-&gt;ii.sense.data
(braket
l_int|31
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Setup tape_info_t structure of a tape device&n; */
r_int
DECL|function|tape_setup
id|tape_setup
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|irq
comma
r_int
id|minor
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|minor
OG
l_int|254
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Device id %d on irq %d will not be accessible since this driver is restricted to 128 devices.&bslash;n&quot;
comma
id|minor
op_div
l_int|2
comma
id|irq
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|rc
op_assign
id|get_dev_info_by_irq
(paren
id|irq
comma
op_amp
(paren
id|ti-&gt;devinfo
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
(brace
multiline_comment|/* end of device list */
r_return
id|rc
suffix:semicolon
)brace
id|ti-&gt;rew_minor
op_assign
id|minor
suffix:semicolon
id|ti-&gt;nor_minor
op_assign
id|minor
op_plus
l_int|1
suffix:semicolon
id|ti-&gt;blk_minor
op_assign
id|minor
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|tape_mkdevfsroots
c_func
(paren
id|ti
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Register IRQ */
macro_line|#ifdef CONFIG_S390_TAPE_DYNAMIC
id|rc
op_assign
id|s390_request_irq_special
(paren
id|irq
comma
id|tape_irq
comma
id|tape_noper_handler
comma
l_int|0
comma
l_string|&quot;tape&quot;
comma
op_amp
(paren
id|ti-&gt;devstat
)paren
)paren
suffix:semicolon
macro_line|#else
id|rc
op_assign
id|s390_request_irq
(paren
id|irq
comma
id|tape_irq
comma
l_int|0
comma
l_string|&quot;tape&quot;
comma
op_amp
(paren
id|ti-&gt;devstat
)paren
)paren
suffix:semicolon
macro_line|#endif
id|s390irq_spin_lock_irqsave
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|PRINT_WARN
(paren
l_string|&quot;Cannot register irq %d, rc=%d&bslash;n&quot;
comma
id|irq
comma
id|rc
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|ti-&gt;userbuf
op_assign
id|ti-&gt;discdata
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_UNUSED
)paren
suffix:semicolon
id|ti-&gt;discdata
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;discipline-&gt;setup_assist
(paren
id|ti
)paren
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|0
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; *      tape_init will register the driver for each tape.&n; */
r_int
DECL|function|tape_init
id|tape_init
(paren
r_void
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|s390_dev_info_t
id|dinfo
suffix:semicolon
id|tape_discipline_t
op_star
id|disc
suffix:semicolon
id|tape_info_t
op_star
id|ti
op_assign
l_int|NULL
comma
op_star
id|tempti
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|opt_char
comma
op_star
id|opt_block
comma
op_star
id|opt_3490
comma
op_star
id|opt_3480
suffix:semicolon
r_int
id|irq
op_assign
l_int|0
comma
id|rc
comma
id|retries
op_assign
l_int|0
comma
id|tape_num
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|initialized
)paren
singleline_comment|// Only init the devices once
r_return
l_int|0
suffix:semicolon
id|initialized
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|tape_debug_area
op_assign
id|debug_register
(paren
l_string|&quot;tape&quot;
comma
l_int|3
comma
l_int|2
comma
l_int|10
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|tape_debug_area
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;begin init&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
multiline_comment|/* print banner */
id|PRINT_WARN
(paren
l_string|&quot;IBM S/390 Tape Device Driver (v1.01).&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
(paren
l_string|&quot;(C) IBM Deutschland Entwicklung GmbH, 2000&bslash;n&quot;
)paren
suffix:semicolon
id|opt_char
op_assign
id|opt_block
op_assign
id|opt_3480
op_assign
id|opt_3490
op_assign
l_string|&quot;not present&quot;
suffix:semicolon
macro_line|#ifdef CONFIG_S390_TAPE_CHAR
id|opt_char
op_assign
l_string|&quot;built in&quot;
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
id|opt_block
op_assign
l_string|&quot;built in&quot;
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_3480
id|opt_3480
op_assign
l_string|&quot;built in&quot;
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_3490
id|opt_3490
op_assign
l_string|&quot;built in&quot;
suffix:semicolon
macro_line|#endif
multiline_comment|/* print feature info */
id|PRINT_WARN
(paren
l_string|&quot;character device frontend   : %s&bslash;n&quot;
comma
id|opt_char
)paren
suffix:semicolon
id|PRINT_WARN
(paren
l_string|&quot;block device frontend       : %s&bslash;n&quot;
comma
id|opt_block
)paren
suffix:semicolon
id|PRINT_WARN
(paren
l_string|&quot;support for 3480 compatible : %s&bslash;n&quot;
comma
id|opt_3480
)paren
suffix:semicolon
id|PRINT_WARN
(paren
l_string|&quot;support for 3490 compatible : %s&bslash;n&quot;
comma
id|opt_3490
)paren
suffix:semicolon
macro_line|#ifndef MODULE
id|tape_split_parm_string
c_func
(paren
id|tape_parm_string
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_star
id|tape
)paren
id|PRINT_INFO
(paren
l_string|&quot;Using ranges supplied in parameters, disabling autoprobe mode.&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|PRINT_INFO
(paren
l_string|&quot;No parameters supplied, enabling autoprobe mode for all supported devices.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_S390_TAPE_3490
r_if
c_cond
(paren
op_star
id|tape
)paren
id|first_discipline
op_assign
id|tape3490_init
(paren
l_int|0
)paren
suffix:semicolon
singleline_comment|// no autoprobe for devices
r_else
id|first_discipline
op_assign
id|tape3490_init
(paren
l_int|1
)paren
suffix:semicolon
singleline_comment|// do autoprobe since no parm specified
id|first_discipline-&gt;next
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_3480
r_if
c_cond
(paren
id|first_discipline
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_star
id|tape
)paren
id|first_discipline
op_assign
id|tape3480_init
(paren
l_int|0
)paren
suffix:semicolon
singleline_comment|// no autoprobe for devices
r_else
id|first_discipline
op_assign
id|tape3480_init
(paren
l_int|1
)paren
suffix:semicolon
singleline_comment|// do autoprobe since no parm specified
id|first_discipline-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_star
id|tape
)paren
id|first_discipline-&gt;next
op_assign
id|tape3480_init
(paren
l_int|0
)paren
suffix:semicolon
singleline_comment|// no autoprobe for devices
r_else
id|first_discipline-&gt;next
op_assign
id|tape3480_init
(paren
l_int|1
)paren
suffix:semicolon
singleline_comment|// do autoprobe since no parm specified
(paren
(paren
id|tape_discipline_t
op_star
)paren
(paren
id|first_discipline-&gt;next
)paren
)paren
op_member_access_from_pointer
id|next
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_DEVFS_FS
id|tape_devfs_root_entry
op_assign
id|devfs_mk_dir
(paren
l_int|NULL
comma
l_string|&quot;tape&quot;
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif CONFIG_DEVFS_FS
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;dev detect&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
multiline_comment|/* Allocate the tape structures */
r_if
c_cond
(paren
op_star
id|tape
op_ne
l_int|NULL
)paren
(brace
singleline_comment|// we have parameters, continue with parsing the parameters and set the devices online
id|tape_parm_parse
(paren
id|tape
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// we are running in autodetect mode, search all devices for compatibles
r_for
c_loop
(paren
id|irq
op_assign
id|get_irq_first
c_func
(paren
)paren
suffix:semicolon
id|irq
op_ne
op_minus
id|ENODEV
suffix:semicolon
id|irq
op_assign
id|get_irq_next
c_func
(paren
id|irq
)paren
)paren
(brace
id|rc
op_assign
id|get_dev_info_by_irq
(paren
id|irq
comma
op_amp
id|dinfo
)paren
suffix:semicolon
id|disc
op_assign
id|first_discipline
suffix:semicolon
r_while
c_loop
(paren
(paren
id|disc
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|disc-&gt;cu_type
op_ne
id|dinfo.sid_data.cu_type
)paren
)paren
id|disc
op_assign
(paren
id|tape_discipline_t
op_star
)paren
(paren
id|disc-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|disc
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|rc
op_eq
op_minus
id|ENODEV
)paren
)paren
r_continue
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;det irq:  &quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|3
comma
id|irq
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;cu:       &quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|3
comma
id|disc-&gt;cu_type
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_INFO
(paren
l_string|&quot;using devno %04x with discipline %04x on irq %d as tape device %d&bslash;n&quot;
comma
id|dinfo.devno
comma
id|dinfo.sid_data.cu_type
comma
id|irq
comma
id|tape_num
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Allocate tape structure  */
id|ti
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|tape_info_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;ti:no mem &quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_INFO
(paren
l_string|&quot;tape: can&squot;t allocate memory for &quot;
l_string|&quot;tape info structure&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ti
comma
l_int|0
comma
r_sizeof
(paren
id|tape_info_t
)paren
)paren
suffix:semicolon
id|ti-&gt;discipline
op_assign
id|disc
suffix:semicolon
id|disc-&gt;tape
op_assign
id|ti
suffix:semicolon
id|rc
op_assign
id|tape_setup
(paren
id|ti
comma
id|irq
comma
id|tape_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;tsetup err&quot;
)paren
suffix:semicolon
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|kfree
(paren
id|ti
)paren
suffix:semicolon
)brace
r_else
(brace
id|s390irq_spin_lock_irqsave
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_tape_info
op_eq
l_int|NULL
)paren
(brace
id|first_tape_info
op_assign
id|ti
suffix:semicolon
)brace
r_else
(brace
id|tempti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
id|tempti-&gt;next
op_ne
l_int|NULL
)paren
id|tempti
op_assign
id|tempti-&gt;next
suffix:semicolon
id|tempti-&gt;next
op_assign
id|ti
suffix:semicolon
)brace
id|tape_num
op_add_assign
l_int|2
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|irq
comma
id|lockflags
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Allocate local buffer for the ccwcache       */
id|tape_init_emergency_req
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,98))
id|tape_devices_entry
op_assign
id|create_proc_entry
(paren
l_string|&quot;tapedevices&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
op_amp
id|proc_root
)paren
suffix:semicolon
id|tape_devices_entry-&gt;proc_fops
op_assign
op_amp
id|tape_devices_file_ops
suffix:semicolon
id|tape_devices_entry-&gt;proc_iops
op_assign
op_amp
id|tape_devices_inode_ops
suffix:semicolon
macro_line|#else
id|tape_devices_entry
op_assign
(paren
r_struct
id|proc_dir_entry
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|proc_dir_entry
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tape_devices_entry
)paren
(brace
id|memset
(paren
id|tape_devices_entry
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|proc_dir_entry
)paren
)paren
suffix:semicolon
id|tape_devices_entry-&gt;name
op_assign
l_string|&quot;tapedevices&quot;
suffix:semicolon
id|tape_devices_entry-&gt;namelen
op_assign
id|strlen
(paren
l_string|&quot;tapedevices&quot;
)paren
suffix:semicolon
id|tape_devices_entry-&gt;low_ino
op_assign
l_int|0
suffix:semicolon
id|tape_devices_entry-&gt;mode
op_assign
(paren
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|tape_devices_entry-&gt;nlink
op_assign
l_int|1
suffix:semicolon
id|tape_devices_entry-&gt;uid
op_assign
l_int|0
suffix:semicolon
id|tape_devices_entry-&gt;gid
op_assign
l_int|0
suffix:semicolon
id|tape_devices_entry-&gt;size
op_assign
l_int|0
suffix:semicolon
id|tape_devices_entry-&gt;get_info
op_assign
l_int|NULL
suffix:semicolon
id|tape_devices_entry-&gt;ops
op_assign
op_amp
id|tape_devices_inode_ops
suffix:semicolon
id|proc_register
(paren
op_amp
id|proc_root
comma
id|tape_devices_entry
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif /* CONFIG_PROC_FS */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;(C) 2001 IBM Deutschland Entwicklung GmbH by Carsten Otte (cotte@de.ibm.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux for S/390 channel attached tape device driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
(paren
id|tape
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
(paren
l_int|256
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
r_int
DECL|function|init_module
id|init_module
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_S390_TAPE_CHAR
id|tapechar_init
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
id|tapeblock_init
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|cleanup_module
id|cleanup_module
(paren
r_void
)paren
(brace
id|tape_info_t
op_star
id|ti
comma
op_star
id|temp
suffix:semicolon
id|tape_frontend_t
op_star
id|frontend
comma
op_star
id|tempfe
suffix:semicolon
id|tape_discipline_t
op_star
id|disc
comma
op_star
id|tempdi
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;cleaup mod&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_if
c_cond
(paren
op_star
id|tape
)paren
(brace
singleline_comment|// we are running with parameters. we&squot;ll now deregister from our devno&squot;s
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|devregct
suffix:semicolon
id|i
op_increment
)paren
(brace
id|s390_device_unregister
c_func
(paren
id|tape_devreg
(braket
id|devregct
)braket
)paren
suffix:semicolon
)brace
)brace
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
id|ti
op_ne
l_int|NULL
)paren
(brace
id|temp
op_assign
id|ti
suffix:semicolon
id|ti
op_assign
id|ti-&gt;next
suffix:semicolon
singleline_comment|//cleanup a device 
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;free irq:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|temp-&gt;devinfo.irq
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|free_irq
(paren
id|temp-&gt;devinfo.irq
comma
op_amp
(paren
id|temp-&gt;devstat
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp-&gt;discdata
)paren
id|kfree
(paren
id|temp-&gt;discdata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp-&gt;kernbuf
)paren
id|kfree
(paren
id|temp-&gt;kernbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp-&gt;cqr
)paren
id|tape_free_request
c_func
(paren
id|temp-&gt;cqr
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
r_for
c_loop
(paren
id|frontend
op_assign
id|first_frontend
suffix:semicolon
id|frontend
op_ne
l_int|NULL
suffix:semicolon
id|frontend
op_assign
id|frontend-&gt;next
)paren
id|frontend
op_member_access_from_pointer
id|rmdevfstree
c_func
(paren
id|temp
)paren
suffix:semicolon
id|tape_rmdevfsroots
c_func
(paren
id|temp
)paren
suffix:semicolon
macro_line|#endif
id|kfree
(paren
id|temp
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_DEVFS_FS
id|devfs_unregister
(paren
id|tape_devfs_root_entry
)paren
suffix:semicolon
macro_line|#endif CONFIG_DEVFS_FS
macro_line|#ifdef CONFIG_PROC_FS
macro_line|#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(2,3,98))
id|remove_proc_entry
(paren
l_string|&quot;tapedevices&quot;
comma
op_amp
id|proc_root
)paren
suffix:semicolon
macro_line|#else
id|proc_unregister
(paren
op_amp
id|proc_root
comma
id|tape_devices_entry-&gt;low_ino
)paren
suffix:semicolon
id|kfree
(paren
id|tape_devices_entry
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* LINUX_IS_24 */
macro_line|#endif 
macro_line|#ifdef CONFIG_S390_TAPE_CHAR
id|tapechar_uninit
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_S390_TAPE_BLOCK
id|tapeblock_uninit
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|frontend
op_assign
id|first_frontend
suffix:semicolon
r_while
c_loop
(paren
id|frontend
op_ne
l_int|NULL
)paren
(brace
id|tempfe
op_assign
id|frontend
suffix:semicolon
id|frontend
op_assign
id|frontend-&gt;next
suffix:semicolon
id|kfree
(paren
id|tempfe
)paren
suffix:semicolon
)brace
id|disc
op_assign
id|first_discipline
suffix:semicolon
r_while
c_loop
(paren
id|disc
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_star
id|tape
)paren
id|disc
op_member_access_from_pointer
id|shutdown
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_else
id|disc
op_member_access_from_pointer
id|shutdown
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|tempdi
op_assign
id|disc
suffix:semicolon
id|disc
op_assign
id|disc-&gt;next
suffix:semicolon
id|kfree
(paren
id|tempdi
)paren
suffix:semicolon
)brace
multiline_comment|/* Deallocate the local buffer for the ccwcache         */
id|tape_cleanup_emergency_req
(paren
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_unregister
(paren
id|tape_debug_area
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
macro_line|#endif&t;&t;&t;&t;/* MODULE */
r_inline
r_void
DECL|function|tapestate_set
id|tapestate_set
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|newstate
)paren
(brace
r_if
c_cond
(paren
id|ti-&gt;tape_state
op_eq
id|TS_NOT_OPER
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;ts_set err&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;dev n.oper&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
r_else
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|4
comma
l_string|&quot;ts. dev:  &quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|4
comma
id|ti-&gt;blk_minor
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|4
comma
l_string|&quot;old ts:   &quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|4
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;UNKNOWN TS&quot;
)paren
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|4
comma
l_string|&quot;new ts:   &quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|4
comma
(paren
(paren
(paren
id|newstate
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|newstate
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|newstate
)braket
suffix:colon
l_string|&quot;UNKNOWN TS&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|ti-&gt;tape_state
op_assign
id|newstate
suffix:semicolon
)brace
)brace
r_inline
r_int
DECL|function|tapestate_get
id|tapestate_get
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
r_return
(paren
id|ti-&gt;tape_state
)paren
suffix:semicolon
)brace
r_void
DECL|function|tapestate_event
id|tapestate_event
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|event
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;te! dev:  &quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|ti-&gt;blk_minor
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;event:&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
(paren
(paren
id|event
op_ge
l_int|0
)paren
op_logical_and
(paren
id|event
OL
id|TE_SIZE
)paren
)paren
ques
c_cond
id|event_verbose
(braket
id|event
)braket
suffix:colon
l_string|&quot;TE UNKNOWN&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;state:&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
(paren
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ge
l_int|0
)paren
op_logical_and
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;TS UNKNOWN&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */    
r_if
c_cond
(paren
id|event
op_eq
id|TE_ERROR
)paren
(brace
id|ti-&gt;discipline
op_member_access_from_pointer
id|error_recovery
c_func
(paren
id|ti
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|event
op_ge
l_int|0
)paren
op_logical_and
(paren
id|event
OL
id|TE_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
(paren
op_star
(paren
id|ti-&gt;discipline-&gt;event_table
)paren
)paren
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
(braket
id|event
)braket
op_ne
l_int|NULL
)paren
)paren
(paren
(paren
op_star
(paren
id|ti-&gt;discipline-&gt;event_table
)paren
)paren
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
(braket
id|event
)braket
)paren
(paren
id|ti
)paren
suffix:semicolon
r_else
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;TE UNEXPEC&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|ti-&gt;discipline-&gt;default_handler
(paren
id|ti
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * Emacs will notice this stuff at the end of the file and automatically&n; * adjust the settings for this buffer only.  This must remain at the end&n; * of the file.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-indent-level: 4&n; * c-brace-imaginary-offset: 0&n; * c-brace-offset: -4&n; * c-argdecl-indent: 4&n; * c-label-offset: -4&n; * c-continued-statement-offset: 4&n; * c-continued-brace-offset: 0&n; * indent-tabs-mode: nil&n; * tab-width: 8&n; * End:&n; */
eof
