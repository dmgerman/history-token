multiline_comment|/*&n; *  IBM/3270 Driver -- Copyright (C) 2000 UTS Global LLC&n; *&n; *  tubttyaid.c -- Linemode Attention-ID functionality&n; *&n; *&n; *&n; *&n; *&n; *  Author:  Richard Hitt&n; */
macro_line|#include &quot;tubio.h&quot;
DECL|macro|PA1_STR
mdefine_line|#define PA1_STR &quot;^C&quot;
DECL|macro|PF3_STR
mdefine_line|#define PF3_STR &quot;^D&quot;
DECL|macro|PF9_STR
mdefine_line|#define PF9_STR &quot;&bslash;033j&quot;
DECL|macro|PF10_STR
mdefine_line|#define PF10_STR &quot;&bslash;033k&quot;
DECL|macro|PF11_STR
mdefine_line|#define PF11_STR &quot;&bslash;033j&quot;
multiline_comment|/* other AID-key default strings */
DECL|variable|aidtab
id|aid_t
id|aidtab
(braket
l_int|64
)braket
op_assign
(brace
multiline_comment|/* 00         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* C1 = PF13  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* C2 = PF14  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* C3 = PF15  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* C4 = PF16  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* C5 = PF17  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* C6 = PF18  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* C7 = PF19  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* C8 = PF20  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* C9 = PF21  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* 4A = PF22  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* 4B = PF23  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* 4C = PF24  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* 0D         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 0E         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 0F         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 10         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 11         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 12         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 13         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 14         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 15         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 16         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 17         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 18         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 19         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1A         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1B         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1C         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1D         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1E         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 1F         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 60 = NoAID */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 21         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 22         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 23         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 24         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 25         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* E6 = OpRdr */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* E7 = MSRdr */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* E8 = NoAID */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 29         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 2A         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 6B =  PA3  */
(brace
id|TA_SHORTREAD
comma
l_int|0
)brace
comma
multiline_comment|/* 6C =  PA1  */
(brace
id|TA_SHORTREAD
op_or
id|TA_DOSTRING
comma
id|PA1_STR
)brace
comma
multiline_comment|/* 6D = CLEAR */
(brace
id|TA_SHORTREAD
op_or
id|TA_CLEARKEY
comma
l_int|0
)brace
comma
multiline_comment|/* 6E =  PA2  */
(brace
id|TA_SHORTREAD
op_or
id|TA_CLEARLOG
comma
l_int|0
)brace
comma
multiline_comment|/* 2F         */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* F0 = TstRq */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* F1 =  PF1  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* F2 =  PF2  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* F3 =  PF3  */
(brace
id|TA_DOSTRING
comma
id|PF3_STR
)brace
comma
multiline_comment|/* F4 =  PF4  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* F5 =  PF5  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* F6 =  PF6  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* F7 =  PF7  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* F8 =  PF8  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* F9 =  PF9  */
(brace
id|TA_DOSTRING
comma
id|PF9_STR
)brace
comma
multiline_comment|/* 7A = PF10  */
(brace
id|TA_DOSTRING
comma
id|PF10_STR
)brace
comma
multiline_comment|/* 7B = PF11  */
(brace
id|TA_DOSTRING
comma
id|PF11_STR
)brace
comma
multiline_comment|/* 7C = PF12  */
(brace
id|TA_DOSTRING
comma
l_int|0
)brace
comma
multiline_comment|/* 7D = ENTER */
(brace
id|TA_DOENTER
comma
l_int|0
)brace
comma
multiline_comment|/* 7E = Pen   */
(brace
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* 3F         */
(brace
l_int|0
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
r_int
DECL|function|tty3270_aid_init
id|tty3270_aid_init
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
id|memcpy
c_func
(paren
id|tubp-&gt;tty_aid
comma
id|aidtab
comma
r_sizeof
id|aidtab
)paren
suffix:semicolon
id|tubp-&gt;tty_aidinit
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|tty3270_aid_fini
id|tty3270_aid_fini
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|sp
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;tty_aidinit
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|sp
op_assign
id|tubp-&gt;tty_aid
(braket
id|i
)braket
dot
id|string
)paren
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
id|aidtab
(braket
id|i
)braket
dot
id|string
)paren
r_continue
suffix:semicolon
id|kfree
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
id|tubp-&gt;tty_aidinit
op_assign
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|tty3270_aid_reinit
id|tty3270_aid_reinit
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
id|tty3270_aid_fini
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|tty3270_aid_init
c_func
(paren
id|tubp
)paren
suffix:semicolon
)brace
r_int
DECL|function|tty3270_aid_get
id|tty3270_aid_get
c_func
(paren
id|tub_t
op_star
id|tubp
comma
r_int
id|aid
comma
r_int
op_star
id|aidflags
comma
r_char
op_star
op_star
id|aidstring
)paren
(brace
id|aid_t
op_star
id|ap
suffix:semicolon
id|ap
op_assign
id|AIDENTRY
c_func
(paren
id|aid
comma
id|tubp
)paren
suffix:semicolon
op_star
id|aidflags
op_assign
id|ap-&gt;aid
suffix:semicolon
op_star
id|aidstring
op_assign
id|ap-&gt;string
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * tty3270_aid_set() -- write_proc extension&n; * Parse written string as an AID name.  Return 0 if it&squot;s not.&n; * Otherwise absorb the string and return count or -error.&n; */
r_int
DECL|function|tty3270_aid_set
id|tty3270_aid_set
c_func
(paren
id|tub_t
op_star
id|tubp
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_char
id|name
(braket
l_int|8
)braket
suffix:semicolon
r_char
op_star
id|sp
suffix:semicolon
r_int
id|aidn
comma
id|aidx
suffix:semicolon
id|aid_t
op_star
id|ap
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
op_star
id|pfp
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;tty_aidinit
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|3
)paren
multiline_comment|/* If AID-key name too short */
r_return
l_int|0
suffix:semicolon
id|name
(braket
l_int|0
)braket
op_assign
id|buf
(braket
l_int|0
)braket
OL
l_int|0x60
ques
c_cond
id|buf
(braket
l_int|0
)braket
suffix:colon
(paren
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0x5f
)paren
suffix:semicolon
id|name
(braket
l_int|1
)braket
op_assign
id|buf
(braket
l_int|1
)braket
OL
l_int|0x60
ques
c_cond
id|buf
(braket
l_int|1
)braket
suffix:colon
(paren
id|buf
(braket
l_int|1
)braket
op_amp
l_int|0x5f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;P&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;F&squot;
)paren
(brace
id|aidn
op_assign
id|simple_strtoul
c_func
(paren
id|buf
op_plus
l_int|2
comma
op_amp
id|sp
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aidn
template_param
l_int|24
)paren
r_return
l_int|0
suffix:semicolon
id|aidx
op_assign
id|aidn
OG
l_int|12
ques
c_cond
id|aidn
op_minus
l_int|12
suffix:colon
id|aidn
op_plus
l_int|0x30
suffix:semicolon
id|ap
op_assign
op_amp
id|tubp-&gt;tty_aid
(braket
id|aidx
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;P&squot;
op_logical_and
id|name
(braket
l_int|1
)braket
op_eq
l_char|&squot;A&squot;
)paren
(brace
id|aidn
op_assign
id|simple_strtoul
c_func
(paren
id|buf
op_plus
l_int|2
comma
op_amp
id|sp
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aidn
template_param
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|aidn
)paren
(brace
r_case
l_int|1
suffix:colon
id|aidx
op_assign
l_int|0x2c
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|aidx
op_assign
l_int|0x2e
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|aidx
op_assign
l_int|0x2b
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|aidx
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ap
op_assign
op_amp
id|tubp-&gt;tty_aid
(braket
id|aidx
)braket
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|sp
op_eq
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|tubp-&gt;tty_showaidx
op_assign
id|ap
op_minus
id|tubp-&gt;tty_aid
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|sp
op_eq
l_char|&squot;=&squot;
)paren
(brace
id|len
op_assign
id|strlen
c_func
(paren
op_increment
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ap-&gt;string
op_ne
l_int|NULL
op_logical_and
id|ap-&gt;string
op_ne
id|aidtab
(braket
id|aidx
)braket
dot
id|string
)paren
id|kfree
c_func
(paren
id|ap-&gt;string
)paren
suffix:semicolon
id|ap-&gt;string
op_assign
id|aidtab
(braket
id|aidx
)braket
dot
id|string
suffix:semicolon
id|ap-&gt;aid
op_assign
id|aidtab
(braket
id|aidx
)braket
dot
id|aid
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pfp
op_assign
id|kmalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|ap-&gt;string
op_ne
l_int|NULL
op_logical_and
id|ap-&gt;string
op_ne
id|aidtab
(braket
id|aidx
)braket
dot
id|string
)paren
id|kfree
c_func
(paren
id|ap-&gt;string
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|ap-&gt;aid
op_assign
id|TA_DOSTRING
suffix:semicolon
id|sp
(braket
id|len
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|len
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|ap-&gt;aid
op_assign
id|TA_DOSTRINGD
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|pfp
comma
id|sp
comma
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ap-&gt;string
op_assign
id|pfp
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
eof
