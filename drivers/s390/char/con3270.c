multiline_comment|/*&n; *  drivers/s390/char/con3270.c&n; *    IBM/3270 Driver - console view.&n; *&n; *  Author(s):&n; *    Original 3270 Code for 2.4 written by Richard Hitt (UTS Global)&n; *    Rewritten for 2.5 by Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; *&t;-- Copyright (C) 2003 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/cio.h&gt;
macro_line|#include &lt;asm/cpcmd.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &quot;raw3270.h&quot;
macro_line|#include &quot;ctrlchar.h&quot;
DECL|macro|CON3270_OUTPUT_BUFFER_SIZE
mdefine_line|#define CON3270_OUTPUT_BUFFER_SIZE 1024
DECL|macro|CON3270_STRING_PAGES
mdefine_line|#define CON3270_STRING_PAGES 4
DECL|variable|con3270_fn
r_static
r_struct
id|raw3270_fn
id|con3270_fn
suffix:semicolon
multiline_comment|/*&n; * Main 3270 console view data structure.&n; */
DECL|struct|con3270
r_struct
id|con3270
(brace
DECL|member|view
r_struct
id|raw3270_view
id|view
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|freemem
r_struct
id|list_head
id|freemem
suffix:semicolon
multiline_comment|/* list of free memory for strings. */
multiline_comment|/* Output stuff. */
DECL|member|lines
r_struct
id|list_head
id|lines
suffix:semicolon
multiline_comment|/* list of lines. */
DECL|member|update
r_struct
id|list_head
id|update
suffix:semicolon
multiline_comment|/* list of lines to update. */
DECL|member|line_nr
r_int
id|line_nr
suffix:semicolon
multiline_comment|/* line number for next update. */
DECL|member|nr_lines
r_int
id|nr_lines
suffix:semicolon
multiline_comment|/* # lines in list. */
DECL|member|nr_up
r_int
id|nr_up
suffix:semicolon
multiline_comment|/* # lines up in history. */
DECL|member|update_flags
r_int
r_int
id|update_flags
suffix:semicolon
multiline_comment|/* Update indication bits. */
DECL|member|cline
r_struct
id|string
op_star
id|cline
suffix:semicolon
multiline_comment|/* current output line. */
DECL|member|status
r_struct
id|string
op_star
id|status
suffix:semicolon
multiline_comment|/* last line of display. */
DECL|member|write
r_struct
id|raw3270_request
op_star
id|write
suffix:semicolon
multiline_comment|/* single write request. */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Input stuff. */
DECL|member|input
r_struct
id|string
op_star
id|input
suffix:semicolon
multiline_comment|/* input string for read request. */
DECL|member|read
r_struct
id|raw3270_request
op_star
id|read
suffix:semicolon
multiline_comment|/* single read request. */
DECL|member|kreset
r_struct
id|raw3270_request
op_star
id|kreset
suffix:semicolon
multiline_comment|/* single keyboard reset request. */
DECL|member|readlet
r_struct
id|tasklet_struct
id|readlet
suffix:semicolon
multiline_comment|/* tasklet to issue read request. */
)brace
suffix:semicolon
DECL|variable|condev
r_static
r_struct
id|con3270
op_star
id|condev
suffix:semicolon
multiline_comment|/* con3270-&gt;update_flags. See con3270_update for details. */
DECL|macro|CON_UPDATE_ERASE
mdefine_line|#define CON_UPDATE_ERASE&t;1&t;/* Use EWRITEA instead of WRITE. */
DECL|macro|CON_UPDATE_LIST
mdefine_line|#define CON_UPDATE_LIST&t;&t;2&t;/* Update lines in tty3270-&gt;update. */
DECL|macro|CON_UPDATE_STATUS
mdefine_line|#define CON_UPDATE_STATUS&t;4&t;/* Update status line. */
DECL|macro|CON_UPDATE_ALL
mdefine_line|#define CON_UPDATE_ALL&t;&t;7
r_static
r_void
id|con3270_update
c_func
(paren
r_struct
id|con3270
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * Setup timeout for a device. On timeout trigger an update.&n; */
r_void
DECL|function|con3270_set_timer
id|con3270_set_timer
c_func
(paren
r_struct
id|con3270
op_star
id|cp
comma
r_int
id|expires
)paren
(brace
r_if
c_cond
(paren
id|expires
op_eq
l_int|0
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|cp-&gt;timer
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mod_timer
c_func
(paren
op_amp
id|cp-&gt;timer
comma
id|jiffies
op_plus
id|expires
)paren
)paren
r_return
suffix:semicolon
id|cp-&gt;timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|con3270_update
suffix:semicolon
id|cp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|cp
suffix:semicolon
id|cp-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|expires
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|cp-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The status line is the last line of the screen. It shows the string&n; * &quot;console view&quot; in the lower left corner and &quot;Running&quot;/&quot;More...&quot;/&quot;Holding&quot;&n; * in the lower right corner of the screen.&n; */
r_static
r_void
DECL|function|con3270_update_status
id|con3270_update_status
c_func
(paren
r_struct
id|con3270
op_star
id|cp
)paren
(brace
r_char
op_star
id|str
suffix:semicolon
id|str
op_assign
(paren
id|cp-&gt;nr_up
op_ne
l_int|0
)paren
ques
c_cond
l_string|&quot;History&quot;
suffix:colon
l_string|&quot;Running&quot;
suffix:semicolon
id|memcpy
c_func
(paren
id|cp-&gt;status-&gt;string
op_plus
l_int|24
comma
id|str
comma
l_int|7
)paren
suffix:semicolon
id|codepage_convert
c_func
(paren
id|cp-&gt;view.ascebc
comma
id|cp-&gt;status-&gt;string
op_plus
l_int|24
comma
l_int|7
)paren
suffix:semicolon
id|cp-&gt;update_flags
op_or_assign
id|CON_UPDATE_STATUS
suffix:semicolon
)brace
r_static
r_void
DECL|function|con3270_create_status
id|con3270_create_status
c_func
(paren
r_struct
id|con3270
op_star
id|cp
)paren
(brace
r_static
r_const
r_int
r_char
id|blueprint
(braket
)braket
op_assign
(brace
id|TO_SBA
comma
l_int|0
comma
l_int|0
comma
id|TO_SF
comma
id|TF_LOG
comma
id|TO_SA
comma
id|TAT_COLOR
comma
id|TAC_GREEN
comma
l_char|&squot;c&squot;
comma
l_char|&squot;o&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;s&squot;
comma
l_char|&squot;o&squot;
comma
l_char|&squot;l&squot;
comma
l_char|&squot;e&squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot;v&squot;
comma
l_char|&squot;i&squot;
comma
l_char|&squot;e&squot;
comma
l_char|&squot;w&squot;
comma
id|TO_RA
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_char|&squot;R&squot;
comma
l_char|&squot;u&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;i&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;g&squot;
comma
id|TO_SF
comma
id|TF_LOG
)brace
suffix:semicolon
id|cp-&gt;status
op_assign
id|alloc_string
c_func
(paren
op_amp
id|cp-&gt;freemem
comma
r_sizeof
(paren
id|blueprint
)paren
)paren
suffix:semicolon
multiline_comment|/* Copy blueprint to status line */
id|memcpy
c_func
(paren
id|cp-&gt;status-&gt;string
comma
id|blueprint
comma
r_sizeof
(paren
id|blueprint
)paren
)paren
suffix:semicolon
multiline_comment|/* Set TO_RA addresses. */
id|raw3270_buffer_address
c_func
(paren
id|cp-&gt;view.dev
comma
id|cp-&gt;status-&gt;string
op_plus
l_int|1
comma
id|cp-&gt;view.cols
op_star
(paren
id|cp-&gt;view.rows
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|raw3270_buffer_address
c_func
(paren
id|cp-&gt;view.dev
comma
id|cp-&gt;status-&gt;string
op_plus
l_int|21
comma
id|cp-&gt;view.cols
op_star
id|cp-&gt;view.rows
op_minus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Convert strings to ebcdic. */
id|codepage_convert
c_func
(paren
id|cp-&gt;view.ascebc
comma
id|cp-&gt;status-&gt;string
op_plus
l_int|8
comma
l_int|12
)paren
suffix:semicolon
id|codepage_convert
c_func
(paren
id|cp-&gt;view.ascebc
comma
id|cp-&gt;status-&gt;string
op_plus
l_int|24
comma
l_int|7
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set output offsets to 3270 datastream fragment of a console string.&n; */
r_static
r_void
DECL|function|con3270_update_string
id|con3270_update_string
c_func
(paren
r_struct
id|con3270
op_star
id|cp
comma
r_struct
id|string
op_star
id|s
comma
r_int
id|nr
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;len
op_ge
id|cp-&gt;view.cols
op_minus
l_int|5
)paren
r_return
suffix:semicolon
id|raw3270_buffer_address
c_func
(paren
id|cp-&gt;view.dev
comma
id|s-&gt;string
op_plus
id|s-&gt;len
op_minus
l_int|3
comma
id|cp-&gt;view.cols
op_star
(paren
id|nr
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Rebuild update list to print all lines.&n; */
r_static
r_void
DECL|function|con3270_rebuild_update
id|con3270_rebuild_update
c_func
(paren
r_struct
id|con3270
op_star
id|cp
)paren
(brace
r_struct
id|string
op_star
id|s
comma
op_star
id|n
suffix:semicolon
r_int
id|nr
suffix:semicolon
multiline_comment|/* &n;&t; * Throw away update list and create a new one,&n;&t; * containing all lines that will fit on the screen.&n;&t; */
id|list_for_each_entry_safe
c_func
(paren
id|s
comma
id|n
comma
op_amp
id|cp-&gt;update
comma
id|update
)paren
id|list_del_init
c_func
(paren
op_amp
id|s-&gt;update
)paren
suffix:semicolon
id|nr
op_assign
id|cp-&gt;view.rows
op_minus
l_int|2
op_plus
id|cp-&gt;nr_up
suffix:semicolon
id|list_for_each_entry_reverse
c_func
(paren
id|s
comma
op_amp
id|cp-&gt;lines
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|nr
OL
id|cp-&gt;view.rows
op_minus
l_int|1
)paren
id|list_add
c_func
(paren
op_amp
id|s-&gt;update
comma
op_amp
id|cp-&gt;update
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|nr
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|cp-&gt;line_nr
op_assign
l_int|0
suffix:semicolon
id|cp-&gt;update_flags
op_or_assign
id|CON_UPDATE_LIST
suffix:semicolon
)brace
multiline_comment|/*&n; * Alloc string for size bytes. Free strings from history if necessary.&n; */
r_static
r_struct
id|string
op_star
DECL|function|con3270_alloc_string
id|con3270_alloc_string
c_func
(paren
r_struct
id|con3270
op_star
id|cp
comma
r_int
id|size
)paren
(brace
r_struct
id|string
op_star
id|s
comma
op_star
id|n
suffix:semicolon
id|s
op_assign
id|alloc_string
c_func
(paren
op_amp
id|cp-&gt;freemem
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
)paren
r_return
id|s
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|s
comma
id|n
comma
op_amp
id|cp-&gt;lines
comma
id|list
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|s-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|s-&gt;update
)paren
)paren
id|list_del
c_func
(paren
op_amp
id|s-&gt;update
)paren
suffix:semicolon
id|cp-&gt;nr_lines
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|free_string
c_func
(paren
op_amp
id|cp-&gt;freemem
comma
id|s
)paren
op_ge
id|size
)paren
r_break
suffix:semicolon
)brace
id|s
op_assign
id|alloc_string
c_func
(paren
op_amp
id|cp-&gt;freemem
comma
id|size
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;nr_up
op_ne
l_int|0
op_logical_and
id|cp-&gt;nr_up
op_plus
id|cp-&gt;view.rows
OG
id|cp-&gt;nr_lines
)paren
(brace
id|cp-&gt;nr_up
op_assign
id|cp-&gt;nr_lines
op_minus
id|cp-&gt;view.rows
op_plus
l_int|1
suffix:semicolon
id|con3270_rebuild_update
c_func
(paren
id|cp
)paren
suffix:semicolon
id|con3270_update_status
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
r_return
id|s
suffix:semicolon
)brace
multiline_comment|/*&n; * Write completion callback.&n; */
r_static
r_void
DECL|function|con3270_write_callback
id|con3270_write_callback
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
r_void
op_star
id|data
)paren
(brace
id|raw3270_request_reset
c_func
(paren
id|rq
)paren
suffix:semicolon
id|xchg
c_func
(paren
op_amp
(paren
(paren
r_struct
id|con3270
op_star
)paren
id|rq-&gt;view
)paren
op_member_access_from_pointer
id|write
comma
id|rq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Update console display.&n; */
r_static
r_void
DECL|function|con3270_update
id|con3270_update
c_func
(paren
r_struct
id|con3270
op_star
id|cp
)paren
(brace
r_struct
id|raw3270_request
op_star
id|wrq
suffix:semicolon
r_char
id|wcc
comma
id|prolog
(braket
l_int|6
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|updated
suffix:semicolon
r_struct
id|string
op_star
id|s
comma
op_star
id|n
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|wrq
op_assign
id|xchg
c_func
(paren
op_amp
id|cp-&gt;write
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wrq
)paren
(brace
id|con3270_set_timer
c_func
(paren
id|cp
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|updated
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;update_flags
op_amp
id|CON_UPDATE_ERASE
)paren
(brace
multiline_comment|/* Use erase write alternate to initialize display. */
id|raw3270_request_set_cmd
c_func
(paren
id|wrq
comma
id|TC_EWRITEA
)paren
suffix:semicolon
id|updated
op_or_assign
id|CON_UPDATE_ERASE
suffix:semicolon
)brace
r_else
id|raw3270_request_set_cmd
c_func
(paren
id|wrq
comma
id|TC_WRITE
)paren
suffix:semicolon
id|wcc
op_assign
id|TW_NONE
suffix:semicolon
id|raw3270_request_add_data
c_func
(paren
id|wrq
comma
op_amp
id|wcc
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Update status line.&n;&t; */
r_if
c_cond
(paren
id|cp-&gt;update_flags
op_amp
id|CON_UPDATE_STATUS
)paren
r_if
c_cond
(paren
id|raw3270_request_add_data
c_func
(paren
id|wrq
comma
id|cp-&gt;status-&gt;string
comma
id|cp-&gt;status-&gt;len
)paren
op_eq
l_int|0
)paren
id|updated
op_or_assign
id|CON_UPDATE_STATUS
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;update_flags
op_amp
id|CON_UPDATE_LIST
)paren
(brace
id|prolog
(braket
l_int|0
)braket
op_assign
id|TO_SBA
suffix:semicolon
id|prolog
(braket
l_int|3
)braket
op_assign
id|TO_SA
suffix:semicolon
id|prolog
(braket
l_int|4
)braket
op_assign
id|TAT_COLOR
suffix:semicolon
id|prolog
(braket
l_int|5
)braket
op_assign
id|TAC_TURQ
suffix:semicolon
id|raw3270_buffer_address
c_func
(paren
id|cp-&gt;view.dev
comma
id|prolog
op_plus
l_int|1
comma
id|cp-&gt;view.cols
op_star
id|cp-&gt;line_nr
)paren
suffix:semicolon
id|raw3270_request_add_data
c_func
(paren
id|wrq
comma
id|prolog
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Write strings in the update list to the screen. */
id|list_for_each_entry_safe
c_func
(paren
id|s
comma
id|n
comma
op_amp
id|cp-&gt;update
comma
id|update
)paren
(brace
r_if
c_cond
(paren
id|s
op_ne
id|cp-&gt;cline
)paren
id|con3270_update_string
c_func
(paren
id|cp
comma
id|s
comma
id|cp-&gt;line_nr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw3270_request_add_data
c_func
(paren
id|wrq
comma
id|s-&gt;string
comma
id|s-&gt;len
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|s-&gt;update
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_ne
id|cp-&gt;cline
)paren
id|cp-&gt;line_nr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|cp-&gt;update
)paren
)paren
id|updated
op_or_assign
id|CON_UPDATE_LIST
suffix:semicolon
)brace
id|wrq-&gt;callback
op_assign
id|con3270_write_callback
suffix:semicolon
id|rc
op_assign
id|raw3270_start
c_func
(paren
op_amp
id|cp-&gt;view
comma
id|wrq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|cp-&gt;update_flags
op_and_assign
op_complement
id|updated
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;update_flags
)paren
id|con3270_set_timer
c_func
(paren
id|cp
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|raw3270_request_reset
c_func
(paren
id|wrq
)paren
suffix:semicolon
id|xchg
c_func
(paren
op_amp
id|cp-&gt;write
comma
id|wrq
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Read tasklet.&n; */
r_static
r_void
DECL|function|con3270_read_tasklet
id|con3270_read_tasklet
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rrq
)paren
(brace
r_static
r_char
id|kreset_data
op_assign
id|TW_KR
suffix:semicolon
r_struct
id|con3270
op_star
id|cp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|nr_up
comma
id|deactivate
suffix:semicolon
id|cp
op_assign
(paren
r_struct
id|con3270
op_star
)paren
id|rrq-&gt;view
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|nr_up
op_assign
id|cp-&gt;nr_up
suffix:semicolon
id|deactivate
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check aid byte. */
r_switch
c_cond
(paren
id|cp-&gt;input-&gt;string
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0x7d
suffix:colon
multiline_comment|/* enter: jump to bottom. */
id|nr_up
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf3
suffix:colon
multiline_comment|/* PF3: deactivate the console view. */
id|deactivate
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x6d
suffix:colon
multiline_comment|/* clear: start from scratch. */
id|con3270_rebuild_update
c_func
(paren
id|cp
)paren
suffix:semicolon
id|cp-&gt;update_flags
op_assign
id|CON_UPDATE_ALL
suffix:semicolon
id|con3270_set_timer
c_func
(paren
id|cp
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xf7
suffix:colon
multiline_comment|/* PF7: do a page up in the console log. */
id|nr_up
op_add_assign
id|cp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|nr_up
op_plus
id|cp-&gt;view.rows
op_minus
l_int|1
OG
id|cp-&gt;nr_lines
)paren
(brace
id|nr_up
op_assign
id|cp-&gt;nr_lines
op_minus
id|cp-&gt;view.rows
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|nr_up
OL
l_int|0
)paren
id|nr_up
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0xf8
suffix:colon
multiline_comment|/* PF8: do a page down in the console log. */
id|nr_up
op_sub_assign
id|cp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|nr_up
OL
l_int|0
)paren
id|nr_up
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nr_up
op_ne
id|cp-&gt;nr_up
)paren
(brace
id|cp-&gt;nr_up
op_assign
id|nr_up
suffix:semicolon
id|con3270_rebuild_update
c_func
(paren
id|cp
)paren
suffix:semicolon
id|con3270_update_status
c_func
(paren
id|cp
)paren
suffix:semicolon
id|con3270_set_timer
c_func
(paren
id|cp
comma
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Start keyboard reset command. */
id|raw3270_request_reset
c_func
(paren
id|cp-&gt;kreset
)paren
suffix:semicolon
id|raw3270_request_set_cmd
c_func
(paren
id|cp-&gt;kreset
comma
id|TC_WRITE
)paren
suffix:semicolon
id|raw3270_request_add_data
c_func
(paren
id|cp-&gt;kreset
comma
op_amp
id|kreset_data
comma
l_int|1
)paren
suffix:semicolon
id|raw3270_start
c_func
(paren
op_amp
id|cp-&gt;view
comma
id|cp-&gt;kreset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|deactivate
)paren
id|raw3270_deactivate_view
c_func
(paren
op_amp
id|cp-&gt;view
)paren
suffix:semicolon
id|raw3270_request_reset
c_func
(paren
id|rrq
)paren
suffix:semicolon
id|xchg
c_func
(paren
op_amp
id|cp-&gt;read
comma
id|rrq
)paren
suffix:semicolon
id|raw3270_put_view
c_func
(paren
op_amp
id|cp-&gt;view
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Read request completion callback.&n; */
r_static
r_void
DECL|function|con3270_read_callback
id|con3270_read_callback
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
r_void
op_star
id|data
)paren
(brace
id|raw3270_get_view
c_func
(paren
id|rq-&gt;view
)paren
suffix:semicolon
multiline_comment|/* Schedule tasklet to pass input to tty. */
id|tasklet_schedule
c_func
(paren
op_amp
(paren
(paren
r_struct
id|con3270
op_star
)paren
id|rq-&gt;view
)paren
op_member_access_from_pointer
id|readlet
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Issue a read request. Called only from interrupt function.&n; */
r_static
r_void
DECL|function|con3270_issue_read
id|con3270_issue_read
c_func
(paren
r_struct
id|con3270
op_star
id|cp
)paren
(brace
r_struct
id|raw3270_request
op_star
id|rrq
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rrq
op_assign
id|xchg
c_func
(paren
op_amp
id|cp-&gt;read
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rrq
)paren
multiline_comment|/* Read already scheduled. */
r_return
suffix:semicolon
id|rrq-&gt;callback
op_assign
id|con3270_read_callback
suffix:semicolon
id|rrq-&gt;callback_data
op_assign
id|cp
suffix:semicolon
id|raw3270_request_set_cmd
c_func
(paren
id|rrq
comma
id|TC_READMOD
)paren
suffix:semicolon
id|raw3270_request_set_data
c_func
(paren
id|rrq
comma
id|cp-&gt;input-&gt;string
comma
id|cp-&gt;input-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Issue the read modified request. */
id|rc
op_assign
id|raw3270_start_irq
c_func
(paren
op_amp
id|cp-&gt;view
comma
id|rrq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|raw3270_request_reset
c_func
(paren
id|rrq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Switch to the console view.&n; */
r_static
r_int
DECL|function|con3270_activate
id|con3270_activate
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|con3270
op_star
id|cp
suffix:semicolon
id|cp
op_assign
(paren
r_struct
id|con3270
op_star
)paren
id|view
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|cp-&gt;nr_up
op_assign
l_int|0
suffix:semicolon
id|con3270_rebuild_update
c_func
(paren
id|cp
)paren
suffix:semicolon
id|con3270_update_status
c_func
(paren
id|cp
)paren
suffix:semicolon
id|cp-&gt;update_flags
op_assign
id|CON_UPDATE_ALL
suffix:semicolon
id|con3270_set_timer
c_func
(paren
id|cp
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|con3270_deactivate
id|con3270_deactivate
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|con3270
op_star
id|cp
suffix:semicolon
id|cp
op_assign
(paren
r_struct
id|con3270
op_star
)paren
id|view
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|cp-&gt;timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|con3270_irq
id|con3270_irq
c_func
(paren
r_struct
id|con3270
op_star
id|cp
comma
r_struct
id|raw3270_request
op_star
id|rq
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
multiline_comment|/* Handle ATTN. Schedule tasklet to read aid. */
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_ATTENTION
)paren
id|con3270_issue_read
c_func
(paren
id|cp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq
)paren
(brace
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
id|rq-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_else
multiline_comment|/* Normal end. Copy residual count. */
id|rq-&gt;rescnt
op_assign
id|irb-&gt;scsw.count
suffix:semicolon
)brace
r_return
id|RAW3270_IO_DONE
suffix:semicolon
)brace
multiline_comment|/* Console view to a 3270 device. */
DECL|variable|con3270_fn
r_static
r_struct
id|raw3270_fn
id|con3270_fn
op_assign
(brace
dot
id|activate
op_assign
id|con3270_activate
comma
dot
id|deactivate
op_assign
id|con3270_deactivate
comma
dot
id|intv
op_assign
(paren
r_void
op_star
)paren
id|con3270_irq
)brace
suffix:semicolon
r_static
r_inline
r_void
DECL|function|con3270_cline_add
id|con3270_cline_add
c_func
(paren
r_struct
id|con3270
op_star
id|cp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|cp-&gt;cline-&gt;list
)paren
)paren
multiline_comment|/* Already added. */
r_return
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|cp-&gt;cline-&gt;list
comma
op_amp
id|cp-&gt;lines
)paren
suffix:semicolon
id|cp-&gt;nr_lines
op_increment
suffix:semicolon
id|con3270_rebuild_update
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|con3270_cline_insert
id|con3270_cline_insert
c_func
(paren
r_struct
id|con3270
op_star
id|cp
comma
r_int
r_char
id|c
)paren
(brace
id|cp-&gt;cline-&gt;string
(braket
id|cp-&gt;cline-&gt;len
op_increment
)braket
op_assign
id|cp-&gt;view.ascebc
(braket
(paren
id|c
OL
l_char|&squot; &squot;
)paren
ques
c_cond
l_char|&squot; &squot;
suffix:colon
id|c
)braket
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|cp-&gt;cline-&gt;update
)paren
)paren
(brace
id|list_add_tail
c_func
(paren
op_amp
id|cp-&gt;cline-&gt;update
comma
op_amp
id|cp-&gt;update
)paren
suffix:semicolon
id|cp-&gt;update_flags
op_or_assign
id|CON_UPDATE_LIST
suffix:semicolon
)brace
)brace
r_static
r_inline
r_void
DECL|function|con3270_cline_end
id|con3270_cline_end
c_func
(paren
r_struct
id|con3270
op_star
id|cp
)paren
(brace
r_struct
id|string
op_star
id|s
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
multiline_comment|/* Copy cline. */
id|size
op_assign
(paren
id|cp-&gt;cline-&gt;len
OL
id|cp-&gt;view.cols
op_minus
l_int|5
)paren
ques
c_cond
id|cp-&gt;cline-&gt;len
op_plus
l_int|4
suffix:colon
id|cp-&gt;view.cols
suffix:semicolon
id|s
op_assign
id|con3270_alloc_string
c_func
(paren
id|cp
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|s-&gt;string
comma
id|cp-&gt;cline-&gt;string
comma
id|cp-&gt;cline-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;len
OL
id|cp-&gt;view.cols
op_minus
l_int|5
)paren
(brace
id|s-&gt;string
(braket
id|s-&gt;len
op_minus
l_int|4
)braket
op_assign
id|TO_RA
suffix:semicolon
id|s-&gt;string
(braket
id|s-&gt;len
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
op_decrement
id|size
OG
id|cp-&gt;cline-&gt;len
)paren
id|s-&gt;string
(braket
id|size
)braket
op_assign
id|cp-&gt;view.ascebc
(braket
l_char|&squot; &squot;
)braket
suffix:semicolon
)brace
multiline_comment|/* Replace cline with allocated line s and reset cline. */
id|list_add
c_func
(paren
op_amp
id|s-&gt;list
comma
op_amp
id|cp-&gt;cline-&gt;list
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|cp-&gt;cline-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|cp-&gt;cline-&gt;update
)paren
)paren
(brace
id|list_add
c_func
(paren
op_amp
id|s-&gt;update
comma
op_amp
id|cp-&gt;cline-&gt;update
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|cp-&gt;cline-&gt;update
)paren
suffix:semicolon
)brace
id|cp-&gt;cline-&gt;len
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Write a string to the 3270 console&n; */
r_static
r_void
DECL|function|con3270_write
id|con3270_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|str
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|con3270
op_star
id|cp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
id|cp
op_assign
id|condev
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;view.dev
)paren
id|raw3270_activate_view
c_func
(paren
op_amp
id|cp-&gt;view
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
op_decrement
OG
l_int|0
)paren
(brace
id|c
op_assign
op_star
id|str
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;cline-&gt;len
op_eq
l_int|0
)paren
id|con3270_cline_add
c_func
(paren
id|cp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_ne
l_char|&squot;&bslash;n&squot;
)paren
id|con3270_cline_insert
c_func
(paren
id|cp
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;&bslash;n&squot;
op_logical_or
id|cp-&gt;cline-&gt;len
op_ge
id|cp-&gt;view.cols
)paren
id|con3270_cline_end
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup timer to output current console buffer after 1/10 second */
r_if
c_cond
(paren
id|cp-&gt;view.dev
op_logical_and
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|cp-&gt;timer
)paren
)paren
id|con3270_set_timer
c_func
(paren
id|cp
comma
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_extern
r_struct
id|tty_driver
op_star
id|tty3270_driver
suffix:semicolon
r_static
r_struct
id|tty_driver
op_star
DECL|function|con3270_device
id|con3270_device
c_func
(paren
r_struct
id|console
op_star
id|c
comma
r_int
op_star
id|index
)paren
(brace
op_star
id|index
op_assign
id|c-&gt;index
suffix:semicolon
r_return
id|tty3270_driver
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for end of write request.&n; */
r_static
r_void
DECL|function|con3270_wait_write
id|con3270_wait_write
c_func
(paren
r_struct
id|con3270
op_star
id|cp
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|cp-&gt;write
)paren
(brace
id|raw3270_wait_cons_dev
c_func
(paren
id|cp-&gt;view.dev
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * panic() calls console_unblank before the system enters a&n; * disabled, endless loop.&n; */
r_static
r_void
DECL|function|con3270_unblank
id|con3270_unblank
c_func
(paren
r_void
)paren
(brace
r_struct
id|con3270
op_star
id|cp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|cp
op_assign
id|condev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cp-&gt;view.dev
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|con3270_wait_write
c_func
(paren
id|cp
)paren
suffix:semicolon
id|cp-&gt;nr_up
op_assign
l_int|0
suffix:semicolon
id|con3270_rebuild_update
c_func
(paren
id|cp
)paren
suffix:semicolon
id|con3270_update_status
c_func
(paren
id|cp
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cp-&gt;update_flags
op_ne
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|con3270_update
c_func
(paren
id|cp
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|con3270_wait_write
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|cp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|con3270_consetup
id|con3270_consetup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *  The console structure for the 3270 console&n; */
DECL|variable|con3270
r_static
r_struct
id|console
id|con3270
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;tty3270&quot;
comma
dot
id|write
op_assign
id|con3270_write
comma
dot
id|device
op_assign
id|con3270_device
comma
dot
id|unblank
op_assign
id|con3270_unblank
comma
dot
id|setup
op_assign
id|con3270_consetup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * 3270 console initialization code called from console_init().&n; * NOTE: This is called before kmalloc is available.&n; */
r_static
r_int
id|__init
DECL|function|con3270_init
id|con3270_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_void
op_star
id|cbuf
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Check if 3270 is to be the console */
r_if
c_cond
(paren
op_logical_neg
id|CONSOLE_IS_3270
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Set the console mode for VM */
r_if
c_cond
(paren
id|MACHINE_IS_VM
)paren
(brace
id|cpcmd
c_func
(paren
l_string|&quot;TERM CONMODE 3270&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|cpcmd
c_func
(paren
l_string|&quot;TERM AUTOCR OFF&quot;
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|cdev
op_assign
id|ccw_device_probe_console
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cdev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|rp
op_assign
id|raw3270_setup_console
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|rp
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|rp
)paren
suffix:semicolon
id|condev
op_assign
(paren
r_struct
id|con3270
op_star
)paren
id|alloc_bootmem_low
c_func
(paren
r_sizeof
(paren
r_struct
id|con3270
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|condev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|con3270
)paren
)paren
suffix:semicolon
id|condev-&gt;view.dev
op_assign
id|rp
suffix:semicolon
id|condev-&gt;read
op_assign
id|raw3270_request_alloc_bootmem
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|condev-&gt;read-&gt;callback
op_assign
id|con3270_read_callback
suffix:semicolon
id|condev-&gt;read-&gt;callback_data
op_assign
id|condev
suffix:semicolon
id|condev-&gt;write
op_assign
id|raw3270_request_alloc_bootmem
c_func
(paren
id|CON3270_OUTPUT_BUFFER_SIZE
)paren
suffix:semicolon
id|condev-&gt;kreset
op_assign
id|raw3270_request_alloc_bootmem
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|condev-&gt;lines
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|condev-&gt;update
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|condev-&gt;timer
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|condev-&gt;readlet
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|con3270_read_tasklet
comma
(paren
r_int
r_int
)paren
id|condev-&gt;read
)paren
suffix:semicolon
id|raw3270_add_view
c_func
(paren
op_amp
id|condev-&gt;view
comma
op_amp
id|con3270_fn
comma
l_int|0
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|condev-&gt;freemem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CON3270_STRING_PAGES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cbuf
op_assign
(paren
r_void
op_star
)paren
id|alloc_bootmem_low_pages
c_func
(paren
id|PAGE_SIZE
)paren
suffix:semicolon
id|add_string_memory
c_func
(paren
op_amp
id|condev-&gt;freemem
comma
id|cbuf
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
id|condev-&gt;cline
op_assign
id|alloc_string
c_func
(paren
op_amp
id|condev-&gt;freemem
comma
id|condev-&gt;view.cols
)paren
suffix:semicolon
id|condev-&gt;cline-&gt;len
op_assign
l_int|0
suffix:semicolon
id|con3270_create_status
c_func
(paren
id|condev
)paren
suffix:semicolon
id|condev-&gt;input
op_assign
id|alloc_string
c_func
(paren
op_amp
id|condev-&gt;freemem
comma
l_int|80
)paren
suffix:semicolon
id|register_console
c_func
(paren
op_amp
id|con3270
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|con3270_init
id|console_initcall
c_func
(paren
id|con3270_init
)paren
suffix:semicolon
eof
