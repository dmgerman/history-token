multiline_comment|/***************************************************************************&n; *&n; *  drivers/s390/char/tape34xx.c&n; *    common tape device discipline for 34xx tapes.&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001 IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *               Michael Holzheu &lt;holzheu@de.ibm.com&gt;&n; *               Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&n; ****************************************************************************&n; */
macro_line|#include &quot;tapedefs.h&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#include &quot;tape.h&quot;
macro_line|#include &quot;tape34xx.h&quot;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/tape390.h&gt;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;T3xxx:&quot;
multiline_comment|/*&n; * Done Handler is called when dev stat = DEVICE-END (successfull operation)&n; */
DECL|function|tape34xx_done_handler
r_void
id|tape34xx_done_handler
c_func
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|__u8
op_star
id|data
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|treq-&gt;op
)braket
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;done&bslash;n&quot;
)paren
suffix:semicolon
id|treq-&gt;rc
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|treq-&gt;op
)paren
(brace
r_case
id|TO_BSB
suffix:colon
r_case
id|TO_BSF
suffix:colon
r_case
id|TO_DSE
suffix:colon
r_case
id|TO_FSB
suffix:colon
r_case
id|TO_FSF
suffix:colon
r_case
id|TO_LBL
suffix:colon
r_case
id|TO_RFO
suffix:colon
r_case
id|TO_RBA
suffix:colon
r_case
id|TO_REW
suffix:colon
r_case
id|TO_WRI
suffix:colon
r_case
id|TO_WTM
suffix:colon
r_case
id|TO_BLOCK
suffix:colon
r_case
id|TO_LOAD
suffix:colon
r_case
id|TO_DIS
suffix:colon
id|tape_med_state_set
c_func
(paren
id|td
comma
id|MS_LOADED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TO_NOP
suffix:colon
r_break
suffix:semicolon
r_case
id|TO_RUN
suffix:colon
id|tape_med_state_set
c_func
(paren
id|td
comma
id|MS_UNLOADED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TO_RBI
suffix:colon
id|data
op_assign
id|treq-&gt;kernbuf
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;data: %04x %04x&bslash;n&quot;
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
op_amp
id|data
(braket
l_int|0
)braket
)paren
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
op_amp
id|data
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|i
op_add_assign
l_int|256
op_star
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|i
op_add_assign
l_int|65536
op_star
(paren
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x3F
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
op_amp
id|i
comma
l_int|4
)paren
suffix:semicolon
id|tape_med_state_set
c_func
(paren
id|td
comma
id|MS_LOADED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;TE UNEXPEC&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_default_handler
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|treq-&gt;wakeup
)paren
(brace
id|treq-&gt;wakeup
(paren
id|treq
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called, when no request is outstanding and we get an&n; * interrupt&n; */
DECL|function|tape34xx_unsolicited_irq
r_void
id|tape34xx_unsolicited_irq
c_func
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
r_if
c_cond
(paren
id|td-&gt;devstat.dstat
op_eq
l_int|0x85
multiline_comment|/* READY */
)paren
(brace
singleline_comment|// A medium was inserted in the drive!
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xuud med&bslash;n&quot;
)paren
suffix:semicolon
id|tape_med_state_set
c_func
(paren
id|td
comma
id|MS_LOADED
)paren
suffix:semicolon
)brace
r_else
(brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;unsol.irq! dev end: %x&bslash;n&quot;
comma
id|td-&gt;devinfo.irq
)paren
suffix:semicolon
id|PRINT_WARN
(paren
l_string|&quot;Unsolicited IRQ (Device End) caught.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
(paren
id|td
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * tape34xx_display &n; */
r_int
DECL|function|tape34xx_display
id|tape34xx_display
(paren
id|tape_dev_t
op_star
id|td
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|display_struct
id|d_struct
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
op_assign
l_int|NULL
suffix:semicolon
id|ccw1_t
op_star
id|ccw
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ds
op_assign
l_int|17
suffix:semicolon
multiline_comment|/* datasize  */
r_int
id|ccw_cnt
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* ccw count */
r_int
id|op
op_assign
id|TO_DIS
suffix:semicolon
multiline_comment|/* tape operation */
r_int
id|i
op_assign
l_int|0
comma
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
id|rc
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|d_struct
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|d_struct
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
r_goto
id|error
suffix:semicolon
id|treq
op_assign
id|tape_alloc_ccw_req
c_func
(paren
id|ccw_cnt
comma
id|ds
comma
l_int|0
comma
id|op
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
r_goto
id|error
suffix:semicolon
(paren
(paren
r_int
r_char
op_star
)paren
id|treq-&gt;kernbuf
)paren
(braket
l_int|0
)braket
op_assign
id|d_struct.cntrl
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
(paren
(paren
r_int
r_char
op_star
)paren
id|treq-&gt;kernbuf
)paren
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|d_struct.message1
(braket
id|i
)braket
suffix:semicolon
(paren
(paren
r_int
r_char
op_star
)paren
id|treq-&gt;kernbuf
)paren
(braket
id|i
op_plus
l_int|9
)braket
op_assign
id|d_struct.message2
(braket
id|i
)braket
suffix:semicolon
)brace
id|ASCEBC
(paren
(paren
(paren
r_int
r_char
op_star
)paren
id|treq-&gt;kernbuf
)paren
op_plus
l_int|1
comma
l_int|16
)paren
suffix:semicolon
id|ccw
op_assign
id|treq-&gt;cpaddr
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|LOAD_DISPLAY
comma
l_int|17
comma
id|treq-&gt;kernbuf
comma
l_int|1
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT_INTERRUPTIBLE
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * ioctl_overload &n; */
r_int
DECL|function|tape34xx_ioctl_overload
id|tape34xx_ioctl_overload
(paren
id|tape_dev_t
op_star
id|td
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|TAPE390_DISPLAY
)paren
r_return
id|tape34xx_display
c_func
(paren
id|td
comma
id|arg
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|// no additional ioctls
)brace
multiline_comment|/*******************************************************************&n; * Request creating functions:&n; *******************************************************************/
multiline_comment|/*&n; * 34xx IOCTLS&n; *&n; * MTFSF: Forward space over &squot;count&squot; file marks. The tape is positioned&n; * at the EOT (End of Tape) side of the file mark.&n; *&n; * MTBSF: Backward space over &squot;count&squot; file marks. The tape is positioned at&n; * the EOT (End of Tape) side of the last skipped file mark.&n; *&n; * MTFSR: Forward space over &squot;count&squot; tape blocks (blocksize is set&n; * via MTSETBLK.&n; *&n; * MTBSR: Backward space over &squot;count&squot; tape blocks.&n; * (blocksize is set via MTSETBLK.&n; *&n; * MTWEOF: Write &squot;count&squot; file marks at the current position.&n; *&n; * MTREW: Rewind the tape.&n; *&n; * MTOFFL: Rewind the tape and put the drive off-line.&n; * Implement &squot;rewind unload&squot;&n; *&n; * MTNOP: &squot;No operation&squot;.&n; *&n; * MTBSFM: Backward space over &squot;count&squot; file marks.&n; * The tape is positioned at the BOT (Begin Of Tape) side of the&n; * last skipped file mark.&n; *&n; * MTFSFM: Forward space over &squot;count&squot; file marks.&n; * The tape is positioned at the BOT (Begin Of Tape) side&n; * of the last skipped file mark.&n; *&n; * MTEOM: positions at the end of the portion of the tape already used&n; * for recordind data. MTEOM positions after the last file mark, ready for&n; * appending another file.&n; * MTRETEN: Retension the tape, i.e. forward space to end of tape and rewind.&n; *&n; * MTERASE: erases the tape.&n; *&n; * MTSETDENSITY: set tape density.&n; *&n; * MTSEEK: seek to the specified block.&n; *&n; * MTTELL: Tell block. Return the number of block relative to current file.&n; *&n; * MTSETDRVBUFFER: Set the tape drive buffer code to number.&n; * Implement NOP.&n; *&n; * MTLOCK: Locks the tape drive door.&n; * Implement NOP CCW command.&n; *&n; * MTUNLOCK: Unlocks the tape drive door.&n; * Implement the NOP CCW command.&n; *&n; * MTLOAD: Loads the tape.&n; * This function is not implemented and returns NULL, which causes the&n; * Frontend to wait for a medium being loaded.&n; * The 3480/3490 type Tapes do not support a load command&n; *&n; * MTUNLOAD: Rewind the tape and unload it.&n; *&n; * MTCOMPRESSION: used to enable compression.&n; * Sets the IDRC on/off.&n; *&n; * MTSTPART: Move the tape head at the partition with the number &squot;count&squot;.&n; * Implement the NOP CCW command.&n; *&n; * MTMKPART: .... dummy .&n; * Implement the NOP CCW command.&n; *&n; * MTIOCGET: query the tape drive status.&n; *&n; * MTIOCPOS: query the tape position.&n; *&n; */
id|tape_ccw_req_t
op_star
DECL|function|tape34xx_ioctl
id|tape34xx_ioctl
c_func
(paren
id|tape_dev_t
op_star
id|td
comma
r_int
id|mtcmd
comma
r_int
id|count
comma
r_int
op_star
id|rc
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
l_int|NULL
suffix:semicolon
id|ccw1_t
op_star
id|ccw
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ds
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* datasize  */
r_int
id|ccw_cnt
suffix:semicolon
multiline_comment|/* ccw count */
r_int
id|op
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* tape operation */
id|tape_sprintf_event
c_func
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;34xxioctl: op(%x) count(%x)&bslash;n&quot;
comma
id|mtcmd
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* Preprocessing */
r_switch
c_cond
(paren
id|mtcmd
)paren
(brace
r_case
id|MTLOAD
suffix:colon
op_star
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error
suffix:semicolon
r_case
id|MTIOCGET
suffix:colon
op_star
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error
suffix:semicolon
r_case
id|MTIOCPOS
suffix:colon
op_star
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error
suffix:semicolon
r_case
id|MTFSF
suffix:colon
id|op
op_assign
id|TO_FSF
suffix:semicolon
id|ccw_cnt
op_assign
id|count
op_plus
l_int|2
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSF
suffix:colon
id|op
op_assign
id|TO_BSF
suffix:semicolon
id|ccw_cnt
op_assign
id|count
op_plus
l_int|2
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSR
suffix:colon
id|op
op_assign
id|TO_FSB
suffix:semicolon
id|ccw_cnt
op_assign
id|count
op_plus
l_int|2
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSR
suffix:colon
id|op
op_assign
id|TO_BSB
suffix:semicolon
id|ccw_cnt
op_assign
id|count
op_plus
l_int|2
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
id|op
op_assign
id|TO_WTM
suffix:semicolon
id|ccw_cnt
op_assign
id|count
op_plus
l_int|2
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTREW
suffix:colon
id|op
op_assign
id|TO_REW
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTOFFL
suffix:colon
id|op
op_assign
id|TO_RUN
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTNOP
suffix:colon
id|op
op_assign
id|TO_NOP
suffix:semicolon
id|ccw_cnt
op_assign
l_int|2
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSFM
suffix:colon
id|op
op_assign
id|TO_BSF
suffix:semicolon
id|ccw_cnt
op_assign
id|count
op_plus
l_int|2
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSFM
suffix:colon
id|op
op_assign
id|TO_FSF
suffix:semicolon
id|ccw_cnt
op_assign
id|count
op_plus
l_int|2
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
id|op
op_assign
id|TO_FSF
suffix:semicolon
id|ccw_cnt
op_assign
l_int|4
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTERASE
suffix:colon
id|op
op_assign
id|TO_DSE
suffix:semicolon
id|ccw_cnt
op_assign
l_int|5
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETDENSITY
suffix:colon
id|op
op_assign
id|TO_NOP
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSEEK
suffix:colon
id|op
op_assign
id|TO_LBL
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTTELL
suffix:colon
id|op
op_assign
id|TO_RBI
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETDRVBUFFER
suffix:colon
id|op
op_assign
id|TO_NOP
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTLOCK
suffix:colon
id|op
op_assign
id|TO_NOP
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTUNLOCK
suffix:colon
id|op
op_assign
id|TO_NOP
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTUNLOAD
suffix:colon
id|op
op_assign
id|TO_RUN
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTCOMPRESSION
suffix:colon
id|op
op_assign
id|TO_NOP
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETPART
suffix:colon
id|op
op_assign
id|TO_NOP
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTMKPART
suffix:colon
id|op
op_assign
id|TO_NOP
suffix:semicolon
id|ccw_cnt
op_assign
l_int|3
suffix:semicolon
id|ds
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_ERR
c_func
(paren
l_string|&quot;IOCTL %x not implemented&bslash;n&quot;
comma
id|op
)paren
suffix:semicolon
op_star
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ccw_cnt
OG
l_int|510
)paren
(brace
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;wrng parm&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|treq
op_assign
id|tape_alloc_ccw_req
c_func
(paren
id|ccw_cnt
comma
id|ds
comma
l_int|0
comma
id|op
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
(brace
op_star
id|rc
op_assign
op_minus
id|ENOSPC
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ccw
op_assign
id|treq-&gt;cpaddr
suffix:semicolon
multiline_comment|/* setup first ccw */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|MODE_SET_DB
comma
l_int|1
comma
op_amp
id|MOD_BYTE
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* setup middle ccw(s) */
r_switch
c_cond
(paren
id|mtcmd
)paren
(brace
r_case
id|MTFSF
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|FORSPACEFILE
comma
l_int|0
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSF
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|BACKSPACEFILE
comma
l_int|0
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSR
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|FORSPACEBLOCK
comma
l_int|0
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSR
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|BACKSPACEBLOCK
comma
l_int|0
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|WRITETAPEMARK
comma
l_int|0
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
singleline_comment|// this operation does _always_ write only one tape mark :(
r_break
suffix:semicolon
r_case
id|MTREW
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|REWIND
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTOFFL
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|REWIND_UNLOAD
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTUNLOCK
suffix:colon
r_case
id|MTLOCK
suffix:colon
r_case
id|MTSETDRVBUFFER
suffix:colon
r_case
id|MTSETDENSITY
suffix:colon
r_case
id|MTSETPART
suffix:colon
r_case
id|MTMKPART
suffix:colon
r_case
id|MTNOP
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSFM
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|BACKSPACEFILE
comma
l_int|0
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSFM
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|FORSPACEFILE
comma
l_int|0
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|FORSPACEFILE
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTERASE
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|REWIND
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|ERASE_GAP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|DATA_SEC_ERASE
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTTELL
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|READ_BLOCK_ID
comma
l_int|8
comma
id|treq-&gt;kernbuf
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTUNLOAD
suffix:colon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|REWIND_UNLOAD
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTCOMPRESSION
suffix:colon
r_if
c_cond
(paren
(paren
id|count
OL
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|1
)paren
)paren
(brace
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xcom parm&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|PRINT_INFO
c_func
(paren
l_string|&quot;(%x) Compression switched off&bslash;n&quot;
comma
id|td-&gt;devstat.devno
)paren
suffix:semicolon
id|MOD_BYTE
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// IDRC off
)brace
r_else
(brace
id|PRINT_INFO
c_func
(paren
l_string|&quot;(%x) Compression switched on&bslash;n&quot;
comma
id|td-&gt;devstat.devno
)paren
suffix:semicolon
id|MOD_BYTE
op_assign
l_int|0x08
suffix:semicolon
singleline_comment|// IDRC on
)brace
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// Modset does the job
r_case
id|MTSEEK
suffix:colon
(brace
id|__u8
op_star
id|data
op_assign
id|treq-&gt;kernbuf
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|2
)braket
op_assign
id|data
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
l_int|4194304
)paren
(brace
id|tape_sprintf_exception
c_func
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xsee parm&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MOD_BYTE
op_logical_and
l_int|0x08
)paren
(brace
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|1
)braket
op_or
l_int|0x80
suffix:semicolon
)brace
id|data
(braket
l_int|3
)braket
op_add_assign
id|count
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_add_assign
(paren
id|count
op_div
l_int|256
)paren
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_add_assign
(paren
id|count
op_div
l_int|65536
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|LOCATE
comma
l_int|4
comma
id|treq-&gt;kernbuf
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;IOCTL %x not implemented&bslash;n&quot;
comma
id|op
)paren
suffix:semicolon
op_star
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* setup last ccw */
r_switch
c_cond
(paren
id|mtcmd
)paren
(brace
r_case
id|MTEOM
suffix:colon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|CCW_CMD_TIC
comma
l_int|0
comma
id|treq-&gt;cpaddr
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTUNLOAD
suffix:colon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|SENSE
comma
l_int|32
comma
id|treq-&gt;kernbuf
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|rc
op_assign
l_int|0
suffix:semicolon
r_return
id|treq
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|treq
)paren
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Write Block &n; */
id|tape_ccw_req_t
op_star
DECL|function|tape34xx_write_block
id|tape34xx_write_block
(paren
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
id|tape_dev_t
op_star
id|td
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
l_int|NULL
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|treq
op_assign
id|tape_alloc_ccw_req
(paren
l_int|2
comma
l_int|0
comma
id|count
comma
id|TO_WRI
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|idalbuf_copy_from_user
(paren
id|treq-&gt;idal_buf
comma
id|data
comma
id|count
)paren
)paren
(brace
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xwbl segf.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ccw
op_assign
id|treq-&gt;cpaddr
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|MODE_SET_DB
comma
l_int|1
comma
op_amp
id|MOD_BYTE
comma
l_int|1
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end_idal
c_func
(paren
id|ccw
comma
id|WRITE_CMD
comma
id|treq-&gt;idal_buf
)paren
suffix:semicolon
id|treq-&gt;userbuf
op_assign
(paren
r_void
op_star
)paren
id|data
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xwbl ccwg&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|treq
suffix:semicolon
id|error
suffix:colon
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xwbl fail&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
)paren
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Read Block&n; */
id|tape_ccw_req_t
op_star
DECL|function|tape34xx_read_block
id|tape34xx_read_block
(paren
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
id|tape_dev_t
op_star
id|td
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
l_int|NULL
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
multiline_comment|/* we have to alloc 4 ccws in order to be able to transform request */
multiline_comment|/* into a read backward request in error case                       */
id|treq
op_assign
id|tape_alloc_ccw_req
(paren
l_int|4
comma
l_int|0
comma
id|count
comma
id|TO_RFO
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
r_goto
id|error
suffix:semicolon
id|treq-&gt;userbuf
op_assign
(paren
r_void
op_star
)paren
id|data
suffix:semicolon
id|treq-&gt;userbuf_size
op_assign
id|count
suffix:semicolon
id|ccw
op_assign
id|treq-&gt;cpaddr
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|MODE_SET_DB
comma
l_int|1
comma
op_amp
id|MOD_BYTE
comma
l_int|1
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end_idal
c_func
(paren
id|ccw
comma
id|READ_FORWARD
comma
id|treq-&gt;idal_buf
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xrbl ccwg&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|treq
suffix:semicolon
id|error
suffix:colon
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xrbl fail&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
)paren
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Read Opposite Error Recovery Function:&n; * Used, when Read Forward does not work&n; */
id|tape_ccw_req_t
op_star
DECL|function|tape34xx_read_opposite
id|tape34xx_read_opposite
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
op_eq
l_int|NULL
)paren
singleline_comment|// no request to recover?
id|BUG
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// transform read forward request into read backward request.
id|ccw
op_assign
id|treq-&gt;cpaddr
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|MODE_SET_DB
comma
l_int|1
comma
op_amp
id|MOD_BYTE
comma
l_int|1
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc_idal
c_func
(paren
id|ccw
comma
id|READ_BACKWARD
comma
id|treq-&gt;idal_buf
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|FORSPACEBLOCK
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|treq-&gt;op
op_assign
id|TO_RBA
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xrop ccwg&quot;
)paren
suffix:semicolon
r_return
id|treq
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape Block READ&n; */
DECL|function|tape34xx_bread
id|tape_ccw_req_t
op_star
id|tape34xx_bread
(paren
r_struct
id|request
op_star
id|req
comma
id|tape_dev_t
op_star
id|td
comma
r_int
id|tapeblock_major
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|__u8
op_star
id|data
suffix:semicolon
r_int
id|s2b
op_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|td-&gt;first_minor
)braket
op_div
id|hardsect_size
(braket
id|tapeblock_major
)braket
(braket
id|td-&gt;first_minor
)braket
suffix:semicolon
r_int
id|realcount
op_assign
l_int|0
suffix:semicolon
r_int
id|size
comma
id|bhct
op_assign
l_int|0
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_size
OG
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|td-&gt;first_minor
)braket
)paren
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|td-&gt;first_minor
)braket
)paren
id|bhct
op_increment
suffix:semicolon
r_else
id|bhct
op_increment
suffix:semicolon
)brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xBREDid:&quot;
)paren
suffix:semicolon
id|treq
op_assign
id|tape_alloc_ccw_req
(paren
l_int|2
op_plus
id|bhct
op_plus
l_int|1
comma
l_int|4
comma
l_int|0
comma
id|TO_BLOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
(brace
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xBREDnomem&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|data
op_assign
id|treq-&gt;kernbuf
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|2
)braket
op_assign
id|data
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
id|realcount
op_assign
id|req-&gt;sector
op_div
id|s2b
suffix:semicolon
r_if
c_cond
(paren
id|MOD_BYTE
op_amp
l_int|0x08
)paren
singleline_comment|// IDRC on
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|1
)braket
op_or
l_int|0x80
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_add_assign
id|realcount
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_add_assign
(paren
id|realcount
op_div
l_int|256
)paren
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_add_assign
(paren
id|realcount
op_div
l_int|65536
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;realcount = %i&bslash;n&quot;
comma
id|realcount
)paren
suffix:semicolon
id|ccw
op_assign
id|treq-&gt;cpaddr
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|MODE_SET_DB
comma
l_int|1
comma
op_amp
id|MOD_BYTE
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|realcount
op_ne
id|td-&gt;blk_data.position
)paren
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|LOCATE
comma
l_int|4
comma
id|treq-&gt;kernbuf
comma
l_int|1
)paren
suffix:semicolon
r_else
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|td-&gt;blk_data.position
op_assign
id|realcount
op_plus
id|req-&gt;nr_sectors
op_div
id|s2b
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_size
op_ge
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|td-&gt;first_minor
)braket
)paren
(brace
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|td-&gt;first_minor
)braket
)paren
(brace
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_FORWARD
suffix:semicolon
id|ccw-&gt;count
op_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|td-&gt;first_minor
)braket
suffix:semicolon
id|set_normalized_cda
c_func
(paren
id|ccw
comma
id|__pa
c_func
(paren
id|bh-&gt;b_data
op_plus
id|size
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* group N bhs to fit into byt_per_blk */
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xBREDccwg&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|treq
suffix:semicolon
id|error
suffix:colon
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xBREDccwg fail&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
)paren
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|tape34xx_free_bread
r_void
id|tape34xx_free_bread
(paren
id|tape_ccw_req_t
op_star
id|treq
)paren
(brace
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_for
c_loop
(paren
id|ccw
op_assign
(paren
id|ccw1_t
op_star
)paren
id|treq-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_CC
suffix:semicolon
id|ccw
op_increment
)paren
r_if
c_cond
(paren
id|ccw-&gt;cmd_code
op_eq
id|READ_FORWARD
)paren
id|clear_normalized_cda
c_func
(paren
id|ccw
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
)brace
singleline_comment|// FIXME: Comment?
DECL|function|tape34xx_bread_enable_locate
r_void
id|tape34xx_bread_enable_locate
(paren
id|tape_ccw_req_t
op_star
id|treq
)paren
(brace
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
id|treq
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|ccw
op_assign
id|treq-&gt;cpaddr
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|ccw
comma
id|LOCATE
comma
l_int|4
comma
id|treq-&gt;kernbuf
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*******************************************************************&n; * Event Handlers&n; *******************************************************************/
multiline_comment|/*&n; * Default Handler is called, when an unexpected IRQ comes in&n; */
r_void
DECL|function|tape34xx_default_handler
id|tape34xx_default_handler
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xdefhandle&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: An unexpected Unit Check occurred.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: Please read Documentation/s390/TAPE and report it!&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: Current op is: %s&quot;
comma
id|tape_op_verbose
(braket
id|treq-&gt;op
)braket
)paren
suffix:semicolon
id|tape_dump_sense
(paren
id|td
)paren
suffix:semicolon
id|treq-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|treq-&gt;wakeup
)paren
(brace
id|treq-&gt;wakeup
(paren
id|treq
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* This function analyses the tape&squot;s sense-data in case of a unit-check. */
multiline_comment|/* If possible, it tries to recover from the error. Else the user is */
multiline_comment|/* informed about the problem.  */
r_void
DECL|function|tape34xx_error_recovery
id|tape34xx_error_recovery
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|__u8
op_star
id|sense
op_assign
id|td-&gt;devstat.ii.sense.data
suffix:semicolon
r_int
id|inhibit_cu_recovery
op_assign
l_int|0
suffix:semicolon
r_int
id|cu_type
op_assign
id|td-&gt;discipline-&gt;cu_type
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
op_eq
l_int|NULL
)paren
(brace
singleline_comment|// Nothing to recover! Why call me?
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MOD_BYTE
op_amp
l_int|0x80
)paren
id|inhibit_cu_recovery
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|treq-&gt;op
op_eq
id|TO_BLOCK
)paren
(brace
singleline_comment|// no recovery for block device, bottom half will retry...
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_COMMAND_REJECT
)paren
r_switch
c_cond
(paren
id|treq-&gt;op
)paren
(brace
r_case
id|TO_DSE
suffix:colon
r_case
id|TO_EGA
suffix:colon
r_case
id|TO_WRI
suffix:colon
r_case
id|TO_WTM
suffix:colon
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_WRITE_PROTECT
)paren
(brace
singleline_comment|// trying to write, but medium is write protected
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EACCES
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_default
suffix:colon
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// special cases for various tape-states when reaching end of recorded area
r_if
c_cond
(paren
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_eq
l_int|0x08
)paren
op_logical_or
(paren
id|sense
(braket
l_int|0
)braket
op_eq
l_int|0x10
)paren
op_logical_or
(paren
id|sense
(braket
l_int|0
)braket
op_eq
l_int|0x12
)paren
)paren
op_logical_and
(paren
(paren
id|sense
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
op_logical_or
(paren
id|sense
(braket
l_int|1
)braket
op_eq
l_int|0x0c
)paren
)paren
)paren
r_switch
c_cond
(paren
id|treq-&gt;op
)paren
(brace
r_case
id|TO_FSF
suffix:colon
singleline_comment|// Trying to seek beyond end of recorded area
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|TO_LBL
suffix:colon
singleline_comment|// Block could not be located.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|TO_RFO
suffix:colon
singleline_comment|// Try to read beyond end of recorded area -&gt; 0 bytes read
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Invalid op in %s:%i&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|__LINE__
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// Sensing special bits
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_BUS_OUT_CHECK
)paren
(brace
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_DATA_CHECK
)paren
(brace
singleline_comment|// hardware failure, damaged tape or improper operating conditions
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x23
suffix:colon
singleline_comment|// a read data check occurred
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SENSE_TAPE_SYNC_MODE
)paren
op_logical_or
(paren
id|inhibit_cu_recovery
)paren
)paren
(brace
singleline_comment|// data check is not permanent, may be recovered. 
singleline_comment|// We always use async-mode with cu-recovery, so this should *never* happen.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// data check is permanent, CU recovery has failed
id|PRINT_WARN
c_func
(paren
l_string|&quot;Permanent read error, recovery failed!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x25
suffix:colon
singleline_comment|// a write data check occurred
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SENSE_TAPE_SYNC_MODE
)paren
op_logical_or
(paren
id|inhibit_cu_recovery
)paren
)paren
(brace
singleline_comment|// data check is not permanent, may be recovered.
singleline_comment|// We always use async-mode with cu-recovery, so this should *never* happen.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|3
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// data check is permanent, cu-recovery has failed
id|PRINT_WARN
c_func
(paren
l_string|&quot;Permanent write error, recovery failed!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x26
suffix:colon
singleline_comment|// Data Check (read opposite) occurred. We&squot;ll recover this.
id|tape34xx_error_recovery_read_opposite
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x28
suffix:colon
singleline_comment|// The ID-Mark at the beginning of the tape could not be written. This is fatal, we&squot;ll report and exit.
id|PRINT_WARN
c_func
(paren
l_string|&quot;ID-Mark could not be written. Check your hardware!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x31
suffix:colon
singleline_comment|// Tape void. Tried to read beyond end of device. We&squot;ll report and exit.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Try to read beyond end of recorded area!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|ENOSPC
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x41
suffix:colon
singleline_comment|// Record sequence error. cu detected incorrect block-id sequence on tape. We&squot;ll report and exit.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Illegal block-id sequence found!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
(brace
)brace
singleline_comment|// well, all data checks for 3480 should result in one of the above erpa-codes. if not -&gt; bug
singleline_comment|// On 3490, other data-check conditions do exist.
r_if
c_cond
(paren
id|cu_type
op_eq
l_int|0x3480
)paren
(brace
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|4
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_OVERRUN
)paren
(brace
singleline_comment|// A data overrun between cu and drive occurred. The channel speed is to slow! We&squot;ll report this and exit!
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x40
suffix:colon
singleline_comment|// overrun error
id|PRINT_WARN
(paren
l_string|&quot;Data overrun error between control-unit and drive. Use a faster channel connection, if possible! &bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
singleline_comment|// Overrun bit is set, but erpa does not show overrun error. This is a bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|5
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_RECORD_SEQUENCE_ERR
)paren
(brace
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x41
suffix:colon
singleline_comment|// Record sequence error. cu detected incorrect block-id sequence on tape. We&squot;ll report and exit.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Illegal block-id sequence found!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
singleline_comment|// Record sequence error bit is set, but erpa does not show record sequence error. This is a bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|6
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
singleline_comment|// Sensing erpa codes
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x00
suffix:colon
singleline_comment|// Everything is fine, but we got a unit check. Report and ignore!
id|PRINT_WARN
(paren
l_string|&quot;Non-error sense was found. Unit-check will be ignored, expect errors...&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x21
suffix:colon
singleline_comment|// Data streaming not operational. Cu switches to interlock mode, we reissue the command.
id|PRINT_WARN
(paren
l_string|&quot;Data streaming not operational. Switching to interlock-mode! &bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x22
suffix:colon
singleline_comment|// Path equipment check. Might be drive adapter error, buffer error on the lower interface, internal path not useable, or error during cartridge load.
singleline_comment|// All of the above are not recoverable
id|PRINT_WARN
(paren
l_string|&quot;A path equipment check occurred. One of the following conditions occurred:&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
(paren
l_string|&quot;drive adapter error,buffer error on the lower interface, internal path not useable, error during cartridge load.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x23
suffix:colon
singleline_comment|// Read data check. Should have been be covered earlier -&gt; Bug!
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|7
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x24
suffix:colon
singleline_comment|// Load display check. Load display was command was issued, but the drive is displaying a drive check message. Can be threated as &quot;device end&quot;.
id|tape34xx_error_recovery_succeded
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x25
suffix:colon
singleline_comment|// Write data check. Should have been covered earlier -&gt; Bug!
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|8
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x26
suffix:colon
singleline_comment|// Data check (read opposite). Should have been covered earlier -&gt; Bug!
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|9
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x27
suffix:colon
singleline_comment|// Command reject. May indicate illegal channel program or buffer over/underrun. 
singleline_comment|// Since all channel programms are issued by this driver and ought be correct,
singleline_comment|// we assume a over/underrun situaltion and retry the channel program.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x28
suffix:colon
singleline_comment|// Write id mark check. Should have beed covered earlier -&gt; bug!
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|10
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x29
suffix:colon
singleline_comment|// Function incompatible. Either idrc is on but hardware not capable doing idrc 
singleline_comment|// or a perform subsystem func is issued and the cu is not online. Anyway, this 
singleline_comment|// cannot be recovered and is an I/O error.
id|PRINT_WARN
(paren
l_string|&quot;Function incompatible. Try to switch off idrc! &bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2a
suffix:colon
singleline_comment|// Unsolicited environmental data. An internal counter overflows, we can ignore
singleline_comment|// this and reissue the cmd.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2b
suffix:colon
singleline_comment|// Environmental data present. Indicates either unload completed ok or read buffered 
singleline_comment|// log command completed ok. 
r_if
c_cond
(paren
id|treq-&gt;op
op_eq
id|TO_RUN
)paren
(brace
singleline_comment|// Rewind unload completed ok.
id|tape34xx_error_recovery_succeded
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// Since we do not issue read buffered log commands, this should never occur -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|11
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2c
suffix:colon
singleline_comment|// Permanent equipment check. cu has tried recovery, but did not succeed. This is an
singleline_comment|// I/O error.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2d
suffix:colon
singleline_comment|// Data security erase failure.
r_if
c_cond
(paren
id|treq-&gt;op
op_eq
id|TO_DSE
)paren
(brace
singleline_comment|// report an I/O error
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// Data security erase failure, but no such command issued. This is a bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|12
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2e
suffix:colon
singleline_comment|// Not capable. This indicates either that the drive fails reading the format id mark
singleline_comment|// or that that format specified is not supported by the drive. We write a message and
singleline_comment|// return an I/O error.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Drive not capable processing the tape format!&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EMEDIUMTYPE
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2f
suffix:colon
singleline_comment|// This erpa is reserved. This is a bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|13
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x30
suffix:colon
singleline_comment|// The medium is write protected, while trying to write on it. We&squot;ll report this.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Medium is write protected!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EACCES
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x31
suffix:colon
singleline_comment|// Tape void. Should have beed covered ealier -&gt; bug
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|14
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x32
suffix:colon
singleline_comment|// Tension loss. We cannot recover this, it&squot;s an I/O error.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive lost tape tension.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x33
suffix:colon
singleline_comment|// Load Failure. The catridge was not inserted correctly or the tape is not threaded
singleline_comment|// correctly. We cannot recover this, the user has to reload the catridge.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Cartridge load failure. Reload the cartridge and try again.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x34
suffix:colon
singleline_comment|// Unload failure. The drive cannot maintain tape tension and control tape movement 
singleline_comment|// during an unload operation. 
id|PRINT_WARN
c_func
(paren
l_string|&quot;Failure during cartridge unload. Please try manually.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq-&gt;op
op_ne
id|TO_RUN
)paren
(brace
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|15
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x35
suffix:colon
singleline_comment|// Drive equipment check. One of the following:
singleline_comment|// - cu cannot recover from a drive detected error
singleline_comment|// - a check code message is displayed on drive message/load displays
singleline_comment|// - the cartridge loader does not respond correctly
singleline_comment|// - a failure occurs during an index, load, or unload cycle
id|PRINT_WARN
c_func
(paren
l_string|&quot;Equipment check! Please check the drive and the cartridge loader.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x36
suffix:colon
r_switch
c_cond
(paren
id|cu_type
)paren
(brace
r_case
l_int|0x3480
suffix:colon
singleline_comment|// This erpa is reserved for 3480 -&gt; BUG
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3490
suffix:colon
singleline_comment|// End of data. This is a permanent I/O error, which cannot be recovered.
singleline_comment|// A read-type command has reached the end-of-data mark.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x37
suffix:colon
singleline_comment|// Tape length error. The tape is shorter than reported in the beginning-of-tape data.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape length error.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x38
suffix:colon
singleline_comment|// Physical end of tape. A read/write operation reached the physical end of tape.
r_if
c_cond
(paren
id|treq-&gt;op
op_eq
id|TO_WRI
op_logical_or
id|treq-&gt;op
op_eq
id|TO_DSE
op_logical_or
id|treq-&gt;op
op_eq
id|TO_EGA
op_logical_or
id|treq-&gt;op
op_eq
id|TO_WTM
)paren
(brace
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|ENOSPC
)paren
suffix:semicolon
)brace
r_else
(brace
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
r_case
l_int|0x39
suffix:colon
singleline_comment|// Backward at BOT. The drive is at BOT and is requestet to move backward.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3a
suffix:colon
singleline_comment|// Drive switched not ready, but the command needs the drive to be ready.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Drive not ready. Turn the ready/not ready switch to ready position and try again.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3b
suffix:colon
singleline_comment|// Manual rewind or unload. This causes an I/O error.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Medium was rewound or unloaded manually. Expect errors! Please do only use the mtoffl and mtrew ioctl to unload tapes or rewind tapes.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3c
suffix:colon
r_case
l_int|0x3d
suffix:colon
r_case
l_int|0x3e
suffix:colon
r_case
l_int|0x3f
suffix:colon
singleline_comment|// These erpas are reserved -&gt; BUG
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|17
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x40
suffix:colon
singleline_comment|// Overrun error. This should have been covered earlier -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|18
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x41
suffix:colon
singleline_comment|// Record sequence error. This should have been covered earlier -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|19
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x42
suffix:colon
singleline_comment|// Degraded mode. A condition that can cause degraded performace is detected.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Subsystem is running in degraded mode. This may compromise your performace.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x43
suffix:colon
singleline_comment|// Drive not ready. Probably swith the ready/not ready switch to ready?
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is not ready. Maybe no medium in?&bslash;n&quot;
)paren
suffix:semicolon
id|tape_med_state_set
c_func
(paren
id|td
comma
id|MS_UNLOADED
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|ENOMEDIUM
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x44
suffix:colon
singleline_comment|// Locate Block unsuccessfull. We&squot;ll report this.
r_if
c_cond
(paren
(paren
id|treq-&gt;op
op_ne
id|TO_BLOCK
)paren
op_logical_and
(paren
id|treq-&gt;op
op_ne
id|TO_LBL
)paren
)paren
(brace
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|20
)paren
suffix:semicolon
singleline_comment|// No locate block was issued...
r_return
suffix:semicolon
)brace
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x45
suffix:colon
singleline_comment|// The drive is assigned elsewhere [to a different channel path/computer].
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is assigned elsewhere.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x46
suffix:colon
singleline_comment|// Drive not online. Drive may be switched offline, the power supply may be switched off 
singleline_comment|// or the drive address may not be set correctly.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is not online.&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x47
suffix:colon
singleline_comment|// Volume fenced. cu reports volume integrity is lost! 
id|PRINT_WARN
c_func
(paren
l_string|&quot;Volume fenced. The volume integrity is lost! &bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x48
suffix:colon
singleline_comment|// Log sense data and retry request. We&squot;ll do so...
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x49
suffix:colon
singleline_comment|// Bus out check. A parity check error on the bus was found.&t;PRINT_WARN(&quot;Bus out check. A data transfer over the bus was corrupted.&bslash;n&quot;);
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x4a
suffix:colon
singleline_comment|// Control unit erp failed. We&squot;ll report this.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The control unit failed recovering an I/O error.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x4b
suffix:colon
singleline_comment|// Cu and drive incompatible. The drive requests micro-program patches, which are not available on the cu.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive needs microprogram patches from the control unit, which are not available.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x4c
suffix:colon
singleline_comment|// Recovered Check-One failure. Cu develops a hardware error, but is able to recover. We&squot;ll reissue the command.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x4d
suffix:colon
r_switch
c_cond
(paren
id|cu_type
)paren
(brace
r_case
l_int|0x3480
suffix:colon
singleline_comment|// This erpa is reserved for 3480 -&gt; bug
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|21
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3490
suffix:colon
singleline_comment|// Resetting event received. Since the driver does not support resetting event recovery
singleline_comment|// (which has to be handled by the I/O Layer), we&squot;ll report and retry our command.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x4e
suffix:colon
r_switch
c_cond
(paren
id|cu_type
)paren
(brace
r_case
l_int|0x3480
suffix:colon
singleline_comment|// This erpa is reserved for 3480 -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|22
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3490
suffix:colon
singleline_comment|// Maximum block size exeeded. This indicates, that the block to be written is larger
singleline_comment|// than allowed for buffered mode. We&squot;ll report this...
id|PRINT_WARN
c_func
(paren
l_string|&quot;Maximum block size for buffered mode exceeded.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|ENOBUFS
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x4f
suffix:colon
singleline_comment|// These erpas are reserved -&gt; bug
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|23
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x50
suffix:colon
singleline_comment|// Read buffered log (Overflow). Cu is running in extended beffered log mode, and a counter overflows.
singleline_comment|// This should never happen, since we&squot;re never running in extended buffered log mode -&gt; bug.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x51
suffix:colon
singleline_comment|// Read buffered log (EOV). EOF processing occurs while the cu is in extended buffered log mode.
singleline_comment|// This should never happen, since we&squot;re never running in extended buffered log mode -&gt; bug.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x52
suffix:colon
singleline_comment|// End of Volume complete. Rewind unload completed ok. We&squot;ll report to the user...
r_if
c_cond
(paren
id|treq-&gt;op
op_ne
id|TO_RUN
)paren
(brace
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|24
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tape34xx_error_recovery_succeded
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x53
suffix:colon
singleline_comment|// Global command intercept. We&squot;ll have to reissue our command.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x54
suffix:colon
singleline_comment|// Channel interface recovery (temporary). This can be recovered by reissuing the command.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x55
suffix:colon
singleline_comment|// Channel interface recovery (permanent). This cannot be recovered, we&squot;ll inform the user.
id|PRINT_WARN
c_func
(paren
l_string|&quot;A permanent channel interface error occurred.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x56
suffix:colon
singleline_comment|// Channel protocol error. This cannot be recovered.
id|PRINT_WARN
c_func
(paren
l_string|&quot;A channel protocol error occurred.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x57
suffix:colon
r_switch
c_cond
(paren
id|cu_type
)paren
(brace
r_case
l_int|0x3480
suffix:colon
singleline_comment|// Attention intercept. We have to reissue the command.
id|PRINT_WARN
c_func
(paren
l_string|&quot;An attention intercept occurred, which will be recovered.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3490
suffix:colon
singleline_comment|// Global status intercept. We have to reissue the command.
id|PRINT_WARN
c_func
(paren
l_string|&quot;An global status intercept was received, which will be recovered.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x58
suffix:colon
r_case
l_int|0x59
suffix:colon
singleline_comment|// These erpas are reserved -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|25
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5a
suffix:colon
singleline_comment|// Tape length incompatible. The tape inserted is too long, 
singleline_comment|// which could cause damage to the tape or the drive.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape length incompatible [should be IBM Cartridge System Tape]. May cause damage to drive or tape.n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5b
suffix:colon
singleline_comment|// Format 3480 XF incompatible
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_BEGINNING_OF_TAPE
)paren
(brace
singleline_comment|// Everything is fine. The tape will be overwritten in a different format.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape format is incompatible to the drive, which writes 3480-2 XF.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5c
suffix:colon
singleline_comment|// Format 3480-2 XF incompatible
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape format is incompatible to the drive. The drive cannot access 3480-2 XF volumes.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5d
suffix:colon
singleline_comment|// Tape length violation. 
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape length violation [should be IBM Enhanced Capacity Cartridge System Tape]. May cause damage to drive or tape.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EMEDIUMTYPE
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5e
suffix:colon
singleline_comment|// Compaction algorithm incompatible.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The volume is recorded using an incompatible compaction algorith, which is not supported by the control unit.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EMEDIUMTYPE
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
singleline_comment|// Reserved erpas -&gt; bug
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|td
comma
l_int|26
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
DECL|function|tape34xx_error_recovery_has_failed
r_void
id|tape34xx_error_recovery_has_failed
(paren
id|tape_dev_t
op_star
id|td
comma
r_int
id|error_id
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;Error Recovery failed for %s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|treq-&gt;op
)braket
)paren
suffix:semicolon
id|treq-&gt;rc
op_assign
op_minus
id|error_id
suffix:semicolon
r_if
c_cond
(paren
id|treq-&gt;wakeup
)paren
(brace
id|treq-&gt;wakeup
(paren
id|treq
)paren
suffix:semicolon
)brace
)brace
DECL|function|tape34xx_error_recovery_succeded
r_void
id|tape34xx_error_recovery_succeded
c_func
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;Error Recovery successfull for %s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|treq-&gt;op
)braket
)paren
suffix:semicolon
id|tape34xx_done_handler
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
DECL|function|tape34xx_error_recovery_do_retry
r_void
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;xerp retr&bslash;n&quot;
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|treq-&gt;op
)braket
)paren
suffix:semicolon
id|tape_remove_ccw_req
c_func
(paren
id|td
comma
id|treq
)paren
suffix:semicolon
id|tape_do_io_irq
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_NO_WAIT
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_error_recovery_read_opposite
id|tape34xx_error_recovery_read_opposite
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|treq-&gt;op
)paren
(brace
r_case
id|TO_RFO
suffix:colon
singleline_comment|// We did read forward, but the data could not be read 
singleline_comment|// *correctly*. We will read backward and then skip 
singleline_comment|// forward again.
r_if
c_cond
(paren
id|tape34xx_read_opposite
c_func
(paren
id|td
)paren
)paren
(brace
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
r_else
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TO_RBA
suffix:colon
singleline_comment|// We tried to read forward and backward, but hat no 
singleline_comment|// success -&gt; failed.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_ERR
c_func
(paren
l_string|&quot;read_opposite_recovery_called_with_state:%s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|treq-&gt;op
)braket
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_error_recovery_HWBUG
id|tape34xx_error_recovery_HWBUG
(paren
id|tape_dev_t
op_star
id|td
comma
r_int
id|condno
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;An unexpected condition #%d was caught in tape error recovery.&bslash;n&quot;
comma
id|condno
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Please report this incident.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Operation of tape:%s&bslash;n&quot;
comma
id|tape_op_verbose
(braket
id|treq-&gt;op
)braket
)paren
suffix:semicolon
)brace
id|tape_dump_sense
c_func
(paren
id|td
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called by frontend after an ENOSP on write&n; */
DECL|function|tape34xx_process_eov
r_void
id|tape34xx_process_eov
c_func
(paren
id|tape_dev_t
op_star
id|ti
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|tm_written
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* End of volume: We have to backspace the last written record, then */
multiline_comment|/* we TRY to write a tapemark and then backspace over the written TM */
id|treq
op_assign
id|tape34xx_ioctl
c_func
(paren
id|ti
comma
id|MTBSR
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
)paren
(brace
id|tape_do_io_and_wait
c_func
(paren
id|ti
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
)brace
id|treq
op_assign
id|tape34xx_ioctl
c_func
(paren
id|ti
comma
id|MTWEOF
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
)paren
(brace
id|rc
op_assign
id|tape_do_io_and_wait
c_func
(paren
id|ti
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_eq
l_int|0
)paren
op_logical_and
(paren
id|treq-&gt;rc
op_eq
l_int|0
)paren
)paren
(brace
id|tm_written
op_assign
l_int|1
suffix:semicolon
)brace
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tm_written
)paren
(brace
id|treq
op_assign
id|tape34xx_ioctl
c_func
(paren
id|ti
comma
id|MTBSR
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
)paren
(brace
id|tape_do_io_and_wait
c_func
(paren
id|ti
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * 34xx first level interrupt handler&n; */
DECL|function|tape34xx_irq
r_void
id|tape34xx_irq
c_func
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
op_assign
id|tape_get_active_ccw_req
c_func
(paren
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
op_eq
l_int|NULL
)paren
(brace
id|tape34xx_unsolicited_irq
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|td-&gt;devstat.dstat
op_amp
id|DEV_STAT_UNIT_EXCEP
)paren
op_logical_and
(paren
id|td-&gt;devstat.dstat
op_amp
id|DEV_STAT_DEV_END
)paren
op_logical_and
(paren
id|treq-&gt;op
op_eq
id|TO_WRI
)paren
)paren
(brace
multiline_comment|/* Write at end of volume */
id|PRINT_INFO
c_func
(paren
l_string|&quot;End of volume&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX */
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|td
comma
id|ENOSPC
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|td-&gt;devstat.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
id|tape34xx_error_recovery
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|td-&gt;devstat.dstat
op_amp
(paren
id|DEV_STAT_DEV_END
)paren
)paren
(brace
id|tape34xx_done_handler
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
r_else
(brace
id|tape34xx_default_handler
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
)brace
DECL|variable|tape34xx_irq
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_irq
)paren
suffix:semicolon
DECL|variable|tape34xx_write_block
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_write_block
)paren
suffix:semicolon
DECL|variable|tape34xx_read_block
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_read_block
)paren
suffix:semicolon
DECL|variable|tape34xx_ioctl
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_ioctl
)paren
suffix:semicolon
DECL|variable|tape34xx_ioctl_overload
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_ioctl_overload
)paren
suffix:semicolon
DECL|variable|tape34xx_bread
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_bread
)paren
suffix:semicolon
DECL|variable|tape34xx_free_bread
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_free_bread
)paren
suffix:semicolon
DECL|variable|tape34xx_process_eov
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_process_eov
)paren
suffix:semicolon
DECL|variable|tape34xx_bread_enable_locate
id|EXPORT_SYMBOL
c_func
(paren
id|tape34xx_bread_enable_locate
)paren
suffix:semicolon
eof
