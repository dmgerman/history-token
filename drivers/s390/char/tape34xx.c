multiline_comment|/***************************************************************************&n; *&n; *  drivers/s390/char/tape34xx.c&n; *    common tape device discipline for 34xx tapes.&n; *&n; *  S390 version&n; *    Copyright (C) 2000 IBM Corporation&n; *    Author(s): Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *               Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *&n; *  UNDER CONSTRUCTION: Work in progress...:-)&n; ****************************************************************************&n; */
macro_line|#include &quot;tapedefs.h&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/ccwcache.h&gt; 
macro_line|#include &lt;asm/idals.h&gt;  
macro_line|#ifdef CONFIG_S390_TAPE_DYNAMIC
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#include &quot;tape.h&quot;
macro_line|#include &quot;tape34xx.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;T34xx:&quot;
DECL|variable|tape34xx_event_handler_table
id|tape_event_handler_t
id|tape34xx_event_handler_table
(braket
id|TS_SIZE
)braket
(braket
id|TE_SIZE
)braket
op_assign
(brace
multiline_comment|/* {START , DONE, FAILED, ERROR, OTHER } */
(brace
l_int|NULL
comma
id|tape34xx_unused_done
comma
l_int|NULL
comma
id|tape34xx_unused_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_UNUSED */
(brace
l_int|NULL
comma
id|tape34xx_idle_done
comma
l_int|NULL
comma
id|tape34xx_idle_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_IDLE */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_DONE */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_FAILED */
(brace
l_int|NULL
comma
id|tape34xx_block_done
comma
l_int|NULL
comma
id|tape34xx_block_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_BLOCK_INIT */
(brace
l_int|NULL
comma
id|tape34xx_bsb_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_BSB_INIT */
(brace
l_int|NULL
comma
id|tape34xx_bsf_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_BSF_INIT */
(brace
l_int|NULL
comma
id|tape34xx_dse_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_DSE_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_EGA_INIT */
(brace
l_int|NULL
comma
id|tape34xx_fsb_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_FSB_INIT */
(brace
l_int|NULL
comma
id|tape34xx_fsf_init_done
comma
l_int|NULL
comma
id|tape34xx_fsf_init_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_FSF_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_LDI_INIT */
(brace
l_int|NULL
comma
id|tape34xx_lbl_init_done
comma
l_int|NULL
comma
id|tape34xx_lbl_init_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_LBL_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_MSE_INIT */
(brace
l_int|NULL
comma
id|tape34xx_nop_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_NOP_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RBA_INIT */
(brace
l_int|NULL
comma
id|tape34xx_rbi_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RBI_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RBU_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RBL_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RDC_INIT */
(brace
l_int|NULL
comma
id|tape34xx_rfo_init_done
comma
l_int|NULL
comma
id|tape34xx_rfo_init_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RFO_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RSD_INIT */
(brace
l_int|NULL
comma
id|tape34xx_rew_init_done
comma
l_int|NULL
comma
id|tape34xx_rew_init_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_REW_INIT */
(brace
l_int|NULL
comma
id|tape34xx_rew_release_init_done
comma
l_int|NULL
comma
id|tape34xx_rew_release_init_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_REW_RELEASE_IMIT */
(brace
l_int|NULL
comma
id|tape34xx_run_init_done
comma
l_int|NULL
comma
id|tape34xx_run_init_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RUN_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SEN_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SID_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SNP_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SPG_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SWI_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SMR_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SYN_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_TIO_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_UNA_INIT */
(brace
l_int|NULL
comma
id|tape34xx_wri_init_done
comma
l_int|NULL
comma
id|tape34xx_wri_init_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_WRI_INIT */
(brace
l_int|NULL
comma
id|tape34xx_wtm_init_done
comma
l_int|NULL
comma
id|tape34xx_wtm_init_error
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_WTM_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* TS_NOT_OPER */
r_int
DECL|function|tape34xx_ioctl_overload
id|tape34xx_ioctl_overload
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|// no additional ioctls
)brace
id|ccw_req_t
op_star
DECL|function|tape34xx_write_block
id|tape34xx_write_block
(paren
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
id|tape_info_t
op_star
id|tape
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_void
op_star
id|mem
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xwbl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|mem
op_assign
id|kmalloc
(paren
id|count
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xwbl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
(paren
id|mem
comma
id|data
comma
id|count
)paren
)paren
(brace
id|kfree
(paren
id|mem
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xwbl segf.&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|WRITE_CMD
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
id|count
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ccw-&gt;cda
)paren
op_eq
l_int|0
)paren
(brace
id|kfree
(paren
id|mem
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
id|mem
suffix:semicolon
id|tape-&gt;userbuf
op_assign
(paren
r_void
op_star
)paren
id|data
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_WRI_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xwbl ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_free_write_block
id|tape34xx_free_write_block
(paren
id|ccw_req_t
op_star
id|cqr
comma
id|tape_info_t
op_star
id|tape
)paren
(brace
r_int
r_int
id|lockflags
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|clear_normalized_cda
(paren
id|ccw
)paren
suffix:semicolon
id|kfree
(paren
id|tape-&gt;kernbuf
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfwb free&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
id|ccw_req_t
op_star
DECL|function|tape34xx_read_block
id|tape34xx_read_block
(paren
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
id|tape_info_t
op_star
id|tape
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_void
op_star
id|mem
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrbl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|mem
op_assign
id|kmalloc
(paren
id|count
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrbl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_FORWARD
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
id|count
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ccw-&gt;cda
)paren
op_eq
l_int|0
)paren
(brace
id|kfree
(paren
id|mem
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
id|mem
suffix:semicolon
id|tape-&gt;userbuf
op_assign
(paren
r_void
op_star
)paren
id|data
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_RFO_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrbl ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_free_read_block
id|tape34xx_free_read_block
(paren
id|ccw_req_t
op_star
id|cqr
comma
id|tape_info_t
op_star
id|tape
)paren
(brace
r_int
r_int
id|lockflags
suffix:semicolon
r_int
id|cpysize
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|cpysize
op_assign
id|ccw-&gt;count
op_minus
id|tape-&gt;devstat.rescnt
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|tape-&gt;userbuf
comma
id|tape-&gt;kernbuf
comma
id|cpysize
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfrb segf.&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|clear_normalized_cda
(paren
id|ccw
)paren
suffix:semicolon
id|kfree
(paren
id|tape-&gt;kernbuf
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfrb free&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
multiline_comment|/*&n; * The IOCTL interface is implemented in the following section,&n; * excepted the MTRESET, MTSETBLK which are handled by tapechar.c&n; */
multiline_comment|/*&n; * MTFSF: Forward space over &squot;count&squot; file marks. The tape is positioned&n; * at the EOT (End of Tape) side of the file mark.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtfsf
id|tape34xx_mtfsf
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsf parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsf nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsf ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSF: Backward space over &squot;count&squot; file marks. The tape is positioned at&n; * the EOT (End of Tape) side of the last skipped file mark.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtbsf
id|tape34xx_mtbsf
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsf parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsf nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|BACKSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_BSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsf ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTFSR: Forward space over &squot;count&squot; tape blocks (blocksize is set&n; * via MTSETBLK.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtfsr
id|tape34xx_mtfsr
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsr parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsr nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEBLOCK
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FSB_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsr ccwgen&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSR: Backward space over &squot;count&squot; tape blocks.&n; * (blocksize is set via MTSETBLK.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtbsr
id|tape34xx_mtbsr
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsr parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */   
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsr nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|BACKSPACEBLOCK
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_BSB_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsr ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTWEOF: Write &squot;count&squot; file marks at the current position.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtweof
id|tape34xx_mtweof
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xweo parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xweo nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|WRITETAPEMARK
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_WTM_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xweo ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTREW: Rewind the tape.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtrew
id|tape34xx_mtrew
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrew nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|REWIND
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_REW_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrew ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTOFFL: Rewind the tape and put the drive off-line.&n; * Implement &squot;rewind unload&squot;&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtoffl
id|tape34xx_mtoffl
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|3
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xoff nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|REWIND_UNLOAD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|SENSE
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|32
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
id|cqr-&gt;cpaddr
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_RUN_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xoff ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTNOP: &squot;No operation&squot;.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtnop
id|tape34xx_mtnop
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xnop nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
id|ccw-&gt;cmd_code
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xnop ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSFM: Backward space over &squot;count&squot; file marks.&n; * The tape is positioned at the BOT (Begin Of Tape) side of the&n; * last skipped file mark.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtbsfm
id|tape34xx_mtbsfm
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsm parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsm nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|BACKSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_BSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsm ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTFSFM: Forward space over &squot;count&squot; file marks.&n; * The tape is positioned at the BOT (Begin Of Tape) side&n; * of the last skipped file mark.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtfsfm
id|tape34xx_mtfsfm
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsm parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsm nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */&t;    
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsm ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTEOM: positions at the end of the portion of the tape already used&n; * for recordind data. MTEOM positions after the last file mark, ready for&n; * appending another file.&n; * MTRETEN: Retension the tape, i.e. forward space to end of tape and rewind.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mteom
id|tape34xx_mteom
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xeom nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|CCW_CMD_TIC
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
id|cqr-&gt;cpaddr
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xeom ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTERASE: erases the tape.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mterase
id|tape34xx_mterase
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|5
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xera nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|REWIND
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|ERASE_GAP
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DATA_SEC_ERASE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_DSE_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xera ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSETDENSITY: set tape density.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtsetdensity
id|tape34xx_mtsetdensity
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xden nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xden ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSEEK: seek to the specified block.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtseek
id|tape34xx_mtseek
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|__u8
op_star
id|data
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_assign
id|kmalloc
(paren
l_int|4
op_star
r_sizeof
(paren
id|__u8
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|2
)braket
op_assign
id|data
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
l_int|4194304
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
op_amp
l_int|0x08
)paren
singleline_comment|// IDRC on
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|1
)braket
op_or
l_int|0x80
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_add_assign
id|count
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_add_assign
(paren
id|count
op_div
l_int|256
)paren
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_add_assign
(paren
id|count
op_div
l_int|65536
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee id:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|count
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|kfree
(paren
id|data
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|LOCATE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|4
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|data
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
id|data
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_LBL_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTTELL: Tell block. Return the number of block relative to current file.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mttell
id|tape34xx_mttell
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_void
op_star
id|mem
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xtel nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|mem
op_assign
id|kmalloc
(paren
l_int|8
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xtel nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_BLOCK_ID
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|mem
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
id|mem
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_RBI_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xtel ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSETDRVBUFFER: Set the tape drive buffer code to number.&n; * Implement NOP.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtsetdrvbuffer
id|tape34xx_mtsetdrvbuffer
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbuf nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbuf ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTLOCK: Locks the tape drive door.&n; * Implement NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtlock
id|tape34xx_mtlock
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xloc nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xloc ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTUNLOCK: Unlocks the tape drive door.&n; * Implement the NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtunlock
id|tape34xx_mtunlock
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xulk nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xulk ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTLOAD: Loads the tape.&n; * Implement the NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtload
id|tape34xx_mtload
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xloa nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xloa ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTUNLOAD: Rewind the tape and unload it.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtunload
id|tape34xx_mtunload
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|3
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xunl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|REWIND_UNLOAD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|SENSE
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|32
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
id|cqr-&gt;cpaddr
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_RUN_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xunl ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTCOMPRESSION: used to enable compression.&n; * Sets the IDRC on/off.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtcompression
id|tape34xx_mtcompression
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
OL
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|1
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xcom parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// IDRC off
r_else
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
op_assign
l_int|0x08
suffix:semicolon
singleline_comment|// IDRC on
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xcom nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xcom ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSTPART: Move the tape head at the partition with the number &squot;count&squot;.&n; * Implement the NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtsetpart
id|tape34xx_mtsetpart
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xspa nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */&t;    
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xspa ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTMKPART: .... dummy .&n; * Implement the NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtmkpart
id|tape34xx_mtmkpart
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xnpa nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|tape-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xnpa ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTIOCGET: query the tape drive status.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtiocget
id|tape34xx_mtiocget
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * MTIOCPOS: query the tape position.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtiocpos
id|tape34xx_mtiocpos
(paren
id|tape_info_t
op_star
id|tape
comma
r_int
id|count
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|tape34xx_bread
id|ccw_req_t
op_star
id|tape34xx_bread
(paren
r_struct
id|request
op_star
id|req
comma
id|tape_info_t
op_star
id|tape
comma
r_int
id|tapeblock_major
)paren
(brace
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|__u8
op_star
id|data
suffix:semicolon
r_int
id|s2b
op_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
op_div
id|hardsect_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
suffix:semicolon
r_int
id|realcount
suffix:semicolon
r_int
id|size
comma
id|bhct
op_assign
l_int|0
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_size
OG
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
)paren
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
)paren
id|bhct
op_increment
suffix:semicolon
r_else
id|bhct
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|data
op_assign
id|kmalloc
(paren
l_int|4
op_star
r_sizeof
(paren
id|__u8
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xBREDnomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|2
)braket
op_assign
id|data
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
id|realcount
op_assign
id|req-&gt;sector
op_div
id|s2b
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
op_amp
l_int|0x08
)paren
singleline_comment|// IDRC on
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|1
)braket
op_or
l_int|0x80
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_add_assign
id|realcount
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_add_assign
(paren
id|realcount
op_div
l_int|256
)paren
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_add_assign
(paren
id|realcount
op_div
l_int|65536
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xBREDid:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|realcount
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|tape
comma
l_int|2
op_plus
id|bhct
op_plus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xBREDnomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|tape-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|realcount
op_ne
id|tape-&gt;position
)paren
(brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|LOCATE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|4
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|data
)paren
suffix:semicolon
)brace
id|tape-&gt;position
op_assign
id|realcount
op_plus
id|req-&gt;nr_sectors
op_div
id|s2b
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
r_if
c_cond
(paren
id|bh-&gt;b_size
op_ge
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
)paren
(brace
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
)paren
(brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_FORWARD
suffix:semicolon
id|ccw-&gt;count
op_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|bh-&gt;b_data
op_plus
id|size
)paren
)paren
suffix:semicolon
)brace
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* group N bhs to fit into byt_per_blk */
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|bh
op_ne
l_int|NULL
op_logical_and
id|size
OL
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
suffix:semicolon
)paren
(brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_DC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_FORWARD
suffix:semicolon
id|ccw-&gt;count
op_assign
id|bh-&gt;b_size
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|bh-&gt;b_data
)paren
)paren
suffix:semicolon
id|size
op_add_assign
id|bh-&gt;b_size
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
op_ne
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Cannot fulfill small request %d vs. %d (%ld sects)&bslash;n&quot;
comma
id|size
comma
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|tape-&gt;blk_minor
)braket
comma
id|req-&gt;nr_sectors
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
id|ccw
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
(paren
id|CCW_FLAG_DC
)paren
suffix:semicolon
id|ccw
op_member_access_from_pointer
id|flags
op_or_assign
(paren
id|CCW_FLAG_CC
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
id|data
suffix:semicolon
id|tape-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_BLOCK_INIT
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xBREDccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
DECL|function|tape34xx_free_bread
r_void
id|tape34xx_free_bread
(paren
id|ccw_req_t
op_star
id|cqr
comma
r_struct
id|_tape_info_t
op_star
id|tape
)paren
(brace
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_for
c_loop
(paren
id|ccw
op_assign
(paren
id|ccw1_t
op_star
)paren
id|cqr-&gt;cpaddr
suffix:semicolon
(paren
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_CC
)paren
op_logical_or
(paren
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_DC
)paren
suffix:semicolon
id|ccw
op_increment
)paren
r_if
c_cond
(paren
(paren
id|ccw-&gt;cmd_code
op_eq
id|MODE_SET_DB
)paren
op_logical_or
(paren
id|ccw-&gt;cmd_code
op_eq
id|LOCATE
)paren
op_logical_or
(paren
id|ccw-&gt;cmd_code
op_eq
id|READ_FORWARD
)paren
)paren
id|clear_normalized_cda
c_func
(paren
id|ccw
)paren
suffix:semicolon
id|tape_free_request
c_func
(paren
id|cqr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tape-&gt;kernbuf
)paren
suffix:semicolon
id|tape-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* event handlers */
r_void
DECL|function|tape34xx_default_handler
id|tape34xx_default_handler
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xdefhandle&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: An unexpected Unit Check occured.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: Please read Documentation/s390/TAPE and report it!&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: Current state is: %s&quot;
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|tape
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|tape
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|tape
)paren
)braket
suffix:colon
l_string|&quot;-&gt;UNKNOWN STATE&lt;-&quot;
)paren
)paren
suffix:semicolon
id|tape_dump_sense
(paren
op_amp
id|tape-&gt;devstat
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_unexpect_uchk_handler
id|tape34xx_unexpect_uchk_handler
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
r_if
c_cond
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
op_eq
l_int|0x43
)paren
)paren
(brace
singleline_comment|// no tape in the drive
id|PRINT_INFO
(paren
l_string|&quot;Drive %d not ready. No volume loaded.&bslash;n&quot;
comma
id|tape-&gt;rew_minor
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xuuh nomed&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
op_minus
id|ENOMEDIUM
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x42
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x44
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
op_eq
l_int|0x3b
)paren
)paren
(brace
id|PRINT_INFO
(paren
l_string|&quot;Media in drive %d was changed!&bslash;n&quot;
comma
id|tape-&gt;rew_minor
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xuuh medchg&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* nothing to do. chan end &amp; dev end will be reported when io is finished */
)brace
r_else
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xuuh unexp&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;state:&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
(paren
(paren
id|tapestate_get
(paren
id|tape
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|tape
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|tape
)paren
)braket
suffix:colon
l_string|&quot;TS UNKNOWN&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tape34xx_default_handler
(paren
id|tape
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_unused_done
id|tape34xx_unused_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
r_if
c_cond
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
op_eq
l_int|0x43
)paren
)paren
(brace
singleline_comment|// A medium was inserted in the drive!
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xuud med&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
r_else
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;unsol.irq!&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;dev end&quot;
)paren
suffix:semicolon
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|tape-&gt;devinfo.irq
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_WARN
(paren
l_string|&quot;Unsolicited IRQ (Device End) caught in unused state.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
(paren
op_amp
id|tape-&gt;devstat
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_unused_error
id|tape34xx_unused_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;unsol.irq!&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;unit chk!&quot;
)paren
suffix:semicolon
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|tape-&gt;devinfo.irq
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_WARN
(paren
l_string|&quot;Unsolicited IRQ (Unit Check) caught in unused state.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
(paren
op_amp
id|tape-&gt;devstat
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_idle_done
id|tape34xx_idle_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;unsol.irq!&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;dev end&quot;
)paren
suffix:semicolon
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|tape-&gt;devinfo.irq
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_WARN
(paren
l_string|&quot;Unsolicited IRQ (Device End) caught in idle state.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
(paren
op_amp
id|tape-&gt;devstat
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_idle_error
id|tape34xx_idle_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;unsol.irq!&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;unit chk!&quot;
)paren
suffix:semicolon
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|tape-&gt;devinfo.irq
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_WARN
(paren
l_string|&quot;Unsolicited IRQ (Unit Check) caught in idle state.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
(paren
op_amp
id|tape-&gt;devstat
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_block_done
id|tape34xx_block_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;x:bREQdone&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tapestate_set
c_func
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|schedule_tapeblock_exec_IO
c_func
(paren
id|tape
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_block_error
id|tape34xx_block_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;x:xREQfail&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tapestate_set
c_func
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|schedule_tapeblock_exec_IO
c_func
(paren
id|tape
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_bsf_init_done
id|tape34xx_bsf_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;bsf done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_dse_init_done
id|tape34xx_dse_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;dse done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_fsf_init_done
id|tape34xx_fsf_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;fsf done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_fsf_init_error
id|tape34xx_fsf_init_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x08
)paren
op_logical_or
singleline_comment|// sense.data[0]=08 -&gt; first time
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x10
)paren
op_logical_or
singleline_comment|// an alternate one...
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x12
)paren
)paren
op_logical_and
singleline_comment|// sense.data[1]=12 -&gt; repeated message
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
)paren
(brace
singleline_comment|// end of recorded area!
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;fsf fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;eoRecArea&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* TAPE_DEBUG */
id|tape-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_else
(brace
id|tape34xx_unexpect_uchk_handler
(paren
id|tape
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_fsb_init_done
id|tape34xx_fsb_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;fsb done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_bsb_init_done
id|tape34xx_bsb_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;bsb done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_lbl_init_done
id|tape34xx_lbl_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;lbl done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_lbl_init_error
id|tape34xx_lbl_init_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x00
)paren
op_logical_or
singleline_comment|// sense.data[0]=00 -&gt; first time
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x08
)paren
op_logical_or
singleline_comment|// an alternate one...
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x10
)paren
op_logical_or
singleline_comment|// alternate, too
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x12
)paren
)paren
op_logical_and
singleline_comment|// sense.data[1]=12 -&gt; repeated message
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
op_logical_or
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0xc0
)paren
)paren
)paren
(brace
singleline_comment|// block not found!
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;lbl fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;blk nfound&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* TAPE_DEBUG */
id|tape-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_else
(brace
id|tape34xx_unexpect_uchk_handler
(paren
id|tape
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_nop_init_done
id|tape34xx_nop_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;nop done..&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;or rew/rel&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rfo_init_done
id|tape34xx_rfo_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rfo done&quot;
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|//BH: use irqsave
singleline_comment|//s390irq_spin_lock(tape-&gt;devinfo.irq);
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rbi_init_done
id|tape34xx_rbi_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
id|__u8
op_star
id|data
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|data
op_assign
id|tape-&gt;kernbuf
suffix:semicolon
id|tape-&gt;rc
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|tape-&gt;rc
op_add_assign
l_int|256
op_star
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|tape-&gt;rc
op_add_assign
l_int|65536
op_star
(paren
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x3F
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rbi done&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;data:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rfo_init_error
id|tape34xx_rfo_init_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x08
)paren
op_logical_or
singleline_comment|// sense.data[0]=08 -&gt; first time
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x10
)paren
op_logical_or
singleline_comment|// an alternate one...
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x12
)paren
)paren
op_logical_and
singleline_comment|// sense.data[1]=12 -&gt; repeated message
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
)paren
(brace
singleline_comment|// end of recorded area!
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;rfo fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;eoRecArea&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* TAPE_DEBUG */
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x48
suffix:colon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;rfo fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;recov x48&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* TAPE_DEBUG */
singleline_comment|//s390irq_spin_lock(tape-&gt;devinfo.irq);
id|do_IO
(paren
id|tape-&gt;devinfo.irq
comma
id|tape-&gt;cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
(paren
id|tape-&gt;cqr
)paren
comma
l_int|0x00
comma
id|tape-&gt;cqr-&gt;options
)paren
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
r_break
suffix:semicolon
r_case
l_int|0x2c
suffix:colon
id|PRINT_ERR
(paren
l_string|&quot;TAPE: Permanent Unit Check. Please check your hardware!&quot;
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;rfo fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;Perm UCK&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tape-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|tape34xx_unexpect_uchk_handler
(paren
id|tape
)paren
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|tape34xx_rew_init_done
id|tape34xx_rew_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rew done&quot;
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|//BH: use irqsave
singleline_comment|//s390irq_spin_lock(tape-&gt;devinfo.irq);
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rew_release_init_error
id|tape34xx_rew_release_init_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
r_if
c_cond
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
op_eq
l_int|0x43
)paren
)paren
(brace
singleline_comment|// no tape in the drive
id|PRINT_INFO
(paren
l_string|&quot;Drive %d not ready. No volume loaded.&bslash;n&quot;
comma
id|tape-&gt;rew_minor
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;rewR fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;no medium&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
op_minus
id|ENOMEDIUM
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: An unexpected Unit Check occured.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: Please send the following 20 lines of output to cotte@de.ibm.com&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: Current state is: %s&quot;
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|tape
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|tape
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|tape
)paren
)braket
suffix:colon
l_string|&quot;-&gt;UNKNOWN STATE&lt;-&quot;
)paren
)paren
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;rewR unexp&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;state:&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
(paren
(paren
id|tapestate_get
(paren
id|tape
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|tape
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|tape
)paren
)braket
suffix:colon
l_string|&quot;TS UNKNOWN&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tape_dump_sense
(paren
op_amp
id|tape-&gt;devstat
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_rew_release_init_done
id|tape34xx_rew_release_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rewR done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rew_init_error
id|tape34xx_rew_init_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
id|tape34xx_unexpect_uchk_handler
(paren
id|tape
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_run_init_done
id|tape34xx_run_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rew done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_run_init_error
id|tape34xx_run_init_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
r_switch
c_cond
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x52
suffix:colon
singleline_comment|// This error is fine for rewind and unload
singleline_comment|// It reports that no volume is loaded... 
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;run done&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* TAPE_DEBUG */
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|tape34xx_unexpect_uchk_handler
(paren
id|tape
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_wri_init_done
id|tape34xx_wri_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;wri done&quot;
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|//BH: use irqsave
singleline_comment|//s390irq_spin_lock(tape-&gt;devinfo.irq);
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_wri_init_error
id|tape34xx_wri_init_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
r_if
c_cond
(paren
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x80
)paren
op_logical_and
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x4a
)paren
)paren
(brace
singleline_comment|// tape is write protected
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;wri fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;writProte&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* TAPE_DEBUG */
id|tape-&gt;rc
op_assign
op_minus
id|EACCES
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|tape-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x48
suffix:colon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;wri fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;recov x48&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* TAPE_DEBUG */
singleline_comment|//s390irq_spin_lock(tape-&gt;devinfo.irq);
id|do_IO
(paren
id|tape-&gt;devinfo.irq
comma
id|tape-&gt;cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
(paren
id|tape-&gt;cqr
)paren
comma
l_int|0x00
comma
id|tape-&gt;cqr-&gt;options
)paren
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
r_break
suffix:semicolon
r_case
l_int|0x2c
suffix:colon
id|PRINT_ERR
(paren
l_string|&quot;TAPE: Permanent Unit Check. Please check your hardware!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;wri fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;Perm UCK&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tape-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x38
suffix:colon
singleline_comment|//end of tape
macro_line|#ifdef TAPE_DEBUG
id|PRINT_WARN
(paren
l_string|&quot;TAPE: End of Tape reached.&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;wri fail&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;EOT!&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tape-&gt;rc
op_assign
id|tape-&gt;devstat.rescnt
suffix:semicolon
id|tapestate_set
(paren
id|tape
comma
id|TS_FAILED
)paren
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|tape34xx_unexpect_uchk_handler
(paren
id|tape
)paren
suffix:semicolon
)brace
)brace
)brace
r_void
DECL|function|tape34xx_wtm_init_done
id|tape34xx_wtm_init_done
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;wtm done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|tape
comma
id|TS_DONE
)paren
suffix:semicolon
id|tape-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|tape-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|tape-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_wtm_init_error
id|tape34xx_wtm_init_error
(paren
id|tape_info_t
op_star
id|tape
)paren
(brace
id|tape34xx_unexpect_uchk_handler
(paren
id|tape
)paren
suffix:semicolon
)brace
eof
