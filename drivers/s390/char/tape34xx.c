multiline_comment|/***************************************************************************&n; *&n; *  drivers/s390/char/tape34xx.c&n; *    common tape device discipline for 34xx tapes.&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001 IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *               Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&n; ****************************************************************************&n; */
macro_line|#include &quot;tapedefs.h&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/ccwcache.h&gt; 
macro_line|#include &lt;asm/idals.h&gt;  
macro_line|#ifdef CONFIG_S390_TAPE_DYNAMIC
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#include &quot;tape.h&quot;
macro_line|#include &quot;tape34xx.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;T34xx:&quot;
DECL|variable|tape34xx_event_handler_table
id|tape_event_handler_t
id|tape34xx_event_handler_table
(braket
id|TS_SIZE
)braket
(braket
id|TE_SIZE
)braket
op_assign
(brace
multiline_comment|/* {START , DONE, FAILED, ERROR, OTHER } */
(brace
l_int|NULL
comma
id|tape34xx_unused_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_UNUSED */
(brace
l_int|NULL
comma
id|tape34xx_idle_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_IDLE */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_DONE */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_FAILED */
(brace
l_int|NULL
comma
id|tape34xx_block_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_BLOCK_INIT */
(brace
l_int|NULL
comma
id|tape34xx_bsb_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_BSB_INIT */
(brace
l_int|NULL
comma
id|tape34xx_bsf_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_BSF_INIT */
(brace
l_int|NULL
comma
id|tape34xx_dse_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_DSE_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_EGA_INIT */
(brace
l_int|NULL
comma
id|tape34xx_fsb_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_FSB_INIT */
(brace
l_int|NULL
comma
id|tape34xx_fsf_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_FSF_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_LDI_INIT */
(brace
l_int|NULL
comma
id|tape34xx_lbl_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_LBL_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_MSE_INIT */
(brace
l_int|NULL
comma
id|tape34xx_nop_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_NOP_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RBA_INIT */
(brace
l_int|NULL
comma
id|tape34xx_rbi_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RBI_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RBU_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RBL_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RDC_INIT */
(brace
l_int|NULL
comma
id|tape34xx_rfo_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RFO_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RSD_INIT */
(brace
l_int|NULL
comma
id|tape34xx_rew_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_REW_INIT */
(brace
l_int|NULL
comma
id|tape34xx_rew_release_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_REW_RELEASE_IMIT */
(brace
l_int|NULL
comma
id|tape34xx_run_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_RUN_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SEN_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SID_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SNP_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SPG_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SWI_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SMR_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_SYN_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_TIO_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_UNA_INIT */
(brace
l_int|NULL
comma
id|tape34xx_wri_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_WRI_INIT */
(brace
l_int|NULL
comma
id|tape34xx_wtm_init_done
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
comma
multiline_comment|/* TS_WTM_INIT */
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* TS_NOT_OPER */
r_int
DECL|function|tape34xx_ioctl_overload
id|tape34xx_ioctl_overload
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|// no additional ioctls
)brace
id|ccw_req_t
op_star
DECL|function|tape34xx_write_block
id|tape34xx_write_block
(paren
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
id|tape_info_t
op_star
id|ti
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_void
op_star
id|mem
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xwbl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|mem
op_assign
id|kmalloc
(paren
id|count
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xwbl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
(paren
id|mem
comma
id|data
comma
id|count
)paren
)paren
(brace
id|kfree
(paren
id|mem
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xwbl segf.&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|WRITE_CMD
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
id|count
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ccw-&gt;cda
)paren
op_eq
l_int|0
)paren
(brace
id|kfree
(paren
id|mem
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|mem
suffix:semicolon
id|ti-&gt;userbuf
op_assign
(paren
r_void
op_star
)paren
id|data
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_WRI_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xwbl ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_free_write_block
id|tape34xx_free_write_block
(paren
id|ccw_req_t
op_star
id|cqr
comma
id|tape_info_t
op_star
id|ti
)paren
(brace
r_int
r_int
id|lockflags
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|clear_normalized_cda
(paren
id|ccw
)paren
suffix:semicolon
id|kfree
(paren
id|ti-&gt;kernbuf
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfwb free&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
id|ccw_req_t
op_star
DECL|function|tape34xx_read_block
id|tape34xx_read_block
(paren
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
id|tape_info_t
op_star
id|ti
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_void
op_star
id|mem
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrbl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|mem
op_assign
id|kmalloc
(paren
id|count
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrbl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_FORWARD
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
id|count
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ccw-&gt;cda
)paren
op_eq
l_int|0
)paren
(brace
id|kfree
(paren
id|mem
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|mem
suffix:semicolon
id|ti-&gt;userbuf
op_assign
(paren
r_void
op_star
)paren
id|data
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_RFO_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrbl ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
id|ccw_req_t
op_star
DECL|function|tape34xx_read_opposite
id|tape34xx_read_opposite
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|novalue
)paren
(brace
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_int
id|count
suffix:semicolon
singleline_comment|// first, retrieve the count from the old cqr.
id|cqr
op_assign
id|ti-&gt;cqr
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|count
op_assign
id|ccw-&gt;count
suffix:semicolon
singleline_comment|// free old cqr.
id|clear_normalized_cda
(paren
id|ccw
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
singleline_comment|// build new cqr
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrop nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_BACKWARD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
id|count
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|ti-&gt;kernbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ccw-&gt;cda
)paren
op_eq
l_int|0
)paren
(brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEBLOCK
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
id|ccw
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
id|ccw
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_RBA_INIT
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrop ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_free_read_block
id|tape34xx_free_read_block
(paren
id|ccw_req_t
op_star
id|cqr
comma
id|tape_info_t
op_star
id|ti
)paren
(brace
r_int
r_int
id|lockflags
suffix:semicolon
r_int
id|cpysize
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|cpysize
op_assign
id|ccw-&gt;count
op_minus
id|ti-&gt;devstat.rescnt
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|ti-&gt;userbuf
comma
id|ti-&gt;kernbuf
comma
id|cpysize
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfrb segf.&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|clear_normalized_cda
(paren
id|ccw
)paren
suffix:semicolon
id|kfree
(paren
id|ti-&gt;kernbuf
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfrb free&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
)brace
multiline_comment|/*&n; * The IOCTL interface is implemented in the following section,&n; * excepted the MTRESET, MTSETBLK which are handled by tapechar.c&n; */
multiline_comment|/*&n; * MTFSF: Forward space over &squot;count&squot; file marks. The tape is positioned&n; * at the EOT (End of Tape) side of the file mark.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtfsf
id|tape34xx_mtfsf
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsf parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsf nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_FSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsf ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSF: Backward space over &squot;count&squot; file marks. The tape is positioned at&n; * the EOT (End of Tape) side of the last skipped file mark.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtbsf
id|tape34xx_mtbsf
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsf parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsf nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|BACKSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_BSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsf ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTFSR: Forward space over &squot;count&squot; tape blocks (blocksize is set&n; * via MTSETBLK.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtfsr
id|tape34xx_mtfsr
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsr parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsr nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEBLOCK
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_FSB_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsr ccwgen&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSR: Backward space over &squot;count&squot; tape blocks.&n; * (blocksize is set via MTSETBLK.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtbsr
id|tape34xx_mtbsr
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsr parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */   
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsr nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|BACKSPACEBLOCK
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_BSB_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsr ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTWEOF: Write &squot;count&squot; file marks at the current position.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtweof
id|tape34xx_mtweof
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xweo parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xweo nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|WRITETAPEMARK
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_WTM_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xweo ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTREW: Rewind the tape.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtrew
id|tape34xx_mtrew
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrew nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|REWIND
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_REW_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xrew ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTOFFL: Rewind the tape and put the drive off-line.&n; * Implement &squot;rewind unload&squot;&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtoffl
id|tape34xx_mtoffl
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|3
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xoff nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|REWIND_UNLOAD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|SENSE
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|32
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
id|cqr-&gt;cpaddr
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_RUN_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xoff ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTNOP: &squot;No operation&squot;.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtnop
id|tape34xx_mtnop
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xnop nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
id|ccw-&gt;cmd_code
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xnop ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSFM: Backward space over &squot;count&squot; file marks.&n; * The tape is positioned at the BOT (Begin Of Tape) side of the&n; * last skipped file mark.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtbsfm
id|tape34xx_mtbsfm
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsm parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsm nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|BACKSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_BSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbsm ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTFSFM: Forward space over &squot;count&squot; file marks.&n; * The tape is positioned at the BOT (Begin Of Tape) side&n; * of the last skipped file mark.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtfsfm
id|tape34xx_mtfsfm
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_eq
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|510
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsm parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
op_plus
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsm nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */&t;    
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
)brace
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_FSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xfsm ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTEOM: positions at the end of the portion of the tape already used&n; * for recordind data. MTEOM positions after the last file mark, ready for&n; * appending another file.&n; * MTRETEN: Retension the tape, i.e. forward space to end of tape and rewind.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mteom
id|tape34xx_mteom
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xeom nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|FORSPACEFILE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|CCW_CMD_TIC
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
id|cqr-&gt;cpaddr
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_FSF_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xeom ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTERASE: erases the tape.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mterase
id|tape34xx_mterase
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|5
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xera nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|REWIND
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|ERASE_GAP
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|DATA_SEC_ERASE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_DSE_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xera ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSETDENSITY: set tape density.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtsetdensity
id|tape34xx_mtsetdensity
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xden nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xden ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSEEK: seek to the specified block.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtseek
id|tape34xx_mtseek
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|__u8
op_star
id|data
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_assign
id|kmalloc
(paren
l_int|4
op_star
r_sizeof
(paren
id|__u8
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|2
)braket
op_assign
id|data
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
l_int|4194304
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
op_amp
l_int|0x08
)paren
singleline_comment|// IDRC on
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|1
)braket
op_or
l_int|0x80
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_add_assign
id|count
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_add_assign
(paren
id|count
op_div
l_int|256
)paren
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_add_assign
(paren
id|count
op_div
l_int|65536
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee id:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|count
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|kfree
(paren
id|data
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|LOCATE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|4
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|data
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|data
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_LBL_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xsee ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTTELL: Tell block. Return the number of block relative to current file.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mttell
id|tape34xx_mttell
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_void
op_star
id|mem
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xtel nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|mem
op_assign
id|kmalloc
(paren
l_int|8
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xtel nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_BLOCK_ID
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|8
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|mem
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|mem
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_RBI_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xtel ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSETDRVBUFFER: Set the tape drive buffer code to number.&n; * Implement NOP.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtsetdrvbuffer
id|tape34xx_mtsetdrvbuffer
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbuf nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xbuf ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTLOCK: Locks the tape drive door.&n; * Implement NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtlock
id|tape34xx_mtlock
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xloc nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xloc ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTUNLOCK: Unlocks the tape drive door.&n; * Implement the NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtunlock
id|tape34xx_mtunlock
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xulk nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xulk ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTLOAD: Loads the tape.&n; * This function is not implemented and returns NULL, which causes the Frontend to wait for a medium being loaded.&n; *  The 3480/3490 type Tapes do not support a load command&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtload
id|tape34xx_mtload
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * MTUNLOAD: Rewind the tape and unload it.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtunload
id|tape34xx_mtunload
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|3
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xunl nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|REWIND_UNLOAD
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|SENSE
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|32
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
id|cqr-&gt;cpaddr
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_RUN_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xunl ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTCOMPRESSION: used to enable compression.&n; * Sets the IDRC on/off.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtcompression
id|tape34xx_mtcompression
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
OL
l_int|0
)paren
op_logical_or
(paren
id|count
OG
l_int|1
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xcom parm&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// IDRC off
r_else
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
op_assign
l_int|0x08
suffix:semicolon
singleline_comment|// IDRC on
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xcom nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xcom ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSTPART: Move the tape head at the partition with the number &squot;count&squot;.&n; * Implement the NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtsetpart
id|tape34xx_mtsetpart
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xspa nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */&t;    
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xspa ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTMKPART: .... dummy .&n; * Implement the NOP CCW command.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtmkpart
id|tape34xx_mtmkpart
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xnpa nomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_NOP_INIT
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xnpa ccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
multiline_comment|/*&n; * MTIOCGET: query the tape drive status.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtiocget
id|tape34xx_mtiocget
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * MTIOCPOS: query the tape position.&n; */
id|ccw_req_t
op_star
DECL|function|tape34xx_mtiocpos
id|tape34xx_mtiocpos
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|count
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|tape34xx_bread
id|ccw_req_t
op_star
id|tape34xx_bread
(paren
r_struct
id|request
op_star
id|req
comma
id|tape_info_t
op_star
id|ti
comma
r_int
id|tapeblock_major
)paren
(brace
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
id|ccw1_t
op_star
id|ccw
suffix:semicolon
id|__u8
op_star
id|data
suffix:semicolon
r_int
id|s2b
op_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
op_div
id|hardsect_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
suffix:semicolon
r_int
id|realcount
suffix:semicolon
r_int
id|size
comma
id|bhct
op_assign
l_int|0
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
)paren
(brace
r_if
c_cond
(paren
id|bh-&gt;b_size
OG
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
)paren
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
)paren
id|bhct
op_increment
suffix:semicolon
r_else
id|bhct
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|data
op_assign
id|kmalloc
(paren
l_int|4
op_star
r_sizeof
(paren
id|__u8
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xBREDnomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
l_int|NULL
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x01
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|2
)braket
op_assign
id|data
(braket
l_int|3
)braket
op_assign
l_int|0x00
suffix:semicolon
id|realcount
op_assign
id|req-&gt;sector
op_div
id|s2b
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
op_amp
l_int|0x08
)paren
singleline_comment|// IDRC on
id|data
(braket
l_int|1
)braket
op_assign
id|data
(braket
l_int|1
)braket
op_or
l_int|0x80
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_add_assign
id|realcount
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_add_assign
(paren
id|realcount
op_div
l_int|256
)paren
op_mod
l_int|256
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_add_assign
(paren
id|realcount
op_div
l_int|65536
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xBREDid:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|realcount
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|cqr
op_assign
id|tape_alloc_ccw_req
(paren
id|ti
comma
l_int|2
op_plus
id|bhct
op_plus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xBREDnomem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|ccw
op_assign
id|cqr-&gt;cpaddr
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|MODE_SET_DB
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|1
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|realcount
op_ne
id|ti-&gt;position
)paren
(brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|LOCATE
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|4
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
(paren
r_int
r_int
)paren
id|data
)paren
suffix:semicolon
)brace
id|ti-&gt;position
op_assign
id|realcount
op_plus
id|req-&gt;nr_sectors
op_div
id|s2b
suffix:semicolon
r_for
c_loop
(paren
id|bh
op_assign
id|req-&gt;bh
suffix:semicolon
id|bh
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
r_if
c_cond
(paren
id|bh-&gt;b_size
op_ge
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
)paren
(brace
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|size
OL
id|bh-&gt;b_size
suffix:semicolon
id|size
op_add_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
)paren
(brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_CC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_FORWARD
suffix:semicolon
id|ccw-&gt;count
op_assign
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|bh-&gt;b_data
op_plus
id|size
)paren
)paren
suffix:semicolon
)brace
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* group N bhs to fit into byt_per_blk */
r_for
c_loop
(paren
id|size
op_assign
l_int|0
suffix:semicolon
id|bh
op_ne
l_int|NULL
op_logical_and
id|size
OL
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
suffix:semicolon
)paren
(brace
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;flags
op_assign
id|CCW_FLAG_DC
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|READ_FORWARD
suffix:semicolon
id|ccw-&gt;count
op_assign
id|bh-&gt;b_size
suffix:semicolon
id|set_normalized_cda
(paren
id|ccw
comma
id|__pa
(paren
id|bh-&gt;b_data
)paren
)paren
suffix:semicolon
id|size
op_add_assign
id|bh-&gt;b_size
suffix:semicolon
id|bh
op_assign
id|bh-&gt;b_reqnext
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
op_ne
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
)paren
(brace
id|PRINT_WARN
(paren
l_string|&quot;Cannot fulfill small request %d vs. %d (%ld sects)&bslash;n&quot;
comma
id|size
comma
id|blksize_size
(braket
id|tapeblock_major
)braket
(braket
id|ti-&gt;blk_minor
)braket
comma
id|req-&gt;nr_sectors
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
)brace
id|ccw
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
(paren
id|CCW_FLAG_DC
)paren
suffix:semicolon
id|ccw
op_member_access_from_pointer
id|flags
op_or_assign
(paren
id|CCW_FLAG_CC
)paren
suffix:semicolon
id|ccw
op_increment
suffix:semicolon
id|ccw-&gt;cmd_code
op_assign
id|NOP
suffix:semicolon
id|ccw-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;count
op_assign
l_int|0
suffix:semicolon
id|ccw-&gt;cda
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
(paren
id|ccw-&gt;cmd_code
)paren
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|data
suffix:semicolon
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_BLOCK_INIT
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xBREDccwg&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
id|cqr
suffix:semicolon
)brace
DECL|function|tape34xx_free_bread
r_void
id|tape34xx_free_bread
(paren
id|ccw_req_t
op_star
id|cqr
comma
r_struct
id|_tape_info_t
op_star
id|ti
)paren
(brace
id|ccw1_t
op_star
id|ccw
suffix:semicolon
r_for
c_loop
(paren
id|ccw
op_assign
(paren
id|ccw1_t
op_star
)paren
id|cqr-&gt;cpaddr
suffix:semicolon
(paren
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_CC
)paren
op_logical_or
(paren
id|ccw-&gt;flags
op_amp
id|CCW_FLAG_DC
)paren
suffix:semicolon
id|ccw
op_increment
)paren
r_if
c_cond
(paren
(paren
id|ccw-&gt;cmd_code
op_eq
id|MODE_SET_DB
)paren
op_logical_or
(paren
id|ccw-&gt;cmd_code
op_eq
id|LOCATE
)paren
op_logical_or
(paren
id|ccw-&gt;cmd_code
op_eq
id|READ_FORWARD
)paren
)paren
id|clear_normalized_cda
c_func
(paren
id|ccw
)paren
suffix:semicolon
id|tape_free_request
c_func
(paren
id|cqr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ti-&gt;kernbuf
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* event handlers */
r_void
DECL|function|tape34xx_default_handler
id|tape34xx_default_handler
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xdefhandle&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: An unexpected Unit Check occurred.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: Please read Documentation/s390/TAPE and report it!&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_ERR
(paren
l_string|&quot;TAPE34XX: Current state is: %s&quot;
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;-&gt;UNKNOWN STATE&lt;-&quot;
)paren
)paren
suffix:semicolon
id|tape_dump_sense
(paren
op_amp
id|ti-&gt;devstat
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
)paren
(brace
r_case
id|TS_REW_RELEASE_INIT
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_FAILED
)paren
suffix:semicolon
id|wake_up
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TS_BLOCK_INIT
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_FAILED
)paren
suffix:semicolon
id|schedule_tapeblock_exec_IO
c_func
(paren
id|ti
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_FAILED
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_unexpect_uchk_handler
id|tape34xx_unexpect_uchk_handler
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
r_if
c_cond
(paren
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
op_logical_and
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
op_eq
l_int|0x43
)paren
)paren
(brace
singleline_comment|// no tape in the drive
id|PRINT_INFO
(paren
l_string|&quot;Drive %d not ready. No volume loaded.&bslash;n&quot;
comma
id|ti-&gt;rew_minor
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xuuh nomed&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tapestate_set
(paren
id|ti
comma
id|TS_FAILED
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
op_minus
id|ENOMEDIUM
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|0
)braket
op_eq
l_int|0x42
)paren
op_logical_and
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_eq
l_int|0x44
)paren
op_logical_and
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
op_eq
l_int|0x3b
)paren
)paren
(brace
id|PRINT_INFO
(paren
l_string|&quot;Media in drive %d was changed!&bslash;n&quot;
comma
id|ti-&gt;rew_minor
op_div
l_int|2
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xuuh medchg&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* nothing to do. chan end &amp; dev end will be reported when io is finished */
)brace
r_else
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xuuh unexp&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;state:&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
(paren
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;TS UNKNOWN&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tape34xx_default_handler
(paren
id|ti
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_unused_done
id|tape34xx_unused_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
r_if
c_cond
(paren
id|ti-&gt;medium_is_unloaded
)paren
(brace
singleline_comment|// A medium was inserted in the drive!
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xuui med&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_WARN
(paren
l_string|&quot;A medium was inserted into the tape.&bslash;n&quot;
)paren
suffix:semicolon
id|ti-&gt;medium_is_unloaded
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;unsol.irq!&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;dev end&quot;
)paren
suffix:semicolon
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|ti-&gt;devinfo.irq
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_WARN
(paren
l_string|&quot;Unsolicited IRQ (Device End) caught in unused state.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
(paren
op_amp
id|ti-&gt;devstat
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_idle_done
id|tape34xx_idle_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
r_if
c_cond
(paren
id|ti-&gt;medium_is_unloaded
)paren
(brace
singleline_comment|// A medium was inserted in the drive!
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;xuud med&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_WARN
(paren
l_string|&quot;A medium was inserted into the tape.&bslash;n&quot;
)paren
suffix:semicolon
id|ti-&gt;medium_is_unloaded
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;unsol.irq!&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;dev end&quot;
)paren
suffix:semicolon
id|debug_int_exception
(paren
id|tape_debug_area
comma
l_int|3
comma
id|ti-&gt;devinfo.irq
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|PRINT_WARN
(paren
l_string|&quot;Unsolicited IRQ (Device End) caught in idle state.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
(paren
op_amp
id|ti-&gt;devstat
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_block_done
id|tape34xx_block_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;x:bREQdone&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|schedule_tapeblock_exec_IO
c_func
(paren
id|ti
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_bsf_init_done
id|tape34xx_bsf_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;bsf done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_dse_init_done
id|tape34xx_dse_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;dse done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_fsf_init_done
id|tape34xx_fsf_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;fsf done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_fsb_init_done
id|tape34xx_fsb_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;fsb done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_bsb_init_done
id|tape34xx_bsb_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;bsb done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_lbl_init_done
id|tape34xx_lbl_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;lbl done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_nop_init_done
id|tape34xx_nop_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;nop done..&quot;
)paren
suffix:semicolon
id|debug_text_exception
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;or rew/rel&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rfo_init_done
id|tape34xx_rfo_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rfo done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rbi_init_done
id|tape34xx_rbi_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
id|__u8
op_star
id|data
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
r_int
id|i
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_FAILED
)paren
suffix:semicolon
id|data
op_assign
id|ti-&gt;kernbuf
suffix:semicolon
id|ti-&gt;rc
op_assign
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|ti-&gt;rc
op_add_assign
l_int|256
op_star
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|ti-&gt;rc
op_add_assign
l_int|65536
op_star
(paren
id|data
(braket
l_int|1
)braket
op_amp
l_int|0x3F
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rbi done&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;data:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rew_init_done
id|tape34xx_rew_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rew done&quot;
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|//BH: use irqsave
singleline_comment|//s390irq_spin_lock(tape-&gt;devinfo.irq);
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_rew_release_init_done
id|tape34xx_rew_release_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rewR done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(tape-&gt;devinfo.irq);
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_run_init_done
id|tape34xx_run_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;rew done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_wri_init_done
id|tape34xx_wri_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;wri done&quot;
)paren
suffix:semicolon
macro_line|#endif
singleline_comment|//BH: use irqsave
singleline_comment|//s390irq_spin_lock(ti-&gt;devinfo.irq);
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|//s390irq_spin_unlock(ti-&gt;devinfo.irq);
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
r_void
DECL|function|tape34xx_wtm_init_done
id|tape34xx_wtm_init_done
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;wtm done&quot;
)paren
suffix:semicolon
macro_line|#endif
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
l_int|0
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
multiline_comment|/* This function analyses the tape&squot;s sense-data in case of a unit-check. If possible,&n;   it tries to recover from the error. Else the user is informed about the problem. */
r_void
DECL|function|tape34xx_error_recovery
id|tape34xx_error_recovery
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
id|__u8
op_star
id|sense
op_assign
id|ti-&gt;devstat.ii.sense.data
suffix:semicolon
r_int
id|inhibit_cu_recovery
op_assign
l_int|0
suffix:semicolon
r_int
id|cu_type
op_assign
id|ti-&gt;discipline-&gt;cu_type
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
(paren
id|tape34xx_disc_data_t
op_star
)paren
id|ti-&gt;discdata
)paren
op_member_access_from_pointer
id|modeset_byte
)paren
op_amp
l_int|0x80
)paren
id|inhibit_cu_recovery
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_eq
id|TS_BLOCK_INIT
)paren
(brace
singleline_comment|// no recovery for block device, bottom half will retry...
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_COMMAND_REJECT
)paren
r_switch
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
)paren
(brace
r_case
id|TS_BLOCK_INIT
suffix:colon
r_case
id|TS_DSE_INIT
suffix:colon
r_case
id|TS_EGA_INIT
suffix:colon
r_case
id|TS_WRI_INIT
suffix:colon
r_case
id|TS_WTM_INIT
suffix:colon
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_WRITE_PROTECT
)paren
(brace
singleline_comment|// trying to write, but medium is write protected
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EACCES
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_default
suffix:colon
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// special cases for various tape-states when reaching end of recorded area
r_if
c_cond
(paren
(paren
(paren
id|sense
(braket
l_int|0
)braket
op_eq
l_int|0x08
)paren
op_logical_or
(paren
id|sense
(braket
l_int|0
)braket
op_eq
l_int|0x10
)paren
op_logical_or
(paren
id|sense
(braket
l_int|0
)braket
op_eq
l_int|0x12
)paren
)paren
op_logical_and
(paren
(paren
id|sense
(braket
l_int|1
)braket
op_eq
l_int|0x40
)paren
op_logical_or
(paren
id|sense
(braket
l_int|1
)braket
op_eq
l_int|0x0c
)paren
)paren
)paren
r_switch
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
)paren
(brace
r_case
id|TS_FSF_INIT
suffix:colon
singleline_comment|// Trying to seek beyond end of recorded area
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|TS_LBL_INIT
suffix:colon
singleline_comment|// Block could not be located.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|TS_RFO_INIT
suffix:colon
singleline_comment|// Try to read beyond end of recorded area -&gt; 0 bytes read
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// Sensing special bits
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_BUS_OUT_CHECK
)paren
(brace
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_DATA_CHECK
)paren
(brace
singleline_comment|// hardware failure, damaged tape or improper operating conditions
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x23
suffix:colon
singleline_comment|// a read data check occurred
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SENSE_TAPE_SYNC_MODE
)paren
op_logical_or
(paren
id|inhibit_cu_recovery
)paren
)paren
(brace
singleline_comment|// data check is not permanent, may be recovered. 
singleline_comment|// We always use async-mode with cu-recovery, so this should *never* happen.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|2
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// data check is permanent, CU recovery has failed
id|PRINT_WARN
c_func
(paren
l_string|&quot;Permanent read error, recovery failed!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x25
suffix:colon
singleline_comment|// a write data check occurred
r_if
c_cond
(paren
(paren
id|sense
(braket
l_int|2
)braket
op_amp
id|SENSE_TAPE_SYNC_MODE
)paren
op_logical_or
(paren
id|inhibit_cu_recovery
)paren
)paren
(brace
singleline_comment|// data check is not permanent, may be recovered.
singleline_comment|// We always use async-mode with cu-recovery, so this should *never* happen.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|3
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// data check is permanent, cu-recovery has failed
id|PRINT_WARN
c_func
(paren
l_string|&quot;Permanent write error, recovery failed!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x26
suffix:colon
singleline_comment|// Data Check (read opposite) occurred. We&squot;ll recover this.
id|tape34xx_error_recovery_read_opposite
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x28
suffix:colon
singleline_comment|// The ID-Mark at the beginning of the tape could not be written. This is fatal, we&squot;ll report and exit.
id|PRINT_WARN
c_func
(paren
l_string|&quot;ID-Mark could not be written. Check your hardware!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x31
suffix:colon
singleline_comment|// Tape void. Tried to read beyond end of device. We&squot;ll report and exit.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Try to read beyond end of recorded area!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|ENOSPC
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x41
suffix:colon
singleline_comment|// Record sequence error. cu detected incorrect block-id sequence on tape. We&squot;ll report and exit.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Illegal block-id sequence found!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
(brace
)brace
singleline_comment|// well, all data checks for 3480 should result in one of the above erpa-codes. if not -&gt; bug
singleline_comment|// On 3490, other data-check conditions do exist.
r_if
c_cond
(paren
id|cu_type
op_eq
l_int|0x3480
)paren
(brace
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|4
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|0
)braket
op_amp
id|SENSE_OVERRUN
)paren
(brace
singleline_comment|// A data overrun between cu and drive occurred. The channel speed is to slow! We&squot;ll report this and exit!
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x40
suffix:colon
singleline_comment|// overrun error
id|PRINT_WARN
(paren
l_string|&quot;Data overrun error between control-unit and drive. Use a faster channel connection, if possible! &bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
singleline_comment|// Overrun bit is set, but erpa does not show overrun error. This is a bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|5
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_RECORD_SEQUENCE_ERR
)paren
(brace
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x41
suffix:colon
singleline_comment|// Record sequence error. cu detected incorrect block-id sequence on tape. We&squot;ll report and exit.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Illegal block-id sequence found!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
singleline_comment|// Record sequence error bit is set, but erpa does not show record sequence error. This is a bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|6
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
singleline_comment|// Sensing erpa codes
r_switch
c_cond
(paren
id|sense
(braket
l_int|3
)braket
)paren
(brace
r_case
l_int|0x00
suffix:colon
singleline_comment|// Everything is fine, but we got a unit check. Report and ignore!
id|PRINT_WARN
(paren
l_string|&quot;Non-error sense was found. Unit-check will be ignored, expect errors...&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x21
suffix:colon
singleline_comment|// Data streaming not operational. Cu switches to interlock mode, we reissue the command.
id|PRINT_WARN
(paren
l_string|&quot;Data streaming not operational. Switching to interlock-mode! &bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x22
suffix:colon
singleline_comment|// Path equipment check. Might be drive adapter error, buffer error on the lower interface, internal path not useable, or error during cartridge load.
singleline_comment|// All of the above are not recoverable
id|PRINT_WARN
(paren
l_string|&quot;A path equipment check occurred. One of the following conditions occurred:&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
(paren
l_string|&quot;drive adapter error,buffer error on the lower interface, internal path not useable, error during cartridge load.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x23
suffix:colon
singleline_comment|// Read data check. Should have been be covered earlier -&gt; Bug!
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|7
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x24
suffix:colon
singleline_comment|// Load display check. Load display was command was issued, but the drive is displaying a drive check message. Can be threated as &quot;device end&quot;.
id|tape34xx_error_recovery_succeded
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x25
suffix:colon
singleline_comment|// Write data check. Should have been covered earlier -&gt; Bug!
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|8
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x26
suffix:colon
singleline_comment|// Data check (read opposite). Should have been covered earlier -&gt; Bug!
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|9
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x27
suffix:colon
singleline_comment|// Command reject. May indicate illegal channel program or buffer over/underrun. 
singleline_comment|// Since all channel programms are issued by this driver and ought be correct,
singleline_comment|// we assume a over/underrun situaltion and retry the channel program.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x28
suffix:colon
singleline_comment|// Write id mark check. Should have beed covered earlier -&gt; bug!
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|10
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x29
suffix:colon
singleline_comment|// Function incompatible. Either idrc is on but hardware not capable doing idrc 
singleline_comment|// or a perform subsystem func is issued and the cu is not online. Anyway, this 
singleline_comment|// cannot be recovered and is an I/O error.
id|PRINT_WARN
(paren
l_string|&quot;Function incompatible. Try to switch off idrc! &bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2a
suffix:colon
singleline_comment|// Unsolicited environmental data. An internal counter overflows, we can ignore
singleline_comment|// this and reissue the cmd.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2b
suffix:colon
singleline_comment|// Environmental data present. Indicates either unload completed ok or read buffered 
singleline_comment|// log command completed ok. 
r_if
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_eq
id|TS_RUN_INIT
)paren
(brace
singleline_comment|// Rewind unload completed ok.
id|tape34xx_error_recovery_succeded
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// Since we do not issue read buffered log commands, this should never occur -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|11
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2c
suffix:colon
singleline_comment|// Permanent equipment check. cu has tried recovery, but did not succeed. This is an
singleline_comment|// I/O error.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2d
suffix:colon
singleline_comment|// Data security erase failure.
r_if
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_eq
id|TS_DSE_INIT
)paren
(brace
singleline_comment|// report an I/O error
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
singleline_comment|// Data security erase failure, but no such command issued. This is a bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|12
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2e
suffix:colon
singleline_comment|// Not capable. This indicates either that the drive fails reading the format id mark
singleline_comment|// or that that format specified is not supported by the drive. We write a message and
singleline_comment|// return an I/O error.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Drive not capable processing the tape format!&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EMEDIUMTYPE
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x2f
suffix:colon
singleline_comment|// This erpa is reserved. This is a bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|13
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x30
suffix:colon
singleline_comment|// The medium is write protected, while trying to write on it. We&squot;ll report this.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Medium is write protected!&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EACCES
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x31
suffix:colon
singleline_comment|// Tape void. Should have beed covered ealier -&gt; bug
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|14
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x32
suffix:colon
singleline_comment|// Tension loss. We cannot recover this, it&squot;s an I/O error.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive lost tape tension.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x33
suffix:colon
singleline_comment|// Load Failure. The catridge was not inserted correctly or the tape is not threaded
singleline_comment|// correctly. We cannot recover this, the user has to reload the catridge.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Cartridge load failure. Reload the cartridge and try again.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x34
suffix:colon
singleline_comment|// Unload failure. The drive cannot maintain tape tension and control tape movement 
singleline_comment|// during an unload operation. 
id|PRINT_WARN
c_func
(paren
l_string|&quot;Failure during cartridge unload. Please try manually.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_RUN_INIT
)paren
(brace
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|15
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x35
suffix:colon
singleline_comment|// Drive equipment check. One of the following:
singleline_comment|// - cu cannot recover from a drive detected error
singleline_comment|// - a check code message is displayed on drive message/load displays
singleline_comment|// - the cartridge loader does not respond correctly
singleline_comment|// - a failure occurs during an index, load, or unload cycle
id|PRINT_WARN
c_func
(paren
l_string|&quot;Equipment check! Please check the drive and the cartridge loader.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x36
suffix:colon
r_switch
c_cond
(paren
id|cu_type
)paren
(brace
r_case
l_int|0x3480
suffix:colon
singleline_comment|// This erpa is reserved for 3480 -&gt; BUG
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|16
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3490
suffix:colon
singleline_comment|// End of data. This is a permanent I/O error, which cannot be recovered.
singleline_comment|// A read-type command has reached the end-of-data mark.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x37
suffix:colon
singleline_comment|// Tape length error. The tape is shorter than reported in the beginning-of-tape data.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape length error.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x38
suffix:colon
singleline_comment|// Physical end of tape. A read/write operation reached the physical end of tape.
r_if
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_eq
id|TS_WRI_INIT
)paren
(brace
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|ENOSPC
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
r_case
l_int|0x39
suffix:colon
singleline_comment|// Backward at BOT. The drive is at BOT and is requestet to move backward.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3a
suffix:colon
singleline_comment|// Drive switched not ready, but the command needs the drive to be ready.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Drive not ready. Turn the ready/not ready switch to ready position and try again.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3b
suffix:colon
singleline_comment|// Manual rewind or unload. This causes an I/O error.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Medium was rewound or unloaded manually. Expect errors! Please do only use the mtoffl and mtrew ioctl to unload tapes or rewind tapes.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3c
suffix:colon
r_case
l_int|0x3d
suffix:colon
r_case
l_int|0x3e
suffix:colon
r_case
l_int|0x3f
suffix:colon
singleline_comment|// These erpas are reserved -&gt; BUG
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|17
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x40
suffix:colon
singleline_comment|// Overrun error. This should have been covered earlier -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|18
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x41
suffix:colon
singleline_comment|// Record sequence error. This should have been covered earlier -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|19
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x42
suffix:colon
singleline_comment|// Degraded mode. A condition that can cause degraded performace is detected.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Subsystem is running in degraded mode. This may compromise your performace.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x43
suffix:colon
singleline_comment|// Drive not ready. Probably swith the ready/not ready switch to ready?
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is not ready. Maybe no medium in?&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|ENOMEDIUM
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x44
suffix:colon
singleline_comment|// Locate Block unsuccessfull. We&squot;ll report this.
r_if
c_cond
(paren
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_BLOCK_INIT
)paren
op_logical_and
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_LBL_INIT
)paren
)paren
(brace
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|20
)paren
suffix:semicolon
singleline_comment|// No locate block was issued...
r_return
suffix:semicolon
)brace
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x45
suffix:colon
singleline_comment|// The drive is assigned elsewhere [to a different channel path/computer].
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is assigned elsewhere.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x46
suffix:colon
singleline_comment|// Drive not online. Drive may be switched offline, the power supply may be switched off 
singleline_comment|// or the drive address may not be set correctly.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive is not online.&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x47
suffix:colon
singleline_comment|// Volume fenced. cu reports volume integrity is lost! 
id|PRINT_WARN
c_func
(paren
l_string|&quot;Volume fenced. The volume integrity is lost! &bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x48
suffix:colon
singleline_comment|// Log sense data and retry request. We&squot;ll do so...
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x49
suffix:colon
singleline_comment|// Bus out check. A parity check error on the bus was found.&t;PRINT_WARN(&quot;Bus out check. A data transfer over the bus was corrupted.&bslash;n&quot;);
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x4a
suffix:colon
singleline_comment|// Control unit erp failed. We&squot;ll report this.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The control unit failed recovering an I/O error.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x4b
suffix:colon
singleline_comment|// Cu and drive incompatible. The drive requests micro-program patches, which are not available on the cu.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The drive needs microprogram patches from the control unit, which are not available.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x4c
suffix:colon
singleline_comment|// Recovered Check-One failure. Cu develops a hardware error, but is able to recover. We&squot;ll reissue the command.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x4d
suffix:colon
r_switch
c_cond
(paren
id|cu_type
)paren
(brace
r_case
l_int|0x3480
suffix:colon
singleline_comment|// This erpa is reserved for 3480 -&gt; bug
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|21
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3490
suffix:colon
singleline_comment|// Resetting event recieved. Since the driver does not support resetting event recovery
singleline_comment|// (which has to be handled by the I/O Layer), we&squot;ll report and retry our command.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x4e
suffix:colon
r_switch
c_cond
(paren
id|cu_type
)paren
(brace
r_case
l_int|0x3480
suffix:colon
singleline_comment|// This erpa is reserved for 3480 -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|22
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3490
suffix:colon
singleline_comment|// Maximum block size exeeded. This indicates, that the block to be written is larger
singleline_comment|// than allowed for buffered mode. We&squot;ll report this...
id|PRINT_WARN
c_func
(paren
l_string|&quot;Maximum block size for buffered mode exceeded.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|ENOBUFS
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x4f
suffix:colon
singleline_comment|// These erpas are reserved -&gt; bug
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|23
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x50
suffix:colon
singleline_comment|// Read buffered log (Overflow). Cu is running in extended beffered log mode, and a counter overflows.
singleline_comment|// This should never happen, since we&squot;re never running in extended buffered log mode -&gt; bug.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x51
suffix:colon
singleline_comment|// Read buffered log (EOV). EOF processing occurs while the cu is in extended buffered log mode.
singleline_comment|// This should never happen, since we&squot;re never running in extended buffered log mode -&gt; bug.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x52
suffix:colon
singleline_comment|// End of Volume complete. Rewind unload completed ok. We&squot;ll report to the user...
r_if
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_RUN_INIT
)paren
(brace
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|24
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tape34xx_error_recovery_succeded
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x53
suffix:colon
singleline_comment|// Global command intercept. We&squot;ll have to reissue our command.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x54
suffix:colon
singleline_comment|// Channel interface recovery (temporary). This can be recovered by reissuing the command.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x55
suffix:colon
singleline_comment|// Channel interface recovery (permanent). This cannot be recovered, we&squot;ll inform the user.
id|PRINT_WARN
c_func
(paren
l_string|&quot;A permanent channel interface error occurred.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x56
suffix:colon
singleline_comment|// Channel protocol error. This cannot be recovered.
id|PRINT_WARN
c_func
(paren
l_string|&quot;A channel protocol error occurred.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x57
suffix:colon
r_switch
c_cond
(paren
id|cu_type
)paren
(brace
r_case
l_int|0x3480
suffix:colon
singleline_comment|// Attention intercept. We have to reissue the command.
id|PRINT_WARN
c_func
(paren
l_string|&quot;An attention intercept occurred, which will be recovered.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x3490
suffix:colon
singleline_comment|// Global status intercept. We have to reissue the command.
id|PRINT_WARN
c_func
(paren
l_string|&quot;An global status intercept was recieved, which will be recovered.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_case
l_int|0x58
suffix:colon
r_case
l_int|0x59
suffix:colon
singleline_comment|// These erpas are reserved -&gt; bug.
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|25
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5a
suffix:colon
singleline_comment|// Tape length incompatible. The tape inserted is too long, 
singleline_comment|// which could cause damage to the tape or the drive.
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape length incompatible [should be IBM Cartridge System Tape]. May cause damage to drive or tape.n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5b
suffix:colon
singleline_comment|// Format 3480 XF incompatible
r_if
c_cond
(paren
id|sense
(braket
l_int|1
)braket
op_amp
id|SENSE_BEGINNING_OF_TAPE
)paren
(brace
singleline_comment|// Everything is fine. The tape will be overwritten in a different format.
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape format is incompatible to the drive, which writes 3480-2 XF.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5c
suffix:colon
singleline_comment|// Format 3480-2 XF incompatible
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape format is incompatible to the drive. The drive cannot access 3480-2 XF volumes.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5d
suffix:colon
singleline_comment|// Tape length violation. 
id|PRINT_WARN
c_func
(paren
l_string|&quot;Tape length violation [should be IBM Enhanced Capacity Cartridge System Tape]. May cause damage to drive or tape.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EMEDIUMTYPE
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0x5e
suffix:colon
singleline_comment|// Compaction algorithm incompatible.
id|PRINT_WARN
c_func
(paren
l_string|&quot;The volume is recorded using an incompatible compaction algorith, which is not supported by the control unit.&bslash;n&quot;
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EMEDIUMTYPE
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
singleline_comment|// Reserved erpas -&gt; bug
id|tape34xx_error_recovery_HWBUG
c_func
(paren
id|ti
comma
l_int|26
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
DECL|function|tape34xx_error_recovery_has_failed
r_void
id|tape34xx_error_recovery_has_failed
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|error_id
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xerp fail&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;UNKNOWN&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_UNUSED
)paren
op_logical_and
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_IDLE
)paren
)paren
(brace
id|tape_dump_sense
c_func
(paren
op_amp
id|ti-&gt;devstat
)paren
suffix:semicolon
id|ti-&gt;rc
op_assign
op_minus
id|error_id
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
)paren
(brace
r_case
id|TS_REW_RELEASE_INIT
suffix:colon
r_case
id|TS_RFO_INIT
suffix:colon
r_case
id|TS_RBA_INIT
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_FAILED
)paren
suffix:semicolon
id|wake_up
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TS_BLOCK_INIT
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_FAILED
)paren
suffix:semicolon
id|schedule_tapeblock_exec_IO
c_func
(paren
id|ti
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_FAILED
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ti-&gt;wq
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Recieved an unsolicited IRQ.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
c_func
(paren
op_amp
id|ti-&gt;devstat
)paren
suffix:semicolon
)brace
)brace
DECL|function|tape34xx_error_recovery_succeded
r_void
id|tape34xx_error_recovery_succeded
c_func
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xerp done&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;UNKNOWN&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_UNUSED
)paren
op_logical_and
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_DONE
)paren
)paren
(brace
id|tapestate_event
(paren
id|ti
comma
id|TE_DONE
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Recieved an unsolicited IRQ.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
c_func
(paren
op_amp
id|ti-&gt;devstat
)paren
suffix:semicolon
)brace
)brace
DECL|function|tape34xx_error_recovery_do_retry
r_void
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;xerp retr&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;UNKNOWN&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_UNUSED
)paren
op_logical_and
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
op_ne
id|TS_IDLE
)paren
)paren
(brace
id|tape_dump_sense
c_func
(paren
op_amp
id|ti-&gt;devstat
)paren
suffix:semicolon
r_while
c_loop
(paren
id|do_IO
(paren
id|ti-&gt;devinfo.irq
comma
id|ti-&gt;cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|ti-&gt;cqr
comma
l_int|0x00
comma
id|ti-&gt;cqr-&gt;options
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;Recieved an unsolicited IRQ.&bslash;n&quot;
)paren
suffix:semicolon
id|tape_dump_sense
c_func
(paren
op_amp
id|ti-&gt;devstat
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_error_recovery_read_opposite
id|tape34xx_error_recovery_read_opposite
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
r_switch
c_cond
(paren
id|tapestate_get
c_func
(paren
id|ti
)paren
)paren
(brace
r_case
id|TS_RFO_INIT
suffix:colon
singleline_comment|// We did read forward, but the data could not be read *correctly*.
singleline_comment|// We will read backward and then skip forward again.
id|ti-&gt;cqr
op_assign
id|tape34xx_read_opposite
c_func
(paren
id|ti
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;cqr
op_eq
l_int|NULL
)paren
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_else
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TS_RBA_INIT
suffix:colon
singleline_comment|// We tried to read forward and backward, but hat no success -&gt; failed.
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TS_BLOCK_INIT
suffix:colon
id|tape34xx_error_recovery_do_retry
c_func
(paren
id|ti
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_WARN
c_func
(paren
l_string|&quot;read_opposite_recovery_called_with_state:%s&bslash;n&quot;
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;UNKNOWN&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|tape34xx_error_recovery_HWBUG
id|tape34xx_error_recovery_HWBUG
(paren
id|tape_info_t
op_star
id|ti
comma
r_int
id|condno
)paren
(brace
id|devstat_t
op_star
id|stat
op_assign
op_amp
id|ti-&gt;devstat
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;An unexpected condition #%d was caught in tape error recovery.&bslash;n&quot;
comma
id|condno
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;Please report this incident.&bslash;n&quot;
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;State of the tape:%s&bslash;n&quot;
comma
(paren
(paren
(paren
id|tapestate_get
(paren
id|ti
)paren
OL
id|TS_SIZE
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ge
l_int|0
)paren
)paren
ques
c_cond
id|state_verbose
(braket
id|tapestate_get
(paren
id|ti
)paren
)braket
suffix:colon
l_string|&quot;UNKNOWN&quot;
)paren
)paren
suffix:semicolon
id|PRINT_INFO
(paren
l_string|&quot;Sense data: %02X%02X%02X%02X %02X%02X%02X%02X &quot;
l_string|&quot; %02X%02X%02X%02X %02X%02X%02X%02X &bslash;n&quot;
comma
id|stat-&gt;ii.sense.data
(braket
l_int|0
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|1
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|2
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|3
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|4
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|5
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|6
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|7
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|8
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|9
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|10
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|11
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|12
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|13
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|14
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|15
)braket
)paren
suffix:semicolon
id|PRINT_INFO
(paren
l_string|&quot;Sense data: %02X%02X%02X%02X %02X%02X%02X%02X &quot;
l_string|&quot; %02X%02X%02X%02X %02X%02X%02X%02X &bslash;n&quot;
comma
id|stat-&gt;ii.sense.data
(braket
l_int|16
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|17
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|18
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|19
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|20
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|21
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|22
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|23
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|24
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|25
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|26
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|27
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|28
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|29
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|30
)braket
comma
id|stat-&gt;ii.sense.data
(braket
l_int|31
)braket
)paren
suffix:semicolon
id|tape34xx_error_recovery_has_failed
c_func
(paren
id|ti
comma
id|EIO
)paren
suffix:semicolon
)brace
eof
