multiline_comment|/***************************************************************************&n; *&n; *  drivers/s390/char/tapechar.c&n; *    character device frontend for tape device driver&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001 IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *               Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&n; *&n; ****************************************************************************&n; */
macro_line|#include &quot;tapedefs.h&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/ccwcache.h&gt;&t;/* CCW allocations      */
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#include &lt;asm/debug.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#ifdef MODULE
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#endif
macro_line|#include &quot;tape.h&quot;
macro_line|#include &quot;tapechar.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;TCHAR:&quot;
multiline_comment|/*&n; * file operation structure for tape devices&n; */
DECL|variable|tape_fops
r_static
r_struct
id|file_operations
id|tape_fops
op_assign
(brace
singleline_comment|//    owner   : THIS_MODULE,
id|llseek
suffix:colon
l_int|NULL
comma
multiline_comment|/* lseek - default */
id|read
suffix:colon
id|tape_read
comma
multiline_comment|/* read  */
id|write
suffix:colon
id|tape_write
comma
multiline_comment|/* write */
id|readdir
suffix:colon
l_int|NULL
comma
multiline_comment|/* readdir - bad */
id|poll
suffix:colon
l_int|NULL
comma
multiline_comment|/* poll */
id|ioctl
suffix:colon
id|tape_ioctl
comma
multiline_comment|/* ioctl */
id|mmap
suffix:colon
l_int|NULL
comma
multiline_comment|/* mmap */
id|open
suffix:colon
id|tape_open
comma
multiline_comment|/* open */
id|flush
suffix:colon
l_int|NULL
comma
multiline_comment|/* flush */
id|release
suffix:colon
id|tape_release
comma
multiline_comment|/* release */
id|fsync
suffix:colon
l_int|NULL
comma
multiline_comment|/* fsync */
id|fasync
suffix:colon
l_int|NULL
comma
multiline_comment|/* fasync */
id|lock
suffix:colon
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|tape_major
r_int
id|tape_major
op_assign
id|TAPE_MAJOR
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
r_void
DECL|function|tapechar_mkdevfstree
id|tapechar_mkdevfstree
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
id|ti-&gt;devfs_char_dir
op_assign
id|devfs_mk_dir
(paren
id|ti-&gt;devfs_dir
comma
l_string|&quot;char&quot;
comma
id|ti
)paren
suffix:semicolon
id|ti-&gt;devfs_nonrewinding
op_assign
id|devfs_register
c_func
(paren
id|ti-&gt;devfs_char_dir
comma
l_string|&quot;nonrewinding&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|tape_major
comma
id|ti-&gt;nor_minor
comma
id|TAPECHAR_DEFAULTMODE
comma
op_amp
id|tape_fops
comma
id|ti
)paren
suffix:semicolon
id|ti-&gt;devfs_rewinding
op_assign
id|devfs_register
c_func
(paren
id|ti-&gt;devfs_char_dir
comma
l_string|&quot;rewinding&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|tape_major
comma
id|ti-&gt;rew_minor
comma
id|TAPECHAR_DEFAULTMODE
comma
op_amp
id|tape_fops
comma
id|ti
)paren
suffix:semicolon
)brace
r_void
DECL|function|tapechar_rmdevfstree
id|tapechar_rmdevfstree
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
id|devfs_unregister
c_func
(paren
id|ti-&gt;devfs_nonrewinding
)paren
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|ti-&gt;devfs_rewinding
)paren
suffix:semicolon
id|devfs_unregister
c_func
(paren
id|ti-&gt;devfs_char_dir
)paren
suffix:semicolon
)brace
macro_line|#endif
r_void
DECL|function|tapechar_setup
id|tapechar_setup
(paren
id|tape_info_t
op_star
id|ti
)paren
(brace
macro_line|#ifdef CONFIG_DEVFS_FS
id|tapechar_mkdevfstree
c_func
(paren
id|ti
)paren
suffix:semicolon
macro_line|#endif
)brace
r_void
DECL|function|tapechar_init
id|tapechar_init
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|tape_frontend_t
op_star
id|charfront
comma
op_star
id|temp
suffix:semicolon
id|tape_info_t
op_star
id|ti
suffix:semicolon
id|tape_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Register the tape major number to the kernel */
macro_line|#ifdef CONFIG_DEVFS_FS
id|result
op_assign
id|devfs_register_chrdev
(paren
id|tape_major
comma
l_string|&quot;tape&quot;
comma
op_amp
id|tape_fops
)paren
suffix:semicolon
macro_line|#else
id|result
op_assign
id|register_chrdev
(paren
id|tape_major
comma
l_string|&quot;tape&quot;
comma
op_amp
id|tape_fops
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|PRINT_WARN
(paren
id|KERN_ERR
l_string|&quot;tape: can&squot;t get major %d&bslash;n&quot;
comma
id|tape_major
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;c:initfail&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;regchrfail&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|panic
(paren
l_string|&quot;no major number available for tape char device&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tape_major
op_eq
l_int|0
)paren
id|tape_major
op_assign
id|result
suffix:semicolon
multiline_comment|/* accept dynamic major number */
id|PRINT_WARN
(paren
id|KERN_ERR
l_string|&quot; tape gets major %d for character device&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|charfront
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|tape_frontend_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|charfront
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;c:initfail&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;no mem&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|panic
(paren
l_string|&quot;no major number available for tape char device&quot;
)paren
suffix:semicolon
)brace
id|charfront-&gt;device_setup
op_assign
id|tapechar_setup
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|charfront-&gt;mkdevfstree
op_assign
id|tapechar_mkdevfstree
suffix:semicolon
id|charfront-&gt;rmdevfstree
op_assign
id|tapechar_rmdevfstree
suffix:semicolon
macro_line|#endif
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;c:init ok&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|charfront-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|first_frontend
op_eq
l_int|NULL
)paren
(brace
id|first_frontend
op_assign
id|charfront
suffix:semicolon
)brace
r_else
(brace
id|temp
op_assign
id|first_frontend
suffix:semicolon
r_while
c_loop
(paren
id|temp-&gt;next
op_ne
l_int|NULL
)paren
id|temp
op_assign
id|temp-&gt;next
suffix:semicolon
id|temp-&gt;next
op_assign
id|charfront
suffix:semicolon
)brace
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
id|ti
op_ne
l_int|NULL
)paren
(brace
id|tapechar_setup
c_func
(paren
id|ti
)paren
suffix:semicolon
id|ti
op_assign
id|ti-&gt;next
suffix:semicolon
)brace
)brace
r_void
DECL|function|tapechar_uninit
id|tapechar_uninit
(paren
r_void
)paren
(brace
id|unregister_chrdev
(paren
id|tape_major
comma
l_string|&quot;tape&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device read function&n; */
id|ssize_t
DECL|function|tape_read
id|tape_read
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|data
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|tape_info_t
op_star
id|ti
suffix:semicolon
r_int
id|block_size
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
r_int
id|rc
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:read&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ti
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ti-&gt;rew_filp
op_ne
id|filp
)paren
op_logical_and
(paren
id|ti-&gt;nor_filp
op_ne
id|filp
)paren
)paren
id|ti
op_assign
(paren
id|tape_info_t
op_star
)paren
id|ti-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:nodev&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|filp-&gt;f_pos
)paren
(brace
multiline_comment|/* &quot;A request was outside the capabilities of the device.&quot; */
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:ppos wrong&quot;
)paren
suffix:semicolon
macro_line|#endif /* TAPE_DEBUG */
r_return
op_minus
id|EOVERFLOW
suffix:semicolon
multiline_comment|/* errno=75 Value too large for def. data type */
)brace
r_if
c_cond
(paren
id|ti-&gt;block_size
op_eq
l_int|0
)paren
(brace
id|block_size
op_assign
id|count
suffix:semicolon
)brace
r_else
(brace
id|block_size
op_assign
id|ti-&gt;block_size
suffix:semicolon
)brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:nbytes:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|block_size
)paren
suffix:semicolon
macro_line|#endif
id|cqr
op_assign
id|ti-&gt;discipline-&gt;read_block
(paren
id|data
comma
id|block_size
comma
id|ti
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
id|cqr
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|do_IO
(paren
id|ti-&gt;devinfo.irq
comma
id|cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|cqr
comma
l_int|0x00
comma
id|cqr-&gt;options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|tapestate_set
c_func
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|kfree
(paren
id|cqr
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|wait_event_interruptible
(paren
id|ti-&gt;wq
comma
id|ti-&gt;wanna_wakeup
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;discipline-&gt;free_read_block
(paren
id|cqr
comma
id|ti
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_eq
id|TS_FAILED
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
id|ti-&gt;rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_eq
id|TS_NOT_OPER
)paren
(brace
id|ti-&gt;blk_minor
op_assign
id|ti-&gt;rew_minor
op_assign
id|ti-&gt;nor_minor
op_assign
op_minus
l_int|1
suffix:semicolon
id|ti-&gt;devinfo.irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ne
id|TS_DONE
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:rbytes:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|block_size
op_minus
id|ti-&gt;devstat.rescnt
)paren
suffix:semicolon
macro_line|#endif&t;/* TAPE_DEBUG */
id|filp-&gt;f_pos
op_add_assign
id|block_size
op_minus
id|ti-&gt;devstat.rescnt
suffix:semicolon
r_return
id|block_size
op_minus
id|ti-&gt;devstat.rescnt
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device write function&n; */
id|ssize_t
DECL|function|tape_write
id|tape_write
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|tape_info_t
op_star
id|ti
suffix:semicolon
r_int
id|block_size
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
r_int
id|nblocks
comma
id|i
comma
id|rc
suffix:semicolon
r_int
id|written
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:write&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ti
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ti-&gt;nor_filp
op_ne
id|filp
)paren
op_logical_and
(paren
id|ti-&gt;rew_filp
op_ne
id|filp
)paren
)paren
id|ti
op_assign
(paren
id|tape_info_t
op_star
)paren
id|ti-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|filp-&gt;f_pos
)paren
(brace
multiline_comment|/* &quot;A request was outside the capabilities of the device.&quot; */
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:ppos wrong&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EOVERFLOW
suffix:semicolon
multiline_comment|/* errno=75 Value too large for def. data type */
)brace
r_if
c_cond
(paren
(paren
id|ti-&gt;block_size
op_ne
l_int|0
)paren
op_logical_and
(paren
id|count
op_mod
id|ti-&gt;block_size
op_ne
l_int|0
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;block_size
op_eq
l_int|0
)paren
(brace
id|block_size
op_assign
id|count
suffix:semicolon
id|nblocks
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|block_size
op_assign
id|ti-&gt;block_size
suffix:semicolon
id|nblocks
op_assign
id|count
op_div
(paren
id|ti-&gt;block_size
)paren
suffix:semicolon
)brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:nbytes:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|block_size
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:nblocks:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|nblocks
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nblocks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cqr
op_assign
id|ti-&gt;discipline-&gt;write_block
(paren
id|data
op_plus
id|i
op_star
id|block_size
comma
id|block_size
comma
id|ti
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cqr
)paren
(brace
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
id|cqr
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|do_IO
(paren
id|ti-&gt;devinfo.irq
comma
id|cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|cqr
comma
l_int|0x00
comma
id|cqr-&gt;options
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|wait_event_interruptible
(paren
id|ti-&gt;wq
comma
id|ti-&gt;wanna_wakeup
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
l_int|NULL
suffix:semicolon
id|ti-&gt;discipline-&gt;free_write_block
(paren
id|cqr
comma
id|ti
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_eq
id|TS_FAILED
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ti-&gt;rc
op_eq
op_minus
id|ENOSPC
)paren
op_logical_and
(paren
id|i
op_ne
l_int|0
)paren
)paren
r_return
id|i
op_star
id|block_size
suffix:semicolon
r_return
id|ti-&gt;rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_eq
id|TS_NOT_OPER
)paren
(brace
id|ti-&gt;blk_minor
op_assign
id|ti-&gt;rew_minor
op_assign
id|ti-&gt;nor_minor
op_assign
op_minus
l_int|1
suffix:semicolon
id|ti-&gt;devinfo.irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ne
id|TS_DONE
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:wbytes:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|block_size
op_minus
id|ti-&gt;devstat.rescnt
)paren
suffix:semicolon
macro_line|#endif
id|filp-&gt;f_pos
op_add_assign
id|block_size
op_minus
id|ti-&gt;devstat.rescnt
suffix:semicolon
id|written
op_add_assign
id|block_size
op_minus
id|ti-&gt;devstat.rescnt
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;devstat.rescnt
OG
l_int|0
)paren
r_return
id|written
suffix:semicolon
)brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:wtotal:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|written
)paren
suffix:semicolon
macro_line|#endif
r_return
id|written
suffix:semicolon
)brace
r_static
r_int
DECL|function|tape_mtioctop
id|tape_mtioctop
(paren
r_struct
id|file
op_star
id|filp
comma
r_int
id|mt_op
comma
r_int
id|mt_count
)paren
(brace
id|tape_info_t
op_star
id|ti
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|lockflags
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:mtio&quot;
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:ioop:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|mt_op
)paren
suffix:semicolon
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:arg:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|mt_count
)paren
suffix:semicolon
macro_line|#endif
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ti
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ti-&gt;rew_filp
op_ne
id|filp
)paren
op_logical_and
(paren
id|ti-&gt;nor_filp
op_ne
id|filp
)paren
)paren
id|ti
op_assign
(paren
id|tape_info_t
op_star
)paren
id|ti-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_switch
c_cond
(paren
id|mt_op
)paren
(brace
r_case
id|MTREW
suffix:colon
singleline_comment|// rewind
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtrew
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTOFFL
suffix:colon
singleline_comment|// put drive offline
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtoffl
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTUNLOAD
suffix:colon
singleline_comment|// unload the tape
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtunload
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
singleline_comment|// write tapemark
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtweof
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSF
suffix:colon
singleline_comment|// forward space file
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtfsf
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSF
suffix:colon
singleline_comment|// backward space file
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtbsf
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSFM
suffix:colon
singleline_comment|// forward space file, stop at BOT side
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtfsfm
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSFM
suffix:colon
singleline_comment|// backward space file, stop at BOT side
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtbsfm
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSR
suffix:colon
singleline_comment|// forward space file
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtfsr
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSR
suffix:colon
singleline_comment|// backward space file
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtbsr
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTNOP
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtnop
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
singleline_comment|// postion at the end of portion
r_case
id|MTRETEN
suffix:colon
singleline_comment|// retension the tape
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mteom
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTERASE
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mterase
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETDENSITY
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtsetdensity
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSEEK
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtseek
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETDRVBUFFER
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtsetdrvbuffer
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTLOCK
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtsetdrvbuffer
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTUNLOCK
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtsetdrvbuffer
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTLOAD
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtload
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_ne
l_int|NULL
)paren
r_break
suffix:semicolon
singleline_comment|// if backend driver has an load function -&gt;use it
singleline_comment|// if no medium is in, wait until it gets inserted
r_if
c_cond
(paren
id|ti-&gt;medium_is_unloaded
)paren
(brace
id|wait_event_interruptible
(paren
id|ti-&gt;wq
comma
id|ti-&gt;medium_is_unloaded
op_eq
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|MTCOMPRESSION
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtcompression
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETPART
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtsetpart
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTMKPART
suffix:colon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtmkpart
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTTELL
suffix:colon
singleline_comment|// return number of block relative to current file
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mttell
(paren
id|ti
comma
id|mt_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETBLK
suffix:colon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;block_size
op_assign
id|mt_count
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:setblk:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|mt_count
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
r_case
id|MTRESET
suffix:colon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
id|ti-&gt;userbuf
op_assign
l_int|NULL
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|ti-&gt;block_size
op_assign
l_int|0
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:devreset:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|ti-&gt;blk_minor
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:inv.mtio&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cqr
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:ccwg fail&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
id|cqr
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|do_IO
(paren
id|ti-&gt;devinfo.irq
comma
id|cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|cqr
comma
l_int|0x00
comma
id|cqr-&gt;options
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|wait_event_interruptible
(paren
id|ti-&gt;wq
comma
id|ti-&gt;wanna_wakeup
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;kernbuf
op_ne
l_int|NULL
)paren
(brace
id|kfree
(paren
id|ti-&gt;kernbuf
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
singleline_comment|// if medium was unloaded, update the corresponding variable.
r_switch
c_cond
(paren
id|mt_op
)paren
(brace
r_case
id|MTOFFL
suffix:colon
r_case
id|MTUNLOAD
suffix:colon
id|ti-&gt;medium_is_unloaded
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|mt_op
op_eq
id|MTEOM
)paren
op_logical_or
(paren
id|mt_op
op_eq
id|MTRETEN
)paren
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_eq
id|TS_FAILED
)paren
)paren
id|tapestate_set
(paren
id|ti
comma
id|TS_DONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_eq
id|TS_FAILED
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
id|ti-&gt;rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_eq
id|TS_NOT_OPER
)paren
(brace
id|ti-&gt;blk_minor
op_assign
id|ti-&gt;rew_minor
op_assign
id|ti-&gt;nor_minor
op_assign
op_minus
l_int|1
suffix:semicolon
id|ti-&gt;devinfo.irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ne
id|TS_DONE
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mt_op
)paren
(brace
r_case
id|MTRETEN
suffix:colon
singleline_comment|//need to rewind the tape after moving to eom
r_return
id|tape_mtioctop
(paren
id|filp
comma
id|MTREW
comma
l_int|1
)paren
suffix:semicolon
r_case
id|MTFSFM
suffix:colon
singleline_comment|//need to skip back over the filemark
r_return
id|tape_mtioctop
(paren
id|filp
comma
id|MTBSFM
comma
l_int|1
)paren
suffix:semicolon
r_case
id|MTBSF
suffix:colon
singleline_comment|//need to skip forward over the filemark
r_return
id|tape_mtioctop
(paren
id|filp
comma
id|MTFSF
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:mtio done&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device io controls.&n; */
r_int
DECL|function|tape_ioctl
id|tape_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|tape_info_t
op_star
id|ti
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
suffix:semicolon
r_struct
id|mtop
id|op
suffix:semicolon
multiline_comment|/* structure for MTIOCTOP */
r_struct
id|mtpos
id|pos
suffix:semicolon
multiline_comment|/* structure for MTIOCPOS */
r_struct
id|mtget
id|get
suffix:semicolon
r_int
id|rc
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:ioct&quot;
)paren
suffix:semicolon
macro_line|#endif
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ti
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ti-&gt;rew_minor
op_ne
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
op_logical_and
(paren
id|ti-&gt;nor_minor
op_ne
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
)paren
id|ti
op_assign
(paren
id|tape_info_t
op_star
)paren
id|ti-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:nodev&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
singleline_comment|// check for discipline ioctl overloading
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|ti-&gt;discipline-&gt;discipline_ioctl_overload
(paren
id|inode
comma
id|filp
comma
id|cmd
comma
id|arg
)paren
)paren
op_ne
op_minus
id|EINVAL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:ioverloa&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|rc
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MTIOCTOP
suffix:colon
multiline_comment|/* tape op command */
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|op
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtop
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
(paren
id|tape_mtioctop
(paren
id|filp
comma
id|op.mt_op
comma
id|op.mt_count
)paren
)paren
suffix:semicolon
r_case
id|MTIOCPOS
suffix:colon
multiline_comment|/* query tape position */
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mttell
(paren
id|ti
comma
l_int|0
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
id|cqr
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|0
suffix:semicolon
id|do_IO
(paren
id|ti-&gt;devinfo.irq
comma
id|cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|cqr
comma
l_int|0x00
comma
id|cqr-&gt;options
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|wait_event_interruptible
(paren
id|ti-&gt;wq
comma
id|ti-&gt;wanna_wakeup
)paren
suffix:semicolon
id|pos.mt_blkno
op_assign
id|ti-&gt;rc
suffix:semicolon
id|ti-&gt;cqr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;kernbuf
op_ne
l_int|NULL
)paren
(brace
id|kfree
(paren
id|ti-&gt;kernbuf
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|pos
comma
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|MTIOCGET
suffix:colon
id|get.mt_erreg
op_assign
id|ti-&gt;rc
suffix:semicolon
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mttell
(paren
id|ti
comma
l_int|0
)paren
suffix:semicolon
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
id|cqr
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|0
suffix:semicolon
id|do_IO
(paren
id|ti-&gt;devinfo.irq
comma
id|cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|cqr
comma
l_int|0x00
comma
id|cqr-&gt;options
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|wait_event_interruptible
(paren
id|ti-&gt;wq
comma
id|ti-&gt;wanna_wakeup
)paren
suffix:semicolon
id|get.mt_blkno
op_assign
id|ti-&gt;rc
suffix:semicolon
id|get.mt_fileno
op_assign
l_int|0
suffix:semicolon
id|get.mt_type
op_assign
id|MT_ISUNKNOWN
suffix:semicolon
id|get.mt_resid
op_assign
id|ti-&gt;devstat.rescnt
suffix:semicolon
id|get.mt_dsreg
op_assign
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|3
)braket
suffix:semicolon
id|get.mt_gstat
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_amp
l_int|0x08
)paren
id|get.mt_gstat
op_and_assign
id|GMT_BOT
(paren
l_int|1
)paren
suffix:semicolon
singleline_comment|// BOT
r_if
c_cond
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_amp
l_int|0x02
)paren
id|get.mt_gstat
op_and_assign
id|GMT_WR_PROT
(paren
l_int|1
)paren
suffix:semicolon
singleline_comment|// write protected
r_if
c_cond
(paren
id|ti-&gt;devstat.ii.sense.data
(braket
l_int|1
)braket
op_amp
l_int|0x40
)paren
id|get.mt_gstat
op_and_assign
id|GMT_ONLINE
(paren
l_int|1
)paren
suffix:semicolon
singleline_comment|//drive online
id|ti-&gt;cqr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;kernbuf
op_ne
l_int|NULL
)paren
(brace
id|kfree
(paren
id|ti-&gt;kernbuf
)paren
suffix:semicolon
id|ti-&gt;kernbuf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
(paren
id|current
)paren
)paren
(brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|get
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|3
comma
l_string|&quot;c:ioct inv&quot;
)paren
suffix:semicolon
macro_line|#endif&t;    
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Tape device open function.&n; */
r_int
DECL|function|tape_open
id|tape_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|tape_info_t
op_star
id|ti
suffix:semicolon
id|kdev_t
id|dev
suffix:semicolon
r_int
id|lockflags
suffix:semicolon
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ti
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ti-&gt;rew_minor
op_ne
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
op_logical_and
(paren
id|ti-&gt;nor_minor
op_ne
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
)paren
id|ti
op_assign
(paren
id|tape_info_t
op_star
)paren
id|ti-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|ti
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:open:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|ti-&gt;blk_minor
)paren
suffix:semicolon
macro_line|#endif
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ne
id|TS_UNUSED
)paren
(brace
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:dbusy&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|tapestate_set
(paren
id|ti
comma
id|TS_IDLE
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|dev
op_assign
id|MKDEV
(paren
id|tape_major
comma
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
multiline_comment|/* Get the device */
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ti-&gt;rew_minor
op_eq
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
id|ti-&gt;rew_filp
op_assign
id|filp
suffix:semicolon
multiline_comment|/* save for later reference     */
r_else
id|ti-&gt;nor_filp
op_assign
id|filp
suffix:semicolon
id|filp-&gt;private_data
op_assign
id|ti
suffix:semicolon
multiline_comment|/* save the dev.info for later reference */
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* MODULE */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device release function.&n; */
r_int
DECL|function|tape_release
id|tape_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|lockflags
suffix:semicolon
id|tape_info_t
op_star
id|ti
comma
op_star
id|lastti
suffix:semicolon
id|ccw_req_t
op_star
id|cqr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ti
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ti-&gt;rew_minor
op_ne
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
op_logical_and
(paren
id|ti-&gt;nor_minor
op_ne
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
)paren
id|ti
op_assign
(paren
id|tape_info_t
op_star
)paren
id|ti-&gt;next
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ti
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|tapestate_get
(paren
id|ti
)paren
op_eq
id|TS_NOT_OPER
)paren
)paren
(brace
r_if
c_cond
(paren
id|ti
op_eq
id|first_tape_info
)paren
(brace
id|first_tape_info
op_assign
id|ti-&gt;next
suffix:semicolon
)brace
r_else
(brace
id|lastti
op_assign
id|first_tape_info
suffix:semicolon
r_while
c_loop
(paren
id|lastti-&gt;next
op_ne
id|ti
)paren
id|lastti
op_assign
id|lastti-&gt;next
suffix:semicolon
id|lastti-&gt;next
op_assign
id|ti-&gt;next
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ti
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ti
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|tapestate_get
(paren
id|ti
)paren
op_ne
id|TS_IDLE
)paren
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:notidle!&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* error in tape_release */
)brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:release:&quot;
)paren
suffix:semicolon
id|debug_int_event
(paren
id|tape_debug_area
comma
l_int|6
comma
id|ti-&gt;blk_minor
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|ti-&gt;rew_minor
op_eq
id|MINOR
(paren
id|inode-&gt;i_rdev
)paren
)paren
(brace
id|cqr
op_assign
id|ti-&gt;discipline-&gt;mtrew
(paren
id|ti
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cqr
op_ne
l_int|NULL
)paren
(brace
macro_line|#ifdef TAPE_DEBUG
id|debug_text_event
(paren
id|tape_debug_area
comma
l_int|6
comma
l_string|&quot;c:rewrelea&quot;
)paren
suffix:semicolon
macro_line|#endif
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_REW_RELEASE_INIT
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
id|cqr
suffix:semicolon
id|ti-&gt;wanna_wakeup
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|do_IO
(paren
id|ti-&gt;devinfo.irq
comma
id|cqr-&gt;cpaddr
comma
(paren
r_int
r_int
)paren
id|cqr
comma
l_int|0x00
comma
id|cqr-&gt;options
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|wait_event
(paren
id|ti-&gt;wq
comma
id|ti-&gt;wanna_wakeup
)paren
suffix:semicolon
id|ti-&gt;cqr
op_assign
l_int|NULL
suffix:semicolon
id|tape_free_request
(paren
id|cqr
)paren
suffix:semicolon
)brace
)brace
id|s390irq_spin_lock_irqsave
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|tapestate_set
(paren
id|ti
comma
id|TS_UNUSED
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
(paren
id|ti-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* MODULE */
r_return
l_int|0
suffix:semicolon
)brace
eof
