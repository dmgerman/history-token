multiline_comment|/***************************************************************************&n; *&n; *  drivers/s390/char/tapechar.c&n; *    character device frontend for tape device driver&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001 IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *               Michael Holzheu &lt;holzheu@de.ibm.com&gt;&n; *               Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&n; *&n; ****************************************************************************&n; */
macro_line|#include &quot;tapedefs.h&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/s390dyn.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#ifdef MODULE
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#endif
macro_line|#include &quot;tape.h&quot;
macro_line|#include &quot;tapechar.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;TCHAR:&quot;
multiline_comment|/*******************************************************************&n; * GLOBALS&n; *******************************************************************/
multiline_comment|/*&n; * file operation structure for tape devices&n; */
DECL|variable|tape_fops
r_static
r_struct
id|file_operations
id|tape_fops
op_assign
(brace
id|read
suffix:colon
id|tapechar_read
comma
id|write
suffix:colon
id|tapechar_write
comma
id|ioctl
suffix:colon
id|tapechar_ioctl
comma
id|open
suffix:colon
id|tapechar_open
comma
id|release
suffix:colon
id|tapechar_release
comma
)brace
suffix:semicolon
DECL|variable|tapechar_major
r_int
id|tapechar_major
op_assign
id|TAPECHAR_MAJOR
suffix:semicolon
multiline_comment|/*******************************************************************&n; * DEVFS Functions&n; *******************************************************************/
macro_line|#ifdef CONFIG_DEVFS_FS
multiline_comment|/*&n; * Create Char directory with (non)rewinding entries&n; */
id|devfs_handle_t
DECL|function|tapechar_mkdevfstree
id|tapechar_mkdevfstree
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|devfs_handle_t
id|rc
op_assign
l_int|NULL
suffix:semicolon
id|rc
op_assign
id|td-&gt;char_data.devfs_char_dir
op_assign
id|devfs_mk_dir
(paren
id|td-&gt;devfs_dir
comma
l_string|&quot;char&quot;
comma
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|NULL
)paren
r_goto
id|out_undo
suffix:semicolon
id|rc
op_assign
id|td-&gt;char_data.devfs_nonrewinding
op_assign
id|devfs_register
c_func
(paren
id|td-&gt;char_data.devfs_char_dir
comma
l_string|&quot;nonrewinding&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|tapechar_major
comma
id|TAPECHAR_NOREW_MINOR
c_func
(paren
id|td-&gt;first_minor
)paren
comma
id|TAPECHAR_DEVFSMODE
comma
op_amp
id|tape_fops
comma
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|NULL
)paren
r_goto
id|out_undo
suffix:semicolon
id|rc
op_assign
id|td-&gt;char_data.devfs_rewinding
op_assign
id|devfs_register
c_func
(paren
id|td-&gt;char_data.devfs_char_dir
comma
l_string|&quot;rewinding&quot;
comma
id|DEVFS_FL_DEFAULT
comma
id|tapechar_major
comma
id|TAPECHAR_REW_MINOR
c_func
(paren
id|td-&gt;first_minor
)paren
comma
id|TAPECHAR_DEVFSMODE
comma
op_amp
id|tape_fops
comma
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|NULL
)paren
r_goto
id|out_undo
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|out_undo
suffix:colon
id|tapechar_rmdevfstree
(paren
id|td
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove DEVFS entries&n; */
r_void
DECL|function|tapechar_rmdevfstree
id|tapechar_rmdevfstree
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
r_if
c_cond
(paren
id|td-&gt;char_data.devfs_nonrewinding
)paren
id|devfs_unregister
c_func
(paren
id|td-&gt;char_data.devfs_nonrewinding
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;char_data.devfs_rewinding
)paren
id|devfs_unregister
c_func
(paren
id|td-&gt;char_data.devfs_rewinding
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;char_data.devfs_char_dir
)paren
id|devfs_unregister
c_func
(paren
id|td-&gt;char_data.devfs_char_dir
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*******************************************************************&n; * TAPECHAR Setup Functions&n; *******************************************************************/
multiline_comment|/*&n; * This function is called for every new tapedevice&n; */
r_void
DECL|function|tapechar_setup
id|tapechar_setup
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
macro_line|#ifdef CONFIG_DEVFS_FS
id|tapechar_mkdevfstree
c_func
(paren
id|td
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Tapechar init Function&n; */
r_void
DECL|function|tapechar_init
id|tapechar_init
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|tape_frontend_t
op_star
id|charfront
comma
op_star
id|temp
suffix:semicolon
id|tape_dev_t
op_star
id|td
suffix:semicolon
id|tape_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Register the tape major number to the kernel */
macro_line|#ifdef CONFIG_DEVFS_FS
id|result
op_assign
id|devfs_register_chrdev
(paren
id|tapechar_major
comma
l_string|&quot;tape&quot;
comma
op_amp
id|tape_fops
)paren
suffix:semicolon
macro_line|#else
id|result
op_assign
id|register_chrdev
(paren
id|tapechar_major
comma
l_string|&quot;tape&quot;
comma
op_amp
id|tape_fops
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|PRINT_WARN
(paren
id|KERN_ERR
l_string|&quot;tape: can&squot;t get major %d&bslash;n&quot;
comma
id|tapechar_major
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;c:initfail&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tapechar_major
op_eq
l_int|0
)paren
id|tapechar_major
op_assign
id|result
suffix:semicolon
multiline_comment|/* accept dynamic major number */
id|PRINT_WARN
(paren
id|KERN_ERR
l_string|&quot; tape gets major %d for character device&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
id|charfront
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|tape_frontend_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|charfront
op_eq
l_int|NULL
)paren
(brace
id|PRINT_WARN
(paren
id|KERN_ERR
l_string|&quot;tapechar: cannot alloc memory for the frontend_t structure&bslash;n&quot;
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;c:initfail no mem&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|charfront-&gt;device_setup
op_assign
(paren
id|tape_setup_device_t
)paren
id|tapechar_setup
suffix:semicolon
macro_line|#ifdef CONFIG_DEVFS_FS
id|charfront-&gt;mkdevfstree
op_assign
id|tapechar_mkdevfstree
suffix:semicolon
id|charfront-&gt;rmdevfstree
op_assign
id|tapechar_rmdevfstree
suffix:semicolon
macro_line|#endif
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;c:init ok&bslash;n&quot;
)paren
suffix:semicolon
id|charfront-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tape_first_front
op_eq
l_int|NULL
)paren
(brace
id|tape_first_front
op_assign
id|charfront
suffix:semicolon
)brace
r_else
(brace
id|temp
op_assign
id|tape_first_front
suffix:semicolon
r_while
c_loop
(paren
id|temp-&gt;next
op_ne
l_int|NULL
)paren
id|temp
op_assign
id|temp-&gt;next
suffix:semicolon
id|temp-&gt;next
op_assign
id|charfront
suffix:semicolon
)brace
id|td
op_assign
id|tape_first_dev
suffix:semicolon
r_while
c_loop
(paren
id|td
op_ne
l_int|NULL
)paren
(brace
id|tapechar_setup
c_func
(paren
id|td
)paren
suffix:semicolon
id|td
op_assign
id|td-&gt;next
suffix:semicolon
)brace
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * cleanup&n; */
r_void
DECL|function|tapechar_uninit
id|tapechar_uninit
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_DEVFS_FS
id|devfs_unregister_chrdev
(paren
id|tapechar_major
comma
l_string|&quot;tape&quot;
)paren
suffix:semicolon
macro_line|#else
id|unregister_chrdev
(paren
id|tapechar_major
comma
l_string|&quot;tape&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*******************************************************************&n; * TAPECHAR Util functions&n; *******************************************************************/
multiline_comment|/*&n; * Terminate write command (we write two TMs and skip backward over last)&n; * This ensures that the tape is always correctly terminated.&n; * When the user writes afterwards a new file, he will overwrite the&n; * second TM and therefore one TM will remain to seperate the &n; * two files on the tape...&n; */
r_static
r_void
DECL|function|tapechar_terminate_write
id|tapechar_terminate_write
c_func
(paren
id|tape_dev_t
op_star
id|td
)paren
(brace
id|tape_ccw_req_t
op_star
id|treq
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|treq
op_assign
id|td-&gt;discipline
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|td
comma
id|MTWEOF
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
r_goto
id|out
suffix:semicolon
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
id|treq
op_assign
id|td-&gt;discipline
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|td
comma
id|MTWEOF
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
r_goto
id|out
suffix:semicolon
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
id|treq
op_assign
id|td-&gt;discipline
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|td
comma
id|MTBSR
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
r_goto
id|out
suffix:semicolon
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/*******************************************************************&n; * TAPECHAR Functions:&n; * - read&n; * - write&n; * - open&n; * - close&n; * - ioctl&n; *******************************************************************/
multiline_comment|/*&n; * Tape device read function&n; */
id|ssize_t
DECL|function|tapechar_read
id|tapechar_read
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
op_star
id|data
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|tape_dev_t
op_star
id|td
suffix:semicolon
r_int
id|block_size
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|cpysize
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:read&bslash;n&quot;
)paren
suffix:semicolon
id|td
op_assign
(paren
id|tape_dev_t
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|filp-&gt;f_pos
)paren
(brace
multiline_comment|/* &quot;A request was outside the capabilities of the device.&quot; */
multiline_comment|/* This check uses internal knowledge about how pread and */
multiline_comment|/* read work... */
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:ppos wrong&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EOVERFLOW
suffix:semicolon
multiline_comment|/* errno=75 Value too large for def. data type */
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|td-&gt;char_data.block_size
op_eq
l_int|0
)paren
(brace
id|block_size
op_assign
id|count
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|count
OL
id|td-&gt;char_data.block_size
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|// invalid argument+
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;tapechar:read smaller than block size was requested&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|block_size
op_assign
id|td-&gt;char_data.block_size
suffix:semicolon
)brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:nbytes: %x&bslash;n&quot;
comma
id|block_size
)paren
suffix:semicolon
id|treq
op_assign
id|td-&gt;discipline-&gt;read_block
(paren
id|data
comma
id|block_size
comma
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
(brace
id|rc
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|TAPE_MERGE_RC
c_func
(paren
id|treq
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
r_goto
id|out_free
suffix:semicolon
)brace
id|rc
op_assign
id|cpysize
op_assign
id|block_size
op_minus
id|td-&gt;devstat.rescnt
suffix:semicolon
r_if
c_cond
(paren
id|idalbuf_copy_to_user
c_func
(paren
id|treq-&gt;userbuf
comma
id|treq-&gt;idal_buf
comma
id|cpysize
)paren
)paren
(brace
id|tape_sprintf_exception
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;xfrb segf.&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:rbytes:  %x&bslash;n&quot;
comma
id|cpysize
)paren
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|cpysize
suffix:semicolon
id|out_free
suffix:colon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device write function&n; */
id|ssize_t
DECL|function|tapechar_write
id|tapechar_write
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|tape_dev_t
op_star
id|td
suffix:semicolon
r_int
id|block_size
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
suffix:semicolon
r_int
id|nblocks
comma
id|i
op_assign
l_int|0
comma
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|written
op_assign
l_int|0
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:write&bslash;n&quot;
)paren
suffix:semicolon
id|td
op_assign
(paren
id|tape_dev_t
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
id|block_size
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|filp-&gt;f_pos
)paren
(brace
multiline_comment|/* &quot;A request was outside the capabilities of the device.&quot; */
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:ppos wrong&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EOVERFLOW
suffix:semicolon
multiline_comment|/* errno=75 Value too large for def. data type */
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|td-&gt;char_data.block_size
op_ne
l_int|0
)paren
op_logical_and
(paren
id|count
OL
id|td-&gt;char_data.block_size
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|td-&gt;char_data.block_size
op_eq
l_int|0
)paren
(brace
id|block_size
op_assign
id|count
suffix:semicolon
id|nblocks
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|block_size
op_assign
id|td-&gt;char_data.block_size
suffix:semicolon
id|nblocks
op_assign
id|count
op_div
id|block_size
suffix:semicolon
)brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:nbytes: %x&bslash;n&quot;
comma
id|block_size
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:nblocks: %x&bslash;n&quot;
comma
id|nblocks
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nblocks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|treq
op_assign
id|td-&gt;discipline-&gt;write_block
(paren
id|data
op_plus
id|i
op_star
id|block_size
comma
id|block_size
comma
id|td
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
(brace
id|rc
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|TAPE_MERGE_RC
c_func
(paren
id|treq
comma
id|rc
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:wbytes: %x&bslash;n&quot;
comma
id|block_size
op_minus
id|td-&gt;devstat.rescnt
)paren
suffix:semicolon
id|filp-&gt;f_pos
op_add_assign
id|block_size
op_minus
id|td-&gt;devstat.rescnt
suffix:semicolon
id|written
op_add_assign
id|block_size
op_minus
id|td-&gt;devstat.rescnt
suffix:semicolon
id|rc
op_assign
id|written
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;devstat.rescnt
OG
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:wtotal: %x&bslash;n&quot;
comma
id|written
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ENOSPC
)paren
(brace
r_if
c_cond
(paren
id|td-&gt;discipline-&gt;process_eov
)paren
(brace
id|td-&gt;discipline
op_member_access_from_pointer
id|process_eov
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
OG
l_int|0
)paren
(brace
id|rc
op_assign
id|i
op_star
id|block_size
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;write rc = %i&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
multiline_comment|/* XXX */
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * MT IOCTLS&n; */
r_static
r_int
DECL|function|tapechar_mtioctop
id|tapechar_mtioctop
(paren
r_struct
id|file
op_star
id|filp
comma
r_int
id|mt_op
comma
r_int
id|mt_count
)paren
(brace
id|tape_dev_t
op_star
id|td
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|td
op_assign
(paren
id|tape_dev_t
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:mtio&bslash;n&quot;
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:ioop: %x&bslash;n&quot;
comma
id|mt_op
)paren
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:arg:  %x&bslash;n&quot;
comma
id|mt_count
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mt_op
)paren
(brace
r_case
id|MTRETEN
suffix:colon
singleline_comment|// retension the tape
id|treq
op_assign
id|td-&gt;discipline-&gt;ioctl
(paren
id|td
comma
id|MTEOM
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTLOAD
suffix:colon
id|treq
op_assign
id|td-&gt;discipline-&gt;ioctl
(paren
id|td
comma
id|MTLOAD
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
op_minus
id|EINVAL
)paren
(brace
singleline_comment|// the backend driver has an load function
r_break
suffix:semicolon
)brace
singleline_comment|// if no medium is in, wait until it gets inserted
r_if
c_cond
(paren
id|td-&gt;medium_state
op_ne
id|MS_LOADED
)paren
(brace
singleline_comment|// create dummy request
id|treq
op_assign
id|tape_alloc_ccw_req
c_func
(paren
l_int|1
comma
l_int|0
comma
l_int|0
comma
id|TO_LOAD
)paren
suffix:semicolon
id|rc
op_assign
id|tape_do_wait_req
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT_INTERRUPTIBLE_NOHALTIO
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|// already loaded
)brace
r_goto
id|out
suffix:semicolon
r_case
id|MTSETBLK
suffix:colon
id|td-&gt;char_data.block_size
op_assign
id|mt_count
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:setblk:&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|MTRESET
suffix:colon
id|td-&gt;char_data.block_size
op_assign
l_int|0
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:devreset:&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
id|treq
op_assign
id|td-&gt;discipline-&gt;ioctl
(paren
id|td
comma
id|mt_op
comma
id|mt_count
comma
op_amp
id|rc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|treq
op_eq
l_int|NULL
)paren
(brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:ccwg fail&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|TAPE_INTERRUPTIBLE_OP
c_func
(paren
id|mt_op
)paren
)paren
(brace
id|rc
op_assign
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT_INTERRUPTIBLE
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
)brace
id|TAPE_MERGE_RC
c_func
(paren
id|treq
comma
id|rc
)paren
suffix:semicolon
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mt_op
op_eq
id|MTEOM
)paren
op_logical_or
(paren
id|mt_op
op_eq
id|MTRETEN
)paren
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
singleline_comment|// EOM and RETEN report an error, this is fine...
)brace
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* IO Failed */
singleline_comment|// if medium was unloaded, update the corresponding variable.
r_switch
c_cond
(paren
id|mt_op
)paren
(brace
r_case
id|MTOFFL
suffix:colon
r_case
id|MTUNLOAD
suffix:colon
id|td-&gt;medium_state
op_assign
id|MS_UNLOADED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTRETEN
suffix:colon
singleline_comment|//need to rewind the tape after moving to eom
r_return
id|tapechar_mtioctop
(paren
id|filp
comma
id|MTREW
comma
l_int|1
)paren
suffix:semicolon
r_case
id|MTFSFM
suffix:colon
singleline_comment|//need to skip back over the filemark
r_return
id|tapechar_mtioctop
(paren
id|filp
comma
id|MTBSFM
comma
l_int|1
)paren
suffix:semicolon
r_case
id|MTBSF
suffix:colon
singleline_comment|//need to skip forward over the filemark
r_return
id|tapechar_mtioctop
(paren
id|filp
comma
id|MTFSF
comma
l_int|1
)paren
suffix:semicolon
)brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:mtio done&bslash;n&quot;
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device io controls.&n; */
r_int
DECL|function|tapechar_ioctl
id|tapechar_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|tape_dev_t
op_star
id|td
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mtop
id|op
suffix:semicolon
multiline_comment|/* structure for MTIOCTOP */
r_struct
id|mtpos
id|pos
suffix:semicolon
multiline_comment|/* structure for MTIOCPOS */
r_struct
id|mtget
id|get
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:ioct&bslash;n&quot;
)paren
suffix:semicolon
id|td
op_assign
(paren
id|tape_dev_t
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
singleline_comment|// check for discipline ioctl overloading
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|td-&gt;discipline-&gt;discipline_ioctl_overload
(paren
id|td
comma
id|cmd
comma
id|arg
)paren
)paren
op_ne
op_minus
id|EINVAL
)paren
(brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:ioverloa&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MTIOCTOP
suffix:colon
multiline_comment|/* tape op command */
r_if
c_cond
(paren
id|copy_from_user
(paren
op_amp
id|op
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtop
)paren
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|op.mt_count
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|op.mt_op
op_eq
id|MTBSR
op_logical_or
id|op.mt_op
op_eq
id|MTFSR
op_logical_or
id|op.mt_op
op_eq
id|MTFSF
op_logical_or
id|op.mt_op
op_eq
id|MTBSR
op_logical_or
id|op.mt_op
op_eq
id|MTFSFM
op_logical_or
id|op.mt_op
op_eq
id|MTBSFM
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* We assume that the backends can handle count up */
multiline_comment|/* to 500. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|op.mt_count
suffix:semicolon
id|i
op_add_assign
l_int|500
)paren
(brace
id|rc
op_assign
id|tapechar_mtioctop
(paren
id|filp
comma
id|op.mt_op
comma
id|MIN
c_func
(paren
l_int|500
comma
id|op.mt_count
op_minus
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Single operations */
id|rc
op_assign
id|tapechar_mtioctop
(paren
id|filp
comma
id|op.mt_op
comma
id|op.mt_count
)paren
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
r_case
id|MTIOCPOS
suffix:colon
multiline_comment|/* query tape position */
id|memset
(paren
op_amp
id|pos
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
suffix:semicolon
id|treq
op_assign
id|td-&gt;discipline-&gt;ioctl
(paren
id|td
comma
id|MTTELL
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|TAPE_MERGE_RC
c_func
(paren
id|treq
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|pos.mt_blkno
op_assign
op_star
(paren
(paren
r_int
op_star
)paren
(paren
id|treq-&gt;kernbuf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|pos
comma
r_sizeof
(paren
r_struct
id|mtpos
)paren
)paren
)paren
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|MTIOCGET
suffix:colon
id|memset
(paren
op_amp
id|get
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
suffix:semicolon
id|treq
op_assign
id|td-&gt;discipline-&gt;ioctl
(paren
id|td
comma
id|MTTELL
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|treq
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|TAPE_MERGE_RC
c_func
(paren
id|treq
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|get.mt_erreg
op_assign
id|treq-&gt;rc
suffix:semicolon
id|get.mt_blkno
op_assign
op_star
(paren
(paren
r_int
op_star
)paren
(paren
id|treq-&gt;kernbuf
)paren
)paren
suffix:semicolon
id|get.mt_type
op_assign
id|MT_ISUNKNOWN
suffix:semicolon
id|get.mt_resid
op_assign
id|td-&gt;devstat.rescnt
suffix:semicolon
id|get.mt_dsreg
op_assign
id|td-&gt;tape_state
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|get
comma
r_sizeof
(paren
r_struct
id|mtget
)paren
)paren
)paren
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
id|tape_free_ccw_req
c_func
(paren
id|treq
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|3
comma
l_string|&quot;c:ioct inv&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device open function.&n; */
r_int
DECL|function|tapechar_open
id|tapechar_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|tape_dev_t
op_star
id|td
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|lockflags
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:open: %x&bslash;n&quot;
comma
id|td-&gt;first_minor
)paren
suffix:semicolon
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|td
op_assign
id|tape_get_device_by_minor
c_func
(paren
id|minor
(paren
id|inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|s390irq_spin_lock_irqsave
c_func
(paren
id|td-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tape_state_get
c_func
(paren
id|td
)paren
op_eq
id|TS_NOT_OPER
)paren
(brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:nodev&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tape_state_get
(paren
id|td
)paren
op_ne
id|TS_UNUSED
)paren
(brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:dbusy&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|td-&gt;discipline-&gt;owner
)paren
id|__MOD_INC_USE_COUNT
c_func
(paren
id|td-&gt;discipline-&gt;owner
)paren
suffix:semicolon
id|tape_state_set
(paren
id|td
comma
id|TS_IN_USE
)paren
suffix:semicolon
id|td-&gt;filp
op_assign
id|filp
suffix:semicolon
multiline_comment|/* save for later reference     */
id|filp-&gt;private_data
op_assign
id|td
suffix:semicolon
multiline_comment|/* save the dev.info for later reference */
id|out
suffix:colon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|td-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|td
op_ne
l_int|NULL
)paren
id|tape_put_device
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Tape device release function.&n; */
r_int
DECL|function|tapechar_release
id|tapechar_release
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|tape_dev_t
op_star
id|td
op_assign
l_int|NULL
suffix:semicolon
id|tape_ccw_req_t
op_star
id|treq
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|lockflags
suffix:semicolon
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:release: %x&bslash;n&quot;
comma
id|td-&gt;first_minor
)paren
suffix:semicolon
id|td
op_assign
(paren
id|tape_dev_t
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;last_op
op_eq
id|TO_WRI
)paren
(brace
id|tapechar_terminate_write
c_func
(paren
id|td
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|minor
(paren
id|inode-&gt;i_rdev
)paren
op_eq
id|TAPECHAR_REW_MINOR
c_func
(paren
id|td-&gt;first_minor
)paren
)paren
(brace
id|treq
op_assign
id|td-&gt;discipline-&gt;ioctl
(paren
id|td
comma
id|MTREW
comma
l_int|1
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|treq
op_ne
l_int|NULL
)paren
(brace
id|tape_sprintf_event
(paren
id|tape_dbf_area
comma
l_int|6
comma
l_string|&quot;c:rewrelea&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|tape_do_io_and_wait
c_func
(paren
id|td
comma
id|treq
comma
id|TAPE_WAIT
)paren
suffix:semicolon
id|tape_free_ccw_req
(paren
id|treq
)paren
suffix:semicolon
)brace
)brace
id|s390irq_spin_lock_irqsave
c_func
(paren
id|td-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tape_state_get
c_func
(paren
id|td
)paren
op_eq
id|TS_IN_USE
)paren
(brace
id|tape_state_set
(paren
id|td
comma
id|TS_UNUSED
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tape_state_get
c_func
(paren
id|td
)paren
op_ne
id|TS_NOT_OPER
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|s390irq_spin_unlock_irqrestore
c_func
(paren
id|td-&gt;devinfo.irq
comma
id|lockflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|td-&gt;discipline-&gt;owner
)paren
id|__MOD_DEC_USE_COUNT
c_func
(paren
id|td-&gt;discipline-&gt;owner
)paren
suffix:semicolon
id|tape_put_device
c_func
(paren
id|td
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
