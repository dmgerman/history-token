multiline_comment|/*&n; *  drivers/s390/char/raw3270.c&n; *    IBM/3270 Driver - core functions.&n; *&n; *  Author(s):&n; *    Original 3270 Code for 2.4 written by Richard Hitt (UTS Global)&n; *    Rewritten for 2.5 by Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; *&t;-- Copyright (C) 2003 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/cio.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &quot;raw3270.h&quot;
multiline_comment|/* The main 3270 data structure. */
DECL|struct|raw3270
r_struct
id|raw3270
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|cdev
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
DECL|member|minor
r_int
id|minor
suffix:semicolon
DECL|member|model
DECL|member|rows
DECL|member|cols
r_int
id|model
comma
id|rows
comma
id|cols
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|member|req_queue
r_struct
id|list_head
id|req_queue
suffix:semicolon
multiline_comment|/* Request queue. */
DECL|member|view_list
r_struct
id|list_head
id|view_list
suffix:semicolon
multiline_comment|/* List of available views. */
DECL|member|view
r_struct
id|raw3270_view
op_star
id|view
suffix:semicolon
multiline_comment|/* Active view. */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Device timer. */
DECL|member|ascebc
r_int
r_char
op_star
id|ascebc
suffix:semicolon
multiline_comment|/* ascii -&gt; ebcdic table */
)brace
suffix:semicolon
multiline_comment|/* raw3270-&gt;flags */
DECL|macro|RAW3270_FLAGS_14BITADDR
mdefine_line|#define RAW3270_FLAGS_14BITADDR&t;0&t;/* 14-bit buffer addresses */
DECL|macro|RAW3270_FLAGS_BUSY
mdefine_line|#define RAW3270_FLAGS_BUSY&t;1&t;/* Device busy, leave it alone */
DECL|macro|RAW3270_FLAGS_ATTN
mdefine_line|#define RAW3270_FLAGS_ATTN&t;2&t;/* Device sent an ATTN interrupt */
DECL|macro|RAW3270_FLAGS_READY
mdefine_line|#define RAW3270_FLAGS_READY&t;4&t;/* Device is useable by views */
DECL|macro|RAW3270_FLAGS_CONSOLE
mdefine_line|#define RAW3270_FLAGS_CONSOLE&t;8&t;/* Device is the console. */
multiline_comment|/* Semaphore to protect global data of raw3270 (devices, views, etc). */
r_static
id|DECLARE_MUTEX
c_func
(paren
id|raw3270_sem
)paren
suffix:semicolon
multiline_comment|/* List of 3270 devices. */
DECL|variable|raw3270_devices
r_static
r_struct
id|list_head
id|raw3270_devices
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|raw3270_devices
)paren
suffix:semicolon
multiline_comment|/*&n; * Flag to indicate if the driver has been registered. Some operations&n; * like waiting for the end of i/o need to be done differently as long&n; * as the kernel is still starting up (console support).&n; */
DECL|variable|raw3270_registered
r_static
r_int
id|raw3270_registered
suffix:semicolon
multiline_comment|/* Module parameters */
DECL|variable|tubxcorrect
r_static
r_int
id|tubxcorrect
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|tubxcorrect
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n; * Wait queue for device init/delete, view delete.&n; */
DECL|variable|raw3270_wait_queue
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|raw3270_wait_queue
)paren
suffix:semicolon
multiline_comment|/*&n; * Encode array for 12 bit 3270 addresses.&n; */
DECL|variable|raw3270_ebcgraf
r_int
r_char
id|raw3270_ebcgraf
(braket
l_int|64
)braket
op_assign
(brace
l_int|0x40
comma
l_int|0xc1
comma
l_int|0xc2
comma
l_int|0xc3
comma
l_int|0xc4
comma
l_int|0xc5
comma
l_int|0xc6
comma
l_int|0xc7
comma
l_int|0xc8
comma
l_int|0xc9
comma
l_int|0x4a
comma
l_int|0x4b
comma
l_int|0x4c
comma
l_int|0x4d
comma
l_int|0x4e
comma
l_int|0x4f
comma
l_int|0x50
comma
l_int|0xd1
comma
l_int|0xd2
comma
l_int|0xd3
comma
l_int|0xd4
comma
l_int|0xd5
comma
l_int|0xd6
comma
l_int|0xd7
comma
l_int|0xd8
comma
l_int|0xd9
comma
l_int|0x5a
comma
l_int|0x5b
comma
l_int|0x5c
comma
l_int|0x5d
comma
l_int|0x5e
comma
l_int|0x5f
comma
l_int|0x60
comma
l_int|0x61
comma
l_int|0xe2
comma
l_int|0xe3
comma
l_int|0xe4
comma
l_int|0xe5
comma
l_int|0xe6
comma
l_int|0xe7
comma
l_int|0xe8
comma
l_int|0xe9
comma
l_int|0x6a
comma
l_int|0x6b
comma
l_int|0x6c
comma
l_int|0x6d
comma
l_int|0x6e
comma
l_int|0x6f
comma
l_int|0xf0
comma
l_int|0xf1
comma
l_int|0xf2
comma
l_int|0xf3
comma
l_int|0xf4
comma
l_int|0xf5
comma
l_int|0xf6
comma
l_int|0xf7
comma
l_int|0xf8
comma
l_int|0xf9
comma
l_int|0x7a
comma
l_int|0x7b
comma
l_int|0x7c
comma
l_int|0x7d
comma
l_int|0x7e
comma
l_int|0x7f
)brace
suffix:semicolon
r_void
DECL|function|raw3270_buffer_address
id|raw3270_buffer_address
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
comma
r_char
op_star
id|cp
comma
r_int
r_int
id|addr
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_14BITADDR
comma
op_amp
id|rp-&gt;flags
)paren
)paren
(brace
id|cp
(braket
l_int|0
)braket
op_assign
(paren
id|addr
op_rshift
l_int|8
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|cp
(braket
l_int|1
)braket
op_assign
id|addr
op_amp
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
id|cp
(braket
l_int|0
)braket
op_assign
id|raw3270_ebcgraf
(braket
(paren
id|addr
op_rshift
l_int|6
)paren
op_amp
l_int|0x3f
)braket
suffix:semicolon
id|cp
(braket
l_int|1
)braket
op_assign
id|raw3270_ebcgraf
(braket
id|addr
op_amp
l_int|0x3f
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Allocate a new 3270 ccw request&n; */
r_struct
id|raw3270_request
op_star
DECL|function|raw3270_request_alloc
id|raw3270_request_alloc
c_func
(paren
r_int
id|size
)paren
(brace
r_struct
id|raw3270_request
op_star
id|rq
suffix:semicolon
multiline_comment|/* Allocate request structure */
id|rq
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|raw3270_request
)paren
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|rq
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|raw3270_request
)paren
)paren
suffix:semicolon
multiline_comment|/* alloc output buffer. */
r_if
c_cond
(paren
id|size
OG
l_int|0
)paren
(brace
id|rq-&gt;buffer
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq-&gt;buffer
)paren
(brace
id|kfree
c_func
(paren
id|rq
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
)brace
id|rq-&gt;size
op_assign
id|size
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|rq-&gt;list
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup ccw.&n;&t; */
id|rq-&gt;ccw.cda
op_assign
id|__pa
c_func
(paren
id|rq-&gt;buffer
)paren
suffix:semicolon
id|rq-&gt;ccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
r_return
id|rq
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_TN3270_CONSOLE
multiline_comment|/*&n; * Allocate a new 3270 ccw request from bootmem. Only works very&n; * early in the boot process. Only con3270.c should be using this.&n; */
r_struct
id|raw3270_request
op_star
DECL|function|raw3270_request_alloc_bootmem
id|raw3270_request_alloc_bootmem
c_func
(paren
r_int
id|size
)paren
(brace
r_struct
id|raw3270_request
op_star
id|rq
suffix:semicolon
id|rq
op_assign
id|alloc_bootmem_low
c_func
(paren
r_sizeof
(paren
r_struct
id|raw3270
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|rq
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|raw3270_request
)paren
)paren
suffix:semicolon
multiline_comment|/* alloc output buffer. */
r_if
c_cond
(paren
id|size
OG
l_int|0
)paren
(brace
id|rq-&gt;buffer
op_assign
id|alloc_bootmem_low
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq-&gt;buffer
)paren
(brace
id|free_bootmem
c_func
(paren
(paren
r_int
r_int
)paren
id|rq
comma
r_sizeof
(paren
r_struct
id|raw3270
)paren
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
)brace
id|rq-&gt;size
op_assign
id|size
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|rq-&gt;list
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup ccw.&n;&t; */
id|rq-&gt;ccw.cda
op_assign
id|__pa
c_func
(paren
id|rq-&gt;buffer
)paren
suffix:semicolon
id|rq-&gt;ccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
r_return
id|rq
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Free 3270 ccw request&n; */
r_void
DECL|function|raw3270_request_free
id|raw3270_request_free
(paren
r_struct
id|raw3270_request
op_star
id|rq
)paren
(brace
r_if
c_cond
(paren
id|rq-&gt;buffer
)paren
id|kfree
c_func
(paren
id|rq-&gt;buffer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Reset request to initial state.&n; */
r_void
DECL|function|raw3270_request_reset
id|raw3270_request_reset
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
)paren
(brace
id|BUG_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|rq-&gt;list
)paren
)paren
suffix:semicolon
id|rq-&gt;ccw.cmd_code
op_assign
l_int|0
suffix:semicolon
id|rq-&gt;ccw.count
op_assign
l_int|0
suffix:semicolon
id|rq-&gt;ccw.cda
op_assign
id|__pa
c_func
(paren
id|rq-&gt;buffer
)paren
suffix:semicolon
id|rq-&gt;ccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|rq-&gt;rescnt
op_assign
l_int|0
suffix:semicolon
id|rq-&gt;rc
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Set command code to ccw of a request.&n; */
r_void
DECL|function|raw3270_request_set_cmd
id|raw3270_request_set_cmd
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
id|u8
id|cmd
)paren
(brace
id|rq-&gt;ccw.cmd_code
op_assign
id|cmd
suffix:semicolon
)brace
multiline_comment|/*&n; * Add data fragment to output buffer.&n; */
r_int
DECL|function|raw3270_request_add_data
id|raw3270_request_add_data
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
r_void
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_if
c_cond
(paren
id|size
op_plus
id|rq-&gt;ccw.count
OG
id|rq-&gt;size
)paren
r_return
op_minus
id|E2BIG
suffix:semicolon
id|memcpy
c_func
(paren
id|rq-&gt;buffer
op_plus
id|rq-&gt;ccw.count
comma
id|data
comma
id|size
)paren
suffix:semicolon
id|rq-&gt;ccw.count
op_add_assign
id|size
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Set address/length pair to ccw of a request.&n; */
r_void
DECL|function|raw3270_request_set_data
id|raw3270_request_set_data
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
r_void
op_star
id|data
comma
r_int
id|size
)paren
(brace
id|rq-&gt;ccw.cda
op_assign
id|__pa
c_func
(paren
id|data
)paren
suffix:semicolon
id|rq-&gt;ccw.count
op_assign
id|size
suffix:semicolon
)brace
multiline_comment|/*&n; * Set idal buffer to ccw of a request.&n; */
r_void
DECL|function|raw3270_request_set_idal
id|raw3270_request_set_idal
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
r_struct
id|idal_buffer
op_star
id|ib
)paren
(brace
id|rq-&gt;ccw.cda
op_assign
id|__pa
c_func
(paren
id|ib-&gt;data
)paren
suffix:semicolon
id|rq-&gt;ccw.count
op_assign
id|ib-&gt;size
suffix:semicolon
id|rq-&gt;ccw.flags
op_or_assign
id|CCW_FLAG_IDA
suffix:semicolon
)brace
multiline_comment|/*&n; * Stop running ccw.&n; */
r_static
r_int
DECL|function|raw3270_halt_io_nolock
id|raw3270_halt_io_nolock
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
comma
r_struct
id|raw3270_request
op_star
id|rq
)paren
(brace
r_int
id|retries
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|raw3270_request_final
c_func
(paren
id|rq
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Check if interrupt has already been processed */
r_for
c_loop
(paren
id|retries
op_assign
l_int|0
suffix:semicolon
id|retries
OL
l_int|5
suffix:semicolon
id|retries
op_increment
)paren
(brace
r_if
c_cond
(paren
id|retries
OL
l_int|2
)paren
id|rc
op_assign
id|ccw_device_halt
c_func
(paren
id|rp-&gt;cdev
comma
(paren
r_int
)paren
id|rq
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|ccw_device_clear
c_func
(paren
id|rp-&gt;cdev
comma
(paren
r_int
)paren
id|rq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* termination successful */
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|raw3270_halt_io
id|raw3270_halt_io
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
comma
r_struct
id|raw3270_request
op_star
id|rq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|raw3270_halt_io_nolock
c_func
(paren
id|rp
comma
id|rq
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Add the request to the request queue, try to start it if the&n; * 3270 device is idle. Return without waiting for end of i/o.&n; */
r_static
r_int
DECL|function|__raw3270_start
id|__raw3270_start
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
comma
r_struct
id|raw3270_view
op_star
id|view
comma
r_struct
id|raw3270_request
op_star
id|rq
)paren
(brace
id|rq-&gt;view
op_assign
id|view
suffix:semicolon
id|raw3270_get_view
c_func
(paren
id|view
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|rp-&gt;req_queue
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_BUSY
comma
op_amp
id|rp-&gt;flags
)paren
)paren
(brace
multiline_comment|/* No other requests are on the queue. Start this one. */
id|rq-&gt;rc
op_assign
id|ccw_device_start
c_func
(paren
id|rp-&gt;cdev
comma
op_amp
id|rq-&gt;ccw
comma
(paren
r_int
r_int
)paren
id|rq
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;rc
)paren
(brace
id|raw3270_put_view
c_func
(paren
id|view
)paren
suffix:semicolon
r_return
id|rq-&gt;rc
suffix:semicolon
)brace
)brace
id|list_add_tail
c_func
(paren
op_amp
id|rq-&gt;list
comma
op_amp
id|rp-&gt;req_queue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|raw3270_start
id|raw3270_start
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
comma
r_struct
id|raw3270_request
op_star
id|rq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|view-&gt;dev-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|rp
op_assign
id|view-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rp
op_logical_or
id|rp-&gt;view
op_ne
id|view
)paren
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
)paren
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_else
id|rc
op_assign
id|__raw3270_start
c_func
(paren
id|rp
comma
id|view
comma
id|rq
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|view-&gt;dev-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|raw3270_start_irq
id|raw3270_start_irq
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
comma
r_struct
id|raw3270_request
op_star
id|rq
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
id|rp
op_assign
id|view-&gt;dev
suffix:semicolon
id|rq-&gt;view
op_assign
id|view
suffix:semicolon
id|raw3270_get_view
c_func
(paren
id|view
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|rq-&gt;list
comma
op_amp
id|rp-&gt;req_queue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * 3270 interrupt routine, called from the ccw_device layer&n; */
r_static
r_void
DECL|function|raw3270_irq
id|raw3270_irq
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_int
r_int
id|intparm
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_struct
id|raw3270_view
op_star
id|view
suffix:semicolon
r_struct
id|raw3270_request
op_star
id|rq
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rp
op_assign
(paren
r_struct
id|raw3270
op_star
)paren
id|cdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rp
)paren
r_return
suffix:semicolon
id|rq
op_assign
(paren
r_struct
id|raw3270_request
op_star
)paren
id|intparm
suffix:semicolon
id|view
op_assign
id|rq
ques
c_cond
id|rq-&gt;view
suffix:colon
id|rp-&gt;view
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|irb
)paren
)paren
id|rc
op_assign
id|RAW3270_IO_RETRY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_eq
(paren
id|DEV_STAT_CHN_END
op_or
id|DEV_STAT_DEV_END
op_or
id|DEV_STAT_UNIT_EXCEP
)paren
)paren
(brace
multiline_comment|/* Handle CE-DE-UE and subsequent UDE */
id|set_bit
c_func
(paren
id|RAW3270_FLAGS_BUSY
comma
op_amp
id|rp-&gt;flags
)paren
suffix:semicolon
id|rc
op_assign
id|RAW3270_IO_BUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_BUSY
comma
op_amp
id|rp-&gt;flags
)paren
)paren
(brace
multiline_comment|/* Wait for UDE if busy flag is set. */
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_DEV_END
)paren
(brace
id|clear_bit
c_func
(paren
id|RAW3270_FLAGS_BUSY
comma
op_amp
id|rp-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* Got it, now retry. */
id|rc
op_assign
id|RAW3270_IO_RETRY
suffix:semicolon
)brace
r_else
id|rc
op_assign
id|RAW3270_IO_BUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|view
)paren
id|rc
op_assign
id|view-&gt;fn
op_member_access_from_pointer
id|intv
c_func
(paren
id|view
comma
id|rq
comma
id|irb
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|RAW3270_IO_DONE
suffix:semicolon
r_switch
c_cond
(paren
id|rc
)paren
(brace
r_case
id|RAW3270_IO_DONE
suffix:colon
r_break
suffix:semicolon
r_case
id|RAW3270_IO_BUSY
suffix:colon
multiline_comment|/* &n;&t;&t; * Intervention required by the operator. We have to wait&n;&t;&t; * for unsolicited device end.&n;&t;&t; */
r_return
suffix:semicolon
r_case
id|RAW3270_IO_RETRY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|rq
)paren
r_break
suffix:semicolon
id|rq-&gt;rc
op_assign
id|ccw_device_start
c_func
(paren
id|rp-&gt;cdev
comma
op_amp
id|rq-&gt;ccw
comma
(paren
r_int
r_int
)paren
id|rq
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;rc
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* Sucessfully restarted. */
r_break
suffix:semicolon
r_case
id|RAW3270_IO_STOP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|rq
)paren
r_break
suffix:semicolon
id|raw3270_halt_io_nolock
c_func
(paren
id|rp
comma
id|rq
)paren
suffix:semicolon
id|rq-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rq
)paren
(brace
id|BUG_ON
c_func
(paren
id|list_empty
c_func
(paren
op_amp
id|rq-&gt;list
)paren
)paren
suffix:semicolon
multiline_comment|/* The request completed, remove from queue and do callback. */
id|list_del_init
c_func
(paren
op_amp
id|rq-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;callback
)paren
id|rq
op_member_access_from_pointer
id|callback
c_func
(paren
id|rq
comma
id|rq-&gt;callback_data
)paren
suffix:semicolon
multiline_comment|/* Do put_device for get_device in raw3270_start. */
id|raw3270_put_view
c_func
(paren
id|view
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Try to start each request on request queue until one is&n;&t; * started successful.&n;&t; */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|rp-&gt;req_queue
)paren
)paren
(brace
id|rq
op_assign
id|list_entry
c_func
(paren
id|rp-&gt;req_queue.next
comma
r_struct
id|raw3270_request
comma
id|list
)paren
suffix:semicolon
id|rq-&gt;rc
op_assign
id|ccw_device_start
c_func
(paren
id|rp-&gt;cdev
comma
op_amp
id|rq-&gt;ccw
comma
(paren
r_int
r_int
)paren
id|rq
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;rc
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* Start failed. Remove request and do callback. */
id|list_del_init
c_func
(paren
op_amp
id|rq-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;callback
)paren
id|rq
op_member_access_from_pointer
id|callback
c_func
(paren
id|rq
comma
id|rq-&gt;callback_data
)paren
suffix:semicolon
multiline_comment|/* Do put_device for get_device in raw3270_start. */
id|raw3270_put_view
c_func
(paren
id|view
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Size sensing.&n; */
DECL|struct|raw3270_ua
r_struct
id|raw3270_ua
(brace
multiline_comment|/* Query Reply structure for Usable Area */
r_struct
(brace
multiline_comment|/* Usable Area Query Reply Base */
DECL|member|l
r_int
id|l
suffix:semicolon
multiline_comment|/* Length of this structured field */
DECL|member|sfid
r_char
id|sfid
suffix:semicolon
multiline_comment|/* 0x81 if Query Reply */
DECL|member|qcode
r_char
id|qcode
suffix:semicolon
multiline_comment|/* 0x81 if Usable Area */
DECL|member|flags0
r_char
id|flags0
suffix:semicolon
DECL|member|flags1
r_char
id|flags1
suffix:semicolon
DECL|member|w
r_int
id|w
suffix:semicolon
multiline_comment|/* Width of usable area */
DECL|member|h
r_int
id|h
suffix:semicolon
multiline_comment|/* Heigth of usavle area */
DECL|member|units
r_char
id|units
suffix:semicolon
multiline_comment|/* 0x00:in; 0x01:mm */
DECL|member|xr
r_int
id|xr
suffix:semicolon
DECL|member|yr
r_int
id|yr
suffix:semicolon
DECL|member|aw
r_char
id|aw
suffix:semicolon
DECL|member|ah
r_char
id|ah
suffix:semicolon
DECL|member|buffsz
r_int
id|buffsz
suffix:semicolon
multiline_comment|/* Character buffer size, bytes */
DECL|member|xmin
r_char
id|xmin
suffix:semicolon
DECL|member|ymin
r_char
id|ymin
suffix:semicolon
DECL|member|xmax
r_char
id|xmax
suffix:semicolon
DECL|member|ymax
r_char
id|ymax
suffix:semicolon
DECL|member|uab
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
id|uab
suffix:semicolon
r_struct
(brace
multiline_comment|/* Alternate Usable Area Self-Defining Parameter */
DECL|member|l
r_char
id|l
suffix:semicolon
multiline_comment|/* Length of this Self-Defining Parm */
DECL|member|sdpid
r_char
id|sdpid
suffix:semicolon
multiline_comment|/* 0x02 if Alternate Usable Area */
DECL|member|res
r_char
id|res
suffix:semicolon
DECL|member|auaid
r_char
id|auaid
suffix:semicolon
multiline_comment|/* 0x01 is Id for the A U A */
DECL|member|wauai
r_int
id|wauai
suffix:semicolon
multiline_comment|/* Width of AUAi */
DECL|member|hauai
r_int
id|hauai
suffix:semicolon
multiline_comment|/* Height of AUAi */
DECL|member|auaunits
r_char
id|auaunits
suffix:semicolon
multiline_comment|/* 0x00:in, 0x01:mm */
DECL|member|auaxr
r_int
id|auaxr
suffix:semicolon
DECL|member|auayr
r_int
id|auayr
suffix:semicolon
DECL|member|awauai
r_char
id|awauai
suffix:semicolon
DECL|member|ahauai
r_char
id|ahauai
suffix:semicolon
DECL|member|aua
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
id|aua
suffix:semicolon
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|variable|raw3270_init_data
r_static
r_int
r_char
id|raw3270_init_data
(braket
l_int|256
)braket
suffix:semicolon
DECL|variable|raw3270_init_request
r_static
r_struct
id|raw3270_request
id|raw3270_init_request
suffix:semicolon
DECL|variable|raw3270_init_diag210
r_static
r_struct
id|diag210
id|raw3270_init_diag210
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|raw3270_init_sem
)paren
suffix:semicolon
r_static
r_int
DECL|function|raw3270_init_irq
id|raw3270_init_irq
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
comma
r_struct
id|raw3270_request
op_star
id|rq
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
multiline_comment|/*&n;&t; * Unit-Check Processing:&n;&t; * Expect Command Reject or Intervention Required.&n;&t; */
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
multiline_comment|/* Request finished abnormally. */
r_if
c_cond
(paren
id|irb-&gt;ecw
(braket
l_int|0
)braket
op_amp
id|SNS0_INTERVENTION_REQ
)paren
(brace
id|set_bit
c_func
(paren
id|RAW3270_FLAGS_BUSY
comma
op_amp
id|view-&gt;dev-&gt;flags
)paren
suffix:semicolon
r_return
id|RAW3270_IO_BUSY
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rq
)paren
(brace
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
r_if
c_cond
(paren
id|irb-&gt;ecw
(braket
l_int|0
)braket
op_amp
id|SNS0_CMD_REJECT
)paren
id|rq-&gt;rc
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_else
id|rq-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
multiline_comment|/* Request finished normally. Copy residual count. */
id|rq-&gt;rescnt
op_assign
id|irb-&gt;scsw.count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_ATTENTION
)paren
(brace
id|set_bit
c_func
(paren
id|RAW3270_FLAGS_ATTN
comma
op_amp
id|view-&gt;dev-&gt;flags
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|raw3270_wait_queue
)paren
suffix:semicolon
)brace
r_return
id|RAW3270_IO_DONE
suffix:semicolon
)brace
DECL|variable|raw3270_init_fn
r_static
r_struct
id|raw3270_fn
id|raw3270_init_fn
op_assign
(brace
dot
id|intv
op_assign
id|raw3270_init_irq
)brace
suffix:semicolon
DECL|variable|raw3270_init_view
r_static
r_struct
id|raw3270_view
id|raw3270_init_view
op_assign
(brace
dot
id|fn
op_assign
op_amp
id|raw3270_init_fn
)brace
suffix:semicolon
multiline_comment|/*&n; * raw3270_wait/raw3270_wait_interruptible/__raw3270_wakeup&n; * Wait for end of request. The request must have been started&n; * with raw3270_start, rc = 0. The device lock may NOT have been&n; * released between calling raw3270_start and raw3270_wait.&n; */
r_static
r_void
DECL|function|raw3270_wake_init
id|raw3270_wake_init
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
r_void
op_star
id|data
)paren
(brace
id|wake_up
c_func
(paren
(paren
id|wait_queue_head_t
op_star
)paren
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Special wait function that can cope with console initialization.&n; */
r_static
r_int
DECL|function|raw3270_start_init
id|raw3270_start_init
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
comma
r_struct
id|raw3270_view
op_star
id|view
comma
r_struct
id|raw3270_request
op_star
id|rq
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|wait_queue_head_t
id|wq
suffix:semicolon
r_int
id|rc
suffix:semicolon
macro_line|#ifdef CONFIG_TN3270_CONSOLE
r_if
c_cond
(paren
id|raw3270_registered
op_eq
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|view-&gt;dev-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|rq-&gt;callback
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|__raw3270_start
c_func
(paren
id|rp
comma
id|view
comma
id|rq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
r_while
c_loop
(paren
op_logical_neg
id|raw3270_request_final
c_func
(paren
id|rq
)paren
)paren
(brace
id|wait_cons_dev
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|view-&gt;dev-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
id|rq-&gt;rc
suffix:semicolon
)brace
macro_line|#endif
id|init_waitqueue_head
c_func
(paren
op_amp
id|wq
)paren
suffix:semicolon
id|rq-&gt;callback
op_assign
id|raw3270_wake_init
suffix:semicolon
id|rq-&gt;callback_data
op_assign
op_amp
id|wq
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|view-&gt;dev-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|rc
op_assign
id|__raw3270_start
c_func
(paren
id|rp
comma
id|view
comma
id|rq
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|view-&gt;dev-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Now wait for the completion. */
id|rc
op_assign
id|wait_event_interruptible
c_func
(paren
id|wq
comma
id|raw3270_request_final
c_func
(paren
id|rq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ERESTARTSYS
)paren
(brace
multiline_comment|/* Interrupted by a signal. */
id|raw3270_halt_io
c_func
(paren
id|view-&gt;dev
comma
id|rq
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_return
id|rq-&gt;rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|__raw3270_size_device_vm
id|__raw3270_size_device_vm
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
)paren
(brace
r_int
id|rc
comma
id|model
suffix:semicolon
id|raw3270_init_diag210.vrdcdvno
op_assign
id|_ccw_device_get_device_number
c_func
(paren
id|rp-&gt;cdev
)paren
suffix:semicolon
id|raw3270_init_diag210.vrdclen
op_assign
r_sizeof
(paren
r_struct
id|diag210
)paren
suffix:semicolon
id|rc
op_assign
id|diag210
c_func
(paren
op_amp
id|raw3270_init_diag210
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|model
op_assign
id|raw3270_init_diag210.vrdccrmd
suffix:semicolon
r_switch
c_cond
(paren
id|model
)paren
(brace
r_case
l_int|2
suffix:colon
id|rp-&gt;model
op_assign
id|model
suffix:semicolon
id|rp-&gt;rows
op_assign
l_int|24
suffix:semicolon
id|rp-&gt;cols
op_assign
l_int|80
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|rp-&gt;model
op_assign
id|model
suffix:semicolon
id|rp-&gt;rows
op_assign
l_int|32
suffix:semicolon
id|rp-&gt;cols
op_assign
l_int|80
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|rp-&gt;model
op_assign
id|model
suffix:semicolon
id|rp-&gt;rows
op_assign
l_int|43
suffix:semicolon
id|rp-&gt;cols
op_assign
l_int|80
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|rp-&gt;model
op_assign
id|model
suffix:semicolon
id|rp-&gt;rows
op_assign
l_int|27
suffix:semicolon
id|rp-&gt;cols
op_assign
l_int|132
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;vrdccrmd is 0x%.8x&bslash;n&quot;
comma
id|model
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|__raw3270_size_device
id|__raw3270_size_device
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
)paren
(brace
r_static
r_const
r_int
r_char
id|wbuf
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x07
comma
l_int|0x01
comma
l_int|0xff
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x81
)brace
suffix:semicolon
r_struct
id|raw3270_ua
op_star
id|uap
suffix:semicolon
r_int
r_int
id|count
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/*&n;&t; * To determine the size of the 3270 device we need to do:&n;&t; * 1) send a &squot;read partition&squot; data stream to the device&n;&t; * 2) wait for the attn interrupt that preceeds the query reply&n;&t; * 3) do a read modified to get the query reply&n;&t; * To make things worse we have to cope with intervention&n;&t; * required (3270 device switched to &squot;stand-by&squot;) and command&n;&t; * rejects (old devices that can&squot;t do &squot;read partition&squot;).&n;&t; */
id|memset
c_func
(paren
op_amp
id|raw3270_init_request
comma
l_int|0
comma
r_sizeof
(paren
id|raw3270_init_request
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|raw3270_init_data
comma
l_int|0
comma
r_sizeof
(paren
id|raw3270_init_data
)paren
)paren
suffix:semicolon
multiline_comment|/* Store &squot;read partition&squot; data stream to raw3270_init_data */
id|memcpy
c_func
(paren
id|raw3270_init_data
comma
id|wbuf
comma
r_sizeof
(paren
id|wbuf
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|raw3270_init_request.list
)paren
suffix:semicolon
id|raw3270_init_request.ccw.cmd_code
op_assign
id|TC_WRITESF
suffix:semicolon
id|raw3270_init_request.ccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|raw3270_init_request.ccw.count
op_assign
r_sizeof
(paren
id|wbuf
)paren
suffix:semicolon
id|raw3270_init_request.ccw.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|raw3270_init_data
)paren
suffix:semicolon
id|rc
op_assign
id|raw3270_start_init
c_func
(paren
id|rp
comma
op_amp
id|raw3270_init_view
comma
op_amp
id|raw3270_init_request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* Check error cases: -ERESTARTSYS, -EIO and -EOPNOTSUPP */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EOPNOTSUPP
op_logical_and
id|MACHINE_IS_VM
)paren
r_return
id|__raw3270_size_device_vm
c_func
(paren
id|rp
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Wait for attention interrupt. */
macro_line|#ifdef CONFIG_TN3270_CONSOLE
r_if
c_cond
(paren
id|raw3270_registered
op_eq
l_int|0
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|test_and_clear_bit
c_func
(paren
id|RAW3270_FLAGS_ATTN
comma
op_amp
id|rp-&gt;flags
)paren
)paren
id|wait_cons_dev
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
id|rc
op_assign
id|wait_event_interruptible
c_func
(paren
id|raw3270_wait_queue
comma
id|test_and_clear_bit
c_func
(paren
id|RAW3270_FLAGS_ATTN
comma
op_amp
id|rp-&gt;flags
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/*&n;&t; * The device accepted the &squot;read partition&squot; command. Now&n;&t; * set up a read ccw and issue it.&n;&t; */
id|raw3270_init_request.ccw.cmd_code
op_assign
id|TC_READMOD
suffix:semicolon
id|raw3270_init_request.ccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|raw3270_init_request.ccw.count
op_assign
r_sizeof
(paren
id|raw3270_init_data
)paren
suffix:semicolon
id|raw3270_init_request.ccw.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|raw3270_init_data
)paren
suffix:semicolon
id|rc
op_assign
id|raw3270_start_init
c_func
(paren
id|rp
comma
op_amp
id|raw3270_init_view
comma
op_amp
id|raw3270_init_request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* Got a Query Reply */
id|count
op_assign
r_sizeof
(paren
id|raw3270_init_data
)paren
op_minus
id|raw3270_init_request.rescnt
suffix:semicolon
id|uap
op_assign
(paren
r_struct
id|raw3270_ua
op_star
)paren
(paren
id|raw3270_init_data
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Paranoia check. */
r_if
c_cond
(paren
id|raw3270_init_data
(braket
l_int|0
)braket
op_ne
l_int|0x88
op_logical_or
id|uap-&gt;uab.qcode
op_ne
l_int|0x81
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
multiline_comment|/* Copy rows/columns of default Usable Area */
id|rp-&gt;rows
op_assign
id|uap-&gt;uab.h
suffix:semicolon
id|rp-&gt;cols
op_assign
id|uap-&gt;uab.w
suffix:semicolon
multiline_comment|/* Check for 14 bit addressing */
r_if
c_cond
(paren
(paren
id|uap-&gt;uab.flags0
op_amp
l_int|0x0d
)paren
op_eq
l_int|0x01
)paren
id|set_bit
c_func
(paren
id|RAW3270_FLAGS_14BITADDR
comma
op_amp
id|rp-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* Check for Alternate Usable Area */
r_if
c_cond
(paren
id|uap-&gt;uab.l
op_eq
r_sizeof
(paren
r_struct
id|raw3270_ua
)paren
op_logical_and
id|uap-&gt;aua.sdpid
op_eq
l_int|0x02
)paren
(brace
id|rp-&gt;rows
op_assign
id|uap-&gt;aua.hauai
suffix:semicolon
id|rp-&gt;cols
op_assign
id|uap-&gt;aua.wauai
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|raw3270_size_device
id|raw3270_size_device
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
)paren
(brace
r_int
id|rc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|raw3270_init_sem
)paren
suffix:semicolon
id|rp-&gt;view
op_assign
op_amp
id|raw3270_init_view
suffix:semicolon
id|raw3270_init_view.dev
op_assign
id|rp
suffix:semicolon
id|rc
op_assign
id|__raw3270_size_device
c_func
(paren
id|rp
)paren
suffix:semicolon
id|raw3270_init_view.dev
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;view
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|raw3270_init_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Found something. */
multiline_comment|/* Try to find a model. */
id|rp-&gt;model
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;rows
op_eq
l_int|24
op_logical_and
id|rp-&gt;cols
op_eq
l_int|80
)paren
id|rp-&gt;model
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;rows
op_eq
l_int|32
op_logical_and
id|rp-&gt;cols
op_eq
l_int|80
)paren
id|rp-&gt;model
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;rows
op_eq
l_int|43
op_logical_and
id|rp-&gt;cols
op_eq
l_int|80
)paren
id|rp-&gt;model
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;rows
op_eq
l_int|27
op_logical_and
id|rp-&gt;cols
op_eq
l_int|132
)paren
id|rp-&gt;model
op_assign
l_int|5
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|raw3270_reset_device
id|raw3270_reset_device
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
)paren
(brace
r_int
id|rc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|raw3270_init_sem
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|raw3270_init_request
comma
l_int|0
comma
r_sizeof
(paren
id|raw3270_init_request
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|raw3270_init_data
comma
l_int|0
comma
r_sizeof
(paren
id|raw3270_init_data
)paren
)paren
suffix:semicolon
multiline_comment|/* Store reset data stream to raw3270_init_data/raw3270_init_request */
id|raw3270_init_data
(braket
l_int|0
)braket
op_assign
id|TW_KR
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|raw3270_init_request.list
)paren
suffix:semicolon
id|raw3270_init_request.ccw.cmd_code
op_assign
id|TC_EWRITEA
suffix:semicolon
id|raw3270_init_request.ccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|raw3270_init_request.ccw.count
op_assign
l_int|1
suffix:semicolon
id|raw3270_init_request.ccw.cda
op_assign
(paren
id|__u32
)paren
id|__pa
c_func
(paren
id|raw3270_init_data
)paren
suffix:semicolon
id|rp-&gt;view
op_assign
op_amp
id|raw3270_init_view
suffix:semicolon
id|raw3270_init_view.dev
op_assign
id|rp
suffix:semicolon
id|rc
op_assign
id|raw3270_start_init
c_func
(paren
id|rp
comma
op_amp
id|raw3270_init_view
comma
op_amp
id|raw3270_init_request
)paren
suffix:semicolon
id|raw3270_init_view.dev
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;view
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|raw3270_init_sem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup new 3270 device.&n; */
r_static
r_int
DECL|function|raw3270_setup_device
id|raw3270_setup_device
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
comma
r_struct
id|raw3270
op_star
id|rp
comma
r_char
op_star
id|ascebc
)paren
(brace
r_struct
id|list_head
op_star
id|l
suffix:semicolon
r_struct
id|raw3270
op_star
id|tmp
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|memset
c_func
(paren
id|rp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|raw3270
)paren
)paren
suffix:semicolon
multiline_comment|/* Copy ebcdic -&gt; ascii translation table. */
id|memcpy
c_func
(paren
id|ascebc
comma
id|_ascebc
comma
l_int|256
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tubxcorrect
)paren
(brace
multiline_comment|/* correct brackets and circumflex */
id|ascebc
(braket
l_char|&squot;[&squot;
)braket
op_assign
l_int|0xad
suffix:semicolon
id|ascebc
(braket
l_char|&squot;]&squot;
)braket
op_assign
l_int|0xbd
suffix:semicolon
id|ascebc
(braket
l_char|&squot;^&squot;
)braket
op_assign
l_int|0xb0
suffix:semicolon
)brace
id|rp-&gt;ascebc
op_assign
id|ascebc
suffix:semicolon
multiline_comment|/* Set defaults. */
id|rp-&gt;rows
op_assign
l_int|24
suffix:semicolon
id|rp-&gt;cols
op_assign
l_int|80
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|rp-&gt;req_queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|rp-&gt;view_list
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Add device to list and find the smallest unused minor&n;&t; * number for it.&n;&t; */
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
multiline_comment|/* Keep the list sorted. */
id|minor
op_assign
l_int|0
suffix:semicolon
id|rp-&gt;minor
op_assign
op_minus
l_int|1
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|raw3270_devices
)paren
(brace
id|tmp
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|raw3270
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp-&gt;minor
OG
id|minor
)paren
(brace
id|rp-&gt;minor
op_assign
id|minor
suffix:semicolon
id|__list_add
c_func
(paren
op_amp
id|rp-&gt;list
comma
id|l-&gt;prev
comma
id|l
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|minor
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rp-&gt;minor
op_eq
op_minus
l_int|1
op_logical_and
id|minor
OL
id|RAW3270_MAXDEVS
)paren
(brace
id|rp-&gt;minor
op_assign
id|minor
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|rp-&gt;list
comma
op_amp
id|raw3270_devices
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
multiline_comment|/* No free minor number? Then give up. */
r_if
c_cond
(paren
id|rp-&gt;minor
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EUSERS
suffix:semicolon
id|rp-&gt;cdev
op_assign
id|cdev
suffix:semicolon
id|cdev-&gt;dev.driver_data
op_assign
id|rp
suffix:semicolon
id|cdev-&gt;handler
op_assign
id|raw3270_irq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_TN3270_CONSOLE
multiline_comment|/*&n; * Setup 3270 device configured as console.&n; */
r_struct
id|raw3270
op_star
DECL|function|raw3270_setup_console
id|raw3270_setup_console
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_char
op_star
id|ascebc
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rp
op_assign
(paren
r_struct
id|raw3270
op_star
)paren
id|alloc_bootmem
c_func
(paren
r_sizeof
(paren
r_struct
id|raw3270
)paren
)paren
suffix:semicolon
id|ascebc
op_assign
(paren
r_char
op_star
)paren
id|alloc_bootmem
c_func
(paren
l_int|256
)paren
suffix:semicolon
id|rc
op_assign
id|raw3270_setup_device
c_func
(paren
id|cdev
comma
id|rp
comma
id|ascebc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|ERR_PTR
c_func
(paren
id|rc
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|RAW3270_FLAGS_CONSOLE
comma
op_amp
id|rp-&gt;flags
)paren
suffix:semicolon
id|raw3270_reset_device
c_func
(paren
id|rp
)paren
suffix:semicolon
id|raw3270_size_device
c_func
(paren
id|rp
)paren
suffix:semicolon
id|raw3270_reset_device
c_func
(paren
id|rp
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
suffix:semicolon
r_return
id|rp
suffix:semicolon
)brace
r_void
DECL|function|raw3270_wait_cons_dev
id|raw3270_wait_cons_dev
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|wait_cons_dev
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; * Create a 3270 device structure.&n; */
r_static
r_struct
id|raw3270
op_star
DECL|function|raw3270_create_device
id|raw3270_create_device
c_func
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_char
op_star
id|ascebc
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|raw3270
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rp
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|ascebc
op_assign
id|kmalloc
c_func
(paren
l_int|256
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ascebc
)paren
(brace
id|kfree
c_func
(paren
id|rp
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|raw3270_setup_device
c_func
(paren
id|cdev
comma
id|rp
comma
id|ascebc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|kfree
c_func
(paren
id|rp-&gt;ascebc
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rp
)paren
suffix:semicolon
id|rp
op_assign
id|ERR_PTR
c_func
(paren
id|rc
)paren
suffix:semicolon
)brace
multiline_comment|/* Get reference to ccw_device structure. */
id|get_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
r_return
id|rp
suffix:semicolon
)brace
multiline_comment|/*&n; * Activate a view.&n; */
r_int
DECL|function|raw3270_activate_view
id|raw3270_activate_view
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_struct
id|raw3270_view
op_star
id|oldview
comma
op_star
id|nv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rp
op_assign
id|view-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rp
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;view
op_eq
id|view
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
)paren
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_else
(brace
id|oldview
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;view
)paren
(brace
id|oldview
op_assign
id|rp-&gt;view
suffix:semicolon
id|oldview-&gt;fn
op_member_access_from_pointer
id|deactivate
c_func
(paren
id|oldview
)paren
suffix:semicolon
)brace
id|rp-&gt;view
op_assign
id|view
suffix:semicolon
id|rc
op_assign
id|view-&gt;fn
op_member_access_from_pointer
id|activate
c_func
(paren
id|view
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* Didn&squot;t work. Try to reactivate the old view. */
id|rp-&gt;view
op_assign
id|oldview
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oldview
op_logical_or
id|oldview-&gt;fn
op_member_access_from_pointer
id|activate
c_func
(paren
id|oldview
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Didn&squot;t work as well. Try any other view. */
id|list_for_each_entry
c_func
(paren
id|nv
comma
op_amp
id|rp-&gt;view_list
comma
id|list
)paren
r_if
c_cond
(paren
id|nv
op_ne
id|view
op_logical_and
id|nv
op_ne
id|oldview
)paren
(brace
id|rp-&gt;view
op_assign
id|nv
suffix:semicolon
r_if
c_cond
(paren
id|nv-&gt;fn
op_member_access_from_pointer
id|activate
c_func
(paren
id|nv
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|rp-&gt;view
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Deactivate current view.&n; */
r_void
DECL|function|raw3270_deactivate_view
id|raw3270_deactivate_view
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
id|rp
op_assign
id|view-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rp
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;view
op_eq
id|view
)paren
(brace
id|view-&gt;fn
op_member_access_from_pointer
id|deactivate
c_func
(paren
id|view
)paren
suffix:semicolon
id|rp-&gt;view
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Move deactivated view to end of list. */
id|list_del_init
c_func
(paren
op_amp
id|view-&gt;list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|view-&gt;list
comma
op_amp
id|rp-&gt;view_list
)paren
suffix:semicolon
multiline_comment|/* Try to activate another view. */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|view
comma
op_amp
id|rp-&gt;view_list
comma
id|list
)paren
r_if
c_cond
(paren
id|view-&gt;fn
op_member_access_from_pointer
id|activate
c_func
(paren
id|view
)paren
op_eq
l_int|0
)paren
(brace
id|rp-&gt;view
op_assign
id|view
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Add view to device with minor &quot;minor&quot;.&n; */
r_int
DECL|function|raw3270_add_view
id|raw3270_add_view
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
comma
r_struct
id|raw3270_fn
op_star
id|fn
comma
r_int
id|minor
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|rp
comma
op_amp
id|raw3270_devices
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|rp-&gt;minor
op_ne
id|minor
)paren
r_continue
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|view-&gt;ref_count
comma
l_int|2
)paren
suffix:semicolon
id|view-&gt;dev
op_assign
id|rp
suffix:semicolon
id|view-&gt;fn
op_assign
id|fn
suffix:semicolon
id|view-&gt;model
op_assign
id|rp-&gt;model
suffix:semicolon
id|view-&gt;rows
op_assign
id|rp-&gt;rows
suffix:semicolon
id|view-&gt;cols
op_assign
id|rp-&gt;cols
suffix:semicolon
id|view-&gt;ascebc
op_assign
id|rp-&gt;ascebc
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|view-&gt;lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|view-&gt;list
comma
op_amp
id|rp-&gt;view_list
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Find specific view of device with minor &quot;minor&quot;.&n; */
r_struct
id|raw3270_view
op_star
DECL|function|raw3270_find_view
id|raw3270_find_view
c_func
(paren
r_struct
id|raw3270_fn
op_star
id|fn
comma
r_int
id|minor
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_struct
id|raw3270_view
op_star
id|view
comma
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
id|view
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|rp
comma
op_amp
id|raw3270_devices
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|rp-&gt;minor
op_ne
id|minor
)paren
r_continue
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
)paren
(brace
id|view
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENOENT
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp
comma
op_amp
id|rp-&gt;view_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;fn
op_eq
id|fn
)paren
(brace
id|raw3270_get_view
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|view
op_assign
id|tmp
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
r_return
id|view
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove view from device and free view structure via call to view-&gt;fn-&gt;free.&n; */
r_void
DECL|function|raw3270_del_view
id|raw3270_del_view
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_struct
id|raw3270_view
op_star
id|nv
suffix:semicolon
id|rp
op_assign
id|view-&gt;dev
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;view
op_eq
id|view
)paren
(brace
id|view-&gt;fn
op_member_access_from_pointer
id|deactivate
c_func
(paren
id|view
)paren
suffix:semicolon
id|rp-&gt;view
op_assign
l_int|0
suffix:semicolon
)brace
id|list_del_init
c_func
(paren
op_amp
id|view-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rp-&gt;view
op_logical_and
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
)paren
(brace
multiline_comment|/* Try to activate another view. */
id|list_for_each_entry
c_func
(paren
id|nv
comma
op_amp
id|rp-&gt;view_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|nv-&gt;fn
op_member_access_from_pointer
id|activate
c_func
(paren
id|view
)paren
op_eq
l_int|0
)paren
(brace
id|rp-&gt;view
op_assign
id|nv
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|rp-&gt;cdev
)paren
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Wait for reference counter to drop to zero. */
id|atomic_sub
c_func
(paren
l_int|2
comma
op_amp
id|view-&gt;ref_count
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|raw3270_wait_queue
comma
id|atomic_read
c_func
(paren
op_amp
id|view-&gt;ref_count
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|view-&gt;fn-&gt;free
)paren
id|view-&gt;fn
op_member_access_from_pointer
id|free
c_func
(paren
id|view
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove a 3270 device structure.&n; */
r_static
r_void
DECL|function|raw3270_delete_device
id|raw3270_delete_device
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
)paren
(brace
r_struct
id|ccw_device
op_star
id|cdev
suffix:semicolon
multiline_comment|/* Remove from device chain. */
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|rp-&gt;list
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
multiline_comment|/* Disconnect from ccw_device. */
id|cdev
op_assign
id|rp-&gt;cdev
suffix:semicolon
id|rp-&gt;cdev
op_assign
l_int|0
suffix:semicolon
id|cdev-&gt;dev.driver_data
op_assign
l_int|0
suffix:semicolon
id|cdev-&gt;handler
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Put ccw_device structure. */
id|put_device
c_func
(paren
op_amp
id|cdev-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* Now free raw3270 structure. */
id|kfree
c_func
(paren
id|rp-&gt;ascebc
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rp
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|raw3270_probe
id|raw3270_probe
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Additional attributes for a 3270 device&n; */
r_static
id|ssize_t
DECL|function|raw3270_model_show
id|raw3270_model_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%i&bslash;n&quot;
comma
(paren
(paren
r_struct
id|raw3270
op_star
)paren
id|dev-&gt;driver_data
)paren
op_member_access_from_pointer
id|model
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|model
comma
l_int|0444
comma
id|raw3270_model_show
comma
l_int|0
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|raw3270_rows_show
id|raw3270_rows_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%i&bslash;n&quot;
comma
(paren
(paren
r_struct
id|raw3270
op_star
)paren
id|dev-&gt;driver_data
)paren
op_member_access_from_pointer
id|rows
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|rows
comma
l_int|0444
comma
id|raw3270_rows_show
comma
l_int|0
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|raw3270_columns_show
id|raw3270_columns_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|snprintf
c_func
(paren
id|buf
comma
id|PAGE_SIZE
comma
l_string|&quot;%i&bslash;n&quot;
comma
(paren
(paren
r_struct
id|raw3270
op_star
)paren
id|dev-&gt;driver_data
)paren
op_member_access_from_pointer
id|cols
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|columns
comma
l_int|0444
comma
id|raw3270_columns_show
comma
l_int|0
)paren
suffix:semicolon
DECL|variable|raw3270_attrs
r_static
r_struct
id|attribute
op_star
id|raw3270_attrs
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_model.attr
comma
op_amp
id|dev_attr_rows.attr
comma
op_amp
id|dev_attr_columns.attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|raw3270_attr_group
r_static
r_struct
id|attribute_group
id|raw3270_attr_group
op_assign
(brace
dot
id|attrs
op_assign
id|raw3270_attrs
comma
)brace
suffix:semicolon
r_static
r_void
DECL|function|raw3270_create_attributes
id|raw3270_create_attributes
c_func
(paren
r_struct
id|raw3270
op_star
id|rp
)paren
(brace
singleline_comment|//FIXME: check return code
id|sysfs_create_group
c_func
(paren
op_amp
id|rp-&gt;cdev-&gt;dev.kobj
comma
op_amp
id|raw3270_attr_group
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Notifier for device addition/removal&n; */
DECL|struct|raw3270_notifier
r_struct
id|raw3270_notifier
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|notifier
r_void
(paren
op_star
id|notifier
)paren
(paren
r_int
comma
r_int
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|raw3270_notifier
r_static
r_struct
id|list_head
id|raw3270_notifier
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|raw3270_notifier
)paren
suffix:semicolon
DECL|function|raw3270_register_notifier
r_int
id|raw3270_register_notifier
c_func
(paren
r_void
(paren
op_star
id|notifier
)paren
(paren
r_int
comma
r_int
)paren
)paren
(brace
r_struct
id|raw3270_notifier
op_star
id|np
suffix:semicolon
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
id|np
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|raw3270_notifier
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|np
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|np-&gt;notifier
op_assign
id|notifier
suffix:semicolon
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|np-&gt;list
comma
op_amp
id|raw3270_notifier
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|rp
comma
op_amp
id|raw3270_devices
comma
id|list
)paren
(brace
id|get_device
c_func
(paren
op_amp
id|rp-&gt;cdev-&gt;dev
)paren
suffix:semicolon
id|notifier
c_func
(paren
id|rp-&gt;minor
comma
l_int|1
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|raw3270_unregister_notifier
r_void
id|raw3270_unregister_notifier
c_func
(paren
r_void
(paren
op_star
id|notifier
)paren
(paren
r_int
comma
r_int
)paren
)paren
(brace
r_struct
id|raw3270_notifier
op_star
id|np
suffix:semicolon
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|np
comma
op_amp
id|raw3270_notifier
comma
id|list
)paren
r_if
c_cond
(paren
id|np-&gt;notifier
op_eq
id|notifier
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|np-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|np
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set 3270 device online.&n; */
r_static
r_int
DECL|function|raw3270_set_online
id|raw3270_set_online
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_struct
id|raw3270_notifier
op_star
id|np
suffix:semicolon
id|rp
op_assign
id|raw3270_create_device
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|rp
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|rp
)paren
suffix:semicolon
id|raw3270_reset_device
c_func
(paren
id|rp
)paren
suffix:semicolon
id|raw3270_size_device
c_func
(paren
id|rp
)paren
suffix:semicolon
id|raw3270_reset_device
c_func
(paren
id|rp
)paren
suffix:semicolon
id|raw3270_create_attributes
c_func
(paren
id|rp
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|np
comma
op_amp
id|raw3270_notifier
comma
id|list
)paren
id|np
op_member_access_from_pointer
id|notifier
c_func
(paren
id|rp-&gt;minor
comma
l_int|1
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove 3270 device structure.&n; */
r_static
r_void
DECL|function|raw3270_remove
id|raw3270_remove
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_struct
id|raw3270_view
op_star
id|v
suffix:semicolon
r_struct
id|raw3270_notifier
op_star
id|np
suffix:semicolon
id|rp
op_assign
id|cdev-&gt;dev.driver_data
suffix:semicolon
id|clear_bit
c_func
(paren
id|RAW3270_FLAGS_READY
comma
op_amp
id|rp-&gt;flags
)paren
suffix:semicolon
id|sysfs_remove_group
c_func
(paren
op_amp
id|cdev-&gt;dev.kobj
comma
op_amp
id|raw3270_attr_group
)paren
suffix:semicolon
multiline_comment|/* Deactivate current view and remove all views. */
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|cdev
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rp-&gt;view
)paren
(brace
id|rp-&gt;view-&gt;fn
op_member_access_from_pointer
id|deactivate
c_func
(paren
id|rp-&gt;view
)paren
suffix:semicolon
id|rp-&gt;view
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|rp-&gt;view_list
)paren
)paren
(brace
id|v
op_assign
id|list_entry
c_func
(paren
id|rp-&gt;view_list.next
comma
r_struct
id|raw3270_view
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;fn-&gt;release
)paren
id|v-&gt;fn
op_member_access_from_pointer
id|release
c_func
(paren
id|v
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|cdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|raw3270_del_view
c_func
(paren
id|v
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|cdev
)paren
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|cdev
)paren
comma
id|flags
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|np
comma
op_amp
id|raw3270_notifier
comma
id|list
)paren
id|np
op_member_access_from_pointer
id|notifier
c_func
(paren
id|rp-&gt;minor
comma
l_int|0
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
multiline_comment|/* Reset 3270 device. */
id|raw3270_reset_device
c_func
(paren
id|rp
)paren
suffix:semicolon
multiline_comment|/* And finally remove it. */
id|raw3270_delete_device
c_func
(paren
id|rp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set 3270 device offline.&n; */
r_static
r_int
DECL|function|raw3270_set_offline
id|raw3270_set_offline
(paren
r_struct
id|ccw_device
op_star
id|cdev
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
id|rp
op_assign
id|cdev-&gt;dev.driver_data
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RAW3270_FLAGS_CONSOLE
comma
op_amp
id|rp-&gt;flags
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|raw3270_remove
c_func
(paren
id|cdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|raw3270_id
r_static
r_struct
id|ccw_device_id
id|raw3270_id
(braket
)braket
op_assign
(brace
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3270
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3271
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3272
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3273
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3274
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3275
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3276
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3277
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3278
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3279
comma
l_int|0
)paren
)brace
comma
(brace
id|CCW_DEVICE
c_func
(paren
l_int|0x3174
comma
l_int|0
)paren
)brace
comma
(brace
multiline_comment|/* end of list */
)brace
comma
)brace
suffix:semicolon
DECL|variable|raw3270_ccw_driver
r_static
r_struct
id|ccw_driver
id|raw3270_ccw_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;3270&quot;
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ids
op_assign
id|raw3270_id
comma
dot
id|probe
op_assign
op_amp
id|raw3270_probe
comma
dot
id|remove
op_assign
op_amp
id|raw3270_remove
comma
dot
id|set_online
op_assign
op_amp
id|raw3270_set_online
comma
dot
id|set_offline
op_assign
op_amp
id|raw3270_set_offline
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|raw3270_init
id|raw3270_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|raw3270
op_star
id|rp
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|raw3270_registered
)paren
r_return
l_int|0
suffix:semicolon
id|raw3270_registered
op_assign
l_int|1
suffix:semicolon
id|rc
op_assign
id|ccw_driver_register
c_func
(paren
op_amp
id|raw3270_ccw_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Create attributes for early (= console) device. */
id|down
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|rp
comma
op_amp
id|raw3270_devices
comma
id|list
)paren
(brace
id|get_device
c_func
(paren
op_amp
id|rp-&gt;cdev-&gt;dev
)paren
suffix:semicolon
id|raw3270_create_attributes
c_func
(paren
id|rp
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|raw3270_sem
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|raw3270_exit
id|raw3270_exit
c_func
(paren
r_void
)paren
(brace
id|ccw_driver_unregister
c_func
(paren
op_amp
id|raw3270_ccw_driver
)paren
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|raw3270_init
id|module_init
c_func
(paren
id|raw3270_init
)paren
suffix:semicolon
DECL|variable|raw3270_exit
id|module_exit
c_func
(paren
id|raw3270_exit
)paren
suffix:semicolon
DECL|variable|raw3270_request_alloc
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_request_alloc
)paren
suffix:semicolon
DECL|variable|raw3270_request_free
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_request_free
)paren
suffix:semicolon
DECL|variable|raw3270_request_reset
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_request_reset
)paren
suffix:semicolon
DECL|variable|raw3270_request_set_cmd
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_request_set_cmd
)paren
suffix:semicolon
DECL|variable|raw3270_request_add_data
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_request_add_data
)paren
suffix:semicolon
DECL|variable|raw3270_request_set_data
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_request_set_data
)paren
suffix:semicolon
DECL|variable|raw3270_request_set_idal
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_request_set_idal
)paren
suffix:semicolon
DECL|variable|raw3270_buffer_address
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_buffer_address
)paren
suffix:semicolon
DECL|variable|raw3270_add_view
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_add_view
)paren
suffix:semicolon
DECL|variable|raw3270_del_view
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_del_view
)paren
suffix:semicolon
DECL|variable|raw3270_find_view
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_find_view
)paren
suffix:semicolon
DECL|variable|raw3270_activate_view
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_activate_view
)paren
suffix:semicolon
DECL|variable|raw3270_deactivate_view
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_deactivate_view
)paren
suffix:semicolon
DECL|variable|raw3270_start
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_start
)paren
suffix:semicolon
DECL|variable|raw3270_start_irq
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_start_irq
)paren
suffix:semicolon
DECL|variable|raw3270_register_notifier
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_register_notifier
)paren
suffix:semicolon
DECL|variable|raw3270_unregister_notifier
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_unregister_notifier
)paren
suffix:semicolon
DECL|variable|raw3270_wait_queue
id|EXPORT_SYMBOL
c_func
(paren
id|raw3270_wait_queue
)paren
suffix:semicolon
eof
