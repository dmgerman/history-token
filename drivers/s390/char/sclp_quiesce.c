multiline_comment|/*&n; *  drivers/s390/char/sclp_quiesce.c&n; *     signal quiesce handler&n; *&n; *  (C) Copyright IBM Corp. 1999,2004&n; *  Author(s): Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; *             Peter Oberparleiter &lt;peter.oberparleiter@de.ibm.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/cpumask.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/ptrace.h&gt;
macro_line|#include &lt;asm/sigp.h&gt;
macro_line|#include &quot;sclp.h&quot;
macro_line|#ifdef CONFIG_SMP
multiline_comment|/* Signal completion of shutdown process. All CPUs except the first to enter&n; * this function: go to stopped state. First CPU: wait until all other&n; * CPUs are in stopped or check stop state. Afterwards, load special PSW&n; * to indicate completion. */
r_static
r_void
DECL|function|do_load_quiesce_psw
id|do_load_quiesce_psw
c_func
(paren
r_void
op_star
id|__unused
)paren
(brace
r_static
id|atomic_t
id|cpuid
op_assign
id|ATOMIC_INIT
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|psw_t
id|quiesce_psw
suffix:semicolon
id|__u32
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|atomic_compare_and_swap
c_func
(paren
op_minus
l_int|1
comma
id|smp_processor_id
c_func
(paren
)paren
comma
op_amp
id|cpuid
)paren
)paren
id|signal_processor
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|sigp_stop
)paren
suffix:semicolon
multiline_comment|/* Wait for all other cpus to enter stopped state */
id|i
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|NR_CPUS
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_online
c_func
(paren
id|i
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|signal_processor_ps
c_func
(paren
op_amp
id|status
comma
l_int|0
comma
id|i
comma
id|sigp_sense
)paren
)paren
(brace
r_case
id|sigp_order_code_accepted
suffix:colon
r_case
id|sigp_status_stored
suffix:colon
multiline_comment|/* Check for stopped and check stop state */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x50
)paren
id|i
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|sigp_busy
suffix:colon
r_break
suffix:semicolon
r_case
id|sigp_not_operational
suffix:colon
id|i
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Quiesce the last cpu with the special psw */
id|quiesce_psw.mask
op_assign
id|PSW_BASE_BITS
op_or
id|PSW_MASK_WAIT
suffix:semicolon
id|quiesce_psw.addr
op_assign
l_int|0xfff
suffix:semicolon
id|__load_psw
c_func
(paren
id|quiesce_psw
)paren
suffix:semicolon
)brace
multiline_comment|/* Shutdown handler. Perform shutdown function on all CPUs. */
r_static
r_void
DECL|function|do_machine_quiesce
id|do_machine_quiesce
c_func
(paren
r_void
)paren
(brace
id|on_each_cpu
c_func
(paren
id|do_load_quiesce_psw
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* Shutdown handler. Signal completion of shutdown by loading special PSW. */
r_static
r_void
DECL|function|do_machine_quiesce
id|do_machine_quiesce
c_func
(paren
r_void
)paren
(brace
id|psw_t
id|quiesce_psw
suffix:semicolon
id|quiesce_psw.mask
op_assign
id|PSW_BASE_BITS
op_or
id|PSW_MASK_WAIT
suffix:semicolon
id|quiesce_psw.addr
op_assign
l_int|0xfff
suffix:semicolon
id|__load_psw
c_func
(paren
id|quiesce_psw
)paren
suffix:semicolon
)brace
macro_line|#endif
r_extern
r_void
id|ctrl_alt_del
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Handler for quiesce event. Start shutdown procedure. */
r_static
r_void
DECL|function|sclp_quiesce_handler
id|sclp_quiesce_handler
c_func
(paren
r_struct
id|evbuf_header
op_star
id|evbuf
)paren
(brace
id|_machine_restart
op_assign
(paren
r_void
op_star
)paren
id|do_machine_quiesce
suffix:semicolon
id|_machine_halt
op_assign
id|do_machine_quiesce
suffix:semicolon
id|_machine_power_off
op_assign
id|do_machine_quiesce
suffix:semicolon
id|ctrl_alt_del
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|sclp_quiesce_event
r_static
r_struct
id|sclp_register
id|sclp_quiesce_event
op_assign
(brace
dot
id|receive_mask
op_assign
id|EvTyp_SigQuiesce_Mask
comma
dot
id|receiver_fn
op_assign
id|sclp_quiesce_handler
)brace
suffix:semicolon
multiline_comment|/* Initialize quiesce driver. */
r_static
r_int
id|__init
DECL|function|sclp_quiesce_init
id|sclp_quiesce_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|sclp_register
c_func
(paren
op_amp
id|sclp_quiesce_event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sclp: could not register quiesce handler &quot;
l_string|&quot;(rc=%d)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|sclp_quiesce_init
id|module_init
c_func
(paren
id|sclp_quiesce_init
)paren
suffix:semicolon
eof
