multiline_comment|/*&n; *  drivers/s390/char/tty3270.c&n; *    IBM/3270 Driver - tty functions.&n; *&n; *  Author(s):&n; *    Original 3270 Code for 2.4 written by Richard Hitt (UTS Global)&n; *    Rewritten for 2.5 by Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; *&t;-- Copyright (C) 2003 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/vt_kern.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &lt;asm/cio.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;raw3270.h&quot;
macro_line|#include &quot;keyboard.h&quot;
DECL|macro|TTY3270_CHAR_BUF_SIZE
mdefine_line|#define TTY3270_CHAR_BUF_SIZE 256
DECL|macro|TTY3270_OUTPUT_BUFFER_SIZE
mdefine_line|#define TTY3270_OUTPUT_BUFFER_SIZE 1024
DECL|macro|TTY3270_STRING_PAGES
mdefine_line|#define TTY3270_STRING_PAGES 5
DECL|variable|tty3270_driver
r_struct
id|tty_driver
op_star
id|tty3270_driver
suffix:semicolon
DECL|variable|tty3270_max_index
r_static
r_int
id|tty3270_max_index
suffix:semicolon
DECL|variable|tty3270_fn
r_struct
id|raw3270_fn
id|tty3270_fn
suffix:semicolon
DECL|struct|tty3270_cell
r_struct
id|tty3270_cell
(brace
DECL|member|character
r_int
r_char
id|character
suffix:semicolon
DECL|member|highlight
r_int
r_char
id|highlight
suffix:semicolon
DECL|member|f_color
r_int
r_char
id|f_color
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tty3270_line
r_struct
id|tty3270_line
(brace
DECL|member|cells
r_struct
id|tty3270_cell
op_star
id|cells
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|ESCAPE_NPAR
mdefine_line|#define ESCAPE_NPAR 8
multiline_comment|/*&n; * The main tty view data structure.&n; * FIXME:&n; * 1) describe line orientation &amp; lines list concept against screen&n; * 2) describe conversion of screen to lines&n; * 3) describe line format.&n; */
DECL|struct|tty3270
r_struct
id|tty3270
(brace
DECL|member|view
r_struct
id|raw3270_view
id|view
suffix:semicolon
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
multiline_comment|/* Pointer to tty structure */
DECL|member|freemem_pages
r_void
op_star
op_star
id|freemem_pages
suffix:semicolon
multiline_comment|/* Array of pages used for freemem. */
DECL|member|freemem
r_struct
id|list_head
id|freemem
suffix:semicolon
multiline_comment|/* List of free memory for strings. */
multiline_comment|/* Output stuff. */
DECL|member|lines
r_struct
id|list_head
id|lines
suffix:semicolon
multiline_comment|/* List of lines. */
DECL|member|update
r_struct
id|list_head
id|update
suffix:semicolon
multiline_comment|/* List of lines to update. */
DECL|member|wcc
r_int
r_char
id|wcc
suffix:semicolon
multiline_comment|/* Write control character. */
DECL|member|nr_lines
r_int
id|nr_lines
suffix:semicolon
multiline_comment|/* # lines in list. */
DECL|member|nr_up
r_int
id|nr_up
suffix:semicolon
multiline_comment|/* # lines up in history. */
DECL|member|update_flags
r_int
r_int
id|update_flags
suffix:semicolon
multiline_comment|/* Update indication bits. */
DECL|member|status
r_struct
id|string
op_star
id|status
suffix:semicolon
multiline_comment|/* Lower right of display. */
DECL|member|write
r_struct
id|raw3270_request
op_star
id|write
suffix:semicolon
multiline_comment|/* Single write request. */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
multiline_comment|/* Output delay timer. */
multiline_comment|/* Current tty screen. */
DECL|member|cx
DECL|member|cy
r_int
r_int
id|cx
comma
id|cy
suffix:semicolon
multiline_comment|/* Current output position. */
DECL|member|highlight
r_int
r_int
id|highlight
suffix:semicolon
multiline_comment|/* Blink/reverse/underscore */
DECL|member|f_color
r_int
r_int
id|f_color
suffix:semicolon
multiline_comment|/* Foreground color */
DECL|member|screen
r_struct
id|tty3270_line
op_star
id|screen
suffix:semicolon
multiline_comment|/* Input stuff. */
DECL|member|prompt
r_struct
id|string
op_star
id|prompt
suffix:semicolon
multiline_comment|/* Output string for input area. */
DECL|member|input
r_struct
id|string
op_star
id|input
suffix:semicolon
multiline_comment|/* Input string for read request. */
DECL|member|read
r_struct
id|raw3270_request
op_star
id|read
suffix:semicolon
multiline_comment|/* Single read request. */
DECL|member|kreset
r_struct
id|raw3270_request
op_star
id|kreset
suffix:semicolon
multiline_comment|/* Single keyboard reset request. */
DECL|member|inattr
r_int
r_char
id|inattr
suffix:semicolon
multiline_comment|/* Visible/invisible input. */
DECL|member|throttle
DECL|member|attn
r_int
id|throttle
comma
id|attn
suffix:semicolon
multiline_comment|/* tty throttle/unthrottle. */
DECL|member|readlet
r_struct
id|tasklet_struct
id|readlet
suffix:semicolon
multiline_comment|/* Tasklet to issue read request. */
DECL|member|kbd
r_struct
id|kbd_data
op_star
id|kbd
suffix:semicolon
multiline_comment|/* key_maps stuff. */
multiline_comment|/* Escape sequence parsing. */
DECL|member|esc_state
DECL|member|esc_ques
DECL|member|esc_npar
r_int
id|esc_state
comma
id|esc_ques
comma
id|esc_npar
suffix:semicolon
DECL|member|esc_par
r_int
id|esc_par
(braket
id|ESCAPE_NPAR
)braket
suffix:semicolon
DECL|member|saved_cx
DECL|member|saved_cy
r_int
r_int
id|saved_cx
comma
id|saved_cy
suffix:semicolon
DECL|member|saved_highlight
DECL|member|saved_f_color
r_int
r_int
id|saved_highlight
comma
id|saved_f_color
suffix:semicolon
multiline_comment|/* Command recalling. */
DECL|member|rcl_lines
r_struct
id|list_head
id|rcl_lines
suffix:semicolon
multiline_comment|/* List of recallable lines. */
DECL|member|rcl_walk
r_struct
id|list_head
op_star
id|rcl_walk
suffix:semicolon
multiline_comment|/* Point in rcl_lines list. */
DECL|member|rcl_nr
DECL|member|rcl_max
r_int
id|rcl_nr
comma
id|rcl_max
suffix:semicolon
multiline_comment|/* Number/max number of rcl_lines. */
multiline_comment|/* Character array for put_char/flush_chars. */
DECL|member|char_count
r_int
r_int
id|char_count
suffix:semicolon
DECL|member|char_buf
r_char
id|char_buf
(braket
id|TTY3270_CHAR_BUF_SIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* tty3270-&gt;update_flags. See tty3270_update for details. */
DECL|macro|TTY_UPDATE_ERASE
mdefine_line|#define TTY_UPDATE_ERASE&t;1&t;/* Use EWRITEA instead of WRITE. */
DECL|macro|TTY_UPDATE_LIST
mdefine_line|#define TTY_UPDATE_LIST&t;&t;2&t;/* Update lines in tty3270-&gt;update. */
DECL|macro|TTY_UPDATE_INPUT
mdefine_line|#define TTY_UPDATE_INPUT&t;4&t;/* Update input line. */
DECL|macro|TTY_UPDATE_STATUS
mdefine_line|#define TTY_UPDATE_STATUS&t;8&t;/* Update status line. */
DECL|macro|TTY_UPDATE_ALL
mdefine_line|#define TTY_UPDATE_ALL&t;&t;15
r_static
r_void
id|tty3270_update
c_func
(paren
r_struct
id|tty3270
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * Setup timeout for a device. On timeout trigger an update.&n; */
r_void
DECL|function|tty3270_set_timer
id|tty3270_set_timer
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|expires
)paren
(brace
r_if
c_cond
(paren
id|expires
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
)paren
(brace
id|raw3270_put_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
)paren
(brace
r_if
c_cond
(paren
id|mod_timer
c_func
(paren
op_amp
id|tp-&gt;timer
comma
id|jiffies
op_plus
id|expires
)paren
)paren
r_return
suffix:semicolon
)brace
id|raw3270_get_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
id|tp-&gt;timer.function
op_assign
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|tty3270_update
suffix:semicolon
id|tp-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|tp
suffix:semicolon
id|tp-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|expires
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The input line are the two last lines of the screen.&n; */
r_static
r_void
DECL|function|tty3270_update_prompt
id|tty3270_update_prompt
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_char
op_star
id|input
comma
r_int
id|count
)paren
(brace
r_struct
id|string
op_star
id|line
suffix:semicolon
r_int
r_int
id|off
suffix:semicolon
id|line
op_assign
id|tp-&gt;prompt
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
l_int|0
)paren
id|line-&gt;string
(braket
l_int|5
)braket
op_assign
id|TF_INMDT
suffix:semicolon
r_else
id|line-&gt;string
(braket
l_int|5
)braket
op_assign
id|tp-&gt;inattr
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|tp-&gt;view.cols
op_star
l_int|2
op_minus
l_int|11
)paren
id|count
op_assign
id|tp-&gt;view.cols
op_star
l_int|2
op_minus
l_int|11
suffix:semicolon
id|memcpy
c_func
(paren
id|line-&gt;string
op_plus
l_int|6
comma
id|input
comma
id|count
)paren
suffix:semicolon
id|line-&gt;string
(braket
l_int|6
op_plus
id|count
)braket
op_assign
id|TO_IC
suffix:semicolon
multiline_comment|/* Clear to end of input line. */
r_if
c_cond
(paren
id|count
OL
id|tp-&gt;view.cols
op_star
l_int|2
op_minus
l_int|11
)paren
(brace
id|line-&gt;string
(braket
l_int|7
op_plus
id|count
)braket
op_assign
id|TO_RA
suffix:semicolon
id|line-&gt;string
(braket
l_int|10
op_plus
id|count
)braket
op_assign
l_int|0
suffix:semicolon
id|off
op_assign
id|tp-&gt;view.cols
op_star
id|tp-&gt;view.rows
op_minus
l_int|9
suffix:semicolon
id|raw3270_buffer_address
c_func
(paren
id|tp-&gt;view.dev
comma
id|line-&gt;string
op_plus
id|count
op_plus
l_int|8
comma
id|off
)paren
suffix:semicolon
id|line-&gt;len
op_assign
l_int|11
op_plus
id|count
suffix:semicolon
)brace
r_else
id|line-&gt;len
op_assign
l_int|7
op_plus
id|count
suffix:semicolon
id|tp-&gt;update_flags
op_or_assign
id|TTY_UPDATE_INPUT
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_create_prompt
id|tty3270_create_prompt
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_static
r_const
r_int
r_char
id|blueprint
(braket
)braket
op_assign
(brace
id|TO_SBA
comma
l_int|0
comma
l_int|0
comma
l_int|0x6e
comma
id|TO_SF
comma
id|TF_INPUT
comma
multiline_comment|/* empty input string */
id|TO_IC
comma
id|TO_RA
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|string
op_star
id|line
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
id|line
op_assign
id|alloc_string
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
r_sizeof
(paren
id|blueprint
)paren
op_plus
id|tp-&gt;view.cols
op_star
l_int|2
op_minus
l_int|9
)paren
suffix:semicolon
id|tp-&gt;prompt
op_assign
id|line
suffix:semicolon
id|tp-&gt;inattr
op_assign
id|TF_INPUT
suffix:semicolon
multiline_comment|/* Copy blueprint to status line */
id|memcpy
c_func
(paren
id|line-&gt;string
comma
id|blueprint
comma
r_sizeof
(paren
id|blueprint
)paren
)paren
suffix:semicolon
id|line-&gt;len
op_assign
r_sizeof
(paren
id|blueprint
)paren
suffix:semicolon
multiline_comment|/* Set output offsets. */
id|offset
op_assign
id|tp-&gt;view.cols
op_star
(paren
id|tp-&gt;view.rows
op_minus
l_int|2
)paren
suffix:semicolon
id|raw3270_buffer_address
c_func
(paren
id|tp-&gt;view.dev
comma
id|line-&gt;string
op_plus
l_int|1
comma
id|offset
)paren
suffix:semicolon
id|offset
op_assign
id|tp-&gt;view.cols
op_star
id|tp-&gt;view.rows
op_minus
l_int|9
suffix:semicolon
id|raw3270_buffer_address
c_func
(paren
id|tp-&gt;view.dev
comma
id|line-&gt;string
op_plus
l_int|8
comma
id|offset
)paren
suffix:semicolon
multiline_comment|/* Allocate input string for reading. */
id|tp-&gt;input
op_assign
id|alloc_string
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
id|tp-&gt;view.cols
op_star
l_int|2
op_minus
l_int|9
op_plus
l_int|6
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The status line is the last line of the screen. It shows the string&n; * &quot;Running&quot;/&quot;Holding&quot; in the lower right corner of the screen.&n; */
r_static
r_void
DECL|function|tty3270_update_status
id|tty3270_update_status
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_char
op_star
id|str
suffix:semicolon
id|str
op_assign
(paren
id|tp-&gt;nr_up
op_ne
l_int|0
)paren
ques
c_cond
l_string|&quot;History&quot;
suffix:colon
l_string|&quot;Running&quot;
suffix:semicolon
id|memcpy
c_func
(paren
id|tp-&gt;status-&gt;string
op_plus
l_int|8
comma
id|str
comma
l_int|7
)paren
suffix:semicolon
id|codepage_convert
c_func
(paren
id|tp-&gt;view.ascebc
comma
id|tp-&gt;status-&gt;string
op_plus
l_int|8
comma
l_int|7
)paren
suffix:semicolon
id|tp-&gt;update_flags
op_or_assign
id|TTY_UPDATE_STATUS
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_create_status
id|tty3270_create_status
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_static
r_const
r_int
r_char
id|blueprint
(braket
)braket
op_assign
(brace
id|TO_SBA
comma
l_int|0
comma
l_int|0
comma
id|TO_SF
comma
id|TF_LOG
comma
id|TO_SA
comma
id|TAT_COLOR
comma
id|TAC_GREEN
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|TO_SF
comma
id|TF_LOG
comma
id|TO_SA
comma
id|TAT_COLOR
comma
id|TAC_RESET
)brace
suffix:semicolon
r_struct
id|string
op_star
id|line
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
id|line
op_assign
id|alloc_string
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
r_sizeof
(paren
id|blueprint
)paren
)paren
suffix:semicolon
id|tp-&gt;status
op_assign
id|line
suffix:semicolon
multiline_comment|/* Copy blueprint to status line */
id|memcpy
c_func
(paren
id|line-&gt;string
comma
id|blueprint
comma
r_sizeof
(paren
id|blueprint
)paren
)paren
suffix:semicolon
multiline_comment|/* Set address to start of status string (= last 9 characters). */
id|offset
op_assign
id|tp-&gt;view.cols
op_star
id|tp-&gt;view.rows
op_minus
l_int|9
suffix:semicolon
id|raw3270_buffer_address
c_func
(paren
id|tp-&gt;view.dev
comma
id|line-&gt;string
op_plus
l_int|1
comma
id|offset
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set output offsets to 3270 datastream fragment of a tty string.&n; * (TO_SBA offset at the start and TO_RA offset at the end of the string)&n; */
r_static
r_void
DECL|function|tty3270_update_string
id|tty3270_update_string
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_struct
id|string
op_star
id|line
comma
r_int
id|nr
)paren
(brace
r_int
r_char
op_star
id|cp
suffix:semicolon
id|raw3270_buffer_address
c_func
(paren
id|tp-&gt;view.dev
comma
id|line-&gt;string
op_plus
l_int|1
comma
id|tp-&gt;view.cols
op_star
id|nr
)paren
suffix:semicolon
id|cp
op_assign
id|line-&gt;string
op_plus
id|line-&gt;len
op_minus
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_eq
id|TO_RA
)paren
id|raw3270_buffer_address
c_func
(paren
id|tp-&gt;view.dev
comma
id|cp
op_plus
l_int|1
comma
id|tp-&gt;view.cols
op_star
(paren
id|nr
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Rebuild update list to print all lines.&n; */
r_static
r_void
DECL|function|tty3270_rebuild_update
id|tty3270_rebuild_update
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_struct
id|string
op_star
id|s
comma
op_star
id|n
suffix:semicolon
r_int
id|line
comma
id|nr_up
suffix:semicolon
multiline_comment|/* &n;&t; * Throw away update list and create a new one,&n;&t; * containing all lines that will fit on the screen.&n;&t; */
id|list_for_each_entry_safe
c_func
(paren
id|s
comma
id|n
comma
op_amp
id|tp-&gt;update
comma
id|update
)paren
id|list_del_init
c_func
(paren
op_amp
id|s-&gt;update
)paren
suffix:semicolon
id|line
op_assign
id|tp-&gt;view.rows
op_minus
l_int|3
suffix:semicolon
id|nr_up
op_assign
id|tp-&gt;nr_up
suffix:semicolon
id|list_for_each_entry_reverse
c_func
(paren
id|s
comma
op_amp
id|tp-&gt;lines
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|nr_up
OG
l_int|0
)paren
(brace
id|nr_up
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|tty3270_update_string
c_func
(paren
id|tp
comma
id|s
comma
id|line
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|s-&gt;update
comma
op_amp
id|tp-&gt;update
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|line
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|tp-&gt;update_flags
op_or_assign
id|TTY_UPDATE_LIST
suffix:semicolon
)brace
multiline_comment|/*&n; * Alloc string for size bytes. If there is not enough room in&n; * freemem, free strings until there is room.&n; */
r_static
r_struct
id|string
op_star
DECL|function|tty3270_alloc_string
id|tty3270_alloc_string
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|size
)paren
(brace
r_struct
id|string
op_star
id|s
comma
op_star
id|n
suffix:semicolon
id|s
op_assign
id|alloc_string
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
)paren
r_return
id|s
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|s
comma
id|n
comma
op_amp
id|tp-&gt;lines
comma
id|list
)paren
(brace
id|BUG_ON
c_func
(paren
id|tp-&gt;nr_lines
op_le
id|tp-&gt;view.rows
op_minus
l_int|2
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|s-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|s-&gt;update
)paren
)paren
id|list_del
c_func
(paren
op_amp
id|s-&gt;update
)paren
suffix:semicolon
id|tp-&gt;nr_lines
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|free_string
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
id|s
)paren
op_ge
id|size
)paren
r_break
suffix:semicolon
)brace
id|s
op_assign
id|alloc_string
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
id|size
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;nr_up
op_ne
l_int|0
op_logical_and
id|tp-&gt;nr_up
op_plus
id|tp-&gt;view.rows
op_minus
l_int|2
op_ge
id|tp-&gt;nr_lines
)paren
(brace
id|tp-&gt;nr_up
op_assign
id|tp-&gt;nr_lines
op_minus
id|tp-&gt;view.rows
op_plus
l_int|2
suffix:semicolon
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_update_status
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
r_return
id|s
suffix:semicolon
)brace
multiline_comment|/*&n; * Add an empty line to the list.&n; */
r_static
r_void
DECL|function|tty3270_blank_line
id|tty3270_blank_line
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_static
r_const
r_int
r_char
id|blueprint
(braket
)braket
op_assign
(brace
id|TO_SBA
comma
l_int|0
comma
l_int|0
comma
id|TO_SA
comma
id|TAT_EXTHI
comma
id|TAX_RESET
comma
id|TO_SA
comma
id|TAT_COLOR
comma
id|TAC_RESET
comma
id|TO_RA
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|string
op_star
id|s
suffix:semicolon
id|s
op_assign
id|tty3270_alloc_string
c_func
(paren
id|tp
comma
r_sizeof
(paren
id|blueprint
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|s-&gt;string
comma
id|blueprint
comma
r_sizeof
(paren
id|blueprint
)paren
)paren
suffix:semicolon
id|s-&gt;len
op_assign
r_sizeof
(paren
id|blueprint
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|s-&gt;list
comma
op_amp
id|tp-&gt;lines
)paren
suffix:semicolon
id|tp-&gt;nr_lines
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;nr_up
op_ne
l_int|0
)paren
id|tp-&gt;nr_up
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n; * Write request completion callback.&n; */
r_static
r_void
DECL|function|tty3270_write_callback
id|tty3270_write_callback
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
id|tp
op_assign
(paren
r_struct
id|tty3270
op_star
)paren
id|rq-&gt;view
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;rc
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Write wasn&squot;t successfull. Refresh all. */
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tp-&gt;update_flags
op_assign
id|TTY_UPDATE_ALL
suffix:semicolon
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
id|raw3270_request_reset
c_func
(paren
id|rq
)paren
suffix:semicolon
id|xchg
c_func
(paren
op_amp
id|tp-&gt;write
comma
id|rq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Update 3270 display.&n; */
r_static
r_void
DECL|function|tty3270_update
id|tty3270_update
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_static
r_char
id|invalid_sba
(braket
l_int|2
)braket
op_assign
(brace
l_int|0xff
comma
l_int|0xff
)brace
suffix:semicolon
r_struct
id|raw3270_request
op_star
id|wrq
suffix:semicolon
r_int
r_int
id|updated
suffix:semicolon
r_struct
id|string
op_star
id|s
comma
op_star
id|n
suffix:semicolon
r_char
op_star
id|sba
comma
op_star
id|str
suffix:semicolon
r_int
id|rc
comma
id|len
suffix:semicolon
id|wrq
op_assign
id|xchg
c_func
(paren
op_amp
id|tp-&gt;write
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wrq
)paren
(brace
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
id|updated
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;update_flags
op_amp
id|TTY_UPDATE_ERASE
)paren
(brace
multiline_comment|/* Use erase write alternate to erase display. */
id|raw3270_request_set_cmd
c_func
(paren
id|wrq
comma
id|TC_EWRITEA
)paren
suffix:semicolon
id|updated
op_or_assign
id|TTY_UPDATE_ERASE
suffix:semicolon
)brace
r_else
id|raw3270_request_set_cmd
c_func
(paren
id|wrq
comma
id|TC_WRITE
)paren
suffix:semicolon
id|raw3270_request_add_data
c_func
(paren
id|wrq
comma
op_amp
id|tp-&gt;wcc
comma
l_int|1
)paren
suffix:semicolon
id|tp-&gt;wcc
op_assign
id|TW_NONE
suffix:semicolon
multiline_comment|/*&n;&t; * Update status line.&n;&t; */
r_if
c_cond
(paren
id|tp-&gt;update_flags
op_amp
id|TTY_UPDATE_STATUS
)paren
r_if
c_cond
(paren
id|raw3270_request_add_data
c_func
(paren
id|wrq
comma
id|tp-&gt;status-&gt;string
comma
id|tp-&gt;status-&gt;len
)paren
op_eq
l_int|0
)paren
id|updated
op_or_assign
id|TTY_UPDATE_STATUS
suffix:semicolon
multiline_comment|/*&n;&t; * Write input line.&n;&t; */
r_if
c_cond
(paren
id|tp-&gt;update_flags
op_amp
id|TTY_UPDATE_INPUT
)paren
r_if
c_cond
(paren
id|raw3270_request_add_data
c_func
(paren
id|wrq
comma
id|tp-&gt;prompt-&gt;string
comma
id|tp-&gt;prompt-&gt;len
)paren
op_eq
l_int|0
)paren
id|updated
op_or_assign
id|TTY_UPDATE_INPUT
suffix:semicolon
id|sba
op_assign
id|invalid_sba
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;update_flags
op_amp
id|TTY_UPDATE_LIST
)paren
(brace
multiline_comment|/* Write strings in the update list to the screen. */
id|list_for_each_entry_safe
c_func
(paren
id|s
comma
id|n
comma
op_amp
id|tp-&gt;update
comma
id|update
)paren
(brace
id|str
op_assign
id|s-&gt;string
suffix:semicolon
id|len
op_assign
id|s-&gt;len
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Skip TO_SBA at the start of the string if the&n;&t;&t;&t; * last output position matches the start address&n;&t;&t;&t; * of this line.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|s-&gt;string
(braket
l_int|1
)braket
op_eq
id|sba
(braket
l_int|0
)braket
op_logical_and
id|s-&gt;string
(braket
l_int|2
)braket
op_eq
id|sba
(braket
l_int|1
)braket
)paren
id|str
op_add_assign
l_int|3
comma
id|len
op_sub_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|raw3270_request_add_data
c_func
(paren
id|wrq
comma
id|str
comma
id|len
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|s-&gt;update
)paren
suffix:semicolon
id|sba
op_assign
id|s-&gt;string
op_plus
id|s-&gt;len
op_minus
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|tp-&gt;update
)paren
)paren
id|updated
op_or_assign
id|TTY_UPDATE_LIST
suffix:semicolon
)brace
id|wrq-&gt;callback
op_assign
id|tty3270_write_callback
suffix:semicolon
id|rc
op_assign
id|raw3270_start
c_func
(paren
op_amp
id|tp-&gt;view
comma
id|wrq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|tp-&gt;update_flags
op_and_assign
op_complement
id|updated
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;update_flags
)paren
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|raw3270_request_reset
c_func
(paren
id|wrq
)paren
suffix:semicolon
id|xchg
c_func
(paren
op_amp
id|tp-&gt;write
comma
id|wrq
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
id|raw3270_put_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Command recalling.&n; */
r_static
r_void
DECL|function|tty3270_rcl_add
id|tty3270_rcl_add
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_char
op_star
id|input
comma
r_int
id|len
)paren
(brace
r_struct
id|string
op_star
id|s
suffix:semicolon
id|tp-&gt;rcl_walk
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;rcl_nr
op_ge
id|tp-&gt;rcl_max
)paren
(brace
id|s
op_assign
id|list_entry
c_func
(paren
id|tp-&gt;rcl_lines.next
comma
r_struct
id|string
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|s-&gt;list
)paren
suffix:semicolon
id|free_string
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
id|s
)paren
suffix:semicolon
id|tp-&gt;rcl_nr
op_decrement
suffix:semicolon
)brace
id|s
op_assign
id|tty3270_alloc_string
c_func
(paren
id|tp
comma
id|len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|s-&gt;string
comma
id|input
comma
id|len
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|s-&gt;list
comma
op_amp
id|tp-&gt;rcl_lines
)paren
suffix:semicolon
id|tp-&gt;rcl_nr
op_increment
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_rcl_backward
id|tty3270_rcl_backward
c_func
(paren
r_struct
id|kbd_data
op_star
id|kbd
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_struct
id|string
op_star
id|s
suffix:semicolon
id|tp
op_assign
id|kbd-&gt;tty-&gt;driver_data
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;inattr
op_eq
id|TF_INPUT
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;rcl_walk
op_logical_and
id|tp-&gt;rcl_walk-&gt;prev
op_ne
op_amp
id|tp-&gt;rcl_lines
)paren
id|tp-&gt;rcl_walk
op_assign
id|tp-&gt;rcl_walk-&gt;prev
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|tp-&gt;rcl_lines
)paren
)paren
id|tp-&gt;rcl_walk
op_assign
id|tp-&gt;rcl_lines.prev
suffix:semicolon
id|s
op_assign
id|tp-&gt;rcl_walk
ques
c_cond
id|list_entry
c_func
(paren
id|tp-&gt;rcl_walk
comma
r_struct
id|string
comma
id|list
)paren
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;rcl_walk
)paren
(brace
id|s
op_assign
id|list_entry
c_func
(paren
id|tp-&gt;rcl_walk
comma
r_struct
id|string
comma
id|list
)paren
suffix:semicolon
id|tty3270_update_prompt
c_func
(paren
id|tp
comma
id|s-&gt;string
comma
id|s-&gt;len
)paren
suffix:semicolon
)brace
r_else
id|tty3270_update_prompt
c_func
(paren
id|tp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Deactivate tty view.&n; */
r_static
r_void
DECL|function|tty3270_exit_tty
id|tty3270_exit_tty
c_func
(paren
r_struct
id|kbd_data
op_star
id|kbd
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
id|tp
op_assign
id|kbd-&gt;tty-&gt;driver_data
suffix:semicolon
id|raw3270_deactivate_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Scroll forward in history.&n; */
r_static
r_void
DECL|function|tty3270_scroll_forward
id|tty3270_scroll_forward
c_func
(paren
r_struct
id|kbd_data
op_star
id|kbd
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_int
id|nr_up
suffix:semicolon
id|tp
op_assign
id|kbd-&gt;tty-&gt;driver_data
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
id|nr_up
op_assign
id|tp-&gt;nr_up
op_minus
id|tp-&gt;view.rows
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|nr_up
OL
l_int|0
)paren
id|nr_up
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|nr_up
op_ne
id|tp-&gt;nr_up
)paren
(brace
id|tp-&gt;nr_up
op_assign
id|nr_up
suffix:semicolon
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_update_status
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Scroll backward in history.&n; */
r_static
r_void
DECL|function|tty3270_scroll_backward
id|tty3270_scroll_backward
c_func
(paren
r_struct
id|kbd_data
op_star
id|kbd
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_int
id|nr_up
suffix:semicolon
id|tp
op_assign
id|kbd-&gt;tty-&gt;driver_data
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
id|nr_up
op_assign
id|tp-&gt;nr_up
op_plus
id|tp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|nr_up
op_plus
id|tp-&gt;view.rows
op_minus
l_int|2
OG
id|tp-&gt;nr_lines
)paren
id|nr_up
op_assign
id|tp-&gt;nr_lines
op_minus
id|tp-&gt;view.rows
op_plus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|nr_up
op_ne
id|tp-&gt;nr_up
)paren
(brace
id|tp-&gt;nr_up
op_assign
id|nr_up
suffix:semicolon
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_update_status
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Pass input line to tty.&n; */
r_static
r_void
DECL|function|tty3270_read_tasklet
id|tty3270_read_tasklet
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rrq
)paren
(brace
r_static
r_char
id|kreset_data
op_assign
id|TW_KR
suffix:semicolon
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_char
op_star
id|input
suffix:semicolon
r_int
id|len
suffix:semicolon
id|tp
op_assign
(paren
r_struct
id|tty3270
op_star
)paren
id|rrq-&gt;view
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Two AID keys are special: For 0x7d (enter) the input line&n;&t; * has to be emitted to the tty and for 0x6d the screen&n;&t; * needs to be redrawn.&n;&t; */
id|input
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;input-&gt;string
(braket
l_int|0
)braket
op_eq
l_int|0x7d
)paren
(brace
multiline_comment|/* Enter: write input to tty. */
id|input
op_assign
id|tp-&gt;input-&gt;string
op_plus
l_int|6
suffix:semicolon
id|len
op_assign
id|tp-&gt;input-&gt;len
op_minus
l_int|6
op_minus
id|rrq-&gt;rescnt
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;inattr
op_ne
id|TF_INPUTN
)paren
id|tty3270_rcl_add
c_func
(paren
id|tp
comma
id|input
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;nr_up
OG
l_int|0
)paren
(brace
id|tp-&gt;nr_up
op_assign
l_int|0
suffix:semicolon
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_update_status
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear input area. */
id|tty3270_update_prompt
c_func
(paren
id|tp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;input-&gt;string
(braket
l_int|0
)braket
op_eq
l_int|0x6d
)paren
(brace
multiline_comment|/* Display has been cleared. Redraw. */
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tp-&gt;update_flags
op_assign
id|TTY_UPDATE_ALL
suffix:semicolon
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
multiline_comment|/* Start keyboard reset command. */
id|raw3270_request_reset
c_func
(paren
id|tp-&gt;kreset
)paren
suffix:semicolon
id|raw3270_request_set_cmd
c_func
(paren
id|tp-&gt;kreset
comma
id|TC_WRITE
)paren
suffix:semicolon
id|raw3270_request_add_data
c_func
(paren
id|tp-&gt;kreset
comma
op_amp
id|kreset_data
comma
l_int|1
)paren
suffix:semicolon
id|raw3270_start
c_func
(paren
op_amp
id|tp-&gt;view
comma
id|tp-&gt;kreset
)paren
suffix:semicolon
multiline_comment|/* Emit input string. */
r_if
c_cond
(paren
id|tp-&gt;tty
)paren
(brace
r_while
c_loop
(paren
id|len
op_decrement
OG
l_int|0
)paren
id|kbd_keycode
c_func
(paren
id|tp-&gt;kbd
comma
op_star
id|input
op_increment
)paren
suffix:semicolon
multiline_comment|/* Emit keycode for AID byte. */
id|kbd_keycode
c_func
(paren
id|tp-&gt;kbd
comma
l_int|256
op_plus
id|tp-&gt;input-&gt;string
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|raw3270_request_reset
c_func
(paren
id|rrq
)paren
suffix:semicolon
id|xchg
c_func
(paren
op_amp
id|tp-&gt;read
comma
id|rrq
)paren
suffix:semicolon
id|raw3270_put_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Read request completion callback.&n; */
r_static
r_void
DECL|function|tty3270_read_callback
id|tty3270_read_callback
c_func
(paren
r_struct
id|raw3270_request
op_star
id|rq
comma
r_void
op_star
id|data
)paren
(brace
id|raw3270_get_view
c_func
(paren
id|rq-&gt;view
)paren
suffix:semicolon
multiline_comment|/* Schedule tasklet to pass input to tty. */
id|tasklet_schedule
c_func
(paren
op_amp
(paren
(paren
r_struct
id|tty3270
op_star
)paren
id|rq-&gt;view
)paren
op_member_access_from_pointer
id|readlet
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Issue a read request. Call with device lock.&n; */
r_static
r_void
DECL|function|tty3270_issue_read
id|tty3270_issue_read
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|lock
)paren
(brace
r_struct
id|raw3270_request
op_star
id|rrq
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rrq
op_assign
id|xchg
c_func
(paren
op_amp
id|tp-&gt;read
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rrq
)paren
multiline_comment|/* Read already scheduled. */
r_return
suffix:semicolon
id|rrq-&gt;callback
op_assign
id|tty3270_read_callback
suffix:semicolon
id|rrq-&gt;callback_data
op_assign
id|tp
suffix:semicolon
id|raw3270_request_set_cmd
c_func
(paren
id|rrq
comma
id|TC_READMOD
)paren
suffix:semicolon
id|raw3270_request_set_data
c_func
(paren
id|rrq
comma
id|tp-&gt;input-&gt;string
comma
id|tp-&gt;input-&gt;len
)paren
suffix:semicolon
multiline_comment|/* Issue the read modified request. */
r_if
c_cond
(paren
id|lock
)paren
(brace
id|rc
op_assign
id|raw3270_start
c_func
(paren
op_amp
id|tp-&gt;view
comma
id|rrq
)paren
suffix:semicolon
)brace
r_else
id|rc
op_assign
id|raw3270_start_irq
c_func
(paren
op_amp
id|tp-&gt;view
comma
id|rrq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|raw3270_request_reset
c_func
(paren
id|rrq
)paren
suffix:semicolon
id|xchg
c_func
(paren
op_amp
id|tp-&gt;read
comma
id|rrq
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Switch to the tty view.&n; */
r_static
r_int
DECL|function|tty3270_activate
id|tty3270_activate
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|tp
op_assign
(paren
r_struct
id|tty3270
op_star
)paren
id|view
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|tp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|tp-&gt;nr_up
op_assign
l_int|0
suffix:semicolon
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_update_status
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tp-&gt;update_flags
op_assign
id|TTY_UPDATE_ALL
suffix:semicolon
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|tp-&gt;view.lock
comma
id|flags
)paren
suffix:semicolon
id|start_tty
c_func
(paren
id|tp-&gt;tty
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_deactivate
id|tty3270_deactivate
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
id|tp
op_assign
(paren
r_struct
id|tty3270
op_star
)paren
id|view
suffix:semicolon
r_if
c_cond
(paren
id|tp
op_logical_and
id|tp-&gt;tty
)paren
id|stop_tty
c_func
(paren
id|tp-&gt;tty
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|tty3270_irq
id|tty3270_irq
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_struct
id|raw3270_request
op_star
id|rq
comma
r_struct
id|irb
op_star
id|irb
)paren
(brace
multiline_comment|/* Handle ATTN. Schedule tasklet to read aid. */
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_ATTENTION
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;throttle
)paren
id|tty3270_issue_read
c_func
(paren
id|tp
comma
l_int|0
)paren
suffix:semicolon
r_else
id|tp-&gt;attn
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rq
)paren
(brace
r_if
c_cond
(paren
id|irb-&gt;scsw.dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
id|rq-&gt;rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_else
multiline_comment|/* Normal end. Copy residual count. */
id|rq-&gt;rescnt
op_assign
id|irb-&gt;scsw.count
suffix:semicolon
)brace
r_return
id|RAW3270_IO_DONE
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate tty3270 structure.&n; */
r_static
r_struct
id|tty3270
op_star
DECL|function|tty3270_alloc_view
id|tty3270_alloc_view
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_int
id|pages
suffix:semicolon
id|tp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|tty3270
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_goto
id|out_err
suffix:semicolon
id|memset
c_func
(paren
id|tp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tty3270
)paren
)paren
suffix:semicolon
id|tp-&gt;freemem_pages
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|TTY3270_STRING_PAGES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;freemem_pages
)paren
r_goto
id|out_tp
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|tp-&gt;freemem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pages
op_assign
l_int|0
suffix:semicolon
id|pages
OL
id|TTY3270_STRING_PAGES
suffix:semicolon
id|pages
op_increment
)paren
(brace
id|tp-&gt;freemem_pages
(braket
id|pages
)braket
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;freemem_pages
(braket
id|pages
)braket
)paren
r_goto
id|out_pages
suffix:semicolon
id|add_string_memory
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
id|tp-&gt;freemem_pages
(braket
id|pages
)braket
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
id|tp-&gt;write
op_assign
id|raw3270_request_alloc
c_func
(paren
id|TTY3270_OUTPUT_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;write
)paren
r_goto
id|out_pages
suffix:semicolon
id|tp-&gt;read
op_assign
id|raw3270_request_alloc
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;read
)paren
r_goto
id|out_write
suffix:semicolon
id|tp-&gt;kreset
op_assign
id|raw3270_request_alloc
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;kreset
)paren
r_goto
id|out_read
suffix:semicolon
id|tp-&gt;kbd
op_assign
id|kbd_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;kbd
)paren
r_goto
id|out_reset
suffix:semicolon
r_return
id|tp
suffix:semicolon
id|out_reset
suffix:colon
id|raw3270_request_free
c_func
(paren
id|tp-&gt;kreset
)paren
suffix:semicolon
id|out_read
suffix:colon
id|raw3270_request_free
c_func
(paren
id|tp-&gt;read
)paren
suffix:semicolon
id|out_write
suffix:colon
id|raw3270_request_free
c_func
(paren
id|tp-&gt;write
)paren
suffix:semicolon
id|out_pages
suffix:colon
r_while
c_loop
(paren
id|pages
op_decrement
)paren
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|tp-&gt;freemem_pages
(braket
id|pages
)braket
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp-&gt;freemem_pages
)paren
suffix:semicolon
id|out_tp
suffix:colon
id|kfree
c_func
(paren
id|tp
)paren
suffix:semicolon
id|out_err
suffix:colon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Free tty3270 structure.&n; */
r_static
r_void
DECL|function|tty3270_free_view
id|tty3270_free_view
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_int
id|pages
suffix:semicolon
id|kbd_free
c_func
(paren
id|tp-&gt;kbd
)paren
suffix:semicolon
id|raw3270_request_free
c_func
(paren
id|tp-&gt;kreset
)paren
suffix:semicolon
id|raw3270_request_free
c_func
(paren
id|tp-&gt;read
)paren
suffix:semicolon
id|raw3270_request_free
c_func
(paren
id|tp-&gt;write
)paren
suffix:semicolon
r_for
c_loop
(paren
id|pages
op_assign
l_int|0
suffix:semicolon
id|pages
OL
id|TTY3270_STRING_PAGES
suffix:semicolon
id|pages
op_increment
)paren
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|tp-&gt;freemem_pages
(braket
id|pages
)braket
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp-&gt;freemem_pages
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate tty3270 screen.&n; */
r_static
r_int
DECL|function|tty3270_alloc_screen
id|tty3270_alloc_screen
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_int
r_int
id|size
suffix:semicolon
r_int
id|lines
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|tty3270_line
)paren
op_star
(paren
id|tp-&gt;view.rows
op_minus
l_int|2
)paren
suffix:semicolon
id|tp-&gt;screen
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;screen
)paren
r_goto
id|out_err
suffix:semicolon
id|memset
c_func
(paren
id|tp-&gt;screen
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_for
c_loop
(paren
id|lines
op_assign
l_int|0
suffix:semicolon
id|lines
OL
id|tp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
id|lines
op_increment
)paren
(brace
id|size
op_assign
r_sizeof
(paren
r_struct
id|tty3270_cell
)paren
op_star
id|tp-&gt;view.cols
suffix:semicolon
id|tp-&gt;screen
(braket
id|lines
)braket
dot
id|cells
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;screen
(braket
id|lines
)braket
dot
id|cells
)paren
r_goto
id|out_screen
suffix:semicolon
id|memset
c_func
(paren
id|tp-&gt;screen
(braket
id|lines
)braket
dot
id|cells
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_screen
suffix:colon
r_while
c_loop
(paren
id|lines
op_decrement
)paren
id|kfree
c_func
(paren
id|tp-&gt;screen
(braket
id|lines
)braket
dot
id|cells
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp-&gt;screen
)paren
suffix:semicolon
id|out_err
suffix:colon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n; * Free tty3270 screen.&n; */
r_static
r_void
DECL|function|tty3270_free_screen
id|tty3270_free_screen
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_int
id|lines
suffix:semicolon
r_for
c_loop
(paren
id|lines
op_assign
l_int|0
suffix:semicolon
id|lines
OL
id|tp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
id|lines
op_increment
)paren
id|kfree
c_func
(paren
id|tp-&gt;screen
(braket
id|lines
)braket
dot
id|cells
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp-&gt;screen
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Unlink tty3270 data structure from tty.&n; */
r_static
r_void
DECL|function|tty3270_release
id|tty3270_release
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|tp
op_assign
(paren
r_struct
id|tty3270
op_star
)paren
id|view
suffix:semicolon
id|tty
op_assign
id|tp-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
(brace
id|tty-&gt;driver_data
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tty
op_assign
id|tp-&gt;kbd-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|tty_hangup
c_func
(paren
id|tty
)paren
suffix:semicolon
id|raw3270_put_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Free tty3270 data structure&n; */
r_static
r_void
DECL|function|tty3270_free
id|tty3270_free
c_func
(paren
r_struct
id|raw3270_view
op_star
id|view
)paren
(brace
id|tty3270_free_screen
c_func
(paren
(paren
r_struct
id|tty3270
op_star
)paren
id|view
)paren
suffix:semicolon
id|tty3270_free_view
c_func
(paren
(paren
r_struct
id|tty3270
op_star
)paren
id|view
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Delayed freeing of tty3270 views.&n; */
r_static
r_void
DECL|function|tty3270_del_views
id|tty3270_del_views
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tty3270_max_index
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp
op_assign
(paren
r_struct
id|tty3270
op_star
)paren
id|raw3270_find_view
c_func
(paren
op_amp
id|tty3270_fn
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|tp
)paren
)paren
id|raw3270_del_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
)brace
)brace
DECL|variable|tty3270_fn
r_struct
id|raw3270_fn
id|tty3270_fn
op_assign
(brace
dot
id|activate
op_assign
id|tty3270_activate
comma
dot
id|deactivate
op_assign
id|tty3270_deactivate
comma
dot
id|intv
op_assign
(paren
r_void
op_star
)paren
id|tty3270_irq
comma
dot
id|release
op_assign
id|tty3270_release
comma
dot
id|free
op_assign
id|tty3270_free
)brace
suffix:semicolon
multiline_comment|/*&n; * This routine is called whenever a 3270 tty is opened.&n; */
r_static
r_int
DECL|function|tty3270_open
id|tty3270_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_int
id|i
comma
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;count
OG
l_int|1
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Check if the tty3270 is already there. */
id|tp
op_assign
(paren
r_struct
id|tty3270
op_star
)paren
id|raw3270_find_view
c_func
(paren
op_amp
id|tty3270_fn
comma
id|tty-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|tp
)paren
)paren
(brace
id|tty-&gt;driver_data
op_assign
id|tp
suffix:semicolon
id|tty-&gt;winsize.ws_row
op_assign
id|tp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
id|tty-&gt;winsize.ws_col
op_assign
id|tp-&gt;view.cols
suffix:semicolon
id|tty-&gt;low_latency
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tty
op_assign
id|tty
suffix:semicolon
id|tp-&gt;kbd-&gt;tty
op_assign
id|tty
suffix:semicolon
id|tp-&gt;inattr
op_assign
id|TF_INPUT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty3270_max_index
OL
id|tty-&gt;index
op_plus
l_int|1
)paren
id|tty3270_max_index
op_assign
id|tty-&gt;index
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Quick exit if there is no device for tty-&gt;index. */
r_if
c_cond
(paren
id|PTR_ERR
c_func
(paren
id|tp
)paren
op_eq
op_minus
id|ENODEV
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* Allocate tty3270 structure on first open. */
id|tp
op_assign
id|tty3270_alloc_view
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|tp
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|tp
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|tp-&gt;lines
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|tp-&gt;update
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|tp-&gt;rcl_lines
)paren
suffix:semicolon
id|tp-&gt;rcl_max
op_assign
l_int|20
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|tp-&gt;readlet
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|tty3270_read_tasklet
comma
(paren
r_int
r_int
)paren
id|tp-&gt;read
)paren
suffix:semicolon
id|rc
op_assign
id|raw3270_add_view
c_func
(paren
op_amp
id|tp-&gt;view
comma
op_amp
id|tty3270_fn
comma
id|tty-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|tty3270_free_view
c_func
(paren
id|tp
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|tty3270_alloc_screen
c_func
(paren
id|tp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|raw3270_del_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
id|raw3270_put_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|tp-&gt;tty
op_assign
id|tty
suffix:semicolon
id|tty-&gt;low_latency
op_assign
l_int|0
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|tp
suffix:semicolon
id|tty-&gt;winsize.ws_row
op_assign
id|tp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
id|tty-&gt;winsize.ws_col
op_assign
id|tp-&gt;view.cols
suffix:semicolon
id|tty3270_create_prompt
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_create_status
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_update_status
c_func
(paren
id|tp
)paren
suffix:semicolon
multiline_comment|/* Create blank line for every line in the tty output area. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
id|i
op_increment
)paren
id|tty3270_blank_line
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tp-&gt;kbd-&gt;tty
op_assign
id|tty
suffix:semicolon
id|tp-&gt;kbd-&gt;fn_handler
(braket
id|KVAL
c_func
(paren
id|K_INCRCONSOLE
)paren
)braket
op_assign
id|tty3270_exit_tty
suffix:semicolon
id|tp-&gt;kbd-&gt;fn_handler
(braket
id|KVAL
c_func
(paren
id|K_SCROLLBACK
)paren
)braket
op_assign
id|tty3270_scroll_backward
suffix:semicolon
id|tp-&gt;kbd-&gt;fn_handler
(braket
id|KVAL
c_func
(paren
id|K_SCROLLFORW
)paren
)braket
op_assign
id|tty3270_scroll_forward
suffix:semicolon
id|tp-&gt;kbd-&gt;fn_handler
(braket
id|KVAL
c_func
(paren
id|K_CONS
)paren
)braket
op_assign
id|tty3270_rcl_backward
suffix:semicolon
id|kbd_ascebc
c_func
(paren
id|tp-&gt;kbd
comma
id|tp-&gt;view.ascebc
)paren
suffix:semicolon
id|raw3270_activate_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called when the 3270 tty is closed. We wait&n; * for the remaining request to be completed. Then we clean up.&n; */
r_static
r_void
DECL|function|tty3270_close
id|tty3270_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;count
OG
l_int|1
)paren
r_return
suffix:semicolon
id|tp
op_assign
(paren
r_struct
id|tty3270
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|tp
)paren
(brace
id|tty-&gt;driver_data
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tty
op_assign
id|tp-&gt;kbd-&gt;tty
op_assign
l_int|0
suffix:semicolon
id|raw3270_put_view
c_func
(paren
op_amp
id|tp-&gt;view
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * We always have room.&n; */
r_static
r_int
DECL|function|tty3270_write_room
id|tty3270_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
id|INT_MAX
suffix:semicolon
)brace
multiline_comment|/*&n; * Insert character into the screen at the current position with the&n; * current color and highlight. This function does NOT do cursor movement.&n; */
r_static
r_void
DECL|function|tty3270_put_character
id|tty3270_put_character
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_char
id|ch
)paren
(brace
r_struct
id|tty3270_line
op_star
id|line
suffix:semicolon
r_struct
id|tty3270_cell
op_star
id|cell
suffix:semicolon
id|line
op_assign
id|tp-&gt;screen
op_plus
id|tp-&gt;cy
suffix:semicolon
r_if
c_cond
(paren
id|line-&gt;len
op_le
id|tp-&gt;cx
)paren
(brace
r_while
c_loop
(paren
id|line-&gt;len
OL
id|tp-&gt;cx
)paren
(brace
id|cell
op_assign
id|line-&gt;cells
op_plus
id|line-&gt;len
suffix:semicolon
id|cell-&gt;character
op_assign
id|tp-&gt;view.ascebc
(braket
l_char|&squot; &squot;
)braket
suffix:semicolon
id|cell-&gt;highlight
op_assign
id|tp-&gt;highlight
suffix:semicolon
id|cell-&gt;f_color
op_assign
id|tp-&gt;f_color
suffix:semicolon
id|line-&gt;len
op_increment
suffix:semicolon
)brace
id|line-&gt;len
op_increment
suffix:semicolon
)brace
id|cell
op_assign
id|line-&gt;cells
op_plus
id|tp-&gt;cx
suffix:semicolon
id|cell-&gt;character
op_assign
id|tp-&gt;view.ascebc
(braket
(paren
r_int
r_int
)paren
id|ch
)braket
suffix:semicolon
id|cell-&gt;highlight
op_assign
id|tp-&gt;highlight
suffix:semicolon
id|cell-&gt;f_color
op_assign
id|tp-&gt;f_color
suffix:semicolon
)brace
multiline_comment|/*&n; * Convert a tty3270_line to a 3270 data fragment usable for output.&n; */
r_static
r_void
DECL|function|tty3270_convert_line
id|tty3270_convert_line
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|line_nr
)paren
(brace
r_struct
id|tty3270_line
op_star
id|line
suffix:semicolon
r_struct
id|tty3270_cell
op_star
id|cell
suffix:semicolon
r_struct
id|string
op_star
id|s
comma
op_star
id|n
suffix:semicolon
r_int
r_char
id|highlight
suffix:semicolon
r_int
r_char
id|f_color
suffix:semicolon
r_char
op_star
id|cp
suffix:semicolon
r_int
id|flen
comma
id|i
suffix:semicolon
multiline_comment|/* Determine how long the fragment will be. */
id|flen
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* Prefix (TO_SBA). */
id|line
op_assign
id|tp-&gt;screen
op_plus
id|line_nr
suffix:semicolon
id|flen
op_add_assign
id|line-&gt;len
suffix:semicolon
id|highlight
op_assign
id|TAX_RESET
suffix:semicolon
id|f_color
op_assign
id|TAC_RESET
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|cell
op_assign
id|line-&gt;cells
suffix:semicolon
id|i
OL
id|line-&gt;len
suffix:semicolon
id|i
op_increment
comma
id|cell
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cell-&gt;highlight
op_ne
id|highlight
)paren
(brace
id|flen
op_add_assign
l_int|3
suffix:semicolon
multiline_comment|/* TO_SA to switch highlight. */
id|highlight
op_assign
id|cell-&gt;highlight
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cell-&gt;f_color
op_ne
id|f_color
)paren
(brace
id|flen
op_add_assign
l_int|3
suffix:semicolon
multiline_comment|/* TO_SA to switch color. */
id|f_color
op_assign
id|cell-&gt;f_color
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|highlight
op_ne
id|TAX_RESET
)paren
id|flen
op_add_assign
l_int|3
suffix:semicolon
multiline_comment|/* TO_SA to reset hightlight. */
r_if
c_cond
(paren
id|f_color
op_ne
id|TAC_RESET
)paren
id|flen
op_add_assign
l_int|3
suffix:semicolon
multiline_comment|/* TO_SA to reset color. */
r_if
c_cond
(paren
id|line-&gt;len
OL
id|tp-&gt;view.cols
)paren
id|flen
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* Postfix (TO_RA). */
multiline_comment|/* Find the line in the list. */
id|i
op_assign
id|tp-&gt;view.rows
op_minus
l_int|2
op_minus
id|line_nr
suffix:semicolon
id|list_for_each_entry_reverse
c_func
(paren
id|s
comma
op_amp
id|tp-&gt;lines
comma
id|list
)paren
r_if
c_cond
(paren
op_decrement
id|i
op_le
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t; * Check if the line needs to get reallocated.&n;&t; */
r_if
c_cond
(paren
id|s-&gt;len
op_ne
id|flen
)paren
(brace
multiline_comment|/* Reallocate string. */
id|n
op_assign
id|tty3270_alloc_string
c_func
(paren
id|tp
comma
id|flen
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|n-&gt;list
comma
op_amp
id|s-&gt;list
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|s-&gt;list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|s-&gt;update
)paren
)paren
id|list_del_init
c_func
(paren
op_amp
id|s-&gt;update
)paren
suffix:semicolon
id|free_string
c_func
(paren
op_amp
id|tp-&gt;freemem
comma
id|s
)paren
suffix:semicolon
id|s
op_assign
id|n
suffix:semicolon
)brace
multiline_comment|/* Write 3270 data fragment. */
id|cp
op_assign
id|s-&gt;string
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|TO_SBA
suffix:semicolon
op_star
id|cp
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|cp
op_increment
op_assign
l_int|0
suffix:semicolon
id|highlight
op_assign
id|TAX_RESET
suffix:semicolon
id|f_color
op_assign
id|TAC_RESET
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|cell
op_assign
id|line-&gt;cells
suffix:semicolon
id|i
OL
id|line-&gt;len
suffix:semicolon
id|i
op_increment
comma
id|cell
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cell-&gt;highlight
op_ne
id|highlight
)paren
(brace
op_star
id|cp
op_increment
op_assign
id|TO_SA
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|TAT_EXTHI
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|cell-&gt;highlight
suffix:semicolon
id|highlight
op_assign
id|cell-&gt;highlight
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cell-&gt;f_color
op_ne
id|f_color
)paren
(brace
op_star
id|cp
op_increment
op_assign
id|TO_SA
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|TAT_COLOR
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|cell-&gt;f_color
suffix:semicolon
id|f_color
op_assign
id|cell-&gt;f_color
suffix:semicolon
)brace
op_star
id|cp
op_increment
op_assign
id|cell-&gt;character
suffix:semicolon
)brace
r_if
c_cond
(paren
id|highlight
op_ne
id|TAX_RESET
)paren
(brace
op_star
id|cp
op_increment
op_assign
id|TO_SA
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|TAT_EXTHI
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|TAX_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
id|f_color
op_ne
id|TAC_RESET
)paren
(brace
op_star
id|cp
op_increment
op_assign
id|TO_SA
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|TAT_COLOR
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|TAC_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
id|line-&gt;len
OL
id|tp-&gt;view.cols
)paren
(brace
op_star
id|cp
op_increment
op_assign
id|TO_RA
suffix:semicolon
op_star
id|cp
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|cp
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|cp
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;nr_up
op_plus
id|line_nr
OL
id|tp-&gt;view.rows
op_minus
l_int|2
)paren
(brace
multiline_comment|/* Line is currently visible on screen. */
id|tty3270_update_string
c_func
(paren
id|tp
comma
id|s
comma
id|line_nr
)paren
suffix:semicolon
multiline_comment|/* Add line to update list. */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|s-&gt;update
)paren
)paren
(brace
id|list_add_tail
c_func
(paren
op_amp
id|s-&gt;update
comma
op_amp
id|tp-&gt;update
)paren
suffix:semicolon
id|tp-&gt;update_flags
op_or_assign
id|TTY_UPDATE_LIST
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * Do carriage return.&n; */
r_static
r_void
DECL|function|tty3270_cr
id|tty3270_cr
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
id|tp-&gt;cx
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Do line feed.&n; */
r_static
r_void
DECL|function|tty3270_lf
id|tty3270_lf
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_struct
id|tty3270_line
id|temp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|tp-&gt;cy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;cy
OL
id|tp-&gt;view.rows
op_minus
l_int|3
)paren
(brace
id|tp-&gt;cy
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Last line just filled up. Add new, blank line. */
id|tty3270_blank_line
c_func
(paren
id|tp
)paren
suffix:semicolon
id|temp
op_assign
id|tp-&gt;screen
(braket
l_int|0
)braket
suffix:semicolon
id|temp.len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tp-&gt;view.rows
op_minus
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|tp-&gt;screen
(braket
id|i
)braket
op_assign
id|tp-&gt;screen
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|tp-&gt;screen
(braket
id|tp-&gt;view.rows
op_minus
l_int|3
)braket
op_assign
id|temp
suffix:semicolon
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_ri
id|tty3270_ri
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;cy
OG
l_int|0
)paren
(brace
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|tp-&gt;cy
)paren
suffix:semicolon
id|tp-&gt;cy
op_decrement
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Insert characters at current position.&n; */
r_static
r_void
DECL|function|tty3270_insert_characters
id|tty3270_insert_characters
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|n
)paren
(brace
r_struct
id|tty3270_line
op_star
id|line
suffix:semicolon
r_int
id|k
suffix:semicolon
id|line
op_assign
id|tp-&gt;screen
op_plus
id|tp-&gt;cy
suffix:semicolon
r_while
c_loop
(paren
id|line-&gt;len
OL
id|tp-&gt;cx
)paren
(brace
id|line-&gt;cells
(braket
id|line-&gt;len
)braket
dot
id|character
op_assign
id|tp-&gt;view.ascebc
(braket
l_char|&squot; &squot;
)braket
suffix:semicolon
id|line-&gt;cells
(braket
id|line-&gt;len
)braket
dot
id|highlight
op_assign
id|TAX_RESET
suffix:semicolon
id|line-&gt;cells
(braket
id|line-&gt;len
)braket
dot
id|f_color
op_assign
id|TAC_RESET
suffix:semicolon
id|line-&gt;len
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n
OG
id|tp-&gt;view.cols
op_minus
id|tp-&gt;cx
)paren
id|n
op_assign
id|tp-&gt;view.cols
op_minus
id|tp-&gt;cx
suffix:semicolon
id|k
op_assign
id|min_t
c_func
(paren
r_int
comma
id|line-&gt;len
op_minus
id|tp-&gt;cx
comma
id|tp-&gt;view.cols
op_minus
id|tp-&gt;cx
op_minus
id|n
)paren
suffix:semicolon
r_while
c_loop
(paren
id|k
op_decrement
)paren
id|line-&gt;cells
(braket
id|tp-&gt;cx
op_plus
id|n
op_plus
id|k
)braket
op_assign
id|line-&gt;cells
(braket
id|tp-&gt;cx
op_plus
id|k
)braket
suffix:semicolon
id|line-&gt;len
op_add_assign
id|n
suffix:semicolon
r_if
c_cond
(paren
id|line-&gt;len
OG
id|tp-&gt;view.cols
)paren
id|line-&gt;len
op_assign
id|tp-&gt;view.cols
suffix:semicolon
r_while
c_loop
(paren
id|n
op_decrement
OG
l_int|0
)paren
(brace
id|line-&gt;cells
(braket
id|tp-&gt;cx
op_plus
id|n
)braket
dot
id|character
op_assign
id|tp-&gt;view.ascebc
(braket
l_char|&squot; &squot;
)braket
suffix:semicolon
id|line-&gt;cells
(braket
id|tp-&gt;cx
op_plus
id|n
)braket
dot
id|highlight
op_assign
id|tp-&gt;highlight
suffix:semicolon
id|line-&gt;cells
(braket
id|tp-&gt;cx
op_plus
id|n
)braket
dot
id|f_color
op_assign
id|tp-&gt;f_color
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Delete characters at current position.&n; */
r_static
r_void
DECL|function|tty3270_delete_characters
id|tty3270_delete_characters
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|n
)paren
(brace
r_struct
id|tty3270_line
op_star
id|line
suffix:semicolon
r_int
id|i
suffix:semicolon
id|line
op_assign
id|tp-&gt;screen
op_plus
id|tp-&gt;cy
suffix:semicolon
r_if
c_cond
(paren
id|line-&gt;len
op_le
id|tp-&gt;cx
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|line-&gt;len
op_minus
id|tp-&gt;cx
op_le
id|n
)paren
(brace
id|line-&gt;len
op_assign
id|tp-&gt;cx
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|tp-&gt;cx
suffix:semicolon
id|i
op_plus
id|n
OL
id|line-&gt;len
suffix:semicolon
id|i
op_increment
)paren
id|line-&gt;cells
(braket
id|i
)braket
op_assign
id|line-&gt;cells
(braket
id|i
op_plus
id|n
)braket
suffix:semicolon
id|line-&gt;len
op_sub_assign
id|n
suffix:semicolon
)brace
multiline_comment|/*&n; * Erase characters at current position.&n; */
r_static
r_void
DECL|function|tty3270_erase_characters
id|tty3270_erase_characters
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|n
)paren
(brace
r_struct
id|tty3270_line
op_star
id|line
suffix:semicolon
r_struct
id|tty3270_cell
op_star
id|cell
suffix:semicolon
id|line
op_assign
id|tp-&gt;screen
op_plus
id|tp-&gt;cy
suffix:semicolon
r_while
c_loop
(paren
id|line-&gt;len
OG
id|tp-&gt;cx
op_logical_and
id|n
op_decrement
OG
l_int|0
)paren
(brace
id|cell
op_assign
id|line-&gt;cells
op_plus
id|tp-&gt;cx
op_increment
suffix:semicolon
id|cell-&gt;character
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|cell-&gt;highlight
op_assign
id|TAX_RESET
suffix:semicolon
id|cell-&gt;f_color
op_assign
id|TAC_RESET
suffix:semicolon
)brace
id|tp-&gt;cx
op_add_assign
id|n
suffix:semicolon
id|tp-&gt;cx
op_assign
id|min_t
c_func
(paren
r_int
comma
id|tp-&gt;cx
comma
id|tp-&gt;view.cols
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Erase line, 3 different cases:&n; *  Esc [ 0 K&t;Erase from current position to end of line inclusive&n; *  Esc [ 1 K&t;Erase from beginning of line to current position inclusive&n; *  Esc [ 2 K&t;Erase entire line (without moving cursor)&n; */
r_static
r_void
DECL|function|tty3270_erase_line
id|tty3270_erase_line
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|mode
)paren
(brace
r_struct
id|tty3270_line
op_star
id|line
suffix:semicolon
r_struct
id|tty3270_cell
op_star
id|cell
suffix:semicolon
r_int
id|i
suffix:semicolon
id|line
op_assign
id|tp-&gt;screen
op_plus
id|tp-&gt;cy
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
l_int|0
)paren
id|line-&gt;len
op_assign
id|tp-&gt;cx
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mode
op_eq
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tp-&gt;cx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cell
op_assign
id|line-&gt;cells
op_plus
id|i
suffix:semicolon
id|cell-&gt;character
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|cell-&gt;highlight
op_assign
id|TAX_RESET
suffix:semicolon
id|cell-&gt;f_color
op_assign
id|TAC_RESET
suffix:semicolon
)brace
r_if
c_cond
(paren
id|line-&gt;len
op_le
id|tp-&gt;cx
)paren
id|line-&gt;len
op_assign
id|tp-&gt;cx
op_plus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mode
op_eq
l_int|2
)paren
id|line-&gt;len
op_assign
l_int|0
suffix:semicolon
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|tp-&gt;cy
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Erase display, 3 different cases:&n; *  Esc [ 0 J&t;Erase from current position to bottom of screen inclusive&n; *  Esc [ 1 J&t;Erase from top of screen to current position inclusive&n; *  Esc [ 2 J&t;Erase entire screen (without moving the cursor)&n; */
r_static
r_void
DECL|function|tty3270_erase_display
id|tty3270_erase_display
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|mode
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_eq
l_int|0
)paren
(brace
id|tty3270_erase_line
c_func
(paren
id|tp
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|tp-&gt;cy
op_plus
l_int|1
suffix:semicolon
id|i
OL
id|tp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;screen
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|i
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|mode
op_eq
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tp-&gt;cy
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;screen
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|i
)paren
suffix:semicolon
)brace
id|tty3270_erase_line
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mode
op_eq
l_int|2
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|tp-&gt;view.rows
op_minus
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tp-&gt;screen
(braket
id|i
)braket
dot
id|len
op_assign
l_int|0
suffix:semicolon
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|tty3270_rebuild_update
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Set attributes found in an escape sequence.&n; *  Esc [ &lt;attr&gt; ; &lt;attr&gt; ; ... m&n; */
r_static
r_void
DECL|function|tty3270_set_attributes
id|tty3270_set_attributes
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
)paren
(brace
r_static
r_int
r_char
id|f_colors
(braket
)braket
op_assign
(brace
id|TAC_DEFAULT
comma
id|TAC_RED
comma
id|TAC_GREEN
comma
id|TAC_YELLOW
comma
id|TAC_BLUE
comma
id|TAC_PINK
comma
id|TAC_TURQ
comma
id|TAC_WHITE
comma
l_int|0
comma
id|TAC_DEFAULT
)brace
suffix:semicolon
r_int
id|i
comma
id|attr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|tp-&gt;esc_npar
suffix:semicolon
id|i
op_increment
)paren
(brace
id|attr
op_assign
id|tp-&gt;esc_par
(braket
id|i
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|attr
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Reset */
id|tp-&gt;highlight
op_assign
id|TAX_RESET
suffix:semicolon
id|tp-&gt;f_color
op_assign
id|TAC_RESET
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Highlight. */
r_case
l_int|4
suffix:colon
multiline_comment|/* Start underlining. */
id|tp-&gt;highlight
op_assign
id|TAX_UNDER
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
multiline_comment|/* Start blink. */
id|tp-&gt;highlight
op_assign
id|TAX_BLINK
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|7
suffix:colon
multiline_comment|/* Start reverse. */
id|tp-&gt;highlight
op_assign
id|TAX_REVER
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
multiline_comment|/* End underlining */
r_if
c_cond
(paren
id|tp-&gt;highlight
op_eq
id|TAX_UNDER
)paren
id|tp-&gt;highlight
op_assign
id|TAX_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|25
suffix:colon
multiline_comment|/* End blink. */
r_if
c_cond
(paren
id|tp-&gt;highlight
op_eq
id|TAX_BLINK
)paren
id|tp-&gt;highlight
op_assign
id|TAX_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|27
suffix:colon
multiline_comment|/* End reverse. */
r_if
c_cond
(paren
id|tp-&gt;highlight
op_eq
id|TAX_REVER
)paren
id|tp-&gt;highlight
op_assign
id|TAX_RESET
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Foreground color. */
r_case
l_int|30
suffix:colon
multiline_comment|/* Black */
r_case
l_int|31
suffix:colon
multiline_comment|/* Red */
r_case
l_int|32
suffix:colon
multiline_comment|/* Green */
r_case
l_int|33
suffix:colon
multiline_comment|/* Yellow */
r_case
l_int|34
suffix:colon
multiline_comment|/* Blue */
r_case
l_int|35
suffix:colon
multiline_comment|/* Magenta */
r_case
l_int|36
suffix:colon
multiline_comment|/* Cyan */
r_case
l_int|37
suffix:colon
multiline_comment|/* White */
r_case
l_int|39
suffix:colon
multiline_comment|/* Black */
id|tp-&gt;f_color
op_assign
id|f_colors
(braket
id|attr
op_minus
l_int|30
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_static
r_inline
r_int
DECL|function|tty3270_getpar
id|tty3270_getpar
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|ix
)paren
(brace
r_return
(paren
id|tp-&gt;esc_par
(braket
id|ix
)braket
OG
l_int|0
)paren
ques
c_cond
id|tp-&gt;esc_par
(braket
id|ix
)braket
suffix:colon
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_goto_xy
id|tty3270_goto_xy
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_int
id|cx
comma
r_int
id|cy
)paren
(brace
id|tp-&gt;cx
op_assign
id|min_t
c_func
(paren
r_int
comma
id|tp-&gt;view.cols
op_minus
l_int|1
comma
id|max_t
c_func
(paren
r_int
comma
l_int|0
comma
id|cx
)paren
)paren
suffix:semicolon
id|cy
op_assign
id|min_t
c_func
(paren
r_int
comma
id|tp-&gt;view.rows
op_minus
l_int|3
comma
id|max_t
c_func
(paren
r_int
comma
l_int|0
comma
id|cy
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cy
op_ne
id|tp-&gt;cy
)paren
(brace
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|tp-&gt;cy
)paren
suffix:semicolon
id|tp-&gt;cy
op_assign
id|cy
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Process escape sequences. Known sequences:&n; *  Esc 7&t;&t;&t;Save Cursor Position&n; *  Esc 8&t;&t;&t;Restore Cursor Position&n; *  Esc [ Pn ; Pn ; .. m&t;Set attributes&n; *  Esc [ Pn ; Pn H&t;&t;Cursor Position&n; *  Esc [ Pn ; Pn f&t;&t;Cursor Position&n; *  Esc [ Pn A&t;&t;&t;Cursor Up&n; *  Esc [ Pn B&t;&t;&t;Cursor Down&n; *  Esc [ Pn C&t;&t;&t;Cursor Forward&n; *  Esc [ Pn D&t;&t;&t;Cursor Backward&n; *  Esc [ Pn G&t;&t;&t;Cursor Horizontal Absolute&n; *  Esc [ Pn X&t;&t;&t;Erase Characters&n; *  Esc [ Ps J&t;&t;&t;Erase in Display&n; *  Esc [ Ps K&t;&t;&t;Erase in Line&n; * // FIXME: add all the new ones.&n; *&n; *  Pn is a numeric parameter, a string of zero or more decimal digits.&n; *  Ps is a selective parameter.&n; */
r_static
r_void
DECL|function|tty3270_escape_sequence
id|tty3270_escape_sequence
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_char
id|ch
)paren
(brace
r_enum
(brace
id|ESnormal
comma
id|ESesc
comma
id|ESsquare
comma
id|ESgetpars
)brace
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;esc_state
op_eq
id|ESnormal
)paren
(brace
r_if
c_cond
(paren
id|ch
op_eq
l_int|0x1b
)paren
multiline_comment|/* Starting new escape sequence. */
id|tp-&gt;esc_state
op_assign
id|ESesc
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;esc_state
op_eq
id|ESesc
)paren
(brace
id|tp-&gt;esc_state
op_assign
id|ESnormal
suffix:semicolon
r_switch
c_cond
(paren
id|ch
)paren
(brace
r_case
l_char|&squot;[&squot;
suffix:colon
id|tp-&gt;esc_state
op_assign
id|ESsquare
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;E&squot;
suffix:colon
id|tty3270_cr
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_lf
c_func
(paren
id|tp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;M&squot;
suffix:colon
id|tty3270_ri
c_func
(paren
id|tp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;D&squot;
suffix:colon
id|tty3270_lf
c_func
(paren
id|tp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;Z&squot;
suffix:colon
multiline_comment|/* Respond ID. */
id|kbd_puts_queue
c_func
(paren
id|tp-&gt;tty
comma
l_string|&quot;&bslash;033[?6c&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;7&squot;
suffix:colon
multiline_comment|/* Save cursor position. */
id|tp-&gt;saved_cx
op_assign
id|tp-&gt;cx
suffix:semicolon
id|tp-&gt;saved_cy
op_assign
id|tp-&gt;cy
suffix:semicolon
id|tp-&gt;saved_highlight
op_assign
id|tp-&gt;highlight
suffix:semicolon
id|tp-&gt;saved_f_color
op_assign
id|tp-&gt;f_color
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;8&squot;
suffix:colon
multiline_comment|/* Restore cursor position. */
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|tp-&gt;cy
)paren
suffix:semicolon
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tp-&gt;saved_cx
comma
id|tp-&gt;saved_cy
)paren
suffix:semicolon
id|tp-&gt;highlight
op_assign
id|tp-&gt;saved_highlight
suffix:semicolon
id|tp-&gt;f_color
op_assign
id|tp-&gt;saved_f_color
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;c&squot;
suffix:colon
multiline_comment|/* Reset terminal. */
id|tp-&gt;cx
op_assign
id|tp-&gt;saved_cx
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;cy
op_assign
id|tp-&gt;saved_cy
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;highlight
op_assign
id|tp-&gt;saved_highlight
op_assign
id|TAX_RESET
suffix:semicolon
id|tp-&gt;f_color
op_assign
id|tp-&gt;saved_f_color
op_assign
id|TAC_RESET
suffix:semicolon
id|tty3270_erase_display
c_func
(paren
id|tp
comma
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;esc_state
op_eq
id|ESsquare
)paren
(brace
id|tp-&gt;esc_state
op_assign
id|ESgetpars
suffix:semicolon
id|memset
c_func
(paren
id|tp-&gt;esc_par
comma
l_int|0
comma
r_sizeof
(paren
id|tp-&gt;esc_par
)paren
)paren
suffix:semicolon
id|tp-&gt;esc_npar
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;esc_ques
op_assign
(paren
id|ch
op_eq
l_char|&squot;?&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;esc_ques
)paren
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;esc_state
op_eq
id|ESgetpars
)paren
(brace
r_if
c_cond
(paren
id|ch
op_eq
l_char|&squot;;&squot;
op_logical_and
id|tp-&gt;esc_npar
OL
id|ESCAPE_NPAR
op_minus
l_int|1
)paren
(brace
id|tp-&gt;esc_npar
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ch
op_ge
l_char|&squot;0&squot;
op_logical_and
id|ch
op_le
l_char|&squot;9&squot;
)paren
(brace
id|tp-&gt;esc_par
(braket
id|tp-&gt;esc_npar
)braket
op_mul_assign
l_int|10
suffix:semicolon
id|tp-&gt;esc_par
(braket
id|tp-&gt;esc_npar
)braket
op_add_assign
id|ch
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|tp-&gt;esc_state
op_assign
id|ESnormal
suffix:semicolon
r_if
c_cond
(paren
id|ch
op_eq
l_char|&squot;n&squot;
op_logical_and
op_logical_neg
id|tp-&gt;esc_ques
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;esc_par
(braket
l_int|0
)braket
op_eq
l_int|5
)paren
multiline_comment|/* Status report. */
id|kbd_puts_queue
c_func
(paren
id|tp-&gt;tty
comma
l_string|&quot;&bslash;033[0n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tp-&gt;esc_par
(braket
l_int|0
)braket
op_eq
l_int|6
)paren
(brace
multiline_comment|/* Cursor report. */
r_char
id|buf
(braket
l_int|40
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;&bslash;033[%d;%dR&quot;
comma
id|tp-&gt;cy
op_plus
l_int|1
comma
id|tp-&gt;cx
op_plus
l_int|1
)paren
suffix:semicolon
id|kbd_puts_queue
c_func
(paren
id|tp-&gt;tty
comma
id|buf
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;esc_ques
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|ch
)paren
(brace
r_case
l_char|&squot;m&squot;
suffix:colon
id|tty3270_set_attributes
c_func
(paren
id|tp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;H&squot;
suffix:colon
multiline_comment|/* Set cursor position. */
r_case
l_char|&squot;f&squot;
suffix:colon
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|1
)paren
op_minus
l_int|1
comma
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;d&squot;
suffix:colon
multiline_comment|/* Set y position. */
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tp-&gt;cx
comma
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;A&squot;
suffix:colon
multiline_comment|/* Cursor up. */
r_case
l_char|&squot;F&squot;
suffix:colon
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tp-&gt;cx
comma
id|tp-&gt;cy
op_minus
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;B&squot;
suffix:colon
multiline_comment|/* Cursor down. */
r_case
l_char|&squot;e&squot;
suffix:colon
r_case
l_char|&squot;E&squot;
suffix:colon
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tp-&gt;cx
comma
id|tp-&gt;cy
op_plus
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;C&squot;
suffix:colon
multiline_comment|/* Cursor forward. */
r_case
l_char|&squot;a&squot;
suffix:colon
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tp-&gt;cx
op_plus
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
comma
id|tp-&gt;cy
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;D&squot;
suffix:colon
multiline_comment|/* Cursor backward. */
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tp-&gt;cx
op_minus
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
comma
id|tp-&gt;cy
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;G&squot;
suffix:colon
multiline_comment|/* Set x position. */
r_case
l_char|&squot;`&squot;
suffix:colon
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
comma
id|tp-&gt;cy
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;X&squot;
suffix:colon
multiline_comment|/* Erase Characters. */
id|tty3270_erase_characters
c_func
(paren
id|tp
comma
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;J&squot;
suffix:colon
multiline_comment|/* Erase display. */
id|tty3270_erase_display
c_func
(paren
id|tp
comma
id|tp-&gt;esc_par
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;K&squot;
suffix:colon
multiline_comment|/* Erase line. */
id|tty3270_erase_line
c_func
(paren
id|tp
comma
id|tp-&gt;esc_par
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;P&squot;
suffix:colon
multiline_comment|/* Delete characters. */
id|tty3270_delete_characters
c_func
(paren
id|tp
comma
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;@&squot;
suffix:colon
multiline_comment|/* Insert characters. */
id|tty3270_insert_characters
c_func
(paren
id|tp
comma
id|tty3270_getpar
c_func
(paren
id|tp
comma
l_int|0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;s&squot;
suffix:colon
multiline_comment|/* Save cursor position. */
id|tp-&gt;saved_cx
op_assign
id|tp-&gt;cx
suffix:semicolon
id|tp-&gt;saved_cy
op_assign
id|tp-&gt;cy
suffix:semicolon
id|tp-&gt;saved_highlight
op_assign
id|tp-&gt;highlight
suffix:semicolon
id|tp-&gt;saved_f_color
op_assign
id|tp-&gt;f_color
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;u&squot;
suffix:colon
multiline_comment|/* Restore cursor position. */
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|tp-&gt;cy
)paren
suffix:semicolon
id|tty3270_goto_xy
c_func
(paren
id|tp
comma
id|tp-&gt;saved_cx
comma
id|tp-&gt;saved_cy
)paren
suffix:semicolon
id|tp-&gt;highlight
op_assign
id|tp-&gt;saved_highlight
suffix:semicolon
id|tp-&gt;f_color
op_assign
id|tp-&gt;saved_f_color
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * String write routine for 3270 ttys&n; */
r_static
r_void
DECL|function|tty3270_do_write
id|tty3270_do_write
c_func
(paren
r_struct
id|tty3270
op_star
id|tp
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|i_msg
comma
id|i
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i_msg
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|tp-&gt;tty-&gt;stopped
op_logical_and
id|i_msg
OL
id|count
suffix:semicolon
id|i_msg
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;esc_state
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Continue escape sequence. */
id|tty3270_escape_sequence
c_func
(paren
id|tp
comma
id|buf
(braket
id|i_msg
)braket
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|buf
(braket
id|i_msg
)braket
)paren
(brace
r_case
l_int|0x07
suffix:colon
multiline_comment|/* &squot;&bslash;a&squot; -- Alarm */
id|tp-&gt;wcc
op_or_assign
id|TW_PLUSALARM
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* Backspace. */
r_if
c_cond
(paren
id|tp-&gt;cx
OG
l_int|0
)paren
(brace
id|tp-&gt;cx
op_decrement
suffix:semicolon
id|tty3270_put_character
c_func
(paren
id|tp
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x09
suffix:colon
multiline_comment|/* &squot;&bslash;t&squot; -- Tabulate */
r_for
c_loop
(paren
id|i
op_assign
id|tp-&gt;cx
op_mod
l_int|8
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;cx
op_ge
id|tp-&gt;view.cols
)paren
(brace
id|tty3270_cr
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_lf
c_func
(paren
id|tp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tty3270_put_character
c_func
(paren
id|tp
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
id|tp-&gt;cx
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x0a
suffix:colon
multiline_comment|/* &squot;&bslash;n&squot; -- New Line */
id|tty3270_cr
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_lf
c_func
(paren
id|tp
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0c
suffix:colon
multiline_comment|/* &squot;&bslash;f&squot; -- Form Feed */
id|tty3270_erase_display
c_func
(paren
id|tp
comma
l_int|2
)paren
suffix:semicolon
id|tp-&gt;cx
op_assign
id|tp-&gt;cy
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0d
suffix:colon
multiline_comment|/* &squot;&bslash;r&squot; -- Carriage Return */
id|tp-&gt;cx
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x0f
suffix:colon
multiline_comment|/* SuSE &quot;exit alternate mode&quot; */
r_break
suffix:semicolon
r_case
l_int|0x1b
suffix:colon
multiline_comment|/* Start escape sequence. */
id|tty3270_escape_sequence
c_func
(paren
id|tp
comma
id|buf
(braket
id|i_msg
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Insert normal character. */
r_if
c_cond
(paren
id|tp-&gt;cx
op_ge
id|tp-&gt;view.cols
)paren
(brace
id|tty3270_cr
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tty3270_lf
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
id|tty3270_put_character
c_func
(paren
id|tp
comma
id|buf
(braket
id|i_msg
)braket
)paren
suffix:semicolon
id|tp-&gt;cx
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Convert current line to 3270 data fragment. */
id|tty3270_convert_line
c_func
(paren
id|tp
comma
id|tp-&gt;cy
)paren
suffix:semicolon
multiline_comment|/* Setup timer to update display after 1/10 second */
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|tp-&gt;timer
)paren
)paren
id|tty3270_set_timer
c_func
(paren
id|tp
comma
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * String write routine for 3270 ttys&n; */
r_static
r_int
DECL|function|tty3270_write
id|tty3270_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_int
id|length
comma
id|ret
suffix:semicolon
id|tp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;char_count
OG
l_int|0
)paren
(brace
id|tty3270_do_write
c_func
(paren
id|tp
comma
id|tp-&gt;char_buf
comma
id|tp-&gt;char_count
)paren
suffix:semicolon
id|tp-&gt;char_count
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|from_user
)paren
(brace
id|tty3270_do_write
c_func
(paren
id|tp
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|length
op_assign
id|count
OL
id|TTY3270_CHAR_BUF_SIZE
ques
c_cond
id|count
suffix:colon
id|TTY3270_CHAR_BUF_SIZE
suffix:semicolon
id|length
op_sub_assign
id|copy_from_user
c_func
(paren
id|tp-&gt;char_buf
comma
id|buf
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|tty3270_do_write
c_func
(paren
id|tp
comma
id|tp-&gt;char_buf
comma
id|count
)paren
suffix:semicolon
id|buf
op_add_assign
id|length
suffix:semicolon
id|count
op_sub_assign
id|length
suffix:semicolon
id|ret
op_add_assign
id|length
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Put single characters to the ttys character buffer&n; */
r_static
r_void
DECL|function|tty3270_put_char
id|tty3270_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
id|tp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;char_count
OL
id|TTY3270_CHAR_BUF_SIZE
)paren
id|tp-&gt;char_buf
(braket
id|tp-&gt;char_count
op_increment
)braket
op_assign
id|ch
suffix:semicolon
)brace
multiline_comment|/*&n; * Flush all characters from the ttys characeter buffer put there&n; * by tty3270_put_char.&n; */
r_static
r_void
DECL|function|tty3270_flush_chars
id|tty3270_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
id|tp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;char_count
OG
l_int|0
)paren
(brace
id|tty3270_do_write
c_func
(paren
id|tp
comma
id|tp-&gt;char_buf
comma
id|tp-&gt;char_count
)paren
suffix:semicolon
id|tp-&gt;char_count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Returns the number of characters in the output buffer. This is&n; * used in tty_wait_until_sent to wait until all characters have&n; * appeared on the screen.&n; */
r_static
r_int
DECL|function|tty3270_chars_in_buffer
id|tty3270_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_flush_buffer
id|tty3270_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
)brace
multiline_comment|/*&n; * Check for visible/invisible input switches&n; */
r_static
r_void
DECL|function|tty3270_set_termios
id|tty3270_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
r_int
r_new
suffix:semicolon
id|tp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_return
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|L_ICANON
c_func
(paren
id|tty
)paren
)paren
(brace
r_new
op_assign
id|L_ECHO
c_func
(paren
id|tty
)paren
ques
c_cond
id|TF_INPUT
suffix:colon
id|TF_INPUTN
suffix:semicolon
r_if
c_cond
(paren
r_new
op_ne
id|tp-&gt;inattr
)paren
(brace
id|tp-&gt;inattr
op_assign
r_new
suffix:semicolon
id|tty3270_update_prompt
c_func
(paren
id|tp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|tty3270_set_timer
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|tp-&gt;view.lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Disable reading from a 3270 tty&n; */
r_static
r_void
DECL|function|tty3270_throttle
id|tty3270_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
id|tp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_return
suffix:semicolon
id|tp-&gt;throttle
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Enable reading from a 3270 tty&n; */
r_static
r_void
DECL|function|tty3270_unthrottle
id|tty3270_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
id|tp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_return
suffix:semicolon
id|tp-&gt;throttle
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;attn
)paren
id|tty3270_issue_read
c_func
(paren
id|tp
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Hang up the tty device.&n; */
r_static
r_void
DECL|function|tty3270_hangup
id|tty3270_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
singleline_comment|// FIXME: implement
)brace
r_static
r_void
DECL|function|tty3270_wait_until_sent
id|tty3270_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
)brace
r_static
r_int
DECL|function|tty3270_ioctl
id|tty3270_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|tty3270
op_star
id|tp
suffix:semicolon
id|tp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|kbd_ioctl
c_func
(paren
id|tp-&gt;kbd
comma
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|tty3270_ops
r_static
r_struct
id|tty_operations
id|tty3270_ops
op_assign
(brace
dot
id|open
op_assign
id|tty3270_open
comma
dot
id|close
op_assign
id|tty3270_close
comma
dot
id|write
op_assign
id|tty3270_write
comma
dot
id|put_char
op_assign
id|tty3270_put_char
comma
dot
id|flush_chars
op_assign
id|tty3270_flush_chars
comma
dot
id|write_room
op_assign
id|tty3270_write_room
comma
dot
id|chars_in_buffer
op_assign
id|tty3270_chars_in_buffer
comma
dot
id|flush_buffer
op_assign
id|tty3270_flush_buffer
comma
dot
id|throttle
op_assign
id|tty3270_throttle
comma
dot
id|unthrottle
op_assign
id|tty3270_unthrottle
comma
dot
id|hangup
op_assign
id|tty3270_hangup
comma
dot
id|wait_until_sent
op_assign
id|tty3270_wait_until_sent
comma
dot
id|ioctl
op_assign
id|tty3270_ioctl
comma
dot
id|set_termios
op_assign
id|tty3270_set_termios
)brace
suffix:semicolon
r_void
DECL|function|tty3270_notifier
id|tty3270_notifier
c_func
(paren
r_int
id|index
comma
r_int
id|active
)paren
(brace
r_if
c_cond
(paren
id|active
)paren
id|tty_register_device
c_func
(paren
id|tty3270_driver
comma
id|index
comma
l_int|0
)paren
suffix:semicolon
r_else
id|tty_unregister_device
c_func
(paren
id|tty3270_driver
comma
id|index
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * 3270 tty registration code called from tty_init().&n; * Most kernel services (incl. kmalloc) are available at this poimt.&n; */
r_int
id|__init
DECL|function|tty3270_init
id|tty3270_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty_driver
op_star
id|driver
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|driver
op_assign
id|alloc_tty_driver
c_func
(paren
l_int|256
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize the tty_driver structure&n;&t; * Entries in tty3270_driver that are NOT initialized:&n;&t; * proc_entry, set_termios, flush_buffer, set_ldisc, write_proc&n;&t; */
id|driver-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|driver-&gt;devfs_name
op_assign
l_string|&quot;ttyTUB/&quot;
suffix:semicolon
id|driver-&gt;driver_name
op_assign
l_string|&quot;ttyTUB&quot;
suffix:semicolon
id|driver-&gt;name
op_assign
l_string|&quot;ttyTUB&quot;
suffix:semicolon
id|driver-&gt;major
op_assign
id|IBM_TTY3270_MAJOR
suffix:semicolon
id|driver-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SYSTEM
suffix:semicolon
id|driver-&gt;subtype
op_assign
id|SYSTEM_TYPE_TTY
suffix:semicolon
id|driver-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|driver-&gt;flags
op_assign
id|TTY_DRIVER_RESET_TERMIOS
op_or
id|TTY_DRIVER_NO_DEVFS
suffix:semicolon
id|tty_set_operations
c_func
(paren
id|driver
comma
op_amp
id|tty3270_ops
)paren
suffix:semicolon
id|ret
op_assign
id|tty_register_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;tty3270 registration failed with %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|tty3270_driver
op_assign
id|driver
suffix:semicolon
id|ret
op_assign
id|raw3270_register_notifier
c_func
(paren
id|tty3270_notifier
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;tty3270 notifier registration failed &quot;
l_string|&quot;with %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|tty3270_exit
id|tty3270_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|tty_driver
op_star
id|driver
suffix:semicolon
id|raw3270_unregister_notifier
c_func
(paren
id|tty3270_notifier
)paren
suffix:semicolon
id|driver
op_assign
id|tty3270_driver
suffix:semicolon
id|tty3270_driver
op_assign
l_int|0
suffix:semicolon
id|tty_unregister_driver
c_func
(paren
id|driver
)paren
suffix:semicolon
id|tty3270_del_views
c_func
(paren
)paren
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|IBM_TTY3270_MAJOR
id|MODULE_ALIAS_CHARDEV_MAJOR
c_func
(paren
id|IBM_TTY3270_MAJOR
)paren
suffix:semicolon
DECL|variable|tty3270_init
id|module_init
c_func
(paren
id|tty3270_init
)paren
suffix:semicolon
DECL|variable|tty3270_exit
id|module_exit
c_func
(paren
id|tty3270_exit
)paren
suffix:semicolon
eof
