multiline_comment|/*&n; *  drivers/s390/char/tape_std.c&n; *    standard tape device functions for ibm tapes.&n; *&n; *  S390 and zSeries version&n; *    Copyright (C) 2001,2002 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Carsten Otte &lt;cotte@de.ibm.com&gt;&n; *&t;&t; Michael Holzheu &lt;holzheu@de.ibm.com&gt;&n; *&t;&t; Tuan Ngo-Anh &lt;ngoanh@de.ibm.com&gt;&n; *&t;&t; Martin Schwidefsky &lt;schwidefsky@de.ibm.com&gt;&n; *&t;&t; Stefan Bader &lt;shbader@de.ibm.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/bio.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;asm/idals.h&gt;
macro_line|#include &lt;asm/ebcdic.h&gt;
macro_line|#include &lt;asm/tape390.h&gt;
DECL|macro|TAPE_DBF_AREA
mdefine_line|#define TAPE_DBF_AREA&t;tape_core_dbf
macro_line|#include &quot;tape.h&quot;
macro_line|#include &quot;tape_std.h&quot;
DECL|macro|PRINTK_HEADER
mdefine_line|#define PRINTK_HEADER &quot;TAPE_STD: &quot;
multiline_comment|/*&n; * tape_std_assign&n; */
r_static
r_void
DECL|function|tape_std_assign_timeout
id|tape_std_assign_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|tape_device
op_star
id|device
suffix:semicolon
id|request
op_assign
(paren
r_struct
id|tape_request
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|device
op_assign
id|request-&gt;device
)paren
op_eq
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;callback
op_ne
l_int|NULL
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x: Assignment timeout. Device busy.&bslash;n&quot;
comma
id|device-&gt;cdev_id
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;%s: Assignment timeout. Device busy.&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|ccw_device_clear
c_func
(paren
id|device-&gt;cdev
comma
(paren
r_int
)paren
id|request
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
id|get_ccwdev_lock
c_func
(paren
id|device-&gt;cdev
)paren
)paren
suffix:semicolon
)brace
r_int
DECL|function|tape_std_assign
id|tape_std_assign
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|timer_list
id|timeout
suffix:semicolon
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|2
comma
l_int|11
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_ASSIGN
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|ASSIGN
comma
l_int|11
comma
id|request-&gt;cpdata
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The assign command sometimes blocks if the device is assigned&n;&t; * to another host (actually this shouldn&squot;t happen but it does).&n;&t; * So we set up a timeout for this call.&n;&t; */
id|init_timer
c_func
(paren
op_amp
id|timeout
)paren
suffix:semicolon
id|timeout.function
op_assign
id|tape_std_assign_timeout
suffix:semicolon
id|timeout.data
op_assign
(paren
r_int
r_int
)paren
id|request
suffix:semicolon
id|timeout.expires
op_assign
id|jiffies
op_plus
l_int|2
op_star
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|timeout
)paren
suffix:semicolon
id|rc
op_assign
id|tape_do_io_interruptible
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|PRINT_WARN
c_func
(paren
l_string|&quot;%s: assign failed - device might be busy&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x: assign failed - device might be busy&bslash;n&quot;
comma
id|device-&gt;cdev_id
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x: Tape assigned&bslash;n&quot;
comma
id|device-&gt;cdev_id
)paren
suffix:semicolon
)brace
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * tape_std_unassign&n; */
r_int
DECL|function|tape_std_unassign
id|tape_std_unassign
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;tape_state
op_eq
id|TS_NOT_OPER
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;(%08x): Can&squot;t unassign device&bslash;n&quot;
comma
id|device-&gt;cdev_id
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;(%s): Can&squot;t unassign device - device gone&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|2
comma
l_int|11
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_UNASSIGN
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|UNASSIGN
comma
l_int|11
comma
id|request-&gt;cpdata
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tape_do_io
c_func
(paren
id|device
comma
id|request
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x: Unassign failed&bslash;n&quot;
comma
id|device-&gt;cdev_id
)paren
suffix:semicolon
id|PRINT_WARN
c_func
(paren
l_string|&quot;%s: Unassign failed&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;%08x: Tape unassigned&bslash;n&quot;
comma
id|device-&gt;cdev_id
)paren
suffix:semicolon
)brace
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * TAPE390_DISPLAY: Show a string on the tape display.&n; */
r_int
DECL|function|tape_std_display
id|tape_std_display
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|display_struct
op_star
id|disp
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|2
comma
l_int|17
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;TAPE: load display failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
)brace
id|request-&gt;op
op_assign
id|TO_DIS
suffix:semicolon
op_star
(paren
r_int
r_char
op_star
)paren
id|request-&gt;cpdata
op_assign
id|disp-&gt;cntrl
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|5
comma
l_string|&quot;TAPE: display cntrl=%04x&bslash;n&quot;
comma
id|disp-&gt;cntrl
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
(paren
r_int
r_char
op_star
)paren
id|request-&gt;cpdata
)paren
op_plus
l_int|1
comma
id|disp-&gt;message1
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
(paren
r_int
r_char
op_star
)paren
id|request-&gt;cpdata
)paren
op_plus
l_int|9
comma
id|disp-&gt;message2
comma
l_int|8
)paren
suffix:semicolon
id|ASCEBC
c_func
(paren
(paren
(paren
r_int
r_char
op_star
)paren
id|request-&gt;cpdata
)paren
op_plus
l_int|1
comma
l_int|16
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|LOAD_DISPLAY
comma
l_int|17
comma
id|request-&gt;cpdata
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|rc
op_assign
id|tape_do_io_interruptible
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Read block id.&n; */
r_int
DECL|function|tape_std_read_block_id
id|tape_std_read_block_id
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
id|__u64
op_star
id|id
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|3
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_RBI
suffix:semicolon
multiline_comment|/* setup ccws */
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|READ_BLOCK_ID
comma
l_int|8
comma
id|request-&gt;cpdata
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|2
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
id|rc
op_assign
id|tape_do_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
multiline_comment|/* Get result from read buffer. */
op_star
id|id
op_assign
op_star
(paren
id|__u64
op_star
)paren
id|request-&gt;cpdata
suffix:semicolon
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|tape_std_terminate_write
id|tape_std_terminate_write
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;required_tapemarks
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|DBF_LH
c_func
(paren
l_int|5
comma
l_string|&quot;tape%d: terminate write %dxEOF&bslash;n&quot;
comma
id|device-&gt;first_minor
comma
id|device-&gt;required_tapemarks
)paren
suffix:semicolon
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTWEOF
comma
id|device-&gt;required_tapemarks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|device-&gt;required_tapemarks
op_assign
l_int|0
suffix:semicolon
r_return
id|tape_mtop
c_func
(paren
id|device
comma
id|MTBSR
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTLOAD: Loads the tape.&n; * The default implementation just wait until the tape medium state changes&n; * to MS_LOADED.&n; */
r_int
DECL|function|tape_std_mtload
id|tape_std_mtload
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|count
)paren
(brace
r_return
id|wait_event_interruptible
c_func
(paren
id|device-&gt;state_change_wq
comma
(paren
id|device-&gt;medium_state
op_eq
id|MS_LOADED
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTSETBLK: Set block size.&n; */
r_int
DECL|function|tape_std_mtsetblk
id|tape_std_mtsetblk
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|count
)paren
(brace
r_struct
id|idal_buffer
op_star
r_new
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|6
comma
l_string|&quot;tape_std_mtsetblk(%d)&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Just set block_size to 0. tapechar_read/tapechar_write&n;&t;&t; * will realloc the idal buffer if a bigger one than the&n;&t;&t; * current is needed.&n;&t;&t; */
id|device-&gt;char_data.block_size
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|device-&gt;char_data.idal_buf
op_ne
l_int|NULL
op_logical_and
id|device-&gt;char_data.idal_buf-&gt;size
op_eq
id|count
)paren
multiline_comment|/* We already have a idal buffer of that size. */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|MAX_BLOCKSIZE
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|3
comma
l_string|&quot;Invalid block size (%d &gt; %d) given.&bslash;n&quot;
comma
id|count
comma
id|MAX_BLOCKSIZE
)paren
suffix:semicolon
id|PRINT_ERR
c_func
(paren
l_string|&quot;Invalid block size (%d &gt; %d) given.&bslash;n&quot;
comma
id|count
comma
id|MAX_BLOCKSIZE
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Allocate a new idal buffer. */
r_new
op_assign
id|idal_buffer_alloc
c_func
(paren
id|count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;char_data.idal_buf
op_ne
l_int|NULL
)paren
id|idal_buffer_free
c_func
(paren
id|device-&gt;char_data.idal_buf
)paren
suffix:semicolon
id|device-&gt;char_data.idal_buf
op_assign
r_new
suffix:semicolon
id|device-&gt;char_data.block_size
op_assign
id|count
suffix:semicolon
id|DBF_LH
c_func
(paren
l_int|6
comma
l_string|&quot;new blocksize is %d&bslash;n&quot;
comma
id|device-&gt;char_data.block_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * MTRESET: Set block size to 0.&n; */
r_int
DECL|function|tape_std_mtreset
id|tape_std_mtreset
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|count
)paren
(brace
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;TCHAR:devreset:&bslash;n&quot;
)paren
suffix:semicolon
id|device-&gt;char_data.block_size
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * MTFSF: Forward space over &squot;count&squot; file marks. The tape is positioned&n; * at the EOT (End of Tape) side of the file mark.&n; */
r_int
DECL|function|tape_std_mtfsf
id|tape_std_mtfsf
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
id|mt_count
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_FSF
suffix:semicolon
multiline_comment|/* setup ccws */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_repeat
c_func
(paren
id|ccw
comma
id|FORSPACEFILE
comma
id|mt_count
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTFSR: Forward space over &squot;count&squot; tape blocks (blocksize is set&n; * via MTSETBLK.&n; */
r_int
DECL|function|tape_std_mtfsr
id|tape_std_mtfsr
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
id|mt_count
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_FSB
suffix:semicolon
multiline_comment|/* setup ccws */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_repeat
c_func
(paren
id|ccw
comma
id|FORSPACEBLOCK
comma
id|mt_count
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
id|rc
op_assign
id|tape_do_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|request-&gt;rescnt
OG
l_int|0
)paren
(brace
id|DBF_LH
c_func
(paren
l_int|3
comma
l_string|&quot;FSR over tapemark&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
l_int|1
suffix:semicolon
)brace
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSR: Backward space over &squot;count&squot; tape blocks.&n; * (blocksize is set via MTSETBLK.&n; */
r_int
DECL|function|tape_std_mtbsr
id|tape_std_mtbsr
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
id|mt_count
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_BSB
suffix:semicolon
multiline_comment|/* setup ccws */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_repeat
c_func
(paren
id|ccw
comma
id|BACKSPACEBLOCK
comma
id|mt_count
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
id|rc
op_assign
id|tape_do_io
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|request-&gt;rescnt
OG
l_int|0
)paren
(brace
id|DBF_LH
c_func
(paren
l_int|3
comma
l_string|&quot;BSR over tapemark&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
l_int|1
suffix:semicolon
)brace
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * MTWEOF: Write &squot;count&squot; file marks at the current position.&n; */
r_int
DECL|function|tape_std_mtweof
id|tape_std_mtweof
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
id|mt_count
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_WTM
suffix:semicolon
multiline_comment|/* setup ccws */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_repeat
c_func
(paren
id|ccw
comma
id|WRITETAPEMARK
comma
id|mt_count
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSFM: Backward space over &squot;count&squot; file marks.&n; * The tape is positioned at the BOT (Begin Of Tape) side of the&n; * last skipped file mark.&n; */
r_int
DECL|function|tape_std_mtbsfm
id|tape_std_mtbsfm
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
id|mt_count
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_BSF
suffix:semicolon
multiline_comment|/* setup ccws */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_repeat
c_func
(paren
id|ccw
comma
id|BACKSPACEFILE
comma
id|mt_count
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTBSF: Backward space over &squot;count&squot; file marks. The tape is positioned at&n; * the EOT (End of Tape) side of the last skipped file mark.&n; */
r_int
DECL|function|tape_std_mtbsf
id|tape_std_mtbsf
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
id|mt_count
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_BSF
suffix:semicolon
multiline_comment|/* setup ccws */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_repeat
c_func
(paren
id|ccw
comma
id|BACKSPACEFILE
comma
id|mt_count
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
id|rc
op_assign
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTFSR
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|0
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * MTFSFM: Forward space over &squot;count&squot; file marks.&n; * The tape is positioned at the BOT (Begin Of Tape) side&n; * of the last skipped file mark.&n; */
r_int
DECL|function|tape_std_mtfsfm
id|tape_std_mtfsfm
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_struct
id|ccw1
op_star
id|ccw
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
id|mt_count
op_plus
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_FSF
suffix:semicolon
multiline_comment|/* setup ccws */
id|ccw
op_assign
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_repeat
c_func
(paren
id|ccw
comma
id|FORSPACEFILE
comma
id|mt_count
)paren
suffix:semicolon
id|ccw
op_assign
id|tape_ccw_end
c_func
(paren
id|ccw
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
id|rc
op_assign
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTBSR
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|0
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * MTREW: Rewind the tape.&n; */
r_int
DECL|function|tape_std_mtrew
id|tape_std_mtrew
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_REW
suffix:semicolon
multiline_comment|/* setup ccws */
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|REWIND
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|2
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTOFFL: Rewind the tape and put the drive off-line.&n; * Implement &squot;rewind unload&squot;&n; */
r_int
DECL|function|tape_std_mtoffl
id|tape_std_mtoffl
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_RUN
suffix:semicolon
multiline_comment|/* setup ccws */
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|REWIND_UNLOAD
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|2
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTNOP: &squot;No operation&squot;.&n; */
r_int
DECL|function|tape_std_mtnop
id|tape_std_mtnop
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_NOP
suffix:semicolon
multiline_comment|/* setup ccws */
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTEOM: positions at the end of the portion of the tape already used&n; * for recordind data. MTEOM positions after the last file mark, ready for&n; * appending another file.&n; */
r_int
DECL|function|tape_std_mteom
id|tape_std_mteom
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/*&n;&t; * Seek from the beginning of tape (rewind).&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTREW
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/*&n;&t; * The logical end of volume is given by two sewuential tapemarks.&n;&t; * Look for this by skipping to the next file (over one tapemark)&n;&t; * and then test for another one (fsr returns 1 if a tapemark was&n;&t; * encountered).&n;&t; */
r_do
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTFSF
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tape_mtop
c_func
(paren
id|device
comma
id|MTFSR
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rc
op_eq
l_int|0
)paren
suffix:semicolon
r_return
id|tape_mtop
c_func
(paren
id|device
comma
id|MTBSR
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTRETEN: Retension the tape, i.e. forward space to end of tape and rewind.&n; */
r_int
DECL|function|tape_std_mtreten
id|tape_std_mtreten
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|4
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_FSF
suffix:semicolon
multiline_comment|/* setup ccws */
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|FORSPACEFILE
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|2
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|3
comma
id|CCW_CMD_TIC
comma
l_int|0
comma
id|request-&gt;cpaddr
)paren
suffix:semicolon
multiline_comment|/* execute it, MTRETEN rc gets ignored */
id|rc
op_assign
id|tape_do_io_interruptible
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
id|tape_free_request
c_func
(paren
id|request
)paren
suffix:semicolon
r_return
id|tape_mtop
c_func
(paren
id|device
comma
id|MTREW
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTERASE: erases the tape.&n; */
r_int
DECL|function|tape_std_mterase
id|tape_std_mterase
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|6
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_DSE
suffix:semicolon
multiline_comment|/* setup ccws */
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|REWIND
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|2
comma
id|ERASE_GAP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|3
comma
id|DATA_SEC_ERASE
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|4
comma
id|REWIND
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|5
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTUNLOAD: Rewind the tape and unload it.&n; */
r_int
DECL|function|tape_std_mtunload
id|tape_std_mtunload
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_return
id|tape_mtop
c_func
(paren
id|device
comma
id|MTOFFL
comma
id|mt_count
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MTCOMPRESSION: used to enable compression.&n; * Sets the IDRC on/off.&n; */
r_int
DECL|function|tape_std_mtcompression
id|tape_std_mtcompression
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|mt_count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
r_if
c_cond
(paren
id|mt_count
template_param
l_int|1
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|6
comma
l_string|&quot;xcom parm&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|device-&gt;modeset_byte
op_amp
l_int|0x08
)paren
id|PRINT_INFO
c_func
(paren
l_string|&quot;(%s) Compression is currently on&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
r_else
id|PRINT_INFO
c_func
(paren
l_string|&quot;(%s) Compression is currently off&bslash;n&quot;
comma
id|device-&gt;cdev-&gt;dev.bus_id
)paren
suffix:semicolon
id|PRINT_INFO
c_func
(paren
l_string|&quot;Use 1 to switch compression on, 0 to &quot;
l_string|&quot;switch it off&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|request
)paren
suffix:semicolon
id|request-&gt;op
op_assign
id|TO_NOP
suffix:semicolon
multiline_comment|/* setup ccws */
op_star
id|device-&gt;modeset_byte
op_assign
(paren
id|mt_count
op_eq
l_int|0
)paren
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x08
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* execute it */
r_return
id|tape_do_io_free
c_func
(paren
id|device
comma
id|request
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Read Block&n; */
r_struct
id|tape_request
op_star
DECL|function|tape_std_read_block
id|tape_std_read_block
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
multiline_comment|/*&n;&t; * We have to alloc 4 ccws in order to be able to transform request&n;&t; * into a read backward request in error case.&n;&t; */
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|4
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|6
comma
l_string|&quot;xrbl fail&quot;
)paren
suffix:semicolon
r_return
id|request
suffix:semicolon
)brace
id|request-&gt;op
op_assign
id|TO_RFO
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_end_idal
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|READ_FORWARD
comma
id|device-&gt;char_data.idal_buf
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;xrbl ccwg&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|request
suffix:semicolon
)brace
multiline_comment|/*&n; * Read Block backward transformation function.&n; */
r_void
DECL|function|tape_std_read_backward
id|tape_std_read_backward
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_struct
id|tape_request
op_star
id|request
)paren
(brace
multiline_comment|/*&n;&t; * We have allocated 4 ccws in tape_std_read, so we can now&n;&t; * transform the request to a read backward, followed by a&n;&t; * forward space block.&n;&t; */
id|request-&gt;op
op_assign
id|TO_RBA
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_cc_idal
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|READ_BACKWARD
comma
id|device-&gt;char_data.idal_buf
)paren
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|2
comma
id|FORSPACEBLOCK
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|tape_ccw_end
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|3
comma
id|NOP
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;xrop ccwg&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Write Block&n; */
r_struct
id|tape_request
op_star
DECL|function|tape_std_write_block
id|tape_std_write_block
c_func
(paren
r_struct
id|tape_device
op_star
id|device
comma
r_int
id|count
)paren
(brace
r_struct
id|tape_request
op_star
id|request
suffix:semicolon
id|request
op_assign
id|tape_alloc_request
c_func
(paren
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|request
)paren
)paren
(brace
id|DBF_EXCEPTION
c_func
(paren
l_int|6
comma
l_string|&quot;xwbl fail&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|request
suffix:semicolon
)brace
id|request-&gt;op
op_assign
id|TO_WRI
suffix:semicolon
id|tape_ccw_cc
c_func
(paren
id|request-&gt;cpaddr
comma
id|MODE_SET_DB
comma
l_int|1
comma
id|device-&gt;modeset_byte
)paren
suffix:semicolon
id|tape_ccw_end_idal
c_func
(paren
id|request-&gt;cpaddr
op_plus
l_int|1
comma
id|WRITE_CMD
comma
id|device-&gt;char_data.idal_buf
)paren
suffix:semicolon
id|DBF_EVENT
c_func
(paren
l_int|6
comma
l_string|&quot;xwbl ccwg&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|request
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called by frontend after an ENOSP on write&n; */
r_void
DECL|function|tape_std_process_eov
id|tape_std_process_eov
c_func
(paren
r_struct
id|tape_device
op_star
id|device
)paren
(brace
multiline_comment|/*&n;&t; * End of volume: We have to backspace the last written record, then&n;&t; * we TRY to write a tapemark and then backspace over the written TM&n;&t; */
r_if
c_cond
(paren
id|tape_mtop
c_func
(paren
id|device
comma
id|MTBSR
comma
l_int|1
)paren
op_eq
l_int|0
op_logical_and
id|tape_mtop
c_func
(paren
id|device
comma
id|MTWEOF
comma
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|tape_mtop
c_func
(paren
id|device
comma
id|MTBSR
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|variable|tape_std_assign
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_assign
)paren
suffix:semicolon
DECL|variable|tape_std_unassign
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_unassign
)paren
suffix:semicolon
DECL|variable|tape_std_display
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_display
)paren
suffix:semicolon
DECL|variable|tape_std_read_block_id
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_read_block_id
)paren
suffix:semicolon
DECL|variable|tape_std_mtload
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtload
)paren
suffix:semicolon
DECL|variable|tape_std_mtsetblk
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtsetblk
)paren
suffix:semicolon
DECL|variable|tape_std_mtreset
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtreset
)paren
suffix:semicolon
DECL|variable|tape_std_mtfsf
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtfsf
)paren
suffix:semicolon
DECL|variable|tape_std_mtfsr
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtfsr
)paren
suffix:semicolon
DECL|variable|tape_std_mtbsr
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtbsr
)paren
suffix:semicolon
DECL|variable|tape_std_mtweof
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtweof
)paren
suffix:semicolon
DECL|variable|tape_std_mtbsfm
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtbsfm
)paren
suffix:semicolon
DECL|variable|tape_std_mtbsf
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtbsf
)paren
suffix:semicolon
DECL|variable|tape_std_mtfsfm
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtfsfm
)paren
suffix:semicolon
DECL|variable|tape_std_mtrew
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtrew
)paren
suffix:semicolon
DECL|variable|tape_std_mtoffl
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtoffl
)paren
suffix:semicolon
DECL|variable|tape_std_mtnop
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtnop
)paren
suffix:semicolon
DECL|variable|tape_std_mteom
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mteom
)paren
suffix:semicolon
DECL|variable|tape_std_mtreten
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtreten
)paren
suffix:semicolon
DECL|variable|tape_std_mterase
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mterase
)paren
suffix:semicolon
DECL|variable|tape_std_mtunload
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtunload
)paren
suffix:semicolon
DECL|variable|tape_std_mtcompression
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_mtcompression
)paren
suffix:semicolon
DECL|variable|tape_std_read_block
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_read_block
)paren
suffix:semicolon
DECL|variable|tape_std_read_backward
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_read_backward
)paren
suffix:semicolon
DECL|variable|tape_std_write_block
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_write_block
)paren
suffix:semicolon
DECL|variable|tape_std_process_eov
id|EXPORT_SYMBOL
c_func
(paren
id|tape_std_process_eov
)paren
suffix:semicolon
eof
