multiline_comment|/*&n; *  IBM/3270 Driver -- Copyright (C) 2000 UTS Global LLC&n; *&n; *  tubttysiz.c -- Linemode screen-size determiner&n; *&n; *&n; *&n; *&n; *&n; *  Author:  Richard Hitt&n; */
macro_line|#include &quot;tubio.h&quot;
r_static
r_int
id|tty3270_size_io
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
suffix:semicolon
r_static
r_void
id|tty3270_size_int
c_func
(paren
id|tub_t
op_star
id|tubp
comma
id|devstat_t
op_star
id|dsp
)paren
suffix:semicolon
r_static
r_int
id|tty3270_size_wait
c_func
(paren
id|tub_t
op_star
id|tubp
comma
r_int
op_star
id|flags
comma
r_int
id|stat
)paren
suffix:semicolon
multiline_comment|/*&n; * Structure representing Usable Area Query Reply Base&n; */
r_typedef
r_struct
(brace
DECL|member|l
r_int
id|l
suffix:semicolon
multiline_comment|/* Length of this structured field */
DECL|member|sfid
r_char
id|sfid
suffix:semicolon
multiline_comment|/* 0x81 if Query Reply */
DECL|member|qcode
r_char
id|qcode
suffix:semicolon
multiline_comment|/* 0x81 if Usable Area */
DECL|macro|QCODE_UA
mdefine_line|#define QCODE_UA 0x81
DECL|member|flags0
r_char
id|flags0
suffix:semicolon
DECL|macro|FLAGS0_ADDR
mdefine_line|#define FLAGS0_ADDR 0x0f
DECL|macro|FLAGS0_ADDR_12_14
mdefine_line|#define FLAGS0_ADDR_12_14       1       /* 12/14-bit adrs ok */
DECL|macro|FLAGS0_ADDR_12_14_16
mdefine_line|#define FLAGS0_ADDR_12_14_16    3       /* 12/14/16-bit adrs ok */
DECL|member|flags1
r_char
id|flags1
suffix:semicolon
DECL|member|w
r_int
id|w
suffix:semicolon
multiline_comment|/* Width of usable area */
DECL|member|h
r_int
id|h
suffix:semicolon
multiline_comment|/* Heigth of usavle area */
DECL|member|units
r_char
id|units
suffix:semicolon
multiline_comment|/* 0x00:in; 0x01:mm */
DECL|member|xr
r_int
id|xr
suffix:semicolon
DECL|member|yr
r_int
id|yr
suffix:semicolon
DECL|member|aw
r_char
id|aw
suffix:semicolon
DECL|member|ah
r_char
id|ah
suffix:semicolon
DECL|member|buffsz
r_int
id|buffsz
suffix:semicolon
multiline_comment|/* Character buffer size, bytes */
DECL|member|xmin
r_char
id|xmin
suffix:semicolon
DECL|member|ymin
r_char
id|ymin
suffix:semicolon
DECL|member|xmax
r_char
id|xmax
suffix:semicolon
DECL|member|ymax
r_char
id|ymax
suffix:semicolon
DECL|typedef|uab_t
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
id|uab_t
suffix:semicolon
multiline_comment|/*&n; * Structure representing Alternate Usable Area Self-Defining Parameter&n; */
r_typedef
r_struct
(brace
DECL|member|l
r_char
id|l
suffix:semicolon
multiline_comment|/* Length of this Self-Defining Parm */
DECL|member|sdpid
r_char
id|sdpid
suffix:semicolon
multiline_comment|/* 0x02 if Alternate Usable Area */
DECL|macro|SDPID_AUA
mdefine_line|#define SDPID_AUA 0x02
DECL|member|res
r_char
id|res
suffix:semicolon
DECL|member|auaid
r_char
id|auaid
suffix:semicolon
multiline_comment|/* 0x01 is Id for the A U A */
DECL|member|wauai
r_int
id|wauai
suffix:semicolon
multiline_comment|/* Width of AUAi */
DECL|member|hauai
r_int
id|hauai
suffix:semicolon
multiline_comment|/* Height of AUAi */
DECL|member|auaunits
r_char
id|auaunits
suffix:semicolon
multiline_comment|/* 0x00:in, 0x01:mm */
DECL|member|auaxr
r_int
id|auaxr
suffix:semicolon
DECL|member|auayr
r_int
id|auayr
suffix:semicolon
DECL|member|awauai
r_char
id|awauai
suffix:semicolon
DECL|member|ahauai
r_char
id|ahauai
suffix:semicolon
DECL|typedef|aua_t
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
id|aua_t
suffix:semicolon
multiline_comment|/*&n; * Structure representing one followed by the other&n; */
r_typedef
r_struct
(brace
DECL|member|uab
id|uab_t
id|uab
suffix:semicolon
DECL|member|aua
id|aua_t
id|aua
suffix:semicolon
DECL|typedef|ua_t
)brace
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
id|ua_t
suffix:semicolon
multiline_comment|/*&n; * Try to determine screen size using Read Partition (Query)&n; */
r_int
DECL|function|tty3270_size
id|tty3270_size
c_func
(paren
id|tub_t
op_star
id|tubp
comma
r_int
op_star
id|flags
)paren
(brace
r_char
id|wbuf
(braket
l_int|7
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x07
comma
l_int|0x01
comma
l_int|0xff
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x81
)brace
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
r_char
op_star
id|cp
suffix:semicolon
id|ua_t
op_star
id|uap
suffix:semicolon
r_char
id|miniscreen
(braket
l_int|256
)braket
suffix:semicolon
r_char
(paren
op_star
id|screen
)paren
(braket
)braket
suffix:semicolon
r_int
id|screenl
suffix:semicolon
r_int
id|geom_rows
comma
id|geom_cols
comma
id|fourteenbitadr
suffix:semicolon
r_void
(paren
op_star
id|oldint
)paren
(paren
r_struct
id|tub_s
op_star
comma
id|devstat_t
op_star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;flags
op_amp
id|TUB_SIZED
)paren
r_return
l_int|0
suffix:semicolon
id|fourteenbitadr
op_assign
l_int|0
suffix:semicolon
id|geom_rows
op_assign
id|tubp-&gt;geom_rows
suffix:semicolon
id|geom_cols
op_assign
id|tubp-&gt;geom_cols
suffix:semicolon
id|oldint
op_assign
id|tubp-&gt;intv
suffix:semicolon
id|tubp-&gt;intv
op_assign
id|tty3270_size_int
suffix:semicolon
r_if
c_cond
(paren
id|tubp-&gt;cmd
op_eq
id|TBC_CONOPEN
)paren
(brace
id|tubp-&gt;ttyccw.cmd_code
op_assign
id|TC_EWRITEA
suffix:semicolon
id|cp
op_assign
id|miniscreen
suffix:semicolon
op_star
id|cp
op_increment
op_assign
id|TW_KR
suffix:semicolon
multiline_comment|/* more? */
id|tubp-&gt;ttyccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|tubp-&gt;ttyccw.cda
op_assign
id|virt_to_phys
c_func
(paren
id|miniscreen
)paren
suffix:semicolon
id|tubp-&gt;ttyccw.count
op_assign
(paren
r_char
op_star
)paren
id|cp
op_minus
id|miniscreen
suffix:semicolon
id|rc
op_assign
id|tty3270_size_io
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|rc
op_assign
id|tty3270_size_wait
c_func
(paren
id|tubp
comma
id|flags
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tubp-&gt;ttyccw.cmd_code
op_assign
id|TC_WRITESF
suffix:semicolon
id|tubp-&gt;ttyccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|tubp-&gt;ttyccw.cda
op_assign
id|virt_to_phys
c_func
(paren
id|wbuf
)paren
suffix:semicolon
id|tubp-&gt;ttyccw.count
op_assign
r_sizeof
id|wbuf
suffix:semicolon
id|try_again
suffix:colon
id|rc
op_assign
id|tty3270_size_io
c_func
(paren
id|tubp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|printk
c_func
(paren
l_string|&quot;tty3270_size_io returned %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|rc
op_assign
id|tty3270_size_wait
c_func
(paren
id|tubp
comma
id|flags
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
r_goto
id|do_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Unit-Check Processing:&n;&t; * Expect Command Reject or Intervention Required.&n;&t; * For Command Reject assume old hdwe/software and&n;&t; * set a default size of 80x24.&n;&t; * For Intervention Required, wait for signal pending&n;&t; * or Unsolicited Device End; if the latter, retry.&n;&t; */
r_if
c_cond
(paren
id|tubp-&gt;dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
(brace
r_if
c_cond
(paren
id|tubp-&gt;sense.data
(braket
l_int|0
)braket
op_amp
id|SNS0_CMD_REJECT
)paren
(brace
r_goto
id|use_diag210
suffix:semicolon
multiline_comment|/* perhaps it&squot;s tn3270 */
)brace
r_else
r_if
c_cond
(paren
id|tubp-&gt;sense.data
(braket
l_int|0
)braket
op_amp
id|SNS0_INTERVENTION_REQ
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_size_wait
c_func
(paren
id|tubp
comma
id|flags
comma
id|DEV_STAT_DEV_END
)paren
)paren
)paren
r_goto
id|do_return
suffix:semicolon
r_goto
id|try_again
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;tty3270_size(): unkn sense %.2x&bslash;n&quot;
comma
id|tubp-&gt;sense.data
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty3270_size_wait
c_func
(paren
id|tubp
comma
id|flags
comma
id|DEV_STAT_ATTENTION
)paren
)paren
)paren
r_goto
id|do_return
suffix:semicolon
multiline_comment|/* Set up a read ccw and issue it */
id|tubp-&gt;ttyccw.cmd_code
op_assign
id|TC_READMOD
suffix:semicolon
id|tubp-&gt;ttyccw.flags
op_assign
id|CCW_FLAG_SLI
suffix:semicolon
id|tubp-&gt;ttyccw.cda
op_assign
id|virt_to_phys
c_func
(paren
id|miniscreen
)paren
suffix:semicolon
id|tubp-&gt;ttyccw.count
op_assign
r_sizeof
id|miniscreen
suffix:semicolon
id|tty3270_size_io
c_func
(paren
id|tubp
)paren
suffix:semicolon
id|rc
op_assign
id|tty3270_size_wait
c_func
(paren
id|tubp
comma
id|flags
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
r_goto
id|do_return
suffix:semicolon
id|count
op_assign
r_sizeof
id|miniscreen
op_minus
id|tubp-&gt;cswl
suffix:semicolon
id|cp
op_assign
id|miniscreen
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_increment
op_ne
l_int|0x88
)paren
r_goto
id|do_return
suffix:semicolon
id|uap
op_assign
(paren
r_void
op_star
)paren
id|cp
suffix:semicolon
r_if
c_cond
(paren
id|uap-&gt;uab.qcode
op_ne
id|QCODE_UA
)paren
r_goto
id|do_return
suffix:semicolon
id|geom_rows
op_assign
id|uap-&gt;uab.h
suffix:semicolon
id|geom_cols
op_assign
id|uap-&gt;uab.w
suffix:semicolon
r_if
c_cond
(paren
(paren
id|uap-&gt;uab.flags0
op_amp
id|FLAGS0_ADDR
)paren
op_eq
id|FLAGS0_ADDR_12_14
op_logical_or
(paren
id|uap-&gt;uab.flags0
op_amp
id|FLAGS0_ADDR
)paren
op_eq
id|FLAGS0_ADDR_12_14_16
)paren
id|fourteenbitadr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|uap-&gt;uab.l
op_le
r_sizeof
id|uap-&gt;uab
)paren
r_goto
id|do_return
suffix:semicolon
r_if
c_cond
(paren
id|uap-&gt;aua.sdpid
op_ne
id|SDPID_AUA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;AUA sdpid was 0x%.2x, expecting 0x%.2x&bslash;n&quot;
comma
id|uap-&gt;aua.sdpid
comma
id|SDPID_AUA
)paren
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
)brace
id|geom_rows
op_assign
id|uap-&gt;aua.hauai
suffix:semicolon
id|geom_cols
op_assign
id|uap-&gt;aua.wauai
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
id|use_diag210
suffix:colon
r_if
c_cond
(paren
id|MACHINE_IS_VM
)paren
(brace
id|diag210_t
id|d210
suffix:semicolon
id|d210.vrdcdvno
op_assign
id|tubp-&gt;devno
suffix:semicolon
id|d210.vrdclen
op_assign
r_sizeof
id|d210
suffix:semicolon
id|rc
op_assign
id|diag210
c_func
(paren
op_amp
id|d210
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tty3270_size: diag210 for 0x%.4x &quot;
l_string|&quot;returned %d&bslash;n&quot;
comma
id|tubp-&gt;devno
comma
id|rc
)paren
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|d210.vrdccrmd
)paren
(brace
r_case
l_int|2
suffix:colon
id|geom_rows
op_assign
l_int|24
suffix:semicolon
id|geom_cols
op_assign
l_int|80
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_case
l_int|3
suffix:colon
id|geom_rows
op_assign
l_int|32
suffix:semicolon
id|geom_cols
op_assign
l_int|80
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_case
l_int|4
suffix:colon
id|geom_rows
op_assign
l_int|43
suffix:semicolon
id|geom_cols
op_assign
l_int|80
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_case
l_int|5
suffix:colon
id|geom_rows
op_assign
l_int|27
suffix:semicolon
id|geom_cols
op_assign
l_int|132
suffix:semicolon
r_goto
id|do_return
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;vrdccrmd is 0x%.8x&bslash;n&quot;
comma
id|d210.vrdccrmd
)paren
suffix:semicolon
)brace
)brace
id|do_return
suffix:colon
r_if
c_cond
(paren
id|geom_rows
op_eq
l_int|0
)paren
(brace
id|geom_rows
op_assign
id|_GEOM_ROWS
suffix:semicolon
id|geom_cols
op_assign
id|_GEOM_COLS
suffix:semicolon
)brace
id|tubp-&gt;tubiocb.pf_cnt
op_assign
l_int|24
suffix:semicolon
id|tubp-&gt;tubiocb.re_cnt
op_assign
l_int|20
suffix:semicolon
id|tubp-&gt;tubiocb.map
op_assign
l_int|0
suffix:semicolon
id|screenl
op_assign
id|geom_rows
op_star
id|geom_cols
op_plus
l_int|100
suffix:semicolon
id|screen
op_assign
(paren
r_char
(paren
op_star
)paren
(braket
)braket
)paren
id|kmalloc
c_func
(paren
id|screenl
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|screen
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ttyscreen size %d unavailable&bslash;n&quot;
comma
id|screenl
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|tubp-&gt;ttyscreen
)paren
id|kfree
c_func
(paren
id|tubp-&gt;ttyscreen
)paren
suffix:semicolon
id|tubp-&gt;tubiocb.line_cnt
op_assign
id|tubp-&gt;geom_rows
op_assign
id|geom_rows
suffix:semicolon
id|tubp-&gt;tubiocb.col_cnt
op_assign
id|tubp-&gt;geom_cols
op_assign
id|geom_cols
suffix:semicolon
id|tubp-&gt;tty_14bitadr
op_assign
id|fourteenbitadr
suffix:semicolon
id|tubp-&gt;ttyscreen
op_assign
id|screen
suffix:semicolon
id|tubp-&gt;ttyscreenl
op_assign
id|screenl
suffix:semicolon
r_if
c_cond
(paren
id|geom_rows
op_eq
l_int|24
op_logical_and
id|geom_cols
op_eq
l_int|80
)paren
id|tubp-&gt;tubiocb.model
op_assign
l_int|2
suffix:semicolon
r_else
r_if
c_cond
(paren
id|geom_rows
op_eq
l_int|32
op_logical_and
id|geom_cols
op_eq
l_int|80
)paren
id|tubp-&gt;tubiocb.model
op_assign
l_int|3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|geom_rows
op_eq
l_int|43
op_logical_and
id|geom_cols
op_eq
l_int|80
)paren
id|tubp-&gt;tubiocb.model
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|geom_rows
op_eq
l_int|27
op_logical_and
id|geom_cols
op_eq
l_int|132
)paren
id|tubp-&gt;tubiocb.model
op_assign
l_int|5
suffix:semicolon
r_else
id|tubp-&gt;tubiocb.model
op_assign
l_int|0
suffix:semicolon
id|tubp-&gt;flags
op_or_assign
id|TUB_SIZED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
op_logical_and
id|tubp-&gt;ttyscreen
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|tubp-&gt;intv
op_assign
id|oldint
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|tty3270_size_io
id|tty3270_size_io
c_func
(paren
id|tub_t
op_star
id|tubp
)paren
(brace
id|tubp-&gt;flags
op_or_assign
id|TUB_WORKING
suffix:semicolon
id|tubp-&gt;dstat
op_assign
l_int|0
suffix:semicolon
r_return
id|do_IO
c_func
(paren
id|tubp-&gt;irq
comma
op_amp
id|tubp-&gt;ttyccw
comma
id|tubp-&gt;irq
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|tty3270_size_int
id|tty3270_size_int
c_func
(paren
id|tub_t
op_star
id|tubp
comma
id|devstat_t
op_star
id|dsp
)paren
(brace
DECL|macro|DEV_NOT_WORKING
mdefine_line|#define DEV_NOT_WORKING &bslash;&n;  (DEV_STAT_ATTENTION | DEV_STAT_DEV_END | DEV_STAT_UNIT_CHECK)
id|tubp-&gt;dstat
op_assign
id|dsp-&gt;dstat
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_STAT_CHN_END
)paren
id|tubp-&gt;cswl
op_assign
id|dsp-&gt;rescnt
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_NOT_WORKING
)paren
id|tubp-&gt;flags
op_and_assign
op_complement
id|TUB_WORKING
suffix:semicolon
r_if
c_cond
(paren
id|dsp-&gt;dstat
op_amp
id|DEV_STAT_UNIT_CHECK
)paren
id|tubp-&gt;sense
op_assign
id|dsp-&gt;ii.sense
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tubp-&gt;waitq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for something.  If the third arg is zero, wait until&n; * tty3270_size_int() turns off TUB_WORKING.  If the third arg&n; * is not zero, it is a device-status bit; wait until dstat&n; * has the bit turned on.  Never wait if signal is pending.&n; * Return 0 unless signal pending, in which case -ERESTARTSYS.&n; */
r_static
r_int
DECL|function|tty3270_size_wait
id|tty3270_size_wait
c_func
(paren
id|tub_t
op_star
id|tubp
comma
r_int
op_star
id|flags
comma
r_int
id|stat
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|tubp-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_and
(paren
id|stat
ques
c_cond
(paren
id|tubp-&gt;dstat
op_amp
id|stat
)paren
op_eq
l_int|0
suffix:colon
(paren
id|tubp-&gt;flags
op_amp
id|TUB_WORKING
)paren
op_ne
l_int|0
)paren
)paren
(brace
macro_line|#warning FIXME: [kj] use set_current_state instead of current-&gt;state=
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|TUBUNLOCK
c_func
(paren
id|tubp-&gt;irq
comma
op_star
id|flags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
macro_line|#warning FIXME: [kj] use set_current_state instead of current-&gt;state=
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|TUBLOCK
c_func
(paren
id|tubp-&gt;irq
comma
op_star
id|flags
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|tubp-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
id|signal_pending
c_func
(paren
id|current
)paren
ques
c_cond
op_minus
id|ERESTARTSYS
suffix:colon
l_int|0
suffix:semicolon
)brace
eof
