multiline_comment|/*&n; * linux/drivers/s390/scsi/zfcp_sysfs_adapter.c&n; *&n; * FCP adapter driver for IBM eServer zSeries&n; *&n; * sysfs adapter related routines&n; *&n; * (C) Copyright IBM Corp. 2003, 2004&n; *&n; * Authors:&n; *      Martin Peschke &lt;mpeschke@de.ibm.com&gt;&n; *&t;Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
DECL|macro|ZFCP_SYSFS_ADAPTER_C_REVISION
mdefine_line|#define ZFCP_SYSFS_ADAPTER_C_REVISION &quot;$Revision: 1.32 $&quot;
macro_line|#include &lt;asm/ccwdev.h&gt;
macro_line|#include &quot;zfcp_ext.h&quot;
macro_line|#include &quot;zfcp_def.h&quot;
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA                   ZFCP_LOG_AREA_CONFIG
DECL|variable|fc_topologies
r_static
r_const
r_char
id|fc_topologies
(braket
l_int|5
)braket
(braket
l_int|25
)braket
op_assign
(brace
(brace
l_string|&quot;&lt;error&gt;&quot;
)brace
comma
(brace
l_string|&quot;point-to-point&quot;
)brace
comma
(brace
l_string|&quot;fabric&quot;
)brace
comma
(brace
l_string|&quot;arbitrated loop&quot;
)brace
comma
(brace
l_string|&quot;fabric (virt. adapter)&quot;
)brace
)brace
suffix:semicolon
multiline_comment|/**&n; * ZFCP_DEFINE_ADAPTER_ATTR&n; * @_name:   name of show attribute&n; * @_format: format string&n; * @_value:  value to print&n; *&n; * Generates attributes for an adapter.&n; */
DECL|macro|ZFCP_DEFINE_ADAPTER_ATTR
mdefine_line|#define ZFCP_DEFINE_ADAPTER_ATTR(_name, _format, _value)                      &bslash;&n;static ssize_t zfcp_sysfs_adapter_##_name##_show(struct device *dev,          &bslash;&n;&t;&t;&t;&t;&t;&t; char *buf)                   &bslash;&n;{                                                                             &bslash;&n;&t;struct zfcp_adapter *adapter;                                         &bslash;&n;                                                                              &bslash;&n;&t;adapter = dev_get_drvdata(dev);                                       &bslash;&n;&t;return sprintf(buf, _format, _value);                                 &bslash;&n;}                                                                             &bslash;&n;                                                                              &bslash;&n;static DEVICE_ATTR(_name, S_IRUGO, zfcp_sysfs_adapter_##_name##_show, NULL);
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|status
comma
l_string|&quot;0x%08x&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;status
)paren
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|wwnn
comma
l_string|&quot;0x%016llx&bslash;n&quot;
comma
id|adapter-&gt;wwnn
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|wwpn
comma
l_string|&quot;0x%016llx&bslash;n&quot;
comma
id|adapter-&gt;wwpn
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|s_id
comma
l_string|&quot;0x%06x&bslash;n&quot;
comma
id|adapter-&gt;s_id
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|card_version
comma
l_string|&quot;0x%04x&bslash;n&quot;
comma
id|adapter-&gt;hydra_version
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|lic_version
comma
l_string|&quot;0x%08x&bslash;n&quot;
comma
id|adapter-&gt;fsf_lic_version
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|fc_link_speed
comma
l_string|&quot;%d Gb/s&bslash;n&quot;
comma
id|adapter-&gt;fc_link_speed
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|fc_service_class
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|adapter-&gt;fc_service_class
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|fc_topology
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|fc_topologies
(braket
id|adapter-&gt;fc_topology
)braket
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|hardware_version
comma
l_string|&quot;0x%08x&bslash;n&quot;
comma
id|adapter-&gt;hardware_version
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|serial_number
comma
l_string|&quot;%17s&bslash;n&quot;
comma
id|adapter-&gt;serial_number
)paren
suffix:semicolon
id|ZFCP_DEFINE_ADAPTER_ATTR
c_func
(paren
id|scsi_host_no
comma
l_string|&quot;0x%x&bslash;n&quot;
comma
id|adapter-&gt;scsi_host_no
)paren
suffix:semicolon
multiline_comment|/**&n; * zfcp_sysfs_adapter_in_recovery_show - recovery state of adapter&n; * @dev: pointer to belonging device&n; * @buf: pointer to input buffer&n; *&n; * Show function of &quot;in_recovery&quot; attribute of adapter. Will be&n; * &quot;0&quot; if no error recovery is pending for adapter, otherwise &quot;1&quot;.&n; */
r_static
id|ssize_t
DECL|function|zfcp_sysfs_adapter_in_recovery_show
id|zfcp_sysfs_adapter_in_recovery_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|adapter-&gt;status
)paren
)paren
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;1&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;0&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|in_recovery
comma
id|S_IRUGO
comma
id|zfcp_sysfs_adapter_in_recovery_show
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/**&n; * zfcp_sysfs_port_add_store - add a port to sysfs tree&n; * @dev: pointer to belonging device&n; * @buf: pointer to input buffer&n; * @count: number of bytes in buffer&n; *&n; * Store function of the &quot;port_add&quot; attribute of an adapter.&n; */
r_static
id|ssize_t
DECL|function|zfcp_sysfs_port_add_store
id|zfcp_sysfs_port_add_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|wwn_t
id|wwpn
suffix:semicolon
r_char
op_star
id|endp
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|wwpn
op_assign
id|simple_strtoull
c_func
(paren
id|buf
comma
op_amp
id|endp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|endp
op_plus
l_int|1
)paren
OL
(paren
id|buf
op_plus
id|count
)paren
)paren
r_goto
id|out
suffix:semicolon
id|port
op_assign
id|zfcp_port_enqueue
c_func
(paren
id|adapter
comma
id|wwpn
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|port-&gt;adapter
)paren
suffix:semicolon
id|zfcp_port_put
c_func
(paren
id|port
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
r_return
id|retval
ques
c_cond
id|retval
suffix:colon
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|port_add
comma
id|S_IWUSR
comma
l_int|NULL
comma
id|zfcp_sysfs_port_add_store
)paren
suffix:semicolon
multiline_comment|/**&n; * zfcp_sysfs_port_remove_store - remove a port from sysfs tree&n; * @dev: pointer to belonging device&n; * @buf: pointer to input buffer&n; * @count: number of bytes in buffer&n; *&n; * Store function of the &quot;port_remove&quot; attribute of an adapter.&n; */
r_static
id|ssize_t
DECL|function|zfcp_sysfs_port_remove_store
id|zfcp_sysfs_port_remove_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|wwn_t
id|wwpn
suffix:semicolon
r_char
op_star
id|endp
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|wwpn
op_assign
id|simple_strtoull
c_func
(paren
id|buf
comma
op_amp
id|endp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|endp
op_plus
l_int|1
)paren
OL
(paren
id|buf
op_plus
id|count
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|write_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|port
op_assign
id|zfcp_get_port_by_wwpn
c_func
(paren
id|adapter
comma
id|wwpn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_logical_and
(paren
id|atomic_read
c_func
(paren
op_amp
id|port-&gt;refcount
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|zfcp_port_get
c_func
(paren
id|port
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|list_move
c_func
(paren
op_amp
id|port-&gt;list
comma
op_amp
id|adapter-&gt;port_remove_lh
)paren
suffix:semicolon
)brace
r_else
(brace
id|port
op_assign
l_int|NULL
suffix:semicolon
)brace
id|write_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
(brace
id|retval
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|zfcp_erp_port_shutdown
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|zfcp_port_put
c_func
(paren
id|port
)paren
suffix:semicolon
id|zfcp_port_dequeue
c_func
(paren
id|port
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
r_return
id|retval
ques
c_cond
id|retval
suffix:colon
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|port_remove
comma
id|S_IWUSR
comma
l_int|NULL
comma
id|zfcp_sysfs_port_remove_store
)paren
suffix:semicolon
multiline_comment|/**&n; * zfcp_sysfs_adapter_failed_store - failed state of adapter&n; * @dev: pointer to belonging device&n; * @buf: pointer to input buffer&n; * @count: number of bytes in buffer&n; *&n; * Store function of the &quot;failed&quot; attribute of an adapter.&n; * If a &quot;0&quot; gets written to &quot;failed&quot;, error recovery will be&n; * started for the belonging adapter.&n; */
r_static
id|ssize_t
DECL|function|zfcp_sysfs_adapter_failed_store
id|zfcp_sysfs_adapter_failed_store
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
r_char
op_star
id|endp
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|val
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|endp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|endp
op_plus
l_int|1
)paren
OL
(paren
id|buf
op_plus
id|count
)paren
)paren
op_logical_or
(paren
id|val
op_ne
l_int|0
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
r_return
id|retval
ques
c_cond
id|retval
suffix:colon
id|count
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_sysfs_adapter_failed_show - failed state of adapter&n; * @dev: pointer to belonging device&n; * @buf: pointer to input buffer&n; *&n; * Show function of &quot;failed&quot; attribute of adapter. Will be&n; * &quot;0&quot; if adapter is working, otherwise &quot;1&quot;.&n; */
r_static
id|ssize_t
DECL|function|zfcp_sysfs_adapter_failed_show
id|zfcp_sysfs_adapter_failed_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|adapter-&gt;status
)paren
)paren
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;1&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;0&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|failed
comma
id|S_IWUSR
op_or
id|S_IRUGO
comma
id|zfcp_sysfs_adapter_failed_show
comma
id|zfcp_sysfs_adapter_failed_store
)paren
suffix:semicolon
DECL|variable|zfcp_adapter_attrs
r_static
r_struct
id|attribute
op_star
id|zfcp_adapter_attrs
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_failed.attr
comma
op_amp
id|dev_attr_in_recovery.attr
comma
op_amp
id|dev_attr_port_remove.attr
comma
op_amp
id|dev_attr_port_add.attr
comma
op_amp
id|dev_attr_wwnn.attr
comma
op_amp
id|dev_attr_wwpn.attr
comma
op_amp
id|dev_attr_s_id.attr
comma
op_amp
id|dev_attr_card_version.attr
comma
op_amp
id|dev_attr_lic_version.attr
comma
op_amp
id|dev_attr_fc_link_speed.attr
comma
op_amp
id|dev_attr_fc_service_class.attr
comma
op_amp
id|dev_attr_fc_topology.attr
comma
op_amp
id|dev_attr_scsi_host_no.attr
comma
op_amp
id|dev_attr_status.attr
comma
op_amp
id|dev_attr_hardware_version.attr
comma
op_amp
id|dev_attr_serial_number.attr
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|zfcp_adapter_attr_group
r_static
r_struct
id|attribute_group
id|zfcp_adapter_attr_group
op_assign
(brace
dot
id|attrs
op_assign
id|zfcp_adapter_attrs
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * zfcp_sysfs_create_adapter_files - create sysfs adapter files&n; * @dev: pointer to belonging device&n; *&n; * Create all attributes of the sysfs representation of an adapter.&n; */
r_int
DECL|function|zfcp_sysfs_adapter_create_files
id|zfcp_sysfs_adapter_create_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
id|sysfs_create_group
c_func
(paren
op_amp
id|dev-&gt;kobj
comma
op_amp
id|zfcp_adapter_attr_group
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_sysfs_remove_adapter_files - remove sysfs adapter files&n; * @dev: pointer to belonging device&n; *&n; * Remove all attributes of the sysfs representation of an adapter.&n; */
r_void
DECL|function|zfcp_sysfs_adapter_remove_files
id|zfcp_sysfs_adapter_remove_files
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
id|sysfs_remove_group
c_func
(paren
op_amp
id|dev-&gt;kobj
comma
op_amp
id|zfcp_adapter_attr_group
)paren
suffix:semicolon
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
eof
