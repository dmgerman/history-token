multiline_comment|/*&n; * linux/drivers/s390/scsi/zfcp_qdio.c&n; *&n; * FCP adapter driver for IBM eServer zSeries&n; *&n; * QDIO related routines&n; *&n; * Copyright (C) 2003 IBM Entwicklung GmbH, IBM Corporation&n; * Authors:&n; *      Martin Peschke &lt;mpeschke@de.ibm.com&gt;&n; *      Raimund Schroeder &lt;raimund.schroeder@de.ibm.com&gt;&n; *      Wolfgang Taphorn &lt;taphorn@de.ibm.com&gt;&n; *      Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
DECL|macro|ZFCP_QDIO_C_REVISION
mdefine_line|#define ZFCP_QDIO_C_REVISION &quot;$Revision: 1.10 $&quot;
macro_line|#include &quot;zfcp_ext.h&quot;
DECL|variable|zfcp_qdio_request_handler
r_static
id|qdio_handler_t
id|zfcp_qdio_request_handler
suffix:semicolon
DECL|variable|zfcp_qdio_response_handler
r_static
id|qdio_handler_t
id|zfcp_qdio_response_handler
suffix:semicolon
r_static
r_int
id|zfcp_qdio_handler_error_check
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA                   ZFCP_LOG_AREA_QDIO
DECL|macro|ZFCP_LOG_AREA_PREFIX
mdefine_line|#define ZFCP_LOG_AREA_PREFIX            ZFCP_LOG_AREA_PREFIX_QDIO
multiline_comment|/*&n; * Allocates BUFFER memory to each of the pointers of the qdio_buffer_t &n; * array in the adapter struct.&n; * Cur_buf is the pointer array and count can be any number of required &n; * buffers, the page-fitting arithmetic is done entirely within this funciton.&n; *&n; * returns:&t;number of buffers allocated&n; * locks:       must only be called with zfcp_data.config_sema taken&n; */
r_static
r_int
DECL|function|zfcp_qdio_buffers_enqueue
id|zfcp_qdio_buffers_enqueue
c_func
(paren
r_struct
id|qdio_buffer
op_star
op_star
id|cur_buf
comma
r_int
id|count
)paren
(brace
r_int
id|buf_pos
suffix:semicolon
r_int
id|qdio_buffers_per_page
suffix:semicolon
r_int
id|page_pos
op_assign
l_int|0
suffix:semicolon
r_struct
id|qdio_buffer
op_star
id|first_in_page
op_assign
l_int|NULL
suffix:semicolon
id|qdio_buffers_per_page
op_assign
id|PAGE_SIZE
op_div
r_sizeof
(paren
r_struct
id|qdio_buffer
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Buffers per page %d.&bslash;n&quot;
comma
id|qdio_buffers_per_page
)paren
suffix:semicolon
r_for
c_loop
(paren
id|buf_pos
op_assign
l_int|0
suffix:semicolon
id|buf_pos
OL
id|count
suffix:semicolon
id|buf_pos
op_increment
)paren
(brace
r_if
c_cond
(paren
id|page_pos
op_eq
l_int|0
)paren
(brace
id|cur_buf
(braket
id|buf_pos
)braket
op_assign
(paren
r_struct
id|qdio_buffer
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cur_buf
(braket
id|buf_pos
)braket
op_eq
l_int|NULL
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not allocate &quot;
l_string|&quot;memory for qdio transfer &quot;
l_string|&quot;structures.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|first_in_page
op_assign
id|cur_buf
(braket
id|buf_pos
)braket
suffix:semicolon
)brace
r_else
(brace
id|cur_buf
(braket
id|buf_pos
)braket
op_assign
id|first_in_page
op_plus
id|page_pos
suffix:semicolon
)brace
multiline_comment|/* was initialised to zero */
id|page_pos
op_increment
suffix:semicolon
id|page_pos
op_mod_assign
id|qdio_buffers_per_page
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|buf_pos
suffix:semicolon
)brace
multiline_comment|/*&n; * Frees BUFFER memory for each of the pointers of the struct qdio_buffer array&n; * in the adapter struct cur_buf is the pointer array and count can be any&n; * number of buffers in the array that should be freed starting from buffer 0&n; *&n; * locks:       must only be called with zfcp_data.config_sema taken&n; */
r_static
r_void
DECL|function|zfcp_qdio_buffers_dequeue
id|zfcp_qdio_buffers_dequeue
c_func
(paren
r_struct
id|qdio_buffer
op_star
op_star
id|cur_buf
comma
r_int
id|count
)paren
(brace
r_int
id|buf_pos
suffix:semicolon
r_int
id|qdio_buffers_per_page
suffix:semicolon
id|qdio_buffers_per_page
op_assign
id|PAGE_SIZE
op_div
r_sizeof
(paren
r_struct
id|qdio_buffer
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Buffers per page %d.&bslash;n&quot;
comma
id|qdio_buffers_per_page
)paren
suffix:semicolon
r_for
c_loop
(paren
id|buf_pos
op_assign
l_int|0
suffix:semicolon
id|buf_pos
OL
id|count
suffix:semicolon
id|buf_pos
op_add_assign
id|qdio_buffers_per_page
)paren
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|cur_buf
(braket
id|buf_pos
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* locks:       must only be called with zfcp_data.config_sema taken */
r_int
DECL|function|zfcp_qdio_allocate_queues
id|zfcp_qdio_allocate_queues
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|buffer_count
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|buffer_count
op_assign
id|zfcp_qdio_buffers_enqueue
c_func
(paren
op_amp
(paren
id|adapter-&gt;request_queue.buffer
(braket
l_int|0
)braket
)paren
comma
id|QDIO_MAX_BUFFERS_PER_Q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer_count
OL
id|QDIO_MAX_BUFFERS_PER_Q
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Out of memory allocating &quot;
l_string|&quot;request queue, only %d buffers got. &quot;
l_string|&quot;Binning them.&bslash;n&quot;
comma
id|buffer_count
)paren
suffix:semicolon
id|zfcp_qdio_buffers_dequeue
c_func
(paren
op_amp
(paren
id|adapter-&gt;request_queue.buffer
(braket
l_int|0
)braket
)paren
comma
id|buffer_count
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|buffer_count
op_assign
id|zfcp_qdio_buffers_enqueue
c_func
(paren
op_amp
(paren
id|adapter-&gt;response_queue.buffer
(braket
l_int|0
)braket
)paren
comma
id|QDIO_MAX_BUFFERS_PER_Q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer_count
OL
id|QDIO_MAX_BUFFERS_PER_Q
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Out of memory allocating &quot;
l_string|&quot;response queue, only %d buffers got. &quot;
l_string|&quot;Binning them.&bslash;n&quot;
comma
id|buffer_count
)paren
suffix:semicolon
id|zfcp_qdio_buffers_dequeue
c_func
(paren
op_amp
(paren
id|adapter-&gt;response_queue.buffer
(braket
l_int|0
)braket
)paren
comma
id|buffer_count
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Deallocating request_queue Buffers.&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_qdio_buffers_dequeue
c_func
(paren
op_amp
(paren
id|adapter-&gt;request_queue.buffer
(braket
l_int|0
)braket
)paren
comma
id|QDIO_MAX_BUFFERS_PER_Q
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* locks:       must only be called with zfcp_data.config_sema taken */
r_void
DECL|function|zfcp_qdio_free_queues
id|zfcp_qdio_free_queues
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Deallocating request_queue Buffers.&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_qdio_buffers_dequeue
c_func
(paren
op_amp
(paren
id|adapter-&gt;request_queue.buffer
(braket
l_int|0
)braket
)paren
comma
id|QDIO_MAX_BUFFERS_PER_Q
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Deallocating response_queue Buffers.&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_qdio_buffers_dequeue
c_func
(paren
op_amp
(paren
id|adapter-&gt;response_queue.buffer
(braket
l_int|0
)braket
)paren
comma
id|QDIO_MAX_BUFFERS_PER_Q
)paren
suffix:semicolon
)brace
r_int
DECL|function|zfcp_qdio_allocate
id|zfcp_qdio_allocate
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_struct
id|qdio_initialize
op_star
id|init_data
suffix:semicolon
id|init_data
op_assign
op_amp
id|adapter-&gt;qdio_init_data
suffix:semicolon
id|init_data-&gt;cdev
op_assign
id|adapter-&gt;ccw_device
suffix:semicolon
id|init_data-&gt;q_format
op_assign
id|QDIO_SCSI_QFMT
suffix:semicolon
id|memcpy
c_func
(paren
id|init_data-&gt;adapter_name
comma
op_amp
id|adapter-&gt;name
comma
l_int|8
)paren
suffix:semicolon
id|init_data-&gt;qib_param_field_format
op_assign
l_int|0
suffix:semicolon
id|init_data-&gt;qib_param_field
op_assign
l_int|NULL
suffix:semicolon
id|init_data-&gt;input_slib_elements
op_assign
l_int|NULL
suffix:semicolon
id|init_data-&gt;output_slib_elements
op_assign
l_int|NULL
suffix:semicolon
id|init_data-&gt;min_input_threshold
op_assign
id|ZFCP_MIN_INPUT_THRESHOLD
suffix:semicolon
id|init_data-&gt;max_input_threshold
op_assign
id|ZFCP_MAX_INPUT_THRESHOLD
suffix:semicolon
id|init_data-&gt;min_output_threshold
op_assign
id|ZFCP_MIN_OUTPUT_THRESHOLD
suffix:semicolon
id|init_data-&gt;max_output_threshold
op_assign
id|ZFCP_MAX_OUTPUT_THRESHOLD
suffix:semicolon
id|init_data-&gt;no_input_qs
op_assign
l_int|1
suffix:semicolon
id|init_data-&gt;no_output_qs
op_assign
l_int|1
suffix:semicolon
id|init_data-&gt;input_handler
op_assign
id|zfcp_qdio_response_handler
suffix:semicolon
id|init_data-&gt;output_handler
op_assign
id|zfcp_qdio_request_handler
suffix:semicolon
id|init_data-&gt;int_parm
op_assign
(paren
r_int
r_int
)paren
id|adapter
suffix:semicolon
id|init_data-&gt;flags
op_assign
id|QDIO_INBOUND_0COPY_SBALS
op_or
id|QDIO_OUTBOUND_0COPY_SBALS
op_or
id|QDIO_USE_OUTBOUND_PCIS
suffix:semicolon
id|init_data-&gt;input_sbal_addr_array
op_assign
(paren
r_void
op_star
op_star
)paren
(paren
id|adapter-&gt;response_queue.buffer
)paren
suffix:semicolon
id|init_data-&gt;output_sbal_addr_array
op_assign
(paren
r_void
op_star
op_star
)paren
(paren
id|adapter-&gt;request_queue.buffer
)paren
suffix:semicolon
r_return
id|qdio_allocate
c_func
(paren
id|init_data
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:   &t;zfcp_qdio_handler_error_check&n; *&n; * purpose:     called by the response handler to determine error condition&n; *&n; * returns:&t;error flag&n; *&n; */
r_static
r_inline
r_int
DECL|function|zfcp_qdio_handler_error_check
id|zfcp_qdio_handler_error_check
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
r_int
id|status
comma
r_int
r_int
id|qdio_error
comma
r_int
r_int
id|siga_error
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ZFCP_LOG_CHECK
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|QDIO_STATUS_INBOUND_INT
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;status is&quot;
l_string|&quot; QDIO_STATUS_INBOUND_INT &bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|QDIO_STATUS_OUTBOUND_INT
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;status is&quot;
l_string|&quot; QDIO_STATUS_OUTBOUND_INT &bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// if (ZFCP_LOG_CHECK(ZFCP_LOG_LEVEL_TRACE))
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|status
op_amp
id|QDIO_STATUS_LOOK_FOR_ERROR
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;QDIO_STATUS_LOOK_FOR_ERROR &bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;A qdio problem occured. The status, qdio_error &quot;
l_string|&quot;and siga_error are 0x%x, 0x%x and 0x%x&bslash;n&quot;
comma
id|status
comma
id|qdio_error
comma
id|siga_error
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|QDIO_STATUS_ACTIVATE_CHECK_CONDITION
)paren
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;QDIO_STATUS_ACTIVATE_CHECK_CONDITION&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|QDIO_STATUS_MORE_THAN_ONE_QDIO_ERROR
)paren
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;QDIO_STATUS_MORE_THAN_ONE_QDIO_ERROR&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|QDIO_STATUS_MORE_THAN_ONE_SIGA_ERROR
)paren
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;QDIO_STATUS_MORE_THAN_ONE_SIGA_ERROR&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|siga_error
op_amp
id|QDIO_SIGA_ERROR_ACCESS_EXCEPTION
)paren
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;QDIO_SIGA_ERROR_ACCESS_EXCEPTION&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|siga_error
op_amp
id|QDIO_SIGA_ERROR_B_BIT_SET
)paren
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;QDIO_SIGA_ERROR_B_BIT_SET&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|qdio_error
)paren
(brace
r_case
l_int|0
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;QDIO_OK&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SLSB_P_INPUT_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;SLSB_P_INPUT_ERROR&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SLSB_P_OUTPUT_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;SLSB_P_OUTPUT_ERROR&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Unknown qdio error reported &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|qdio_error
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Restarting IO on the failed adapter from scratch */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;qdio_err&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;                * Since we have been using this adapter, it is save to assume&n;                * that it is not failed but recoverable. The card seems to&n;                * report link-up events by self-initiated queue shutdown.&n;                * That is why we need to clear the the link-down flag&n;                * which is set again in case we have missed by a mile.&n;                */
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_qdio_request_handler&n; *&n; * purpose:&t;is called by QDIO layer for completed SBALs in request queue&n; *&n; * returns:&t;(void)&n; */
r_static
r_void
DECL|function|zfcp_qdio_request_handler
id|zfcp_qdio_request_handler
c_func
(paren
r_struct
id|ccw_device
op_star
id|ccw_device
comma
r_int
r_int
id|status
comma
r_int
r_int
id|qdio_error
comma
r_int
r_int
id|siga_error
comma
r_int
r_int
id|queue_number
comma
r_int
id|first_element
comma
r_int
id|elements_processed
comma
r_int
r_int
id|int_parm
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|queue
suffix:semicolon
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|int_parm
suffix:semicolon
id|queue
op_assign
op_amp
id|adapter-&gt;request_queue
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;busid=%s, first=%d, count=%d&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|first_element
comma
id|elements_processed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|zfcp_qdio_handler_error_check
c_func
(paren
id|adapter
comma
id|status
comma
id|qdio_error
comma
id|siga_error
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * we stored address of struct zfcp_adapter  data structure&n;&t; * associated with irq in int_parm&n;&t; */
multiline_comment|/* cleanup all SBALs being program-owned now */
id|zfcp_qdio_zero_sbals
c_func
(paren
id|queue-&gt;buffer
comma
id|first_element
comma
id|elements_processed
)paren
suffix:semicolon
multiline_comment|/* increase free space in outbound queue */
id|atomic_add
c_func
(paren
id|elements_processed
comma
op_amp
id|queue-&gt;free_count
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;free_count=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|queue-&gt;free_count
)paren
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|adapter-&gt;request_wq
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Elements_processed = %d, free count=%d &bslash;n&quot;
comma
id|elements_processed
comma
id|atomic_read
c_func
(paren
op_amp
id|queue-&gt;free_count
)paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * function:   &t;zfcp_qdio_response_handler&n; *&n; * purpose:&t;is called by QDIO layer for completed SBALs in response queue&n; *&n; * returns:&t;(void)&n; */
r_static
r_void
DECL|function|zfcp_qdio_response_handler
id|zfcp_qdio_response_handler
c_func
(paren
r_struct
id|ccw_device
op_star
id|ccw_device
comma
r_int
r_int
id|status
comma
r_int
r_int
id|qdio_error
comma
r_int
r_int
id|siga_error
comma
r_int
r_int
id|queue_number
comma
r_int
id|first_element
comma
r_int
id|elements_processed
comma
r_int
r_int
id|int_parm
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|queue
suffix:semicolon
r_int
id|buffer_index
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|qdio_buffer
op_star
id|buffer
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|u8
id|count
suffix:semicolon
id|u8
id|start
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffere
op_assign
l_int|NULL
suffix:semicolon
r_int
id|buffere_index
suffix:semicolon
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|int_parm
suffix:semicolon
id|queue
op_assign
op_amp
id|adapter-&gt;response_queue
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|zfcp_qdio_handler_error_check
c_func
(paren
id|adapter
comma
id|status
comma
id|qdio_error
comma
id|siga_error
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * we stored address of struct zfcp_adapter  data structure&n;&t; * associated with irq in int_parm&n;&t; */
id|buffere
op_assign
op_amp
(paren
id|queue-&gt;buffer
(braket
id|first_element
)braket
op_member_access_from_pointer
id|element
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;first BUFFERE flags=0x%x &bslash;n &quot;
comma
id|buffere-&gt;flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * go through all SBALs from input queue currently&n;&t; * returned by QDIO layer&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|elements_processed
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buffer_index
op_assign
id|first_element
op_plus
id|i
suffix:semicolon
id|buffer_index
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|buffer
op_assign
id|queue-&gt;buffer
(braket
id|buffer_index
)braket
suffix:semicolon
multiline_comment|/* go through all SBALEs of SBAL */
r_for
c_loop
(paren
id|buffere_index
op_assign
l_int|0
suffix:semicolon
id|buffere_index
OL
id|QDIO_MAX_ELEMENTS_PER_BUFFER
suffix:semicolon
id|buffere_index
op_increment
)paren
(brace
multiline_comment|/* look for QDIO request identifiers in SB */
id|buffere
op_assign
op_amp
id|buffer-&gt;element
(braket
id|buffere_index
)braket
suffix:semicolon
id|retval
op_assign
id|zfcp_qdio_reqid_check
c_func
(paren
id|adapter
comma
(paren
r_void
op_star
)paren
id|buffere-&gt;addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Inbound packet seems not to &quot;
l_string|&quot;have been sent at all. It will be &quot;
l_string|&quot;ignored. (debug info 0x%lx, 0x%lx, &quot;
l_string|&quot;%d, %d, %s)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|buffere-&gt;addr
comma
(paren
r_int
r_int
)paren
op_amp
(paren
id|buffere-&gt;addr
)paren
comma
id|first_element
comma
id|elements_processed
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Dump of inbound BUFFER %d &quot;
l_string|&quot;BUFFERE %d at address 0x%lx&bslash;n&quot;
comma
id|buffer_index
comma
id|buffere_index
comma
(paren
r_int
r_int
)paren
id|buffer
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|buffer
comma
id|SBAL_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * A single used SBALE per inbound SBALE has been&n;&t;&t;&t; * implemented by QDIO so far. Hope they will&n;&t;&t;&t; * do some optimisation. Will need to change to&n;&t;&t;&t; * unlikely() then.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|buffere-&gt;flags
op_amp
id|SBAL_FLAGS_LAST_ENTRY
)paren
)paren
r_break
suffix:semicolon
)brace
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
(paren
id|buffere-&gt;flags
op_amp
id|SBAL_FLAGS_LAST_ENTRY
)paren
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: End of inbound data &quot;
l_string|&quot;not marked!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * put range of SBALs back to response queue&n;&t; * (including SBALs which have already been free before)&n;&t; */
id|count
op_assign
id|atomic_read
c_func
(paren
op_amp
id|queue-&gt;free_count
)paren
op_plus
id|elements_processed
suffix:semicolon
id|start
op_assign
id|queue-&gt;free_index
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Calling do QDIO busid=%s, flags=0x%x, queue_no=%i, &quot;
l_string|&quot;index_in_queue=%i, count=%i, buffers=0x%lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|QDIO_FLAG_SYNC_INPUT
op_or
id|QDIO_FLAG_UNDER_INTERRUPT
comma
l_int|0
comma
id|start
comma
id|count
comma
(paren
r_int
r_int
)paren
op_amp
id|queue-&gt;buffer
(braket
id|start
)braket
)paren
suffix:semicolon
id|retval
op_assign
id|do_QDIO
c_func
(paren
id|ccw_device
comma
id|QDIO_FLAG_SYNC_INPUT
op_or
id|QDIO_FLAG_UNDER_INTERRUPT
comma
l_int|0
comma
id|start
comma
id|count
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
)paren
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|queue-&gt;free_count
comma
id|count
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Inbound data regions could not be cleared &quot;
l_string|&quot;Transfer queues may be down. &quot;
l_string|&quot;(info %d, %d, %d)&bslash;n&quot;
comma
id|count
comma
id|start
comma
id|retval
)paren
suffix:semicolon
)brace
r_else
(brace
id|queue-&gt;free_index
op_add_assign
id|count
suffix:semicolon
id|queue-&gt;free_index
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|queue-&gt;free_count
comma
l_int|0
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;%i buffers successfully enqueued to response &quot;
l_string|&quot;queue starting at position %i&bslash;n&quot;
comma
id|count
comma
id|start
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_qdio_reqid_check&n; *&n; * purpose:&t;checks for valid reqids or unsolicited status&n; *&n; * returns:&t;0 - valid request id or unsolicited status&n; *&t;&t;!0 - otherwise&n; */
r_int
DECL|function|zfcp_qdio_reqid_check
id|zfcp_qdio_reqid_check
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_void
op_star
id|sbale_addr
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
multiline_comment|/* Note: seq is entered later */
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
l_string|&quot;i:a/seq&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
op_amp
id|sbale_addr
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
multiline_comment|/* invalid (per convention used in this driver) */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|sbale_addr
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Inbound data faulty, contains null-pointer!&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* valid request id and thus (hopefully :) valid fsf_req address */
id|fsf_req
op_assign
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
id|sbale_addr
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
(paren
id|fsf_req-&gt;common_magic
op_ne
id|ZFCP_MAGIC
)paren
op_logical_or
(paren
id|fsf_req-&gt;specific_magic
op_ne
id|ZFCP_MAGIC_FSFREQ
)paren
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An inbound FSF acknowledgement was &quot;
l_string|&quot;faulty (debug info 0x%x, 0x%x, 0x%lx)&bslash;n&quot;
comma
id|fsf_req-&gt;common_magic
comma
id|fsf_req-&gt;specific_magic
comma
(paren
r_int
r_int
)paren
id|fsf_req
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|adapter
op_ne
id|fsf_req-&gt;adapter
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An inbound FSF acknowledgement was not &quot;
l_string|&quot;correct (debug info 0x%lx, 0x%lx, 0%lx) &bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
(paren
r_int
r_int
)paren
id|fsf_req-&gt;adapter
comma
(paren
r_int
r_int
)paren
id|adapter
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
multiline_comment|/* debug feature stuff (test for QTCB: remember new unsol. status!) */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;qtcb
)paren
)paren
(brace
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.req_seq_no
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;fsf_req at 0x%lx, QTCB at 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
(paren
r_int
r_int
)paren
id|fsf_req-&gt;qtcb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;qtcb
)paren
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;HEX DUMP OF 1ST BUFFERE PAYLOAD (QTCB):&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_char
op_star
)paren
id|fsf_req-&gt;qtcb
comma
id|ZFCP_QTCB_SIZE
)paren
suffix:semicolon
)brace
multiline_comment|/* finish the FSF request */
id|zfcp_fsf_req_complete
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
r_int
DECL|function|zfcp_qdio_determine_pci
id|zfcp_qdio_determine_pci
c_func
(paren
r_struct
id|zfcp_qdio_queue
op_star
id|req_queue
comma
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|new_distance_from_int
suffix:semicolon
r_int
id|pci_pos
suffix:semicolon
id|new_distance_from_int
op_assign
id|req_queue-&gt;distance_from_int
op_plus
id|fsf_req-&gt;sbal_count
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|new_distance_from_int
op_ge
id|ZFCP_QDIO_PCI_INTERVAL
)paren
)paren
(brace
id|new_distance_from_int
op_mod_assign
id|ZFCP_QDIO_PCI_INTERVAL
suffix:semicolon
id|pci_pos
op_assign
id|fsf_req-&gt;sbal_index
suffix:semicolon
id|pci_pos
op_add_assign
id|fsf_req-&gt;sbal_count
suffix:semicolon
id|pci_pos
op_sub_assign
id|new_distance_from_int
suffix:semicolon
id|pci_pos
op_sub_assign
l_int|1
suffix:semicolon
id|pci_pos
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|req_queue-&gt;buffer
(braket
id|pci_pos
)braket
op_member_access_from_pointer
id|element
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_PCI
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Setting PCI flag at pos %d&bslash;n&quot;
comma
id|pci_pos
)paren
suffix:semicolon
)brace
r_return
id|new_distance_from_int
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_zero_sbals&n; *&n; * purpose:&t;zeros specified range of SBALs&n; *&n; * returns:&n; */
r_void
DECL|function|zfcp_qdio_zero_sbals
id|zfcp_qdio_zero_sbals
c_func
(paren
r_struct
id|qdio_buffer
op_star
id|buf
(braket
)braket
comma
r_int
id|first
comma
r_int
id|clean_count
)paren
(brace
r_int
id|cur_pos
suffix:semicolon
r_int
id|index
suffix:semicolon
r_for
c_loop
(paren
id|cur_pos
op_assign
id|first
suffix:semicolon
id|cur_pos
OL
(paren
id|first
op_plus
id|clean_count
)paren
suffix:semicolon
id|cur_pos
op_increment
)paren
(brace
id|index
op_assign
id|cur_pos
op_mod
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|memset
c_func
(paren
id|buf
(braket
id|index
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|qdio_buffer
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;zeroing BUFFER %d at address 0x%lx&bslash;n&quot;
comma
id|index
comma
(paren
r_int
r_int
)paren
id|buf
(braket
id|index
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
DECL|macro|ZFCP_LOG_AREA_PREFIX
macro_line|#undef ZFCP_LOG_AREA_PREFIX
eof
