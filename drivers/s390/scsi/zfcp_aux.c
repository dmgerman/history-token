multiline_comment|/*&n; *&n; * linux/drivers/s390/scsi/zfcp_aux.c&n; *&n; * FCP adapter driver for IBM eServer zSeries&n; *&n; * (C) Copyright IBM Corp. 2002, 2004&n; *&n; * Author(s): Martin Peschke &lt;mpeschke@de.ibm.com&gt;&n; *            Raimund Schroeder &lt;raimund.schroeder@de.ibm.com&gt;&n; *            Aron Zeh&n; *            Wolfgang Taphorn&n; *            Stefan Bader &lt;stefan.bader@de.ibm.com&gt;&n; *            Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;&n; *            Andreas Herrmann &lt;aherrman@de.ibm.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
DECL|macro|ZFCP_AUX_REVISION
mdefine_line|#define ZFCP_AUX_REVISION &quot;$Revision: 1.145 $&quot;
macro_line|#include &quot;zfcp_ext.h&quot;
multiline_comment|/* accumulated log level (module parameter) */
DECL|variable|loglevel
r_static
id|u32
id|loglevel
op_assign
id|ZFCP_LOG_LEVEL_DEFAULTS
suffix:semicolon
DECL|variable|device
r_static
r_char
op_star
id|device
suffix:semicolon
multiline_comment|/*********************** FUNCTION PROTOTYPES *********************************/
multiline_comment|/* written against the module interface */
r_static
r_int
id|__init
id|zfcp_module_init
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* FCP related */
r_static
r_void
id|zfcp_ns_gid_pn_handler
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
multiline_comment|/* miscellaneous */
r_static
r_inline
r_int
id|zfcp_sg_list_alloc
c_func
(paren
r_struct
id|zfcp_sg_list
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_inline
r_void
id|zfcp_sg_list_free
c_func
(paren
r_struct
id|zfcp_sg_list
op_star
)paren
suffix:semicolon
r_static
r_inline
r_int
id|zfcp_sg_list_copy_from_user
c_func
(paren
r_struct
id|zfcp_sg_list
op_star
comma
r_void
id|__user
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_inline
r_int
id|zfcp_sg_list_copy_to_user
c_func
(paren
r_void
id|__user
op_star
comma
r_struct
id|zfcp_sg_list
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_cfdc_dev_ioctl
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
suffix:semicolon
DECL|macro|ZFCP_CFDC_IOC_MAGIC
mdefine_line|#define ZFCP_CFDC_IOC_MAGIC                     0xDD
DECL|macro|ZFCP_CFDC_IOC
mdefine_line|#define ZFCP_CFDC_IOC &bslash;&n;&t;_IOWR(ZFCP_CFDC_IOC_MAGIC, 0, struct zfcp_cfdc_sense_data)
macro_line|#ifdef CONFIG_COMPAT
DECL|variable|zfcp_ioctl_trans
r_static
r_struct
id|ioctl_trans
id|zfcp_ioctl_trans
op_assign
(brace
id|ZFCP_CFDC_IOC
comma
(paren
r_void
op_star
)paren
id|sys_ioctl
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|zfcp_cfdc_fops
r_static
r_struct
id|file_operations
id|zfcp_cfdc_fops
op_assign
(brace
dot
id|ioctl
op_assign
id|zfcp_cfdc_dev_ioctl
)brace
suffix:semicolon
DECL|variable|zfcp_cfdc_misc
r_static
r_struct
id|miscdevice
id|zfcp_cfdc_misc
op_assign
(brace
dot
id|minor
op_assign
id|ZFCP_CFDC_DEV_MINOR
comma
dot
id|name
op_assign
id|ZFCP_CFDC_DEV_NAME
comma
dot
id|fops
op_assign
op_amp
id|zfcp_cfdc_fops
)brace
suffix:semicolon
multiline_comment|/*********************** KERNEL/MODULE PARAMETERS  ***************************/
multiline_comment|/* declare driver module init/cleanup functions */
DECL|variable|zfcp_module_init
id|module_init
c_func
(paren
id|zfcp_module_init
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;, &quot;
l_string|&quot;Andreas Herrman &lt;aherrman@de.ibm.com&gt;, &quot;
l_string|&quot;Martin Peschke &lt;mpeschke@de.ibm.com&gt;, &quot;
l_string|&quot;Raimund Schroeder &lt;raimund.schroeder@de.ibm.com&gt;, &quot;
l_string|&quot;Wolfgang Taphorn &lt;taphorn@de.ibm.com&gt;, &quot;
l_string|&quot;Aron Zeh &lt;arzeh@de.ibm.com&gt;, &quot;
l_string|&quot;IBM Deutschland Entwicklung GmbH&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;FCP (SCSI over Fibre Channel) HBA driver for IBM eServer zSeries&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|device
comma
id|charp
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|device
comma
l_string|&quot;specify initial device&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|loglevel
comma
id|uint
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|loglevel
comma
l_string|&quot;log levels, 8 nibbles: &quot;
l_string|&quot;FC ERP QDIO CIO Config FSF SCSI Other, &quot;
l_string|&quot;levels: 0=none 1=normal 2=devel 3=trace&quot;
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_PRINT_FLAGS
DECL|variable|flags_dump
id|u32
id|flags_dump
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|flags_dump
comma
id|uint
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/****************************************************************/
multiline_comment|/************** Functions without logging ***********************/
multiline_comment|/****************************************************************/
r_void
DECL|function|_zfcp_hex_dump
id|_zfcp_hex_dump
c_func
(paren
r_char
op_star
id|addr
comma
r_int
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x&quot;
comma
id|addr
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|4
)paren
op_eq
l_int|3
)paren
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_mod
l_int|32
)paren
op_eq
l_int|31
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|i
op_minus
l_int|1
)paren
op_mod
l_int|32
)paren
op_ne
l_int|31
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************/
multiline_comment|/************** Uncategorised Functions *************************/
multiline_comment|/****************************************************************/
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA&t;&t;&t;ZFCP_LOG_AREA_OTHER
r_static
r_inline
r_int
DECL|function|zfcp_fsf_req_is_scsi_cmnd
id|zfcp_fsf_req_is_scsi_cmnd
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_return
(paren
(paren
id|fsf_req-&gt;fsf_command
op_eq
id|FSF_QTCB_FCP_CMND
)paren
op_logical_and
op_logical_neg
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_TASK_MANAGEMENT
)paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|zfcp_cmd_dbf_event_fsf
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
r_const
r_char
op_star
id|text
comma
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
r_void
op_star
id|add_data
comma
r_int
id|add_length
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|scsi_cmnd
suffix:semicolon
r_int
id|level
op_assign
l_int|3
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;dbf_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_fsf_req_is_scsi_cmnd
c_func
(paren
id|fsf_req
)paren
)paren
(brace
id|scsi_cmnd
op_assign
id|fsf_req-&gt;data.send_fcp_command_task.scsi_cmnd
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
l_string|&quot;fsferror&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
id|text
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|fsf_req
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|fsf_req-&gt;seq_no
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|scsi_cmnd
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|scsi_cmnd-&gt;cmnd
comma
id|min
c_func
(paren
id|ZFCP_CMD_DBF_LENGTH
comma
(paren
r_int
)paren
id|scsi_cmnd-&gt;cmd_len
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|add_length
suffix:semicolon
id|i
op_add_assign
id|ZFCP_CMD_DBF_LENGTH
)paren
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
(paren
r_char
op_star
)paren
id|add_data
op_plus
id|i
comma
id|min
c_func
(paren
id|ZFCP_CMD_DBF_LENGTH
comma
id|add_length
op_minus
id|i
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;dbf_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX additionally log unit if available */
multiline_comment|/* ---&gt; introduce new parameter for unit, see 2.4 code */
r_void
DECL|function|zfcp_cmd_dbf_event_scsi
id|zfcp_cmd_dbf_event_scsi
c_func
(paren
r_const
r_char
op_star
id|text
comma
r_struct
id|scsi_cmnd
op_star
id|scsi_cmnd
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_union
id|zfcp_req_data
op_star
id|req_data
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
r_int
id|level
op_assign
(paren
(paren
id|host_byte
c_func
(paren
id|scsi_cmnd-&gt;result
)paren
op_ne
l_int|0
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|5
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|scsi_cmnd-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|req_data
op_assign
(paren
r_union
id|zfcp_req_data
op_star
)paren
id|scsi_cmnd-&gt;host_scribble
suffix:semicolon
id|fsf_req
op_assign
(paren
id|req_data
ques
c_cond
id|req_data-&gt;send_fcp_command_task.fsf_req
suffix:colon
l_int|NULL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;dbf_lock
comma
id|flags
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
l_string|&quot;hostbyte&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
id|text
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|scsi_cmnd-&gt;result
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|scsi_cmnd
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|scsi_cmnd-&gt;cmnd
comma
id|min
c_func
(paren
id|ZFCP_CMD_DBF_LENGTH
comma
(paren
r_int
)paren
id|scsi_cmnd-&gt;cmd_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req
)paren
)paren
(brace
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|fsf_req
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
op_amp
id|fsf_req-&gt;seq_no
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|level
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;dbf_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|zfcp_in_els_dbf_event
id|zfcp_in_els_dbf_event
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_const
r_char
op_star
id|text
comma
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
comma
r_int
id|length
)paren
(brace
r_int
id|level
op_assign
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;in_els_dbf
comma
id|level
comma
id|text
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;in_els_dbf
comma
id|level
comma
op_amp
id|status_buffer-&gt;d_id
comma
l_int|8
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_add_assign
id|ZFCP_IN_ELS_DBF_LENGTH
)paren
id|debug_event
c_func
(paren
id|adapter-&gt;in_els_dbf
comma
id|level
comma
(paren
r_char
op_star
)paren
id|status_buffer-&gt;payload
op_plus
id|i
comma
id|min
c_func
(paren
id|ZFCP_IN_ELS_DBF_LENGTH
comma
id|length
op_minus
id|i
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_device_setup - setup function&n; * @str: pointer to parameter string&n; *&n; * Parse &quot;device=...&quot; parameter string.&n; */
r_static
r_int
id|__init
DECL|function|zfcp_device_setup
id|zfcp_device_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|str
)paren
r_return
l_int|0
suffix:semicolon
id|tmp
op_assign
id|strchr
c_func
(paren
id|str
comma
l_char|&squot;,&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
r_goto
id|err_out
suffix:semicolon
op_star
id|tmp
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|zfcp_data.init_busid
comma
id|str
comma
id|BUS_ID_SIZE
)paren
suffix:semicolon
id|zfcp_data.init_busid
(braket
id|BUS_ID_SIZE
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|zfcp_data.init_wwpn
op_assign
id|simple_strtoull
c_func
(paren
id|tmp
comma
op_amp
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|tmp
op_increment
op_ne
l_char|&squot;,&squot;
)paren
r_goto
id|err_out
suffix:semicolon
r_if
c_cond
(paren
op_star
id|tmp
op_eq
l_char|&squot;&bslash;0&squot;
)paren
r_goto
id|err_out
suffix:semicolon
id|zfcp_data.init_fcp_lun
op_assign
id|simple_strtoull
c_func
(paren
id|tmp
comma
op_amp
id|tmp
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|tmp
op_ne
l_char|&squot;&bslash;0&squot;
)paren
r_goto
id|err_out
suffix:semicolon
r_return
l_int|1
suffix:semicolon
id|err_out
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Parse error for device parameter string %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|zfcp_init_device_configure
id|zfcp_init_device_configure
c_func
(paren
r_void
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|read_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|adapter
op_assign
id|zfcp_get_adapter_by_busid
c_func
(paren
id|zfcp_data.init_busid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter
)paren
id|zfcp_adapter_get
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|read_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter
op_eq
l_int|NULL
)paren
r_goto
id|out_adapter
suffix:semicolon
id|port
op_assign
id|zfcp_port_enqueue
c_func
(paren
id|adapter
comma
id|zfcp_data.init_wwpn
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_goto
id|out_port
suffix:semicolon
id|unit
op_assign
id|zfcp_unit_enqueue
c_func
(paren
id|port
comma
id|zfcp_data.init_fcp_lun
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unit
)paren
r_goto
id|out_unit
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|ccw_device_set_online
c_func
(paren
id|adapter-&gt;ccw_device
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|zfcp_unit_put
c_func
(paren
id|unit
)paren
suffix:semicolon
id|out_unit
suffix:colon
id|zfcp_port_put
c_func
(paren
id|port
)paren
suffix:semicolon
id|out_port
suffix:colon
id|zfcp_adapter_put
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|out_adapter
suffix:colon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|zfcp_module_init
id|zfcp_module_init
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|zfcp_data.loglevel
comma
id|loglevel
)paren
suffix:semicolon
multiline_comment|/* initialize adapter list */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|zfcp_data.adapter_list_head
)paren
suffix:semicolon
multiline_comment|/* initialize adapters to be removed list head */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|zfcp_data.adapter_remove_lh
)paren
suffix:semicolon
id|zfcp_transport_template
op_assign
id|fc_attach_transport
c_func
(paren
op_amp
id|zfcp_transport_functions
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zfcp_transport_template
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|retval
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|zfcp_ioctl_trans.cmd
comma
id|zfcp_ioctl_trans.handler
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;registration of ioctl32 conversion failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|misc_register
c_func
(paren
op_amp
id|zfcp_cfdc_misc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;registration of misc device &quot;
l_string|&quot;zfcp_cfdc failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_misc_register
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;major/minor for zfcp_cfdc: %d/%d&bslash;n&quot;
comma
id|ZFCP_CFDC_DEV_MAJOR
comma
id|zfcp_cfdc_misc.minor
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialise proc semaphores */
id|sema_init
c_func
(paren
op_amp
id|zfcp_data.config_sema
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* initialise configuration rw lock */
id|rwlock_init
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
multiline_comment|/* save address of data structure managing the driver module */
id|zfcp_data.scsi_host_template.module
op_assign
id|THIS_MODULE
suffix:semicolon
multiline_comment|/* setup dynamic I/O */
id|retval
op_assign
id|zfcp_ccw_register
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;registration with common I/O layer failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_ccw_register
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zfcp_device_setup
c_func
(paren
id|device
)paren
)paren
id|zfcp_init_device_configure
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|out_ccw_register
suffix:colon
id|misc_deregister
c_func
(paren
op_amp
id|zfcp_cfdc_misc
)paren
suffix:semicolon
id|out_misc_register
suffix:colon
id|unregister_ioctl32_conversion
c_func
(paren
id|zfcp_ioctl_trans.cmd
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_cfdc_dev_ioctl&n; *&n; * purpose:     Handle control file upload/download transaction via IOCTL&n; *&t;&t;interface&n; *&n; * returns:     0           - Operation completed successfuly&n; *              -ENOTTY     - Unknown IOCTL command&n; *              -EINVAL     - Invalid sense data record&n; *              -ENXIO      - The FCP adapter is not available&n; *              -EOPNOTSUPP - The FCP adapter does not have CFDC support&n; *              -ENOMEM     - Insufficient memory&n; *              -EFAULT     - User space memory I/O operation fault&n; *              -EPERM      - Cannot create or queue FSF request or create SBALs&n; *              -ERESTARTSYS- Received signal (is mapped to EAGAIN by VFS)&n; */
r_static
r_int
DECL|function|zfcp_cfdc_dev_ioctl
id|zfcp_cfdc_dev_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|command
comma
r_int
r_int
id|buffer
)paren
(brace
r_struct
id|zfcp_cfdc_sense_data
op_star
id|sense_data
comma
id|__user
op_star
id|sense_data_user
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|zfcp_sg_list
op_star
id|sg_list
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|fsf_command
comma
id|option
suffix:semicolon
r_char
op_star
id|bus_id
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|sense_data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zfcp_cfdc_sense_data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sense_data
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sg_list
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zfcp_sg_list
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_list
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sg_list
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sg_list
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
op_ne
id|ZFCP_CFDC_IOC
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;IOC request code 0x%x invalid&bslash;n&quot;
comma
id|command
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOTTY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sense_data_user
op_assign
(paren
r_void
id|__user
op_star
)paren
id|buffer
)paren
op_eq
l_int|NULL
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;sense data record is required&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|copy_from_user
c_func
(paren
id|sense_data
comma
id|sense_data_user
comma
r_sizeof
(paren
r_struct
id|zfcp_cfdc_sense_data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense_data-&gt;signature
op_ne
id|ZFCP_CFDC_SIGNATURE
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;invalid sense data request signature 0x%08x&bslash;n&quot;
comma
id|ZFCP_CFDC_SIGNATURE
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|sense_data-&gt;command
)paren
(brace
r_case
id|ZFCP_CFDC_CMND_DOWNLOAD_NORMAL
suffix:colon
id|fsf_command
op_assign
id|FSF_QTCB_DOWNLOAD_CONTROL_FILE
suffix:semicolon
id|option
op_assign
id|FSF_CFDC_OPTION_NORMAL_MODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_CFDC_CMND_DOWNLOAD_FORCE
suffix:colon
id|fsf_command
op_assign
id|FSF_QTCB_DOWNLOAD_CONTROL_FILE
suffix:semicolon
id|option
op_assign
id|FSF_CFDC_OPTION_FORCE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_CFDC_CMND_FULL_ACCESS
suffix:colon
id|fsf_command
op_assign
id|FSF_QTCB_DOWNLOAD_CONTROL_FILE
suffix:semicolon
id|option
op_assign
id|FSF_CFDC_OPTION_FULL_ACCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_CFDC_CMND_RESTRICTED_ACCESS
suffix:colon
id|fsf_command
op_assign
id|FSF_QTCB_DOWNLOAD_CONTROL_FILE
suffix:semicolon
id|option
op_assign
id|FSF_CFDC_OPTION_RESTRICTED_ACCESS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_CFDC_CMND_UPLOAD
suffix:colon
id|fsf_command
op_assign
id|FSF_QTCB_UPLOAD_CONTROL_FILE
suffix:semicolon
id|option
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;invalid command code 0x%08x&bslash;n&quot;
comma
id|sense_data-&gt;command
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|bus_id
op_assign
id|kmalloc
c_func
(paren
id|BUS_ID_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_id
op_eq
l_int|NULL
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|snprintf
c_func
(paren
id|bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;%d.%d.%04x&quot;
comma
(paren
id|sense_data-&gt;devno
op_rshift
l_int|24
)paren
comma
(paren
id|sense_data-&gt;devno
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
comma
(paren
id|sense_data-&gt;devno
op_amp
l_int|0xFFFF
)paren
)paren
suffix:semicolon
id|read_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|adapter
op_assign
id|zfcp_get_adapter_by_busid
c_func
(paren
id|bus_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter
)paren
id|zfcp_adapter_get
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|read_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bus_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter
op_eq
l_int|NULL
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;invalid adapter&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense_data-&gt;command
op_amp
id|ZFCP_CFDC_WITH_CONTROL_FILE
)paren
(brace
id|retval
op_assign
id|zfcp_sg_list_alloc
c_func
(paren
id|sg_list
comma
id|ZFCP_CFDC_MAX_CONTROL_FILE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|sense_data-&gt;command
op_amp
id|ZFCP_CFDC_DOWNLOAD
)paren
op_logical_and
(paren
id|sense_data-&gt;command
op_amp
id|ZFCP_CFDC_WITH_CONTROL_FILE
)paren
)paren
(brace
id|retval
op_assign
id|zfcp_sg_list_copy_from_user
c_func
(paren
id|sg_list
comma
op_amp
id|sense_data_user-&gt;control_file
comma
id|ZFCP_CFDC_MAX_CONTROL_FILE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|retval
op_assign
id|zfcp_fsf_control_file
c_func
(paren
id|adapter
comma
op_amp
id|fsf_req
comma
id|fsf_command
comma
id|option
comma
id|sg_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status
op_ne
id|FSF_PROT_GOOD
)paren
op_logical_and
(paren
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status
op_ne
id|FSF_PROT_FSF_STATUS_PRESENTED
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sense_data-&gt;fsf_status
op_assign
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sense_data-&gt;fsf_status_qual
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sense_data-&gt;payloads
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.support.els
comma
l_int|256
)paren
suffix:semicolon
id|retval
op_assign
id|copy_to_user
c_func
(paren
id|sense_data_user
comma
id|sense_data
comma
r_sizeof
(paren
r_struct
id|zfcp_cfdc_sense_data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense_data-&gt;command
op_amp
id|ZFCP_CFDC_UPLOAD
)paren
(brace
id|retval
op_assign
id|zfcp_sg_list_copy_to_user
c_func
(paren
op_amp
id|sense_data_user-&gt;control_file
comma
id|sg_list
comma
id|ZFCP_CFDC_MAX_CONTROL_FILE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|fsf_req
op_ne
l_int|NULL
)paren
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|adapter
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|retval
op_ne
op_minus
id|ENXIO
)paren
)paren
id|zfcp_adapter_put
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_list
op_ne
l_int|NULL
)paren
(brace
id|zfcp_sg_list_free
c_func
(paren
id|sg_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sg_list
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sense_data
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|sense_data
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_sg_list_alloc - create a scatter-gather list of the specified size&n; * @sg_list: structure describing a scatter gather list&n; * @size: size of scatter-gather list&n; * Return: 0 on success, else -ENOMEM&n; *&n; * In sg_list-&gt;sg a pointer to the created scatter-gather list is returned,&n; * or NULL if we run out of memory. sg_list-&gt;count specifies the number of&n; * elements of the scatter-gather list. The maximum size of a single element&n; * in the scatter-gather list is PAGE_SIZE.&n; */
r_static
r_inline
r_int
DECL|function|zfcp_sg_list_alloc
id|zfcp_sg_list_alloc
c_func
(paren
r_struct
id|zfcp_sg_list
op_star
id|sg_list
comma
r_int
id|size
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_void
op_star
id|address
suffix:semicolon
id|BUG_ON
c_func
(paren
id|sg_list
op_eq
l_int|NULL
)paren
suffix:semicolon
id|sg_list-&gt;count
op_assign
id|size
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|size
op_amp
op_complement
id|PAGE_MASK
)paren
id|sg_list-&gt;count
op_increment
suffix:semicolon
id|sg_list-&gt;sg
op_assign
id|kmalloc
c_func
(paren
id|sg_list-&gt;count
op_star
r_sizeof
(paren
r_struct
id|scatterlist
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sg_list-&gt;sg
op_eq
l_int|NULL
)paren
(brace
id|sg_list-&gt;count
op_assign
l_int|0
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sg_list-&gt;sg
comma
l_int|0
comma
id|sg_list-&gt;count
op_star
r_sizeof
(paren
r_struct
id|scatterlist
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|sg
op_assign
id|sg_list-&gt;sg
suffix:semicolon
id|i
OL
id|sg_list-&gt;count
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
(brace
id|sg-&gt;length
op_assign
id|min
c_func
(paren
id|size
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|sg-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|address
op_assign
(paren
r_void
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|address
op_eq
l_int|NULL
)paren
(brace
id|sg_list-&gt;count
op_assign
id|i
suffix:semicolon
id|zfcp_sg_list_free
c_func
(paren
id|sg_list
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|zfcp_address_to_sg
c_func
(paren
id|address
comma
id|sg
)paren
suffix:semicolon
id|size
op_sub_assign
id|sg-&gt;length
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_sg_list_free - free memory of a scatter-gather list&n; * @sg_list: structure describing a scatter-gather list&n; *&n; * Memory for each element in the scatter-gather list is freed.&n; * Finally sg_list-&gt;sg is freed itself and sg_list-&gt;count is reset.&n; */
r_static
r_inline
r_void
DECL|function|zfcp_sg_list_free
id|zfcp_sg_list_free
c_func
(paren
r_struct
id|zfcp_sg_list
op_star
id|sg_list
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|BUG_ON
c_func
(paren
id|sg_list
op_eq
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|sg
op_assign
id|sg_list-&gt;sg
suffix:semicolon
id|i
OL
id|sg_list-&gt;count
suffix:semicolon
id|i
op_increment
comma
id|sg
op_increment
)paren
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|zfcp_sg_to_address
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|sg_list-&gt;count
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|sg_list-&gt;sg
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_sg_size - determine size of a scatter-gather list&n; * @sg: array of (struct scatterlist)&n; * @sg_count: elements in array&n; * Return: size of entire scatter-gather list&n; */
r_int
DECL|function|zfcp_sg_size
id|zfcp_sg_size
c_func
(paren
r_struct
id|scatterlist
op_star
id|sg
comma
r_int
r_int
id|sg_count
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_struct
id|scatterlist
op_star
id|p
suffix:semicolon
r_int
id|size
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|sg
suffix:semicolon
id|i
OL
id|sg_count
suffix:semicolon
id|i
op_increment
comma
id|p
op_increment
)paren
(brace
id|BUG_ON
c_func
(paren
id|p
op_eq
l_int|NULL
)paren
suffix:semicolon
id|size
op_add_assign
id|p-&gt;length
suffix:semicolon
)brace
r_return
id|size
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_sg_list_copy_from_user -copy data from user space to scatter-gather list&n; * @sg_list: structure describing a scatter-gather list&n; * @user_buffer: pointer to buffer in user space&n; * @size: number of bytes to be copied&n; * Return: 0 on success, -EFAULT if copy_from_user fails.&n; */
r_static
r_inline
r_int
DECL|function|zfcp_sg_list_copy_from_user
id|zfcp_sg_list_copy_from_user
c_func
(paren
r_struct
id|zfcp_sg_list
op_star
id|sg_list
comma
r_void
id|__user
op_star
id|user_buffer
comma
r_int
id|size
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
r_int
id|length
suffix:semicolon
r_void
op_star
id|zfcp_buffer
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
id|sg_list
op_eq
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_sg_size
c_func
(paren
id|sg_list-&gt;sg
comma
id|sg_list-&gt;count
)paren
OL
id|size
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_for
c_loop
(paren
id|sg
op_assign
id|sg_list-&gt;sg
suffix:semicolon
id|size
OG
l_int|0
suffix:semicolon
id|sg
op_increment
)paren
(brace
id|length
op_assign
id|min
c_func
(paren
(paren
r_int
r_int
)paren
id|size
comma
id|sg-&gt;length
)paren
suffix:semicolon
id|zfcp_buffer
op_assign
id|zfcp_sg_to_address
c_func
(paren
id|sg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|zfcp_buffer
comma
id|user_buffer
comma
id|length
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|user_buffer
op_add_assign
id|length
suffix:semicolon
id|size
op_sub_assign
id|length
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_sg_list_copy_to_user - copy data from scatter-gather list to user space&n; * @user_buffer: pointer to buffer in user space&n; * @sg_list: structure describing a scatter-gather list&n; * @size: number of bytes to be copied&n; * Return: 0 on success, -EFAULT if copy_to_user fails&n; */
r_static
r_inline
r_int
DECL|function|zfcp_sg_list_copy_to_user
id|zfcp_sg_list_copy_to_user
c_func
(paren
r_void
id|__user
op_star
id|user_buffer
comma
r_struct
id|zfcp_sg_list
op_star
id|sg_list
comma
r_int
id|size
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
r_int
id|length
suffix:semicolon
r_void
op_star
id|zfcp_buffer
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
id|sg_list
op_eq
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_sg_size
c_func
(paren
id|sg_list-&gt;sg
comma
id|sg_list-&gt;count
)paren
OL
id|size
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_for
c_loop
(paren
id|sg
op_assign
id|sg_list-&gt;sg
suffix:semicolon
id|size
OG
l_int|0
suffix:semicolon
id|sg
op_increment
)paren
(brace
id|length
op_assign
id|min
c_func
(paren
(paren
r_int
r_int
)paren
id|size
comma
id|sg-&gt;length
)paren
suffix:semicolon
id|zfcp_buffer
op_assign
id|zfcp_sg_to_address
c_func
(paren
id|sg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user_buffer
comma
id|zfcp_buffer
comma
id|length
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|user_buffer
op_add_assign
id|length
suffix:semicolon
id|size
op_sub_assign
id|length
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
multiline_comment|/****************************************************************/
multiline_comment|/****** Functions for configuration/set-up of structures ********/
multiline_comment|/****************************************************************/
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA&t;&t;&t;ZFCP_LOG_AREA_CONFIG
multiline_comment|/**&n; * zfcp_get_unit_by_lun - find unit in unit list of port by FCP LUN&n; * @port: pointer to port to search for unit&n; * @fcp_lun: FCP LUN to search for&n; * Traverse list of all units of a port and return pointer to a unit&n; * with the given FCP LUN.&n; */
r_struct
id|zfcp_unit
op_star
DECL|function|zfcp_get_unit_by_lun
id|zfcp_get_unit_by_lun
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
id|fcp_lun_t
id|fcp_lun
)paren
(brace
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|unit-&gt;fcp_lun
op_eq
id|fcp_lun
)paren
op_logical_and
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|found
ques
c_cond
id|unit
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_get_port_by_wwpn - find port in port list of adapter by wwpn&n; * @adapter: pointer to adapter to search for port&n; * @wwpn: wwpn to search for&n; * Traverse list of all ports of an adapter and return pointer to a port&n; * with the given wwpn.&n; */
r_struct
id|zfcp_port
op_star
DECL|function|zfcp_get_port_by_wwpn
id|zfcp_get_port_by_wwpn
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
id|wwn_t
id|wwpn
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|port-&gt;wwpn
op_eq
id|wwpn
)paren
op_logical_and
op_logical_neg
(paren
id|atomic_read
c_func
(paren
op_amp
id|port-&gt;status
)paren
op_amp
(paren
id|ZFCP_STATUS_PORT_NO_WWPN
op_or
id|ZFCP_STATUS_COMMON_REMOVE
)paren
)paren
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|found
ques
c_cond
id|port
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_get_port_by_did - find port in port list of adapter by d_id&n; * @adapter: pointer to adapter to search for port&n; * @d_id: d_id to search for&n; * Traverse list of all ports of an adapter and return pointer to a port&n; * with the given d_id.&n; */
r_struct
id|zfcp_port
op_star
DECL|function|zfcp_get_port_by_did
id|zfcp_get_port_by_did
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
id|u32
id|d_id
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|port-&gt;d_id
op_eq
id|d_id
)paren
op_logical_and
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|found
ques
c_cond
id|port
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_get_adapter_by_busid - find adpater in adapter list by bus_id&n; * @bus_id: bus_id to search for&n; * Traverse list of all adapters and return pointer to an adapter&n; * with the given bus_id.&n; */
r_struct
id|zfcp_adapter
op_star
DECL|function|zfcp_get_adapter_by_busid
id|zfcp_get_adapter_by_busid
c_func
(paren
r_char
op_star
id|bus_id
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|adapter
comma
op_amp
id|zfcp_data.adapter_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|strncmp
c_func
(paren
id|bus_id
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|BUS_ID_SIZE
)paren
op_eq
l_int|0
)paren
op_logical_and
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|found
ques
c_cond
id|adapter
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_unit_enqueue - enqueue unit to unit list of a port.&n; * @port: pointer to port where unit is added&n; * @fcp_lun: FCP LUN of unit to be enqueued&n; * Return: pointer to enqueued unit on success, NULL on error&n; * Locks: config_sema must be held to serialize changes to the unit list&n; *&n; * Sets up some unit internal structures and creates sysfs entry.&n; */
r_struct
id|zfcp_unit
op_star
DECL|function|zfcp_unit_enqueue
id|zfcp_unit_enqueue
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
id|fcp_lun_t
id|fcp_lun
)paren
(brace
r_struct
id|zfcp_unit
op_star
id|unit
comma
op_star
id|tmp_unit
suffix:semicolon
id|scsi_lun_t
id|scsi_lun
suffix:semicolon
r_int
id|found
suffix:semicolon
multiline_comment|/*&n;&t; * check that there is no unit with this FCP_LUN already in list&n;&t; * and enqueue it.&n;&t; * Note: Unlike for the adapter and the port, this is an error&n;&t; */
id|read_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|unit
op_assign
id|zfcp_get_unit_by_lun
c_func
(paren
id|port
comma
id|fcp_lun
)paren
suffix:semicolon
id|read_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unit
)paren
r_return
l_int|NULL
suffix:semicolon
id|unit
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zfcp_unit
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unit
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|unit
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zfcp_unit
)paren
)paren
suffix:semicolon
multiline_comment|/* initialise reference count stuff */
id|atomic_set
c_func
(paren
op_amp
id|unit-&gt;refcount
comma
l_int|0
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|unit-&gt;remove_wq
)paren
suffix:semicolon
id|unit-&gt;port
op_assign
id|port
suffix:semicolon
id|unit-&gt;fcp_lun
op_assign
id|fcp_lun
suffix:semicolon
multiline_comment|/* setup for sysfs registration */
id|snprintf
c_func
(paren
id|unit-&gt;sysfs_device.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;0x%016llx&quot;
comma
id|fcp_lun
)paren
suffix:semicolon
id|unit-&gt;sysfs_device.parent
op_assign
op_amp
id|port-&gt;sysfs_device
suffix:semicolon
id|unit-&gt;sysfs_device.release
op_assign
id|zfcp_sysfs_unit_release
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
op_amp
id|unit-&gt;sysfs_device
comma
id|unit
)paren
suffix:semicolon
multiline_comment|/* mark unit unusable as long as sysfs registration is not complete */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_register
c_func
(paren
op_amp
id|unit-&gt;sysfs_device
)paren
)paren
(brace
id|kfree
c_func
(paren
id|unit
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zfcp_sysfs_unit_create_files
c_func
(paren
op_amp
id|unit-&gt;sysfs_device
)paren
)paren
(brace
id|device_unregister
c_func
(paren
op_amp
id|unit-&gt;sysfs_device
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|zfcp_unit_get
c_func
(paren
id|unit
)paren
suffix:semicolon
id|scsi_lun
op_assign
l_int|0
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp_unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|tmp_unit-&gt;scsi_lun
op_ne
id|scsi_lun
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|scsi_lun
op_increment
suffix:semicolon
)brace
id|unit-&gt;scsi_lun
op_assign
id|scsi_lun
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
id|list_add_tail
c_func
(paren
op_amp
id|unit-&gt;list
comma
op_amp
id|tmp_unit-&gt;list
)paren
suffix:semicolon
r_else
id|list_add_tail
c_func
(paren
op_amp
id|unit-&gt;list
comma
op_amp
id|port-&gt;unit_list_head
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|port-&gt;units
op_increment
suffix:semicolon
id|zfcp_port_get
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|unit
suffix:semicolon
)brace
r_void
DECL|function|zfcp_unit_dequeue
id|zfcp_unit_dequeue
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
)paren
(brace
id|zfcp_unit_wait
c_func
(paren
id|unit
)paren
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|unit-&gt;list
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|unit-&gt;port-&gt;units
op_decrement
suffix:semicolon
id|zfcp_port_put
c_func
(paren
id|unit-&gt;port
)paren
suffix:semicolon
id|zfcp_sysfs_unit_remove_files
c_func
(paren
op_amp
id|unit-&gt;sysfs_device
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|unit-&gt;sysfs_device
)paren
suffix:semicolon
)brace
r_static
r_void
op_star
DECL|function|zfcp_mempool_alloc
id|zfcp_mempool_alloc
c_func
(paren
r_int
id|gfp_mask
comma
r_void
op_star
id|size
)paren
(brace
r_return
id|kmalloc
c_func
(paren
(paren
r_int
)paren
id|size
comma
id|gfp_mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|zfcp_mempool_free
id|zfcp_mempool_free
c_func
(paren
r_void
op_star
id|element
comma
r_void
op_star
id|size
)paren
(brace
id|kfree
c_func
(paren
id|element
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocates a combined QTCB/fsf_req buffer for erp actions and fcp/SCSI&n; * commands.&n; * It also genrates fcp-nameserver request/response buffer and unsolicited &n; * status read fsf_req buffers.&n; *&n; * locks:       must only be called with zfcp_data.config_sema taken&n; */
r_static
r_int
DECL|function|zfcp_allocate_low_mem_buffers
id|zfcp_allocate_low_mem_buffers
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
id|adapter-&gt;pool.fsf_req_erp
op_assign
id|mempool_create
c_func
(paren
id|ZFCP_POOL_FSF_REQ_ERP_NR
comma
id|zfcp_mempool_alloc
comma
id|zfcp_mempool_free
comma
(paren
r_void
op_star
)paren
r_sizeof
(paren
r_struct
id|zfcp_fsf_req_pool_element
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|adapter-&gt;pool.fsf_req_erp
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|adapter-&gt;pool.fsf_req_scsi
op_assign
id|mempool_create
c_func
(paren
id|ZFCP_POOL_FSF_REQ_SCSI_NR
comma
id|zfcp_mempool_alloc
comma
id|zfcp_mempool_free
comma
(paren
r_void
op_star
)paren
r_sizeof
(paren
r_struct
id|zfcp_fsf_req_pool_element
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|adapter-&gt;pool.fsf_req_scsi
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|adapter-&gt;pool.fsf_req_abort
op_assign
id|mempool_create
c_func
(paren
id|ZFCP_POOL_FSF_REQ_ABORT_NR
comma
id|zfcp_mempool_alloc
comma
id|zfcp_mempool_free
comma
(paren
r_void
op_star
)paren
r_sizeof
(paren
r_struct
id|zfcp_fsf_req_pool_element
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|adapter-&gt;pool.fsf_req_abort
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|adapter-&gt;pool.fsf_req_status_read
op_assign
id|mempool_create
c_func
(paren
id|ZFCP_POOL_STATUS_READ_NR
comma
id|zfcp_mempool_alloc
comma
id|zfcp_mempool_free
comma
(paren
r_void
op_star
)paren
r_sizeof
(paren
r_struct
id|zfcp_fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|adapter-&gt;pool.fsf_req_status_read
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|adapter-&gt;pool.data_status_read
op_assign
id|mempool_create
c_func
(paren
id|ZFCP_POOL_STATUS_READ_NR
comma
id|zfcp_mempool_alloc
comma
id|zfcp_mempool_free
comma
(paren
r_void
op_star
)paren
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|adapter-&gt;pool.data_status_read
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|adapter-&gt;pool.data_gid_pn
op_assign
id|mempool_create
c_func
(paren
id|ZFCP_POOL_DATA_GID_PN_NR
comma
id|zfcp_mempool_alloc
comma
id|zfcp_mempool_free
comma
(paren
r_void
op_star
)paren
r_sizeof
(paren
r_struct
id|zfcp_gid_pn_data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|adapter-&gt;pool.data_gid_pn
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_free_low_mem_buffers - free memory pools of an adapter&n; * @adapter: pointer to zfcp_adapter for which memory pools should be freed&n; * locking:  zfcp_data.config_sema must be held&n; */
r_static
r_void
DECL|function|zfcp_free_low_mem_buffers
id|zfcp_free_low_mem_buffers
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_if
c_cond
(paren
id|adapter-&gt;pool.fsf_req_erp
)paren
id|mempool_destroy
c_func
(paren
id|adapter-&gt;pool.fsf_req_erp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;pool.fsf_req_scsi
)paren
id|mempool_destroy
c_func
(paren
id|adapter-&gt;pool.fsf_req_scsi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;pool.fsf_req_abort
)paren
id|mempool_destroy
c_func
(paren
id|adapter-&gt;pool.fsf_req_abort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;pool.fsf_req_status_read
)paren
id|mempool_destroy
c_func
(paren
id|adapter-&gt;pool.fsf_req_status_read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;pool.data_status_read
)paren
id|mempool_destroy
c_func
(paren
id|adapter-&gt;pool.data_status_read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;pool.data_gid_pn
)paren
id|mempool_destroy
c_func
(paren
id|adapter-&gt;pool.data_gid_pn
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_adapter_debug_register - registers debug feature for an adapter&n; * @adapter: pointer to adapter for which debug features should be registered&n; * return: -ENOMEM on error, 0 otherwise&n; */
r_int
DECL|function|zfcp_adapter_debug_register
id|zfcp_adapter_debug_register
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_char
id|dbf_name
(braket
l_int|20
)braket
suffix:semicolon
multiline_comment|/* debug feature area which records SCSI command failures (hostbyte) */
id|spin_lock_init
c_func
(paren
op_amp
id|adapter-&gt;dbf_lock
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|dbf_name
comma
id|ZFCP_CMD_DBF_NAME
l_string|&quot;%s&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|adapter-&gt;cmd_dbf
op_assign
id|debug_register
c_func
(paren
id|dbf_name
comma
id|ZFCP_CMD_DBF_INDEX
comma
id|ZFCP_CMD_DBF_AREAS
comma
id|ZFCP_CMD_DBF_LENGTH
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|adapter-&gt;cmd_dbf
comma
id|ZFCP_CMD_DBF_LEVEL
)paren
suffix:semicolon
multiline_comment|/* debug feature area which records SCSI command aborts */
id|sprintf
c_func
(paren
id|dbf_name
comma
id|ZFCP_ABORT_DBF_NAME
l_string|&quot;%s&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|adapter-&gt;abort_dbf
op_assign
id|debug_register
c_func
(paren
id|dbf_name
comma
id|ZFCP_ABORT_DBF_INDEX
comma
id|ZFCP_ABORT_DBF_AREAS
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|adapter-&gt;abort_dbf
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|adapter-&gt;abort_dbf
comma
id|ZFCP_ABORT_DBF_LEVEL
)paren
suffix:semicolon
multiline_comment|/* debug feature area which records incoming ELS commands */
id|sprintf
c_func
(paren
id|dbf_name
comma
id|ZFCP_IN_ELS_DBF_NAME
l_string|&quot;%s&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|adapter-&gt;in_els_dbf
op_assign
id|debug_register
c_func
(paren
id|dbf_name
comma
id|ZFCP_IN_ELS_DBF_INDEX
comma
id|ZFCP_IN_ELS_DBF_AREAS
comma
id|ZFCP_IN_ELS_DBF_LENGTH
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|adapter-&gt;in_els_dbf
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|adapter-&gt;in_els_dbf
comma
id|ZFCP_IN_ELS_DBF_LEVEL
)paren
suffix:semicolon
multiline_comment|/* debug feature area which records erp events */
id|sprintf
c_func
(paren
id|dbf_name
comma
id|ZFCP_ERP_DBF_NAME
l_string|&quot;%s&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|adapter-&gt;erp_dbf
op_assign
id|debug_register
c_func
(paren
id|dbf_name
comma
id|ZFCP_ERP_DBF_INDEX
comma
id|ZFCP_ERP_DBF_AREAS
comma
id|ZFCP_ERP_DBF_LENGTH
)paren
suffix:semicolon
id|debug_register_view
c_func
(paren
id|adapter-&gt;erp_dbf
comma
op_amp
id|debug_hex_ascii_view
)paren
suffix:semicolon
id|debug_set_level
c_func
(paren
id|adapter-&gt;erp_dbf
comma
id|ZFCP_ERP_DBF_LEVEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|adapter-&gt;cmd_dbf
op_logical_and
id|adapter-&gt;abort_dbf
op_logical_and
id|adapter-&gt;in_els_dbf
op_logical_and
id|adapter-&gt;erp_dbf
)paren
)paren
(brace
id|zfcp_adapter_debug_unregister
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_adapter_debug_unregister - unregisters debug feature for an adapter&n; * @adapter: pointer to adapter for which debug features should be unregistered&n; */
r_void
DECL|function|zfcp_adapter_debug_unregister
id|zfcp_adapter_debug_unregister
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
id|debug_unregister
c_func
(paren
id|adapter-&gt;abort_dbf
)paren
suffix:semicolon
id|debug_unregister
c_func
(paren
id|adapter-&gt;cmd_dbf
)paren
suffix:semicolon
id|debug_unregister
c_func
(paren
id|adapter-&gt;erp_dbf
)paren
suffix:semicolon
id|debug_unregister
c_func
(paren
id|adapter-&gt;in_els_dbf
)paren
suffix:semicolon
id|adapter-&gt;abort_dbf
op_assign
l_int|NULL
suffix:semicolon
id|adapter-&gt;cmd_dbf
op_assign
l_int|NULL
suffix:semicolon
id|adapter-&gt;erp_dbf
op_assign
l_int|NULL
suffix:semicolon
id|adapter-&gt;in_els_dbf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_void
DECL|function|zfcp_dummy_release
id|zfcp_dummy_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Enqueues an adapter at the end of the adapter list in the driver data.&n; * All adapter internal structures are set up.&n; * Proc-fs entries are also created.&n; *&n; * returns:&t;0             if a new adapter was successfully enqueued&n; *              ZFCP_KNOWN    if an adapter with this devno was already present&n; *&t;&t;-ENOMEM       if alloc failed&n; * locks:&t;config_sema must be held to serialise changes to the adapter list&n; */
r_struct
id|zfcp_adapter
op_star
DECL|function|zfcp_adapter_enqueue
id|zfcp_adapter_enqueue
c_func
(paren
r_struct
id|ccw_device
op_star
id|ccw_device
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
multiline_comment|/*&n;&t; * Note: It is safe to release the list_lock, as any list changes &n;&t; * are protected by the config_sema, which must be held to get here&n;&t; */
multiline_comment|/* try to allocate new adapter data structure (zeroed) */
id|adapter
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zfcp_adapter
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: allocation of base adapter &quot;
l_string|&quot;structure failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|adapter
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zfcp_adapter
)paren
)paren
suffix:semicolon
id|ccw_device-&gt;handler
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* save ccw_device pointer */
id|adapter-&gt;ccw_device
op_assign
id|ccw_device
suffix:semicolon
id|retval
op_assign
id|zfcp_qdio_allocate_queues
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|queues_alloc_failed
suffix:semicolon
id|retval
op_assign
id|zfcp_qdio_allocate
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|qdio_allocate_failed
suffix:semicolon
id|retval
op_assign
id|zfcp_allocate_low_mem_buffers
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: pool allocation failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_low_mem_buffers
suffix:semicolon
)brace
multiline_comment|/* initialise reference count stuff */
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;refcount
comma
l_int|0
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|adapter-&gt;remove_wq
)paren
suffix:semicolon
multiline_comment|/* initialise list of ports */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|adapter-&gt;port_list_head
)paren
suffix:semicolon
multiline_comment|/* initialise list of ports to be removed */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|adapter-&gt;port_remove_lh
)paren
suffix:semicolon
multiline_comment|/* initialize list of fsf requests */
id|rwlock_init
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_head
)paren
suffix:semicolon
multiline_comment|/* initialize abort lock */
id|rwlock_init
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
)paren
suffix:semicolon
multiline_comment|/* initialise some erp stuff */
id|init_waitqueue_head
c_func
(paren
op_amp
id|adapter-&gt;erp_thread_wqh
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|adapter-&gt;erp_done_wqh
)paren
suffix:semicolon
multiline_comment|/* initialize lock of associated request queue */
id|rwlock_init
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
)paren
suffix:semicolon
multiline_comment|/* intitialise SCSI ER timer */
id|init_timer
c_func
(paren
op_amp
id|adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
multiline_comment|/* set FC service class used per default */
id|adapter-&gt;fc_service_class
op_assign
id|ZFCP_FC_SERVICE_CLASS_DEFAULT
suffix:semicolon
id|sprintf
c_func
(paren
id|adapter-&gt;name
comma
l_string|&quot;%s&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|ASCEBC
c_func
(paren
id|adapter-&gt;name
comma
id|strlen
c_func
(paren
id|adapter-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* mark adapter unusable as long as sysfs registration is not complete */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|adapter-&gt;ccw_device
op_assign
id|ccw_device
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
op_amp
id|ccw_device-&gt;dev
comma
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_sysfs_adapter_create_files
c_func
(paren
op_amp
id|ccw_device-&gt;dev
)paren
)paren
r_goto
id|sysfs_failed
suffix:semicolon
id|adapter-&gt;generic_services.parent
op_assign
op_amp
id|adapter-&gt;ccw_device-&gt;dev
suffix:semicolon
id|adapter-&gt;generic_services.release
op_assign
id|zfcp_dummy_release
suffix:semicolon
id|snprintf
c_func
(paren
id|adapter-&gt;generic_services.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;generic_services&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_register
c_func
(paren
op_amp
id|adapter-&gt;generic_services
)paren
)paren
r_goto
id|generic_services_failed
suffix:semicolon
multiline_comment|/* put allocated adapter at list tail */
id|write_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|adapter-&gt;list
comma
op_amp
id|zfcp_data.adapter_list_head
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|zfcp_data.adapters
op_increment
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|generic_services_failed
suffix:colon
id|zfcp_sysfs_adapter_remove_files
c_func
(paren
op_amp
id|adapter-&gt;ccw_device-&gt;dev
)paren
suffix:semicolon
id|sysfs_failed
suffix:colon
id|dev_set_drvdata
c_func
(paren
op_amp
id|ccw_device-&gt;dev
comma
l_int|NULL
)paren
suffix:semicolon
id|failed_low_mem_buffers
suffix:colon
id|zfcp_free_low_mem_buffers
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qdio_free
c_func
(paren
id|ccw_device
)paren
op_ne
l_int|0
)paren
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: qdio_free for adapter %s failed&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|qdio_allocate_failed
suffix:colon
id|zfcp_qdio_free_queues
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|queues_alloc_failed
suffix:colon
id|kfree
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|adapter
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
r_return
id|adapter
suffix:semicolon
)brace
multiline_comment|/*&n; * returns:&t;0 - struct zfcp_adapter  data structure successfully removed&n; *&t;&t;!0 - struct zfcp_adapter  data structure could not be removed&n; *&t;&t;&t;(e.g. still used)&n; * locks:&t;adapter list write lock is assumed to be held by caller&n; *              adapter-&gt;fsf_req_list_lock is taken and released within this &n; *              function and must not be held on entry&n; */
r_void
DECL|function|zfcp_adapter_dequeue
id|zfcp_adapter_dequeue
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|adapter-&gt;generic_services
)paren
suffix:semicolon
id|zfcp_sysfs_adapter_remove_files
c_func
(paren
op_amp
id|adapter-&gt;ccw_device-&gt;dev
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
op_amp
id|adapter-&gt;ccw_device-&gt;dev
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* sanity check: no pending FSF requests */
id|read_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_head
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: adapter %s (%p) still in use, &quot;
l_string|&quot;%i requests outstanding&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|adapter
comma
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* remove specified adapter data structure from list */
id|write_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|adapter-&gt;list
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
multiline_comment|/* decrease number of adapters in list */
id|zfcp_data.adapters
op_decrement
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;adapter %s (%p) removed from list, &quot;
l_string|&quot;%i adapters still in list&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|adapter
comma
id|zfcp_data.adapters
)paren
suffix:semicolon
id|retval
op_assign
id|qdio_free
c_func
(paren
id|adapter-&gt;ccw_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: qdio_free for adapter %s failed&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_free_low_mem_buffers
c_func
(paren
id|adapter
)paren
suffix:semicolon
multiline_comment|/* free memory of adapter data structure and queues */
id|zfcp_qdio_free_queues
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;freeing adapter structure&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_port_enqueue - enqueue port to port list of adapter&n; * @adapter: adapter where remote port is added&n; * @wwpn: WWPN of the remote port to be enqueued&n; * @status: initial status for the port&n; * @d_id: destination id of the remote port to be enqueued&n; * Return: pointer to enqueued port on success, NULL on error&n; * Locks: config_sema must be held to serialize changes to the port list&n; *&n; * All port internal structures are set up and the sysfs entry is generated.&n; * d_id is used to enqueue ports with a well known address like the Directory&n; * Service for nameserver lookup.&n; */
r_struct
id|zfcp_port
op_star
DECL|function|zfcp_port_enqueue
id|zfcp_port_enqueue
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
id|wwn_t
id|wwpn
comma
id|u32
id|status
comma
id|u32
id|d_id
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
comma
op_star
id|tmp_port
suffix:semicolon
r_int
id|check_wwpn
suffix:semicolon
id|scsi_id_t
id|scsi_id
suffix:semicolon
r_int
id|found
suffix:semicolon
id|check_wwpn
op_assign
op_logical_neg
(paren
id|status
op_amp
id|ZFCP_STATUS_PORT_NO_WWPN
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * check that there is no port with this WWPN already in list&n;&t; */
r_if
c_cond
(paren
id|check_wwpn
)paren
(brace
id|read_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|port
op_assign
id|zfcp_get_port_by_wwpn
c_func
(paren
id|adapter
comma
id|wwpn
)paren
suffix:semicolon
id|read_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
id|port
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zfcp_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|port
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zfcp_port
)paren
)paren
suffix:semicolon
multiline_comment|/* initialise reference count stuff */
id|atomic_set
c_func
(paren
op_amp
id|port-&gt;refcount
comma
l_int|0
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;remove_wq
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|port-&gt;unit_list_head
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|port-&gt;unit_remove_lh
)paren
suffix:semicolon
id|port-&gt;adapter
op_assign
id|adapter
suffix:semicolon
r_if
c_cond
(paren
id|check_wwpn
)paren
id|port-&gt;wwpn
op_assign
id|wwpn
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|status
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
multiline_comment|/* setup for sysfs registration */
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_PORT_WKA
)paren
(brace
r_switch
c_cond
(paren
id|d_id
)paren
(brace
r_case
id|ZFCP_DID_DIRECTORY_SERVICE
suffix:colon
id|snprintf
c_func
(paren
id|port-&gt;sysfs_device.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;directory&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_DID_MANAGEMENT_SERVICE
suffix:colon
id|snprintf
c_func
(paren
id|port-&gt;sysfs_device.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;management&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_DID_KEY_DISTRIBUTION_SERVICE
suffix:colon
id|snprintf
c_func
(paren
id|port-&gt;sysfs_device.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;key_distribution&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_DID_ALIAS_SERVICE
suffix:colon
id|snprintf
c_func
(paren
id|port-&gt;sysfs_device.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;alias&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_DID_TIME_SERVICE
suffix:colon
id|snprintf
c_func
(paren
id|port-&gt;sysfs_device.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;time&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|kfree
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|port-&gt;d_id
op_assign
id|d_id
suffix:semicolon
id|port-&gt;sysfs_device.parent
op_assign
op_amp
id|adapter-&gt;generic_services
suffix:semicolon
)brace
r_else
(brace
id|snprintf
c_func
(paren
id|port-&gt;sysfs_device.bus_id
comma
id|BUS_ID_SIZE
comma
l_string|&quot;0x%016llx&quot;
comma
id|wwpn
)paren
suffix:semicolon
id|port-&gt;sysfs_device.parent
op_assign
op_amp
id|adapter-&gt;ccw_device-&gt;dev
suffix:semicolon
)brace
id|port-&gt;sysfs_device.release
op_assign
id|zfcp_sysfs_port_release
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
op_amp
id|port-&gt;sysfs_device
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* mark port unusable as long as sysfs registration is not complete */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|device_register
c_func
(paren
op_amp
id|port-&gt;sysfs_device
)paren
)paren
(brace
id|kfree
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zfcp_sysfs_port_create_files
c_func
(paren
op_amp
id|port-&gt;sysfs_device
comma
id|status
)paren
)paren
(brace
id|device_unregister
c_func
(paren
op_amp
id|port-&gt;sysfs_device
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|zfcp_port_get
c_func
(paren
id|port
)paren
suffix:semicolon
id|scsi_id
op_assign
l_int|1
suffix:semicolon
id|found
op_assign
l_int|0
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp_port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_PORT_NO_SCSI_ID
comma
op_amp
id|tmp_port-&gt;status
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|tmp_port-&gt;scsi_id
op_ne
id|scsi_id
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|scsi_id
op_increment
suffix:semicolon
)brace
id|port-&gt;scsi_id
op_assign
id|scsi_id
suffix:semicolon
r_if
c_cond
(paren
id|found
)paren
id|list_add_tail
c_func
(paren
op_amp
id|port-&gt;list
comma
op_amp
id|tmp_port-&gt;list
)paren
suffix:semicolon
r_else
id|list_add_tail
c_func
(paren
op_amp
id|port-&gt;list
comma
op_amp
id|adapter-&gt;port_list_head
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d_id
op_eq
id|ZFCP_DID_DIRECTORY_SERVICE
)paren
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;nameserver_port
)paren
id|adapter-&gt;nameserver_port
op_assign
id|port
suffix:semicolon
id|adapter-&gt;ports
op_increment
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|zfcp_adapter_get
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_return
id|port
suffix:semicolon
)brace
r_void
DECL|function|zfcp_port_dequeue
id|zfcp_port_dequeue
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
)paren
(brace
id|zfcp_port_wait
c_func
(paren
id|port
)paren
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|port-&gt;list
)paren
suffix:semicolon
id|port-&gt;adapter-&gt;ports
op_decrement
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|zfcp_adapter_put
c_func
(paren
id|port-&gt;adapter
)paren
suffix:semicolon
id|zfcp_sysfs_port_remove_files
c_func
(paren
op_amp
id|port-&gt;sysfs_device
comma
id|atomic_read
c_func
(paren
op_amp
id|port-&gt;status
)paren
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|port-&gt;sysfs_device
)paren
suffix:semicolon
)brace
multiline_comment|/* Enqueues a nameserver port */
r_int
DECL|function|zfcp_nameserver_enqueue
id|zfcp_nameserver_enqueue
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|port
op_assign
id|zfcp_port_enqueue
c_func
(paren
id|adapter
comma
l_int|0
comma
id|ZFCP_STATUS_PORT_WKA
comma
id|ZFCP_DID_DIRECTORY_SERVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: enqueue of nameserver port for &quot;
l_string|&quot;adapter %s failed&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|zfcp_port_put
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
multiline_comment|/****************************************************************/
multiline_comment|/******* Fibre Channel Standard related Functions  **************/
multiline_comment|/****************************************************************/
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA                   ZFCP_LOG_AREA_FC
r_void
DECL|function|zfcp_fsf_incoming_els_rscn
id|zfcp_fsf_incoming_els_rscn
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
)paren
(brace
r_struct
id|fcp_rscn_head
op_star
id|fcp_rscn_head
suffix:semicolon
r_struct
id|fcp_rscn_element
op_star
id|fcp_rscn_element
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|u16
id|i
suffix:semicolon
id|u16
id|no_entries
suffix:semicolon
id|u32
id|range_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|fcp_rscn_head
op_assign
(paren
r_struct
id|fcp_rscn_head
op_star
)paren
id|status_buffer-&gt;payload
suffix:semicolon
id|fcp_rscn_element
op_assign
(paren
r_struct
id|fcp_rscn_element
op_star
)paren
id|status_buffer-&gt;payload
suffix:semicolon
multiline_comment|/* see FC-FS */
id|no_entries
op_assign
(paren
id|fcp_rscn_head-&gt;payload_len
op_div
l_int|4
)paren
suffix:semicolon
id|zfcp_in_els_dbf_event
c_func
(paren
id|adapter
comma
l_string|&quot;##rscn&quot;
comma
id|status_buffer
comma
id|fcp_rscn_head-&gt;payload_len
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;unsol_els_rscn:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|no_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* skip head and start with 1st element */
id|fcp_rscn_element
op_increment
suffix:semicolon
r_switch
c_cond
(paren
id|fcp_rscn_element-&gt;addr_format
)paren
(brace
r_case
id|ZFCP_PORT_ADDRESS
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;ZFCP_PORT_ADDRESS&bslash;n&quot;
)paren
suffix:semicolon
id|range_mask
op_assign
id|ZFCP_PORTS_RANGE_PORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_AREA_ADDRESS
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;ZFCP_AREA_ADDRESS&bslash;n&quot;
)paren
suffix:semicolon
id|range_mask
op_assign
id|ZFCP_PORTS_RANGE_AREA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_DOMAIN_ADDRESS
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;ZFCP_DOMAIN_ADDRESS&bslash;n&quot;
)paren
suffix:semicolon
id|range_mask
op_assign
id|ZFCP_PORTS_RANGE_DOMAIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_FABRIC_ADDRESS
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;ZFCP_FABRIC_ADDRESS&bslash;n&quot;
)paren
suffix:semicolon
id|range_mask
op_assign
id|ZFCP_PORTS_RANGE_FABRIC
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;incoming RSCN with unknown &quot;
l_string|&quot;address format&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|atomic_test_mask
(paren
id|ZFCP_STATUS_PORT_WKA
comma
op_amp
id|port-&gt;status
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* Do we know this port? If not skip it. */
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
(paren
id|ZFCP_STATUS_PORT_DID_DID
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;incoming RSCN, trying to open &quot;
l_string|&quot;port 0x%016Lx&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;unsol_els_rscnu:&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * FIXME: race: d_id might being invalidated&n;&t;&t;&t; * (...DID_DID reset)&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|port-&gt;d_id
op_amp
id|range_mask
)paren
op_eq
(paren
id|fcp_rscn_element-&gt;nport_did
op_amp
id|range_mask
)paren
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;reopen did 0x%08x&bslash;n&quot;
comma
id|fcp_rscn_element-&gt;nport_did
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Unfortunately, an RSCN does not specify the&n;&t;&t;&t;&t; * type of change a target underwent. We assume&n;&t;&t;&t;&t; * that it makes sense to reopen the link.&n;&t;&t;&t;&t; * FIXME: Shall we try to find out more about&n;&t;&t;&t;&t; * the target and link state before closing it?&n;&t;&t;&t;&t; * How to accomplish this? (nameserver?)&n;&t;&t;&t;&t; * Where would such code be put in?&n;&t;&t;&t;&t; * (inside or outside erp)&n;&t;&t;&t;&t; */
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;incoming RSCN, trying to open &quot;
l_string|&quot;port 0x%016Lx&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;unsol_els_rscnk:&quot;
)paren
suffix:semicolon
id|zfcp_test_link
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|zfcp_fsf_incoming_els_plogi
id|zfcp_fsf_incoming_els_plogi
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
)paren
(brace
id|logi
op_star
id|els_logi
op_assign
(paren
id|logi
op_star
)paren
id|status_buffer-&gt;payload
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|zfcp_in_els_dbf_event
c_func
(paren
id|adapter
comma
l_string|&quot;##plogi&quot;
comma
id|status_buffer
comma
l_int|28
)paren
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;wwpn
op_eq
(paren
op_star
(paren
id|wwn_t
op_star
)paren
op_amp
id|els_logi-&gt;nport_wwn
)paren
)paren
r_break
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
op_logical_or
(paren
id|port-&gt;wwpn
op_ne
(paren
op_star
(paren
id|wwn_t
op_star
)paren
op_amp
id|els_logi-&gt;nport_wwn
)paren
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;ignored incoming PLOGI for nonexisting port &quot;
l_string|&quot;with d_id 0x%08x on adapter %s&bslash;n&quot;
comma
id|status_buffer-&gt;d_id
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;unsol_els_plogi:&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
op_amp
id|els_logi-&gt;nport_wwn
comma
l_int|8
)paren
suffix:semicolon
id|zfcp_erp_port_forced_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|zfcp_fsf_incoming_els_logo
id|zfcp_fsf_incoming_els_logo
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
)paren
(brace
r_struct
id|fcp_logo
op_star
id|els_logo
op_assign
(paren
r_struct
id|fcp_logo
op_star
)paren
id|status_buffer-&gt;payload
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|zfcp_in_els_dbf_event
c_func
(paren
id|adapter
comma
l_string|&quot;##logo&quot;
comma
id|status_buffer
comma
l_int|16
)paren
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;wwpn
op_eq
id|els_logo-&gt;nport_wwpn
)paren
r_break
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
op_logical_or
(paren
id|port-&gt;wwpn
op_ne
id|els_logo-&gt;nport_wwpn
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;ignored incoming LOGO for nonexisting port &quot;
l_string|&quot;with d_id 0x%08x on adapter %s&bslash;n&quot;
comma
id|status_buffer-&gt;d_id
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;unsol_els_logo:&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
op_amp
id|els_logo-&gt;nport_wwpn
comma
l_int|8
)paren
suffix:semicolon
id|zfcp_erp_port_forced_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|zfcp_fsf_incoming_els_unknown
id|zfcp_fsf_incoming_els_unknown
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
)paren
(brace
id|zfcp_in_els_dbf_event
c_func
(paren
id|adapter
comma
l_string|&quot;##undef&quot;
comma
id|status_buffer
comma
l_int|24
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;warning: unknown incoming ELS 0x%08x &quot;
l_string|&quot;for adapter %s&bslash;n&quot;
comma
op_star
(paren
id|u32
op_star
)paren
(paren
id|status_buffer-&gt;payload
)paren
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|zfcp_fsf_incoming_els
id|zfcp_fsf_incoming_els
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
suffix:semicolon
id|u32
id|els_type
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|status_buffer
op_assign
id|fsf_req-&gt;data.status_read.buffer
suffix:semicolon
id|els_type
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|status_buffer-&gt;payload
)paren
suffix:semicolon
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_if
c_cond
(paren
id|els_type
op_eq
id|LS_PLOGI
)paren
id|zfcp_fsf_incoming_els_plogi
c_func
(paren
id|adapter
comma
id|status_buffer
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|els_type
op_eq
id|LS_LOGO
)paren
id|zfcp_fsf_incoming_els_logo
c_func
(paren
id|adapter
comma
id|status_buffer
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|els_type
op_amp
l_int|0xffff0000
)paren
op_eq
id|LS_RSCN
)paren
multiline_comment|/* we are only concerned with the command, not the length */
id|zfcp_fsf_incoming_els_rscn
c_func
(paren
id|adapter
comma
id|status_buffer
)paren
suffix:semicolon
r_else
id|zfcp_fsf_incoming_els_unknown
c_func
(paren
id|adapter
comma
id|status_buffer
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_gid_pn_buffers_alloc - allocate buffers for GID_PN nameserver request&n; * @gid_pn: pointer to return pointer to struct zfcp_gid_pn_data&n; * @pool: pointer to mempool_t if non-null memory pool is used for allocation&n; */
r_static
r_int
DECL|function|zfcp_gid_pn_buffers_alloc
id|zfcp_gid_pn_buffers_alloc
c_func
(paren
r_struct
id|zfcp_gid_pn_data
op_star
op_star
id|gid_pn
comma
id|mempool_t
op_star
id|pool
)paren
(brace
r_struct
id|zfcp_gid_pn_data
op_star
id|data
suffix:semicolon
r_if
c_cond
(paren
id|pool
op_ne
l_int|NULL
)paren
(brace
id|data
op_assign
id|mempool_alloc
c_func
(paren
id|pool
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|data
op_ne
l_int|NULL
)paren
)paren
(brace
id|data-&gt;ct.pool
op_assign
id|pool
suffix:semicolon
)brace
)brace
r_else
(brace
id|data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zfcp_gid_pn_data
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|data
)paren
)paren
suffix:semicolon
id|data-&gt;ct.req
op_assign
op_amp
id|data-&gt;req
suffix:semicolon
id|data-&gt;ct.resp
op_assign
op_amp
id|data-&gt;resp
suffix:semicolon
id|data-&gt;ct.req_count
op_assign
id|data-&gt;ct.resp_count
op_assign
l_int|1
suffix:semicolon
id|zfcp_address_to_sg
c_func
(paren
op_amp
id|data-&gt;ct_iu_req
comma
op_amp
id|data-&gt;req
)paren
suffix:semicolon
id|zfcp_address_to_sg
c_func
(paren
op_amp
id|data-&gt;ct_iu_resp
comma
op_amp
id|data-&gt;resp
)paren
suffix:semicolon
id|data-&gt;req.length
op_assign
r_sizeof
(paren
r_struct
id|ct_iu_gid_pn_req
)paren
suffix:semicolon
id|data-&gt;resp.length
op_assign
r_sizeof
(paren
r_struct
id|ct_iu_gid_pn_resp
)paren
suffix:semicolon
op_star
id|gid_pn
op_assign
id|data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_gid_pn_buffers_free - free buffers for GID_PN nameserver request&n; * @gid_pn: pointer to struct zfcp_gid_pn_data which has to be freed&n; */
r_static
r_void
DECL|function|zfcp_gid_pn_buffers_free
id|zfcp_gid_pn_buffers_free
c_func
(paren
r_struct
id|zfcp_gid_pn_data
op_star
id|gid_pn
)paren
(brace
r_if
c_cond
(paren
(paren
id|gid_pn-&gt;ct.pool
op_ne
l_int|0
)paren
)paren
id|mempool_free
c_func
(paren
id|gid_pn
comma
id|gid_pn-&gt;ct.pool
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|gid_pn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ns_gid_pn_request - initiate GID_PN nameserver request&n; * @erp_action: pointer to zfcp_erp_action where GID_PN request is needed&n; */
r_int
DECL|function|zfcp_ns_gid_pn_request
id|zfcp_ns_gid_pn_request
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|ct_iu_gid_pn_req
op_star
id|ct_iu_req
suffix:semicolon
r_struct
id|zfcp_gid_pn_data
op_star
id|gid_pn
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|ret
op_assign
id|zfcp_gid_pn_buffers_alloc
c_func
(paren
op_amp
id|gid_pn
comma
id|adapter-&gt;pool.data_gid_pn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: buffer allocation for gid_pn nameserver &quot;
l_string|&quot;request failed for adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* setup nameserver request */
id|ct_iu_req
op_assign
id|zfcp_sg_to_address
c_func
(paren
id|gid_pn-&gt;ct.req
)paren
suffix:semicolon
id|ct_iu_req-&gt;header.revision
op_assign
id|ZFCP_CT_REVISION
suffix:semicolon
id|ct_iu_req-&gt;header.gs_type
op_assign
id|ZFCP_CT_DIRECTORY_SERVICE
suffix:semicolon
id|ct_iu_req-&gt;header.gs_subtype
op_assign
id|ZFCP_CT_NAME_SERVER
suffix:semicolon
id|ct_iu_req-&gt;header.options
op_assign
id|ZFCP_CT_SYNCHRONOUS
suffix:semicolon
id|ct_iu_req-&gt;header.cmd_rsp_code
op_assign
id|ZFCP_CT_GID_PN
suffix:semicolon
id|ct_iu_req-&gt;header.max_res_size
op_assign
id|ZFCP_CT_MAX_SIZE
suffix:semicolon
id|ct_iu_req-&gt;wwpn
op_assign
id|erp_action-&gt;port-&gt;wwpn
suffix:semicolon
multiline_comment|/* setup parameters for send generic command */
id|gid_pn-&gt;ct.port
op_assign
id|adapter-&gt;nameserver_port
suffix:semicolon
id|gid_pn-&gt;ct.handler
op_assign
id|zfcp_ns_gid_pn_handler
suffix:semicolon
id|gid_pn-&gt;ct.handler_data
op_assign
(paren
r_int
r_int
)paren
id|gid_pn
suffix:semicolon
id|gid_pn-&gt;ct.timeout
op_assign
id|ZFCP_NS_GID_PN_TIMEOUT
suffix:semicolon
id|gid_pn-&gt;ct.timer
op_assign
op_amp
id|erp_action-&gt;timer
suffix:semicolon
id|gid_pn-&gt;port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|ret
op_assign
id|zfcp_fsf_send_ct
c_func
(paren
op_amp
id|gid_pn-&gt;ct
comma
id|adapter-&gt;pool.fsf_req_erp
comma
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: initiation of gid_pn nameserver request &quot;
l_string|&quot;failed for adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_gid_pn_buffers_free
c_func
(paren
id|gid_pn
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ns_gid_pn_handler - handler for GID_PN nameserver request&n; * @data: unsigned long, contains pointer to struct zfcp_gid_pn_data&n; */
DECL|function|zfcp_ns_gid_pn_handler
r_static
r_void
id|zfcp_ns_gid_pn_handler
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_send_ct
op_star
id|ct
suffix:semicolon
r_struct
id|ct_iu_gid_pn_req
op_star
id|ct_iu_req
suffix:semicolon
r_struct
id|ct_iu_gid_pn_resp
op_star
id|ct_iu_resp
suffix:semicolon
r_struct
id|zfcp_gid_pn_data
op_star
id|gid_pn
suffix:semicolon
id|gid_pn
op_assign
(paren
r_struct
id|zfcp_gid_pn_data
op_star
)paren
id|data
suffix:semicolon
id|port
op_assign
id|gid_pn-&gt;port
suffix:semicolon
id|ct
op_assign
op_amp
id|gid_pn-&gt;ct
suffix:semicolon
id|ct_iu_req
op_assign
id|zfcp_sg_to_address
c_func
(paren
id|ct-&gt;req
)paren
suffix:semicolon
id|ct_iu_resp
op_assign
id|zfcp_sg_to_address
c_func
(paren
id|ct-&gt;resp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ct-&gt;status
op_ne
l_int|0
)paren
op_logical_or
id|zfcp_check_ct_response
c_func
(paren
op_amp
id|ct_iu_resp-&gt;header
)paren
)paren
(brace
multiline_comment|/* FIXME: do we need some specific erp entry points */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_PORT_INVALID_WWPN
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
multiline_comment|/* paranoia */
r_if
c_cond
(paren
id|ct_iu_req-&gt;wwpn
op_ne
id|port-&gt;wwpn
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: wwpn 0x%016Lx returned by nameserver &quot;
l_string|&quot;lookup does not match expected wwpn 0x%016Lx &quot;
l_string|&quot;for adapter %s&bslash;n&quot;
comma
id|ct_iu_req-&gt;wwpn
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_goto
id|mismatch
suffix:semicolon
)brace
multiline_comment|/* looks like a valid d_id */
id|port-&gt;d_id
op_assign
id|ct_iu_resp-&gt;d_id
op_amp
id|ZFCP_DID_MASK
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_PORT_DID_DID
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;adapter %s:  wwpn=0x%016Lx ---&gt; d_id=0x%08x&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;wwpn
comma
id|port-&gt;d_id
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|mismatch
suffix:colon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;CT IUs do not match:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
id|ct_iu_req
comma
r_sizeof
(paren
r_struct
id|ct_iu_gid_pn_req
)paren
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
id|ct_iu_resp
comma
r_sizeof
(paren
r_struct
id|ct_iu_gid_pn_resp
)paren
)paren
suffix:semicolon
id|failed
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;warning: failed gid_pn nameserver request for wwpn &quot;
l_string|&quot;0x%016Lx for adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|out
suffix:colon
id|zfcp_gid_pn_buffers_free
c_func
(paren
id|gid_pn
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* reject CT_IU reason codes acc. to FC-GS-4 */
DECL|variable|zfcp_ct_rc
r_static
r_const
r_struct
id|zfcp_rc_entry
id|zfcp_ct_rc
(braket
)braket
op_assign
(brace
(brace
l_int|0x01
comma
l_string|&quot;invalid command code&quot;
)brace
comma
(brace
l_int|0x02
comma
l_string|&quot;invalid version level&quot;
)brace
comma
(brace
l_int|0x03
comma
l_string|&quot;logical error&quot;
)brace
comma
(brace
l_int|0x04
comma
l_string|&quot;invalid CT_IU size&quot;
)brace
comma
(brace
l_int|0x05
comma
l_string|&quot;logical busy&quot;
)brace
comma
(brace
l_int|0x07
comma
l_string|&quot;protocol error&quot;
)brace
comma
(brace
l_int|0x09
comma
l_string|&quot;unable to perform command request&quot;
)brace
comma
(brace
l_int|0x0b
comma
l_string|&quot;command not supported&quot;
)brace
comma
(brace
l_int|0x0d
comma
l_string|&quot;server not available&quot;
)brace
comma
(brace
l_int|0x0e
comma
l_string|&quot;session could not be established&quot;
)brace
comma
(brace
l_int|0xff
comma
l_string|&quot;vendor specific error&quot;
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* LS_RJT reason codes acc. to FC-FS */
DECL|variable|zfcp_ls_rjt_rc
r_static
r_const
r_struct
id|zfcp_rc_entry
id|zfcp_ls_rjt_rc
(braket
)braket
op_assign
(brace
(brace
l_int|0x01
comma
l_string|&quot;invalid LS_Command code&quot;
)brace
comma
(brace
l_int|0x03
comma
l_string|&quot;logical error&quot;
)brace
comma
(brace
l_int|0x05
comma
l_string|&quot;logical busy&quot;
)brace
comma
(brace
l_int|0x07
comma
l_string|&quot;protocol error&quot;
)brace
comma
(brace
l_int|0x09
comma
l_string|&quot;unable to perform command request&quot;
)brace
comma
(brace
l_int|0x0b
comma
l_string|&quot;command not supported&quot;
)brace
comma
(brace
l_int|0x0e
comma
l_string|&quot;command already in progress&quot;
)brace
comma
(brace
l_int|0xff
comma
l_string|&quot;vendor specific error&quot;
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* reject reason codes according to FC-PH/FC-FS */
DECL|variable|zfcp_p_rjt_rc
r_static
r_const
r_struct
id|zfcp_rc_entry
id|zfcp_p_rjt_rc
(braket
)braket
op_assign
(brace
(brace
l_int|0x01
comma
l_string|&quot;invalid D_ID&quot;
)brace
comma
(brace
l_int|0x02
comma
l_string|&quot;invalid S_ID&quot;
)brace
comma
(brace
l_int|0x03
comma
l_string|&quot;Nx_Port not available, temporary&quot;
)brace
comma
(brace
l_int|0x04
comma
l_string|&quot;Nx_Port not available, permament&quot;
)brace
comma
(brace
l_int|0x05
comma
l_string|&quot;class not supported&quot;
)brace
comma
(brace
l_int|0x06
comma
l_string|&quot;delimiter usage error&quot;
)brace
comma
(brace
l_int|0x07
comma
l_string|&quot;TYPE not supported&quot;
)brace
comma
(brace
l_int|0x08
comma
l_string|&quot;invalid Link_Control&quot;
)brace
comma
(brace
l_int|0x09
comma
l_string|&quot;invalid R_CTL field&quot;
)brace
comma
(brace
l_int|0x0a
comma
l_string|&quot;invalid F_CTL field&quot;
)brace
comma
(brace
l_int|0x0b
comma
l_string|&quot;invalid OX_ID&quot;
)brace
comma
(brace
l_int|0x0c
comma
l_string|&quot;invalid RX_ID&quot;
)brace
comma
(brace
l_int|0x0d
comma
l_string|&quot;invalid SEQ_ID&quot;
)brace
comma
(brace
l_int|0x0e
comma
l_string|&quot;invalid DF_CTL&quot;
)brace
comma
(brace
l_int|0x0f
comma
l_string|&quot;invalid SEQ_CNT&quot;
)brace
comma
(brace
l_int|0x10
comma
l_string|&quot;invalid parameter field&quot;
)brace
comma
(brace
l_int|0x11
comma
l_string|&quot;exchange error&quot;
)brace
comma
(brace
l_int|0x12
comma
l_string|&quot;protocol error&quot;
)brace
comma
(brace
l_int|0x13
comma
l_string|&quot;incorrect length&quot;
)brace
comma
(brace
l_int|0x14
comma
l_string|&quot;unsupported ACK&quot;
)brace
comma
(brace
l_int|0x15
comma
l_string|&quot;class of service not supported by entity at FFFFFE&quot;
)brace
comma
(brace
l_int|0x16
comma
l_string|&quot;login required&quot;
)brace
comma
(brace
l_int|0x17
comma
l_string|&quot;excessive sequences attempted&quot;
)brace
comma
(brace
l_int|0x18
comma
l_string|&quot;unable to establish exchange&quot;
)brace
comma
(brace
l_int|0x1a
comma
l_string|&quot;fabric path not available&quot;
)brace
comma
(brace
l_int|0x1b
comma
l_string|&quot;invalid VC_ID (class 4)&quot;
)brace
comma
(brace
l_int|0x1c
comma
l_string|&quot;invalid CS_CTL field&quot;
)brace
comma
(brace
l_int|0x1d
comma
l_string|&quot;insufficient resources for VC (class 4)&quot;
)brace
comma
(brace
l_int|0x1f
comma
l_string|&quot;invalid class of service&quot;
)brace
comma
(brace
l_int|0x20
comma
l_string|&quot;preemption request rejected&quot;
)brace
comma
(brace
l_int|0x21
comma
l_string|&quot;preemption not enabled&quot;
)brace
comma
(brace
l_int|0x22
comma
l_string|&quot;multicast error&quot;
)brace
comma
(brace
l_int|0x23
comma
l_string|&quot;multicast error terminate&quot;
)brace
comma
(brace
l_int|0x24
comma
l_string|&quot;process login required&quot;
)brace
comma
(brace
l_int|0xff
comma
l_string|&quot;vendor specific reject&quot;
)brace
comma
(brace
l_int|0
comma
l_int|NULL
)brace
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * zfcp_rc_description - return description for given reaon code&n; * @code: reason code&n; * @rc_table: table of reason codes and descriptions&n; */
r_static
r_inline
r_const
r_char
op_star
DECL|function|zfcp_rc_description
id|zfcp_rc_description
c_func
(paren
id|u8
id|code
comma
r_const
r_struct
id|zfcp_rc_entry
op_star
id|rc_table
)paren
(brace
r_const
r_char
op_star
id|descr
op_assign
l_string|&quot;unknown reason code&quot;
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|code
op_eq
id|rc_table-&gt;code
)paren
(brace
id|descr
op_assign
id|rc_table-&gt;description
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rc_table
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rc_table-&gt;code
op_logical_and
id|rc_table-&gt;description
)paren
suffix:semicolon
r_return
id|descr
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_check_ct_response - evaluate reason code for CT_IU&n; * @rjt: response payload to an CT_IU request&n; * Return: 0 for accept CT_IU, 1 for reject CT_IU or invlid response code&n; */
r_int
DECL|function|zfcp_check_ct_response
id|zfcp_check_ct_response
c_func
(paren
r_struct
id|ct_hdr
op_star
id|rjt
)paren
(brace
r_if
c_cond
(paren
id|rjt-&gt;cmd_rsp_code
op_eq
id|ZFCP_CT_ACCEPT
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rjt-&gt;cmd_rsp_code
op_ne
id|ZFCP_CT_REJECT
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: invalid Generic Service command/&quot;
l_string|&quot;response code (0x%04hx)&bslash;n&quot;
comma
id|rjt-&gt;cmd_rsp_code
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Generic Service command rejected&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;%s (0x%02x, 0x%02x, 0x%02x)&bslash;n&quot;
comma
id|zfcp_rc_description
c_func
(paren
id|rjt-&gt;reason_code
comma
id|zfcp_ct_rc
)paren
comma
(paren
id|u32
)paren
id|rjt-&gt;reason_code
comma
(paren
id|u32
)paren
id|rjt-&gt;reason_code_expl
comma
(paren
id|u32
)paren
id|rjt-&gt;vendor_unique
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_print_els_rjt - print reject parameter and description for ELS reject&n; * @rjt_par: reject parameter acc. to FC-PH/FC-FS&n; * @rc_table: table of reason codes and descriptions&n; */
r_static
r_inline
r_void
DECL|function|zfcp_print_els_rjt
id|zfcp_print_els_rjt
c_func
(paren
r_struct
id|zfcp_ls_rjt_par
op_star
id|rjt_par
comma
r_const
r_struct
id|zfcp_rc_entry
op_star
id|rc_table
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;%s (%02x %02x %02x %02x)&bslash;n&quot;
comma
id|zfcp_rc_description
c_func
(paren
id|rjt_par-&gt;reason_code
comma
id|rc_table
)paren
comma
(paren
id|u32
)paren
id|rjt_par-&gt;action
comma
(paren
id|u32
)paren
id|rjt_par-&gt;reason_code
comma
(paren
id|u32
)paren
id|rjt_par-&gt;reason_expl
comma
(paren
id|u32
)paren
id|rjt_par-&gt;vendor_unique
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_handle_els_rjt - evaluate status qualifier/reason code on ELS reject&n; * @sq: status qualifier word&n; * @rjt_par: reject parameter as described in FC-PH and FC-FS&n; * Return: -EROMTEIO for LS_RJT, -EREMCHG for invalid D_ID, -EIO else&n; */
r_int
DECL|function|zfcp_handle_els_rjt
id|zfcp_handle_els_rjt
c_func
(paren
id|u32
id|sq
comma
r_struct
id|zfcp_ls_rjt_par
op_star
id|rjt_par
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|sq
op_eq
id|FSF_IOSTAT_NPORT_RJT
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;ELS rejected (P_RJT)&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_print_els_rjt
c_func
(paren
id|rjt_par
comma
id|zfcp_p_rjt_rc
)paren
suffix:semicolon
multiline_comment|/* invalid d_id */
r_if
c_cond
(paren
id|rjt_par-&gt;reason_code
op_eq
l_int|0x01
)paren
id|ret
op_assign
op_minus
id|EREMCHG
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sq
op_eq
id|FSF_IOSTAT_FABRIC_RJT
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;ELS rejected (F_RJT)&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_print_els_rjt
c_func
(paren
id|rjt_par
comma
id|zfcp_p_rjt_rc
)paren
suffix:semicolon
multiline_comment|/* invalid d_id */
r_if
c_cond
(paren
id|rjt_par-&gt;reason_code
op_eq
l_int|0x01
)paren
id|ret
op_assign
op_minus
id|EREMCHG
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sq
op_eq
id|FSF_IOSTAT_LS_RJT
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;ELS rejected (LS_RJT)&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_print_els_rjt
c_func
(paren
id|rjt_par
comma
id|zfcp_ls_rjt_rc
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EREMOTEIO
suffix:semicolon
)brace
r_else
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;unexpected SQ: 0x%02x&bslash;n&quot;
comma
id|sq
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
eof
