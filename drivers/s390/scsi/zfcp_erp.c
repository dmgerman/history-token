multiline_comment|/* &n; * &n; * linux/drivers/s390/scsi/zfcp_erp.c &n; * &n; * FCP adapter driver for IBM eServer zSeries &n; * &n; * (C) Copyright IBM Corp. 2002, 2004&n; *&n; * Author(s): Martin Peschke &lt;mpeschke@de.ibm.com&gt; &n; *            Raimund Schroeder &lt;raimund.schroeder@de.ibm.com&gt; &n; *            Aron Zeh&n; *            Wolfgang Taphorn&n; *            Stefan Bader &lt;stefan.bader@de.ibm.com&gt; &n; *            Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt; &n; *            Andreas Herrmann &lt;aherrman@de.ibm.com&gt;&n; * &n; * This program is free software; you can redistribute it and/or modify &n; * it under the terms of the GNU General Public License as published by &n; * the Free Software Foundation; either version 2, or (at your option) &n; * any later version. &n; * &n; * This program is distributed in the hope that it will be useful, &n; * but WITHOUT ANY WARRANTY; without even the implied warranty of &n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the &n; * GNU General Public License for more details. &n; * &n; * You should have received a copy of the GNU General Public License &n; * along with this program; if not, write to the Free Software &n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; */
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA&t;&t;&t;ZFCP_LOG_AREA_ERP
multiline_comment|/* this drivers version (do not edit !!! generated and updated by cvs) */
DECL|macro|ZFCP_ERP_REVISION
mdefine_line|#define ZFCP_ERP_REVISION &quot;$Revision: 1.69 $&quot;
macro_line|#include &quot;zfcp_ext.h&quot;
r_static
r_int
id|zfcp_els
c_func
(paren
r_struct
id|zfcp_port
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
r_void
id|zfcp_els_handler
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_reopen_internal
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_forced_reopen_internal
c_func
(paren
r_struct
id|zfcp_port
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_reopen_internal
c_func
(paren
r_struct
id|zfcp_port
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_unit_reopen_internal
c_func
(paren
r_struct
id|zfcp_unit
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_reopen_all_internal
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_unit_reopen_all_internal
c_func
(paren
r_struct
id|zfcp_port
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_adapter_block
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_adapter_unblock
c_func
(paren
r_struct
id|zfcp_adapter
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_port_block
c_func
(paren
r_struct
id|zfcp_port
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_port_unblock
c_func
(paren
r_struct
id|zfcp_port
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_unit_block
c_func
(paren
r_struct
id|zfcp_unit
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_unit_unblock
c_func
(paren
r_struct
id|zfcp_unit
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_thread
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_do_action
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_memwait
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_check_target
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_check_unit
c_func
(paren
r_struct
id|zfcp_unit
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_check_port
c_func
(paren
r_struct
id|zfcp_port
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_check_adapter
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_statechange
c_func
(paren
r_int
comma
id|u32
comma
r_struct
id|zfcp_adapter
op_star
comma
r_struct
id|zfcp_port
op_star
comma
r_struct
id|zfcp_unit
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_inline
r_int
id|zfcp_erp_strategy_statechange_detected
c_func
(paren
id|atomic_t
op_star
comma
id|u32
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_followup_actions
c_func
(paren
r_int
comma
r_struct
id|zfcp_adapter
op_star
comma
r_struct
id|zfcp_port
op_star
comma
r_struct
id|zfcp_unit
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_check_queues
c_func
(paren
r_struct
id|zfcp_adapter
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_strategy_check_action
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_generic
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_close
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_close_qdio
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_close_fsf
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_open
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_open_qdio
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_open_fsf
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_open_fsf_xconfig
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_adapter_strategy_open_fsf_statusread
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_forced_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_forced_strategy_close
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy_clearstati
c_func
(paren
r_struct
id|zfcp_port
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy_close
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy_open
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy_open_nameserver
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy_open_nameserver_wakeup
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy_open_common
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy_open_common_lookup
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_port_strategy_open_port
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_unit_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_unit_strategy_clearstati
c_func
(paren
r_struct
id|zfcp_unit
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_unit_strategy_close
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_unit_strategy_open
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_action_dismiss_adapter
c_func
(paren
r_struct
id|zfcp_adapter
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_action_dismiss_port
c_func
(paren
r_struct
id|zfcp_port
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_action_dismiss_unit
c_func
(paren
r_struct
id|zfcp_unit
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_action_dismiss
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_action_enqueue
c_func
(paren
r_int
comma
r_struct
id|zfcp_adapter
op_star
comma
r_struct
id|zfcp_port
op_star
comma
r_struct
id|zfcp_unit
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_action_dequeue
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_action_cleanup
c_func
(paren
r_int
comma
r_struct
id|zfcp_adapter
op_star
comma
r_struct
id|zfcp_port
op_star
comma
r_struct
id|zfcp_unit
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_action_ready
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_erp_action_exists
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|zfcp_erp_action_to_ready
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_inline
r_void
id|zfcp_erp_action_to_running
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_memwait_handler
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_void
id|zfcp_erp_timeout_handler
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
r_inline
r_void
id|zfcp_erp_timeout_init
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
suffix:semicolon
multiline_comment|/**&n; * zfcp_fsf_request_timeout_handler - called if a request timed out&n; * @data: pointer to adapter for handler function&n; *&n; * This function needs to be called if requests (ELS, Generic Service,&n; * or SCSI commands) exceed a certain time limit. The assumption is&n; * that after the time limit the adapter get stuck. So we trigger a reopen of&n; * the adapter. This should not be used for error recovery, SCSI abort&n; * commands and SCSI requests from SCSI mid-layer.&n; */
r_void
DECL|function|zfcp_fsf_request_timeout_handler
id|zfcp_fsf_request_timeout_handler
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|data
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_scsi_er_timeout_handler&n; *&n; * purpose:     This function needs to be called whenever a SCSI error recovery&n; *              action (abort/reset) does not return.&n; *              Re-opening the adapter means that the command can be returned&n; *              by zfcp (it is guarranteed that it does not return via the&n; *              adapter anymore). The buffer can then be used again.&n; *    &n; * returns:     sod all&n; */
r_void
DECL|function|zfcp_fsf_scsi_er_timeout_handler
id|zfcp_fsf_scsi_er_timeout_handler
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|data
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;warning: SCSI error recovery timed out. &quot;
l_string|&quot;Restarting all operations on the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;eh_lmem_tout&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;called if an adapter failed,&n; *&t;&t;initiates adapter recovery which is done&n; *&t;&t;asynchronously&n; *&n; * returns:&t;0&t;- initiated action succesfully&n; *&t;&t;&lt;0&t;- failed to initiate action&n; */
r_int
DECL|function|zfcp_erp_adapter_reopen_internal
id|zfcp_erp_adapter_reopen_internal
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_ro&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;reopen adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_block
c_func
(paren
id|adapter
comma
id|clear_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;skipped reopen of failed adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_ro_f&quot;
)paren
suffix:semicolon
multiline_comment|/* ensure propagation of failed status to new devices */
id|zfcp_erp_adapter_failed
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_erp_action_enqueue
c_func
(paren
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
comma
id|adapter
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;Wrappper for zfcp_erp_adapter_reopen_internal&n; *              used to ensure the correct locking&n; *&n; * returns:&t;0&t;- initiated action succesfully&n; *&t;&t;&lt;0&t;- failed to initiate action&n; */
r_int
DECL|function|zfcp_erp_adapter_reopen
id|zfcp_erp_adapter_reopen
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_adapter_reopen_internal
c_func
(paren
id|adapter
comma
id|clear_mask
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_erp_adapter_shutdown
id|zfcp_erp_adapter_shutdown
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_RUNNING
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
op_or
id|clear_mask
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_erp_port_shutdown
id|zfcp_erp_port_shutdown
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
id|ZFCP_STATUS_COMMON_RUNNING
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
op_or
id|clear_mask
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_erp_unit_shutdown
id|zfcp_erp_unit_shutdown
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_unit_reopen
c_func
(paren
id|unit
comma
id|ZFCP_STATUS_COMMON_RUNNING
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
op_or
id|clear_mask
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_els&n; *&n; * purpose:     Originator of the ELS commands&n; *&n; * returns:     0       - Operation completed successfuly&n; *              -EINVAL - Unknown IOCTL command or invalid sense data record&n; *              -ENOMEM - Insufficient memory&n; *              -EPERM  - Cannot create or queue FSF request&n; */
r_int
DECL|function|zfcp_els
id|zfcp_els
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
id|u8
id|ls_code
)paren
(brace
r_struct
id|zfcp_send_els
op_star
id|send_els
suffix:semicolon
r_struct
id|zfcp_ls_rls
op_star
id|rls
suffix:semicolon
r_struct
id|zfcp_ls_pdisc
op_star
id|pdisc
suffix:semicolon
r_struct
id|zfcp_ls_adisc
op_star
id|adisc
suffix:semicolon
r_struct
id|page
op_star
id|page
op_assign
l_int|NULL
suffix:semicolon
r_void
op_star
id|req
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|send_els
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zfcp_send_els
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_els
op_eq
l_int|NULL
)paren
r_goto
id|nomem
suffix:semicolon
id|send_els-&gt;req
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_els-&gt;req
op_eq
l_int|NULL
)paren
r_goto
id|nomem
suffix:semicolon
id|send_els-&gt;req_count
op_assign
l_int|1
suffix:semicolon
id|send_els-&gt;resp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_els-&gt;resp
op_eq
l_int|NULL
)paren
r_goto
id|nomem
suffix:semicolon
id|send_els-&gt;resp_count
op_assign
l_int|1
suffix:semicolon
id|page
op_assign
id|alloc_pages
c_func
(paren
id|GFP_ATOMIC
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
r_goto
id|nomem
suffix:semicolon
id|send_els-&gt;req-&gt;page
op_assign
id|page
suffix:semicolon
id|send_els-&gt;resp-&gt;page
op_assign
id|page
suffix:semicolon
id|send_els-&gt;req-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|send_els-&gt;resp-&gt;offset
op_assign
id|PAGE_SIZE
op_rshift
l_int|1
suffix:semicolon
id|send_els-&gt;adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|send_els-&gt;d_id
op_assign
id|port-&gt;d_id
suffix:semicolon
id|send_els-&gt;ls_code
op_assign
id|ls_code
suffix:semicolon
id|send_els-&gt;handler
op_assign
id|zfcp_els_handler
suffix:semicolon
id|send_els-&gt;handler_data
op_assign
(paren
r_int
r_int
)paren
id|send_els
suffix:semicolon
id|send_els-&gt;completion
op_assign
l_int|NULL
suffix:semicolon
id|req
op_assign
id|zfcp_sg_to_address
c_func
(paren
id|send_els-&gt;req
)paren
suffix:semicolon
id|memset
c_func
(paren
id|req
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
id|req
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|u8
op_star
)paren
id|req
op_assign
id|ls_code
suffix:semicolon
r_switch
c_cond
(paren
id|ls_code
)paren
(brace
r_case
id|ZFCP_LS_RTV
suffix:colon
id|send_els-&gt;req-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|zfcp_ls_rtv
)paren
suffix:semicolon
id|send_els-&gt;resp-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|zfcp_ls_rtv_acc
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;RTV request from s_id 0x%08x to d_id 0x%08x&bslash;n&quot;
comma
id|port-&gt;adapter-&gt;s_id
comma
id|port-&gt;d_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_LS_RLS
suffix:colon
id|send_els-&gt;req-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|zfcp_ls_rls
)paren
suffix:semicolon
id|send_els-&gt;resp-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|zfcp_ls_rls_acc
)paren
suffix:semicolon
id|rls
op_assign
(paren
r_struct
id|zfcp_ls_rls
op_star
)paren
id|req
suffix:semicolon
id|rls-&gt;port_id
op_assign
id|port-&gt;adapter-&gt;s_id
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;RLS request from s_id 0x%08x to d_id 0x%08x &quot;
l_string|&quot;(port_id=0x%08x)&bslash;n&quot;
comma
id|port-&gt;adapter-&gt;s_id
comma
id|port-&gt;d_id
comma
id|rls-&gt;port_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_LS_PDISC
suffix:colon
id|send_els-&gt;req-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|zfcp_ls_pdisc
)paren
suffix:semicolon
id|send_els-&gt;resp-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|zfcp_ls_pdisc_acc
)paren
suffix:semicolon
id|pdisc
op_assign
(paren
r_struct
id|zfcp_ls_pdisc
op_star
)paren
id|req
suffix:semicolon
id|pdisc-&gt;wwpn
op_assign
id|port-&gt;adapter-&gt;wwpn
suffix:semicolon
id|pdisc-&gt;wwnn
op_assign
id|port-&gt;adapter-&gt;wwnn
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;PDISC request from s_id 0x%08x to d_id 0x%08x &quot;
l_string|&quot;(wwpn=0x%016Lx, wwnn=0x%016Lx)&bslash;n&quot;
comma
id|port-&gt;adapter-&gt;s_id
comma
id|port-&gt;d_id
comma
id|pdisc-&gt;wwpn
comma
id|pdisc-&gt;wwnn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_LS_ADISC
suffix:colon
id|send_els-&gt;req-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|zfcp_ls_adisc
)paren
suffix:semicolon
id|send_els-&gt;resp-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|zfcp_ls_adisc_acc
)paren
suffix:semicolon
id|adisc
op_assign
(paren
r_struct
id|zfcp_ls_adisc
op_star
)paren
id|req
suffix:semicolon
id|adisc-&gt;hard_nport_id
op_assign
id|port-&gt;adapter-&gt;s_id
suffix:semicolon
id|adisc-&gt;wwpn
op_assign
id|port-&gt;adapter-&gt;wwpn
suffix:semicolon
id|adisc-&gt;wwnn
op_assign
id|port-&gt;adapter-&gt;wwnn
suffix:semicolon
id|adisc-&gt;nport_id
op_assign
id|port-&gt;adapter-&gt;s_id
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;ADISC request from s_id 0x%08x to d_id 0x%08x &quot;
l_string|&quot;(wwpn=0x%016Lx, wwnn=0x%016Lx, &quot;
l_string|&quot;hard_nport_id=0x%08x, nport_id=0x%08x)&bslash;n&quot;
comma
id|port-&gt;adapter-&gt;s_id
comma
id|port-&gt;d_id
comma
id|adisc-&gt;wwpn
comma
id|adisc-&gt;wwnn
comma
id|adisc-&gt;hard_nport_id
comma
id|adisc-&gt;nport_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;ELS command code 0x%02x is not supported&bslash;n&quot;
comma
id|ls_code
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|invalid_ls_code
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_fsf_send_els
c_func
(paren
id|send_els
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: initiation of Send ELS failed for port &quot;
l_string|&quot;0x%016Lx on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
id|nomem
suffix:colon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|invalid_ls_code
suffix:colon
r_if
c_cond
(paren
id|page
op_ne
l_int|NULL
)paren
id|__free_pages
c_func
(paren
id|page
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_els
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|send_els-&gt;req
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|send_els-&gt;req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_els-&gt;resp
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|send_els-&gt;resp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|send_els
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_els_handler - handler for ELS commands&n; * @data: pointer to struct zfcp_send_els&n; * If ELS failed (LS_RJT or timed out) forced reopen of the port is triggered.&n; */
r_void
DECL|function|zfcp_els_handler
id|zfcp_els_handler
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|zfcp_send_els
op_star
id|send_els
op_assign
(paren
r_struct
id|zfcp_send_els
op_star
)paren
id|data
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_ls_rtv_acc
op_star
id|rtv
suffix:semicolon
r_struct
id|zfcp_ls_rls_acc
op_star
id|rls
suffix:semicolon
r_struct
id|zfcp_ls_pdisc_acc
op_star
id|pdisc
suffix:semicolon
r_struct
id|zfcp_ls_adisc_acc
op_star
id|adisc
suffix:semicolon
r_void
op_star
id|req
comma
op_star
id|resp
suffix:semicolon
id|u8
id|req_code
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|port
op_assign
id|zfcp_get_port_by_did
c_func
(paren
id|send_els-&gt;adapter
comma
id|send_els-&gt;d_id
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|port
op_eq
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* request rejected or timed out */
r_if
c_cond
(paren
id|send_els-&gt;status
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;ELS request timed out, force physical port &quot;
l_string|&quot;reopen of port 0x%016Lx on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;forcreop&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_erp_port_forced_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
)paren
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;reopen of remote port 0x%016Lx &quot;
l_string|&quot;on adapter %s failed&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|req
op_assign
id|zfcp_sg_to_address
c_func
(paren
id|send_els-&gt;req
)paren
suffix:semicolon
id|resp
op_assign
id|zfcp_sg_to_address
c_func
(paren
id|send_els-&gt;resp
)paren
suffix:semicolon
id|req_code
op_assign
op_star
(paren
id|u8
op_star
)paren
id|req
suffix:semicolon
r_switch
c_cond
(paren
id|req_code
)paren
(brace
r_case
id|ZFCP_LS_RTV
suffix:colon
id|rtv
op_assign
(paren
r_struct
id|zfcp_ls_rtv_acc
op_star
)paren
id|resp
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;RTV response from d_id 0x%08x to s_id &quot;
l_string|&quot;0x%08x (R_A_TOV=%ds E_D_TOV=%d%cs)&bslash;n&quot;
comma
id|port-&gt;d_id
comma
id|port-&gt;adapter-&gt;s_id
comma
id|rtv-&gt;r_a_tov
comma
id|rtv-&gt;e_d_tov
comma
id|rtv-&gt;qualifier
op_amp
id|ZFCP_LS_RTV_E_D_TOV_FLAG
ques
c_cond
l_char|&squot;n&squot;
suffix:colon
l_char|&squot;m&squot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_LS_RLS
suffix:colon
id|rls
op_assign
(paren
r_struct
id|zfcp_ls_rls_acc
op_star
)paren
id|resp
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;RLS response from d_id 0x%08x to s_id &quot;
l_string|&quot;0x%08x (link_failure_count=%u, &quot;
l_string|&quot;loss_of_sync_count=%u, &quot;
l_string|&quot;loss_of_signal_count=%u, &quot;
l_string|&quot;primitive_sequence_protocol_error=%u, &quot;
l_string|&quot;invalid_transmition_word=%u, &quot;
l_string|&quot;invalid_crc_count=%u)&bslash;n&quot;
comma
id|port-&gt;d_id
comma
id|port-&gt;adapter-&gt;s_id
comma
id|rls-&gt;link_failure_count
comma
id|rls-&gt;loss_of_sync_count
comma
id|rls-&gt;loss_of_signal_count
comma
id|rls-&gt;prim_seq_prot_error
comma
id|rls-&gt;invalid_transmition_word
comma
id|rls-&gt;invalid_crc_count
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_LS_PDISC
suffix:colon
id|pdisc
op_assign
(paren
r_struct
id|zfcp_ls_pdisc_acc
op_star
)paren
id|resp
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;PDISC response from d_id 0x%08x to s_id &quot;
l_string|&quot;0x%08x (wwpn=0x%016Lx, wwnn=0x%016Lx, &quot;
l_string|&quot;vendor=&squot;%-16s&squot;)&bslash;n&quot;
comma
id|port-&gt;d_id
comma
id|port-&gt;adapter-&gt;s_id
comma
id|pdisc-&gt;wwpn
comma
id|pdisc-&gt;wwnn
comma
id|pdisc-&gt;vendor_version
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_LS_ADISC
suffix:colon
id|adisc
op_assign
(paren
r_struct
id|zfcp_ls_adisc_acc
op_star
)paren
id|resp
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;ADISC response from d_id 0x%08x to s_id &quot;
l_string|&quot;0x%08x (wwpn=0x%016Lx, wwnn=0x%016Lx, &quot;
l_string|&quot;hard_nport_id=0x%08x, &quot;
l_string|&quot;nport_id=0x%08x)&bslash;n&quot;
comma
id|port-&gt;d_id
comma
id|port-&gt;adapter-&gt;s_id
comma
id|adisc-&gt;wwpn
comma
id|adisc-&gt;wwnn
comma
id|adisc-&gt;hard_nport_id
comma
id|adisc-&gt;nport_id
)paren
suffix:semicolon
multiline_comment|/* FIXME: set wwnn in during open port */
r_if
c_cond
(paren
id|port-&gt;wwnn
op_eq
l_int|0
)paren
id|port-&gt;wwnn
op_assign
id|adisc-&gt;wwnn
suffix:semicolon
r_break
suffix:semicolon
)brace
id|out
suffix:colon
id|zfcp_port_put
c_func
(paren
id|port
)paren
suffix:semicolon
id|__free_pages
c_func
(paren
id|send_els-&gt;req-&gt;page
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|send_els-&gt;req
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|send_els-&gt;resp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|send_els
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_test_link&n; *&n; * purpose:     Test a status of a link to a remote port using the ELS command ADISC&n; *&n; * returns:     0       - Link is OK&n; *              -EPERM  - Port forced reopen failed&n; */
r_int
DECL|function|zfcp_test_link
id|zfcp_test_link
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
)paren
(brace
r_int
id|retval
suffix:semicolon
id|zfcp_port_get
c_func
(paren
id|port
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_els
c_func
(paren
id|port
comma
id|ZFCP_LS_ADISC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|zfcp_port_put
c_func
(paren
id|port
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;reopen needed for port 0x%016Lx &quot;
l_string|&quot;on adapter %s&bslash;n &quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_forced_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;reopen of remote port 0x%016Lx &quot;
l_string|&quot;on adapter %s failed&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;called if a port failed to be opened normally&n; *&t;&t;initiates Forced Reopen recovery which is done&n; *&t;&t;asynchronously&n; *&n; * returns:&t;0&t;- initiated action succesfully&n; *&t;&t;&lt;0&t;- failed to initiate action&n; */
r_static
r_int
DECL|function|zfcp_erp_port_forced_reopen_internal
id|zfcp_erp_port_forced_reopen_internal
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;pf_ro&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;forced reopen of port 0x%016Lx on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|zfcp_erp_port_block
c_func
(paren
id|port
comma
id|clear_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;skipped forced reopen of failed port 0x%016Lx &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;pf_ro_f&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_erp_action_enqueue
c_func
(paren
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
comma
id|port-&gt;adapter
comma
id|port
comma
l_int|NULL
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;Wrappper for zfcp_erp_port_forced_reopen_internal&n; *              used to ensure the correct locking&n; *&n; * returns:&t;0&t;- initiated action succesfully&n; *&t;&t;&lt;0&t;- failed to initiate action&n; */
r_int
DECL|function|zfcp_erp_port_forced_reopen
id|zfcp_erp_port_forced_reopen
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_forced_reopen_internal
c_func
(paren
id|port
comma
id|clear_mask
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;called if a port is to be opened&n; *&t;&t;initiates Reopen recovery which is done&n; *&t;&t;asynchronously&n; *&n; * returns:&t;0&t;- initiated action succesfully&n; *&t;&t;&lt;0&t;- failed to initiate action&n; */
r_static
r_int
DECL|function|zfcp_erp_port_reopen_internal
id|zfcp_erp_port_reopen_internal
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_ro&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;reopen of port 0x%016Lx on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|zfcp_erp_port_block
c_func
(paren
id|port
comma
id|clear_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;skipped reopen of failed port 0x%016Lx &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_ro_f&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
multiline_comment|/* ensure propagation of failed status to new devices */
id|zfcp_erp_port_failed
c_func
(paren
id|port
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_erp_action_enqueue
c_func
(paren
id|ZFCP_ERP_ACTION_REOPEN_PORT
comma
id|port-&gt;adapter
comma
id|port
comma
l_int|NULL
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_erp_port_reopen - initiate reopen of a remote port&n; * @port: port to be reopened&n; * @clear_mask: specifies flags in port status to be cleared&n; * Return: 0 on success, &lt; 0 on error&n; *&n; * This is a wrappper function for zfcp_erp_port_reopen_internal. It ensures&n; * correct locking. An error recovery task is initiated to do the reopen.&n; * To wait for the completion of the reopen zfcp_erp_wait should be used.&n; */
r_int
DECL|function|zfcp_erp_port_reopen
id|zfcp_erp_port_reopen
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_reopen_internal
c_func
(paren
id|port
comma
id|clear_mask
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;called if a unit is to be opened&n; *&t;&t;initiates Reopen recovery which is done&n; *&t;&t;asynchronously&n; *&n; * returns:&t;0&t;- initiated action succesfully&n; *&t;&t;&lt;0&t;- failed to initiate action&n; */
r_static
r_int
DECL|function|zfcp_erp_unit_reopen_internal
id|zfcp_erp_unit_reopen_internal
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|unit-&gt;port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_ro&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;reopen of unit 0x%016Lx on port 0x%016Lx &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|zfcp_erp_unit_block
c_func
(paren
id|unit
comma
id|clear_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;skipped reopen of failed unit 0x%016Lx &quot;
l_string|&quot;on port 0x%016Lx on adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_ro_f&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_erp_action_enqueue
c_func
(paren
id|ZFCP_ERP_ACTION_REOPEN_UNIT
comma
id|unit-&gt;port-&gt;adapter
comma
id|unit-&gt;port
comma
id|unit
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_erp_unit_reopen - initiate reopen of a unit&n; * @unit: unit to be reopened&n; * @clear_mask: specifies flags in unit status to be cleared&n; * Return: 0 on success, &lt; 0 on error&n; *&n; * This is a wrappper for zfcp_erp_unit_reopen_internal. It ensures correct&n; * locking. An error recovery task is initiated to do the reopen.&n; * To wait for the completion of the reopen zfcp_erp_wait should be used.&n; */
r_int
DECL|function|zfcp_erp_unit_reopen
id|zfcp_erp_unit_reopen
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|port
op_assign
id|unit-&gt;port
suffix:semicolon
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_unit_reopen_internal
c_func
(paren
id|unit
comma
id|clear_mask
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;disable I/O,&n; *&t;&t;return any open requests and clean them up,&n; *&t;&t;aim: no pending and incoming I/O&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_erp_adapter_block
id|zfcp_erp_adapter_block
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|clear_mask
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_bl&quot;
)paren
suffix:semicolon
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_UNBLOCKED
op_or
id|clear_mask
comma
id|ZFCP_CLEAR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;enable I/O&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_erp_adapter_unblock
id|zfcp_erp_adapter_unblock
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_ubl&quot;
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_UNBLOCKED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;disable I/O,&n; *&t;&t;return any open requests and clean them up,&n; *&t;&t;aim: no pending and incoming I/O&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_erp_port_block
id|zfcp_erp_port_block
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
r_int
id|clear_mask
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;p_bl&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|zfcp_erp_modify_port_status
c_func
(paren
id|port
comma
id|ZFCP_STATUS_COMMON_UNBLOCKED
op_or
id|clear_mask
comma
id|ZFCP_CLEAR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;enable I/O&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_erp_port_unblock
id|zfcp_erp_port_unblock
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;p_ubl&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_UNBLOCKED
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;disable I/O,&n; *&t;&t;return any open requests and clean them up,&n; *&t;&t;aim: no pending and incoming I/O&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_erp_unit_block
id|zfcp_erp_unit_block
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|clear_mask
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|unit-&gt;port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;u_bl&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|zfcp_erp_modify_unit_status
c_func
(paren
id|unit
comma
id|ZFCP_STATUS_COMMON_UNBLOCKED
op_or
id|clear_mask
comma
id|ZFCP_CLEAR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;enable I/O&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_erp_unit_unblock
id|zfcp_erp_unit_unblock
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|unit-&gt;port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;u_ubl&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_UNBLOCKED
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_erp_action_ready
id|zfcp_erp_action_ready
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;a_ar&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|zfcp_erp_action_to_ready
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|adapter-&gt;erp_ready_sem
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&n; *&n; * returns:&t;&lt;0&t;&t;&t;erp_action not found in any list&n; *&t;&t;ZFCP_ERP_ACTION_READY&t;erp_action is in ready list&n; *&t;&t;ZFCP_ERP_ACTION_RUNNING&t;erp_action is in running list&n; *&n; * locks:&t;erp_lock must be held&n; */
r_static
r_int
DECL|function|zfcp_erp_action_exists
id|zfcp_erp_action_exists
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|list_head
op_star
id|entry
suffix:semicolon
r_struct
id|zfcp_erp_action
op_star
id|entry_erp_action
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
multiline_comment|/* search in running list */
id|list_for_each
c_func
(paren
id|entry
comma
op_amp
id|adapter-&gt;erp_running_head
)paren
(brace
id|entry_erp_action
op_assign
id|list_entry
c_func
(paren
id|entry
comma
r_struct
id|zfcp_erp_action
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry_erp_action
op_eq
id|erp_action
)paren
(brace
id|retval
op_assign
id|ZFCP_ERP_ACTION_RUNNING
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/* search in ready list */
id|list_for_each
c_func
(paren
id|entry
comma
op_amp
id|adapter-&gt;erp_ready_head
)paren
(brace
id|entry_erp_action
op_assign
id|list_entry
c_func
(paren
id|entry
comma
r_struct
id|zfcp_erp_action
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry_erp_action
op_eq
id|erp_action
)paren
(brace
id|retval
op_assign
id|ZFCP_ERP_ACTION_READY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * purpose:&t;checks current status of action (timed out, dismissed, ...)&n; *&t;&t;and does appropriate preparations (dismiss fsf request, ...)&n; *&n; * locks:&t;called under erp_lock (disabled interrupts)&n; *&n; * returns:&t;0&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_check_fsfreq
id|zfcp_erp_strategy_check_fsfreq
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_if
c_cond
(paren
id|erp_action-&gt;fsf_req
)paren
(brace
multiline_comment|/* take lock to ensure that request is not being deleted meanwhile */
id|write_lock
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
)paren
suffix:semicolon
multiline_comment|/* check whether fsf req does still exist */
id|list_for_each_entry
c_func
(paren
id|fsf_req
comma
op_amp
id|adapter-&gt;fsf_req_list_head
comma
id|list
)paren
r_if
c_cond
(paren
id|fsf_req
op_eq
id|erp_action-&gt;fsf_req
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req
op_eq
id|erp_action-&gt;fsf_req
)paren
(brace
multiline_comment|/* fsf_req still exists */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_ca_req&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|fsf_req
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
multiline_comment|/* dismiss fsf_req of timed out or dismissed erp_action */
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
(paren
id|ZFCP_STATUS_ERP_DISMISSED
op_or
id|ZFCP_STATUS_ERP_TIMEDOUT
)paren
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_ca_disreq&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_DISMISSED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_TIMEDOUT
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: erp step timed out &quot;
l_string|&quot;(action=%d, fsf_req=%p)&bslash;n &quot;
comma
id|erp_action-&gt;action
comma
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * If fsf_req is neither dismissed nor completed&n;&t;&t;&t; * then keep it running asynchronously and don&squot;t mess&n;&t;&t;&t; * with the association of erp_action and fsf_req.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
(paren
id|ZFCP_STATUS_FSFREQ_COMPLETED
op_or
id|ZFCP_STATUS_FSFREQ_DISMISSED
)paren
)paren
(brace
multiline_comment|/* forget about association between fsf_req&n;&t;&t;&t;&t;   and erp_action */
id|fsf_req-&gt;erp_action
op_assign
l_int|NULL
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_ca_gonereq&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * even if this fsf_req has gone, forget about&n;&t;&t;&t; * association between erp_action and fsf_req&n;&t;&t;&t; */
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
)brace
id|write_unlock
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
)paren
suffix:semicolon
)brace
r_else
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_ca_noreq&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * purpose:&t;generic handler for asynchronous events related to erp_action events&n; *&t;&t;(normal completion, time-out, dismissing, retry after&n; *&t;&t;low memory condition)&n; *&n; * note:&t;deletion of timer is not required (e.g. in case of a time-out),&n; *&t;&t;but a second try does no harm,&n; *&t;&t;we leave it in here to allow for greater simplification&n; *&n; * returns:&t;0 - there was an action to handle&n; *&t;&t;!0 - otherwise&n; */
r_static
r_int
DECL|function|zfcp_erp_async_handler_nolock
id|zfcp_erp_async_handler_nolock
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
comma
r_int
r_int
id|set_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_erp_action_exists
c_func
(paren
id|erp_action
)paren
op_eq
id|ZFCP_ERP_ACTION_RUNNING
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;a_asyh_ex&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|set_mask
op_amp
id|ZFCP_STATUS_ERP_TIMEDOUT
)paren
)paren
id|del_timer_sync
c_func
(paren
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
id|erp_action-&gt;status
op_or_assign
id|set_mask
suffix:semicolon
id|zfcp_erp_action_ready
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* action is ready or gone - nothing to do */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_asyh_gone&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|retval
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * purpose:&t;generic handler for asynchronous events related to erp_action&n; *               events&t;(normal completion, time-out, dismissing, retry after&n; *&t;&t;low memory condition)&n; *&n; * note:&t;deletion of timer is not required (e.g. in case of a time-out),&n; *&t;&t;but a second try does no harm,&n; *&t;&t;we leave it in here to allow for greater simplification&n; *&n; * returns:&t;0 - there was an action to handle&n; *&t;&t;!0 - otherwise&n; */
r_int
DECL|function|zfcp_erp_async_handler
id|zfcp_erp_async_handler
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
comma
r_int
r_int
id|set_mask
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_async_handler_nolock
c_func
(paren
id|erp_action
comma
id|set_mask
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * purpose:&t;is called for erp_action which was slept waiting for&n; *&t;&t;memory becoming avaliable,&n; *&t;&t;will trigger that this action will be continued&n; */
r_static
r_void
DECL|function|zfcp_erp_memwait_handler
id|zfcp_erp_memwait_handler
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|zfcp_erp_action
op_star
id|erp_action
op_assign
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
id|data
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;a_mwh&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|zfcp_erp_async_handler
c_func
(paren
id|erp_action
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * purpose:&t;is called if an asynchronous erp step timed out,&n; *&t;&t;action gets an appropriate flag and will be processed&n; *&t;&t;accordingly&n; */
r_static
r_void
DECL|function|zfcp_erp_timeout_handler
id|zfcp_erp_timeout_handler
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|zfcp_erp_action
op_star
id|erp_action
op_assign
(paren
r_struct
id|zfcp_erp_action
op_star
)paren
id|data
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;a_th&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|zfcp_erp_async_handler
c_func
(paren
id|erp_action
comma
id|ZFCP_STATUS_ERP_TIMEDOUT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * purpose:&t;is called for an erp_action which needs to be ended&n; *&t;&t;though not being done,&n; *&t;&t;this is usually required if an higher is generated,&n; *&t;&t;action gets an appropriate flag and will be processed&n; *&t;&t;accordingly&n; *&n; * locks:&t;erp_lock held (thus we need to call another handler variant)&n; */
r_static
r_int
DECL|function|zfcp_erp_action_dismiss
id|zfcp_erp_action_dismiss
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;a_adis&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|zfcp_erp_async_handler_nolock
c_func
(paren
id|erp_action
comma
id|ZFCP_STATUS_ERP_DISMISSED
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|zfcp_erp_thread_setup
id|zfcp_erp_thread_setup
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_UP
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|adapter-&gt;erp_ready_head
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|adapter-&gt;erp_running_head
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|adapter-&gt;erp_ready_sem
comma
l_int|0
)paren
suffix:semicolon
id|retval
op_assign
id|kernel_thread
c_func
(paren
id|zfcp_erp_thread
comma
id|adapter
comma
id|SIGCHLD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: creation of erp thread failed for &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_thset_fail&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|wait_event
c_func
(paren
id|adapter-&gt;erp_thread_wqh
comma
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_UP
comma
op_amp
id|adapter-&gt;status
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_thset_ok&quot;
)paren
suffix:semicolon
)brace
r_return
(paren
id|retval
OL
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; *&n; * context:&t;process (i.e. proc-fs or rmmod/insmod)&n; *&n; * note:&t;The caller of this routine ensures that the specified&n; *&t;&t;adapter has been shut down and that this operation&n; *&t;&t;has been completed. Thus, there are no pending erp_actions&n; *&t;&t;which would need to be handled here.&n; */
r_int
DECL|function|zfcp_erp_thread_kill
id|zfcp_erp_thread_kill
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_KILL
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|adapter-&gt;erp_ready_sem
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|adapter-&gt;erp_thread_wqh
comma
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_UP
comma
op_amp
id|adapter-&gt;status
)paren
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_KILL
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_thki_ok&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * purpose:&t;is run as a kernel thread,&n; *&t;&t;goes through list of error recovery actions of associated adapter&n; *&t;&t;and delegates single action to execution&n; *&n; * returns:&t;0&n; */
r_static
r_int
DECL|function|zfcp_erp_thread
id|zfcp_erp_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|data
suffix:semicolon
r_struct
id|list_head
op_star
id|next
suffix:semicolon
r_struct
id|zfcp_erp_action
op_star
id|erp_action
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;zfcperp%s&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* Block all signals */
id|siginitsetinv
c_func
(paren
op_amp
id|current-&gt;blocked
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_UP
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_th_run&quot;
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|adapter-&gt;erp_thread_wqh
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_KILL
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
comma
id|flags
)paren
suffix:semicolon
id|next
op_assign
id|adapter-&gt;erp_ready_head.prev
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|next
op_ne
op_amp
id|adapter-&gt;erp_ready_head
)paren
(brace
id|erp_action
op_assign
id|list_entry
c_func
(paren
id|next
comma
r_struct
id|zfcp_erp_action
comma
id|list
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * process action (incl. [re]moving it&n;&t;&t;&t; * from &squot;ready&squot; queue)&n;&t;&t;&t; */
id|zfcp_erp_strategy
c_func
(paren
id|erp_action
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * sleep as long as there is nothing to do, i.e.&n;&t;&t; * no action in &squot;ready&squot; queue to be processed and&n;&t;&t; * thread is not to be killed&n;&t;&t; */
id|down_interruptible
c_func
(paren
op_amp
id|adapter-&gt;erp_ready_sem
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_th_woken&quot;
)paren
suffix:semicolon
)brace
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_UP
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_th_stop&quot;
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|adapter-&gt;erp_thread_wqh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;drives single error recovery action and schedules higher and&n; *&t;&t;subordinate actions, if necessary&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_SUCCEEDED&t;- action finished successfully (deqd)&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully (deqd)&n; *&t;&t;ZFCP_ERP_EXIT&t;&t;- action finished (dequeued), offline&n; *&t;&t;ZFCP_ERP_DISMISSED&t;- action canceled (dequeued)&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy
id|zfcp_erp_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
r_int
id|action
op_assign
id|erp_action-&gt;action
suffix:semicolon
id|u32
id|status
op_assign
id|erp_action-&gt;status
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* serialise dismissing, timing out, moving, enqueueing */
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
multiline_comment|/* dequeue dismissed action and leave, if required */
id|retval
op_assign
id|zfcp_erp_strategy_check_action
c_func
(paren
id|erp_action
comma
id|retval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
id|ZFCP_ERP_DISMISSED
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;a_st_dis1&quot;
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * move action to &squot;running&squot; queue before processing it&n;&t; * (to avoid a race condition regarding moving the&n;&t; * action to the &squot;running&squot; queue and back)&n;&t; */
id|zfcp_erp_action_to_running
c_func
(paren
id|erp_action
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * try to process action as far as possible,&n;&t; * no lock to allow for blocking operations (kmalloc, qdio, ...),&n;&t; * afterwards the lock is required again for the following reasons:&n;&t; * - dequeueing of finished action and enqueueing of&n;&t; *   follow-up actions must be atomic so that any other&n;&t; *   reopen-routine does not believe there is nothing to do&n;&t; *   and that it is safe to enqueue something else,&n;&t; * - we want to force any control thread which is dismissing&n;&t; *   actions to finish this before we decide about&n;&t; *   necessary steps to be taken here further&n;&t; */
id|write_unlock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_strategy_do_action
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * check for dismissed status again to avoid follow-up actions,&n;&t; * failing of targets and so on for dismissed actions&n;&t; */
id|retval
op_assign
id|zfcp_erp_strategy_check_action
c_func
(paren
id|erp_action
comma
id|retval
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|retval
)paren
(brace
r_case
id|ZFCP_ERP_DISMISSED
suffix:colon
multiline_comment|/* leave since this action has ridden to its ancestors */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_st_dis2&quot;
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
r_case
id|ZFCP_ERP_NOMEM
suffix:colon
multiline_comment|/* no memory to continue immediately, let it sleep */
r_if
c_cond
(paren
op_logical_neg
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_LOWMEM
)paren
)paren
(brace
op_increment
id|adapter-&gt;erp_low_mem_count
suffix:semicolon
id|erp_action-&gt;status
op_or_assign
id|ZFCP_STATUS_ERP_LOWMEM
suffix:semicolon
)brace
multiline_comment|/* This condition is true if there is no memory available&n;&t;&t;   for any erp_action on this adapter. This implies that there&n;&t;&t;   are no elements in the memory pool(s) left for erp_actions.&n;&t;&t;   This might happen if an erp_action that used a memory pool&n;&t;&t;   element was timed out.&n;&t;&t; */
r_if
c_cond
(paren
id|adapter-&gt;erp_total_count
op_eq
id|adapter-&gt;erp_low_mem_count
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_st_lowmem&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: no mempool elements available, &quot;
l_string|&quot;restarting I/O on adapter %s &quot;
l_string|&quot;to free mempool&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen_internal
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;a_st_memw&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_strategy_memwait
c_func
(paren
id|erp_action
)paren
suffix:semicolon
)brace
r_goto
id|unlock
suffix:semicolon
r_case
id|ZFCP_ERP_CONTINUES
suffix:colon
multiline_comment|/* leave since this action runs asynchronously */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_st_cont&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_LOWMEM
)paren
(brace
op_decrement
id|adapter-&gt;erp_low_mem_count
suffix:semicolon
id|erp_action-&gt;status
op_and_assign
op_complement
id|ZFCP_STATUS_ERP_LOWMEM
suffix:semicolon
)brace
r_goto
id|unlock
suffix:semicolon
)brace
multiline_comment|/* ok, finished action (whatever its result is) */
multiline_comment|/* check for unrecoverable targets */
id|retval
op_assign
id|zfcp_erp_strategy_check_target
c_func
(paren
id|erp_action
comma
id|retval
)paren
suffix:semicolon
multiline_comment|/* action must be dequeued (here to allow for further ones) */
id|zfcp_erp_action_dequeue
c_func
(paren
id|erp_action
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * put this target through the erp mill again if someone has&n;&t; * requested to change the status of a target being online &n;&t; * to offline or the other way around&n;&t; * (old retval is preserved if nothing has to be done here)&n;&t; */
id|retval
op_assign
id|zfcp_erp_strategy_statechange
c_func
(paren
id|action
comma
id|status
comma
id|adapter
comma
id|port
comma
id|unit
comma
id|retval
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * leave if target is in permanent error state or if&n;&t; * action is repeated in order to process state change&n;&t; */
r_if
c_cond
(paren
id|retval
op_eq
id|ZFCP_ERP_EXIT
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;a_st_exit&quot;
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
multiline_comment|/* trigger follow up actions */
id|zfcp_erp_strategy_followup_actions
c_func
(paren
id|action
comma
id|adapter
comma
id|port
comma
id|unit
comma
id|retval
)paren
suffix:semicolon
id|unlock
suffix:colon
id|write_unlock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
id|ZFCP_ERP_CONTINUES
)paren
id|zfcp_erp_action_cleanup
c_func
(paren
id|action
comma
id|adapter
comma
id|port
comma
id|unit
comma
id|retval
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * a few tasks remain when the erp queues are empty&n;&t; * (don&squot;t do that if the last action evaluated was dismissed&n;&t; * since this clearly indicates that there is more to come) :&n;&t; * - close the name server port if it is open yet&n;&t; *   (enqueues another [probably] final action)&n;&t; * - otherwise, wake up whoever wants to be woken when we are&n;&t; *   done with erp&n;&t; */
r_if
c_cond
(paren
id|retval
op_ne
id|ZFCP_ERP_DISMISSED
)paren
id|zfcp_erp_strategy_check_queues
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_st_done&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_DISMISSED&t;- if action has been dismissed&n; *&t;&t;retval&t;&t;&t;- otherwise&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_check_action
id|zfcp_erp_strategy_check_action
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
comma
r_int
id|retval
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|zfcp_erp_strategy_check_fsfreq
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_DISMISSED
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_stcd_dis&quot;
)paren
suffix:semicolon
id|zfcp_erp_action_dequeue
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_DISMISSED
suffix:semicolon
)brace
r_else
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_stcd_nodis&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_do_action
id|zfcp_erp_strategy_do_action
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
multiline_comment|/*&n;&t; * try to execute/continue action as far as possible,&n;&t; * note: no lock in subsequent strategy routines&n;&t; * (this allows these routine to call schedule, e.g.&n;&t; * kmalloc with such flags or qdio_initialize &amp; friends)&n;&t; * Note: in case of timeout, the seperate strategies will fail&n;&t; * anyhow. No need for a special action. Even worse, a nameserver&n;&t; * failure would not wake up waiting ports without the call.&n;&t; */
r_switch
c_cond
(paren
id|erp_action-&gt;action
)paren
(brace
r_case
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:colon
id|retval
op_assign
id|zfcp_erp_adapter_strategy
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
suffix:colon
id|retval
op_assign
id|zfcp_erp_port_forced_strategy
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:colon
id|retval
op_assign
id|zfcp_erp_port_strategy
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_UNIT
suffix:colon
id|retval
op_assign
id|zfcp_erp_unit_strategy
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;a_stda_bug&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: unknown erp action requested on &quot;
l_string|&quot;adapter %s (action=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;action
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;triggers retry of this action after a certain amount of time&n; *&t;&t;by means of timer provided by erp_action&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES - erp_action sleeps in erp running queue&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_memwait
id|zfcp_erp_strategy_memwait
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_CONTINUES
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_mwinit&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
id|erp_action-&gt;timer.function
op_assign
id|zfcp_erp_memwait_handler
suffix:semicolon
id|erp_action-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|erp_action
suffix:semicolon
id|erp_action-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|ZFCP_ERP_MEMWAIT_TIMEOUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* &n; * function:    zfcp_erp_adapter_failed&n; *&n; * purpose:     sets the adapter and all underlying devices to ERP_FAILED&n; *&n; */
r_void
DECL|function|zfcp_erp_adapter_failed
id|zfcp_erp_adapter_failed
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;adapter erp failed on adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;a_afail&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * function:    zfcp_erp_port_failed&n; *&n; * purpose:     sets the port and all underlying devices to ERP_FAILED&n; *&n; */
r_void
DECL|function|zfcp_erp_port_failed
id|zfcp_erp_port_failed
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
)paren
(brace
id|zfcp_erp_modify_port_status
c_func
(paren
id|port
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;port erp failed on port 0x%016Lx on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;p_pfail&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * function:    zfcp_erp_unit_failed&n; *&n; * purpose:     sets the unit to ERP_FAILED&n; *&n; */
r_void
DECL|function|zfcp_erp_unit_failed
id|zfcp_erp_unit_failed
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
)paren
(brace
id|zfcp_erp_modify_unit_status
c_func
(paren
id|unit
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;unit erp failed on unit 0x%016Lx on port 0x%016Lx &quot;
l_string|&quot; on adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|unit-&gt;port-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;u_ufail&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|unit-&gt;port-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_erp_strategy_check_target&n; *&n; * purpose:&t;increments the erp action count on the device currently in&n; *              recovery if the action failed or resets the count in case of&n; *              success. If a maximum count is exceeded the device is marked&n; *              as ERP_FAILED.&n; *&t;&t;The &squot;blocked&squot; state of a target which has been recovered&n; *              successfully is reset.&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (not considered)&n; *&t;&t;ZFCP_ERP_SUCCEEDED&t;- action finished successfully &n; *&t;&t;ZFCP_ERP_EXIT&t;&t;- action failed and will not continue&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_check_target
id|zfcp_erp_strategy_check_target
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
comma
r_int
id|result
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_stct_norm&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|result
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|erp_action-&gt;action
)paren
(brace
r_case
id|ZFCP_ERP_ACTION_REOPEN_UNIT
suffix:colon
id|result
op_assign
id|zfcp_erp_strategy_check_unit
c_func
(paren
id|unit
comma
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
suffix:colon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:colon
id|result
op_assign
id|zfcp_erp_strategy_check_port
c_func
(paren
id|port
comma
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:colon
id|result
op_assign
id|zfcp_erp_strategy_check_adapter
c_func
(paren
id|adapter
comma
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_statechange
id|zfcp_erp_strategy_statechange
c_func
(paren
r_int
id|action
comma
id|u32
id|status
comma
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_port
op_star
id|port
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|retval
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_stsc&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:colon
r_if
c_cond
(paren
id|zfcp_erp_strategy_statechange_detected
c_func
(paren
op_amp
id|adapter-&gt;status
comma
id|status
)paren
)paren
(brace
id|zfcp_erp_adapter_reopen_internal
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
suffix:colon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:colon
r_if
c_cond
(paren
id|zfcp_erp_strategy_statechange_detected
c_func
(paren
op_amp
id|port-&gt;status
comma
id|status
)paren
)paren
(brace
id|zfcp_erp_port_reopen_internal
c_func
(paren
id|port
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_UNIT
suffix:colon
r_if
c_cond
(paren
id|zfcp_erp_strategy_statechange_detected
c_func
(paren
op_amp
id|unit-&gt;status
comma
id|status
)paren
)paren
(brace
id|zfcp_erp_unit_reopen_internal
c_func
(paren
id|unit
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_inline
r_int
DECL|function|zfcp_erp_strategy_statechange_detected
id|zfcp_erp_strategy_statechange_detected
c_func
(paren
id|atomic_t
op_star
id|target_status
comma
id|u32
id|erp_status
)paren
(brace
r_return
multiline_comment|/* take it online */
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|target_status
)paren
op_logical_and
(paren
id|ZFCP_STATUS_ERP_CLOSE_ONLY
op_amp
id|erp_status
)paren
)paren
op_logical_or
multiline_comment|/* take it offline */
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|target_status
)paren
op_logical_and
op_logical_neg
(paren
id|ZFCP_STATUS_ERP_CLOSE_ONLY
op_amp
id|erp_status
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_erp_scsi_add_device&n; * @data: pointer to a struct zfcp_unit&n; *&n; * Registers a logical unit with the SCSI stack.&n; */
r_static
r_void
DECL|function|zfcp_erp_scsi_add_device
id|zfcp_erp_scsi_add_device
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
(brace
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|work_struct
id|work
suffix:semicolon
)brace
op_star
id|p
suffix:semicolon
id|p
op_assign
id|data
suffix:semicolon
id|scsi_add_device
c_func
(paren
id|p-&gt;unit-&gt;port-&gt;adapter-&gt;scsi_host
comma
l_int|0
comma
id|p-&gt;unit-&gt;port-&gt;scsi_id
comma
id|p-&gt;unit-&gt;scsi_lun
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|p-&gt;unit-&gt;scsi_add_work
comma
l_int|0
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|p-&gt;unit-&gt;scsi_add_wq
)paren
suffix:semicolon
id|zfcp_unit_put
c_func
(paren
id|p-&gt;unit
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_erp_schedule_work&n; * @unit: pointer to unit which should be registered with SCSI stack&n; *&n; * Schedules work which registers a unit with the SCSI stack&n; */
r_static
r_int
DECL|function|zfcp_erp_schedule_work
id|zfcp_erp_schedule_work
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
)paren
(brace
r_struct
(brace
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|work_struct
id|work
suffix:semicolon
)brace
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|atomic_compare_and_swap
c_func
(paren
l_int|0
comma
l_int|1
comma
op_amp
id|unit-&gt;scsi_add_work
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|p
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: registration at SCSI stack failed for &quot;
l_string|&quot;unit 0x%016Lx on port 0x%016Lx on &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|unit-&gt;scsi_add_work
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|zfcp_unit_get
c_func
(paren
id|unit
)paren
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|p
)paren
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|p-&gt;work
comma
id|zfcp_erp_scsi_add_device
comma
id|p
)paren
suffix:semicolon
id|p-&gt;unit
op_assign
id|unit
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|p-&gt;work
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_check_unit
id|zfcp_erp_strategy_check_unit
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|result
)paren
(brace
id|debug_text_event
c_func
(paren
id|unit-&gt;port-&gt;adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_stct&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|unit-&gt;port-&gt;adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|result
)paren
(brace
r_case
id|ZFCP_ERP_SUCCEEDED
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|unit-&gt;erp_counter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_unit_unblock
c_func
(paren
id|unit
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_FAILED
suffix:colon
id|atomic_inc
c_func
(paren
op_amp
id|unit-&gt;erp_counter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|unit-&gt;erp_counter
)paren
OG
id|ZFCP_MAX_ERPS
)paren
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_EXIT
suffix:colon
multiline_comment|/* nothing */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|zfcp_erp_unit_block
c_func
(paren
id|unit
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* for ZFCP_ERP_SUCCEEDED */
id|result
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_check_port
id|zfcp_erp_strategy_check_port
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
r_int
id|result
)paren
(brace
id|debug_text_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_stct&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|result
)paren
(brace
r_case
id|ZFCP_ERP_SUCCEEDED
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|port-&gt;erp_counter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_port_unblock
c_func
(paren
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_FAILED
suffix:colon
id|atomic_inc
c_func
(paren
op_amp
id|port-&gt;erp_counter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|port-&gt;erp_counter
)paren
OG
id|ZFCP_MAX_ERPS
)paren
id|zfcp_erp_port_failed
c_func
(paren
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_EXIT
suffix:colon
multiline_comment|/* nothing */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|zfcp_erp_port_block
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* for ZFCP_ERP_SUCCEEDED */
id|result
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_check_adapter
id|zfcp_erp_strategy_check_adapter
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|result
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_stct&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|result
)paren
(brace
r_case
id|ZFCP_ERP_SUCCEEDED
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;erp_counter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_adapter_unblock
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_FAILED
suffix:colon
id|atomic_inc
c_func
(paren
op_amp
id|adapter-&gt;erp_counter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;erp_counter
)paren
OG
id|ZFCP_MAX_ERPS
)paren
id|zfcp_erp_adapter_failed
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_EXIT
suffix:colon
multiline_comment|/* nothing */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|zfcp_erp_adapter_block
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* for ZFCP_ERP_SUCCEEDED */
id|result
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;remaining things in good cases,&n; *&t;&t;escalation in bad cases&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_followup_actions
id|zfcp_erp_strategy_followup_actions
c_func
(paren
r_int
id|action
comma
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_port
op_star
id|port
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|status
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_stfol&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
multiline_comment|/* initiate follow-up actions depending on success of finished action */
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:colon
r_if
c_cond
(paren
id|status
op_eq
id|ZFCP_ERP_SUCCEEDED
)paren
id|zfcp_erp_port_reopen_all_internal
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_else
id|zfcp_erp_adapter_reopen_internal
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
suffix:colon
r_if
c_cond
(paren
id|status
op_eq
id|ZFCP_ERP_SUCCEEDED
)paren
id|zfcp_erp_port_reopen_internal
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_else
id|zfcp_erp_adapter_reopen_internal
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:colon
r_if
c_cond
(paren
id|status
op_eq
id|ZFCP_ERP_SUCCEEDED
)paren
id|zfcp_erp_unit_reopen_all_internal
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_else
id|zfcp_erp_port_forced_reopen_internal
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_UNIT
suffix:colon
r_if
c_cond
(paren
id|status
op_eq
id|ZFCP_ERP_SUCCEEDED
)paren
suffix:semicolon
multiline_comment|/* no further action */
r_else
id|zfcp_erp_port_reopen_internal
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_strategy_check_queues
id|zfcp_erp_strategy_check_queues
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|nport
op_assign
id|adapter-&gt;nameserver_port
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|adapter-&gt;erp_ready_head
)paren
op_logical_and
id|list_empty
c_func
(paren
op_amp
id|adapter-&gt;erp_running_head
)paren
)paren
(brace
r_if
c_cond
(paren
id|nport
op_logical_and
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|nport-&gt;status
)paren
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;a_cq_nspsd&quot;
)paren
suffix:semicolon
multiline_comment|/* taking down nameserver port */
id|zfcp_erp_port_reopen_internal
c_func
(paren
id|nport
comma
id|ZFCP_STATUS_COMMON_RUNNING
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
)brace
r_else
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;a_cq_wake&quot;
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_PENDING
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|adapter-&gt;erp_done_wqh
)paren
suffix:semicolon
)brace
)brace
r_else
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_cq_notempty&quot;
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_erp_wait - wait for completion of error recovery on an adapter&n; * @adapter: adapter for which to wait for completion of its error recovery&n; * Return: 0&n; */
r_int
DECL|function|zfcp_erp_wait
id|zfcp_erp_wait
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|wait_event
c_func
(paren
id|adapter-&gt;erp_done_wqh
comma
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_PENDING
comma
op_amp
id|adapter-&gt;status
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_erp_modify_adapter_status&n; *&n; * purpose:&t;&n; *&n; */
r_void
DECL|function|zfcp_erp_modify_adapter_status
id|zfcp_erp_modify_adapter_status
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
id|u32
id|mask
comma
r_int
id|set_or_clear
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|u32
id|common_mask
op_assign
id|mask
op_amp
id|ZFCP_COMMON_FLAGS
suffix:semicolon
r_if
c_cond
(paren
id|set_or_clear
op_eq
id|ZFCP_SET
)paren
(brace
id|atomic_set_mask
c_func
(paren
id|mask
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_mod_as_s&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_clear_mask
c_func
(paren
id|mask
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;erp_counter
comma
l_int|0
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_mod_as_c&quot;
)paren
suffix:semicolon
)brace
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|mask
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* Deal with all underlying devices, only pass common_mask */
r_if
c_cond
(paren
id|common_mask
)paren
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
id|zfcp_erp_modify_port_status
c_func
(paren
id|port
comma
id|common_mask
comma
id|set_or_clear
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_erp_modify_port_status&n; *&n; * purpose:&t;sets the port and all underlying devices to ERP_FAILED&n; *&n; */
r_void
DECL|function|zfcp_erp_modify_port_status
id|zfcp_erp_modify_port_status
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
id|u32
id|mask
comma
r_int
id|set_or_clear
)paren
(brace
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|u32
id|common_mask
op_assign
id|mask
op_amp
id|ZFCP_COMMON_FLAGS
suffix:semicolon
r_if
c_cond
(paren
id|set_or_clear
op_eq
id|ZFCP_SET
)paren
(brace
id|atomic_set_mask
c_func
(paren
id|mask
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;p_mod_ps_s&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_clear_mask
c_func
(paren
id|mask
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
id|atomic_set
c_func
(paren
op_amp
id|port-&gt;erp_counter
comma
l_int|0
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;p_mod_ps_c&quot;
)paren
suffix:semicolon
)brace
id|debug_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|mask
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* Modify status of all underlying devices, only pass common mask */
r_if
c_cond
(paren
id|common_mask
)paren
id|list_for_each_entry
c_func
(paren
id|unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
id|zfcp_erp_modify_unit_status
c_func
(paren
id|unit
comma
id|common_mask
comma
id|set_or_clear
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_erp_modify_unit_status&n; *&n; * purpose:&t;sets the unit to ERP_FAILED&n; *&n; */
r_void
DECL|function|zfcp_erp_modify_unit_status
id|zfcp_erp_modify_unit_status
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
id|u32
id|mask
comma
r_int
id|set_or_clear
)paren
(brace
r_if
c_cond
(paren
id|set_or_clear
op_eq
id|ZFCP_SET
)paren
(brace
id|atomic_set_mask
c_func
(paren
id|mask
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|unit-&gt;port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;u_mod_us_s&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_clear_mask
c_func
(paren
id|mask
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|unit-&gt;erp_counter
comma
l_int|0
)paren
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|unit-&gt;port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;u_mod_us_c&quot;
)paren
suffix:semicolon
)brace
id|debug_event
c_func
(paren
id|unit-&gt;port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|unit-&gt;port-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|mask
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;Wrappper for zfcp_erp_port_reopen_all_internal&n; *              used to ensure the correct locking&n; *&n; * returns:&t;0&t;- initiated action succesfully&n; *&t;&t;&lt;0&t;- failed to initiate action&n; */
r_int
DECL|function|zfcp_erp_port_reopen_all
id|zfcp_erp_port_reopen_all
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_reopen_all_internal
c_func
(paren
id|adapter
comma
id|clear_mask
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;FIXME&n; */
r_static
r_int
DECL|function|zfcp_erp_port_reopen_all_internal
id|zfcp_erp_port_reopen_all_internal
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_PORT_WKA
comma
op_amp
id|port-&gt;status
)paren
)paren
id|zfcp_erp_port_reopen_internal
c_func
(paren
id|port
comma
id|clear_mask
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;FIXME&n; */
r_static
r_int
DECL|function|zfcp_erp_unit_reopen_all_internal
id|zfcp_erp_unit_reopen_all_internal
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
comma
r_int
id|clear_mask
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
id|zfcp_erp_unit_reopen_internal
c_func
(paren
id|unit
comma
id|clear_mask
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;this routine executes the &squot;Reopen Adapter&squot; action&n; *&t;&t;(the entire action is processed synchronously, since&n; *&t;&t;there are no actions which might be run concurrently&n; *&t;&t;per definition)&n; *&n; * returns:&t;ZFCP_ERP_SUCCEEDED&t;- action finished successfully&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_adapter_strategy
id|zfcp_erp_adapter_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_adapter_strategy_close
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_CLOSE_ONLY
)paren
id|retval
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
r_else
id|retval
op_assign
id|zfcp_erp_adapter_strategy_open
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_ast/ret&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|retval
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
id|ZFCP_ERP_FAILED
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Waiting to allow the adapter %s &quot;
l_string|&quot;to recover itself&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|msleep
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|ZFCP_TYPE2_RECOVERY_TIME
)paren
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_SUCCEEDED      - action finished successfully&n; *              ZFCP_ERP_FAILED         - action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_adapter_strategy_close
id|zfcp_erp_adapter_strategy_close
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|erp_action-&gt;adapter-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_adapter_strategy_generic
c_func
(paren
id|erp_action
comma
l_int|1
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|erp_action-&gt;adapter-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_SUCCEEDED      - action finished successfully&n; *              ZFCP_ERP_FAILED         - action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_adapter_strategy_open
id|zfcp_erp_adapter_strategy_open
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|erp_action-&gt;adapter-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_adapter_strategy_generic
c_func
(paren
id|erp_action
comma
l_int|0
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|erp_action-&gt;adapter-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_register_adapter&n; *&n; * purpose:&t;allocate the irq associated with this devno and register&n; *&t;&t;the FSF adapter with the SCSI stack&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_erp_adapter_strategy_generic
id|zfcp_erp_adapter_strategy_generic
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
comma
r_int
id|close
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
r_if
c_cond
(paren
id|close
)paren
r_goto
id|close_only
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_adapter_strategy_open_qdio
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
id|ZFCP_ERP_SUCCEEDED
)paren
r_goto
id|failed_qdio
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_adapter_strategy_open_fsf
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
id|ZFCP_ERP_SUCCEEDED
)paren
r_goto
id|failed_openfcp
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|erp_action-&gt;adapter-&gt;status
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|close_only
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|erp_action-&gt;adapter-&gt;status
)paren
suffix:semicolon
id|failed_openfcp
suffix:colon
id|zfcp_erp_adapter_strategy_close_qdio
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|zfcp_erp_adapter_strategy_close_fsf
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|failed_qdio
suffix:colon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_qdio_init&n; *&n; * purpose:&t;setup QDIO operation for specified adapter&n; *&n; * returns:&t;0 - successful setup&n; *&t;&t;!0 - failed setup&n; */
r_int
DECL|function|zfcp_erp_adapter_strategy_open_qdio
id|zfcp_erp_adapter_strategy_open_qdio
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
id|i
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_QDIOUP
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: second attempt to set up QDIO on &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|failed_sanity
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qdio_establish
c_func
(paren
op_amp
id|adapter-&gt;qdio_init_data
)paren
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: establishment of QDIO queues failed &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|failed_qdio_establish
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;qdio_est&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qdio_activate
c_func
(paren
id|adapter-&gt;ccw_device
comma
l_int|0
)paren
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: activation of QDIO queues failed &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|failed_qdio_activate
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;qdio_act&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * put buffers into response queue,&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sbale
op_assign
op_amp
(paren
id|adapter-&gt;response_queue.buffer
(braket
id|i
)braket
op_member_access_from_pointer
id|element
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbale-&gt;length
op_assign
l_int|0
suffix:semicolon
id|sbale-&gt;flags
op_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|sbale-&gt;addr
op_assign
l_int|0
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;calling do_QDIO on adapter %s (flags=0x%x, &quot;
l_string|&quot;queue_no=%i, index_in_queue=%i, count=%i)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|QDIO_FLAG_SYNC_INPUT
comma
l_int|0
comma
l_int|0
comma
id|QDIO_MAX_BUFFERS_PER_Q
)paren
suffix:semicolon
id|retval
op_assign
id|do_QDIO
c_func
(paren
id|adapter-&gt;ccw_device
comma
id|QDIO_FLAG_SYNC_INPUT
comma
l_int|0
comma
l_int|0
comma
id|QDIO_MAX_BUFFERS_PER_Q
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: setup of QDIO failed (retval=%d)&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_goto
id|failed_do_qdio
suffix:semicolon
)brace
r_else
(brace
id|adapter-&gt;response_queue.free_index
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;response_queue.free_count
comma
l_int|0
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;%i buffers successfully enqueued to &quot;
l_string|&quot;response queue&bslash;n&quot;
comma
id|QDIO_MAX_BUFFERS_PER_Q
)paren
suffix:semicolon
)brace
multiline_comment|/* set index of first avalable SBALS / number of available SBALS */
id|adapter-&gt;request_queue.free_index
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;request_queue.free_count
comma
id|QDIO_MAX_BUFFERS_PER_Q
)paren
suffix:semicolon
id|adapter-&gt;request_queue.distance_from_int
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialize waitqueue used to wait for free SBALs in requests queue */
id|init_waitqueue_head
c_func
(paren
op_amp
id|adapter-&gt;request_wq
)paren
suffix:semicolon
multiline_comment|/* ok, we did it - skip all cleanups for different failures */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_QDIOUP
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|failed_do_qdio
suffix:colon
multiline_comment|/* NOP */
id|failed_qdio_activate
suffix:colon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;qdio_down1a&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|qdio_shutdown
c_func
(paren
id|adapter-&gt;ccw_device
comma
id|QDIO_FLAG_CLEANUP_USING_CLEAR
)paren
op_eq
op_minus
id|EINPROGRESS
)paren
id|msleep
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;qdio_down1b&quot;
)paren
suffix:semicolon
id|failed_qdio_establish
suffix:colon
id|failed_sanity
suffix:colon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_qdio_cleanup&n; *&n; * purpose:&t;cleans up QDIO operation for the specified adapter&n; *&n; * returns:&t;0 - successful cleanup&n; *&t;&t;!0 - failed cleanup&n; */
r_int
DECL|function|zfcp_erp_adapter_strategy_close_qdio
id|zfcp_erp_adapter_strategy_close_qdio
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
r_int
id|first_used
suffix:semicolon
r_int
id|used_count
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_QDIOUP
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: attempt to shut down inactive QDIO &quot;
l_string|&quot;queues on adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get queue_lock and clear QDIOUP flag. Thus it&squot;s guaranteed that&n;&t; * do_QDIO won&squot;t be called while qdio_shutdown is in progress.&n;&t; */
id|write_lock_irq
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_QDIOUP
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;qdio_down2a&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|qdio_shutdown
c_func
(paren
id|adapter-&gt;ccw_device
comma
id|QDIO_FLAG_CLEANUP_USING_CLEAR
)paren
op_eq
op_minus
id|EINPROGRESS
)paren
id|msleep
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;qdio_down2b&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * First we had to stop QDIO operation.&n;&t; * Now it is safe to take the following actions.&n;&t; */
multiline_comment|/* Cleanup only necessary when there are unacknowledged buffers */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;request_queue.free_count
)paren
OL
id|QDIO_MAX_BUFFERS_PER_Q
)paren
(brace
id|first_used
op_assign
(paren
id|adapter-&gt;request_queue.free_index
op_plus
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;request_queue.free_count
)paren
)paren
op_mod
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|used_count
op_assign
id|QDIO_MAX_BUFFERS_PER_Q
op_minus
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;request_queue.free_count
)paren
suffix:semicolon
id|zfcp_qdio_zero_sbals
c_func
(paren
id|adapter-&gt;request_queue.buffer
comma
id|first_used
comma
id|used_count
)paren
suffix:semicolon
)brace
id|adapter-&gt;response_queue.free_index
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;response_queue.free_count
comma
l_int|0
)paren
suffix:semicolon
id|adapter-&gt;request_queue.free_index
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;request_queue.free_count
comma
l_int|0
)paren
suffix:semicolon
id|adapter-&gt;request_queue.distance_from_int
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_init&n; *&n; * purpose:&t;initializes FSF operation for the specified adapter&n; *&n; * returns:&t;0 - succesful initialization of FSF operation&n; *&t;&t;!0 - failed to initialize FSF operation&n; */
r_static
r_int
DECL|function|zfcp_erp_adapter_strategy_open_fsf
id|zfcp_erp_adapter_strategy_open_fsf
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
multiline_comment|/* do &squot;exchange configuration data&squot; */
id|retval
op_assign
id|zfcp_erp_adapter_strategy_open_fsf_xconfig
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
id|ZFCP_ERP_FAILED
)paren
r_return
id|retval
suffix:semicolon
multiline_comment|/* start the desired number of Status Reads */
id|retval
op_assign
id|zfcp_erp_adapter_strategy_open_fsf_statusread
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_adapter_strategy_open_fsf_xconfig
id|zfcp_erp_adapter_strategy_open_fsf_xconfig
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
r_int
id|retries
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_XCONFIG_OK
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|retries
op_assign
id|ZFCP_EXCHANGE_CONFIG_DATA_RETRIES
suffix:semicolon
r_do
(brace
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_HOST_CON_INIT
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Doing exchange config data&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_erp_action_to_running
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|zfcp_erp_timeout_init
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_fsf_exchange_config_data
c_func
(paren
id|erp_action
)paren
)paren
(brace
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_fstx_xf&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error:  initiation of exchange of &quot;
l_string|&quot;configuration data failed for &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_fstx_xok&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Xchange underway&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Why this works:&n;&t;&t; * Both the normal completion handler as well as the timeout&n;&t;&t; * handler will do an &squot;up&squot; when the &squot;exchange config data&squot;&n;&t;&t; * request completes or times out. Thus, the signal to go on&n;&t;&t; * won&squot;t be lost utilizing this semaphore.&n;&t;&t; * Furthermore, this &squot;adapter_reopen&squot; action is&n;&t;&t; * guaranteed to be the only action being there (highest action&n;&t;&t; * which prevents other actions from being created).&n;&t;&t; * Resulting from that, the wake signal recognized here&n;&t;&t; * _must_ be the one belonging to the &squot;exchange config&n;&t;&t; * data&squot; request.&n;&t;&t; */
id|down
c_func
(paren
op_amp
id|adapter-&gt;erp_ready_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_TIMEDOUT
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: exchange of configuration data &quot;
l_string|&quot;for adapter %s timed out&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_HOST_CON_INIT
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;host connection still initialising... &quot;
l_string|&quot;waiting and retrying...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* sleep a little bit before retry */
id|msleep
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|ZFCP_EXCHANGE_CONFIG_DATA_SLEEP
)paren
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|retries
op_decrement
)paren
op_logical_and
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_HOST_CON_INIT
comma
op_amp
id|adapter-&gt;status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_XCONFIG_OK
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: exchange of configuration data for &quot;
l_string|&quot;adapter %s failed&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_adapter_strategy_open_fsf_statusread
id|zfcp_erp_adapter_strategy_open_fsf_statusread
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
r_int
id|temp_ret
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_int
id|i
suffix:semicolon
id|adapter-&gt;status_read_failed
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ZFCP_STATUS_READS_RECOM
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp_ret
op_assign
id|zfcp_fsf_status_read
c_func
(paren
id|adapter
comma
id|ZFCP_WAIT_FOR_SBAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp_ret
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: set-up of unsolicited status &quot;
l_string|&quot;notification failed on adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_cleanup&n; *&n; * purpose:&t;cleanup FSF operation for specified adapter&n; *&n; * returns:&t;0 - FSF operation successfully cleaned up&n; *&t;&t;!0 - failed to cleanup FSF operation for this adapter&n; */
r_static
r_int
DECL|function|zfcp_erp_adapter_strategy_close_fsf
id|zfcp_erp_adapter_strategy_close_fsf
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
multiline_comment|/*&n;&t; * wake waiting initiators of requests,&n;&t; * return SCSI commands (with error status),&n;&t; * clean up all requests (synchronously)&n;&t; */
id|zfcp_fsf_req_dismiss_all
c_func
(paren
id|adapter
)paren
suffix:semicolon
multiline_comment|/* reset FSF request sequence number */
id|adapter-&gt;fsf_req_seq_no
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* all ports and units are closed */
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_OPEN
comma
id|ZFCP_CLEAR
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;this routine executes the &squot;Reopen Physical Port&squot; action&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_SUCCEEDED&t;- action finished successfully&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_port_forced_strategy
id|zfcp_erp_port_forced_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_switch
c_cond
(paren
id|erp_action-&gt;step
)paren
(brace
multiline_comment|/*&n;&t;&t; * FIXME:&n;&t;&t; * the ULP spec. begs for waiting for oustanding commands&n;&t;&t; */
r_case
id|ZFCP_ERP_STEP_UNINITIALIZED
suffix:colon
id|zfcp_erp_port_strategy_clearstati
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * it would be sufficient to test only the normal open flag&n;&t;&t; * since the phys. open flag cannot be set if the normal&n;&t;&t; * open flag is unset - however, this is for readabilty ...&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
(paren
id|ZFCP_STATUS_PORT_PHYS_OPEN
op_or
id|ZFCP_STATUS_COMMON_OPEN
)paren
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;port 0x%016Lx is open -&gt; trying &quot;
l_string|&quot;close physical&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_forced_strategy_close
c_func
(paren
id|erp_action
)paren
suffix:semicolon
)brace
r_else
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_STEP_PHYS_PORT_CLOSING
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_PORT_PHYS_OPEN
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;close physical failed for port &quot;
l_string|&quot;0x%016Lx&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
r_else
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
r_break
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;p_pfst/ret&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|retval
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;this routine executes the &squot;Reopen Port&squot; action&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_SUCCEEDED&t;- action finished successfully&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy
id|zfcp_erp_port_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_switch
c_cond
(paren
id|erp_action-&gt;step
)paren
(brace
multiline_comment|/*&n;&t;&t; * FIXME:&n;&t;&t; * the ULP spec. begs for waiting for oustanding commands&n;&t;&t; */
r_case
id|ZFCP_ERP_STEP_UNINITIALIZED
suffix:colon
id|zfcp_erp_port_strategy_clearstati
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;port 0x%016Lx is open -&gt; trying &quot;
l_string|&quot;close&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_strategy_close
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* else it&squot;s already closed, open it */
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_STEP_PORT_CLOSING
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;close failed for port 0x%016Lx&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* else it&squot;s closed now, open it */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_CLOSE_ONLY
)paren
id|retval
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
r_else
id|retval
op_assign
id|zfcp_erp_port_strategy_open
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|out
suffix:colon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;p_pst/ret&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|retval
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy_open
id|zfcp_erp_port_strategy_open
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_PORT_WKA
comma
op_amp
id|erp_action-&gt;port-&gt;status
)paren
)paren
id|retval
op_assign
id|zfcp_erp_port_strategy_open_nameserver
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_else
id|retval
op_assign
id|zfcp_erp_port_strategy_open_common
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; *&n; * FIXME(design):&t;currently only prepared for fabric (nameserver!)&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy_open_common
id|zfcp_erp_port_strategy_open_common
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
r_switch
c_cond
(paren
id|erp_action-&gt;step
)paren
(brace
r_case
id|ZFCP_ERP_STEP_UNINITIALIZED
suffix:colon
r_case
id|ZFCP_ERP_STEP_PHYS_PORT_CLOSING
suffix:colon
r_case
id|ZFCP_ERP_STEP_PORT_CLOSING
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|adapter-&gt;nameserver_port
)paren
)paren
(brace
id|retval
op_assign
id|zfcp_nameserver_enqueue
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: nameserver port &quot;
l_string|&quot;unavailable for adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_UNBLOCKED
comma
op_amp
id|adapter-&gt;nameserver_port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;nameserver port is not open -&gt; open &quot;
l_string|&quot;nameserver port&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* nameserver port may live again */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|adapter-&gt;nameserver_port-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_erp_port_reopen
c_func
(paren
id|adapter-&gt;nameserver_port
comma
l_int|0
)paren
op_ge
l_int|0
)paren
(brace
id|erp_action-&gt;step
op_assign
id|ZFCP_ERP_STEP_NAMESERVER_OPEN
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_CONTINUES
suffix:semicolon
)brace
r_else
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* else nameserver port is already open, fall through */
r_case
id|ZFCP_ERP_STEP_NAMESERVER_OPEN
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|adapter-&gt;nameserver_port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;open failed for nameserver port&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;nameserver port is open -&gt; &quot;
l_string|&quot;nameserver look-up for port 0x%016Lx&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_strategy_open_common_lookup
(paren
id|erp_action
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_STEP_NAMESERVER_LOOKUP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_PORT_DID_DID
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
r_if
c_cond
(paren
id|atomic_test_mask
(paren
id|ZFCP_STATUS_PORT_INVALID_WWPN
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;nameserver look-up failed &quot;
l_string|&quot;for port 0x%016Lx &quot;
l_string|&quot;(misconfigured WWPN?)&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|zfcp_erp_port_failed
c_func
(paren
id|port
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;nameserver look-up failed for &quot;
l_string|&quot;port 0x%016Lx&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;port 0x%016Lx has d_id=0x%08x -&gt; &quot;
l_string|&quot;trying open&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|port-&gt;d_id
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_strategy_open_port
c_func
(paren
id|erp_action
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_STEP_PORT_OPENING
suffix:colon
multiline_comment|/* D_ID might have changed during open */
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
(paren
id|ZFCP_STATUS_COMMON_OPEN
op_or
id|ZFCP_STATUS_PORT_DID_DID
)paren
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;port 0x%016Lx is open&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;open failed for port 0x%016Lx&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: unknown erp step 0x%08x&bslash;n&quot;
comma
id|erp_action-&gt;step
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy_open_nameserver
id|zfcp_erp_port_strategy_open_nameserver
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
r_switch
c_cond
(paren
id|erp_action-&gt;step
)paren
(brace
r_case
id|ZFCP_ERP_STEP_UNINITIALIZED
suffix:colon
r_case
id|ZFCP_ERP_STEP_PHYS_PORT_CLOSING
suffix:colon
r_case
id|ZFCP_ERP_STEP_PORT_CLOSING
suffix:colon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;port 0x%016Lx has d_id=0x%08x -&gt; trying open&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|port-&gt;d_id
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_port_strategy_open_port
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_STEP_PORT_OPENING
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;WKA port is open&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;open failed for WKA port&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
multiline_comment|/* this is needed anyway (dont care for retval of wakeup) */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;continue other open port operations&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_strategy_open_nameserver_wakeup
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: unknown erp step 0x%08x&bslash;n&quot;
comma
id|erp_action-&gt;step
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;makes the erp thread continue with reopen (physical) port&n; *&t;&t;actions which have been paused until the name server port&n; *&t;&t;is opened (or failed)&n; *&n; * returns:&t;0&t;(a kind of void retval, its not used)&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy_open_nameserver_wakeup
id|zfcp_erp_port_strategy_open_nameserver_wakeup
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|ns_erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|ns_erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_erp_action
op_star
id|erp_action
comma
op_star
id|tmp
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|erp_action
comma
id|tmp
comma
op_amp
id|adapter-&gt;erp_running_head
comma
id|list
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;p_pstnsw_n&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|erp_action-&gt;port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp_action-&gt;step
op_eq
id|ZFCP_ERP_STEP_NAMESERVER_OPEN
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;p_pstnsw_w&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|erp_action-&gt;port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|adapter-&gt;nameserver_port-&gt;status
)paren
)paren
id|zfcp_erp_port_failed
c_func
(paren
id|erp_action-&gt;port
)paren
suffix:semicolon
id|zfcp_erp_action_ready
c_func
(paren
id|erp_action
)paren
suffix:semicolon
)brace
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;erp_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_port_forced_strategy_close
id|zfcp_erp_port_forced_strategy_close
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|zfcp_erp_timeout_init
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_close_physical_port
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;o_pfstc_nomem&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_NOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;step
op_assign
id|ZFCP_ERP_STEP_PHYS_PORT_CLOSING
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;o_pfstc_cpf&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
multiline_comment|/* could not send &squot;open&squot;, fail */
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;o_pfstc_cpok&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_CONTINUES
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy_clearstati
id|zfcp_erp_port_strategy_clearstati
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_pstclst&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
op_or
id|ZFCP_STATUS_COMMON_CLOSING
op_or
id|ZFCP_STATUS_PORT_DID_DID
op_or
id|ZFCP_STATUS_PORT_PHYS_CLOSING
op_or
id|ZFCP_STATUS_PORT_INVALID_WWPN
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy_close
id|zfcp_erp_port_strategy_close
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|zfcp_erp_timeout_init
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_close_port
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_pstc_nomem&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_NOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;step
op_assign
id|ZFCP_ERP_STEP_PORT_CLOSING
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_pstc_cpf&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
multiline_comment|/* could not send &squot;close&squot;, fail */
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;p_pstc_cpok&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_CONTINUES
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy_open_port
id|zfcp_erp_port_strategy_open_port
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|zfcp_erp_timeout_init
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_open_port
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_psto_nomem&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_NOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;step
op_assign
id|ZFCP_ERP_STEP_PORT_OPENING
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_psto_opf&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
multiline_comment|/* could not send &squot;open&squot;, fail */
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;p_psto_opok&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_CONTINUES
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_port_strategy_open_common_lookup
id|zfcp_erp_port_strategy_open_common_lookup
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|zfcp_erp_timeout_init
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_ns_gid_pn_request
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_pstn_nomem&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_NOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;step
op_assign
id|ZFCP_ERP_STEP_NAMESERVER_LOOKUP
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_pstn_ref&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
multiline_comment|/* could not send nameserver request, fail */
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;p_pstn_reok&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_CONTINUES
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;this routine executes the &squot;Reopen Unit&squot; action&n; *&t;&t;currently no retries&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_SUCCEEDED&t;- action finished successfully&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_unit_strategy
id|zfcp_erp_unit_strategy
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_switch
c_cond
(paren
id|erp_action-&gt;step
)paren
(brace
multiline_comment|/*&n;&t;&t; * FIXME:&n;&t;&t; * the ULP spec. begs for waiting for oustanding commands&n;&t;&t; */
r_case
id|ZFCP_ERP_STEP_UNINITIALIZED
suffix:colon
id|zfcp_erp_unit_strategy_clearstati
c_func
(paren
id|unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit 0x%016Lx is open -&gt; &quot;
l_string|&quot;trying close&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_unit_strategy_close
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* else it&squot;s already closed, fall through */
r_case
id|ZFCP_ERP_STEP_UNIT_CLOSING
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;close failed for unit 0x%016Lx&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_CLOSE_ONLY
)paren
id|retval
op_assign
id|ZFCP_ERP_EXIT
suffix:semicolon
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit 0x%016Lx is not open -&gt; &quot;
l_string|&quot;trying open&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_unit_strategy_open
c_func
(paren
id|erp_action
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_STEP_UNIT_OPENING
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit 0x%016Lx is open&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_SUCCEEDED
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;open failed for unit 0x%016Lx&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;u_ust/ret&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|retval
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_unit_strategy_clearstati
id|zfcp_erp_unit_strategy_clearstati
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|unit-&gt;port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_ustclst&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
op_or
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_unit_strategy_close
id|zfcp_erp_unit_strategy_close
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
id|zfcp_erp_timeout_init
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_close_unit
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_ustc_nomem&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_NOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;step
op_assign
id|ZFCP_ERP_STEP_UNIT_CLOSING
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_ustc_cuf&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
multiline_comment|/* could not send &squot;close&squot;, fail */
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;u_ustc_cuok&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_CONTINUES
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;ZFCP_ERP_CONTINUES&t;- action continues (asynchronously)&n; *&t;&t;ZFCP_ERP_FAILED&t;&t;- action finished unsuccessfully&n; */
r_static
r_int
DECL|function|zfcp_erp_unit_strategy_open
id|zfcp_erp_unit_strategy_open
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
id|zfcp_erp_timeout_init
c_func
(paren
id|erp_action
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_open_unit
c_func
(paren
id|erp_action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOMEM
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_usto_nomem&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_NOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;step
op_assign
id|ZFCP_ERP_STEP_UNIT_OPENING
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_usto_ouf&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
multiline_comment|/* could not send &squot;open&squot;, fail */
id|retval
op_assign
id|ZFCP_ERP_FAILED
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;u_usto_ouok&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|ZFCP_ERP_CONTINUES
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_inline
r_void
DECL|function|zfcp_erp_timeout_init
id|zfcp_erp_timeout_init
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
id|erp_action-&gt;timer.function
op_assign
id|zfcp_erp_timeout_handler
suffix:semicolon
id|erp_action-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|erp_action
suffix:semicolon
multiline_comment|/* jiffies will be added in zfcp_fsf_req_send */
id|erp_action-&gt;timer.expires
op_assign
id|ZFCP_ERP_FSFREQ_TIMEOUT
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;enqueue the specified error recovery action, if needed&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_action_enqueue
id|zfcp_erp_action_enqueue
c_func
(paren
r_int
id|action
comma
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_port
op_star
id|port
comma
r_struct
id|zfcp_unit
op_star
id|unit
)paren
(brace
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
r_struct
id|zfcp_erp_action
op_star
id|erp_action
op_assign
l_int|NULL
suffix:semicolon
r_int
id|stronger_action
op_assign
l_int|0
suffix:semicolon
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * We need some rules here which check whether we really need&n;&t; * this action or whether we should just drop it.&n;&t; * E.g. if there is a unfinished &squot;Reopen Port&squot; request then we drop a&n;&t; * &squot;Reopen Unit&squot; request for an associated unit since we can&squot;t&n;&t; * satisfy this request now. A &squot;Reopen Port&squot; action will trigger&n;&t; * &squot;Reopen Unit&squot; actions when it completes.&n;&t; * Thus, there are only actions in the queue which can immediately be&n;&t; * executed. This makes the processing of the action queue more&n;&t; * efficient.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_THREAD_UP
comma
op_amp
id|adapter-&gt;status
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
multiline_comment|/* check whether we really need this */
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|ZFCP_ERP_ACTION_REOPEN_UNIT
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;u_actenq_drp&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|port-&gt;status
)paren
op_logical_or
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_UNBLOCKED
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|stronger_action
op_assign
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:semicolon
id|unit
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* fall through !!! */
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;p_actenq_drp&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* fall through !!! */
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|port-&gt;status
)paren
op_logical_and
id|port-&gt;erp_action.action
op_eq
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;pf_actenq_drp&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|adapter-&gt;status
)paren
op_logical_or
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_UNBLOCKED
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|stronger_action
op_assign
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:semicolon
id|port
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* fall through !!! */
r_case
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:colon
r_if
c_cond
(paren
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;a_actenq_drp&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;a_actenq_bug&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
op_amp
id|action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: unknown erp action requested &quot;
l_string|&quot;on adapter %s (action=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|action
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* check whether we need something stronger first */
r_if
c_cond
(paren
id|stronger_action
)paren
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;a_actenq_str&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|stronger_action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;stronger erp action %d needed before &quot;
l_string|&quot;erp action %d on adapter %s&bslash;n&quot;
comma
id|stronger_action
comma
id|action
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|action
op_assign
id|stronger_action
suffix:semicolon
)brace
multiline_comment|/* mark adapter to have some error recovery pending */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_ERP_PENDING
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
multiline_comment|/* setup error recovery action */
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|ZFCP_ERP_ACTION_REOPEN_UNIT
suffix:colon
id|zfcp_unit_get
c_func
(paren
id|unit
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|erp_action
op_assign
op_amp
id|unit-&gt;erp_action
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|unit-&gt;status
)paren
)paren
id|status
op_assign
id|ZFCP_STATUS_ERP_CLOSE_ONLY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:colon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
suffix:colon
id|zfcp_port_get
c_func
(paren
id|port
)paren
suffix:semicolon
id|zfcp_erp_action_dismiss_port
c_func
(paren
id|port
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|erp_action
op_assign
op_amp
id|port-&gt;erp_action
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|port-&gt;status
)paren
)paren
id|status
op_assign
id|ZFCP_STATUS_ERP_CLOSE_ONLY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:colon
id|zfcp_adapter_get
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|zfcp_erp_action_dismiss_adapter
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|erp_action
op_assign
op_amp
id|adapter-&gt;erp_action
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|adapter-&gt;status
)paren
)paren
id|status
op_assign
id|ZFCP_STATUS_ERP_CLOSE_ONLY
suffix:semicolon
r_break
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;a_actenq&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|erp_action
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zfcp_erp_action
)paren
)paren
suffix:semicolon
id|erp_action-&gt;adapter
op_assign
id|adapter
suffix:semicolon
id|erp_action-&gt;port
op_assign
id|port
suffix:semicolon
id|erp_action-&gt;unit
op_assign
id|unit
suffix:semicolon
id|erp_action-&gt;action
op_assign
id|action
suffix:semicolon
id|erp_action-&gt;status
op_assign
id|status
suffix:semicolon
op_increment
id|adapter-&gt;erp_total_count
suffix:semicolon
multiline_comment|/* finally put it into &squot;ready&squot; queue and kick erp thread */
id|list_add
c_func
(paren
op_amp
id|erp_action-&gt;list
comma
op_amp
id|adapter-&gt;erp_ready_head
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|adapter-&gt;erp_ready_sem
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_erp_action_dequeue
id|zfcp_erp_action_dequeue
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
op_decrement
id|adapter-&gt;erp_total_count
suffix:semicolon
r_if
c_cond
(paren
id|erp_action-&gt;status
op_amp
id|ZFCP_STATUS_ERP_LOWMEM
)paren
(brace
op_decrement
id|adapter-&gt;erp_low_mem_count
suffix:semicolon
id|erp_action-&gt;status
op_and_assign
op_complement
id|ZFCP_STATUS_ERP_LOWMEM
suffix:semicolon
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;a_actdeq&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|erp_action-&gt;list
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|erp_action-&gt;action
)paren
(brace
r_case
id|ZFCP_ERP_ACTION_REOPEN_UNIT
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|erp_action-&gt;unit-&gt;status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
suffix:colon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|erp_action-&gt;port-&gt;status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|erp_action-&gt;adapter-&gt;status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* bug */
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_erp_action_cleanup&n; *&n; * Register unit with scsi stack if appropiate and fix reference counts.&n; * Note: Temporary units are not registered with scsi stack.&n; */
r_static
r_void
DECL|function|zfcp_erp_action_cleanup
id|zfcp_erp_action_cleanup
c_func
(paren
r_int
id|action
comma
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_port
op_star
id|port
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|result
)paren
(brace
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|ZFCP_ERP_ACTION_REOPEN_UNIT
suffix:colon
r_if
c_cond
(paren
(paren
id|result
op_eq
id|ZFCP_ERP_SUCCEEDED
)paren
op_logical_and
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_UNIT_TEMPORARY
comma
op_amp
id|unit-&gt;status
)paren
)paren
op_logical_and
(paren
op_logical_neg
id|unit-&gt;device
)paren
)paren
id|zfcp_erp_schedule_work
c_func
(paren
id|unit
)paren
suffix:semicolon
id|zfcp_unit_put
c_func
(paren
id|unit
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT_FORCED
suffix:colon
r_case
id|ZFCP_ERP_ACTION_REOPEN_PORT
suffix:colon
id|zfcp_port_put
c_func
(paren
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZFCP_ERP_ACTION_REOPEN_ADAPTER
suffix:colon
id|zfcp_adapter_put
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;FIXME&n; */
r_static
r_int
DECL|function|zfcp_erp_action_dismiss_adapter
id|zfcp_erp_action_dismiss_adapter
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;a_actab&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|adapter-&gt;status
)paren
)paren
id|zfcp_erp_action_dismiss
c_func
(paren
op_amp
id|adapter-&gt;erp_action
)paren
suffix:semicolon
r_else
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
id|zfcp_erp_action_dismiss_port
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;FIXME&n; */
r_static
r_int
DECL|function|zfcp_erp_action_dismiss_port
id|zfcp_erp_action_dismiss_port
c_func
(paren
r_struct
id|zfcp_port
op_star
id|port
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;p_actab&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|port-&gt;wwpn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|port-&gt;status
)paren
)paren
id|zfcp_erp_action_dismiss
c_func
(paren
op_amp
id|port-&gt;erp_action
)paren
suffix:semicolon
r_else
id|list_for_each_entry
c_func
(paren
id|unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
id|zfcp_erp_action_dismiss_unit
c_func
(paren
id|unit
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&t;FIXME&n; */
r_static
r_int
DECL|function|zfcp_erp_action_dismiss_unit
id|zfcp_erp_action_dismiss_unit
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|unit-&gt;port-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
l_string|&quot;u_actab&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|5
comma
op_amp
id|unit-&gt;fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_INUSE
comma
op_amp
id|unit-&gt;status
)paren
)paren
id|zfcp_erp_action_dismiss
c_func
(paren
op_amp
id|unit-&gt;erp_action
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;moves erp_action to &squot;erp running list&squot;&n; *&n; * returns:&n; */
r_static
r_inline
r_void
DECL|function|zfcp_erp_action_to_running
id|zfcp_erp_action_to_running
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_toru&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|list_move
c_func
(paren
op_amp
id|erp_action-&gt;list
comma
op_amp
id|erp_action-&gt;adapter-&gt;erp_running_head
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;moves erp_action to &squot;erp ready list&squot;&n; *&n; * returns:&n; */
r_static
r_inline
r_void
DECL|function|zfcp_erp_action_to_ready
id|zfcp_erp_action_to_ready
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|erp_action-&gt;adapter
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
l_string|&quot;a_tore&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|6
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|list_move
c_func
(paren
op_amp
id|erp_action-&gt;list
comma
op_amp
id|erp_action-&gt;adapter-&gt;erp_ready_head
)paren
suffix:semicolon
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
eof
