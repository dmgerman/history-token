multiline_comment|/*&n; * linux/drivers/s390/scsi/zfcp_ccw.c&n; *&n; * FCP adapter driver for IBM eServer zSeries&n; *&n; * CCW driver related routines&n; *&n; * (C) Copyright IBM Corp. 2003, 2004&n; *&n; * Authors:&n; *      Martin Peschke &lt;mpeschke@de.ibm.com&gt;&n; *&t;Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;&n; *      Andreas Herrmann &lt;aherrman@de.ibm.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
DECL|macro|ZFCP_CCW_C_REVISION
mdefine_line|#define ZFCP_CCW_C_REVISION &quot;$Revision: 1.58 $&quot;
macro_line|#include &quot;zfcp_ext.h&quot;
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA                   ZFCP_LOG_AREA_CONFIG
r_static
r_int
id|zfcp_ccw_probe
c_func
(paren
r_struct
id|ccw_device
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_ccw_remove
c_func
(paren
r_struct
id|ccw_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_ccw_set_online
c_func
(paren
r_struct
id|ccw_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_ccw_set_offline
c_func
(paren
r_struct
id|ccw_device
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_ccw_notify
c_func
(paren
r_struct
id|ccw_device
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|zfcp_ccw_shutdown
c_func
(paren
r_struct
id|device
op_star
)paren
suffix:semicolon
DECL|variable|zfcp_ccw_device_id
r_static
r_struct
id|ccw_device_id
id|zfcp_ccw_device_id
(braket
)braket
op_assign
(brace
(brace
id|CCW_DEVICE_DEVTYPE
c_func
(paren
id|ZFCP_CONTROL_UNIT_TYPE
comma
id|ZFCP_CONTROL_UNIT_MODEL
comma
id|ZFCP_DEVICE_TYPE
comma
id|ZFCP_DEVICE_MODEL
)paren
)brace
comma
(brace
id|CCW_DEVICE_DEVTYPE
c_func
(paren
id|ZFCP_CONTROL_UNIT_TYPE
comma
id|ZFCP_CONTROL_UNIT_MODEL
comma
id|ZFCP_DEVICE_TYPE
comma
id|ZFCP_DEVICE_MODEL_PRIV
)paren
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|variable|zfcp_ccw_driver
r_static
r_struct
id|ccw_driver
id|zfcp_ccw_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|ZFCP_NAME
comma
dot
id|ids
op_assign
id|zfcp_ccw_device_id
comma
dot
id|probe
op_assign
id|zfcp_ccw_probe
comma
dot
id|remove
op_assign
id|zfcp_ccw_remove
comma
dot
id|set_online
op_assign
id|zfcp_ccw_set_online
comma
dot
id|set_offline
op_assign
id|zfcp_ccw_set_offline
comma
dot
id|notify
op_assign
id|zfcp_ccw_notify
comma
dot
id|driver
op_assign
(brace
dot
id|shutdown
op_assign
id|zfcp_ccw_shutdown
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|ccw
comma
id|zfcp_ccw_device_id
)paren
suffix:semicolon
multiline_comment|/**&n; * zfcp_ccw_probe - probe function of zfcp driver&n; * @ccw_device: pointer to belonging ccw device&n; *&n; * This function gets called by the common i/o layer and sets up the initial&n; * data structures for each fcp adapter, which was detected by the system.&n; * Also the sysfs files for this adapter will be created by this function.&n; * In addition the nameserver port will be added to the ports of the adapter&n; * and its sysfs representation will be created too.&n; */
r_static
r_int
DECL|function|zfcp_ccw_probe
id|zfcp_ccw_probe
c_func
(paren
r_struct
id|ccw_device
op_star
id|ccw_device
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|zfcp_adapter_enqueue
c_func
(paren
id|ccw_device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter
)paren
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Probed adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ccw_remove - remove function of zfcp driver&n; * @ccw_device: pointer to belonging ccw device&n; *&n; * This function gets called by the common i/o layer and removes an adapter&n; * from the system. Task of this function is to get rid of all units and&n; * ports that belong to this adapter. And in addition all resources of this&n; * adapter will be freed too.&n; */
r_static
r_void
DECL|function|zfcp_ccw_remove
id|zfcp_ccw_remove
c_func
(paren
r_struct
id|ccw_device
op_star
id|ccw_device
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
comma
op_star
id|p
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
comma
op_star
id|u
suffix:semicolon
id|ccw_device_set_offline
c_func
(paren
id|ccw_device
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
op_amp
id|ccw_device-&gt;dev
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Removing adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|port
comma
id|p
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
id|list_for_each_entry_safe
c_func
(paren
id|unit
comma
id|u
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
(brace
id|list_move
c_func
(paren
op_amp
id|unit-&gt;list
comma
op_amp
id|port-&gt;unit_remove_lh
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
)brace
id|list_move
c_func
(paren
op_amp
id|port-&gt;list
comma
op_amp
id|adapter-&gt;port_remove_lh
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
)brace
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_REMOVE
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|port
comma
id|p
comma
op_amp
id|adapter-&gt;port_remove_lh
comma
id|list
)paren
(brace
id|list_for_each_entry_safe
c_func
(paren
id|unit
comma
id|u
comma
op_amp
id|port-&gt;unit_remove_lh
comma
id|list
)paren
(brace
id|zfcp_unit_dequeue
c_func
(paren
id|unit
)paren
suffix:semicolon
)brace
id|zfcp_port_dequeue
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
id|zfcp_adapter_wait
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|zfcp_adapter_dequeue
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ccw_set_online - set_online function of zfcp driver&n; * @ccw_device: pointer to belonging ccw device&n; *&n; * This function gets called by the common i/o layer and sets an adapter&n; * into state online. Setting an fcp device online means that it will be&n; * registered with the SCSI stack, that the QDIO queues will be set up&n; * and that the adapter will be opened (asynchronously).&n; */
r_static
r_int
DECL|function|zfcp_ccw_set_online
id|zfcp_ccw_set_online
c_func
(paren
r_struct
id|ccw_device
op_star
id|ccw_device
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
op_amp
id|ccw_device-&gt;dev
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_adapter_debug_register
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
id|zfcp_erp_thread_setup
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: start of error recovery thread for &quot;
l_string|&quot;adapter %s failed&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|out_erp_thread
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_adapter_scsi_register
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out_scsi_register
suffix:semicolon
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|out_scsi_register
suffix:colon
id|zfcp_erp_thread_kill
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|out_erp_thread
suffix:colon
id|zfcp_adapter_debug_unregister
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ccw_set_offline - set_offline function of zfcp driver&n; * @ccw_device: pointer to belonging ccw device&n; *&n; * This function gets called by the common i/o layer and sets an adapter&n; * into state offline. Setting an fcp device offline means that it will be&n; * unregistered from the SCSI stack and that the adapter will be shut down&n; * asynchronously.&n; */
r_static
r_int
DECL|function|zfcp_ccw_set_offline
id|zfcp_ccw_set_offline
c_func
(paren
r_struct
id|ccw_device
op_star
id|ccw_device
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
op_amp
id|ccw_device-&gt;dev
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|zfcp_adapter_scsi_unregister
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|zfcp_erp_thread_kill
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|zfcp_adapter_debug_unregister
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ccw_notify&n; * @ccw_device: pointer to belonging ccw device&n; * @event: indicates if adapter was detached or attached&n; *&n; * This function gets called by the common i/o layer if an adapter has gone&n; * or reappeared.&n; */
r_static
r_int
DECL|function|zfcp_ccw_notify
id|zfcp_ccw_notify
c_func
(paren
r_struct
id|ccw_device
op_star
id|ccw_device
comma
r_int
id|event
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
op_amp
id|ccw_device-&gt;dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CIO_GONE
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;adapter %s: device gone&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;dev_gone&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CIO_NO_PATH
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;adapter %s: no path&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;no_path&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CIO_OPER
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;adapter %s: operational again&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;dev_oper&quot;
)paren
suffix:semicolon
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|zfcp_erp_wait
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ccw_register - ccw register function&n; *&n; * Registers the driver at the common i/o layer. This function will be called&n; * at module load time/system start.&n; */
r_int
id|__init
DECL|function|zfcp_ccw_register
id|zfcp_ccw_register
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|ccw_driver_register
c_func
(paren
op_amp
id|zfcp_ccw_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
id|retval
op_assign
id|zfcp_sysfs_driver_create_files
c_func
(paren
op_amp
id|zfcp_ccw_driver.driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|ccw_driver_unregister
c_func
(paren
op_amp
id|zfcp_ccw_driver
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ccw_unregister - ccw unregister function&n; *&n; * Unregisters the driver from common i/o layer. Function will be called at&n; * module unload/system shutdown.&n; */
r_void
id|__exit
DECL|function|zfcp_ccw_unregister
id|zfcp_ccw_unregister
c_func
(paren
r_void
)paren
(brace
id|zfcp_sysfs_driver_remove_files
c_func
(paren
op_amp
id|zfcp_ccw_driver.driver
)paren
suffix:semicolon
id|ccw_driver_unregister
c_func
(paren
op_amp
id|zfcp_ccw_driver
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_ccw_shutdown - gets called on reboot/shutdown&n; *&n; * Makes sure that QDIO queues are down when the system gets stopped.&n; */
r_static
r_void
DECL|function|zfcp_ccw_shutdown
id|zfcp_ccw_shutdown
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
id|adapter
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zfcp_data.config_sema
)paren
suffix:semicolon
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
eof
