multiline_comment|/* &n; * &n; * linux/drivers/s390/scsi/zfcp_scsi.c&n; * &n; * FCP adapter driver for IBM eServer zSeries &n; * &n; * Copyright 2002 IBM Corporation &n; * Author(s): Martin Peschke &lt;mpeschke@de.ibm.com&gt; &n; *            Raimund Schroeder &lt;raimund.schroeder@de.ibm.com&gt; &n; *            Aron Zeh &lt;arzeh@de.ibm.com&gt; &n; *            Wolfgang Taphorn &lt;taphorn@de.ibm.com&gt; &n; *            Stefan Bader &lt;stefan.bader@de.ibm.com&gt; &n; *            Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt; &n; * &n; * This program is free software; you can redistribute it and/or modify &n; * it under the terms of the GNU General Public License as published by &n; * the Free Software Foundation; either version 2, or (at your option) &n; * any later version. &n; * &n; * This program is distributed in the hope that it will be useful, &n; * but WITHOUT ANY WARRANTY; without even the implied warranty of &n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the &n; * GNU General Public License for more details. &n; * &n; * You should have received a copy of the GNU General Public License &n; * along with this program; if not, write to the Free Software &n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; */
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA&t;&t;&t;ZFCP_LOG_AREA_SCSI
DECL|macro|ZFCP_LOG_AREA_PREFIX
mdefine_line|#define ZFCP_LOG_AREA_PREFIX&t;&t;ZFCP_LOG_AREA_PREFIX_SCSI
multiline_comment|/* this drivers version (do not edit !!! generated and updated by cvs) */
DECL|macro|ZFCP_SCSI_REVISION
mdefine_line|#define ZFCP_SCSI_REVISION &quot;$Revision: 1.42 $&quot;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &quot;zfcp_ext.h&quot;
r_static
r_void
id|zfcp_scsi_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_eh_abort_handler
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_eh_device_reset_handler
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_eh_bus_reset_handler
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_eh_host_reset_handler
c_func
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_task_management_function
c_func
(paren
r_struct
id|zfcp_unit
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
r_int
id|zfcp_create_sbales_from_segment
c_func
(paren
r_int
r_int
comma
r_int
comma
r_int
op_star
comma
r_int
comma
r_int
comma
r_int
op_star
comma
r_int
op_star
comma
r_int
comma
r_int
comma
r_struct
id|qdio_buffer
op_star
op_star
comma
r_char
)paren
suffix:semicolon
r_static
r_int
id|zfcp_create_sbale
c_func
(paren
r_int
r_int
comma
r_int
comma
r_int
op_star
comma
r_int
comma
r_int
comma
r_int
op_star
comma
r_int
comma
r_int
comma
r_int
op_star
comma
r_struct
id|qdio_buffer
op_star
op_star
comma
r_char
)paren
suffix:semicolon
r_static
r_struct
id|zfcp_unit
op_star
id|zfcp_scsi_determine_unit
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_static
r_struct
id|zfcp_unit
op_star
id|zfcp_unit_lookup
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
r_int
comma
r_int
comma
r_int
)paren
suffix:semicolon
DECL|variable|zfcp_sysfs_sdev_attrs
r_static
r_struct
id|device_attribute
op_star
id|zfcp_sysfs_sdev_attrs
(braket
)braket
suffix:semicolon
DECL|variable|zfcp_data
r_struct
id|zfcp_data
id|zfcp_data
op_assign
(brace
dot
id|scsi_host_template
op_assign
(brace
id|name
suffix:colon
id|ZFCP_NAME
comma
id|proc_name
suffix:colon
l_string|&quot;dummy&quot;
comma
id|proc_info
suffix:colon
l_int|NULL
comma
id|detect
suffix:colon
l_int|NULL
comma
id|slave_alloc
suffix:colon
id|zfcp_scsi_slave_alloc
comma
id|slave_configure
suffix:colon
id|zfcp_scsi_slave_configure
comma
id|slave_destroy
suffix:colon
id|zfcp_scsi_slave_destroy
comma
id|queuecommand
suffix:colon
id|zfcp_scsi_queuecommand
comma
id|eh_abort_handler
suffix:colon
id|zfcp_scsi_eh_abort_handler
comma
id|eh_device_reset_handler
suffix:colon
id|zfcp_scsi_eh_device_reset_handler
comma
id|eh_bus_reset_handler
suffix:colon
id|zfcp_scsi_eh_bus_reset_handler
comma
id|eh_host_reset_handler
suffix:colon
id|zfcp_scsi_eh_host_reset_handler
comma
multiline_comment|/* FIXME(openfcp): Tune */
id|can_queue
suffix:colon
l_int|4096
comma
id|this_id
suffix:colon
l_int|0
comma
multiline_comment|/*&n;&t;       * FIXME:&n;&t;       * one less? can zfcp_create_sbale cope with it?&n;&t;       */
id|sg_tablesize
suffix:colon
id|ZFCP_MAX_SBALES_PER_REQ
comma
id|cmd_per_lun
suffix:colon
l_int|1
comma
id|unchecked_isa_dma
suffix:colon
l_int|0
comma
id|use_clustering
suffix:colon
l_int|1
comma
id|sdev_attrs
suffix:colon
id|zfcp_sysfs_sdev_attrs
comma
)brace
multiline_comment|/* rest initialised with zeros */
)brace
suffix:semicolon
multiline_comment|/* Find start of Response Information in FCP response unit*/
r_char
op_star
DECL|function|zfcp_get_fcp_rsp_info_ptr
id|zfcp_get_fcp_rsp_info_ptr
c_func
(paren
r_struct
id|fcp_rsp_iu
op_star
id|fcp_rsp_iu
)paren
(brace
r_char
op_star
id|fcp_rsp_info_ptr
suffix:semicolon
id|fcp_rsp_info_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|fcp_rsp_iu
op_plus
(paren
r_sizeof
(paren
r_struct
id|fcp_rsp_iu
)paren
)paren
suffix:semicolon
r_return
id|fcp_rsp_info_ptr
suffix:semicolon
)brace
multiline_comment|/* Find start of Sense Information in FCP response unit*/
r_char
op_star
DECL|function|zfcp_get_fcp_sns_info_ptr
id|zfcp_get_fcp_sns_info_ptr
c_func
(paren
r_struct
id|fcp_rsp_iu
op_star
id|fcp_rsp_iu
)paren
(brace
r_char
op_star
id|fcp_sns_info_ptr
suffix:semicolon
id|fcp_sns_info_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|fcp_rsp_iu
op_plus
(paren
r_sizeof
(paren
r_struct
id|fcp_rsp_iu
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_rsp_len_valid
)paren
id|fcp_sns_info_ptr
op_assign
(paren
r_char
op_star
)paren
id|fcp_sns_info_ptr
op_plus
id|fcp_rsp_iu-&gt;fcp_rsp_len
suffix:semicolon
r_return
id|fcp_sns_info_ptr
suffix:semicolon
)brace
id|fcp_dl_t
op_star
DECL|function|zfcp_get_fcp_dl_ptr
id|zfcp_get_fcp_dl_ptr
c_func
(paren
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmd
)paren
(brace
r_int
id|additional_length
op_assign
id|fcp_cmd-&gt;add_fcp_cdb_length
op_lshift
l_int|2
suffix:semicolon
id|fcp_dl_t
op_star
id|fcp_dl_addr
suffix:semicolon
id|fcp_dl_addr
op_assign
(paren
id|fcp_dl_t
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|fcp_cmd
op_plus
r_sizeof
(paren
r_struct
id|fcp_cmnd_iu
)paren
op_plus
id|additional_length
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * fcp_dl_addr = start address of fcp_cmnd structure + &n;&t; * size of fixed part + size of dynamically sized add_dcp_cdb field&n;&t; * SEE FCP-2 documentation&n;&t; */
r_return
id|fcp_dl_addr
suffix:semicolon
)brace
id|fcp_dl_t
DECL|function|zfcp_get_fcp_dl
id|zfcp_get_fcp_dl
c_func
(paren
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmd
)paren
(brace
r_return
op_star
id|zfcp_get_fcp_dl_ptr
c_func
(paren
id|fcp_cmd
)paren
suffix:semicolon
)brace
r_void
DECL|function|zfcp_set_fcp_dl
id|zfcp_set_fcp_dl
c_func
(paren
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmd
comma
id|fcp_dl_t
id|fcp_dl
)paren
(brace
op_star
id|zfcp_get_fcp_dl_ptr
c_func
(paren
id|fcp_cmd
)paren
op_assign
id|fcp_dl
suffix:semicolon
)brace
multiline_comment|/*&n; * note: it&squot;s a bit-or operation not an assignment&n; * regarding the specified byte&n; */
r_static
r_inline
r_void
DECL|function|set_byte
id|set_byte
c_func
(paren
id|u32
op_star
id|result
comma
r_char
id|status
comma
r_char
id|pos
)paren
(brace
op_star
id|result
op_or_assign
id|status
op_lshift
(paren
id|pos
op_star
l_int|8
)paren
suffix:semicolon
)brace
r_void
DECL|function|set_host_byte
id|set_host_byte
c_func
(paren
id|u32
op_star
id|result
comma
r_char
id|status
)paren
(brace
id|set_byte
c_func
(paren
id|result
comma
id|status
comma
l_int|2
)paren
suffix:semicolon
)brace
r_void
DECL|function|set_driver_byte
id|set_driver_byte
c_func
(paren
id|u32
op_star
id|result
comma
r_char
id|status
)paren
(brace
id|set_byte
c_func
(paren
id|result
comma
id|status
comma
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_slave_alloc&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_scsi_slave_alloc
id|zfcp_scsi_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|sdp-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter
)paren
r_goto
id|out
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|unit
op_assign
id|zfcp_unit_lookup
c_func
(paren
id|adapter
comma
id|sdp-&gt;channel
comma
id|sdp-&gt;id
comma
id|sdp-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unit
)paren
(brace
id|sdp-&gt;hostdata
op_assign
id|unit
suffix:semicolon
id|unit-&gt;device
op_assign
id|sdp
suffix:semicolon
id|zfcp_unit_get
c_func
(paren
id|unit
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_slave_destroy&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_scsi_slave_destroy
id|zfcp_scsi_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdpnt
)paren
(brace
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|sdpnt-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|unit
)paren
(brace
id|sdpnt-&gt;hostdata
op_assign
l_int|NULL
suffix:semicolon
id|unit-&gt;device
op_assign
l_int|NULL
suffix:semicolon
id|zfcp_unit_put
c_func
(paren
id|unit
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;no unit associated with SCSI device at &quot;
l_string|&quot;address 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|sdpnt
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|zfcp_scsi_block_requests
id|zfcp_scsi_block_requests
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shpnt
)paren
(brace
id|scsi_block_requests
c_func
(paren
id|shpnt
)paren
suffix:semicolon
multiline_comment|/* This is still somewhat racy but the best I could imagine */
r_do
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|ZFCP_SCSI_HOST_FLUSH_TIMEOUT
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|shpnt-&gt;host_busy
op_logical_or
id|shpnt-&gt;eh_active
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Tries to associate a zfcp unit with the scsi device.&n; *&n; * returns:       unit pointer   if unit is found&n; *                NULL           otherwise&n; */
r_struct
id|zfcp_unit
op_star
DECL|function|zfcp_scsi_determine_unit
id|zfcp_scsi_determine_unit
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
id|Scsi_Cmnd
op_star
id|scpnt
)paren
(brace
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
multiline_comment|/*&n;&t; * figure out target device&n;&t; * (stored there by zfcp_scsi_slave_alloc)&n;&t; * ATTENTION: assumes hostdata initialized to NULL by&n;&t; * mid layer (see scsi_scan.c)&n;&t; */
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unit
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;logical unit (%i %i %i %i) not configured&bslash;n&quot;
comma
id|scpnt-&gt;device-&gt;host-&gt;host_no
comma
id|scpnt-&gt;device-&gt;channel
comma
id|scpnt-&gt;device-&gt;id
comma
id|scpnt-&gt;device-&gt;lun
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * must fake SCSI command execution and scsi_done&n;&t;&t; * callback for non-configured logical unit&n;&t;&t; */
multiline_comment|/* return this as long as we are unable to process requests */
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_NO_CONNECT
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_scsi
c_func
(paren
l_string|&quot;notconf&quot;
comma
id|scpnt
)paren
suffix:semicolon
id|scpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scpnt
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|2
comma
l_string|&quot;nc_done:&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|2
comma
op_amp
id|scpnt
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
)brace
r_return
id|unit
suffix:semicolon
)brace
multiline_comment|/*&n; * called from scsi midlayer to allow finetuning of a device.&n; */
r_static
r_int
DECL|function|zfcp_scsi_slave_configure
id|zfcp_scsi_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
(brace
r_if
c_cond
(paren
id|sdp-&gt;tagged_supported
)paren
id|scsi_adjust_queue_depth
c_func
(paren
id|sdp
comma
id|MSG_SIMPLE_TAG
comma
id|ZFCP_CMND_PER_LUN
)paren
suffix:semicolon
r_else
id|scsi_adjust_queue_depth
c_func
(paren
id|sdp
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Complete a command immediately handing back DID_ERROR */
r_static
r_void
DECL|function|zfcp_scsi_queuecommand_stop
id|zfcp_scsi_queuecommand_stop
c_func
(paren
id|Scsi_Cmnd
op_star
id|scpnt
comma
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_unit
op_star
id|unit
)paren
(brace
multiline_comment|/* Always pass through to upper layer */
id|scpnt-&gt;retries
op_assign
id|scpnt-&gt;allowed
op_minus
l_int|1
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_scsi
c_func
(paren
l_string|&quot;stopping&quot;
comma
id|scpnt
)paren
suffix:semicolon
multiline_comment|/* return directly */
id|scpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter
op_logical_and
id|unit
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Stopping SCSI IO on the unit with FCP LUN 0x%Lx &quot;
l_string|&quot;connected to the port with WWPN 0x%Lx at the &quot;
l_string|&quot;adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|2
comma
l_string|&quot;de_done:&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|2
comma
op_amp
id|scpnt
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
)brace
r_else
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;There is no adapter registered in the zfcp &quot;
l_string|&quot;module for the SCSI host with hostnumber %d. &quot;
l_string|&quot;Stopping IO.&bslash;n&quot;
comma
id|scpnt-&gt;device-&gt;host-&gt;host_no
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_queuecommand&n; *&n; * purpose:&t;enqueues a SCSI command to the specified target device&n; *&n; * note:        The scsi_done midlayer function may be called directly from&n; *              within queuecommand provided queuecommand returns with&n; *              success (0).&n; *              If it fails, it is expected that the command could not be sent&n; *              and is still available for processing.&n; *              As we ensure that queuecommand never fails, we have the choice &n; *              to call done directly wherever we please.&n; *              Thus, any kind of send errors other than those indicating&n; *              &squot;infinite&squot; retries will be reported directly.&n; *              Retry requests are put into a list to be processed under timer &n; *              control once in a while to allow for other operations to&n; *              complete in the meantime.&n; *&n; * returns:&t;0 - success, SCSI command enqueued&n; *&t;&t;!0 - failure, note that we never allow this to happen as the &n; *              SCSI stack would block indefinitely should a non-zero return&n; *              value be reported if there are no outstanding commands&n; *              (as in when the queues are down)&n; */
r_int
DECL|function|zfcp_scsi_queuecommand
id|zfcp_scsi_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|scpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
id|temp_ret
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset the status for this request */
id|scpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* save address of mid layer call back function */
id|scpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/*&n;&t; * figure out adapter&n;&t; * (previously stored there by the driver when&n;&t; * the adapter was registered)&n;&t; */
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|scpnt-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* NULL when the adapter was removed from the zfcp list */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|adapter
op_eq
l_int|NULL
)paren
)paren
(brace
id|zfcp_scsi_queuecommand_stop
c_func
(paren
id|scpnt
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|unit
op_assign
id|zfcp_scsi_determine_unit
c_func
(paren
id|adapter
comma
id|scpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|unit
op_eq
l_int|NULL
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|unit-&gt;status
)paren
op_logical_or
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|unit-&gt;status
)paren
)paren
)paren
(brace
id|zfcp_scsi_queuecommand_stop
c_func
(paren
id|scpnt
comma
id|adapter
comma
id|unit
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_UNBLOCKED
comma
op_amp
id|unit-&gt;status
)paren
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;adapter %s not ready or unit with LUN 0x%Lx &quot;
l_string|&quot;on the port with WWPN 0x%Lx in recovery.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|SCSI_MLQUEUE_DEVICE_BUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|temp_ret
op_assign
id|zfcp_fsf_send_fcp_command_task
c_func
(paren
id|adapter
comma
id|unit
comma
id|scpnt
comma
id|ZFCP_REQ_AUTO_CLEANUP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|temp_ret
OL
l_int|0
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Could not send a Send FCP Command&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|3
comma
l_string|&quot;q_scpnt&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|3
comma
op_amp
id|scpnt
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_unit_lookup&n; *&n; * purpose:&n; *&n; * returns:&n; *&n; * context:&t;&n; */
r_static
r_struct
id|zfcp_unit
op_star
DECL|function|zfcp_unit_lookup
id|zfcp_unit_lookup
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|channel
comma
r_int
id|id
comma
r_int
id|lun
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
comma
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|id
op_ne
id|port-&gt;scsi_id
)paren
r_continue
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|lun
op_eq
id|unit-&gt;scsi_lun
)paren
(brace
id|retval
op_assign
id|unit
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_eh_abort_handler&n; *&n; * purpose:&t;tries to abort the specified (timed out) SCSI command&n; *&n; * note: &t;We do not need to care for a SCSI command which completes&n; *&t;&t;normally but late during this abort routine runs.&n; *&t;&t;We are allowed to return late commands to the SCSI stack.&n; *&t;&t;It tracks the state of commands and will handle late commands.&n; *&t;&t;(Usually, the normal completion of late commands is ignored with&n; *&t;&t;respect to the running abort operation. Grep for &squot;done_late&squot;&n; *&t;&t;in the SCSI stacks sources.)&n; *&n; * returns:&t;SUCCESS&t;- command has been aborted and cleaned up in internal&n; *&t;&t;&t;  bookkeeping,&n; *&t;&t;&t;  SCSI stack won&squot;t be called for aborted command&n; *&t;&t;FAILED&t;- otherwise&n; */
r_int
DECL|function|zfcp_scsi_eh_abort_handler
id|zfcp_scsi_eh_abort_handler
c_func
(paren
id|Scsi_Cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|retval
op_assign
id|SUCCESS
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|new_fsf_req
comma
op_star
id|old_fsf_req
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
suffix:semicolon
r_union
id|zfcp_req_data
op_star
id|req_data
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|scpnt-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|scsi_host
op_assign
id|scpnt-&gt;device-&gt;host
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
id|port
op_assign
id|unit-&gt;port
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_ABORTS
multiline_comment|/* the components of a abort_dbf record (fixed size record) */
id|u64
id|dbf_scsi_cmnd
op_assign
(paren
r_int
r_int
)paren
id|scpnt
suffix:semicolon
r_char
id|dbf_opcode
(braket
id|ZFCP_ABORT_DBF_LENGTH
)braket
suffix:semicolon
id|wwn_t
id|dbf_wwn
op_assign
id|port-&gt;wwpn
suffix:semicolon
id|fcp_lun_t
id|dbf_fcp_lun
op_assign
id|unit-&gt;fcp_lun
suffix:semicolon
id|u64
id|dbf_retries
op_assign
id|scpnt-&gt;retries
suffix:semicolon
id|u64
id|dbf_allowed
op_assign
id|scpnt-&gt;allowed
suffix:semicolon
id|u64
id|dbf_timeout
op_assign
l_int|0
suffix:semicolon
id|u64
id|dbf_fsf_req
op_assign
l_int|0
suffix:semicolon
id|u64
id|dbf_fsf_status
op_assign
l_int|0
suffix:semicolon
id|u64
id|dbf_fsf_qual
(braket
l_int|2
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_char
id|dbf_result
(braket
id|ZFCP_ABORT_DBF_LENGTH
)braket
op_assign
(brace
l_string|&quot;##undef&quot;
)brace
suffix:semicolon
id|memset
c_func
(paren
id|dbf_opcode
comma
l_int|0
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dbf_opcode
comma
id|scpnt-&gt;cmnd
comma
id|min
c_func
(paren
id|scpnt-&gt;cmd_len
comma
(paren
r_int
r_char
)paren
id|ZFCP_ABORT_DBF_LENGTH
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*TRACE*/
id|ZFCP_LOG_INFO
(paren
l_string|&quot;Aborting for adapter=0x%lx, busid=%s, scsi_cmnd=0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|adapter
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
(paren
r_int
r_int
)paren
id|scpnt
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Race condition between normal (late) completion and abort has&n;&t; * to be avoided.&n;&t; * The entirity of all accesses to scsi_req have to be atomic.&n;&t; * scsi_req is usually part of the fsf_req and thus we block the&n;&t; * release of fsf_req as long as we need to access scsi_req.&n;&t; */
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check whether command has just completed and can not be aborted.&n;&t; * Even if the command has just been completed late, we can access&n;&t; * scpnt since the SCSI stack does not release it at least until&n;&t; * this routine returns. (scpnt is parameter passed to this routine&n;&t; * and must not disappear during abort even on late completion.)&n;&t; */
id|req_data
op_assign
(paren
r_union
id|zfcp_req_data
op_star
)paren
id|scpnt-&gt;host_scribble
suffix:semicolon
multiline_comment|/* DEBUG */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;req_data=0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|req_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req_data
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;late command completion overtook abort&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * That&squot;s it.&n;&t;&t; * Do not initiate abort but return SUCCESS.&n;&t;&t; */
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##late1&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Figure out which fsf_req needs to be aborted. */
id|old_fsf_req
op_assign
id|req_data-&gt;send_fcp_command_task.fsf_req
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_ABORTS
id|dbf_fsf_req
op_assign
(paren
r_int
r_int
)paren
id|old_fsf_req
suffix:semicolon
id|dbf_timeout
op_assign
(paren
id|jiffies
op_minus
id|req_data-&gt;send_fcp_command_task.start_jiffies
)paren
op_div
id|HZ
suffix:semicolon
macro_line|#endif
multiline_comment|/* DEBUG */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;old_fsf_req=0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|old_fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|old_fsf_req
)paren
(brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: No old fsf request found.&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;req_data:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|req_data
comma
r_sizeof
(paren
r_union
id|zfcp_req_data
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;scsi_cmnd:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|scpnt
comma
r_sizeof
(paren
r_struct
id|scsi_cmnd
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|FAILED
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##bug:r&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|old_fsf_req-&gt;data.send_fcp_command_task.scsi_cmnd
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* mark old request as being aborted */
id|old_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ABORTING
suffix:semicolon
multiline_comment|/*&n;&t; * We have to collect all information (e.g. unit) needed by &n;&t; * zfcp_fsf_abort_fcp_command before calling that routine&n;&t; * since that routine is not allowed to access&n;&t; * fsf_req which it is going to abort.&n;&t; * This is because of we need to release fsf_req_list_lock&n;&t; * before calling zfcp_fsf_abort_fcp_command.&n;&t; * Since this lock will not be held, fsf_req may complete&n;&t; * late and may be released meanwhile.&n;&t; */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit=0x%lx, unit_fcp_lun=0x%Lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|unit
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The &squot;Abort FCP Command&squot; routine may block (call schedule)&n;&t; * because it may wait for a free SBAL.&n;&t; * That&squot;s why we must release the lock and enable the&n;&t; * interrupts before.&n;&t; * On the other hand we do not need the lock anymore since&n;&t; * all critical accesses to scsi_req are done.&n;&t; */
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* call FSF routine which does the abort */
id|new_fsf_req
op_assign
id|zfcp_fsf_abort_fcp_command
c_func
(paren
(paren
r_int
r_int
)paren
id|old_fsf_req
comma
id|adapter
comma
id|unit
comma
id|ZFCP_WAIT_FOR_SBAL
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;new_fsf_req=0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|new_fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_fsf_req
)paren
(brace
id|retval
op_assign
id|FAILED
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;warning: Could not abort SCSI command &quot;
l_string|&quot;at 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|scpnt
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##nores&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* wait for completion of abort */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Waiting for cleanup....&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_ABORTS
multiline_comment|/*&n;&t; * FIXME:&n;&t; * copying zfcp_fsf_req_wait_and_cleanup code is not really nice&n;&t; */
id|__wait_event
c_func
(paren
id|new_fsf_req-&gt;completion_wq
comma
id|new_fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_COMPLETED
)paren
suffix:semicolon
id|status
op_assign
id|new_fsf_req-&gt;status
suffix:semicolon
id|dbf_fsf_status
op_assign
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status
suffix:semicolon
multiline_comment|/*&n;&t; * Ralphs special debug load provides timestamps in the FSF&n;&t; * status qualifier. This might be specified later if being&n;&t; * useful for debugging aborts.&n;&t; */
id|dbf_fsf_qual
(braket
l_int|0
)braket
op_assign
op_star
(paren
id|u64
op_star
)paren
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
suffix:semicolon
id|dbf_fsf_qual
(braket
l_int|1
)braket
op_assign
op_star
(paren
id|u64
op_star
)paren
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|2
)braket
suffix:semicolon
id|zfcp_fsf_req_cleanup
c_func
(paren
id|new_fsf_req
)paren
suffix:semicolon
macro_line|#else
id|retval
op_assign
id|zfcp_fsf_req_wait_and_cleanup
c_func
(paren
id|new_fsf_req
comma
id|ZFCP_UNINTERRUPTIBLE
comma
op_amp
id|status
)paren
suffix:semicolon
macro_line|#endif
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Waiting for cleanup complete, status=0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* status should be valid since signals were not permitted */
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_FSFREQ_ABORTSUCCEEDED
)paren
(brace
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##succ&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_FSFREQ_ABORTNOTNEEDED
)paren
(brace
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##late2&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
id|FAILED
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##fail&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
)brace
id|out
suffix:colon
macro_line|#ifdef ZFCP_DEBUG_ABORTS
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_scsi_cmnd
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_opcode
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_wwn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_retries
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_allowed
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_timeout
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fsf_req
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fsf_status
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fsf_qual
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fsf_qual
(braket
l_int|1
)braket
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
id|dbf_result
)paren
suffix:semicolon
macro_line|#endif
id|spin_lock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_eh_device_reset_handler&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_scsi_eh_device_reset_handler
id|zfcp_scsi_eh_device_reset_handler
c_func
(paren
id|Scsi_Cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|scpnt-&gt;device-&gt;host
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unit
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Tried to reset a non existant unit.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Resetting Device fcp_lun=0x%Lx&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we do not know whether the unit supports &squot;logical unit reset&squot;&n;&t; * then try &squot;logical unit reset&squot; and proceed with &squot;target reset&squot;&n;&t; * if &squot;logical unit reset&squot; fails.&n;&t; * If the unit is known not to support &squot;logical unit reset&squot; then&n;&t; * skip &squot;logical unit reset&squot; and try &squot;target reset&squot; immediately.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_UNIT_NOTSUPPUNITRESET
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|retval
op_assign
id|zfcp_task_management_function
c_func
(paren
id|unit
comma
id|LOGICAL_UNIT_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_DEBUG
(paren
l_string|&quot;logical unit reset failed (unit=0x%lx)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOTSUPP
)paren
id|atomic_set_mask
(paren
id|ZFCP_STATUS_UNIT_NOTSUPPUNITRESET
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
multiline_comment|/* fall through and try &squot;target reset&squot; next */
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
(paren
l_string|&quot;logical unit reset succeeded (unit=0x%lx)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|unit
)paren
suffix:semicolon
multiline_comment|/* avoid &squot;target reset&squot; */
id|retval
op_assign
id|SUCCESS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|retval
op_assign
id|zfcp_task_management_function
c_func
(paren
id|unit
comma
id|TARGET_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;target reset failed (unit=0x%lx)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|unit
)paren
suffix:semicolon
id|retval
op_assign
id|FAILED
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;target reset succeeded (unit=0x%lx)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|unit
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_lock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|zfcp_task_management_function
id|zfcp_task_management_function
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
id|u8
id|tm_flags
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|unit-&gt;port-&gt;adapter
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|status
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
multiline_comment|/* issue task management function */
id|fsf_req
op_assign
id|zfcp_fsf_send_fcp_command_task_management
(paren
id|adapter
comma
id|unit
comma
id|tm_flags
comma
id|ZFCP_WAIT_FOR_SBAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fsf_req
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create a &quot;
l_string|&quot;task management (abort, reset, etc) request &quot;
l_string|&quot;for the unit with FCP-LUN 0x%Lx connected to &quot;
l_string|&quot;the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_fsf_req_wait_and_cleanup
c_func
(paren
id|fsf_req
comma
id|ZFCP_UNINTERRUPTIBLE
comma
op_amp
id|status
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * check completion status of task management function&n;&t; * (status should always be valid since no signals permitted)&n;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_FSFREQ_TMFUNCFAILED
)paren
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_FSFREQ_TMFUNCNOTSUPP
)paren
id|retval
op_assign
op_minus
id|ENOTSUPP
suffix:semicolon
r_else
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_eh_bus_reset_handler&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_scsi_eh_bus_reset_handler
id|zfcp_scsi_eh_bus_reset_handler
c_func
(paren
id|Scsi_Cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|scpnt-&gt;device-&gt;host
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
multiline_comment|/*DEBUG*/
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Resetting because of problems with &quot;
l_string|&quot;unit=0x%lx, unit_fcp_lun=0x%Lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|unit
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|unit-&gt;port-&gt;adapter
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_eh_host_reset_handler&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_scsi_eh_host_reset_handler
id|zfcp_scsi_eh_host_reset_handler
c_func
(paren
id|Scsi_Cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|scpnt-&gt;device-&gt;host
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
multiline_comment|/*DEBUG*/
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Resetting because of problems with &quot;
l_string|&quot;unit=0x%lx, unit_fcp_lun=0x%Lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|unit
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|unit-&gt;port-&gt;adapter
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_adapter_scsi_register
id|zfcp_adapter_scsi_register
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_static
r_int
r_int
id|unique_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* register adapter as SCSI host with mid layer of SCSI stack */
id|adapter-&gt;scsi_host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|zfcp_data.scsi_host_template
comma
r_sizeof
(paren
r_struct
id|zfcp_adapter
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;scsi_host
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: Not enough free memory. &quot;
l_string|&quot;Could not register adapter %s &quot;
l_string|&quot;with the SCSI-stack.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;host registered, scsi_host at 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|adapter-&gt;scsi_host
)paren
suffix:semicolon
multiline_comment|/* tell the SCSI stack some characteristics of this adapter */
id|adapter-&gt;scsi_host-&gt;max_id
op_assign
id|adapter-&gt;max_scsi_id
op_plus
l_int|1
suffix:semicolon
id|adapter-&gt;scsi_host-&gt;max_lun
op_assign
id|adapter-&gt;max_scsi_lun
op_plus
l_int|1
suffix:semicolon
id|adapter-&gt;scsi_host-&gt;max_channel
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;scsi_host-&gt;unique_id
op_assign
id|unique_id
op_increment
suffix:semicolon
multiline_comment|/* FIXME */
id|adapter-&gt;scsi_host-&gt;max_cmd_len
op_assign
id|ZFCP_MAX_SCSI_CMND_LENGTH
suffix:semicolon
multiline_comment|/*&n;&t; * save a pointer to our own adapter data structure within&n;&t; * hostdata field of SCSI host data structure&n;&t; */
id|adapter-&gt;scsi_host-&gt;hostdata
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|adapter
suffix:semicolon
r_if
c_cond
(paren
id|scsi_add_host
c_func
(paren
id|adapter-&gt;scsi_host
comma
op_amp
id|adapter-&gt;ccw_device-&gt;dev
)paren
)paren
(brace
id|scsi_host_put
c_func
(paren
id|adapter-&gt;scsi_host
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_REGISTERED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_void
DECL|function|zfcp_adapter_scsi_unregister
id|zfcp_adapter_scsi_unregister
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
suffix:semicolon
id|shost
op_assign
id|adapter-&gt;scsi_host
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
r_return
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|shost
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|shost
)paren
suffix:semicolon
id|adapter-&gt;scsi_host
op_assign
l_int|NULL
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_REGISTERED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_create_sbales_from_segment - creates SBALEs&n; * @addr:          begin of this buffer segment&n; * @length_seg:&t;   length of this buffer segment&n; * @length_total:  total length of buffer&n; * @length_min:    roll back if generated buffer smaller than this&n; * @length_max:&t;   sum of all SBALEs (count) not larger than this&n; * @buffer_index:  position of current BUFFER&n; * @buffere_index: position of current BUFFERE&n; * @buffer_first:  first BUFFER used for this buffer&n; * @buffer_last:   last BUFFER in request queue allowed&n; * @buffer:        begin of SBAL array of request queue&n; * @sbtype:        storage-block type&n; */
r_static
r_int
DECL|function|zfcp_create_sbales_from_segment
id|zfcp_create_sbales_from_segment
c_func
(paren
r_int
r_int
id|addr
comma
r_int
id|length_seg
comma
r_int
op_star
id|length_total
comma
r_int
id|length_min
comma
r_int
id|length_max
comma
r_int
op_star
id|buffer_index
comma
r_int
op_star
id|buffere_index
comma
r_int
id|buffer_first
comma
r_int
id|buffer_last
comma
r_struct
id|qdio_buffer
op_star
id|buffer
(braket
)braket
comma
r_char
id|sbtype
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|length
op_assign
l_int|0
suffix:semicolon
id|ZFCP_LOG_TRACE
(paren
l_string|&quot;SCSI data buffer segment with %i bytes from 0x%lx to 0x%lx&bslash;n&quot;
comma
id|length_seg
comma
id|addr
comma
(paren
id|addr
op_plus
id|length_seg
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|length_seg
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
(brace
id|length
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
(paren
id|PAGE_SIZE
op_minus
(paren
id|addr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
)paren
comma
id|length_seg
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
(paren
l_string|&quot;address 0x%lx not on page boundary, length=0x%x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|addr
comma
id|length
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_create_sbale
c_func
(paren
id|addr
comma
id|length
comma
id|length_total
comma
id|length_min
comma
id|length_max
comma
id|buffer_index
comma
id|buffer_first
comma
id|buffer_last
comma
id|buffere_index
comma
id|buffer
comma
id|sbtype
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
multiline_comment|/* no resources */
r_goto
id|out
suffix:semicolon
)brace
id|addr
op_add_assign
id|length
suffix:semicolon
id|length
op_assign
id|length_seg
op_minus
id|length
suffix:semicolon
)brace
r_else
id|length
op_assign
id|length_seg
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
id|retval
op_assign
id|zfcp_create_sbale
c_func
(paren
id|addr
comma
id|min
c_func
(paren
(paren
r_int
)paren
id|PAGE_SIZE
comma
id|length
)paren
comma
id|length_total
comma
id|length_min
comma
id|length_max
comma
id|buffer_index
comma
id|buffer_first
comma
id|buffer_last
comma
id|buffere_index
comma
id|buffer
comma
id|sbtype
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|buffere_index
OG
id|ZFCP_LAST_SBALE_PER_SBAL
)paren
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Filling output buffers with SCSI &quot;
l_string|&quot;data failed. Index ran out of bounds. &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
op_star
id|buffere_index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
multiline_comment|/* no resources */
r_goto
id|out
suffix:semicolon
)brace
id|length
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
id|addr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_create_sbale - creates a single SBALE&n; * @addr:          begin of this buffer segment&n; * @length:        length of this buffer segment&n; * @length_total:  total length of buffer&n; * @length_min:    roll back if generated buffer smaller than this&n; * @length_max:    sum of all SBALEs (count) not larger than this&n; * @buffer_index:  position of current BUFFER&n; * @buffer_first:  first BUFFER used for this buffer&n; * @buffer_last:   last BUFFER allowed for this buffer&n; * @buffere_index: position of current BUFFERE of current BUFFER&n; * @buffer:        begin of SBAL array of request queue&n; * @sbtype:        storage-block type&n; */
r_static
r_int
DECL|function|zfcp_create_sbale
id|zfcp_create_sbale
c_func
(paren
r_int
r_int
id|addr
comma
r_int
id|length
comma
r_int
op_star
id|length_total
comma
r_int
id|length_min
comma
r_int
id|length_max
comma
r_int
op_star
id|buffer_index
comma
r_int
id|buffer_first
comma
r_int
id|buffer_last
comma
r_int
op_star
id|buffere_index
comma
r_struct
id|qdio_buffer
op_star
id|buffer
(braket
)braket
comma
r_char
id|sbtype
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|length_real
comma
id|residual
suffix:semicolon
r_int
id|buffers_used
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffere
op_assign
op_amp
(paren
id|buffer
(braket
op_star
id|buffer_index
)braket
op_member_access_from_pointer
id|element
(braket
op_star
id|buffere_index
)braket
)paren
suffix:semicolon
multiline_comment|/* check whether we hit the limit */
id|residual
op_assign
id|length_max
op_minus
op_star
id|length_total
suffix:semicolon
r_if
c_cond
(paren
id|residual
op_eq
l_int|0
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;skip remaining %i bytes since length_max hit&bslash;n&quot;
comma
id|length
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|length_real
op_assign
id|min
c_func
(paren
id|length
comma
id|residual
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * figure out next BUFFERE&n;&t; * (first BUFFERE of first BUFFER is skipped - &n;&t; * this is ok since it is reserved for the QTCB)&n;&t; */
r_if
c_cond
(paren
op_star
id|buffere_index
op_eq
id|ZFCP_LAST_SBALE_PER_SBAL
)paren
(brace
multiline_comment|/* last BUFFERE in this BUFFER */
id|buffere-&gt;flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
multiline_comment|/* need further BUFFER */
r_if
c_cond
(paren
op_star
id|buffer_index
op_eq
id|buffer_last
)paren
(brace
multiline_comment|/* queue full or last allowed BUFFER */
id|buffers_used
op_assign
(paren
id|buffer_last
op_minus
id|buffer_first
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* avoid modulo operation on negative value */
id|buffers_used
op_add_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|buffers_used
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;reached limit of number of BUFFERs &quot;
l_string|&quot;allowed for this request&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME (design) - This check is wrong and enforces the&n;&t;&t;&t; * use of one SBALE less than possible &n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
op_star
id|length_total
OL
id|length_min
)paren
op_logical_or
(paren
id|buffers_used
OL
id|ZFCP_MAX_SBALS_PER_REQ
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Rolling back SCSI command as &quot;
l_string|&quot;there are insufficient buffers &quot;
l_string|&quot;to cover the minimum required &quot;
l_string|&quot;amount of data&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * roll back complete list of BUFFERs generated&n;&t;&t;&t;&t; * from the scatter-gather list associated&n;&t;&t;&t;&t; * with this SCSI command&n;&t;&t;&t;&t; */
id|zfcp_qdio_zero_sbals
c_func
(paren
id|buffer
comma
id|buffer_first
comma
id|buffers_used
)paren
suffix:semicolon
op_star
id|length_total
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* DEBUG */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Not enough buffers available. &quot;
l_string|&quot;Can only transfer %i bytes of &quot;
l_string|&quot;data&bslash;n&quot;
comma
op_star
id|length_total
)paren
suffix:semicolon
)brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* *buffer_index != buffer_last */
multiline_comment|/* chain BUFFERs */
op_star
id|buffere_index
op_assign
l_int|0
suffix:semicolon
id|buffere
op_assign
op_amp
(paren
id|buffer
(braket
op_star
id|buffer_index
)braket
op_member_access_from_pointer
id|element
(braket
op_star
id|buffere_index
)braket
)paren
suffix:semicolon
id|buffere-&gt;flags
op_or_assign
id|SBAL_FLAGS0_MORE_SBALS
suffix:semicolon
(paren
op_star
id|buffer_index
)paren
op_increment
suffix:semicolon
op_star
id|buffer_index
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|buffere
op_assign
op_amp
(paren
id|buffer
(braket
op_star
id|buffer_index
)braket
op_member_access_from_pointer
id|element
(braket
op_star
id|buffere_index
)braket
)paren
suffix:semicolon
id|buffere-&gt;flags
op_or_assign
id|sbtype
suffix:semicolon
id|ZFCP_LOG_DEBUG
(paren
l_string|&quot;Chaining previous BUFFER %i to BUFFER %i&bslash;n&quot;
comma
(paren
(paren
op_star
id|buffer_index
op_ne
l_int|0
)paren
ques
c_cond
op_star
id|buffer_index
op_minus
l_int|1
suffix:colon
id|QDIO_MAX_BUFFERS_PER_Q
op_minus
l_int|1
)paren
comma
op_star
id|buffer_index
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* *buffere_index != (QDIO_MAX_ELEMENTS_PER_BUFFER - 1) */
(paren
op_star
id|buffere_index
)paren
op_increment
suffix:semicolon
id|buffere
op_assign
op_amp
(paren
id|buffer
(braket
op_star
id|buffer_index
)braket
op_member_access_from_pointer
id|element
(braket
op_star
id|buffere_index
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* ok, found a place for this piece, put it there */
id|buffere-&gt;addr
op_assign
(paren
r_void
op_star
)paren
id|addr
suffix:semicolon
id|buffere-&gt;length
op_assign
id|length_real
suffix:semicolon
macro_line|#ifdef ZFCP_STAT_REQSIZES
r_if
c_cond
(paren
id|sbtype
op_eq
id|SBAL_FLAGS0_TYPE_READ
)paren
id|zfcp_statistics_inc
c_func
(paren
op_amp
id|zfcp_data.read_sg_head
comma
id|length_real
)paren
suffix:semicolon
r_else
id|zfcp_statistics_inc
c_func
(paren
op_amp
id|zfcp_data.write_sg_head
comma
id|length_real
)paren
suffix:semicolon
macro_line|#endif
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_char
op_star
)paren
id|addr
comma
id|length_real
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;BUFFER no %i (0x%lx) BUFFERE no %i (0x%lx): BUFFERE &quot;
l_string|&quot;data addr 0x%lx, BUFFERE length %i, BUFFER type %i&bslash;n&quot;
comma
op_star
id|buffer_index
comma
(paren
r_int
r_int
)paren
op_amp
id|buffer
(braket
op_star
id|buffer_index
)braket
comma
op_star
id|buffere_index
comma
(paren
r_int
r_int
)paren
id|buffere
comma
id|addr
comma
id|length_real
comma
id|sbtype
)paren
suffix:semicolon
op_star
id|length_total
op_add_assign
id|length_real
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_create_sbals_from_sg&n; *&n; * purpose:&t;walks through scatter-gather list of specified SCSI command&n; *&t;&t;and creates a corresponding list of SBALs&n; *&n; * returns:&t;size of generated buffer in bytes &n; *&n; * context:&t;&n; */
r_int
DECL|function|zfcp_create_sbals_from_sg
id|zfcp_create_sbals_from_sg
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
id|Scsi_Cmnd
op_star
id|scpnt
comma
r_char
id|sbtype
comma
multiline_comment|/* storage-block type */
r_int
id|length_min
comma
multiline_comment|/* roll back if generated buffer */
r_int
id|buffer_max
)paren
multiline_comment|/* max numbers of BUFFERs */
(brace
r_int
id|length_total
op_assign
l_int|0
suffix:semicolon
r_int
id|buffer_index
op_assign
l_int|0
suffix:semicolon
r_int
id|buffer_last
op_assign
l_int|0
suffix:semicolon
r_int
id|buffere_index
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* elements 0 and 1 are req-id and qtcb */
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffere
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|req_q
op_assign
l_int|NULL
suffix:semicolon
r_int
id|length_max
op_assign
id|scpnt-&gt;request_bufflen
suffix:semicolon
id|req_q
op_assign
op_amp
id|fsf_req-&gt;adapter-&gt;request_queue
suffix:semicolon
id|buffer_index
op_assign
id|req_q-&gt;free_index
suffix:semicolon
id|buffer_last
op_assign
id|req_q-&gt;free_index
op_plus
id|min
c_func
(paren
id|buffer_max
comma
id|atomic_read
c_func
(paren
op_amp
id|req_q-&gt;free_count
)paren
)paren
op_minus
l_int|1
suffix:semicolon
id|buffer_last
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|ZFCP_LOG_TRACE
(paren
l_string|&quot;total SCSI data buffer size is (scpnt-&gt;request_bufflen) %i&bslash;n&quot;
comma
id|scpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
(paren
l_string|&quot;BUFFERs from (buffer_index)%i to (buffer_last)%i available&bslash;n&quot;
comma
id|buffer_index
comma
id|buffer_last
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;buffer_max=%d, req_q-&gt;free_count=%d&bslash;n&quot;
comma
id|buffer_max
comma
id|atomic_read
c_func
(paren
op_amp
id|req_q-&gt;free_count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scpnt-&gt;use_sg
)paren
(brace
r_int
id|sg_index
suffix:semicolon
r_struct
id|scatterlist
op_star
id|list
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|scpnt-&gt;request_buffer
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;%i (scpnt-&gt;use_sg) scatter-gather segments&bslash;n&quot;
comma
id|scpnt-&gt;use_sg
)paren
suffix:semicolon
singleline_comment|//                length_max+=0x2100;
macro_line|#ifdef ZFCP_STAT_REQSIZES
r_if
c_cond
(paren
id|sbtype
op_eq
id|SBAL_FLAGS0_TYPE_READ
)paren
id|zfcp_statistics_inc
c_func
(paren
op_amp
id|zfcp_data.read_sguse_head
comma
id|scpnt-&gt;use_sg
)paren
suffix:semicolon
r_else
id|zfcp_statistics_inc
c_func
(paren
op_amp
id|zfcp_data.write_sguse_head
comma
id|scpnt-&gt;use_sg
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|sg_index
op_assign
l_int|0
suffix:semicolon
id|sg_index
OL
id|scpnt-&gt;use_sg
suffix:semicolon
id|sg_index
op_increment
comma
id|list
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zfcp_create_sbales_from_segment
c_func
(paren
(paren
id|page_to_pfn
(paren
id|list-&gt;page
)paren
op_lshift
id|PAGE_SHIFT
)paren
op_plus
id|list-&gt;offset
comma
id|list-&gt;length
comma
op_amp
id|length_total
comma
id|length_min
comma
id|length_max
comma
op_amp
id|buffer_index
comma
op_amp
id|buffere_index
comma
id|req_q-&gt;free_index
comma
id|buffer_last
comma
id|req_q-&gt;buffer
comma
id|sbtype
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;no scatter-gather list&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_STAT_REQSIZES
r_if
c_cond
(paren
id|sbtype
op_eq
id|SBAL_FLAGS0_TYPE_READ
)paren
id|zfcp_statistics_inc
c_func
(paren
op_amp
id|zfcp_data.read_sguse_head
comma
l_int|1
)paren
suffix:semicolon
r_else
id|zfcp_statistics_inc
c_func
(paren
op_amp
id|zfcp_data.write_sguse_head
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|zfcp_create_sbales_from_segment
c_func
(paren
(paren
r_int
r_int
)paren
id|scpnt-&gt;request_buffer
comma
id|scpnt-&gt;request_bufflen
comma
op_amp
id|length_total
comma
id|length_min
comma
id|length_max
comma
op_amp
id|buffer_index
comma
op_amp
id|buffere_index
comma
id|req_q-&gt;free_index
comma
id|buffer_last
comma
id|req_q-&gt;buffer
comma
id|sbtype
)paren
suffix:semicolon
)brace
id|fsf_req-&gt;sbal_index
op_assign
id|req_q-&gt;free_index
suffix:semicolon
r_if
c_cond
(paren
id|buffer_index
op_ge
id|fsf_req-&gt;sbal_index
)paren
(brace
id|fsf_req-&gt;sbal_count
op_assign
(paren
id|buffer_index
op_minus
id|fsf_req-&gt;sbal_index
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|fsf_req-&gt;sbal_count
op_assign
(paren
id|QDIO_MAX_BUFFERS_PER_Q
op_minus
id|fsf_req-&gt;sbal_index
)paren
op_plus
id|buffer_index
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* HACK */
r_if
c_cond
(paren
(paren
id|scpnt-&gt;request_bufflen
op_ne
l_int|0
)paren
op_logical_and
(paren
id|length_total
op_eq
l_int|0
)paren
)paren
r_goto
id|out
suffix:semicolon
macro_line|#ifdef ZFCP_STAT_REQSIZES
r_if
c_cond
(paren
id|sbtype
op_eq
id|SBAL_FLAGS0_TYPE_READ
)paren
id|zfcp_statistics_inc
c_func
(paren
op_amp
id|zfcp_data.read_req_head
comma
id|length_total
)paren
suffix:semicolon
r_else
id|zfcp_statistics_inc
c_func
(paren
op_amp
id|zfcp_data.write_req_head
comma
id|length_total
)paren
suffix:semicolon
macro_line|#endif
id|buffere
op_assign
op_amp
(paren
id|req_q-&gt;buffer
(braket
id|buffer_index
)braket
op_member_access_from_pointer
id|element
(braket
id|buffere_index
)braket
)paren
suffix:semicolon
id|buffere-&gt;flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|out
suffix:colon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;%i BUFFER(s) from %i to %i needed&bslash;n&quot;
comma
id|fsf_req-&gt;sbal_count
comma
id|fsf_req-&gt;sbal_index
comma
id|buffer_index
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;total QDIO data buffer size is %i&bslash;n&quot;
comma
id|length_total
)paren
suffix:semicolon
r_return
id|length_total
suffix:semicolon
)brace
r_void
DECL|function|zfcp_fsf_start_scsi_er_timer
id|zfcp_fsf_start_scsi_er_timer
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
id|adapter-&gt;scsi_er_timer.function
op_assign
id|zfcp_fsf_scsi_er_timeout_handler
suffix:semicolon
id|adapter-&gt;scsi_er_timer.data
op_assign
(paren
r_int
r_int
)paren
id|adapter
suffix:semicolon
id|adapter-&gt;scsi_er_timer.expires
op_assign
id|jiffies
op_plus
id|ZFCP_SCSI_ER_TIMEOUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_sysfs_hba_id_show - display hba_id of scsi device&n; * @dev: pointer to belonging device&n; * @buf: pointer to input buffer&n; *&n; * &quot;hba_id&quot; attribute of a scsi device. Displays hba_id (bus_id)&n; * of the adapter belonging to a scsi device.&n; */
r_static
id|ssize_t
DECL|function|zfcp_sysfs_hba_id_show
id|zfcp_sysfs_hba_id_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|hba_id
comma
id|S_IRUGO
comma
id|zfcp_sysfs_hba_id_show
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/**&n; * zfcp_sysfs_wwpn_show - display wwpn of scsi device&n; * @dev: pointer to belonging device&n; * @buf: pointer to input buffer&n; *&n; * &quot;wwpn&quot; attribute of a scsi device. Displays wwpn of the port&n; * belonging to a scsi device.&n; */
r_static
id|ssize_t
DECL|function|zfcp_sysfs_wwpn_show
id|zfcp_sysfs_wwpn_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;0x%016llx&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|wwpn
comma
id|S_IRUGO
comma
id|zfcp_sysfs_wwpn_show
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/**&n; * zfcp_sysfs_fcp_lun_show - display fcp lun of scsi device&n; * @dev: pointer to belonging device&n; * @buf: pointer to input buffer&n; *&n; * &quot;fcp_lun&quot; attribute of a scsi device. Displays fcp_lun of the unit&n; * belonging to a scsi device.&n; */
r_static
id|ssize_t
DECL|function|zfcp_sysfs_fcp_lun_show
id|zfcp_sysfs_fcp_lun_show
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|scsi_device
op_star
id|sdev
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|sdev
op_assign
id|to_scsi_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|sdev-&gt;hostdata
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;0x%016llx&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|fcp_lun
comma
id|S_IRUGO
comma
id|zfcp_sysfs_fcp_lun_show
comma
l_int|NULL
)paren
suffix:semicolon
DECL|variable|zfcp_sysfs_sdev_attrs
r_static
r_struct
id|device_attribute
op_star
id|zfcp_sysfs_sdev_attrs
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_fcp_lun
comma
op_amp
id|dev_attr_wwpn
comma
op_amp
id|dev_attr_hba_id
comma
l_int|NULL
)brace
suffix:semicolon
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
DECL|macro|ZFCP_LOG_AREA_PREFIX
macro_line|#undef ZFCP_LOG_AREA_PREFIX
eof
