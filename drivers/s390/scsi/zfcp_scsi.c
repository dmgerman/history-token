multiline_comment|/* &n; * &n; * linux/drivers/s390/scsi/zfcp_scsi.c&n; * &n; * FCP adapter driver for IBM eServer zSeries &n; * &n; * (C) Copyright IBM Corp. 2002, 2004&n; *&n; * Author(s): Martin Peschke &lt;mpeschke@de.ibm.com&gt; &n; *            Raimund Schroeder &lt;raimund.schroeder@de.ibm.com&gt; &n; *            Aron Zeh&n; *            Wolfgang Taphorn&n; *            Stefan Bader &lt;stefan.bader@de.ibm.com&gt; &n; *            Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt; &n; * &n; * This program is free software; you can redistribute it and/or modify &n; * it under the terms of the GNU General Public License as published by &n; * the Free Software Foundation; either version 2, or (at your option) &n; * any later version. &n; * &n; * This program is distributed in the hope that it will be useful, &n; * but WITHOUT ANY WARRANTY; without even the implied warranty of &n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the &n; * GNU General Public License for more details. &n; * &n; * You should have received a copy of the GNU General Public License &n; * along with this program; if not, write to the Free Software &n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA. &n; */
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA&t;&t;&t;ZFCP_LOG_AREA_SCSI
multiline_comment|/* this drivers version (do not edit !!! generated and updated by cvs) */
DECL|macro|ZFCP_SCSI_REVISION
mdefine_line|#define ZFCP_SCSI_REVISION &quot;$Revision: 1.61 $&quot;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &quot;zfcp_ext.h&quot;
r_static
r_void
id|zfcp_scsi_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_queuecommand
c_func
(paren
r_struct
id|scsi_cmnd
op_star
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_eh_abort_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_eh_device_reset_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_eh_bus_reset_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_scsi_eh_host_reset_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_task_management_function
c_func
(paren
r_struct
id|zfcp_unit
op_star
comma
id|u8
)paren
suffix:semicolon
r_static
r_struct
id|zfcp_unit
op_star
id|zfcp_unit_lookup
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
r_int
comma
id|scsi_id_t
comma
id|scsi_lun_t
)paren
suffix:semicolon
DECL|variable|zfcp_sysfs_sdev_attrs
r_static
r_struct
id|device_attribute
op_star
id|zfcp_sysfs_sdev_attrs
(braket
)braket
suffix:semicolon
DECL|variable|zfcp_data
r_struct
id|zfcp_data
id|zfcp_data
op_assign
(brace
dot
id|scsi_host_template
op_assign
(brace
id|name
suffix:colon
id|ZFCP_NAME
comma
id|proc_name
suffix:colon
l_string|&quot;zfcp&quot;
comma
id|proc_info
suffix:colon
l_int|NULL
comma
id|detect
suffix:colon
l_int|NULL
comma
id|slave_alloc
suffix:colon
id|zfcp_scsi_slave_alloc
comma
id|slave_configure
suffix:colon
id|zfcp_scsi_slave_configure
comma
id|slave_destroy
suffix:colon
id|zfcp_scsi_slave_destroy
comma
id|queuecommand
suffix:colon
id|zfcp_scsi_queuecommand
comma
id|eh_abort_handler
suffix:colon
id|zfcp_scsi_eh_abort_handler
comma
id|eh_device_reset_handler
suffix:colon
id|zfcp_scsi_eh_device_reset_handler
comma
id|eh_bus_reset_handler
suffix:colon
id|zfcp_scsi_eh_bus_reset_handler
comma
id|eh_host_reset_handler
suffix:colon
id|zfcp_scsi_eh_host_reset_handler
comma
multiline_comment|/* FIXME(openfcp): Tune */
id|can_queue
suffix:colon
l_int|4096
comma
id|this_id
suffix:colon
l_int|0
comma
multiline_comment|/*&n;&t;       * FIXME:&n;&t;       * one less? can zfcp_create_sbale cope with it?&n;&t;       */
id|sg_tablesize
suffix:colon
id|ZFCP_MAX_SBALES_PER_REQ
comma
id|cmd_per_lun
suffix:colon
l_int|1
comma
id|unchecked_isa_dma
suffix:colon
l_int|0
comma
id|use_clustering
suffix:colon
l_int|1
comma
id|sdev_attrs
suffix:colon
id|zfcp_sysfs_sdev_attrs
comma
)brace
multiline_comment|/* rest initialised with zeros */
)brace
suffix:semicolon
multiline_comment|/* Find start of Response Information in FCP response unit*/
r_char
op_star
DECL|function|zfcp_get_fcp_rsp_info_ptr
id|zfcp_get_fcp_rsp_info_ptr
c_func
(paren
r_struct
id|fcp_rsp_iu
op_star
id|fcp_rsp_iu
)paren
(brace
r_char
op_star
id|fcp_rsp_info_ptr
suffix:semicolon
id|fcp_rsp_info_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|fcp_rsp_iu
op_plus
(paren
r_sizeof
(paren
r_struct
id|fcp_rsp_iu
)paren
)paren
suffix:semicolon
r_return
id|fcp_rsp_info_ptr
suffix:semicolon
)brace
multiline_comment|/* Find start of Sense Information in FCP response unit*/
r_char
op_star
DECL|function|zfcp_get_fcp_sns_info_ptr
id|zfcp_get_fcp_sns_info_ptr
c_func
(paren
r_struct
id|fcp_rsp_iu
op_star
id|fcp_rsp_iu
)paren
(brace
r_char
op_star
id|fcp_sns_info_ptr
suffix:semicolon
id|fcp_sns_info_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|fcp_rsp_iu
op_plus
(paren
r_sizeof
(paren
r_struct
id|fcp_rsp_iu
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_rsp_len_valid
)paren
id|fcp_sns_info_ptr
op_assign
(paren
r_char
op_star
)paren
id|fcp_sns_info_ptr
op_plus
id|fcp_rsp_iu-&gt;fcp_rsp_len
suffix:semicolon
r_return
id|fcp_sns_info_ptr
suffix:semicolon
)brace
id|fcp_dl_t
op_star
DECL|function|zfcp_get_fcp_dl_ptr
id|zfcp_get_fcp_dl_ptr
c_func
(paren
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmd
)paren
(brace
r_int
id|additional_length
op_assign
id|fcp_cmd-&gt;add_fcp_cdb_length
op_lshift
l_int|2
suffix:semicolon
id|fcp_dl_t
op_star
id|fcp_dl_addr
suffix:semicolon
id|fcp_dl_addr
op_assign
(paren
id|fcp_dl_t
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|fcp_cmd
op_plus
r_sizeof
(paren
r_struct
id|fcp_cmnd_iu
)paren
op_plus
id|additional_length
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * fcp_dl_addr = start address of fcp_cmnd structure + &n;&t; * size of fixed part + size of dynamically sized add_dcp_cdb field&n;&t; * SEE FCP-2 documentation&n;&t; */
r_return
id|fcp_dl_addr
suffix:semicolon
)brace
id|fcp_dl_t
DECL|function|zfcp_get_fcp_dl
id|zfcp_get_fcp_dl
c_func
(paren
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmd
)paren
(brace
r_return
op_star
id|zfcp_get_fcp_dl_ptr
c_func
(paren
id|fcp_cmd
)paren
suffix:semicolon
)brace
r_void
DECL|function|zfcp_set_fcp_dl
id|zfcp_set_fcp_dl
c_func
(paren
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmd
comma
id|fcp_dl_t
id|fcp_dl
)paren
(brace
op_star
id|zfcp_get_fcp_dl_ptr
c_func
(paren
id|fcp_cmd
)paren
op_assign
id|fcp_dl
suffix:semicolon
)brace
multiline_comment|/*&n; * note: it&squot;s a bit-or operation not an assignment&n; * regarding the specified byte&n; */
r_static
r_inline
r_void
DECL|function|set_byte
id|set_byte
c_func
(paren
id|u32
op_star
id|result
comma
r_char
id|status
comma
r_char
id|pos
)paren
(brace
op_star
id|result
op_or_assign
id|status
op_lshift
(paren
id|pos
op_star
l_int|8
)paren
suffix:semicolon
)brace
r_void
DECL|function|set_host_byte
id|set_host_byte
c_func
(paren
id|u32
op_star
id|result
comma
r_char
id|status
)paren
(brace
id|set_byte
c_func
(paren
id|result
comma
id|status
comma
l_int|2
)paren
suffix:semicolon
)brace
r_void
DECL|function|set_driver_byte
id|set_driver_byte
c_func
(paren
id|u32
op_star
id|result
comma
r_char
id|status
)paren
(brace
id|set_byte
c_func
(paren
id|result
comma
id|status
comma
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_slave_alloc&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_scsi_slave_alloc
id|zfcp_scsi_slave_alloc
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|sdp-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter
)paren
r_goto
id|out
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|unit
op_assign
id|zfcp_unit_lookup
c_func
(paren
id|adapter
comma
id|sdp-&gt;channel
comma
id|sdp-&gt;id
comma
id|sdp-&gt;lun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unit
)paren
(brace
id|sdp-&gt;hostdata
op_assign
id|unit
suffix:semicolon
id|unit-&gt;device
op_assign
id|sdp
suffix:semicolon
id|zfcp_unit_get
c_func
(paren
id|unit
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_slave_destroy&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_scsi_slave_destroy
id|zfcp_scsi_slave_destroy
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdpnt
)paren
(brace
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|sdpnt-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|unit
)paren
(brace
id|sdpnt-&gt;hostdata
op_assign
l_int|NULL
suffix:semicolon
id|unit-&gt;device
op_assign
l_int|NULL
suffix:semicolon
id|zfcp_unit_put
c_func
(paren
id|unit
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: no unit associated with SCSI device at &quot;
l_string|&quot;address %p&bslash;n&quot;
comma
id|sdpnt
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * called from scsi midlayer to allow finetuning of a device.&n; */
r_static
r_int
DECL|function|zfcp_scsi_slave_configure
id|zfcp_scsi_slave_configure
c_func
(paren
r_struct
id|scsi_device
op_star
id|sdp
)paren
(brace
r_if
c_cond
(paren
id|sdp-&gt;tagged_supported
)paren
id|scsi_adjust_queue_depth
c_func
(paren
id|sdp
comma
id|MSG_SIMPLE_TAG
comma
id|ZFCP_CMND_PER_LUN
)paren
suffix:semicolon
r_else
id|scsi_adjust_queue_depth
c_func
(paren
id|sdp
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_scsi_command_fail - set result in scsi_cmnd and call scsi_done function&n; * @scpnt: pointer to struct scsi_cmnd where result is set&n; * @result: result to be set in scpnt (e.g. DID_ERROR)&n; */
r_static
r_void
DECL|function|zfcp_scsi_command_fail
id|zfcp_scsi_command_fail
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scpnt
comma
r_int
id|result
)paren
(brace
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|result
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_scsi
c_func
(paren
l_string|&quot;failing&quot;
comma
id|scpnt
)paren
suffix:semicolon
multiline_comment|/* return directly */
id|scpnt
op_member_access_from_pointer
id|scsi_done
c_func
(paren
id|scpnt
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_scsi_command_async - worker for zfcp_scsi_queuecommand and&n; *&t;zfcp_scsi_command_sync&n; * @adapter: adapter for where scsi command is issued&n; * @unit: unit to which scsi command is sent&n; * @scpnt: scsi command to be sent&n; *&n; * Note: In scsi_done function must be set in scpnt.&n; */
r_int
DECL|function|zfcp_scsi_command_async
id|zfcp_scsi_command_async
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_struct
id|scsi_cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
(paren
id|adapter
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|adapter
op_ne
id|unit-&gt;port-&gt;adapter
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|scpnt-&gt;scsi_done
op_eq
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
l_int|NULL
op_eq
id|unit
)paren
)paren
(brace
id|zfcp_scsi_command_fail
c_func
(paren
id|scpnt
comma
id|DID_NO_CONNECT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|unit-&gt;status
)paren
op_logical_or
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_RUNNING
comma
op_amp
id|unit-&gt;status
)paren
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;stopping SCSI I/O on unit 0x%016Lx on port &quot;
l_string|&quot;0x%016Lx on adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_scsi_command_fail
c_func
(paren
id|scpnt
comma
id|DID_ERROR
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_UNBLOCKED
comma
op_amp
id|unit-&gt;status
)paren
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;adapter %s not ready or unit 0x%016Lx &quot;
l_string|&quot;on port 0x%016Lx in recovery&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|retval
op_assign
id|SCSI_MLQUEUE_DEVICE_BUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|tmp
op_assign
id|zfcp_fsf_send_fcp_command_task
c_func
(paren
id|adapter
comma
id|unit
comma
id|scpnt
comma
id|ZFCP_REQ_AUTO_CLEANUP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|tmp
OL
l_int|0
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: initiation of Send FCP Cmnd failed&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|SCSI_MLQUEUE_HOST_BUSY
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
r_void
DECL|function|zfcp_scsi_command_sync_handler
id|zfcp_scsi_command_sync_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scpnt
)paren
(brace
r_struct
id|completion
op_star
id|wait
op_assign
(paren
r_struct
id|completion
op_star
)paren
id|scpnt-&gt;SCp.ptr
suffix:semicolon
id|complete
c_func
(paren
id|wait
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_scsi_command_sync - send a SCSI command and wait for completion&n; * returns 0, errors are indicated by scsi_cmnd-&gt;result&n; */
r_int
DECL|function|zfcp_scsi_command_sync
id|zfcp_scsi_command_sync
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_struct
id|scsi_cmnd
op_star
id|scpnt
)paren
(brace
id|DECLARE_COMPLETION
c_func
(paren
id|wait
)paren
suffix:semicolon
id|scpnt-&gt;SCp.ptr
op_assign
(paren
r_void
op_star
)paren
op_amp
id|wait
suffix:semicolon
multiline_comment|/* silent re-use */
id|scpnt-&gt;done
op_assign
id|zfcp_scsi_command_sync_handler
suffix:semicolon
id|zfcp_scsi_command_async
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
id|unit
comma
id|scpnt
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_queuecommand&n; *&n; * purpose:&t;enqueues a SCSI command to the specified target device&n; *&n; * returns:&t;0 - success, SCSI command enqueued&n; *&t;&t;!0 - failure&n; */
r_int
DECL|function|zfcp_scsi_queuecommand
id|zfcp_scsi_queuecommand
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
r_struct
id|scsi_cmnd
op_star
)paren
)paren
(brace
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
multiline_comment|/* reset the status for this request */
id|scpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|scpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|scpnt-&gt;scsi_done
op_assign
id|done
suffix:semicolon
multiline_comment|/*&n;&t; * figure out adapter and target device&n;&t; * (stored there by zfcp_scsi_slave_alloc)&n;&t; */
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|scpnt-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
r_return
id|zfcp_scsi_command_async
c_func
(paren
id|adapter
comma
id|unit
comma
id|scpnt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_unit_lookup&n; *&n; * purpose:&n; *&n; * returns:&n; *&n; * context:&t;&n; */
r_static
r_struct
id|zfcp_unit
op_star
DECL|function|zfcp_unit_lookup
id|zfcp_unit_lookup
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|channel
comma
id|scsi_id_t
id|id
comma
id|scsi_lun_t
id|lun
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
comma
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|id
op_ne
id|port-&gt;scsi_id
)paren
r_continue
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|lun
op_eq
id|unit-&gt;scsi_lun
)paren
(brace
id|retval
op_assign
id|unit
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_eh_abort_handler&n; *&n; * purpose:&t;tries to abort the specified (timed out) SCSI command&n; *&n; * note: &t;We do not need to care for a SCSI command which completes&n; *&t;&t;normally but late during this abort routine runs.&n; *&t;&t;We are allowed to return late commands to the SCSI stack.&n; *&t;&t;It tracks the state of commands and will handle late commands.&n; *&t;&t;(Usually, the normal completion of late commands is ignored with&n; *&t;&t;respect to the running abort operation. Grep for &squot;done_late&squot;&n; *&t;&t;in the SCSI stacks sources.)&n; *&n; * returns:&t;SUCCESS&t;- command has been aborted and cleaned up in internal&n; *&t;&t;&t;  bookkeeping,&n; *&t;&t;&t;  SCSI stack won&squot;t be called for aborted command&n; *&t;&t;FAILED&t;- otherwise&n; */
r_int
DECL|function|zfcp_scsi_eh_abort_handler
id|zfcp_scsi_eh_abort_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|retval
op_assign
id|SUCCESS
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|new_fsf_req
comma
op_star
id|old_fsf_req
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
(paren
r_struct
id|zfcp_adapter
op_star
)paren
id|scpnt-&gt;device-&gt;host-&gt;hostdata
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|unit-&gt;port
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|scpnt-&gt;device-&gt;host
suffix:semicolon
r_union
id|zfcp_req_data
op_star
id|req_data
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* the components of a abort_dbf record (fixed size record) */
id|u64
id|dbf_scsi_cmnd
op_assign
(paren
r_int
r_int
)paren
id|scpnt
suffix:semicolon
r_char
id|dbf_opcode
(braket
id|ZFCP_ABORT_DBF_LENGTH
)braket
suffix:semicolon
id|wwn_t
id|dbf_wwn
op_assign
id|port-&gt;wwpn
suffix:semicolon
id|fcp_lun_t
id|dbf_fcp_lun
op_assign
id|unit-&gt;fcp_lun
suffix:semicolon
id|u64
id|dbf_retries
op_assign
id|scpnt-&gt;retries
suffix:semicolon
id|u64
id|dbf_allowed
op_assign
id|scpnt-&gt;allowed
suffix:semicolon
id|u64
id|dbf_timeout
op_assign
l_int|0
suffix:semicolon
id|u64
id|dbf_fsf_req
op_assign
l_int|0
suffix:semicolon
id|u64
id|dbf_fsf_status
op_assign
l_int|0
suffix:semicolon
id|u64
id|dbf_fsf_qual
(braket
l_int|2
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_char
id|dbf_result
(braket
id|ZFCP_ABORT_DBF_LENGTH
)braket
op_assign
(brace
l_string|&quot;##undef&quot;
)brace
suffix:semicolon
id|memset
c_func
(paren
id|dbf_opcode
comma
l_int|0
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dbf_opcode
comma
id|scpnt-&gt;cmnd
comma
id|min
c_func
(paren
id|scpnt-&gt;cmd_len
comma
(paren
r_int
r_char
)paren
id|ZFCP_ABORT_DBF_LENGTH
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;aborting scsi_cmnd=%p on adapter %s&bslash;n&quot;
comma
id|scpnt
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Race condition between normal (late) completion and abort has&n;&t; * to be avoided.&n;&t; * The entirity of all accesses to scsi_req have to be atomic.&n;&t; * scsi_req is usually part of the fsf_req and thus we block the&n;&t; * release of fsf_req as long as we need to access scsi_req.&n;&t; */
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check whether command has just completed and can not be aborted.&n;&t; * Even if the command has just been completed late, we can access&n;&t; * scpnt since the SCSI stack does not release it at least until&n;&t; * this routine returns. (scpnt is parameter passed to this routine&n;&t; * and must not disappear during abort even on late completion.)&n;&t; */
id|req_data
op_assign
(paren
r_union
id|zfcp_req_data
op_star
)paren
id|scpnt-&gt;host_scribble
suffix:semicolon
multiline_comment|/* DEBUG */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;req_data=%p&bslash;n&quot;
comma
id|req_data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req_data
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;late command completion overtook abort&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * That&squot;s it.&n;&t;&t; * Do not initiate abort but return SUCCESS.&n;&t;&t; */
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##late1&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Figure out which fsf_req needs to be aborted. */
id|old_fsf_req
op_assign
id|req_data-&gt;send_fcp_command_task.fsf_req
suffix:semicolon
id|dbf_fsf_req
op_assign
(paren
r_int
r_int
)paren
id|old_fsf_req
suffix:semicolon
id|dbf_timeout
op_assign
(paren
id|jiffies
op_minus
id|req_data-&gt;send_fcp_command_task.start_jiffies
)paren
op_div
id|HZ
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;old_fsf_req=%p&bslash;n&quot;
comma
id|old_fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|old_fsf_req
)paren
(brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: no old fsf request found&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;req_data:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|req_data
comma
r_sizeof
(paren
r_union
id|zfcp_req_data
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;scsi_cmnd:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|scpnt
comma
r_sizeof
(paren
r_struct
id|scsi_cmnd
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|FAILED
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##bug:r&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|old_fsf_req-&gt;data.send_fcp_command_task.scsi_cmnd
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* mark old request as being aborted */
id|old_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ABORTING
suffix:semicolon
multiline_comment|/*&n;&t; * We have to collect all information (e.g. unit) needed by &n;&t; * zfcp_fsf_abort_fcp_command before calling that routine&n;&t; * since that routine is not allowed to access&n;&t; * fsf_req which it is going to abort.&n;&t; * This is because of we need to release fsf_req_list_lock&n;&t; * before calling zfcp_fsf_abort_fcp_command.&n;&t; * Since this lock will not be held, fsf_req may complete&n;&t; * late and may be released meanwhile.&n;&t; */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit 0x%016Lx (%p)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The &squot;Abort FCP Command&squot; routine may block (call schedule)&n;&t; * because it may wait for a free SBAL.&n;&t; * That&squot;s why we must release the lock and enable the&n;&t; * interrupts before.&n;&t; * On the other hand we do not need the lock anymore since&n;&t; * all critical accesses to scsi_req are done.&n;&t; */
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* call FSF routine which does the abort */
id|new_fsf_req
op_assign
id|zfcp_fsf_abort_fcp_command
c_func
(paren
(paren
r_int
r_int
)paren
id|old_fsf_req
comma
id|adapter
comma
id|unit
comma
id|ZFCP_WAIT_FOR_SBAL
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;new_fsf_req=%p&bslash;n&quot;
comma
id|new_fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_fsf_req
)paren
(brace
id|retval
op_assign
id|FAILED
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: initiation of Abort FCP Cmnd &quot;
l_string|&quot;failed&bslash;n&quot;
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##nores&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* wait for completion of abort */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;waiting for cleanup...&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 1
multiline_comment|/*&n;&t; * FIXME:&n;&t; * copying zfcp_fsf_req_wait_and_cleanup code is not really nice&n;&t; */
id|__wait_event
c_func
(paren
id|new_fsf_req-&gt;completion_wq
comma
id|new_fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_COMPLETED
)paren
suffix:semicolon
id|status
op_assign
id|new_fsf_req-&gt;status
suffix:semicolon
id|dbf_fsf_status
op_assign
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status
suffix:semicolon
multiline_comment|/*&n;&t; * Ralphs special debug load provides timestamps in the FSF&n;&t; * status qualifier. This might be specified later if being&n;&t; * useful for debugging aborts.&n;&t; */
id|dbf_fsf_qual
(braket
l_int|0
)braket
op_assign
op_star
(paren
id|u64
op_star
)paren
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
suffix:semicolon
id|dbf_fsf_qual
(braket
l_int|1
)braket
op_assign
op_star
(paren
id|u64
op_star
)paren
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|2
)braket
suffix:semicolon
id|zfcp_fsf_req_cleanup
c_func
(paren
id|new_fsf_req
)paren
suffix:semicolon
macro_line|#else
id|retval
op_assign
id|zfcp_fsf_req_wait_and_cleanup
c_func
(paren
id|new_fsf_req
comma
id|ZFCP_UNINTERRUPTIBLE
comma
op_amp
id|status
)paren
suffix:semicolon
macro_line|#endif
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Waiting for cleanup complete, status=0x%x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* status should be valid since signals were not permitted */
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_FSFREQ_ABORTSUCCEEDED
)paren
(brace
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##succ&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_FSFREQ_ABORTNOTNEEDED
)paren
(brace
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##late2&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
id|FAILED
suffix:semicolon
id|strncpy
c_func
(paren
id|dbf_result
comma
l_string|&quot;##fail&quot;
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_scsi_cmnd
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_opcode
comma
id|ZFCP_ABORT_DBF_LENGTH
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_wwn
comma
r_sizeof
(paren
id|wwn_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fcp_lun
comma
r_sizeof
(paren
id|fcp_lun_t
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_retries
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_allowed
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_timeout
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fsf_req
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fsf_status
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fsf_qual
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
op_amp
id|dbf_fsf_qual
(braket
l_int|1
)braket
comma
r_sizeof
(paren
id|u64
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;abort_dbf
comma
l_int|1
comma
id|dbf_result
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_eh_device_reset_handler&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_scsi_eh_device_reset_handler
id|zfcp_scsi_eh_device_reset_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|retval
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|scpnt-&gt;device-&gt;host
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unit
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Tried reset for nonexistent unit&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;resetting unit 0x%016Lx&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we do not know whether the unit supports &squot;logical unit reset&squot;&n;&t; * then try &squot;logical unit reset&squot; and proceed with &squot;target reset&squot;&n;&t; * if &squot;logical unit reset&squot; fails.&n;&t; * If the unit is known not to support &squot;logical unit reset&squot; then&n;&t; * skip &squot;logical unit reset&squot; and try &squot;target reset&squot; immediately.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_UNIT_NOTSUPPUNITRESET
comma
op_amp
id|unit-&gt;status
)paren
)paren
(brace
id|retval
op_assign
id|zfcp_task_management_function
c_func
(paren
id|unit
comma
id|LOGICAL_UNIT_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit reset failed (unit=%p)&bslash;n&quot;
comma
id|unit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_eq
op_minus
id|ENOTSUPP
)paren
id|atomic_set_mask
(paren
id|ZFCP_STATUS_UNIT_NOTSUPPUNITRESET
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
multiline_comment|/* fall through and try &squot;target reset&squot; next */
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit reset succeeded (unit=%p)&bslash;n&quot;
comma
id|unit
)paren
suffix:semicolon
multiline_comment|/* avoid &squot;target reset&squot; */
id|retval
op_assign
id|SUCCESS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|retval
op_assign
id|zfcp_task_management_function
c_func
(paren
id|unit
comma
id|TARGET_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;target reset failed (unit=%p)&bslash;n&quot;
comma
id|unit
)paren
suffix:semicolon
id|retval
op_assign
id|FAILED
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;target reset succeeded (unit=%p)&bslash;n&quot;
comma
id|unit
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_lock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|zfcp_task_management_function
id|zfcp_task_management_function
c_func
(paren
r_struct
id|zfcp_unit
op_star
id|unit
comma
id|u8
id|tm_flags
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|unit-&gt;port-&gt;adapter
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|status
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
multiline_comment|/* issue task management function */
id|fsf_req
op_assign
id|zfcp_fsf_send_fcp_command_task_management
(paren
id|adapter
comma
id|unit
comma
id|tm_flags
comma
id|ZFCP_WAIT_FOR_SBAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fsf_req
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: creation of task management request &quot;
l_string|&quot;failed for unit 0x%016Lx on port 0x%016Lx on  &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_fsf_req_wait_and_cleanup
c_func
(paren
id|fsf_req
comma
id|ZFCP_UNINTERRUPTIBLE
comma
op_amp
id|status
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * check completion status of task management function&n;&t; * (status should always be valid since no signals permitted)&n;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_FSFREQ_TMFUNCFAILED
)paren
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|ZFCP_STATUS_FSFREQ_TMFUNCNOTSUPP
)paren
id|retval
op_assign
op_minus
id|ENOTSUPP
suffix:semicolon
r_else
id|retval
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_eh_bus_reset_handler&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_scsi_eh_bus_reset_handler
id|zfcp_scsi_eh_bus_reset_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|scpnt-&gt;device-&gt;host
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bus reset because of problems with &quot;
l_string|&quot;unit 0x%016Lx&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|unit-&gt;port-&gt;adapter
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_scsi_eh_host_reset_handler&n; *&n; * purpose:&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_scsi_eh_host_reset_handler
id|zfcp_scsi_eh_host_reset_handler
c_func
(paren
r_struct
id|scsi_cmnd
op_star
id|scpnt
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
op_assign
id|scpnt-&gt;device-&gt;host
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
id|unit
op_assign
(paren
r_struct
id|zfcp_unit
op_star
)paren
id|scpnt-&gt;device-&gt;hostdata
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;host reset because of problems with &quot;
l_string|&quot;unit 0x%016Lx&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_erp_wait
c_func
(paren
id|unit-&gt;port-&gt;adapter
)paren
suffix:semicolon
id|retval
op_assign
id|SUCCESS
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|scsi_host-&gt;host_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_adapter_scsi_register
id|zfcp_adapter_scsi_register
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_static
r_int
r_int
id|unique_id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* register adapter as SCSI host with mid layer of SCSI stack */
id|adapter-&gt;scsi_host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|zfcp_data.scsi_host_template
comma
r_sizeof
(paren
r_struct
id|zfcp_adapter
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;scsi_host
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: registration with SCSI stack failed &quot;
l_string|&quot;for adapter %s &quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;host registered, scsi_host=%p&bslash;n&quot;
comma
id|adapter-&gt;scsi_host
)paren
suffix:semicolon
multiline_comment|/* tell the SCSI stack some characteristics of this adapter */
id|adapter-&gt;scsi_host-&gt;max_id
op_assign
l_int|1
suffix:semicolon
id|adapter-&gt;scsi_host-&gt;max_lun
op_assign
l_int|1
suffix:semicolon
id|adapter-&gt;scsi_host-&gt;max_channel
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;scsi_host-&gt;unique_id
op_assign
id|unique_id
op_increment
suffix:semicolon
multiline_comment|/* FIXME */
id|adapter-&gt;scsi_host-&gt;max_cmd_len
op_assign
id|ZFCP_MAX_SCSI_CMND_LENGTH
suffix:semicolon
multiline_comment|/*&n;&t; * Reverse mapping of the host number to avoid race condition&n;&t; */
id|adapter-&gt;scsi_host_no
op_assign
id|adapter-&gt;scsi_host-&gt;host_no
suffix:semicolon
multiline_comment|/*&n;&t; * save a pointer to our own adapter data structure within&n;&t; * hostdata field of SCSI host data structure&n;&t; */
id|adapter-&gt;scsi_host-&gt;hostdata
(braket
l_int|0
)braket
op_assign
(paren
r_int
r_int
)paren
id|adapter
suffix:semicolon
r_if
c_cond
(paren
id|scsi_add_host
c_func
(paren
id|adapter-&gt;scsi_host
comma
op_amp
id|adapter-&gt;ccw_device-&gt;dev
)paren
)paren
(brace
id|scsi_host_put
c_func
(paren
id|adapter-&gt;scsi_host
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_REGISTERED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_void
DECL|function|zfcp_adapter_scsi_unregister
id|zfcp_adapter_scsi_unregister
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_struct
id|Scsi_Host
op_star
id|shost
suffix:semicolon
id|shost
op_assign
id|adapter-&gt;scsi_host
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|shost
)paren
r_return
suffix:semicolon
id|scsi_remove_host
c_func
(paren
id|shost
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|shost
)paren
suffix:semicolon
id|adapter-&gt;scsi_host
op_assign
l_int|NULL
suffix:semicolon
id|adapter-&gt;scsi_host_no
op_assign
l_int|0
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_REGISTERED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|zfcp_fsf_start_scsi_er_timer
id|zfcp_fsf_start_scsi_er_timer
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
id|adapter-&gt;scsi_er_timer.function
op_assign
id|zfcp_fsf_scsi_er_timeout_handler
suffix:semicolon
id|adapter-&gt;scsi_er_timer.data
op_assign
(paren
r_int
r_int
)paren
id|adapter
suffix:semicolon
id|adapter-&gt;scsi_er_timer.expires
op_assign
id|jiffies
op_plus
id|ZFCP_SCSI_ER_TIMEOUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * ZFCP_DEFINE_SCSI_ATTR&n; * @_name:   name of show attribute&n; * @_format: format string&n; * @_value:  value to print&n; *&n; * Generates attribute for a unit.&n; */
DECL|macro|ZFCP_DEFINE_SCSI_ATTR
mdefine_line|#define ZFCP_DEFINE_SCSI_ATTR(_name, _format, _value)                    &bslash;&n;static ssize_t zfcp_sysfs_scsi_##_name##_show(struct device *dev,        &bslash;&n;                                              char *buf)                 &bslash;&n;{                                                                        &bslash;&n;        struct scsi_device *sdev;                                        &bslash;&n;        struct zfcp_unit *unit;                                          &bslash;&n;                                                                         &bslash;&n;        sdev = to_scsi_device(dev);                                      &bslash;&n;        unit = sdev-&gt;hostdata;                                           &bslash;&n;        return sprintf(buf, _format, _value);                            &bslash;&n;}                                                                        &bslash;&n;                                                                         &bslash;&n;static DEVICE_ATTR(_name, S_IRUGO, zfcp_sysfs_scsi_##_name##_show, NULL);
id|ZFCP_DEFINE_SCSI_ATTR
c_func
(paren
id|hba_id
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_DEFINE_SCSI_ATTR
c_func
(paren
id|wwpn
comma
l_string|&quot;0x%016llx&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|ZFCP_DEFINE_SCSI_ATTR
c_func
(paren
id|fcp_lun
comma
l_string|&quot;0x%016llx&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
DECL|variable|zfcp_sysfs_sdev_attrs
r_static
r_struct
id|device_attribute
op_star
id|zfcp_sysfs_sdev_attrs
(braket
)braket
op_assign
(brace
op_amp
id|dev_attr_fcp_lun
comma
op_amp
id|dev_attr_wwpn
comma
op_amp
id|dev_attr_hba_id
comma
l_int|NULL
)brace
suffix:semicolon
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
eof
