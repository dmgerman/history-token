multiline_comment|/*&n; *&n; * linux/drivers/s390/scsi/zfcp_fsf.c&n; *&n; * FCP adapter driver for IBM eServer zSeries&n; *&n; * Copyright 2002 IBM Corporation&n; * Author(s): Martin Peschke &lt;mpeschke@de.ibm.com&gt;&n; *            Raimund Schroeder &lt;raimund.schroeder@de.ibm.com&gt;&n; *            Aron Zeh &lt;arzeh@de.ibm.com&gt;&n; *            Wolfgang Taphorn &lt;taphorn@de.ibm.com&gt;&n; *            Stefan Bader &lt;stefan.bader@de.ibm.com&gt;&n; *            Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/* this drivers version (do not edit !!! generated and updated by cvs) */
DECL|macro|ZFCP_FSF_C_REVISION
mdefine_line|#define ZFCP_FSF_C_REVISION &quot;$Revision: 1.16 $&quot;
macro_line|#include &quot;zfcp_ext.h&quot;
r_static
r_int
id|zfcp_fsf_exchange_config_data_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_open_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_close_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_close_physical_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_open_unit_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_close_unit_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_fcp_command_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_fcp_command_task_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_fcp_command_task_management_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_abort_fcp_command_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_generic_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_status_read_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_inline
r_int
id|zfcp_fsf_req_create_sbal_check
c_func
(paren
r_int
r_int
op_star
comma
r_struct
id|zfcp_qdio_queue
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_struct
id|zfcp_fsf_req
op_star
id|zfcp_fsf_req_get
c_func
(paren
r_int
comma
id|mempool_t
op_star
)paren
suffix:semicolon
r_static
r_struct
id|zfcp_fsf_req
op_star
id|zfcp_fsf_req_alloc
c_func
(paren
r_struct
id|zfcp_adapter
op_star
comma
id|u32
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_req_send
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
comma
r_struct
id|timer_list
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_protstatus_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_fsfstatus_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_fsfstatus_qual_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_req_dispatch
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_fsf_req_dismiss
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
multiline_comment|/* association between FSF command and FSF QTCB type */
DECL|variable|fsf_qtcb_type
r_static
id|u32
id|fsf_qtcb_type
(braket
)braket
op_assign
(brace
(braket
id|FSF_QTCB_FCP_CMND
)braket
op_assign
id|FSF_IO_COMMAND
comma
(braket
id|FSF_QTCB_ABORT_FCP_CMND
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_OPEN_PORT_WITH_DID
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_OPEN_LUN
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_CLOSE_LUN
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_CLOSE_PORT
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_SEND_ELS
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_SEND_GENERIC
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
)braket
op_assign
id|FSF_CONFIG_COMMAND
)brace
suffix:semicolon
multiline_comment|/****************************************************************/
multiline_comment|/*************** FSF related Functions  *************************/
multiline_comment|/****************************************************************/
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA&t;&t;&t;ZFCP_LOG_AREA_FSF
DECL|macro|ZFCP_LOG_AREA_PREFIX
mdefine_line|#define ZFCP_LOG_AREA_PREFIX&t;&t;ZFCP_LOG_AREA_PREFIX_FSF
multiline_comment|/*&n; * function:&t;zfcp_fsf_req_alloc&n; *&n; * purpose:     Obtains an fsf_req and potentially a qtcb (for all but &n; *              unsolicited requests) via helper functions&n; *              Does some initial fsf request set-up.&n; *              &n; * returns:&t;pointer to allocated fsf_req if successfull&n; *              NULL otherwise&n; *&n; * locks:       none&n; *&n; */
r_static
r_struct
id|zfcp_fsf_req
op_star
DECL|function|zfcp_fsf_req_alloc
id|zfcp_fsf_req_alloc
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
id|u32
id|fsf_cmd
comma
r_int
id|kmalloc_flags
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_cmd
)paren
(brace
r_case
id|FSF_QTCB_FCP_CMND
suffix:colon
r_case
id|FSF_QTCB_ABORT_FCP_CMND
suffix:colon
id|fsf_req
op_assign
id|zfcp_fsf_req_get
c_func
(paren
id|kmalloc_flags
comma
id|adapter-&gt;pool.fcp_command_fsf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req
op_logical_and
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_POOL
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * watch low mem buffer&n;&t;&t;&t; * Note: If the command is reset or aborted, two&n;&t;&t;&t; * timeouts (this and the SCSI ER one) will be started&n;&t;&t;&t; * for the command. There is no problem however as&n;&t;&t;&t; * the first expired timer will call adapter_reopen&n;&t;&t;&t; * which will delete the other &n;&t;&t;&t; */
id|adapter-&gt;pool.fcp_command_fsf_timer.expires
op_assign
id|jiffies
op_plus
id|ZFCP_ERP_SCSI_LOW_MEM_TIMEOUT
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|adapter-&gt;pool.fcp_command_fsf_timer
)paren
suffix:semicolon
)brace
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|5
comma
l_string|&quot;fsfa_fcp&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req
op_logical_and
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_POOL
)paren
)paren
)paren
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|5
comma
l_string|&quot;fsfa_pl&quot;
)paren
suffix:semicolon
macro_line|#endif /* ZFCP_DEBUG_REQUESTS */
r_break
suffix:semicolon
r_case
id|FSF_QTCB_OPEN_PORT_WITH_DID
suffix:colon
r_case
id|FSF_QTCB_OPEN_LUN
suffix:colon
r_case
id|FSF_QTCB_CLOSE_LUN
suffix:colon
r_case
id|FSF_QTCB_CLOSE_PORT
suffix:colon
r_case
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
suffix:colon
r_case
id|FSF_QTCB_SEND_ELS
suffix:colon
r_case
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
suffix:colon
r_case
id|FSF_QTCB_SEND_GENERIC
suffix:colon
id|fsf_req
op_assign
id|zfcp_fsf_req_get
c_func
(paren
id|kmalloc_flags
comma
id|adapter-&gt;pool.erp_fsf
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|5
comma
l_string|&quot;fsfa_erp&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req
op_logical_and
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_POOL
)paren
)paren
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|5
comma
l_string|&quot;fsfa_pl&quot;
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
r_break
suffix:semicolon
r_case
id|FSF_QTCB_UNSOLICITED_STATUS
suffix:colon
id|fsf_req
op_assign
id|mempool_alloc
c_func
(paren
id|adapter-&gt;pool.status_read_fsf
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req
)paren
(brace
id|memset
c_func
(paren
id|fsf_req
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zfcp_fsf_req
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_POOL
suffix:semicolon
)brace
r_else
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: could not find free fsf_req&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|5
comma
l_string|&quot;fsfa_sr&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|5
comma
l_string|&quot;fsfa_pl&quot;
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An attempt to send an unsupported &quot;
l_string|&quot;command has been detected. &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_cmd
)paren
suffix:semicolon
)brace
singleline_comment|//switch(fsf_cmd)
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|fsf_req
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Out of memory. Allocation of FSF &quot;
l_string|&quot;request structure failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;FSF request allocated at 0x%lx, &quot;
l_string|&quot;adapter 0x%lx (%s)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
(paren
r_int
r_int
)paren
id|adapter
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|5
comma
op_amp
id|fsf_req
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;qtcb
)paren
)paren
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|5
comma
op_amp
id|fsf_req-&gt;qtcb
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
r_return
id|fsf_req
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_req_free&n; *&n; * purpose:     Frees the memory of an fsf_req (and potentially a qtcb) or&n; *              returns it into the pool via helper functions.&n; *&n; * returns:     sod all&n; *&n; * locks:       none&n; */
r_void
DECL|function|zfcp_fsf_req_free
id|zfcp_fsf_req_free
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;fsf_command
)paren
(brace
r_case
id|FSF_QTCB_FCP_CMND
suffix:colon
r_case
id|FSF_QTCB_ABORT_FCP_CMND
suffix:colon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_POOL
)paren
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|adapter-&gt;pool.fcp_command_fsf_timer
)paren
suffix:semicolon
id|mempool_free
c_func
(paren
id|fsf_req
comma
id|adapter-&gt;pool.fcp_command_fsf
)paren
suffix:semicolon
)brace
r_else
id|kfree
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_OPEN_PORT_WITH_DID
suffix:colon
r_case
id|FSF_QTCB_OPEN_LUN
suffix:colon
r_case
id|FSF_QTCB_CLOSE_LUN
suffix:colon
r_case
id|FSF_QTCB_CLOSE_PORT
suffix:colon
r_case
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
suffix:colon
r_case
id|FSF_QTCB_SEND_ELS
suffix:colon
r_case
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
suffix:colon
r_case
id|FSF_QTCB_SEND_GENERIC
suffix:colon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_POOL
)paren
id|mempool_free
c_func
(paren
id|fsf_req
comma
id|adapter-&gt;pool.erp_fsf
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_UNSOLICITED_STATUS
suffix:colon
id|mempool_free
c_func
(paren
id|fsf_req
comma
id|adapter-&gt;pool.status_read_fsf
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; *&n; * note: qdio queues shall be down (no ongoing inbound processing)&n; */
r_int
DECL|function|zfcp_fsf_req_dismiss_all
id|zfcp_fsf_req_dismiss_all
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
op_star
id|tmp
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|fsf_req
comma
id|tmp
comma
op_amp
id|adapter-&gt;fsf_req_list_head
comma
id|list
)paren
id|zfcp_fsf_req_dismiss
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/* wait_event_timeout? */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_head
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;fsf req list of adapter %s not yet empty&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for woken intiators to clean up their requests */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|ZFCP_FSFREQ_CLEANUP_TIMEOUT
)paren
suffix:semicolon
)brace
multiline_comment|/* consistency check */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: There are still %d FSF requests pending &quot;
l_string|&quot;on adapter %s after cleanup.&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_fsf_req_dismiss
id|zfcp_fsf_req_dismiss
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_DISMISSED
suffix:semicolon
id|zfcp_fsf_req_complete
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_complete&n; *&n; * purpose:&t;Updates active counts and timers for openfcp-reqs&n; *              May cleanup request after req_eval returns&n; *&n; * returns:&t;0 - success&n; *&t;&t;!0 - failure&n; *&n; * context:&t;&n; */
r_int
DECL|function|zfcp_fsf_req_complete
id|zfcp_fsf_req_complete
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|cleanup
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
multiline_comment|/* do some statistics */
id|atomic_dec
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;fsf_command
op_eq
id|FSF_QTCB_UNSOLICITED_STATUS
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Status read response received&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Note: all cleanup handling is done in the callchain of&n;&t;&t; * the function call-chain below.&n;&t;&t; */
id|zfcp_fsf_status_read_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
id|zfcp_fsf_protstatus_eval
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * fsf_req may be deleted due to waking up functions, so &n;&t; * cleanup is saved here and used later &n;&t; */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_CLEANUP
)paren
)paren
id|cleanup
op_assign
l_int|1
suffix:semicolon
r_else
id|cleanup
op_assign
l_int|0
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_COMPLETED
suffix:semicolon
multiline_comment|/* cleanup request if requested by initiator */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|cleanup
)paren
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;removing FSF request 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * lock must not be held here since it will be&n;&t;&t; * grabed by the called routine, too&n;&t;&t; */
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* notify initiator waiting for the requests completion */
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;waking initiator of FSF request 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FIXME: Race! We must not access fsf_req here as it might have been&n;&t;&t; * cleaned up already due to the set ZFCP_STATUS_FSFREQ_COMPLETED&n;&t;&t; * flag. It&squot;s an improbable case. But, we have the same paranoia for&n;&t;&t; * the cleanup flag already.&n;&t;&t; * Might better be handled using complete()?&n;&t;&t; * (setting the flag and doing wakeup ought to be atomic&n;&t;&t; *  with regard to checking the flag as long as waitqueue is&n;&t;&t; *  part of the to be released structure)&n;&t;&t; */
id|wake_up
c_func
(paren
op_amp
id|fsf_req-&gt;completion_wq
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_protstatus_eval&n; *&n; * purpose:&t;evaluates the QTCB of the finished FSF request&n; *&t;&t;and initiates appropriate actions&n; *&t;&t;(usually calling FSF command specific handlers)&n; *&n; * returns:&t;&n; *&n; * context:&t;&n; *&n; * locks:&n; */
r_static
r_int
DECL|function|zfcp_fsf_protstatus_eval
id|zfcp_fsf_protstatus_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;QTCB is at 0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req-&gt;qtcb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_DISMISSED
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;fsf_req 0x%lx has been dismissed&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
multiline_comment|/* only for SCSI cmnds. */
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;dismiss&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_protstatus
suffix:semicolon
)brace
multiline_comment|/* log additional information provided by FSF (if any) */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;qtcb-&gt;header.log_length
)paren
)paren
(brace
multiline_comment|/* do not trust them ;-) */
r_if
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.log_start
OG
id|ZFCP_QTCB_SIZE
)paren
(brace
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: ULP (FSF logging) log data starts &quot;
l_string|&quot;beyond end of packet header. Ignored. &quot;
l_string|&quot;(start=%i, size=%li)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.log_start
comma
id|ZFCP_QTCB_SIZE
)paren
suffix:semicolon
r_goto
id|forget_log
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|fsf_req-&gt;qtcb-&gt;header.log_start
op_plus
id|fsf_req-&gt;qtcb-&gt;header.log_length
)paren
OG
id|ZFCP_QTCB_SIZE
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: ULP (FSF logging) log data ends &quot;
l_string|&quot;beyond end of packet header. Ignored. &quot;
l_string|&quot;(start=%i, length=%i, size=%li)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.log_start
comma
id|fsf_req-&gt;qtcb-&gt;header.log_length
comma
id|ZFCP_QTCB_SIZE
)paren
suffix:semicolon
r_goto
id|forget_log
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;ULP log data: &bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_char
op_star
)paren
id|fsf_req-&gt;qtcb
op_plus
id|fsf_req-&gt;qtcb-&gt;header.log_start
comma
id|fsf_req-&gt;qtcb-&gt;header.log_length
)paren
suffix:semicolon
)brace
id|forget_log
suffix:colon
multiline_comment|/* evaluate FSF Protocol Status */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status
)paren
(brace
r_case
id|FSF_PROT_GOOD
suffix:colon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;FSF_PROT_GOOD&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_FSF_STATUS_PRESENTED
suffix:colon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;FSF_PROT_FSF_STATUS_PRESENTED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_QTCB_VERSION_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_QTCB_VERSION_ERROR&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* DEBUG */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;fsf_req=0x%lx, qtcb=0x%lx (0x%lx, 0x%lx)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
(paren
r_int
r_int
)paren
id|fsf_req-&gt;qtcb
comma
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
comma
(paren
r_int
r_int
)paren
(paren
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
)paren
)paren
op_member_access_from_pointer
id|qtcb
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
)paren
comma
r_sizeof
(paren
r_struct
id|zfcp_fsf_req
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The adapter %s contains &quot;
l_string|&quot;microcode of version 0x%x, the device driver &quot;
l_string|&quot;only supports 0x%x. Aborting.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
dot
id|version_error.fsf_version
comma
id|ZFCP_QTCB_VERSION
)paren
suffix:semicolon
multiline_comment|/* stop operation for this adapter */
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_ver_err&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;qverserr&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_SEQ_NUMB_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_SEQ_NUMB_ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Sequence number mismatch between &quot;
l_string|&quot;driver (0x%x) and adapter %s (0x%x). &quot;
l_string|&quot;Restarting all operations on this adapter.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;prefix.req_seq_no
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
dot
id|sequence_error.exp_req_seq_no
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
l_string|&quot;exp_seq!&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
dot
id|sequence_error.exp_req_seq_no
comma
l_int|4
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
l_string|&quot;qtcb_seq!&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.req_seq_no
comma
l_int|4
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_seq_err&quot;
)paren
suffix:semicolon
multiline_comment|/* restart operation on this adapter */
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;seqnoerr&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_UNSUPP_QTCB_TYPE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_UNSUP_QTCB_TYPE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: Packet header type used by the &quot;
l_string|&quot;device driver is incompatible with &quot;
l_string|&quot;that used on adapter %s. &quot;
l_string|&quot;Stopping all operations on this adapter.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;fsf_req=0x%lx, qtcb=0x%lx (0x%lx, 0x%lx)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
(paren
r_int
r_int
)paren
id|fsf_req-&gt;qtcb
comma
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
comma
(paren
r_int
r_int
)paren
(paren
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
)paren
)paren
op_member_access_from_pointer
id|qtcb
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
)paren
comma
r_sizeof
(paren
r_struct
id|zfcp_fsf_req
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_unsup_qtcb&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;unsqtcbt&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_HOST_CONNECTION_INITIALIZING
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PROT_HOST_CONNECTION_INITIALIZING&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;hconinit&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_HOST_CON_INIT
comma
op_amp
(paren
id|adapter-&gt;status
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;prot_con_init&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_DUPLICATE_REQUEST_ID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_DUPLICATE_REQUEST_IDS&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;qtcb
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The request identifier  0x%Lx &quot;
l_string|&quot;to the adapter %s is ambiguous. &quot;
l_string|&quot;Stopping all operations on this &quot;
l_string|&quot;adapter.&bslash;n&quot;
comma
op_star
(paren
r_int
r_int
r_int
op_star
)paren
(paren
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.support
dot
id|req_handle
)paren
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The request identifier  0x%lx &quot;
l_string|&quot;to the adapter %s is ambiguous. &quot;
l_string|&quot;Stopping all operations on this &quot;
l_string|&quot;adapter. &quot;
l_string|&quot;(bug: got this for an unsolicited &quot;
l_string|&quot;status read request)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_dup_id&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;dupreqid&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_LINK_DOWN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PROT_LINK_DOWN&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * &squot;test and set&squot; is not atomic here -&n;&t;&t; * it&squot;s ok as long as calls to our response queue handler&n;&t;&t; * (and thus execution of this code here) are serialized&n;&t;&t; * by the qdio module&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
dot
id|locallink_error.code
)paren
(brace
r_case
id|FSF_PSQ_LINK_NOLIGHT
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter %s &quot;
l_string|&quot;is down (no light detected).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PSQ_LINK_WRAPPLUG
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter %s &quot;
l_string|&quot;is down (wrap plug detected).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PSQ_LINK_NOFCP
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter %s &quot;
l_string|&quot;is down (adjacent node on &quot;
l_string|&quot;link does not support FCP).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter %s &quot;
l_string|&quot;is down &quot;
l_string|&quot;(warning: unknown reason &quot;
l_string|&quot;code).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Due to the &squot;erp failed&squot; flag the adapter won&squot;t&n;&t;&t;&t; * be recovered but will be just set to &squot;blocked&squot;&n;&t;&t;&t; * state. All subordinary devices will have state&n;&t;&t;&t; * &squot;blocked&squot; and &squot;erp failed&squot;, too.&n;&t;&t;&t; * Thus the adapter is still able to provide&n;&t;&t;&t; * &squot;link up&squot; status without being flooded with&n;&t;&t;&t; * requests.&n;&t;&t;&t; * (note: even &squot;close port&squot; is not permitted)&n;&t;&t;&t; */
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Stopping all operations for adapter &quot;
l_string|&quot;%s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;prot_link_down&quot;
)paren
suffix:semicolon
)brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_REEST_QUEUE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PROT_REEST_QUEUE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;prot_reest_queue&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter with &quot;
l_string|&quot;%s was re-plugged. &quot;
l_string|&quot;Re-starting operations on this adapter.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* All ports should be marked as ready to run again */
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;reestque&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_ERROR_STATE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_ERROR_STATE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The adapter %s &quot;
l_string|&quot;has entered the error state. &quot;
l_string|&quot;Restarting all operations on this &quot;
l_string|&quot;adapter.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_err_sta&quot;
)paren
suffix:semicolon
multiline_comment|/* restart operation on this adapter */
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;proterrs&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Transfer protocol status information &quot;
l_string|&quot;provided by the adapter %s &quot;
l_string|&quot;is not compatible with the device driver. &quot;
l_string|&quot;Stopping all operations on this adapter. &quot;
l_string|&quot;(debug info 0x%x).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;fsf_req=0x%lx, qtcb=0x%lx (0x%lx, 0x%lx)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
(paren
r_int
r_int
)paren
id|fsf_req-&gt;qtcb
comma
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
comma
(paren
r_int
r_int
)paren
(paren
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
)paren
)paren
op_member_access_from_pointer
id|qtcb
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|fsf_req
)paren
op_amp
l_int|0xFFFFFF00
)paren
comma
r_sizeof
(paren
r_struct
id|zfcp_fsf_req
)paren
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|fsf_req-&gt;qtcb
comma
id|ZFCP_QTCB_SIZE
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
)brace
id|skip_protstatus
suffix:colon
multiline_comment|/*&n;&t; * always call specific handlers to give them a chance to do&n;&t; * something meaningful even in error cases&n;&t; */
id|zfcp_fsf_fsfstatus_eval
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_fsfstatus_eval&n; *&n; * purpose:&t;evaluates FSF status of completed FSF request&n; *&t;&t;and acts accordingly&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_fsfstatus_eval
id|zfcp_fsf_fsfstatus_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
)paren
(brace
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF Status */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_UNKNOWN_COMMAND
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_UNKNOWN_COMMAND&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Command issued by the device driver is &quot;
l_string|&quot;not known by the adapter %s &quot;
l_string|&quot;Stopping all operations on this adapter. &quot;
l_string|&quot;(debug info 0x%x).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_command
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_unknown&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|fsf_req-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;unknownc&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_FCP_RSP_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_FCP_RSP_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;FCP Sense data will be presented to the &quot;
l_string|&quot;SCSI stack.&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;fsf_s_rsp&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_astatus&quot;
)paren
suffix:semicolon
id|zfcp_fsf_fsfstatus_qual_eval
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
multiline_comment|/*&n;&t; * always call specific handlers to give them a chance to do&n;&t; * something meaningful even in error cases&n;&t; */
id|zfcp_fsf_req_dispatch
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_fsfstatus_qual_eval&n; *&n; * purpose:&t;evaluates FSF status-qualifier of completed FSF request&n; *&t;&t;and acts accordingly&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_fsfstatus_qual_eval
id|zfcp_fsf_fsfstatus_qual_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_FCP_RSP_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_FCP_RSP_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;fsf_sq_rsp&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_RETRY_IF_POSSIBLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_RETRY_IF_POSSIBLE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* The SCSI-stack may now issue retries or escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_sq_retry&quot;
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqretry&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_COMMAND_ABORTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_COMMAND_ABORTED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Carry the aborted state on to upper layer */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_sq_abort&quot;
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqabort&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ABORTED
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_NO_RECOM
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SQ_NO_RECOM&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_no_rec&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: No recommendation could be given for a&quot;
l_string|&quot;problem on the adapter %s &quot;
l_string|&quot;Stopping all operations on this adapter. &quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|fsf_req-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqnrecom&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_PROGRAMMING_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SQ_ULP_PROGRAMMING_ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An illegal amount of data was attempted &quot;
l_string|&quot;to be sent to the adapter %s &quot;
l_string|&quot;Stopping all operations on this adapter. &quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_ulp_err&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|fsf_req-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
r_case
id|FSF_SQ_NO_RETRY_POSSIBLE
suffix:colon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
multiline_comment|/* dealt with in the respective functions */
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Additional status info could &quot;
l_string|&quot;not be interpreted properly.&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;squndef&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_req_dispatch&n; *&n; * purpose:&t;calls the appropriate command specific handler&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_req_dispatch
id|zfcp_fsf_req_dispatch
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;fsf_req=0x%lx, QTCB=0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
(paren
r_int
r_int
)paren
(paren
id|fsf_req-&gt;qtcb
)paren
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_char
op_star
)paren
id|fsf_req-&gt;qtcb
comma
id|ZFCP_QTCB_SIZE
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|fsf_req-&gt;fsf_command
)paren
(brace
r_case
id|FSF_QTCB_FCP_CMND
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_QTCB_FCP_CMND&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_send_fcp_command_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_ABORT_FCP_CMND
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_ABORT_FCP_CMND&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_abort_fcp_command_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_SEND_GENERIC
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_SEND_GENERIC&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_send_generic_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|zfcp_erp_fsf_req_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_OPEN_PORT_WITH_DID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_OPEN_PORT_WITH_DID&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_open_port_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|zfcp_erp_fsf_req_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_OPEN_LUN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_OPEN_LUN&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_open_unit_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|zfcp_erp_fsf_req_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_CLOSE_LUN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_CLOSE_LUN&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_close_unit_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|zfcp_erp_fsf_req_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_CLOSE_PORT
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_CLOSE_PORT&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_close_port_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|zfcp_erp_fsf_req_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_CLOSE_PHYSICAL_PORT&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_close_physical_port_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|zfcp_erp_fsf_req_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_EXCHANGE_CONFIG_DATA&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_exchange_config_data_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|zfcp_erp_fsf_req_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_UNKNOWN&bslash;n&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Command issued by the device driver is &quot;
l_string|&quot;not supported by the adapter %s &quot;
l_string|&quot;(debug info 0x%lx 0x%x).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
id|fsf_req-&gt;fsf_command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;fsf_command
op_ne
id|fsf_req-&gt;qtcb-&gt;header.fsf_command
)paren
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Command issued by the device driver differs &quot;
l_string|&quot;from the command returned by the adapter %s &quot;
l_string|&quot;(debug info 0x%x, 0x%x).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
comma
id|fsf_req-&gt;fsf_command
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_command
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_status_read&n; *&n; * purpose:&t;initiates a Status Read command at the specified adapter&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_fsf_status_read
id|zfcp_fsf_status_read
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|req_flags
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffere
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|req_queue
op_assign
op_amp
id|adapter-&gt;request_queue
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_UNSOLICITED_STATUS
comma
op_amp
id|lock_flags
comma
id|req_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create an &quot;
l_string|&quot;unsolicited status buffer for &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|failed_req_create
suffix:semicolon
)brace
id|status_buffer
op_assign
id|mempool_alloc
c_func
(paren
id|adapter-&gt;pool.status_read_buf
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status_buffer
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: could not get some buffer&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_buf
suffix:semicolon
)brace
id|memset
c_func
(paren
id|status_buffer
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;data.status_read.buffer
op_assign
id|status_buffer
suffix:semicolon
multiline_comment|/* insert pointer to respective buffer */
id|buffere
op_assign
id|req_queue-&gt;buffer
(braket
id|fsf_req-&gt;sbal_index
)braket
op_member_access_from_pointer
id|element
suffix:semicolon
id|buffere
(braket
l_int|2
)braket
dot
id|addr
op_assign
(paren
r_void
op_star
)paren
id|status_buffer
suffix:semicolon
id|buffere
(braket
l_int|2
)braket
dot
id|length
op_assign
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Could not set-up unsolicited status &quot;
l_string|&quot;environment.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_req_send
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Status Read request initiated &quot;
l_string|&quot;(adapter busid=%s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
l_string|&quot;unso&quot;
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|out
suffix:semicolon
id|failed_req_send
suffix:colon
id|mempool_free
c_func
(paren
id|status_buffer
comma
id|adapter-&gt;pool.status_read_buf
)paren
suffix:semicolon
id|failed_buf
suffix:colon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|failed_req_create
suffix:colon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|zfcp_fsf_status_read_port_closed
id|zfcp_fsf_status_read_port_closed
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|status_buffer
op_assign
id|fsf_req-&gt;data.status_read.buffer
suffix:semicolon
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
r_if
c_cond
(paren
id|port-&gt;d_id
op_eq
(paren
id|status_buffer-&gt;d_id
op_amp
id|ZFCP_DID_MASK
)paren
)paren
r_break
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
op_logical_or
(paren
id|port-&gt;d_id
op_ne
(paren
id|status_buffer-&gt;d_id
op_amp
id|ZFCP_DID_MASK
)paren
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Re-open port indication received for the &quot;
l_string|&quot;non-existing port with DID 0x%3.3x, on &quot;
l_string|&quot;the adapter %s. Ignored.&bslash;n&quot;
comma
id|status_buffer-&gt;d_id
op_amp
id|ZFCP_DID_MASK
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status_buffer-&gt;status_subtype
)paren
(brace
r_case
id|FSF_STATUS_READ_SUB_CLOSE_PHYS_PORT
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_STATUS_READ_SUB_CLOSE_PHYS_PORT&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_pc_phys:&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_SUB_ERROR_PORT
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_SUB_ERROR_PORT&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;unsol_pc_err:&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_shutdown
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;unsol_unk_sub:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|status_buffer-&gt;status_subtype
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Undefined status subtype received &quot;
l_string|&quot;for a re-open indication on the port with &quot;
l_string|&quot;DID 0x%3.3x, on the adapter &quot;
l_string|&quot;%s. Ignored. (debug info 0x%x)&bslash;n&quot;
comma
id|status_buffer-&gt;d_id
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|status_buffer-&gt;status_subtype
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_status_read_handler&n; *&n; * purpose:&t;is called for finished Open Port command&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_status_read_handler
id|zfcp_fsf_status_read_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
op_assign
id|fsf_req-&gt;data.status_read.buffer
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_DISMISSED
)paren
(brace
id|mempool_free
c_func
(paren
id|status_buffer
comma
id|adapter-&gt;pool.status_read_buf
)paren
suffix:semicolon
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status_buffer-&gt;status_type
)paren
(brace
r_case
id|FSF_STATUS_READ_PORT_CLOSED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_PORT_CLOSED&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_pclosed:&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|status_buffer-&gt;d_id
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_fsf_status_read_port_closed
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_INCOMING_ELS
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_INCOMING_ELS&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_els:&quot;
)paren
suffix:semicolon
id|zfcp_fsf_incoming_els
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_BIT_ERROR_THRESHOLD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_BIT_ERROR_THRESHOLD&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_bit_err:&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Bit error threshold data received:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|status_buffer
comma
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_LINK_DOWN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_LINK_DOWN&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Unneccessary, ignoring.... */
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_LINK_UP
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_LINK_UP&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;unsol_link_up:&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to the adapter %s &quot;
l_string|&quot;was re-plugged. &quot;
l_string|&quot;Re-starting operations on this adapter..&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* All ports should be marked as ready to run again */
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;unsol_unknown:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|status_buffer-&gt;status_type
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unsolicited status packet of unknown &quot;
l_string|&quot;type was received by the zfcp-driver &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|status_buffer-&gt;status_type
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Dump of status_read_buffer 0x%lx:&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|status_buffer
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
id|status_buffer
comma
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mempool_free
c_func
(paren
id|status_buffer
comma
id|adapter-&gt;pool.status_read_buf
)paren
suffix:semicolon
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * recycle buffer and start new request repeat until outbound&n;&t; * queue is empty or adapter shutdown is requested&n;&t; */
multiline_comment|/*&n;&t; * FIXME(qdio):&n;&t; * we may wait in the req_create for 5s during shutdown, so&n;&t; * qdio_cleanup will have to wait at least that long before returning&n;&t; * with failure to allow us a proper cleanup under all circumstances&n;&t; */
multiline_comment|/*&n;&t; * FIXME:&n;&t; * allocation failure possible? (Is this code needed?)&n;&t; */
id|retval
op_assign
id|zfcp_fsf_status_read
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Outbound queue busy. &quot;
l_string|&quot;Could not create use an &quot;
l_string|&quot;unsolicited status read request for &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* temporary fix to avoid status read buffer shortage */
id|adapter-&gt;status_read_failed
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ZFCP_STATUS_READS_RECOM
op_minus
id|adapter-&gt;status_read_failed
)paren
OL
id|ZFCP_STATUS_READ_FAILED_THRESHOLD
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;restart adapter due to status read &quot;
l_string|&quot;buffer shortage (busid %s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_abort_fcp_command&n; *&n; * purpose:&t;tells FSF to abort a running SCSI command&n; *&n; * returns:&t;address of initiated FSF request&n; *&t;&t;NULL - request could not be initiated&n; *&n; * FIXME(design): should be watched by a timeout !!! &n; * FIXME(design) shouldn&squot;t this be modified to return an int&n; *               also...don&squot;t know how though&n; */
r_struct
id|zfcp_fsf_req
op_star
DECL|function|zfcp_fsf_abort_fcp_command
id|zfcp_fsf_abort_fcp_command
c_func
(paren
r_int
r_int
id|old_req_id
comma
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|req_flags
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|new_fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_ABORT_FCP_CMND
comma
op_amp
id|lock_flags
comma
id|req_flags
comma
op_amp
id|new_fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create an &quot;
l_string|&quot;abort command request on the device with &quot;
l_string|&quot;the FCP-LUN 0x%Lx connected to &quot;
l_string|&quot;the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|new_fsf_req-&gt;data.abort_fcp_command.unit
op_assign
id|unit
suffix:semicolon
multiline_comment|/* set handles of unit and its parent port in QTCB */
id|new_fsf_req-&gt;qtcb-&gt;header.lun_handle
op_assign
id|unit-&gt;handle
suffix:semicolon
id|new_fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|unit-&gt;port-&gt;handle
suffix:semicolon
multiline_comment|/* set handle of request which should be aborted */
id|new_fsf_req-&gt;qtcb-&gt;bottom.support.req_handle
op_assign
(paren
id|u64
)paren
id|old_req_id
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|zfcp_fsf_start_scsi_er_timer
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|new_fsf_req
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an abort command request &quot;
l_string|&quot;for a command on the adapter %s, &quot;
l_string|&quot;port WWPN 0x%Lx and unit LUN 0x%Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|new_fsf_req
)paren
suffix:semicolon
id|new_fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Abort FCP Command request initiated &quot;
l_string|&quot;(adapter busid=%s, port d_id=0x%x, &quot;
l_string|&quot;unit fcp_lun=0x%Lx, old_req_id=0x%lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
(paren
r_int
r_int
)paren
id|unit-&gt;port-&gt;d_id
comma
id|unit-&gt;fcp_lun
comma
id|old_req_id
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|new_fsf_req
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_abort_fcp_command_handler&n; *&n; * purpose:&t;is called for finished Abort FCP Command request&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_abort_fcp_command_handler
id|zfcp_fsf_abort_fcp_command_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|new_fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|new_fsf_req-&gt;data.abort_fcp_command.unit
suffix:semicolon
r_int
r_char
id|status_qual
op_assign
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|new_fsf_req-&gt;adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* do not set ZFCP_STATUS_FSFREQ_ABORTSUCCEEDED */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
r_if
c_cond
(paren
id|status_qual
op_rshift
l_int|4
op_ne
id|status_qual
op_mod
l_int|0xf
)paren
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;fsf_s_phand_nv0&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * In this case a command that was sent prior to a port&n;&t;&t;&t; * reopen was aborted (handles are different). This is&n;&t;&t;&t; * fine.&n;&t;&t;&t; */
)brace
r_else
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier (handle) 0x%x &quot;
l_string|&quot;for the port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s is not valid. This &quot;
l_string|&quot;may happen occasionally.&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header
dot
id|fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
multiline_comment|/* Let&squot;s hope this sorts out the mess */
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv1&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_LUN_HANDLE_NOT_VALID
suffix:colon
r_if
c_cond
(paren
id|status_qual
op_rshift
l_int|4
op_ne
id|status_qual
op_mod
l_int|0xf
)paren
(brace
multiline_comment|/* 2 */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_LUN_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;fsf_s_lhand_nv0&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * In this case a command that was sent prior to a unit&n;&t;&t;&t; * reopen was aborted (handles are different).&n;&t;&t;&t; * This is fine.&n;&t;&t;&t; */
)brace
r_else
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_LUN_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
(paren
l_string|&quot;Warning: Temporary LUN identifier (handle) 0x%x &quot;
l_string|&quot;of the logical unit with FCP-LUN 0x%Lx at &quot;
l_string|&quot;the remote port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s is &quot;
l_string|&quot;not valid. This may happen in rare cases.&quot;
l_string|&quot;Trying to re-establish link.&bslash;n&quot;
comma
id|unit-&gt;handle
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Status qualifier data:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header
dot
id|fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
multiline_comment|/* Let&squot;s hope this sorts out the mess */
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_lhand_nv1&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_FCP_COMMAND_DOES_NOT_EXIST
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_FCP_COMMAND_DOES_NOT_EXIST&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
multiline_comment|/*&n;&t;&t; * debug feature area which records&n;&t;&t; * fsf request sequence numbers&n;&t;&t; */
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;req_dbf
comma
l_int|3
comma
l_string|&quot;no_exist&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;req_dbf
comma
l_int|3
comma
op_amp
id|new_fsf_req-&gt;qtcb-&gt;bottom.support.req_handle
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;fsf_s_no_exist&quot;
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ABORTNOTNEEDED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
multiline_comment|/* 2 */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port &quot;
l_string|&quot;with WWPN 0x%Lx on the adapter %s &quot;
l_string|&quot;needs to be reopened&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
multiline_comment|/* 2 */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
multiline_comment|/* reopening link to port */
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* SCSI stack will escalate */
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header
dot
id|fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
multiline_comment|/* 3 */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ABORTSUCCEEDED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_generic&n; *&n; * purpose:&t;sends a FC request according to FC-GS-3&n; *&n; * returns:&t;address of initiated FSF request&n; *&t;&t;NULL - request could not be initiated &n; */
r_int
DECL|function|zfcp_fsf_send_generic
id|zfcp_fsf_send_generic
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
r_int
r_char
id|timeout
comma
r_int
r_int
op_star
id|lock_flags
comma
r_struct
id|timer_list
op_star
id|timer
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|qdio_buffer
op_star
id|buffer
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffer_element
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|fsf_req-&gt;data.send_generic.port
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
multiline_comment|/* put buffers to the 2 SBALEs after the QTCB */
id|buffer
op_assign
(paren
id|adapter-&gt;request_queue.buffer
(braket
id|fsf_req-&gt;sbal_index
)braket
)paren
suffix:semicolon
id|buffer_element
op_assign
op_amp
(paren
id|buffer-&gt;element
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|buffer_element-&gt;addr
op_assign
id|fsf_req-&gt;data.send_generic.outbuf
suffix:semicolon
id|buffer_element-&gt;length
op_assign
id|fsf_req-&gt;data.send_generic.outbuf_length
suffix:semicolon
id|buffer_element
op_increment
suffix:semicolon
id|buffer_element-&gt;addr
op_assign
id|fsf_req-&gt;data.send_generic.inbuf
suffix:semicolon
id|buffer_element-&gt;length
op_assign
id|fsf_req-&gt;data.send_generic.inbuf_length
suffix:semicolon
id|buffer_element-&gt;flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
multiline_comment|/* settings in QTCB */
id|fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|port-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.support.service_class
op_assign
id|adapter-&gt;fc_service_class
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.support.timeout
op_assign
id|timeout
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
id|timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Out of resources. could not send a &quot;
l_string|&quot;generic services &quot;
l_string|&quot;command via the adapter %s, port &quot;
l_string|&quot;WWPN 0x%Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * fsf_req structure will be cleaned up by higher layer handler&n;&t;&t; */
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Send Generic request initiated &quot;
l_string|&quot;(adapter busido=%s, port d_id=0x%x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
(paren
r_int
r_int
)paren
id|port-&gt;d_id
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_generic_handler&n; *&n; * purpose:&t;is called for finished Send Generic request&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_send_generic_handler
id|zfcp_fsf_send_generic_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
op_assign
id|fsf_req-&gt;data.send_generic.port
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* do not set ZFCP_STATUS_FSFREQ_ABORTSUCCEEDED */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Temporary port identifier (handle) 0x%x &quot;
l_string|&quot;for the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is &quot;
l_string|&quot;not valid. This may happen occasionally.&bslash;n&quot;
comma
id|port-&gt;handle
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phandle_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SERVICE_CLASS_NOT_SUPPORTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SERVICE_CLASS_NOT_SUPPORTED&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;adapter-&gt;fc_service_class
op_le
l_int|3
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The adapter %s does &quot;
l_string|&quot;not support fibre-channel class %d.&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|fsf_req-&gt;adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: The fibre channel class at the adapter &quot;
l_string|&quot;%s is invalid. &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|fsf_req-&gt;adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
multiline_comment|/* stop operation for this adapter */
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_class_nsup&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_GENERIC_COMMAND_REJECTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_GENERIC_COMMAND_REJECTED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;warning: The port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is&quot;
l_string|&quot;rejected a generic services command.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_gcom_rej&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_REQUEST_BUF_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_REQUEST_BUF_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is&quot;
l_string|&quot;rejected a generic services command &quot;
l_string|&quot;due to invalid request buffer.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_reqiv&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_RESPONSE_BUF_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_RESPONSE_BUF_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is&quot;
l_string|&quot;rejected a generic services command &quot;
l_string|&quot;due to invalid response buffer.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_resiv&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port &quot;
l_string|&quot;with WWPN 0x%Lx on the adapter %s &quot;
l_string|&quot;needs to be reopened&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* reopening link to port */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_forced_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
multiline_comment|/* callback */
(paren
id|fsf_req-&gt;data.send_generic.handler
)paren
(paren
id|fsf_req
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&n; *&n; * purpose:&n; *&n; * returns:&t;address of initiated FSF request&n; *&t;&t;NULL - request could not be initiated&n; */
r_int
DECL|function|zfcp_fsf_exchange_config_data
id|zfcp_fsf_exchange_config_data
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
comma
op_amp
id|lock_flags
comma
id|ZFCP_REQ_AUTO_CLEANUP
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create an &quot;
l_string|&quot;exchange configuration data request for&quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* no information from us to adapter, set nothing */
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
(paren
l_string|&quot;error: Could not send an exchange configuration data &quot;
l_string|&quot;command on the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Exchange Configuration Data request initiated &quot;
l_string|&quot;(adapter busid=%s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_exchange_config_data_handler&n; *&n; * purpose:     is called for finished Exchange Configuration Data command&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_exchange_config_data_handler
id|zfcp_fsf_exchange_config_data_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_struct
id|fsf_qtcb_bottom_config
op_star
id|bottom
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t set any value, stay with the old (unitialized) ones */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.config
suffix:semicolon
multiline_comment|/* only log QTCB versions for now */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;low QTCB version 0x%x of FSF, &quot;
l_string|&quot;high QTCB version 0x%x of FSF, &bslash;n&quot;
comma
id|bottom-&gt;low_qtcb_version
comma
id|bottom-&gt;high_qtcb_version
)paren
suffix:semicolon
id|adapter-&gt;wwnn
op_assign
id|bottom-&gt;nport_serv_param.wwnn
suffix:semicolon
id|adapter-&gt;wwpn
op_assign
id|bottom-&gt;nport_serv_param.wwpn
suffix:semicolon
id|adapter-&gt;s_id
op_assign
id|bottom-&gt;s_id
op_amp
id|ZFCP_DID_MASK
suffix:semicolon
id|adapter-&gt;hydra_version
op_assign
id|bottom-&gt;adapter_type
suffix:semicolon
id|adapter-&gt;fsf_lic_version
op_assign
id|bottom-&gt;lic_version
suffix:semicolon
id|adapter-&gt;fc_topology
op_assign
id|bottom-&gt;fc_topology
suffix:semicolon
id|adapter-&gt;fc_link_speed
op_assign
id|bottom-&gt;fc_link_speed
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The adapter %s reported &quot;
l_string|&quot;the following characteristics:&bslash;n&quot;
l_string|&quot;WWNN 0x%16.16Lx, &quot;
l_string|&quot;WWPN 0x%16.16Lx, &quot;
l_string|&quot;S_ID 0x%6.6x,&bslash;n&quot;
l_string|&quot;adapter version 0x%x, &quot;
l_string|&quot;LIC version 0x%x, &quot;
l_string|&quot;FC link speed %d Gb/s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|adapter-&gt;wwnn
comma
id|adapter-&gt;wwpn
comma
(paren
r_int
r_int
)paren
id|adapter-&gt;s_id
comma
id|adapter-&gt;hydra_version
comma
id|adapter-&gt;fsf_lic_version
comma
id|adapter-&gt;fc_link_speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ZFCP_QTCB_VERSION
OL
id|bottom-&gt;low_qtcb_version
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: the adapter %s &quot;
l_string|&quot;only supports newer control block &quot;
l_string|&quot;versions in comparison to this device &quot;
l_string|&quot;driver (try updated device driver)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;low_qtcb_ver&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ZFCP_QTCB_VERSION
OG
id|bottom-&gt;high_qtcb_version
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: the adapter %s &quot;
l_string|&quot;only supports older control block &quot;
l_string|&quot;versions than this device driver uses&quot;
l_string|&quot;(consider a microcode upgrade)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;high_qtcb_ver&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|adapter-&gt;fc_topology
)paren
(brace
r_case
id|FSF_TOPO_P2P
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_TOPO_P2P&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: Point-to-point fibre-channel &quot;
l_string|&quot;configuration detected &quot;
l_string|&quot;at the adapter %s, not &quot;
l_string|&quot;supported, shutting down adapter&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;top-p-to-p&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
r_case
id|FSF_TOPO_AL
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_TOPO_AL&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: Arbitrated loop fibre-channel &quot;
l_string|&quot;topology detected &quot;
l_string|&quot;at the adapter %s, not &quot;
l_string|&quot;supported, shutting down adapter&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;top-al&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
r_case
id|FSF_TOPO_FABRIC
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_TOPO_FABRIC&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Switched fabric fibre-channel &quot;
l_string|&quot;network detected &quot;
l_string|&quot;at the adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The fibre-channel topology &quot;
l_string|&quot;reported by the exchange &quot;
l_string|&quot;configuration command for &quot;
l_string|&quot;the adapter %s is not &quot;
l_string|&quot;of a type known to the zfcp &quot;
l_string|&quot;driver, shutting down adapter&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;unknown-topo&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bottom-&gt;max_qtcb_size
OL
id|ZFCP_QTCB_SIZE
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Maximum QTCB size (%d bytes) &quot;
l_string|&quot;allowed by the adapter %s &quot;
l_string|&quot;is lower than the minimum &quot;
l_string|&quot;required by the driver (%ld bytes).&bslash;n&quot;
comma
id|bottom-&gt;max_qtcb_size
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|ZFCP_QTCB_SIZE
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;qtcb-size&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|bottom-&gt;max_qtcb_size
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_XCONFIG_OK
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* retval is -EIO by default */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf-stat-ng&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_open_port&n; *&n; * purpose:&t;&n; *&n; * returns:&t;address of initiated FSF request&n; *&t;&t;NULL - request could not be initiated &n; */
r_int
DECL|function|zfcp_fsf_open_port
id|zfcp_fsf_open_port
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_OPEN_PORT_WITH_DID
comma
op_amp
id|lock_flags
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create an &quot;
l_string|&quot;open port request for &quot;
l_string|&quot;the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;bottom.support.d_id
op_assign
id|erp_action-&gt;port-&gt;d_id
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|erp_action-&gt;port-&gt;status
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;data.open_port.port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an &quot;
l_string|&quot;open port request for &quot;
l_string|&quot;the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Open Port request initiated &quot;
l_string|&quot;(adapter busid=%s, port wwpn=0x%Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_open_port_handler&n; *&n; * purpose:&t;is called for finished Open Port command&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_open_port_handler
id|zfcp_fsf_open_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|fsf_plogi
op_star
id|plogi
suffix:semicolon
id|port
op_assign
id|fsf_req-&gt;data.open_port.port
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change port status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_ALREADY_OPEN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PORT_ALREADY_OPEN&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The remote port with WWPN=0x%Lx &quot;
l_string|&quot;connected to the adapter %s &quot;
l_string|&quot;is already open.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_popen&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This is a bug, however operation should continue normally&n;&t;&t; * if it is simply ignored&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|FSF_MAXIMUM_NUMBER_OF_PORTS_EXCEEDED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_MAXIMUM_NUMBER_OF_PORTS_EXCEEDED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: The FSF adapter is out of resources. &quot;
l_string|&quot;The remote port with WWPN=0x%Lx &quot;
l_string|&quot;connected to the adapter %s &quot;
l_string|&quot;could not be opened. Disabling it.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_max_ports&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_failed
c_func
(paren
id|port
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_NO_RETRY_POSSIBLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SQ_NO_RETRY_POSSIBLE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;The remote port with WWPN=0x%Lx &quot;
l_string|&quot;connected to the adapter %s &quot;
l_string|&quot;could not be opened. Disabling it.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_no_retry&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_failed
c_func
(paren
id|port
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* save port handle assigned by FSF */
id|port-&gt;handle
op_assign
id|fsf_req-&gt;qtcb-&gt;header.port_handle
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The remote port (WWPN=0x%Lx) via adapter &quot;
l_string|&quot;(busid=%s) was opened, it&squot;s &quot;
l_string|&quot;port handle is 0x%x&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* mark port as open */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
op_or
id|ZFCP_STATUS_PORT_PHYS_OPEN
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check whether D_ID has changed during open */
multiline_comment|/*&n;&t;&t; * FIXME: This check is not airtight, as the FCP channel does&n;&t;&t; * not monitor closures of target port connections caused on&n;&t;&t; * the remote side. Thus, they might miss out on invalidating&n;&t;&t; * locally cached WWPNs (and other N_Port parameters) of gone&n;&t;&t; * target ports. So, our heroic attempt to make things safe&n;&t;&t; * could be undermined by &squot;open port&squot; response data tagged with&n;&t;&t; * obsolete WWPNs. Another reason to monitor potential&n;&t;&t; * connection closures ourself at least (by interpreting&n;&t;&t; * incoming ELS&squot; and unsolicited status). It just crosses my&n;&t;&t; * mind that one should be able to cross-check by means of&n;&t;&t; * another GID_PN straight after a port has been opened.&n;&t;&t; * Alternately, an ADISC/PDISC ELS should suffice, as well.&n;&t;&t; */
id|plogi
op_assign
(paren
r_struct
id|fsf_plogi
op_star
)paren
id|fsf_req-&gt;qtcb-&gt;bottom.support.els
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_PORT_NO_WWPN
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
r_if
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.support.els1_length
OL
(paren
(paren
(paren
(paren
r_int
r_int
)paren
op_amp
id|plogi-&gt;serv_param.wwpn
)paren
op_minus
(paren
(paren
r_int
r_int
)paren
id|plogi
)paren
)paren
op_plus
r_sizeof
(paren
id|u64
)paren
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;warning: insufficient length of &quot;
l_string|&quot;PLOGI payload (%i)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;bottom.support.els1_length
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_short_plogi:&quot;
)paren
suffix:semicolon
multiline_comment|/* skip sanity check and assume wwpn is ok */
)brace
r_else
(brace
r_if
c_cond
(paren
id|plogi-&gt;serv_param.wwpn
op_ne
id|port-&gt;wwpn
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;warning: D_ID of port &quot;
l_string|&quot;with WWPN 0x%Lx changed &quot;
l_string|&quot;during open&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_did_change:&quot;
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_PORT_DID_DID
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
)brace
r_else
id|port-&gt;wwnn
op_assign
id|plogi-&gt;serv_param.wwnn
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_port&n; *&n; * purpose:     submit FSF command &quot;close port&quot;&n; *&n; * returns:     address of initiated FSF request&n; *              NULL - request could not be initiated&n; */
r_int
DECL|function|zfcp_fsf_close_port
id|zfcp_fsf_close_port
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_CLOSE_PORT
comma
op_amp
id|lock_flags
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create a &quot;
l_string|&quot;close port request for WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|erp_action-&gt;port-&gt;status
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;data.close_port.port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|erp_action-&gt;port-&gt;handle
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send a &quot;
l_string|&quot;close port request for WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Close Port request initiated &quot;
l_string|&quot;(adapter busid=%s, port wwpn=0x%Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_port_handler&n; *&n; * purpose:     is called for finished Close Port FSF command&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_close_port_handler
id|zfcp_fsf_close_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|port
op_assign
id|fsf_req-&gt;data.close_port.port
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change port status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier (handle) 0x%x &quot;
l_string|&quot;for the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is&quot;
l_string|&quot;not valid. This may happen occasionally.&bslash;n&quot;
comma
id|port-&gt;handle
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Note: FSF has actually closed the port in this case.&n;&t;&t; * The status code is just daft. Fingers crossed for a change&n;&t;&t; */
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;remote port (WWPN=0x%Lx) via adapter &quot;
l_string|&quot;(busid=%s) closed, port handle 0x%x&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;handle
)paren
suffix:semicolon
id|zfcp_erp_modify_port_status
c_func
(paren
id|port
comma
id|ZFCP_STATUS_COMMON_OPEN
comma
id|ZFCP_CLEAR
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_physical_port&n; *&n; * purpose:     submit FSF command &quot;close physical port&quot;&n; *&n; * returns:     address of initiated FSF request&n; *              NULL - request could not be initiated&n; */
r_int
DECL|function|zfcp_fsf_close_physical_port
id|zfcp_fsf_close_physical_port
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
comma
op_amp
id|lock_flags
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
op_amp
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create a &quot;
l_string|&quot;close physical port request for &quot;
l_string|&quot;the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* mark port as being closed */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_PORT_PHYS_CLOSING
comma
op_amp
id|erp_action-&gt;port-&gt;status
)paren
suffix:semicolon
multiline_comment|/* save a pointer to this port */
id|erp_action-&gt;fsf_req-&gt;data.close_physical_port.port
op_assign
id|erp_action-&gt;port
suffix:semicolon
multiline_comment|/* port to be closeed */
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|erp_action-&gt;port-&gt;handle
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an close physical port &quot;
l_string|&quot;request for the port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Close Physical Port request initiated &quot;
l_string|&quot;(adapter busid=%s, port wwpn=0x%Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_physical_port_handler&n; *&n; * purpose:     is called for finished Close Physical Port FSF command&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_close_physical_port_handler
id|zfcp_fsf_close_physical_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|port
op_assign
id|fsf_req-&gt;data.close_physical_port.port
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change port status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier (handle) 0x%x &quot;
l_string|&quot;for the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is not valid. This may happen &quot;
l_string|&quot;occasionally.&bslash;n&quot;
comma
id|port-&gt;handle
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port with WWPN 0x%Lx on the adapter &quot;
l_string|&quot;%s needs to be reopened but it was attempted &quot;
l_string|&quot;to close it physically.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
multiline_comment|/* This will now be escalated by ERP */
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Remote port (WWPN=0x%Lx) via adapter &quot;
l_string|&quot;(busid=%s) physically closed, &quot;
l_string|&quot;port handle 0x%x&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* can&squot;t use generic zfcp_erp_modify_port_status because&n;&t;&t; * ZFCP_STATUS_COMMON_OPEN must not be reset for the port&n;&t;&t; */
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_PORT_PHYS_OPEN
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_PORT_PHYS_CLOSING
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_open_unit&n; *&n; * purpose:&n; *&n; * returns:&n; *&n; * assumptions:&t;This routine does not check whether the associated&n; *&t;&t;remote port has already been opened. This should be&n; *&t;&t;done by calling routines. Otherwise some status&n; *&t;&t;may be presented by FSF&n; */
r_int
DECL|function|zfcp_fsf_open_unit
id|zfcp_fsf_open_unit
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_OPEN_LUN
comma
op_amp
id|lock_flags
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create an &quot;
l_string|&quot;open unit request for FCP-LUN 0x%Lx connected &quot;
l_string|&quot;to the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;unit-&gt;fcp_lun
comma
id|erp_action-&gt;unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|erp_action-&gt;port-&gt;handle
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;bottom.support.fcp_lun
op_assign
id|erp_action-&gt;unit-&gt;fcp_lun
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|erp_action-&gt;unit-&gt;status
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;data.open_unit.unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an open unit request &quot;
l_string|&quot;on the adapter %s, port WWPN 0x%Lx for &quot;
l_string|&quot;unit LUN 0x%Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|erp_action-&gt;unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Open LUN request initiated (adapter busid=%s, &quot;
l_string|&quot;port wwpn=0x%Lx, unit fcp_lun=0x%Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|erp_action-&gt;unit-&gt;fcp_lun
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_open_unit_handler&n; *&n; * purpose:&t;is called for finished Open LUN command&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_open_unit_handler
id|zfcp_fsf_open_unit_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|unit
op_assign
id|fsf_req-&gt;data.open_unit.unit
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change unit status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier (handle) 0x%x &quot;
l_string|&quot;for the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is&quot;
l_string|&quot;not valid. This may happen occasionally.&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_ph_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_ALREADY_OPEN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_LUN_ALREADY_OPEN&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Attempted to open the logical unit &quot;
l_string|&quot;with FCP-LUN 0x%Lx at &quot;
l_string|&quot;the remote port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s twice.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_uopen&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port &quot;
l_string|&quot;with WWPN 0x%Lx on the adapter %s &quot;
l_string|&quot;needs to be reopened&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_IN_USE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_LUN_IN_USE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: FCP-LUN 0x%Lx at &quot;
l_string|&quot;the remote port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s &quot;
l_string|&quot;is already owned by another operating system &quot;
l_string|&quot;instance (LPAR or VM guest)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Additional sense data is presented:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_l_in_use&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_MAXIMUM_NUMBER_OF_LUNS_EXCEEDED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_MAXIMUM_NUMBER_OF_LUNS_EXCEEDED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: The adapter ran out of resources. &quot;
l_string|&quot;There is no handle (temporary port identifier) &quot;
l_string|&quot;available for the unit with FCP-LUN 0x%Lx &quot;
l_string|&quot;at the remote port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_max_units&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Re-establish link to port */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* save LUN handle assigned by FSF */
id|unit-&gt;handle
op_assign
id|fsf_req-&gt;qtcb-&gt;header.lun_handle
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;unit (FCP_LUN=0x%Lx) of remote port &quot;
l_string|&quot;(WWPN=0x%Lx) via adapter (busid=%s) opened, &quot;
l_string|&quot;port handle 0x%x &bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* mark unit as open */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_unit&n; *&n; * purpose:&n; *&n; * returns:&t;address of fsf_req - request successfully initiated&n; *&t;&t;NULL - &n; *&n; * assumptions: This routine does not check whether the associated&n; *              remote port/lun has already been opened. This should be&n; *              done by calling routines. Otherwise some status&n; *              may be presented by FSF&n; */
r_int
DECL|function|zfcp_fsf_close_unit
id|zfcp_fsf_close_unit
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_CLOSE_LUN
comma
op_amp
id|lock_flags
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create a &quot;
l_string|&quot;close unit request for FCP-LUN 0x%Lx &quot;
l_string|&quot;connected to the port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;unit-&gt;fcp_lun
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|erp_action-&gt;port-&gt;handle
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.lun_handle
op_assign
id|erp_action-&gt;unit-&gt;handle
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|erp_action-&gt;unit-&gt;status
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;data.close_unit.unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send a close unit request for &quot;
l_string|&quot;FCP-LUN 0x%Lx connected to the port with &quot;
l_string|&quot;WWPN 0x%Lx connected to the adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;unit-&gt;fcp_lun
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Close LUN request initiated (adapter busid=%s, &quot;
l_string|&quot;port wwpn=0x%Lx, unit fcp_lun=0x%Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|erp_action-&gt;unit-&gt;fcp_lun
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_unit_handler&n; *&n; * purpose:     is called for finished Close LUN FSF command&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_close_unit_handler
id|zfcp_fsf_close_unit_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|unit
op_assign
id|fsf_req-&gt;data.close_unit.unit
suffix:semicolon
multiline_comment|/* restore unit */
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change unit status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier (handle) 0x%x &quot;
l_string|&quot;for the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is not valid. This may &quot;
l_string|&quot;happen in rare circumstances&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;porthinv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_LUN_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary LUN identifier (handle) 0x%x &quot;
l_string|&quot;of the logical unit with FCP-LUN 0x%Lx at &quot;
l_string|&quot;the remote port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s is &quot;
l_string|&quot;not valid. This may happen occasionally.&bslash;n&quot;
comma
id|unit-&gt;handle
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Status qualifier data:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_lhand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;lunhinv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port &quot;
l_string|&quot;with WWPN 0x%Lx on the adapter %s &quot;
l_string|&quot;needs to be reopened&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* re-establish link to port */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;unit (FCP_LUN=0x%Lx) of remote port &quot;
l_string|&quot;(WWPN=0x%Lx) via adapter (busid=%s) closed, &quot;
l_string|&quot;port handle 0x%x &bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* mark unit as closed */
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_task&n; *&n; * purpose:&n; *&n; * returns:&n; *&n; * note: we do not employ linked commands (not supported by HBA anyway)&n; */
r_int
DECL|function|zfcp_fsf_send_fcp_command_task
id|zfcp_fsf_send_fcp_command_task
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
id|Scsi_Cmnd
op_star
id|scsi_cmnd
comma
r_int
id|req_flags
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmnd_iu
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffere
suffix:semicolon
r_int
r_int
id|sbtype
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|real_bytes
op_assign
l_int|0
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_FCP_CMND
comma
op_amp
id|lock_flags
comma
id|req_flags
comma
op_amp
(paren
id|fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
OL
l_int|0
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Out of resources. Could not create an &quot;
l_string|&quot;FCP command request for FCP-LUN 0x%Lx &quot;
l_string|&quot;connected to the port with WWPN 0x%Lx &quot;
l_string|&quot;connected to the adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|failed_req_create
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * associate FSF request with SCSI request&n;&t; * (need this for look up on abort)&n;&t; */
id|fsf_req-&gt;data.send_fcp_command_task.fsf_req
op_assign
id|fsf_req
suffix:semicolon
id|scsi_cmnd-&gt;host_scribble
op_assign
(paren
r_char
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;data
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * associate SCSI command with FSF request&n;&t; * (need this for look up on normal command completion)&n;&t; */
id|fsf_req-&gt;data.send_fcp_command_task.scsi_cmnd
op_assign
id|scsi_cmnd
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|3
comma
l_string|&quot;fsf/sc&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|3
comma
op_amp
id|fsf_req
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|3
comma
op_amp
id|scsi_cmnd
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
macro_line|#ifdef ZFCP_DEBUG_ABORTS
id|fsf_req-&gt;data.send_fcp_command_task.start_jiffies
op_assign
id|jiffies
suffix:semicolon
macro_line|#endif
id|fsf_req-&gt;data.send_fcp_command_task.unit
op_assign
id|unit
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit=0x%lx, unit_fcp_lun=0x%Lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|unit
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
multiline_comment|/* set handles of unit and its parent port in QTCB */
id|fsf_req-&gt;qtcb-&gt;header.lun_handle
op_assign
id|unit-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|unit-&gt;port-&gt;handle
suffix:semicolon
multiline_comment|/* FSF does not define the structure of the FCP_CMND IU */
id|fcp_cmnd_iu
op_assign
(paren
r_struct
id|fcp_cmnd_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set depending on data direction:&n;&t; *      data direction bits in SBALE (SB Type)&n;&t; *      data direction bits in QTCB&n;&t; *      data direction bits in FCP_CMND IU&n;&t; */
r_switch
c_cond
(paren
id|scsi_cmnd-&gt;sc_data_direction
)paren
(brace
r_case
id|SCSI_DATA_NONE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;SCSI_DATA_NONE&bslash;n&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
op_assign
id|FSF_DATADIR_CMND
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FIXME(qdio):&n;&t;&t; * what is the correct type for commands&n;&t;&t; * without &squot;real&squot; data buffers?&n;&t;&t; */
id|sbtype
op_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_READ
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;SCSI_DATA_READ&bslash;n&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
op_assign
id|FSF_DATADIR_READ
suffix:semicolon
id|sbtype
op_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|fcp_cmnd_iu-&gt;rddata
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_WRITE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;SCSI_DATA_WRITE&bslash;n&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
op_assign
id|FSF_DATADIR_WRITE
suffix:semicolon
id|sbtype
op_assign
id|SBAL_FLAGS0_TYPE_WRITE
suffix:semicolon
id|fcp_cmnd_iu-&gt;wddata
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_UNKNOWN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;SCSI_DATA_UNKNOWN not supported&bslash;n&quot;
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t;&t; * dummy, catch this condition earlier&n;&t;&t; * in zfcp_scsi_queuecommand&n;&t;&t; */
r_goto
id|failed_scsi_cmnd
suffix:semicolon
)brace
id|buffere
op_assign
op_amp
(paren
id|adapter-&gt;request_queue.buffer
(braket
id|fsf_req-&gt;sbal_index
)braket
op_member_access_from_pointer
id|element
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|buffere-&gt;flags
op_or_assign
id|sbtype
suffix:semicolon
multiline_comment|/* set FC service class in QTCB (3 per default) */
id|fsf_req-&gt;qtcb-&gt;bottom.io.service_class
op_assign
id|adapter-&gt;fc_service_class
suffix:semicolon
multiline_comment|/* set FCP_LUN in FCP_CMND IU in QTCB */
id|fcp_cmnd_iu-&gt;fcp_lun
op_assign
id|unit-&gt;fcp_lun
suffix:semicolon
multiline_comment|/* set task attributes in FCP_CMND IU in QTCB */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|scsi_cmnd-&gt;device-&gt;simple_tags
)paren
)paren
(brace
id|fcp_cmnd_iu-&gt;task_attribute
op_assign
id|SIMPLE_Q
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;setting SIMPLE_Q task attribute&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|fcp_cmnd_iu-&gt;task_attribute
op_assign
id|UNTAGGED
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;setting UNTAGGED task attribute&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* set additional length of FCP_CDB in FCP_CMND IU in QTCB, if needed */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|scsi_cmnd-&gt;cmd_len
OG
id|FCP_CDB_LENGTH
)paren
)paren
(brace
id|fcp_cmnd_iu-&gt;add_fcp_cdb_length
op_assign
(paren
id|scsi_cmnd-&gt;cmd_len
op_minus
id|FCP_CDB_LENGTH
)paren
op_rshift
l_int|2
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;SCSI CDB length is 0x%x, &quot;
l_string|&quot;additional FCP_CDB length is 0x%x &quot;
l_string|&quot;(shifted right 2 bits)&bslash;n&quot;
comma
id|scsi_cmnd-&gt;cmd_len
comma
id|fcp_cmnd_iu-&gt;add_fcp_cdb_length
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * copy SCSI CDB (including additional length, if any) to&n;&t; * FCP_CDB in FCP_CMND IU in QTCB&n;&t; */
id|memcpy
c_func
(paren
id|fcp_cmnd_iu-&gt;fcp_cdb
comma
id|scsi_cmnd-&gt;cmnd
comma
id|scsi_cmnd-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/* FCP CMND IU length in QTCB */
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd_length
op_assign
r_sizeof
(paren
r_struct
id|fcp_cmnd_iu
)paren
op_plus
id|fcp_cmnd_iu-&gt;add_fcp_cdb_length
op_plus
r_sizeof
(paren
id|fcp_dl_t
)paren
suffix:semicolon
multiline_comment|/* generate SBALEs from data buffer */
id|real_bytes
op_assign
id|zfcp_create_sbals_from_sg
c_func
(paren
id|fsf_req
comma
id|scsi_cmnd
comma
id|sbtype
comma
l_int|0
comma
id|ZFCP_MAX_SBALS_PER_REQ
)paren
suffix:semicolon
multiline_comment|/* Note: &gt;= and not = because the combined scatter-gather entries&n;&t; * may be larger than request_bufflen according to the mailing list&n;&t; */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|real_bytes
op_ge
id|scsi_cmnd-&gt;request_bufflen
)paren
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Data fits&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|likely
c_func
(paren
id|real_bytes
op_eq
l_int|0
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Data did not fit into available buffer(s), &quot;
l_string|&quot;waiting for more...&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|no_fit
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: No truncation implemented but &quot;
l_string|&quot;required. Shutting down unit (busid=%s, &quot;
l_string|&quot;WWPN=0x%16.16Lx, FCP_LUN=0x%16.16Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_erp_unit_shutdown
c_func
(paren
id|unit
comma
l_int|0
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|no_fit
suffix:semicolon
)brace
multiline_comment|/* set length of FCP data length in FCP_CMND IU in QTCB */
id|zfcp_set_fcp_dl
c_func
(paren
id|fcp_cmnd_iu
comma
id|real_bytes
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Sending SCSI command:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
id|scsi_cmnd-&gt;cmnd
comma
id|scsi_cmnd-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * start QDIO request for this FSF request&n;&t; *  covered by an SBALE)&n;&t; */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
OL
l_int|0
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an FCP command request &quot;
l_string|&quot;for a command on the adapter %s, &quot;
l_string|&quot;port WWPN 0x%Lx and unit LUN 0x%Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
r_goto
id|send_failed
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Send FCP Command initiated (adapter busid=%s, &quot;
l_string|&quot;port wwpn=0x%Lx, unit fcp_lun=0x%Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
r_goto
id|success
suffix:semicolon
id|send_failed
suffix:colon
id|no_fit
suffix:colon
id|failed_scsi_cmnd
suffix:colon
multiline_comment|/* dequeue new FSF request previously enqueued */
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|3
comma
l_string|&quot;fail_sc&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|3
comma
op_amp
id|scsi_cmnd
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
id|success
suffix:colon
id|failed_req_create
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_task_management&n; *&n; * purpose:&n; *&n; * returns:&n; *&n; * FIXME(design): should be watched by a timeout!!!&n; * FIXME(design) shouldn&squot;t this be modified to return an int&n; *               also...don&squot;t know how though&n; *&n; */
r_struct
id|zfcp_fsf_req
op_star
DECL|function|zfcp_fsf_send_fcp_command_task_management
id|zfcp_fsf_send_fcp_command_task_management
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
id|u8
id|tm_flags
comma
r_int
id|req_flags
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmnd_iu
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffere
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_FCP_CMND
comma
op_amp
id|lock_flags
comma
id|req_flags
comma
op_amp
(paren
id|fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create an &quot;
l_string|&quot;FCP command (task management) request for &quot;
l_string|&quot;the adapter %s, port with &quot;
l_string|&quot;WWPN 0x%Lx and FCP_LUN 0x%Lx.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Used to decide on proper handler in the return path,&n;&t; * could be either zfcp_fsf_send_fcp_command_task_handler or&n;&t; * zfcp_fsf_send_fcp_command_task_management_handler */
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TASK_MANAGEMENT
suffix:semicolon
multiline_comment|/*&n;&t; * hold a pointer to the unit being target of this&n;&t; * task management request&n;&t; */
id|fsf_req-&gt;data.send_fcp_command_task_management.unit
op_assign
id|unit
suffix:semicolon
multiline_comment|/* set FSF related fields in QTCB */
id|fsf_req-&gt;qtcb-&gt;header.lun_handle
op_assign
id|unit-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|unit-&gt;port-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
op_assign
id|FSF_DATADIR_CMND
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.service_class
op_assign
id|adapter-&gt;fc_service_class
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd_length
op_assign
r_sizeof
(paren
r_struct
id|fcp_cmnd_iu
)paren
op_plus
r_sizeof
(paren
id|fcp_dl_t
)paren
suffix:semicolon
id|buffere
op_assign
op_amp
(paren
id|adapter-&gt;request_queue.buffer
(braket
id|fsf_req-&gt;sbal_index
)braket
op_member_access_from_pointer
id|element
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|buffere
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_WRITE
suffix:semicolon
id|buffere
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
multiline_comment|/* set FCP related fields in FCP_CMND IU in QTCB */
id|fcp_cmnd_iu
op_assign
(paren
r_struct
id|fcp_cmnd_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd
)paren
suffix:semicolon
id|fcp_cmnd_iu-&gt;fcp_lun
op_assign
id|unit-&gt;fcp_lun
suffix:semicolon
id|fcp_cmnd_iu-&gt;task_management_flags
op_assign
id|tm_flags
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|zfcp_fsf_start_scsi_er_timer
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an FCP-command (task &quot;
l_string|&quot;management) on the adapter %s, port WWPN &quot;
l_string|&quot;0x%Lx for unit LUN 0x%Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Send FCP Command (task management function) initiated &quot;
l_string|&quot;(adapter busid=%s, port wwpn=0x%Lx, &quot;
l_string|&quot;unit fcp_lun=0x%Lx, tm_flags=0x%x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
comma
id|tm_flags
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|fsf_req
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_handler&n; *&n; * purpose:&t;is called for finished Send FCP Command&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_send_fcp_command_handler
id|zfcp_fsf_send_fcp_command_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_TASK_MANAGEMENT
)paren
)paren
id|unit
op_assign
id|fsf_req-&gt;data.send_fcp_command_task_management.unit
suffix:semicolon
r_else
id|unit
op_assign
id|fsf_req-&gt;data.send_fcp_command_task.unit
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
)paren
(brace
multiline_comment|/* go directly to calls of special handlers */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier (handle) 0x%x &quot;
l_string|&quot;for the port with WWPN 0x%Lx connected to &quot;
l_string|&quot;the adapter %s is not valid.&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_LUN_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary LUN identifier (handle) 0x%x &quot;
l_string|&quot;of the logical unit with FCP-LUN 0x%Lx at &quot;
l_string|&quot;the remote port with WWPN 0x%Lx connected &quot;
l_string|&quot;to the adapter %s is &quot;
l_string|&quot;not valid. This may happen occasionally.&bslash;n&quot;
comma
id|unit-&gt;handle
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Status qualifier data:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_uhand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_HANDLE_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_HANDLE_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The port handle (temporary port &quot;
l_string|&quot;identifier) 0x%x has changed unexpectedly. &quot;
l_string|&quot;This was detected upon receiveing the &quot;
l_string|&quot;response of a command send to the unit with &quot;
l_string|&quot;FCP-LUN 0x%Lx at the remote port with WWPN &quot;
l_string|&quot;0x%Lx connected to the adapter %s.&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_hand_mis&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;handmism&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SERVICE_CLASS_NOT_SUPPORTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SERVICE_CLASS_NOT_SUPPORTED&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;adapter-&gt;fc_service_class
op_le
l_int|3
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The adapter %s does &quot;
l_string|&quot;not support fibre-channel class %d.&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fsf_req-&gt;adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The fibre channel class at the &quot;
l_string|&quot;adapter %s is invalid. &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fsf_req-&gt;adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
multiline_comment|/* stop operation for this adapter */
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_class_nsup&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;unsclass&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_FCPLUN_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_FCPLUN_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The FCP LUN 0x%Lx behind the remote port &quot;
l_string|&quot;of WWPN0x%Lx via the adapter %s does not have &quot;
l_string|&quot;the correct unit handle (temporary unit &quot;
l_string|&quot;identifier) 0x%x&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;handle
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_fcp_lun_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;fluninv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_DIRECTION_INDICATOR_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_DIRECTION_INDICATOR_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;bug: Invalid data direction given for the unit &quot;
l_string|&quot;with FCP LUN 0x%Lx at the remote port with &quot;
l_string|&quot;WWPN 0x%Lx via the adapter %s &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
)paren
suffix:semicolon
multiline_comment|/* stop operation for this adapter */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_dir_ind_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;dirinv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* FIXME: this should be obsolete, isn&squot; it? */
r_case
id|FSF_INBOUND_DATA_LENGTH_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_INBOUND_DATA_LENGTH_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An invalid inbound data length field &quot;
l_string|&quot;was found in a command for the unit with &quot;
l_string|&quot;FCP LUN 0x%Lx of the remote port &quot;
l_string|&quot;with WWPN 0x%Lx via the adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
multiline_comment|/* stop operation for this adapter */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_in_dl_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;idleninv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* FIXME: this should be obsolete, isn&squot; it? */
r_case
id|FSF_OUTBOUND_DATA_LENGTH_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_OUTBOUND_DATA_LENGTH_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An invalid outbound data length field &quot;
l_string|&quot;was found in a command for the unit with &quot;
l_string|&quot;FCP LUN 0x%Lx of the remote port &quot;
l_string|&quot;with WWPN 0x%Lx via the adapter %s&bslash;n.&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
multiline_comment|/* stop operation for this adapter */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_out_dl_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;odleninv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_CMND_LENGTH_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_CMND_LENGTH_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: An invalid control-data-block length field &quot;
l_string|&quot;was found in a command for the unit with &quot;
l_string|&quot;FCP LUN 0x%Lx of the remote port &quot;
l_string|&quot;with WWPN 0x%Lx via the adapter %s &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd_length
)paren
suffix:semicolon
multiline_comment|/* stop operation for this adapter */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_cmd_len_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;cleninv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port &quot;
l_string|&quot;with WWPN 0x%Lx on the adapter %s &quot;
l_string|&quot;needs to be reopened&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;portbox&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* re-establish link to port */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqltest&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME(hw) need proper specs for proper action */
multiline_comment|/* let scsi stack deal with retries and escalation */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqdeperp&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* FIXME: shall we consider this a successful transfer? */
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_FCP_RSP_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_FCP_RSP_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_TASK_MANAGEMENT
)paren
(brace
id|retval
op_assign
id|zfcp_fsf_send_fcp_command_task_management_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
id|zfcp_fsf_send_fcp_command_task_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_task_handler&n; *&n; * purpose:&t;evaluates FCP_RSP IU&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_send_fcp_command_task_handler
id|zfcp_fsf_send_fcp_command_task_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|Scsi_Cmnd
op_star
id|scpnt
suffix:semicolon
r_struct
id|fcp_rsp_iu
op_star
id|fcp_rsp_iu
op_assign
(paren
r_struct
id|fcp_rsp_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_rsp
)paren
suffix:semicolon
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmnd_iu
op_assign
(paren
r_struct
id|fcp_cmnd_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd
)paren
suffix:semicolon
id|u32
id|sns_len
suffix:semicolon
r_char
op_star
id|fcp_rsp_info
op_assign
id|zfcp_get_fcp_rsp_info_ptr
c_func
(paren
id|fcp_rsp_iu
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|fsf_req-&gt;data.send_fcp_command_task.unit
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|fsf_req-&gt;adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
id|scpnt
op_assign
id|fsf_req-&gt;data.send_fcp_command_task.scsi_cmnd
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|scpnt
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
(paren
l_string|&quot;Command with fsf_req 0x%lx is not associated to &quot;
l_string|&quot;a scsi command anymore. Aborted?&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ABORTED
)paren
)paren
(brace
multiline_comment|/* FIXME: (design) mid-layer should handle DID_ABORT like&n;&t;&t; *        DID_SOFT_ERROR by retrying the request for devices&n;&t;&t; *        that allow retries.&n;&t;&t; */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Setting DID_SOFT_ERROR and SUGGEST_RETRY&bslash;n&quot;
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_SOFT_ERROR
)paren
suffix:semicolon
id|set_driver_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|SUGGEST_RETRY
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Setting DID_ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* set message byte of result in SCSI command */
id|scpnt-&gt;result
op_or_assign
id|COMMAND_COMPLETE
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/*&n;&t; * copy SCSI status code of FCP_STATUS of FCP_RSP IU to status byte&n;&t; * of result in SCSI command&n;&t; */
id|scpnt-&gt;result
op_or_assign
id|fcp_rsp_iu-&gt;scsi_status
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;scsi_status
)paren
)paren
(brace
multiline_comment|/* DEBUG */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;status for SCSI Command:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
id|scpnt-&gt;cmnd
comma
id|scpnt-&gt;cmd_len
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;SCSI status code 0x%x&bslash;n&quot;
comma
id|fcp_rsp_iu-&gt;scsi_status
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_void
op_star
)paren
id|fcp_rsp_iu
comma
r_sizeof
(paren
r_struct
id|fcp_rsp_iu
)paren
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
id|zfcp_get_fcp_sns_info_ptr
c_func
(paren
id|fcp_rsp_iu
)paren
comma
id|fcp_rsp_iu-&gt;fcp_sns_len
)paren
suffix:semicolon
)brace
multiline_comment|/* check FCP_RSP_INFO */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_rsp_len_valid
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;rsp_len is valid&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fcp_rsp_info
(braket
l_int|3
)braket
)paren
(brace
r_case
id|RSP_CODE_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;RSP_CODE_GOOD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ok, continue */
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;no failure or Task Management &quot;
l_string|&quot;Function complete&bslash;n&quot;
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RSP_CODE_LENGTH_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_LENGTH_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* hardware bug */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: FCP response code indictates &quot;
l_string|&quot; that the fibre-channel protocol data &quot;
l_string|&quot;length differs from the burst length. &quot;
l_string|&quot;The problem occured on the unit &quot;
l_string|&quot;with FCP LUN 0x%Lx connected to the &quot;
l_string|&quot;port with WWPN 0x%Lx at the &quot;
l_string|&quot;adapter %s&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
multiline_comment|/* dump SCSI CDB as prepared by zfcp */
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb
op_member_access_from_pointer
id|bottom.io.fcp_cmnd
comma
id|FSF_FCP_CMND_SIZE
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;clenmis&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
r_case
id|RSP_CODE_FIELD_INVALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_FIELD_INVALID&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* driver or hardware bug */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: FCP response code indictates &quot;
l_string|&quot;that the fibre-channel protocol data &quot;
l_string|&quot;fields were incorrectly set-up. &quot;
l_string|&quot;The problem occured on the unit &quot;
l_string|&quot;with FCP LUN 0x%Lx connected to the &quot;
l_string|&quot;port with WWPN 0x%Lx at the &quot;
l_string|&quot;adapter %s&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
multiline_comment|/* dump SCSI CDB as prepared by zfcp */
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb
op_member_access_from_pointer
id|bottom.io.fcp_cmnd
comma
id|FSF_FCP_CMND_SIZE
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;codeinv&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
r_case
id|RSP_CODE_RO_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_RO_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* hardware bug */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The FCP response code indicates &quot;
l_string|&quot;that conflicting  values for the &quot;
l_string|&quot;fibre-channel payload offset from the &quot;
l_string|&quot;header were found. &quot;
l_string|&quot;The problem occured on the unit &quot;
l_string|&quot;with FCP LUN 0x%Lx connected to the &quot;
l_string|&quot;port with WWPN 0x%Lx at the &quot;
l_string|&quot;adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
multiline_comment|/* dump SCSI CDB as prepared by zfcp */
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb
op_member_access_from_pointer
id|bottom.io.fcp_cmnd
comma
id|FSF_FCP_CMND_SIZE
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;codemism&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An invalid FCP response &quot;
l_string|&quot;code was detected for a command. &quot;
l_string|&quot;The problem occured on the unit &quot;
l_string|&quot;with FCP LUN 0x%Lx connected to the &quot;
l_string|&quot;port with WWPN 0x%Lx at the &quot;
l_string|&quot;adapter %s &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fcp_rsp_info
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/* dump SCSI CDB as prepared by zfcp */
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb
op_member_access_from_pointer
id|bottom.io.fcp_cmnd
comma
id|FSF_FCP_CMND_SIZE
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;undeffcp&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* check for sense data */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_sns_len_valid
)paren
)paren
(brace
id|sns_len
op_assign
id|FSF_FCP_RSP_SIZE
op_minus
r_sizeof
(paren
r_struct
id|fcp_rsp_iu
)paren
op_plus
id|fcp_rsp_iu-&gt;fcp_rsp_len
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;room for %i bytes sense data in QTCB&bslash;n&quot;
comma
id|sns_len
)paren
suffix:semicolon
id|sns_len
op_assign
id|min
c_func
(paren
id|sns_len
comma
(paren
id|u32
)paren
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;room for %i bytes sense data in SCSI command&bslash;n&quot;
comma
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
id|sns_len
op_assign
id|min
c_func
(paren
id|sns_len
comma
id|fcp_rsp_iu-&gt;fcp_sns_len
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;scpnt-&gt;result =0x%x, command was:&bslash;n&quot;
comma
id|scpnt-&gt;result
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_void
op_star
)paren
op_amp
id|scpnt-&gt;cmnd
comma
id|scpnt-&gt;cmd_len
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;%i bytes sense data provided by FCP&bslash;n&quot;
comma
id|fcp_rsp_iu-&gt;fcp_sns_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|scpnt-&gt;sense_buffer
comma
id|zfcp_get_fcp_sns_info_ptr
c_func
(paren
id|fcp_rsp_iu
)paren
comma
id|sns_len
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_void
op_star
)paren
op_amp
id|scpnt-&gt;sense_buffer
comma
id|sns_len
)paren
suffix:semicolon
)brace
multiline_comment|/* check for overrun */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_resid_over
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;A data overrun was detected for a command. &quot;
l_string|&quot;This happened for a command to the unit &quot;
l_string|&quot;with FCP LUN 0x%Lx connected to the &quot;
l_string|&quot;port with WWPN 0x%Lx at the adapter %s. &quot;
l_string|&quot;The response data length is &quot;
l_string|&quot;%d, the original length was %d.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fcp_rsp_iu-&gt;fcp_resid
comma
(paren
r_int
)paren
id|zfcp_get_fcp_dl
c_func
(paren
id|fcp_cmnd_iu
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* check for underrun */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_resid_under
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;A data underrun was detected for a command. &quot;
l_string|&quot;This happened for a command to the unit &quot;
l_string|&quot;with FCP LUN 0x%Lx connected to the &quot;
l_string|&quot;port with WWPN 0x%Lx at the adapter %s. &quot;
l_string|&quot;The response data length is &quot;
l_string|&quot;%d, the original length was %d.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fcp_rsp_iu-&gt;fcp_resid
comma
(paren
r_int
)paren
id|zfcp_get_fcp_dl
c_func
(paren
id|fcp_cmnd_iu
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * It may not have been possible to send all data and the&n;&t;&t; * underrun on send may already be in scpnt-&gt;resid, so it&squot;s add&n;&t;&t; * not equals in the below statement.&n;&t;&t; */
id|scpnt-&gt;resid
op_add_assign
id|fcp_rsp_iu-&gt;fcp_resid
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;scpnt-&gt;resid=0x%x&bslash;n&quot;
comma
id|scpnt-&gt;resid
)paren
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
macro_line|#if 0
multiline_comment|/*&n;&t; * This nasty chop at the problem is not working anymore&n;&t; * as we do not adjust the retry count anylonger in order&n;&t; * to have a number of retries that avoids I/O errors.&n;&t; * The manipulation of the retry count has been removed&n;&t; * in favour of a safe tape device handling. We must not&n;&t; * sent SCSI commands more than once to a device if no&n;&t; * retries are permitted by the high level driver. Generally&n;&t; * speaking, it was a mess to change retry counts. So it is&n;&t; * fine that this sort of workaround is gone.&n;&t; * Then, we had to face a certain number of immediate retries in case of&n;&t; * busy and queue full conditions (see below).&n;&t; * This is not acceptable&n;&t; * for the latter. Queue full conditions are used&n;&t; * by devices to indicate to a host that the host can rely&n;&t; * on the completion (or timeout) of at least one outstanding&n;&t; * command as a suggested trigger for command retries.&n;&t; * Busy conditions require a different trigger since&n;&t; * no commands are outstanding for that initiator from the&n;&t; * devices perspective.&n;&t; * The drawback of mapping a queue full condition to a&n;&t; * busy condition is the chance of wasting all retries prior&n;&t; * to the time when the device indicates that a command&n;&t; * rejected due to a queue full condition should be re-driven.&n;&t; * This case would lead to unnecessary I/O errors that&n;&t; * have to be considered fatal if for example ext3&squot;s&n;&t; * journaling would be torpedoed by such an avoidable&n;&t; * I/O error.&n;&t; * So, what issues are there with not mapping a queue-full&n;&t; * condition to a busy condition?&n;&t; * Due to the &squot;exclusive LUN&squot;&n;&t; * policy enforced by the zSeries FCP channel, this &n;&t; * Linux instance is the only initiator with regard to&n;&t; * this adapter. It is safe to rely on the information&n;&t; * &squot;don&squot;t disturb me now ... and btw. no other commands&n;&t; * pending for you&squot; (= queue full) sent by the LU,&n;&t; * since no other Linux can use this LUN via this adapter&n;&t; * at the same time. If there is a potential race&n;&t; * introduced by the FCP channel by not inhibiting Linux A&n;&t; * to give up a LU with commands pending while Linux B&n;&t; * grabs this LU and sends commands  - thus providing&n;&t; * an exploit at the &squot;exclusive LUN&squot; policy - then this&n;&t; * issue has to be considered a hardware problem. It should&n;&t; * be tracked as such if it really occurs. Even if the&n;&t; * FCP Channel spec. begs exploiters to wait for the&n;&t; * completion of all request sent to a LU prior to&n;&t; * closing this LU connection.&n;&t; * This spec. statement in conjunction with&n;&t; * the &squot;exclusive LUN&squot; policy is not consistent design.&n;&t; * Another issue is how resource constraints for SCSI commands&n;&t; * might be handled by the FCP channel (just guessing for now).&n;&t; * If the FCP channel would always map resource constraints,&n;&t; * e.g. no free FC exchange ID due to I/O stress caused by&n;&t; * other sharing Linux instances, to faked queue-full&n;&t; * conditions then this would be a misinterpretation and&n;&t; * violation of SCSI standards.&n;&t; * If there are SCSI stack races as indicated below&n;&t; * then they need to be fixed just there.&n;&t; * Providing all issue above are not applicable or will&n;&t; * be fixed appropriately, removing the following hack&n;&t; * is the right thing to do.&n;&t; */
multiline_comment|/*&n;&t; * Note: This is a rather nasty chop at the problem. We cannot &n;&t; * risk adding to the mlqueue however as this will block the &n;&t; * device. If it is the last outstanding command for this host&n;&t; * it will remain blocked indefinitely. This would be quite possible&n;&t; * on the zSeries FCP adapter.&n;&t; * Also, there exists a race with scsi_insert_special relying on &n;&t; * scsi_request_fn to recalculate some command data which may not &n;&t; * happen when q-&gt;plugged is true in scsi_request_fn&n;&t; */
r_if
c_cond
(paren
id|status_byte
c_func
(paren
id|scpnt-&gt;result
)paren
op_eq
id|QUEUE_FULL
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Changing QUEUE_FULL to BUSY....&bslash;n&quot;
)paren
suffix:semicolon
id|scpnt-&gt;result
op_and_assign
op_complement
(paren
id|QUEUE_FULL
op_lshift
l_int|1
)paren
suffix:semicolon
id|scpnt-&gt;result
op_or_assign
(paren
id|BUSY
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;scpnt-&gt;result =0x%x&bslash;n&quot;
comma
id|scpnt-&gt;result
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_scsi
c_func
(paren
l_string|&quot;response&quot;
comma
id|scpnt
)paren
suffix:semicolon
multiline_comment|/* cleanup pointer (need this especially for abort) */
id|scpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * NOTE:&n;&t; * according to the outcome of a discussion on linux-scsi we&n;&t; * don&squot;t need to grab the io_request_lock here since we use&n;&t; * the new eh&n;&t; */
multiline_comment|/* always call back */
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;req_dbf
comma
l_int|2
comma
l_string|&quot;ok_done:&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;req_dbf
comma
l_int|2
comma
op_amp
id|scpnt
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;req_dbf
comma
l_int|2
comma
op_amp
id|scpnt-&gt;scsi_done
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;req_dbf
comma
l_int|2
comma
op_amp
id|fsf_req
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#endif /* ZFCP_DEBUG_REQUESTS */
(paren
id|scpnt-&gt;scsi_done
)paren
(paren
id|scpnt
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We must hold this lock until scsi_done has been called.&n;&t; * Otherwise we may call scsi_done after abort regarding this&n;&t; * command has completed.&n;&t; * Note: scsi_done must not block!&n;&t; */
id|out
suffix:colon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|fsf_req-&gt;adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_task_management_handler&n; *&n; * purpose:&t;evaluates FCP_RSP IU&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_send_fcp_command_task_management_handler
id|zfcp_fsf_send_fcp_command_task_management_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|fcp_rsp_iu
op_star
id|fcp_rsp_iu
op_assign
(paren
r_struct
id|fcp_rsp_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_rsp
)paren
suffix:semicolon
r_char
op_star
id|fcp_rsp_info
op_assign
id|zfcp_get_fcp_rsp_info_ptr
c_func
(paren
id|fcp_rsp_iu
)paren
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|fsf_req-&gt;data.send_fcp_command_task_management.unit
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|fsf_req-&gt;adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TMFUNCFAILED
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* check FCP_RSP_INFO */
r_switch
c_cond
(paren
id|fcp_rsp_info
(braket
l_int|3
)braket
)paren
(brace
r_case
id|RSP_CODE_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;RSP_CODE_GOOD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ok, continue */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;no failure or Task Management &quot;
l_string|&quot;Function complete&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RSP_CODE_TASKMAN_UNSUPP
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_TASKMAN_UNSUPP&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: A reuested task management function &quot;
l_string|&quot;is not supported on the target device &quot;
l_string|&quot;The corresponding device is the unit with &quot;
l_string|&quot;FCP LUN 0x%Lx at the port &quot;
l_string|&quot;with WWPN 0x%Lx at the adapter %s&bslash;n &quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TMFUNCNOTSUPP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RSP_CODE_TASKMAN_FAILED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_TASKMAN_FAILED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: A reuested task management function &quot;
l_string|&quot;failed to complete successfully. &quot;
l_string|&quot;The corresponding device is the unit with &quot;
l_string|&quot;FCP LUN 0x%Lx at the port &quot;
l_string|&quot;with WWPN 0x%Lx at the adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TMFUNCFAILED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An invalid FCP response &quot;
l_string|&quot;code was detected for a command. &quot;
l_string|&quot;The problem occured on the unit &quot;
l_string|&quot;with FCP LUN 0x%Lx connected to the &quot;
l_string|&quot;port with WWPN 0x%Lx at the adapter %s &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fcp_rsp_info
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TMFUNCFAILED
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_wait_and_cleanup&n; *&n; * purpose:&n; *&n; * FIXME(design): signal seems to be &lt;0 !!!&n; * returns:&t;0&t;- request completed (*status is valid), cleanup succ.&n; *&t;&t;&lt;0&t;- request completed (*status is valid), cleanup failed&n; *&t;&t;&gt;0&t;- signal which interrupted waiting (*status invalid),&n; *&t;&t;&t;  request not completed, no cleanup&n; *&n; *&t;&t;*status is a copy of status of completed fsf_req&n; */
r_int
DECL|function|zfcp_fsf_req_wait_and_cleanup
id|zfcp_fsf_req_wait_and_cleanup
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
r_int
id|interruptible
comma
id|u32
op_star
id|status
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|signal
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|interruptible
)paren
(brace
id|__wait_event_interruptible
c_func
(paren
id|fsf_req-&gt;completion_wq
comma
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_COMPLETED
comma
id|signal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Caught signal %i while waiting for the &quot;
l_string|&quot;completion of the request at 0x%lx&bslash;n&quot;
comma
id|signal
comma
(paren
r_int
r_int
)paren
id|fsf_req
)paren
suffix:semicolon
id|retval
op_assign
id|signal
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
(brace
id|__wait_event
c_func
(paren
id|fsf_req-&gt;completion_wq
comma
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_COMPLETED
)paren
suffix:semicolon
)brace
op_star
id|status
op_assign
id|fsf_req-&gt;status
suffix:semicolon
multiline_comment|/* cleanup request */
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|zfcp_fsf_req_create_sbal_check
id|zfcp_fsf_req_create_sbal_check
c_func
(paren
r_int
r_int
op_star
id|flags
comma
r_struct
id|zfcp_qdio_queue
op_star
id|queue
comma
r_int
id|needed
)paren
(brace
id|write_lock_irqsave
c_func
(paren
op_amp
id|queue-&gt;queue_lock
comma
op_star
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|queue-&gt;free_count
)paren
op_ge
id|needed
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|queue-&gt;queue_lock
comma
op_star
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_create&n; *&n; * purpose:&t;create an FSF request at the specified adapter and&n; *&t;&t;setup common fields&n; *&n; * returns:&t;-ENOMEM if there was insufficient memory for a request&n; *              -EIO if no qdio buffers could be allocate to the request&n; *              -EINVAL/-EPERM on bug conditions in req_dequeue&n; *              0 in success&n; *&n; * note:        The created request is returned by reference.&n; *&n; * locks:&t;lock of concerned request queue must not be held,&n; *&t;&t;but is held on completion (write, irqsave)&n; */
r_int
DECL|function|zfcp_fsf_req_create
id|zfcp_fsf_req_create
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
id|u32
id|fsf_cmd
comma
r_int
r_int
op_star
id|lock_flags
comma
r_int
id|req_flags
comma
r_struct
id|zfcp_fsf_req
op_star
op_star
id|fsf_req_p
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|req_queue
op_assign
op_amp
id|adapter-&gt;request_queue
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffere
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|condition
suffix:semicolon
multiline_comment|/* allocate new FSF request */
id|fsf_req
op_assign
id|zfcp_fsf_req_alloc
c_func
(paren
id|adapter
comma
id|fsf_cmd
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|fsf_req
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Could not put an FSF request into&quot;
l_string|&quot;the outbound (send) queue.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|failed_fsf_req
suffix:semicolon
)brace
multiline_comment|/* save pointer to &quot;parent&quot; adapter */
id|fsf_req-&gt;adapter
op_assign
id|adapter
suffix:semicolon
multiline_comment|/* initialize waitqueue which may be used to wait on &n;&t;   this request completion */
id|init_waitqueue_head
c_func
(paren
op_amp
id|fsf_req-&gt;completion_wq
)paren
suffix:semicolon
multiline_comment|/* set magics */
id|fsf_req-&gt;common_magic
op_assign
id|ZFCP_MAGIC
suffix:semicolon
id|fsf_req-&gt;specific_magic
op_assign
id|ZFCP_MAGIC_FSFREQ
suffix:semicolon
id|fsf_req-&gt;fsf_command
op_assign
id|fsf_cmd
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req_flags
op_amp
id|ZFCP_REQ_AUTO_CLEANUP
)paren
)paren
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_CLEANUP
suffix:semicolon
multiline_comment|/* initialize QTCB */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_cmd
op_ne
id|FSF_QTCB_UNSOLICITED_STATUS
)paren
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;fsf_req-&gt;qtcb=0x%lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req-&gt;qtcb
)paren
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;prefix.req_id
op_assign
(paren
r_int
r_int
)paren
id|fsf_req
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;prefix.ulp_info
op_assign
id|ZFCP_ULP_INFO_VERSION
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;prefix.qtcb_type
op_assign
id|fsf_qtcb_type
(braket
id|fsf_cmd
)braket
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;prefix.qtcb_version
op_assign
id|ZFCP_QTCB_VERSION
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.req_handle
op_assign
(paren
r_int
r_int
)paren
id|fsf_req
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.fsf_command
op_assign
id|fsf_cmd
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Request Sequence Number is set later when the request is&n;&t;&t; * actually sent.&n;&t;&t; */
)brace
multiline_comment|/*&n;&t; * try to get needed SBALs in request queue (get queue lock on success)&n;&t; */
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;try to get free BUFFER in request queue&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|req_flags
op_amp
id|ZFCP_WAIT_FOR_SBAL
)paren
)paren
(brace
id|timeout
op_assign
id|ZFCP_SBAL_TIMEOUT
suffix:semicolon
id|ZFCP_WAIT_EVENT_TIMEOUT
c_func
(paren
id|adapter-&gt;request_wq
comma
id|timeout
comma
(paren
id|condition
op_assign
(paren
id|zfcp_fsf_req_create_sbal_check
)paren
(paren
id|lock_flags
comma
id|req_queue
comma
l_int|1
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|condition
)paren
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|failed_sbals
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|zfcp_fsf_req_create_sbal_check
c_func
(paren
id|lock_flags
comma
id|req_queue
comma
l_int|1
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|failed_sbals
suffix:semicolon
)brace
)brace
id|fsf_req-&gt;sbal_count
op_assign
l_int|1
suffix:semicolon
id|fsf_req-&gt;sbal_index
op_assign
id|req_queue-&gt;free_index
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;got %i free BUFFERs starting at index %i&bslash;n&quot;
comma
id|fsf_req-&gt;sbal_count
comma
id|fsf_req-&gt;sbal_index
)paren
suffix:semicolon
id|buffere
op_assign
id|req_queue-&gt;buffer
(braket
id|fsf_req-&gt;sbal_index
)braket
op_member_access_from_pointer
id|element
suffix:semicolon
multiline_comment|/* setup common SBALE fields */
id|buffere
(braket
l_int|0
)braket
dot
id|addr
op_assign
id|fsf_req
suffix:semicolon
id|buffere
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_COMMAND
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_cmd
op_ne
id|FSF_QTCB_UNSOLICITED_STATUS
)paren
)paren
(brace
id|buffere
(braket
l_int|1
)braket
dot
id|addr
op_assign
(paren
r_void
op_star
)paren
id|fsf_req-&gt;qtcb
suffix:semicolon
id|buffere
(braket
l_int|1
)braket
dot
id|length
op_assign
id|ZFCP_QTCB_SIZE
suffix:semicolon
)brace
multiline_comment|/* set specific common SBALE and QTCB fields */
r_switch
c_cond
(paren
id|fsf_cmd
)paren
(brace
r_case
id|FSF_QTCB_FCP_CMND
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_QTCB_FCP_CMND&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * storage-block type depends on actual&n;&t;&t; * SCSI command and is set by calling&n;&t;&t; * routine according to transfer direction&n;&t;&t; * of data buffers associated with SCSI&n;&t;&t; * command&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|FSF_QTCB_ABORT_FCP_CMND
suffix:colon
r_case
id|FSF_QTCB_OPEN_PORT_WITH_DID
suffix:colon
r_case
id|FSF_QTCB_OPEN_LUN
suffix:colon
r_case
id|FSF_QTCB_CLOSE_LUN
suffix:colon
r_case
id|FSF_QTCB_CLOSE_PORT
suffix:colon
r_case
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
suffix:colon
r_case
id|FSF_QTCB_SEND_ELS
suffix:colon
multiline_comment|/* FIXME: ELS needs separate case */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_QTCB_*&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FIXME(qdio):&n;&t;&t; * what is the correct type for commands&n;&t;&t; * without &squot;real&squot; data buffers?&n;&t;&t; */
id|buffere
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|buffere
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_QTCB_EXCHANGE_CONFIG_DATA&bslash;n&quot;
)paren
suffix:semicolon
id|buffere
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|buffere
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_SEND_GENERIC
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_QTCB_SEND_GENERIC&bslash;n&quot;
)paren
suffix:semicolon
id|buffere
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_WRITE_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_UNSOLICITED_STATUS
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_QTCB_UNSOLICITED_STATUS&bslash;n&quot;
)paren
suffix:semicolon
id|buffere
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_STATUS
suffix:semicolon
id|buffere
(braket
l_int|2
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An attempt to send an unsupported &quot;
l_string|&quot;command has been detected. &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_cmd
)paren
suffix:semicolon
r_goto
id|unsupported_fsf_cmd
suffix:semicolon
)brace
multiline_comment|/* yes, we did it - skip all cleanups for different failures */
r_goto
id|out
suffix:semicolon
id|unsupported_fsf_cmd
suffix:colon
id|failed_sbals
suffix:colon
macro_line|#ifdef ZFCP_STAT_QUEUES
id|atomic_inc
c_func
(paren
op_amp
id|zfcp_data.outbound_queue_full
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* dequeue new FSF request previously enqueued */
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
id|failed_fsf_req
suffix:colon
id|write_lock_irqsave
c_func
(paren
op_amp
id|req_queue-&gt;queue_lock
comma
op_star
id|lock_flags
)paren
suffix:semicolon
id|out
suffix:colon
op_star
id|fsf_req_p
op_assign
id|fsf_req
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_send&n; *&n; * purpose:&t;start transfer of FSF request via QDIO&n; *&n; * returns:&t;0 - request transfer succesfully started&n; *&t;&t;!0 - start of request transfer failed&n; */
r_static
r_int
DECL|function|zfcp_fsf_req_send
id|zfcp_fsf_req_send
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
r_struct
id|timer_list
op_star
id|timer
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|req_queue
op_assign
op_amp
id|adapter-&gt;request_queue
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|buffere
suffix:semicolon
r_int
id|inc_seq_no
op_assign
l_int|1
suffix:semicolon
r_int
id|new_distance_from_int
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u8
id|sbal_index
op_assign
id|fsf_req-&gt;sbal_index
suffix:semicolon
multiline_comment|/* FIXME(debug): remove it later */
id|buffere
op_assign
op_amp
(paren
id|req_queue-&gt;buffer
(braket
id|sbal_index
)braket
op_member_access_from_pointer
id|element
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;zeroeth BUFFERE flags=0x%x &bslash;n &quot;
comma
id|buffere-&gt;flags
)paren
suffix:semicolon
id|buffere
op_assign
op_amp
(paren
id|req_queue-&gt;buffer
(braket
id|sbal_index
)braket
op_member_access_from_pointer
id|element
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;HEX DUMP OF 0eth BUFFERE PAYLOAD:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_char
op_star
)paren
id|buffere-&gt;addr
comma
id|buffere-&gt;length
)paren
suffix:semicolon
multiline_comment|/* set sequence counter in QTCB */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;qtcb
)paren
)paren
(brace
id|fsf_req-&gt;qtcb-&gt;prefix.req_seq_no
op_assign
id|adapter-&gt;fsf_req_seq_no
suffix:semicolon
id|fsf_req-&gt;seq_no
op_assign
id|adapter-&gt;fsf_req_seq_no
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;FSF request 0x%lx of adapter 0x%lx gets &quot;
l_string|&quot;FSF sequence counter value of %i&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
comma
(paren
r_int
r_int
)paren
id|adapter
comma
id|fsf_req-&gt;qtcb-&gt;prefix.req_seq_no
)paren
suffix:semicolon
)brace
r_else
id|inc_seq_no
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* put allocated FSF request at list tail */
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|fsf_req-&gt;list
comma
op_amp
id|adapter-&gt;fsf_req_list_head
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* figure out expiration time of timeout and start timeout */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|timer
)paren
)paren
(brace
id|timer-&gt;expires
op_add_assign
id|jiffies
suffix:semicolon
id|add_timer
c_func
(paren
id|timer
)paren
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;request queue of adapter with busid=%s: &quot;
l_string|&quot;next free SBAL is %i, %i free SBALs&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|req_queue-&gt;free_index
comma
id|atomic_read
c_func
(paren
op_amp
id|req_queue-&gt;free_count
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Calling do QDIO busid=%s, flags=0x%x, queue_no=%i, &quot;
l_string|&quot;index_in_queue=%i, count=%i, buffers=0x%lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|QDIO_FLAG_SYNC_OUTPUT
comma
l_int|0
comma
id|sbal_index
comma
id|fsf_req-&gt;sbal_count
comma
(paren
r_int
r_int
)paren
op_amp
id|req_queue-&gt;buffer
(braket
id|sbal_index
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * adjust the number of free SBALs in request queue as well as&n;&t; * position of first one&n;&t; */
id|atomic_sub
c_func
(paren
id|fsf_req-&gt;sbal_count
comma
op_amp
id|req_queue-&gt;free_count
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;free_count=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|req_queue-&gt;free_count
)paren
)paren
suffix:semicolon
id|req_queue-&gt;free_index
op_add_assign
id|fsf_req-&gt;sbal_count
suffix:semicolon
multiline_comment|/* increase */
id|req_queue-&gt;free_index
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
multiline_comment|/* wrap if needed */
id|new_distance_from_int
op_assign
id|zfcp_qdio_determine_pci
c_func
(paren
id|req_queue
comma
id|fsf_req
)paren
suffix:semicolon
id|retval
op_assign
id|do_QDIO
c_func
(paren
id|adapter-&gt;ccw_device
comma
id|QDIO_FLAG_SYNC_OUTPUT
comma
l_int|0
comma
id|fsf_req-&gt;sbal_index
comma
id|fsf_req-&gt;sbal_count
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
)paren
)paren
(brace
multiline_comment|/* Queues are down..... */
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FIXME(potential race):&n;&t;&t; * timer might be expired (absolutely unlikely)&n;&t;&t; */
r_if
c_cond
(paren
id|timer
)paren
id|del_timer_sync
c_func
(paren
id|timer
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|fsf_req-&gt;list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * adjust the number of free SBALs in request queue as well as&n;&t;&t; * position of first one&n;&t;&t; */
id|zfcp_qdio_zero_sbals
c_func
(paren
id|req_queue-&gt;buffer
comma
id|fsf_req-&gt;sbal_index
comma
id|fsf_req-&gt;sbal_count
)paren
suffix:semicolon
id|atomic_add
c_func
(paren
id|fsf_req-&gt;sbal_count
comma
op_amp
id|req_queue-&gt;free_count
)paren
suffix:semicolon
id|req_queue-&gt;free_index
op_sub_assign
id|fsf_req-&gt;sbal_count
suffix:semicolon
multiline_comment|/* increase */
id|req_queue-&gt;free_index
op_add_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|req_queue-&gt;free_index
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
multiline_comment|/* wrap */
id|ZFCP_LOG_DEBUG
(paren
l_string|&quot;error: do_QDIO failed. Buffers could not be enqueued &quot;
l_string|&quot;to request queue.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|req_queue-&gt;distance_from_int
op_assign
id|new_distance_from_int
suffix:semicolon
macro_line|#ifdef ZFCP_DEBUG_REQUESTS
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
l_string|&quot;o:a/seq&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
op_amp
id|fsf_req
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|inc_seq_no
)paren
)paren
(brace
id|debug_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
op_amp
id|adapter-&gt;fsf_req_seq_no
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;req_dbf
comma
l_int|1
comma
l_string|&quot;nocb&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* ZFCP_DEBUG_REQUESTS */
multiline_comment|/*&n;&t;&t; * increase FSF sequence counter -&n;&t;&t; * this must only be done for request successfully enqueued to&n;&t;&t; * QDIO this rejected requests may be cleaned up by calling&n;&t;&t; * routines  resulting in missing sequence counter values&n;&t;&t; * otherwise,&n;&t;&t; */
multiline_comment|/* Don&squot;t increase for unsolicited status */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|inc_seq_no
)paren
)paren
(brace
id|adapter-&gt;fsf_req_seq_no
op_increment
suffix:semicolon
id|ZFCP_LOG_TRACE
(paren
l_string|&quot;FSF sequence counter value of adapter 0x%lx &quot;
l_string|&quot;increased to %i&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|adapter
comma
id|adapter-&gt;fsf_req_seq_no
)paren
suffix:semicolon
)brace
multiline_comment|/* count FSF requests pending */
id|atomic_inc
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
suffix:semicolon
macro_line|#ifdef ZFCP_STAT_QUEUES
id|atomic_inc
c_func
(paren
op_amp
id|zfcp_data.outbound_total
)paren
suffix:semicolon
macro_line|#endif
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_cleanup&n; *&n; * purpose:&t;cleans up an FSF request and removes it from the specified list&n; *&n; * returns:&n; *&n; * assumption:&t;no pending SB in SBALEs other than QTCB&n; */
r_void
DECL|function|zfcp_fsf_req_cleanup
id|zfcp_fsf_req_cleanup
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|fsf_req-&gt;list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * try to allocate fsf_req with QTCB,&n; * alternately try to get hold of fsf_req+QTCB provided by the specified memory&n; * pool element, this routine is called for all kinds of fsf requests other than&n; * status read since status read does neither require kmalloc involvement&n; * nor a QTCB&n; */
r_static
r_struct
id|zfcp_fsf_req
op_star
DECL|function|zfcp_fsf_req_get
id|zfcp_fsf_req_get
c_func
(paren
r_int
id|kmalloc_flags
comma
id|mempool_t
op_star
id|pool
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
id|fsf_req
op_assign
id|kmalloc
c_func
(paren
id|ZFCP_QTCB_AND_REQ_SIZE
comma
id|kmalloc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req
)paren
)paren
(brace
id|memset
c_func
(paren
id|fsf_req
comma
l_int|0
comma
id|ZFCP_QTCB_AND_REQ_SIZE
)paren
suffix:semicolon
)brace
r_else
(brace
id|fsf_req
op_assign
id|mempool_alloc
c_func
(paren
id|pool
comma
id|kmalloc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req
)paren
)paren
(brace
id|memset
c_func
(paren
id|fsf_req
comma
l_int|0
comma
id|ZFCP_QTCB_AND_REQ_SIZE
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_POOL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req
)paren
)paren
id|fsf_req-&gt;qtcb
op_assign
(paren
r_struct
id|fsf_qtcb
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|fsf_req
op_plus
r_sizeof
(paren
r_struct
id|zfcp_fsf_req
)paren
)paren
suffix:semicolon
r_return
id|fsf_req
suffix:semicolon
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
DECL|macro|ZFCP_LOG_AREA_PREFIX
macro_line|#undef ZFCP_LOG_AREA_PREFIX
eof
