multiline_comment|/*&n; *&n; * linux/drivers/s390/scsi/zfcp_fsf.c&n; *&n; * FCP adapter driver for IBM eServer zSeries&n; *&n; * (C) Copyright IBM Corp. 2002, 2004&n; *&n; * Author(s): Martin Peschke &lt;mpeschke@de.ibm.com&gt;&n; *            Raimund Schroeder &lt;raimund.schroeder@de.ibm.com&gt;&n; *            Aron Zeh&n; *            Wolfgang Taphorn&n; *            Stefan Bader &lt;stefan.bader@de.ibm.com&gt;&n; *            Heiko Carstens &lt;heiko.carstens@de.ibm.com&gt;&n; *            Andreas Herrmann &lt;aherrman@de.ibm.com&gt;&n; *            Volker Sameske &lt;sameske@de.ibm.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/* this drivers version (do not edit !!! generated and updated by cvs) */
DECL|macro|ZFCP_FSF_C_REVISION
mdefine_line|#define ZFCP_FSF_C_REVISION &quot;$Revision: 1.83 $&quot;
macro_line|#include &quot;zfcp_ext.h&quot;
r_static
r_int
id|zfcp_fsf_exchange_config_data_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_fsf_exchange_port_data_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_open_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_close_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_close_physical_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_open_unit_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_close_unit_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_fcp_command_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_fcp_command_task_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_fcp_command_task_management_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_abort_fcp_command_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_status_read_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_ct_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_send_els_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_control_file_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_inline
r_int
id|zfcp_fsf_req_sbal_check
c_func
(paren
r_int
r_int
op_star
comma
r_struct
id|zfcp_qdio_queue
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_inline
r_int
id|zfcp_use_one_sbal
c_func
(paren
r_struct
id|scatterlist
op_star
comma
r_int
comma
r_struct
id|scatterlist
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_struct
id|zfcp_fsf_req
op_star
id|zfcp_fsf_req_alloc
c_func
(paren
id|mempool_t
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_req_send
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
comma
r_struct
id|timer_list
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_protstatus_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_fsfstatus_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_fsfstatus_qual_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_int
id|zfcp_fsf_req_dispatch
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_fsf_req_dismiss
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
r_static
r_void
id|zfcp_fsf_req_free
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
suffix:semicolon
multiline_comment|/* association between FSF command and FSF QTCB type */
DECL|variable|fsf_qtcb_type
r_static
id|u32
id|fsf_qtcb_type
(braket
)braket
op_assign
(brace
(braket
id|FSF_QTCB_FCP_CMND
)braket
op_assign
id|FSF_IO_COMMAND
comma
(braket
id|FSF_QTCB_ABORT_FCP_CMND
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_OPEN_PORT_WITH_DID
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_OPEN_LUN
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_CLOSE_LUN
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_CLOSE_PORT
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_SEND_ELS
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_SEND_GENERIC
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
)braket
op_assign
id|FSF_CONFIG_COMMAND
comma
(braket
id|FSF_QTCB_EXCHANGE_PORT_DATA
)braket
op_assign
id|FSF_PORT_COMMAND
comma
(braket
id|FSF_QTCB_DOWNLOAD_CONTROL_FILE
)braket
op_assign
id|FSF_SUPPORT_COMMAND
comma
(braket
id|FSF_QTCB_UPLOAD_CONTROL_FILE
)braket
op_assign
id|FSF_SUPPORT_COMMAND
)brace
suffix:semicolon
DECL|variable|zfcp_act_subtable_type
r_static
r_const
r_char
id|zfcp_act_subtable_type
(braket
l_int|5
)braket
(braket
l_int|8
)braket
op_assign
(brace
l_string|&quot;unknown&quot;
comma
l_string|&quot;OS&quot;
comma
l_string|&quot;WWPN&quot;
comma
l_string|&quot;DID&quot;
comma
l_string|&quot;LUN&quot;
)brace
suffix:semicolon
multiline_comment|/****************************************************************/
multiline_comment|/*************** FSF related Functions  *************************/
multiline_comment|/****************************************************************/
DECL|macro|ZFCP_LOG_AREA
mdefine_line|#define ZFCP_LOG_AREA&t;&t;&t;ZFCP_LOG_AREA_FSF
multiline_comment|/*&n; * function:&t;zfcp_fsf_req_alloc&n; *&n; * purpose:     Obtains an fsf_req and potentially a qtcb (for all but &n; *              unsolicited requests) via helper functions&n; *              Does some initial fsf request set-up.&n; *              &n; * returns:&t;pointer to allocated fsf_req if successfull&n; *              NULL otherwise&n; *&n; * locks:       none&n; *&n; */
r_static
r_struct
id|zfcp_fsf_req
op_star
DECL|function|zfcp_fsf_req_alloc
id|zfcp_fsf_req_alloc
c_func
(paren
id|mempool_t
op_star
id|pool
comma
r_int
id|req_flags
)paren
(brace
r_int
id|size
suffix:semicolon
r_void
op_star
id|ptr
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|req_flags
op_amp
id|ZFCP_REQ_NO_QTCB
)paren
id|size
op_assign
r_sizeof
(paren
r_struct
id|zfcp_fsf_req
)paren
suffix:semicolon
r_else
id|size
op_assign
r_sizeof
(paren
r_struct
id|zfcp_fsf_req_pool_element
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|pool
op_ne
l_int|NULL
)paren
)paren
id|ptr
op_assign
id|mempool_alloc
c_func
(paren
id|pool
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_else
id|ptr
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
l_int|NULL
op_eq
id|ptr
)paren
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|ptr
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req_flags
op_amp
id|ZFCP_REQ_NO_QTCB
)paren
(brace
id|fsf_req
op_assign
(paren
r_struct
id|zfcp_fsf_req
op_star
)paren
id|ptr
suffix:semicolon
)brace
r_else
(brace
id|fsf_req
op_assign
op_amp
(paren
(paren
r_struct
id|zfcp_fsf_req_pool_element
op_star
)paren
id|ptr
)paren
op_member_access_from_pointer
id|fsf_req
suffix:semicolon
id|fsf_req-&gt;qtcb
op_assign
op_amp
(paren
(paren
r_struct
id|zfcp_fsf_req_pool_element
op_star
)paren
id|ptr
)paren
op_member_access_from_pointer
id|qtcb
suffix:semicolon
)brace
id|fsf_req-&gt;pool
op_assign
id|pool
suffix:semicolon
id|out
suffix:colon
r_return
id|fsf_req
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_req_free&n; *&n; * purpose:     Frees the memory of an fsf_req (and potentially a qtcb) or&n; *              returns it into the pool via helper functions.&n; *&n; * returns:     sod all&n; *&n; * locks:       none&n; */
r_static
r_void
DECL|function|zfcp_fsf_req_free
id|zfcp_fsf_req_free
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;pool
op_ne
l_int|NULL
)paren
)paren
id|mempool_free
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;pool
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; *&n; * note: qdio queues shall be down (no ongoing inbound processing)&n; */
r_int
DECL|function|zfcp_fsf_req_dismiss_all
id|zfcp_fsf_req_dismiss_all
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
op_star
id|tmp
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|fsf_req
comma
id|tmp
comma
op_amp
id|adapter-&gt;fsf_req_list_head
comma
id|list
)paren
id|zfcp_fsf_req_dismiss
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/* wait_event_timeout? */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_head
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;fsf req list of adapter %s not yet empty&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for woken intiators to clean up their requests */
id|msleep
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|ZFCP_FSFREQ_CLEANUP_TIMEOUT
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* consistency check */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: There are still %d FSF requests pending &quot;
l_string|&quot;on adapter %s after cleanup.&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;&n; *&n; * purpose:&t;&n; *&n; * returns:&n; */
r_static
r_void
DECL|function|zfcp_fsf_req_dismiss
id|zfcp_fsf_req_dismiss
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_DISMISSED
suffix:semicolon
id|zfcp_fsf_req_complete
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_complete&n; *&n; * purpose:&t;Updates active counts and timers for openfcp-reqs&n; *              May cleanup request after req_eval returns&n; *&n; * returns:&t;0 - success&n; *&t;&t;!0 - failure&n; *&n; * context:&t;&n; */
r_int
DECL|function|zfcp_fsf_req_complete
id|zfcp_fsf_req_complete
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|cleanup
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
multiline_comment|/* do some statistics */
id|atomic_dec
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;fsf_command
op_eq
id|FSF_QTCB_UNSOLICITED_STATUS
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Status read response received&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Note: all cleanup handling is done in the callchain of&n;&t;&t; * the function call-chain below.&n;&t;&t; */
id|zfcp_fsf_status_read_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
id|zfcp_fsf_protstatus_eval
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * fsf_req may be deleted due to waking up functions, so &n;&t; * cleanup is saved here and used later &n;&t; */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_CLEANUP
)paren
)paren
id|cleanup
op_assign
l_int|1
suffix:semicolon
r_else
id|cleanup
op_assign
l_int|0
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_COMPLETED
suffix:semicolon
multiline_comment|/* cleanup request if requested by initiator */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|cleanup
)paren
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;removing FSF request %p&bslash;n&quot;
comma
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * lock must not be held here since it will be&n;&t;&t; * grabed by the called routine, too&n;&t;&t; */
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* notify initiator waiting for the requests completion */
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;waking initiator of FSF request %p&bslash;n&quot;
comma
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FIXME: Race! We must not access fsf_req here as it might have been&n;&t;&t; * cleaned up already due to the set ZFCP_STATUS_FSFREQ_COMPLETED&n;&t;&t; * flag. It&squot;s an improbable case. But, we have the same paranoia for&n;&t;&t; * the cleanup flag already.&n;&t;&t; * Might better be handled using complete()?&n;&t;&t; * (setting the flag and doing wakeup ought to be atomic&n;&t;&t; *  with regard to checking the flag as long as waitqueue is&n;&t;&t; *  part of the to be released structure)&n;&t;&t; */
id|wake_up
c_func
(paren
op_amp
id|fsf_req-&gt;completion_wq
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_protstatus_eval&n; *&n; * purpose:&t;evaluates the QTCB of the finished FSF request&n; *&t;&t;and initiates appropriate actions&n; *&t;&t;(usually calling FSF command specific handlers)&n; *&n; * returns:&t;&n; *&n; * context:&t;&n; *&n; * locks:&n; */
r_static
r_int
DECL|function|zfcp_fsf_protstatus_eval
id|zfcp_fsf_protstatus_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;QTCB is at %p&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_DISMISSED
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;fsf_req 0x%lx has been dismissed&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
multiline_comment|/* only for SCSI cmnds. */
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;dismiss&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_protstatus
suffix:semicolon
)brace
multiline_comment|/* log additional information provided by FSF (if any) */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;qtcb-&gt;header.log_length
)paren
)paren
(brace
multiline_comment|/* do not trust them ;-) */
r_if
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.log_start
OG
r_sizeof
(paren
r_struct
id|fsf_qtcb
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: ULP (FSF logging) log data starts &quot;
l_string|&quot;beyond end of packet header. Ignored. &quot;
l_string|&quot;(start=%i, size=%li)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.log_start
comma
r_sizeof
(paren
r_struct
id|fsf_qtcb
)paren
)paren
suffix:semicolon
r_goto
id|forget_log
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|fsf_req-&gt;qtcb-&gt;header.log_start
op_plus
id|fsf_req-&gt;qtcb-&gt;header.log_length
)paren
OG
r_sizeof
(paren
r_struct
id|fsf_qtcb
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: ULP (FSF logging) log data ends &quot;
l_string|&quot;beyond end of packet header. Ignored. &quot;
l_string|&quot;(start=%i, length=%i, size=%li)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.log_start
comma
id|fsf_req-&gt;qtcb-&gt;header.log_length
comma
r_sizeof
(paren
r_struct
id|fsf_qtcb
)paren
)paren
suffix:semicolon
r_goto
id|forget_log
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;ULP log data: &bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_char
op_star
)paren
id|fsf_req-&gt;qtcb
op_plus
id|fsf_req-&gt;qtcb-&gt;header.log_start
comma
id|fsf_req-&gt;qtcb-&gt;header.log_length
)paren
suffix:semicolon
)brace
id|forget_log
suffix:colon
multiline_comment|/* evaluate FSF Protocol Status */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status
)paren
(brace
r_case
id|FSF_PROT_GOOD
suffix:colon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;FSF_PROT_GOOD&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_FSF_STATUS_PRESENTED
suffix:colon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;FSF_PROT_FSF_STATUS_PRESENTED&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_QTCB_VERSION_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_QTCB_VERSION_ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The adapter %s contains &quot;
l_string|&quot;microcode of version 0x%x, the device driver &quot;
l_string|&quot;only supports 0x%x. Aborting.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
dot
id|version_error.fsf_version
comma
id|ZFCP_QTCB_VERSION
)paren
suffix:semicolon
multiline_comment|/* stop operation for this adapter */
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_ver_err&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;qverserr&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_SEQ_NUMB_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_SEQ_NUMB_ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Sequence number mismatch between &quot;
l_string|&quot;driver (0x%x) and adapter %s (0x%x). &quot;
l_string|&quot;Restarting all operations on this adapter.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;prefix.req_seq_no
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
dot
id|sequence_error.exp_req_seq_no
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_seq_err&quot;
)paren
suffix:semicolon
multiline_comment|/* restart operation on this adapter */
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;seqnoerr&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_UNSUPP_QTCB_TYPE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_UNSUP_QTCB_TYPE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: Packet header type used by the &quot;
l_string|&quot;device driver is incompatible with &quot;
l_string|&quot;that used on adapter %s. &quot;
l_string|&quot;Stopping all operations on this adapter.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_unsup_qtcb&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;unsqtcbt&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_HOST_CONNECTION_INITIALIZING
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PROT_HOST_CONNECTION_INITIALIZING&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;hconinit&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_HOST_CON_INIT
comma
op_amp
(paren
id|adapter-&gt;status
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;prot_con_init&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_DUPLICATE_REQUEST_ID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_DUPLICATE_REQUEST_IDS&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;qtcb
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The request identifier 0x%Lx &quot;
l_string|&quot;to the adapter %s is ambiguous. &quot;
l_string|&quot;Stopping all operations on this &quot;
l_string|&quot;adapter.&bslash;n&quot;
comma
op_star
(paren
r_int
r_int
r_int
op_star
)paren
(paren
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.support
dot
id|req_handle
)paren
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The request identifier %p &quot;
l_string|&quot;to the adapter %s is ambiguous. &quot;
l_string|&quot;Stopping all operations on this &quot;
l_string|&quot;adapter. &quot;
l_string|&quot;(bug: got this for an unsolicited &quot;
l_string|&quot;status read request)&bslash;n&quot;
comma
id|fsf_req
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_dup_id&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;dupreqid&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_LINK_DOWN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PROT_LINK_DOWN&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * &squot;test and set&squot; is not atomic here -&n;&t;&t; * it&squot;s ok as long as calls to our response queue handler&n;&t;&t; * (and thus execution of this code here) are serialized&n;&t;&t; * by the qdio module&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
dot
id|locallink_error.code
)paren
(brace
r_case
id|FSF_PSQ_LINK_NOLIGHT
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter %s &quot;
l_string|&quot;is down (no light detected).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PSQ_LINK_WRAPPLUG
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter %s &quot;
l_string|&quot;is down (wrap plug detected).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PSQ_LINK_NOFCP
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter %s &quot;
l_string|&quot;is down (adjacent node on &quot;
l_string|&quot;link does not support FCP).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter %s &quot;
l_string|&quot;is down &quot;
l_string|&quot;(warning: unknown reason &quot;
l_string|&quot;code).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Due to the &squot;erp failed&squot; flag the adapter won&squot;t&n;&t;&t;&t; * be recovered but will be just set to &squot;blocked&squot;&n;&t;&t;&t; * state. All subordinary devices will have state&n;&t;&t;&t; * &squot;blocked&squot; and &squot;erp failed&squot;, too.&n;&t;&t;&t; * Thus the adapter is still able to provide&n;&t;&t;&t; * &squot;link up&squot; status without being flooded with&n;&t;&t;&t; * requests.&n;&t;&t;&t; * (note: even &squot;close port&squot; is not permitted)&n;&t;&t;&t; */
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Stopping all operations for adapter &quot;
l_string|&quot;%s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;prot_link_down&quot;
)paren
suffix:semicolon
)brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_REEST_QUEUE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PROT_REEST_QUEUE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;prot_reest_queue&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The local link to adapter with &quot;
l_string|&quot;%s was re-plugged. &quot;
l_string|&quot;Re-starting operations on this adapter.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* All ports should be marked as ready to run again */
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;reestque&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PROT_ERROR_STATE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PROT_ERROR_STATE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The adapter %s &quot;
l_string|&quot;has entered the error state. &quot;
l_string|&quot;Restarting all operations on this &quot;
l_string|&quot;adapter.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_err_sta&quot;
)paren
suffix:semicolon
multiline_comment|/* restart operation on this adapter */
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;proterrs&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_prot_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Transfer protocol status information &quot;
l_string|&quot;provided by the adapter %s &quot;
l_string|&quot;is not compatible with the device driver. &quot;
l_string|&quot;Stopping all operations on this adapter. &quot;
l_string|&quot;(debug info 0x%x).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;prot_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;prefix.prot_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
)brace
id|skip_protstatus
suffix:colon
multiline_comment|/*&n;&t; * always call specific handlers to give them a chance to do&n;&t; * something meaningful even in error cases&n;&t; */
id|zfcp_fsf_fsfstatus_eval
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_fsfstatus_eval&n; *&n; * purpose:&t;evaluates FSF status of completed FSF request&n; *&t;&t;and acts accordingly&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_fsfstatus_eval
id|zfcp_fsf_fsfstatus_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
)paren
(brace
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF Status */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_UNKNOWN_COMMAND
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_UNKNOWN_COMMAND&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Command issued by the device driver is &quot;
l_string|&quot;not known by the adapter %s &quot;
l_string|&quot;Stopping all operations on this adapter. &quot;
l_string|&quot;(debug info 0x%x).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_command
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_unknown&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|fsf_req-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;unknownc&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_FCP_RSP_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_FCP_RSP_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;FCP Sense data will be presented to the &quot;
l_string|&quot;SCSI stack.&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;fsf_s_rsp&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_astatus&quot;
)paren
suffix:semicolon
id|zfcp_fsf_fsfstatus_qual_eval
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
multiline_comment|/*&n;&t; * always call specific handlers to give them a chance to do&n;&t; * something meaningful even in error cases&n;&t; */
id|zfcp_fsf_req_dispatch
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_fsfstatus_qual_eval&n; *&n; * purpose:&t;evaluates FSF status-qualifier of completed FSF request&n; *&t;&t;and acts accordingly&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_fsfstatus_qual_eval
id|zfcp_fsf_fsfstatus_qual_eval
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_FCP_RSP_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_FCP_RSP_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|4
comma
l_string|&quot;fsf_sq_rsp&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_RETRY_IF_POSSIBLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_RETRY_IF_POSSIBLE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* The SCSI-stack may now issue retries or escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_sq_retry&quot;
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqretry&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_COMMAND_ABORTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_COMMAND_ABORTED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Carry the aborted state on to upper layer */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_sq_abort&quot;
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqabort&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ABORTED
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_NO_RECOM
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SQ_NO_RECOM&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_no_rec&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: No recommendation could be given for a&quot;
l_string|&quot;problem on the adapter %s &quot;
l_string|&quot;Stopping all operations on this adapter. &quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|fsf_req-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqnrecom&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_PROGRAMMING_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SQ_ULP_PROGRAMMING_ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: not enough SBALs for data transfer &quot;
l_string|&quot;(adapter %s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_ulp_err&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
r_case
id|FSF_SQ_NO_RETRY_POSSIBLE
suffix:colon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
multiline_comment|/* dealt with in the respective functions */
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Additional status info could &quot;
l_string|&quot;not be interpreted properly.&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;squndef&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&t;zfcp_fsf_req_dispatch&n; *&n; * purpose:&t;calls the appropriate command specific handler&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_req_dispatch
id|zfcp_fsf_req_dispatch
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|zfcp_erp_action
op_star
id|erp_action
op_assign
id|fsf_req-&gt;erp_action
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
)paren
(brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;fsf_req=%p, QTCB=%p&bslash;n&quot;
comma
id|fsf_req
comma
id|fsf_req-&gt;qtcb
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_char
op_star
)paren
id|fsf_req-&gt;qtcb
comma
r_sizeof
(paren
r_struct
id|fsf_qtcb
)paren
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|fsf_req-&gt;fsf_command
)paren
(brace
r_case
id|FSF_QTCB_FCP_CMND
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_QTCB_FCP_CMND&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_send_fcp_command_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_ABORT_FCP_CMND
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_ABORT_FCP_CMND&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_abort_fcp_command_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_SEND_GENERIC
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_SEND_GENERIC&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_send_ct_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_OPEN_PORT_WITH_DID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_OPEN_PORT_WITH_DID&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_open_port_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_OPEN_LUN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_OPEN_LUN&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_open_unit_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_CLOSE_LUN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_CLOSE_LUN&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_close_unit_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_CLOSE_PORT
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_CLOSE_PORT&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_close_port_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_CLOSE_PHYSICAL_PORT&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_close_physical_port_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_EXCHANGE_CONFIG_DATA&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_exchange_config_data_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_EXCHANGE_PORT_DATA
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_EXCHANGE_PORT_DATA&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_exchange_port_data_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_SEND_ELS
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_SEND_ELS&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_send_els_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_DOWNLOAD_CONTROL_FILE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_DOWNLOAD_CONTROL_FILE&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_control_file_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_UPLOAD_CONTROL_FILE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_UPLOAD_CONTROL_FILE&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_fsf_control_file_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_QTCB_UNKNOWN&bslash;n&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Command issued by the device driver is &quot;
l_string|&quot;not supported by the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;fsf_command
op_ne
id|fsf_req-&gt;qtcb-&gt;header.fsf_command
)paren
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Command issued by the device driver differs &quot;
l_string|&quot;from the command returned by the adapter %s &quot;
l_string|&quot;(debug info 0x%x, 0x%x).&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|fsf_req-&gt;adapter
)paren
comma
id|fsf_req-&gt;fsf_command
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_command
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|erp_action
)paren
r_return
id|retval
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;a_frh&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|erp_action-&gt;action
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|zfcp_erp_async_handler
c_func
(paren
id|erp_action
comma
l_int|0
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_status_read&n; *&n; * purpose:&t;initiates a Status Read command at the specified adapter&n; *&n; * returns:&n; */
r_int
DECL|function|zfcp_fsf_status_read
id|zfcp_fsf_status_read
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|req_flags
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_UNSOLICITED_STATUS
comma
id|req_flags
op_or
id|ZFCP_REQ_NO_QTCB
comma
id|adapter-&gt;pool.fsf_req_status_read
comma
op_amp
id|lock_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create unsolicited status &quot;
l_string|&quot;buffer for adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|failed_req_create
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_STATUS
suffix:semicolon
id|sbale
(braket
l_int|2
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|fsf_req-&gt;sbale_curr
op_assign
l_int|2
suffix:semicolon
id|status_buffer
op_assign
id|mempool_alloc
c_func
(paren
id|adapter-&gt;pool.data_status_read
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status_buffer
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: could not get some buffer&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_buf
suffix:semicolon
)brace
id|memset
c_func
(paren
id|status_buffer
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;data.status_read.buffer
op_assign
id|status_buffer
suffix:semicolon
multiline_comment|/* insert pointer to respective buffer */
id|sbale
op_assign
id|zfcp_qdio_sbale_curr
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|sbale-&gt;addr
op_assign
(paren
r_void
op_star
)paren
id|status_buffer
suffix:semicolon
id|sbale-&gt;length
op_assign
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Could not set-up unsolicited status &quot;
l_string|&quot;environment.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_req_send
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Status Read request initiated (adapter%s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|failed_req_send
suffix:colon
id|mempool_free
c_func
(paren
id|status_buffer
comma
id|adapter-&gt;pool.data_status_read
)paren
suffix:semicolon
id|failed_buf
suffix:colon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|failed_req_create
suffix:colon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_int
DECL|function|zfcp_fsf_status_read_port_closed
id|zfcp_fsf_status_read_port_closed
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|status_buffer
op_assign
id|fsf_req-&gt;data.status_read.buffer
suffix:semicolon
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|port
comma
op_amp
id|adapter-&gt;port_list_head
comma
id|list
)paren
r_if
c_cond
(paren
id|port-&gt;d_id
op_eq
(paren
id|status_buffer-&gt;d_id
op_amp
id|ZFCP_DID_MASK
)paren
)paren
r_break
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|zfcp_data.config_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
op_logical_or
(paren
id|port-&gt;d_id
op_ne
(paren
id|status_buffer-&gt;d_id
op_amp
id|ZFCP_DID_MASK
)paren
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Reopen port indication received for&quot;
l_string|&quot;nonexisting port with d_id 0x%08x on &quot;
l_string|&quot;adapter %s. Ignored.&bslash;n&quot;
comma
id|status_buffer-&gt;d_id
op_amp
id|ZFCP_DID_MASK
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status_buffer-&gt;status_subtype
)paren
(brace
r_case
id|FSF_STATUS_READ_SUB_CLOSE_PHYS_PORT
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_STATUS_READ_SUB_CLOSE_PHYS_PORT&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_pc_phys:&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_SUB_ERROR_PORT
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_SUB_ERROR_PORT&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;unsol_pc_err:&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_shutdown
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;unsol_unk_sub:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|status_buffer-&gt;status_subtype
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Undefined status subtype received &quot;
l_string|&quot;for a reopen indication on port with &quot;
l_string|&quot;d_id 0x%08x on the adapter %s. &quot;
l_string|&quot;Ignored. (debug info 0x%x)&bslash;n&quot;
comma
id|status_buffer-&gt;d_id
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|status_buffer-&gt;status_subtype
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_status_read_handler&n; *&n; * purpose:&t;is called for finished Open Port command&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_status_read_handler
id|zfcp_fsf_status_read_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_struct
id|fsf_status_read_buffer
op_star
id|status_buffer
op_assign
id|fsf_req-&gt;data.status_read.buffer
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_DISMISSED
)paren
(brace
id|mempool_free
c_func
(paren
id|status_buffer
comma
id|adapter-&gt;pool.data_status_read
)paren
suffix:semicolon
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status_buffer-&gt;status_type
)paren
(brace
r_case
id|FSF_STATUS_READ_PORT_CLOSED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_PORT_CLOSED&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_pclosed:&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
op_amp
id|status_buffer-&gt;d_id
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_fsf_status_read_port_closed
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_INCOMING_ELS
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_INCOMING_ELS&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_els:&quot;
)paren
suffix:semicolon
id|zfcp_fsf_incoming_els
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_SENSE_DATA_AVAIL
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_SENSE_DATA_AVAIL&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_sense:&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;unsolicited sense data received (adapter %s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|status_buffer
comma
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_BIT_ERROR_THRESHOLD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_BIT_ERROR_THRESHOLD&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;unsol_bit_err:&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Bit error threshold data received:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
id|status_buffer
comma
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_LINK_DOWN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_LINK_DOWN&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;unsol_link_down:&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Local link to adapter %s is down&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|zfcp_erp_adapter_failed
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|zfcp_cb_link_down
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_LINK_UP
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_LINK_UP&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;unsol_link_up:&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Local link to adapter %s was replugged. &quot;
l_string|&quot;Restarting operations on this adapter&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* All ports should be marked as ready to run again */
id|zfcp_erp_modify_adapter_status
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_COMMON_RUNNING
comma
id|ZFCP_SET
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
op_or
id|ZFCP_STATUS_COMMON_ERP_FAILED
)paren
suffix:semicolon
id|zfcp_cb_link_up
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_CFDC_UPDATED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_CFDC_UPDATED&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;unsol_cfdc_update:&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;CFDC has been updated on the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_access_changed
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_CFDC_HARDENED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_STATUS_READ_CFDC_HARDENED&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;unsol_cfdc_harden:&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|status_buffer-&gt;status_subtype
)paren
(brace
r_case
id|FSF_STATUS_READ_SUB_CFDC_HARDENED_ON_SE
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;CFDC of adapter %s saved on SE&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_STATUS_READ_SUB_CFDC_HARDENED_ON_SE2
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;CFDC of adapter %s has been copied &quot;
l_string|&quot;to the secondary SE&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;CFDC of adapter %s has been hardened&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;unsol_unknown:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|status_buffer-&gt;status_type
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unsolicited status packet of unknown &quot;
l_string|&quot;type was received (debug info 0x%x)&bslash;n&quot;
comma
id|status_buffer-&gt;status_type
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Dump of status_read_buffer %p:&bslash;n&quot;
comma
id|status_buffer
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
id|status_buffer
comma
r_sizeof
(paren
r_struct
id|fsf_status_read_buffer
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mempool_free
c_func
(paren
id|status_buffer
comma
id|adapter-&gt;pool.data_status_read
)paren
suffix:semicolon
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * recycle buffer and start new request repeat until outbound&n;&t; * queue is empty or adapter shutdown is requested&n;&t; */
multiline_comment|/*&n;&t; * FIXME(qdio):&n;&t; * we may wait in the req_create for 5s during shutdown, so&n;&t; * qdio_cleanup will have to wait at least that long before returning&n;&t; * with failure to allow us a proper cleanup under all circumstances&n;&t; */
multiline_comment|/*&n;&t; * FIXME:&n;&t; * allocation failure possible? (Is this code needed?)&n;&t; */
id|retval
op_assign
id|zfcp_fsf_status_read
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Failed to create unsolicited status read &quot;
l_string|&quot;request for the adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
multiline_comment|/* temporary fix to avoid status read buffer shortage */
id|adapter-&gt;status_read_failed
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ZFCP_STATUS_READS_RECOM
op_minus
id|adapter-&gt;status_read_failed
)paren
OL
id|ZFCP_STATUS_READ_FAILED_THRESHOLD
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;restart adapter %s due to status read &quot;
l_string|&quot;buffer shortage&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_abort_fcp_command&n; *&n; * purpose:&t;tells FSF to abort a running SCSI command&n; *&n; * returns:&t;address of initiated FSF request&n; *&t;&t;NULL - request could not be initiated&n; *&n; * FIXME(design): should be watched by a timeout !!! &n; * FIXME(design) shouldn&squot;t this be modified to return an int&n; *               also...don&squot;t know how though&n; */
r_struct
id|zfcp_fsf_req
op_star
DECL|function|zfcp_fsf_abort_fcp_command
id|zfcp_fsf_abort_fcp_command
c_func
(paren
r_int
r_int
id|old_req_id
comma
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_int
id|req_flags
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_ABORT_FCP_CMND
comma
id|req_flags
comma
id|adapter-&gt;pool.fsf_req_abort
comma
op_amp
id|lock_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Failed to create an abort command &quot;
l_string|&quot;request for lun 0x%016Lx on port 0x%016Lx &quot;
l_string|&quot;on adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|fsf_req-&gt;data.abort_fcp_command.unit
op_assign
id|unit
suffix:semicolon
multiline_comment|/* set handles of unit and its parent port in QTCB */
id|fsf_req-&gt;qtcb-&gt;header.lun_handle
op_assign
id|unit-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|unit-&gt;port-&gt;handle
suffix:semicolon
multiline_comment|/* set handle of request which should be aborted */
id|fsf_req-&gt;qtcb-&gt;bottom.support.req_handle
op_assign
(paren
id|u64
)paren
id|old_req_id
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|zfcp_fsf_start_scsi_er_timer
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Failed to send abort command request &quot;
l_string|&quot;on adapter %s, port 0x%016Lx, unit 0x%016Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Abort FCP Command request initiated &quot;
l_string|&quot;(adapter%s, port d_id=0x%08x, &quot;
l_string|&quot;unit x%016Lx, old_req_id=0x%lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;d_id
comma
id|unit-&gt;fcp_lun
comma
id|old_req_id
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|fsf_req
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_abort_fcp_command_handler&n; *&n; * purpose:&t;is called for finished Abort FCP Command request&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_abort_fcp_command_handler
id|zfcp_fsf_abort_fcp_command_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|new_fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|new_fsf_req-&gt;data.abort_fcp_command.unit
suffix:semicolon
r_int
r_char
id|status_qual
op_assign
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|new_fsf_req-&gt;adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* do not set ZFCP_STATUS_FSFREQ_ABORTSUCCEEDED */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
r_if
c_cond
(paren
id|status_qual
op_rshift
l_int|4
op_ne
id|status_qual
op_mod
l_int|0xf
)paren
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;fsf_s_phand_nv0&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * In this case a command that was sent prior to a port&n;&t;&t;&t; * reopen was aborted (handles are different). This is&n;&t;&t;&t; * fine.&n;&t;&t;&t; */
)brace
r_else
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier 0x%x for &quot;
l_string|&quot;port 0x%016Lx on adapter %s invalid. &quot;
l_string|&quot;This may happen occasionally.&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header
dot
id|fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
multiline_comment|/* Let&squot;s hope this sorts out the mess */
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv1&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_LUN_HANDLE_NOT_VALID
suffix:colon
r_if
c_cond
(paren
id|status_qual
op_rshift
l_int|4
op_ne
id|status_qual
op_mod
l_int|0xf
)paren
(brace
multiline_comment|/* 2 */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_LUN_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;fsf_s_lhand_nv0&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * In this case a command that was sent prior to a unit&n;&t;&t;&t; * reopen was aborted (handles are different).&n;&t;&t;&t; * This is fine.&n;&t;&t;&t; */
)brace
r_else
(brace
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_LUN_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
(paren
l_string|&quot;Warning: Temporary LUN identifier 0x%x of LUN &quot;
l_string|&quot;0x%016Lx on port 0x%016Lx on adapter %s is &quot;
l_string|&quot;invalid. This may happen in rare cases. &quot;
l_string|&quot;Trying to re-establish link.&bslash;n&quot;
comma
id|unit-&gt;handle
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Status qualifier data:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header
dot
id|fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
multiline_comment|/* Let&squot;s hope this sorts out the mess */
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_lhand_nv1&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_FCP_COMMAND_DOES_NOT_EXIST
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_FCP_COMMAND_DOES_NOT_EXIST&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|3
comma
l_string|&quot;fsf_s_no_exist&quot;
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ABORTNOTNEEDED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
multiline_comment|/* 2 */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Remote port 0x%016Lx on adapter %s needs to &quot;
l_string|&quot;be reopened&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_LUN_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;unit 0x%016Lx on port 0x%016Lx on adapter %s needs &quot;
l_string|&quot;to be reopened&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_lboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_reopen
c_func
(paren
id|unit
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;unitbox&quot;
comma
id|new_fsf_req
comma
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
multiline_comment|/* 2 */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
multiline_comment|/* reopening link to port */
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* SCSI stack will escalate */
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header
dot
id|fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
multiline_comment|/* 3 */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|new_fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ABORTSUCCEEDED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|new_fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|new_fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_use_one_sbal - checks whether req buffer and resp bother each fit into&n; *&t;one SBALE&n; * Two scatter-gather lists are passed, one for the reqeust and one for the&n; * response.&n; */
r_static
r_inline
r_int
DECL|function|zfcp_use_one_sbal
id|zfcp_use_one_sbal
c_func
(paren
r_struct
id|scatterlist
op_star
id|req
comma
r_int
id|req_count
comma
r_struct
id|scatterlist
op_star
id|resp
comma
r_int
id|resp_count
)paren
(brace
r_return
(paren
(paren
id|req_count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|resp_count
op_eq
l_int|1
)paren
op_logical_and
(paren
(paren
(paren
r_int
r_int
)paren
id|zfcp_sg_to_address
c_func
(paren
op_amp
id|req
(braket
l_int|0
)braket
)paren
op_amp
id|PAGE_MASK
)paren
op_eq
(paren
(paren
r_int
r_int
)paren
(paren
id|zfcp_sg_to_address
c_func
(paren
op_amp
id|req
(braket
l_int|0
)braket
)paren
op_plus
id|req
(braket
l_int|0
)braket
dot
id|length
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
)paren
)paren
op_logical_and
(paren
(paren
(paren
r_int
r_int
)paren
id|zfcp_sg_to_address
c_func
(paren
op_amp
id|resp
(braket
l_int|0
)braket
)paren
op_amp
id|PAGE_MASK
)paren
op_eq
(paren
(paren
r_int
r_int
)paren
(paren
id|zfcp_sg_to_address
c_func
(paren
op_amp
id|resp
(braket
l_int|0
)braket
)paren
op_plus
id|resp
(braket
l_int|0
)braket
dot
id|length
op_minus
l_int|1
)paren
op_amp
id|PAGE_MASK
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_send_ct - initiate a Generic Service request (FC-GS)&n; * @ct: pointer to struct zfcp_send_ct which conatins all needed data for&n; *&t;the request&n; * @pool: pointer to memory pool, if non-null this pool is used to allocate&n; *&t;a struct zfcp_fsf_req&n; * @erp_action: pointer to erp_action, if non-null the Generic Service request&n; *&t;is sent within error recovery&n; */
r_int
DECL|function|zfcp_fsf_send_ct
id|zfcp_fsf_send_ct
c_func
(paren
r_struct
id|zfcp_send_ct
op_star
id|ct
comma
id|mempool_t
op_star
id|pool
comma
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|bytes
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|port
op_assign
id|ct-&gt;port
suffix:semicolon
id|adapter
op_assign
id|port-&gt;adapter
suffix:semicolon
id|ret
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_SEND_GENERIC
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
id|pool
comma
op_amp
id|lock_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create CT request (FC-GS) for &quot;
l_string|&quot;adapter: %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|failed_req
suffix:semicolon
)brace
r_if
c_cond
(paren
id|erp_action
op_ne
l_int|NULL
)paren
(brace
id|erp_action-&gt;fsf_req
op_assign
id|fsf_req
suffix:semicolon
id|fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_use_one_sbal
c_func
(paren
id|ct-&gt;req
comma
id|ct-&gt;req_count
comma
id|ct-&gt;resp
comma
id|ct-&gt;resp_count
)paren
)paren
(brace
multiline_comment|/* both request buffer and response buffer&n;                   fit into one sbale each */
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_WRITE_READ
suffix:semicolon
id|sbale
(braket
l_int|2
)braket
dot
id|addr
op_assign
id|zfcp_sg_to_address
c_func
(paren
op_amp
id|ct-&gt;req
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbale
(braket
l_int|2
)braket
dot
id|length
op_assign
id|ct-&gt;req
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|sbale
(braket
l_int|3
)braket
dot
id|addr
op_assign
id|zfcp_sg_to_address
c_func
(paren
op_amp
id|ct-&gt;resp
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbale
(braket
l_int|3
)braket
dot
id|length
op_assign
id|ct-&gt;resp
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|sbale
(braket
l_int|3
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_ELS_CT_CHAINED_SBALS
)paren
(brace
multiline_comment|/* try to use chained SBALs */
id|bytes
op_assign
id|zfcp_qdio_sbals_from_sg
c_func
(paren
id|fsf_req
comma
id|SBAL_FLAGS0_TYPE_WRITE_READ
comma
id|ct-&gt;req
comma
id|ct-&gt;req_count
comma
id|ZFCP_MAX_SBALS_PER_CT_REQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_le
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: creation of CT request failed &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_eq
l_int|0
)paren
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
id|ret
op_assign
id|bytes
suffix:semicolon
r_goto
id|failed_send
suffix:semicolon
)brace
id|fsf_req-&gt;qtcb-&gt;bottom.support.req_buf_length
op_assign
id|bytes
suffix:semicolon
id|fsf_req-&gt;sbale_curr
op_assign
id|ZFCP_LAST_SBALE_PER_SBAL
suffix:semicolon
id|bytes
op_assign
id|zfcp_qdio_sbals_from_sg
c_func
(paren
id|fsf_req
comma
id|SBAL_FLAGS0_TYPE_WRITE_READ
comma
id|ct-&gt;resp
comma
id|ct-&gt;resp_count
comma
id|ZFCP_MAX_SBALS_PER_CT_REQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_le
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: creation of CT request failed &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_eq
l_int|0
)paren
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
id|ret
op_assign
id|bytes
suffix:semicolon
r_goto
id|failed_send
suffix:semicolon
)brace
id|fsf_req-&gt;qtcb-&gt;bottom.support.resp_buf_length
op_assign
id|bytes
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* reject send generic request */
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: microcode does not support chained SBALs,&quot;
l_string|&quot;CT request too big (adapter %s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_goto
id|failed_send
suffix:semicolon
)brace
multiline_comment|/* settings in QTCB */
id|fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|port-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.support.service_class
op_assign
id|adapter-&gt;fc_service_class
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.support.timeout
op_assign
id|ct-&gt;timeout
suffix:semicolon
id|fsf_req-&gt;data.send_ct
op_assign
id|ct
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|ret
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
id|ct-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: initiation of CT request failed &quot;
l_string|&quot;(adapter %s, port 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
r_goto
id|failed_send
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;CT request initiated (adapter %s, port 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|failed_send
suffix:colon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|erp_action
op_ne
l_int|NULL
)paren
(brace
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
)brace
id|failed_req
suffix:colon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_send_ct_handler - handler for Generic Service requests&n; * @fsf_req: pointer to struct zfcp_fsf_req&n; *&n; * Data specific for the Generic Service request is passed by&n; * fsf_req-&gt;data.send_ct&n; * Usually a specific handler for the request is called via&n; * fsf_req-&gt;data.send_ct-&gt;handler at end of this function.&n; */
r_static
r_int
DECL|function|zfcp_fsf_send_ct_handler
id|zfcp_fsf_send_ct_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_send_ct
op_star
id|send_ct
suffix:semicolon
r_struct
id|fsf_qtcb_header
op_star
id|header
suffix:semicolon
r_struct
id|fsf_qtcb_bottom_support
op_star
id|bottom
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|u16
id|subtable
comma
id|rule
comma
id|counter
suffix:semicolon
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
id|send_ct
op_assign
id|fsf_req-&gt;data.send_ct
suffix:semicolon
id|port
op_assign
id|send_ct-&gt;port
suffix:semicolon
id|header
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;header
suffix:semicolon
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.support
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
r_goto
id|skip_fsfstatus
suffix:semicolon
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|header-&gt;fsf_status
)paren
(brace
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SERVICE_CLASS_NOT_SUPPORTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SERVICE_CLASS_NOT_SUPPORTED&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;fc_service_class
op_le
l_int|3
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: adapter %s does not support fc &quot;
l_string|&quot;class %d.&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;bug: The fibre channel class at the &quot;
l_string|&quot;adapter %s is invalid. &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
multiline_comment|/* stop operation for this adapter */
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_class_nsup&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* reopening link to port */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
id|zfcp_test_link
c_func
(paren
id|port
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x &quot;
l_string|&quot;arrived.&bslash;n&quot;
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_ACCESS_DENIED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ACCESS_DENIED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;access denied, cannot send generic service &quot;
l_string|&quot;command (adapter %s, port d_id=0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;d_id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|2
suffix:semicolon
id|counter
op_increment
)paren
(brace
id|subtable
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
)braket
suffix:semicolon
id|rule
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|subtable
)paren
(brace
r_case
id|FSF_SQ_CFDC_SUBTABLE_OS
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_WWPN
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_DID
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_LUN
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Access denied (%s rule %d)&bslash;n&quot;
comma
id|zfcp_act_subtable_type
(braket
id|subtable
)braket
comma
id|rule
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_access&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_access_denied
c_func
(paren
id|port
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_GENERIC_COMMAND_REJECTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_GENERIC_COMMAND_REJECTED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;generic service command rejected &quot;
l_string|&quot;(adapter %s, port d_id=0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;d_id
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_gcom_rej&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Temporary port identifier 0x%x for port &quot;
l_string|&quot;0x%016Lx on adapter %s invalid. This may &quot;
l_string|&quot;happen occasionally.&bslash;n&quot;
comma
id|port-&gt;handle
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_INFO
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phandle_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;port needs to be reopened &quot;
l_string|&quot;(adapter %s, port d_id=0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;d_id
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* following states should never occure, all cases avoided&n;&t;   in zfcp_fsf_send_ct - but who knows ... */
r_case
id|FSF_PAYLOAD_SIZE_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PAYLOAD_SIZE_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;payload size mismatch (adapter: %s, &quot;
l_string|&quot;req_buf_length=%d, resp_buf_length=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;req_buf_length
comma
id|bottom-&gt;resp_buf_length
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_REQUEST_SIZE_TOO_LARGE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_REQUEST_SIZE_TOO_LARGE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;request size too large (adapter: %s, &quot;
l_string|&quot;req_buf_length=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;req_buf_length
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_RESPONSE_SIZE_TOO_LARGE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_RESPONSE_SIZE_TOO_LARGE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;response size too large (adapter: %s, &quot;
l_string|&quot;resp_buf_length=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;resp_buf_length
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SBAL_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SBAL_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;SBAL mismatch (adapter: %s, req_buf_length=%d, &quot;
l_string|&quot;resp_buf_length=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;req_buf_length
comma
id|bottom-&gt;resp_buf_length
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|header-&gt;fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|send_ct-&gt;status
op_assign
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|send_ct-&gt;handler
op_ne
l_int|NULL
)paren
id|send_ct
op_member_access_from_pointer
id|handler
c_func
(paren
id|send_ct-&gt;handler_data
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_send_els - initiate an ELS command (FC-FS)&n; * @els: pointer to struct zfcp_send_els which contains all needed data for&n; *&t;the command.&n; */
r_int
DECL|function|zfcp_fsf_send_els
id|zfcp_fsf_send_els
c_func
(paren
r_struct
id|zfcp_send_els
op_star
id|els
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
id|fc_id_t
id|d_id
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|bytes
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|d_id
op_assign
id|els-&gt;d_id
suffix:semicolon
id|adapter
op_assign
id|els-&gt;adapter
suffix:semicolon
id|ret
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_SEND_ELS
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
l_int|NULL
comma
op_amp
id|lock_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: creation of ELS request failed &quot;
l_string|&quot;(adapter %s, port d_id: 0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|d_id
)paren
suffix:semicolon
r_goto
id|failed_req
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_use_one_sbal
c_func
(paren
id|els-&gt;req
comma
id|els-&gt;req_count
comma
id|els-&gt;resp
comma
id|els-&gt;resp_count
)paren
)paren
(brace
multiline_comment|/* both request buffer and response buffer&n;                   fit into one sbale each */
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_WRITE_READ
suffix:semicolon
id|sbale
(braket
l_int|2
)braket
dot
id|addr
op_assign
id|zfcp_sg_to_address
c_func
(paren
op_amp
id|els-&gt;req
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbale
(braket
l_int|2
)braket
dot
id|length
op_assign
id|els-&gt;req
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|sbale
(braket
l_int|3
)braket
dot
id|addr
op_assign
id|zfcp_sg_to_address
c_func
(paren
op_amp
id|els-&gt;resp
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbale
(braket
l_int|3
)braket
dot
id|length
op_assign
id|els-&gt;resp
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|sbale
(braket
l_int|3
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_ELS_CT_CHAINED_SBALS
)paren
(brace
multiline_comment|/* try to use chained SBALs */
id|bytes
op_assign
id|zfcp_qdio_sbals_from_sg
c_func
(paren
id|fsf_req
comma
id|SBAL_FLAGS0_TYPE_WRITE_READ
comma
id|els-&gt;req
comma
id|els-&gt;req_count
comma
id|ZFCP_MAX_SBALS_PER_ELS_REQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_le
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: creation of ELS request failed &quot;
l_string|&quot;(adapter %s, port d_id: 0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|d_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|bytes
suffix:semicolon
)brace
r_goto
id|failed_send
suffix:semicolon
)brace
id|fsf_req-&gt;qtcb-&gt;bottom.support.req_buf_length
op_assign
id|bytes
suffix:semicolon
id|fsf_req-&gt;sbale_curr
op_assign
id|ZFCP_LAST_SBALE_PER_SBAL
suffix:semicolon
id|bytes
op_assign
id|zfcp_qdio_sbals_from_sg
c_func
(paren
id|fsf_req
comma
id|SBAL_FLAGS0_TYPE_WRITE_READ
comma
id|els-&gt;resp
comma
id|els-&gt;resp_count
comma
id|ZFCP_MAX_SBALS_PER_ELS_REQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_le
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: creation of ELS request failed &quot;
l_string|&quot;(adapter %s, port d_id: 0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|d_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|bytes
suffix:semicolon
)brace
r_goto
id|failed_send
suffix:semicolon
)brace
id|fsf_req-&gt;qtcb-&gt;bottom.support.resp_buf_length
op_assign
id|bytes
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* reject request */
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: microcode does not support chained SBALs&quot;
l_string|&quot;, ELS request too big (adapter %s, &quot;
l_string|&quot;port d_id: 0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|d_id
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_goto
id|failed_send
suffix:semicolon
)brace
multiline_comment|/* settings in QTCB */
id|fsf_req-&gt;qtcb-&gt;bottom.support.d_id
op_assign
id|d_id
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.support.service_class
op_assign
id|adapter-&gt;fc_service_class
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.support.timeout
op_assign
id|ZFCP_ELS_TIMEOUT
suffix:semicolon
id|fsf_req-&gt;data.send_els
op_assign
id|els
suffix:semicolon
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|ret
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
id|els-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: initiation of ELS request failed &quot;
l_string|&quot;(adapter %s, port d_id: 0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|d_id
)paren
suffix:semicolon
r_goto
id|failed_send
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;ELS request initiated (adapter %s, port d_id: &quot;
l_string|&quot;0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|d_id
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|failed_send
suffix:colon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|failed_req
suffix:colon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_send_els_handler - handler for ELS commands&n; * @fsf_req: pointer to struct zfcp_fsf_req&n; *&n; * Data specific for the ELS command is passed by&n; * fsf_req-&gt;data.send_els&n; * Usually a specific handler for the command is called via&n; * fsf_req-&gt;data.send_els-&gt;handler at end of this function.&n; */
DECL|function|zfcp_fsf_send_els_handler
r_static
r_int
id|zfcp_fsf_send_els_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
id|fc_id_t
id|d_id
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|fsf_qtcb_header
op_star
id|header
suffix:semicolon
r_struct
id|fsf_qtcb_bottom_support
op_star
id|bottom
suffix:semicolon
r_struct
id|zfcp_send_els
op_star
id|send_els
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|u16
id|subtable
comma
id|rule
comma
id|counter
suffix:semicolon
id|send_els
op_assign
id|fsf_req-&gt;data.send_els
suffix:semicolon
id|adapter
op_assign
id|send_els-&gt;adapter
suffix:semicolon
id|d_id
op_assign
id|send_els-&gt;d_id
suffix:semicolon
id|header
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;header
suffix:semicolon
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.support
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
r_goto
id|skip_fsfstatus
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;fsf_status
)paren
(brace
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SERVICE_CLASS_NOT_SUPPORTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SERVICE_CLASS_NOT_SUPPORTED&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;fc_service_class
op_le
l_int|3
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: adapter %s does &quot;
l_string|&quot;not support fibrechannel class %d.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;bug: The fibrechannel class at &quot;
l_string|&quot;adapter %s is invalid. &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
multiline_comment|/* stop operation for this adapter */
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_class_nsup&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|send_els-&gt;ls_code
op_ne
id|ZFCP_LS_ADISC
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|port
op_assign
id|zfcp_get_port_by_did
c_func
(paren
id|adapter
comma
id|d_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
id|zfcp_test_link
c_func
(paren
id|port
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
)brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
id|zfcp_handle_els_rjt
c_func
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|1
)braket
comma
(paren
r_struct
id|zfcp_ls_rjt_par
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual.word
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_RETRY_IF_POSSIBLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_RETRY_IF_POSSIBLE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_retry&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x&bslash;n&quot;
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_INFO
comma
(paren
r_char
op_star
)paren
id|header-&gt;fsf_status_qual.word
comma
l_int|16
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_ELS_COMMAND_REJECTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ELS_COMMAND_REJECTED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;ELS has been rejected because command filter &quot;
l_string|&quot;prohibited sending &quot;
l_string|&quot;(adapter: %s, port d_id: 0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|d_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PAYLOAD_SIZE_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PAYLOAD_SIZE_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;ELS request size and ELS response size must be either &quot;
l_string|&quot;both 0, or both greater than 0 &quot;
l_string|&quot;(adapter: %s, req_buf_length=%d resp_buf_length=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;req_buf_length
comma
id|bottom-&gt;resp_buf_length
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_REQUEST_SIZE_TOO_LARGE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_REQUEST_SIZE_TOO_LARGE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Length of the ELS request buffer, &quot;
l_string|&quot;specified in QTCB bottom, &quot;
l_string|&quot;exceeds the size of the buffers &quot;
l_string|&quot;that have been allocated for ELS request data &quot;
l_string|&quot;(adapter: %s, req_buf_length=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;req_buf_length
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_RESPONSE_SIZE_TOO_LARGE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_RESPONSE_SIZE_TOO_LARGE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Length of the ELS response buffer, &quot;
l_string|&quot;specified in QTCB bottom, &quot;
l_string|&quot;exceeds the size of the buffers &quot;
l_string|&quot;that have been allocated for ELS response data &quot;
l_string|&quot;(adapter: %s, resp_buf_length=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;resp_buf_length
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SBAL_MISMATCH
suffix:colon
multiline_comment|/* should never occure, avoided in zfcp_fsf_send_els */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SBAL_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;SBAL mismatch (adapter: %s, req_buf_length=%d, &quot;
l_string|&quot;resp_buf_length=%d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;req_buf_length
comma
id|bottom-&gt;resp_buf_length
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ACCESS_DENIED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ACCESS_DENIED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;access denied, cannot send ELS command &quot;
l_string|&quot;(adapter %s, port d_id=0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|d_id
)paren
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|2
suffix:semicolon
id|counter
op_increment
)paren
(brace
id|subtable
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
)braket
suffix:semicolon
id|rule
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|subtable
)paren
(brace
r_case
id|FSF_SQ_CFDC_SUBTABLE_OS
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_WWPN
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_DID
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_LUN
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Access denied (%s rule %d)&bslash;n&quot;
comma
id|zfcp_act_subtable_type
(braket
id|subtable
)braket
comma
id|rule
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_access&quot;
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|port
op_assign
id|zfcp_get_port_by_did
c_func
(paren
id|adapter
comma
id|d_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_ne
l_int|NULL
)paren
id|zfcp_erp_port_access_denied
c_func
(paren
id|port
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|zfcp_data.config_lock
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(adapter: %s, fsf_status=0x%08x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|header-&gt;fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|send_els-&gt;status
op_assign
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|send_els-&gt;handler
op_ne
l_int|0
)paren
id|send_els
op_member_access_from_pointer
id|handler
c_func
(paren
id|send_els-&gt;handler_data
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:&n; *&n; * purpose:&n; *&n; * returns:&t;address of initiated FSF request&n; *&t;&t;NULL - request could not be initiated&n; */
r_int
DECL|function|zfcp_fsf_exchange_config_data
id|zfcp_fsf_exchange_config_data
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_EXCHANGE_CONFIG_DATA
comma
id|ZFCP_REQ_AUTO_CLEANUP
comma
id|erp_action-&gt;adapter-&gt;pool.fsf_req_erp
comma
op_amp
id|lock_flags
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create exchange configuration &quot;
l_string|&quot;data request for adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|erp_action-&gt;fsf_req
comma
id|erp_action-&gt;fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;bottom.config.feature_selection
op_assign
(paren
id|FSF_FEATURE_CFDC
op_or
id|FSF_FEATURE_LUN_SHARING
)paren
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
(paren
l_string|&quot;error: Could not send exchange configuration data &quot;
l_string|&quot;command on the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;exchange configuration data request initiated &quot;
l_string|&quot;(adapter %s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_exchange_config_evaluate&n; * @fsf_req: fsf_req which belongs to xchg config data request&n; * @xchg_ok: specifies if xchg config data was incomplete or complete (0/1)&n; *&n; * returns: -EIO on error, 0 otherwise&n; */
r_static
r_int
DECL|function|zfcp_fsf_exchange_config_evaluate
id|zfcp_fsf_exchange_config_evaluate
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
r_int
id|xchg_ok
)paren
(brace
r_struct
id|fsf_qtcb_bottom_config
op_star
id|bottom
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.config
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;low/high QTCB version 0x%x/0x%x of FSF&bslash;n&quot;
comma
id|bottom-&gt;low_qtcb_version
comma
id|bottom-&gt;high_qtcb_version
)paren
suffix:semicolon
id|adapter-&gt;fsf_lic_version
op_assign
id|bottom-&gt;lic_version
suffix:semicolon
id|adapter-&gt;supported_features
op_assign
id|bottom-&gt;supported_features
suffix:semicolon
r_if
c_cond
(paren
id|xchg_ok
)paren
(brace
id|adapter-&gt;wwnn
op_assign
id|bottom-&gt;nport_serv_param.wwnn
suffix:semicolon
id|adapter-&gt;wwpn
op_assign
id|bottom-&gt;nport_serv_param.wwpn
suffix:semicolon
id|adapter-&gt;s_id
op_assign
id|bottom-&gt;s_id
op_amp
id|ZFCP_DID_MASK
suffix:semicolon
id|adapter-&gt;fc_topology
op_assign
id|bottom-&gt;fc_topology
suffix:semicolon
id|adapter-&gt;fc_link_speed
op_assign
id|bottom-&gt;fc_link_speed
suffix:semicolon
id|adapter-&gt;hydra_version
op_assign
id|bottom-&gt;adapter_type
suffix:semicolon
)brace
r_else
(brace
id|adapter-&gt;wwnn
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;wwpn
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;s_id
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;fc_topology
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;fc_link_speed
op_assign
l_int|0
suffix:semicolon
id|adapter-&gt;hydra_version
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_HBAAPI_MANAGEMENT
)paren
(brace
id|adapter-&gt;hardware_version
op_assign
id|bottom-&gt;hardware_version
suffix:semicolon
id|memcpy
c_func
(paren
id|adapter-&gt;serial_number
comma
id|bottom-&gt;serial_number
comma
l_int|17
)paren
suffix:semicolon
id|EBCASC
c_func
(paren
id|adapter-&gt;serial_number
comma
r_sizeof
(paren
id|adapter-&gt;serial_number
)paren
)paren
suffix:semicolon
)brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The adapter %s reported the following characteristics:&bslash;n&quot;
l_string|&quot;WWNN 0x%016Lx, &quot;
l_string|&quot;WWPN 0x%016Lx, &quot;
l_string|&quot;S_ID 0x%08x,&bslash;n&quot;
l_string|&quot;adapter version 0x%x, &quot;
l_string|&quot;LIC version 0x%x, &quot;
l_string|&quot;FC link speed %d Gb/s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|adapter-&gt;wwnn
comma
id|adapter-&gt;wwpn
comma
(paren
r_int
r_int
)paren
id|adapter-&gt;s_id
comma
id|adapter-&gt;hydra_version
comma
id|adapter-&gt;fsf_lic_version
comma
id|adapter-&gt;fc_link_speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ZFCP_QTCB_VERSION
OL
id|bottom-&gt;low_qtcb_version
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: the adapter %s &quot;
l_string|&quot;only supports newer control block &quot;
l_string|&quot;versions in comparison to this device &quot;
l_string|&quot;driver (try updated device driver)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;low_qtcb_ver&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ZFCP_QTCB_VERSION
OG
id|bottom-&gt;high_qtcb_version
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: the adapter %s &quot;
l_string|&quot;only supports older control block &quot;
l_string|&quot;versions than this device driver uses&quot;
l_string|&quot;(consider a microcode upgrade)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;high_qtcb_ver&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_exchange_config_data_handler&n; *&n; * purpose:     is called for finished Exchange Configuration Data command&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_exchange_config_data_handler
id|zfcp_fsf_exchange_config_data_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|fsf_qtcb_bottom_config
op_star
id|bottom
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_fsf_exchange_config_evaluate
c_func
(paren
id|fsf_req
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|adapter-&gt;fc_topology
)paren
(brace
r_case
id|FSF_TOPO_P2P
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_TOPO_P2P&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: Point-to-point fibrechannel &quot;
l_string|&quot;configuration detected at adapter %s &quot;
l_string|&quot;unsupported, shutting down adapter&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;top-p-to-p&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
r_case
id|FSF_TOPO_AL
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_TOPO_AL&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: Arbitrated loop fibrechannel &quot;
l_string|&quot;topology detected at adapter %s &quot;
l_string|&quot;unsupported, shutting down adapter&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;top-al&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
r_case
id|FSF_TOPO_FABRIC
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_TOPO_FABRIC&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Switched fabric fibrechannel &quot;
l_string|&quot;network detected at adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The fibrechannel topology &quot;
l_string|&quot;reported by the exchange &quot;
l_string|&quot;configuration command for &quot;
l_string|&quot;the adapter %s is not &quot;
l_string|&quot;of a type known to the zfcp &quot;
l_string|&quot;driver, shutting down adapter&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;unknown-topo&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.config
suffix:semicolon
r_if
c_cond
(paren
id|bottom-&gt;max_qtcb_size
OL
r_sizeof
(paren
r_struct
id|fsf_qtcb
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Maximum QTCB size (%d bytes) &quot;
l_string|&quot;allowed by the adapter %s &quot;
l_string|&quot;is lower than the minimum &quot;
l_string|&quot;required by the driver (%ld bytes).&bslash;n&quot;
comma
id|bottom-&gt;max_qtcb_size
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
r_sizeof
(paren
r_struct
id|fsf_qtcb
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;qtcb-size&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|bottom-&gt;max_qtcb_size
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_XCONFIG_OK
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|zfcp_cb_adapter_add
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_EXCHANGE_CONFIG_DATA_INCOMPLETE
suffix:colon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;xchg-inco&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zfcp_fsf_exchange_config_evaluate
c_func
(paren
id|fsf_req
comma
l_int|0
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Local link to adapter %s is down&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_XCONFIG_OK
op_or
id|ZFCP_STATUS_ADAPTER_LINK_UNPLUGGED
comma
op_amp
id|adapter-&gt;status
)paren
suffix:semicolon
id|zfcp_erp_adapter_failed
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf-stat-ng&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|adapter
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_exchange_port_data - request information about local port&n; * @adapter: for which port data is requested&n; * @data: response to exchange port data request&n; */
r_int
DECL|function|zfcp_fsf_exchange_port_data
id|zfcp_fsf_exchange_port_data
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|fsf_qtcb_bottom_port
op_star
id|data
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
r_struct
id|timer_list
op_star
id|timer
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_HBAAPI_MANAGEMENT
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: exchange port data &quot;
l_string|&quot;command not supported by adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
id|timer
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|timer_list
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_EXCHANGE_PORT_DATA
comma
l_int|0
comma
l_int|0
comma
op_amp
id|lock_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Out of resources. Could not create an &quot;
l_string|&quot;exchange port data request for&quot;
l_string|&quot;the adapter %s.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|fsf_req-&gt;data.port_data
op_assign
id|data
suffix:semicolon
id|init_timer
c_func
(paren
id|timer
)paren
suffix:semicolon
id|timer-&gt;function
op_assign
id|zfcp_fsf_request_timeout_handler
suffix:semicolon
id|timer-&gt;data
op_assign
(paren
r_int
r_int
)paren
id|adapter
suffix:semicolon
id|timer-&gt;expires
op_assign
id|ZFCP_FSF_REQUEST_TIMEOUT
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
id|timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an exchange port data &quot;
l_string|&quot;command on the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Exchange Port Data request initiated (adapter %s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|fsf_req-&gt;completion_wq
comma
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_COMPLETED
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
id|timer
)paren
suffix:semicolon
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|timer
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_exchange_port_data_handler - handler for exchange_port_data request&n; * @fsf_req: pointer to struct zfcp_fsf_req&n; */
r_static
r_void
DECL|function|zfcp_fsf_exchange_port_data_handler
id|zfcp_fsf_exchange_port_data_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|fsf_qtcb_bottom_port
op_star
id|bottom
suffix:semicolon
r_struct
id|fsf_qtcb_bottom_port
op_star
id|data
op_assign
id|fsf_req-&gt;data.port_data
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.port
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|bottom
comma
r_sizeof
(paren
op_star
id|data
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;xchg-port-ng&quot;
)paren
suffix:semicolon
id|debug_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_open_port&n; *&n; * purpose:&t;&n; *&n; * returns:&t;address of initiated FSF request&n; *&t;&t;NULL - request could not be initiated &n; */
r_int
DECL|function|zfcp_fsf_open_port
id|zfcp_fsf_open_port
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_OPEN_PORT_WITH_DID
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
id|erp_action-&gt;adapter-&gt;pool.fsf_req_erp
comma
op_amp
id|lock_flags
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create open port request &quot;
l_string|&quot;for port 0x%016Lx on adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|erp_action-&gt;fsf_req
comma
id|erp_action-&gt;fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;bottom.support.d_id
op_assign
id|erp_action-&gt;port-&gt;d_id
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|erp_action-&gt;port-&gt;status
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;data.open_port.port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send open port request for &quot;
l_string|&quot;port 0x%016Lx on adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;open port request initiated &quot;
l_string|&quot;(adapter %s,  port 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_open_port_handler&n; *&n; * purpose:&t;is called for finished Open Port command&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_open_port_handler
id|zfcp_fsf_open_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|fsf_plogi
op_star
id|plogi
suffix:semicolon
r_struct
id|fsf_qtcb_header
op_star
id|header
suffix:semicolon
id|u16
id|subtable
comma
id|rule
comma
id|counter
suffix:semicolon
id|port
op_assign
id|fsf_req-&gt;data.open_port.port
suffix:semicolon
id|header
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;header
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change port status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|header-&gt;fsf_status
)paren
(brace
r_case
id|FSF_PORT_ALREADY_OPEN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_PORT_ALREADY_OPEN&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: remote port 0x%016Lx on adapter %s &quot;
l_string|&quot;is already open.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_popen&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This is a bug, however operation should continue normally&n;&t;&t; * if it is simply ignored&n;&t;&t; */
r_break
suffix:semicolon
r_case
id|FSF_ACCESS_DENIED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ACCESS_DENIED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Access denied, cannot open port 0x%016Lx &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|2
suffix:semicolon
id|counter
op_increment
)paren
(brace
id|subtable
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
)braket
suffix:semicolon
id|rule
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|subtable
)paren
(brace
r_case
id|FSF_SQ_CFDC_SUBTABLE_OS
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_WWPN
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_DID
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_LUN
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Access denied (%s rule %d)&bslash;n&quot;
comma
id|zfcp_act_subtable_type
(braket
id|subtable
)braket
comma
id|rule
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_access&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_access_denied
c_func
(paren
id|port
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_MAXIMUM_NUMBER_OF_PORTS_EXCEEDED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_MAXIMUM_NUMBER_OF_PORTS_EXCEEDED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: The FSF adapter is out of resources. &quot;
l_string|&quot;The remote port 0x%016Lx on adapter %s &quot;
l_string|&quot;could not be opened. Disabling it.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_max_ports&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_failed
c_func
(paren
id|port
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_NO_RETRY_POSSIBLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SQ_NO_RETRY_POSSIBLE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;The remote port 0x%016Lx on &quot;
l_string|&quot;adapter %s could not be opened. &quot;
l_string|&quot;Disabling it.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_no_retry&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_failed
c_func
(paren
id|port
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* save port handle assigned by FSF */
id|port-&gt;handle
op_assign
id|header-&gt;port_handle
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;The remote port 0x%016Lx via adapter %s &quot;
l_string|&quot;was opened, it&squot;s port handle is 0x%x&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* mark port as open */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
op_or
id|ZFCP_STATUS_PORT_PHYS_OPEN
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check whether D_ID has changed during open */
multiline_comment|/*&n;&t;&t; * FIXME: This check is not airtight, as the FCP channel does&n;&t;&t; * not monitor closures of target port connections caused on&n;&t;&t; * the remote side. Thus, they might miss out on invalidating&n;&t;&t; * locally cached WWPNs (and other N_Port parameters) of gone&n;&t;&t; * target ports. So, our heroic attempt to make things safe&n;&t;&t; * could be undermined by &squot;open port&squot; response data tagged with&n;&t;&t; * obsolete WWPNs. Another reason to monitor potential&n;&t;&t; * connection closures ourself at least (by interpreting&n;&t;&t; * incoming ELS&squot; and unsolicited status). It just crosses my&n;&t;&t; * mind that one should be able to cross-check by means of&n;&t;&t; * another GID_PN straight after a port has been opened.&n;&t;&t; * Alternately, an ADISC/PDISC ELS should suffice, as well.&n;&t;&t; */
id|plogi
op_assign
(paren
r_struct
id|fsf_plogi
op_star
)paren
id|fsf_req-&gt;qtcb-&gt;bottom.support.els
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_PORT_NO_WWPN
comma
op_amp
id|port-&gt;status
)paren
)paren
(brace
r_if
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.support.els1_length
OL
(paren
(paren
(paren
(paren
r_int
r_int
)paren
op_amp
id|plogi-&gt;serv_param.wwpn
)paren
op_minus
(paren
(paren
r_int
r_int
)paren
id|plogi
)paren
)paren
op_plus
r_sizeof
(paren
id|u64
)paren
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;warning: insufficient length of &quot;
l_string|&quot;PLOGI payload (%i)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;bottom.support.els1_length
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_short_plogi:&quot;
)paren
suffix:semicolon
multiline_comment|/* skip sanity check and assume wwpn is ok */
)brace
r_else
(brace
r_if
c_cond
(paren
id|plogi-&gt;serv_param.wwpn
op_ne
id|port-&gt;wwpn
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;warning: d_id of port &quot;
l_string|&quot;0x%016Lx changed during &quot;
l_string|&quot;open&bslash;n&quot;
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_did_change:&quot;
)paren
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_PORT_DID_DID
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
)brace
r_else
id|port-&gt;wwnn
op_assign
id|plogi-&gt;serv_param.wwnn
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|FSF_UNKNOWN_OP_SUBTYPE
suffix:colon
multiline_comment|/* should never occure, subtype not set in zfcp_fsf_open_port */
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_UNKNOWN_OP_SUBTYPE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;unknown operation subtype (adapter: %s, &quot;
l_string|&quot;op_subtype=0x%x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|fsf_req-&gt;qtcb-&gt;bottom.support.operation_subtype
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|header-&gt;fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_port&n; *&n; * purpose:     submit FSF command &quot;close port&quot;&n; *&n; * returns:     address of initiated FSF request&n; *              NULL - request could not be initiated&n; */
r_int
DECL|function|zfcp_fsf_close_port
id|zfcp_fsf_close_port
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_CLOSE_PORT
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
id|erp_action-&gt;adapter-&gt;pool.fsf_req_erp
comma
op_amp
id|lock_flags
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create a close port request &quot;
l_string|&quot;for port 0x%016Lx on adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|erp_action-&gt;fsf_req
comma
id|erp_action-&gt;fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|erp_action-&gt;port-&gt;status
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;data.close_port.port
op_assign
id|erp_action-&gt;port
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|erp_action-&gt;port-&gt;handle
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send a close port request for &quot;
l_string|&quot;port 0x%016Lx on adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;close port request initiated &quot;
l_string|&quot;(adapter %s, port 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_port_handler&n; *&n; * purpose:     is called for finished Close Port FSF command&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_close_port_handler
id|zfcp_fsf_close_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
id|port
op_assign
id|fsf_req-&gt;data.close_port.port
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change port status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier 0x%x for port &quot;
l_string|&quot;0x%016Lx on adapter %s invalid. This may happen &quot;
l_string|&quot;occasionally.&bslash;n&quot;
comma
id|port-&gt;handle
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Note: FSF has actually closed the port in this case.&n;&t;&t; * The status code is just daft. Fingers crossed for a change&n;&t;&t; */
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;remote port 0x016%Lx on adapter %s closed, &quot;
l_string|&quot;port handle 0x%x&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;handle
)paren
suffix:semicolon
id|zfcp_erp_modify_port_status
c_func
(paren
id|port
comma
id|ZFCP_STATUS_COMMON_OPEN
comma
id|ZFCP_CLEAR
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_physical_port&n; *&n; * purpose:     submit FSF command &quot;close physical port&quot;&n; *&n; * returns:     address of initiated FSF request&n; *              NULL - request could not be initiated&n; */
r_int
DECL|function|zfcp_fsf_close_physical_port
id|zfcp_fsf_close_physical_port
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_CLOSE_PHYSICAL_PORT
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
id|erp_action-&gt;adapter-&gt;pool.fsf_req_erp
comma
op_amp
id|lock_flags
comma
op_amp
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create close physical port &quot;
l_string|&quot;request (adapter %s, port 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|erp_action-&gt;fsf_req
comma
id|erp_action-&gt;fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
multiline_comment|/* mark port as being closed */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_PORT_PHYS_CLOSING
comma
op_amp
id|erp_action-&gt;port-&gt;status
)paren
suffix:semicolon
multiline_comment|/* save a pointer to this port */
id|erp_action-&gt;fsf_req-&gt;data.close_physical_port.port
op_assign
id|erp_action-&gt;port
suffix:semicolon
multiline_comment|/* port to be closeed */
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|erp_action-&gt;port-&gt;handle
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send close physical port &quot;
l_string|&quot;request (adapter %s, port 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;close physical port request initiated &quot;
l_string|&quot;(adapter %s, port 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_physical_port_handler&n; *&n; * purpose:     is called for finished Close Physical Port FSF command&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_close_physical_port_handler
id|zfcp_fsf_close_physical_port_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_port
op_star
id|port
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|fsf_qtcb_header
op_star
id|header
suffix:semicolon
id|u16
id|subtable
comma
id|rule
comma
id|counter
suffix:semicolon
id|port
op_assign
id|fsf_req-&gt;data.close_physical_port.port
suffix:semicolon
id|header
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;header
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change port status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|header-&gt;fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier 0x%x invalid&quot;
l_string|&quot;(adapter %s, port 0x%016Lx). &quot;
l_string|&quot;This may happen occasionally.&bslash;n&quot;
comma
id|port-&gt;handle
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;wwpn
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ACCESS_DENIED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ACCESS_DENIED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Access denied, cannot close &quot;
l_string|&quot;physical port 0x%016Lx on adapter %s&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|2
suffix:semicolon
id|counter
op_increment
)paren
(brace
id|subtable
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
)braket
suffix:semicolon
id|rule
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|subtable
)paren
(brace
r_case
id|FSF_SQ_CFDC_SUBTABLE_OS
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_WWPN
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_DID
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_LUN
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Access denied (%s rule %d)&bslash;n&quot;
comma
id|zfcp_act_subtable_type
(braket
id|subtable
)braket
comma
id|rule
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_access&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_access_denied
c_func
(paren
id|port
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port 0x%016Lx on adapter &quot;
l_string|&quot;%s needs to be reopened but it was attempted &quot;
l_string|&quot;to close it physically.&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
multiline_comment|/* This will now be escalated by ERP */
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Remote port 0x%016Lx via adapter %s &quot;
l_string|&quot;physically closed, port handle 0x%x&bslash;n&quot;
comma
id|port-&gt;wwpn
comma
id|zfcp_get_busid_by_port
c_func
(paren
id|port
)paren
comma
id|port-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* can&squot;t use generic zfcp_erp_modify_port_status because&n;&t;&t; * ZFCP_STATUS_COMMON_OPEN must not be reset for the port&n;&t;&t; */
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_PORT_PHYS_OPEN
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|unit
comma
op_amp
id|port-&gt;unit_list_head
comma
id|list
)paren
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|header-&gt;fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_PORT_PHYS_CLOSING
comma
op_amp
id|port-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_open_unit&n; *&n; * purpose:&n; *&n; * returns:&n; *&n; * assumptions:&t;This routine does not check whether the associated&n; *&t;&t;remote port has already been opened. This should be&n; *&t;&t;done by calling routines. Otherwise some status&n; *&t;&t;may be presented by FSF&n; */
r_int
DECL|function|zfcp_fsf_open_unit
id|zfcp_fsf_open_unit
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_OPEN_LUN
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
id|erp_action-&gt;adapter-&gt;pool.fsf_req_erp
comma
op_amp
id|lock_flags
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create open unit request for &quot;
l_string|&quot;unit 0x%016Lx on port 0x%016Lx on adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;unit-&gt;fcp_lun
comma
id|erp_action-&gt;unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|erp_action-&gt;fsf_req
comma
id|erp_action-&gt;fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|erp_action-&gt;port-&gt;handle
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;bottom.support.fcp_lun
op_assign
id|erp_action-&gt;unit-&gt;fcp_lun
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;bottom.support.option
op_assign
id|FSF_OPEN_LUN_SUPPRESS_BOXING
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|erp_action-&gt;unit-&gt;status
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;data.open_unit.unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an open unit request &quot;
l_string|&quot;on the adapter %s, port 0x%016Lx for &quot;
l_string|&quot;unit 0x%016Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|erp_action-&gt;unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Open LUN request initiated (adapter %s, &quot;
l_string|&quot;port 0x%016Lx, unit 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|erp_action-&gt;unit-&gt;fcp_lun
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_open_unit_handler&n; *&n; * purpose:&t;is called for finished Open LUN command&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_open_unit_handler
id|zfcp_fsf_open_unit_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|fsf_qtcb_header
op_star
id|header
suffix:semicolon
r_struct
id|fsf_qtcb_bottom_support
op_star
id|bottom
suffix:semicolon
r_struct
id|fsf_queue_designator
op_star
id|queue_designator
suffix:semicolon
id|u16
id|subtable
comma
id|rule
comma
id|counter
suffix:semicolon
id|u32
id|allowed
comma
id|exclusive
comma
id|readwrite
suffix:semicolon
id|unit
op_assign
id|fsf_req-&gt;data.open_unit.unit
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change unit status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
id|header
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;header
suffix:semicolon
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.support
suffix:semicolon
id|queue_designator
op_assign
op_amp
id|header-&gt;fsf_status_qual.fsf_queue_designator
suffix:semicolon
id|allowed
op_assign
id|bottom-&gt;lun_access_info
op_amp
id|FSF_UNIT_ACCESS_OPEN_LUN_ALLOWED
suffix:semicolon
id|exclusive
op_assign
id|bottom-&gt;lun_access_info
op_amp
id|FSF_UNIT_ACCESS_EXCLUSIVE
suffix:semicolon
id|readwrite
op_assign
id|bottom-&gt;lun_access_info
op_amp
id|FSF_UNIT_ACCESS_OUTBOUND_TRANSFER
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_CFDC
)paren
r_goto
id|no_cfdc
suffix:semicolon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ACCESS_DENIED
op_or
id|ZFCP_STATUS_UNIT_SHARED
op_or
id|ZFCP_STATUS_UNIT_READONLY
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|allowed
)paren
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_ACCESS_DENIED
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_LUN_SHARING
)paren
r_goto
id|no_lun_sharing
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exclusive
)paren
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_UNIT_SHARED
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|readwrite
)paren
(brace
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_UNIT_READONLY
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Unit 0x%016Lx on port 0x%016Lx on adapter %s &quot;
l_string|&quot;accessed read-only&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|exclusive
op_logical_and
op_logical_neg
id|readwrite
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Exclusive access of read-only unit not &quot;
l_string|&quot;supported&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|exclusive
op_logical_and
id|readwrite
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Shared access of read-write unit is not &quot;
l_string|&quot;supported&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
id|no_lun_sharing
suffix:colon
id|no_cfdc
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_CFDC
)paren
op_logical_and
(paren
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_LUN_SHARING
)paren
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;LUN sharing without access control is not &quot;
l_string|&quot;supported.&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|header-&gt;fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier 0x%x &quot;
l_string|&quot;for port 0x%016Lx on adapter %s invalid &quot;
l_string|&quot;This may happen occasionally&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_ph_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_ALREADY_OPEN
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_LUN_ALREADY_OPEN&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: Attempted to open unit 0x%016Lx on &quot;
l_string|&quot;remote port 0x%016Lx on adapter %s twice.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_uopen&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ACCESS_DENIED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ACCESS_DENIED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Access denied, cannot open unit 0x%016Lx on &quot;
l_string|&quot;remote port 0x%016Lx on adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|2
suffix:semicolon
id|counter
op_increment
)paren
(brace
id|subtable
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
)braket
suffix:semicolon
id|rule
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|subtable
)paren
(brace
r_case
id|FSF_SQ_CFDC_SUBTABLE_OS
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_WWPN
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_DID
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_LUN
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Access denied (%s rule %d)&bslash;n&quot;
comma
id|zfcp_act_subtable_type
(braket
id|subtable
)braket
comma
id|rule
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_access&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_access_denied
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port 0x%016Lx on adapter %s &quot;
l_string|&quot;needs to be reopened&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_SHARING_VIOLATION
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_LUN_SHARING_VIOLATION&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;FCP-LUN 0x%Lx at the remote port &quot;
l_string|&quot;with WWPN 0x%Lx &quot;
l_string|&quot;connected to the adapter %s &quot;
l_string|&quot;is already in use in LPAR%d, CSS%d&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|queue_designator-&gt;hla
comma
id|queue_designator-&gt;cssid
)paren
suffix:semicolon
)brace
r_else
(brace
id|subtable
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
l_int|4
)braket
suffix:semicolon
id|rule
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
l_int|5
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|subtable
)paren
(brace
r_case
id|FSF_SQ_CFDC_SUBTABLE_OS
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_WWPN
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_DID
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_LUN
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Access to FCP-LUN 0x%Lx at the &quot;
l_string|&quot;remote port with WWPN 0x%Lx &quot;
l_string|&quot;connected to the adapter %s &quot;
l_string|&quot;is denied (%s rule %d)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|zfcp_act_subtable_type
(braket
id|subtable
)braket
comma
id|rule
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_l_sh_vio&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_MAXIMUM_NUMBER_OF_LUNS_EXCEEDED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_MAXIMUM_NUMBER_OF_LUNS_EXCEEDED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: The adapter ran out of resources. &quot;
l_string|&quot;There is no handle (temporary port identifier) &quot;
l_string|&quot;available for unit 0x%016Lx on port 0x%016Lx &quot;
l_string|&quot;on adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_max_units&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Re-establish link to port */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_INVALID_COMMAND_OPTION
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_INVALID_COMMAND_OPTION&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Invalid option 0x%x has been specified &quot;
l_string|&quot;in QTCB bottom sent to the adapter %s&bslash;n&quot;
comma
id|bottom-&gt;option
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* save LUN handle assigned by FSF */
id|unit-&gt;handle
op_assign
id|header-&gt;lun_handle
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;unit 0x%016Lx on remote port 0x%016Lx on &quot;
l_string|&quot;adapter %s opened, port handle 0x%x&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* mark unit as open */
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_LUN_SHARING
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|exclusive
)paren
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_UNIT_SHARED
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|readwrite
)paren
(brace
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_UNIT_READONLY
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;read-only access for unit &quot;
l_string|&quot;(adapter %s, wwpn=0x%016Lx, &quot;
l_string|&quot;fcp_lun=0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|exclusive
op_logical_and
op_logical_neg
id|readwrite
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;exclusive access of read-only &quot;
l_string|&quot;unit not supported&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|zfcp_erp_unit_shutdown
c_func
(paren
id|unit
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|exclusive
op_logical_and
id|readwrite
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;shared access of read-write &quot;
l_string|&quot;unit not supported&bslash;n&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_failed
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|zfcp_erp_unit_shutdown
c_func
(paren
id|unit
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|header-&gt;fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPENING
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_unit&n; *&n; * purpose:&n; *&n; * returns:&t;address of fsf_req - request successfully initiated&n; *&t;&t;NULL - &n; *&n; * assumptions: This routine does not check whether the associated&n; *              remote port/lun has already been opened. This should be&n; *              done by calling routines. Otherwise some status&n; *              may be presented by FSF&n; */
r_int
DECL|function|zfcp_fsf_close_unit
id|zfcp_fsf_close_unit
c_func
(paren
r_struct
id|zfcp_erp_action
op_star
id|erp_action
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|erp_action-&gt;adapter
comma
id|FSF_QTCB_CLOSE_LUN
comma
id|ZFCP_WAIT_FOR_SBAL
op_or
id|ZFCP_REQ_AUTO_CLEANUP
comma
id|erp_action-&gt;adapter-&gt;pool.fsf_req_erp
comma
op_amp
id|lock_flags
comma
op_amp
(paren
id|erp_action-&gt;fsf_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create close unit request for &quot;
l_string|&quot;unit 0x%016Lx on port 0x%016Lx on adapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;unit-&gt;fcp_lun
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|erp_action-&gt;fsf_req
comma
id|erp_action-&gt;fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|erp_action-&gt;port-&gt;handle
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;qtcb-&gt;header.lun_handle
op_assign
id|erp_action-&gt;unit-&gt;handle
suffix:semicolon
id|atomic_set_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|erp_action-&gt;unit-&gt;status
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;data.close_unit.unit
op_assign
id|erp_action-&gt;unit
suffix:semicolon
id|erp_action-&gt;fsf_req-&gt;erp_action
op_assign
id|erp_action
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|erp_action-&gt;fsf_req
comma
op_amp
id|erp_action-&gt;timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send a close unit request for &quot;
l_string|&quot;unit 0x%016Lx on port 0x%016Lx onadapter %s.&bslash;n&quot;
comma
id|erp_action-&gt;unit-&gt;fcp_lun
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|erp_action-&gt;fsf_req
)paren
suffix:semicolon
id|erp_action-&gt;fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Close LUN request initiated (adapter %s, &quot;
l_string|&quot;port 0x%016Lx, unit 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|erp_action-&gt;adapter
)paren
comma
id|erp_action-&gt;port-&gt;wwpn
comma
id|erp_action-&gt;unit-&gt;fcp_lun
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|erp_action-&gt;adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_close_unit_handler&n; *&n; * purpose:     is called for finished Close LUN FSF command&n; *&n; * returns:&n; */
r_static
r_int
DECL|function|zfcp_fsf_close_unit_handler
id|zfcp_fsf_close_unit_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
id|unit
op_assign
id|fsf_req-&gt;data.close_unit.unit
suffix:semicolon
multiline_comment|/* restore unit */
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
multiline_comment|/* don&squot;t change unit status in our bookkeeping */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier 0x%x for port &quot;
l_string|&quot;0x%016Lx on adapter %s invalid. This may &quot;
l_string|&quot;happen in rare circumstances&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;porthinv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_LUN_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary LUN identifier 0x%x of unit &quot;
l_string|&quot;0x%016Lx on port 0x%016Lx on adapter %s is &quot;
l_string|&quot;invalid. This may happen occasionally.&bslash;n&quot;
comma
id|unit-&gt;handle
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Status qualifier data:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_lhand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;lunhinv&quot;
comma
id|fsf_req
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port 0x%016Lx on adapter %s &quot;
l_string|&quot;needs to be reopened&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* re-establish link to port */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ERP strategy will escalate */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;unit 0x%016Lx on port 0x%016Lx on adapter %s &quot;
l_string|&quot;closed, port handle 0x%x&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* mark unit as closed */
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_OPEN
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown FSF Status was presented &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|fsf_req-&gt;qtcb-&gt;header.fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|atomic_clear_mask
c_func
(paren
id|ZFCP_STATUS_COMMON_CLOSING
comma
op_amp
id|unit-&gt;status
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * zfcp_fsf_send_fcp_command_task - initiate an FCP command (for a SCSI command)&n; * @adapter: adapter where scsi command is issued&n; * @unit: unit where command is sent to&n; * @scsi_cmnd: scsi command to be sent&n; * @timer: timer to be started when request is initiated&n; * @req_flags: flags for fsf_request&n; */
r_int
DECL|function|zfcp_fsf_send_fcp_command_task
id|zfcp_fsf_send_fcp_command_task
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
r_struct
id|scsi_cmnd
op_star
id|scsi_cmnd
comma
r_struct
id|timer_list
op_star
id|timer
comma
r_int
id|req_flags
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmnd_iu
suffix:semicolon
r_int
r_int
id|sbtype
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|real_bytes
op_assign
l_int|0
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|mask
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_FCP_CMND
comma
id|req_flags
comma
id|adapter-&gt;pool.fsf_req_scsi
comma
op_amp
id|lock_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
OL
l_int|0
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Could not create FCP command request &quot;
l_string|&quot;for unit 0x%016Lx on port 0x%016Lx on &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_goto
id|failed_req_create
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * associate FSF request with SCSI request&n;&t; * (need this for look up on abort)&n;&t; */
id|fsf_req-&gt;data.send_fcp_command_task.fsf_req
op_assign
id|fsf_req
suffix:semicolon
id|scsi_cmnd-&gt;host_scribble
op_assign
(paren
r_char
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;data
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * associate SCSI command with FSF request&n;&t; * (need this for look up on normal command completion)&n;&t; */
id|fsf_req-&gt;data.send_fcp_command_task.scsi_cmnd
op_assign
id|scsi_cmnd
suffix:semicolon
id|fsf_req-&gt;data.send_fcp_command_task.start_jiffies
op_assign
id|jiffies
suffix:semicolon
id|fsf_req-&gt;data.send_fcp_command_task.unit
op_assign
id|unit
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;unit=%p, fcp_lun=0x%016Lx&bslash;n&quot;
comma
id|unit
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
multiline_comment|/* set handles of unit and its parent port in QTCB */
id|fsf_req-&gt;qtcb-&gt;header.lun_handle
op_assign
id|unit-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|unit-&gt;port-&gt;handle
suffix:semicolon
multiline_comment|/* FSF does not define the structure of the FCP_CMND IU */
id|fcp_cmnd_iu
op_assign
(paren
r_struct
id|fcp_cmnd_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set depending on data direction:&n;&t; *      data direction bits in SBALE (SB Type)&n;&t; *      data direction bits in QTCB&n;&t; *      data direction bits in FCP_CMND IU&n;&t; */
r_switch
c_cond
(paren
id|scsi_cmnd-&gt;sc_data_direction
)paren
(brace
r_case
id|DMA_NONE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;DMA_NONE&bslash;n&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
op_assign
id|FSF_DATADIR_CMND
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FIXME(qdio):&n;&t;&t; * what is the correct type for commands&n;&t;&t; * without &squot;real&squot; data buffers?&n;&t;&t; */
id|sbtype
op_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_FROM_DEVICE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;DMA_FROM_DEVICE&bslash;n&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
op_assign
id|FSF_DATADIR_READ
suffix:semicolon
id|sbtype
op_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
id|fcp_cmnd_iu-&gt;rddata
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_TO_DEVICE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;DMA_TO_DEVICE&bslash;n&quot;
)paren
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
op_assign
id|FSF_DATADIR_WRITE
suffix:semicolon
id|sbtype
op_assign
id|SBAL_FLAGS0_TYPE_WRITE
suffix:semicolon
id|fcp_cmnd_iu-&gt;wddata
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DMA_BIDIRECTIONAL
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;DMA_BIDIRECTIONAL not supported&bslash;n&quot;
)paren
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*&n;&t;&t; * dummy, catch this condition earlier&n;&t;&t; * in zfcp_scsi_queuecommand&n;&t;&t; */
r_goto
id|failed_scsi_cmnd
suffix:semicolon
)brace
multiline_comment|/* set FC service class in QTCB (3 per default) */
id|fsf_req-&gt;qtcb-&gt;bottom.io.service_class
op_assign
id|adapter-&gt;fc_service_class
suffix:semicolon
multiline_comment|/* set FCP_LUN in FCP_CMND IU in QTCB */
id|fcp_cmnd_iu-&gt;fcp_lun
op_assign
id|unit-&gt;fcp_lun
suffix:semicolon
id|mask
op_assign
id|ZFCP_STATUS_UNIT_READONLY
op_or
id|ZFCP_STATUS_UNIT_SHARED
suffix:semicolon
multiline_comment|/* set task attributes in FCP_CMND IU in QTCB */
r_if
c_cond
(paren
id|likely
c_func
(paren
(paren
id|scsi_cmnd-&gt;device-&gt;simple_tags
)paren
op_logical_or
(paren
id|atomic_test_mask
c_func
(paren
id|mask
comma
op_amp
id|unit-&gt;status
)paren
)paren
)paren
)paren
id|fcp_cmnd_iu-&gt;task_attribute
op_assign
id|SIMPLE_Q
suffix:semicolon
r_else
id|fcp_cmnd_iu-&gt;task_attribute
op_assign
id|UNTAGGED
suffix:semicolon
multiline_comment|/* set additional length of FCP_CDB in FCP_CMND IU in QTCB, if needed */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|scsi_cmnd-&gt;cmd_len
OG
id|FCP_CDB_LENGTH
)paren
)paren
(brace
id|fcp_cmnd_iu-&gt;add_fcp_cdb_length
op_assign
(paren
id|scsi_cmnd-&gt;cmd_len
op_minus
id|FCP_CDB_LENGTH
)paren
op_rshift
l_int|2
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;SCSI CDB length is 0x%x, &quot;
l_string|&quot;additional FCP_CDB length is 0x%x &quot;
l_string|&quot;(shifted right 2 bits)&bslash;n&quot;
comma
id|scsi_cmnd-&gt;cmd_len
comma
id|fcp_cmnd_iu-&gt;add_fcp_cdb_length
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * copy SCSI CDB (including additional length, if any) to&n;&t; * FCP_CDB in FCP_CMND IU in QTCB&n;&t; */
id|memcpy
c_func
(paren
id|fcp_cmnd_iu-&gt;fcp_cdb
comma
id|scsi_cmnd-&gt;cmnd
comma
id|scsi_cmnd-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/* FCP CMND IU length in QTCB */
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd_length
op_assign
r_sizeof
(paren
r_struct
id|fcp_cmnd_iu
)paren
op_plus
id|fcp_cmnd_iu-&gt;add_fcp_cdb_length
op_plus
r_sizeof
(paren
id|fcp_dl_t
)paren
suffix:semicolon
multiline_comment|/* generate SBALEs from data buffer */
id|real_bytes
op_assign
id|zfcp_qdio_sbals_from_scsicmnd
c_func
(paren
id|fsf_req
comma
id|sbtype
comma
id|scsi_cmnd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|real_bytes
OL
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|fsf_req-&gt;sbal_number
OL
id|ZFCP_MAX_SBALS_PER_REQ
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Data did not fit into available buffer(s), &quot;
l_string|&quot;waiting for more...&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: No truncation implemented but &quot;
l_string|&quot;required. Shutting down unit &quot;
l_string|&quot;(adapter %s, port 0x%016Lx, &quot;
l_string|&quot;unit 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_erp_unit_shutdown
c_func
(paren
id|unit
comma
l_int|0
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_goto
id|no_fit
suffix:semicolon
)brace
multiline_comment|/* set length of FCP data length in FCP_CMND IU in QTCB */
id|zfcp_set_fcp_dl
c_func
(paren
id|fcp_cmnd_iu
comma
id|real_bytes
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Sending SCSI command:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
id|scsi_cmnd-&gt;cmnd
comma
id|scsi_cmnd-&gt;cmd_len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * start QDIO request for this FSF request&n;&t; *  covered by an SBALE)&n;&t; */
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
id|timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
OL
l_int|0
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send FCP command request &quot;
l_string|&quot;on adapter %s, port 0x%016Lx, unit 0x%016Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
r_goto
id|send_failed
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Send FCP Command initiated (adapter %s, &quot;
l_string|&quot;port 0x%016Lx, unit 0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
r_goto
id|success
suffix:semicolon
id|send_failed
suffix:colon
id|no_fit
suffix:colon
id|failed_scsi_cmnd
suffix:colon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
id|scsi_cmnd-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
id|success
suffix:colon
id|failed_req_create
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_task_management&n; *&n; * purpose:&n; *&n; * returns:&n; *&n; * FIXME(design): should be watched by a timeout!!!&n; * FIXME(design) shouldn&squot;t this be modified to return an int&n; *               also...don&squot;t know how though&n; *&n; */
r_struct
id|zfcp_fsf_req
op_star
DECL|function|zfcp_fsf_send_fcp_command_task_management
id|zfcp_fsf_send_fcp_command_task_management
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_unit
op_star
id|unit
comma
id|u8
id|tm_flags
comma
r_int
id|req_flags
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmnd_iu
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
multiline_comment|/* setup new FSF request */
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|FSF_QTCB_FCP_CMND
comma
id|req_flags
comma
id|adapter-&gt;pool.fsf_req_scsi
comma
op_amp
id|lock_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create FCP command (task &quot;
l_string|&quot;management) request for adapter %s, port &quot;
l_string|&quot; 0x%016Lx, unit 0x%016Lx.&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Used to decide on proper handler in the return path,&n;&t; * could be either zfcp_fsf_send_fcp_command_task_handler or&n;&t; * zfcp_fsf_send_fcp_command_task_management_handler */
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TASK_MANAGEMENT
suffix:semicolon
multiline_comment|/*&n;&t; * hold a pointer to the unit being target of this&n;&t; * task management request&n;&t; */
id|fsf_req-&gt;data.send_fcp_command_task_management.unit
op_assign
id|unit
suffix:semicolon
multiline_comment|/* set FSF related fields in QTCB */
id|fsf_req-&gt;qtcb-&gt;header.lun_handle
op_assign
id|unit-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.port_handle
op_assign
id|unit-&gt;port-&gt;handle
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
op_assign
id|FSF_DATADIR_CMND
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.service_class
op_assign
id|adapter-&gt;fc_service_class
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd_length
op_assign
r_sizeof
(paren
r_struct
id|fcp_cmnd_iu
)paren
op_plus
r_sizeof
(paren
id|fcp_dl_t
)paren
suffix:semicolon
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_TYPE_WRITE
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
multiline_comment|/* set FCP related fields in FCP_CMND IU in QTCB */
id|fcp_cmnd_iu
op_assign
(paren
r_struct
id|fcp_cmnd_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd
)paren
suffix:semicolon
id|fcp_cmnd_iu-&gt;fcp_lun
op_assign
id|unit-&gt;fcp_lun
suffix:semicolon
id|fcp_cmnd_iu-&gt;task_management_flags
op_assign
id|tm_flags
suffix:semicolon
multiline_comment|/* start QDIO request for this FSF request */
id|zfcp_fsf_start_scsi_er_timer
c_func
(paren
id|adapter
)paren
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not send an FCP-command (task &quot;
l_string|&quot;management) on adapter %s, port 0x%016Lx for &quot;
l_string|&quot;unit LUN 0x%016Lx&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;Send FCP Command (task management function) initiated &quot;
l_string|&quot;(adapter %s, port 0x%016Lx, unit 0x%016Lx, &quot;
l_string|&quot;tm_flags=0x%x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
comma
id|tm_flags
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
r_return
id|fsf_req
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_handler&n; *&n; * purpose:&t;is called for finished Send FCP Command&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_send_fcp_command_handler
id|zfcp_fsf_send_fcp_command_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
suffix:semicolon
r_struct
id|fsf_qtcb_header
op_star
id|header
suffix:semicolon
id|u16
id|subtable
comma
id|rule
comma
id|counter
suffix:semicolon
id|header
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;header
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_TASK_MANAGEMENT
)paren
)paren
id|unit
op_assign
id|fsf_req-&gt;data.send_fcp_command_task_management.unit
suffix:semicolon
r_else
id|unit
op_assign
id|fsf_req-&gt;data.send_fcp_command_task.unit
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
)paren
(brace
multiline_comment|/* go directly to calls of special handlers */
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* evaluate FSF status in QTCB */
r_switch
c_cond
(paren
id|header-&gt;fsf_status
)paren
(brace
r_case
id|FSF_PORT_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_PORT_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary port identifier 0x%x for port &quot;
l_string|&quot;0x%016Lx on adapter %s invalid&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_phand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_HANDLE_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|1
comma
l_string|&quot;FSF_LUN_HANDLE_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Temporary LUN identifier 0x%x for unit &quot;
l_string|&quot;0x%016Lx on port 0x%016Lx on adapter %s is &quot;
l_string|&quot;invalid. This may happen occasionally.&bslash;n&quot;
comma
id|unit-&gt;handle
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Status qualifier data:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_uhand_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_HANDLE_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_HANDLE_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The port handle 0x%x has changed &quot;
l_string|&quot;unexpectedly. (adapter %s, port 0x%016Lx, &quot;
l_string|&quot;unit 0x%016Lx)&bslash;n&quot;
comma
id|unit-&gt;port-&gt;handle
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_NORMAL
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_hand_mis&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_reopen
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;handmism&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SERVICE_CLASS_NOT_SUPPORTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_SERVICE_CLASS_NOT_SUPPORTED&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;adapter-&gt;fc_service_class
op_le
l_int|3
)paren
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;error: The adapter %s does &quot;
l_string|&quot;not support fibrechannel class %d.&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fsf_req-&gt;adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
r_else
(brace
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The fibrechannel class at &quot;
l_string|&quot;adapter %s is invalid. &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fsf_req-&gt;adapter-&gt;fc_service_class
)paren
suffix:semicolon
)brace
multiline_comment|/* stop operation for this adapter */
id|debug_text_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_class_nsup&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;unsclass&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_FCPLUN_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_FCPLUN_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: unit 0x%016Lx on port 0x%016Lx on &quot;
l_string|&quot;adapter %s does not have correct unit &quot;
l_string|&quot;handle 0x%x&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;handle
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status qualifier:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_fcp_lun_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;fluninv&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ACCESS_DENIED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ACCESS_DENIED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Access denied, cannot send FCP command to &quot;
l_string|&quot;unit 0x%016Lx on port 0x%016Lx on &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter
OL
l_int|2
suffix:semicolon
id|counter
op_increment
)paren
(brace
id|subtable
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
)braket
suffix:semicolon
id|rule
op_assign
id|header-&gt;fsf_status_qual.halfword
(braket
id|counter
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|subtable
)paren
(brace
r_case
id|FSF_SQ_CFDC_SUBTABLE_OS
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_WWPN
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_PORT_DID
suffix:colon
r_case
id|FSF_SQ_CFDC_SUBTABLE_LUN
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Access denied (%s rule %d)&bslash;n&quot;
comma
id|zfcp_act_subtable_type
(braket
id|subtable
)braket
comma
id|rule
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_access&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_access_denied
c_func
(paren
id|unit
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_DIRECTION_INDICATOR_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_DIRECTION_INDICATOR_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;bug: Invalid data direction given for unit &quot;
l_string|&quot;0x%016Lx on port 0x%016Lx on adapter %s &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fsf_req-&gt;qtcb-&gt;bottom.io.data_direction
)paren
suffix:semicolon
multiline_comment|/* stop operation for this adapter */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_dir_ind_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;dirinv&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_CMND_LENGTH_NOT_VALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_CMND_LENGTH_NOT_VALID&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: An invalid control-data-block length field &quot;
l_string|&quot;was found in a command for unit 0x%016Lx on port &quot;
l_string|&quot;0x%016Lx on adapter %s &quot;
l_string|&quot;(debug info %d)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd_length
)paren
suffix:semicolon
multiline_comment|/* stop operation for this adapter */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_cmd_len_nv&quot;
)paren
suffix:semicolon
id|zfcp_erp_adapter_shutdown
c_func
(paren
id|unit-&gt;port-&gt;adapter
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;cleninv&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_PORT_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_PORT_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;The remote port 0x%016Lx on adapter %s &quot;
l_string|&quot;needs to be reopened&bslash;n&quot;
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|2
comma
l_string|&quot;fsf_s_pboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;portbox&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_LUN_BOXED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;FSF_LUN_BOXED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;unit needs to be reopened (adapter %s, &quot;
l_string|&quot;wwpn=0x%016Lx, fcp_lun=0x%016Lx)&bslash;n&quot;
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|unit-&gt;port-&gt;wwpn
comma
id|unit-&gt;fcp_lun
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_s_lboxed&quot;
)paren
suffix:semicolon
id|zfcp_erp_unit_reopen
c_func
(paren
id|unit
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;unitbox&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
op_or
id|ZFCP_STATUS_FSFREQ_RETRY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ADAPTER_STATUS_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ADAPTER_STATUS_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_INVOKE_LINK_TEST_PROCEDURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_SQ_INVOKE_LINK_TEST_PROCEDURE&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* re-establish link to port */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ltest&quot;
)paren
suffix:semicolon
id|zfcp_erp_port_reopen
c_func
(paren
id|unit-&gt;port
comma
l_int|0
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqltest&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_SQ_ULP_DEPENDENT_ERP_REQUIRED&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME(hw) need proper specs for proper action */
multiline_comment|/* let scsi stack deal with retries and escalation */
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|1
comma
l_string|&quot;fsf_sq_ulp&quot;
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;sqdeperp&quot;
comma
id|fsf_req
comma
op_amp
id|header-&gt;fsf_status_qual
comma
r_sizeof
(paren
r_union
id|fsf_status_qual
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* FIXME: shall we consider this a successful transfer? */
id|ZFCP_LOG_NORMAL
(paren
l_string|&quot;bug: Wrong status qualifier 0x%x arrived.&bslash;n&quot;
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_FCP_RSP_AVAILABLE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_FCP_RSP_AVAILABLE&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_s_inval:&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_TASK_MANAGEMENT
)paren
(brace
id|retval
op_assign
id|zfcp_fsf_send_fcp_command_task_management_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
id|zfcp_fsf_send_fcp_command_task_handler
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_task_handler&n; *&n; * purpose:&t;evaluates FCP_RSP IU&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_send_fcp_command_task_handler
id|zfcp_fsf_send_fcp_command_task_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|scsi_cmnd
op_star
id|scpnt
suffix:semicolon
r_struct
id|fcp_rsp_iu
op_star
id|fcp_rsp_iu
op_assign
(paren
r_struct
id|fcp_rsp_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_rsp
)paren
suffix:semicolon
r_struct
id|fcp_cmnd_iu
op_star
id|fcp_cmnd_iu
op_assign
(paren
r_struct
id|fcp_cmnd_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_cmnd
)paren
suffix:semicolon
id|u32
id|sns_len
suffix:semicolon
r_char
op_star
id|fcp_rsp_info
op_assign
id|zfcp_get_fcp_rsp_info_ptr
c_func
(paren
id|fcp_rsp_iu
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|fsf_req-&gt;data.send_fcp_command_task.unit
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
op_amp
id|fsf_req-&gt;adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
id|scpnt
op_assign
id|fsf_req-&gt;data.send_fcp_command_task.scsi_cmnd
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|scpnt
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
(paren
l_string|&quot;Command with fsf_req %p is not associated to &quot;
l_string|&quot;a scsi command anymore. Aborted?&bslash;n&quot;
comma
id|fsf_req
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ABORTED
)paren
)paren
(brace
multiline_comment|/* FIXME: (design) mid-layer should handle DID_ABORT like&n;&t;&t; *        DID_SOFT_ERROR by retrying the request for devices&n;&t;&t; *        that allow retries.&n;&t;&t; */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Setting DID_SOFT_ERROR and SUGGEST_RETRY&bslash;n&quot;
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_SOFT_ERROR
)paren
suffix:semicolon
id|set_driver_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|SUGGEST_RETRY
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Setting DID_ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* set message byte of result in SCSI command */
id|scpnt-&gt;result
op_or_assign
id|COMMAND_COMPLETE
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/*&n;&t; * copy SCSI status code of FCP_STATUS of FCP_RSP IU to status byte&n;&t; * of result in SCSI command&n;&t; */
id|scpnt-&gt;result
op_or_assign
id|fcp_rsp_iu-&gt;scsi_status
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;scsi_status
)paren
)paren
(brace
multiline_comment|/* DEBUG */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;status for SCSI Command:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
id|scpnt-&gt;cmnd
comma
id|scpnt-&gt;cmd_len
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;SCSI status code 0x%x&bslash;n&quot;
comma
id|fcp_rsp_iu-&gt;scsi_status
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_void
op_star
)paren
id|fcp_rsp_iu
comma
r_sizeof
(paren
r_struct
id|fcp_rsp_iu
)paren
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
id|zfcp_get_fcp_sns_info_ptr
c_func
(paren
id|fcp_rsp_iu
)paren
comma
id|fcp_rsp_iu-&gt;fcp_sns_len
)paren
suffix:semicolon
)brace
multiline_comment|/* check FCP_RSP_INFO */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_rsp_len_valid
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;rsp_len is valid&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fcp_rsp_info
(braket
l_int|3
)braket
)paren
(brace
r_case
id|RSP_CODE_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;RSP_CODE_GOOD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ok, continue */
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;no failure or Task Management &quot;
l_string|&quot;Function complete&bslash;n&quot;
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_OK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RSP_CODE_LENGTH_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_LENGTH_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* hardware bug */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: FCP response code indictates &quot;
l_string|&quot;that the fibrechannel protocol data &quot;
l_string|&quot;length differs from the burst length. &quot;
l_string|&quot;The problem occured on unit 0x%016Lx &quot;
l_string|&quot;on port 0x%016Lx on adapter %s&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
multiline_comment|/* dump SCSI CDB as prepared by zfcp */
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb
op_member_access_from_pointer
id|bottom.io.fcp_cmnd
comma
id|FSF_FCP_CMND_SIZE
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;clenmis&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
r_case
id|RSP_CODE_FIELD_INVALID
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_FIELD_INVALID&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* driver or hardware bug */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: FCP response code indictates &quot;
l_string|&quot;that the fibrechannel protocol data &quot;
l_string|&quot;fields were incorrectly set up. &quot;
l_string|&quot;The problem occured on the unit &quot;
l_string|&quot;0x%016Lx on port 0x%016Lx on &quot;
l_string|&quot;adapter %s&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
multiline_comment|/* dump SCSI CDB as prepared by zfcp */
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb
op_member_access_from_pointer
id|bottom.io.fcp_cmnd
comma
id|FSF_FCP_CMND_SIZE
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;codeinv&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
r_case
id|RSP_CODE_RO_MISMATCH
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_RO_MISMATCH&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* hardware bug */
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: The FCP response code indicates &quot;
l_string|&quot;that conflicting  values for the &quot;
l_string|&quot;fibrechannel payload offset from the &quot;
l_string|&quot;header were found. &quot;
l_string|&quot;The problem occured on unit 0x%016Lx &quot;
l_string|&quot;on port 0x%016Lx on adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
multiline_comment|/* dump SCSI CDB as prepared by zfcp */
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb
op_member_access_from_pointer
id|bottom.io.fcp_cmnd
comma
id|FSF_FCP_CMND_SIZE
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;codemism&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An invalid FCP response &quot;
l_string|&quot;code was detected for a command. &quot;
l_string|&quot;The problem occured on the unit &quot;
l_string|&quot;0x%016Lx on port 0x%016Lx on &quot;
l_string|&quot;adapter %s (debug info 0x%x)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fcp_rsp_info
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/* dump SCSI CDB as prepared by zfcp */
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_DEBUG
comma
(paren
r_char
op_star
)paren
op_amp
id|fsf_req-&gt;qtcb
op_member_access_from_pointer
id|bottom.io.fcp_cmnd
comma
id|FSF_FCP_CMND_SIZE
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_fsf
c_func
(paren
l_string|&quot;undeffcp&quot;
comma
id|fsf_req
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|set_host_byte
c_func
(paren
op_amp
id|scpnt-&gt;result
comma
id|DID_ERROR
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* check for sense data */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_sns_len_valid
)paren
)paren
(brace
id|sns_len
op_assign
id|FSF_FCP_RSP_SIZE
op_minus
r_sizeof
(paren
r_struct
id|fcp_rsp_iu
)paren
op_plus
id|fcp_rsp_iu-&gt;fcp_rsp_len
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;room for %i bytes sense data in QTCB&bslash;n&quot;
comma
id|sns_len
)paren
suffix:semicolon
id|sns_len
op_assign
id|min
c_func
(paren
id|sns_len
comma
(paren
id|u32
)paren
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;room for %i bytes sense data in SCSI command&bslash;n&quot;
comma
id|SCSI_SENSE_BUFFERSIZE
)paren
suffix:semicolon
id|sns_len
op_assign
id|min
c_func
(paren
id|sns_len
comma
id|fcp_rsp_iu-&gt;fcp_sns_len
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;scpnt-&gt;result =0x%x, command was:&bslash;n&quot;
comma
id|scpnt-&gt;result
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_void
op_star
)paren
op_amp
id|scpnt-&gt;cmnd
comma
id|scpnt-&gt;cmd_len
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;%i bytes sense data provided by FCP&bslash;n&quot;
comma
id|fcp_rsp_iu-&gt;fcp_sns_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|scpnt-&gt;sense_buffer
comma
id|zfcp_get_fcp_sns_info_ptr
c_func
(paren
id|fcp_rsp_iu
)paren
comma
id|sns_len
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_void
op_star
)paren
op_amp
id|scpnt-&gt;sense_buffer
comma
id|sns_len
)paren
suffix:semicolon
)brace
multiline_comment|/* check for overrun */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_resid_over
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;A data overrun was detected for a command. &quot;
l_string|&quot;unit 0x%016Lx, port 0x%016Lx, adapter %s. &quot;
l_string|&quot;The response data length is &quot;
l_string|&quot;%d, the original length was %d.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fcp_rsp_iu-&gt;fcp_resid
comma
(paren
r_int
)paren
id|zfcp_get_fcp_dl
c_func
(paren
id|fcp_cmnd_iu
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* check for underrun */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|fcp_rsp_iu-&gt;validity.bits.fcp_resid_under
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;A data underrun was detected for a command. &quot;
l_string|&quot;unit 0x%016Lx, port 0x%016Lx, adapter %s. &quot;
l_string|&quot;The response data length is &quot;
l_string|&quot;%d, the original length was %d.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fcp_rsp_iu-&gt;fcp_resid
comma
(paren
r_int
)paren
id|zfcp_get_fcp_dl
c_func
(paren
id|fcp_cmnd_iu
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * It may not have been possible to send all data and the&n;&t;&t; * underrun on send may already be in scpnt-&gt;resid, so it&squot;s add&n;&t;&t; * not equals in the below statement.&n;&t;&t; */
id|scpnt-&gt;resid
op_add_assign
id|fcp_rsp_iu-&gt;fcp_resid
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;scpnt-&gt;resid=0x%x&bslash;n&quot;
comma
id|scpnt-&gt;resid
)paren
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;scpnt-&gt;result =0x%x&bslash;n&quot;
comma
id|scpnt-&gt;result
)paren
suffix:semicolon
id|zfcp_cmd_dbf_event_scsi
c_func
(paren
l_string|&quot;response&quot;
comma
id|scpnt
)paren
suffix:semicolon
multiline_comment|/* cleanup pointer (need this especially for abort) */
id|scpnt-&gt;host_scribble
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * NOTE:&n;&t; * according to the outcome of a discussion on linux-scsi we&n;&t; * don&squot;t need to grab the io_request_lock here since we use&n;&t; * the new eh&n;&t; */
multiline_comment|/* always call back */
(paren
id|scpnt-&gt;scsi_done
)paren
(paren
id|scpnt
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We must hold this lock until scsi_done has been called.&n;&t; * Otherwise we may call scsi_done after abort regarding this&n;&t; * command has completed.&n;&t; * Note: scsi_done must not block!&n;&t; */
id|out
suffix:colon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|fsf_req-&gt;adapter-&gt;abort_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_send_fcp_command_task_management_handler&n; *&n; * purpose:&t;evaluates FCP_RSP IU&n; *&n; * returns:&t;&n; */
r_static
r_int
DECL|function|zfcp_fsf_send_fcp_command_task_management_handler
id|zfcp_fsf_send_fcp_command_task_management_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|fcp_rsp_iu
op_star
id|fcp_rsp_iu
op_assign
(paren
r_struct
id|fcp_rsp_iu
op_star
)paren
op_amp
(paren
id|fsf_req-&gt;qtcb-&gt;bottom.io.fcp_rsp
)paren
suffix:semicolon
r_char
op_star
id|fcp_rsp_info
op_assign
id|zfcp_get_fcp_rsp_info_ptr
c_func
(paren
id|fcp_rsp_iu
)paren
suffix:semicolon
r_struct
id|zfcp_unit
op_star
id|unit
op_assign
id|fsf_req-&gt;data.send_fcp_command_task_management.unit
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|fsf_req-&gt;adapter-&gt;scsi_er_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TMFUNCFAILED
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
multiline_comment|/* check FCP_RSP_INFO */
r_switch
c_cond
(paren
id|fcp_rsp_info
(braket
l_int|3
)braket
)paren
(brace
r_case
id|RSP_CODE_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|3
comma
l_string|&quot;RSP_CODE_GOOD&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* ok, continue */
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;no failure or Task Management &quot;
l_string|&quot;Function complete&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RSP_CODE_TASKMAN_UNSUPP
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_TASKMAN_UNSUPP&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: A reuested task management function &quot;
l_string|&quot;is not supported on the target device &quot;
l_string|&quot;unit 0x%016Lx, port 0x%016Lx, adapter %s&bslash;n &quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TMFUNCNOTSUPP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RSP_CODE_TASKMAN_FAILED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|0
comma
l_string|&quot;RSP_CODE_TASKMAN_FAILED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: A reuested task management function &quot;
l_string|&quot;failed to complete successfully. &quot;
l_string|&quot;unit 0x%016Lx, port 0x%016Lx, adapter %s.&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TMFUNCFAILED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An invalid FCP response &quot;
l_string|&quot;code was detected for a command. &quot;
l_string|&quot;unit 0x%016Lx, port 0x%016Lx, adapter %s &quot;
l_string|&quot;(debug info 0x%x)&bslash;n&quot;
comma
id|unit-&gt;fcp_lun
comma
id|unit-&gt;port-&gt;wwpn
comma
id|zfcp_get_busid_by_unit
c_func
(paren
id|unit
)paren
comma
id|fcp_rsp_info
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_TMFUNCFAILED
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_control_file&n; *&n; * purpose:     Initiator of the control file upload/download FSF requests&n; *&n; * returns:     0           - FSF request is successfuly created and queued&n; *              -EOPNOTSUPP - The FCP adapter does not have Control File support&n; *              -EINVAL     - Invalid direction specified&n; *              -ENOMEM     - Insufficient memory&n; *              -EPERM      - Cannot create FSF request or place it in QDIO queue&n; */
r_int
DECL|function|zfcp_fsf_control_file
id|zfcp_fsf_control_file
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_struct
id|zfcp_fsf_req
op_star
op_star
id|fsf_req_ptr
comma
id|u32
id|fsf_command
comma
id|u32
id|option
comma
r_struct
id|zfcp_sg_list
op_star
id|sg_list
)paren
(brace
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
suffix:semicolon
r_struct
id|fsf_qtcb_bottom_support
op_star
id|bottom
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_struct
id|timer_list
op_star
id|timer
suffix:semicolon
r_int
r_int
id|lock_flags
suffix:semicolon
r_int
id|req_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|direction
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|adapter-&gt;supported_features
op_amp
id|FSF_FEATURE_CFDC
)paren
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;cfdc not supported (adapter %s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|fsf_command
)paren
(brace
r_case
id|FSF_QTCB_DOWNLOAD_CONTROL_FILE
suffix:colon
id|direction
op_assign
id|SBAL_FLAGS0_TYPE_WRITE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|option
op_ne
id|FSF_CFDC_OPTION_FULL_ACCESS
)paren
op_logical_and
(paren
id|option
op_ne
id|FSF_CFDC_OPTION_RESTRICTED_ACCESS
)paren
)paren
id|req_flags
op_assign
id|ZFCP_WAIT_FOR_SBAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_QTCB_UPLOAD_CONTROL_FILE
suffix:colon
id|direction
op_assign
id|SBAL_FLAGS0_TYPE_READ
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;Invalid FSF command code 0x%08x&bslash;n&quot;
comma
id|fsf_command
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|timer
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|timer_list
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer
)paren
(brace
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|zfcp_fsf_req_create
c_func
(paren
id|adapter
comma
id|fsf_command
comma
id|req_flags
comma
l_int|NULL
comma
op_amp
id|lock_flags
comma
op_amp
id|fsf_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create FSF request for the &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|unlock_queue_lock
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|direction
suffix:semicolon
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.support
suffix:semicolon
id|bottom-&gt;operation_subtype
op_assign
id|FSF_CFDC_OPERATION_SUBTYPE
suffix:semicolon
id|bottom-&gt;option
op_assign
id|option
suffix:semicolon
r_if
c_cond
(paren
id|sg_list-&gt;count
OG
l_int|0
)paren
(brace
r_int
id|bytes
suffix:semicolon
id|bytes
op_assign
id|zfcp_qdio_sbals_from_sg
c_func
(paren
id|fsf_req
comma
id|direction
comma
id|sg_list-&gt;sg
comma
id|sg_list-&gt;count
comma
id|ZFCP_MAX_SBALS_PER_REQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bytes
op_ne
id|ZFCP_CFDC_MAX_CONTROL_FILE_SIZE
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;error: Could not create sufficient number of &quot;
l_string|&quot;SBALS for an FSF request to the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_fsf_req
suffix:semicolon
)brace
)brace
r_else
id|sbale
(braket
l_int|1
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS_LAST_ENTRY
suffix:semicolon
id|init_timer
c_func
(paren
id|timer
)paren
suffix:semicolon
id|timer-&gt;function
op_assign
id|zfcp_fsf_request_timeout_handler
suffix:semicolon
id|timer-&gt;data
op_assign
(paren
r_int
r_int
)paren
id|adapter
suffix:semicolon
id|timer-&gt;expires
op_assign
id|ZFCP_FSF_REQUEST_TIMEOUT
suffix:semicolon
id|retval
op_assign
id|zfcp_fsf_req_send
c_func
(paren
id|fsf_req
comma
id|timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|ZFCP_LOG_INFO
c_func
(paren
l_string|&quot;initiation of cfdc up/download failed&quot;
l_string|&quot;(adapter %s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|free_fsf_req
suffix:semicolon
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Control file %s FSF request has been sent to the &quot;
l_string|&quot;adapter %s&bslash;n&quot;
comma
id|fsf_command
op_eq
id|FSF_QTCB_DOWNLOAD_CONTROL_FILE
ques
c_cond
l_string|&quot;download&quot;
suffix:colon
l_string|&quot;upload&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|wait_event
c_func
(paren
id|fsf_req-&gt;completion_wq
comma
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_COMPLETED
)paren
suffix:semicolon
op_star
id|fsf_req_ptr
op_assign
id|fsf_req
suffix:semicolon
id|del_timer_sync
c_func
(paren
id|timer
)paren
suffix:semicolon
r_goto
id|free_timer
suffix:semicolon
id|free_fsf_req
suffix:colon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|unlock_queue_lock
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;request_queue.queue_lock
comma
id|lock_flags
)paren
suffix:semicolon
id|free_timer
suffix:colon
id|kfree
c_func
(paren
id|timer
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_control_file_handler&n; *&n; * purpose:     Handler of the control file upload/download FSF requests&n; *&n; * returns:     0       - FSF request successfuly processed&n; *              -EAGAIN - Operation has to be repeated because of a temporary problem&n; *              -EACCES - There is no permission to execute an operation&n; *              -EPERM  - The control file is not in a right format&n; *              -EIO    - There is a problem with the FCP adapter&n; *              -EINVAL - Invalid operation&n; *              -EFAULT - User space memory I/O operation fault&n; */
r_static
r_int
DECL|function|zfcp_fsf_control_file_handler
id|zfcp_fsf_control_file_handler
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_struct
id|fsf_qtcb_header
op_star
id|header
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;header
suffix:semicolon
r_struct
id|fsf_qtcb_bottom_support
op_star
id|bottom
op_assign
op_amp
id|fsf_req-&gt;qtcb-&gt;bottom.support
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_ERROR
)paren
(brace
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|skip_fsfstatus
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|header-&gt;fsf_status
)paren
(brace
r_case
id|FSF_GOOD
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_GOOD&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;The FSF request has been successfully completed &quot;
l_string|&quot;on the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_OPERATION_PARTIALLY_SUCCESSFUL
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_OPERATION_PARTIALLY_SUCCESSFUL&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bottom-&gt;operation_subtype
op_eq
id|FSF_CFDC_OPERATION_SUBTYPE
)paren
(brace
r_switch
c_cond
(paren
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
(brace
r_case
id|FSF_SQ_CFDC_COULD_NOT_HARDEN_ON_SE
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;CFDC of the adapter %s could not &quot;
l_string|&quot;be saved on the SE&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_SQ_CFDC_COULD_NOT_HARDEN_ON_SE2
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;CFDC of the adapter %s could not &quot;
l_string|&quot;be copied to the secondary SE&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;CFDC could not be hardened &quot;
l_string|&quot;on the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
)brace
)brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_AUTHORIZATION_FAILURE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_AUTHORIZATION_FAILURE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Adapter %s does not accept privileged commands&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_CFDC_ERROR_DETECTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_CFDC_ERROR_DETECTED&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Error at position %d in the CFDC, &quot;
l_string|&quot;CFDC is discarded by the adapter %s&bslash;n&quot;
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EPERM
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_CONTROL_FILE_UPDATE_ERROR
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_CONTROL_FILE_UPDATE_ERROR&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Adapter %s cannot harden the control file, &quot;
l_string|&quot;file is discarded&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_CONTROL_FILE_TOO_LARGE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_CONTROL_FILE_TOO_LARGE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Control file is too large, file is discarded &quot;
l_string|&quot;by the adapter %s&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_ACCESS_CONFLICT_DETECTED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_ACCESS_CONFLICT_DETECTED&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bottom-&gt;operation_subtype
op_eq
id|FSF_CFDC_OPERATION_SUBTYPE
)paren
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;CFDC has been discarded by the adapter %s, &quot;
l_string|&quot;because activation would impact &quot;
l_string|&quot;%d active connection(s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_CONFLICTS_OVERRULED
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_CONFLICTS_OVERRULED&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bottom-&gt;operation_subtype
op_eq
id|FSF_CFDC_OPERATION_SUBTYPE
)paren
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;CFDC has been activated on the adapter %s, &quot;
l_string|&quot;but activation has impacted &quot;
l_string|&quot;%d active connection(s)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_UNKNOWN_OP_SUBTYPE
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_UNKNOWN_OP_SUBTYPE&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;unknown operation subtype (adapter: %s, &quot;
l_string|&quot;op_subtype=0x%x)&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|bottom-&gt;operation_subtype
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FSF_INVALID_COMMAND_OPTION
suffix:colon
id|ZFCP_LOG_FLAGS
c_func
(paren
l_int|2
comma
l_string|&quot;FSF_INVALID_COMMAND_OPTION&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;Invalid option 0x%x has been specified &quot;
l_string|&quot;in QTCB bottom sent to the adapter %s&bslash;n&quot;
comma
id|bottom-&gt;option
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ZFCP_LOG_NORMAL
c_func
(paren
l_string|&quot;bug: An unknown/unexpected FSF status 0x%08x &quot;
l_string|&quot;was presented on the adapter %s&bslash;n&quot;
comma
id|header-&gt;fsf_status
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
)paren
suffix:semicolon
id|debug_text_event
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
l_string|&quot;fsf_sq_inval&quot;
)paren
suffix:semicolon
id|debug_exception
c_func
(paren
id|fsf_req-&gt;adapter-&gt;erp_dbf
comma
l_int|0
comma
op_amp
id|header-&gt;fsf_status_qual.word
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_ERROR
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|skip_fsfstatus
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_wait_and_cleanup&n; *&n; * purpose:&n; *&n; * FIXME(design): signal seems to be &lt;0 !!!&n; * returns:&t;0&t;- request completed (*status is valid), cleanup succ.&n; *&t;&t;&lt;0&t;- request completed (*status is valid), cleanup failed&n; *&t;&t;&gt;0&t;- signal which interrupted waiting (*status invalid),&n; *&t;&t;&t;  request not completed, no cleanup&n; *&n; *&t;&t;*status is a copy of status of completed fsf_req&n; */
r_int
DECL|function|zfcp_fsf_req_wait_and_cleanup
id|zfcp_fsf_req_wait_and_cleanup
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
r_int
id|interruptible
comma
id|u32
op_star
id|status
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|signal
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|interruptible
)paren
(brace
id|__wait_event_interruptible
c_func
(paren
id|fsf_req-&gt;completion_wq
comma
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_COMPLETED
comma
id|signal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;Caught signal %i while waiting for the &quot;
l_string|&quot;completion of the request at %p&bslash;n&quot;
comma
id|signal
comma
id|fsf_req
)paren
suffix:semicolon
id|retval
op_assign
id|signal
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_else
(brace
id|__wait_event
c_func
(paren
id|fsf_req-&gt;completion_wq
comma
id|fsf_req-&gt;status
op_amp
id|ZFCP_STATUS_FSFREQ_COMPLETED
)paren
suffix:semicolon
)brace
op_star
id|status
op_assign
id|fsf_req-&gt;status
suffix:semicolon
multiline_comment|/* cleanup request */
id|zfcp_fsf_req_cleanup
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|zfcp_fsf_req_sbal_check
id|zfcp_fsf_req_sbal_check
c_func
(paren
r_int
r_int
op_star
id|flags
comma
r_struct
id|zfcp_qdio_queue
op_star
id|queue
comma
r_int
id|needed
)paren
(brace
id|write_lock_irqsave
c_func
(paren
op_amp
id|queue-&gt;queue_lock
comma
op_star
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|queue-&gt;free_count
)paren
op_ge
id|needed
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|queue-&gt;queue_lock
comma
op_star
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * set qtcb pointer in fsf_req and initialize QTCB&n; */
r_static
r_inline
r_void
DECL|function|zfcp_fsf_req_qtcb_init
id|zfcp_fsf_req_qtcb_init
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
id|u32
id|fsf_cmd
)paren
(brace
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;qtcb
op_ne
l_int|NULL
)paren
)paren
(brace
id|fsf_req-&gt;qtcb-&gt;prefix.req_id
op_assign
(paren
r_int
r_int
)paren
id|fsf_req
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;prefix.ulp_info
op_assign
id|ZFCP_ULP_INFO_VERSION
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;prefix.qtcb_type
op_assign
id|fsf_qtcb_type
(braket
id|fsf_cmd
)braket
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;prefix.qtcb_version
op_assign
id|ZFCP_QTCB_VERSION
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.req_handle
op_assign
(paren
r_int
r_int
)paren
id|fsf_req
suffix:semicolon
id|fsf_req-&gt;qtcb-&gt;header.fsf_command
op_assign
id|fsf_cmd
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * zfcp_fsf_req_sbal_get - try to get one SBAL in the request queue&n; * @adapter: adapter for which request queue is examined&n; * @req_flags: flags indicating whether to wait for needed SBAL or not&n; * @lock_flags: lock_flags if queue_lock is taken&n; * Return: 0 on success, otherwise -EIO, or -ERESTARTSYS&n; * Locks: lock adapter-&gt;request_queue-&gt;queue_lock on success&n; */
r_static
r_int
DECL|function|zfcp_fsf_req_sbal_get
id|zfcp_fsf_req_sbal_get
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
r_int
id|req_flags
comma
r_int
r_int
op_star
id|lock_flags
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|req_queue
op_assign
op_amp
id|adapter-&gt;request_queue
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|req_flags
op_amp
id|ZFCP_WAIT_FOR_SBAL
)paren
)paren
(brace
id|ret
op_assign
id|wait_event_interruptible_timeout
c_func
(paren
id|adapter-&gt;request_wq
comma
id|zfcp_fsf_req_sbal_check
c_func
(paren
id|lock_flags
comma
id|req_queue
comma
l_int|1
)paren
comma
id|ZFCP_SBAL_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|zfcp_fsf_req_sbal_check
c_func
(paren
id|lock_flags
comma
id|req_queue
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_create&n; *&n; * purpose:&t;create an FSF request at the specified adapter and&n; *&t;&t;setup common fields&n; *&n; * returns:&t;-ENOMEM if there was insufficient memory for a request&n; *              -EIO if no qdio buffers could be allocate to the request&n; *              -EINVAL/-EPERM on bug conditions in req_dequeue&n; *              0 in success&n; *&n; * note:        The created request is returned by reference.&n; *&n; * locks:&t;lock of concerned request queue must not be held,&n; *&t;&t;but is held on completion (write, irqsave)&n; */
r_int
DECL|function|zfcp_fsf_req_create
id|zfcp_fsf_req_create
c_func
(paren
r_struct
id|zfcp_adapter
op_star
id|adapter
comma
id|u32
id|fsf_cmd
comma
r_int
id|req_flags
comma
id|mempool_t
op_star
id|pool
comma
r_int
r_int
op_star
id|lock_flags
comma
r_struct
id|zfcp_fsf_req
op_star
op_star
id|fsf_req_p
)paren
(brace
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|req_queue
op_assign
op_amp
id|adapter-&gt;request_queue
suffix:semicolon
multiline_comment|/* allocate new FSF request */
id|fsf_req
op_assign
id|zfcp_fsf_req_alloc
c_func
(paren
id|pool
comma
id|req_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
l_int|NULL
op_eq
id|fsf_req
)paren
)paren
(brace
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;error: Could not put an FSF request into&quot;
l_string|&quot;the outbound (send) queue.&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|failed_fsf_req
suffix:semicolon
)brace
id|zfcp_fsf_req_qtcb_init
c_func
(paren
id|fsf_req
comma
id|fsf_cmd
)paren
suffix:semicolon
multiline_comment|/* initialize waitqueue which may be used to wait on &n;&t;   this request completion */
id|init_waitqueue_head
c_func
(paren
op_amp
id|fsf_req-&gt;completion_wq
)paren
suffix:semicolon
id|ret
op_assign
id|zfcp_fsf_req_sbal_get
c_func
(paren
id|adapter
comma
id|req_flags
comma
id|lock_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_goto
id|failed_sbals
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We hold queue_lock here. Check if QDIOUP is set and let request fail&n;&t; * if it is not set (see also *_open_qdio and *_close_qdio).&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_test_mask
c_func
(paren
id|ZFCP_STATUS_ADAPTER_QDIOUP
comma
op_amp
id|adapter-&gt;status
)paren
)paren
(brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|req_queue-&gt;queue_lock
comma
op_star
id|lock_flags
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|failed_sbals
suffix:semicolon
)brace
id|fsf_req-&gt;adapter
op_assign
id|adapter
suffix:semicolon
multiline_comment|/* pointer to &quot;parent&quot; adapter */
id|fsf_req-&gt;fsf_command
op_assign
id|fsf_cmd
suffix:semicolon
id|fsf_req-&gt;sbal_number
op_assign
l_int|1
suffix:semicolon
id|fsf_req-&gt;sbal_first
op_assign
id|req_queue-&gt;free_index
suffix:semicolon
id|fsf_req-&gt;sbal_curr
op_assign
id|req_queue-&gt;free_index
suffix:semicolon
id|fsf_req-&gt;sbale_curr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|req_flags
op_amp
id|ZFCP_REQ_AUTO_CLEANUP
)paren
)paren
(brace
id|fsf_req-&gt;status
op_or_assign
id|ZFCP_STATUS_FSFREQ_CLEANUP
suffix:semicolon
)brace
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_curr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* setup common SBALE fields */
id|sbale
(braket
l_int|0
)braket
dot
id|addr
op_assign
id|fsf_req
suffix:semicolon
id|sbale
(braket
l_int|0
)braket
dot
id|flags
op_or_assign
id|SBAL_FLAGS0_COMMAND
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;qtcb
op_ne
l_int|NULL
)paren
)paren
(brace
id|sbale
(braket
l_int|1
)braket
dot
id|addr
op_assign
(paren
r_void
op_star
)paren
id|fsf_req-&gt;qtcb
suffix:semicolon
id|sbale
(braket
l_int|1
)braket
dot
id|length
op_assign
r_sizeof
(paren
r_struct
id|fsf_qtcb
)paren
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;got %i free BUFFERs starting at index %i&bslash;n&quot;
comma
id|fsf_req-&gt;sbal_number
comma
id|fsf_req-&gt;sbal_first
)paren
suffix:semicolon
r_goto
id|success
suffix:semicolon
id|failed_sbals
suffix:colon
multiline_comment|/* dequeue new FSF request previously enqueued */
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
id|fsf_req
op_assign
l_int|NULL
suffix:semicolon
id|failed_fsf_req
suffix:colon
id|write_lock_irqsave
c_func
(paren
op_amp
id|req_queue-&gt;queue_lock
comma
op_star
id|lock_flags
)paren
suffix:semicolon
id|success
suffix:colon
op_star
id|fsf_req_p
op_assign
id|fsf_req
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_send&n; *&n; * purpose:&t;start transfer of FSF request via QDIO&n; *&n; * returns:&t;0 - request transfer succesfully started&n; *&t;&t;!0 - start of request transfer failed&n; */
r_static
r_int
DECL|function|zfcp_fsf_req_send
id|zfcp_fsf_req_send
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
comma
r_struct
id|timer_list
op_star
id|timer
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
suffix:semicolon
r_struct
id|zfcp_qdio_queue
op_star
id|req_queue
suffix:semicolon
r_volatile
r_struct
id|qdio_buffer_element
op_star
id|sbale
suffix:semicolon
r_int
id|new_distance_from_int
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|inc_seq_no
op_assign
l_int|1
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
id|req_queue
op_assign
op_amp
id|adapter-&gt;request_queue
comma
multiline_comment|/* FIXME(debug): remove it later */
id|sbale
op_assign
id|zfcp_qdio_sbale_req
c_func
(paren
id|fsf_req
comma
id|fsf_req-&gt;sbal_first
comma
l_int|0
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;SBALE0 flags=0x%x&bslash;n&quot;
comma
id|sbale
(braket
l_int|0
)braket
dot
id|flags
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;HEX DUMP OF SBALE1 PAYLOAD:&bslash;n&quot;
)paren
suffix:semicolon
id|ZFCP_HEX_DUMP
c_func
(paren
id|ZFCP_LOG_LEVEL_TRACE
comma
(paren
r_char
op_star
)paren
id|sbale
(braket
l_int|1
)braket
dot
id|addr
comma
id|sbale
(braket
l_int|1
)braket
dot
id|length
)paren
suffix:semicolon
multiline_comment|/* set sequence counter in QTCB */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|fsf_req-&gt;qtcb
)paren
)paren
(brace
id|fsf_req-&gt;qtcb-&gt;prefix.req_seq_no
op_assign
id|adapter-&gt;fsf_req_seq_no
suffix:semicolon
id|fsf_req-&gt;seq_no
op_assign
id|adapter-&gt;fsf_req_seq_no
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;FSF request %p of adapter %s gets &quot;
l_string|&quot;FSF sequence counter value of %i&bslash;n&quot;
comma
id|fsf_req
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|fsf_req-&gt;qtcb-&gt;prefix.req_seq_no
)paren
suffix:semicolon
)brace
r_else
id|inc_seq_no
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* put allocated FSF request at list tail */
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|fsf_req-&gt;list
comma
op_amp
id|adapter-&gt;fsf_req_list_head
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* figure out expiration time of timeout and start timeout */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|timer
)paren
)paren
(brace
id|timer-&gt;expires
op_add_assign
id|jiffies
suffix:semicolon
id|add_timer
c_func
(paren
id|timer
)paren
suffix:semicolon
)brace
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;request queue of adapter %s: &quot;
l_string|&quot;next free SBAL is %i, %i free SBALs&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|req_queue-&gt;free_index
comma
id|atomic_read
c_func
(paren
op_amp
id|req_queue-&gt;free_count
)paren
)paren
suffix:semicolon
id|ZFCP_LOG_DEBUG
c_func
(paren
l_string|&quot;calling do_QDIO adapter %s, flags=0x%x, queue_no=%i, &quot;
l_string|&quot;index_in_queue=%i, count=%i, buffers=%p&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|QDIO_FLAG_SYNC_OUTPUT
comma
l_int|0
comma
id|fsf_req-&gt;sbal_first
comma
id|fsf_req-&gt;sbal_number
comma
op_amp
id|req_queue-&gt;buffer
(braket
id|fsf_req-&gt;sbal_first
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * adjust the number of free SBALs in request queue as well as&n;&t; * position of first one&n;&t; */
id|atomic_sub
c_func
(paren
id|fsf_req-&gt;sbal_number
comma
op_amp
id|req_queue-&gt;free_count
)paren
suffix:semicolon
id|ZFCP_LOG_TRACE
c_func
(paren
l_string|&quot;free_count=%d&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|req_queue-&gt;free_count
)paren
)paren
suffix:semicolon
id|req_queue-&gt;free_index
op_add_assign
id|fsf_req-&gt;sbal_number
suffix:semicolon
multiline_comment|/* increase */
id|req_queue-&gt;free_index
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
multiline_comment|/* wrap if needed */
id|new_distance_from_int
op_assign
id|zfcp_qdio_determine_pci
c_func
(paren
id|req_queue
comma
id|fsf_req
)paren
suffix:semicolon
id|retval
op_assign
id|do_QDIO
c_func
(paren
id|adapter-&gt;ccw_device
comma
id|QDIO_FLAG_SYNC_OUTPUT
comma
l_int|0
comma
id|fsf_req-&gt;sbal_first
comma
id|fsf_req-&gt;sbal_number
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|retval
)paren
)paren
(brace
multiline_comment|/* Queues are down..... */
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/*&n;&t;&t; * FIXME(potential race):&n;&t;&t; * timer might be expired (absolutely unlikely)&n;&t;&t; */
r_if
c_cond
(paren
id|timer
)paren
id|del_timer_sync
c_func
(paren
id|timer
)paren
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|fsf_req-&gt;list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * adjust the number of free SBALs in request queue as well as&n;&t;&t; * position of first one&n;&t;&t; */
id|zfcp_qdio_zero_sbals
c_func
(paren
id|req_queue-&gt;buffer
comma
id|fsf_req-&gt;sbal_first
comma
id|fsf_req-&gt;sbal_number
)paren
suffix:semicolon
id|atomic_add
c_func
(paren
id|fsf_req-&gt;sbal_number
comma
op_amp
id|req_queue-&gt;free_count
)paren
suffix:semicolon
id|req_queue-&gt;free_index
op_sub_assign
id|fsf_req-&gt;sbal_number
suffix:semicolon
multiline_comment|/* increase */
id|req_queue-&gt;free_index
op_add_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
id|req_queue-&gt;free_index
op_mod_assign
id|QDIO_MAX_BUFFERS_PER_Q
suffix:semicolon
multiline_comment|/* wrap */
id|ZFCP_LOG_DEBUG
(paren
l_string|&quot;error: do_QDIO failed. Buffers could not be enqueued &quot;
l_string|&quot;to request queue.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|req_queue-&gt;distance_from_int
op_assign
id|new_distance_from_int
suffix:semicolon
multiline_comment|/*&n;&t;&t; * increase FSF sequence counter -&n;&t;&t; * this must only be done for request successfully enqueued to&n;&t;&t; * QDIO this rejected requests may be cleaned up by calling&n;&t;&t; * routines  resulting in missing sequence counter values&n;&t;&t; * otherwise,&n;&t;&t; */
multiline_comment|/* Don&squot;t increase for unsolicited status */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|inc_seq_no
)paren
)paren
(brace
id|adapter-&gt;fsf_req_seq_no
op_increment
suffix:semicolon
id|ZFCP_LOG_TRACE
(paren
l_string|&quot;FSF sequence counter value of adapter %s &quot;
l_string|&quot;increased to %i&bslash;n&quot;
comma
id|zfcp_get_busid_by_adapter
c_func
(paren
id|adapter
)paren
comma
id|adapter-&gt;fsf_req_seq_no
)paren
suffix:semicolon
)brace
multiline_comment|/* count FSF requests pending */
id|atomic_inc
c_func
(paren
op_amp
id|adapter-&gt;fsf_reqs_active
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * function:    zfcp_fsf_req_cleanup&n; *&n; * purpose:&t;cleans up an FSF request and removes it from the specified list&n; *&n; * returns:&n; *&n; * assumption:&t;no pending SB in SBALEs other than QTCB&n; */
r_void
DECL|function|zfcp_fsf_req_cleanup
id|zfcp_fsf_req_cleanup
c_func
(paren
r_struct
id|zfcp_fsf_req
op_star
id|fsf_req
)paren
(brace
r_struct
id|zfcp_adapter
op_star
id|adapter
op_assign
id|fsf_req-&gt;adapter
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|fsf_req-&gt;list
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|adapter-&gt;fsf_req_list_lock
comma
id|flags
)paren
suffix:semicolon
id|zfcp_fsf_req_free
c_func
(paren
id|fsf_req
)paren
suffix:semicolon
)brace
DECL|macro|ZFCP_LOG_AREA
macro_line|#undef ZFCP_LOG_AREA
DECL|variable|zfcp_fsf_exchange_port_data
id|EXPORT_SYMBOL
c_func
(paren
id|zfcp_fsf_exchange_port_data
)paren
suffix:semicolon
DECL|variable|zfcp_fsf_send_ct
id|EXPORT_SYMBOL
c_func
(paren
id|zfcp_fsf_send_ct
)paren
suffix:semicolon
DECL|variable|zfcp_fsf_send_els
id|EXPORT_SYMBOL
c_func
(paren
id|zfcp_fsf_send_els
)paren
suffix:semicolon
eof
