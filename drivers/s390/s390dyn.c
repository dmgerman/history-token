multiline_comment|/*&n; *  arch/s390/kernel/s390dyn.c&n; *   S/390 dynamic device attachment&n; *&n; *  S390 version&n; *    Copyright (C) 2000 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Ingo Adlung (adlung@de.ibm.com)&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/s390io.h&gt;
macro_line|#include &lt;asm/s390dyn.h&gt;
DECL|variable|devreg_anchor
r_static
id|devreg_t
op_star
id|devreg_anchor
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|dyn_lock
r_static
id|spinlock_t
id|dyn_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|s390_device_register
r_int
id|s390_device_register
c_func
(paren
id|devreg_t
op_star
id|drinfo
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|pdevflag
comma
id|drflag
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|devreg_t
op_star
id|pdevreg
op_assign
id|devreg_anchor
suffix:semicolon
r_if
c_cond
(paren
id|drinfo
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|drflag
op_assign
id|drinfo-&gt;flag
suffix:semicolon
r_if
c_cond
(paren
(paren
id|drflag
op_amp
id|DEVREG_TYPE_DEVNO
)paren
op_eq
(paren
id|drflag
op_amp
id|DEVREG_TYPE_DEVCHARS
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdevreg
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ret
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdevreg
op_eq
id|drinfo
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
id|pdevflag
op_assign
id|pdevreg-&gt;flag
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * we don&squot;t allow multiple drivers to register &n;&t;&t;&t; *  for the same device number &n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|pdevflag
op_amp
id|DEVREG_TYPE_DEVNO
)paren
op_logical_and
(paren
id|pdevreg-&gt;ci.devno
)paren
)paren
op_logical_and
(paren
(paren
id|drflag
op_amp
id|DEVREG_TYPE_DEVNO
)paren
op_logical_and
(paren
id|drinfo-&gt;ci.devno
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|drflag
op_eq
(paren
id|DEVREG_TYPE_DEVCHARS
op_or
id|DEVREG_EXACT_MATCH
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|drinfo-&gt;ci.hc
comma
op_amp
id|pdevreg-&gt;ci.hc
comma
r_sizeof
(paren
id|devreg_hc_t
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* endif */
)brace
multiline_comment|/* endif */
id|pdevreg
op_assign
id|pdevreg-&gt;next
suffix:semicolon
)brace
multiline_comment|/* endwhile */
multiline_comment|/*&n;&t; * only enqueue if no collision was found ...&t;&n;&t; */
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|drinfo-&gt;next
op_assign
id|devreg_anchor
suffix:semicolon
id|drinfo-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|devreg_anchor
op_ne
l_int|NULL
)paren
(brace
id|devreg_anchor-&gt;prev
op_assign
id|drinfo
suffix:semicolon
)brace
multiline_comment|/* endif */
id|devreg_anchor
op_assign
id|drinfo
suffix:semicolon
)brace
multiline_comment|/* endif */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|s390_device_unregister
r_int
id|s390_device_unregister
c_func
(paren
id|devreg_t
op_star
id|dreg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|devreg_t
op_star
id|pdevreg
op_assign
id|devreg_anchor
suffix:semicolon
r_if
c_cond
(paren
id|dreg
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pdevreg
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|ret
op_ne
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdevreg
op_eq
id|dreg
)paren
(brace
id|devreg_t
op_star
id|dprev
op_assign
id|pdevreg-&gt;prev
suffix:semicolon
id|devreg_t
op_star
id|dnext
op_assign
id|pdevreg-&gt;next
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dprev
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|dnext
op_ne
l_int|NULL
)paren
)paren
(brace
id|dnext-&gt;prev
op_assign
id|dprev
suffix:semicolon
id|dprev-&gt;next
op_assign
id|dnext
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dprev
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|dnext
op_eq
l_int|NULL
)paren
)paren
(brace
id|dprev-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|dprev
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|dnext
op_ne
l_int|NULL
)paren
)paren
(brace
id|dnext-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* else */
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|pdevreg
op_assign
id|pdevreg-&gt;next
suffix:semicolon
)brace
multiline_comment|/* endif */
)brace
multiline_comment|/* endwhile */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|s390_search_devreg
id|devreg_t
op_star
id|s390_search_devreg
c_func
(paren
id|ioinfo_t
op_star
id|ioinfo
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|devreg_hc_t
id|match
suffix:semicolon
id|devreg_t
op_star
id|pdevreg
op_assign
id|devreg_anchor
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pdevreg
op_ne
l_int|NULL
)paren
(brace
r_int
id|flag
op_assign
id|pdevreg-&gt;flag
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flag
op_amp
id|DEVREG_TYPE_DEVNO
)paren
op_logical_and
(paren
id|ioinfo-&gt;ui.flags.dval
op_eq
l_int|1
)paren
op_logical_and
(paren
id|ioinfo-&gt;devno
op_eq
id|pdevreg-&gt;ci.devno
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_amp
id|DEVREG_TYPE_DEVCHARS
)paren
(brace
r_if
c_cond
(paren
id|flag
op_amp
id|DEVREG_EXACT_MATCH
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|pdevreg-&gt;ci.hc
comma
op_amp
id|ioinfo-&gt;senseid.cu_type
comma
r_sizeof
(paren
id|devreg_hc_t
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
op_amp
id|match
comma
op_amp
id|ioinfo-&gt;senseid.cu_type
comma
r_sizeof
(paren
id|match
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|DEVREG_NO_CU_INFO
)paren
(brace
id|match.ctype
op_assign
id|pdevreg-&gt;ci.hc.ctype
suffix:semicolon
id|match.cmode
op_assign
id|pdevreg-&gt;ci.hc.cmode
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
op_amp
id|DEVREG_NO_DEV_INFO
)paren
(brace
id|match.dtype
op_assign
id|pdevreg-&gt;ci.hc.dtype
suffix:semicolon
id|match.dmode
op_assign
id|pdevreg-&gt;ci.hc.dmode
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
op_amp
id|DEVREG_MATCH_CU_TYPE
)paren
id|match.cmode
op_assign
id|pdevreg-&gt;ci.hc.cmode
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|DEVREG_MATCH_DEV_TYPE
)paren
(brace
id|match.dmode
op_assign
id|pdevreg-&gt;ci.hc.dmode
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|pdevreg-&gt;ci.hc
comma
op_amp
id|match
comma
r_sizeof
(paren
id|match
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* endif */
)brace
multiline_comment|/* endif */
id|pdevreg
op_assign
id|pdevreg-&gt;next
suffix:semicolon
)brace
multiline_comment|/* endwhile */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|pdevreg
suffix:semicolon
)brace
eof
