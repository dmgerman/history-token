multiline_comment|/*&n; *  arch/s390/kernel/s390dyn.c&n; *   S/390 dynamic device attachment&n; *&n; *  S390 version&n; *    Copyright (C) 2000 IBM Deutschland Entwicklung GmbH, IBM Corporation&n; *    Author(s): Ingo Adlung (adlung@de.ibm.com)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/s390io.h&gt;
macro_line|#include &lt;asm/s390dyn.h&gt;
DECL|variable|devreg_anchor
r_static
r_struct
id|list_head
id|devreg_anchor
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|devreg_anchor
)paren
suffix:semicolon
DECL|variable|dyn_lock
r_static
id|spinlock_t
id|dyn_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|s390_device_register_internal
r_static
r_inline
r_int
id|s390_device_register_internal
c_func
(paren
id|devreg_t
op_star
id|drinfo
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|devreg_anchor
)paren
(brace
id|devreg_t
op_star
id|pdevreg
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|devreg_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdevreg
op_eq
id|drinfo
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;                 * We don&squot;t allow multiple drivers to register&n;                 * for the same device number&n;                 */
r_if
c_cond
(paren
id|pdevreg-&gt;ci.devno
op_eq
id|drinfo-&gt;ci.devno
op_logical_and
(paren
id|pdevreg-&gt;flag
op_amp
id|DEVREG_TYPE_DEVNO
)paren
op_logical_and
(paren
id|drinfo-&gt;flag
op_amp
id|DEVREG_TYPE_DEVNO
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|drinfo-&gt;flag
op_eq
(paren
id|DEVREG_TYPE_DEVCHARS
op_or
id|DEVREG_EXACT_MATCH
)paren
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|drinfo-&gt;ci.hc
comma
op_amp
id|pdevreg-&gt;ci.hc
comma
r_sizeof
(paren
id|devreg_hc_t
)paren
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;         * no collision found, enqueue&n;         */
id|list_add
(paren
op_amp
id|drinfo-&gt;list
comma
op_amp
id|devreg_anchor
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s390_device_register
r_int
id|s390_device_register
c_func
(paren
id|devreg_t
op_star
id|drinfo
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|drinfo
op_eq
l_int|NULL
op_logical_or
op_logical_neg
(paren
id|drinfo-&gt;flag
op_amp
(paren
id|DEVREG_TYPE_DEVNO
op_or
id|DEVREG_TYPE_DEVCHARS
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|s390_device_register_internal
c_func
(paren
id|drinfo
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|s390_device_unregister_internal
r_static
r_inline
r_int
id|s390_device_unregister_internal
c_func
(paren
id|devreg_t
op_star
id|dreg
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|devreg_anchor
)paren
(brace
id|devreg_t
op_star
id|pdevreg
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|devreg_t
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdevreg
op_eq
id|dreg
)paren
(brace
id|list_del
(paren
op_amp
id|dreg-&gt;list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|s390_device_unregister
r_int
id|s390_device_unregister
c_func
(paren
id|devreg_t
op_star
id|dreg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|dreg
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|s390_device_unregister_internal
c_func
(paren
id|dreg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|s390_search_devreg_internal
r_static
r_inline
id|devreg_t
op_star
id|s390_search_devreg_internal
c_func
(paren
id|ioinfo_t
op_star
id|ioinfo
)paren
(brace
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|devreg_anchor
)paren
(brace
id|devreg_t
op_star
id|pdevreg
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|devreg_t
comma
id|list
)paren
suffix:semicolon
id|senseid_t
op_star
id|sid
suffix:semicolon
r_int
id|flag
suffix:semicolon
id|flag
op_assign
id|pdevreg-&gt;flag
suffix:semicolon
id|sid
op_assign
op_amp
id|ioinfo-&gt;senseid
suffix:semicolon
r_if
c_cond
(paren
id|flag
op_amp
id|DEVREG_TYPE_DEVNO
)paren
(brace
r_if
c_cond
(paren
id|ioinfo-&gt;ui.flags.dval
op_ne
l_int|1
op_logical_or
id|ioinfo-&gt;devno
op_ne
id|pdevreg-&gt;ci.devno
)paren
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|flag
op_amp
id|DEVREG_TYPE_DEVCHARS
)paren
op_logical_and
(paren
id|flag
op_amp
id|DEVREG_EXACT_MATCH
)paren
)paren
(brace
r_if
c_cond
(paren
id|pdevreg-&gt;ci.hc.ctype
op_ne
id|sid-&gt;cu_type
op_logical_or
id|pdevreg-&gt;ci.hc.cmode
op_ne
id|sid-&gt;cu_model
op_logical_or
id|pdevreg-&gt;ci.hc.dtype
op_ne
id|sid-&gt;dev_type
op_logical_or
id|pdevreg-&gt;ci.hc.dmode
op_ne
id|sid-&gt;dev_model
)paren
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flag
op_amp
id|DEVREG_TYPE_DEVCHARS
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|flag
op_amp
id|DEVREG_NO_CU_INFO
)paren
op_logical_and
id|pdevreg-&gt;ci.hc.ctype
op_ne
id|sid-&gt;cu_type
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flag
op_amp
id|DEVREG_NO_CU_INFO
)paren
op_logical_and
op_logical_neg
(paren
id|flag
op_amp
id|DEVREG_MATCH_CU_TYPE
)paren
op_logical_and
id|pdevreg-&gt;ci.hc.cmode
op_ne
id|sid-&gt;cu_model
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flag
op_amp
id|DEVREG_NO_DEV_INFO
)paren
op_logical_and
id|pdevreg-&gt;ci.hc.dtype
op_ne
id|sid-&gt;dev_type
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flag
op_amp
id|DEVREG_NO_DEV_INFO
)paren
op_logical_and
op_logical_neg
(paren
id|flag
op_amp
id|DEVREG_MATCH_DEV_TYPE
)paren
op_logical_and
id|pdevreg-&gt;ci.hc.dmode
op_ne
id|sid-&gt;dev_model
)paren
r_continue
suffix:semicolon
)brace
r_return
id|pdevreg
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|s390_search_devreg
id|devreg_t
op_star
id|s390_search_devreg
c_func
(paren
id|ioinfo_t
op_star
id|ioinfo
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|devreg_t
op_star
id|pdevreg
suffix:semicolon
r_if
c_cond
(paren
id|ioinfo
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
id|pdevreg
op_assign
id|s390_search_devreg_internal
c_func
(paren
id|ioinfo
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dyn_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|pdevreg
suffix:semicolon
)brace
DECL|variable|s390_device_register
id|EXPORT_SYMBOL
c_func
(paren
id|s390_device_register
)paren
suffix:semicolon
DECL|variable|s390_device_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|s390_device_unregister
)paren
suffix:semicolon
eof
