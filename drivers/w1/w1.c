multiline_comment|/*&n; * &t;w1.c&n; *&n; * Copyright (c) 2004 Evgeniy Polyakov &lt;johnpol@2ka.mipt.ru&gt;&n; * &n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; */
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &quot;w1.h&quot;
macro_line|#include &quot;w1_io.h&quot;
macro_line|#include &quot;w1_log.h&quot;
macro_line|#include &quot;w1_int.h&quot;
macro_line|#include &quot;w1_family.h&quot;
macro_line|#include &quot;w1_netlink.h&quot;
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Evgeniy Polyakov &lt;johnpol@2ka.mipt.ru&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for 1-wire Dallas network protocol.&quot;
)paren
suffix:semicolon
DECL|variable|w1_timeout
r_static
r_int
id|w1_timeout
op_assign
l_int|10
suffix:semicolon
DECL|variable|w1_max_slave_count
r_int
id|w1_max_slave_count
op_assign
l_int|10
suffix:semicolon
DECL|variable|w1_max_slave_ttl
r_int
id|w1_max_slave_ttl
op_assign
l_int|10
suffix:semicolon
id|module_param_named
c_func
(paren
id|timeout
comma
id|w1_timeout
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|max_slave_count
comma
id|w1_max_slave_count
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param_named
c_func
(paren
id|slave_ttl
comma
id|w1_max_slave_ttl
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
DECL|variable|w1_mlock
id|spinlock_t
id|w1_mlock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|w1_masters
id|LIST_HEAD
c_func
(paren
id|w1_masters
)paren
suffix:semicolon
DECL|variable|control_thread
r_static
id|pid_t
id|control_thread
suffix:semicolon
DECL|variable|control_needs_exit
r_static
r_int
id|control_needs_exit
suffix:semicolon
r_static
id|DECLARE_COMPLETION
c_func
(paren
id|w1_control_complete
)paren
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|w1_control_wait
)paren
suffix:semicolon
DECL|function|w1_master_match
r_static
r_int
id|w1_master_match
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|device_driver
op_star
id|drv
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|w1_master_probe
r_static
r_int
id|w1_master_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|w1_master_remove
r_static
r_int
id|w1_master_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|w1_master_release
r_static
r_void
id|w1_master_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|w1_master
op_star
id|md
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|w1_master
comma
id|dev
)paren
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|md-&gt;dev_released
)paren
suffix:semicolon
)brace
DECL|function|w1_slave_release
r_static
r_void
id|w1_slave_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|w1_slave
op_star
id|sl
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|w1_slave
comma
id|dev
)paren
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|sl-&gt;dev_released
)paren
suffix:semicolon
)brace
DECL|function|w1_default_read_name
r_static
id|ssize_t
id|w1_default_read_name
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;No family registered.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|w1_default_read_bin
r_static
id|ssize_t
id|w1_default_read_bin
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_char
op_star
id|buf
comma
id|loff_t
id|off
comma
r_int
id|count
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;No family registered.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|w1_bus_type
r_struct
id|bus_type
id|w1_bus_type
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1&quot;
comma
dot
id|match
op_assign
id|w1_master_match
comma
)brace
suffix:semicolon
DECL|variable|w1_driver
r_struct
id|device_driver
id|w1_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_driver&quot;
comma
dot
id|bus
op_assign
op_amp
id|w1_bus_type
comma
dot
id|probe
op_assign
id|w1_master_probe
comma
dot
id|remove
op_assign
id|w1_master_remove
comma
)brace
suffix:semicolon
DECL|variable|w1_device
r_struct
id|device
id|w1_device
op_assign
(brace
dot
id|parent
op_assign
l_int|NULL
comma
dot
id|bus
op_assign
op_amp
id|w1_bus_type
comma
dot
id|bus_id
op_assign
l_string|&quot;w1 bus master&quot;
comma
dot
id|driver
op_assign
op_amp
id|w1_driver
comma
dot
id|release
op_assign
op_amp
id|w1_master_release
)brace
suffix:semicolon
DECL|variable|w1_slave_attribute
r_static
r_struct
id|device_attribute
id|w1_slave_attribute
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;name&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_default_read_name
comma
)brace
suffix:semicolon
DECL|variable|w1_slave_attribute_val
r_static
r_struct
id|device_attribute
id|w1_slave_attribute_val
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;value&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_default_read_name
comma
)brace
suffix:semicolon
DECL|function|w1_master_attribute_show_name
id|ssize_t
id|w1_master_attribute_show_name
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|w1_master
op_star
id|md
op_assign
id|container_of
(paren
id|dev
comma
r_struct
id|w1_master
comma
id|dev
)paren
suffix:semicolon
id|ssize_t
id|count
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
(paren
op_amp
id|md-&gt;mutex
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|count
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|md-&gt;name
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|w1_master_attribute_show_pointer
id|ssize_t
id|w1_master_attribute_show_pointer
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|w1_master
op_star
id|md
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|w1_master
comma
id|dev
)paren
suffix:semicolon
id|ssize_t
id|count
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|count
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;0x%p&bslash;n&quot;
comma
id|md-&gt;bus_master
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|w1_master_attribute_show_timeout
id|ssize_t
id|w1_master_attribute_show_timeout
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
id|ssize_t
id|count
suffix:semicolon
id|count
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|w1_timeout
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|w1_master_attribute_show_max_slave_count
id|ssize_t
id|w1_master_attribute_show_max_slave_count
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|w1_master
op_star
id|md
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|w1_master
comma
id|dev
)paren
suffix:semicolon
id|ssize_t
id|count
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|count
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|md-&gt;max_slave_count
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|w1_master_attribute_show_attempts
id|ssize_t
id|w1_master_attribute_show_attempts
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|w1_master
op_star
id|md
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|w1_master
comma
id|dev
)paren
suffix:semicolon
id|ssize_t
id|count
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|count
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%lu&bslash;n&quot;
comma
id|md-&gt;attempts
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|w1_master_attribute_show_slave_count
id|ssize_t
id|w1_master_attribute_show_slave_count
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|w1_master
op_star
id|md
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|w1_master
comma
id|dev
)paren
suffix:semicolon
id|ssize_t
id|count
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|count
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|md-&gt;slave_count
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|w1_master_attribute_show_slaves
id|ssize_t
id|w1_master_attribute_show_slaves
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|w1_master
op_star
id|md
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|w1_master
comma
id|dev
)paren
suffix:semicolon
r_int
id|c
op_assign
id|PAGE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;slave_count
op_eq
l_int|0
)paren
id|c
op_sub_assign
id|snprintf
c_func
(paren
id|buf
op_plus
id|PAGE_SIZE
op_minus
id|c
comma
id|c
comma
l_string|&quot;not found.&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_struct
id|list_head
op_star
id|ent
comma
op_star
id|n
suffix:semicolon
r_struct
id|w1_slave
op_star
id|sl
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|ent
comma
id|n
comma
op_amp
id|md-&gt;slist
)paren
(brace
id|sl
op_assign
id|list_entry
c_func
(paren
id|ent
comma
r_struct
id|w1_slave
comma
id|w1_slave_entry
)paren
suffix:semicolon
id|c
op_sub_assign
id|snprintf
c_func
(paren
id|buf
op_plus
id|PAGE_SIZE
op_minus
id|c
comma
id|c
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|sl-&gt;name
)paren
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|md-&gt;mutex
)paren
suffix:semicolon
r_return
id|PAGE_SIZE
op_minus
id|c
suffix:semicolon
)brace
DECL|variable|w1_master_attribute_slaves
r_static
r_struct
id|device_attribute
id|w1_master_attribute_slaves
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_master_slaves&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_master_attribute_show_slaves
comma
)brace
suffix:semicolon
DECL|variable|w1_master_attribute_slave_count
r_static
r_struct
id|device_attribute
id|w1_master_attribute_slave_count
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_master_slave_count&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_master_attribute_show_slave_count
comma
)brace
suffix:semicolon
DECL|variable|w1_master_attribute_attempts
r_static
r_struct
id|device_attribute
id|w1_master_attribute_attempts
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_master_attempts&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_master_attribute_show_attempts
comma
)brace
suffix:semicolon
DECL|variable|w1_master_attribute_max_slave_count
r_static
r_struct
id|device_attribute
id|w1_master_attribute_max_slave_count
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_master_max_slave_count&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_master_attribute_show_max_slave_count
comma
)brace
suffix:semicolon
DECL|variable|w1_master_attribute_timeout
r_static
r_struct
id|device_attribute
id|w1_master_attribute_timeout
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_master_timeout&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_master_attribute_show_timeout
comma
)brace
suffix:semicolon
DECL|variable|w1_master_attribute_pointer
r_static
r_struct
id|device_attribute
id|w1_master_attribute_pointer
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_master_pointer&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_master_attribute_show_pointer
comma
)brace
suffix:semicolon
DECL|variable|w1_master_attribute_name
r_static
r_struct
id|device_attribute
id|w1_master_attribute_name
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_master_name&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
op_amp
id|w1_master_attribute_show_name
comma
)brace
suffix:semicolon
DECL|variable|w1_slave_bin_attribute
r_static
r_struct
id|bin_attribute
id|w1_slave_bin_attribute
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;w1_slave&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
comma
dot
id|size
op_assign
id|W1_SLAVE_DATA_SIZE
comma
dot
id|read
op_assign
op_amp
id|w1_default_read_bin
comma
)brace
suffix:semicolon
DECL|function|__w1_attach_slave_device
r_static
r_int
id|__w1_attach_slave_device
c_func
(paren
r_struct
id|w1_slave
op_star
id|sl
)paren
(brace
r_int
id|err
suffix:semicolon
id|sl-&gt;dev.parent
op_assign
op_amp
id|sl-&gt;master-&gt;dev
suffix:semicolon
id|sl-&gt;dev.driver
op_assign
id|sl-&gt;master-&gt;driver
suffix:semicolon
id|sl-&gt;dev.bus
op_assign
op_amp
id|w1_bus_type
suffix:semicolon
id|sl-&gt;dev.release
op_assign
op_amp
id|w1_slave_release
suffix:semicolon
id|snprintf
c_func
(paren
op_amp
id|sl-&gt;dev.bus_id
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|sl-&gt;dev.bus_id
)paren
comma
l_string|&quot;%02x-%012llx&quot;
comma
(paren
r_int
r_int
)paren
id|sl-&gt;reg_num.family
comma
(paren
r_int
r_int
r_int
)paren
id|sl-&gt;reg_num.id
)paren
suffix:semicolon
id|snprintf
(paren
op_amp
id|sl-&gt;name
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|sl-&gt;name
)paren
comma
l_string|&quot;%02x-%012llx&quot;
comma
(paren
r_int
r_int
)paren
id|sl-&gt;reg_num.family
comma
(paren
r_int
r_int
r_int
)paren
id|sl-&gt;reg_num.id
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|sl-&gt;dev
comma
l_string|&quot;%s: registering %s.&bslash;n&quot;
comma
id|__func__
comma
op_amp
id|sl-&gt;dev.bus_id
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|err
op_assign
id|device_register
c_func
(paren
op_amp
id|sl-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|sl-&gt;dev
comma
l_string|&quot;Device registration [%s] failed. err=%d&bslash;n&quot;
comma
id|sl-&gt;dev.bus_id
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_amp
id|sl-&gt;attr_bin
comma
op_amp
id|w1_slave_bin_attribute
comma
r_sizeof
(paren
id|sl-&gt;attr_bin
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sl-&gt;attr_name
comma
op_amp
id|w1_slave_attribute
comma
r_sizeof
(paren
id|sl-&gt;attr_name
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sl-&gt;attr_val
comma
op_amp
id|w1_slave_attribute_val
comma
r_sizeof
(paren
id|sl-&gt;attr_val
)paren
)paren
suffix:semicolon
id|sl-&gt;attr_bin.read
op_assign
id|sl-&gt;family-&gt;fops-&gt;rbin
suffix:semicolon
id|sl-&gt;attr_name.show
op_assign
id|sl-&gt;family-&gt;fops-&gt;rname
suffix:semicolon
id|sl-&gt;attr_val.show
op_assign
id|sl-&gt;family-&gt;fops-&gt;rval
suffix:semicolon
id|sl-&gt;attr_val.attr.name
op_assign
id|sl-&gt;family-&gt;fops-&gt;rvalname
suffix:semicolon
id|err
op_assign
id|device_create_file
c_func
(paren
op_amp
id|sl-&gt;dev
comma
op_amp
id|sl-&gt;attr_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|sl-&gt;dev
comma
l_string|&quot;sysfs file creation for [%s] failed. err=%d&bslash;n&quot;
comma
id|sl-&gt;dev.bus_id
comma
id|err
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|sl-&gt;dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|device_create_file
c_func
(paren
op_amp
id|sl-&gt;dev
comma
op_amp
id|sl-&gt;attr_val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|sl-&gt;dev
comma
l_string|&quot;sysfs file creation for [%s] failed. err=%d&bslash;n&quot;
comma
id|sl-&gt;dev.bus_id
comma
id|err
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|sl-&gt;dev
comma
op_amp
id|sl-&gt;attr_name
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|sl-&gt;dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|sysfs_create_bin_file
c_func
(paren
op_amp
id|sl-&gt;dev.kobj
comma
op_amp
id|sl-&gt;attr_bin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|sl-&gt;dev
comma
l_string|&quot;sysfs file creation for [%s] failed. err=%d&bslash;n&quot;
comma
id|sl-&gt;dev.bus_id
comma
id|err
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|sl-&gt;dev
comma
op_amp
id|sl-&gt;attr_name
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|sl-&gt;dev
comma
op_amp
id|sl-&gt;attr_val
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|sl-&gt;dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|list_add_tail
c_func
(paren
op_amp
id|sl-&gt;w1_slave_entry
comma
op_amp
id|sl-&gt;master-&gt;slist
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|w1_attach_slave_device
r_static
r_int
id|w1_attach_slave_device
c_func
(paren
r_struct
id|w1_master
op_star
id|dev
comma
r_struct
id|w1_reg_num
op_star
id|rn
)paren
(brace
r_struct
id|w1_slave
op_star
id|sl
suffix:semicolon
r_struct
id|w1_family
op_star
id|f
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|w1_netlink_msg
id|msg
suffix:semicolon
id|sl
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|w1_slave
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sl
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s: failed to allocate new slave device.&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sl
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sl
)paren
)paren
suffix:semicolon
id|sl-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|sl-&gt;master
op_assign
id|dev
suffix:semicolon
id|set_bit
c_func
(paren
id|W1_SLAVE_ACTIVE
comma
(paren
r_int
op_star
)paren
op_amp
id|sl-&gt;flags
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sl-&gt;reg_num
comma
id|rn
comma
r_sizeof
(paren
id|sl-&gt;reg_num
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|sl-&gt;refcnt
comma
l_int|0
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|sl-&gt;dev_released
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|w1_flock
)paren
suffix:semicolon
id|f
op_assign
id|w1_family_registered
c_func
(paren
id|rn-&gt;family
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|w1_flock
)paren
suffix:semicolon
id|dev_info
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;Family %x for %02x.%012llx.%02x is not registered.&bslash;n&quot;
comma
id|rn-&gt;family
comma
id|rn-&gt;family
comma
id|rn-&gt;id
comma
id|rn-&gt;crc
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sl
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|__w1_family_get
c_func
(paren
id|f
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|w1_flock
)paren
suffix:semicolon
id|sl-&gt;family
op_assign
id|f
suffix:semicolon
id|err
op_assign
id|__w1_attach_slave_device
c_func
(paren
id|sl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s: Attaching %s failed.&bslash;n&quot;
comma
id|__func__
comma
id|sl-&gt;name
)paren
suffix:semicolon
id|w1_family_put
c_func
(paren
id|sl-&gt;family
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sl
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|sl-&gt;ttl
op_assign
id|dev-&gt;slave_ttl
suffix:semicolon
id|dev-&gt;slave_count
op_increment
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|msg.id.id
comma
id|rn
comma
r_sizeof
(paren
id|msg.id.id
)paren
)paren
suffix:semicolon
id|msg.type
op_assign
id|W1_SLAVE_ADD
suffix:semicolon
id|w1_netlink_send
c_func
(paren
id|dev
comma
op_amp
id|msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|w1_slave_detach
r_static
r_void
id|w1_slave_detach
c_func
(paren
r_struct
id|w1_slave
op_star
id|sl
)paren
(brace
r_struct
id|w1_netlink_msg
id|msg
suffix:semicolon
id|dev_info
c_func
(paren
op_amp
id|sl-&gt;dev
comma
l_string|&quot;%s: detaching %s.&bslash;n&quot;
comma
id|__func__
comma
id|sl-&gt;name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|sl-&gt;refcnt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Waiting for %s to become free: refcnt=%d.&bslash;n&quot;
comma
id|sl-&gt;name
comma
id|atomic_read
c_func
(paren
op_amp
id|sl-&gt;refcnt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msleep_interruptible
c_func
(paren
l_int|1000
)paren
)paren
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
)brace
id|sysfs_remove_bin_file
(paren
op_amp
id|sl-&gt;dev.kobj
comma
op_amp
id|sl-&gt;attr_bin
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|sl-&gt;dev
comma
op_amp
id|sl-&gt;attr_name
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|sl-&gt;dev
comma
op_amp
id|sl-&gt;attr_val
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|sl-&gt;dev
)paren
suffix:semicolon
id|w1_family_put
c_func
(paren
id|sl-&gt;family
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|msg.id.id
comma
op_amp
id|sl-&gt;reg_num
comma
r_sizeof
(paren
id|msg.id.id
)paren
)paren
suffix:semicolon
id|msg.type
op_assign
id|W1_SLAVE_REMOVE
suffix:semicolon
id|w1_netlink_send
c_func
(paren
id|sl-&gt;master
comma
op_amp
id|msg
)paren
suffix:semicolon
)brace
DECL|function|w1_search
r_static
r_void
id|w1_search
c_func
(paren
r_struct
id|w1_master
op_star
id|dev
)paren
(brace
id|u64
id|last
comma
id|rn
comma
id|tmp
suffix:semicolon
r_int
id|i
comma
id|count
op_assign
l_int|0
comma
id|slave_count
suffix:semicolon
r_int
id|last_family_desc
comma
id|last_zero
comma
id|last_device
suffix:semicolon
r_int
id|search_bit
comma
id|id_bit
comma
id|comp_bit
comma
id|desc_bit
suffix:semicolon
r_struct
id|list_head
op_star
id|ent
suffix:semicolon
r_struct
id|w1_slave
op_star
id|sl
suffix:semicolon
r_int
id|family_found
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;attempts
op_increment
suffix:semicolon
id|search_bit
op_assign
id|id_bit
op_assign
id|comp_bit
op_assign
l_int|0
suffix:semicolon
id|rn
op_assign
id|tmp
op_assign
id|last
op_assign
l_int|0
suffix:semicolon
id|last_device
op_assign
id|last_zero
op_assign
id|last_family_desc
op_assign
l_int|0
suffix:semicolon
id|desc_bit
op_assign
l_int|64
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|id_bit
op_logical_and
id|comp_bit
)paren
op_logical_and
op_logical_neg
id|last_device
op_logical_and
id|count
op_increment
OL
id|dev-&gt;max_slave_count
)paren
(brace
id|last
op_assign
id|rn
suffix:semicolon
id|rn
op_assign
l_int|0
suffix:semicolon
id|last_family_desc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Reset bus and all 1-wire device state machines&n;&t;&t; * so they can respond to our requests.&n;&t;&t; *&n;&t;&t; * Return 0 - device(s) present, 1 - no devices present.&n;&t;&t; */
r_if
c_cond
(paren
id|w1_reset_bus
c_func
(paren
id|dev
)paren
)paren
(brace
id|dev_info
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;No devices present on the wire.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
macro_line|#if 1
id|w1_write_8
c_func
(paren
id|dev
comma
id|W1_SEARCH
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Read 2 bits from bus.&n;&t;&t;&t; * All who don&squot;t sleep must send ID bit and COMPLEMENT ID bit.&n;&t;&t;&t; * They actually are ANDed between all senders.&n;&t;&t;&t; */
id|id_bit
op_assign
id|w1_touch_bit
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|comp_bit
op_assign
id|w1_touch_bit
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id_bit
op_logical_and
id|comp_bit
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|id_bit
op_eq
l_int|0
op_logical_and
id|comp_bit
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|desc_bit
)paren
id|search_bit
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|i
OG
id|desc_bit
)paren
id|search_bit
op_assign
l_int|0
suffix:semicolon
r_else
id|search_bit
op_assign
(paren
(paren
id|last
op_rshift
id|i
)paren
op_amp
l_int|0x1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|search_bit
op_eq
l_int|0
)paren
(brace
id|last_zero
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|last_zero
OL
l_int|9
)paren
id|last_family_desc
op_assign
id|last_zero
suffix:semicolon
)brace
)brace
r_else
id|search_bit
op_assign
id|id_bit
suffix:semicolon
id|tmp
op_assign
id|search_bit
suffix:semicolon
id|rn
op_or_assign
(paren
id|tmp
op_lshift
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Write 1 bit to bus&n;&t;&t;&t; * and make all who don&squot;t have &quot;search_bit&quot; in &quot;i&quot;&squot;th position&n;&t;&t;&t; * in it&squot;s registration number sleep.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;bus_master-&gt;touch_bit
)paren
id|w1_touch_bit
c_func
(paren
id|dev
comma
id|search_bit
)paren
suffix:semicolon
r_else
id|w1_write_bit
c_func
(paren
id|dev
comma
id|search_bit
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|desc_bit
op_eq
id|last_zero
)paren
id|last_device
op_assign
l_int|1
suffix:semicolon
id|desc_bit
op_assign
id|last_zero
suffix:semicolon
id|slave_count
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|ent
comma
op_amp
id|dev-&gt;slist
)paren
(brace
r_struct
id|w1_reg_num
op_star
id|tmp
suffix:semicolon
id|tmp
op_assign
(paren
r_struct
id|w1_reg_num
op_star
)paren
op_amp
id|rn
suffix:semicolon
id|sl
op_assign
id|list_entry
c_func
(paren
id|ent
comma
r_struct
id|w1_slave
comma
id|w1_slave_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sl-&gt;reg_num.family
op_eq
id|tmp-&gt;family
op_logical_and
id|sl-&gt;reg_num.id
op_eq
id|tmp-&gt;id
op_logical_and
id|sl-&gt;reg_num.crc
op_eq
id|tmp-&gt;crc
)paren
(brace
id|set_bit
c_func
(paren
id|W1_SLAVE_ACTIVE
comma
(paren
r_int
op_star
)paren
op_amp
id|sl-&gt;flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sl-&gt;reg_num.family
op_eq
id|tmp-&gt;family
)paren
(brace
id|family_found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|slave_count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|slave_count
op_eq
id|dev-&gt;slave_count
op_logical_and
id|rn
op_logical_and
(paren
(paren
id|rn
op_rshift
l_int|56
)paren
op_amp
l_int|0xff
)paren
op_eq
id|w1_calc_crc8
c_func
(paren
(paren
id|u8
op_star
)paren
op_amp
id|rn
comma
l_int|7
)paren
)paren
(brace
id|w1_attach_slave_device
c_func
(paren
id|dev
comma
(paren
r_struct
id|w1_reg_num
op_star
)paren
op_amp
id|rn
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|w1_create_master_attributes
r_int
id|w1_create_master_attributes
c_func
(paren
r_struct
id|w1_master
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_slaves
)paren
OL
l_int|0
op_logical_or
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_slave_count
)paren
OL
l_int|0
op_logical_or
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_attempts
)paren
OL
l_int|0
op_logical_or
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_max_slave_count
)paren
OL
l_int|0
op_logical_or
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_timeout
)paren
OL
l_int|0
op_logical_or
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_pointer
)paren
OL
l_int|0
op_logical_or
id|device_create_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_name
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|w1_destroy_master_attributes
r_void
id|w1_destroy_master_attributes
c_func
(paren
r_struct
id|w1_master
op_star
id|dev
)paren
(brace
id|device_remove_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_slaves
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_slave_count
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_attempts
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_max_slave_count
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_timeout
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_pointer
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|dev-&gt;dev
comma
op_amp
id|w1_master_attribute_name
)paren
suffix:semicolon
)brace
DECL|function|w1_control
r_int
id|w1_control
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|w1_slave
op_star
id|sl
suffix:semicolon
r_struct
id|w1_master
op_star
id|dev
suffix:semicolon
r_struct
id|list_head
op_star
id|ent
comma
op_star
id|ment
comma
op_star
id|n
comma
op_star
id|mn
suffix:semicolon
r_int
id|err
comma
id|have_to_wait
op_assign
l_int|0
comma
id|timeout
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;w1_control&quot;
)paren
suffix:semicolon
id|allow_signal
c_func
(paren
id|SIGTERM
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|control_needs_exit
op_logical_or
id|have_to_wait
)paren
(brace
id|have_to_wait
op_assign
l_int|0
suffix:semicolon
id|timeout
op_assign
id|w1_timeout
op_star
id|HZ
suffix:semicolon
r_do
(brace
id|timeout
op_assign
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|w1_control_wait
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;flags
op_amp
id|PF_FREEZE
)paren
id|refrigerator
c_func
(paren
id|PF_FREEZE
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_and
(paren
id|timeout
OG
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|ment
comma
id|mn
comma
op_amp
id|w1_masters
)paren
(brace
id|dev
op_assign
id|list_entry
c_func
(paren
id|ment
comma
r_struct
id|w1_master
comma
id|w1_master_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|control_needs_exit
op_logical_and
op_logical_neg
id|dev-&gt;need_exit
)paren
r_continue
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Little race: we can create thread but not set the flag.&n;&t;&t;&t; * Get a chance for external process to set flag up.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;initialized
)paren
(brace
id|have_to_wait
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|w1_mlock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|dev-&gt;w1_master_entry
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|w1_mlock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control_needs_exit
)paren
(brace
id|dev-&gt;need_exit
op_assign
l_int|1
suffix:semicolon
id|err
op_assign
id|kill_proc
c_func
(paren
id|dev-&gt;kpid
comma
id|SIGTERM
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;Failed to send signal to w1 kernel thread %d.&bslash;n&quot;
comma
id|dev-&gt;kpid
)paren
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|dev-&gt;dev_exited
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|ent
comma
id|n
comma
op_amp
id|dev-&gt;slist
)paren
(brace
id|sl
op_assign
id|list_entry
c_func
(paren
id|ent
comma
r_struct
id|w1_slave
comma
id|w1_slave_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sl
)paren
id|dev_warn
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s: slave entry is NULL.&bslash;n&quot;
comma
id|__func__
)paren
suffix:semicolon
r_else
(brace
id|list_del
c_func
(paren
op_amp
id|sl-&gt;w1_slave_entry
)paren
suffix:semicolon
id|w1_slave_detach
c_func
(paren
id|sl
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sl
)paren
suffix:semicolon
)brace
)brace
id|w1_destroy_master_attributes
c_func
(paren
id|dev
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|dev-&gt;refcnt
)paren
suffix:semicolon
)brace
)brace
id|complete_and_exit
c_func
(paren
op_amp
id|w1_control_complete
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|w1_process
r_int
id|w1_process
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|w1_master
op_star
id|dev
op_assign
(paren
r_struct
id|w1_master
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_struct
id|list_head
op_star
id|ent
comma
op_star
id|n
suffix:semicolon
r_struct
id|w1_slave
op_star
id|sl
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;%s&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|allow_signal
c_func
(paren
id|SIGTERM
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|dev-&gt;need_exit
)paren
(brace
id|timeout
op_assign
id|w1_timeout
op_star
id|HZ
suffix:semicolon
r_do
(brace
id|timeout
op_assign
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|dev-&gt;kwait
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;flags
op_amp
id|PF_FREEZE
)paren
id|refrigerator
c_func
(paren
id|PF_FREEZE
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_and
(paren
id|timeout
OG
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;need_exit
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;initialized
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|dev-&gt;mutex
)paren
)paren
r_continue
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|ent
comma
id|n
comma
op_amp
id|dev-&gt;slist
)paren
(brace
id|sl
op_assign
id|list_entry
c_func
(paren
id|ent
comma
r_struct
id|w1_slave
comma
id|w1_slave_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sl
)paren
id|clear_bit
c_func
(paren
id|W1_SLAVE_ACTIVE
comma
(paren
r_int
op_star
)paren
op_amp
id|sl-&gt;flags
)paren
suffix:semicolon
)brace
id|w1_search
c_func
(paren
id|dev
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|ent
comma
id|n
comma
op_amp
id|dev-&gt;slist
)paren
(brace
id|sl
op_assign
id|list_entry
c_func
(paren
id|ent
comma
r_struct
id|w1_slave
comma
id|w1_slave_entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sl
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|W1_SLAVE_ACTIVE
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|sl-&gt;flags
)paren
op_logical_and
op_logical_neg
op_decrement
id|sl-&gt;ttl
)paren
(brace
id|list_del
(paren
op_amp
id|sl-&gt;w1_slave_entry
)paren
suffix:semicolon
id|w1_slave_detach
(paren
id|sl
)paren
suffix:semicolon
id|kfree
(paren
id|sl
)paren
suffix:semicolon
id|dev-&gt;slave_count
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|W1_SLAVE_ACTIVE
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|sl-&gt;flags
)paren
)paren
id|sl-&gt;ttl
op_assign
id|dev-&gt;slave_ttl
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;mutex
)paren
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|dev-&gt;refcnt
)paren
suffix:semicolon
id|complete_and_exit
c_func
(paren
op_amp
id|dev-&gt;dev_exited
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|w1_init
r_int
id|w1_init
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Driver for 1-wire Dallas network protocol.&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|bus_register
c_func
(paren
op_amp
id|w1_bus_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to register bus. err=%d.&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_goto
id|err_out_exit_init
suffix:semicolon
)brace
id|retval
op_assign
id|driver_register
c_func
(paren
op_amp
id|w1_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to register master driver. err=%d.&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_goto
id|err_out_bus_unregister
suffix:semicolon
)brace
id|control_thread
op_assign
id|kernel_thread
c_func
(paren
op_amp
id|w1_control
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control_thread
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to create control thread. err=%d&bslash;n&quot;
comma
id|control_thread
)paren
suffix:semicolon
id|retval
op_assign
id|control_thread
suffix:semicolon
r_goto
id|err_out_driver_unregister
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_out_driver_unregister
suffix:colon
id|driver_unregister
c_func
(paren
op_amp
id|w1_driver
)paren
suffix:semicolon
id|err_out_bus_unregister
suffix:colon
id|bus_unregister
c_func
(paren
op_amp
id|w1_bus_type
)paren
suffix:semicolon
id|err_out_exit_init
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|w1_fini
r_void
id|w1_fini
c_func
(paren
r_void
)paren
(brace
r_struct
id|w1_master
op_star
id|dev
suffix:semicolon
r_struct
id|list_head
op_star
id|ent
comma
op_star
id|n
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|ent
comma
id|n
comma
op_amp
id|w1_masters
)paren
(brace
id|dev
op_assign
id|list_entry
c_func
(paren
id|ent
comma
r_struct
id|w1_master
comma
id|w1_master_entry
)paren
suffix:semicolon
id|__w1_remove_master_device
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|control_needs_exit
op_assign
l_int|1
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|w1_control_complete
)paren
suffix:semicolon
id|driver_unregister
c_func
(paren
op_amp
id|w1_driver
)paren
suffix:semicolon
id|bus_unregister
c_func
(paren
op_amp
id|w1_bus_type
)paren
suffix:semicolon
)brace
DECL|variable|w1_init
id|module_init
c_func
(paren
id|w1_init
)paren
suffix:semicolon
DECL|variable|w1_fini
id|module_exit
c_func
(paren
id|w1_fini
)paren
suffix:semicolon
DECL|variable|w1_create_master_attributes
id|EXPORT_SYMBOL
c_func
(paren
id|w1_create_master_attributes
)paren
suffix:semicolon
DECL|variable|w1_destroy_master_attributes
id|EXPORT_SYMBOL
c_func
(paren
id|w1_destroy_master_attributes
)paren
suffix:semicolon
eof
