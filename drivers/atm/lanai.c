multiline_comment|/* lanai.c -- Copyright 1999 by Mitchell Blank Jr &lt;mitch@sfgoth.com&gt;&n; *&n; *  This program is free software; you can redistribute it and/or&n; *  modify it under the terms of the GNU General Public License&n; *  as published by the Free Software Foundation; either version&n; *  2 of the License, or (at your option) any later version.&n; *&n; * This driver supports ATM cards based on the Efficient &quot;Lanai&quot;&n; * chipset such as the Speedstream 3010 and the ENI-25p.  The&n; * Speedstream 3060 is currently not supported since we don&squot;t&n; * have the code to drive the on-board Alcatel DSL chipset (yet).&n; *&n; * Thanks to Efficient for supporting this project with hardware,&n; * documentation, and by answering my questions.&n; *&n; * Things not working yet:&n; *&n; * o  We&squot;re only set up to compile as a module currently.  i.e.&n; *    you should put the source in drivers/atm/lanai.c and then&n; *    just do &quot;make drivers/atm/lanai.o&quot; from the main&n; *    source directory.  This will produce a drivers/atm/lanai.o&n; *    file suitable for insmod&squot;ing&n; *&n; * o  We don&squot;t support the Speedstream 3060 yet - this card has&n; *    an on-board DSL modem chip by Alcatel and the driver will&n; *    need some extra code added to handle it&n; *&n; * o  Note that due to limitations of the Lanai only one VCC can be&n; *    in CBR at once&n; *&n; * o We don&squot;t currently parse the EEPROM at all.  The code is all&n; *   there as per the spec, but it doesn&squot;t actually work.  I think&n; *   there may be some issues with the docs.  Anyway, do NOT&n; *   enable it yet - bugs in that code may actually damage your&n; *   hardware!  Because of this you should hardware an ESI before&n; *   trying to use this in a LANE or MPOA environment.&n; *&n; * o  AAL0 is stubbed in but the actual rx/tx path isn&squot;t written yet:&n; *&t;vcc_tx_aal0() needs to send or queue a SKB&n; *&t;vcc_tx_unqueue_aal0() needs to attempt to send queued SKBs&n; *&t;vcc_rx_aal0() needs to handle AAL0 interrupts&n; *    This isn&squot;t too much work - I just wanted to get other things&n; *    done first.&n; *&n; * o  lanai_change_qos() isn&squot;t written yet&n; *&n; * o  There aren&squot;t any ioctl&squot;s yet -- I&squot;d like to eventually support&n; *    setting loopback and LED modes that way.  (see lanai_ioctl)&n; *&n; * o  If the segmentation engine or DMA gets shut down we should restart&n; *    card as per section 17.0i.  (see lanai_reset)&n; *&n; * o setsockopt(SO_CIRANGE) isn&squot;t done (although despite what the&n; *   API says it isn&squot;t exactly commonly implemented)&n; */
multiline_comment|/* Version history:&n; *   v.0.02 -- 11-JAN-2000 -- Endian fixes&n; *   v.0.01 -- 30-NOV-1999 -- Initial release&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#ifndef PCI_VENDOR_ID_EF_ATM_LANAI2
multiline_comment|/* These need to eventually go into &lt;linux/pci.h&gt; - they&squot;re here for now */
DECL|macro|PCI_VENDOR_ID_EF_ATM_LANAI2
mdefine_line|#define PCI_VENDOR_ID_EF_ATM_LANAI2&t;0x0003
DECL|macro|PCI_VENDOR_ID_EF_ATM_LANAIHB
mdefine_line|#define PCI_VENDOR_ID_EF_ATM_LANAIHB&t;0x0005
macro_line|#endif
multiline_comment|/* -------------------- TUNABLE PARAMATERS: */
multiline_comment|/*&n; * Maximum number of VCIs per card.  Setting it lower could theoretically&n; * save some memory, but since we allocate our vcc list with get_free_pages,&n; * it&squot;s not really likely for most architectures&n; */
DECL|macro|NUM_VCI
mdefine_line|#define NUM_VCI&t;&t;&t;(1024)
multiline_comment|/*&n; * Enable extra debugging&n; */
DECL|macro|DEBUG
mdefine_line|#define DEBUG
multiline_comment|/*&n; * Debug _all_ register operations with card, except the memory test.&n; * Also disables the timed poll to prevent extra chattiness.  This&n; * isn&squot;t for normal use&n; */
DECL|macro|DEBUG_RW
macro_line|#undef DEBUG_RW
multiline_comment|/*&n; * The programming guide specifies a full test of the on-board SRAM&n; * at initialization time.  Undefine to remove this&n; */
DECL|macro|FULL_MEMORY_TEST
mdefine_line|#define FULL_MEMORY_TEST
multiline_comment|/*&n; * This is the number of (4 byte) service entries that we will&n; * try to allocate at startup.  Note that we will end up with&n; * one PAGE_SIZE&squot;s worth regardless of what this is set to&n; */
DECL|macro|SERVICE_ENTRIES
mdefine_line|#define SERVICE_ENTRIES&t;&t;(1024)
multiline_comment|/* TODO: make above a module load-time option */
multiline_comment|/*&n; * We normally read the onboard EEPROM in order to discover our MAC&n; * address.  Undefine to _not_ do this&n; */
multiline_comment|/* #define READ_EEPROM */
multiline_comment|/* ***DONT ENABLE YET*** */
multiline_comment|/* TODO: make above a module load-time option (also) */
multiline_comment|/*&n; * Depth of TX fifo (in 128 byte units; range 2-31)&n; * Smaller numbers are better for network latency&n; * Larger numbers are better for PCI latency&n; * I&squot;m really sure where the best tradeoff is, but the BSD driver uses&n; * 7 and it seems to work ok.&n; */
DECL|macro|TX_FIFO_DEPTH
mdefine_line|#define TX_FIFO_DEPTH&t;&t;(7)
multiline_comment|/* TODO: make above a module load-time option */
multiline_comment|/*&n; * How often (in jiffies) we will try to unstick stuck connections -&n; * shouldn&squot;t need to happen much&n; */
DECL|macro|LANAI_POLL_PERIOD
mdefine_line|#define LANAI_POLL_PERIOD&t;(10*HZ)
multiline_comment|/* TODO: make above a module load-time option */
multiline_comment|/*&n; * When allocating an AAL5 receiving buffer, try to make it at least&n; * large enough to hold this many max_sdu sized PDUs&n; */
DECL|macro|AAL5_RX_MULTIPLIER
mdefine_line|#define AAL5_RX_MULTIPLIER&t;(3)
multiline_comment|/* TODO: make above a module load-time option */
multiline_comment|/*&n; * Same for transmitting buffer&n; */
DECL|macro|AAL5_TX_MULTIPLIER
mdefine_line|#define AAL5_TX_MULTIPLIER&t;(3)
multiline_comment|/* TODO: make above a module load-time option */
multiline_comment|/*&n; * When allocating an AAL0 transmiting buffer, how many cells should fit.&n; * Remember we&squot;ll end up with a PAGE_SIZE of them anyway, so this isn&squot;t&n; * really critical&n; */
DECL|macro|AAL0_TX_MULTIPLIER
mdefine_line|#define AAL0_TX_MULTIPLIER&t;(40)
multiline_comment|/* TODO: make above a module load-time option */
multiline_comment|/*&n; * How large should we make the AAL0 receiving buffer.  Remember that this&n; * is shared between all AAL0 VC&squot;s&n; */
DECL|macro|AAL0_RX_BUFFER_SIZE
mdefine_line|#define AAL0_RX_BUFFER_SIZE&t;(PAGE_SIZE)
multiline_comment|/* TODO: make above a module load-time option */
multiline_comment|/*&n; * Should we use Lanai&squot;s &quot;powerdown&quot; feature when no vcc&squot;s are bound?&n; */
multiline_comment|/* #define USE_POWERDOWN */
multiline_comment|/* TODO: make above a module load-time option (also) */
multiline_comment|/* -------------------- DEBUGGING AIDS: */
DECL|macro|DEV_LABEL
mdefine_line|#define DEV_LABEL &quot;lanai&quot;
macro_line|#ifdef DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format, args...) &bslash;&n;&t;printk(KERN_DEBUG DEV_LABEL &quot;: &quot; format, ##args)
DECL|macro|APRINTK
mdefine_line|#define APRINTK(truth, format, args...) &bslash;&n;&t;do { &bslash;&n;&t;&t;if (!(truth)) &bslash;&n;&t;&t;&t;printk(KERN_ERR DEV_LABEL &quot;: &quot; format, ##args); &bslash;&n;&t;} while (0)
macro_line|#else /* !DEBUG */
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format, args...)
DECL|macro|APRINTK
mdefine_line|#define APRINTK(truth, format, args...)
macro_line|#endif /* DEBUG */
macro_line|#ifdef DEBUG_RW
DECL|macro|RWDEBUG
mdefine_line|#define RWDEBUG(format, args...) &bslash;&n;&t;printk(KERN_DEBUG DEV_LABEL &quot;: &quot; format, ##args)
macro_line|#else /* !DEBUG_RW */
DECL|macro|RWDEBUG
mdefine_line|#define RWDEBUG(format, args...)
macro_line|#endif
multiline_comment|/* -------------------- DATA DEFINITIONS: */
DECL|macro|LANAI_MAPPING_SIZE
mdefine_line|#define LANAI_MAPPING_SIZE&t;(0x40000)
DECL|macro|LANAI_EEPROM_SIZE
mdefine_line|#define LANAI_EEPROM_SIZE&t;(128)
DECL|typedef|vci_t
r_typedef
r_int
id|vci_t
suffix:semicolon
DECL|typedef|bus_addr_t
r_typedef
r_int
r_int
id|bus_addr_t
suffix:semicolon
multiline_comment|/* A bitfield large enough for NUM_VCI */
DECL|macro|VCI_BITFIELD_NELEM
mdefine_line|#define VCI_BITFIELD_NELEM  ((NUM_VCI + BITS_PER_LONG - 1) / BITS_PER_LONG)
r_typedef
r_struct
(brace
DECL|member|ul
r_int
r_int
id|ul
(braket
id|VCI_BITFIELD_NELEM
)braket
suffix:semicolon
DECL|typedef|vci_bitfield
)brace
id|vci_bitfield
suffix:semicolon
multiline_comment|/* DMA buffer in host memory for TX, RX, or service list. */
DECL|struct|lanai_buffer
r_struct
id|lanai_buffer
(brace
DECL|member|start
id|u32
op_star
id|start
suffix:semicolon
multiline_comment|/* From get_free_pages */
DECL|member|end
id|u32
op_star
id|end
suffix:semicolon
multiline_comment|/* One past last byte */
DECL|member|ptr
id|u32
op_star
id|ptr
suffix:semicolon
multiline_comment|/* Pointer to current host location */
DECL|member|order
r_int
id|order
suffix:semicolon
multiline_comment|/* log2(size/PAGE_SIZE) */
)brace
suffix:semicolon
DECL|struct|lanai_vcc_stats
r_struct
id|lanai_vcc_stats
(brace
DECL|member|rx_nomem
r_int
id|rx_nomem
suffix:semicolon
r_union
(brace
r_struct
(brace
DECL|member|rx_badlen
r_int
id|rx_badlen
suffix:semicolon
DECL|member|service_trash
r_int
id|service_trash
suffix:semicolon
DECL|member|service_stream
r_int
id|service_stream
suffix:semicolon
DECL|member|service_rxcrc
r_int
id|service_rxcrc
suffix:semicolon
DECL|member|aal5
)brace
id|aal5
suffix:semicolon
r_struct
(brace
DECL|member|aal0
)brace
id|aal0
suffix:semicolon
DECL|member|x
)brace
id|x
suffix:semicolon
)brace
suffix:semicolon
r_struct
id|lanai_dev
suffix:semicolon
multiline_comment|/* Forward declaration */
multiline_comment|/*&n; * This is the card-specific per-vcc data.  Note that unlike some other&n; * drivers there is NOT a 1-to-1 correspondance between these and&n; * atm_vcc&squot;s - each one of these represents an actual 2-way vcc, but&n; * an atm_vcc can be 1-way and share with a 1-way vcc in the other&n; * direction.  To make it weirder, there can even be 0-way vccs&n; * bound to us, waiting to do a change_qos&n; */
DECL|struct|lanai_vcc
r_struct
id|lanai_vcc
(brace
DECL|member|vbase
id|bus_addr_t
id|vbase
suffix:semicolon
multiline_comment|/* Base of VCC&squot;s registers */
DECL|member|stats
r_struct
id|lanai_vcc_stats
id|stats
suffix:semicolon
DECL|member|nref
r_int
id|nref
suffix:semicolon
multiline_comment|/* # of atm_vcc&squot;s who reference us */
DECL|member|vci
id|vci_t
id|vci
suffix:semicolon
r_struct
(brace
DECL|member|buf
r_struct
id|lanai_buffer
id|buf
suffix:semicolon
DECL|member|atmvcc
r_struct
id|atm_vcc
op_star
id|atmvcc
suffix:semicolon
multiline_comment|/* atm_vcc who is receiver */
DECL|member|rx
)brace
id|rx
suffix:semicolon
r_struct
(brace
DECL|member|buf
r_struct
id|lanai_buffer
id|buf
suffix:semicolon
DECL|member|atmvcc
r_struct
id|atm_vcc
op_star
id|atmvcc
suffix:semicolon
multiline_comment|/* atm_vcc who is transmitter */
DECL|member|endptr
r_int
id|endptr
suffix:semicolon
multiline_comment|/* last endptr from service entry */
DECL|member|backlog
r_struct
id|sk_buff_head
id|backlog
suffix:semicolon
DECL|member|inprogress
r_struct
id|sk_buff
op_star
id|inprogress
suffix:semicolon
multiline_comment|/* We&squot;re streaming this PDU */
DECL|member|pptr
r_int
r_char
op_star
id|pptr
suffix:semicolon
multiline_comment|/* Where we are in above */
DECL|member|inprogleft
r_int
id|inprogleft
suffix:semicolon
multiline_comment|/* Bytes left to send &quot;inprogress&quot; */
DECL|member|unqueue
r_void
(paren
op_star
id|unqueue
)paren
(paren
r_struct
id|lanai_dev
op_star
comma
r_struct
id|lanai_vcc
op_star
comma
r_int
)paren
suffix:semicolon
DECL|member|tx
)brace
id|tx
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|lanai_type
r_enum
id|lanai_type
(brace
DECL|enumerator|lanai2
id|lanai2
op_assign
id|PCI_VENDOR_ID_EF_ATM_LANAI2
comma
DECL|enumerator|lanaihb
id|lanaihb
op_assign
id|PCI_VENDOR_ID_EF_ATM_LANAIHB
)brace
suffix:semicolon
DECL|struct|lanai_dev_stats
r_struct
id|lanai_dev_stats
(brace
DECL|member|ovfl_trash
r_int
id|ovfl_trash
suffix:semicolon
multiline_comment|/* # of cells dropped - buffer overflow */
DECL|member|vci_trash
r_int
id|vci_trash
suffix:semicolon
multiline_comment|/* # of cells dropped - closed vci */
DECL|member|hec_err
r_int
id|hec_err
suffix:semicolon
multiline_comment|/* # of cells dropped - bad HEC */
DECL|member|atm_ovfl
r_int
id|atm_ovfl
suffix:semicolon
multiline_comment|/* # of cells dropped - rx fifo overflow */
DECL|member|pcierr_parity_detect
r_int
id|pcierr_parity_detect
suffix:semicolon
DECL|member|pcierr_serr_set
r_int
id|pcierr_serr_set
suffix:semicolon
DECL|member|pcierr_master_abort
r_int
id|pcierr_master_abort
suffix:semicolon
DECL|member|pcierr_m_target_abort
r_int
id|pcierr_m_target_abort
suffix:semicolon
DECL|member|pcierr_s_target_abort
r_int
id|pcierr_s_target_abort
suffix:semicolon
DECL|member|pcierr_master_parity
r_int
id|pcierr_master_parity
suffix:semicolon
DECL|member|service_novcc_rx
r_int
id|service_novcc_rx
suffix:semicolon
DECL|member|service_novcc_tx
r_int
id|service_novcc_tx
suffix:semicolon
DECL|member|service_notx
r_int
id|service_notx
suffix:semicolon
DECL|member|service_norx
r_int
id|service_norx
suffix:semicolon
DECL|member|service_rxnotaal5
r_int
id|service_rxnotaal5
suffix:semicolon
DECL|member|dma_reenable
r_int
id|dma_reenable
suffix:semicolon
DECL|member|card_reset
r_int
id|card_reset
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|lanai_dev
r_struct
id|lanai_dev
(brace
DECL|member|base
id|bus_addr_t
id|base
suffix:semicolon
DECL|member|stats
r_struct
id|lanai_dev_stats
id|stats
suffix:semicolon
DECL|member|service
r_struct
id|lanai_buffer
id|service
suffix:semicolon
DECL|member|vccs
r_struct
id|lanai_vcc
op_star
op_star
id|vccs
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
DECL|member|nbound
r_int
id|nbound
suffix:semicolon
multiline_comment|/* number of bound vccs */
macro_line|#endif
DECL|member|type
r_enum
id|lanai_type
id|type
suffix:semicolon
DECL|member|num_vci
id|vci_t
id|num_vci
suffix:semicolon
multiline_comment|/* Currently just NUM_VCI */
DECL|member|eeprom
id|u8
id|eeprom
(braket
id|LANAI_EEPROM_SIZE
)braket
suffix:semicolon
DECL|member|serialno
DECL|member|magicno
id|u32
id|serialno
comma
id|magicno
suffix:semicolon
DECL|member|pci
r_struct
id|pci_dev
op_star
id|pci
suffix:semicolon
DECL|member|backlog_vccs
id|vci_bitfield
id|backlog_vccs
suffix:semicolon
multiline_comment|/* VCCs that are backlogged */
DECL|member|transmit_ready
id|vci_bitfield
id|transmit_ready
suffix:semicolon
multiline_comment|/* VCCs that have transmit space */
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|naal0
r_int
id|naal0
suffix:semicolon
DECL|member|aal0buf
r_struct
id|lanai_buffer
id|aal0buf
suffix:semicolon
multiline_comment|/* AAL0 RX buffers */
DECL|member|conf1
DECL|member|conf2
id|u32
id|conf1
comma
id|conf2
suffix:semicolon
multiline_comment|/* CONFIG[12] registers */
DECL|member|status
id|u32
id|status
suffix:semicolon
multiline_comment|/* STATUS register */
DECL|member|txlock
id|spinlock_t
id|txlock
suffix:semicolon
DECL|member|servicelock
id|spinlock_t
id|servicelock
suffix:semicolon
DECL|member|cbrvcc
r_struct
id|atm_vcc
op_star
id|cbrvcc
suffix:semicolon
DECL|member|number
r_int
id|number
suffix:semicolon
DECL|member|board_rev
r_int
id|board_rev
suffix:semicolon
DECL|member|pci_revision
id|u8
id|pci_revision
suffix:semicolon
multiline_comment|/* TODO - look at race conditions with maintence of conf1/conf2 */
multiline_comment|/* TODO - transmit locking: should we use _irq not _irqsave? */
multiline_comment|/* TODO - organize above in some rational fashion (see &lt;asm/cache.h&gt;) */
)brace
suffix:semicolon
multiline_comment|/* -------------------- VCI_BITFIELD UTILITIES: */
multiline_comment|/*&n; * These functions assume that BITS_PER_LONG is a power of two, which&n; * should be safe&n; */
macro_line|#if (BITS_PER_LONG &amp; (BITS_PER_LONG - 1))
macro_line|#error lanai driver requires type long to have a power of two number of bits
macro_line|#endif
multiline_comment|/*&n; * In vci_bitfield_{set,clear} we do the operation in three&n; * parts to ensure that gcc doesn&squot;t cast anything down to&n; * 32 bits (and then sign extend them later) on 64-bit&n; * platforms like the alpha&n; */
DECL|function|vci_bitfield_set
r_static
r_inline
r_void
id|vci_bitfield_set
c_func
(paren
id|vci_bitfield
op_star
id|bf
comma
id|vci_t
id|vci
)paren
(brace
r_int
r_int
id|bit
op_assign
l_int|1
suffix:semicolon
id|bit
op_lshift_assign
(paren
r_int
r_int
)paren
(paren
id|vci
op_amp
(paren
id|BITS_PER_LONG
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|bf-&gt;ul
(braket
id|vci
op_div
id|BITS_PER_LONG
)braket
op_or_assign
id|bit
suffix:semicolon
)brace
DECL|function|vci_bitfield_clear
r_static
r_inline
r_void
id|vci_bitfield_clear
c_func
(paren
id|vci_bitfield
op_star
id|bf
comma
id|vci_t
id|vci
)paren
(brace
r_int
r_int
id|bit
op_assign
l_int|1
suffix:semicolon
id|bit
op_lshift_assign
(paren
r_int
r_int
)paren
(paren
id|vci
op_amp
(paren
id|BITS_PER_LONG
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|bf-&gt;ul
(braket
id|vci
op_div
id|BITS_PER_LONG
)braket
op_and_assign
op_complement
id|bit
suffix:semicolon
)brace
DECL|function|vci_bitfield_init
r_static
r_inline
r_void
id|vci_bitfield_init
c_func
(paren
id|vci_bitfield
op_star
id|bf
)paren
(brace
id|memset
c_func
(paren
id|bf
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|bf
)paren
)paren
suffix:semicolon
)brace
DECL|function|vci_bitfield_iterate
r_static
r_void
id|vci_bitfield_iterate
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_const
id|vci_bitfield
op_star
id|bf
comma
r_void
(paren
op_star
id|func
)paren
(paren
r_struct
id|lanai_dev
op_star
comma
id|vci_t
id|vci
)paren
)paren
(brace
id|vci_t
id|vci
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_const
r_int
r_int
op_star
id|lp
op_assign
op_amp
(paren
id|bf-&gt;ul
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|vci
op_assign
l_int|0
suffix:semicolon
id|vci
OL
id|NUM_VCI
suffix:semicolon
id|lp
op_increment
)paren
r_if
c_cond
(paren
op_star
id|lp
op_eq
l_int|0
)paren
id|vci
op_add_assign
id|BITS_PER_LONG
suffix:semicolon
r_else
r_for
c_loop
(paren
id|mask
op_assign
l_int|1
suffix:semicolon
id|mask
op_ne
l_int|0
suffix:semicolon
id|mask
op_lshift_assign
l_int|1
comma
id|vci
op_increment
)paren
r_if
c_cond
(paren
op_star
id|lp
op_amp
id|mask
)paren
id|func
c_func
(paren
id|lanai
comma
id|vci
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- BUFFER  UTILITIES: */
multiline_comment|/*&n; * Lanai needs DMA buffers aligned to 256 bytes of at least 1024 bytes -&n; * we assume that any page allocation will do.  I&squot;m sure this is&n; * never going to be a problem, but it&squot;s good to document assumtions&n; */
macro_line|#if PAGE_SIZE &lt; 1024
macro_line|#error PAGE_SIZE too small to support LANAI chipset
macro_line|#endif
multiline_comment|/*&n; * We also assume that the maximum buffer size will be some number&n; * of whole pages, although that wouldn&squot;t be too hard to fix&n; */
macro_line|#if PAGE_SIZE &gt; (128 * 1024)
macro_line|#error PAGE_SIZE too large to support LANAI chipset
macro_line|#endif
multiline_comment|/* Convert a size to &quot;order&quot; for __get_free_pages */
DECL|function|bytes_to_order
r_static
r_int
id|bytes_to_order
c_func
(paren
r_int
id|bytes
)paren
(brace
r_int
id|order
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|bytes
OG
(paren
l_int|128
op_star
l_int|1024
)paren
)paren
id|bytes
op_assign
l_int|128
op_star
l_int|1024
suffix:semicolon
multiline_comment|/* Max buffer size for lanai */
r_while
c_loop
(paren
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
OL
id|bytes
)paren
id|order
op_increment
suffix:semicolon
r_return
id|order
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a buffer in host RAM for service list, RX, or TX&n; * Returns buf-&gt;order&lt;0 if no memory&n; * Note that the size will be rounded up to an &quot;order&quot; of pages, and&n; * if we can&squot;t allocate that we&squot;ll settle for something smaller&n; * until minbytes&n; *&n; * NOTE: buffer must be 32-bit DMA capable - when linux can&n; *&t; make distinction, this will need tweaking for this&n; *&t; to work on BIG memory machines.&n; */
DECL|function|lanai_buf_allocate
r_static
r_void
id|lanai_buf_allocate
c_func
(paren
r_struct
id|lanai_buffer
op_star
id|buf
comma
r_int
id|bytes
comma
r_int
id|minbytes
)paren
(brace
r_int
r_int
id|address
suffix:semicolon
r_int
id|order
op_assign
id|bytes_to_order
c_func
(paren
id|bytes
)paren
suffix:semicolon
r_do
(brace
id|address
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
id|address
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Success */
id|bytes
op_assign
id|PAGE_SIZE
op_lshift
id|order
suffix:semicolon
id|buf-&gt;start
op_assign
id|buf-&gt;ptr
op_assign
(paren
id|u32
op_star
)paren
id|address
suffix:semicolon
id|buf-&gt;end
op_assign
(paren
id|u32
op_star
)paren
(paren
id|address
op_plus
id|bytes
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|address
comma
l_int|0
comma
id|bytes
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|PAGE_SIZE
op_lshift
op_decrement
id|order
)paren
OL
id|minbytes
)paren
id|order
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Too small - give up */
)brace
r_while
c_loop
(paren
id|order
op_ge
l_int|0
)paren
suffix:semicolon
id|buf-&gt;order
op_assign
id|order
suffix:semicolon
)brace
DECL|function|lanai_buf_deallocate
r_static
r_inline
r_void
id|lanai_buf_deallocate
c_func
(paren
r_struct
id|lanai_buffer
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|buf-&gt;order
op_ge
l_int|0
)paren
(brace
id|APRINTK
c_func
(paren
id|buf-&gt;start
op_ne
l_int|0
comma
l_string|&quot;lanai_buf_deallocate: start==0!&bslash;n&quot;
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|buf-&gt;start
comma
id|buf-&gt;order
)paren
suffix:semicolon
id|buf-&gt;start
op_assign
id|buf-&gt;end
op_assign
id|buf-&gt;ptr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* size of buffer in bytes */
DECL|function|lanai_buf_size
r_static
r_inline
r_int
id|lanai_buf_size
c_func
(paren
r_const
r_struct
id|lanai_buffer
op_star
id|buf
)paren
(brace
r_return
(paren
(paren
r_int
r_int
)paren
id|buf-&gt;end
)paren
op_minus
(paren
(paren
r_int
r_int
)paren
id|buf-&gt;start
)paren
suffix:semicolon
)brace
multiline_comment|/* size of buffer as &quot;card order&quot; (0=1k .. 7=128k) */
DECL|function|lanai_buf_size_cardorder
r_static
r_inline
r_int
id|lanai_buf_size_cardorder
c_func
(paren
r_const
r_struct
id|lanai_buffer
op_star
id|buf
)paren
(brace
r_return
id|buf-&gt;order
op_plus
id|PAGE_SHIFT
op_minus
l_int|10
suffix:semicolon
)brace
multiline_comment|/* DMA-able address for this buffer */
DECL|function|lanai_buf_dmaaddr
r_static
r_int
r_int
id|lanai_buf_dmaaddr
c_func
(paren
r_const
r_struct
id|lanai_buffer
op_star
id|buf
)paren
(brace
r_int
r_int
id|r
op_assign
id|virt_to_bus
c_func
(paren
id|buf-&gt;start
)paren
suffix:semicolon
id|APRINTK
c_func
(paren
(paren
id|r
op_amp
op_complement
l_int|0xFFFFFF00
)paren
op_eq
l_int|0
comma
l_string|&quot;bad dmaaddr: 0x%lx&bslash;n&quot;
comma
(paren
r_int
)paren
id|r
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* -------------------- HANDLE BACKLOG_VCCS BITFIELD: */
DECL|function|vcc_mark_backlogged
r_static
r_inline
r_void
id|vcc_mark_backlogged
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
id|APRINTK
c_func
(paren
id|lvcc-&gt;vbase
op_ne
l_int|0
comma
l_string|&quot;vcc_mark_backlogged: zero vbase!&bslash;n&quot;
)paren
suffix:semicolon
id|vci_bitfield_set
c_func
(paren
op_amp
id|lanai-&gt;backlog_vccs
comma
id|lvcc-&gt;vci
)paren
suffix:semicolon
)brace
DECL|function|vcc_unmark_backlogged
r_static
r_inline
r_void
id|vcc_unmark_backlogged
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
id|APRINTK
c_func
(paren
id|lvcc-&gt;vbase
op_ne
l_int|0
comma
l_string|&quot;vcc_unmark_backlogged: zero vbase!&bslash;n&quot;
)paren
suffix:semicolon
id|vci_bitfield_clear
c_func
(paren
op_amp
id|lanai-&gt;backlog_vccs
comma
id|lvcc-&gt;vci
)paren
suffix:semicolon
)brace
DECL|function|vcc_backlog_init
r_static
r_inline
r_void
id|vcc_backlog_init
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|vci_bitfield_init
c_func
(paren
op_amp
id|lanai-&gt;backlog_vccs
)paren
suffix:semicolon
)brace
DECL|function|vcc_is_backlogged
r_static
r_inline
r_int
id|vcc_is_backlogged
c_func
(paren
multiline_comment|/*const*/
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
r_return
id|lvcc-&gt;tx.inprogress
op_ne
l_int|NULL
op_logical_or
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|lvcc-&gt;tx.backlog
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- PORT I/O UTILITIES: */
multiline_comment|/* Registers (and their bit-fields) */
DECL|enum|lanai_register
r_enum
id|lanai_register
(brace
DECL|enumerator|Reset_Reg
id|Reset_Reg
op_assign
l_int|0x00
comma
multiline_comment|/* Reset; read for chip type; bits: */
DECL|macro|RESET_GET_BOARD_REV
mdefine_line|#define   RESET_GET_BOARD_REV(x)    (((x)&gt;&gt; 0)&amp;0x03)&t;/* Board revision */
DECL|macro|RESET_GET_BOARD_ID
mdefine_line|#define   RESET_GET_BOARD_ID(x)&t;    (((x)&gt;&gt; 2)&amp;0x03)&t;/* Board ID */
DECL|macro|BOARD_ID_LANAI256
mdefine_line|#define     BOARD_ID_LANAI256&t;&t;(0)&t;/* 25.6M adaptor card */
DECL|enumerator|Endian_Reg
id|Endian_Reg
op_assign
l_int|0x04
comma
multiline_comment|/* Endian setting */
DECL|enumerator|IntStatus_Reg
id|IntStatus_Reg
op_assign
l_int|0x08
comma
multiline_comment|/* Interrupt status */
DECL|enumerator|IntStatusMasked_Reg
id|IntStatusMasked_Reg
op_assign
l_int|0x0C
comma
multiline_comment|/* Interrupt status (masked) */
DECL|enumerator|IntAck_Reg
id|IntAck_Reg
op_assign
l_int|0x10
comma
multiline_comment|/* Interrupt acknowledge */
DECL|enumerator|IntAckMasked_Reg
id|IntAckMasked_Reg
op_assign
l_int|0x14
comma
multiline_comment|/* Interrupt acknowledge (masked) */
DECL|enumerator|IntStatusSet_Reg
id|IntStatusSet_Reg
op_assign
l_int|0x18
comma
multiline_comment|/* Get status + enable/disable */
DECL|enumerator|IntStatusSetMasked_Reg
id|IntStatusSetMasked_Reg
op_assign
l_int|0x1C
comma
multiline_comment|/* Get status + en/di (masked) */
DECL|enumerator|IntControlEna_Reg
id|IntControlEna_Reg
op_assign
l_int|0x20
comma
multiline_comment|/* Interrupt control enable */
DECL|enumerator|IntControlDis_Reg
id|IntControlDis_Reg
op_assign
l_int|0x24
comma
multiline_comment|/* Interrupt control disable */
DECL|enumerator|Status_Reg
id|Status_Reg
op_assign
l_int|0x28
comma
multiline_comment|/* Status */
DECL|macro|STATUS_PROMDATA
mdefine_line|#define   STATUS_PROMDATA&t; (0x00000001)&t;/* PROM_DATA pin */
DECL|macro|STATUS_WAITING
mdefine_line|#define   STATUS_WAITING&t; (0x00000002)&t;/* Interrupt being delayed */
DECL|macro|STATUS_SOOL
mdefine_line|#define&t;  STATUS_SOOL&t;&t; (0x00000004)&t;/* SOOL alarm */
DECL|macro|STATUS_LOCD
mdefine_line|#define   STATUS_LOCD&t;&t; (0x00000008)&t;/* LOCD alarm */
DECL|macro|STATUS_LED
mdefine_line|#define&t;  STATUS_LED&t;&t; (0x00000010)&t;/* LED (HAPPI) output */
DECL|macro|STATUS_GPIN
mdefine_line|#define   STATUS_GPIN&t;&t; (0x00000020)&t;/* GPIN pin */
DECL|macro|STATUS_BUTTBUSY
mdefine_line|#define   STATUS_BUTTBUSY&t; (0x00000040)&t;/* Butt register is pending */
DECL|enumerator|Config1_Reg
id|Config1_Reg
op_assign
l_int|0x2C
comma
multiline_comment|/* Config word 1; bits: */
DECL|macro|CONFIG1_PROMDATA
mdefine_line|#define   CONFIG1_PROMDATA&t; (0x00000001)&t;/* PROM_DATA pin */
DECL|macro|CONFIG1_PROMCLK
mdefine_line|#define   CONFIG1_PROMCLK&t; (0x00000002)&t;/* PROM_CLK pin */
DECL|macro|CONFIG1_SET_READMODE
mdefine_line|#define   CONFIG1_SET_READMODE(x) ((x)*0x004)&t;/* PCI BM reads; values: */
DECL|macro|READMODE_PLAIN
mdefine_line|#define     READMODE_PLAIN&t;    (0)&t;&t;/*   Plain memory read */
DECL|macro|READMODE_LINE
mdefine_line|#define     READMODE_LINE&t;    (2)&t;&t;/*   Memory read line */
DECL|macro|READMODE_MULTIPLE
mdefine_line|#define     READMODE_MULTIPLE&t;    (3)&t;&t;/*   Memory read multiple */
DECL|macro|CONFIG1_DMA_ENABLE
mdefine_line|#define   CONFIG1_DMA_ENABLE&t; (0x00000010)&t;/* Turn on DMA */
DECL|macro|CONFIG1_POWERDOWN
mdefine_line|#define   CONFIG1_POWERDOWN&t; (0x00000020)&t;/* Turn off clocks */
DECL|macro|CONFIG1_SET_LOOPMODE
mdefine_line|#define   CONFIG1_SET_LOOPMODE(x) ((x)*0x080)&t;/* Clock&amp;loop mode; values: */
DECL|macro|LOOPMODE_NORMAL
mdefine_line|#define     LOOPMODE_NORMAL&t;    (0)&t;&t;/*   Normal - no loop */
DECL|macro|LOOPMODE_TIME
mdefine_line|#define     LOOPMODE_TIME&t;    (1)
DECL|macro|LOOPMODE_DIAG
mdefine_line|#define     LOOPMODE_DIAG&t;    (2)
DECL|macro|LOOPMODE_LINE
mdefine_line|#define     LOOPMODE_LINE&t;    (3)
DECL|macro|CONFIG1_MASK_LOOPMODE
mdefine_line|#define   CONFIG1_MASK_LOOPMODE  (0x00000180)
DECL|macro|CONFIG1_SET_LEDMODE
mdefine_line|#define   CONFIG1_SET_LEDMODE(x) ((x)*0x0200)&t;/* Mode of LED; values: */
DECL|macro|LEDMODE_NOT_SOOL
mdefine_line|#define     LEDMODE_NOT_SOOL&t;    (0)&t;&t;/*   !SOOL */
DECL|macro|LEDMODE_OFF
mdefine_line|#define&t;    LEDMODE_OFF&t;&t;    (1)&t;&t;/*   0     */
DECL|macro|LEDMODE_ON
mdefine_line|#define&t;    LEDMODE_ON&t;&t;    (2)&t;&t;/*   1     */
DECL|macro|LEDMODE_NOT_LOCD
mdefine_line|#define&t;    LEDMODE_NOT_LOCD&t;    (3)&t;&t;/*   !LOCD */
DECL|macro|LEDMORE_GPIN
mdefine_line|#define&t;    LEDMORE_GPIN&t;    (4)&t;&t;/*   GPIN  */
DECL|macro|LEDMODE_NOT_GPIN
mdefine_line|#define     LEDMODE_NOT_GPIN&t;    (7)&t;&t;/*   !GPIN */
DECL|macro|CONFIG1_MASK_LEDMODE
mdefine_line|#define   CONFIG1_MASK_LEDMODE&t; (0x00000E00)
DECL|macro|CONFIG1_GPOUT1
mdefine_line|#define   CONFIG1_GPOUT1&t; (0x00001000)&t;/* Toggle for reset */
DECL|macro|CONFIG1_GPOUT2
mdefine_line|#define   CONFIG1_GPOUT2&t; (0x00002000)&t;/* Loopback PHY */
DECL|macro|CONFIG1_GPOUT3
mdefine_line|#define   CONFIG1_GPOUT3&t; (0x00004000)&t;/* Loopback lanai */
DECL|enumerator|Config2_Reg
id|Config2_Reg
op_assign
l_int|0x30
comma
multiline_comment|/* Config word 2; bits: */
DECL|macro|CONFIG2_HOWMANY
mdefine_line|#define   CONFIG2_HOWMANY&t; (0x00000001)&t;/* &gt;512 VCIs? */
DECL|macro|CONFIG2_PTI7_MODE
mdefine_line|#define   CONFIG2_PTI7_MODE&t; (0x00000002)&t;/* Make PTI=7 RM, not OAM */
DECL|macro|CONFIG2_VPI_CHK_DIS
mdefine_line|#define   CONFIG2_VPI_CHK_DIS&t; (0x00000004)&t;/* Ignore RX VPI value */
DECL|macro|CONFIG2_HEC_DROP
mdefine_line|#define   CONFIG2_HEC_DROP&t; (0x00000008)&t;/* Drop cells w/ HEC errors */
DECL|macro|CONFIG2_VCI0_NORMAL
mdefine_line|#define   CONFIG2_VCI0_NORMAL&t; (0x00000010)&t;/* Treat VCI=0 normally */
DECL|macro|CONFIG2_CBR_ENABLE
mdefine_line|#define   CONFIG2_CBR_ENABLE&t; (0x00000020)&t;/* Deal with CBR traffic */
DECL|macro|CONFIG2_TRASH_ALL
mdefine_line|#define   CONFIG2_TRASH_ALL&t; (0x00000040)&t;/* Trashing incoming cells */
DECL|macro|CONFIG2_TX_DISABLE
mdefine_line|#define   CONFIG2_TX_DISABLE&t; (0x00000080)&t;/* Trashing outgoing cells */
DECL|macro|CONFIG2_SET_TRASH
mdefine_line|#define   CONFIG2_SET_TRASH&t; (0x00000100)&t;/* Turn trashing on */
DECL|enumerator|Statistics_Reg
id|Statistics_Reg
op_assign
l_int|0x34
comma
multiline_comment|/* Statistics; bits: */
DECL|macro|STATS_GET_FIFO_OVFL
mdefine_line|#define   STATS_GET_FIFO_OVFL(x)    (((x)&gt;&gt; 0)&amp;0xFF)&t;/* FIFO overflowed */
DECL|macro|STATS_GET_HEC_ERR
mdefine_line|#define   STATS_GET_HEC_ERR(x)      (((x)&gt;&gt; 8)&amp;0xFF)&t;/* HEC was bad */
DECL|macro|STATS_GET_BAD_VCI
mdefine_line|#define   STATS_GET_BAD_VCI(x)      (((x)&gt;&gt;16)&amp;0xFF)&t;/* VCI not open */
DECL|macro|STATS_GET_BUF_OVFL
mdefine_line|#define   STATS_GET_BUF_OVFL(x)     (((x)&gt;&gt;24)&amp;0xFF)&t;/* VCC buffer full */
DECL|enumerator|ServiceStuff_Reg
id|ServiceStuff_Reg
op_assign
l_int|0x38
comma
multiline_comment|/* Service stuff; bits: */
DECL|macro|SSTUFF_SET_SIZE
mdefine_line|#define   SSTUFF_SET_SIZE(x) ((x)*0x20000000)&t;/* size of service buffer */
DECL|macro|SSTUFF_SET_ADDR
mdefine_line|#define   SSTUFF_SET_ADDR(x)&t;    ((x)&gt;&gt;8)&t;/* set address of buffer */
DECL|enumerator|ServWrite_Reg
id|ServWrite_Reg
op_assign
l_int|0x3C
comma
multiline_comment|/* ServWrite Pointer */
DECL|enumerator|ServRead_Reg
id|ServRead_Reg
op_assign
l_int|0x40
comma
multiline_comment|/* ServRead Pointer */
DECL|enumerator|TxDepth_Reg
id|TxDepth_Reg
op_assign
l_int|0x44
comma
multiline_comment|/* FIFO Transmit Depth */
DECL|enumerator|Butt_Reg
id|Butt_Reg
op_assign
l_int|0x48
comma
multiline_comment|/* Butt register */
DECL|enumerator|CBR_ICG_Reg
id|CBR_ICG_Reg
op_assign
l_int|0x50
comma
DECL|enumerator|CBR_PTR_Reg
id|CBR_PTR_Reg
op_assign
l_int|0x54
comma
DECL|enumerator|PingCount_Reg
id|PingCount_Reg
op_assign
l_int|0x58
comma
multiline_comment|/* Ping count */
DECL|enumerator|DMA_Addr_Reg
id|DMA_Addr_Reg
op_assign
l_int|0x5C
multiline_comment|/* DMA address */
)brace
suffix:semicolon
DECL|function|reg_addr
r_static
r_inline
id|bus_addr_t
id|reg_addr
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_enum
id|lanai_register
id|reg
)paren
(brace
r_return
id|lanai-&gt;base
op_plus
(paren
id|bus_addr_t
)paren
id|reg
suffix:semicolon
)brace
DECL|function|reg_read
r_static
r_inline
id|u32
id|reg_read
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_enum
id|lanai_register
id|reg
)paren
(brace
id|u32
id|t
suffix:semicolon
id|t
op_assign
id|readl
c_func
(paren
id|reg_addr
c_func
(paren
id|lanai
comma
id|reg
)paren
)paren
suffix:semicolon
id|RWDEBUG
c_func
(paren
l_string|&quot;R [0x%08X] 0x%02X = 0x%08X&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|lanai-&gt;base
comma
(paren
r_int
)paren
id|reg
comma
id|t
)paren
suffix:semicolon
r_return
id|t
suffix:semicolon
)brace
DECL|function|reg_write
r_static
r_inline
r_void
id|reg_write
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|u32
id|val
comma
r_enum
id|lanai_register
id|reg
)paren
(brace
id|RWDEBUG
c_func
(paren
l_string|&quot;W [0x%08X] 0x%02X &lt; 0x%08X&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|lanai-&gt;base
comma
(paren
r_int
)paren
id|reg
comma
id|val
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|reg_addr
c_func
(paren
id|lanai
comma
id|reg
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|conf1_write
r_static
r_inline
r_void
id|conf1_write
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|reg_write
c_func
(paren
id|lanai
comma
id|lanai-&gt;conf1
comma
id|Config1_Reg
)paren
suffix:semicolon
)brace
DECL|function|conf2_write
r_static
r_inline
r_void
id|conf2_write
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|reg_write
c_func
(paren
id|lanai
comma
id|lanai-&gt;conf2
comma
id|Config2_Reg
)paren
suffix:semicolon
)brace
DECL|function|reset_board
r_static
r_inline
r_void
id|reset_board
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;about to reset board&bslash;n&quot;
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lanai
comma
l_int|0
comma
id|Reset_Reg
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If we don&squot;t delay a little while here then we can end up&n;&t; * leaving the card in a VERY weird state and lock up the&n;&t; * PCI bus.  This isn&squot;t documented anywhere but I&squot;ve convinced&n;&t; * myself after a lot of painful experimentation&n;&t; */
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- VCC LIST LOCK: */
multiline_comment|/*&n; * The linux-atm code disables local IRQs while managing the list of&n; * VCCs on a card.  This is good, but it doesn&squot;t save us against&n; * SMP.  Unfortunately, fixing this will require changes in the&n; * API which will have to wait a little bit.  It&squot;s a hard race to&n; * trigger accidentally, so it isn&squot;t TOO horrible so far.&n; *&n; * One possible solution would be to have an rwlock which is&n; * always grabbed _irq-style on writing.  This would automatically&n; * be grabbed (for writing) by the higher layers on things that&n; * would result in a change in the vcc list (_open, _close,&n; * probably _change_qos) - thus it would also protect the&n; * higher-level list of vccs on each device (atm_dev-&gt;vccs).&n; * The driver would be responsible for grabbing it as a read_lock&n; * anytime it wants to consult its table of vccs - for instance&n; * when handling an incoming PDU.  This also explains why we would&n; * probably want the write_lock while in _change_qos - to prevent&n; * handling of PDUs while possibly in an inconsistant state.&n; * Also, _send would grab the lock for reading.&n; *&n; * One problem with this is that _open and _close could no longer&n; * do anything that might provoke a schedule.  First, it would&n; * force us to use GFP_ATOMIC memory (which is bad), but also&n; * some devices pretty much require scheduling due to long&n; * delays (see lanai_close for an example).  So in this case&n; * we need a way to schedule without losing the spinlock.&n; * The cleanest way to do this is probably have a way to mark a&n; * VCC as &quot;in progress&quot; so that the interrupt handler can&n; * still disregard any traffic for it while _open or _close&n; * are sleeping on it.  Then it will need to be _open and&n; * _close&squot;s job to relinquish the write_lock.  Thus, the&n; * lock could be dropped around the times that scheduling&n; * might occur.  Perhaps the _READY flag can be used for&n; * this purpose.&n; *&n; * One short note about this &quot;upper layer grabs, driver&n; * relinquishes&quot; write lock - since this needs to be&n; * an _irq lock we&squot;re going to have problem saving&n; * and restoring flags (_irqsave/_irqrestore).  This&n; * shouldn&squot;t be a problem, however - we must just&n; * require that those syscalls are never called with&n; * interrupts disabled so we can use the non-flags-saving&n; * versions.&n; *&n; * Anyway, all of the above is vaporware currently - fixing&n; * this right will require changes in the API and all of&n; * the drivers - this will wait until 2.5.x most likely.&n; * The following NOP macros are just here to mark where&n; * the locks will be needed in the future.&n; */
DECL|macro|vcclist_read_lock
mdefine_line|#define vcclist_read_lock()&t;do {} while (0)
DECL|macro|vcclist_read_unlock
mdefine_line|#define vcclist_read_unlock()&t;do {} while (0)
DECL|macro|vcclist_write_lock
mdefine_line|#define vcclist_write_lock()&t;do {} while (0)
DECL|macro|vcclist_write_unlock
mdefine_line|#define vcclist_write_unlock()&t;do {} while (0)
multiline_comment|/* -------------------- CARD SRAM UTILITIES: */
multiline_comment|/* The SRAM is mapped into normal PCI memory space - the only catch is&n; * that it is only 16-bits wide but must be accessed as 32-bit.  The&n; * 16 high bits will be zero.  We don&squot;t hide this, since they get&n; * programmed mostly like discrete registers anyway&n; */
DECL|macro|SRAM_START
mdefine_line|#define SRAM_START (0x20000)
DECL|macro|SRAM_BYTES
mdefine_line|#define SRAM_BYTES (0x20000)&t;/* Again, half don&squot;t really exist */
DECL|function|sram_addr
r_static
r_inline
id|bus_addr_t
id|sram_addr
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_int
id|offset
)paren
(brace
r_return
id|lanai-&gt;base
op_plus
id|SRAM_START
op_plus
id|offset
suffix:semicolon
)brace
DECL|function|sram_read
r_static
r_inline
id|u32
id|sram_read
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_int
id|offset
)paren
(brace
r_return
id|readl
c_func
(paren
id|sram_addr
c_func
(paren
id|lanai
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
DECL|function|sram_write
r_static
r_inline
r_void
id|sram_write
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|u32
id|val
comma
r_int
id|offset
)paren
(brace
id|writel
c_func
(paren
id|val
comma
id|sram_addr
c_func
(paren
id|lanai
comma
id|offset
)paren
)paren
suffix:semicolon
)brace
DECL|function|sram_test_word
r_static
r_int
id|__init
id|sram_test_word
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_int
id|offset
comma
id|u32
id|pattern
)paren
(brace
id|u32
id|readback
suffix:semicolon
id|sram_write
c_func
(paren
id|lanai
comma
id|pattern
comma
id|offset
)paren
suffix:semicolon
id|readback
op_assign
id|sram_read
c_func
(paren
id|lanai
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readback
op_eq
id|pattern
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): SRAM word at %d bad: wrote 0x%X, read 0x%X&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|offset
comma
id|pattern
comma
id|readback
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|sram_test_pass
r_static
r_int
id|__init
id|sram_test_pass
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|u32
id|pattern
)paren
(brace
r_int
id|offset
comma
id|result
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|offset
op_assign
l_int|0
suffix:semicolon
id|offset
OL
id|SRAM_BYTES
op_logical_and
id|result
op_eq
l_int|0
suffix:semicolon
id|offset
op_add_assign
l_int|4
)paren
id|result
op_assign
id|sram_test_word
c_func
(paren
id|lanai
comma
id|offset
comma
id|pattern
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|sram_test_and_clear
r_static
r_int
id|__init
id|sram_test_and_clear
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
macro_line|#ifdef FULL_MEMORY_TEST
r_int
id|result
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;testing SRAM&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|sram_test_pass
c_func
(paren
id|lanai
comma
l_int|0x5555
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|sram_test_pass
c_func
(paren
id|lanai
comma
l_int|0xAAAA
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|result
suffix:semicolon
macro_line|#endif
id|DPRINTK
c_func
(paren
l_string|&quot;clearing SRAM&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|sram_test_pass
c_func
(paren
id|lanai
comma
l_int|0x0000
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- CARD-BASED VCC TABLE UTILITIES: */
multiline_comment|/* vcc table */
DECL|enum|lanai_vcc_offset
r_enum
id|lanai_vcc_offset
(brace
DECL|enumerator|vcc_rxaddr1
id|vcc_rxaddr1
op_assign
l_int|0x00
comma
multiline_comment|/* Location1, plus bits: */
DECL|macro|RXADDR1_SET_SIZE
mdefine_line|#define   RXADDR1_SET_SIZE(x) ((x)*0x0000100)&t;/* size of RX buffer */
DECL|macro|RXADDR1_SET_RMMODE
mdefine_line|#define   RXADDR1_SET_RMMODE(x) ((x)*0x00800)&t;/* RM cell action; values: */
DECL|macro|RMMODE_TRASH
mdefine_line|#define     RMMODE_TRASH&t;  (0)&t;&t;/*   discard */
DECL|macro|RMMODE_PRESERVE
mdefine_line|#define     RMMODE_PRESERVE&t;  (1)&t;&t;/*   input as AAL0 */
DECL|macro|RMMODE_PIPE
mdefine_line|#define     RMMODE_PIPE&t;&t;  (2)&t;&t;/*   pipe to coscheduler */
DECL|macro|RMMODE_PIPEALL
mdefine_line|#define     RMMODE_PIPEALL&t;  (3)&t;&t;/*   pipe non-RM too */
DECL|macro|RXADDR1_OAM_PRESERVE
mdefine_line|#define   RXADDR1_OAM_PRESERVE&t; (0x00002000)&t;/* Input OAM cells as AAL0 */
DECL|macro|RXADDR1_SET_MODE
mdefine_line|#define   RXADDR1_SET_MODE(x) ((x)*0x0004000)&t;/* Reassembly mode */
DECL|macro|RXMODE_TRASH
mdefine_line|#define     RXMODE_TRASH&t;  (0)&t;&t;/*   discard */
DECL|macro|RXMODE_AAL0
mdefine_line|#define     RXMODE_AAL0&t;&t;  (1)&t;&t;/*   non-AAL5 mode */
DECL|macro|RXMODE_AAL5
mdefine_line|#define     RXMODE_AAL5&t;&t;  (2)&t;&t;/*   AAL5, intr. each PDU */
DECL|macro|RXMODE_AAL5_STREAM
mdefine_line|#define     RXMODE_AAL5_STREAM&t;  (3)&t;&t;/*   AAL5 w/o per-PDU intr */
DECL|enumerator|vcc_rxaddr2
id|vcc_rxaddr2
op_assign
l_int|0x04
comma
multiline_comment|/* Location2 */
DECL|enumerator|vcc_rxcrc1
id|vcc_rxcrc1
op_assign
l_int|0x08
comma
multiline_comment|/* RX CRC claculation space */
DECL|enumerator|vcc_rxcrc2
id|vcc_rxcrc2
op_assign
l_int|0x0C
comma
DECL|enumerator|vcc_rxwriteptr
id|vcc_rxwriteptr
op_assign
l_int|0x10
comma
multiline_comment|/* RX writeptr, plus bits: */
DECL|macro|RXWRITEPTR_LASTEFCI
mdefine_line|#define   RXWRITEPTR_LASTEFCI&t; (0x00002000)&t;/* Last PDU had EFCI bit */
DECL|macro|RXWRITEPTR_DROPPING
mdefine_line|#define   RXWRITEPTR_DROPPING&t; (0x00004000)&t;/* Had error, dropping */
DECL|macro|RXWRITEPTR_TRASHING
mdefine_line|#define   RXWRITEPTR_TRASHING&t; (0x00008000)&t;/* Trashing */
DECL|enumerator|vcc_rxbufstart
id|vcc_rxbufstart
op_assign
l_int|0x14
comma
multiline_comment|/* RX bufstart, plus bits: */
DECL|macro|RXBUFSTART_CLP
mdefine_line|#define   RXBUFSTART_CLP&t; (0x00004000)
DECL|macro|RXBUFSTART_CI
mdefine_line|#define   RXBUFSTART_CI&t;&t; (0x00008000)
DECL|enumerator|vcc_rxreadptr
id|vcc_rxreadptr
op_assign
l_int|0x18
comma
multiline_comment|/* RX readptr */
DECL|enumerator|vcc_txicg
id|vcc_txicg
op_assign
l_int|0x1C
comma
multiline_comment|/* TX ICG */
DECL|enumerator|vcc_txaddr1
id|vcc_txaddr1
op_assign
l_int|0x20
comma
multiline_comment|/* Location1, plus bits: */
DECL|macro|TXADDR1_SET_SIZE
mdefine_line|#define   TXADDR1_SET_SIZE(x) ((x)*0x0000100)&t;/* size of TX buffer */
DECL|macro|TXADDR1_ABR
mdefine_line|#define   TXADDR1_ABR&t;&t; (0x00008000)&t;/* use ABR (doesn&squot;t work) */
DECL|enumerator|vcc_txaddr2
id|vcc_txaddr2
op_assign
l_int|0x24
comma
multiline_comment|/* Location2 */
DECL|enumerator|vcc_txcrc1
id|vcc_txcrc1
op_assign
l_int|0x28
comma
multiline_comment|/* TX CRC claculation space */
DECL|enumerator|vcc_txcrc2
id|vcc_txcrc2
op_assign
l_int|0x2C
comma
DECL|enumerator|vcc_txreadptr
id|vcc_txreadptr
op_assign
l_int|0x30
comma
multiline_comment|/* TX Readptr, plus bits: */
DECL|macro|TXREADPTR_GET_PTR
mdefine_line|#define   TXREADPTR_GET_PTR(x) ((x)&amp;0x01FFF)
DECL|macro|TXREADPTR_MASK_DELTA
mdefine_line|#define   TXREADPTR_MASK_DELTA&t;(0x0000E000)&t;/* ? */
DECL|enumerator|vcc_txendptr
id|vcc_txendptr
op_assign
l_int|0x34
comma
multiline_comment|/* TX Endptr, plus bits: */
DECL|macro|TXENDPTR_CLP
mdefine_line|#define   TXENDPTR_CLP&t;&t;(0x00002000)
DECL|macro|TXENDPTR_MASK_PDUMODE
mdefine_line|#define   TXENDPTR_MASK_PDUMODE&t;(0x0000C000)&t;/* PDU mode; values: */
DECL|macro|PDUMODE_AAL0
mdefine_line|#define     PDUMODE_AAL0&t; (0*0x04000)
DECL|macro|PDUMODE_AAL5
mdefine_line|#define     PDUMODE_AAL5&t; (2*0x04000)
DECL|macro|PDUMODE_AAL5STREAM
mdefine_line|#define     PDUMODE_AAL5STREAM&t; (3*0x04000)
DECL|enumerator|vcc_txwriteptr
id|vcc_txwriteptr
op_assign
l_int|0x38
comma
multiline_comment|/* TX Writeptr */
DECL|macro|TXWRITEPTR_GET_PTR
mdefine_line|#define   TXWRITEPTR_GET_PTR(x) ((x)&amp;0x1FFF)
DECL|enumerator|vcc_txcbr_next
id|vcc_txcbr_next
op_assign
l_int|0x3C
multiline_comment|/* # of next CBR VCI in ring */
DECL|macro|TXCBR_NEXT_BOZO
mdefine_line|#define   TXCBR_NEXT_BOZO&t;(0x00008000)&t;/* &quot;bozo bit&quot; */
)brace
suffix:semicolon
DECL|macro|CARDVCC_SIZE
mdefine_line|#define CARDVCC_SIZE&t;(0x40)
DECL|function|cardvcc_addr
r_static
r_inline
id|bus_addr_t
id|cardvcc_addr
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|vci_t
id|vci
)paren
(brace
r_return
id|sram_addr
c_func
(paren
id|lanai
comma
id|vci
op_star
id|CARDVCC_SIZE
)paren
suffix:semicolon
)brace
DECL|function|cardvcc_read
r_static
r_inline
id|u32
id|cardvcc_read
c_func
(paren
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_enum
id|lanai_vcc_offset
id|offset
)paren
(brace
id|u32
id|val
suffix:semicolon
id|APRINTK
c_func
(paren
id|lvcc-&gt;vbase
op_ne
l_int|0
comma
l_string|&quot;cardvcc_read: unbound vcc!&bslash;n&quot;
)paren
suffix:semicolon
id|val
op_assign
id|readl
c_func
(paren
id|lvcc-&gt;vbase
op_plus
(paren
id|bus_addr_t
)paren
id|offset
)paren
suffix:semicolon
id|RWDEBUG
c_func
(paren
l_string|&quot;VR vci=%04d 0x%02X = 0x%08X&bslash;n&quot;
comma
id|lvcc-&gt;vci
comma
(paren
r_int
)paren
id|offset
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|cardvcc_write
r_static
r_inline
r_void
id|cardvcc_write
c_func
(paren
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
id|u32
id|val
comma
r_enum
id|lanai_vcc_offset
id|offset
)paren
(brace
id|APRINTK
c_func
(paren
id|lvcc-&gt;vbase
op_ne
l_int|0
comma
l_string|&quot;cardvcc_write: unbound vcc!&bslash;n&quot;
)paren
suffix:semicolon
id|APRINTK
c_func
(paren
(paren
id|val
op_amp
op_complement
l_int|0xFFFF
)paren
op_eq
l_int|0
comma
l_string|&quot;cardvcc_write: bad val 0x%X (vci=%d, addr=0x%02X)&bslash;n&quot;
comma
id|val
comma
id|lvcc-&gt;vci
comma
(paren
r_int
)paren
id|offset
)paren
suffix:semicolon
id|RWDEBUG
c_func
(paren
l_string|&quot;VW vci=%04d 0x%02X &gt; 0x%08X&bslash;n&quot;
comma
id|lvcc-&gt;vci
comma
(paren
r_int
)paren
id|offset
comma
id|val
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|lvcc-&gt;vbase
op_plus
(paren
id|bus_addr_t
)paren
id|offset
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- COMPUTE SIZE OF AN AAL5 PDU: */
multiline_comment|/* How many bytes will an AAL5 PDU take to transmit - remember that:&n; *   o  we need to add 8 bytes for length, CPI, UU, and CRC&n; *   o  we need to round up to 48 bytes for cells&n; */
DECL|function|aal5_size
r_static
r_inline
r_int
id|aal5_size
c_func
(paren
r_int
id|size
)paren
(brace
r_int
id|cells
op_assign
(paren
id|size
op_plus
l_int|8
op_plus
l_int|47
)paren
op_div
l_int|48
suffix:semicolon
r_return
id|cells
op_star
l_int|48
suffix:semicolon
)brace
multiline_comment|/* How many bytes can we send if we have &quot;space&quot; space, assuming we have&n; * to send full cells&n; */
DECL|function|aal5_spacefor
r_static
r_inline
r_int
id|aal5_spacefor
c_func
(paren
r_int
id|space
)paren
(brace
r_int
id|cells
op_assign
id|space
op_div
l_int|48
suffix:semicolon
r_return
id|cells
op_star
l_int|48
suffix:semicolon
)brace
multiline_comment|/* -------------------- FREE AN ATM SKB: */
DECL|function|lanai_free_skb
r_static
r_inline
r_void
id|lanai_free_skb
c_func
(paren
r_struct
id|atm_vcc
op_star
id|atmvcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|atmvcc-&gt;pop
op_ne
l_int|NULL
)paren
id|atmvcc
op_member_access_from_pointer
id|pop
c_func
(paren
id|atmvcc
comma
id|skb
)paren
suffix:semicolon
r_else
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- TURN VCCS ON AND OFF: */
DECL|function|host_vcc_start_rx
r_static
r_void
id|host_vcc_start_rx
c_func
(paren
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
id|u32
id|addr1
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;rx.atmvcc-&gt;qos.aal
op_eq
id|ATM_AAL5
)paren
(brace
r_int
r_int
id|dmaaddr
op_assign
id|lanai_buf_dmaaddr
c_func
(paren
op_amp
id|lvcc-&gt;rx.buf
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0xFFFF
comma
id|vcc_rxcrc1
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0xFFFF
comma
id|vcc_rxcrc2
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxwriteptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxbufstart
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxreadptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
(paren
id|dmaaddr
op_rshift
l_int|16
)paren
op_amp
l_int|0xFFFF
comma
id|vcc_rxaddr2
)paren
suffix:semicolon
id|addr1
op_assign
(paren
(paren
id|dmaaddr
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
op_or
id|RXADDR1_SET_SIZE
c_func
(paren
id|lanai_buf_size_cardorder
c_func
(paren
op_amp
id|lvcc-&gt;rx.buf
)paren
)paren
op_or
id|RXADDR1_SET_RMMODE
c_func
(paren
id|RMMODE_TRASH
)paren
op_or
multiline_comment|/* ??? */
multiline_comment|/* RXADDR1_OAM_PRESERVE |&t;--- no OAM support yet */
id|RXADDR1_SET_MODE
c_func
(paren
id|RXMODE_AAL5
)paren
suffix:semicolon
)brace
r_else
id|addr1
op_assign
id|RXADDR1_SET_RMMODE
c_func
(paren
id|RMMODE_PRESERVE
)paren
op_or
multiline_comment|/* ??? */
id|RXADDR1_OAM_PRESERVE
op_or
multiline_comment|/* ??? */
id|RXADDR1_SET_MODE
c_func
(paren
id|RXMODE_AAL0
)paren
suffix:semicolon
multiline_comment|/* This one must be last! */
id|cardvcc_write
c_func
(paren
id|lvcc
comma
id|addr1
comma
id|vcc_rxaddr1
)paren
suffix:semicolon
)brace
DECL|function|host_vcc_start_tx
r_static
r_void
id|host_vcc_start_tx
c_func
(paren
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
r_int
r_int
id|dmaaddr
op_assign
id|lanai_buf_dmaaddr
c_func
(paren
op_amp
id|lvcc-&gt;tx.buf
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txicg
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0xFFFF
comma
id|vcc_txcrc1
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0xFFFF
comma
id|vcc_txcrc2
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txreadptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txendptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txwriteptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
(paren
id|lvcc-&gt;tx.atmvcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_CBR
)paren
ques
c_cond
id|TXCBR_NEXT_BOZO
op_or
id|lvcc-&gt;vci
suffix:colon
l_int|0
comma
id|vcc_txcbr_next
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
(paren
id|dmaaddr
op_rshift
l_int|16
)paren
op_amp
l_int|0xFFFF
comma
id|vcc_txaddr2
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
(paren
(paren
id|dmaaddr
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
)paren
op_or
id|TXADDR1_SET_SIZE
c_func
(paren
id|lanai_buf_size_cardorder
c_func
(paren
op_amp
id|lvcc-&gt;tx.buf
)paren
)paren
comma
id|vcc_txaddr1
)paren
suffix:semicolon
)brace
multiline_comment|/* Shutdown receiving on card */
DECL|function|lanai_shutdown_rx_vci
r_static
r_void
id|lanai_shutdown_rx_vci
c_func
(paren
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
r_if
c_cond
(paren
id|lvcc-&gt;vbase
op_eq
l_int|0
)paren
multiline_comment|/* We were never bound to a VCI */
r_return
suffix:semicolon
multiline_comment|/* 15.1.1 - set to trashing, wait one cell time (15us) */
id|cardvcc_write
c_func
(paren
id|lvcc
comma
id|RXADDR1_SET_RMMODE
c_func
(paren
id|RMMODE_TRASH
)paren
op_or
id|RXADDR1_SET_MODE
c_func
(paren
id|RXMODE_TRASH
)paren
comma
id|vcc_rxaddr1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
multiline_comment|/* 15.1.2 - clear rest of entries */
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxaddr2
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxcrc1
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxcrc2
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxwriteptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxbufstart
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_rxreadptr
)paren
suffix:semicolon
)brace
multiline_comment|/* Shutdown transmitting on card.&n; * Unfortunately the lanai needs us to wait until all the data&n; * drains out of the buffer before we can dealloc it, so this&n; * can take awhile -- up to 370ms for a full 128KB buffer&n; * assuming everone else is quiet.  In theory the time is&n; * boundless if there&squot;s a CBR VCC holding things up.&n; */
DECL|function|lanai_shutdown_tx_vci
r_static
r_void
id|lanai_shutdown_tx_vci
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
comma
id|timeout
suffix:semicolon
r_int
id|read
comma
id|write
comma
id|lastread
op_assign
op_minus
l_int|1
suffix:semicolon
id|APRINTK
c_func
(paren
op_logical_neg
id|in_interrupt
c_func
(paren
)paren
comma
l_string|&quot;lanai_shutdown_tx_vci called w/o process context!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;vbase
op_eq
l_int|0
)paren
multiline_comment|/* We were never bound to a VCI */
r_return
suffix:semicolon
multiline_comment|/* 15.2.1 - wait for queue to drain */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lanai-&gt;txlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;tx.inprogress
op_ne
l_int|NULL
)paren
(brace
id|lanai_free_skb
c_func
(paren
id|lvcc-&gt;tx.atmvcc
comma
id|lvcc-&gt;tx.inprogress
)paren
suffix:semicolon
id|lvcc-&gt;tx.inprogress
op_assign
l_int|NULL
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lvcc-&gt;tx.backlog
)paren
)paren
op_ne
l_int|NULL
)paren
id|lanai_free_skb
c_func
(paren
id|lvcc-&gt;tx.atmvcc
comma
id|skb
)paren
suffix:semicolon
id|vcc_unmark_backlogged
c_func
(paren
id|lanai
comma
id|lvcc
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lanai-&gt;txlock
comma
id|flags
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
(paren
(paren
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;tx.buf
)paren
op_star
id|HZ
)paren
op_rshift
l_int|17
)paren
suffix:semicolon
id|write
op_assign
id|TXWRITEPTR_GET_PTR
c_func
(paren
id|cardvcc_read
c_func
(paren
id|lvcc
comma
id|vcc_txwriteptr
)paren
)paren
suffix:semicolon
r_goto
id|start
suffix:semicolon
r_while
c_loop
(paren
id|time_before_eq
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|25
)paren
suffix:semicolon
id|start
suffix:colon
id|read
op_assign
id|TXREADPTR_GET_PTR
c_func
(paren
id|cardvcc_read
c_func
(paren
id|lvcc
comma
id|vcc_txreadptr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read
op_eq
id|write
op_logical_and
multiline_comment|/* Is TX buffer empty? */
(paren
id|lvcc-&gt;tx.atmvcc-&gt;qos.txtp.traffic_class
op_ne
id|ATM_CBR
op_logical_or
(paren
id|cardvcc_read
c_func
(paren
id|lvcc
comma
id|vcc_txcbr_next
)paren
op_amp
id|TXCBR_NEXT_BOZO
)paren
op_eq
l_int|0
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|read
op_ne
id|lastread
)paren
(brace
multiline_comment|/* Has there been any progress? */
id|lastread
op_assign
id|read
suffix:semicolon
id|timeout
op_add_assign
id|HZ
op_div
l_int|10
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): Timed out on backlog closing &quot;
l_string|&quot;vci %d&bslash;n&quot;
comma
id|lvcc-&gt;tx.atmvcc-&gt;dev-&gt;number
comma
id|lvcc-&gt;vci
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;read, write = %d, %d&bslash;n&quot;
comma
id|read
comma
id|write
)paren
suffix:semicolon
id|done
suffix:colon
multiline_comment|/* 15.2.2 - clear out all tx registers */
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txreadptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txwriteptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txendptr
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txcrc1
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txcrc2
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txaddr2
)paren
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|vcc_txaddr1
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- MANAGING AAL0 RX BUFFER: */
DECL|function|aal0_buffer_allocate
r_static
r_inline
r_int
id|aal0_buffer_allocate
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;aal0_buffer_allocate: allocating AAL0 RX buffer&bslash;n&quot;
)paren
suffix:semicolon
id|lanai_buf_allocate
c_func
(paren
op_amp
id|lanai-&gt;aal0buf
comma
id|AAL0_RX_BUFFER_SIZE
comma
l_int|80
)paren
suffix:semicolon
r_return
(paren
id|lanai-&gt;aal0buf.order
OL
l_int|0
)paren
ques
c_cond
op_minus
id|ENOMEM
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|aal0_buffer_free
r_static
r_inline
r_void
id|aal0_buffer_free
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;aal0_buffer_allocate: freeing AAL0 RX buffer&bslash;n&quot;
)paren
suffix:semicolon
id|lanai_buf_deallocate
c_func
(paren
op_amp
id|lanai-&gt;aal0buf
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- EEPROM UTILITIES: */
multiline_comment|/* Offsets of data in the EEPROM */
DECL|macro|EEPROM_COPYRIGHT
mdefine_line|#define EEPROM_COPYRIGHT&t;(0)
DECL|macro|EEPROM_COPYRIGHT_LEN
mdefine_line|#define EEPROM_COPYRIGHT_LEN&t;(44)
DECL|macro|EEPROM_CHECKSUM
mdefine_line|#define EEPROM_CHECKSUM&t;&t;(62)
DECL|macro|EEPROM_CHECKSUM_REV
mdefine_line|#define EEPROM_CHECKSUM_REV&t;(63)
DECL|macro|EEPROM_MAC
mdefine_line|#define EEPROM_MAC&t;&t;(64)
DECL|macro|EEPROM_MAC_REV
mdefine_line|#define EEPROM_MAC_REV&t;&t;(70)
DECL|macro|EEPROM_SERIAL
mdefine_line|#define EEPROM_SERIAL&t;&t;(112)
DECL|macro|EEPROM_SERIAL_REV
mdefine_line|#define EEPROM_SERIAL_REV&t;(116)
DECL|macro|EEPROM_MAGIC
mdefine_line|#define EEPROM_MAGIC&t;&t;(120)
DECL|macro|EEPROM_MAGIC_REV
mdefine_line|#define EEPROM_MAGIC_REV&t;(124)
DECL|macro|EEPROM_MAGIC_VALUE
mdefine_line|#define EEPROM_MAGIC_VALUE&t;(0x5AB478D2)
macro_line|#ifndef READ_EEPROM
multiline_comment|/* Stub functions to use if EEPROM reading is disabled */
DECL|function|eeprom_read
r_static
r_int
id|__init
id|eeprom_read
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;(itf %d): *NOT* reading EEPROM&bslash;n&quot;
comma
id|lanai-&gt;number
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|lanai-&gt;eeprom
(braket
id|EEPROM_MAC
)braket
comma
l_int|0
comma
l_int|6
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eeprom_validate
r_static
r_int
id|__init
id|eeprom_validate
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|lanai-&gt;serialno
op_assign
l_int|0
suffix:semicolon
id|lanai-&gt;magicno
op_assign
id|EEPROM_MAGIC_VALUE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else /* READ_EEPROM */
DECL|function|eeprom_read
r_static
r_int
id|__init
id|eeprom_read
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
r_int
id|i
comma
id|address
suffix:semicolon
id|u8
id|data
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
DECL|macro|set_config1
mdefine_line|#define set_config1(x)   do { lanai-&gt;conf1 = x; conf1_write(lanai); &bslash;&n;&t;&t;&t;    } while (0)
DECL|macro|clock_h
mdefine_line|#define clock_h()&t; set_config1(lanai-&gt;conf1 | CONFIG1_PROMCLK)
DECL|macro|clock_l
mdefine_line|#define clock_l()&t; set_config1(lanai-&gt;conf1 &amp;~ CONFIG1_PROMCLK)
DECL|macro|data_h
mdefine_line|#define data_h()&t; set_config1(lanai-&gt;conf1 | CONFIG1_PROMDATA)
DECL|macro|data_l
mdefine_line|#define data_l()&t; set_config1(lanai-&gt;conf1 &amp;~ CONFIG1_PROMDATA)
DECL|macro|pre_read
mdefine_line|#define pre_read()&t; do { data_h(); clock_h(); udelay(5); } while (0)
DECL|macro|read_pin
mdefine_line|#define read_pin()&t; (reg_read(lanai, Status_Reg) &amp; STATUS_PROMDATA)
DECL|macro|send_stop
mdefine_line|#define send_stop()&t; do { data_l(); udelay(5); clock_h(); udelay(5); &bslash;&n;&t;&t;&t;      data_h(); udelay(5); } while (0)
multiline_comment|/* start with both clock and data high */
id|data_h
c_func
(paren
)paren
suffix:semicolon
id|clock_h
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_for
c_loop
(paren
id|address
op_assign
l_int|0
suffix:semicolon
id|address
OL
id|LANAI_EEPROM_SIZE
suffix:semicolon
id|address
op_increment
)paren
(brace
id|data
op_assign
(paren
id|address
op_lshift
l_int|1
)paren
op_or
l_int|1
suffix:semicolon
multiline_comment|/* Command=read + address */
multiline_comment|/* send start bit */
id|data_l
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|clock_l
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|128
suffix:semicolon
id|i
op_ne
l_int|0
suffix:semicolon
id|i
op_rshift_assign
l_int|1
)paren
(brace
multiline_comment|/* write command out */
id|tmp
op_assign
(paren
id|lanai-&gt;conf1
op_amp
op_complement
id|CONFIG1_PROMDATA
)paren
op_or
(paren
id|data
op_amp
id|i
)paren
ques
c_cond
id|CONFIG1_PROMDATA
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lanai-&gt;conf1
op_ne
id|tmp
)paren
(brace
id|set_config1
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* Let new data settle */
)brace
id|clock_h
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|clock_l
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
multiline_comment|/* look for ack */
id|data_h
c_func
(paren
)paren
suffix:semicolon
id|clock_h
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_pin
c_func
(paren
)paren
op_ne
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* No ack seen */
id|clock_l
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* read back result */
r_for
c_loop
(paren
id|data
op_assign
l_int|0
comma
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|data_h
c_func
(paren
)paren
suffix:semicolon
id|clock_h
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|data
op_assign
(paren
id|data
op_lshift
l_int|1
)paren
op_or
op_logical_neg
op_logical_neg
id|read_pin
c_func
(paren
)paren
suffix:semicolon
id|clock_l
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
multiline_comment|/* look again for ack */
id|data_h
c_func
(paren
)paren
suffix:semicolon
id|clock_h
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_pin
c_func
(paren
)paren
op_eq
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* Spurious ack */
id|clock_l
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|send_stop
c_func
(paren
)paren
suffix:semicolon
id|lanai-&gt;eeprom
(braket
id|address
)braket
op_assign
id|data
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EEPROM 0x%04X %02X&bslash;n&quot;
comma
id|address
comma
id|data
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|clock_l
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* finish read */
id|send_stop
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): error reading EEPROM byte %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|address
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
DECL|macro|set_config1
macro_line|#undef set_config1
DECL|macro|clock_h
macro_line|#undef clock_h
DECL|macro|clock_l
macro_line|#undef clock_l
DECL|macro|data_h
macro_line|#undef data_h
DECL|macro|data_l
macro_line|#undef data_l
DECL|macro|pre_read
macro_line|#undef pre_read
DECL|macro|read_pin
macro_line|#undef read_pin
DECL|macro|send_stop
macro_line|#undef send_stop
)brace
multiline_comment|/* read a big-endian 4-byte value out of eeprom */
DECL|function|eeprom_be4
r_static
r_inline
id|u32
id|eeprom_be4
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_int
id|address
)paren
(brace
r_return
id|be32_to_cpup
c_func
(paren
(paren
id|u32
op_star
)paren
(paren
op_amp
id|lanai-&gt;eeprom
(braket
id|address
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Checksum/validate EEPROM contents */
DECL|function|eeprom_validate
r_static
r_int
id|__init
id|eeprom_validate
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
r_int
id|i
comma
id|s
suffix:semicolon
id|u32
id|v
suffix:semicolon
r_const
id|u8
op_star
id|e
op_assign
id|lanai-&gt;eeprom
suffix:semicolon
macro_line|#ifdef DEBUG
multiline_comment|/* First, see if we can get an ASCIIZ string out of the copyright */
r_for
c_loop
(paren
id|i
op_assign
id|EEPROM_COPYRIGHT
suffix:semicolon
id|i
OL
(paren
id|EEPROM_COPYRIGHT
op_plus
id|EEPROM_COPYRIGHT_LEN
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|e
(braket
id|i
)braket
template_param
l_int|0x7E
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|EEPROM_COPYRIGHT
op_logical_and
id|i
op_ne
id|EEPROM_COPYRIGHT
op_plus
id|EEPROM_COPYRIGHT_LEN
op_logical_and
id|e
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;eeprom: copyright = &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|e
(braket
id|EEPROM_COPYRIGHT
)braket
)paren
suffix:semicolon
r_else
id|DPRINTK
c_func
(paren
l_string|&quot;eeprom: copyright not found&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Validate checksum */
r_for
c_loop
(paren
id|i
op_assign
id|s
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|EEPROM_CHECKSUM
suffix:semicolon
id|i
op_increment
)paren
id|s
op_add_assign
id|e
(braket
id|i
)braket
suffix:semicolon
id|s
op_and_assign
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
id|s
op_ne
id|e
(braket
id|EEPROM_CHECKSUM
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): EEPROM checksum bad &quot;
l_string|&quot;(wanted 0x%02X, got 0x%02X)&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|s
comma
id|e
(braket
id|EEPROM_CHECKSUM
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|s
op_xor_assign
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
id|s
op_ne
id|e
(braket
id|EEPROM_CHECKSUM_REV
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): EEPROM inverse checksum &quot;
l_string|&quot;bad (wanted 0x%02X, got 0x%02X)&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|s
comma
id|e
(braket
id|EEPROM_CHECKSUM_REV
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Verify MAC address */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|e
(braket
id|EEPROM_MAC
op_plus
id|i
)braket
op_xor
id|e
(braket
id|EEPROM_MAC_REV
op_plus
id|i
)braket
)paren
op_ne
l_int|0xFF
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d) : EEPROM MAC addresses don&squot;t match &quot;
l_string|&quot;(0x%02X, inverse 0x%02X)&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|e
(braket
id|EEPROM_MAC
op_plus
id|i
)braket
comma
id|e
(braket
id|EEPROM_MAC_REV
op_plus
id|i
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;eeprom: MAC address = %02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|e
(braket
id|EEPROM_MAC
op_plus
l_int|0
)braket
comma
id|e
(braket
id|EEPROM_MAC
op_plus
l_int|1
)braket
comma
id|e
(braket
id|EEPROM_MAC
op_plus
l_int|2
)braket
comma
id|e
(braket
id|EEPROM_MAC
op_plus
l_int|3
)braket
comma
id|e
(braket
id|EEPROM_MAC
op_plus
l_int|4
)braket
comma
id|e
(braket
id|EEPROM_MAC
op_plus
l_int|5
)braket
)paren
suffix:semicolon
multiline_comment|/* Verify serial number */
id|lanai-&gt;serialno
op_assign
id|eeprom_be4
c_func
(paren
id|lanai
comma
id|EEPROM_SERIAL
)paren
suffix:semicolon
id|v
op_assign
id|eeprom_be4
c_func
(paren
id|lanai
comma
id|EEPROM_SERIAL_REV
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lanai-&gt;serialno
op_xor
id|v
)paren
op_ne
l_int|0xFFFFFFFF
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): EEPROM serial numbers &quot;
l_string|&quot;don&squot;t match (0x%08X, inverse 0x%08X)&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|lanai-&gt;serialno
comma
id|v
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;eeprom: Serial number = %d&bslash;n&quot;
comma
id|lanai-&gt;serialno
)paren
suffix:semicolon
multiline_comment|/* Verify magic number */
id|lanai-&gt;magicno
op_assign
id|eeprom_be4
c_func
(paren
id|lanai
comma
id|EEPROM_MAGIC
)paren
suffix:semicolon
id|v
op_assign
id|eeprom_be4
c_func
(paren
id|lanai
comma
id|EEPROM_MAGIC_REV
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lanai-&gt;magicno
op_xor
id|v
)paren
op_ne
l_int|0xFFFFFFFF
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): EEPROM magic numbers &quot;
l_string|&quot;don&squot;t match (0x%08X, inverse 0x%08X)&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|lanai-&gt;magicno
comma
id|v
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;eeprom: Magic number = 0x%08X&bslash;n&quot;
comma
id|lanai-&gt;magicno
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lanai-&gt;magicno
op_ne
id|EEPROM_MAGIC_VALUE
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|DEV_LABEL
l_string|&quot;(itf %d): warning - EEPROM &quot;
l_string|&quot;magic not what expected (got 0x%08X, not 0x%08X)&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|lanai-&gt;magicno
comma
id|EEPROM_MAGIC_VALUE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* READ_EEPROM */
DECL|function|eeprom_mac
r_static
r_inline
r_const
id|u8
op_star
id|eeprom_mac
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
r_return
op_amp
id|lanai-&gt;eeprom
(braket
id|EEPROM_MAC
)braket
suffix:semicolon
)brace
multiline_comment|/* -------------------- INTERRUPT HANDLING UTILITIES: */
multiline_comment|/* Interrupt types */
DECL|macro|INT_STATS
mdefine_line|#define INT_STATS&t;(0x00000002)&t;/* Statistics counter overflow */
DECL|macro|INT_SOOL
mdefine_line|#define INT_SOOL&t;(0x00000004)&t;/* SOOL changed state */
DECL|macro|INT_LOCD
mdefine_line|#define INT_LOCD&t;(0x00000008)&t;/* LOCD changed state */
DECL|macro|INT_LED
mdefine_line|#define INT_LED&t;&t;(0x00000010)&t;/* LED (HAPPI) changed state */
DECL|macro|INT_GPIN
mdefine_line|#define INT_GPIN&t;(0x00000020)&t;/* GPIN changed state */
DECL|macro|INT_PING
mdefine_line|#define INT_PING&t;(0x00000040)&t;/* PING_COUNT fulfilled */
DECL|macro|INT_WAKE
mdefine_line|#define INT_WAKE&t;(0x00000080)&t;/* Lanai wants bus */
DECL|macro|INT_CBR0
mdefine_line|#define INT_CBR0&t;(0x00000100)&t;/* CBR sched hit VCI 0 */
DECL|macro|INT_LOCK
mdefine_line|#define INT_LOCK&t;(0x00000200)&t;/* Service list overflow */
DECL|macro|INT_MISMATCH
mdefine_line|#define INT_MISMATCH&t;(0x00000400)&t;/* TX magic list mismatch */
DECL|macro|INT_AAL0_STR
mdefine_line|#define INT_AAL0_STR&t;(0x00000800)&t;/* Non-AAL5 buffer half filled */
DECL|macro|INT_AAL0
mdefine_line|#define INT_AAL0&t;(0x00001000)&t;/* Non-AAL5 data available */
DECL|macro|INT_SERVICE
mdefine_line|#define INT_SERVICE&t;(0x00002000)&t;/* Service list entries available */
DECL|macro|INT_TABORTSENT
mdefine_line|#define INT_TABORTSENT&t;(0x00004000)&t;/* Target abort sent by lanai */
DECL|macro|INT_TABORTBM
mdefine_line|#define INT_TABORTBM&t;(0x00008000)&t;/* Abort rcv&squot;d as bus master */
DECL|macro|INT_TIMEOUTBM
mdefine_line|#define INT_TIMEOUTBM&t;(0x00010000)&t;/* No response to bus master */
DECL|macro|INT_PCIPARITY
mdefine_line|#define INT_PCIPARITY&t;(0x00020000)&t;/* Parity error on PCI */
multiline_comment|/* Sets of the above */
DECL|macro|INT_ALL
mdefine_line|#define INT_ALL&t;&t;(0x0003FFFE)&t;/* All interrupts */
DECL|macro|INT_STATUS
mdefine_line|#define INT_STATUS&t;(0x0000003C)&t;/* Some status pin changed */
DECL|macro|INT_DMASHUT
mdefine_line|#define INT_DMASHUT&t;(0x00038000)&t;/* DMA engine got shut down */
DECL|macro|INT_SEGSHUT
mdefine_line|#define INT_SEGSHUT&t;(0x00000700)&t;/* Segmentation got shut down */
DECL|function|intr_pending
r_static
r_inline
id|u32
id|intr_pending
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
r_return
id|reg_read
c_func
(paren
id|lanai
comma
id|IntStatusMasked_Reg
)paren
suffix:semicolon
)brace
DECL|function|intr_enable
r_static
r_inline
r_void
id|intr_enable
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|u32
id|i
)paren
(brace
id|reg_write
c_func
(paren
id|lanai
comma
id|i
comma
id|IntControlEna_Reg
)paren
suffix:semicolon
)brace
DECL|function|intr_disable
r_static
r_inline
r_void
id|intr_disable
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|u32
id|i
)paren
(brace
id|reg_write
c_func
(paren
id|lanai
comma
id|i
comma
id|IntControlDis_Reg
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- CARD/PCI STATUS: */
DECL|function|status_message
r_static
r_void
id|status_message
c_func
(paren
r_int
id|itf
comma
r_const
r_char
op_star
id|name
comma
r_int
id|status
)paren
(brace
r_static
r_const
r_char
op_star
id|onoff
(braket
l_int|2
)braket
op_assign
(brace
l_string|&quot;off to on&quot;
comma
l_string|&quot;on to off&quot;
)brace
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;(itf %d): %s changed from %s&bslash;n&quot;
comma
id|itf
comma
id|name
comma
id|onoff
(braket
op_logical_neg
id|status
)braket
)paren
suffix:semicolon
)brace
DECL|function|lanai_check_status
r_static
r_void
id|lanai_check_status
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|u32
r_new
op_assign
id|reg_read
c_func
(paren
id|lanai
comma
id|Status_Reg
)paren
suffix:semicolon
id|u32
id|changes
op_assign
r_new
op_xor
id|lanai-&gt;status
suffix:semicolon
id|lanai-&gt;status
op_assign
r_new
suffix:semicolon
DECL|macro|e
mdefine_line|#define e(flag, name) &bslash;&n;&t;&t;if (changes &amp; flag) &bslash;&n;&t;&t;&t;status_message(lanai-&gt;number, name, new &amp; flag)
id|e
c_func
(paren
id|STATUS_SOOL
comma
l_string|&quot;SOOL&quot;
)paren
suffix:semicolon
id|e
c_func
(paren
id|STATUS_LOCD
comma
l_string|&quot;LOCD&quot;
)paren
suffix:semicolon
id|e
c_func
(paren
id|STATUS_LED
comma
l_string|&quot;LED&quot;
)paren
suffix:semicolon
id|e
c_func
(paren
id|STATUS_GPIN
comma
l_string|&quot;GPIN&quot;
)paren
suffix:semicolon
DECL|macro|e
macro_line|#undef e
)brace
DECL|function|pcistatus_got
r_static
r_void
id|pcistatus_got
c_func
(paren
r_int
id|itf
comma
r_const
r_char
op_star
id|name
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;(itf %d): PCI got %s error&bslash;n&quot;
comma
id|itf
comma
id|name
)paren
suffix:semicolon
)brace
DECL|function|pcistatus_check
r_static
r_void
id|pcistatus_check
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_int
id|clearonly
)paren
(brace
id|u16
id|s
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
id|pci_read_config_word
c_func
(paren
id|lanai-&gt;pci
comma
id|PCI_STATUS
comma
op_amp
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t read PCI_STATUS: &quot;
l_string|&quot;%d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|s
op_and_assign
id|PCI_STATUS_DETECTED_PARITY
op_or
id|PCI_STATUS_SIG_SYSTEM_ERROR
op_or
id|PCI_STATUS_REC_MASTER_ABORT
op_or
id|PCI_STATUS_REC_TARGET_ABORT
op_or
id|PCI_STATUS_SIG_TARGET_ABORT
op_or
id|PCI_STATUS_PARITY
suffix:semicolon
r_if
c_cond
(paren
id|s
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|result
op_assign
id|pci_write_config_word
c_func
(paren
id|lanai-&gt;pci
comma
id|PCI_STATUS
comma
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t write PCI_STATUS: &quot;
l_string|&quot;%d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clearonly
)paren
r_return
suffix:semicolon
DECL|macro|e
mdefine_line|#define e(flag, name, stat) &bslash;&n;&t;&t;if (s &amp; flag) { &bslash;&n;&t;&t;&t;pcistatus_got(lanai-&gt;number, name); &bslash;&n;&t;&t;&t;++lanai-&gt;stats.pcierr_##stat; &bslash;&n;&t;&t;}
id|e
c_func
(paren
id|PCI_STATUS_DETECTED_PARITY
comma
l_string|&quot;parity&quot;
comma
id|parity_detect
)paren
suffix:semicolon
id|e
c_func
(paren
id|PCI_STATUS_SIG_SYSTEM_ERROR
comma
l_string|&quot;signalled system&quot;
comma
id|serr_set
)paren
suffix:semicolon
id|e
c_func
(paren
id|PCI_STATUS_REC_MASTER_ABORT
comma
l_string|&quot;master&quot;
comma
id|master_abort
)paren
suffix:semicolon
id|e
c_func
(paren
id|PCI_STATUS_REC_TARGET_ABORT
comma
l_string|&quot;master target&quot;
comma
id|m_target_abort
)paren
suffix:semicolon
id|e
c_func
(paren
id|PCI_STATUS_SIG_TARGET_ABORT
comma
l_string|&quot;slave&quot;
comma
id|s_target_abort
)paren
suffix:semicolon
id|e
c_func
(paren
id|PCI_STATUS_PARITY
comma
l_string|&quot;master parity&quot;
comma
id|master_parity
)paren
suffix:semicolon
DECL|macro|e
macro_line|#undef e
)brace
multiline_comment|/* -------------------- VCC TX BUFFER UTILITIES: */
multiline_comment|/* space left in tx buffer in bytes */
DECL|function|vcc_tx_space
r_static
r_inline
r_int
id|vcc_tx_space
c_func
(paren
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_int
id|endptr
)paren
(brace
r_int
id|r
suffix:semicolon
id|r
op_assign
id|endptr
op_star
l_int|16
suffix:semicolon
id|r
op_sub_assign
(paren
(paren
r_int
r_int
)paren
id|lvcc-&gt;tx.buf.ptr
)paren
op_minus
(paren
(paren
r_int
r_int
)paren
id|lvcc-&gt;tx.buf.start
)paren
suffix:semicolon
id|r
op_sub_assign
l_int|16
suffix:semicolon
multiline_comment|/* Leave &quot;bubble&quot; - if start==end it looks empty */
r_if
c_cond
(paren
id|r
OL
l_int|0
)paren
id|r
op_add_assign
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;tx.buf
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* Bit fields in the segmentation buffer descriptor */
DECL|macro|DESCRIPTOR_MAGIC
mdefine_line|#define DESCRIPTOR_MAGIC&t;(0xD0000000)
DECL|macro|DESCRIPTOR_AAL5
mdefine_line|#define DESCRIPTOR_AAL5&t;&t;(0x00008000)
DECL|macro|DESCRIPTOR_AAL5_STREAM
mdefine_line|#define DESCRIPTOR_AAL5_STREAM&t;(0x00004000)
DECL|macro|DESCRIPTOR_CLP
mdefine_line|#define DESCRIPTOR_CLP&t;&t;(0x00002000)
multiline_comment|/* Add 32-bit descriptor with it&squot;s padding */
DECL|function|vcc_tx_add_aal5_descriptor
r_static
r_inline
r_void
id|vcc_tx_add_aal5_descriptor
c_func
(paren
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
id|u32
id|flags
comma
r_int
id|len
)paren
(brace
r_int
id|pos
suffix:semicolon
id|APRINTK
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|lvcc-&gt;tx.buf.ptr
)paren
op_amp
l_int|15
)paren
op_eq
l_int|0
comma
l_string|&quot;vcc_tx_add_aal5_descriptor: bad ptr=%p&bslash;n&quot;
comma
id|lvcc-&gt;tx.buf.ptr
)paren
suffix:semicolon
id|lvcc-&gt;tx.buf.ptr
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* Hope the values REALLY don&squot;t matter */
id|pos
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.ptr
)paren
op_minus
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.start
suffix:semicolon
id|APRINTK
c_func
(paren
(paren
id|pos
op_amp
op_complement
l_int|0x0001FFF0
)paren
op_eq
l_int|0
comma
l_string|&quot;vcc_tx_add_aal5_descriptor: bad pos (%d) before, vci=%d, &quot;
l_string|&quot;start,ptr,end=%p,%p,%p&bslash;n&quot;
comma
id|pos
comma
id|lvcc-&gt;vci
comma
id|lvcc-&gt;tx.buf.start
comma
id|lvcc-&gt;tx.buf.ptr
comma
id|lvcc-&gt;tx.buf.end
)paren
suffix:semicolon
id|pos
op_assign
(paren
id|pos
op_plus
id|len
)paren
op_amp
(paren
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;tx.buf
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|APRINTK
c_func
(paren
(paren
id|pos
op_amp
op_complement
l_int|0x0001FFF0
)paren
op_eq
l_int|0
comma
l_string|&quot;vcc_tx_add_aal5_descriptor: bad pos (%d) after, vci=%d, &quot;
l_string|&quot;start,ptr,end=%p,%p,%p&bslash;n&quot;
comma
id|pos
comma
id|lvcc-&gt;vci
comma
id|lvcc-&gt;tx.buf.start
comma
id|lvcc-&gt;tx.buf.ptr
comma
id|lvcc-&gt;tx.buf.end
)paren
suffix:semicolon
id|lvcc-&gt;tx.buf.ptr
(braket
op_minus
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|DESCRIPTOR_MAGIC
op_or
id|DESCRIPTOR_AAL5
op_or
(paren
(paren
id|lvcc-&gt;tx.atmvcc-&gt;atm_options
op_amp
id|ATM_ATMOPT_CLP
)paren
ques
c_cond
id|DESCRIPTOR_CLP
suffix:colon
l_int|0
)paren
op_or
id|flags
op_or
id|pos
op_rshift
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;tx.buf.ptr
op_ge
id|lvcc-&gt;tx.buf.end
)paren
id|lvcc-&gt;tx.buf.ptr
op_assign
id|lvcc-&gt;tx.buf.start
suffix:semicolon
)brace
multiline_comment|/* Add 32-bit AAL5 trailer and leave room for its CRC */
DECL|function|vcc_tx_add_aal5trailer
r_static
r_inline
r_void
id|vcc_tx_add_aal5trailer
c_func
(paren
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_int
id|len
comma
r_int
id|cpi
comma
r_int
id|uu
)paren
(brace
id|APRINTK
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|lvcc-&gt;tx.buf.ptr
)paren
op_amp
l_int|15
)paren
op_eq
l_int|8
comma
l_string|&quot;vcc_tx_add_aal5_descriptor: bad ptr=%p&bslash;n&quot;
comma
id|lvcc-&gt;tx.buf.ptr
)paren
suffix:semicolon
id|lvcc-&gt;tx.buf.ptr
op_add_assign
l_int|2
suffix:semicolon
id|lvcc-&gt;tx.buf.ptr
(braket
op_minus
l_int|2
)braket
op_assign
id|cpu_to_be32
c_func
(paren
(paren
id|uu
op_lshift
l_int|24
)paren
op_or
(paren
id|cpi
op_lshift
l_int|16
)paren
op_or
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;tx.buf.ptr
op_ge
id|lvcc-&gt;tx.buf.end
)paren
id|lvcc-&gt;tx.buf.ptr
op_assign
id|lvcc-&gt;tx.buf.start
suffix:semicolon
)brace
DECL|function|vcc_tx_memcpy
r_static
r_inline
r_void
id|vcc_tx_memcpy
c_func
(paren
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_const
r_int
r_char
op_star
id|src
comma
r_int
id|n
)paren
(brace
r_int
r_char
op_star
id|e
suffix:semicolon
r_int
id|m
suffix:semicolon
id|e
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.ptr
)paren
op_plus
id|n
suffix:semicolon
id|m
op_assign
id|e
op_minus
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.end
suffix:semicolon
r_if
c_cond
(paren
id|m
OL
l_int|0
)paren
id|m
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|lvcc-&gt;tx.buf.ptr
comma
id|src
comma
id|n
op_minus
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|lvcc-&gt;tx.buf.start
comma
id|src
op_plus
id|n
op_minus
id|m
comma
id|m
)paren
suffix:semicolon
id|e
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.start
)paren
op_plus
id|m
suffix:semicolon
)brace
id|lvcc-&gt;tx.buf.ptr
op_assign
(paren
id|u32
op_star
)paren
id|e
suffix:semicolon
)brace
DECL|function|vcc_tx_memzero
r_static
r_inline
r_void
id|vcc_tx_memzero
c_func
(paren
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_int
id|n
)paren
(brace
r_int
r_char
op_star
id|e
suffix:semicolon
r_int
id|m
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|e
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.ptr
)paren
op_plus
id|n
suffix:semicolon
id|m
op_assign
id|e
op_minus
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.end
suffix:semicolon
r_if
c_cond
(paren
id|m
OL
l_int|0
)paren
id|m
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|lvcc-&gt;tx.buf.ptr
comma
l_int|0
comma
id|n
op_minus
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
op_ne
l_int|0
)paren
(brace
id|memset
c_func
(paren
id|lvcc-&gt;tx.buf.start
comma
l_int|0
comma
id|m
)paren
suffix:semicolon
id|e
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.start
)paren
op_plus
id|m
suffix:semicolon
)brace
id|lvcc-&gt;tx.buf.ptr
op_assign
(paren
id|u32
op_star
)paren
id|e
suffix:semicolon
)brace
multiline_comment|/* Update &quot;butt&quot; register to specify new WritePtr */
DECL|function|lanai_endtx
r_static
r_inline
r_void
id|lanai_endtx
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
r_int
id|i
comma
id|ptr
op_assign
(paren
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.ptr
)paren
op_minus
(paren
r_int
r_char
op_star
)paren
id|lvcc-&gt;tx.buf.start
suffix:semicolon
id|APRINTK
c_func
(paren
(paren
id|ptr
op_amp
op_complement
l_int|0x0001FFF0
)paren
op_eq
l_int|0
comma
l_string|&quot;lanai_endtx: bad ptr (%d), vci=%d, start,ptr,end=%p,%p,%p&bslash;n&quot;
comma
id|ptr
comma
id|lvcc-&gt;vci
comma
id|lvcc-&gt;tx.buf.start
comma
id|lvcc-&gt;tx.buf.ptr
comma
id|lvcc-&gt;tx.buf.end
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We need to check if the &quot;butt busy&quot; bit is set before&n;&t; * updating the butt register.  In theory this should&n;&t; * never happen because the ATM card is plenty fast at&n;&t; * updating the register.  Still, we should make sure&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|reg_read
c_func
(paren
id|lanai
comma
id|Status_Reg
)paren
op_amp
id|STATUS_BUTTBUSY
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|50
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): butt register &quot;
l_string|&quot;always busy!&bslash;n&quot;
comma
id|lanai-&gt;number
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|lanai
comma
(paren
id|ptr
op_lshift
l_int|12
)paren
op_or
id|lvcc-&gt;vci
comma
id|Butt_Reg
)paren
suffix:semicolon
)brace
multiline_comment|/* Try to fill the buffer - don&squot;t call unless there is backlog */
DECL|function|vcc_tx_unqueue_aal5
r_static
r_void
id|vcc_tx_unqueue_aal5
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_int
id|endptr
)paren
(brace
r_int
id|pad
comma
id|n
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|space
op_assign
id|vcc_tx_space
c_func
(paren
id|lvcc
comma
id|endptr
)paren
suffix:semicolon
id|APRINTK
c_func
(paren
id|vcc_is_backlogged
c_func
(paren
id|lvcc
)paren
comma
l_string|&quot;vcc_tx_unqueue() called with empty backlog (vci=%d)&bslash;n&quot;
comma
id|lvcc-&gt;vci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|space
OL
l_int|64
)paren
r_return
suffix:semicolon
multiline_comment|/* No space for even 1 cell+descriptor */
r_if
c_cond
(paren
id|lvcc-&gt;tx.inprogress
op_ne
l_int|NULL
)paren
(brace
id|APRINTK
c_func
(paren
(paren
id|lvcc-&gt;tx.inprogleft
op_mod
l_int|48
)paren
op_eq
l_int|0
comma
l_string|&quot;vcc_tx_unqueue_aal5: bad progleft=%d&bslash;n&quot;
comma
id|lvcc-&gt;tx.inprogleft
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;tx.inprogleft
op_plus
l_int|16
OG
id|space
)paren
(brace
multiline_comment|/* Can&squot;t send all? */
id|n
op_assign
id|aal5_spacefor
c_func
(paren
id|space
op_minus
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Bytes to send */
id|vcc_tx_add_aal5_descriptor
c_func
(paren
id|lvcc
comma
id|DESCRIPTOR_AAL5_STREAM
comma
id|n
)paren
suffix:semicolon
id|pad
op_assign
id|lvcc-&gt;tx.pptr
op_plus
id|n
op_minus
id|lvcc-&gt;tx.inprogress-&gt;tail
suffix:semicolon
r_if
c_cond
(paren
id|pad
OL
l_int|0
)paren
id|pad
op_assign
l_int|0
suffix:semicolon
id|vcc_tx_memcpy
c_func
(paren
id|lvcc
comma
id|lvcc-&gt;tx.pptr
comma
id|n
op_minus
id|pad
)paren
suffix:semicolon
id|vcc_tx_memzero
c_func
(paren
id|lvcc
comma
id|pad
)paren
suffix:semicolon
id|lvcc-&gt;tx.pptr
op_add_assign
id|n
suffix:semicolon
id|lvcc-&gt;tx.inprogleft
op_sub_assign
id|n
suffix:semicolon
r_goto
id|end
suffix:semicolon
multiline_comment|/* Buffer is now full */
)brace
multiline_comment|/* OK, there&squot;s at least space for all of &quot;inprogress&quot; skb */
id|vcc_tx_add_aal5_descriptor
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|lvcc-&gt;tx.inprogleft
)paren
suffix:semicolon
id|pad
op_assign
id|lvcc-&gt;tx.pptr
op_plus
id|lvcc-&gt;tx.inprogleft
op_minus
id|lvcc-&gt;tx.inprogress-&gt;tail
suffix:semicolon
r_if
c_cond
(paren
id|pad
op_ge
id|lvcc-&gt;tx.inprogleft
)paren
(brace
multiline_comment|/* Nothing but pad left */
id|APRINTK
c_func
(paren
id|lvcc-&gt;tx.inprogleft
op_eq
l_int|48
comma
l_string|&quot;vcc_tx_unqueue_aal5: bad pure-pad=%d&bslash;n&quot;
comma
id|lvcc-&gt;tx.inprogleft
)paren
suffix:semicolon
id|pad
op_assign
l_int|48
suffix:semicolon
)brace
r_else
id|vcc_tx_memcpy
c_func
(paren
id|lvcc
comma
id|lvcc-&gt;tx.pptr
comma
id|lvcc-&gt;tx.inprogleft
op_minus
id|pad
)paren
suffix:semicolon
id|vcc_tx_memzero
c_func
(paren
id|lvcc
comma
id|pad
op_minus
l_int|8
)paren
suffix:semicolon
id|vcc_tx_add_aal5trailer
c_func
(paren
id|lvcc
comma
id|lvcc-&gt;tx.inprogress-&gt;len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|lanai_free_skb
c_func
(paren
id|lvcc-&gt;tx.atmvcc
comma
id|lvcc-&gt;tx.inprogress
)paren
suffix:semicolon
id|lvcc-&gt;tx.inprogress
op_assign
l_int|NULL
suffix:semicolon
id|space
op_sub_assign
id|lvcc-&gt;tx.inprogleft
op_plus
l_int|16
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lvcc-&gt;tx.atmvcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|space
op_ge
l_int|64
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|lvcc-&gt;tx.backlog
)paren
)paren
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|n
op_assign
id|aal5_size
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_plus
l_int|16
OG
id|space
)paren
(brace
multiline_comment|/* Can only send part */
r_int
id|m
op_assign
id|aal5_spacefor
c_func
(paren
id|space
op_minus
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Bytes to send */
id|vcc_tx_add_aal5_descriptor
c_func
(paren
id|lvcc
comma
id|DESCRIPTOR_AAL5_STREAM
comma
id|m
)paren
suffix:semicolon
id|lvcc-&gt;tx.pptr
op_assign
id|skb-&gt;data
op_plus
id|m
suffix:semicolon
id|pad
op_assign
id|lvcc-&gt;tx.pptr
op_minus
id|skb-&gt;tail
suffix:semicolon
r_if
c_cond
(paren
id|pad
OL
l_int|0
)paren
id|pad
op_assign
l_int|0
suffix:semicolon
id|vcc_tx_memcpy
c_func
(paren
id|lvcc
comma
id|skb-&gt;data
comma
id|m
op_minus
id|pad
)paren
suffix:semicolon
id|vcc_tx_memzero
c_func
(paren
id|lvcc
comma
id|pad
)paren
suffix:semicolon
id|lvcc-&gt;tx.inprogleft
op_assign
id|n
op_minus
id|m
suffix:semicolon
id|lvcc-&gt;tx.inprogress
op_assign
id|skb
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|vcc_tx_add_aal5_descriptor
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|n
)paren
suffix:semicolon
id|pad
op_assign
id|n
op_minus
id|skb-&gt;len
op_minus
l_int|8
suffix:semicolon
id|vcc_tx_memcpy
c_func
(paren
id|lvcc
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|vcc_tx_memzero
c_func
(paren
id|lvcc
comma
id|pad
)paren
suffix:semicolon
id|lanai_free_skb
c_func
(paren
id|lvcc-&gt;tx.atmvcc
comma
id|skb
)paren
suffix:semicolon
id|vcc_tx_add_aal5trailer
c_func
(paren
id|lvcc
comma
id|skb-&gt;len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|space
op_sub_assign
id|n
op_plus
l_int|16
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lvcc-&gt;tx.atmvcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_queue_empty
c_func
(paren
op_amp
id|lvcc-&gt;tx.backlog
)paren
)paren
id|vcc_unmark_backlogged
c_func
(paren
id|lanai
comma
id|lvcc
)paren
suffix:semicolon
id|end
suffix:colon
id|lanai_endtx
c_func
(paren
id|lanai
comma
id|lvcc
)paren
suffix:semicolon
)brace
multiline_comment|/* Given an skb that we want to transmit either send it now or queue */
DECL|function|vcc_tx_aal5
r_static
r_void
id|vcc_tx_aal5
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|space
comma
id|n
comma
id|pad
suffix:semicolon
r_if
c_cond
(paren
id|vcc_is_backlogged
c_func
(paren
id|lvcc
)paren
)paren
multiline_comment|/* Already backlogged */
r_goto
id|queue_it
suffix:semicolon
id|space
op_assign
id|vcc_tx_space
c_func
(paren
id|lvcc
comma
id|TXREADPTR_GET_PTR
c_func
(paren
id|cardvcc_read
c_func
(paren
id|lvcc
comma
id|vcc_txreadptr
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|space
OL
l_int|64
)paren
(brace
id|vcc_mark_backlogged
c_func
(paren
id|lanai
comma
id|lvcc
)paren
suffix:semicolon
multiline_comment|/* No space */
r_goto
id|queue_it
suffix:semicolon
)brace
r_if
c_cond
(paren
id|space
op_ge
l_int|16
op_plus
(paren
id|n
op_assign
id|aal5_size
c_func
(paren
id|skb-&gt;len
)paren
)paren
)paren
(brace
multiline_comment|/* We can send the whole thing now */
id|vcc_tx_add_aal5_descriptor
c_func
(paren
id|lvcc
comma
l_int|0
comma
id|n
)paren
suffix:semicolon
id|pad
op_assign
id|n
op_minus
id|skb-&gt;len
suffix:semicolon
id|vcc_tx_memcpy
c_func
(paren
id|lvcc
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|vcc_tx_memzero
c_func
(paren
id|lvcc
comma
id|pad
op_minus
l_int|8
)paren
suffix:semicolon
id|vcc_tx_add_aal5trailer
c_func
(paren
id|lvcc
comma
id|skb-&gt;len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|lanai_free_skb
c_func
(paren
id|lvcc-&gt;tx.atmvcc
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lvcc-&gt;tx.atmvcc-&gt;stats-&gt;tx
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Space for only part of skb */
r_int
id|bytes
op_assign
id|aal5_spacefor
c_func
(paren
id|space
op_minus
l_int|16
)paren
suffix:semicolon
multiline_comment|/* Bytes to send */
id|vcc_tx_add_aal5_descriptor
c_func
(paren
id|lvcc
comma
id|DESCRIPTOR_AAL5_STREAM
comma
id|bytes
)paren
suffix:semicolon
id|pad
op_assign
id|bytes
op_minus
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|pad
OL
l_int|0
)paren
id|pad
op_assign
l_int|0
suffix:semicolon
id|vcc_tx_memcpy
c_func
(paren
id|lvcc
comma
id|skb-&gt;data
comma
id|bytes
op_minus
id|pad
)paren
suffix:semicolon
id|vcc_tx_memzero
c_func
(paren
id|lvcc
comma
id|pad
)paren
suffix:semicolon
id|lvcc-&gt;tx.inprogress
op_assign
id|skb
suffix:semicolon
id|lvcc-&gt;tx.inprogleft
op_assign
id|n
op_minus
id|bytes
suffix:semicolon
id|lvcc-&gt;tx.pptr
op_assign
id|skb-&gt;data
op_plus
id|bytes
suffix:semicolon
id|vcc_mark_backlogged
c_func
(paren
id|lanai
comma
id|lvcc
)paren
suffix:semicolon
)brace
id|lanai_endtx
c_func
(paren
id|lanai
comma
id|lvcc
)paren
suffix:semicolon
r_return
suffix:semicolon
id|queue_it
suffix:colon
id|skb_queue_tail
c_func
(paren
op_amp
id|lvcc-&gt;tx.backlog
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|vcc_tx_unqueue_aal0
r_static
r_void
id|vcc_tx_unqueue_aal0
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_int
id|endptr
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;: vcc_tx_unqueue_aal0: not implemented&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|vcc_tx_aal0
r_static
r_void
id|vcc_tx_aal0
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;: vcc_tx_aal0: not implemented&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Remember to increment lvcc-&gt;tx.atmvcc-&gt;stats-&gt;tx */
id|lanai_free_skb
c_func
(paren
id|lvcc-&gt;tx.atmvcc
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* Try to undequeue 1 backlogged vcc */
DECL|function|iter_dequeue
r_static
r_void
id|iter_dequeue
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|vci_t
id|vci
)paren
(brace
r_struct
id|lanai_vcc
op_star
id|lvcc
op_assign
id|lanai-&gt;vccs
(braket
id|vci
)braket
suffix:semicolon
r_int
id|endptr
suffix:semicolon
r_if
c_cond
(paren
id|lvcc
op_eq
l_int|NULL
op_logical_or
op_logical_neg
id|vcc_is_backlogged
c_func
(paren
id|lvcc
)paren
)paren
(brace
id|vci_bitfield_clear
c_func
(paren
op_amp
id|lanai-&gt;backlog_vccs
comma
id|vci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|endptr
op_assign
id|TXREADPTR_GET_PTR
c_func
(paren
id|cardvcc_read
c_func
(paren
id|lvcc
comma
id|vcc_txreadptr
)paren
)paren
suffix:semicolon
id|lvcc-&gt;tx
dot
id|unqueue
c_func
(paren
id|lanai
comma
id|lvcc
comma
id|endptr
)paren
suffix:semicolon
)brace
multiline_comment|/* Try a dequeue on all backlogged connections */
DECL|function|vcc_tx_dequeue_all
r_static
r_inline
r_void
id|vcc_tx_dequeue_all
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lanai-&gt;txlock
comma
id|flags
)paren
suffix:semicolon
id|vci_bitfield_iterate
c_func
(paren
id|lanai
comma
op_amp
id|lanai-&gt;backlog_vccs
comma
id|iter_dequeue
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lanai-&gt;txlock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- VCC RX BUFFER UTILITIES: */
multiline_comment|/* unlike the _tx_ cousins, this doesn&squot;t update ptr */
DECL|function|vcc_rx_memcpy
r_static
r_inline
r_void
id|vcc_rx_memcpy
c_func
(paren
r_int
r_char
op_star
id|dest
comma
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_int
id|n
)paren
(brace
r_int
id|m
op_assign
(paren
(paren
r_const
r_int
r_char
op_star
)paren
id|lvcc-&gt;rx.buf.ptr
)paren
op_plus
id|n
op_minus
(paren
(paren
r_const
r_int
r_char
op_star
)paren
(paren
id|lvcc-&gt;rx.buf.end
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m
OL
l_int|0
)paren
id|m
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|dest
comma
id|lvcc-&gt;rx.buf.ptr
comma
id|n
op_minus
id|m
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dest
op_plus
id|n
op_minus
id|m
comma
id|lvcc-&gt;rx.buf.start
comma
id|m
)paren
suffix:semicolon
)brace
multiline_comment|/* Receive AAL5 data on a VCC with a particular endptr */
DECL|function|vcc_rx_aal5
r_static
r_void
id|vcc_rx_aal5
c_func
(paren
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_int
id|endptr
)paren
(brace
r_int
id|size
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/*const*/
id|u32
op_star
id|x
comma
op_star
id|end
op_assign
op_amp
id|lvcc-&gt;rx.buf.start
(braket
id|endptr
op_star
l_int|4
)braket
suffix:semicolon
r_int
id|n
op_assign
(paren
(paren
r_int
r_int
)paren
id|end
)paren
op_minus
(paren
(paren
r_int
r_int
)paren
id|lvcc-&gt;rx.buf.ptr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
id|n
op_add_assign
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;rx.buf
)paren
suffix:semicolon
id|APRINTK
c_func
(paren
id|n
op_ge
l_int|0
op_logical_and
id|n
OL
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;rx.buf
)paren
op_logical_and
op_logical_neg
(paren
id|n
op_amp
l_int|15
)paren
comma
l_string|&quot;vcc_rx_aal5: n out of range (%d/%d)&bslash;n&quot;
comma
id|n
comma
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;rx.buf
)paren
)paren
suffix:semicolon
multiline_comment|/* Recover the second-to-last word to get true pdu length */
r_if
c_cond
(paren
(paren
id|x
op_assign
op_amp
id|end
(braket
op_minus
l_int|2
)braket
)paren
OL
id|lvcc-&gt;rx.buf.start
)paren
id|x
op_assign
op_amp
id|lvcc-&gt;rx.buf.end
(braket
op_minus
l_int|2
)braket
suffix:semicolon
id|size
op_assign
id|be32_to_cpup
c_func
(paren
id|x
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
id|aal5_size
c_func
(paren
id|size
)paren
)paren
(brace
multiline_comment|/* Make sure size matches padding */
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;(itf %d): Got bad AAL5 length &quot;
l_string|&quot;on vci=%d - size=%d n=%d&bslash;n&quot;
comma
id|lvcc-&gt;rx.atmvcc-&gt;dev-&gt;number
comma
id|lvcc-&gt;vci
comma
id|size
comma
id|n
)paren
suffix:semicolon
id|lvcc-&gt;stats.x.aal5.rx_badlen
op_increment
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|skb
op_assign
id|atm_alloc_charge
c_func
(paren
id|lvcc-&gt;rx.atmvcc
comma
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|lvcc-&gt;stats.rx_nomem
op_increment
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|lvcc-&gt;rx.atmvcc
suffix:semicolon
id|skb-&gt;stamp
op_assign
id|xtime
suffix:semicolon
id|vcc_rx_memcpy
c_func
(paren
id|skb-&gt;data
comma
id|lvcc
comma
id|size
)paren
suffix:semicolon
id|lvcc-&gt;rx.atmvcc
op_member_access_from_pointer
id|push
c_func
(paren
id|lvcc-&gt;rx.atmvcc
comma
id|skb
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lvcc-&gt;rx.atmvcc-&gt;stats-&gt;rx
)paren
suffix:semicolon
id|out
suffix:colon
id|lvcc-&gt;rx.buf.ptr
op_assign
id|end
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
id|endptr
comma
id|vcc_rxreadptr
)paren
suffix:semicolon
)brace
DECL|function|vcc_rx_aal0
r_static
r_void
id|vcc_rx_aal0
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;: vcc_rx_aal0: not implemented&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Remember to get vcclist_read_lock while looking up VC */
multiline_comment|/* Remember to increment lvcc-&gt;rx.atmvcc-&gt;stats-&gt;rx */
)brace
multiline_comment|/* -------------------- MANAGING HOST-BASED VCC TABLE: */
multiline_comment|/* Decide whether to use vmalloc or get_free_page for VCC table */
macro_line|#if (NUM_VCI * BITS_PER_LONG) &lt;= PAGE_SIZE
DECL|macro|VCCTABLE_GETFREEPAGE
mdefine_line|#define VCCTABLE_GETFREEPAGE
macro_line|#else
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#endif
DECL|function|vcc_table_allocate
r_static
r_int
id|__init
id|vcc_table_allocate
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
macro_line|#ifdef VCCTABLE_GETFREEPAGE
id|APRINTK
c_func
(paren
(paren
id|lanai-&gt;num_vci
)paren
op_star
r_sizeof
(paren
r_struct
id|lanai_vcc
op_star
)paren
op_le
id|PAGE_SIZE
comma
l_string|&quot;vcc table &gt; PAGE_SIZE!&quot;
)paren
suffix:semicolon
id|lanai-&gt;vccs
op_assign
(paren
r_struct
id|lanai_vcc
op_star
op_star
)paren
id|get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_return
(paren
id|lanai-&gt;vccs
op_eq
l_int|NULL
)paren
ques
c_cond
op_minus
id|ENOMEM
suffix:colon
l_int|0
suffix:semicolon
macro_line|#else
r_int
id|bytes
op_assign
(paren
id|lanai-&gt;num_vci
)paren
op_star
r_sizeof
(paren
r_struct
id|lanai_vcc
op_star
)paren
suffix:semicolon
id|lanai-&gt;vccs
op_assign
(paren
r_struct
id|lanai_vcc
op_star
op_star
)paren
id|vmalloc
c_func
(paren
id|bytes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lanai-&gt;vccs
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|lanai-&gt;vccs
comma
l_int|0
comma
id|bytes
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
DECL|function|vcc_table_deallocate
r_static
r_inline
r_void
id|vcc_table_deallocate
c_func
(paren
r_const
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
macro_line|#ifdef VCCTABLE_GETFREEPAGE
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|lanai-&gt;vccs
)paren
suffix:semicolon
macro_line|#else
id|vfree
c_func
(paren
id|lanai-&gt;vccs
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Allocate a fresh lanai_vcc, with the appropriate things cleared */
DECL|function|new_lanai_vcc
r_static
r_inline
r_struct
id|lanai_vcc
op_star
id|new_lanai_vcc
c_func
(paren
r_void
)paren
(brace
r_struct
id|lanai_vcc
op_star
id|lvcc
suffix:semicolon
id|lvcc
op_assign
(paren
r_struct
id|lanai_vcc
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|lvcc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc
op_ne
l_int|NULL
)paren
(brace
id|lvcc-&gt;vbase
op_assign
l_int|0
suffix:semicolon
id|lvcc-&gt;rx.atmvcc
op_assign
id|lvcc-&gt;tx.atmvcc
op_assign
l_int|NULL
suffix:semicolon
id|lvcc-&gt;nref
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|lvcc-&gt;stats
comma
l_int|0
comma
r_sizeof
id|lvcc-&gt;stats
)paren
suffix:semicolon
id|lvcc-&gt;rx.buf.start
op_assign
id|lvcc-&gt;tx.buf.start
op_assign
l_int|NULL
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|lvcc-&gt;tx.backlog
)paren
suffix:semicolon
id|lvcc-&gt;tx.inprogress
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef DEBUG
id|lvcc-&gt;tx.unqueue
op_assign
l_int|NULL
suffix:semicolon
id|lvcc-&gt;vci
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_return
id|lvcc
suffix:semicolon
)brace
DECL|function|lanai_get_sized_buffer
r_static
r_int
id|lanai_get_sized_buffer
c_func
(paren
r_int
id|number
comma
r_struct
id|lanai_buffer
op_star
id|buf
comma
r_int
id|max_sdu
comma
r_int
id|multiplier
comma
r_int
id|min
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|size
suffix:semicolon
r_if
c_cond
(paren
id|max_sdu
OL
l_int|1
)paren
id|max_sdu
op_assign
l_int|1
suffix:semicolon
id|max_sdu
op_assign
id|aal5_size
c_func
(paren
id|max_sdu
)paren
suffix:semicolon
id|size
op_assign
(paren
id|max_sdu
op_plus
l_int|16
)paren
op_star
id|multiplier
op_plus
l_int|16
suffix:semicolon
id|lanai_buf_allocate
c_func
(paren
id|buf
comma
id|size
comma
id|min
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;order
OL
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|lanai_buf_size
c_func
(paren
id|buf
)paren
OL
id|size
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|DEV_LABEL
l_string|&quot;(itf %d): wanted %d bytes &quot;
l_string|&quot;for %s buffer, got only %d&bslash;n&quot;
comma
id|number
comma
id|size
comma
id|name
comma
id|lanai_buf_size
c_func
(paren
id|buf
)paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Allocated %d byte %s buffer&bslash;n&quot;
comma
id|lanai_buf_size
c_func
(paren
id|buf
)paren
comma
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Setup a RX buffer for a currently unbound AAL5 vci */
DECL|function|lanai_setup_rx_vci_aal5
r_static
r_inline
r_int
id|lanai_setup_rx_vci_aal5
c_func
(paren
r_int
id|number
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_const
r_struct
id|atm_qos
op_star
id|qos
)paren
(brace
r_return
id|lanai_get_sized_buffer
c_func
(paren
id|number
comma
op_amp
id|lvcc-&gt;rx.buf
comma
id|qos-&gt;rxtp.max_sdu
comma
id|AAL5_RX_MULTIPLIER
comma
id|qos-&gt;rxtp.max_sdu
op_plus
l_int|32
comma
l_string|&quot;RX&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup a TX buffer for a currently unbound AAL5 vci */
DECL|function|lanai_setup_tx_vci
r_static
r_int
id|lanai_setup_tx_vci
c_func
(paren
r_int
id|number
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
r_const
r_struct
id|atm_qos
op_star
id|qos
)paren
(brace
r_int
id|max_sdu
comma
id|multiplier
suffix:semicolon
r_if
c_cond
(paren
id|qos-&gt;aal
op_eq
id|ATM_AAL0
)paren
(brace
id|lvcc-&gt;tx.unqueue
op_assign
id|vcc_tx_unqueue_aal0
suffix:semicolon
id|max_sdu
op_assign
id|ATM_CELL_SIZE
op_minus
l_int|1
suffix:semicolon
id|multiplier
op_assign
id|AAL0_TX_MULTIPLIER
suffix:semicolon
)brace
r_else
(brace
id|lvcc-&gt;tx.unqueue
op_assign
id|vcc_tx_unqueue_aal5
suffix:semicolon
id|max_sdu
op_assign
id|qos-&gt;txtp.max_sdu
suffix:semicolon
id|multiplier
op_assign
id|AAL5_TX_MULTIPLIER
suffix:semicolon
)brace
r_return
id|lanai_get_sized_buffer
c_func
(paren
id|number
comma
op_amp
id|lvcc-&gt;tx.buf
comma
id|max_sdu
comma
id|multiplier
comma
l_int|80
comma
l_string|&quot;TX&quot;
)paren
suffix:semicolon
)brace
DECL|function|host_vcc_bind
r_static
r_inline
r_void
id|host_vcc_bind
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
comma
id|vci_t
id|vci
)paren
(brace
r_if
c_cond
(paren
id|lvcc-&gt;vbase
op_ne
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* We already were bound in the other direction */
id|DPRINTK
c_func
(paren
l_string|&quot;Binding vci %d&bslash;n&quot;
comma
id|vci
)paren
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
r_if
c_cond
(paren
id|lanai-&gt;nbound
op_increment
op_eq
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Coming out of powerdown&bslash;n&quot;
)paren
suffix:semicolon
id|lanai-&gt;conf1
op_and_assign
op_complement
id|CONFIG1_POWERDOWN
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|conf2_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
macro_line|#endif
id|lvcc-&gt;vbase
op_assign
id|cardvcc_addr
c_func
(paren
id|lanai
comma
id|vci
)paren
suffix:semicolon
id|lanai-&gt;vccs
(braket
id|lvcc-&gt;vci
op_assign
id|vci
)braket
op_assign
id|lvcc
suffix:semicolon
)brace
DECL|function|host_vcc_unbind
r_static
r_inline
r_void
id|host_vcc_unbind
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_struct
id|lanai_vcc
op_star
id|lvcc
)paren
(brace
r_if
c_cond
(paren
id|lvcc-&gt;vbase
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* This vcc was never bound */
id|DPRINTK
c_func
(paren
l_string|&quot;Unbinding vci %d&bslash;n&quot;
comma
id|lvcc-&gt;vci
)paren
suffix:semicolon
id|lvcc-&gt;vbase
op_assign
l_int|0
suffix:semicolon
id|lanai-&gt;vccs
(braket
id|lvcc-&gt;vci
)braket
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
r_if
c_cond
(paren
op_decrement
id|lanai-&gt;nbound
op_eq
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Going into powerdown&bslash;n&quot;
)paren
suffix:semicolon
id|lanai-&gt;conf1
op_or_assign
id|CONFIG1_POWERDOWN
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
multiline_comment|/* -------------------- RESET CARD: */
DECL|function|lanai_reset
r_static
r_void
id|lanai_reset
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;(itf %d): *NOT* reseting - not &quot;
l_string|&quot;implemented&bslash;n&quot;
comma
id|lanai-&gt;number
)paren
suffix:semicolon
multiline_comment|/* TODO */
multiline_comment|/* The following is just a hack until we write the real&n;&t; * resetter - at least ack whatever interrupt sent us&n;&t; * here&n;&t; */
id|reg_write
c_func
(paren
id|lanai
comma
id|INT_ALL
comma
id|IntAck_Reg
)paren
suffix:semicolon
id|lanai-&gt;stats.card_reset
op_increment
suffix:semicolon
)brace
multiline_comment|/* -------------------- SERVICE LIST UTILITIES: */
multiline_comment|/*&n; * Allocate service buffer and tell card about it&n; */
DECL|function|service_buffer_allocate
r_static
r_int
id|__init
id|service_buffer_allocate
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|lanai_buf_allocate
c_func
(paren
op_amp
id|lanai-&gt;service
comma
id|SERVICE_ENTRIES
op_star
l_int|4
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lanai-&gt;service.order
OL
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;allocated service buffer at 0x%08lX, size %d(%d)&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|lanai-&gt;service.start
comma
id|lanai_buf_size
c_func
(paren
op_amp
id|lanai-&gt;service
)paren
comma
id|lanai_buf_size_cardorder
c_func
(paren
op_amp
id|lanai-&gt;service
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear ServWrite register to be safe */
id|reg_write
c_func
(paren
id|lanai
comma
l_int|0
comma
id|ServWrite_Reg
)paren
suffix:semicolon
multiline_comment|/* ServiceStuff register contains size and address of buffer */
id|reg_write
c_func
(paren
id|lanai
comma
id|SSTUFF_SET_SIZE
c_func
(paren
id|lanai_buf_size_cardorder
c_func
(paren
op_amp
id|lanai-&gt;service
)paren
)paren
op_or
id|SSTUFF_SET_ADDR
c_func
(paren
id|lanai_buf_dmaaddr
c_func
(paren
op_amp
id|lanai-&gt;service
)paren
)paren
comma
id|ServiceStuff_Reg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|service_buffer_deallocate
r_static
r_inline
r_void
id|service_buffer_deallocate
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|lanai_buf_deallocate
c_func
(paren
op_amp
id|lanai-&gt;service
)paren
suffix:semicolon
)brace
multiline_comment|/* Bitfields in service list */
DECL|macro|SERVICE_TX
mdefine_line|#define SERVICE_TX&t;(0x80000000)&t;/* Was from transmission */
DECL|macro|SERVICE_TRASH
mdefine_line|#define SERVICE_TRASH&t;(0x40000000)&t;/* RXed PDU was trashed */
DECL|macro|SERVICE_CRCERR
mdefine_line|#define SERVICE_CRCERR&t;(0x20000000)&t;/* RXed PDU had CRC error */
DECL|macro|SERVICE_CI
mdefine_line|#define SERVICE_CI&t;(0x10000000)&t;/* RXed PDU had CI set */
DECL|macro|SERVICE_CLP
mdefine_line|#define SERVICE_CLP&t;(0x08000000)&t;/* RXed PDU had CLP set */
DECL|macro|SERVICE_STREAM
mdefine_line|#define SERVICE_STREAM&t;(0x04000000)&t;/* RX Stream mode */
DECL|macro|SERVICE_GET_VCI
mdefine_line|#define SERVICE_GET_VCI(x) (((x)&gt;&gt;16)&amp;0x3FF)
DECL|macro|SERVICE_GET_END
mdefine_line|#define SERVICE_GET_END(x) ((x)&amp;0x1FFF)
multiline_comment|/* Handle one thing from the service list - returns true if it marked a&n; * VCC ready for xmit&n; */
DECL|function|handle_service
r_static
r_int
id|handle_service
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|u32
id|s
)paren
(brace
id|vci_t
id|vci
op_assign
id|SERVICE_GET_VCI
c_func
(paren
id|s
)paren
suffix:semicolon
r_struct
id|lanai_vcc
op_star
id|lvcc
suffix:semicolon
id|vcclist_read_lock
c_func
(paren
)paren
suffix:semicolon
id|lvcc
op_assign
id|lanai-&gt;vccs
(braket
id|vci
)braket
suffix:semicolon
r_if
c_cond
(paren
id|lvcc
op_eq
l_int|NULL
)paren
(brace
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;(itf %d) got service entry 0x%X for nonexistent &quot;
l_string|&quot;vcc %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|s
comma
id|vci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_amp
id|SERVICE_TX
)paren
id|lanai-&gt;stats.service_novcc_tx
op_increment
suffix:semicolon
r_else
id|lanai-&gt;stats.service_novcc_rx
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SERVICE_TX
)paren
(brace
multiline_comment|/* segmentation interrupt */
r_if
c_cond
(paren
id|lvcc-&gt;tx.atmvcc
op_eq
l_int|NULL
)paren
(brace
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;(itf %d) got service entry 0x%X for non-TX &quot;
l_string|&quot;vcc %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|s
comma
id|vci
)paren
suffix:semicolon
id|lanai-&gt;stats.service_notx
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|vci_bitfield_set
c_func
(paren
op_amp
id|lanai-&gt;transmit_ready
comma
id|vci
)paren
suffix:semicolon
id|lvcc-&gt;tx.endptr
op_assign
id|SERVICE_GET_END
c_func
(paren
id|s
)paren
suffix:semicolon
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lvcc-&gt;rx.atmvcc
op_eq
l_int|NULL
)paren
(brace
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;(itf %d) got service entry 0x%X for non-RX &quot;
l_string|&quot;vcc %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|s
comma
id|vci
)paren
suffix:semicolon
id|lanai-&gt;stats.service_norx
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lvcc-&gt;rx.atmvcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
(brace
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;(itf %d) got RX service entry 0x%X for non-AAL5 &quot;
l_string|&quot;vcc %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|s
comma
id|vci
)paren
suffix:semicolon
id|lanai-&gt;stats.service_rxnotaal5
op_increment
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lvcc-&gt;rx.atmvcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|s
op_amp
(paren
id|SERVICE_TRASH
op_or
id|SERVICE_STREAM
op_or
id|SERVICE_CRCERR
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|vcc_rx_aal5
c_func
(paren
id|lvcc
comma
id|SERVICE_GET_END
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SERVICE_TRASH
)paren
(brace
r_int
id|bytes
suffix:semicolon
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;got trashed rx pdu on vci %d&bslash;n&quot;
comma
id|vci
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lvcc-&gt;rx.atmvcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|lvcc-&gt;stats.x.aal5.service_trash
op_increment
suffix:semicolon
id|bytes
op_assign
(paren
id|SERVICE_GET_END
c_func
(paren
id|s
)paren
op_star
l_int|16
)paren
op_minus
(paren
(paren
(paren
r_int
r_int
)paren
id|lvcc-&gt;rx.buf.ptr
)paren
op_minus
(paren
(paren
r_int
r_int
)paren
id|lvcc-&gt;rx.buf.start
)paren
)paren
op_plus
l_int|47
suffix:semicolon
r_if
c_cond
(paren
id|bytes
OL
l_int|0
)paren
id|bytes
op_add_assign
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;rx.buf
)paren
suffix:semicolon
id|lanai-&gt;stats.ovfl_trash
op_add_assign
(paren
id|bytes
op_div
l_int|48
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
op_amp
id|SERVICE_STREAM
)paren
(brace
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lvcc-&gt;rx.atmvcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|lvcc-&gt;stats.x.aal5.service_stream
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): Got AAL5 stream &quot;
l_string|&quot;PDU on VCI %d!&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|vci
)paren
suffix:semicolon
id|lanai_reset
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;got rx crc error on vci %d&bslash;n&quot;
comma
id|vci
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lvcc-&gt;rx.atmvcc-&gt;stats-&gt;rx_err
)paren
suffix:semicolon
id|lvcc-&gt;stats.x.aal5.service_rxcrc
op_increment
suffix:semicolon
id|lvcc-&gt;rx.buf.ptr
op_assign
op_amp
id|lvcc-&gt;rx.buf.start
(braket
id|SERVICE_GET_END
c_func
(paren
id|s
)paren
op_star
l_int|4
)braket
suffix:semicolon
id|cardvcc_write
c_func
(paren
id|lvcc
comma
id|SERVICE_GET_END
c_func
(paren
id|s
)paren
comma
id|vcc_rxreadptr
)paren
suffix:semicolon
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Try transmitting on all VCIs that we marked ready to serve */
DECL|function|iter_transmit
r_static
r_void
id|iter_transmit
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|vci_t
id|vci
)paren
(brace
r_struct
id|lanai_vcc
op_star
id|lvcc
op_assign
id|lanai-&gt;vccs
(braket
id|vci
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vcc_is_backlogged
c_func
(paren
id|lvcc
)paren
)paren
r_return
suffix:semicolon
id|lvcc-&gt;tx
dot
id|unqueue
c_func
(paren
id|lanai
comma
id|lvcc
comma
id|lvcc-&gt;tx.endptr
)paren
suffix:semicolon
)brace
multiline_comment|/* Run service queue -- called from interrupt context or with&n; * interrupts otherwise disabled and with the lanai-&gt;servicelock&n; * lock held&n; */
DECL|function|run_service
r_static
r_void
id|run_service
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
r_int
id|ntx
op_assign
l_int|0
suffix:semicolon
id|u32
id|wreg
op_assign
id|reg_read
c_func
(paren
id|lanai
comma
id|ServWrite_Reg
)paren
suffix:semicolon
r_const
id|u32
op_star
id|end
op_assign
id|lanai-&gt;service.start
op_plus
id|wreg
suffix:semicolon
r_while
c_loop
(paren
id|lanai-&gt;service.ptr
op_ne
id|end
)paren
(brace
id|ntx
op_add_assign
id|handle_service
c_func
(paren
id|lanai
comma
id|le32_to_cpup
c_func
(paren
id|lanai-&gt;service.ptr
op_increment
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lanai-&gt;service.ptr
op_ge
id|lanai-&gt;service.end
)paren
id|lanai-&gt;service.ptr
op_assign
id|lanai-&gt;service.start
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|lanai
comma
id|wreg
comma
id|ServRead_Reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ntx
op_ne
l_int|0
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|lanai-&gt;txlock
)paren
suffix:semicolon
id|vcclist_read_lock
c_func
(paren
)paren
suffix:semicolon
id|vci_bitfield_iterate
c_func
(paren
id|lanai
comma
op_amp
id|lanai-&gt;transmit_ready
comma
id|iter_transmit
)paren
suffix:semicolon
id|vci_bitfield_init
c_func
(paren
op_amp
id|lanai-&gt;transmit_ready
)paren
suffix:semicolon
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lanai-&gt;txlock
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* -------------------- GATHER STATISTICS: */
DECL|function|get_statistics
r_static
r_void
id|get_statistics
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|u32
id|statreg
op_assign
id|reg_read
c_func
(paren
id|lanai
comma
id|Statistics_Reg
)paren
suffix:semicolon
id|lanai-&gt;stats.atm_ovfl
op_add_assign
id|STATS_GET_FIFO_OVFL
c_func
(paren
id|statreg
)paren
suffix:semicolon
id|lanai-&gt;stats.hec_err
op_add_assign
id|STATS_GET_HEC_ERR
c_func
(paren
id|statreg
)paren
suffix:semicolon
id|lanai-&gt;stats.vci_trash
op_add_assign
id|STATS_GET_BAD_VCI
c_func
(paren
id|statreg
)paren
suffix:semicolon
id|lanai-&gt;stats.ovfl_trash
op_add_assign
id|STATS_GET_BUF_OVFL
c_func
(paren
id|statreg
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- POLLING TIMER: */
DECL|function|lanai_timed_poll
r_static
r_void
id|lanai_timed_poll
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
macro_line|#ifndef DEBUG_RW
r_struct
id|lanai_dev
op_star
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|arg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
r_if
c_cond
(paren
id|lanai-&gt;conf1
op_amp
id|CONFIG1_POWERDOWN
)paren
r_return
suffix:semicolon
macro_line|#endif
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lanai-&gt;servicelock
comma
id|flags
)paren
suffix:semicolon
id|run_service
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lanai-&gt;servicelock
comma
id|flags
)paren
suffix:semicolon
id|vcc_tx_dequeue_all
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|get_statistics
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|lanai-&gt;timer
comma
id|jiffies
op_plus
id|LANAI_POLL_PERIOD
)paren
suffix:semicolon
macro_line|#endif /* DEBUG_RW */
)brace
DECL|function|lanai_timed_poll_start
r_static
r_inline
r_void
id|lanai_timed_poll_start
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|lanai-&gt;timer
)paren
suffix:semicolon
id|lanai-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|LANAI_POLL_PERIOD
suffix:semicolon
id|lanai-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|lanai
suffix:semicolon
id|lanai-&gt;timer.function
op_assign
id|lanai_timed_poll
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|lanai-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|lanai_timed_poll_stop
r_static
r_inline
r_void
id|lanai_timed_poll_stop
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|lanai-&gt;timer
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- INTERRUPT SERVICE: */
DECL|function|lanai_int_1
r_static
r_inline
r_void
id|lanai_int_1
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|u32
id|reason
)paren
(brace
id|u32
id|ack
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
id|INT_SERVICE
)paren
(brace
id|ack
op_assign
id|INT_SERVICE
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lanai-&gt;servicelock
)paren
suffix:semicolon
id|run_service
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lanai-&gt;servicelock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_amp
(paren
id|INT_AAL0_STR
op_or
id|INT_AAL0
)paren
)paren
(brace
id|ack
op_or_assign
id|reason
op_amp
(paren
id|INT_AAL0_STR
op_or
id|INT_AAL0
)paren
suffix:semicolon
id|vcc_rx_aal0
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_amp
id|INT_STATS
)paren
(brace
id|reason
op_and_assign
op_complement
id|INT_STATS
suffix:semicolon
multiline_comment|/* No need to ack */
id|get_statistics
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_amp
id|INT_STATUS
)paren
(brace
id|ack
op_or_assign
id|reason
op_amp
id|INT_STATUS
suffix:semicolon
id|lanai_check_status
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_amp
id|INT_DMASHUT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): driver error - DMA &quot;
l_string|&quot;shutdown, reason=0x%08X, address=0x%08X&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|reason
op_amp
id|INT_DMASHUT
comma
id|reg_read
c_func
(paren
id|lanai
comma
id|DMA_Addr_Reg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reason
op_amp
id|INT_TABORTBM
)paren
(brace
id|lanai_reset
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ack
op_or_assign
(paren
id|reason
op_amp
id|INT_DMASHUT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): re-enabling DMA&bslash;n&quot;
comma
id|lanai-&gt;number
)paren
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|lanai-&gt;stats.dma_reenable
op_increment
suffix:semicolon
id|pcistatus_check
c_func
(paren
id|lanai
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_amp
id|INT_TABORTSENT
)paren
(brace
id|ack
op_or_assign
(paren
id|reason
op_amp
id|INT_TABORTSENT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): sent PCI target abort&bslash;n&quot;
comma
id|lanai-&gt;number
)paren
suffix:semicolon
id|pcistatus_check
c_func
(paren
id|lanai
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_amp
id|INT_SEGSHUT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): driver error - &quot;
l_string|&quot;segmentation shutdown, reason=0x%08X&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|reason
op_amp
id|INT_SEGSHUT
)paren
suffix:semicolon
id|lanai_reset
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reason
op_amp
(paren
id|INT_PING
op_or
id|INT_WAKE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): driver error - &quot;
l_string|&quot;unexpected interrupt 0x%08X, resetting&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|reason
op_amp
(paren
id|INT_PING
op_or
id|INT_WAKE
)paren
)paren
suffix:semicolon
id|lanai_reset
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|ack
op_ne
id|reason
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;unacked ints: 0x%08X&bslash;n&quot;
comma
id|reason
op_amp
op_complement
id|ack
)paren
suffix:semicolon
id|ack
op_assign
id|reason
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|ack
op_ne
l_int|0
)paren
id|reg_write
c_func
(paren
id|lanai
comma
id|ack
comma
id|IntAck_Reg
)paren
suffix:semicolon
)brace
DECL|function|lanai_int
r_static
r_void
id|lanai_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devid
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|lanai_dev
op_star
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|devid
suffix:semicolon
id|u32
id|reason
suffix:semicolon
(paren
r_void
)paren
id|irq
suffix:semicolon
(paren
r_void
)paren
id|regs
suffix:semicolon
multiline_comment|/* unused variables */
macro_line|#ifdef USE_POWERDOWN
r_if
c_cond
(paren
id|lanai-&gt;conf1
op_amp
id|CONFIG1_POWERDOWN
)paren
(brace
id|lanai-&gt;conf1
op_and_assign
op_complement
id|CONFIG1_POWERDOWN
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|DEV_LABEL
l_string|&quot;(itf %d): Got interrupt &quot;
l_string|&quot;0x%08X while in POWERDOWN, powering up&bslash;n&quot;
comma
id|lanai-&gt;conf1
comma
id|intr_pending
c_func
(paren
id|lanai
)paren
)paren
suffix:semicolon
id|conf2_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
macro_line|#endif
r_while
c_loop
(paren
(paren
id|reason
op_assign
id|intr_pending
c_func
(paren
id|lanai
)paren
)paren
op_ne
l_int|0
)paren
id|lanai_int_1
c_func
(paren
id|lanai
comma
id|reason
)paren
suffix:semicolon
)brace
multiline_comment|/* TODO - it would be nice if we could use the &quot;delayed interrupt&quot; system&n; *   to some advantage&n; */
multiline_comment|/* -------------------- CHECK BOARD ID/REV: */
multiline_comment|/*&n; * The board id and revision are stored both in the reset register and&n; * in the PCI configuration space - the documentation says to check&n; * each of them.  If revp!=NULL we store the revision there&n; */
DECL|function|check_board_id_and_rev
r_static
r_int
id|check_board_id_and_rev
c_func
(paren
r_const
r_char
op_star
id|name
comma
id|u32
id|val
comma
r_int
op_star
id|revp
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;%s says board_id=%d, board_rev=%d&bslash;n&quot;
comma
id|name
comma
id|RESET_GET_BOARD_ID
c_func
(paren
id|val
)paren
comma
id|RESET_GET_BOARD_REV
c_func
(paren
id|val
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|RESET_GET_BOARD_ID
c_func
(paren
id|val
)paren
op_ne
id|BOARD_ID_LANAI256
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: Found %s board-id %d -- not a &quot;
l_string|&quot;Lanai 25.6&bslash;n&quot;
comma
id|name
comma
id|RESET_GET_BOARD_ID
c_func
(paren
id|val
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|revp
op_ne
l_int|NULL
)paren
op_star
id|revp
op_assign
id|RESET_GET_BOARD_REV
c_func
(paren
id|val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------------------- PCI INITIALIZATION/SHUTDOWN: */
DECL|function|lanai_pci_start
r_static
r_inline
r_int
id|__init
id|lanai_pci_start
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci
op_assign
id|lanai-&gt;pci
suffix:semicolon
r_int
id|result
suffix:semicolon
id|u16
id|w
suffix:semicolon
multiline_comment|/* Get the pci revision byte */
id|result
op_assign
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_REVISION_ID
comma
op_amp
id|lanai-&gt;pci_revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t read &quot;
l_string|&quot;PCI_REVISION_ID: %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|result
op_assign
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t read &quot;
"&quot;"
id|PCI_SUBSYSTEM_ID
suffix:colon
op_mod
id|d
"&bslash;"
id|n
"&quot;"
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|result
op_assign
id|check_board_id_and_rev
c_func
(paren
l_string|&quot;PCI&quot;
comma
id|w
comma
l_int|NULL
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|result
suffix:semicolon
multiline_comment|/* Set latency timer to zero as per lanai docs */
id|result
op_assign
id|pci_write_config_byte
c_func
(paren
id|pci
comma
id|PCI_LATENCY_TIMER
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t write &quot;
l_string|&quot;PCI_LATENCY_TIMER: %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|result
op_assign
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|PCI_COMMAND
comma
op_amp
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t read &quot;
l_string|&quot;PCI_COMMAND: %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|w
op_or_assign
(paren
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_SERR
op_or
id|PCI_COMMAND_PARITY
)paren
suffix:semicolon
id|result
op_assign
id|pci_write_config_word
c_func
(paren
id|pci
comma
id|PCI_COMMAND
comma
id|w
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t &quot;
l_string|&quot;write PCI_COMMAND: %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|pcistatus_check
c_func
(paren
id|lanai
comma
l_int|1
)paren
suffix:semicolon
id|pcistatus_check
c_func
(paren
id|lanai
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lanai_pci_stop
r_static
r_void
id|lanai_pci_stop
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci
op_assign
id|lanai-&gt;pci
suffix:semicolon
r_int
id|result
suffix:semicolon
id|u16
id|pci_command
suffix:semicolon
id|result
op_assign
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|PCI_COMMAND
comma
op_amp
id|pci_command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t &quot;
l_string|&quot;read PCI_COMMAND: %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|pci_command
op_and_assign
op_complement
(paren
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
)paren
suffix:semicolon
id|result
op_assign
id|pci_write_config_word
c_func
(paren
id|pci
comma
id|PCI_COMMAND
comma
id|pci_command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
id|PCIBIOS_SUCCESSFUL
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;(itf %d): can&squot;t &quot;
l_string|&quot;write PCI_COMMAND: %d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- VPI/VCI ALLOCATION: */
multiline_comment|/*&n; * We _can_ use VCI==0 for normal traffic, but only for UBR (or we&squot;ll&n; * get a CBRZERO interrupt), and we can use it only if noone is receiving&n; * AAL0 traffic (since they will use the same queue) - according to the&n; * docs we shouldn&squot;t even use it for AAL0 traffic&n; */
DECL|function|vci0_is_ok
r_static
r_inline
r_int
id|vci0_is_ok
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_const
r_struct
id|atm_qos
op_star
id|qos
)paren
(brace
r_if
c_cond
(paren
id|qos-&gt;txtp.traffic_class
op_eq
id|ATM_CBR
op_logical_or
id|qos-&gt;aal
op_eq
id|ATM_AAL0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qos-&gt;rxtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
r_if
c_cond
(paren
id|lanai-&gt;naal0
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|lanai-&gt;conf2
op_or_assign
id|CONFIG2_VCI0_NORMAL
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
r_if
c_cond
(paren
(paren
id|lanai-&gt;conf1
op_amp
id|CONFIG1_POWERDOWN
)paren
op_eq
l_int|0
)paren
macro_line|#endif
id|conf2_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* return true if vci is currently unused, or if requested qos is&n; * compatible&n; */
DECL|function|vci_is_ok
r_static
r_int
id|vci_is_ok
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
id|vci_t
id|vci
comma
r_const
r_struct
id|atm_vcc
op_star
id|atmvcc
)paren
(brace
r_const
r_struct
id|atm_qos
op_star
id|qos
op_assign
op_amp
id|atmvcc-&gt;qos
suffix:semicolon
r_const
r_struct
id|lanai_vcc
op_star
id|lvcc
op_assign
id|lanai-&gt;vccs
(braket
id|vci
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vci
op_eq
l_int|0
op_logical_and
op_logical_neg
id|vci0_is_ok
c_func
(paren
id|lanai
comma
id|qos
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lvcc
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|qos-&gt;rxtp.traffic_class
op_ne
id|ATM_NONE
op_logical_and
id|lvcc-&gt;rx.atmvcc
op_ne
l_int|NULL
op_logical_and
id|lvcc-&gt;rx.atmvcc
op_ne
id|atmvcc
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qos-&gt;txtp.traffic_class
op_ne
id|ATM_NONE
op_logical_and
id|lvcc-&gt;tx.atmvcc
op_ne
l_int|NULL
op_logical_and
id|lvcc-&gt;tx.atmvcc
op_ne
id|atmvcc
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|qos-&gt;txtp.traffic_class
op_eq
id|ATM_CBR
op_logical_and
id|lanai-&gt;cbrvcc
op_ne
l_int|NULL
op_logical_and
id|lanai-&gt;cbrvcc
op_ne
id|atmvcc
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|qos-&gt;aal
op_eq
id|ATM_AAL0
op_logical_and
id|lanai-&gt;naal0
op_eq
l_int|0
op_logical_and
id|qos-&gt;rxtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
r_const
r_struct
id|lanai_vcc
op_star
id|vci0
op_assign
id|lanai-&gt;vccs
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|vci0
op_ne
l_int|NULL
op_logical_and
id|vci0-&gt;rx.atmvcc
op_ne
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|lanai-&gt;conf2
op_and_assign
op_complement
id|CONFIG2_VCI0_NORMAL
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
r_if
c_cond
(paren
(paren
id|lanai-&gt;conf1
op_amp
id|CONFIG1_POWERDOWN
)paren
op_eq
l_int|0
)paren
macro_line|#endif
id|conf2_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|lanai_normalize_ci
r_static
r_int
id|lanai_normalize_ci
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
comma
r_const
r_struct
id|atm_vcc
op_star
id|atmvcc
comma
r_int
op_star
id|vpip
comma
id|vci_t
op_star
id|vcip
)paren
(brace
r_switch
c_cond
(paren
op_star
id|vpip
)paren
(brace
r_case
id|ATM_VPI_ANY
suffix:colon
op_star
id|vpip
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FALLTHROUGH */
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
r_switch
c_cond
(paren
op_star
id|vcip
)paren
(brace
r_case
id|ATM_VCI_ANY
suffix:colon
r_for
c_loop
(paren
op_star
id|vcip
op_assign
id|ATM_NOT_RSV_VCI
suffix:semicolon
op_star
id|vcip
OL
id|lanai-&gt;num_vci
suffix:semicolon
(paren
op_star
id|vcip
)paren
op_increment
)paren
r_if
c_cond
(paren
id|vci_is_ok
c_func
(paren
id|lanai
comma
op_star
id|vcip
comma
id|atmvcc
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
op_star
id|vcip
op_ge
id|lanai-&gt;num_vci
op_logical_or
op_star
id|vcip
OL
l_int|0
op_logical_or
op_logical_neg
id|vci_is_ok
c_func
(paren
id|lanai
comma
op_star
id|vcip
comma
id|atmvcc
)paren
)paren
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -------------------- MANAGE CBR: */
multiline_comment|/*&n; * CBR ICG is stored as a fixed-point number with 4 fractional bits.&n; * Note that storing a number greater than 2046.0 will result in&n; * incorrect shaping&n; */
DECL|macro|CBRICG_FRAC_BITS
mdefine_line|#define CBRICG_FRAC_BITS&t;(4)
DECL|macro|CBRICG_MAX
mdefine_line|#define CBRICG_MAX&t;&t;(2046 &lt;&lt; CBRICG_FRAC_BITS)
multiline_comment|/*&n; * ICG is related to PCR with the formula PCR = MAXPCR / (ICG + 1)&n; * where MAXPCR is (according to the docs) 25600000/(54*8),&n; * which is equal to (3125&lt;&lt;9)/27.&n; *&n; * Solving for ICG, we get:&n; *    ICG = MAXPCR/PCR - 1&n; *    ICG = (3125&lt;&lt;9)/(27*PCR) - 1&n; *    ICG = ((3125&lt;&lt;9) - (27*PCR)) / (27*PCR)&n; *&n; * The end result is supposed to be a fixed-point number with FRAC_BITS&n; * bits of a fractional part, so we keep everything in the numerator&n; * shifted by that much as we compute&n; *&n; */
DECL|function|pcr_to_cbricg
r_static
r_int
id|pcr_to_cbricg
c_func
(paren
multiline_comment|/*const*/
r_struct
id|atm_qos
op_star
id|qos
)paren
(brace
r_int
id|rounddown
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1 = Round PCR down, i.e. round ICG _up_ */
r_int
id|x
comma
id|icg
comma
id|pcr
op_assign
id|atm_pcr_goal
c_func
(paren
op_amp
id|qos-&gt;txtp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcr
op_eq
l_int|0
)paren
multiline_comment|/* Use maximum bandwidth */
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcr
OL
l_int|0
)paren
(brace
id|rounddown
op_assign
l_int|1
suffix:semicolon
id|pcr
op_assign
op_minus
id|pcr
suffix:semicolon
)brace
id|x
op_assign
id|pcr
op_star
l_int|27
suffix:semicolon
id|icg
op_assign
(paren
l_int|3125
op_lshift
(paren
l_int|9
op_plus
id|CBRICG_FRAC_BITS
)paren
)paren
op_minus
(paren
id|x
op_lshift
id|CBRICG_FRAC_BITS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rounddown
)paren
id|icg
op_add_assign
id|x
op_minus
l_int|1
suffix:semicolon
id|icg
op_div_assign
id|x
suffix:semicolon
r_if
c_cond
(paren
id|icg
OG
id|CBRICG_MAX
)paren
id|icg
op_assign
id|CBRICG_MAX
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;pcr_to_cbricg: pcr=%d rounddown=%c icg=%d&bslash;n&quot;
comma
id|pcr
comma
id|rounddown
ques
c_cond
l_char|&squot;Y&squot;
suffix:colon
l_char|&squot;N&squot;
comma
id|icg
)paren
suffix:semicolon
r_return
id|icg
suffix:semicolon
)brace
DECL|function|lanai_cbr_setup
r_static
r_inline
r_void
id|lanai_cbr_setup
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|reg_write
c_func
(paren
id|lanai
comma
id|pcr_to_cbricg
c_func
(paren
op_amp
id|lanai-&gt;cbrvcc-&gt;qos
)paren
comma
id|CBR_ICG_Reg
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lanai
comma
id|lanai-&gt;cbrvcc-&gt;vci
comma
id|CBR_PTR_Reg
)paren
suffix:semicolon
id|lanai-&gt;conf2
op_or_assign
id|CONFIG2_CBR_ENABLE
suffix:semicolon
id|conf2_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
DECL|function|lanai_cbr_shutdown
r_static
r_inline
r_void
id|lanai_cbr_shutdown
c_func
(paren
r_struct
id|lanai_dev
op_star
id|lanai
)paren
(brace
id|lanai-&gt;conf2
op_and_assign
op_complement
id|CONFIG2_CBR_ENABLE
suffix:semicolon
id|conf2_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
multiline_comment|/* -------------------- OPERATIONS: */
multiline_comment|/* setup a newly detected device */
DECL|function|lanai_dev_open
r_static
r_int
id|__init
id|lanai_dev_open
c_func
(paren
r_struct
id|atm_dev
op_star
id|atmdev
)paren
(brace
r_struct
id|lanai_dev
op_star
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|atmdev-&gt;dev_data
suffix:semicolon
r_int
r_int
id|raw_base
suffix:semicolon
r_int
id|result
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;In lanai_dev_open()&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Basic device fields */
id|lanai-&gt;number
op_assign
id|atmdev-&gt;number
suffix:semicolon
id|lanai-&gt;num_vci
op_assign
id|NUM_VCI
suffix:semicolon
id|vci_bitfield_init
c_func
(paren
op_amp
id|lanai-&gt;backlog_vccs
)paren
suffix:semicolon
id|vci_bitfield_init
c_func
(paren
op_amp
id|lanai-&gt;transmit_ready
)paren
suffix:semicolon
id|lanai-&gt;naal0
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
id|lanai-&gt;nbound
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|lanai-&gt;cbrvcc
op_assign
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|lanai-&gt;stats
comma
l_int|0
comma
r_sizeof
id|lanai-&gt;stats
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lanai-&gt;txlock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lanai-&gt;servicelock
)paren
suffix:semicolon
id|atmdev-&gt;ci_range.vpi_bits
op_assign
l_int|0
suffix:semicolon
id|atmdev-&gt;ci_range.vci_bits
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
op_lshift
id|atmdev-&gt;ci_range.vci_bits
OL
id|lanai-&gt;num_vci
)paren
id|atmdev-&gt;ci_range.vci_bits
op_increment
suffix:semicolon
id|atmdev-&gt;link_rate
op_assign
(paren
(paren
l_int|25600000
op_div
l_int|8
op_minus
l_int|8000
)paren
op_div
l_int|54
)paren
suffix:semicolon
multiline_comment|/* 3.2: PCI initialization */
r_if
c_cond
(paren
(paren
id|result
op_assign
id|lanai_pci_start
c_func
(paren
id|lanai
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|error
suffix:semicolon
id|raw_base
op_assign
(paren
id|bus_addr_t
)paren
id|lanai-&gt;pci-&gt;resource
(braket
l_int|0
)braket
dot
id|start
suffix:semicolon
id|lanai-&gt;base
op_assign
(paren
id|bus_addr_t
)paren
id|ioremap
c_func
(paren
id|raw_base
comma
id|LANAI_MAPPING_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lanai-&gt;base
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: couldn&squot;t remap I/O space&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_pci
suffix:semicolon
)brace
multiline_comment|/* 3.3: Reset lanai and PHY */
id|reset_board
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|lanai-&gt;conf1
op_assign
id|reg_read
c_func
(paren
id|lanai
comma
id|Config1_Reg
)paren
suffix:semicolon
id|lanai-&gt;conf1
op_and_assign
op_complement
(paren
id|CONFIG1_GPOUT1
op_or
id|CONFIG1_POWERDOWN
op_or
id|CONFIG1_MASK_LEDMODE
)paren
suffix:semicolon
id|lanai-&gt;conf1
op_or_assign
id|CONFIG1_SET_LEDMODE
c_func
(paren
id|LEDMODE_NOT_SOOL
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lanai
comma
id|lanai-&gt;conf1
op_or
id|CONFIG1_GPOUT1
comma
id|Config1_Reg
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * 3.4: Turn on endian mode for big-endian hardware&n;&t; *   We don&squot;t actually want to do this - the actual bit fields&n;&t; *   in the endian register are not documented anywhere.&n;&t; *   Instead we do the bit-flipping ourselves on big-endian&n;&t; *   hardware.&n;&t; *&n;&t; * 3.5: get the board ID/rev by reading the reset register&n;&t; */
id|result
op_assign
id|check_board_id_and_rev
c_func
(paren
l_string|&quot;register&quot;
comma
id|reg_read
c_func
(paren
id|lanai
comma
id|Reset_Reg
)paren
comma
op_amp
id|lanai-&gt;board_rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
r_goto
id|error_unmap
suffix:semicolon
multiline_comment|/* 3.6: read EEPROM */
r_if
c_cond
(paren
(paren
id|result
op_assign
id|eeprom_read
c_func
(paren
id|lanai
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|error_unmap
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|eeprom_validate
c_func
(paren
id|lanai
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|error_unmap
suffix:semicolon
multiline_comment|/* 3.7: re-reset PHY, do loopback tests, setup PHY */
id|reg_write
c_func
(paren
id|lanai
comma
id|lanai-&gt;conf1
op_or
id|CONFIG1_GPOUT1
comma
id|Config1_Reg
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
multiline_comment|/* TODO - loopback tests */
id|lanai-&gt;conf1
op_or_assign
(paren
id|CONFIG1_GPOUT2
op_or
id|CONFIG1_GPOUT3
op_or
id|CONFIG1_DMA_ENABLE
)paren
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
multiline_comment|/* 3.8/3.9: test and initialize card SRAM */
r_if
c_cond
(paren
(paren
id|result
op_assign
id|sram_test_and_clear
c_func
(paren
id|lanai
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|error_unmap
suffix:semicolon
multiline_comment|/* 3.10: initialize lanai registers */
id|lanai-&gt;conf1
op_or_assign
id|CONFIG1_DMA_ENABLE
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|service_buffer_allocate
c_func
(paren
id|lanai
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|error_unmap
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|vcc_table_allocate
c_func
(paren
id|lanai
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|error_service
suffix:semicolon
id|lanai-&gt;conf2
op_assign
(paren
id|lanai-&gt;num_vci
op_ge
l_int|512
ques
c_cond
id|CONFIG2_HOWMANY
suffix:colon
l_int|0
)paren
op_or
id|CONFIG2_HEC_DROP
op_or
multiline_comment|/* ??? */
id|CONFIG2_PTI7_MODE
suffix:semicolon
id|conf2_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lanai
comma
id|TX_FIFO_DEPTH
comma
id|TxDepth_Reg
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lanai
comma
l_int|0
comma
id|CBR_ICG_Reg
)paren
suffix:semicolon
multiline_comment|/* CBR defaults to no limit */
r_if
c_cond
(paren
(paren
id|result
op_assign
id|request_irq
c_func
(paren
id|lanai-&gt;pci-&gt;irq
comma
id|lanai_int
comma
id|SA_SHIRQ
comma
l_string|&quot;lanai&quot;
comma
id|lanai
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: can&squot;t allocate interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_vcctable
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
multiline_comment|/* At this point we can&squot;t fail */
id|intr_enable
c_func
(paren
id|lanai
comma
id|INT_ALL
op_amp
op_complement
(paren
id|INT_PING
op_or
id|INT_WAKE
)paren
)paren
suffix:semicolon
multiline_comment|/* 3.11: initialize loop mode (i.e. turn looping off) */
id|lanai-&gt;conf1
op_assign
(paren
id|lanai-&gt;conf1
op_amp
op_complement
id|CONFIG1_MASK_LOOPMODE
)paren
op_or
id|CONFIG1_SET_LOOPMODE
c_func
(paren
id|LOOPMODE_NORMAL
)paren
op_or
id|CONFIG1_GPOUT2
op_or
id|CONFIG1_GPOUT3
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|lanai-&gt;status
op_assign
id|reg_read
c_func
(paren
id|lanai
comma
id|Status_Reg
)paren
suffix:semicolon
multiline_comment|/* We&squot;re now done initializing this card */
macro_line|#ifdef USE_POWERDOWN
id|lanai-&gt;conf1
op_or_assign
id|CONFIG1_POWERDOWN
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
macro_line|#endif
id|memcpy
c_func
(paren
id|atmdev-&gt;esi
comma
id|eeprom_mac
c_func
(paren
id|lanai
)paren
comma
id|ESI_LEN
)paren
suffix:semicolon
id|lanai_timed_poll_start
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
id|DEV_LABEL
l_string|&quot;(itf %d): rev.%d, base=0x%lx, irq=%d &quot;
l_string|&quot;(%02X-%02X-%02X-%02X-%02X-%02X)&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|lanai-&gt;pci_revision
comma
(paren
r_int
)paren
id|lanai-&gt;base
comma
id|lanai-&gt;pci-&gt;irq
comma
id|atmdev-&gt;esi
(braket
l_int|0
)braket
comma
id|atmdev-&gt;esi
(braket
l_int|1
)braket
comma
id|atmdev-&gt;esi
(braket
l_int|2
)braket
comma
id|atmdev-&gt;esi
(braket
l_int|3
)braket
comma
id|atmdev-&gt;esi
(braket
l_int|4
)braket
comma
id|atmdev-&gt;esi
(braket
l_int|5
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
id|DEV_LABEL
l_string|&quot;(itf %d): LANAI%s, serialno=%d(0x%X), &quot;
l_string|&quot;board_rev=%d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|lanai-&gt;type
op_eq
id|lanai2
ques
c_cond
l_string|&quot;2&quot;
suffix:colon
l_string|&quot;HB&quot;
comma
id|lanai-&gt;serialno
comma
id|lanai-&gt;serialno
comma
id|lanai-&gt;board_rev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error_vcctable
suffix:colon
id|vcc_table_deallocate
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|error_service
suffix:colon
id|service_buffer_deallocate
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|error_unmap
suffix:colon
id|reset_board
c_func
(paren
id|lanai
)paren
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
id|lanai-&gt;conf1
op_assign
id|reg_read
c_func
(paren
id|lanai
comma
id|Config1_Reg
)paren
op_or
id|CONFIG1_POWERDOWN
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
macro_line|#endif
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|lanai-&gt;base
)paren
suffix:semicolon
id|error_pci
suffix:colon
id|lanai_pci_stop
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|error
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* called when device is being shutdown, and all vcc&squot;s are gone - higher&n; * levels will deallocate the atm device for us&n; */
DECL|function|lanai_dev_close
r_static
r_void
id|lanai_dev_close
c_func
(paren
r_struct
id|atm_dev
op_star
id|atmdev
)paren
(brace
r_struct
id|lanai_dev
op_star
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|atmdev-&gt;dev_data
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DEV_LABEL
l_string|&quot;(itf %d): shutting down interface&bslash;n&quot;
comma
id|lanai-&gt;number
)paren
suffix:semicolon
id|lanai_timed_poll_stop
c_func
(paren
id|lanai
)paren
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
id|lanai-&gt;conf1
op_assign
id|reg_read
c_func
(paren
id|lanai
comma
id|Config1_Reg
)paren
op_amp
op_complement
id|CONFIG1_POWERDOWN
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
macro_line|#endif
id|intr_disable
c_func
(paren
id|lanai
comma
id|INT_ALL
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|lanai-&gt;pci-&gt;irq
comma
id|lanai
)paren
suffix:semicolon
id|reset_board
c_func
(paren
id|lanai
)paren
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
id|lanai-&gt;conf1
op_or_assign
id|CONFIG1_POWERDOWN
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
macro_line|#endif
id|lanai_pci_stop
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|vcc_table_deallocate
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|service_buffer_deallocate
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|lanai-&gt;base
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/* close a vcc */
DECL|function|lanai_close
r_static
r_void
id|lanai_close
c_func
(paren
r_struct
id|atm_vcc
op_star
id|atmvcc
)paren
(brace
r_struct
id|lanai_vcc
op_star
id|lvcc
op_assign
(paren
r_struct
id|lanai_vcc
op_star
)paren
id|atmvcc-&gt;dev_data
suffix:semicolon
r_struct
id|lanai_dev
op_star
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|atmvcc-&gt;dev-&gt;dev_data
suffix:semicolon
r_if
c_cond
(paren
id|lvcc
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|atmvcc-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|atmvcc-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;rx.atmvcc
op_eq
id|atmvcc
)paren
(brace
id|lanai_shutdown_rx_vci
c_func
(paren
id|lvcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc-&gt;qos.aal
op_eq
id|ATM_AAL0
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|lanai-&gt;naal0
op_le
l_int|0
)paren
id|aal0_buffer_free
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
r_else
id|lanai_buf_deallocate
c_func
(paren
op_amp
id|lvcc-&gt;rx.buf
)paren
suffix:semicolon
id|lvcc-&gt;rx.atmvcc
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lvcc-&gt;tx.atmvcc
op_eq
id|atmvcc
)paren
(brace
r_if
c_cond
(paren
id|atmvcc
op_eq
id|lanai-&gt;cbrvcc
)paren
(brace
r_if
c_cond
(paren
id|lvcc-&gt;vbase
op_ne
l_int|0
)paren
id|lanai_cbr_shutdown
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|lanai-&gt;cbrvcc
op_assign
l_int|NULL
suffix:semicolon
)brace
id|lanai_shutdown_tx_vci
c_func
(paren
id|lanai
comma
id|lvcc
)paren
suffix:semicolon
id|lanai_buf_deallocate
c_func
(paren
op_amp
id|lvcc-&gt;tx.buf
)paren
suffix:semicolon
id|lvcc-&gt;tx.atmvcc
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_decrement
id|lvcc-&gt;nref
op_eq
l_int|0
)paren
(brace
id|host_vcc_unbind
c_func
(paren
id|lanai
comma
id|lvcc
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lvcc
)paren
suffix:semicolon
)brace
id|atmvcc-&gt;dev_data
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|atmvcc-&gt;flags
)paren
suffix:semicolon
)brace
multiline_comment|/* open a vcc on the card to vpi/vci */
DECL|function|lanai_open
r_static
r_int
id|lanai_open
c_func
(paren
r_struct
id|atm_vcc
op_star
id|atmvcc
comma
r_int
id|vpi
comma
r_int
id|vci
)paren
(brace
r_struct
id|lanai_dev
op_star
id|lanai
suffix:semicolon
r_struct
id|lanai_vcc
op_star
id|lvcc
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we don&squot;t support partial open - it&squot;s not really useful anyway */
r_if
c_cond
(paren
(paren
id|test_bit
c_func
(paren
id|ATM_VF_PARTIAL
comma
op_amp
id|atmvcc-&gt;flags
)paren
)paren
op_logical_or
(paren
id|vpi
op_eq
id|ATM_VPI_UNSPEC
)paren
op_logical_or
(paren
id|vci
op_eq
id|ATM_VCI_UNSPEC
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|atmvcc-&gt;dev-&gt;dev_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|lanai_normalize_ci
c_func
(paren
id|lanai
comma
id|atmvcc
comma
op_amp
id|vpi
comma
op_amp
id|vci
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|atmvcc-&gt;vpi
op_assign
id|vpi
suffix:semicolon
id|atmvcc-&gt;vci
op_assign
id|vci
suffix:semicolon
id|set_bit
c_func
(paren
id|ATM_VF_ADDR
comma
op_amp
id|atmvcc-&gt;flags
)paren
suffix:semicolon
id|lvcc
op_assign
id|lanai-&gt;vccs
(braket
id|vci
)braket
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc-&gt;qos.aal
op_ne
id|ATM_AAL0
op_logical_and
id|atmvcc-&gt;qos.aal
op_ne
id|ATM_AAL5
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
id|DEV_LABEL
l_string|&quot;(itf %d): open %d.%d flags=0x%X&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|vpi
comma
id|vci
comma
(paren
r_int
r_int
)paren
id|atmvcc-&gt;flags
)paren
suffix:semicolon
macro_line|#else
id|DPRINTK
c_func
(paren
id|DEV_LABEL
l_string|&quot;(itf %d): open %d.%d&bslash;n&quot;
comma
id|lanai-&gt;number
comma
id|vpi
comma
id|vci
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lvcc
op_eq
l_int|NULL
op_logical_and
(paren
id|lvcc
op_assign
id|new_lanai_vcc
c_func
(paren
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|atmvcc-&gt;dev_data
op_assign
id|lvcc
suffix:semicolon
id|lvcc-&gt;nref
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc-&gt;qos.rxtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
id|APRINTK
c_func
(paren
id|lvcc-&gt;rx.atmvcc
op_eq
l_int|NULL
comma
l_string|&quot;rx.atmvcc!=NULL, vci=%d&bslash;n&quot;
comma
id|vci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc-&gt;qos.aal
op_eq
id|ATM_AAL0
)paren
(brace
r_if
c_cond
(paren
id|lanai-&gt;naal0
op_eq
l_int|0
)paren
id|result
op_assign
id|aal0_buffer_allocate
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
r_else
id|result
op_assign
id|lanai_setup_rx_vci_aal5
c_func
(paren
id|lanai-&gt;number
comma
id|lvcc
comma
op_amp
id|atmvcc-&gt;qos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|lvcc-&gt;rx.atmvcc
op_assign
id|atmvcc
suffix:semicolon
id|lvcc-&gt;stats.rx_nomem
op_assign
l_int|0
suffix:semicolon
id|lvcc-&gt;stats.x.aal5.rx_badlen
op_assign
l_int|0
suffix:semicolon
id|lvcc-&gt;stats.x.aal5.service_trash
op_assign
l_int|0
suffix:semicolon
id|lvcc-&gt;stats.x.aal5.service_stream
op_assign
l_int|0
suffix:semicolon
id|lvcc-&gt;stats.x.aal5.service_rxcrc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc-&gt;qos.aal
op_eq
id|ATM_AAL0
)paren
id|lanai-&gt;naal0
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atmvcc-&gt;qos.txtp.traffic_class
op_ne
id|ATM_NONE
)paren
(brace
id|APRINTK
c_func
(paren
id|lvcc-&gt;tx.atmvcc
op_eq
l_int|NULL
comma
l_string|&quot;tx.atmvcc!=NULL, vci=%d&bslash;n&quot;
comma
id|vci
)paren
suffix:semicolon
id|result
op_assign
id|lanai_setup_tx_vci
c_func
(paren
id|lanai-&gt;number
comma
id|lvcc
comma
op_amp
id|atmvcc-&gt;qos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|lvcc-&gt;tx.atmvcc
op_assign
id|atmvcc
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc-&gt;qos.txtp.traffic_class
op_eq
id|ATM_CBR
)paren
(brace
id|APRINTK
c_func
(paren
id|lanai-&gt;cbrvcc
op_eq
l_int|NULL
comma
l_string|&quot;cbrvcc!=NULL, vci=%d&bslash;n&quot;
comma
id|vci
)paren
suffix:semicolon
id|lanai-&gt;cbrvcc
op_assign
id|atmvcc
suffix:semicolon
)brace
)brace
id|host_vcc_bind
c_func
(paren
id|lanai
comma
id|lvcc
comma
id|vci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc
op_eq
id|lvcc-&gt;rx.atmvcc
)paren
id|host_vcc_start_rx
c_func
(paren
id|lvcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc
op_eq
id|lvcc-&gt;tx.atmvcc
)paren
(brace
id|host_vcc_start_tx
c_func
(paren
id|lvcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lanai-&gt;cbrvcc
op_eq
id|atmvcc
)paren
id|lanai_cbr_setup
c_func
(paren
id|lanai
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|ATM_VF_READY
comma
op_amp
id|atmvcc-&gt;flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|lanai_close
c_func
(paren
id|atmvcc
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* ioctl operations for card */
multiline_comment|/* NOTE: these are all DEBUGGING ONLY currently */
DECL|function|lanai_ioctl
r_static
r_int
id|lanai_ioctl
c_func
(paren
r_struct
id|atm_dev
op_star
id|atmdev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|lanai_dev
op_star
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|atmdev-&gt;dev_data
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
l_int|2106275
suffix:colon
id|shutdown_atm_dev
c_func
(paren
id|atmdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
l_int|2200000
suffix:colon
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lanai-&gt;servicelock
comma
id|flags
)paren
suffix:semicolon
id|run_service
c_func
(paren
id|lanai
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lanai-&gt;servicelock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
l_int|2200001
suffix:colon
id|vcc_tx_dequeue_all
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
l_int|2200002
suffix:colon
id|get_statistics
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
l_int|2200003
suffix:colon
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|0x5C
suffix:semicolon
id|i
op_add_assign
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0x48
)paren
multiline_comment|/* Write-only butt reg */
r_continue
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
id|DEV_LABEL
l_string|&quot;  0x%02X: &quot;
l_string|&quot;0x%08X&bslash;n&quot;
comma
id|i
comma
(paren
id|u32
)paren
id|readl
c_func
(paren
id|lanai-&gt;base
op_plus
id|i
)paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|pcistatus_check
c_func
(paren
id|lanai
comma
l_int|0
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
l_int|2200004
suffix:colon
(brace
id|u8
id|b
suffix:semicolon
id|u16
id|w
suffix:semicolon
id|u32
id|dw
suffix:semicolon
r_struct
id|pci_dev
op_star
id|pci
op_assign
id|lanai-&gt;pci
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|PCI_VENDOR_ID
comma
op_amp
id|w
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;vendor = 0x%X&bslash;n&quot;
comma
id|w
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|PCI_DEVICE_ID
comma
op_amp
id|w
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;device = 0x%X&bslash;n&quot;
comma
id|w
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|PCI_COMMAND
comma
op_amp
id|w
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;command = 0x%X&bslash;n&quot;
comma
id|w
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_word
c_func
(paren
id|pci
comma
id|PCI_STATUS
comma
op_amp
id|w
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;status = 0x%X&bslash;n&quot;
comma
id|w
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_dword
c_func
(paren
id|pci
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|dw
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;class/revision = 0x%X&bslash;n&quot;
comma
id|dw
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_CACHE_LINE_SIZE
comma
op_amp
id|b
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;cache line size = 0x%X&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_LATENCY_TIMER
comma
op_amp
id|b
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;latency = %d (0x%X)&bslash;n&quot;
comma
id|b
comma
id|b
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_HEADER_TYPE
comma
op_amp
id|b
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;header type = 0x%X&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_BIST
comma
op_amp
id|b
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;bist = 0x%X&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
multiline_comment|/* skipping a few here */
(paren
r_void
)paren
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_INTERRUPT_LINE
comma
op_amp
id|b
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;pci_int_line = 0x%X&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_INTERRUPT_PIN
comma
op_amp
id|b
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;pci_int_pin = 0x%X&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_MIN_GNT
comma
op_amp
id|b
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;min_gnt = 0x%X&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
(paren
r_void
)paren
id|pci_read_config_byte
c_func
(paren
id|pci
comma
id|PCI_MAX_LAT
comma
op_amp
id|b
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;max_lat = 0x%X&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
macro_line|#ifdef USE_POWERDOWN
r_case
l_int|2200005
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;Coming out of powerdown&bslash;n&quot;
)paren
suffix:semicolon
id|lanai-&gt;conf1
op_and_assign
op_complement
id|CONFIG1_POWERDOWN
suffix:semicolon
id|conf1_write
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|lanai_send
r_static
r_int
id|lanai_send
c_func
(paren
r_struct
id|atm_vcc
op_star
id|atmvcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|lanai_vcc
op_star
id|lvcc
op_assign
(paren
r_struct
id|lanai_vcc
op_star
)paren
id|atmvcc-&gt;dev_data
suffix:semicolon
r_struct
id|lanai_dev
op_star
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|atmvcc-&gt;dev-&gt;dev_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|lvcc
op_eq
l_int|NULL
op_logical_or
id|lvcc-&gt;vbase
op_eq
l_int|0
op_logical_or
id|lvcc-&gt;tx.atmvcc
op_ne
id|atmvcc
)paren
r_goto
id|einval
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;lanai_send: skb==NULL for vci=%d&bslash;n&quot;
comma
id|atmvcc-&gt;vci
)paren
suffix:semicolon
r_goto
id|einval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lanai
op_eq
l_int|NULL
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;lanai_send: lanai==NULL for vci=%d&bslash;n&quot;
comma
id|atmvcc-&gt;vci
)paren
suffix:semicolon
r_goto
id|einval
suffix:semicolon
)brace
macro_line|#endif
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|atmvcc
suffix:semicolon
r_switch
c_cond
(paren
id|atmvcc-&gt;qos.aal
)paren
(brace
r_case
id|ATM_AAL5
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lanai-&gt;txlock
comma
id|flags
)paren
suffix:semicolon
id|vcc_tx_aal5
c_func
(paren
id|lanai
comma
id|lvcc
comma
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lanai-&gt;txlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|ATM_AAL0
suffix:colon
r_if
c_cond
(paren
id|skb-&gt;len
op_ne
id|ATM_CELL_SIZE
op_minus
l_int|1
)paren
r_goto
id|einval
suffix:semicolon
multiline_comment|/* NOTE - this next line is technically invalid - we haven&squot;t unshared skb */
id|cpu_to_be32s
c_func
(paren
(paren
id|u32
op_star
)paren
id|skb-&gt;data
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lanai-&gt;txlock
comma
id|flags
)paren
suffix:semicolon
id|vcc_tx_aal0
c_func
(paren
id|lanai
comma
id|lvcc
comma
id|skb
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lanai-&gt;txlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;lanai_send: bad aal=%d on vci=%d&bslash;n&quot;
comma
id|atmvcc-&gt;qos.aal
comma
id|atmvcc-&gt;vci
)paren
suffix:semicolon
id|einval
suffix:colon
id|lanai_free_skb
c_func
(paren
id|atmvcc
comma
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|lanai_change_qos
r_static
r_int
id|lanai_change_qos
c_func
(paren
r_struct
id|atm_vcc
op_star
id|atmvcc
comma
multiline_comment|/*const*/
r_struct
id|atm_qos
op_star
id|qos
comma
r_int
id|flags
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* TODO: need to write this */
)brace
macro_line|#ifndef CONFIG_PROC_FS
DECL|macro|lanai_proc_read
mdefine_line|#define lanai_proc_read NULL
macro_line|#else
DECL|function|lanai_proc_read
r_static
r_int
id|lanai_proc_read
c_func
(paren
r_struct
id|atm_dev
op_star
id|atmdev
comma
id|loff_t
op_star
id|pos
comma
r_char
op_star
id|page
)paren
(brace
r_struct
id|lanai_dev
op_star
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|atmdev-&gt;dev_data
suffix:semicolon
id|loff_t
id|left
op_assign
op_star
id|pos
suffix:semicolon
r_struct
id|lanai_vcc
op_star
id|lvcc
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
id|DEV_LABEL
l_string|&quot;(itf %d): chip=LANAI%s, &quot;
l_string|&quot;serial=%d, magic=0x%08X, num_vci=%d&bslash;n&quot;
comma
id|atmdev-&gt;number
comma
id|lanai-&gt;type
op_eq
id|lanai2
ques
c_cond
l_string|&quot;2&quot;
suffix:colon
l_string|&quot;HB&quot;
comma
id|lanai-&gt;serialno
comma
id|lanai-&gt;magicno
comma
id|lanai-&gt;num_vci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;revision: board=%d, pci_if=%d&bslash;n&quot;
comma
id|lanai-&gt;board_rev
comma
id|lanai-&gt;pci_revision
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;EEPROM ESI: &quot;
l_string|&quot;%02X:%02X:%02X:%02X:%02X:%02X&bslash;n&quot;
comma
id|lanai-&gt;eeprom
(braket
id|EEPROM_MAC
op_plus
l_int|0
)braket
comma
id|lanai-&gt;eeprom
(braket
id|EEPROM_MAC
op_plus
l_int|1
)braket
comma
id|lanai-&gt;eeprom
(braket
id|EEPROM_MAC
op_plus
l_int|2
)braket
comma
id|lanai-&gt;eeprom
(braket
id|EEPROM_MAC
op_plus
l_int|3
)braket
comma
id|lanai-&gt;eeprom
(braket
id|EEPROM_MAC
op_plus
l_int|4
)braket
comma
id|lanai-&gt;eeprom
(braket
id|EEPROM_MAC
op_plus
l_int|5
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;status: SOOL=%d, LOCD=%d, LED=%d, &quot;
l_string|&quot;GPIN=%d&bslash;n&quot;
comma
(paren
id|lanai-&gt;status
op_amp
id|STATUS_SOOL
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|lanai-&gt;status
op_amp
id|STATUS_LOCD
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|lanai-&gt;status
op_amp
id|STATUS_LED
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
(paren
id|lanai-&gt;status
op_amp
id|STATUS_GPIN
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;global buffer sizes: service=%d, &quot;
l_string|&quot;aal0_rx=%d&bslash;n&quot;
comma
id|lanai_buf_size
c_func
(paren
op_amp
id|lanai-&gt;service
)paren
comma
id|lanai-&gt;naal0
ques
c_cond
id|lanai_buf_size
c_func
(paren
op_amp
id|lanai-&gt;aal0buf
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
(brace
id|get_statistics
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;cells in error: overflow=%d, &quot;
l_string|&quot;closed_vci=%d, bad_HEC=%d, rx_fifo=%d&bslash;n&quot;
comma
id|lanai-&gt;stats.ovfl_trash
comma
id|lanai-&gt;stats.vci_trash
comma
id|lanai-&gt;stats.hec_err
comma
id|lanai-&gt;stats.atm_ovfl
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;PCI errors: parity_detect=%d, &quot;
l_string|&quot;master_abort=%d, master_target_abort=%d,&bslash;n&quot;
comma
id|lanai-&gt;stats.pcierr_parity_detect
comma
id|lanai-&gt;stats.pcierr_serr_set
comma
id|lanai-&gt;stats.pcierr_m_target_abort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;            slave_target_abort=%d, &quot;
l_string|&quot;master_parity=%d&bslash;n&quot;
comma
id|lanai-&gt;stats.pcierr_s_target_abort
comma
id|lanai-&gt;stats.pcierr_master_parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;service list errors: no_vcc_rx=%d, &quot;
l_string|&quot;no_vcc_tx=%d,&bslash;n&quot;
comma
id|lanai-&gt;stats.service_novcc_rx
comma
id|lanai-&gt;stats.service_novcc_tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;                     no_tx=%d, &quot;
l_string|&quot;no_rx=%d, bad_rx_aal=%d&bslash;n&quot;
comma
id|lanai-&gt;stats.service_norx
comma
id|lanai-&gt;stats.service_notx
comma
id|lanai-&gt;stats.service_rxnotaal5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
op_decrement
op_eq
l_int|0
)paren
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;resets: dma=%d, card=%d&bslash;n&quot;
comma
id|lanai-&gt;stats.dma_reenable
comma
id|lanai-&gt;stats.card_reset
)paren
suffix:semicolon
multiline_comment|/* At this point, &quot;left&quot; should be the VCI we&squot;re looking for */
id|vcclist_read_lock
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
id|left
op_increment
)paren
(brace
r_if
c_cond
(paren
id|left
op_ge
id|NUM_VCI
)paren
(brace
id|left
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|lvcc
op_assign
id|lanai-&gt;vccs
(braket
id|left
)braket
)paren
op_ne
l_int|NULL
)paren
r_break
suffix:semicolon
(paren
op_star
id|pos
)paren
op_increment
suffix:semicolon
)brace
multiline_comment|/* Note that we re-use &quot;left&quot; here since we&squot;re done with it */
id|left
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;VCI %4d: nref=%d, rx_nomem=%d&quot;
comma
(paren
id|vci_t
)paren
id|left
comma
id|lvcc-&gt;nref
comma
id|lvcc-&gt;stats.rx_nomem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;rx.atmvcc
op_ne
l_int|NULL
)paren
(brace
id|left
op_add_assign
id|sprintf
c_func
(paren
op_amp
id|page
(braket
id|left
)braket
comma
l_string|&quot;,&bslash;n          rx_AAL=%d&quot;
comma
id|lvcc-&gt;rx.atmvcc-&gt;qos.aal
op_eq
id|ATM_AAL5
ques
c_cond
l_int|5
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lvcc-&gt;rx.atmvcc-&gt;qos.aal
op_eq
id|ATM_AAL5
)paren
id|left
op_add_assign
id|sprintf
c_func
(paren
op_amp
id|page
(braket
id|left
)braket
comma
l_string|&quot;, rx_buf_size=%d, &quot;
l_string|&quot;rx_bad_len=%d,&bslash;n          rx_service_trash=%d, &quot;
l_string|&quot;rx_service_stream=%d, rx_bad_crc=%d&quot;
comma
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;rx.buf
)paren
comma
id|lvcc-&gt;stats.x.aal5.rx_badlen
comma
id|lvcc-&gt;stats.x.aal5.service_trash
comma
id|lvcc-&gt;stats.x.aal5.service_stream
comma
id|lvcc-&gt;stats.x.aal5.service_rxcrc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lvcc-&gt;tx.atmvcc
op_ne
l_int|NULL
)paren
id|left
op_add_assign
id|sprintf
c_func
(paren
op_amp
id|page
(braket
id|left
)braket
comma
l_string|&quot;,&bslash;n          tx_AAL=%d, &quot;
l_string|&quot;tx_buf_size=%d, tx_qos=%cBR, tx_backlogged=%c&quot;
comma
id|lvcc-&gt;tx.atmvcc-&gt;qos.aal
op_eq
id|ATM_AAL5
ques
c_cond
l_int|5
suffix:colon
l_int|0
comma
id|lanai_buf_size
c_func
(paren
op_amp
id|lvcc-&gt;tx.buf
)paren
comma
id|lvcc-&gt;tx.atmvcc
op_eq
id|lanai-&gt;cbrvcc
ques
c_cond
l_char|&squot;C&squot;
suffix:colon
l_char|&squot;U&squot;
comma
id|vcc_is_backlogged
c_func
(paren
id|lvcc
)paren
ques
c_cond
l_char|&squot;Y&squot;
suffix:colon
l_char|&squot;N&squot;
)paren
suffix:semicolon
id|page
(braket
id|left
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|page
(braket
id|left
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|out
suffix:colon
id|vcclist_read_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|left
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS */
multiline_comment|/* -------------------- HOOKS: */
DECL|variable|ops
r_static
r_const
r_struct
id|atmdev_ops
id|ops
op_assign
(brace
id|dev_close
suffix:colon
id|lanai_dev_close
comma
id|open
suffix:colon
id|lanai_open
comma
id|close
suffix:colon
id|lanai_close
comma
id|ioctl
suffix:colon
id|lanai_ioctl
comma
id|getsockopt
suffix:colon
l_int|NULL
comma
id|setsockopt
suffix:colon
l_int|NULL
comma
id|send
suffix:colon
id|lanai_send
comma
id|sg_send
suffix:colon
l_int|NULL
comma
multiline_comment|/* no scatter-gather on card */
id|send_oam
suffix:colon
l_int|NULL
comma
multiline_comment|/* OAM support not in linux yet */
id|phy_put
suffix:colon
l_int|NULL
comma
id|phy_get
suffix:colon
l_int|NULL
comma
id|feedback
suffix:colon
l_int|NULL
comma
id|change_qos
suffix:colon
id|lanai_change_qos
comma
id|free_rx_skb
suffix:colon
l_int|NULL
comma
id|proc_read
suffix:colon
id|lanai_proc_read
)brace
suffix:semicolon
multiline_comment|/* detect one type of card LANAI2 or LANAIHB */
DECL|function|lanai_detect_1
r_static
r_int
id|__init
id|lanai_detect_1
c_func
(paren
r_int
r_int
id|vendor
comma
r_int
r_int
id|device
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|lanai_dev
op_star
id|lanai
suffix:semicolon
r_struct
id|atm_dev
op_star
id|atmdev
suffix:semicolon
r_int
id|count
op_assign
l_int|0
comma
id|result
suffix:semicolon
r_while
c_loop
(paren
(paren
id|pci
op_assign
id|pci_find_device
c_func
(paren
id|vendor
comma
id|device
comma
id|pci
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|lanai
op_assign
(paren
r_struct
id|lanai_dev
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|lanai
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lanai
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: couldn&squot;t allocate &quot;
l_string|&quot;dev_data structure!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|atmdev
op_assign
id|atm_dev_register
c_func
(paren
id|DEV_LABEL
comma
op_amp
id|ops
comma
op_minus
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atmdev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: couldn&squot;t register &quot;
l_string|&quot;atm device!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|atmdev-&gt;dev_data
op_assign
id|lanai
suffix:semicolon
id|lanai-&gt;pci
op_assign
id|pci
suffix:semicolon
id|lanai-&gt;type
op_assign
(paren
r_enum
id|lanai_type
)paren
id|device
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|lanai_dev_open
c_func
(paren
id|atmdev
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;lanai_start() failed, err=%d&bslash;n&quot;
comma
op_minus
id|result
)paren
suffix:semicolon
id|atm_dev_deregister
c_func
(paren
id|atmdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lanai
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
macro_line|#ifdef MODULE
r_static
macro_line|#endif
DECL|function|lanai_detect
r_int
id|__init
id|lanai_detect
c_func
(paren
r_void
)paren
(brace
r_return
id|lanai_detect_1
c_func
(paren
id|PCI_VENDOR_ID_EF
comma
id|PCI_VENDOR_ID_EF_ATM_LANAI2
)paren
op_plus
id|lanai_detect_1
c_func
(paren
id|PCI_VENDOR_ID_EF
comma
id|PCI_VENDOR_ID_EF_ATM_LANAIHB
)paren
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|lanai_detect
c_func
(paren
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DEV_LABEL
l_string|&quot;: no adaptor found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* We&squot;ll only get called when all the interfaces are already&n;&t; * gone, so there isn&squot;t much to do&n;&t; */
id|DPRINTK
c_func
(paren
l_string|&quot;cleanup_module()&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Mitchell Blank Jr &lt;mitch@sfgoth.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Efficient Networks Speedstream 3010 driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#endif /* MODULE */
eof
