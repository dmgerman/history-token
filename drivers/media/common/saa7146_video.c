macro_line|#include &lt;media/saa7146_vv.h&gt;
DECL|variable|memory
r_static
r_int
id|memory
op_assign
l_int|32
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|memory
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|memory
comma
l_string|&quot;maximum memory usage for capture buffers (default: 32Mb)&quot;
)paren
suffix:semicolon
multiline_comment|/* format descriptions for capture and preview */
DECL|variable|formats
r_static
r_struct
id|saa7146_format
id|formats
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;RGB-8 (3-3-2)&quot;
comma
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_RGB332
comma
dot
id|trans
op_assign
id|RGB08_COMPOSED
comma
dot
id|depth
op_assign
l_int|8
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;RGB-16 (5/B-6/G-5/R)&quot;
comma
multiline_comment|/* really? */
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_RGB565
comma
dot
id|trans
op_assign
id|RGB16_COMPOSED
comma
dot
id|depth
op_assign
l_int|16
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;RGB-24 (B-G-R)&quot;
comma
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_BGR24
comma
dot
id|trans
op_assign
id|RGB24_COMPOSED
comma
dot
id|depth
op_assign
l_int|24
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;RGB-32 (B-G-R)&quot;
comma
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_BGR32
comma
dot
id|trans
op_assign
id|RGB32_COMPOSED
comma
dot
id|depth
op_assign
l_int|32
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Greyscale-8&quot;
comma
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_GREY
comma
dot
id|trans
op_assign
id|Y8
comma
dot
id|depth
op_assign
l_int|8
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;YUV 4:2:2 planar (Y-Cb-Cr)&quot;
comma
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_YUV422P
comma
dot
id|trans
op_assign
id|YUV422_DECOMPOSED
comma
dot
id|depth
op_assign
l_int|16
comma
dot
id|swap
op_assign
l_int|1
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;YVU 4:2:0 planar (Y-Cb-Cr)&quot;
comma
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_YVU420
comma
dot
id|trans
op_assign
id|YUV420_DECOMPOSED
comma
dot
id|depth
op_assign
l_int|12
comma
dot
id|swap
op_assign
l_int|1
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;YUV 4:2:0 planar (Y-Cb-Cr)&quot;
comma
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_YUV420
comma
dot
id|trans
op_assign
id|YUV420_DECOMPOSED
comma
dot
id|depth
op_assign
l_int|12
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;YUV 4:2:2 (U-Y-V-Y)&quot;
comma
dot
id|pixelformat
op_assign
id|V4L2_PIX_FMT_UYVY
comma
dot
id|trans
op_assign
id|YUV422_COMPOSED
comma
dot
id|depth
op_assign
l_int|16
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* unfortunately, the saa7146 contains a bug which prevents it from doing on-the-fly byte swaps.&n;   due to this, it&squot;s impossible to provide additional *packed* formats, which are simply byte swapped&n;   (like V4L2_PIX_FMT_YUYV) ... 8-( */
DECL|variable|NUM_FORMATS
r_static
r_int
id|NUM_FORMATS
op_assign
r_sizeof
(paren
id|formats
)paren
op_div
r_sizeof
(paren
r_struct
id|saa7146_format
)paren
suffix:semicolon
DECL|function|format_by_fourcc
r_struct
id|saa7146_format
op_star
id|format_by_fourcc
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_int
id|fourcc
)paren
(brace
r_int
id|i
comma
id|j
op_assign
id|NUM_FORMATS
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|j
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|formats
(braket
id|i
)braket
dot
id|pixelformat
op_eq
id|fourcc
)paren
(brace
r_return
id|formats
op_plus
id|i
suffix:semicolon
)brace
)brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;unknown pixelformat:&squot;%4.4s&squot;&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|fourcc
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|g_fmt
r_static
r_int
id|g_fmt
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
comma
r_struct
id|v4l2_format
op_star
id|f
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;dev:%p, fh:%p&bslash;n&quot;
comma
id|dev
comma
id|fh
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|f-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
id|f-&gt;fmt.pix
op_assign
id|fh-&gt;video_fmt
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|V4L2_BUF_TYPE_VIDEO_OVERLAY
suffix:colon
id|f-&gt;fmt.win
op_assign
id|fh-&gt;ov.win
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|V4L2_BUF_TYPE_VBI_CAPTURE
suffix:colon
(brace
id|f-&gt;fmt.vbi
op_assign
id|fh-&gt;vbi_fmt
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;invalid format type &squot;%d&squot;.&bslash;n&quot;
comma
id|f-&gt;type
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|try_win
r_static
r_int
id|try_win
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|v4l2_window
op_star
id|win
)paren
(brace
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_enum
id|v4l2_field
id|field
suffix:semicolon
r_int
id|maxw
comma
id|maxh
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;dev:%p&bslash;n&quot;
comma
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|vv-&gt;ov_fb.base
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;no fb base set.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|vv-&gt;ov_fmt
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;no fb fmt set.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|win-&gt;w.width
OL
l_int|64
op_logical_or
id|win-&gt;w.height
OL
l_int|64
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;min width/height. (%d,%d)&bslash;n&quot;
comma
id|win-&gt;w.width
comma
id|win-&gt;w.height
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|win-&gt;clipcount
OG
l_int|16
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;clipcount too big.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|field
op_assign
id|win-&gt;field
suffix:semicolon
id|maxw
op_assign
id|vv-&gt;standard-&gt;h_max_out
suffix:semicolon
id|maxh
op_assign
id|vv-&gt;standard-&gt;v_max_out
suffix:semicolon
r_if
c_cond
(paren
id|V4L2_FIELD_ANY
op_eq
id|field
)paren
(brace
id|field
op_assign
(paren
id|win-&gt;w.height
OG
id|maxh
op_div
l_int|2
)paren
ques
c_cond
id|V4L2_FIELD_INTERLACED
suffix:colon
id|V4L2_FIELD_TOP
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|field
)paren
(brace
r_case
id|V4L2_FIELD_TOP
suffix:colon
r_case
id|V4L2_FIELD_BOTTOM
suffix:colon
r_case
id|V4L2_FIELD_ALTERNATE
suffix:colon
id|maxh
op_assign
id|maxh
op_div
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_INTERLACED
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;no known field mode &squot;%d&squot;.&bslash;n&quot;
comma
id|field
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|win-&gt;field
op_assign
id|field
suffix:semicolon
r_if
c_cond
(paren
id|win-&gt;w.width
OG
id|maxw
)paren
id|win-&gt;w.width
op_assign
id|maxw
suffix:semicolon
r_if
c_cond
(paren
id|win-&gt;w.height
OG
id|maxh
)paren
id|win-&gt;w.height
op_assign
id|maxh
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|try_fmt
r_static
r_int
id|try_fmt
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
comma
r_struct
id|v4l2_format
op_star
id|f
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|f-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
(brace
r_struct
id|saa7146_format
op_star
id|fmt
suffix:semicolon
r_enum
id|v4l2_field
id|field
suffix:semicolon
r_int
id|maxw
comma
id|maxh
suffix:semicolon
r_int
id|calc_bpl
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;V4L2_BUF_TYPE_VIDEO_CAPTURE: dev:%p, fh:%p&bslash;n&quot;
comma
id|dev
comma
id|fh
)paren
)paren
suffix:semicolon
id|fmt
op_assign
id|format_by_fourcc
c_func
(paren
id|dev
comma
id|f-&gt;fmt.pix.pixelformat
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|fmt
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|field
op_assign
id|f-&gt;fmt.pix.field
suffix:semicolon
id|maxw
op_assign
id|vv-&gt;standard-&gt;h_max_out
suffix:semicolon
id|maxh
op_assign
id|vv-&gt;standard-&gt;v_max_out
suffix:semicolon
r_if
c_cond
(paren
id|V4L2_FIELD_ANY
op_eq
id|field
)paren
(brace
id|field
op_assign
(paren
id|f-&gt;fmt.pix.height
OG
id|maxh
op_div
l_int|2
)paren
ques
c_cond
id|V4L2_FIELD_INTERLACED
suffix:colon
id|V4L2_FIELD_BOTTOM
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|field
)paren
(brace
r_case
id|V4L2_FIELD_ALTERNATE
suffix:colon
(brace
id|vv-&gt;last_field
op_assign
id|V4L2_FIELD_TOP
suffix:semicolon
id|maxh
op_assign
id|maxh
op_div
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|V4L2_FIELD_TOP
suffix:colon
r_case
id|V4L2_FIELD_BOTTOM
suffix:colon
id|vv-&gt;last_field
op_assign
id|V4L2_FIELD_INTERLACED
suffix:semicolon
id|maxh
op_assign
id|maxh
op_div
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_INTERLACED
suffix:colon
id|vv-&gt;last_field
op_assign
id|V4L2_FIELD_INTERLACED
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;no known field mode &squot;%d&squot;.&bslash;n&quot;
comma
id|field
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|f-&gt;fmt.pix.field
op_assign
id|field
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;fmt.pix.width
OG
id|maxw
)paren
id|f-&gt;fmt.pix.width
op_assign
id|maxw
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;fmt.pix.height
OG
id|maxh
)paren
id|f-&gt;fmt.pix.height
op_assign
id|maxh
suffix:semicolon
id|calc_bpl
op_assign
(paren
id|f-&gt;fmt.pix.width
op_star
id|fmt-&gt;depth
)paren
op_div
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;fmt.pix.bytesperline
OL
id|calc_bpl
)paren
id|f-&gt;fmt.pix.bytesperline
op_assign
id|calc_bpl
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;fmt.pix.bytesperline
OG
(paren
l_int|2
op_star
id|PAGE_SIZE
op_star
id|fmt-&gt;depth
)paren
op_div
l_int|8
)paren
multiline_comment|/* arbitrary constraint */
id|f-&gt;fmt.pix.bytesperline
op_assign
id|calc_bpl
suffix:semicolon
id|f-&gt;fmt.pix.sizeimage
op_assign
id|f-&gt;fmt.pix.bytesperline
op_star
id|f-&gt;fmt.pix.height
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;w:%d, h:%d, bytesperline:%d, sizeimage:%d&bslash;n&quot;
comma
id|f-&gt;fmt.pix.width
comma
id|f-&gt;fmt.pix.height
comma
id|f-&gt;fmt.pix.bytesperline
comma
id|f-&gt;fmt.pix.sizeimage
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|V4L2_BUF_TYPE_VIDEO_OVERLAY
suffix:colon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;V4L2_BUF_TYPE_VIDEO_OVERLAY: dev:%p, fh:%p&bslash;n&quot;
comma
id|dev
comma
id|fh
)paren
)paren
suffix:semicolon
id|err
op_assign
id|try_win
c_func
(paren
id|dev
comma
op_amp
id|f-&gt;fmt.win
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;unknown format type &squot;%d&squot;&bslash;n&quot;
comma
id|f-&gt;type
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|saa7146_start_preview
r_int
id|saa7146_start_preview
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;dev:%p, fh:%p&bslash;n&quot;
comma
id|dev
comma
id|fh
)paren
)paren
suffix:semicolon
multiline_comment|/* check if we have overlay informations */
r_if
c_cond
(paren
l_int|NULL
op_eq
id|fh-&gt;ov.fh
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;not overlay data available. try S_FMT first.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* check if overlay is running */
r_if
c_cond
(paren
l_int|0
op_ne
id|vv-&gt;ov_data
)paren
(brace
r_if
c_cond
(paren
id|fh
op_ne
id|vv-&gt;ov_data-&gt;fh
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;overlay is running in another open.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;overlay is already active.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_ne
id|vv-&gt;streaming
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;streaming capture is active.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|err
op_assign
id|try_win
c_func
(paren
id|dev
comma
op_amp
id|fh-&gt;ov.win
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
id|vv-&gt;ov_data
op_assign
op_amp
id|fh-&gt;ov
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;%dx%d+%d+%d %s field=%s&bslash;n&quot;
comma
id|fh-&gt;ov.win.w.width
comma
id|fh-&gt;ov.win.w.height
comma
id|fh-&gt;ov.win.w.left
comma
id|fh-&gt;ov.win.w.top
comma
id|vv-&gt;ov_fmt-&gt;name
comma
id|v4l2_field_names
(braket
id|fh-&gt;ov.win.field
)braket
)paren
)paren
suffix:semicolon
id|saa7146_set_overlay
c_func
(paren
id|dev
comma
id|fh
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa7146_stop_preview
r_int
id|saa7146_stop_preview
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;saa7146.o: saa7146_stop_preview()&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* check if overlay is running */
r_if
c_cond
(paren
l_int|0
op_eq
id|vv-&gt;ov_data
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;overlay is not active.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fh
op_ne
id|vv-&gt;ov_data-&gt;fh
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;overlay is active, but for another open.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|saa7146_set_overlay
c_func
(paren
id|dev
comma
id|fh
comma
l_int|0
)paren
suffix:semicolon
id|vv-&gt;ov_data
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s_fmt
r_static
r_int
id|s_fmt
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
comma
r_struct
id|v4l2_format
op_star
id|f
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|f-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;V4L2_BUF_TYPE_VIDEO_CAPTURE: dev:%p, fh:%p&bslash;n&quot;
comma
id|dev
comma
id|fh
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh
op_eq
id|vv-&gt;streaming
)paren
(brace
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;streaming capture is active&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|err
op_assign
id|try_fmt
c_func
(paren
id|fh
comma
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
r_return
id|err
suffix:semicolon
id|fh-&gt;video_fmt
op_assign
id|f-&gt;fmt.pix
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;set to pixelformat &squot;%4.4s&squot;&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|fh-&gt;video_fmt.pixelformat
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|V4L2_BUF_TYPE_VIDEO_OVERLAY
suffix:colon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;V4L2_BUF_TYPE_VIDEO_OVERLAY: dev:%p, fh:%p&bslash;n&quot;
comma
id|dev
comma
id|fh
)paren
)paren
suffix:semicolon
id|err
op_assign
id|try_win
c_func
(paren
id|dev
comma
op_amp
id|f-&gt;fmt.win
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
r_return
id|err
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|fh-&gt;ov.win
op_assign
id|f-&gt;fmt.win
suffix:semicolon
id|fh-&gt;ov.nclips
op_assign
id|f-&gt;fmt.win.clipcount
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;ov.nclips
OG
l_int|16
)paren
id|fh-&gt;ov.nclips
op_assign
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|fh-&gt;ov.clips
comma
id|f-&gt;fmt.win.clips
comma
r_sizeof
(paren
r_struct
id|v4l2_clip
)paren
op_star
id|fh-&gt;ov.nclips
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* fh-&gt;ov.fh is used to indicate that we have valid overlay informations, too */
id|fh-&gt;ov.fh
op_assign
id|fh
suffix:semicolon
multiline_comment|/* check if we have an active overlay */
r_if
c_cond
(paren
id|vv-&gt;ov_data
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|fh
op_eq
id|vv-&gt;ov_data-&gt;fh
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
id|saa7146_stop_preview
c_func
(paren
id|fh
)paren
suffix:semicolon
id|saa7146_start_preview
c_func
(paren
id|fh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;unknown format type &squot;%d&squot;&bslash;n&quot;
comma
id|f-&gt;type
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/********************************************************************************/
multiline_comment|/* device controls */
DECL|variable|controls
r_static
r_struct
id|v4l2_queryctrl
id|controls
(braket
)braket
op_assign
(brace
(brace
id|id
suffix:colon
id|V4L2_CID_BRIGHTNESS
comma
id|name
suffix:colon
l_string|&quot;Brightness&quot;
comma
id|minimum
suffix:colon
l_int|0
comma
id|maximum
suffix:colon
l_int|255
comma
id|step
suffix:colon
l_int|1
comma
id|default_value
suffix:colon
l_int|128
comma
id|type
suffix:colon
id|V4L2_CTRL_TYPE_INTEGER
comma
)brace
comma
(brace
id|id
suffix:colon
id|V4L2_CID_CONTRAST
comma
id|name
suffix:colon
l_string|&quot;Contrast&quot;
comma
id|minimum
suffix:colon
l_int|0
comma
id|maximum
suffix:colon
l_int|127
comma
id|step
suffix:colon
l_int|1
comma
id|default_value
suffix:colon
l_int|64
comma
id|type
suffix:colon
id|V4L2_CTRL_TYPE_INTEGER
comma
)brace
comma
(brace
id|id
suffix:colon
id|V4L2_CID_SATURATION
comma
id|name
suffix:colon
l_string|&quot;Saturation&quot;
comma
id|minimum
suffix:colon
l_int|0
comma
id|maximum
suffix:colon
l_int|127
comma
id|step
suffix:colon
l_int|1
comma
id|default_value
suffix:colon
l_int|64
comma
id|type
suffix:colon
id|V4L2_CTRL_TYPE_INTEGER
comma
)brace
comma
(brace
id|id
suffix:colon
id|V4L2_CID_VFLIP
comma
id|name
suffix:colon
l_string|&quot;Vertical flip&quot;
comma
id|minimum
suffix:colon
l_int|0
comma
id|maximum
suffix:colon
l_int|1
comma
id|type
suffix:colon
id|V4L2_CTRL_TYPE_BOOLEAN
comma
)brace
comma
(brace
id|id
suffix:colon
id|V4L2_CID_HFLIP
comma
id|name
suffix:colon
l_string|&quot;Horizontal flip&quot;
comma
id|minimum
suffix:colon
l_int|0
comma
id|maximum
suffix:colon
l_int|1
comma
id|type
suffix:colon
id|V4L2_CTRL_TYPE_BOOLEAN
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|NUM_CONTROLS
r_static
r_int
id|NUM_CONTROLS
op_assign
r_sizeof
(paren
id|controls
)paren
op_div
r_sizeof
(paren
r_struct
id|v4l2_queryctrl
)paren
suffix:semicolon
DECL|macro|V4L2_CID_PRIVATE_LASTP1
mdefine_line|#define V4L2_CID_PRIVATE_LASTP1      (V4L2_CID_PRIVATE_BASE + 0)
DECL|function|ctrl_by_id
r_static
r_struct
id|v4l2_queryctrl
op_star
id|ctrl_by_id
c_func
(paren
r_int
id|id
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CONTROLS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|controls
(braket
id|i
)braket
dot
id|id
op_eq
id|id
)paren
r_return
id|controls
op_plus
id|i
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|get_control
r_static
r_int
id|get_control
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
comma
r_struct
id|v4l2_control
op_star
id|c
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_const
r_struct
id|v4l2_queryctrl
op_star
id|ctrl
suffix:semicolon
id|u32
id|value
op_assign
l_int|0
suffix:semicolon
id|ctrl
op_assign
id|ctrl_by_id
c_func
(paren
id|c-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|ctrl
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;id
)paren
(brace
r_case
id|V4L2_CID_BRIGHTNESS
suffix:colon
id|value
op_assign
id|saa7146_read
c_func
(paren
id|dev
comma
id|BCS_CTRL
)paren
suffix:semicolon
id|c-&gt;value
op_assign
l_int|0xff
op_amp
(paren
id|value
op_rshift
l_int|24
)paren
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;V4L2_CID_BRIGHTNESS: %d&bslash;n&quot;
comma
id|c-&gt;value
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_CONTRAST
suffix:colon
id|value
op_assign
id|saa7146_read
c_func
(paren
id|dev
comma
id|BCS_CTRL
)paren
suffix:semicolon
id|c-&gt;value
op_assign
l_int|0x7f
op_amp
(paren
id|value
op_rshift
l_int|16
)paren
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;V4L2_CID_CONTRAST: %d&bslash;n&quot;
comma
id|c-&gt;value
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_SATURATION
suffix:colon
id|value
op_assign
id|saa7146_read
c_func
(paren
id|dev
comma
id|BCS_CTRL
)paren
suffix:semicolon
id|c-&gt;value
op_assign
l_int|0x7f
op_amp
(paren
id|value
op_rshift
l_int|0
)paren
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;V4L2_CID_SATURATION: %d&bslash;n&quot;
comma
id|c-&gt;value
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_VFLIP
suffix:colon
id|c-&gt;value
op_assign
id|vv-&gt;vflip
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;V4L2_CID_VFLIP: %d&bslash;n&quot;
comma
id|c-&gt;value
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_HFLIP
suffix:colon
id|c-&gt;value
op_assign
id|vv-&gt;hflip
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;V4L2_CID_HFLIP: %d&bslash;n&quot;
comma
id|c-&gt;value
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_control
r_static
r_int
id|set_control
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
comma
r_struct
id|v4l2_control
op_star
id|c
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_const
r_struct
id|v4l2_queryctrl
op_star
id|ctrl
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|restart_overlay
op_assign
l_int|0
suffix:semicolon
id|ctrl
op_assign
id|ctrl_by_id
c_func
(paren
id|c-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|ctrl
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;unknown control %d&bslash;n&quot;
comma
id|c-&gt;id
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ctrl-&gt;type
)paren
(brace
r_case
id|V4L2_CTRL_TYPE_BOOLEAN
suffix:colon
r_case
id|V4L2_CTRL_TYPE_MENU
suffix:colon
r_case
id|V4L2_CTRL_TYPE_INTEGER
suffix:colon
r_if
c_cond
(paren
id|c-&gt;value
OL
id|ctrl-&gt;minimum
)paren
id|c-&gt;value
op_assign
id|ctrl-&gt;minimum
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;value
OG
id|ctrl-&gt;maximum
)paren
id|c-&gt;value
op_assign
id|ctrl-&gt;maximum
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* nothing */
suffix:semicolon
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|c-&gt;id
)paren
(brace
r_case
id|V4L2_CID_BRIGHTNESS
suffix:colon
(brace
id|u32
id|value
op_assign
id|saa7146_read
c_func
(paren
id|dev
comma
id|BCS_CTRL
)paren
suffix:semicolon
id|value
op_and_assign
l_int|0x00ffffff
suffix:semicolon
id|value
op_or_assign
(paren
id|c-&gt;value
op_lshift
l_int|24
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|dev
comma
id|BCS_CTRL
comma
id|value
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|dev
comma
id|MC2
comma
id|MASK_22
op_or
id|MASK_06
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|V4L2_CID_CONTRAST
suffix:colon
(brace
id|u32
id|value
op_assign
id|saa7146_read
c_func
(paren
id|dev
comma
id|BCS_CTRL
)paren
suffix:semicolon
id|value
op_and_assign
l_int|0xff00ffff
suffix:semicolon
id|value
op_or_assign
(paren
id|c-&gt;value
op_lshift
l_int|16
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|dev
comma
id|BCS_CTRL
comma
id|value
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|dev
comma
id|MC2
comma
id|MASK_22
op_or
id|MASK_06
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|V4L2_CID_SATURATION
suffix:colon
(brace
id|u32
id|value
op_assign
id|saa7146_read
c_func
(paren
id|dev
comma
id|BCS_CTRL
)paren
suffix:semicolon
id|value
op_and_assign
l_int|0xffffff00
suffix:semicolon
id|value
op_or_assign
(paren
id|c-&gt;value
op_lshift
l_int|0
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|dev
comma
id|BCS_CTRL
comma
id|value
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|dev
comma
id|MC2
comma
id|MASK_22
op_or
id|MASK_06
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|V4L2_CID_HFLIP
suffix:colon
multiline_comment|/* fixme: we can supfhrt changing VFLIP and HFLIP here... */
r_if
c_cond
(paren
l_int|0
op_ne
id|vv-&gt;streaming
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;V4L2_CID_HFLIP while active capture.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|vv-&gt;hflip
op_assign
id|c-&gt;value
suffix:semicolon
id|restart_overlay
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_VFLIP
suffix:colon
r_if
c_cond
(paren
l_int|0
op_ne
id|vv-&gt;streaming
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;V4L2_CID_VFLIP while active capture.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|vv-&gt;vflip
op_assign
id|c-&gt;value
suffix:semicolon
id|restart_overlay
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
l_int|0
op_ne
id|restart_overlay
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_ne
id|vv-&gt;ov_data
)paren
(brace
r_if
c_cond
(paren
id|fh
op_eq
id|vv-&gt;ov_data-&gt;fh
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
id|saa7146_stop_preview
c_func
(paren
id|fh
)paren
suffix:semicolon
id|saa7146_start_preview
c_func
(paren
id|fh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/********************************************************************************/
multiline_comment|/* common pagetable functions */
DECL|function|saa7146_pgtable_build
r_static
r_int
id|saa7146_pgtable_build
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|saa7146_buf
op_star
id|buf
)paren
(brace
r_struct
id|pci_dev
op_star
id|pci
op_assign
id|dev-&gt;pci
suffix:semicolon
r_struct
id|scatterlist
op_star
id|list
op_assign
id|buf-&gt;vb.dma.sglist
suffix:semicolon
r_int
id|length
op_assign
id|buf-&gt;vb.dma.sglen
suffix:semicolon
r_struct
id|saa7146_format
op_star
id|sfmt
op_assign
id|format_by_fourcc
c_func
(paren
id|dev
comma
id|buf-&gt;fmt-&gt;pixelformat
)paren
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;dev:%p, buf:%p, sg_len:%d&bslash;n&quot;
comma
id|dev
comma
id|buf
comma
id|length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|IS_PLANAR
c_func
(paren
id|sfmt-&gt;trans
)paren
)paren
(brace
r_struct
id|saa7146_pgtable
op_star
id|pt1
op_assign
op_amp
id|buf-&gt;pt
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|saa7146_pgtable
op_star
id|pt2
op_assign
op_amp
id|buf-&gt;pt
(braket
l_int|1
)braket
suffix:semicolon
r_struct
id|saa7146_pgtable
op_star
id|pt3
op_assign
op_amp
id|buf-&gt;pt
(braket
l_int|2
)braket
suffix:semicolon
id|u32
op_star
id|ptr1
comma
op_star
id|ptr2
comma
op_star
id|ptr3
suffix:semicolon
id|u32
id|fill
suffix:semicolon
r_int
id|size
op_assign
id|buf-&gt;fmt-&gt;width
op_star
id|buf-&gt;fmt-&gt;height
suffix:semicolon
r_int
id|i
comma
id|p
comma
id|m1
comma
id|m2
comma
id|m3
comma
id|o1
comma
id|o2
suffix:semicolon
r_switch
c_cond
(paren
id|sfmt-&gt;depth
)paren
(brace
r_case
l_int|12
suffix:colon
(brace
multiline_comment|/* create some offsets inside the page table */
id|m1
op_assign
(paren
(paren
id|size
op_plus
id|PAGE_SIZE
)paren
op_div
id|PAGE_SIZE
)paren
op_minus
l_int|1
suffix:semicolon
id|m2
op_assign
(paren
(paren
id|size
op_plus
(paren
id|size
op_div
l_int|4
)paren
op_plus
id|PAGE_SIZE
)paren
op_div
id|PAGE_SIZE
)paren
op_minus
l_int|1
suffix:semicolon
id|m3
op_assign
(paren
(paren
id|size
op_plus
(paren
id|size
op_div
l_int|2
)paren
op_plus
id|PAGE_SIZE
)paren
op_div
id|PAGE_SIZE
)paren
op_minus
l_int|1
suffix:semicolon
id|o1
op_assign
id|size
op_mod
id|PAGE_SIZE
suffix:semicolon
id|o2
op_assign
(paren
id|size
op_plus
(paren
id|size
op_div
l_int|4
)paren
)paren
op_mod
id|PAGE_SIZE
suffix:semicolon
id|DEB_CAP
c_func
(paren
(paren
l_string|&quot;size:%d, m1:%d, m2:%d, m3:%d, o1:%d, o2:%d&bslash;n&quot;
comma
id|size
comma
id|m1
comma
id|m2
comma
id|m3
comma
id|o1
comma
id|o2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|16
suffix:colon
(brace
multiline_comment|/* create some offsets inside the page table */
id|m1
op_assign
(paren
(paren
id|size
op_plus
id|PAGE_SIZE
)paren
op_div
id|PAGE_SIZE
)paren
op_minus
l_int|1
suffix:semicolon
id|m2
op_assign
(paren
(paren
id|size
op_plus
(paren
id|size
op_div
l_int|2
)paren
op_plus
id|PAGE_SIZE
)paren
op_div
id|PAGE_SIZE
)paren
op_minus
l_int|1
suffix:semicolon
id|m3
op_assign
(paren
(paren
l_int|2
op_star
id|size
op_plus
id|PAGE_SIZE
)paren
op_div
id|PAGE_SIZE
)paren
op_minus
l_int|1
suffix:semicolon
id|o1
op_assign
id|size
op_mod
id|PAGE_SIZE
suffix:semicolon
id|o2
op_assign
(paren
id|size
op_plus
(paren
id|size
op_div
l_int|2
)paren
)paren
op_mod
id|PAGE_SIZE
suffix:semicolon
id|DEB_CAP
c_func
(paren
(paren
l_string|&quot;size:%d, m1:%d, m2:%d, m3:%d, o1:%d, o2:%d&bslash;n&quot;
comma
id|size
comma
id|m1
comma
id|m2
comma
id|m3
comma
id|o1
comma
id|o2
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|ptr1
op_assign
id|pt1-&gt;cpu
suffix:semicolon
id|ptr2
op_assign
id|pt2-&gt;cpu
suffix:semicolon
id|ptr3
op_assign
id|pt3-&gt;cpu
suffix:semicolon
multiline_comment|/* walk all pages, copy all page addresses to ptr1 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
comma
id|list
op_increment
)paren
(brace
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
op_star
l_int|4096
OL
id|list-&gt;length
suffix:semicolon
id|p
op_increment
comma
id|ptr1
op_increment
)paren
(brace
op_star
id|ptr1
op_assign
id|sg_dma_address
c_func
(paren
id|list
)paren
op_minus
id|list-&gt;offset
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t;ptr1 = pt1-&gt;cpu;&n;&t;&t;for(j=0;j&lt;40;j++) {&n;&t;&t;&t;printk(&quot;ptr1 %d: 0x%08x&bslash;n&quot;,j,ptr1[j]);&n;&t;&t;}&n;*/
multiline_comment|/* if we have a user buffer, the first page may not be&n;&t;&t;   aligned to a page boundary. */
id|pt1-&gt;offset
op_assign
id|buf-&gt;vb.dma.sglist-&gt;offset
suffix:semicolon
id|pt2-&gt;offset
op_assign
id|pt1-&gt;offset
op_plus
id|o1
suffix:semicolon
id|pt3-&gt;offset
op_assign
id|pt1-&gt;offset
op_plus
id|o2
suffix:semicolon
multiline_comment|/* create video-dma2 page table */
id|ptr1
op_assign
id|pt1-&gt;cpu
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|m1
suffix:semicolon
id|i
op_le
id|m2
suffix:semicolon
id|i
op_increment
comma
id|ptr2
op_increment
)paren
(brace
op_star
id|ptr2
op_assign
id|ptr1
(braket
id|i
)braket
suffix:semicolon
)brace
id|fill
op_assign
op_star
(paren
id|ptr2
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|1024
suffix:semicolon
id|i
op_increment
comma
id|ptr2
op_increment
)paren
(brace
op_star
id|ptr2
op_assign
id|fill
suffix:semicolon
)brace
multiline_comment|/* create video-dma3 page table */
id|ptr1
op_assign
id|pt1-&gt;cpu
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|m2
suffix:semicolon
id|i
op_le
id|m3
suffix:semicolon
id|i
op_increment
comma
id|ptr3
op_increment
)paren
(brace
op_star
id|ptr3
op_assign
id|ptr1
(braket
id|i
)braket
suffix:semicolon
)brace
id|fill
op_assign
op_star
(paren
id|ptr3
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|1024
suffix:semicolon
id|i
op_increment
comma
id|ptr3
op_increment
)paren
(brace
op_star
id|ptr3
op_assign
id|fill
suffix:semicolon
)brace
multiline_comment|/* finally: finish up video-dma1 page table */
id|ptr1
op_assign
id|pt1-&gt;cpu
op_plus
id|m1
suffix:semicolon
id|fill
op_assign
id|pt1-&gt;cpu
(braket
id|m1
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|m1
suffix:semicolon
id|i
OL
l_int|1024
suffix:semicolon
id|i
op_increment
comma
id|ptr1
op_increment
)paren
(brace
op_star
id|ptr1
op_assign
id|fill
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;ptr1 = pt1-&gt;cpu;&n;&t;&t;ptr2 = pt2-&gt;cpu;&n;&t;&t;ptr3 = pt3-&gt;cpu;&n;&t;&t;for(j=0;j&lt;40;j++) {&n;&t;&t;&t;printk(&quot;ptr1 %d: 0x%08x&bslash;n&quot;,j,ptr1[j]);&n;&t;&t;}&n;&t;&t;for(j=0;j&lt;40;j++) {&n;&t;&t;&t;printk(&quot;ptr2 %d: 0x%08x&bslash;n&quot;,j,ptr2[j]);&n;&t;&t;}&n;&t;&t;for(j=0;j&lt;40;j++) {&n;&t;&t;&t;printk(&quot;ptr3 %d: 0x%08x&bslash;n&quot;,j,ptr3[j]);&n;&t;&t;}&n;*/
)brace
r_else
(brace
r_struct
id|saa7146_pgtable
op_star
id|pt
op_assign
op_amp
id|buf-&gt;pt
(braket
l_int|0
)braket
suffix:semicolon
id|saa7146_pgtable_build_single
c_func
(paren
id|pci
comma
id|pt
comma
id|list
comma
id|length
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/********************************************************************************/
multiline_comment|/* file operations */
DECL|function|video_begin
r_static
r_int
id|video_begin
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;dev:%p, fh:%p&bslash;n&quot;
comma
id|dev
comma
id|fh
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh
op_eq
id|vv-&gt;streaming
)paren
(brace
id|DEB_S
c_func
(paren
(paren
l_string|&quot;already capturing.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vv-&gt;streaming
op_ne
l_int|0
)paren
(brace
id|DEB_S
c_func
(paren
(paren
l_string|&quot;already capturing, but in another open.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* fixme: check for planar formats here, if we will interfere with&n;&t;   vbi capture for example */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* clear out beginning of streaming bit (rps register 0)*/
id|saa7146_write
c_func
(paren
id|dev
comma
id|MC2
comma
id|MASK_27
)paren
suffix:semicolon
multiline_comment|/* enable rps0 irqs */
id|IER_ENABLE
c_func
(paren
id|dev
comma
id|MASK_27
)paren
suffix:semicolon
id|vv-&gt;streaming
op_assign
id|fh
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|video_end
r_static
r_int
id|video_end
c_func
(paren
r_struct
id|saa7146_fh
op_star
id|fh
)paren
(brace
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;dev:%p, fh:%p&bslash;n&quot;
comma
id|dev
comma
id|fh
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vv-&gt;streaming
op_ne
id|fh
)paren
(brace
id|DEB_S
c_func
(paren
(paren
l_string|&quot;not capturing.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* disable rps0  */
id|saa7146_write
c_func
(paren
id|dev
comma
id|MC1
comma
id|MASK_28
)paren
suffix:semicolon
multiline_comment|/* disable rps0 irqs */
id|IER_DISABLE
c_func
(paren
id|dev
comma
id|MASK_27
)paren
suffix:semicolon
singleline_comment|// fixme: only used formats here!
multiline_comment|/* fixme: look at planar formats here, especially at the&n;&t;   shutdown of planar formats! */
multiline_comment|/* shut down all used video dma transfers */
multiline_comment|/* fixme: what about the budget-dvb cards? they use&n;&t;   video-dma3, but video_end should not get called anyway ...*/
id|saa7146_write
c_func
(paren
id|dev
comma
id|MC1
comma
l_int|0x00700000
)paren
suffix:semicolon
id|vv-&gt;streaming
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* capturing to framebuffer */
DECL|function|overlay_reqbufs
r_int
id|overlay_reqbufs
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|v4l2_requestbuffers
op_star
id|req
)paren
(brace
multiline_comment|/*&t;struct saa7146_fh *fh = file-&gt;private_data;&n;&n;&t;if (req-&gt;count &gt; VIDEO_MAX_FRAME)&n;&t;&t;req-&gt;count = VIDEO_MAX_FRAME;&n;&n;&t;*size = fh-&gt;video_fmt.sizeimage;&n;&n;*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|overlay_querybuf
r_int
id|overlay_querybuf
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|v4l2_buffer
op_star
id|buf
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|overlay_qbuf
r_int
id|overlay_qbuf
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|v4l2_buffer
op_star
id|b
)paren
(brace
multiline_comment|/*&t;if (b-&gt;index &lt; 0 || b-&gt;index &gt;= VIDEO_MAX_FRAME) {&n;&t;&t;DEB_D((&quot;index %d out of bounds.&bslash;n&quot;,b-&gt;index));&n;&t;&t;goto -EINVAL;&n;&t;}&n;&t;&n;&t;buf = q-&gt;bufs[b-&gt;index];&n;&t;if (NULL == buf) {&n;&t;&t;printk(&quot;videobuf_qbuf: NULL == buf&bslash;n&quot;);&n;&t;&t;goto done;&n;&t;}&n;&t;if (0 == buf-&gt;baddr) {&n;&t;&t;printk(&quot;videobuf_qbuf: 0 == buf-&gt;baddr&bslash;n&quot;);&n;&t;&t;goto done;&n;&t;}&n;&t;if (buf-&gt;state == STATE_QUEUED ||&n;&t;    buf-&gt;state == STATE_ACTIVE) {&n;&t;&t;printk(&quot;videobuf_qbuf: already queued or activated.&bslash;n&quot;);&n;&t;&t;goto done;&n;&t;}&n;&n;&t;field = videobuf_next_field(q);&n;&t;retval = q-&gt;ops-&gt;buf_prepare(file,buf,field);&n;&t;if (0 != retval) {&n;&t;&t;printk(&quot;videobuf_qbuf: buf_prepare() failed.&bslash;n&quot;);&n;&t;&t;goto done;&n;&t;}&n;&t;&n;&t;list_add_tail(&amp;buf-&gt;stream,&amp;q-&gt;stream);&n;&t;if (q-&gt;streaming) {&n;&t;&t;spin_lock_irqsave(q-&gt;irqlock,flags);&n;&t;&t;q-&gt;ops-&gt;buf_queue(file,buf);&n;&t;&t;spin_unlock_irqrestore(q-&gt;irqlock,flags);&n;&t;}&n;&t;retval = 0;&n;&t;&n; done:&n;&t;up(&amp;q-&gt;lock);&n;&t;return retval;&n;*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|overlay_dqbuf
r_int
id|overlay_dqbuf
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|v4l2_buffer
op_star
id|buf
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|overlay_streamon
r_int
id|overlay_streamon
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|overlay_streamoff
r_int
id|overlay_streamoff
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is _not_ called directly, but from&n; * video_generic_ioctl (and maybe others).  userspace&n; * copying is done already, arg is a kernel fhinter.&n; */
DECL|function|saa7146_video_do_ioctl
r_int
id|saa7146_video_do_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|saa7146_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
op_assign
l_int|0
comma
id|result
op_assign
l_int|0
comma
id|ee
op_assign
l_int|0
suffix:semicolon
r_struct
id|saa7146_use_ops
op_star
id|ops
suffix:semicolon
r_struct
id|videobuf_queue
op_star
id|q
suffix:semicolon
multiline_comment|/* check if extension handles the command */
r_for
c_loop
(paren
id|ee
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;ext_vv_data-&gt;ioctls
(braket
id|ee
)braket
dot
id|flags
op_ne
l_int|0
suffix:semicolon
id|ee
op_increment
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|dev-&gt;ext_vv_data-&gt;ioctls
(braket
id|ee
)braket
dot
id|cmd
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|dev-&gt;ext_vv_data-&gt;ioctls
(braket
id|ee
)braket
dot
id|flags
op_amp
id|SAA7146_EXCLUSIVE
)paren
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;extension handles ioctl exclusive.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
id|dev-&gt;ext_vv_data
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|fh
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|dev-&gt;ext_vv_data-&gt;ioctls
(braket
id|ee
)braket
dot
id|flags
op_amp
id|SAA7146_BEFORE
)paren
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;extension handles ioctl before.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
id|dev-&gt;ext_vv_data
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|fh
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_minus
id|EAGAIN
op_ne
id|result
)paren
(brace
r_return
id|result
suffix:semicolon
)brace
)brace
multiline_comment|/* fixme: add handle &quot;after&quot; case (is it still needed?) */
r_switch
c_cond
(paren
id|fh-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
(brace
id|ops
op_assign
op_amp
id|saa7146_video_uops
suffix:semicolon
id|q
op_assign
op_amp
id|fh-&gt;video_q
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|V4L2_BUF_TYPE_VBI_CAPTURE
suffix:colon
(brace
id|ops
op_assign
op_amp
id|saa7146_vbi_uops
suffix:semicolon
id|q
op_assign
op_amp
id|fh-&gt;vbi_q
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOC_QUERYCAP
suffix:colon
(brace
r_struct
id|v4l2_capability
op_star
id|cap
op_assign
id|arg
suffix:semicolon
id|memset
c_func
(paren
id|cap
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cap
)paren
)paren
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_QUERYCAP&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|cap-&gt;driver
comma
l_string|&quot;saa7146 v4l2&quot;
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|cap-&gt;card
comma
id|dev-&gt;ext-&gt;name
comma
r_sizeof
(paren
id|cap-&gt;card
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|cap-&gt;bus_info
comma
l_string|&quot;PCI:%s&quot;
comma
id|dev-&gt;pci-&gt;slot_name
)paren
suffix:semicolon
id|cap-&gt;version
op_assign
id|SAA7146_VERSION_CODE
suffix:semicolon
id|cap-&gt;capabilities
op_assign
id|V4L2_CAP_VIDEO_CAPTURE
op_or
id|V4L2_CAP_VIDEO_OVERLAY
op_or
id|V4L2_CAP_READWRITE
op_or
id|V4L2_CAP_STREAMING
suffix:semicolon
id|cap-&gt;capabilities
op_or_assign
id|dev-&gt;ext_vv_data-&gt;capabilities
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOC_G_FBUF
suffix:colon
(brace
r_struct
id|v4l2_framebuffer
op_star
id|fb
op_assign
id|arg
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_G_FBUF&bslash;n&quot;
)paren
)paren
suffix:semicolon
op_star
id|fb
op_assign
id|vv-&gt;ov_fb
suffix:semicolon
id|fb-&gt;capability
op_assign
id|V4L2_FBUF_CAP_LIST_CLIPPING
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOC_S_FBUF
suffix:colon
(brace
r_struct
id|v4l2_framebuffer
op_star
id|fb
op_assign
id|arg
suffix:semicolon
r_struct
id|saa7146_format
op_star
id|fmt
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_S_FBUF&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;if(!capable(CAP_SYS_ADMIN)) { // &amp;&amp; !capable(CAP_SYS_RAWIO)) {&n;&t;&t;&t;DEB_D((&quot;VIDIOC_S_FBUF: not CAP_SYS_ADMIN or CAP_SYS_RAWIO.&bslash;n&quot;));&n;&t;&t;&t;return -EPERM;&n;&t;&t;}&n;*/
r_if
c_cond
(paren
l_int|0
op_ne
id|vv-&gt;ov_data
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_S_FBUF: overlay is active.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
multiline_comment|/* check args */
id|fmt
op_assign
id|format_by_fourcc
c_func
(paren
id|dev
comma
id|fb-&gt;fmt.pixelformat
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|fmt
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* ok, accept it */
id|vv-&gt;ov_fb
op_assign
op_star
id|fb
suffix:semicolon
id|vv-&gt;ov_fmt
op_assign
id|fmt
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|vv-&gt;ov_fb.fmt.bytesperline
)paren
id|vv-&gt;ov_fb.fmt.bytesperline
op_assign
id|vv-&gt;ov_fb.fmt.width
op_star
id|fmt-&gt;depth
op_div
l_int|8
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOC_ENUM_FMT
suffix:colon
(brace
r_struct
id|v4l2_fmtdesc
op_star
id|f
op_assign
id|arg
suffix:semicolon
r_int
id|index
suffix:semicolon
r_switch
c_cond
(paren
id|f-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
r_case
id|V4L2_BUF_TYPE_VIDEO_OVERLAY
suffix:colon
(brace
id|index
op_assign
id|f-&gt;index
suffix:semicolon
r_if
c_cond
(paren
id|index
OL
l_int|0
op_logical_or
id|index
op_ge
id|NUM_FORMATS
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|f
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|f
)paren
)paren
suffix:semicolon
id|f-&gt;index
op_assign
id|index
suffix:semicolon
id|strlcpy
c_func
(paren
id|f-&gt;description
comma
id|formats
(braket
id|index
)braket
dot
id|name
comma
r_sizeof
(paren
id|f-&gt;description
)paren
)paren
suffix:semicolon
id|f-&gt;pixelformat
op_assign
id|formats
(braket
id|index
)braket
dot
id|pixelformat
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_ENUM_FMT: type:%d, index:%d&bslash;n&quot;
comma
id|f-&gt;type
comma
id|f-&gt;index
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOC_QUERYCTRL
suffix:colon
(brace
r_const
r_struct
id|v4l2_queryctrl
op_star
id|ctrl
suffix:semicolon
r_struct
id|v4l2_queryctrl
op_star
id|c
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c-&gt;id
OL
id|V4L2_CID_BASE
op_logical_or
id|c-&gt;id
op_ge
id|V4L2_CID_LASTP1
)paren
op_logical_and
(paren
id|c-&gt;id
OL
id|V4L2_CID_PRIVATE_BASE
op_logical_or
id|c-&gt;id
op_ge
id|V4L2_CID_PRIVATE_LASTP1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ctrl
op_assign
id|ctrl_by_id
c_func
(paren
id|c-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|ctrl
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;c-&gt;flags = V4L2_CTRL_FLAG_DISABLED;&t;&n;&t;&t;&t;return 0;&n;*/
)brace
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_QUERYCTRL: id:%d&bslash;n&quot;
comma
id|c-&gt;id
)paren
)paren
suffix:semicolon
op_star
id|c
op_assign
op_star
id|ctrl
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOC_G_CTRL
suffix:colon
(brace
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_G_CTRL&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|get_control
c_func
(paren
id|fh
comma
id|arg
)paren
suffix:semicolon
)brace
r_case
id|VIDIOC_S_CTRL
suffix:colon
(brace
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_S_CTRL&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
id|err
op_assign
id|set_control
c_func
(paren
id|fh
comma
id|arg
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_case
id|VIDIOC_G_PARM
suffix:colon
(brace
r_struct
id|v4l2_streamparm
op_star
id|parm
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|parm-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|parm-&gt;parm.capture
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|v4l2_captureparm
)paren
)paren
suffix:semicolon
id|parm-&gt;parm.capture.readbuffers
op_assign
l_int|1
suffix:semicolon
singleline_comment|// fixme: only for PAL!
id|parm-&gt;parm.capture.timeperframe.numerator
op_assign
l_int|1
suffix:semicolon
id|parm-&gt;parm.capture.timeperframe.denominator
op_assign
l_int|25
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOC_G_FMT
suffix:colon
(brace
r_struct
id|v4l2_format
op_star
id|f
op_assign
id|arg
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_G_FMT&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|g_fmt
c_func
(paren
id|fh
comma
id|f
)paren
suffix:semicolon
)brace
r_case
id|VIDIOC_S_FMT
suffix:colon
(brace
r_struct
id|v4l2_format
op_star
id|f
op_assign
id|arg
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_S_FMT&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|s_fmt
c_func
(paren
id|fh
comma
id|f
)paren
suffix:semicolon
)brace
r_case
id|VIDIOC_TRY_FMT
suffix:colon
(brace
r_struct
id|v4l2_format
op_star
id|f
op_assign
id|arg
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_TRY_FMT&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|try_fmt
c_func
(paren
id|fh
comma
id|f
)paren
suffix:semicolon
)brace
r_case
id|VIDIOC_G_STD
suffix:colon
(brace
id|v4l2_std_id
op_star
id|id
op_assign
id|arg
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_G_STD&bslash;n&quot;
)paren
)paren
suffix:semicolon
op_star
id|id
op_assign
id|vv-&gt;standard-&gt;id
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* the saa7146 supfhrts (used in conjunction with the saa7111a for example)&n;&t;   PAL / NTSC / SECAM. if your hardware does not (or does more)&n;&t;   -- override this function in your extension */
r_case
id|VIDIOC_ENUMSTD
suffix:colon
(brace
r_struct
id|v4l2_standard
op_star
id|e
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;index
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;index
OL
id|dev-&gt;ext_vv_data-&gt;num_stds
)paren
(brace
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_ENUMSTD: index:%d&bslash;n&quot;
comma
id|e-&gt;index
)paren
)paren
suffix:semicolon
id|v4l2_video_std_construct
c_func
(paren
id|e
comma
id|dev-&gt;ext_vv_data-&gt;stds
(braket
id|e-&gt;index
)braket
dot
id|id
comma
id|dev-&gt;ext_vv_data-&gt;stds
(braket
id|e-&gt;index
)braket
dot
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
id|VIDIOC_S_STD
suffix:colon
(brace
id|v4l2_std_id
op_star
id|id
op_assign
id|arg
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|restart_overlay
op_assign
l_int|0
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_struct
id|saa7146_fh
op_star
id|ov_fh
op_assign
l_int|NULL
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_S_STD&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|vv-&gt;streaming
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vv-&gt;ov_data
op_ne
l_int|NULL
)paren
(brace
id|ov_fh
op_assign
id|vv-&gt;ov_data-&gt;fh
suffix:semicolon
id|saa7146_stop_preview
c_func
(paren
id|ov_fh
)paren
suffix:semicolon
id|restart_overlay
op_assign
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;ext_vv_data-&gt;num_stds
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_star
id|id
op_amp
id|dev-&gt;ext_vv_data-&gt;stds
(braket
id|i
)braket
dot
id|id
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|dev-&gt;ext_vv_data-&gt;num_stds
)paren
(brace
id|vv-&gt;standard
op_assign
op_amp
id|dev-&gt;ext_vv_data-&gt;stds
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|dev-&gt;ext_vv_data-&gt;std_callback
)paren
(brace
id|dev-&gt;ext_vv_data
op_member_access_from_pointer
id|std_callback
c_func
(paren
id|dev
comma
id|vv-&gt;standard
)paren
suffix:semicolon
)brace
id|found
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_ne
id|restart_overlay
)paren
(brace
id|saa7146_start_preview
c_func
(paren
id|ov_fh
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|found
)paren
(brace
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_S_STD: standard not found.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;VIDIOC_S_STD: set to standard to &squot;%s&squot;&bslash;n&quot;
comma
id|vv-&gt;standard-&gt;name
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOC_OVERLAY
suffix:colon
(brace
r_int
id|on
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|vv-&gt;ov_fmt
op_logical_and
id|on
op_ne
l_int|0
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_OVERLAY: no framebuffer informations. call S_FBUF first!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_OVERLAY on:%d&bslash;n&quot;
comma
id|on
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|on
)paren
(brace
r_if
c_cond
(paren
id|vv-&gt;ov_data
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|fh
op_ne
id|vv-&gt;ov_data-&gt;fh
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
id|err
op_assign
id|saa7146_start_preview
c_func
(paren
id|fh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|vv-&gt;ov_data
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|fh
op_ne
id|vv-&gt;ov_data-&gt;fh
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
id|err
op_assign
id|saa7146_stop_preview
c_func
(paren
id|fh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_case
id|VIDIOC_REQBUFS
suffix:colon
(brace
r_struct
id|v4l2_requestbuffers
op_star
id|req
op_assign
id|arg
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_REQBUFS, type:%d&bslash;n&quot;
comma
id|req-&gt;type
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;if( req-&gt;type == V4L2_BUF_TYPE_VIDEO_OVERLAY ) {&n;&t;&t;&t;return overlay_reqbufs(dev,req);&n;&t;&t;} &n;*/
r_return
id|videobuf_reqbufs
c_func
(paren
id|file
comma
id|q
comma
id|req
)paren
suffix:semicolon
)brace
r_case
id|VIDIOC_QUERYBUF
suffix:colon
(brace
r_struct
id|v4l2_buffer
op_star
id|buf
op_assign
id|arg
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_QUERYBUF, type:%d, offset:%d&bslash;n&quot;
comma
id|buf-&gt;type
comma
id|buf-&gt;m.offset
)paren
)paren
suffix:semicolon
multiline_comment|/* &t;&t;if( buf-&gt;type == V4L2_BUF_TYPE_VIDEO_OVERLAY ) {&n;&t;&t;&t;return overlay_querybuf(dev,buf);&n;&t;&t;} &n; */
r_return
id|videobuf_querybuf
c_func
(paren
id|q
comma
id|buf
)paren
suffix:semicolon
)brace
r_case
id|VIDIOC_QBUF
suffix:colon
(brace
r_struct
id|v4l2_buffer
op_star
id|buf
op_assign
id|arg
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &t;&t;if( buf-&gt;type == V4L2_BUF_TYPE_VIDEO_OVERLAY ) {&n;&t;&t;&t;return overlay_qbuf(dev,buf);&n;&t;&t;} &n; */
id|ret
op_assign
id|videobuf_qbuf
c_func
(paren
id|file
comma
id|q
comma
id|buf
)paren
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_QBUF: ret:%d, index:%d&bslash;n&quot;
comma
id|ret
comma
id|buf-&gt;index
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_case
id|VIDIOC_DQBUF
suffix:colon
(brace
r_struct
id|v4l2_buffer
op_star
id|buf
op_assign
id|arg
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* &t;&t;if( buf-&gt;type == V4L2_BUF_TYPE_VIDEO_OVERLAY ) {&n;&t;&t;&t;return overlay_dqbuf(dev,buf);&n;&t;&t;} &n; */
id|ret
op_assign
id|videobuf_dqbuf
c_func
(paren
id|file
comma
id|q
comma
id|buf
)paren
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_DQBUF: ret:%d, index:%d&bslash;n&quot;
comma
id|ret
comma
id|buf-&gt;index
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_case
id|VIDIOC_STREAMON
suffix:colon
(brace
r_int
op_star
id|type
op_assign
id|arg
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_STREAMON, type:%d&bslash;n&quot;
comma
op_star
id|type
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|ops-&gt;capture_begin
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|err
op_assign
id|ops
op_member_access_from_pointer
id|capture_begin
c_func
(paren
id|fh
)paren
)paren
)paren
(brace
r_return
id|err
suffix:semicolon
)brace
)brace
multiline_comment|/* &t;&t;if( *type == V4L2_BUF_TYPE_VIDEO_OVERLAY ) {&n;&t;&t;&t;err = overlay_streamon(dev);&n;&t;&t;} else { */
id|err
op_assign
id|videobuf_streamon
c_func
(paren
id|file
comma
id|q
)paren
suffix:semicolon
multiline_comment|/* &t;&t;} */
r_return
id|err
suffix:semicolon
)brace
r_case
id|VIDIOC_STREAMOFF
suffix:colon
(brace
r_int
op_star
id|type
op_assign
id|arg
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOC_STREAMOFF, type:%d&bslash;n&quot;
comma
op_star
id|type
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|ops-&gt;capture_end
)paren
(brace
id|ops
op_member_access_from_pointer
id|capture_end
c_func
(paren
id|fh
)paren
suffix:semicolon
)brace
multiline_comment|/* &t;&t;if( *type == V4L2_BUF_TYPE_VIDEO_OVERLAY ) {&n;&t;&t;&t;return overlay_streamoff(dev);&n;&t;&t;} &n; */
id|err
op_assign
id|videobuf_streamoff
c_func
(paren
id|file
comma
id|q
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
op_star
id|mbuf
op_assign
id|arg
suffix:semicolon
r_struct
id|videobuf_queue
op_star
id|q
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* fixme: number of capture buffers and sizes for v4l apps */
r_int
id|gbuffers
op_assign
l_int|2
suffix:semicolon
r_int
id|gbufsize
op_assign
l_int|768
op_star
l_int|576
op_star
l_int|4
suffix:semicolon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;VIDIOCGMBUF &bslash;n&quot;
)paren
)paren
suffix:semicolon
id|q
op_assign
op_amp
id|fh-&gt;video_q
suffix:semicolon
id|down
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|err
op_assign
id|videobuf_mmap_setup
c_func
(paren
id|file
comma
id|q
comma
id|gbuffers
comma
id|gbufsize
comma
id|V4L2_MEMORY_MMAP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|memset
c_func
(paren
id|mbuf
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mbuf
)paren
)paren
suffix:semicolon
id|mbuf-&gt;frames
op_assign
id|gbuffers
suffix:semicolon
id|mbuf-&gt;size
op_assign
id|gbuffers
op_star
id|gbufsize
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gbuffers
suffix:semicolon
id|i
op_increment
)paren
id|mbuf-&gt;offsets
(braket
id|i
)braket
op_assign
id|i
op_star
id|gbufsize
suffix:semicolon
id|up
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
id|v4l_compat_translate_ioctl
c_func
(paren
id|inode
comma
id|file
comma
id|cmd
comma
id|arg
comma
id|saa7146_video_do_ioctl
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*********************************************************************************/
multiline_comment|/* buffer handling functions                                                  */
DECL|function|buffer_activate
r_static
r_int
id|buffer_activate
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|saa7146_buf
op_star
id|buf
comma
r_struct
id|saa7146_buf
op_star
id|next
)paren
(brace
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
id|buf-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
id|saa7146_set_capture
c_func
(paren
id|dev
comma
id|buf
comma
id|next
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|vv-&gt;video_q.timeout
comma
id|jiffies
op_plus
id|BUFFER_TIMEOUT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|buffer_prepare
r_static
r_int
id|buffer_prepare
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|videobuf_buffer
op_star
id|vb
comma
r_enum
id|v4l2_field
id|field
)paren
(brace
r_struct
id|saa7146_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_struct
id|saa7146_buf
op_star
id|buf
op_assign
(paren
r_struct
id|saa7146_buf
op_star
)paren
id|vb
suffix:semicolon
r_int
id|size
comma
id|err
op_assign
l_int|0
suffix:semicolon
id|DEB_CAP
c_func
(paren
(paren
l_string|&quot;vbuf:%p&bslash;n&quot;
comma
id|vb
)paren
)paren
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
id|fh-&gt;video_fmt.width
template_param
id|vv-&gt;standard-&gt;v_max_out
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;w (%d) / h (%d) out of bounds.&bslash;n&quot;
comma
id|fh-&gt;video_fmt.width
comma
id|fh-&gt;video_fmt.height
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|size
op_assign
id|fh-&gt;video_fmt.sizeimage
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|buf-&gt;vb.baddr
op_logical_and
id|buf-&gt;vb.bsize
OL
id|size
)paren
(brace
id|DEB_D
c_func
(paren
(paren
l_string|&quot;size mismatch.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DEB_CAP
c_func
(paren
(paren
l_string|&quot;buffer_prepare [size=%dx%d,bytes=%d,fields=%s]&bslash;n&quot;
comma
id|fh-&gt;video_fmt.width
comma
id|fh-&gt;video_fmt.height
comma
id|size
comma
id|v4l2_field_names
(braket
id|fh-&gt;video_fmt.field
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;vb.width
op_ne
id|fh-&gt;video_fmt.width
op_logical_or
id|buf-&gt;vb.bytesperline
op_ne
id|fh-&gt;video_fmt.bytesperline
op_logical_or
id|buf-&gt;vb.height
op_ne
id|fh-&gt;video_fmt.height
op_logical_or
id|buf-&gt;vb.size
op_ne
id|size
op_logical_or
id|buf-&gt;vb.field
op_ne
id|field
op_logical_or
id|buf-&gt;vb.field
op_ne
id|fh-&gt;video_fmt.field
op_logical_or
id|buf-&gt;fmt
op_ne
op_amp
id|fh-&gt;video_fmt
)paren
(brace
id|saa7146_dma_free
c_func
(paren
id|dev
comma
id|buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STATE_NEEDS_INIT
op_eq
id|buf-&gt;vb.state
)paren
(brace
r_struct
id|saa7146_format
op_star
id|sfmt
suffix:semicolon
id|buf-&gt;vb.bytesperline
op_assign
id|fh-&gt;video_fmt.bytesperline
suffix:semicolon
id|buf-&gt;vb.width
op_assign
id|fh-&gt;video_fmt.width
suffix:semicolon
id|buf-&gt;vb.height
op_assign
id|fh-&gt;video_fmt.height
suffix:semicolon
id|buf-&gt;vb.size
op_assign
id|size
suffix:semicolon
id|buf-&gt;vb.field
op_assign
id|field
suffix:semicolon
id|buf-&gt;fmt
op_assign
op_amp
id|fh-&gt;video_fmt
suffix:semicolon
id|buf-&gt;vb.field
op_assign
id|fh-&gt;video_fmt.field
suffix:semicolon
id|sfmt
op_assign
id|format_by_fourcc
c_func
(paren
id|dev
comma
id|buf-&gt;fmt-&gt;pixelformat
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|IS_PLANAR
c_func
(paren
id|sfmt-&gt;trans
)paren
)paren
(brace
id|saa7146_pgtable_free
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;pt
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|saa7146_pgtable_free
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;pt
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|saa7146_pgtable_free
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;pt
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|saa7146_pgtable_alloc
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;pt
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|saa7146_pgtable_alloc
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;pt
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|saa7146_pgtable_alloc
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;pt
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|saa7146_pgtable_free
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;pt
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|saa7146_pgtable_alloc
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;pt
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|err
op_assign
id|videobuf_iolock
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;vb
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|oops
suffix:semicolon
id|err
op_assign
id|saa7146_pgtable_build
c_func
(paren
id|dev
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|oops
suffix:semicolon
)brace
id|buf-&gt;vb.state
op_assign
id|STATE_PREPARED
suffix:semicolon
id|buf-&gt;activate
op_assign
id|buffer_activate
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|oops
suffix:colon
id|DEB_D
c_func
(paren
(paren
l_string|&quot;error out.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|saa7146_dma_free
c_func
(paren
id|dev
comma
id|buf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|buffer_setup
r_static
r_int
id|buffer_setup
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
op_star
id|count
comma
r_int
r_int
op_star
id|size
)paren
(brace
r_struct
id|saa7146_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
op_star
id|count
op_logical_or
op_star
id|count
OG
id|MAX_SAA7146_CAPTURE_BUFFERS
)paren
op_star
id|count
op_assign
id|MAX_SAA7146_CAPTURE_BUFFERS
suffix:semicolon
op_star
id|size
op_assign
id|fh-&gt;video_fmt.sizeimage
suffix:semicolon
multiline_comment|/* check if we exceed the &quot;memory&quot; parameter */
r_if
c_cond
(paren
(paren
op_star
id|count
op_star
op_star
id|size
)paren
OG
(paren
id|memory
op_star
l_int|1048576
)paren
)paren
(brace
op_star
id|count
op_assign
(paren
id|memory
op_star
l_int|1048576
)paren
op_div
op_star
id|size
suffix:semicolon
)brace
id|DEB_CAP
c_func
(paren
(paren
l_string|&quot;%d buffers, %d bytes each.&bslash;n&quot;
comma
op_star
id|count
comma
op_star
id|size
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|buffer_queue
r_static
r_void
id|buffer_queue
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|videobuf_buffer
op_star
id|vb
)paren
(brace
r_struct
id|saa7146_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_struct
id|saa7146_buf
op_star
id|buf
op_assign
(paren
r_struct
id|saa7146_buf
op_star
)paren
id|vb
suffix:semicolon
id|DEB_CAP
c_func
(paren
(paren
l_string|&quot;vbuf:%p&bslash;n&quot;
comma
id|vb
)paren
)paren
suffix:semicolon
id|saa7146_buffer_queue
c_func
(paren
id|fh-&gt;dev
comma
op_amp
id|vv-&gt;video_q
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|function|buffer_release
r_static
r_void
id|buffer_release
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|videobuf_buffer
op_star
id|vb
)paren
(brace
r_struct
id|saa7146_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_buf
op_star
id|buf
op_assign
(paren
r_struct
id|saa7146_buf
op_star
)paren
id|vb
suffix:semicolon
id|DEB_CAP
c_func
(paren
(paren
l_string|&quot;vbuf:%p&bslash;n&quot;
comma
id|vb
)paren
)paren
suffix:semicolon
id|saa7146_dma_free
c_func
(paren
id|dev
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|variable|video_qops
r_static
r_struct
id|videobuf_queue_ops
id|video_qops
op_assign
(brace
dot
id|buf_setup
op_assign
id|buffer_setup
comma
dot
id|buf_prepare
op_assign
id|buffer_prepare
comma
dot
id|buf_queue
op_assign
id|buffer_queue
comma
dot
id|buf_release
op_assign
id|buffer_release
comma
)brace
suffix:semicolon
multiline_comment|/********************************************************************************/
multiline_comment|/* file operations */
DECL|function|video_init
r_static
r_void
id|video_init
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|saa7146_vv
op_star
id|vv
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|vv-&gt;video_q.queue
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|vv-&gt;video_q.timeout
)paren
suffix:semicolon
id|vv-&gt;video_q.timeout.function
op_assign
id|saa7146_buffer_timeout
suffix:semicolon
id|vv-&gt;video_q.timeout.data
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
id|vv-&gt;video_q
)paren
suffix:semicolon
id|vv-&gt;video_q.dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* set some default values */
id|vv-&gt;standard
op_assign
op_amp
id|dev-&gt;ext_vv_data-&gt;stds
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* FIXME: what&squot;s this? */
id|vv-&gt;current_hps_source
op_assign
id|SAA7146_HPS_SOURCE_PORT_A
suffix:semicolon
id|vv-&gt;current_hps_sync
op_assign
id|SAA7146_HPS_SYNC_PORT_A
suffix:semicolon
)brace
DECL|function|video_open
r_static
r_void
id|video_open
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|saa7146_fh
op_star
id|fh
)paren
(brace
r_struct
id|saa7146_format
op_star
id|sfmt
suffix:semicolon
id|fh-&gt;video_fmt.width
op_assign
l_int|384
suffix:semicolon
id|fh-&gt;video_fmt.height
op_assign
l_int|288
suffix:semicolon
id|fh-&gt;video_fmt.pixelformat
op_assign
id|V4L2_PIX_FMT_BGR24
suffix:semicolon
id|fh-&gt;video_fmt.bytesperline
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;video_fmt.field
op_assign
id|V4L2_FIELD_ANY
suffix:semicolon
id|sfmt
op_assign
id|format_by_fourcc
c_func
(paren
id|dev
comma
id|fh-&gt;video_fmt.pixelformat
)paren
suffix:semicolon
id|fh-&gt;video_fmt.sizeimage
op_assign
(paren
id|fh-&gt;video_fmt.width
op_star
id|fh-&gt;video_fmt.height
op_star
id|sfmt-&gt;depth
)paren
op_div
l_int|8
suffix:semicolon
id|videobuf_queue_init
c_func
(paren
op_amp
id|fh-&gt;video_q
comma
op_amp
id|video_qops
comma
id|dev-&gt;pci
comma
op_amp
id|dev-&gt;slock
comma
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
comma
id|V4L2_FIELD_INTERLACED
comma
r_sizeof
(paren
r_struct
id|saa7146_buf
)paren
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|fh-&gt;video_q.lock
)paren
suffix:semicolon
)brace
DECL|function|video_close
r_static
r_void
id|video_close
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_struct
id|saa7146_fh
op_star
id|fh
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|vv-&gt;ov_data
)paren
(brace
r_if
c_cond
(paren
id|fh
op_eq
id|vv-&gt;ov_data-&gt;fh
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
id|saa7146_stop_preview
c_func
(paren
id|fh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|fh
op_eq
id|vv-&gt;streaming
)paren
(brace
id|video_end
c_func
(paren
id|fh
)paren
suffix:semicolon
)brace
id|videobuf_queue_cancel
c_func
(paren
id|file
comma
op_amp
id|fh-&gt;video_q
)paren
suffix:semicolon
)brace
DECL|function|video_irq_done
r_static
r_void
id|video_irq_done
c_func
(paren
r_struct
id|saa7146_dev
op_star
id|dev
comma
r_int
r_int
id|st
)paren
(brace
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
r_struct
id|saa7146_dmaqueue
op_star
id|q
op_assign
op_amp
id|vv-&gt;video_q
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;slock
)paren
suffix:semicolon
id|DEB_CAP
c_func
(paren
(paren
l_string|&quot;called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* only finish the buffer if we have one... */
r_if
c_cond
(paren
l_int|NULL
op_ne
id|q-&gt;curr
)paren
(brace
id|saa7146_buffer_finish
c_func
(paren
id|dev
comma
id|q
comma
id|STATE_DONE
)paren
suffix:semicolon
)brace
id|saa7146_buffer_next
c_func
(paren
id|dev
comma
id|q
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;slock
)paren
suffix:semicolon
)brace
DECL|function|video_read
r_static
id|ssize_t
id|video_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|data
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|saa7146_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|saa7146_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|saa7146_vv
op_star
id|vv
op_assign
id|dev-&gt;vv_data
suffix:semicolon
id|ssize_t
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|restart_overlay
op_assign
l_int|0
suffix:semicolon
r_struct
id|saa7146_fh
op_star
id|ov_fh
op_assign
l_int|NULL
suffix:semicolon
id|DEB_EE
c_func
(paren
(paren
l_string|&quot;called.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vv-&gt;ov_data
op_ne
l_int|NULL
)paren
(brace
id|ov_fh
op_assign
id|vv-&gt;ov_data-&gt;fh
suffix:semicolon
id|saa7146_stop_preview
c_func
(paren
id|ov_fh
)paren
suffix:semicolon
id|restart_overlay
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_ne
id|video_begin
c_func
(paren
id|fh
)paren
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|ret
op_assign
id|videobuf_read_one
c_func
(paren
id|file
comma
op_amp
id|fh-&gt;video_q
comma
id|data
comma
id|count
comma
id|ppos
)paren
suffix:semicolon
id|video_end
c_func
(paren
id|fh
)paren
suffix:semicolon
multiline_comment|/* restart overlay if it was active before */
r_if
c_cond
(paren
l_int|0
op_ne
id|restart_overlay
)paren
(brace
id|saa7146_start_preview
c_func
(paren
id|ov_fh
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|saa7146_video_uops
r_struct
id|saa7146_use_ops
id|saa7146_video_uops
op_assign
(brace
dot
id|init
op_assign
id|video_init
comma
dot
id|open
op_assign
id|video_open
comma
dot
id|release
op_assign
id|video_close
comma
dot
id|irq_done
op_assign
id|video_irq_done
comma
dot
id|read
op_assign
id|video_read
comma
dot
id|capture_begin
op_assign
id|video_begin
comma
dot
id|capture_end
op_assign
id|video_end
comma
)brace
suffix:semicolon
eof
