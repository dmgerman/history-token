multiline_comment|/*&n;     Driver for Philips tda1004x OFDM Frontend&n;&n;     This program is free software; you can redistribute it and/or modify&n;     it under the terms of the GNU General Public License as published by&n;     the Free Software Foundation; either version 2 of the License, or&n;     (at your option) any later version.&n;&n;     This program is distributed in the hope that it will be useful,&n;     but WITHOUT ANY WARRANTY; without even the implied warranty of&n;     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;&n;     GNU General Public License for more details.&n;&n;     You should have received a copy of the GNU General Public License&n;     along with this program; if not, write to the Free Software&n;     Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;&n;   */
multiline_comment|/*&n;    This driver needs a copy of the DLL &quot;ttlcdacc.dll&quot; from the Haupauge or Technotrend&n;    windows driver saved as &squot;/etc/dvb/tda1004x.mc&squot;.&n;    You can also pass the complete file name with the module parameter &squot;tda1004x_firmware&squot;.&n;&n;    Currently the DLL from v2.15a of the technotrend driver is supported. Other versions can&n;    be added reasonably painlessly.&n;&n;    Windows driver URL: http://www.technotrend.de/&n; */
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &quot;dvb_frontend.h&quot;
macro_line|#include &quot;dvb_functions.h&quot;
macro_line|#ifndef CONFIG_TDA1004X_MC_LOCATION
DECL|macro|CONFIG_TDA1004X_MC_LOCATION
mdefine_line|#define CONFIG_TDA1004X_MC_LOCATION &quot;/etc/dvb/tda1004x.mc&quot;
macro_line|#endif
DECL|variable|tda1004x_debug
r_static
r_int
id|tda1004x_debug
op_assign
l_int|0
suffix:semicolon
DECL|variable|tda1004x_firmware
r_static
r_char
op_star
id|tda1004x_firmware
op_assign
id|CONFIG_TDA1004X_MC_LOCATION
suffix:semicolon
DECL|macro|TDA10045H_ADDRESS
mdefine_line|#define TDA10045H_ADDRESS        0x08
DECL|macro|TD1344_ADDRESS
mdefine_line|#define TD1344_ADDRESS           0x61
DECL|macro|TDM1316L_ADDRESS
mdefine_line|#define TDM1316L_ADDRESS         0x63
DECL|macro|MC44BC374_ADDRESS
mdefine_line|#define MC44BC374_ADDRESS        0x65
DECL|macro|TDA1004X_CHIPID
mdefine_line|#define TDA1004X_CHIPID          0x00
DECL|macro|TDA1004X_AUTO
mdefine_line|#define TDA1004X_AUTO            0x01
DECL|macro|TDA1004X_IN_CONF1
mdefine_line|#define TDA1004X_IN_CONF1        0x02
DECL|macro|TDA1004X_IN_CONF2
mdefine_line|#define TDA1004X_IN_CONF2        0x03
DECL|macro|TDA1004X_OUT_CONF1
mdefine_line|#define TDA1004X_OUT_CONF1       0x04
DECL|macro|TDA1004X_OUT_CONF2
mdefine_line|#define TDA1004X_OUT_CONF2       0x05
DECL|macro|TDA1004X_STATUS_CD
mdefine_line|#define TDA1004X_STATUS_CD       0x06
DECL|macro|TDA1004X_CONFC4
mdefine_line|#define TDA1004X_CONFC4          0x07
DECL|macro|TDA1004X_DSSPARE2
mdefine_line|#define TDA1004X_DSSPARE2        0x0C
DECL|macro|TDA1004X_CODE_IN
mdefine_line|#define TDA1004X_CODE_IN         0x0D
DECL|macro|TDA1004X_FWPAGE
mdefine_line|#define TDA1004X_FWPAGE          0x0E
DECL|macro|TDA1004X_SCAN_CPT
mdefine_line|#define TDA1004X_SCAN_CPT        0x10
DECL|macro|TDA1004X_DSP_CMD
mdefine_line|#define TDA1004X_DSP_CMD         0x11
DECL|macro|TDA1004X_DSP_ARG
mdefine_line|#define TDA1004X_DSP_ARG         0x12
DECL|macro|TDA1004X_DSP_DATA1
mdefine_line|#define TDA1004X_DSP_DATA1       0x13
DECL|macro|TDA1004X_DSP_DATA2
mdefine_line|#define TDA1004X_DSP_DATA2       0x14
DECL|macro|TDA1004X_CONFADC1
mdefine_line|#define TDA1004X_CONFADC1        0x15
DECL|macro|TDA1004X_CONFC1
mdefine_line|#define TDA1004X_CONFC1          0x16
DECL|macro|TDA1004X_SIGNAL_STRENGTH
mdefine_line|#define TDA1004X_SIGNAL_STRENGTH 0x1a
DECL|macro|TDA1004X_SNR
mdefine_line|#define TDA1004X_SNR             0x1c
DECL|macro|TDA1004X_REG1E
mdefine_line|#define TDA1004X_REG1E           0x1e
DECL|macro|TDA1004X_REG1F
mdefine_line|#define TDA1004X_REG1F           0x1f
DECL|macro|TDA1004X_CBER_RESET
mdefine_line|#define TDA1004X_CBER_RESET      0x20
DECL|macro|TDA1004X_CBER_MSB
mdefine_line|#define TDA1004X_CBER_MSB        0x21
DECL|macro|TDA1004X_CBER_LSB
mdefine_line|#define TDA1004X_CBER_LSB        0x22
DECL|macro|TDA1004X_CVBER_LUT
mdefine_line|#define TDA1004X_CVBER_LUT       0x23
DECL|macro|TDA1004X_VBER_MSB
mdefine_line|#define TDA1004X_VBER_MSB        0x24
DECL|macro|TDA1004X_VBER_MID
mdefine_line|#define TDA1004X_VBER_MID        0x25
DECL|macro|TDA1004X_VBER_LSB
mdefine_line|#define TDA1004X_VBER_LSB        0x26
DECL|macro|TDA1004X_UNCOR
mdefine_line|#define TDA1004X_UNCOR           0x27
DECL|macro|TDA1004X_CONFPLL_P
mdefine_line|#define TDA1004X_CONFPLL_P       0x2D
DECL|macro|TDA1004X_CONFPLL_M_MSB
mdefine_line|#define TDA1004X_CONFPLL_M_MSB   0x2E
DECL|macro|TDA1004X_CONFPLL_M_LSB
mdefine_line|#define TDA1004X_CONFPLL_M_LSB   0x2F
DECL|macro|TDA1004X_CONFPLL_N
mdefine_line|#define TDA1004X_CONFPLL_N       0x30
DECL|macro|TDA1004X_UNSURW_MSB
mdefine_line|#define TDA1004X_UNSURW_MSB      0x31
DECL|macro|TDA1004X_UNSURW_LSB
mdefine_line|#define TDA1004X_UNSURW_LSB      0x32
DECL|macro|TDA1004X_WREF_MSB
mdefine_line|#define TDA1004X_WREF_MSB        0x33
DECL|macro|TDA1004X_WREF_MID
mdefine_line|#define TDA1004X_WREF_MID        0x34
DECL|macro|TDA1004X_WREF_LSB
mdefine_line|#define TDA1004X_WREF_LSB        0x35
DECL|macro|TDA1004X_MUXOUT
mdefine_line|#define TDA1004X_MUXOUT          0x36
DECL|macro|TDA1004X_CONFADC2
mdefine_line|#define TDA1004X_CONFADC2        0x37
DECL|macro|TDA1004X_IOFFSET
mdefine_line|#define TDA1004X_IOFFSET         0x38
DECL|macro|dprintk
mdefine_line|#define dprintk if (tda1004x_debug) printk
DECL|variable|tda10045h_info
r_static
r_struct
id|dvb_frontend_info
id|tda10045h_info
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Philips TDA10045H&quot;
comma
dot
id|type
op_assign
id|FE_OFDM
comma
dot
id|frequency_min
op_assign
l_int|51000000
comma
dot
id|frequency_max
op_assign
l_int|858000000
comma
dot
id|frequency_stepsize
op_assign
l_int|166667
comma
dot
id|caps
op_assign
id|FE_CAN_INVERSION_AUTO
op_or
id|FE_CAN_FEC_1_2
op_or
id|FE_CAN_FEC_2_3
op_or
id|FE_CAN_FEC_3_4
op_or
id|FE_CAN_FEC_5_6
op_or
id|FE_CAN_FEC_7_8
op_or
id|FE_CAN_FEC_AUTO
op_or
id|FE_CAN_QPSK
op_or
id|FE_CAN_QAM_16
op_or
id|FE_CAN_QAM_64
op_or
id|FE_CAN_QAM_AUTO
op_or
id|FE_CAN_TRANSMISSION_MODE_AUTO
op_or
id|FE_CAN_GUARD_INTERVAL_AUTO
)brace
suffix:semicolon
macro_line|#pragma pack(1)
DECL|struct|tda1004x_state
r_struct
id|tda1004x_state
(brace
DECL|member|tda1004x_address
id|u8
id|tda1004x_address
suffix:semicolon
DECL|member|tuner_address
id|u8
id|tuner_address
suffix:semicolon
DECL|member|initialised
id|u8
id|initialised
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
macro_line|#pragma pack()
DECL|struct|fwinfo
r_struct
id|fwinfo
(brace
DECL|member|file_size
r_int
id|file_size
suffix:semicolon
DECL|member|fw_offset
r_int
id|fw_offset
suffix:semicolon
DECL|member|fw_size
r_int
id|fw_size
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|tda10045h_fwinfo
r_static
r_struct
id|fwinfo
id|tda10045h_fwinfo
(braket
)braket
op_assign
(brace
(brace
dot
id|file_size
op_assign
l_int|286720
comma
dot
id|fw_offset
op_assign
l_int|0x34cc5
comma
dot
id|fw_size
op_assign
l_int|30555
)brace
)brace
suffix:semicolon
DECL|variable|tda10045h_fwinfo_count
r_static
r_int
id|tda10045h_fwinfo_count
op_assign
r_sizeof
(paren
id|tda10045h_fwinfo
)paren
op_div
r_sizeof
(paren
r_struct
id|fwinfo
)paren
suffix:semicolon
DECL|variable|errno
r_static
r_int
id|errno
suffix:semicolon
DECL|function|tda1004x_write_byte
r_static
r_int
id|tda1004x_write_byte
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
r_int
id|ret
suffix:semicolon
id|u8
id|buf
(braket
)braket
op_assign
(brace
id|reg
comma
id|data
)brace
suffix:semicolon
r_struct
id|i2c_msg
id|msg
op_assign
(brace
dot
id|addr
op_assign
l_int|0
comma
dot
id|flags
op_assign
l_int|0
comma
dot
id|buf
op_assign
id|buf
comma
dot
id|len
op_assign
l_int|2
)brace
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: reg=0x%x, data=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|reg
comma
id|data
)paren
suffix:semicolon
id|msg.addr
op_assign
id|tda_state-&gt;tda1004x_address
suffix:semicolon
id|ret
op_assign
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|msg
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|1
)paren
id|dprintk
c_func
(paren
l_string|&quot;%s: error reg=0x%x, data=0x%x, ret=%i&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|reg
comma
id|data
comma
id|ret
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: success reg=0x%x, data=0x%x, ret=%i&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|reg
comma
id|data
comma
id|ret
)paren
suffix:semicolon
r_return
(paren
id|ret
op_ne
l_int|1
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_read_byte
r_static
r_int
id|tda1004x_read_byte
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
r_int
id|reg
)paren
(brace
r_int
id|ret
suffix:semicolon
id|u8
id|b0
(braket
)braket
op_assign
(brace
id|reg
)brace
suffix:semicolon
id|u8
id|b1
(braket
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_struct
id|i2c_msg
id|msg
(braket
)braket
op_assign
(brace
(brace
dot
id|addr
op_assign
l_int|0
comma
dot
id|flags
op_assign
l_int|0
comma
dot
id|buf
op_assign
id|b0
comma
dot
id|len
op_assign
l_int|1
)brace
comma
(brace
dot
id|addr
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|I2C_M_RD
comma
dot
id|buf
op_assign
id|b1
comma
dot
id|len
op_assign
l_int|1
)brace
)brace
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: reg=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|reg
)paren
suffix:semicolon
id|msg
(braket
l_int|0
)braket
dot
id|addr
op_assign
id|tda_state-&gt;tda1004x_address
suffix:semicolon
id|msg
(braket
l_int|1
)braket
dot
id|addr
op_assign
id|tda_state-&gt;tda1004x_address
suffix:semicolon
id|ret
op_assign
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
id|msg
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|2
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s: error reg=0x%x, ret=%i&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|reg
comma
id|ret
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;%s: success reg=0x%x, data=0x%x, ret=%i&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|reg
comma
id|b1
(braket
l_int|0
)braket
comma
id|ret
)paren
suffix:semicolon
r_return
id|b1
(braket
l_int|0
)braket
suffix:semicolon
)brace
DECL|function|tda1004x_write_mask
r_static
r_int
id|tda1004x_write_mask
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
r_int
id|reg
comma
r_int
id|mask
comma
r_int
id|data
)paren
(brace
r_int
id|val
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: reg=0x%x, mask=0x%x, data=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|reg
comma
id|mask
comma
id|data
)paren
suffix:semicolon
singleline_comment|// read a byte and check
id|val
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
r_return
id|val
suffix:semicolon
singleline_comment|// mask if off
id|val
op_assign
id|val
op_amp
op_complement
id|mask
suffix:semicolon
id|val
op_or_assign
id|data
op_amp
l_int|0xff
suffix:semicolon
singleline_comment|// write it out again
r_return
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|reg
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|tda1004x_write_buf
r_static
r_int
id|tda1004x_write_buf
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
r_int
id|reg
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: reg=0x%x, len=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|reg
comma
id|len
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|result
op_assign
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|reg
op_plus
id|i
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|tda1004x_enable_tuner_i2c
r_static
r_int
id|tda1004x_enable_tuner_i2c
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
)paren
(brace
r_int
id|result
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|result
op_assign
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC4
comma
l_int|2
comma
l_int|2
)paren
suffix:semicolon
id|dvb_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|tda1004x_disable_tuner_i2c
r_static
r_int
id|tda1004x_disable_tuner_i2c
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC4
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|tda10045h_set_bandwidth
r_static
r_int
id|tda10045h_set_bandwidth
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
id|fe_bandwidth_t
id|bandwidth
)paren
(brace
r_static
id|u8
id|bandwidth_6mhz
(braket
)braket
op_assign
(brace
l_int|0x02
comma
l_int|0x00
comma
l_int|0x3d
comma
l_int|0x00
comma
l_int|0x60
comma
l_int|0x1e
comma
l_int|0xa7
comma
l_int|0x45
comma
l_int|0x4f
)brace
suffix:semicolon
r_static
id|u8
id|bandwidth_7mhz
(braket
)braket
op_assign
(brace
l_int|0x02
comma
l_int|0x00
comma
l_int|0x37
comma
l_int|0x00
comma
l_int|0x4a
comma
l_int|0x2f
comma
l_int|0x6d
comma
l_int|0x76
comma
l_int|0xdb
)brace
suffix:semicolon
r_static
id|u8
id|bandwidth_8mhz
(braket
)braket
op_assign
(brace
l_int|0x02
comma
l_int|0x00
comma
l_int|0x3d
comma
l_int|0x00
comma
l_int|0x48
comma
l_int|0x17
comma
l_int|0x89
comma
l_int|0xc7
comma
l_int|0x14
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|bandwidth
)paren
(brace
r_case
id|BANDWIDTH_6_MHZ
suffix:colon
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_DSSPARE2
comma
l_int|0x14
)paren
suffix:semicolon
id|tda1004x_write_buf
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFPLL_P
comma
id|bandwidth_6mhz
comma
r_sizeof
(paren
id|bandwidth_6mhz
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BANDWIDTH_7_MHZ
suffix:colon
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_DSSPARE2
comma
l_int|0x80
)paren
suffix:semicolon
id|tda1004x_write_buf
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFPLL_P
comma
id|bandwidth_7mhz
comma
r_sizeof
(paren
id|bandwidth_7mhz
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BANDWIDTH_8_MHZ
suffix:colon
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_DSSPARE2
comma
l_int|0x14
)paren
suffix:semicolon
id|tda1004x_write_buf
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFPLL_P
comma
id|bandwidth_8mhz
comma
r_sizeof
(paren
id|bandwidth_8mhz
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IOFFSET
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// done
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_init
r_static
r_int
id|tda1004x_init
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
)paren
(brace
id|u8
id|fw_buf
(braket
l_int|65
)braket
suffix:semicolon
r_struct
id|i2c_msg
id|fw_msg
op_assign
(brace
dot
id|addr
op_assign
l_int|0
comma
dot
id|flags
op_assign
l_int|0
comma
dot
id|buf
op_assign
id|fw_buf
comma
dot
id|len
op_assign
l_int|0
)brace
suffix:semicolon
r_struct
id|i2c_msg
id|tuner_msg
op_assign
(brace
dot
id|addr
op_assign
l_int|0
comma
dot
id|flags
op_assign
l_int|0
comma
dot
id|buf
op_assign
l_int|0
comma
dot
id|len
op_assign
l_int|0
)brace
suffix:semicolon
r_int
r_char
op_star
id|firmware
op_assign
l_int|NULL
suffix:semicolon
r_int
id|filesize
suffix:semicolon
r_int
id|fd
suffix:semicolon
r_int
id|fwinfo_idx
suffix:semicolon
r_int
id|fw_size
op_assign
l_int|0
suffix:semicolon
r_int
id|fw_pos
suffix:semicolon
r_int
id|tx_size
suffix:semicolon
r_static
id|u8
id|disable_mc44BC374c
(braket
)braket
op_assign
(brace
l_int|0x1d
comma
l_int|0x74
comma
l_int|0xa0
comma
l_int|0x68
)brace
suffix:semicolon
id|mm_segment_t
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// Load the firmware
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|fd
op_assign
id|open
c_func
(paren
id|tda1004x_firmware
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Unable to open firmware %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tda1004x_firmware
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|filesize
op_assign
id|lseek
c_func
(paren
id|fd
comma
l_int|0L
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filesize
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Firmware %s is empty&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tda1004x_firmware
)paren
suffix:semicolon
id|sys_close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
singleline_comment|// find extraction parameters
r_for
c_loop
(paren
id|fwinfo_idx
op_assign
l_int|0
suffix:semicolon
id|fwinfo_idx
OL
id|tda10045h_fwinfo_count
suffix:semicolon
id|fwinfo_idx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tda10045h_fwinfo
(braket
id|fwinfo_idx
)braket
dot
id|file_size
op_eq
id|filesize
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fwinfo_idx
op_ge
id|tda10045h_fwinfo_count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Unsupported firmware %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|tda1004x_firmware
)paren
suffix:semicolon
id|sys_close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|fw_size
op_assign
id|tda10045h_fwinfo
(braket
id|fwinfo_idx
)braket
dot
id|fw_size
suffix:semicolon
singleline_comment|// allocate buffer for it
id|firmware
op_assign
id|vmalloc
c_func
(paren
id|fw_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|firmware
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Out of memory loading firmware&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|sys_close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
singleline_comment|// read it!
id|lseek
c_func
(paren
id|fd
comma
id|tda10045h_fwinfo
(braket
id|fwinfo_idx
)braket
dot
id|fw_offset
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read
c_func
(paren
id|fd
comma
id|firmware
comma
id|fw_size
)paren
op_ne
id|fw_size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Failed to read firmware&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|firmware
)paren
suffix:semicolon
id|sys_close
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|sys_close
c_func
(paren
id|fd
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
singleline_comment|// Disable the MC44BC374C
id|tda1004x_enable_tuner_i2c
c_func
(paren
id|i2c
comma
id|tda_state
)paren
suffix:semicolon
id|tuner_msg.addr
op_assign
id|MC44BC374_ADDRESS
suffix:semicolon
id|tuner_msg.buf
op_assign
id|disable_mc44BC374c
suffix:semicolon
id|tuner_msg.len
op_assign
r_sizeof
(paren
id|disable_mc44BC374c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|tuner_msg
comma
l_int|1
)paren
op_ne
l_int|1
)paren
(brace
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|tuner_msg
comma
l_int|1
)paren
suffix:semicolon
)brace
id|tda1004x_disable_tuner_i2c
c_func
(paren
id|i2c
comma
id|tda_state
)paren
suffix:semicolon
singleline_comment|// set some valid bandwith parameters
r_switch
c_cond
(paren
id|tda_state-&gt;tda1004x_address
)paren
(brace
r_case
id|TDA10045H_ADDRESS
suffix:colon
id|tda10045h_set_bandwidth
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|BANDWIDTH_8_MHZ
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dvb_delay
c_func
(paren
l_int|500
)paren
suffix:semicolon
singleline_comment|// do the firmware upload
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_FWPAGE
comma
l_int|0
)paren
suffix:semicolon
id|fw_msg.addr
op_assign
id|tda_state-&gt;tda1004x_address
suffix:semicolon
id|fw_pos
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|fw_pos
op_ne
id|fw_size
)paren
(brace
singleline_comment|// work out how much to send this time
id|tx_size
op_assign
id|fw_size
op_minus
id|fw_pos
suffix:semicolon
r_if
c_cond
(paren
id|tx_size
OG
l_int|64
)paren
(brace
id|tx_size
op_assign
l_int|64
suffix:semicolon
)brace
singleline_comment|// send the chunk
id|fw_buf
(braket
l_int|0
)braket
op_assign
id|TDA1004X_CODE_IN
suffix:semicolon
id|memcpy
c_func
(paren
id|fw_buf
op_plus
l_int|1
comma
id|firmware
op_plus
id|fw_pos
comma
id|tx_size
)paren
suffix:semicolon
id|fw_msg.len
op_assign
id|tx_size
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|fw_msg
comma
l_int|1
)paren
op_ne
l_int|1
)paren
(brace
id|vfree
c_func
(paren
id|firmware
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|fw_pos
op_add_assign
id|tx_size
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: fw_pos=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|fw_pos
)paren
suffix:semicolon
)brace
id|dvb_delay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|firmware
)paren
suffix:semicolon
singleline_comment|// Initialise the DSP and check upload was OK
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC4
comma
l_int|0x10
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_DSP_CMD
comma
l_int|0x67
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_DSP_DATA1
)paren
op_ne
l_int|0x67
)paren
op_logical_or
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_DSP_DATA2
)paren
op_ne
l_int|0x2c
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: firmware upload failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
singleline_comment|// tda setup
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|0x10
comma
l_int|0x10
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF2
comma
l_int|0xC0
comma
l_int|0x0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC4
comma
l_int|0x20
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFADC1
comma
l_int|0x2e
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC1
comma
l_int|0x80
comma
l_int|0x80
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC1
comma
l_int|0x40
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC1
comma
l_int|0x10
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_REG1E
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_REG1F
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_VBER_MSB
comma
l_int|0xe0
comma
l_int|0xa0
)paren
suffix:semicolon
singleline_comment|// done
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_encode_fec
r_static
r_int
id|tda1004x_encode_fec
c_func
(paren
r_int
id|fec
)paren
(brace
singleline_comment|// convert known FEC values
r_switch
c_cond
(paren
id|fec
)paren
(brace
r_case
id|FEC_1_2
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|FEC_2_3
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|FEC_3_4
suffix:colon
r_return
l_int|2
suffix:semicolon
r_case
id|FEC_5_6
suffix:colon
r_return
l_int|3
suffix:semicolon
r_case
id|FEC_7_8
suffix:colon
r_return
l_int|4
suffix:semicolon
)brace
singleline_comment|// unsupported
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|tda1004x_decode_fec
r_static
r_int
id|tda1004x_decode_fec
c_func
(paren
r_int
id|tdafec
)paren
(brace
singleline_comment|// convert known FEC values
r_switch
c_cond
(paren
id|tdafec
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|FEC_1_2
suffix:semicolon
r_case
l_int|1
suffix:colon
r_return
id|FEC_2_3
suffix:semicolon
r_case
l_int|2
suffix:colon
r_return
id|FEC_3_4
suffix:semicolon
r_case
l_int|3
suffix:colon
r_return
id|FEC_5_6
suffix:semicolon
r_case
l_int|4
suffix:colon
r_return
id|FEC_7_8
suffix:semicolon
)brace
singleline_comment|// unsupported
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|tda1004x_set_frequency
r_static
r_int
id|tda1004x_set_frequency
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
r_struct
id|dvb_frontend_parameters
op_star
id|fe_params
)paren
(brace
id|u8
id|tuner_buf
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|i2c_msg
id|tuner_msg
op_assign
(brace
dot
id|addr
op_assign
l_int|0
comma
dot
id|flags
op_assign
l_int|0
comma
dot
id|buf
op_assign
id|tuner_buf
comma
dot
id|len
op_assign
r_sizeof
(paren
id|tuner_buf
)paren
)brace
suffix:semicolon
r_int
id|tuner_frequency
suffix:semicolon
id|u8
id|band
comma
id|cp
comma
id|filter
suffix:semicolon
r_int
id|counter
comma
id|counter2
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// setup the frequency buffer
r_switch
c_cond
(paren
id|tda_state-&gt;tuner_address
)paren
(brace
r_case
id|TD1344_ADDRESS
suffix:colon
singleline_comment|// setup tuner buffer
id|tuner_frequency
op_assign
(paren
(paren
(paren
id|fe_params-&gt;frequency
op_div
l_int|1000
)paren
op_star
l_int|6
)paren
op_plus
l_int|217502
)paren
op_div
l_int|1000
suffix:semicolon
id|tuner_buf
(braket
l_int|0
)braket
op_assign
id|tuner_frequency
op_rshift
l_int|8
suffix:semicolon
id|tuner_buf
(braket
l_int|1
)braket
op_assign
id|tuner_frequency
op_amp
l_int|0xff
suffix:semicolon
id|tuner_buf
(braket
l_int|2
)braket
op_assign
l_int|0x88
suffix:semicolon
r_if
c_cond
(paren
id|fe_params-&gt;frequency
OL
l_int|550000000
)paren
(brace
id|tuner_buf
(braket
l_int|3
)braket
op_assign
l_int|0xab
suffix:semicolon
)brace
r_else
(brace
id|tuner_buf
(braket
l_int|3
)braket
op_assign
l_int|0xeb
suffix:semicolon
)brace
singleline_comment|// tune it
id|tda1004x_enable_tuner_i2c
c_func
(paren
id|i2c
comma
id|tda_state
)paren
suffix:semicolon
id|tuner_msg.addr
op_assign
id|tda_state-&gt;tuner_address
suffix:semicolon
id|tuner_msg.len
op_assign
l_int|4
suffix:semicolon
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|tuner_msg
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// wait for it to finish
id|tuner_msg.len
op_assign
l_int|1
suffix:semicolon
id|tuner_msg.flags
op_assign
id|I2C_M_RD
suffix:semicolon
id|counter
op_assign
l_int|0
suffix:semicolon
id|counter2
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|counter
op_increment
OL
l_int|100
)paren
(brace
r_if
c_cond
(paren
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|tuner_msg
comma
l_int|1
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|tuner_buf
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
(brace
id|counter2
op_increment
suffix:semicolon
)brace
r_else
(brace
id|counter2
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|counter2
OG
l_int|10
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
id|tda1004x_disable_tuner_i2c
c_func
(paren
id|i2c
comma
id|tda_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TDM1316L_ADDRESS
suffix:colon
singleline_comment|// determine charge pump
id|tuner_frequency
op_assign
id|fe_params-&gt;frequency
op_plus
l_int|36130000
suffix:semicolon
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|87000000
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|130000000
)paren
(brace
id|cp
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|160000000
)paren
(brace
id|cp
op_assign
l_int|5
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|200000000
)paren
(brace
id|cp
op_assign
l_int|6
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|290000000
)paren
(brace
id|cp
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|420000000
)paren
(brace
id|cp
op_assign
l_int|5
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|480000000
)paren
(brace
id|cp
op_assign
l_int|6
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|620000000
)paren
(brace
id|cp
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|830000000
)paren
(brace
id|cp
op_assign
l_int|5
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tuner_frequency
OL
l_int|895000000
)paren
(brace
id|cp
op_assign
l_int|7
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// determine band
r_if
c_cond
(paren
id|fe_params-&gt;frequency
OL
l_int|49000000
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fe_params-&gt;frequency
OL
l_int|159000000
)paren
(brace
id|band
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fe_params-&gt;frequency
OL
l_int|444000000
)paren
(brace
id|band
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fe_params-&gt;frequency
OL
l_int|861000000
)paren
(brace
id|band
op_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// work out filter
r_switch
c_cond
(paren
id|fe_params-&gt;u.ofdm.bandwidth
)paren
(brace
r_case
id|BANDWIDTH_6_MHZ
suffix:colon
singleline_comment|// 6 MHz isn&squot;t supported directly, but set this to
singleline_comment|// the 8 MHz setting in case we can fiddle it later
id|filter
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BANDWIDTH_7_MHZ
suffix:colon
id|filter
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BANDWIDTH_8_MHZ
suffix:colon
id|filter
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// calculate tuner parameters
id|tuner_frequency
op_assign
(paren
(paren
(paren
id|fe_params-&gt;frequency
op_div
l_int|1000
)paren
op_star
l_int|6
)paren
op_plus
l_int|217280
)paren
op_div
l_int|1000
suffix:semicolon
id|tuner_buf
(braket
l_int|0
)braket
op_assign
id|tuner_frequency
op_rshift
l_int|8
suffix:semicolon
id|tuner_buf
(braket
l_int|1
)braket
op_assign
id|tuner_frequency
op_amp
l_int|0xff
suffix:semicolon
id|tuner_buf
(braket
l_int|2
)braket
op_assign
l_int|0xca
suffix:semicolon
id|tuner_buf
(braket
l_int|3
)braket
op_assign
(paren
id|cp
op_lshift
l_int|5
)paren
op_or
(paren
id|filter
op_lshift
l_int|3
)paren
op_or
id|band
suffix:semicolon
singleline_comment|// tune it
id|tda1004x_enable_tuner_i2c
c_func
(paren
id|i2c
comma
id|tda_state
)paren
suffix:semicolon
id|tuner_msg.addr
op_assign
id|tda_state-&gt;tuner_address
suffix:semicolon
id|tuner_msg.len
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|tuner_msg
comma
l_int|1
)paren
op_ne
l_int|1
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|dvb_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|tda1004x_disable_tuner_i2c
c_func
(paren
id|i2c
comma
id|tda_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;%s: success&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// done
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_set_fe
r_static
r_int
id|tda1004x_set_fe
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
r_struct
id|dvb_frontend_parameters
op_star
id|fe_params
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// set frequency
id|tmp
op_assign
id|tda1004x_set_frequency
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|fe_params
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
id|tmp
suffix:semicolon
singleline_comment|// hardcoded to use auto as much as possible
id|fe_params-&gt;u.ofdm.code_rate_HP
op_assign
id|FEC_AUTO
suffix:semicolon
id|fe_params-&gt;u.ofdm.guard_interval
op_assign
id|GUARD_INTERVAL_AUTO
suffix:semicolon
id|fe_params-&gt;u.ofdm.transmission_mode
op_assign
id|TRANSMISSION_MODE_AUTO
suffix:semicolon
singleline_comment|// Set standard params.. or put them to auto
r_if
c_cond
(paren
(paren
id|fe_params-&gt;u.ofdm.code_rate_HP
op_eq
id|FEC_AUTO
)paren
op_logical_or
(paren
id|fe_params-&gt;u.ofdm.code_rate_LP
op_eq
id|FEC_AUTO
)paren
op_logical_or
(paren
id|fe_params-&gt;u.ofdm.constellation
op_eq
id|QAM_AUTO
)paren
op_logical_or
(paren
id|fe_params-&gt;u.ofdm.hierarchy_information
op_eq
id|HIERARCHY_AUTO
)paren
)paren
(brace
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// enable auto
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x03
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// turn off constellation bits
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x60
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// turn off hierarchy bits
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF2
comma
l_int|0x3f
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// turn off FEC bits
)brace
r_else
(brace
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// disable auto
singleline_comment|// set HP FEC
id|tmp
op_assign
id|tda1004x_encode_fec
c_func
(paren
id|fe_params-&gt;u.ofdm.code_rate_HP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
id|tmp
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF2
comma
l_int|7
comma
id|tmp
)paren
suffix:semicolon
singleline_comment|// set LP FEC
r_if
c_cond
(paren
id|fe_params-&gt;u.ofdm.code_rate_LP
op_ne
id|FEC_NONE
)paren
(brace
id|tmp
op_assign
id|tda1004x_encode_fec
c_func
(paren
id|fe_params-&gt;u.ofdm.code_rate_LP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
id|tmp
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF2
comma
l_int|0x38
comma
id|tmp
op_lshift
l_int|3
)paren
suffix:semicolon
)brace
singleline_comment|// set constellation
r_switch
c_cond
(paren
id|fe_params-&gt;u.ofdm.constellation
)paren
(brace
r_case
id|QPSK
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|QAM_16
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|3
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|QAM_64
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|3
comma
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// set hierarchy
r_switch
c_cond
(paren
id|fe_params-&gt;u.ofdm.hierarchy_information
)paren
(brace
r_case
id|HIERARCHY_NONE
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x60
comma
l_int|0
op_lshift
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIERARCHY_1
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x60
comma
l_int|1
op_lshift
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIERARCHY_2
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x60
comma
l_int|2
op_lshift
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIERARCHY_4
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x60
comma
l_int|3
op_lshift
l_int|5
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
singleline_comment|// set bandwidth
r_switch
c_cond
(paren
id|tda_state-&gt;tda1004x_address
)paren
(brace
r_case
id|TDA10045H_ADDRESS
suffix:colon
id|tda10045h_set_bandwidth
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|fe_params-&gt;u.ofdm.bandwidth
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// set inversion
r_switch
c_cond
(paren
id|fe_params-&gt;inversion
)paren
(brace
r_case
id|INVERSION_OFF
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC1
comma
l_int|0x20
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|INVERSION_ON
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC1
comma
l_int|0x20
comma
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// set guard interval
r_switch
c_cond
(paren
id|fe_params-&gt;u.ofdm.guard_interval
)paren
(brace
r_case
id|GUARD_INTERVAL_1_32
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x0c
comma
l_int|0
op_lshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GUARD_INTERVAL_1_16
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x0c
comma
l_int|1
op_lshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GUARD_INTERVAL_1_8
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x0c
comma
l_int|2
op_lshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GUARD_INTERVAL_1_4
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x0c
comma
l_int|3
op_lshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GUARD_INTERVAL_AUTO
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|2
comma
l_int|2
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x0c
comma
l_int|0
op_lshift
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// set transmission mode
r_switch
c_cond
(paren
id|fe_params-&gt;u.ofdm.transmission_mode
)paren
(brace
r_case
id|TRANSMISSION_MODE_2K
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x10
comma
l_int|0
op_lshift
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TRANSMISSION_MODE_8K
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x10
comma
l_int|1
op_lshift
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TRANSMISSION_MODE_AUTO
suffix:colon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_AUTO
comma
l_int|4
comma
l_int|4
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_IN_CONF1
comma
l_int|0x10
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// reset DSP
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC4
comma
l_int|8
comma
l_int|8
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC4
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|dvb_delay
c_func
(paren
l_int|10
)paren
suffix:semicolon
singleline_comment|// done
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_get_fe
r_static
r_int
id|tda1004x_get_fe
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
r_struct
id|dvb_frontend_parameters
op_star
id|fe_params
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// inversion status
id|fe_params-&gt;inversion
op_assign
id|INVERSION_OFF
suffix:semicolon
r_if
c_cond
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CONFC1
)paren
op_amp
l_int|0x20
)paren
(brace
id|fe_params-&gt;inversion
op_assign
id|INVERSION_ON
suffix:semicolon
)brace
singleline_comment|// bandwidth
r_switch
c_cond
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_WREF_LSB
)paren
)paren
(brace
r_case
l_int|0x14
suffix:colon
id|fe_params-&gt;u.ofdm.bandwidth
op_assign
id|BANDWIDTH_8_MHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xdb
suffix:colon
id|fe_params-&gt;u.ofdm.bandwidth
op_assign
id|BANDWIDTH_7_MHZ
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4f
suffix:colon
id|fe_params-&gt;u.ofdm.bandwidth
op_assign
id|BANDWIDTH_6_MHZ
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// FEC
id|fe_params-&gt;u.ofdm.code_rate_HP
op_assign
id|tda1004x_decode_fec
c_func
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_OUT_CONF2
)paren
op_amp
l_int|7
)paren
suffix:semicolon
id|fe_params-&gt;u.ofdm.code_rate_LP
op_assign
id|tda1004x_decode_fec
c_func
(paren
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_OUT_CONF2
)paren
op_rshift
l_int|3
)paren
op_amp
l_int|7
)paren
suffix:semicolon
singleline_comment|// constellation
r_switch
c_cond
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_OUT_CONF1
)paren
op_amp
l_int|3
)paren
(brace
r_case
l_int|0
suffix:colon
id|fe_params-&gt;u.ofdm.constellation
op_assign
id|QPSK
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|fe_params-&gt;u.ofdm.constellation
op_assign
id|QAM_16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|fe_params-&gt;u.ofdm.constellation
op_assign
id|QAM_64
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// transmission mode
id|fe_params-&gt;u.ofdm.transmission_mode
op_assign
id|TRANSMISSION_MODE_2K
suffix:semicolon
r_if
c_cond
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_OUT_CONF1
)paren
op_amp
l_int|0x10
)paren
(brace
id|fe_params-&gt;u.ofdm.transmission_mode
op_assign
id|TRANSMISSION_MODE_8K
suffix:semicolon
)brace
singleline_comment|// guard interval
r_switch
c_cond
(paren
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_OUT_CONF1
)paren
op_amp
l_int|0x0c
)paren
op_rshift
l_int|2
)paren
(brace
r_case
l_int|0
suffix:colon
id|fe_params-&gt;u.ofdm.guard_interval
op_assign
id|GUARD_INTERVAL_1_32
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|fe_params-&gt;u.ofdm.guard_interval
op_assign
id|GUARD_INTERVAL_1_16
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|fe_params-&gt;u.ofdm.guard_interval
op_assign
id|GUARD_INTERVAL_1_8
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|fe_params-&gt;u.ofdm.guard_interval
op_assign
id|GUARD_INTERVAL_1_4
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// hierarchy
r_switch
c_cond
(paren
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_OUT_CONF1
)paren
op_amp
l_int|0x60
)paren
op_rshift
l_int|5
)paren
(brace
r_case
l_int|0
suffix:colon
id|fe_params-&gt;u.ofdm.hierarchy_information
op_assign
id|HIERARCHY_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|fe_params-&gt;u.ofdm.hierarchy_information
op_assign
id|HIERARCHY_1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|fe_params-&gt;u.ofdm.hierarchy_information
op_assign
id|HIERARCHY_2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|fe_params-&gt;u.ofdm.hierarchy_information
op_assign
id|HIERARCHY_4
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// done
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_read_status
r_static
r_int
id|tda1004x_read_status
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
id|fe_status_t
op_star
id|fe_status
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
id|cber
suffix:semicolon
r_int
id|vber
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// read status
id|status
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_STATUS_CD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
l_int|1
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
singleline_comment|// decode
op_star
id|fe_status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|4
)paren
op_star
id|fe_status
op_or_assign
id|FE_HAS_SIGNAL
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|2
)paren
op_star
id|fe_status
op_or_assign
id|FE_HAS_CARRIER
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|8
)paren
op_star
id|fe_status
op_or_assign
id|FE_HAS_VITERBI
op_or
id|FE_HAS_SYNC
op_or
id|FE_HAS_LOCK
suffix:semicolon
singleline_comment|// if we don&squot;t already have VITERBI (i.e. not LOCKED), see if the viterbi
singleline_comment|// is getting anything valid
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|fe_status
op_amp
id|FE_HAS_VITERBI
)paren
)paren
(brace
singleline_comment|// read the CBER
id|cber
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CBER_LSB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cber
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|status
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CBER_MSB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|cber
op_or_assign
(paren
id|status
op_lshift
l_int|8
)paren
suffix:semicolon
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CBER_RESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cber
op_ne
l_int|65535
)paren
(brace
op_star
id|fe_status
op_or_assign
id|FE_HAS_VITERBI
suffix:semicolon
)brace
)brace
singleline_comment|// if we DO have some valid VITERBI output, but don&squot;t already have SYNC
singleline_comment|// bytes (i.e. not LOCKED), see if the RS decoder is getting anything valid.
r_if
c_cond
(paren
(paren
op_star
id|fe_status
op_amp
id|FE_HAS_VITERBI
)paren
op_logical_and
(paren
op_logical_neg
(paren
op_star
id|fe_status
op_amp
id|FE_HAS_SYNC
)paren
)paren
)paren
(brace
singleline_comment|// read the VBER
id|vber
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_VBER_LSB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vber
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|status
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_VBER_MID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|vber
op_or_assign
(paren
id|status
op_lshift
l_int|8
)paren
suffix:semicolon
id|status
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_VBER_MSB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|vber
op_or_assign
(paren
(paren
id|status
op_lshift
l_int|16
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CVBER_LUT
)paren
suffix:semicolon
singleline_comment|// if RS has passed some valid TS packets, then we must be
singleline_comment|// getting some SYNC bytes
r_if
c_cond
(paren
id|vber
OL
l_int|16632
)paren
(brace
op_star
id|fe_status
op_or_assign
id|FE_HAS_SYNC
suffix:semicolon
)brace
)brace
singleline_comment|// success
id|dprintk
c_func
(paren
l_string|&quot;%s: fe_status=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
op_star
id|fe_status
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_read_signal_strength
r_static
r_int
id|tda1004x_read_signal_strength
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
id|u16
op_star
id|signal
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// read it
id|tmp
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_SIGNAL_STRENGTH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
singleline_comment|// done
op_star
id|signal
op_assign
(paren
id|tmp
op_lshift
l_int|8
)paren
op_or
id|tmp
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: signal=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
op_star
id|signal
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_read_snr
r_static
r_int
id|tda1004x_read_snr
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
id|u16
op_star
id|snr
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// read it
id|tmp
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_SNR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
(brace
id|tmp
op_assign
l_int|255
op_minus
id|tmp
suffix:semicolon
)brace
singleline_comment|// done
op_star
id|snr
op_assign
(paren
(paren
id|tmp
op_lshift
l_int|8
)paren
op_or
id|tmp
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: snr=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
op_star
id|snr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_read_ucblocks
r_static
r_int
id|tda1004x_read_ucblocks
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
id|u32
op_star
id|ucblocks
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_int
id|tmp2
suffix:semicolon
r_int
id|counter
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// read the UCBLOCKS and reset
id|counter
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_UNCOR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|tmp
op_and_assign
l_int|0x7f
suffix:semicolon
r_while
c_loop
(paren
id|counter
op_increment
OL
l_int|5
)paren
(brace
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_UNCOR
comma
l_int|0x80
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_UNCOR
comma
l_int|0x80
comma
l_int|0
)paren
suffix:semicolon
id|tda1004x_write_mask
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_UNCOR
comma
l_int|0x80
comma
l_int|0
)paren
suffix:semicolon
id|tmp2
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_UNCOR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp2
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|tmp2
op_and_assign
l_int|0x7f
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp2
OL
id|tmp
)paren
op_logical_or
(paren
id|tmp2
op_eq
l_int|0
)paren
)paren
r_break
suffix:semicolon
)brace
singleline_comment|// done
r_if
c_cond
(paren
id|tmp
op_ne
l_int|0x7f
)paren
(brace
op_star
id|ucblocks
op_assign
id|tmp
suffix:semicolon
)brace
r_else
(brace
op_star
id|ucblocks
op_assign
l_int|0xffffffff
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;%s: ucblocks=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
op_star
id|ucblocks
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_read_ber
r_static
r_int
id|tda1004x_read_ber
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|tda1004x_state
op_star
id|tda_state
comma
id|u32
op_star
id|ber
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// read it in
id|tmp
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CBER_LSB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
op_star
id|ber
op_assign
id|tmp
op_lshift
l_int|1
suffix:semicolon
id|tmp
op_assign
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CBER_MSB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
op_star
id|ber
op_or_assign
(paren
id|tmp
op_lshift
l_int|9
)paren
suffix:semicolon
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
id|tda_state
comma
id|TDA1004X_CBER_RESET
)paren
suffix:semicolon
singleline_comment|// done
id|dprintk
c_func
(paren
l_string|&quot;%s: ber=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
op_star
id|ber
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_ioctl
r_static
r_int
id|tda1004x_ioctl
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_struct
id|dvb_i2c_bus
op_star
id|i2c
op_assign
id|fe-&gt;i2c
suffix:semicolon
r_struct
id|tda1004x_state
op_star
id|tda_state
op_assign
(paren
r_struct
id|tda1004x_state
op_star
)paren
op_amp
(paren
id|fe-&gt;data
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: cmd=0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|FE_GET_INFO
suffix:colon
r_switch
c_cond
(paren
id|tda_state-&gt;tda1004x_address
)paren
(brace
r_case
id|TDA10045H_ADDRESS
suffix:colon
id|memcpy
c_func
(paren
id|arg
comma
op_amp
id|tda10045h_info
comma
r_sizeof
(paren
r_struct
id|dvb_frontend_info
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|FE_READ_STATUS
suffix:colon
r_return
id|tda1004x_read_status
c_func
(paren
id|i2c
comma
id|tda_state
comma
(paren
id|fe_status_t
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|FE_READ_BER
suffix:colon
r_return
id|tda1004x_read_ber
c_func
(paren
id|i2c
comma
id|tda_state
comma
(paren
id|u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|FE_READ_SIGNAL_STRENGTH
suffix:colon
r_return
id|tda1004x_read_signal_strength
c_func
(paren
id|i2c
comma
id|tda_state
comma
(paren
id|u16
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|FE_READ_SNR
suffix:colon
r_return
id|tda1004x_read_snr
c_func
(paren
id|i2c
comma
id|tda_state
comma
(paren
id|u16
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|FE_READ_UNCORRECTED_BLOCKS
suffix:colon
r_return
id|tda1004x_read_ucblocks
c_func
(paren
id|i2c
comma
id|tda_state
comma
(paren
id|u32
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|FE_SET_FRONTEND
suffix:colon
r_return
id|tda1004x_set_fe
c_func
(paren
id|i2c
comma
id|tda_state
comma
(paren
r_struct
id|dvb_frontend_parameters
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|FE_GET_FRONTEND
suffix:colon
r_return
id|tda1004x_get_fe
c_func
(paren
id|i2c
comma
id|tda_state
comma
(paren
r_struct
id|dvb_frontend_parameters
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|FE_INIT
suffix:colon
singleline_comment|// don&squot;t bother reinitialising
r_if
c_cond
(paren
id|tda_state-&gt;initialised
)paren
r_return
l_int|0
suffix:semicolon
singleline_comment|// OK, perform initialisation
id|status
op_assign
id|tda1004x_init
c_func
(paren
id|i2c
comma
id|tda_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|tda_state-&gt;initialised
op_assign
l_int|1
suffix:semicolon
r_return
id|status
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tda1004x_attach
r_static
r_int
id|tda1004x_attach
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
)paren
(brace
r_int
id|tda1004x_address
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|tuner_address
op_assign
op_minus
l_int|1
suffix:semicolon
r_struct
id|tda1004x_state
id|tda_state
suffix:semicolon
r_struct
id|i2c_msg
id|tuner_msg
op_assign
(brace
dot
id|addr
op_assign
l_int|0
comma
dot
id|flags
op_assign
l_int|0
comma
dot
id|buf
op_assign
l_int|0
comma
dot
id|len
op_assign
l_int|0
)brace
suffix:semicolon
r_static
id|u8
id|td1344_init
(braket
)braket
op_assign
(brace
l_int|0x0b
comma
l_int|0xf5
comma
l_int|0x88
comma
l_int|0xab
)brace
suffix:semicolon
r_static
id|u8
id|tdm1316l_init
(braket
)braket
op_assign
(brace
l_int|0x0b
comma
l_int|0xf5
comma
l_int|0x85
comma
l_int|0xab
)brace
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// probe for frontend
id|tda_state.tda1004x_address
op_assign
id|TDA10045H_ADDRESS
suffix:semicolon
r_if
c_cond
(paren
id|tda1004x_read_byte
c_func
(paren
id|i2c
comma
op_amp
id|tda_state
comma
id|TDA1004X_CHIPID
)paren
op_eq
l_int|0x25
)paren
(brace
id|tda1004x_address
op_assign
id|TDA10045H_ADDRESS
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tda1004x: Detected Philips TDA10045H.&bslash;n&quot;
)paren
suffix:semicolon
)brace
singleline_comment|// did we find a frontend?
r_if
c_cond
(paren
id|tda1004x_address
op_eq
op_minus
l_int|1
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
singleline_comment|// supported tuner?
id|tda1004x_enable_tuner_i2c
c_func
(paren
id|i2c
comma
op_amp
id|tda_state
)paren
suffix:semicolon
id|tuner_msg.addr
op_assign
id|TD1344_ADDRESS
suffix:semicolon
id|tuner_msg.buf
op_assign
id|td1344_init
suffix:semicolon
id|tuner_msg.len
op_assign
r_sizeof
(paren
id|td1344_init
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|tuner_msg
comma
l_int|1
)paren
op_eq
l_int|1
)paren
(brace
id|dvb_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|tuner_address
op_assign
id|TD1344_ADDRESS
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tda1004x: Detected Philips TD1344 tuner. PLEASE CHECK THIS AND REPORT BACK!.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|tuner_msg.addr
op_assign
id|TDM1316L_ADDRESS
suffix:semicolon
id|tuner_msg.buf
op_assign
id|tdm1316l_init
suffix:semicolon
id|tuner_msg.len
op_assign
r_sizeof
(paren
id|tdm1316l_init
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c
op_member_access_from_pointer
id|xfer
c_func
(paren
id|i2c
comma
op_amp
id|tuner_msg
comma
l_int|1
)paren
op_eq
l_int|1
)paren
(brace
id|dvb_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|tuner_address
op_assign
id|TDM1316L_ADDRESS
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;tda1004x: Detected Philips TDM1316L tuner.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|tda1004x_disable_tuner_i2c
c_func
(paren
id|i2c
comma
op_amp
id|tda_state
)paren
suffix:semicolon
singleline_comment|// did we find a tuner?
r_if
c_cond
(paren
id|tuner_address
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;tda1004x: Detected, but with unknown tuner.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
singleline_comment|// create state
id|tda_state.tda1004x_address
op_assign
id|tda1004x_address
suffix:semicolon
id|tda_state.tuner_address
op_assign
id|tuner_address
suffix:semicolon
id|tda_state.initialised
op_assign
l_int|0
suffix:semicolon
singleline_comment|// register
r_switch
c_cond
(paren
id|tda_state.tda1004x_address
)paren
(brace
r_case
id|TDA10045H_ADDRESS
suffix:colon
id|dvb_register_frontend
c_func
(paren
id|tda1004x_ioctl
comma
id|i2c
comma
(paren
r_void
op_star
)paren
(paren
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|tda_state
)paren
)paren
comma
op_amp
id|tda10045h_info
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// success
r_return
l_int|0
suffix:semicolon
)brace
r_static
DECL|function|tda1004x_detach
r_void
id|tda1004x_detach
c_func
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dvb_unregister_frontend
c_func
(paren
id|tda1004x_ioctl
comma
id|i2c
)paren
suffix:semicolon
)brace
r_static
DECL|function|init_tda1004x
r_int
id|__init
id|init_tda1004x
c_func
(paren
r_void
)paren
(brace
r_return
id|dvb_register_i2c_device
c_func
(paren
id|THIS_MODULE
comma
id|tda1004x_attach
comma
id|tda1004x_detach
)paren
suffix:semicolon
)brace
r_static
DECL|function|exit_tda1004x
r_void
id|__exit
id|exit_tda1004x
c_func
(paren
r_void
)paren
(brace
id|dvb_unregister_i2c_device
c_func
(paren
id|tda1004x_attach
)paren
suffix:semicolon
)brace
DECL|variable|init_tda1004x
id|module_init
c_func
(paren
id|init_tda1004x
)paren
suffix:semicolon
DECL|variable|exit_tda1004x
id|module_exit
c_func
(paren
id|exit_tda1004x
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Philips TDA10045H DVB-T Frontend&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Andrew de Quincey &amp; Robert Schlabbach&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tda1004x_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tda1004x_debug
comma
l_string|&quot;enable verbose debug messages&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tda1004x_firmware
comma
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tda1004x_firmware
comma
l_string|&quot;Where to find the firmware file&quot;
)paren
suffix:semicolon
eof
