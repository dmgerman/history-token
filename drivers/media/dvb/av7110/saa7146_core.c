multiline_comment|/*&n;    saa7146_core.c - core-functions + i2c driver for the saa7146 by&n;    Philips Semiconductors.&n;    &n;    Copyright (C) 1998,1999 Michael Hunold &lt;michael@mihu.de&gt;&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/module.h&gt;&t;/* for module-version */
macro_line|#include &lt;linux/delay.h&gt;&t;/* for delay-stuff */
macro_line|#include &lt;linux/slab.h&gt;&t;&t;/* for kmalloc/kfree */
macro_line|#include &lt;linux/pci.h&gt;&t;&t;/* for pci-config-stuff, vendor ids etc. */
macro_line|#include &lt;linux/wrapper.h&gt;&t;/* for mem_map_reserve */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;&t;&t;/* for accessing the pci-device */
macro_line|#include &lt;linux/vmalloc.h&gt;&t;/* for module-version */
macro_line|#include &quot;saa7146_defs.h&quot;
macro_line|#include &quot;saa7146_core.h&quot;
macro_line|#include &quot;saa7146_v4l.h&quot;
macro_line|#include &quot;av7110.h&quot;
macro_line|#include &quot;../dvb-core/compat.h&quot;
macro_line|#include &quot;../dvb-core/dvb_i2c.h&quot;
multiline_comment|/* insmod parameter: here you can specify the number of video-buffers&n;   to be allocated. for simple capturing 2 buffers (double-buffering)&n;   should suffice. but if you plan to do 25fps grabbing, you should&n;   set this to 4(=maximum), in order to be able to catch up from&n;   temporarily delays */
DECL|variable|buffers
r_static
r_int
id|buffers
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* insmod parameter: some programs (e.g. &#xfffd;vic&#xfffd;) do not allow to&n;   specify the used video-mode, so you have to tell this to the&n;   modules by hand, 0 = PAL, 1 = NTSC  */
DECL|variable|mode
r_static
r_int
id|mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* debug levels: 0 -- no debugging outputs&n;&t;&t; 1 -- prints out entering (and exiting if useful) of functions&n;&t;&t; 2 -- prints out very, very detailed informations of what is going on&n;&t;&t; 3 -- both of the above */
DECL|variable|saa7146_debug
r_int
id|saa7146_debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* insmod parameter */
DECL|macro|dprintk
mdefine_line|#define dprintk&t;&t;if (saa7146_debug &amp; 1) printk
DECL|macro|hprintk
mdefine_line|#define hprintk&t;&t;if (saa7146_debug &amp; 2) printk
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* memory functions - taken from bttv.c&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
DECL|function|kvirt_to_pa
r_static
r_inline
r_int
r_int
id|kvirt_to_pa
c_func
(paren
r_int
r_int
id|adr
)paren
(brace
r_int
r_int
id|kva
suffix:semicolon
id|kva
op_assign
(paren
r_int
r_int
)paren
id|page_address
c_func
(paren
id|vmalloc_to_page
c_func
(paren
(paren
r_void
op_star
)paren
id|adr
)paren
)paren
suffix:semicolon
id|kva
op_or_assign
id|adr
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* restore the offset */
r_return
id|__pa
c_func
(paren
id|kva
)paren
suffix:semicolon
)brace
r_static
id|LIST_HEAD
c_func
(paren
id|saa7146_list
)paren
suffix:semicolon
DECL|variable|saa7146_extension_count
r_static
r_int
id|saa7146_extension_count
op_assign
l_int|0
suffix:semicolon
DECL|variable|saa7146_ext
r_static
r_struct
id|saa7146_extension
op_star
id|saa7146_ext
(braket
id|SAA7146_MAX_EXTENSIONS
)braket
suffix:semicolon
DECL|macro|SAA7146_I2C_TIMEOUT
mdefine_line|#define SAA7146_I2C_TIMEOUT  100   /* in ms */
DECL|macro|SAA7146_I2C_RETRIES
mdefine_line|#define SAA7146_I2C_RETRIES  6
DECL|variable|SAA7146_I2C_BBR
r_static
id|u32
id|SAA7146_I2C_BBR
op_assign
id|SAA7146_I2C_BUS_BIT_RATE_3200
suffix:semicolon
DECL|macro|__COMPILE_SAA7146_I2C__
mdefine_line|#define&t;__COMPILE_SAA7146_I2C__
DECL|macro|__COMPILE_SAA7146_DEBI__
mdefine_line|#define&t;__COMPILE_SAA7146_DEBI__
macro_line|#include &quot;saa7146.c&quot;
DECL|macro|__COMPILE_SAA7146_I2C__
macro_line|#undef&t;__COMPILE_SAA7146_I2C__
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* memory functions designed for saa7146&t;*/
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* rvmalloc allocates the memory and builds up&n;   the page-tables for &#xfffd;quant&#xfffd;-number of buffers */
DECL|function|rvmalloc
r_static
r_void
op_star
id|rvmalloc
c_func
(paren
r_int
id|quant
comma
id|u32
op_star
id|pt
(braket
)braket
)paren
(brace
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|adr
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|u32
op_star
id|ptp
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: rvmalloc called, quant:%d&bslash;n&quot;
comma
id|quant
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|quant
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* get grabbing memory */
id|mem
op_assign
id|vmalloc_32
c_func
(paren
id|quant
op_star
id|GRABBING_MEM_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: alloc page tables&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* alloc one page for a page-table for &#xfffd;quant&#xfffd; buffers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|quant
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pt
(braket
id|i
)braket
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* error: memory could not be allocated */
r_if
c_cond
(paren
op_logical_neg
id|pt
(braket
id|i
)braket
)paren
(brace
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: failed, free tables&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
(paren
id|i
op_minus
l_int|1
)paren
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|kfree
c_func
(paren
id|pt
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: free buffer memory&bslash;n&quot;
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: return 0 address for buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|pt
(braket
id|i
)braket
comma
l_int|0x00
comma
id|PAGE_SIZE
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: clear RAM&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* clear the ram out, no junk to the user&n;&t;   note: 0x7f gives a nice grey field&n;&t;   in RGB and YUV as well */
id|memset
c_func
(paren
id|mem
comma
l_int|0x7f
comma
id|quant
op_star
id|GRABBING_MEM_SIZE
)paren
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: build page tables&bslash;n&quot;
)paren
suffix:semicolon
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
multiline_comment|/* walk through the grabbing-memory and build up the page-tables */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|quant
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|GRABBING_MEM_SIZE
suffix:semicolon
id|count
op_add_assign
id|PAGE_SIZE
)paren
id|mem_map_reserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|kvirt_to_pa
c_func
(paren
id|adr
op_plus
id|count
)paren
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* separate loop for SAA MMU, PAGE_SIZE can be !=4096 */
id|ptp
op_assign
id|pt
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|GRABBING_MEM_SIZE
suffix:semicolon
id|count
op_add_assign
l_int|4096
comma
id|adr
op_add_assign
l_int|4096
)paren
op_star
(paren
id|ptp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: page tables built&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|mem
suffix:semicolon
)brace
DECL|function|rvfree
r_static
r_void
id|rvfree
c_func
(paren
r_void
op_star
id|mem
comma
r_int
id|quant
comma
id|u32
op_star
id|pt
(braket
)braket
)paren
(brace
r_int
r_int
id|adr
comma
id|page
suffix:semicolon
r_int
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146: rvfree called&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|quant
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|mem
)paren
(brace
id|adr
op_assign
(paren
r_int
r_int
)paren
id|mem
suffix:semicolon
id|size
op_assign
id|quant
op_star
id|GRABBING_MEM_SIZE
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|adr
)paren
suffix:semicolon
id|mem_map_unreserve
c_func
(paren
id|virt_to_page
c_func
(paren
id|__va
c_func
(paren
id|page
)paren
)paren
)paren
suffix:semicolon
id|adr
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
multiline_comment|/* release the grabbing memory */
id|vfree
c_func
(paren
id|mem
)paren
suffix:semicolon
)brace
multiline_comment|/* free the page tables */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|quant
suffix:semicolon
id|i
op_increment
)paren
(brace
id|kfree
c_func
(paren
id|pt
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* i2c-functions&t;&t;&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
r_static
DECL|function|do_master_xfer
r_int
id|do_master_xfer
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_struct
id|saa7146
op_star
id|a
op_assign
id|i2c-&gt;data
suffix:semicolon
r_int
id|result
comma
id|count
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: master_xfer called, num:%d&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
multiline_comment|/* prepare the message(s), get number of u32s to transfer */
id|count
op_assign
id|prepare
c_func
(paren
id|msgs
comma
id|num
comma
id|a-&gt;i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|count
)paren
(brace
id|hprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: master_xfer: could not prepare i2c-message&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* reset the i2c-device if necessary */
id|result
op_assign
id|i2c_reset
c_func
(paren
id|a
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|hprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: master_xfer: could not reset i2c-bus&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* see how many u32 have to be transferred;&n;&t;&t; * if there is only 1,&n;&t;&t; * we do not start the whole rps1-engine...&n;&t;&t; */
id|result
op_assign
id|i2c_write_out
c_func
(paren
id|a
comma
op_amp
id|a-&gt;i2c
(braket
id|i
)braket
comma
id|SAA7146_I2C_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|result
)paren
(brace
multiline_comment|/* if address-error occured, don&squot;t retry */
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EREMOTEIO
)paren
(brace
id|hprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: master_xfer: error in address phase&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|hprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: master_xfer: error transferring, trying again&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* see if an error occured &amp; the last retry failed */
r_if
c_cond
(paren
l_int|0
op_ne
id|result
)paren
(brace
id|hprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: master_xfer: could not transfer i2c-message&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* if any things had to be read, get the results */
id|result
op_assign
id|clean_up
c_func
(paren
id|msgs
comma
id|num
comma
id|a-&gt;i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|result
)paren
(brace
id|hprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: master_xfer: could not cleanup&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* return the number of delivered messages */
r_return
id|num
suffix:semicolon
)brace
r_static
DECL|function|master_xfer
r_int
id|master_xfer
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_int
id|retries
op_assign
id|SAA7146_I2C_RETRIES
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_do
(brace
id|ret
op_assign
id|do_master_xfer
(paren
id|i2c
comma
id|msgs
comma
id|num
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ret
op_ne
id|num
op_logical_and
id|retries
op_decrement
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* registering functions to load algorithms at runtime */
DECL|function|i2c_saa7146_add_bus
r_int
id|i2c_saa7146_add_bus
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
multiline_comment|/* enable i2c-port pins */
id|saa7146_write
(paren
id|saa-&gt;mem
comma
id|MC1
comma
(paren
id|MASK_08
op_or
id|MASK_24
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|saa-&gt;name
comma
l_string|&quot;saa7146(%d)&quot;
comma
id|saa-&gt;dvb_adapter-&gt;num
)paren
suffix:semicolon
id|saa-&gt;i2c_bus
op_assign
id|dvb_register_i2c_bus
(paren
id|master_xfer
comma
id|saa
comma
id|saa-&gt;dvb_adapter
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;i2c_bus
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2c_saa7146_del_bus
r_void
id|i2c_saa7146_del_bus
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
id|dvb_unregister_i2c_bus
(paren
id|master_xfer
comma
id|saa-&gt;i2c_bus-&gt;adapter
comma
id|saa-&gt;i2c_bus-&gt;id
)paren
suffix:semicolon
id|dvb_unregister_adapter
(paren
id|saa-&gt;dvb_adapter
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* debug-helper function: dump-registers&t;*/
multiline_comment|/* ---------------------------------------------*/
DECL|function|dump_registers
r_void
id|dump_registers
c_func
(paren
r_int
r_char
op_star
id|mem
)paren
(brace
id|u16
id|j
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0x0
suffix:semicolon
id|j
OL
l_int|0x1fe
suffix:semicolon
id|j
op_add_assign
l_int|0x4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%03x: 0x%08x&bslash;n&quot;
comma
id|j
comma
id|saa7146_read
c_func
(paren
id|mem
comma
id|j
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* -----------------------------------------------------*/
multiline_comment|/* dispatcher-function for handling external commands&t;*/
multiline_comment|/* -----------------------------------------------------*/
DECL|function|saa7146_core_command
r_static
r_int
id|saa7146_core_command
(paren
r_struct
id|dvb_i2c_bus
op_star
id|i2c
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_int
id|i
op_assign
l_int|0
comma
id|result
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_struct
id|saa7146
op_star
id|saa
op_assign
id|i2c-&gt;data
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saa7146_core.o: ==&gt; saa7146_core_command&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|saa
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* first let the extensions handle the command */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SAA7146_MAX_EXTENSIONS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_ne
id|saa7146_ext
(braket
id|i
)braket
)paren
(brace
r_if
c_cond
(paren
op_minus
id|ENOIOCTLCMD
op_ne
(paren
id|result
op_assign
id|saa7146_ext
(braket
id|i
)braket
op_member_access_from_pointer
id|command
c_func
(paren
id|saa
comma
id|saa-&gt;data
(braket
id|i
)braket
comma
id|cmd
comma
id|arg
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* if command has not been handled by an extension, handle it now */
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|ENOIOCTLCMD
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SAA7146_DUMP_REGISTERS
suffix:colon
(brace
id|dump_registers
c_func
(paren
id|saa-&gt;mem
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SAA7146_SET_DD1
suffix:colon
(brace
id|u32
op_star
id|i
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: SAA7146_SET_DD1 to 0x%08x&bslash;n&quot;
comma
op_star
id|i
)paren
suffix:semicolon
multiline_comment|/* set dd1 port register */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|DD1_INIT
comma
op_star
id|i
)paren
suffix:semicolon
multiline_comment|/* write out init-values */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_09
op_or
id|MASK_10
op_or
id|MASK_26
op_or
id|MASK_26
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SAA7146_DO_MMAP
suffix:colon
(brace
r_struct
id|vm_area_struct
op_star
id|vma
op_assign
id|arg
suffix:semicolon
r_int
r_int
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_int
r_int
id|start
op_assign
id|vma-&gt;vm_start
suffix:semicolon
r_int
r_int
id|page
comma
id|pos
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: SAA7146_DO_MMAP.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|saa-&gt;buffers
op_star
id|GRABBING_MEM_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|saa-&gt;grabbing
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pos
op_assign
(paren
r_int
r_int
)paren
id|saa-&gt;grabbing
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|page
op_assign
id|kvirt_to_pa
c_func
(paren
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma
comma
id|start
comma
id|page
comma
id|PAGE_SIZE
comma
id|PAGE_SHARED
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|start
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|pos
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|size
op_sub_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|SAA7146_DEBI_TRANSFER
suffix:colon
(brace
r_struct
id|saa7146_debi_transfer
op_star
id|dt
op_assign
id|arg
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;saa7146_core.o: SAA7146_DEBI_TRANSFER&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;saa7146_core.o: timeout:%d, swap:%d, slave16:%d, increment:%d, intel:%d, tien:%d&bslash;n&quot;
comma
id|dt-&gt;timeout
comma
id|dt-&gt;swap
comma
id|dt-&gt;slave16
comma
id|dt-&gt;increment
comma
id|dt-&gt;intel
comma
id|dt-&gt;tien
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;saa7146_core.o: address:0x%04x, num_bytes:%d, direction:%d, mem:0x%08x&bslash;n&quot;
comma
id|dt-&gt;address
comma
id|dt-&gt;address
comma
id|dt-&gt;direction
comma
id|dt-&gt;mem
)paren
suffix:semicolon
id|debi_transfer
c_func
(paren
id|saa
comma
id|dt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* -----------------------------------------------------*/
multiline_comment|/* dispatcher-function for handling irq-events&t;&t;*/
multiline_comment|/* -----------------------------------------------------*/
multiline_comment|/* irq-handler function */
DECL|function|saa7146_irq
r_static
r_void
id|saa7146_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
(paren
r_struct
id|saa7146
op_star
)paren
id|dev_id
suffix:semicolon
id|u32
id|isr
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* process all interrupts */
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* read out the primary status register */
id|isr
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|ISR
)paren
suffix:semicolon
multiline_comment|/* clear all IRQs */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|ISR
comma
id|isr
)paren
suffix:semicolon
multiline_comment|/* is anything to do? */
r_if
c_cond
(paren
l_int|0
op_eq
id|isr
)paren
r_return
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;%s: irq-call: isr:0x%08x&bslash;n&quot;
comma
id|saa-&gt;name
comma
id|isr
)paren
suffix:semicolon
multiline_comment|/* first let the extensions handle the interrupt */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SAA7146_MAX_EXTENSIONS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|saa7146_ext
(braket
id|i
)braket
op_logical_and
(paren
id|isr
op_amp
id|saa7146_ext
(braket
id|i
)braket
op_member_access_from_pointer
id|handles_irqs
)paren
)paren
(brace
id|saa7146_ext
(braket
id|i
)braket
op_member_access_from_pointer
id|irq_handler
c_func
(paren
id|saa
comma
id|isr
comma
id|saa-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
singleline_comment|//saa7146_write(saa-&gt;mem, ISR, saa7146_ext[i]-&gt;handles_irqs);
)brace
singleline_comment|//printk(KERN_ERR &quot;%s: unhandled interrupt: 0x%08x&bslash;n&quot;, saa-&gt;name, isr);
multiline_comment|/* see if we are in a hard interrupt loop */
op_increment
id|count
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|10
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;%s: irq loop %d&bslash;n&quot;
comma
id|saa-&gt;name
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|20
)paren
(brace
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|IER
comma
l_int|0x00000000
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: IRQ lockup, cleared int mask&bslash;n&quot;
comma
id|saa-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* -----------------------------------------------------&n;   functions for finding any saa7146s in the system,&n;   inserting/removing module for kernel, etc.&n;   -----------------------------------------------------*/
DECL|function|configure_saa7146
r_int
id|configure_saa7146
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
id|u32
id|rev
op_assign
l_int|0
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|hprintk
c_func
(paren
l_string|&quot;saa7146_core.o: ==&gt; configure_saa7146&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* check module-parameters for sanity */
multiline_comment|/* check if wanted number of video-buffers is valid, otherwise fix it */
singleline_comment|//if (buffers &lt; 2)
singleline_comment|//&t;buffers = 2;
r_if
c_cond
(paren
id|buffers
OG
id|SAA7146_MAX_BUF
)paren
id|buffers
op_assign
id|SAA7146_MAX_BUF
suffix:semicolon
multiline_comment|/* check if mode is supported */
r_switch
c_cond
(paren
id|mode
)paren
(brace
multiline_comment|/* 0 = pal, 1 = ntsc */
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* default to pal */
r_default
suffix:colon
(brace
)brace
(brace
id|mode
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* get chip-revision; this is needed to enable bug-fixes */
r_if
c_cond
(paren
l_int|0
OG
id|pci_read_config_dword
c_func
(paren
id|saa-&gt;device
comma
l_int|0x08
comma
op_amp
id|rev
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: cannot read from pci-device!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|saa-&gt;revision
op_assign
(paren
id|rev
op_amp
l_int|0xf
)paren
suffix:semicolon
multiline_comment|/* remap the memory from virtual to physical adress */
id|saa-&gt;mem
op_assign
id|ioremap
(paren
(paren
id|saa-&gt;device-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
comma
l_int|0x1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;mem
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: cannot map pci-address!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* get clipping memory */
id|saa-&gt;clipping
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
(paren
id|CLIPPING_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;clipping
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: not enough kernel-memory for clipping!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|saa-&gt;clipping
comma
l_int|0x0
comma
id|CLIPPING_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* get i2c memory */
id|saa-&gt;i2c
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
(paren
id|I2C_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/*64*/
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;i2c
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: not enough kernel-memory for i2c!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|saa-&gt;i2c
comma
l_int|0x0
comma
id|I2C_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* get grabbing memory */
id|saa-&gt;grabbing
op_assign
(paren
id|u32
op_star
)paren
id|rvmalloc
(paren
id|buffers
comma
op_amp
id|saa-&gt;page_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;grabbing
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: not enough kernel-memory for grabbing_mem!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* get rps0 memory */
id|saa-&gt;rps0
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
(paren
id|RPS_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;rps0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: not enough kernel-memory for rps0_mem!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
id|rvfree
c_func
(paren
id|saa-&gt;grabbing
comma
id|buffers
comma
op_amp
id|saa-&gt;page_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|saa-&gt;rps0
comma
l_int|0x0
comma
id|RPS_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* get rps1 memory */
id|saa-&gt;rps1
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
(paren
id|RPS_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;rps1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: not enough kernel-memory for rps1_mem!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;rps0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
id|rvfree
c_func
(paren
id|saa-&gt;grabbing
comma
id|buffers
comma
op_amp
id|saa-&gt;page_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|saa-&gt;rps1
comma
l_int|0x0
comma
id|RPS_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* get debi memory (32kB) */
id|saa-&gt;debi
op_assign
(paren
id|u32
op_star
)paren
id|kmalloc
(paren
l_int|8192
op_star
r_sizeof
(paren
id|u32
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|saa-&gt;debi
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: not enough kernel-memory for debi_mem!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;rps1
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;rps0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
id|rvfree
c_func
(paren
id|saa-&gt;grabbing
comma
id|buffers
comma
op_amp
id|saa-&gt;page_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|saa-&gt;debi
comma
l_int|0x0
comma
l_int|8192
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* clear out memory for grabbing information */
id|memset
c_func
(paren
op_amp
id|saa-&gt;grab_width
(braket
l_int|0
)braket
comma
l_int|0x0
comma
r_sizeof
(paren
r_int
)paren
op_star
id|SAA7146_MAX_BUF
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|saa-&gt;grab_height
(braket
l_int|0
)braket
comma
l_int|0x0
comma
r_sizeof
(paren
r_int
)paren
op_star
id|SAA7146_MAX_BUF
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|saa-&gt;grab_format
(braket
l_int|0
)braket
comma
l_int|0x0
comma
r_sizeof
(paren
r_int
)paren
op_star
id|SAA7146_MAX_BUF
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|saa-&gt;grab_port
(braket
l_int|0
)braket
comma
l_int|0x0
comma
r_sizeof
(paren
r_int
)paren
op_star
id|SAA7146_MAX_BUF
)paren
suffix:semicolon
multiline_comment|/* init the frame-status array */
id|memset
c_func
(paren
op_amp
id|saa-&gt;frame_stat
(braket
l_int|0
)braket
comma
id|GBUFFER_UNUSED
comma
r_sizeof
(paren
r_int
)paren
op_star
id|SAA7146_MAX_BUF
)paren
suffix:semicolon
multiline_comment|/* clear out all wait queues */
id|init_waitqueue_head
c_func
(paren
op_amp
id|saa-&gt;rps0_wq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|saa-&gt;rps1_wq
)paren
suffix:semicolon
multiline_comment|/* request an interrupt for the saa7146 */
id|result
op_assign
id|request_irq
(paren
id|saa-&gt;device-&gt;irq
comma
id|saa7146_irq
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
id|saa-&gt;name
comma
(paren
r_void
op_star
)paren
id|saa
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|result
)paren
(brace
r_case
op_minus
id|EINVAL
suffix:colon
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: Bad irq number or handler&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
op_minus
id|EBUSY
suffix:colon
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: IRQ %d busy, change your PnP config in BIOS&bslash;n&quot;
comma
id|saa-&gt;device-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_case
l_int|0
suffix:colon
(brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
r_return
id|result
suffix:semicolon
)brace
)brace
multiline_comment|/* print status message */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;saa7146_core.o: %s: bus:%d, rev:%d, mem:0x%08x.&bslash;n&quot;
comma
id|saa-&gt;name
comma
id|saa-&gt;device-&gt;bus-&gt;number
comma
id|saa-&gt;revision
comma
(paren
r_int
r_int
)paren
id|saa-&gt;mem
)paren
suffix:semicolon
multiline_comment|/* enable bus-mastering */
id|pci_set_master
c_func
(paren
id|saa-&gt;device
)paren
suffix:semicolon
multiline_comment|/* disable everything on the saa7146, perform a software-reset */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
l_int|0xbfff0000
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
macro_line|#if 0
(brace
r_int
id|j
suffix:semicolon
multiline_comment|/* clear all registers */
r_for
c_loop
(paren
id|j
op_assign
l_int|0x0
suffix:semicolon
id|j
OL
l_int|0xfc
suffix:semicolon
id|j
op_add_assign
l_int|0x4
)paren
(brace
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|j
comma
l_int|0x0000000
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0x104
suffix:semicolon
id|j
OL
l_int|0x1fc
suffix:semicolon
id|j
op_add_assign
l_int|0x4
)paren
(brace
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|j
comma
l_int|0x0000000
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif 
multiline_comment|/* clear out any rps-signals pending */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
l_int|0xf8000000
)paren
suffix:semicolon
multiline_comment|/* enable video-port-pins*/
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
(paren
id|MASK_10
op_or
id|MASK_26
)paren
)paren
suffix:semicolon
multiline_comment|/* disable all interrupt-conditions, only enable RPS interrupts */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|ISR
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|IER
comma
(paren
id|MASK_27
op_or
id|MASK_28
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;printk(&quot;main: 0x114: 0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, 0x114));&n;&t;printk(&quot;main: 0x0e4: 0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, 0x0e4));&n;&t;printk(&quot;PSR:   0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, PSR));&n;&t;printk(&quot;SSR:   0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, SSR));&n;&t;printk(&quot;IER:   0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, IER));&n;&t;printk(&quot;ISR:   0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, ISR));&n;*/
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|PCI_BT_V1
comma
l_int|0x1c00101f
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|BCS_CTRL
comma
l_int|0x80400040
)paren
suffix:semicolon
multiline_comment|/* set dd1 stream a &amp; b */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|DD1_STREAM_B
comma
l_int|0x00000000
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|DD1_INIT
comma
l_int|0x02000000
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_09
op_or
id|MASK_25
op_or
id|MASK_10
op_or
id|MASK_26
)paren
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
l_int|0x077c077c
)paren
suffix:semicolon
multiline_comment|/* the Siemens DVB needs this if you want to have the i2c chips&n;           get recognized before the main driver is loaded &n;&t;*/
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|GPIO_CTRL
comma
l_int|0x500000
)paren
suffix:semicolon
id|saa-&gt;command
op_assign
op_amp
id|saa7146_core_command
suffix:semicolon
id|saa-&gt;buffers
op_assign
id|buffers
suffix:semicolon
id|saa-&gt;mode
op_assign
id|mode
suffix:semicolon
id|saa-&gt;interlace
op_assign
l_int|1
suffix:semicolon
id|i2c_saa7146_add_bus
(paren
id|saa
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|GPIO_CTRL
comma
l_int|0x000000
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa7146_foreach
r_void
id|saa7146_foreach
(paren
r_void
(paren
op_star
id|callback
)paren
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_void
op_star
id|data
)paren
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|list_head
op_star
id|entry
suffix:semicolon
id|list_for_each
(paren
id|entry
comma
op_amp
id|saa7146_list
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
suffix:semicolon
id|saa
op_assign
id|list_entry
(paren
id|entry
comma
r_struct
id|saa7146
comma
id|list_head
)paren
suffix:semicolon
id|callback
(paren
id|saa
comma
id|data
)paren
suffix:semicolon
)brace
)brace
r_static
DECL|function|saa7146_attach_extension
r_void
id|saa7146_attach_extension
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|ext_id
op_assign
(paren
r_int
)paren
id|data
suffix:semicolon
id|saa7146_ext
(braket
id|ext_id
)braket
op_member_access_from_pointer
id|attach
(paren
id|saa
comma
op_amp
id|saa-&gt;data
(braket
id|ext_id
)braket
)paren
suffix:semicolon
)brace
r_static
DECL|function|saa7146_detach_extension
r_void
id|saa7146_detach_extension
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|ext_id
op_assign
(paren
r_int
)paren
id|data
suffix:semicolon
id|saa7146_ext
(braket
id|ext_id
)braket
op_member_access_from_pointer
id|detach
(paren
id|saa
comma
op_amp
id|saa-&gt;data
(braket
id|ext_id
)braket
)paren
suffix:semicolon
)brace
DECL|function|saa7146_add_extension
r_int
id|saa7146_add_extension
c_func
(paren
r_struct
id|saa7146_extension
op_star
id|ext
)paren
(brace
r_int
id|ext_id
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ext_id
op_assign
l_int|0
suffix:semicolon
id|ext_id
OL
id|SAA7146_MAX_EXTENSIONS
suffix:semicolon
id|ext_id
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|saa7146_ext
(braket
id|ext_id
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|SAA7146_MAX_EXTENSIONS
op_eq
id|ext_id
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;saa7146.o: attach_extension(%s) - &quot;
l_string|&quot;enlarge SAA7146_MAX_EXTENSIONS.&bslash;n&quot;
comma
id|ext-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|saa7146_ext
(braket
id|ext_id
)braket
op_assign
id|ext
suffix:semicolon
id|saa7146_extension_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ext-&gt;attach
)paren
id|saa7146_foreach
(paren
id|saa7146_attach_extension
comma
(paren
r_void
op_star
)paren
id|ext_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa7146_del_extension
r_int
id|saa7146_del_extension
c_func
(paren
r_struct
id|saa7146_extension
op_star
id|ext
)paren
(brace
r_int
id|ext_id
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ext_id
op_assign
l_int|0
suffix:semicolon
id|ext_id
OL
id|SAA7146_MAX_EXTENSIONS
suffix:semicolon
id|ext_id
op_increment
)paren
r_if
c_cond
(paren
id|ext
op_eq
id|saa7146_ext
(braket
id|ext_id
)braket
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|SAA7146_MAX_EXTENSIONS
op_eq
id|ext_id
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: detach_extension extension [%s] not found.&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ext-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ext-&gt;detach
)paren
id|saa7146_foreach
(paren
id|saa7146_detach_extension
comma
(paren
r_void
op_star
)paren
id|ext_id
)paren
suffix:semicolon
id|saa7146_ext
(braket
id|ext_id
)braket
op_assign
l_int|NULL
suffix:semicolon
id|saa7146_extension_count
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
DECL|function|remove_saa7146
r_void
id|remove_saa7146
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
id|i2c_saa7146_del_bus
(paren
id|saa
)paren
suffix:semicolon
multiline_comment|/* shut down all dma transfers */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
l_int|0xbfff0000
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;free irqs&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* disable alle irqs, release irq-routine */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|IER
comma
l_int|0x00
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|ISR
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|saa-&gt;device-&gt;irq
comma
(paren
r_void
op_star
)paren
id|saa
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;unmap memory&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* unmap the memory, if necessary */
r_if
c_cond
(paren
id|saa-&gt;mem
)paren
id|iounmap
c_func
(paren
(paren
r_int
r_char
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|saa-&gt;mem
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;release grabbing memory&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* release grabbing memory */
r_if
c_cond
(paren
id|saa-&gt;grabbing
)paren
(brace
id|rvfree
c_func
(paren
id|saa-&gt;grabbing
comma
id|buffers
comma
op_amp
id|saa-&gt;page_table
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;release other memory&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* release clipping, i2c, rps0 memory */
id|kfree
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;i2c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;rps0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;rps1
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|saa-&gt;debi
)paren
suffix:semicolon
)brace
DECL|function|saa7146_suspend
r_static
r_int
id|saa7146_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146_suspend()&bslash;n&quot;
)paren
suffix:semicolon
id|saa7146_core_command
c_func
(paren
(paren
(paren
r_struct
id|saa7146
op_star
)paren
id|pdev-&gt;driver_data
)paren
op_member_access_from_pointer
id|i2c_bus
comma
id|SAA7146_SUSPEND
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|saa7146_resume
id|saa7146_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146_resume()&bslash;n&quot;
)paren
suffix:semicolon
id|saa7146_core_command
c_func
(paren
(paren
(paren
r_struct
id|saa7146
op_star
)paren
id|pdev-&gt;driver_data
)paren
op_member_access_from_pointer
id|i2c_bus
comma
id|SAA7146_RESUME
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|struct|card_info
r_struct
id|card_info
(brace
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
)brace
suffix:semicolon
r_static
DECL|function|saa7146_init_one
r_int
id|__devinit
id|saa7146_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|dvb_adapter_s
op_star
id|adap
suffix:semicolon
r_struct
id|saa7146
op_star
id|saa
suffix:semicolon
r_int
id|card_type
suffix:semicolon
r_struct
id|card_info
op_star
id|cinfo
op_assign
(paren
r_struct
id|card_info
op_star
)paren
id|ent-&gt;driver_data
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saa7146_init_one()&bslash;n&quot;
)paren
suffix:semicolon
id|card_type
op_assign
id|cinfo-&gt;type
suffix:semicolon
id|dvb_register_adapter
c_func
(paren
op_amp
id|adap
comma
id|cinfo-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|saa
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|saa7146
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;%s: out of memory!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|saa
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|saa7146
)paren
)paren
suffix:semicolon
id|saa-&gt;device
op_assign
id|pdev
suffix:semicolon
id|saa-&gt;device-&gt;driver_data
op_assign
id|saa
suffix:semicolon
id|saa-&gt;card_type
op_assign
id|card_type
suffix:semicolon
id|saa-&gt;dvb_adapter
op_assign
id|adap
suffix:semicolon
id|pci_enable_device
(paren
id|saa-&gt;device
)paren
suffix:semicolon
id|configure_saa7146
(paren
id|saa
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|saa-&gt;list_head
comma
op_amp
id|saa7146_list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
DECL|function|saa7146_remove_one
r_void
id|__devexit
id|saa7146_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|saa7146
op_star
id|saa
op_assign
id|pdev-&gt;driver_data
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saa7146_remove_one()&bslash;n&quot;
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|saa-&gt;list_head
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|remove_saa7146
(paren
id|saa
)paren
suffix:semicolon
)brace
DECL|variable|fs_1_5
r_static
r_struct
id|card_info
id|fs_1_5
op_assign
(brace
id|DVB_CARD_TT_SIEMENS
comma
l_string|&quot;Siemens cable card PCI rev1.5&quot;
)brace
suffix:semicolon
DECL|variable|fs_1_3
r_static
r_struct
id|card_info
id|fs_1_3
op_assign
(brace
id|DVB_CARD_TT_SIEMENS
comma
l_string|&quot;Siemens/Technotrend/Hauppauge PCI rev1.3&quot;
)brace
suffix:semicolon
DECL|variable|ttbs
r_static
r_struct
id|card_info
id|ttbs
op_assign
(brace
id|DVB_CARD_TT_BUDGET
comma
l_string|&quot;TT-Budget/WinTV-NOVA-S  PCI&quot;
)brace
suffix:semicolon
DECL|variable|ttbc
r_static
r_struct
id|card_info
id|ttbc
op_assign
(brace
id|DVB_CARD_TT_BUDGET
comma
l_string|&quot;TT-Budget/WinTV-NOVA-C  PCI&quot;
)brace
suffix:semicolon
DECL|variable|ttbt
r_static
r_struct
id|card_info
id|ttbt
op_assign
(brace
id|DVB_CARD_TT_BUDGET
comma
l_string|&quot;TT-Budget/WinTV-NOVA-T  PCI&quot;
)brace
suffix:semicolon
DECL|variable|ttbci
r_static
r_struct
id|card_info
id|ttbci
op_assign
(brace
id|DVB_CARD_TT_BUDGET_CI
comma
l_string|&quot;TT-Budget/WinTV-NOVA-CI PCI&quot;
)brace
suffix:semicolon
DECL|variable|satel
r_static
r_struct
id|card_info
id|satel
op_assign
(brace
id|DVB_CARD_TT_BUDGET
comma
l_string|&quot;SATELCO Multimedia PCI&quot;
)brace
suffix:semicolon
DECL|variable|unkwn
r_static
r_struct
id|card_info
id|unkwn
op_assign
(brace
id|DVB_CARD_TT_SIEMENS
comma
l_string|&quot;Technotrend/Hauppauge PCI rev?(unknown0)?&quot;
)brace
suffix:semicolon
DECL|variable|tt_1_6
r_static
r_struct
id|card_info
id|tt_1_6
op_assign
(brace
id|DVB_CARD_TT_SIEMENS
comma
l_string|&quot;Technotrend/Hauppauge PCI rev1.3 or 1.6&quot;
)brace
suffix:semicolon
DECL|variable|tt_2_1
r_static
r_struct
id|card_info
id|tt_2_1
op_assign
(brace
id|DVB_CARD_TT_SIEMENS
comma
l_string|&quot;Technotrend/Hauppauge PCI rev2.1&quot;
)brace
suffix:semicolon
DECL|variable|tt_t
r_static
r_struct
id|card_info
id|tt_t
op_assign
(brace
id|DVB_CARD_TT_SIEMENS
comma
l_string|&quot;Technotrend/Hauppauge PCI DVB-T&quot;
)brace
suffix:semicolon
DECL|variable|knc1
r_static
r_struct
id|card_info
id|knc1
op_assign
(brace
id|DVB_CARD_KNC1
comma
l_string|&quot;KNC1 DVB-S&quot;
)brace
suffix:semicolon
DECL|macro|PHILIPS_SAA7146
mdefine_line|#define PHILIPS_SAA7146 PCI_VENDOR_ID_PHILIPS, PCI_DEVICE_ID_PHILIPS_SAA7146
DECL|macro|CARD_INFO
mdefine_line|#define CARD_INFO driver_data: (unsigned long) &amp;
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|saa7146_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PHILIPS_SAA7146
comma
l_int|0x110a
comma
l_int|0xffff
comma
id|CARD_INFO
id|fs_1_5
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x110a
comma
l_int|0x0000
comma
id|CARD_INFO
id|fs_1_5
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x1003
comma
id|CARD_INFO
id|ttbs
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x1004
comma
id|CARD_INFO
id|ttbc
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x1005
comma
id|CARD_INFO
id|ttbt
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x100c
comma
id|CARD_INFO
id|ttbci
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x1013
comma
id|CARD_INFO
id|satel
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x0000
comma
id|CARD_INFO
id|fs_1_3
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x1002
comma
id|CARD_INFO
id|unkwn
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x0001
comma
id|CARD_INFO
id|tt_1_6
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x0002
comma
id|CARD_INFO
id|tt_2_1
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x0003
comma
id|CARD_INFO
id|tt_2_1
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x0004
comma
id|CARD_INFO
id|tt_2_1
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x0006
comma
id|CARD_INFO
id|tt_1_6
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x13c2
comma
l_int|0x0008
comma
id|CARD_INFO
id|tt_t
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0xffc2
comma
l_int|0x0000
comma
id|CARD_INFO
id|unkwn
)brace
comma
(brace
id|PHILIPS_SAA7146
comma
l_int|0x1131
comma
l_int|0x4f56
comma
id|CARD_INFO
id|knc1
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|saa7146_pci_tbl
)paren
suffix:semicolon
DECL|variable|saa7146_driver
r_static
r_struct
id|pci_driver
id|saa7146_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;saa7146&quot;
comma
id|id_table
suffix:colon
id|saa7146_pci_tbl
comma
id|probe
suffix:colon
id|saa7146_init_one
comma
id|remove
suffix:colon
id|saa7146_remove_one
comma
id|suspend
suffix:colon
id|saa7146_suspend
comma
id|resume
suffix:colon
id|saa7146_resume
comma
)brace
suffix:semicolon
r_static
DECL|function|saa7146_init_module
r_int
id|__init
id|saa7146_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saa7146_init_module&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|saa7146_driver
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|saa7146_v4l_init
(paren
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|av7110_init
(paren
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|av7110_ir_init
(paren
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
DECL|function|saa7146_cleanup_module
r_void
id|__exit
id|saa7146_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|av7110_ir_exit
(paren
)paren
suffix:semicolon
id|av7110_exit
(paren
)paren
suffix:semicolon
id|saa7146_v4l_exit
(paren
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|saa7146_driver
)paren
suffix:semicolon
)brace
DECL|variable|saa7146_init_module
id|module_init
c_func
(paren
id|saa7146_init_module
)paren
suffix:semicolon
DECL|variable|saa7146_cleanup_module
id|module_exit
c_func
(paren
id|saa7146_cleanup_module
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Michael Hunold &lt;michael@mihu.de&gt;, &quot;
l_string|&quot;Christian Theiss &lt;mistert@rz.fh-augsburg.de&gt;, &quot;
l_string|&quot;Ralph Metzler &lt;rjkm@convergence.de&gt;, &quot;
l_string|&quot;Marcus Metzler &lt;mocm@convergence.de&gt;, &quot;
l_string|&quot;Holger Waechtler &lt;holger@convergence.de&gt; and others&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;driver for saa7146/av7110 based DVB PCI cards&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|saa7146_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|buffers
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
eof
