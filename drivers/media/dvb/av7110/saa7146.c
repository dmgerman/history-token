multiline_comment|/*&n;    the api- and os-independet parts of the saa7146 device driver&n;    &n;    Copyright (C) 1998,1999 Michael Hunold &lt;michael@mihu.de&gt;&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &quot;saa7146_defs.h&quot;
DECL|macro|TRUNC
mdefine_line|#define TRUNC(val,max) ((val) &lt; (max) ? (val) : (max))
macro_line|#ifdef __COMPILE_SAA7146__
r_struct
id|saa7146_modes_constants
DECL|variable|modes_constants
id|modes_constants
(braket
)braket
op_assign
(brace
(brace
id|V_OFFSET_PAL
comma
id|V_FIELD_PAL
comma
id|V_ACTIVE_LINES_PAL
comma
id|H_OFFSET_PAL
comma
id|H_PIXELS_PAL
comma
id|H_PIXELS_PAL
op_plus
l_int|1
comma
id|V_ACTIVE_LINES_PAL
comma
l_int|1024
)brace
comma
multiline_comment|/* PAL values */
(brace
id|V_OFFSET_NTSC
comma
id|V_FIELD_NTSC
comma
id|V_ACTIVE_LINES_NTSC
comma
id|H_OFFSET_NTSC
comma
id|H_PIXELS_NTSC
comma
id|H_PIXELS_NTSC
op_plus
l_int|1
comma
id|V_ACTIVE_LINES_NTSC
comma
l_int|1024
)brace
comma
multiline_comment|/* NTSC values */
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* secam values */
(brace
l_int|0
comma
l_int|288
comma
l_int|576
comma
l_int|0
comma
l_int|188
op_star
l_int|4
comma
l_int|188
op_star
l_int|4
op_plus
l_int|1
comma
l_int|288
comma
l_int|188
op_star
l_int|4
)brace
multiline_comment|/* TS values */
)brace
suffix:semicolon
multiline_comment|/* -----------------------------------------------------------------------------------------&n;   helper functions for the calculation of the horizontal- and vertical scaling&t;registers,&n;   clip-format-register etc ...&n;   these functions take pointers to the (most-likely read-out original-values) and manipulate&n;   them according to the requested new scaling parameters.&n;   ----------------------------------------------------------------------------------------- */
multiline_comment|/* hps_coeff used for CXY and CXUV; scale 1/1 -&gt; scale 1/64 */
r_struct
(brace
DECL|member|hps_coeff
id|u16
id|hps_coeff
suffix:semicolon
DECL|member|weight_sum
id|u16
id|weight_sum
suffix:semicolon
DECL|variable|hps_h_coeff_tab
)brace
id|hps_h_coeff_tab
(braket
)braket
op_assign
(brace
(brace
l_int|0x00
comma
l_int|2
)brace
comma
(brace
l_int|0x02
comma
l_int|4
)brace
comma
(brace
l_int|0x00
comma
l_int|4
)brace
comma
(brace
l_int|0x06
comma
l_int|8
)brace
comma
(brace
l_int|0x02
comma
l_int|8
)brace
comma
(brace
l_int|0x08
comma
l_int|8
)brace
comma
(brace
l_int|0x00
comma
l_int|8
)brace
comma
(brace
l_int|0x1E
comma
l_int|16
)brace
comma
(brace
l_int|0x0E
comma
l_int|8
)brace
comma
(brace
l_int|0x26
comma
l_int|8
)brace
comma
(brace
l_int|0x06
comma
l_int|8
)brace
comma
(brace
l_int|0x42
comma
l_int|8
)brace
comma
(brace
l_int|0x02
comma
l_int|8
)brace
comma
(brace
l_int|0x80
comma
l_int|8
)brace
comma
(brace
l_int|0x00
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|16
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0x7E
comma
l_int|8
)brace
comma
(brace
l_int|0x7E
comma
l_int|8
)brace
comma
(brace
l_int|0x3E
comma
l_int|8
)brace
comma
(brace
l_int|0x3E
comma
l_int|8
)brace
comma
(brace
l_int|0x1E
comma
l_int|8
)brace
comma
(brace
l_int|0x1E
comma
l_int|8
)brace
comma
(brace
l_int|0x0E
comma
l_int|8
)brace
comma
(brace
l_int|0x0E
comma
l_int|8
)brace
comma
(brace
l_int|0x06
comma
l_int|8
)brace
comma
(brace
l_int|0x06
comma
l_int|8
)brace
comma
(brace
l_int|0x02
comma
l_int|8
)brace
comma
(brace
l_int|0x02
comma
l_int|8
)brace
comma
(brace
l_int|0x00
comma
l_int|8
)brace
comma
(brace
l_int|0x00
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|16
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|8
)brace
comma
(brace
l_int|0x7E
comma
l_int|8
)brace
comma
(brace
l_int|0x7E
comma
l_int|8
)brace
comma
(brace
l_int|0x3E
comma
l_int|8
)brace
comma
(brace
l_int|0x3E
comma
l_int|8
)brace
comma
(brace
l_int|0x1E
comma
l_int|8
)brace
comma
(brace
l_int|0x1E
comma
l_int|8
)brace
comma
(brace
l_int|0x0E
comma
l_int|8
)brace
comma
(brace
l_int|0x0E
comma
l_int|8
)brace
comma
(brace
l_int|0x06
comma
l_int|8
)brace
comma
(brace
l_int|0x06
comma
l_int|8
)brace
comma
(brace
l_int|0x02
comma
l_int|8
)brace
comma
(brace
l_int|0x02
comma
l_int|8
)brace
comma
(brace
l_int|0x00
comma
l_int|8
)brace
comma
(brace
l_int|0x00
comma
l_int|8
)brace
comma
(brace
l_int|0xFE
comma
l_int|16
)brace
)brace
suffix:semicolon
multiline_comment|/* table of attenuation values for horizontal scaling */
DECL|variable|h_attenuation
id|u8
id|h_attenuation
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|4
comma
l_int|8
comma
l_int|2
comma
l_int|4
comma
l_int|8
comma
l_int|16
comma
l_int|0
)brace
suffix:semicolon
DECL|function|calculate_h_scale_registers
r_int
id|calculate_h_scale_registers
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|in_x
comma
id|u32
id|out_x
comma
r_int
id|flip_lr
comma
id|u32
op_star
id|hps_ctrl
comma
id|u32
op_star
id|hps_v_gain
comma
id|u32
op_star
id|hps_h_prescale
comma
id|u32
op_star
id|hps_h_scale
)paren
(brace
multiline_comment|/* horizontal prescaler */
id|u32
id|dcgx
op_assign
l_int|0
comma
id|xpsc
op_assign
l_int|0
comma
id|xacm
op_assign
l_int|0
comma
id|cxy
op_assign
l_int|0
comma
id|cxuv
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* horizontal scaler */
id|u32
id|xim
op_assign
l_int|0
comma
id|xp
op_assign
l_int|0
comma
id|xsci
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* vertical scale &amp; gain */
id|u32
id|pfuv
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* helper variables */
id|u32
id|h_atten
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|out_x
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; calculate_h_scale_registers: invalid value (=0).&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* mask out vanity-bit */
op_star
id|hps_ctrl
op_and_assign
op_complement
id|MASK_29
suffix:semicolon
multiline_comment|/* calculate prescale-(xspc)-value:&t;[n   .. 1/2) : 1&n;&t;&t;&t;&t;    &t;&t;[1/2 .. 1/3) : 2&n;&t;&t;&t;&t;    &t;&t;[1/3 .. 1/4) : 3&n;&t;&t;&t;&t;&t;&t;... &t;&t;&t;*/
r_if
c_cond
(paren
id|in_x
OG
id|out_x
)paren
(brace
id|xpsc
op_assign
id|in_x
op_div
id|out_x
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* zooming */
id|xpsc
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* if flip_lr-bit is set, number of pixels after horizontal prescaling must be &lt; 384 */
r_if
c_cond
(paren
l_int|0
op_ne
id|flip_lr
)paren
(brace
multiline_comment|/* set vanity bit */
op_star
id|hps_ctrl
op_or_assign
id|MASK_29
suffix:semicolon
r_while
c_loop
(paren
id|in_x
op_div
id|xpsc
op_ge
l_int|384
)paren
id|xpsc
op_increment
suffix:semicolon
)brace
multiline_comment|/* if zooming is wanted, number of pixels after horizontal prescaling must be &lt; 768 */
r_else
(brace
r_while
c_loop
(paren
id|in_x
op_div
id|xpsc
op_ge
l_int|768
)paren
id|xpsc
op_increment
suffix:semicolon
)brace
multiline_comment|/* maximum prescale is 64 (p.69) */
r_if
c_cond
(paren
id|xpsc
OG
l_int|64
)paren
id|xpsc
op_assign
l_int|64
suffix:semicolon
multiline_comment|/* keep xacm clear*/
id|xacm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set horizontal filter parameters (CXY = CXUV) */
id|cxy
op_assign
id|hps_h_coeff_tab
(braket
id|TRUNC
c_func
(paren
id|xpsc
op_minus
l_int|1
comma
l_int|63
)paren
)braket
dot
id|hps_coeff
suffix:semicolon
id|cxuv
op_assign
id|cxy
suffix:semicolon
multiline_comment|/* calculate and set horizontal fine scale (xsci) */
multiline_comment|/* bypass the horizontal scaler ? */
r_if
c_cond
(paren
(paren
id|in_x
op_eq
id|out_x
)paren
op_logical_and
(paren
l_int|1
op_eq
id|xpsc
)paren
)paren
id|xsci
op_assign
l_int|0x400
suffix:semicolon
r_else
id|xsci
op_assign
(paren
(paren
l_int|1024
op_star
id|in_x
)paren
op_div
(paren
id|out_x
op_star
id|xpsc
)paren
)paren
op_plus
id|xpsc
suffix:semicolon
multiline_comment|/* set start phase for horizontal fine scale (xp) to 0 */
id|xp
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set xim, if we bypass the horizontal scaler */
r_if
c_cond
(paren
l_int|0x400
op_eq
id|xsci
)paren
id|xim
op_assign
l_int|1
suffix:semicolon
r_else
id|xim
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if the prescaler is bypassed, enable horizontal accumulation mode (xacm)&n;&t;   and clear dcgx */
r_if
c_cond
(paren
l_int|1
op_eq
id|xpsc
)paren
(brace
id|xacm
op_assign
l_int|1
suffix:semicolon
id|dcgx
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|xacm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* get best match in the table of attenuations for horizontal scaling */
id|h_atten
op_assign
id|hps_h_coeff_tab
(braket
id|TRUNC
c_func
(paren
id|xpsc
op_minus
l_int|1
comma
l_int|63
)paren
)braket
dot
id|weight_sum
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|h_attenuation
(braket
id|i
)braket
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|h_attenuation
(braket
id|i
)braket
op_ge
id|h_atten
)paren
r_break
suffix:semicolon
)brace
id|dcgx
op_assign
id|i
suffix:semicolon
)brace
multiline_comment|/* the horizontal scaling increment controls the UV filter to reduce the bandwith to&n;&t;   improve the display quality, so set it ... */
r_if
c_cond
(paren
id|xsci
op_eq
l_int|0x400
)paren
id|pfuv
op_assign
l_int|0x00
suffix:semicolon
r_else
r_if
c_cond
(paren
id|xsci
OL
l_int|0x600
)paren
id|pfuv
op_assign
l_int|0x01
suffix:semicolon
r_else
r_if
c_cond
(paren
id|xsci
OL
l_int|0x680
)paren
id|pfuv
op_assign
l_int|0x11
suffix:semicolon
r_else
r_if
c_cond
(paren
id|xsci
OL
l_int|0x700
)paren
id|pfuv
op_assign
l_int|0x22
suffix:semicolon
r_else
id|pfuv
op_assign
l_int|0x33
suffix:semicolon
op_star
id|hps_v_gain
op_and_assign
id|MASK_W0
op_or
id|MASK_B2
suffix:semicolon
op_star
id|hps_v_gain
op_or_assign
(paren
id|pfuv
op_lshift
l_int|24
)paren
suffix:semicolon
op_star
id|hps_h_scale
op_and_assign
op_complement
(paren
id|MASK_W1
op_or
l_int|0xf000
)paren
suffix:semicolon
op_star
id|hps_h_scale
op_or_assign
(paren
id|xim
op_lshift
l_int|31
)paren
op_or
(paren
id|xp
op_lshift
l_int|24
)paren
op_or
(paren
id|xsci
op_lshift
l_int|12
)paren
suffix:semicolon
op_star
id|hps_h_prescale
op_or_assign
(paren
id|dcgx
op_lshift
l_int|27
)paren
op_or
(paren
(paren
id|xpsc
op_minus
l_int|1
)paren
op_lshift
l_int|18
)paren
op_or
(paren
id|xacm
op_lshift
l_int|17
)paren
op_or
(paren
id|cxy
op_lshift
l_int|8
)paren
op_or
(paren
id|cxuv
op_lshift
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_struct
(brace
DECL|member|hps_coeff
id|u16
id|hps_coeff
suffix:semicolon
DECL|member|weight_sum
id|u16
id|weight_sum
suffix:semicolon
DECL|variable|hps_v_coeff_tab
)brace
id|hps_v_coeff_tab
(braket
)braket
op_assign
(brace
(brace
l_int|0x0100
comma
l_int|2
)brace
comma
(brace
l_int|0x0102
comma
l_int|4
)brace
comma
(brace
l_int|0x0300
comma
l_int|4
)brace
comma
(brace
l_int|0x0106
comma
l_int|8
)brace
comma
(brace
l_int|0x0502
comma
l_int|8
)brace
comma
(brace
l_int|0x0708
comma
l_int|8
)brace
comma
(brace
l_int|0x0F00
comma
l_int|8
)brace
comma
(brace
l_int|0x011E
comma
l_int|16
)brace
comma
(brace
l_int|0x110E
comma
l_int|16
)brace
comma
(brace
l_int|0x1926
comma
l_int|16
)brace
comma
(brace
l_int|0x3906
comma
l_int|16
)brace
comma
(brace
l_int|0x3D42
comma
l_int|16
)brace
comma
(brace
l_int|0x7D02
comma
l_int|16
)brace
comma
(brace
l_int|0x7F80
comma
l_int|16
)brace
comma
(brace
l_int|0xFF00
comma
l_int|16
)brace
comma
(brace
l_int|0x01FE
comma
l_int|32
)brace
comma
(brace
l_int|0x01FE
comma
l_int|32
)brace
comma
(brace
l_int|0x817E
comma
l_int|32
)brace
comma
(brace
l_int|0x817E
comma
l_int|32
)brace
comma
(brace
l_int|0xC13E
comma
l_int|32
)brace
comma
(brace
l_int|0xC13E
comma
l_int|32
)brace
comma
(brace
l_int|0xE11E
comma
l_int|32
)brace
comma
(brace
l_int|0xE11E
comma
l_int|32
)brace
comma
(brace
l_int|0xF10E
comma
l_int|32
)brace
comma
(brace
l_int|0xF10E
comma
l_int|32
)brace
comma
(brace
l_int|0xF906
comma
l_int|32
)brace
comma
(brace
l_int|0xF906
comma
l_int|32
)brace
comma
(brace
l_int|0xFD02
comma
l_int|32
)brace
comma
(brace
l_int|0xFD02
comma
l_int|32
)brace
comma
(brace
l_int|0xFF00
comma
l_int|32
)brace
comma
(brace
l_int|0xFF00
comma
l_int|32
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|64
)brace
comma
(brace
l_int|0x817E
comma
l_int|64
)brace
comma
(brace
l_int|0x817E
comma
l_int|64
)brace
comma
(brace
l_int|0xC13E
comma
l_int|64
)brace
comma
(brace
l_int|0xC13E
comma
l_int|64
)brace
comma
(brace
l_int|0xE11E
comma
l_int|64
)brace
comma
(brace
l_int|0xE11E
comma
l_int|64
)brace
comma
(brace
l_int|0xF10E
comma
l_int|64
)brace
comma
(brace
l_int|0xF10E
comma
l_int|64
)brace
comma
(brace
l_int|0xF906
comma
l_int|64
)brace
comma
(brace
l_int|0xF906
comma
l_int|64
)brace
comma
(brace
l_int|0xFD02
comma
l_int|64
)brace
comma
(brace
l_int|0xFD02
comma
l_int|64
)brace
comma
(brace
l_int|0xFF00
comma
l_int|64
)brace
comma
(brace
l_int|0xFF00
comma
l_int|64
)brace
comma
(brace
l_int|0x01FE
comma
l_int|128
)brace
)brace
suffix:semicolon
multiline_comment|/* table of attenuation values for vertical scaling */
DECL|variable|v_attenuation
id|u16
id|v_attenuation
(braket
)braket
op_assign
(brace
l_int|2
comma
l_int|4
comma
l_int|8
comma
l_int|16
comma
l_int|32
comma
l_int|64
comma
l_int|128
comma
l_int|256
comma
l_int|0
)brace
suffix:semicolon
DECL|function|calculate_v_scale_registers
r_int
id|calculate_v_scale_registers
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|in_y
comma
id|u32
id|out_y
comma
id|u32
op_star
id|hps_v_scale
comma
id|u32
op_star
id|hps_v_gain
)paren
(brace
id|u32
id|yacm
op_assign
l_int|0
comma
id|ysci
op_assign
l_int|0
comma
id|yacl
op_assign
l_int|0
comma
id|ypo
op_assign
l_int|0
comma
id|ype
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* vertical scaling */
id|u32
id|dcgy
op_assign
l_int|0
comma
id|cya_cyb
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* vertical scale &amp; gain */
id|u32
id|v_atten
op_assign
l_int|0
comma
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* helper variables */
multiline_comment|/* error, if vertical zooming */
r_if
c_cond
(paren
id|in_y
OL
id|out_y
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; calculate_v_scale_registers: we cannot do vertical zooming.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* linear phase interpolation may be used if scaling is between 1 and 1/2&n;&t;   or scaling is between 1/2 and 1/4 (if interlace is set; see below) */
r_if
c_cond
(paren
(paren
(paren
l_int|2
op_star
id|out_y
)paren
op_ge
id|in_y
)paren
op_logical_or
(paren
(paren
(paren
l_int|4
op_star
id|out_y
)paren
op_ge
id|in_y
)paren
op_logical_and
id|saa-&gt;interlace
op_ne
l_int|0
)paren
)paren
(brace
multiline_comment|/* convention: if scaling is between 1/2 and 1/4 we only use&n;&t;&t;   the even lines, the odd lines get discarded (see function move_to)&n;&t;&t;   if interlace is set */
r_if
c_cond
(paren
id|saa-&gt;interlace
op_ne
l_int|0
op_logical_and
(paren
id|out_y
op_star
l_int|4
)paren
op_ge
id|in_y
op_logical_and
(paren
id|out_y
op_star
l_int|2
)paren
op_le
id|in_y
)paren
(brace
id|out_y
op_mul_assign
l_int|2
suffix:semicolon
)brace
id|yacm
op_assign
l_int|0
suffix:semicolon
id|yacl
op_assign
l_int|0
suffix:semicolon
id|cya_cyb
op_assign
l_int|0x00ff
suffix:semicolon
multiline_comment|/* calculate scaling increment */
r_if
c_cond
(paren
id|in_y
OG
id|out_y
)paren
id|ysci
op_assign
(paren
(paren
l_int|1024
op_star
id|in_y
)paren
op_div
(paren
id|out_y
op_plus
l_int|1
)paren
)paren
op_minus
l_int|1024
suffix:semicolon
r_else
id|ysci
op_assign
l_int|0
suffix:semicolon
id|dcgy
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* calculate ype and ypo */
r_if
c_cond
(paren
id|saa-&gt;interlace
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Special case for interlaced input */
multiline_comment|/* See Philips SAA7146A Product Spec (page 75):       */
multiline_comment|/* &quot;For interlaced input, ype and ypo is defiend as   */
multiline_comment|/* YPeven= 3/2 x YPodd (line 1 = odd)&quot;                */
multiline_comment|/*                                                    */
multiline_comment|/* It looks like the spec is wrong!                   */
multiline_comment|/* The  ad hoc values below works fine for a target   */
multiline_comment|/* window height of 480 (vertical scale = 1/1) NTSC.  */
multiline_comment|/* PLI: December 27, 2000.                            */
id|ypo
op_assign
l_int|64
suffix:semicolon
id|ype
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ype
op_assign
id|ysci
op_div
l_int|16
suffix:semicolon
id|ypo
op_assign
id|ype
op_plus
(paren
id|ysci
op_div
l_int|64
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|yacm
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* calculate scaling increment */
id|ysci
op_assign
(paren
(paren
(paren
l_int|10
op_star
l_int|1024
op_star
(paren
id|in_y
op_minus
id|out_y
op_minus
l_int|1
)paren
)paren
op_div
id|in_y
)paren
op_plus
l_int|9
)paren
op_div
l_int|10
suffix:semicolon
multiline_comment|/* calculate ype and ypo */
id|ypo
op_assign
id|ype
op_assign
(paren
(paren
id|ysci
op_plus
l_int|15
)paren
op_div
l_int|16
)paren
suffix:semicolon
multiline_comment|/* the sequence length interval (yacl) has to be set according&n;&t;&t;   to the prescale value, e.g.&t;[n   .. 1/2) : 0&n;&t;&t;   &t;&t;&t;&t;[1/2 .. 1/3) : 1&n;&t;&t;&t;&t;&t;&t;[1/3 .. 1/4) : 2&n;&t;&t;&t;&t;&t;&t;... */
r_if
c_cond
(paren
id|ysci
OL
l_int|512
)paren
(brace
id|yacl
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|yacl
op_assign
(paren
id|ysci
op_div
(paren
l_int|1024
op_minus
id|ysci
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* get filter coefficients for cya, cyb from table hps_v_coeff_tab */
id|cya_cyb
op_assign
id|hps_v_coeff_tab
(braket
id|TRUNC
c_func
(paren
id|yacl
comma
l_int|63
)paren
)braket
dot
id|hps_coeff
suffix:semicolon
multiline_comment|/* get best match in the table of attenuations for vertical scaling */
id|v_atten
op_assign
id|hps_v_coeff_tab
(braket
id|TRUNC
c_func
(paren
id|yacl
comma
l_int|63
)paren
)braket
dot
id|weight_sum
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|v_attenuation
(braket
id|i
)braket
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|v_attenuation
(braket
id|i
)braket
op_ge
id|v_atten
)paren
r_break
suffix:semicolon
)brace
id|dcgy
op_assign
id|i
suffix:semicolon
)brace
multiline_comment|/* ypo and ype swapped in spec ? */
op_star
id|hps_v_scale
op_or_assign
(paren
id|yacm
op_lshift
l_int|31
)paren
op_or
(paren
id|ysci
op_lshift
l_int|21
)paren
op_or
(paren
id|yacl
op_lshift
l_int|15
)paren
op_or
(paren
id|ypo
op_lshift
l_int|8
)paren
op_or
(paren
id|ype
op_lshift
l_int|1
)paren
suffix:semicolon
op_star
id|hps_v_gain
op_and_assign
op_complement
(paren
id|MASK_W0
op_or
id|MASK_B2
)paren
suffix:semicolon
op_star
id|hps_v_gain
op_or_assign
(paren
id|dcgy
op_lshift
l_int|16
)paren
op_or
(paren
id|cya_cyb
op_lshift
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|calculate_hxo_hyo_and_sources
r_void
id|calculate_hxo_hyo_and_sources
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|port_sel
comma
r_int
id|sync_sel
comma
id|u32
op_star
id|hps_h_scale
comma
id|u32
op_star
id|hps_ctrl
)paren
(brace
id|u32
id|hyo
op_assign
l_int|0
comma
id|hxo
op_assign
l_int|0
suffix:semicolon
id|hyo
op_assign
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_offset
suffix:semicolon
id|hxo
op_assign
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|h_offset
suffix:semicolon
op_star
id|hps_h_scale
op_and_assign
op_complement
(paren
id|MASK_B0
op_or
l_int|0xf00
)paren
suffix:semicolon
op_star
id|hps_ctrl
op_and_assign
op_complement
(paren
id|MASK_W0
op_or
id|MASK_B2
op_or
id|MASK_30
op_or
id|MASK_31
op_or
id|MASK_28
)paren
suffix:semicolon
op_star
id|hps_h_scale
op_or_assign
(paren
id|hxo
op_lshift
l_int|0
)paren
suffix:semicolon
op_star
id|hps_ctrl
op_or_assign
(paren
id|hyo
op_lshift
l_int|12
)paren
suffix:semicolon
op_star
id|hps_ctrl
op_or_assign
(paren
id|port_sel
op_eq
l_int|0
ques
c_cond
l_int|0x0
suffix:colon
id|MASK_30
)paren
suffix:semicolon
op_star
id|hps_ctrl
op_or_assign
(paren
id|sync_sel
op_eq
l_int|0
ques
c_cond
l_int|0x0
suffix:colon
id|MASK_28
)paren
suffix:semicolon
)brace
DECL|function|calculate_output_format_register
r_void
id|calculate_output_format_register
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u16
id|palette
comma
id|u32
op_star
id|clip_format
)paren
(brace
multiline_comment|/* clear out the necessary bits */
op_star
id|clip_format
op_and_assign
l_int|0x0000ffff
suffix:semicolon
multiline_comment|/* set these bits new */
op_star
id|clip_format
op_or_assign
(paren
(paren
(paren
(paren
id|palette
op_amp
l_int|0xf00
)paren
op_rshift
l_int|8
)paren
op_lshift
l_int|30
)paren
op_or
(paren
(paren
id|palette
op_amp
l_int|0x00f
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
(paren
id|palette
op_amp
l_int|0x0f0
)paren
op_rshift
l_int|4
)paren
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
DECL|function|calculate_bcs_ctrl_register
r_void
id|calculate_bcs_ctrl_register
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|brightness
comma
id|u32
id|contrast
comma
id|u32
id|colour
comma
id|u32
op_star
id|bcs_ctrl
)paren
(brace
op_star
id|bcs_ctrl
op_assign
(paren
(paren
id|brightness
op_lshift
l_int|24
)paren
op_or
(paren
id|contrast
op_lshift
l_int|16
)paren
op_or
(paren
id|colour
op_lshift
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|function|calculate_video_dma1_grab
r_int
id|calculate_video_dma1_grab
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|frame
comma
r_struct
id|saa7146_video_dma
op_star
id|vdma1
)paren
(brace
r_int
id|depth
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|saa-&gt;grab_format
(braket
id|frame
)braket
)paren
(brace
r_case
id|YUV422_COMPOSED
suffix:colon
r_case
id|RGB15_COMPOSED
suffix:colon
r_case
id|RGB16_COMPOSED
suffix:colon
id|depth
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RGB24_COMPOSED
suffix:colon
id|depth
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|depth
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
)brace
id|vdma1-&gt;pitch
op_assign
id|saa-&gt;grab_width
(braket
id|frame
)braket
op_star
id|depth
op_star
l_int|2
suffix:semicolon
id|vdma1-&gt;base_even
op_assign
l_int|0
suffix:semicolon
id|vdma1-&gt;base_odd
op_assign
id|vdma1-&gt;base_even
op_plus
(paren
id|vdma1-&gt;pitch
op_div
l_int|2
)paren
suffix:semicolon
id|vdma1-&gt;prot_addr
op_assign
(paren
id|saa-&gt;grab_width
(braket
id|frame
)braket
op_star
id|saa-&gt;grab_height
(braket
id|frame
)braket
op_star
id|depth
)paren
op_minus
l_int|1
suffix:semicolon
id|vdma1-&gt;num_line_byte
op_assign
(paren
(paren
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_field
op_lshift
l_int|16
)paren
op_plus
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|h_pixels
)paren
suffix:semicolon
id|vdma1-&gt;base_page
op_assign
id|virt_to_bus
c_func
(paren
id|saa-&gt;page_table
(braket
id|frame
)braket
)paren
op_or
id|ME1
suffix:semicolon
multiline_comment|/* convention: if scaling is between 1/2 and 1/4 we only use&n;&t;   the even lines, the odd lines get discarded (see vertical scaling) */
r_if
c_cond
(paren
id|saa-&gt;interlace
op_ne
l_int|0
op_logical_and
id|saa-&gt;grab_height
(braket
id|frame
)braket
op_star
l_int|4
op_ge
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
op_logical_and
id|saa-&gt;grab_height
(braket
id|frame
)braket
op_star
l_int|2
op_le
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
)paren
(brace
id|vdma1-&gt;base_odd
op_assign
id|vdma1-&gt;prot_addr
suffix:semicolon
id|vdma1-&gt;pitch
op_div_assign
l_int|2
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* position of overlay-window&t;&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* calculate the new memory offsets for a desired position */
DECL|function|move_to
r_int
id|move_to
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|w_x
comma
r_int
id|w_y
comma
r_int
id|w_height
comma
r_int
id|b_width
comma
r_int
id|b_depth
comma
r_int
id|b_bpl
comma
id|u32
id|base
comma
r_int
id|td_flip
)paren
(brace
r_struct
id|saa7146_video_dma
id|vdma1
suffix:semicolon
r_if
c_cond
(paren
id|w_y
OL
l_int|0
op_logical_or
id|w_height
op_le
l_int|0
op_logical_or
id|b_depth
op_le
l_int|0
op_logical_or
id|b_bpl
op_le
l_int|0
op_logical_or
id|base
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; calculate_video_dma1_overlay: illegal values: y: %d  h: %d  d: %d  b: %d  base: %d&bslash;n&quot;
comma
id|w_y
comma
id|w_height
comma
id|b_depth
comma
id|b_bpl
comma
id|base
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* calculate memory offsets for picture, look if we shall top-down-flip */
id|vdma1.pitch
op_assign
l_int|2
op_star
id|b_bpl
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|td_flip
)paren
(brace
id|vdma1.prot_addr
op_assign
(paren
id|u32
)paren
id|base
op_plus
(paren
(paren
id|w_height
op_plus
id|w_y
op_plus
l_int|1
)paren
op_star
id|b_width
op_star
(paren
id|b_depth
op_div
l_int|4
)paren
)paren
suffix:semicolon
id|vdma1.base_even
op_assign
(paren
id|u32
)paren
id|base
op_plus
(paren
id|w_y
op_star
(paren
id|vdma1.pitch
op_div
l_int|2
)paren
)paren
op_plus
(paren
id|w_x
op_star
(paren
id|b_depth
op_div
l_int|8
)paren
)paren
suffix:semicolon
id|vdma1.base_odd
op_assign
id|vdma1.base_even
op_plus
(paren
id|vdma1.pitch
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|vdma1.prot_addr
op_assign
(paren
id|u32
)paren
id|base
op_plus
(paren
id|w_y
op_star
(paren
id|vdma1.pitch
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|vdma1.base_even
op_assign
(paren
id|u32
)paren
id|base
op_plus
(paren
(paren
id|w_y
op_plus
id|w_height
)paren
op_star
(paren
id|vdma1.pitch
op_div
l_int|2
)paren
)paren
op_plus
(paren
id|w_x
op_star
(paren
id|b_depth
op_div
l_int|8
)paren
)paren
suffix:semicolon
id|vdma1.base_odd
op_assign
id|vdma1.base_even
op_plus
(paren
id|vdma1.pitch
op_div
l_int|2
)paren
suffix:semicolon
id|vdma1.pitch
op_mul_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* convention: if scaling is between 1/2 and 1/4 we only use&n;&t;   the even lines, the odd lines get discarded (see vertical scaling) */
r_if
c_cond
(paren
id|saa-&gt;interlace
op_ne
l_int|0
op_logical_and
id|w_height
op_star
l_int|4
op_ge
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
op_logical_and
id|w_height
op_star
l_int|2
op_le
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
)paren
(brace
id|vdma1.base_odd
op_assign
id|vdma1.prot_addr
suffix:semicolon
id|vdma1.pitch
op_div_assign
l_int|2
suffix:semicolon
)brace
id|vdma1.base_page
op_assign
l_int|0
suffix:semicolon
id|vdma1.num_line_byte
op_assign
(paren
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_field
op_lshift
l_int|16
)paren
op_plus
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|h_pixels
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|BASE_EVEN1
comma
id|vdma1.base_even
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|BASE_ODD1
comma
id|vdma1.base_odd
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|PROT_ADDR1
comma
id|vdma1.prot_addr
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|BASE_PAGE1
comma
id|vdma1.base_page
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|PITCH1
comma
id|vdma1.pitch
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|NUM_LINE_BYTE1
comma
id|vdma1.num_line_byte
)paren
suffix:semicolon
multiline_comment|/* update the video dma 1 registers */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_02
op_or
id|MASK_18
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* size of window (overlay)&t;&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
DECL|function|set_window
r_int
id|set_window
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|flip_lr
comma
r_int
id|port_sel
comma
r_int
id|sync_sel
)paren
(brace
id|u32
id|hps_v_scale
op_assign
l_int|0
comma
id|hps_v_gain
op_assign
l_int|0
comma
id|hps_ctrl
op_assign
l_int|0
comma
id|hps_h_prescale
op_assign
l_int|0
comma
id|hps_h_scale
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set vertical scale according to selected mode: 0 = PAL, 1 = NTSC */
id|hps_v_scale
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* all bits get set by the function-call */
id|hps_v_gain
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fixme: saa7146_read(saa-&gt;mem, HPS_V_GAIN);*/
id|calculate_v_scale_registers
c_func
(paren
id|saa
comma
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
comma
id|height
comma
op_amp
id|hps_v_scale
comma
op_amp
id|hps_v_gain
)paren
suffix:semicolon
multiline_comment|/* set horizontal scale according to selected mode: 0 = PAL, 1 = NTSC */
id|hps_ctrl
op_assign
l_int|0
suffix:semicolon
id|hps_h_prescale
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* all bits get set in the function */
id|hps_h_scale
op_assign
l_int|0
suffix:semicolon
id|calculate_h_scale_registers
c_func
(paren
id|saa
comma
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|h_calc
comma
id|width
comma
l_int|0
comma
op_amp
id|hps_ctrl
comma
op_amp
id|hps_v_gain
comma
op_amp
id|hps_h_prescale
comma
op_amp
id|hps_h_scale
)paren
suffix:semicolon
multiline_comment|/* set hyo and hxo */
id|calculate_hxo_hyo_and_sources
c_func
(paren
id|saa
comma
id|port_sel
comma
id|sync_sel
comma
op_amp
id|hps_h_scale
comma
op_amp
id|hps_ctrl
)paren
suffix:semicolon
multiline_comment|/* write out new register contents */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|HPS_V_SCALE
comma
id|hps_v_scale
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|HPS_V_GAIN
comma
id|hps_v_gain
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|HPS_CTRL
comma
id|hps_ctrl
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|HPS_H_PRESCALE
comma
id|hps_h_prescale
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|HPS_H_SCALE
comma
id|hps_h_scale
)paren
suffix:semicolon
multiline_comment|/* upload shadow-ram registers */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_05
op_or
id|MASK_06
op_or
id|MASK_21
op_or
id|MASK_22
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;printk(&quot;w:%d,h:%d&bslash;n&quot;,width,height);&n;*/
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_output_format
r_void
id|set_output_format
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u16
id|palette
)paren
(brace
id|u32
id|clip_format
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|CLIP_FORMAT_CTRL
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; set_output_format: pal:0x%03x&bslash;n&quot;
comma
id|palette
)paren
suffix:semicolon
multiline_comment|/* call helper function */
id|calculate_output_format_register
c_func
(paren
id|saa
comma
id|palette
comma
op_amp
id|clip_format
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; set_output_format: 0x%08x&bslash;n&quot;
comma
id|clip_format
)paren
suffix:semicolon
multiline_comment|/* update the hps registers */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|CLIP_FORMAT_CTRL
comma
id|clip_format
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_05
op_or
id|MASK_21
)paren
)paren
suffix:semicolon
)brace
DECL|function|set_picture_prop
r_void
id|set_picture_prop
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|brightness
comma
id|u32
id|contrast
comma
id|u32
id|colour
)paren
(brace
id|u32
id|bcs_ctrl
op_assign
l_int|0
suffix:semicolon
id|calculate_bcs_ctrl_register
c_func
(paren
id|saa
comma
id|brightness
comma
id|contrast
comma
id|colour
comma
op_amp
id|bcs_ctrl
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|BCS_CTRL
comma
id|bcs_ctrl
)paren
suffix:semicolon
multiline_comment|/* update the bcs register */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_06
op_or
id|MASK_22
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* overlay enable/disable&t;&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* enable(1) / disable(0) video */
DECL|function|video_setmode
r_void
id|video_setmode
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|v
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; video_setmode; m:%d&bslash;n&quot;
comma
id|v
)paren
suffix:semicolon
multiline_comment|/* disable ? */
r_if
c_cond
(paren
id|v
op_eq
l_int|0
)paren
(brace
multiline_comment|/* disable video dma1 */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
id|MASK_22
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* or enable ? */
multiline_comment|/* fixme: enable video */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
(paren
id|MASK_06
op_or
id|MASK_22
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* -----------------------------------------------------&n;   common grabbing-functions. if you have some simple&n;   saa7146-based frame-grabber you can most likely call&n;   these. they do all the revision-dependend stuff and&n;   do rps/irq-based grabbing for you.&n;   -----------------------------------------------------*/
multiline_comment|/* this function initializes the rps for the next grab for any &quot;old&quot;&n;   saa7146s (= revision 0). it assumes that the rps is *not* running&n;   when it gets called. */
DECL|function|init_rps0_rev0
r_int
id|init_rps0_rev0
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|frame
comma
r_int
id|irq_call
)paren
(brace
r_struct
id|saa7146_video_dma
id|vdma1
suffix:semicolon
id|u32
id|hps_v_scale
op_assign
l_int|0
comma
id|hps_v_gain
op_assign
l_int|0
comma
id|hps_ctrl
op_assign
l_int|0
comma
id|hps_h_prescale
op_assign
l_int|0
comma
id|hps_h_scale
op_assign
l_int|0
suffix:semicolon
id|u32
id|clip_format
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this can be 0, since we don&squot;t do clipping */
id|u32
id|bcs_ctrl
op_assign
l_int|0
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* these static values are used to remember the last &quot;programming&quot; of the rps.&n;   if the height, width and format of the grab has not changed (which is very likely&n;   when some streaming capture is done) the reprogramming overhead can be minimized */
r_static
r_int
id|last_height
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|last_width
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|last_format
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|last_port
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|last_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* write the address of the rps-program */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|RPS_ADDR0
comma
id|virt_to_bus
c_func
(paren
op_amp
id|saa-&gt;rps0
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* let&squot;s check if we can re-use something of the last grabbing process */
r_if
c_cond
(paren
id|saa-&gt;grab_height
(braket
id|frame
)braket
op_ne
id|last_height
op_logical_or
id|saa-&gt;grab_width
(braket
id|frame
)braket
op_ne
id|last_width
op_logical_or
id|saa-&gt;grab_port
(braket
id|frame
)braket
op_ne
id|last_port
op_logical_or
id|saa-&gt;grab_format
(braket
id|frame
)braket
op_ne
id|last_format
)paren
(brace
multiline_comment|/* nope, we have to start from the beginning */
id|calculate_video_dma1_grab
c_func
(paren
id|saa
comma
id|frame
comma
op_amp
id|vdma1
)paren
suffix:semicolon
id|calculate_v_scale_registers
c_func
(paren
id|saa
comma
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
comma
id|saa-&gt;grab_height
(braket
id|frame
)braket
comma
op_amp
id|hps_v_scale
comma
op_amp
id|hps_v_gain
)paren
suffix:semicolon
id|calculate_h_scale_registers
c_func
(paren
id|saa
comma
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|h_calc
comma
id|saa-&gt;grab_width
(braket
id|frame
)braket
comma
l_int|0
comma
op_amp
id|hps_ctrl
comma
op_amp
id|hps_v_gain
comma
op_amp
id|hps_h_prescale
comma
op_amp
id|hps_h_scale
)paren
suffix:semicolon
id|calculate_hxo_hyo_and_sources
c_func
(paren
id|saa
comma
id|saa-&gt;grab_port
(braket
id|frame
)braket
comma
id|saa-&gt;grab_port
(braket
id|frame
)braket
comma
op_amp
id|hps_h_scale
comma
op_amp
id|hps_ctrl
)paren
suffix:semicolon
id|calculate_output_format_register
c_func
(paren
id|saa
comma
id|saa-&gt;grab_format
(braket
id|frame
)braket
comma
op_amp
id|clip_format
)paren
suffix:semicolon
id|calculate_bcs_ctrl_register
c_func
(paren
id|saa
comma
l_int|0x80
comma
l_int|0x40
comma
l_int|0x40
comma
op_amp
id|bcs_ctrl
)paren
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG_MASK
op_or
(paren
id|MC1
op_div
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* turn off video-dma1 and dma2 (clipping)*/
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_06
op_or
id|MASK_22
op_or
id|MASK_05
op_or
id|MASK_21
)paren
suffix:semicolon
multiline_comment|/* =&gt; mask */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_22
op_or
id|MASK_21
)paren
suffix:semicolon
multiline_comment|/* =&gt; values */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
(paren
id|saa-&gt;grab_port
(braket
id|frame
)braket
op_eq
l_int|0
ques
c_cond
id|MASK_12
suffix:colon
id|MASK_14
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for o_fid_a/b */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
(paren
id|saa-&gt;grab_port
(braket
id|frame
)braket
op_eq
l_int|0
ques
c_cond
id|MASK_11
suffix:colon
id|MASK_13
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for e_fid_a/b */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG
op_or
(paren
l_int|6
op_lshift
l_int|8
)paren
op_or
id|HPS_CTRL
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* upload hps-registers for next grab */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_ctrl
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_v_scale
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_v_gain
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_h_prescale
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_h_scale
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|bcs_ctrl
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
id|CLIP_FORMAT_CTRL
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* upload hps-registers for next grab */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|clip_format
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_UPLOAD
op_or
id|MASK_05
op_or
id|MASK_06
)paren
suffix:semicolon
multiline_comment|/* upload hps1/2 */
multiline_comment|/* upload video-dma1 registers for next grab */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG
op_or
(paren
l_int|6
op_lshift
l_int|8
)paren
op_or
id|BASE_ODD1
op_div
l_int|4
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.base_odd
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.base_even
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.prot_addr
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.pitch
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.base_page
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.num_line_byte
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_UPLOAD
op_or
id|MASK_02
)paren
suffix:semicolon
multiline_comment|/* upload video-dma1 */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG_MASK
op_or
(paren
id|MC1
op_div
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* turn on video-dma1 */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_06
op_or
id|MASK_22
)paren
suffix:semicolon
multiline_comment|/* =&gt; mask */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_06
op_or
id|MASK_22
)paren
suffix:semicolon
multiline_comment|/* =&gt; values */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
id|MC2
op_div
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* Write MC2 */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
l_int|1
op_lshift
(paren
l_int|27
op_plus
id|frame
)paren
)paren
op_or
(paren
l_int|1
op_lshift
(paren
l_int|11
op_plus
id|frame
)paren
)paren
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
(paren
id|saa-&gt;grab_port
(braket
id|frame
)braket
op_eq
l_int|0
ques
c_cond
id|MASK_12
suffix:colon
id|MASK_14
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for o_fid_a/b */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
(paren
id|saa-&gt;grab_port
(braket
id|frame
)braket
op_eq
l_int|0
ques
c_cond
id|MASK_11
suffix:colon
id|MASK_13
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for e_fid_a/b */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG_MASK
op_or
(paren
id|MC1
op_div
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* turn off video-dma1 */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_06
op_or
id|MASK_22
)paren
suffix:semicolon
multiline_comment|/* =&gt; mask */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_22
)paren
suffix:semicolon
multiline_comment|/* =&gt; values */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_INTERRUPT
)paren
suffix:semicolon
multiline_comment|/* generate interrupt */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_STOP
)paren
suffix:semicolon
multiline_comment|/* stop processing */
)brace
r_else
(brace
multiline_comment|/* the height, width, ... have not changed. check if the user wants to grab to&n;&t;&t;   another *buffer* */
r_if
c_cond
(paren
id|frame
op_ne
id|last_frame
)paren
(brace
multiline_comment|/* ok, we want to grab to another buffer, but with the same programming.&n;&t;&t;&t;   it is sufficient to adjust the video_dma1-registers and the rps-signal stuff. */
id|saa-&gt;rps0
(braket
l_int|20
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
id|saa-&gt;page_table
(braket
id|frame
)braket
)paren
op_or
id|ME1
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
l_int|27
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
l_int|1
op_lshift
(paren
l_int|27
op_plus
id|frame
)paren
)paren
op_or
(paren
l_int|1
op_lshift
(paren
l_int|11
op_plus
id|frame
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* if we are called from within the irq-handler, the hps is at the beginning of a&n;&t;   new frame. the rps does not need to wait the new frame, and so we tweak the&n;&t;   starting address a little bit and so we can directly start grabbing again.&n;&t;   note: for large video-sizes and slow computers this can cause jaggy pictures&n;&t;   because the whole process is not in sync. perhaps one should be able to&n;&t;   disable this. (please remember that this whole stuff only belongs to &n;&t;   &quot;old&quot; saa7146s (= revision 0), newer saa7146s don&#xfffd;t have any hardware-bugs&n;&t;   and capture works fine. (see below) */
r_if
c_cond
(paren
l_int|1
op_eq
id|irq_call
)paren
(brace
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|RPS_ADDR0
comma
id|virt_to_bus
c_func
(paren
op_amp
id|saa-&gt;rps0
(braket
l_int|15
)braket
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* turn on rps */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
(paren
id|MASK_12
op_or
id|MASK_28
)paren
)paren
suffix:semicolon
multiline_comment|/* store the values for the last grab */
id|last_height
op_assign
id|saa-&gt;grab_height
(braket
id|frame
)braket
suffix:semicolon
id|last_width
op_assign
id|saa-&gt;grab_width
(braket
id|frame
)braket
suffix:semicolon
id|last_format
op_assign
id|saa-&gt;grab_format
(braket
id|frame
)braket
suffix:semicolon
id|last_port
op_assign
id|saa-&gt;grab_port
(braket
id|frame
)braket
suffix:semicolon
id|last_frame
op_assign
id|frame
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|init_rps0_rev1
r_int
id|init_rps0_rev1
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|frame
)paren
(brace
r_static
r_int
id|old_width
(braket
id|SAA7146_MAX_BUF
)braket
suffix:semicolon
multiline_comment|/* pixel width of grabs */
r_static
r_int
id|old_height
(braket
id|SAA7146_MAX_BUF
)braket
suffix:semicolon
multiline_comment|/* pixel height of grabs */
r_static
r_int
id|old_format
(braket
id|SAA7146_MAX_BUF
)braket
suffix:semicolon
multiline_comment|/* video format of grabs */
r_static
r_int
id|old_port
(braket
id|SAA7146_MAX_BUF
)braket
suffix:semicolon
multiline_comment|/* video port for grab */
r_static
r_int
id|buf_stat
(braket
id|SAA7146_MAX_BUF
)braket
suffix:semicolon
r_struct
id|saa7146_video_dma
id|vdma1
suffix:semicolon
id|u32
id|hps_v_scale
op_assign
l_int|0
comma
id|hps_v_gain
op_assign
l_int|0
comma
id|hps_ctrl
op_assign
l_int|0
comma
id|hps_h_prescale
op_assign
l_int|0
comma
id|hps_h_scale
op_assign
l_int|0
suffix:semicolon
id|u32
id|clip_format
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this can be 0, since we don&squot;t do clipping */
id|u32
id|bcs_ctrl
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* check if something has changed since the last grab for this buffer */
r_if
c_cond
(paren
id|saa-&gt;grab_height
(braket
id|frame
)braket
op_eq
id|old_height
(braket
id|frame
)braket
op_logical_and
id|saa-&gt;grab_width
(braket
id|frame
)braket
op_eq
id|old_width
(braket
id|frame
)braket
op_logical_and
id|saa-&gt;grab_port
(braket
id|frame
)braket
op_eq
id|old_port
(braket
id|frame
)braket
op_logical_and
id|saa-&gt;grab_format
(braket
id|frame
)braket
op_eq
id|old_format
(braket
id|frame
)braket
)paren
(brace
multiline_comment|/* nope, nothing to be done here */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* re-program the rps0 completely */
multiline_comment|/* indicate that the user has requested re-programming of the &squot;frame&squot;-buffer */
id|buf_stat
(braket
id|frame
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* turn off rps */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
id|MASK_28
)paren
suffix:semicolon
multiline_comment|/* write beginning of rps-program */
id|count
op_assign
l_int|0
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
id|MASK_12
)paren
suffix:semicolon
multiline_comment|/* wait for o_fid_a */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
id|MASK_11
)paren
suffix:semicolon
multiline_comment|/* wait for e_fid_a */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|saa-&gt;buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_JUMP
op_or
(paren
l_int|1
op_lshift
(paren
l_int|21
op_plus
id|i
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* check signal x, jump if set */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|saa-&gt;rps0
(braket
l_int|40
op_star
(paren
id|i
op_plus
l_int|1
)paren
)braket
)paren
)paren
suffix:semicolon
)brace
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
id|MASK_12
)paren
suffix:semicolon
multiline_comment|/* wait for o_fid_a */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
id|MASK_11
)paren
suffix:semicolon
multiline_comment|/* wait for e_fid_a */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_JUMP
)paren
suffix:semicolon
multiline_comment|/* jump to the beginning */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|saa-&gt;rps0
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|saa-&gt;buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* we only re-program the i-th buffer if the user had set some values for it earlier.&n;&t;&t;   otherwise the calculation-functions may fail. */
r_if
c_cond
(paren
id|buf_stat
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|count
op_assign
l_int|40
op_star
(paren
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|calculate_video_dma1_grab
c_func
(paren
id|saa
comma
id|i
comma
op_amp
id|vdma1
)paren
suffix:semicolon
id|calculate_v_scale_registers
c_func
(paren
id|saa
comma
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
comma
id|saa-&gt;grab_height
(braket
id|i
)braket
comma
op_amp
id|hps_v_scale
comma
op_amp
id|hps_v_gain
)paren
suffix:semicolon
id|calculate_h_scale_registers
c_func
(paren
id|saa
comma
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|h_calc
comma
id|saa-&gt;grab_width
(braket
id|i
)braket
comma
l_int|0
comma
op_amp
id|hps_ctrl
comma
op_amp
id|hps_v_gain
comma
op_amp
id|hps_h_prescale
comma
op_amp
id|hps_h_scale
)paren
suffix:semicolon
id|calculate_hxo_hyo_and_sources
c_func
(paren
id|saa
comma
id|saa-&gt;grab_port
(braket
id|i
)braket
comma
id|saa-&gt;grab_port
(braket
id|i
)braket
comma
op_amp
id|hps_h_scale
comma
op_amp
id|hps_ctrl
)paren
suffix:semicolon
id|calculate_output_format_register
c_func
(paren
id|saa
comma
id|saa-&gt;grab_format
(braket
id|i
)braket
comma
op_amp
id|clip_format
)paren
suffix:semicolon
id|calculate_bcs_ctrl_register
c_func
(paren
id|saa
comma
l_int|0x80
comma
l_int|0x40
comma
l_int|0x40
comma
op_amp
id|bcs_ctrl
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG
op_or
(paren
l_int|6
op_lshift
l_int|8
)paren
op_or
id|HPS_CTRL
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* upload hps-registers for next grab */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_ctrl
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_v_scale
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_v_gain
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_h_prescale
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|hps_h_scale
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|bcs_ctrl
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
id|CLIP_FORMAT_CTRL
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* upload hps-registers for next grab */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|clip_format
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_UPLOAD
op_or
id|MASK_05
op_or
id|MASK_06
)paren
suffix:semicolon
multiline_comment|/* upload hps1/2 */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG
op_or
(paren
l_int|6
op_lshift
l_int|8
)paren
op_or
id|BASE_ODD1
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* upload video-dma1 registers for next grab */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.base_odd
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.base_even
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.prot_addr
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.pitch
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.base_page
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|vdma1.num_line_byte
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_UPLOAD
op_or
id|MASK_02
)paren
suffix:semicolon
multiline_comment|/* upload video-dma1 */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG_MASK
op_or
(paren
id|MC1
op_div
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* turn on video-dma1 */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_06
op_or
id|MASK_22
)paren
suffix:semicolon
multiline_comment|/* =&gt; mask */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_06
op_or
id|MASK_22
)paren
suffix:semicolon
multiline_comment|/* =&gt; values */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
(paren
id|saa-&gt;grab_port
(braket
id|i
)braket
op_eq
l_int|0
ques
c_cond
id|MASK_12
suffix:colon
id|MASK_14
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for o_fid_a/b */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_PAUSE
op_or
(paren
id|saa-&gt;grab_port
(braket
id|i
)braket
op_eq
l_int|0
ques
c_cond
id|MASK_11
suffix:colon
id|MASK_13
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for e_fid_a/b */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG_MASK
op_or
(paren
id|MC1
op_div
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* turn off video-dma1 and dma2 (clipping)*/
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_06
op_or
id|MASK_22
op_or
id|MASK_05
op_or
id|MASK_21
)paren
suffix:semicolon
multiline_comment|/* =&gt; mask */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|MASK_22
op_or
id|MASK_21
)paren
suffix:semicolon
multiline_comment|/* =&gt; values */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_WR_REG
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
id|MC2
op_div
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* Write MC2 */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
l_int|1
op_lshift
(paren
l_int|27
op_plus
id|i
)paren
)paren
)paren
suffix:semicolon
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_INTERRUPT
)paren
suffix:semicolon
multiline_comment|/* generate interrupt */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|CMD_JUMP
)paren
suffix:semicolon
multiline_comment|/* jump to the beginning */
id|saa-&gt;rps0
(braket
id|count
op_increment
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
op_amp
id|saa-&gt;rps0
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|old_height
(braket
id|frame
)braket
op_assign
id|saa-&gt;grab_height
(braket
id|frame
)braket
suffix:semicolon
id|old_width
(braket
id|frame
)braket
op_assign
id|saa-&gt;grab_width
(braket
id|frame
)braket
suffix:semicolon
id|old_port
(braket
id|frame
)braket
op_assign
id|saa-&gt;grab_port
(braket
id|frame
)braket
suffix:semicolon
id|old_format
(braket
id|frame
)braket
op_assign
id|saa-&gt;grab_format
(braket
id|frame
)braket
suffix:semicolon
)brace
multiline_comment|/* write the address of the rps-program */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|RPS_ADDR0
comma
id|virt_to_bus
c_func
(paren
op_amp
id|saa-&gt;rps0
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* turn on rps again */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
(paren
id|MASK_12
op_or
id|MASK_28
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* this funtion is called whenever a new grab is requested. if possible (that&n;   means: if the rps is not running) it re-programs the rps, otherwise it relys on&n;   the irq-handler to do that */
DECL|function|set_up_grabbing
r_int
id|set_up_grabbing
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|frame
)paren
(brace
id|u32
id|mc1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|saa-&gt;revision
)paren
(brace
multiline_comment|/* check if the rps is currently in use */
id|mc1
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
)paren
suffix:semicolon
multiline_comment|/* the rps is not running ... */
r_if
c_cond
(paren
l_int|0
op_eq
(paren
id|mc1
op_amp
id|MASK_12
)paren
)paren
(brace
multiline_comment|/* we can completly re-program the rps now */
id|dprintk
c_func
(paren
l_string|&quot;saa7146_v4l.o: ==&gt; set_up_grabbing: start new rps.&bslash;n&quot;
)paren
suffix:semicolon
id|init_rps0_rev0
c_func
(paren
id|saa
comma
id|frame
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* the rps is running. in this case, the irq-handler is responsible for&n;&t;&t;&t;   re-programming the rps and nothing can be done right now */
id|dprintk
c_func
(paren
l_string|&quot;saa7146_v4l.o: ==&gt; set_up_grabbing: no new rps started.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* check if something has changed, reprogram if necessary */
id|init_rps0_rev1
c_func
(paren
id|saa
comma
id|frame
)paren
suffix:semicolon
multiline_comment|/* set rps-signal-bit to start grabbing */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
l_int|1
op_lshift
(paren
l_int|27
op_plus
id|frame
)paren
)paren
op_or
(paren
l_int|1
op_lshift
(paren
l_int|11
op_plus
id|frame
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa7146_std_grab_irq_callback_rps0
r_void
id|saa7146_std_grab_irq_callback_rps0
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|isr
comma
r_void
op_star
id|data
)paren
(brace
id|u32
id|mc2
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|hprintk
c_func
(paren
l_string|&quot;saa7146_v4l.o: ==&gt; saa7146_v4l_irq_callback_rps0&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* check for revision: old revision */
r_if
c_cond
(paren
l_int|0
op_eq
id|saa-&gt;revision
)paren
(brace
multiline_comment|/* look what buffer has been grabbed, set the &#xfffd;done&#xfffd;-flag and clear the signal */
id|mc2
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|saa-&gt;buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|0
op_ne
(paren
id|mc2
op_amp
(paren
l_int|1
op_lshift
(paren
l_int|11
op_plus
id|i
)paren
)paren
)paren
)paren
op_logical_and
(paren
id|GBUFFER_GRABBING
op_eq
id|saa-&gt;frame_stat
(braket
id|i
)braket
)paren
)paren
(brace
id|saa-&gt;frame_stat
(braket
id|i
)braket
op_assign
id|GBUFFER_DONE
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
l_int|1
op_lshift
(paren
l_int|27
op_plus
id|i
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* look if there is another buffer we can grab to */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|saa-&gt;buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|GBUFFER_GRABBING
op_eq
id|saa-&gt;frame_stat
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* yes, then set up the rps again */
r_if
c_cond
(paren
id|saa-&gt;buffers
op_ne
id|i
)paren
(brace
id|init_rps0_rev0
c_func
(paren
id|saa
comma
id|i
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* new revisions */
multiline_comment|/* look what buffer has been grabbed, set the &#xfffd;done&#xfffd;-flag */
id|mc2
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|saa-&gt;buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|0
op_eq
(paren
id|mc2
op_amp
(paren
l_int|1
op_lshift
(paren
l_int|11
op_plus
id|i
)paren
)paren
)paren
)paren
op_logical_and
(paren
id|GBUFFER_GRABBING
op_eq
id|saa-&gt;frame_stat
(braket
id|i
)braket
)paren
)paren
(brace
id|saa-&gt;frame_stat
(braket
id|i
)braket
op_assign
id|GBUFFER_DONE
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* notify any pending process */
id|wake_up_interruptible
c_func
(paren
op_amp
id|saa-&gt;rps0_wq
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* mask-clipping&t;&t;&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
DECL|function|calculate_clipping_registers_mask
r_int
id|calculate_clipping_registers_mask
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|width
comma
id|u32
id|height
comma
r_struct
id|saa7146_video_dma
op_star
id|vdma2
comma
id|u32
op_star
id|clip_format
comma
id|u32
op_star
id|arbtr_ctrl
)paren
(brace
id|u32
id|clip_addr
op_assign
l_int|0
comma
id|clip_pitch
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; calculate_clipping_registers_mask&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* adjust arbitration control register */
op_star
id|arbtr_ctrl
op_and_assign
l_int|0xffff00ff
suffix:semicolon
op_star
id|arbtr_ctrl
op_or_assign
l_int|0x00001000
suffix:semicolon
id|clip_addr
op_assign
id|virt_to_bus
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
id|clip_pitch
op_assign
(paren
(paren
id|width
op_plus
l_int|31
)paren
op_div
l_int|32
)paren
op_star
l_int|4
suffix:semicolon
id|vdma2-&gt;base_even
op_assign
id|clip_addr
suffix:semicolon
id|vdma2-&gt;base_page
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* enable read - operation */
id|vdma2-&gt;prot_addr
op_assign
id|clip_addr
op_plus
(paren
id|clip_pitch
op_star
id|height
)paren
suffix:semicolon
multiline_comment|/* convention: if scaling is between 1/2 and 1/4 we only use&n;&t;   the even lines, the odd lines get discarded (see vertical scaling) */
r_if
c_cond
(paren
id|saa-&gt;interlace
op_ne
l_int|0
op_logical_and
id|height
op_star
l_int|4
op_ge
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
op_logical_and
id|height
op_star
l_int|2
op_le
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
)paren
(brace
id|vdma2-&gt;base_odd
op_assign
id|vdma2-&gt;prot_addr
suffix:semicolon
id|vdma2-&gt;pitch
op_assign
id|clip_pitch
suffix:semicolon
id|vdma2-&gt;num_line_byte
op_assign
(paren
(paren
(paren
id|height
)paren
op_minus
l_int|1
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|clip_pitch
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|vdma2-&gt;base_odd
op_assign
id|clip_addr
op_plus
id|clip_pitch
suffix:semicolon
id|vdma2-&gt;pitch
op_assign
id|clip_pitch
op_star
l_int|2
suffix:semicolon
id|vdma2-&gt;num_line_byte
op_assign
(paren
(paren
(paren
id|height
op_div
l_int|2
)paren
op_minus
l_int|1
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|clip_pitch
op_minus
l_int|1
)paren
suffix:semicolon
)brace
op_star
id|clip_format
op_and_assign
l_int|0xfffffff7
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* helper functions for emulate rect-clipping via mask-clipping.&n;   note: these are extremely inefficient, but for clipping with less than 16&n;   windows rect-clipping should be done anyway...&n;*/
multiline_comment|/* clear one pixel of the clipping memory at position (x,y) */
DECL|function|set_pixel
r_void
id|set_pixel
c_func
(paren
id|s32
id|x
comma
id|s32
id|y
comma
id|s32
id|window_width
comma
id|u32
op_star
id|mem
)paren
(brace
id|u32
id|mem_per_row
op_assign
l_int|0
suffix:semicolon
id|u32
id|adr
op_assign
l_int|0
suffix:semicolon
id|u32
id|shift
op_assign
l_int|0
suffix:semicolon
id|u32
id|bit
op_assign
l_int|0
suffix:semicolon
id|mem_per_row
op_assign
(paren
id|window_width
op_plus
l_int|31
)paren
op_div
l_int|32
suffix:semicolon
id|adr
op_assign
id|y
op_star
id|mem_per_row
op_plus
(paren
id|x
op_div
l_int|32
)paren
suffix:semicolon
id|shift
op_assign
l_int|31
op_minus
(paren
id|x
op_mod
l_int|32
)paren
suffix:semicolon
id|bit
op_assign
(paren
l_int|1
op_lshift
id|shift
)paren
suffix:semicolon
id|mem
(braket
id|adr
)braket
op_or_assign
id|bit
suffix:semicolon
)brace
multiline_comment|/* clear a box out of the clipping memory, beginning at (x,y) with &quot;width&quot; and &quot;height&quot; */
DECL|function|set_box
r_void
id|set_box
c_func
(paren
id|s32
id|x
comma
id|s32
id|y
comma
id|s32
id|width
comma
id|s32
id|height
comma
id|s32
id|window_width
comma
id|s32
id|window_height
comma
id|u32
op_star
id|mem
)paren
(brace
id|s32
id|ty
op_assign
l_int|0
suffix:semicolon
id|s32
id|tx
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* the video_clip-struct may contain negative values to indicate that a window&n;&t;   doesn&squot;t lay completly over the video window. Thus, we correct the values */
r_if
c_cond
(paren
id|width
OL
l_int|0
)paren
(brace
id|x
op_add_assign
id|width
suffix:semicolon
id|width
op_assign
op_minus
id|width
suffix:semicolon
)brace
r_if
c_cond
(paren
id|height
OL
l_int|0
)paren
(brace
id|y
op_add_assign
id|height
suffix:semicolon
id|height
op_assign
op_minus
id|height
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
OL
l_int|0
)paren
(brace
id|width
op_add_assign
id|x
suffix:semicolon
id|x
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y
OL
l_int|0
)paren
(brace
id|height
op_add_assign
id|y
suffix:semicolon
id|y
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|width
op_le
l_int|0
op_logical_or
id|height
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; set_box: sanity error!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_plus
id|width
OG
id|window_width
)paren
(brace
id|width
op_sub_assign
(paren
id|x
op_plus
id|width
)paren
op_minus
id|window_width
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y
op_plus
id|height
OG
id|window_height
)paren
(brace
id|height
op_sub_assign
(paren
id|y
op_plus
id|height
)paren
op_minus
id|window_height
suffix:semicolon
)brace
multiline_comment|/* Now, set a &squot;1&squot; in the memory, where no video picture should appear */
r_for
c_loop
(paren
id|ty
op_assign
id|y
suffix:semicolon
id|ty
OL
id|y
op_plus
id|height
suffix:semicolon
id|ty
op_increment
)paren
(brace
r_for
c_loop
(paren
id|tx
op_assign
id|x
suffix:semicolon
id|tx
OL
id|x
op_plus
id|width
suffix:semicolon
id|tx
op_increment
)paren
(brace
id|set_pixel
c_func
(paren
id|tx
comma
id|ty
comma
id|window_width
comma
id|mem
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|emulate_rect_clipping
r_int
id|emulate_rect_clipping
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u16
id|clipcount
comma
r_int
id|x
(braket
)braket
comma
r_int
id|y
(braket
)braket
comma
r_int
id|w
(braket
)braket
comma
r_int
id|h
(braket
)braket
comma
id|u32
id|w_width
comma
id|u32
id|w_height
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* clear out clipping mem */
id|memset
c_func
(paren
id|saa-&gt;clipping
comma
l_int|0x0
comma
id|CLIPPING_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* go through list of clipping-windows, clear out rectangular-regions in the clipping memory */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|clipcount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_box
c_func
(paren
id|x
(braket
id|i
)braket
comma
id|y
(braket
id|i
)braket
comma
id|w
(braket
id|i
)braket
comma
id|h
(braket
id|i
)braket
comma
id|w_width
comma
id|w_height
comma
id|saa-&gt;clipping
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* rectangle-clipping&t;&t;&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
DECL|macro|MIN
mdefine_line|#define MIN(x,y)&t;( ((x) &lt; (y)) ? (x) : (y) )
DECL|macro|MAX
mdefine_line|#define MAX(x,y)&t;( ((x) &gt; (y)) ? (x) : (y) )
multiline_comment|/* simple double-sort algorithm with duplicate elimination */
DECL|function|sort_and_eliminate
r_int
id|sort_and_eliminate
c_func
(paren
id|u32
op_star
id|values
comma
r_int
op_star
id|count
)paren
(brace
r_int
id|low
op_assign
l_int|0
comma
id|high
op_assign
l_int|0
comma
id|top
op_assign
l_int|0
comma
id|temp
op_assign
l_int|0
suffix:semicolon
r_int
id|cur
op_assign
l_int|0
comma
id|next
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
(paren
l_int|0
OG
op_star
id|count
)paren
op_logical_or
(paren
l_int|NULL
op_eq
id|values
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; sort_and_eliminate: internal error #1&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* bubble sort the first &#xfffd;count&#xfffd; items of the array &#xfffd;values&#xfffd; */
r_for
c_loop
(paren
id|top
op_assign
op_star
id|count
suffix:semicolon
id|top
OG
l_int|0
suffix:semicolon
id|top
op_decrement
)paren
(brace
r_for
c_loop
(paren
id|low
op_assign
l_int|0
comma
id|high
op_assign
l_int|1
suffix:semicolon
id|high
OL
id|top
suffix:semicolon
id|low
op_increment
comma
id|high
op_increment
)paren
(brace
r_if
c_cond
(paren
id|values
(braket
id|low
)braket
OG
id|values
(braket
id|high
)braket
)paren
(brace
id|temp
op_assign
id|values
(braket
id|low
)braket
suffix:semicolon
id|values
(braket
id|low
)braket
op_assign
id|values
(braket
id|high
)braket
suffix:semicolon
id|values
(braket
id|high
)braket
op_assign
id|temp
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* remove duplicate items */
r_for
c_loop
(paren
id|cur
op_assign
l_int|0
comma
id|next
op_assign
l_int|1
suffix:semicolon
id|next
OL
op_star
id|count
suffix:semicolon
id|next
op_increment
)paren
(brace
r_if
c_cond
(paren
id|values
(braket
id|cur
)braket
op_ne
id|values
(braket
id|next
)braket
)paren
(brace
id|values
(braket
op_increment
id|cur
)braket
op_assign
id|values
(braket
id|next
)braket
suffix:semicolon
)brace
)brace
op_star
id|count
op_assign
id|cur
op_plus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|calculate_clipping_registers_rect
r_int
id|calculate_clipping_registers_rect
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|clipcount
comma
r_int
id|x
(braket
)braket
comma
r_int
id|y
(braket
)braket
comma
r_int
id|w
(braket
)braket
comma
r_int
id|h
(braket
)braket
comma
id|u32
id|width
comma
id|u32
id|height
comma
r_struct
id|saa7146_video_dma
op_star
id|vdma2
comma
id|u32
op_star
id|clip_format
comma
id|u32
op_star
id|arbtr_ctrl
)paren
(brace
id|u32
id|line_list
(braket
l_int|32
)braket
suffix:semicolon
id|u32
id|pixel_list
(braket
l_int|32
)braket
suffix:semicolon
id|u32
id|numdwords
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
r_int
id|l
op_assign
l_int|0
comma
id|r
op_assign
l_int|0
comma
id|t
op_assign
l_int|0
comma
id|b
op_assign
l_int|0
suffix:semicolon
r_int
id|cnt_line
op_assign
l_int|0
comma
id|cnt_pixel
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; calculate_clipping_registers_clip&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* clear out memory */
id|memset
c_func
(paren
op_amp
id|line_list
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|u32
)paren
op_star
l_int|32
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|pixel_list
(braket
l_int|0
)braket
comma
l_int|0x00
comma
r_sizeof
(paren
id|u32
)paren
op_star
l_int|32
)paren
suffix:semicolon
id|memset
c_func
(paren
id|saa-&gt;clipping
comma
l_int|0x00
comma
r_sizeof
(paren
id|u32
)paren
op_star
id|CLIPPING_MEM_SIZE
)paren
suffix:semicolon
multiline_comment|/* fill the line and pixel-lists */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|clipcount
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* calculate values for l(eft), r(ight), t(op), b(ottom) */
id|l
op_assign
id|x
(braket
id|i
)braket
suffix:semicolon
id|r
op_assign
id|x
(braket
id|i
)braket
op_plus
id|w
(braket
id|i
)braket
suffix:semicolon
id|t
op_assign
id|y
(braket
id|i
)braket
suffix:semicolon
id|b
op_assign
id|y
(braket
id|i
)braket
op_plus
id|h
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* insert left/right coordinates */
id|pixel_list
(braket
l_int|2
op_star
id|i
)braket
op_assign
id|MIN
c_func
(paren
id|l
comma
id|width
)paren
suffix:semicolon
id|pixel_list
(braket
(paren
l_int|2
op_star
id|i
)paren
op_plus
l_int|1
)braket
op_assign
id|MIN
c_func
(paren
id|r
comma
id|width
)paren
suffix:semicolon
multiline_comment|/* insert top/bottom coordinates */
id|line_list
(braket
l_int|2
op_star
id|i
)braket
op_assign
id|MIN
c_func
(paren
id|t
comma
id|height
)paren
suffix:semicolon
id|line_list
(braket
(paren
l_int|2
op_star
id|i
)paren
op_plus
l_int|1
)braket
op_assign
id|MIN
c_func
(paren
id|b
comma
id|height
)paren
suffix:semicolon
)brace
multiline_comment|/* sort and eliminate lists */
id|cnt_line
op_assign
id|cnt_pixel
op_assign
l_int|2
op_star
id|clipcount
suffix:semicolon
id|sort_and_eliminate
c_func
(paren
op_amp
id|pixel_list
(braket
l_int|0
)braket
comma
op_amp
id|cnt_pixel
)paren
suffix:semicolon
id|sort_and_eliminate
c_func
(paren
op_amp
id|line_list
(braket
l_int|0
)braket
comma
op_amp
id|cnt_line
)paren
suffix:semicolon
multiline_comment|/* calculate the number of used u32s */
id|numdwords
op_assign
id|MAX
c_func
(paren
(paren
id|cnt_line
op_plus
l_int|1
)paren
comma
(paren
id|cnt_pixel
op_plus
l_int|1
)paren
)paren
op_star
l_int|2
suffix:semicolon
id|numdwords
op_assign
id|MAX
c_func
(paren
l_int|4
comma
id|numdwords
)paren
suffix:semicolon
id|numdwords
op_assign
id|MIN
c_func
(paren
l_int|64
comma
id|numdwords
)paren
suffix:semicolon
multiline_comment|/* fill up cliptable */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt_pixel
suffix:semicolon
id|i
op_increment
)paren
(brace
id|saa-&gt;clipping
(braket
l_int|2
op_star
id|i
)braket
op_or_assign
(paren
id|pixel_list
(braket
id|i
)braket
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt_line
suffix:semicolon
id|i
op_increment
)paren
(brace
id|saa-&gt;clipping
(braket
(paren
l_int|2
op_star
id|i
)paren
op_plus
l_int|1
)braket
op_or_assign
(paren
id|line_list
(braket
id|i
)braket
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
multiline_comment|/* fill up cliptable with the display infos */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|clipcount
suffix:semicolon
id|j
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt_pixel
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|x
(braket
id|j
)braket
OL
l_int|0
)paren
(brace
id|x
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pixel_list
(braket
id|i
)braket
OL
(paren
id|x
(braket
id|j
)braket
op_plus
id|w
(braket
id|j
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|pixel_list
(braket
id|i
)braket
op_ge
id|x
(braket
id|j
)braket
)paren
(brace
id|saa-&gt;clipping
(braket
l_int|2
op_star
id|i
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|j
)paren
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cnt_line
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|y
(braket
id|j
)braket
OL
l_int|0
)paren
(brace
id|y
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|line_list
(braket
id|i
)braket
OL
(paren
id|y
(braket
id|j
)braket
op_plus
id|h
(braket
id|j
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|line_list
(braket
id|i
)braket
op_ge
id|y
(braket
id|j
)braket
)paren
(brace
id|saa-&gt;clipping
(braket
(paren
l_int|2
op_star
id|i
)paren
op_plus
l_int|1
)braket
op_or_assign
(paren
l_int|1
op_lshift
id|j
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* adjust arbitration control register */
op_star
id|arbtr_ctrl
op_and_assign
l_int|0xffff00ff
suffix:semicolon
op_star
id|arbtr_ctrl
op_or_assign
l_int|0x00001c00
suffix:semicolon
id|vdma2-&gt;base_even
op_assign
id|virt_to_bus
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
id|vdma2-&gt;base_odd
op_assign
id|virt_to_bus
c_func
(paren
id|saa-&gt;clipping
)paren
suffix:semicolon
id|vdma2-&gt;prot_addr
op_assign
id|virt_to_bus
c_func
(paren
id|saa-&gt;clipping
)paren
op_plus
(paren
(paren
r_sizeof
(paren
id|u32
)paren
)paren
op_star
(paren
id|numdwords
)paren
)paren
suffix:semicolon
id|vdma2-&gt;base_page
op_assign
l_int|0x04
suffix:semicolon
id|vdma2-&gt;pitch
op_assign
l_int|0x00
suffix:semicolon
id|vdma2-&gt;num_line_byte
op_assign
(paren
l_int|0
op_lshift
l_int|16
op_or
(paren
r_sizeof
(paren
id|u32
)paren
)paren
op_star
(paren
id|numdwords
op_minus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* set clipping-mode. please note again, that for sizes below 1/2, we only use the&n;&t;   even-field. because of this, we have to specify &#xfffd;recinterl&#xfffd; correctly (specs, p. 97)*/
op_star
id|clip_format
op_and_assign
l_int|0xfffffff7
suffix:semicolon
r_if
c_cond
(paren
id|saa-&gt;interlace
op_ne
l_int|0
op_logical_and
id|height
op_star
l_int|4
op_ge
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
op_logical_and
id|height
op_star
l_int|2
op_le
id|modes_constants
(braket
id|saa-&gt;mode
)braket
dot
id|v_calc
)paren
(brace
op_star
id|clip_format
op_or_assign
l_int|0x00000000
suffix:semicolon
)brace
r_else
(brace
op_star
id|clip_format
op_or_assign
l_int|0x00000008
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* main function for clipping&t;&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* arguments:&n;&t;type &t;= see &#xfffd;saa7146.h&#xfffd;&n;&t;width &t;= width of the video-window&n;&t;height &t;= height of the video-window&n;&t;*mask &t;= pointer to mask memory&t;(only needed for mask-clipping)&n;&t;*clips&t;= pointer to clip-window-list   (only needed for rect-clipping)&n;&t;clipcount = # of clip-windows&t;&t;(only needed for rect-clipping)&n;*/
DECL|function|clip_windows
r_int
id|clip_windows
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
id|type
comma
id|u32
id|width
comma
id|u32
id|height
comma
id|u32
op_star
id|mask
comma
id|u16
id|clipcount
comma
r_int
id|x
(braket
)braket
comma
r_int
id|y
(braket
)braket
comma
r_int
id|w
(braket
)braket
comma
r_int
id|h
(braket
)braket
)paren
(brace
r_struct
id|saa7146_video_dma
id|vdma2
suffix:semicolon
id|u32
id|clip_format
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|CLIP_FORMAT_CTRL
)paren
suffix:semicolon
id|u32
id|arbtr_ctrl
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|PCI_BT_V1
)paren
suffix:semicolon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; clip_windows&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* some sanity checks first */
r_if
c_cond
(paren
id|width
op_le
l_int|0
op_logical_or
id|height
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; clip_windows: sanity error #1!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* check if anything to do here, disable clipping if == 0 */
r_if
c_cond
(paren
id|clipcount
op_eq
l_int|0
)paren
(brace
multiline_comment|/* mask out relevant bits (=lower word)*/
id|clip_format
op_and_assign
id|MASK_W1
suffix:semicolon
multiline_comment|/* upload clipping-registers*/
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|CLIP_FORMAT_CTRL
comma
id|clip_format
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_05
op_or
id|MASK_21
)paren
)paren
suffix:semicolon
multiline_comment|/* disable video dma2 */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
(paren
id|MASK_21
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|SAA7146_CLIPPING_MASK_INVERTED
suffix:colon
r_case
id|SAA7146_CLIPPING_MASK
suffix:colon
(brace
id|printk
c_func
(paren
l_string|&quot;mask&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
l_int|NULL
op_eq
id|mask
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; clip_windows: sanity error #1!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* copy the clipping mask to structure */
id|memmove
c_func
(paren
id|saa-&gt;clipping
comma
id|mask
comma
id|CLIPPING_MEM_SIZE
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
multiline_comment|/* set clipping registers */
id|calculate_clipping_registers_mask
c_func
(paren
id|saa
comma
id|width
comma
id|height
comma
op_amp
id|vdma2
comma
op_amp
id|clip_format
comma
op_amp
id|arbtr_ctrl
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SAA7146_CLIPPING_RECT_INVERTED
suffix:colon
r_case
id|SAA7146_CLIPPING_RECT
suffix:colon
(brace
multiline_comment|/* see if we have anything to do */
r_if
c_cond
(paren
l_int|0
op_eq
id|clipcount
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* sanity check */
r_if
c_cond
(paren
l_int|NULL
op_eq
id|x
op_logical_or
l_int|NULL
op_eq
id|y
op_logical_or
l_int|NULL
op_eq
id|w
op_logical_or
l_int|NULL
op_eq
id|h
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; clip_windows: sanity error #2!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* rectangle clipping can only handle 16 overlay windows; if we&n;&t;&t;&t;   have more, we have do emulate the whole thing with mask-clipping */
r_if
c_cond
(paren
l_int|1
)paren
(brace
singleline_comment|//clipcount &gt;  &gt; 16 ) {
singleline_comment|//printk(&quot;emulate&bslash;n&quot;);
id|emulate_rect_clipping
c_func
(paren
id|saa
comma
id|clipcount
comma
id|x
comma
id|y
comma
id|w
comma
id|h
comma
id|width
comma
id|height
)paren
suffix:semicolon
id|calculate_clipping_registers_mask
c_func
(paren
id|saa
comma
id|width
comma
id|height
comma
op_amp
id|vdma2
comma
op_amp
id|clip_format
comma
op_amp
id|arbtr_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SAA7146_CLIPPING_RECT
op_eq
id|type
)paren
(brace
id|type
op_assign
id|SAA7146_CLIPPING_MASK
suffix:semicolon
)brace
r_else
id|type
op_assign
id|SAA7146_CLIPPING_MASK_INVERTED
suffix:semicolon
)brace
r_else
(brace
id|calculate_clipping_registers_rect
c_func
(paren
id|saa
comma
id|clipcount
comma
id|x
comma
id|y
comma
id|w
comma
id|h
comma
id|width
comma
id|height
comma
op_amp
id|vdma2
comma
op_amp
id|clip_format
comma
op_amp
id|arbtr_ctrl
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
(brace
)brace
(brace
id|printk
c_func
(paren
l_string|&quot;saa7146: ==&gt; clip_windows: internal error #1!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* set clipping format */
id|clip_format
op_and_assign
l_int|0xffff0008
suffix:semicolon
id|clip_format
op_or_assign
(paren
id|type
op_lshift
l_int|4
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|BASE_EVEN2
comma
id|vdma2.base_even
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|BASE_ODD2
comma
id|vdma2.base_odd
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|PROT_ADDR2
comma
id|vdma2.prot_addr
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|BASE_PAGE2
comma
id|vdma2.base_page
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|PITCH2
comma
id|vdma2.pitch
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|NUM_LINE_BYTE2
comma
id|vdma2.num_line_byte
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|CLIP_FORMAT_CTRL
comma
id|clip_format
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|PCI_BT_V1
comma
id|arbtr_ctrl
)paren
suffix:semicolon
multiline_comment|/* upload clip_control-register, clipping-registers, enable video dma2 */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_05
op_or
id|MASK_21
op_or
id|MASK_03
op_or
id|MASK_19
)paren
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC1
comma
(paren
id|MASK_05
op_or
id|MASK_21
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;       &t;printk(&quot;ARBTR_CTRL:     0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, PCI_BT_V1));&n;       &t;printk(&quot;CLIP_FORMAT:    0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, CLIP_FORMAT_CTRL));&n;        printk(&quot;BASE_ODD1:      0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, BASE_ODD1));&n;        printk(&quot;BASE_EVEN1:     0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, BASE_EVEN1));&n;        printk(&quot;PROT_ADDR1:     0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, PROT_ADDR1));&n;        printk(&quot;PITCH1:         0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, PITCH1));&n;        printk(&quot;BASE_PAGE1:     0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, BASE_PAGE1));&n;        printk(&quot;NUM_LINE_BYTE1: 0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, NUM_LINE_BYTE1));&n;        printk(&quot;BASE_ODD2:      0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, BASE_ODD2));&n;        printk(&quot;BASE_EVEN2:     0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, BASE_EVEN2));&n;        printk(&quot;PROT_ADDR2:     0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, PROT_ADDR2));&n;        printk(&quot;PITCH2:         0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, PITCH2));&n;        printk(&quot;BASE_PAGE2:     0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, BASE_PAGE2));&n;        printk(&quot;NUM_LINE_BYTE2: 0x%08x&bslash;n&quot;,saa7146_read(saa-&gt;mem, NUM_LINE_BYTE2));&n;*/
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef __COMPILE_SAA7146_I2C__
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* i2c-helper functions&t;&t;&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* this functions gets the status from the saa7146 at address &squot;addr&squot;&n;   and returns it */
DECL|function|i2c_status_check
id|u32
id|i2c_status_check
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
id|u32
id|iicsta
op_assign
l_int|0
suffix:semicolon
id|iicsta
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_STATUS
)paren
suffix:semicolon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; i2c_status_check:0x%08x&bslash;n&quot;
comma
id|iicsta
)paren
suffix:semicolon
r_return
id|iicsta
suffix:semicolon
)brace
multiline_comment|/* this function should be called after an i2c-command has been written. &n;   if we are debugging, it checks, if the busy flags rises and falls correctly&n;   and reports a timeout (-1) or the error-bits set like in described in the specs,&n;   p.123, table 110 */
DECL|function|i2c_busy_rise_and_fall
r_int
id|i2c_busy_rise_and_fall
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|timeout
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; i2c_busy_rise_and_fall&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* wait until busy-flag rises */
r_for
c_loop
(paren
id|i
op_assign
l_int|5
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_busy_rise_and_fall; rise wait %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|status
op_assign
id|i2c_status_check
c_func
(paren
id|saa
)paren
suffix:semicolon
multiline_comment|/* check busy flag */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|status
op_amp
id|SAA7146_I2C_BUSY
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* see if anything can be done while we&squot;re waiting */
id|cond_resched
(paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* we don&squot;t check the i-value, since it does not matter&n;&t;   if we missed the rise of the busy flag or the fall or&n;&t;   whatever. we just have to wait some undefined time&n;&t;   after an i2c-command has been written out */
multiline_comment|/* wait until busy-flag is inactive or error is reported */
r_for
c_loop
(paren
id|i
op_assign
id|timeout
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_busy_rise_and_fall; fall wait %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|status
op_assign
id|i2c_status_check
c_func
(paren
id|saa
)paren
suffix:semicolon
multiline_comment|/* check busy flag */
r_if
c_cond
(paren
l_int|0
op_eq
(paren
id|status
op_amp
id|SAA7146_I2C_BUSY
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* check error flag */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|status
op_amp
id|SAA7146_I2C_ERR
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* see if anything can be done while we&squot;re waiting */
id|cond_resched
(paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* did a timeout occur ? */
r_if
c_cond
(paren
l_int|0
op_eq
id|i
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_busy_rise_and_fall: timeout #2&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* report every error pending */
r_switch
c_cond
(paren
id|status
op_amp
l_int|0xfc
)paren
(brace
r_case
id|SAA7146_I2C_SPERR
suffix:colon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_busy_rise_and_fall: error due to invalid start/stop condition&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA7146_I2C_APERR
suffix:colon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_busy_rise_and_fall: error in address phase&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA7146_I2C_DTERR
suffix:colon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_busy_rise_and_fall: error in data transmission&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA7146_I2C_DRERR
suffix:colon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_busy_rise_and_fall: error when receiving data&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA7146_I2C_AL
suffix:colon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_busy_rise_and_fall: error because arbitration lost&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* this functions resets the saa7146 at address &squot;addr&squot;&n;   and returns 0 if everything was fine, otherwise -1 */
DECL|function|i2c_reset
r_int
id|i2c_reset
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
)paren
(brace
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; i2c_reset&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
id|i2c_status_check
c_func
(paren
id|saa
)paren
suffix:semicolon
multiline_comment|/* clear data-byte for sure */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_TRANSFER
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* check if any operation is still in progress */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|status
op_amp
id|SAA7146_I2C_BUSY
)paren
)paren
(brace
multiline_comment|/* Yes, kill ongoing operation */
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_reset: busy_state detected&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* set ABORT-OPERATION-bit */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_STATUS
comma
(paren
id|SAA7146_I2C_BBR
op_or
id|MASK_07
)paren
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_00
op_or
id|MASK_16
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|SAA7146_I2C_DELAY
)paren
suffix:semicolon
multiline_comment|/* clear all error-bits pending; this is needed because p.123, note 1 */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_STATUS
comma
id|SAA7146_I2C_BBR
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_00
op_or
id|MASK_16
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|SAA7146_I2C_DELAY
)paren
suffix:semicolon
)brace
multiline_comment|/* check if any other error is still present */
r_if
c_cond
(paren
id|SAA7146_I2C_BBR
op_ne
(paren
id|status
op_assign
id|i2c_status_check
c_func
(paren
id|saa
)paren
)paren
)paren
(brace
multiline_comment|/* yes, try to kick it */
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_reset: error_state detected, status:0x%08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* clear all error-bits pending */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_STATUS
comma
id|SAA7146_I2C_BBR
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_00
op_or
id|MASK_16
)paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|SAA7146_I2C_DELAY
)paren
suffix:semicolon
multiline_comment|/* the data sheet says it might be necessary to clear the status&n;&t;&t;   twice after an abort */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_STATUS
comma
id|SAA7146_I2C_BBR
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_00
op_or
id|MASK_16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* if any error is still present, a fatal error has occured ... */
r_if
c_cond
(paren
id|SAA7146_I2C_BBR
op_ne
(paren
id|status
op_assign
id|i2c_status_check
c_func
(paren
id|saa
)paren
)paren
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_reset: fatal error, status:0x%08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* this functions writes out the data-bytes at &squot;data&squot; to the saa7146&n;   at address &squot;addr&squot; regarding the &squot;timeout&squot; and &squot;retries&squot; values;&n;   it returns 0 if ok, -1 if the transfer failed, -2 if the transfer&n;   failed badly (e.g. address error) */
DECL|function|i2c_write_out
r_int
id|i2c_write_out
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u32
op_star
id|data
comma
r_int
id|timeout
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: ==&gt; writeout: 0x%08x (before) (to:%d)&bslash;n&quot;
comma
op_star
id|data
comma
id|timeout
)paren
suffix:semicolon
multiline_comment|/* write out i2c-command */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_TRANSFER
comma
op_star
id|data
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_STATUS
comma
id|SAA7146_I2C_BBR
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_00
op_or
id|MASK_16
)paren
)paren
suffix:semicolon
multiline_comment|/* after writing out an i2c-command we have to wait for a while;&n;&t;   because we do not know, how long we have to wait, we simply look&n;&t;   what the busy-flag is doing, before doing something else */
multiline_comment|/* reason: while fiddling around with the i2c-routines, I noticed&n;&t;   that after writing out an i2c-command, one may not read out the&n;&t;   status immediately after that. you *must* wait some time, before&n;&t;   even the busy-flag gets set */
id|status
op_assign
id|i2c_busy_rise_and_fall
c_func
(paren
id|saa
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
op_minus
l_int|1
op_eq
id|status
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_write_out; timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/* we only handle address-errors here */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|status
op_amp
id|SAA7146_I2C_APERR
)paren
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_write_out; error in address phase&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
)brace
multiline_comment|/* check for some other mysterious error; we don&squot;t handle this here */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|status
op_amp
l_int|0xff
)paren
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: i2c_write_out: some error has occured&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* read back data, just in case we were reading ... */
op_star
id|data
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|I2C_TRANSFER
)paren
suffix:semicolon
id|hprintk
c_func
(paren
l_string|&quot;saa7146: writeout: 0x%08x (after)&bslash;n&quot;
comma
op_star
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|clean_up
r_int
id|clean_up
c_func
(paren
r_struct
id|i2c_msg
id|m
(braket
)braket
comma
r_int
id|num
comma
id|u32
op_star
id|op
)paren
(brace
id|u16
id|i
comma
id|j
suffix:semicolon
id|u16
id|op_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* loop through all messages */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|op_count
op_increment
suffix:semicolon
multiline_comment|/* loop throgh all bytes of message i */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|m
(braket
id|i
)braket
dot
id|len
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* write back all bytes that could have been read */
id|m
(braket
id|i
)braket
dot
id|buf
(braket
id|j
)braket
op_assign
(paren
id|op
(braket
id|op_count
op_div
l_int|3
)braket
op_rshift
(paren
(paren
l_int|3
op_minus
(paren
id|op_count
op_mod
l_int|3
)paren
)paren
op_star
l_int|8
)paren
)paren
suffix:semicolon
id|op_count
op_increment
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|prepare
r_int
id|prepare
c_func
(paren
r_struct
id|i2c_msg
id|m
(braket
)braket
comma
r_int
id|num
comma
id|u32
op_star
id|op
)paren
(brace
id|u16
id|h1
comma
id|h2
suffix:semicolon
id|u16
id|i
comma
id|j
comma
id|addr
suffix:semicolon
id|u16
id|mem
op_assign
l_int|0
comma
id|op_count
op_assign
l_int|0
suffix:semicolon
singleline_comment|//for (i=0; i&lt;num; i++) { printk (&quot;&bslash;n%02x (%s): &quot;, m[i].addr, m[i].flags &amp; I2C_M_RD ? &quot;R&quot; : &quot;W&quot;); for (j=0; j&lt;m[i].len; j++) { m[i].buf[j] &amp;= 0xff; printk (&quot; %02x &quot;, (u8) m[i].buf[j]); } } printk (&quot;&bslash;n&quot;);
multiline_comment|/* determine size of needed memory */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mem
op_add_assign
id|m
(braket
id|i
)braket
dot
id|len
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* we need one u32 for three bytes to be send plus&n;&t;   one byte to address the device */
id|mem
op_assign
l_int|1
op_plus
(paren
(paren
id|mem
op_minus
l_int|1
)paren
op_div
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
OG
id|I2C_MEM_SIZE
)paren
(brace
id|hprintk
c_func
(paren
l_string|&quot;saa7146: prepare: i2c-message to big&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* be careful: clear out the i2c-mem first */
id|memset
c_func
(paren
id|op
comma
l_int|0
comma
r_sizeof
(paren
id|u32
)paren
op_star
id|mem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* insert the address of the i2c-slave.&n;&t;&t; * note: we get 7-bit-i2c-addresses,&n;&t;&t; * so we have to perform a translation&n;&t;&t; */
id|addr
op_assign
(paren
id|m
(braket
id|i
)braket
dot
id|addr
op_lshift
l_int|1
)paren
op_or
(paren
(paren
id|m
(braket
id|i
)braket
dot
id|flags
op_amp
id|I2C_M_RD
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|h1
op_assign
id|op_count
op_div
l_int|3
suffix:semicolon
id|h2
op_assign
id|op_count
op_mod
l_int|3
suffix:semicolon
id|op
(braket
id|h1
)braket
op_or_assign
(paren
(paren
id|u8
)paren
id|addr
op_lshift
(paren
(paren
l_int|3
op_minus
id|h2
)paren
op_star
l_int|8
)paren
)paren
suffix:semicolon
id|op
(braket
id|h1
)braket
op_or_assign
(paren
id|SAA7146_I2C_START
op_lshift
(paren
(paren
l_int|3
op_minus
id|h2
)paren
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|op_count
op_increment
suffix:semicolon
multiline_comment|/* loop through all bytes of message i */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|m
(braket
id|i
)braket
dot
id|len
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* insert the data bytes */
id|h1
op_assign
id|op_count
op_div
l_int|3
suffix:semicolon
id|h2
op_assign
id|op_count
op_mod
l_int|3
suffix:semicolon
id|op
(braket
id|h1
)braket
op_or_assign
(paren
(paren
id|u8
)paren
id|m
(braket
id|i
)braket
dot
id|buf
(braket
id|j
)braket
op_lshift
(paren
(paren
l_int|3
op_minus
id|h2
)paren
op_star
l_int|8
)paren
)paren
suffix:semicolon
id|op
(braket
id|h1
)braket
op_or_assign
(paren
id|SAA7146_I2C_CONT
op_lshift
(paren
(paren
l_int|3
op_minus
id|h2
)paren
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|op_count
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* have a look at the last byte inserted:&n;&t; * if it was: ...CONT change it to ...STOP&n;&t; */
id|h1
op_assign
(paren
id|op_count
op_minus
l_int|1
)paren
op_div
l_int|3
suffix:semicolon
id|h2
op_assign
(paren
id|op_count
op_minus
l_int|1
)paren
op_mod
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|SAA7146_I2C_CONT
op_eq
(paren
l_int|0x3
op_amp
(paren
(paren
id|op
(braket
id|h1
)braket
)paren
op_rshift
(paren
(paren
l_int|3
op_minus
id|h2
)paren
op_star
l_int|2
)paren
)paren
)paren
)paren
(brace
id|op
(braket
id|h1
)braket
op_and_assign
op_complement
(paren
l_int|0x2
op_lshift
(paren
(paren
l_int|3
op_minus
id|h2
)paren
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|op
(braket
id|h1
)braket
op_or_assign
(paren
id|SAA7146_I2C_STOP
op_lshift
(paren
(paren
l_int|3
op_minus
id|h2
)paren
op_star
l_int|2
)paren
)paren
suffix:semicolon
)brace
r_return
id|mem
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef __COMPILE_SAA7146_DEBI__
multiline_comment|/* functions for accessing the debi-port. note: we currently don&squot;t support &n; * page-table-transfers.&n; */
DECL|macro|MY_DEBI_TIMEOUT_MS
mdefine_line|#define MY_DEBI_TIMEOUT_MS 5
DECL|function|debi_transfer
r_int
id|debi_transfer
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_struct
id|saa7146_debi_transfer
op_star
id|dt
)paren
(brace
id|u32
id|debi_config
op_assign
l_int|0
comma
id|debi_command
op_assign
l_int|0
comma
id|debi_page
op_assign
l_int|0
comma
id|debi_ad
op_assign
l_int|0
suffix:semicolon
id|u32
id|timeout
op_assign
id|MY_DEBI_TIMEOUT_MS
suffix:semicolon
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
id|dt-&gt;direction
OG
l_int|1
op_logical_or
id|dt-&gt;timeout
OG
l_int|15
op_logical_or
id|dt-&gt;swap
OG
l_int|3
op_logical_or
id|dt-&gt;slave16
OG
l_int|2
op_logical_or
id|dt-&gt;intel
OG
l_int|1
op_logical_or
id|dt-&gt;increment
OG
l_int|1
op_logical_or
id|dt-&gt;tien
OG
l_int|1
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|debi_page
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* keep bits 31,30,28 clear */
id|debi_config
op_assign
(paren
id|dt-&gt;timeout
op_lshift
l_int|22
)paren
op_or
(paren
id|dt-&gt;swap
op_lshift
l_int|20
)paren
op_or
(paren
id|dt-&gt;slave16
op_lshift
l_int|19
)paren
op_or
(paren
id|dt-&gt;increment
op_lshift
l_int|18
)paren
op_or
(paren
id|dt-&gt;intel
op_lshift
l_int|17
)paren
op_or
(paren
id|dt-&gt;tien
op_lshift
l_int|16
)paren
suffix:semicolon
id|debi_command
op_assign
(paren
id|dt-&gt;num_bytes
op_lshift
l_int|17
)paren
op_or
(paren
id|dt-&gt;direction
op_lshift
l_int|16
)paren
op_or
(paren
id|dt-&gt;address
op_lshift
l_int|0
)paren
suffix:semicolon
id|debi_ad
op_assign
id|dt-&gt;mem
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|DEBI_PAGE
comma
id|debi_page
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|DEBI_CONFIG
comma
id|debi_config
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|DEBI_COMMAND
comma
id|debi_command
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|DEBI_AD
comma
id|debi_ad
)paren
suffix:semicolon
multiline_comment|/* upload debi-registers */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_01
op_or
id|MASK_17
)paren
)paren
suffix:semicolon
multiline_comment|/* wait for DEBI upload to complete */
r_while
c_loop
(paren
op_logical_neg
(paren
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
)paren
op_amp
l_int|0x2
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|timeout
)paren
(brace
multiline_comment|/* check, if DEBI still active */
id|u32
id|psr
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|PSR
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|psr
op_amp
id|SPCI_DEBI_S
)paren
)paren
(brace
multiline_comment|/* check, if error occured */
multiline_comment|/*&t;&t;&t;if ( 0 != (saa7146_read(saa-&gt;mem, SSR) &amp; (MASK_23|MASK_22))) { */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|SSR
)paren
op_amp
(paren
id|MASK_22
)paren
)paren
)paren
(brace
multiline_comment|/* clear error status and indicate error */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|ISR
comma
id|SPCI_DEBI_E
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Clear status bit */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|ISR
comma
id|SPCI_DEBI_S
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* I don&#xfffd;t know how we should actually wait for the debi to have finished.&n;&t;&t;   we simply wait 1ms here and then check in a loop for max. MY_DEBI_TIMEOUT_MS */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* check for timeout */
r_if
c_cond
(paren
l_int|0
op_eq
id|timeout
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* read back data if we did immediate read-transfer */
r_if
c_cond
(paren
id|dt-&gt;num_bytes
op_le
l_int|4
op_logical_and
id|dt-&gt;direction
op_eq
l_int|1
)paren
(brace
id|dt-&gt;mem
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|DEBI_AD
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dt-&gt;num_bytes
)paren
(brace
r_case
l_int|1
suffix:colon
id|dt-&gt;mem
op_and_assign
l_int|0x000000ff
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|dt-&gt;mem
op_and_assign
l_int|0x0000ffff
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|dt-&gt;mem
op_and_assign
l_int|0x00ffffff
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef __COMPILE_SAA7146_STUFF__
multiline_comment|/* ---------------------------------------------*/
multiline_comment|/* helper-function: set gpio-pins&t;&t;*/
multiline_comment|/* ---------------------------------------------*/
DECL|function|gpio_set
r_void
id|gpio_set
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
id|u8
id|pin
comma
id|u8
id|data
)paren
(brace
id|u32
id|value
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|pin
OG
l_int|3
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* read old register contents */
id|value
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|GPIO_CTRL
)paren
suffix:semicolon
id|value
op_and_assign
op_complement
(paren
l_int|0xff
op_lshift
(paren
l_int|8
op_star
id|pin
)paren
)paren
suffix:semicolon
id|value
op_or_assign
(paren
id|data
op_lshift
(paren
l_int|8
op_star
id|pin
)paren
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|GPIO_CTRL
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|select_input
r_void
id|select_input
c_func
(paren
r_struct
id|saa7146
op_star
id|saa
comma
r_int
id|p
)paren
(brace
id|u32
id|hps_ctrl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|p
template_param
l_int|1
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* read old state */
id|hps_ctrl
op_assign
id|saa7146_read
c_func
(paren
id|saa-&gt;mem
comma
id|HPS_CTRL
)paren
suffix:semicolon
multiline_comment|/* mask out relevant bits */
id|hps_ctrl
op_and_assign
op_complement
(paren
id|MASK_31
op_or
id|MASK_30
op_or
id|MASK_28
)paren
suffix:semicolon
multiline_comment|/* set bits for input b */
r_if
c_cond
(paren
l_int|1
op_eq
id|p
)paren
(brace
id|hps_ctrl
op_or_assign
(paren
(paren
l_int|1
op_lshift
l_int|30
)paren
op_or
(paren
l_int|1
op_lshift
l_int|28
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* write back &amp; upload register */
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|HPS_CTRL
comma
id|hps_ctrl
)paren
suffix:semicolon
id|saa7146_write
c_func
(paren
id|saa-&gt;mem
comma
id|MC2
comma
(paren
id|MASK_05
op_or
id|MASK_21
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
