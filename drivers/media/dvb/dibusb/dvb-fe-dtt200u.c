multiline_comment|/*&n; * dvb-dtt200u-fe.c is a driver which implements the frontend-part of the&n; * Yakumo/Typhoon/Hama USB2.0 boxes. It is hard-wired to the dibusb-driver as&n; * it uses the usb-transfer functions directly (maybe creating a&n; * generic-dvb-usb-lib for all usb-drivers will be reduce some more code.)&n; *&n; * Copyright (C) 2005 Patrick Boettcher &lt;patrick.boettcher@desy.de&gt;&n; *&n; * see dvb-dibusb-core.c for copyright details.&n; */
multiline_comment|/* guessed protocol description (reverse engineered):&n; * read&n; *  00 - USB type 0x02 for usb2.0, 0x01 for usb1.1&n; *  81 - &lt;TS_LOCK&gt; &lt;current frequency divided by 250000&gt;&n; *  82 - crash - do not touch&n; *  83 - crash - do not touch&n; *  84 - remote control&n; *  85 - crash - do not touch (OK, stop testing here)&n; *  88 - locking 2 bytes (0x80 0x40 == no signal, 0x89 0x20 == nice signal)&n; *  89 - noise-to-signal&n; *&t;8a - unkown 1 byte - signal_strength&n; *  8c - ber ???&n; *  8d - ber&n; *  8e - unc&n; *&n; * write&n; *  02 - bandwidth&n; *  03 - frequency (divided by 250000)&n; *  04 - pid table (index pid(7:0) pid(12:8))&n; *  05 - reset the pid table&n; *  08 - demod transfer enabled or not (FX2 transfer is enabled by default)&n; */
macro_line|#include &quot;dvb-dibusb.h&quot;
macro_line|#include &quot;dvb_frontend.h&quot;
DECL|struct|dtt200u_fe_state
r_struct
id|dtt200u_fe_state
(brace
DECL|member|dib
r_struct
id|usb_dibusb
op_star
id|dib
suffix:semicolon
DECL|member|fep
r_struct
id|dvb_frontend_parameters
id|fep
suffix:semicolon
DECL|member|frontend
r_struct
id|dvb_frontend
id|frontend
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|moan
mdefine_line|#define moan(which,what) info(&quot;unexpected value in &squot;%s&squot; for cmd &squot;%02x&squot; - please report to linux-dvb@linuxtv.org&quot;,which,what)
DECL|function|dtt200u_fe_read_status
r_static
r_int
id|dtt200u_fe_read_status
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
id|fe_status_t
op_star
id|stat
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u8
id|bw
(braket
l_int|1
)braket
op_assign
(brace
l_int|0x81
)brace
suffix:semicolon
id|u8
id|br
(braket
l_int|3
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
singleline_comment|//&t;u8 bdeb[5] = { 0 };
id|dibusb_readwrite_usb
c_func
(paren
id|state-&gt;dib
comma
id|bw
comma
l_int|1
comma
id|br
comma
l_int|3
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|br
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0x01
suffix:colon
op_star
id|stat
op_assign
id|FE_HAS_SIGNAL
op_or
id|FE_HAS_CARRIER
op_or
id|FE_HAS_VITERBI
op_or
id|FE_HAS_SYNC
op_or
id|FE_HAS_LOCK
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x00
suffix:colon
op_star
id|stat
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|moan
c_func
(paren
l_string|&quot;br[0]&quot;
comma
l_int|0x81
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|//&t;bw[0] = 0x88;
singleline_comment|//&t;dibusb_readwrite_usb(state-&gt;dib,bw,1,bdeb,5);
singleline_comment|//&t;deb_info(&quot;%02x: %02x %02x %02x %02x %02x&bslash;n&quot;,bw[0],bdeb[0],bdeb[1],bdeb[2],bdeb[3],bdeb[4]);
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fe_read_ber
r_static
r_int
id|dtt200u_fe_read_ber
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
id|u32
op_star
id|ber
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u8
id|bw
(braket
l_int|1
)braket
op_assign
(brace
l_int|0x8d
)brace
suffix:semicolon
op_star
id|ber
op_assign
l_int|0
suffix:semicolon
id|dibusb_readwrite_usb
c_func
(paren
id|state-&gt;dib
comma
id|bw
comma
l_int|1
comma
(paren
id|u8
op_star
)paren
id|ber
comma
l_int|3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fe_read_unc_blocks
r_static
r_int
id|dtt200u_fe_read_unc_blocks
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
id|u32
op_star
id|unc
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u8
id|bw
(braket
l_int|1
)braket
op_assign
(brace
l_int|0x8c
)brace
suffix:semicolon
op_star
id|unc
op_assign
l_int|0
suffix:semicolon
id|dibusb_readwrite_usb
c_func
(paren
id|state-&gt;dib
comma
id|bw
comma
l_int|1
comma
(paren
id|u8
op_star
)paren
id|unc
comma
l_int|3
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fe_read_signal_strength
r_static
r_int
id|dtt200u_fe_read_signal_strength
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
id|u16
op_star
id|strength
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u8
id|bw
(braket
l_int|1
)braket
op_assign
(brace
l_int|0x8a
)brace
suffix:semicolon
id|u8
id|b
suffix:semicolon
id|dibusb_readwrite_usb
c_func
(paren
id|state-&gt;dib
comma
id|bw
comma
l_int|1
comma
op_amp
id|b
comma
l_int|1
)paren
suffix:semicolon
op_star
id|strength
op_assign
(paren
id|b
op_lshift
l_int|8
)paren
op_or
id|b
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fe_read_snr
r_static
r_int
id|dtt200u_fe_read_snr
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
id|u16
op_star
id|snr
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u8
id|bw
(braket
l_int|1
)braket
op_assign
(brace
l_int|0x89
)brace
suffix:semicolon
id|u8
id|br
(braket
l_int|1
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|dibusb_readwrite_usb
c_func
(paren
id|state-&gt;dib
comma
id|bw
comma
l_int|1
comma
id|br
comma
l_int|1
)paren
suffix:semicolon
op_star
id|snr
op_assign
(paren
(paren
l_int|0xff
op_minus
id|br
(braket
l_int|0
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
l_int|0xff
op_minus
id|br
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fe_init
r_static
r_int
id|dtt200u_fe_init
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u8
id|b
(braket
)braket
op_assign
(brace
l_int|0x01
)brace
suffix:semicolon
r_return
id|dibusb_write_usb
c_func
(paren
id|state-&gt;dib
comma
id|b
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|dtt200u_fe_sleep
r_static
r_int
id|dtt200u_fe_sleep
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
)paren
(brace
r_return
id|dtt200u_fe_init
c_func
(paren
id|fe
)paren
suffix:semicolon
)brace
DECL|function|dtt200u_fe_get_tune_settings
r_static
r_int
id|dtt200u_fe_get_tune_settings
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
r_struct
id|dvb_frontend_tune_settings
op_star
id|tune
)paren
(brace
id|tune-&gt;min_delay_ms
op_assign
l_int|1500
suffix:semicolon
id|tune-&gt;step_size
op_assign
l_int|166667
suffix:semicolon
id|tune-&gt;max_drift
op_assign
l_int|166667
op_star
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fe_set_frontend
r_static
r_int
id|dtt200u_fe_set_frontend
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
r_struct
id|dvb_frontend_parameters
op_star
id|fep
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u16
id|freq
op_assign
id|fep-&gt;frequency
op_div
l_int|250000
suffix:semicolon
id|u8
id|bw
comma
id|bwbuf
(braket
l_int|2
)braket
op_assign
(brace
l_int|0x03
comma
l_int|0
)brace
comma
id|freqbuf
(braket
l_int|3
)braket
op_assign
(brace
l_int|0x02
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|fep-&gt;u.ofdm.bandwidth
)paren
(brace
r_case
id|BANDWIDTH_8_MHZ
suffix:colon
id|bw
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BANDWIDTH_7_MHZ
suffix:colon
id|bw
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BANDWIDTH_6_MHZ
suffix:colon
id|bw
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BANDWIDTH_AUTO
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|deb_info
c_func
(paren
l_string|&quot;set_frontend&bslash;n&quot;
)paren
suffix:semicolon
id|bwbuf
(braket
l_int|1
)braket
op_assign
id|bw
suffix:semicolon
id|dibusb_write_usb
c_func
(paren
id|state-&gt;dib
comma
id|bwbuf
comma
l_int|2
)paren
suffix:semicolon
id|freqbuf
(braket
l_int|1
)braket
op_assign
id|freq
op_amp
l_int|0xff
suffix:semicolon
id|freqbuf
(braket
l_int|2
)braket
op_assign
(paren
id|freq
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dibusb_write_usb
c_func
(paren
id|state-&gt;dib
comma
id|freqbuf
comma
l_int|3
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|state-&gt;fep
comma
id|fep
comma
r_sizeof
(paren
r_struct
id|dvb_frontend_parameters
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fe_get_frontend
r_static
r_int
id|dtt200u_fe_get_frontend
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
r_struct
id|dvb_frontend_parameters
op_star
id|fep
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
id|fe-&gt;demodulator_priv
suffix:semicolon
id|memcpy
c_func
(paren
id|fep
comma
op_amp
id|state-&gt;fep
comma
r_sizeof
(paren
r_struct
id|dvb_frontend_parameters
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fe_release
r_static
r_void
id|dtt200u_fe_release
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
(paren
r_struct
id|dtt200u_fe_state
op_star
)paren
id|fe-&gt;demodulator_priv
suffix:semicolon
id|kfree
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
DECL|function|dtt200u_pid_control
r_static
r_int
id|dtt200u_pid_control
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
r_int
id|index
comma
r_int
id|pid
comma
r_int
id|onoff
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
(paren
r_struct
id|dtt200u_fe_state
op_star
)paren
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u8
id|b_pid
(braket
l_int|4
)braket
suffix:semicolon
id|pid
op_assign
id|onoff
ques
c_cond
id|pid
suffix:colon
l_int|0
suffix:semicolon
id|b_pid
(braket
l_int|0
)braket
op_assign
l_int|0x04
suffix:semicolon
id|b_pid
(braket
l_int|1
)braket
op_assign
id|index
suffix:semicolon
id|b_pid
(braket
l_int|2
)braket
op_assign
id|pid
op_amp
l_int|0xff
suffix:semicolon
id|b_pid
(braket
l_int|3
)braket
op_assign
(paren
id|pid
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dibusb_write_usb
c_func
(paren
id|state-&gt;dib
comma
id|b_pid
comma
l_int|4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dtt200u_fifo_control
r_static
r_int
id|dtt200u_fifo_control
c_func
(paren
r_struct
id|dvb_frontend
op_star
id|fe
comma
r_int
id|onoff
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
(paren
r_struct
id|dtt200u_fe_state
op_star
)paren
id|fe-&gt;demodulator_priv
suffix:semicolon
id|u8
id|b_streaming
(braket
l_int|2
)braket
op_assign
(brace
l_int|0x08
comma
id|onoff
)brace
suffix:semicolon
id|u8
id|b_rst_pid
(braket
l_int|1
)braket
op_assign
(brace
l_int|0x05
)brace
suffix:semicolon
id|dibusb_write_usb
c_func
(paren
id|state-&gt;dib
comma
id|b_streaming
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|onoff
)paren
id|dibusb_write_usb
c_func
(paren
id|state-&gt;dib
comma
id|b_rst_pid
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|dtt200u_fe_ops
r_static
r_struct
id|dvb_frontend_ops
id|dtt200u_fe_ops
suffix:semicolon
DECL|function|dtt200u_fe_attach
r_struct
id|dvb_frontend
op_star
id|dtt200u_fe_attach
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
comma
r_struct
id|dib_fe_xfer_ops
op_star
id|xfer_ops
)paren
(brace
r_struct
id|dtt200u_fe_state
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* allocate memory for the internal state */
id|state
op_assign
(paren
r_struct
id|dtt200u_fe_state
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dtt200u_fe_state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
l_int|NULL
)paren
r_goto
id|error
suffix:semicolon
id|memset
c_func
(paren
id|state
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dtt200u_fe_state
)paren
)paren
suffix:semicolon
id|deb_info
c_func
(paren
l_string|&quot;attaching frontend dtt200u&bslash;n&quot;
)paren
suffix:semicolon
id|state-&gt;dib
op_assign
id|dib
suffix:semicolon
id|state-&gt;frontend.ops
op_assign
op_amp
id|dtt200u_fe_ops
suffix:semicolon
id|state-&gt;frontend.demodulator_priv
op_assign
id|state
suffix:semicolon
id|xfer_ops-&gt;fifo_ctrl
op_assign
id|dtt200u_fifo_control
suffix:semicolon
id|xfer_ops-&gt;pid_ctrl
op_assign
id|dtt200u_pid_control
suffix:semicolon
r_goto
id|success
suffix:semicolon
id|error
suffix:colon
r_return
l_int|NULL
suffix:semicolon
id|success
suffix:colon
r_return
op_amp
id|state-&gt;frontend
suffix:semicolon
)brace
DECL|variable|dtt200u_fe_ops
r_static
r_struct
id|dvb_frontend_ops
id|dtt200u_fe_ops
op_assign
(brace
dot
id|info
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;DTT200U (Yakumo/Typhoon/Hama) DVB-T&quot;
comma
dot
id|type
op_assign
id|FE_OFDM
comma
dot
id|frequency_min
op_assign
l_int|44250000
comma
dot
id|frequency_max
op_assign
l_int|867250000
comma
dot
id|frequency_stepsize
op_assign
l_int|250000
comma
dot
id|caps
op_assign
id|FE_CAN_INVERSION_AUTO
op_or
id|FE_CAN_FEC_1_2
op_or
id|FE_CAN_FEC_2_3
op_or
id|FE_CAN_FEC_3_4
op_or
id|FE_CAN_FEC_5_6
op_or
id|FE_CAN_FEC_7_8
op_or
id|FE_CAN_FEC_AUTO
op_or
id|FE_CAN_QPSK
op_or
id|FE_CAN_QAM_16
op_or
id|FE_CAN_QAM_64
op_or
id|FE_CAN_QAM_AUTO
op_or
id|FE_CAN_TRANSMISSION_MODE_AUTO
op_or
id|FE_CAN_GUARD_INTERVAL_AUTO
op_or
id|FE_CAN_RECOVER
op_or
id|FE_CAN_HIERARCHY_AUTO
comma
)brace
comma
dot
id|release
op_assign
id|dtt200u_fe_release
comma
dot
id|init
op_assign
id|dtt200u_fe_init
comma
dot
id|sleep
op_assign
id|dtt200u_fe_sleep
comma
dot
id|set_frontend
op_assign
id|dtt200u_fe_set_frontend
comma
dot
id|get_frontend
op_assign
id|dtt200u_fe_get_frontend
comma
dot
id|get_tune_settings
op_assign
id|dtt200u_fe_get_tune_settings
comma
dot
id|read_status
op_assign
id|dtt200u_fe_read_status
comma
dot
id|read_ber
op_assign
id|dtt200u_fe_read_ber
comma
dot
id|read_signal_strength
op_assign
id|dtt200u_fe_read_signal_strength
comma
dot
id|read_snr
op_assign
id|dtt200u_fe_read_snr
comma
dot
id|read_ucblocks
op_assign
id|dtt200u_fe_read_unc_blocks
comma
)brace
suffix:semicolon
eof
