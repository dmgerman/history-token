multiline_comment|/*&n; * dvb-dibusb-remote.c is part of the driver for mobile USB Budget DVB-T devices&n; * based on reference design made by DiBcom (http://www.dibcom.fr/)&n; *&n; * Copyright (C) 2004-5 Patrick Boettcher (patrick.boettcher@desy.de)&n; *&n; * see dvb-dibusb-core.c for more copyright details.&n; *&n; * This file contains functions for handling the event device on the software&n; * side and the remote control on the hardware side.&n; */
macro_line|#include &quot;dvb-dibusb.h&quot;
multiline_comment|/* Table to map raw key codes to key events.  This should not be hard-wired&n;   into the kernel.  */
DECL|member|c0
DECL|member|c1
DECL|member|c2
DECL|member|key
DECL|variable|rc_keys
r_static
r_const
r_struct
(brace
id|u8
id|c0
comma
id|c1
comma
id|c2
suffix:semicolon
r_uint32
id|key
suffix:semicolon
)brace
id|rc_keys
(braket
)braket
op_assign
(brace
multiline_comment|/* Key codes for the little Artec T1/Twinhan/HAMA/ remote. */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x16
comma
id|KEY_POWER
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x10
comma
id|KEY_MUTE
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x03
comma
id|KEY_1
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x01
comma
id|KEY_2
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x06
comma
id|KEY_3
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x09
comma
id|KEY_4
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x1d
comma
id|KEY_5
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x1f
comma
id|KEY_6
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x0d
comma
id|KEY_7
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x19
comma
id|KEY_8
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x1b
comma
id|KEY_9
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x15
comma
id|KEY_0
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x05
comma
id|KEY_CHANNELUP
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x02
comma
id|KEY_CHANNELDOWN
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x1e
comma
id|KEY_VOLUMEUP
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x0a
comma
id|KEY_VOLUMEDOWN
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x11
comma
id|KEY_RECORD
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x17
comma
id|KEY_FAVORITES
)brace
comma
multiline_comment|/* Heart symbol - Channel list. */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x14
comma
id|KEY_PLAY
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x1a
comma
id|KEY_STOP
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x40
comma
id|KEY_REWIND
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x12
comma
id|KEY_FASTFORWARD
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x0e
comma
id|KEY_PREVIOUS
)brace
comma
multiline_comment|/* Recall - Previous channel. */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x4c
comma
id|KEY_PAUSE
)brace
comma
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x4d
comma
id|KEY_SCREEN
)brace
comma
multiline_comment|/* Full screen mode. */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x54
comma
id|KEY_AUDIO
)brace
comma
multiline_comment|/* MTS - Switch to secondary audio. */
multiline_comment|/* additional keys TwinHan VisionPlus, the Artec seemingly not have */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x0c
comma
id|KEY_CANCEL
)brace
comma
multiline_comment|/* Cancel */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x1c
comma
id|KEY_EPG
)brace
comma
multiline_comment|/* EPG */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x00
comma
id|KEY_TAB
)brace
comma
multiline_comment|/* Tab */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x48
comma
id|KEY_INFO
)brace
comma
multiline_comment|/* Preview */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x04
comma
id|KEY_LIST
)brace
comma
multiline_comment|/* RecordList */
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0x0f
comma
id|KEY_TEXT
)brace
comma
multiline_comment|/* Teletext */
multiline_comment|/* Key codes for the KWorld/ADSTech/JetWay remote. */
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x12
comma
id|KEY_POWER
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x0f
comma
id|KEY_SELECT
)brace
comma
multiline_comment|/* source */
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x0c
comma
id|KEY_UNKNOWN
)brace
comma
multiline_comment|/* scan */
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x0b
comma
id|KEY_EPG
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x10
comma
id|KEY_MUTE
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x01
comma
id|KEY_1
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x02
comma
id|KEY_2
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x03
comma
id|KEY_3
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x04
comma
id|KEY_4
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x05
comma
id|KEY_5
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x06
comma
id|KEY_6
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x07
comma
id|KEY_7
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x08
comma
id|KEY_8
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x09
comma
id|KEY_9
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x0a
comma
id|KEY_0
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x18
comma
id|KEY_ZOOM
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x1c
comma
id|KEY_UNKNOWN
)brace
comma
multiline_comment|/* preview */
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x13
comma
id|KEY_UNKNOWN
)brace
comma
multiline_comment|/* snap */
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x00
comma
id|KEY_UNDO
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x1d
comma
id|KEY_RECORD
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x0d
comma
id|KEY_STOP
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x0e
comma
id|KEY_PAUSE
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x16
comma
id|KEY_PLAY
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x11
comma
id|KEY_BACK
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x19
comma
id|KEY_FORWARD
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x14
comma
id|KEY_UNKNOWN
)brace
comma
multiline_comment|/* pip */
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x15
comma
id|KEY_ESC
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x1a
comma
id|KEY_UP
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x1e
comma
id|KEY_DOWN
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x1f
comma
id|KEY_LEFT
)brace
comma
(brace
l_int|0x86
comma
l_int|0x6b
comma
l_int|0x1b
comma
id|KEY_RIGHT
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Read the remote control and feed the appropriate event.&n; * NEC protocol is used for remote controls&n; */
DECL|function|dibusb_read_remote_control
r_static
r_int
id|dibusb_read_remote_control
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
id|u8
id|b
(braket
l_int|1
)braket
op_assign
(brace
id|DIBUSB_REQ_POLL_REMOTE
)brace
comma
id|rb
(braket
l_int|5
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dibusb_readwrite_usb
c_func
(paren
id|dib
comma
id|b
comma
l_int|1
comma
id|rb
comma
l_int|5
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|rb
(braket
l_int|0
)braket
)paren
(brace
r_case
id|DIBUSB_RC_NEC_KEY_PRESSED
suffix:colon
multiline_comment|/* rb[1-3] is the actual key, rb[4] is a checksum */
id|deb_rc
c_func
(paren
l_string|&quot;raw key code 0x%02x, 0x%02x, 0x%02x, 0x%02x&bslash;n&quot;
comma
id|rb
(braket
l_int|1
)braket
comma
id|rb
(braket
l_int|2
)braket
comma
id|rb
(braket
l_int|3
)braket
comma
id|rb
(braket
l_int|4
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
l_int|0xff
op_minus
id|rb
(braket
l_int|3
)braket
)paren
op_ne
id|rb
(braket
l_int|4
)braket
)paren
(brace
id|deb_rc
c_func
(paren
l_string|&quot;remote control checksum failed.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* See if we can match the raw key code. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|rc_keys
)paren
op_div
r_sizeof
(paren
id|rc_keys
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|rc_keys
(braket
id|i
)braket
dot
id|c0
op_eq
id|rb
(braket
l_int|1
)braket
op_logical_and
id|rc_keys
(braket
id|i
)braket
dot
id|c1
op_eq
id|rb
(braket
l_int|2
)braket
op_logical_and
id|rc_keys
(braket
id|i
)braket
dot
id|c2
op_eq
id|rb
(braket
l_int|3
)braket
)paren
(brace
id|dib-&gt;rc_input_event
op_assign
id|rc_keys
(braket
id|i
)braket
dot
id|key
suffix:semicolon
id|deb_rc
c_func
(paren
l_string|&quot;Translated key 0x%04x&bslash;n&quot;
comma
id|dib-&gt;rc_input_event
)paren
suffix:semicolon
multiline_comment|/* Signal down and up events for this key. */
id|input_report_key
c_func
(paren
op_amp
id|dib-&gt;rc_input_dev
comma
id|dib-&gt;rc_input_event
comma
l_int|1
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|dib-&gt;rc_input_dev
comma
id|dib-&gt;rc_input_event
comma
l_int|0
)paren
suffix:semicolon
id|input_sync
c_func
(paren
op_amp
id|dib-&gt;rc_input_dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|DIBUSB_RC_NEC_EMPTY
suffix:colon
multiline_comment|/* No (more) remote control keys. */
r_break
suffix:semicolon
r_case
id|DIBUSB_RC_NEC_KEY_REPEATED
suffix:colon
multiline_comment|/* rb[1]..rb[4] are always zero.*/
multiline_comment|/* Repeats often seem to occur so for the moment just ignore this. */
id|deb_rc
c_func
(paren
l_string|&quot;Key repeat&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Remote-control poll function - called every dib-&gt;rc_query_interval ms to see&n;   whether the remote control has received anything. */
DECL|function|dibusb_remote_query
r_static
r_void
id|dibusb_remote_query
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
(paren
r_struct
id|usb_dibusb
op_star
)paren
id|data
suffix:semicolon
multiline_comment|/* TODO: need a lock here.  We can simply skip checking for the remote control&n;&t;   if we&squot;re busy. */
id|dibusb_read_remote_control
c_func
(paren
id|dib
)paren
suffix:semicolon
id|schedule_delayed_work
c_func
(paren
op_amp
id|dib-&gt;rc_query_work
comma
id|msecs_to_jiffies
c_func
(paren
id|dib-&gt;rc_query_interval
)paren
)paren
suffix:semicolon
)brace
DECL|function|dibusb_remote_init
r_int
id|dibusb_remote_init
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;dibdev-&gt;dev_cl-&gt;remote_type
op_eq
id|DIBUSB_RC_NO
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Initialise the remote-control structures.*/
id|init_input_dev
c_func
(paren
op_amp
id|dib-&gt;rc_input_dev
)paren
suffix:semicolon
id|dib-&gt;rc_input_dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
suffix:semicolon
id|dib-&gt;rc_input_dev.keycodesize
op_assign
r_sizeof
(paren
r_int
r_char
)paren
suffix:semicolon
id|dib-&gt;rc_input_dev.keycodemax
op_assign
id|KEY_MAX
suffix:semicolon
id|dib-&gt;rc_input_dev.name
op_assign
id|DRIVER_DESC
l_string|&quot; remote control&quot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|rc_keys
)paren
op_div
r_sizeof
(paren
id|rc_keys
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|i
op_increment
)paren
id|set_bit
c_func
(paren
id|rc_keys
(braket
id|i
)braket
dot
id|key
comma
id|dib-&gt;rc_input_dev.keybit
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|dib-&gt;rc_input_dev
)paren
suffix:semicolon
id|dib-&gt;rc_input_event
op_assign
id|KEY_MAX
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|dib-&gt;rc_query_work
comma
id|dibusb_remote_query
comma
id|dib
)paren
suffix:semicolon
multiline_comment|/* Start the remote-control polling. */
r_if
c_cond
(paren
id|dib-&gt;rc_query_interval
OL
l_int|40
)paren
id|dib-&gt;rc_query_interval
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* default */
id|info
c_func
(paren
l_string|&quot;schedule remote query interval to %d msecs.&quot;
comma
id|dib-&gt;rc_query_interval
)paren
suffix:semicolon
id|schedule_delayed_work
c_func
(paren
op_amp
id|dib-&gt;rc_query_work
comma
id|msecs_to_jiffies
c_func
(paren
id|dib-&gt;rc_query_interval
)paren
)paren
suffix:semicolon
id|dib-&gt;init_state
op_or_assign
id|DIBUSB_STATE_REMOTE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_remote_exit
r_int
id|dibusb_remote_exit
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_if
c_cond
(paren
id|dib-&gt;dibdev-&gt;dev_cl-&gt;remote_type
op_eq
id|DIBUSB_RC_NO
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;init_state
op_amp
id|DIBUSB_STATE_REMOTE
)paren
(brace
id|cancel_delayed_work
c_func
(paren
op_amp
id|dib-&gt;rc_query_work
)paren
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|dib-&gt;rc_input_dev
)paren
suffix:semicolon
)brace
id|dib-&gt;init_state
op_and_assign
op_complement
id|DIBUSB_STATE_REMOTE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
