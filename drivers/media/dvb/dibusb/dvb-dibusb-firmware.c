multiline_comment|/*&n; * dvb-dibusb-firmware.c is part of the driver for mobile USB Budget DVB-T devices &n; * based on reference design made by DiBcom (http://www.dibcom.fr/)&n; *&n; * Copyright (C) 2004-5 Patrick Boettcher (patrick.boettcher@desy.de)&n; *&n; * see dvb-dibusb-core.c for more copyright details.&n; *&n; * This file contains functions for downloading the firmware to the device.&n; */
macro_line|#include &quot;dvb-dibusb.h&quot;
macro_line|#include &lt;linux/firmware.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
multiline_comment|/*&n; * load a firmware packet to the device &n; */
DECL|function|dibusb_writemem
r_static
r_int
id|dibusb_writemem
c_func
(paren
r_struct
id|usb_device
op_star
id|udev
comma
id|u16
id|addr
comma
id|u8
op_star
id|data
comma
id|u8
id|len
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|udev
comma
id|usb_sndctrlpipe
c_func
(paren
id|udev
comma
l_int|0
)paren
comma
l_int|0xa0
comma
id|USB_TYPE_VENDOR
comma
id|addr
comma
l_int|0x00
comma
id|data
comma
id|len
comma
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|dibusb_loadfirmware
r_int
id|dibusb_loadfirmware
c_func
(paren
r_struct
id|usb_device
op_star
id|udev
comma
r_struct
id|dibusb_usb_device
op_star
id|dibdev
)paren
(brace
r_const
r_struct
id|firmware
op_star
id|fw
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|addr
suffix:semicolon
id|u8
op_star
id|b
comma
op_star
id|p
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|request_firmware
c_func
(paren
op_amp
id|fw
comma
id|dibdev-&gt;dev_cl-&gt;firmware
comma
op_amp
id|udev-&gt;dev
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;did not find a valid firmware file. (%s) &quot;
l_string|&quot;Please see linux/Documentation/dvb/ for more details on firmware-problems.&quot;
comma
id|dibdev-&gt;dev_cl-&gt;firmware
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|p
op_assign
id|kmalloc
c_func
(paren
id|fw-&gt;size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
l_int|NULL
)paren
(brace
id|u8
id|reset
suffix:semicolon
multiline_comment|/*&n;&t;&t; * you cannot use the fw-&gt;data as buffer for &n;&t;&t; * usb_control_msg, a new buffer has to be&n;&t;&t; * created&n;&t;&t; */
id|memcpy
c_func
(paren
id|p
comma
id|fw-&gt;data
comma
id|fw-&gt;size
)paren
suffix:semicolon
multiline_comment|/* stop the CPU */
id|reset
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dibusb_writemem
c_func
(paren
id|udev
comma
id|dibdev-&gt;dev_cl-&gt;usb_ctrl-&gt;cpu_cs_register
comma
op_amp
id|reset
comma
l_int|1
)paren
)paren
op_ne
l_int|1
)paren
id|err
c_func
(paren
l_string|&quot;could not stop the USB controller CPU.&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|3
)braket
op_eq
l_int|0
op_logical_and
id|i
OL
id|fw-&gt;size
suffix:semicolon
)paren
(brace
id|b
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|p
(braket
id|i
)braket
suffix:semicolon
id|addr
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|b
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ret
op_assign
id|dibusb_writemem
c_func
(paren
id|udev
comma
id|addr
comma
op_amp
id|b
(braket
l_int|4
)braket
comma
id|b
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|b
(braket
l_int|0
)braket
)paren
(brace
id|err
c_func
(paren
l_string|&quot;error while transferring firmware &quot;
l_string|&quot;(transferred size: %d, block size: %d)&quot;
comma
id|ret
comma
id|b
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_add_assign
l_int|5
op_plus
id|b
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/* length in ret */
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* restart the CPU */
id|reset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_or
id|dibusb_writemem
c_func
(paren
id|udev
comma
id|dibdev-&gt;dev_cl-&gt;usb_ctrl-&gt;cpu_cs_register
comma
op_amp
id|reset
comma
l_int|1
)paren
op_ne
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;could not restart the USB controller CPU.&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|release_firmware
c_func
(paren
id|fw
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
