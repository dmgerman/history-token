multiline_comment|/*&n; * dvb-dibusb-dvb.c is part of the driver for mobile USB Budget DVB-T devices &n; * based on reference design made by DiBcom (http://www.dibcom.fr/)&n; *&n; * Copyright (C) 2004-5 Patrick Boettcher (patrick.boettcher@desy.de)&n; *&n; * see dvb-dibusb-core.c for more copyright details.&n; *&n; * This file contains functions for initializing and handling the &n; * linux-dvb API.&n; */
macro_line|#include &quot;dvb-dibusb.h&quot;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/version.h&gt;
DECL|variable|urb_compl_count
r_static
id|u32
id|urb_compl_count
suffix:semicolon
multiline_comment|/*&n; * MPEG2 TS DVB stuff &n; */
DECL|function|dibusb_urb_complete
r_void
id|dibusb_urb_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|urb-&gt;context
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|deb_ts
c_func
(paren
l_string|&quot;urb complete feedcount: %d, status: %d, length: %d&bslash;n&quot;
comma
id|dib-&gt;feedcount
comma
id|urb-&gt;status
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
id|urb_compl_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|urb_compl_count
op_mod
l_int|500
op_eq
l_int|0
)paren
id|deb_info
c_func
(paren
l_string|&quot;%d urbs completed so far.&bslash;n&quot;
comma
id|urb_compl_count
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* success */
r_case
op_minus
id|ETIMEDOUT
suffix:colon
multiline_comment|/* NAK */
r_break
suffix:semicolon
r_case
op_minus
id|ECONNRESET
suffix:colon
multiline_comment|/* unlink */
r_case
op_minus
id|ENOENT
suffix:colon
r_case
op_minus
id|ESHUTDOWN
suffix:colon
r_return
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* error */
id|warn
c_func
(paren
l_string|&quot;urb completition error %d.&quot;
comma
id|urb-&gt;status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dib-&gt;feedcount
OG
l_int|0
)paren
(brace
id|deb_ts
c_func
(paren
l_string|&quot;URB return len: %d&bslash;n&quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;actual_length
op_mod
l_int|188
)paren
id|deb_ts
c_func
(paren
l_string|&quot;TS Packets: %d, %d&bslash;n&quot;
comma
id|urb-&gt;actual_length
op_div
l_int|188
comma
id|urb-&gt;actual_length
op_mod
l_int|188
)paren
suffix:semicolon
multiline_comment|/* Francois recommends to drop not full-filled packets, even if they may &n;&t;&t; * contain valid TS packets, at least for USB1.1&n;&t;&t; *&n;&t;&t; * if (urb-&gt;actual_length == dib-&gt;dibdev-&gt;parm-&gt;default_size &amp;&amp; dib-&gt;dvb_is_ready) */
r_if
c_cond
(paren
id|dib-&gt;init_state
op_amp
id|DIBUSB_STATE_DVB
)paren
id|dvb_dmx_swfilter
c_func
(paren
op_amp
id|dib-&gt;demux
comma
(paren
id|u8
op_star
)paren
id|urb-&gt;transfer_buffer
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_else
id|deb_ts
c_func
(paren
l_string|&quot;URB dropped because of the &quot;
l_string|&quot;actual_length or !dvb_is_ready (%d).&bslash;n&quot;
comma
id|dib-&gt;init_state
op_amp
id|DIBUSB_STATE_DVB
)paren
suffix:semicolon
)brace
r_else
id|deb_ts
c_func
(paren
l_string|&quot;URB dropped because of feedcount.&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|deb_ts
c_func
(paren
l_string|&quot;urb resubmitted, (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
DECL|function|dibusb_ctrl_feed
r_static
r_int
id|dibusb_ctrl_feed
c_func
(paren
r_struct
id|dvb_demux_feed
op_star
id|dvbdmxfeed
comma
r_int
id|onoff
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|dvbdmxfeed-&gt;demux-&gt;priv
suffix:semicolon
r_int
id|newfeedcount
suffix:semicolon
r_if
c_cond
(paren
id|dib
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|newfeedcount
op_assign
id|dib-&gt;feedcount
op_plus
(paren
id|onoff
ques
c_cond
l_int|1
suffix:colon
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * stop feed before setting a new pid if there will be no pid anymore &n;&t; */
singleline_comment|//&t;if ((dib-&gt;dibdev-&gt;parm-&gt;firmware_bug &amp;&amp; dib-&gt;feedcount) || 
r_if
c_cond
(paren
id|newfeedcount
op_eq
l_int|0
)paren
(brace
id|deb_ts
c_func
(paren
l_string|&quot;stop feeding&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;xfer_ops.fifo_ctrl
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|dib-&gt;xfer_ops
dot
id|fifo_ctrl
c_func
(paren
id|dib-&gt;fe
comma
l_int|0
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;error while inhibiting fifo.&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
id|dib-&gt;feedcount
op_assign
id|newfeedcount
suffix:semicolon
multiline_comment|/* get a free pid from the list and activate it on the device&n;&t; * specific pid_filter&n;&t; */
r_if
c_cond
(paren
id|dib-&gt;pid_parse
)paren
id|dibusb_ctrl_pid
c_func
(paren
id|dib
comma
id|dvbdmxfeed
comma
id|onoff
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * start the feed, either if there is the firmware bug or &n;&t; * if this was the first pid to set and there is still a pid for &n;&t; * reception.&n;&t; */
singleline_comment|//&t;if ((dib-&gt;dibdev-&gt;parm-&gt;firmware_bug)
r_if
c_cond
(paren
id|dib-&gt;feedcount
op_eq
id|onoff
op_logical_and
id|dib-&gt;feedcount
OG
l_int|0
)paren
(brace
id|deb_ts
c_func
(paren
l_string|&quot;controlling pid parser&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;xfer_ops.pid_parse
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|dib-&gt;xfer_ops
dot
id|pid_parse
c_func
(paren
id|dib-&gt;fe
comma
id|dib-&gt;pid_parse
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;could not handle pid_parser&quot;
)paren
suffix:semicolon
)brace
)brace
id|deb_ts
c_func
(paren
l_string|&quot;start feeding&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;xfer_ops.fifo_ctrl
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|dib-&gt;xfer_ops
dot
id|fifo_ctrl
c_func
(paren
id|dib-&gt;fe
comma
l_int|1
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;error while enabling fifo.&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
id|dibusb_streaming
c_func
(paren
id|dib
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_start_feed
r_static
r_int
id|dibusb_start_feed
c_func
(paren
r_struct
id|dvb_demux_feed
op_star
id|dvbdmxfeed
)paren
(brace
id|deb_ts
c_func
(paren
l_string|&quot;start pid: 0x%04x, feedtype: %d&bslash;n&quot;
comma
id|dvbdmxfeed-&gt;pid
comma
id|dvbdmxfeed-&gt;type
)paren
suffix:semicolon
r_return
id|dibusb_ctrl_feed
c_func
(paren
id|dvbdmxfeed
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|dibusb_stop_feed
r_static
r_int
id|dibusb_stop_feed
c_func
(paren
r_struct
id|dvb_demux_feed
op_star
id|dvbdmxfeed
)paren
(brace
id|deb_ts
c_func
(paren
l_string|&quot;stop pid: 0x%04x, feedtype: %d&bslash;n&quot;
comma
id|dvbdmxfeed-&gt;pid
comma
id|dvbdmxfeed-&gt;type
)paren
suffix:semicolon
r_return
id|dibusb_ctrl_feed
c_func
(paren
id|dvbdmxfeed
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|dibusb_dvb_init
r_int
id|dibusb_dvb_init
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_int
id|ret
suffix:semicolon
id|urb_compl_count
op_assign
l_int|0
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt;= KERNEL_VERSION(2,6,4)
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_register_adapter
c_func
(paren
op_amp
id|dib-&gt;adapter
comma
id|DRIVER_DESC
)paren
)paren
OL
l_int|0
)paren
(brace
macro_line|#else
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_register_adapter
c_func
(paren
op_amp
id|dib-&gt;adapter
comma
id|DRIVER_DESC
comma
id|THIS_MODULE
)paren
)paren
OL
l_int|0
)paren
(brace
macro_line|#endif
id|deb_info
c_func
(paren
l_string|&quot;dvb_register_adapter failed: error %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|dib-&gt;adapter-&gt;priv
op_assign
id|dib
suffix:semicolon
multiline_comment|/* i2c is done in dibusb_i2c_init */
id|dib-&gt;demux.dmx.capabilities
op_assign
id|DMX_TS_FILTERING
op_or
id|DMX_SECTION_FILTERING
suffix:semicolon
id|dib-&gt;demux.priv
op_assign
(paren
r_void
op_star
)paren
id|dib
suffix:semicolon
multiline_comment|/* get pidcount from demod */
id|dib-&gt;demux.feednum
op_assign
id|dib-&gt;demux.filternum
op_assign
l_int|255
suffix:semicolon
id|dib-&gt;demux.start_feed
op_assign
id|dibusb_start_feed
suffix:semicolon
id|dib-&gt;demux.stop_feed
op_assign
id|dibusb_stop_feed
suffix:semicolon
id|dib-&gt;demux.write_to_decoder
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_dmx_init
c_func
(paren
op_amp
id|dib-&gt;demux
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;dvb_dmx_init failed: error %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err_dmx
suffix:semicolon
)brace
id|dib-&gt;dmxdev.filternum
op_assign
id|dib-&gt;demux.filternum
suffix:semicolon
id|dib-&gt;dmxdev.demux
op_assign
op_amp
id|dib-&gt;demux.dmx
suffix:semicolon
id|dib-&gt;dmxdev.capabilities
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_dmxdev_init
c_func
(paren
op_amp
id|dib-&gt;dmxdev
comma
id|dib-&gt;adapter
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;dvb_dmxdev_init failed: error %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err_dmx_dev
suffix:semicolon
)brace
id|dvb_net_init
c_func
(paren
id|dib-&gt;adapter
comma
op_amp
id|dib-&gt;dvb_net
comma
op_amp
id|dib-&gt;demux.dmx
)paren
suffix:semicolon
r_goto
id|success
suffix:semicolon
id|err_dmx_dev
suffix:colon
id|dvb_dmx_release
c_func
(paren
op_amp
id|dib-&gt;demux
)paren
suffix:semicolon
id|err_dmx
suffix:colon
id|dvb_unregister_adapter
c_func
(paren
id|dib-&gt;adapter
)paren
suffix:semicolon
id|err
suffix:colon
r_return
id|ret
suffix:semicolon
id|success
suffix:colon
id|dib-&gt;init_state
op_or_assign
id|DIBUSB_STATE_DVB
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_dvb_exit
r_int
id|dibusb_dvb_exit
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_if
c_cond
(paren
id|dib-&gt;init_state
op_amp
id|DIBUSB_STATE_DVB
)paren
(brace
id|dib-&gt;init_state
op_and_assign
op_complement
id|DIBUSB_STATE_DVB
suffix:semicolon
id|deb_info
c_func
(paren
l_string|&quot;unregistering DVB part&bslash;n&quot;
)paren
suffix:semicolon
id|dvb_net_release
c_func
(paren
op_amp
id|dib-&gt;dvb_net
)paren
suffix:semicolon
id|dib-&gt;demux.dmx
dot
id|close
c_func
(paren
op_amp
id|dib-&gt;demux.dmx
)paren
suffix:semicolon
id|dvb_dmxdev_release
c_func
(paren
op_amp
id|dib-&gt;dmxdev
)paren
suffix:semicolon
id|dvb_dmx_release
c_func
(paren
op_amp
id|dib-&gt;demux
)paren
suffix:semicolon
id|dvb_unregister_adapter
c_func
(paren
id|dib-&gt;adapter
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
