multiline_comment|/*&n; * Driver for mobile USB Budget DVB-T devices based on reference&n; * design made by DiBcom (http://www.dibcom.fr/)&n; *&n; * dvb-dibusb.c&n; *&n; * Copyright (C) 2004 Patrick Boettcher (patrick.boettcher@desy.de)&n; *&n; * based on GPL code from DiBcom, which has&n; *&n; * Copyright (C) 2004 Amaury Demol for DiBcom (ademol@dibcom.fr)&n; *&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License as&n; *&t;published by the Free Software Foundation, version 2.&n; *&n; * Acknowledgements&n; *&n; *  Amaury Demol (ademol@dibcom.fr) from DiBcom for providing specs and driver&n; *  sources, on which this driver (and the dib3000mb frontend) are based.&n; *&n; * &n; *&n; * see Documentation/dvb/README.dibusb for more information&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/firmware.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &quot;dmxdev.h&quot;
macro_line|#include &quot;dvb_demux.h&quot;
macro_line|#include &quot;dvb_filter.h&quot;
macro_line|#include &quot;dvb_net.h&quot;
macro_line|#include &quot;dvb_frontend.h&quot;
macro_line|#include &quot;dvb-dibusb.h&quot;
multiline_comment|/* debug */
macro_line|#ifdef CONFIG_DVB_DIBCOM_DEBUG
DECL|macro|dprintk_new
mdefine_line|#define dprintk_new(level,args...) &bslash;&n;&t;    do { if ((debug &amp; level)) { printk(args); } } while (0)
DECL|macro|debug_dump
mdefine_line|#define debug_dump(b,l) if (debug) {&bslash;&n;&t;int i; deb_xfer(&quot;%s: %d &gt; &quot;,__FUNCTION__,l); &bslash;&n;&t;for (i = 0; i &lt; l; i++) deb_xfer(&quot;%02x &quot;, b[i]); &bslash;&n;&t;deb_xfer(&quot;&bslash;n&quot;);&bslash;&n;}
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_int
comma
l_int|0x644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;set debugging level (1=info,2=xfer,4=alotmore,8=ts,16=err (|-able)).&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|macro|dprintk_new
mdefine_line|#define dprintk_new(args...)
DECL|macro|debug_dump
mdefine_line|#define debug_dump(b,l)
macro_line|#endif
DECL|macro|deb_info
mdefine_line|#define deb_info(args...) dprintk_new(0x01,args)
DECL|macro|deb_xfer
mdefine_line|#define deb_xfer(args...) dprintk_new(0x02,args)
DECL|macro|deb_alot
mdefine_line|#define deb_alot(args...) dprintk_new(0x04,args)
DECL|macro|deb_ts
mdefine_line|#define deb_ts(args...)   dprintk_new(0x08,args)
DECL|macro|deb_err
mdefine_line|#define deb_err(args...)   dprintk_new(0x10,args)
multiline_comment|/* Version information */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;0.0&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;Driver for DiBcom based USB Budget DVB-T device&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Patrick Boettcher, patrick.boettcher@desy.de&quot;
DECL|function|dibusb_readwrite_usb
r_static
r_int
id|dibusb_readwrite_usb
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
comma
id|u8
op_star
id|wbuf
comma
id|u16
id|wlen
comma
id|u8
op_star
id|rbuf
comma
id|u16
id|rlen
)paren
(brace
r_int
id|actlen
comma
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|wbuf
op_eq
l_int|NULL
op_logical_or
id|wlen
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|down_interruptible
c_func
(paren
op_amp
id|dib-&gt;usb_sem
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;streaming
op_logical_and
id|wbuf
(braket
l_int|0
)braket
op_eq
id|DIBUSB_REQ_I2C_WRITE
)paren
id|deb_err
c_func
(paren
l_string|&quot;BUG: writing to i2c, while TS-streaming destroys the stream. What&quot;
l_string|&quot; did you do ? Please enable debugging and send the syslog to the author. (%x reg: %x %x)&quot;
comma
id|wbuf
(braket
l_int|0
)braket
comma
id|wbuf
(braket
l_int|2
)braket
comma
id|wbuf
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|debug_dump
c_func
(paren
id|wbuf
comma
id|wlen
)paren
suffix:semicolon
id|ret
op_assign
id|usb_bulk_msg
c_func
(paren
id|dib-&gt;udev
comma
id|COMMAND_PIPE
comma
id|wbuf
comma
id|wlen
comma
op_amp
id|actlen
comma
id|DIBUSB_I2C_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|err
c_func
(paren
l_string|&quot;bulk message failed: %d (%d/%d)&quot;
comma
id|ret
comma
id|wlen
comma
id|actlen
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|actlen
op_ne
id|wlen
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* an answer is expected */
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
id|rbuf
op_logical_and
id|rlen
)paren
(brace
id|ret
op_assign
id|usb_bulk_msg
c_func
(paren
id|dib-&gt;udev
comma
id|RESULT_PIPE
comma
id|rbuf
comma
id|rlen
comma
op_amp
id|actlen
comma
id|DIBUSB_I2C_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|err
c_func
(paren
l_string|&quot;recv bulk message failed: %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_else
(brace
id|deb_alot
c_func
(paren
l_string|&quot;rlen: %d&bslash;n&quot;
comma
id|rlen
)paren
suffix:semicolon
id|debug_dump
c_func
(paren
id|rbuf
comma
id|actlen
)paren
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|dib-&gt;usb_sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dibusb_write_usb
r_static
r_int
id|dibusb_write_usb
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
comma
id|u8
op_star
id|buf
comma
id|u16
id|len
)paren
(brace
r_return
id|dibusb_readwrite_usb
c_func
(paren
id|dib
comma
id|buf
comma
id|len
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|dibusb_i2c_msg
r_static
r_int
id|dibusb_i2c_msg
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
comma
id|u8
id|addr
comma
id|u8
op_star
id|wbuf
comma
id|u16
id|wlen
comma
id|u8
op_star
id|rbuf
comma
id|u16
id|rlen
)paren
(brace
id|u8
id|sndbuf
(braket
id|wlen
op_plus
l_int|4
)braket
suffix:semicolon
multiline_comment|/* lead(1) devaddr,direction(1) addr(2) data(wlen) (len(2) (when reading)) */
multiline_comment|/* write only ? */
r_int
id|wo
op_assign
(paren
id|rbuf
op_eq
l_int|NULL
op_logical_or
id|rlen
op_eq
l_int|0
)paren
comma
id|len
op_assign
l_int|2
op_plus
id|wlen
op_plus
(paren
id|wo
ques
c_cond
l_int|0
suffix:colon
l_int|2
)paren
suffix:semicolon
id|deb_alot
c_func
(paren
l_string|&quot;wo: %d, wlen: %d, len: %d&bslash;n&quot;
comma
id|wo
comma
id|wlen
comma
id|len
)paren
suffix:semicolon
id|sndbuf
(braket
l_int|0
)braket
op_assign
id|wo
ques
c_cond
id|DIBUSB_REQ_I2C_WRITE
suffix:colon
id|DIBUSB_REQ_I2C_READ
suffix:semicolon
id|sndbuf
(braket
l_int|1
)braket
op_assign
(paren
id|addr
op_amp
l_int|0xfe
)paren
op_or
(paren
id|wo
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|sndbuf
(braket
l_int|2
)braket
comma
id|wbuf
comma
id|wlen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wo
)paren
(brace
id|sndbuf
(braket
id|wlen
op_plus
l_int|2
)braket
op_assign
(paren
id|rlen
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|sndbuf
(braket
id|wlen
op_plus
l_int|3
)braket
op_assign
id|rlen
op_amp
l_int|0xff
suffix:semicolon
)brace
r_return
id|dibusb_readwrite_usb
c_func
(paren
id|dib
comma
id|sndbuf
comma
id|len
comma
id|rbuf
comma
id|rlen
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * DVB stuff&n; */
DECL|function|dibusb_get_free_pid
r_static
r_struct
id|dibusb_pid
op_star
id|dibusb_get_free_pid
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|dibusb_pid
op_star
id|dpid
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dib-&gt;pid_list_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DIBUSB_MAX_PIDS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|active
)paren
(brace
id|dpid
op_assign
id|dib-&gt;pid_list
op_plus
id|i
suffix:semicolon
id|dpid-&gt;active
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dib-&gt;pid_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|dpid
suffix:semicolon
)brace
DECL|function|dibusb_start_xfer
r_static
r_int
id|dibusb_start_xfer
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
id|u8
id|b
(braket
l_int|4
)braket
op_assign
(brace
(paren
id|DIB3000MB_REG_FIFO
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
(paren
id|DIB3000MB_REG_FIFO
)paren
op_amp
l_int|0xff
comma
(paren
id|DIB3000MB_FIFO_ACTIVATE
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
(paren
id|DIB3000MB_FIFO_ACTIVATE
)paren
op_amp
l_int|0xff
)brace
suffix:semicolon
id|dib-&gt;streaming
op_assign
l_int|1
suffix:semicolon
id|deb_ts
c_func
(paren
l_string|&quot;start streaming&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|dibusb_i2c_msg
c_func
(paren
id|dib
comma
id|DIBUSB_DEMOD_I2C_ADDR_DEFAULT
comma
id|b
comma
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|dibusb_stop_xfer
r_static
r_int
id|dibusb_stop_xfer
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
id|u8
id|b
(braket
l_int|4
)braket
op_assign
(brace
(paren
id|DIB3000MB_REG_FIFO
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
(paren
id|DIB3000MB_REG_FIFO
)paren
op_amp
l_int|0xff
comma
(paren
id|DIB3000MB_FIFO_INHIBIT
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
(paren
id|DIB3000MB_FIFO_INHIBIT
)paren
op_amp
l_int|0xff
)brace
suffix:semicolon
id|dib-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|deb_ts
c_func
(paren
l_string|&quot;stop streaming&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|dibusb_i2c_msg
c_func
(paren
id|dib
comma
id|DIBUSB_DEMOD_I2C_ADDR_DEFAULT
comma
id|b
comma
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|dibusb_set_pid
r_static
r_int
id|dibusb_set_pid
c_func
(paren
r_struct
id|dibusb_pid
op_star
id|dpid
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|dpid-&gt;dib
suffix:semicolon
id|u16
id|pid
op_assign
id|dpid-&gt;pid
op_or
(paren
id|dpid-&gt;active
ques
c_cond
id|DIB3000MB_ACTIVATE_FILTERING
suffix:colon
l_int|0
)paren
suffix:semicolon
id|u8
id|b
(braket
l_int|4
)braket
op_assign
(brace
(paren
id|dpid-&gt;reg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
(paren
id|dpid-&gt;reg
)paren
op_amp
l_int|0xff
comma
(paren
id|pid
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
comma
(paren
id|pid
)paren
op_amp
l_int|0xff
)brace
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* firmware bug, i2c write during mpeg transfer */
r_if
c_cond
(paren
id|dib-&gt;feedcount
)paren
(brace
id|deb_info
c_func
(paren
l_string|&quot;stop streaming&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|dibusb_stop_xfer
c_func
(paren
id|dib
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dpid-&gt;active
)paren
id|dib-&gt;feedcount
op_increment
suffix:semicolon
r_else
id|dib-&gt;feedcount
op_decrement
suffix:semicolon
id|ret
op_assign
id|dibusb_i2c_msg
c_func
(paren
id|dib
comma
id|DIBUSB_DEMOD_I2C_ADDR_DEFAULT
comma
id|b
comma
l_int|4
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
op_logical_and
id|dib-&gt;feedcount
)paren
(brace
id|deb_info
c_func
(paren
l_string|&quot;start streaming&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|dibusb_start_xfer
c_func
(paren
id|dib
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dibusb_urb_complete
r_static
r_void
id|dibusb_urb_complete
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|ptregs
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|urb-&gt;context
suffix:semicolon
id|deb_xfer
c_func
(paren
l_string|&quot;urb complete feedcount: %d, status: %d&bslash;n&quot;
comma
id|dib-&gt;feedcount
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;feedcount
OG
l_int|0
op_logical_and
id|urb-&gt;status
op_eq
l_int|0
)paren
(brace
id|deb_xfer
c_func
(paren
l_string|&quot;URB return len: %d&bslash;n&quot;
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;actual_length
op_mod
l_int|188
)paren
id|deb_xfer
c_func
(paren
l_string|&quot;TS Packets: %d, %d&bslash;n&quot;
comma
id|urb-&gt;actual_length
op_div
l_int|188
comma
id|urb-&gt;actual_length
op_mod
l_int|188
)paren
suffix:semicolon
multiline_comment|/* Francois recommends to drop not full-filled packets, even if they may &n;&t;&t; * contain valid TS packets&n;&t;&t; */
r_if
c_cond
(paren
id|urb-&gt;actual_length
op_eq
id|DIBUSB_TS_DEFAULT_SIZE
op_logical_and
id|dib-&gt;dvb_is_ready
)paren
id|dvb_dmx_swfilter_packets
c_func
(paren
op_amp
id|dib-&gt;demux
comma
(paren
id|u8
op_star
)paren
id|urb-&gt;transfer_buffer
comma
id|urb-&gt;actual_length
op_div
l_int|188
)paren
suffix:semicolon
r_else
id|deb_ts
c_func
(paren
l_string|&quot;URB dropped because of the &quot;
l_string|&quot;actual_length or !dvb_is_ready (%d).&bslash;n&quot;
comma
id|dib-&gt;dvb_is_ready
)paren
suffix:semicolon
)brace
r_else
id|deb_ts
c_func
(paren
l_string|&quot;URB dropped because of feedcount or status.&bslash;n&quot;
)paren
suffix:semicolon
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
DECL|function|dibusb_start_feed
r_static
r_int
id|dibusb_start_feed
c_func
(paren
r_struct
id|dvb_demux_feed
op_star
id|dvbdmxfeed
)paren
(brace
singleline_comment|//&t;struct dvb_demux *dvbdmx = dvbdmxfeed-&gt;demux;
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|dvbdmxfeed-&gt;demux-&gt;priv
suffix:semicolon
r_struct
id|dibusb_pid
op_star
id|dpid
suffix:semicolon
id|deb_ts
c_func
(paren
l_string|&quot;pid: 0x%04x, feedtype: %d&bslash;n&quot;
comma
id|dvbdmxfeed-&gt;pid
comma
id|dvbdmxfeed-&gt;type
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dpid
op_assign
id|dibusb_get_free_pid
c_func
(paren
id|dib
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;no free pid in list.&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dvbdmxfeed-&gt;priv
op_assign
id|dpid
suffix:semicolon
id|dpid-&gt;pid
op_assign
id|dvbdmxfeed-&gt;pid
suffix:semicolon
id|dibusb_set_pid
c_func
(paren
id|dpid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_stop_feed
r_static
r_int
id|dibusb_stop_feed
c_func
(paren
r_struct
id|dvb_demux_feed
op_star
id|dvbdmxfeed
)paren
(brace
r_struct
id|dibusb_pid
op_star
id|dpid
op_assign
(paren
r_struct
id|dibusb_pid
op_star
)paren
id|dvbdmxfeed-&gt;priv
suffix:semicolon
id|deb_ts
c_func
(paren
l_string|&quot;stopfeed pid: 0x%04x, feedtype: %d&bslash;n&quot;
comma
id|dvbdmxfeed-&gt;pid
comma
id|dvbdmxfeed-&gt;type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dpid
op_eq
l_int|NULL
)paren
id|err
c_func
(paren
l_string|&quot;channel in dmxfeed-&gt;priv was NULL&quot;
)paren
suffix:semicolon
r_else
(brace
id|dpid-&gt;active
op_assign
l_int|0
suffix:semicolon
id|dpid-&gt;pid
op_assign
l_int|0
suffix:semicolon
id|dibusb_set_pid
c_func
(paren
id|dpid
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * firmware transfers&n; */
multiline_comment|/*&n; * do not use this, just a workaround for a bug,&n; * which will hopefully never occur :).&n; */
DECL|function|dibusb_interrupt_read_loop
r_static
r_int
id|dibusb_interrupt_read_loop
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
id|u8
id|b
(braket
l_int|1
)braket
op_assign
(brace
id|DIBUSB_REQ_INTR_READ
)brace
suffix:semicolon
r_return
id|dibusb_write_usb
c_func
(paren
id|dib
comma
id|b
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * TODO: a tasklet should run with a delay of 1/10 second&n; * and feed an appropriate event device ?&n; * NEC protocol is used for remote controlls&n; */
DECL|function|dibusb_read_remote_control
r_static
r_int
id|dibusb_read_remote_control
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
id|u8
id|b
(braket
l_int|1
)braket
op_assign
(brace
id|DIBUSB_REQ_POLL_REMOTE
)brace
comma
id|rb
(braket
l_int|5
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dibusb_readwrite_usb
c_func
(paren
id|dib
comma
id|b
comma
l_int|1
comma
id|rb
comma
l_int|5
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_switch
c_cond
(paren
id|rb
(braket
l_int|0
)braket
)paren
(brace
r_case
id|DIBUSB_RC_NEC_KEY_PRESSED
suffix:colon
r_break
suffix:semicolon
r_case
id|DIBUSB_RC_NEC_EMPTY
suffix:colon
r_case
id|DIBUSB_RC_NEC_KEY_REPEATED
suffix:colon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ioctl for the firmware&n; */
DECL|function|dibusb_ioctl_cmd
r_static
r_int
id|dibusb_ioctl_cmd
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
comma
id|u8
id|cmd
comma
id|u8
op_star
id|param
comma
r_int
id|plen
)paren
(brace
id|u8
id|b
(braket
l_int|34
)braket
suffix:semicolon
r_int
id|size
op_assign
id|plen
OG
l_int|32
ques
c_cond
l_int|32
suffix:colon
id|plen
suffix:semicolon
id|b
(braket
l_int|0
)braket
op_assign
id|DIBUSB_REQ_SET_IOCTL
suffix:semicolon
id|b
(braket
l_int|1
)braket
op_assign
id|cmd
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|b
(braket
l_int|2
)braket
comma
id|param
comma
id|size
)paren
suffix:semicolon
r_return
id|dibusb_write_usb
c_func
(paren
id|dib
comma
id|b
comma
l_int|2
op_plus
id|size
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ioctl for power control&n; */
DECL|function|dibusb_hw_sleep
r_static
r_int
id|dibusb_hw_sleep
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
id|u8
id|b
(braket
l_int|1
)braket
op_assign
(brace
id|DIBUSB_IOCTL_POWER_SLEEP
)brace
suffix:semicolon
r_return
id|dibusb_ioctl_cmd
c_func
(paren
id|dib
comma
id|DIBUSB_IOCTL_CMD_POWER_MODE
comma
id|b
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|dibusb_hw_wakeup
r_static
r_int
id|dibusb_hw_wakeup
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
id|u8
id|b
(braket
l_int|1
)braket
op_assign
(brace
id|DIBUSB_IOCTL_POWER_WAKEUP
)brace
suffix:semicolon
r_return
id|dibusb_ioctl_cmd
c_func
(paren
id|dib
comma
id|DIBUSB_IOCTL_CMD_POWER_MODE
comma
id|b
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * I2C&n; */
DECL|function|dibusb_i2c_xfer
r_static
r_int
id|dibusb_i2c_xfer
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_struct
id|i2c_msg
id|msg
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|i2c_get_adapdata
c_func
(paren
id|adap
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|dib-&gt;i2c_sem
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* write/read request */
r_if
c_cond
(paren
id|i
op_plus
l_int|1
OL
id|num
op_logical_and
(paren
id|msg
(braket
id|i
op_plus
l_int|1
)braket
dot
id|flags
op_amp
id|I2C_M_RD
)paren
)paren
(brace
r_if
c_cond
(paren
id|dibusb_i2c_msg
c_func
(paren
id|dib
comma
id|msg
(braket
id|i
)braket
dot
id|addr
comma
id|msg
(braket
id|i
)braket
dot
id|buf
comma
id|msg
(braket
id|i
)braket
dot
id|len
comma
id|msg
(braket
id|i
op_plus
l_int|1
)braket
dot
id|buf
comma
id|msg
(braket
id|i
op_plus
l_int|1
)braket
dot
id|len
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
id|i
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dibusb_i2c_msg
c_func
(paren
id|dib
comma
id|msg
(braket
id|i
)braket
dot
id|addr
comma
id|msg
(braket
id|i
)braket
dot
id|buf
comma
id|msg
(braket
id|i
)braket
dot
id|len
comma
l_int|NULL
comma
l_int|0
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dib-&gt;i2c_sem
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|dibusb_i2c_func
r_static
id|u32
id|dibusb_i2c_func
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_return
id|I2C_FUNC_I2C
suffix:semicolon
)brace
DECL|function|dibusb_i2c_client_register
r_static
r_int
id|dibusb_i2c_client_register
(paren
r_struct
id|i2c_client
op_star
id|i2c
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|i2c_get_adapdata
c_func
(paren
id|i2c-&gt;adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c-&gt;driver-&gt;command
)paren
r_return
id|i2c-&gt;driver
op_member_access_from_pointer
id|command
c_func
(paren
id|i2c
comma
id|FE_REGISTER
comma
id|dib-&gt;adapter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_i2c_client_unregister
r_static
r_int
id|dibusb_i2c_client_unregister
(paren
r_struct
id|i2c_client
op_star
id|i2c
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|i2c_get_adapdata
c_func
(paren
id|i2c-&gt;adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c-&gt;driver-&gt;command
)paren
r_return
id|i2c-&gt;driver
op_member_access_from_pointer
id|command
c_func
(paren
id|i2c
comma
id|FE_UNREGISTER
comma
id|dib-&gt;adapter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|dibusb_algo
r_static
r_struct
id|i2c_algorithm
id|dibusb_algo
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;DiBcom USB i2c algorithm&quot;
comma
dot
id|id
op_assign
id|I2C_ALGO_BIT
comma
dot
id|master_xfer
op_assign
id|dibusb_i2c_xfer
comma
dot
id|functionality
op_assign
id|dibusb_i2c_func
comma
)brace
suffix:semicolon
DECL|function|dibusb_dvb_init
r_static
r_int
id|dibusb_dvb_init
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_int
id|ret
suffix:semicolon
macro_line|#if LINUX_VERSION_CODE &lt;= KERNEL_VERSION(2,6,4)
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_register_adapter
c_func
(paren
op_amp
id|dib-&gt;adapter
comma
id|DRIVER_DESC
)paren
)paren
OL
l_int|0
)paren
(brace
macro_line|#else
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_register_adapter
c_func
(paren
op_amp
id|dib-&gt;adapter
comma
id|DRIVER_DESC
comma
id|THIS_MODULE
)paren
)paren
OL
l_int|0
)paren
(brace
macro_line|#endif
id|deb_info
c_func
(paren
l_string|&quot;dvb_register_adapter failed: error %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|dib-&gt;i2c_adap.name
comma
id|dib-&gt;dibdev-&gt;name
comma
id|I2C_NAME_SIZE
)paren
suffix:semicolon
macro_line|#ifdef I2C_ADAP_CLASS_TV_DIGITAL
id|dib-&gt;i2c_adap
dot
r_class
op_assign
id|I2C_ADAP_CLASS_TV_DIGITAL
comma
macro_line|#else
id|dib-&gt;i2c_adap
dot
r_class
op_assign
id|I2C_CLASS_TV_DIGITAL
comma
macro_line|#endif
id|dib-&gt;i2c_adap.algo
op_assign
op_amp
id|dibusb_algo
suffix:semicolon
id|dib-&gt;i2c_adap.algo_data
op_assign
l_int|NULL
suffix:semicolon
id|dib-&gt;i2c_adap.id
op_assign
id|I2C_ALGO_BIT
suffix:semicolon
id|dib-&gt;i2c_adap.client_register
op_assign
id|dibusb_i2c_client_register
comma
id|dib-&gt;i2c_adap.client_unregister
op_assign
id|dibusb_i2c_client_unregister
comma
id|i2c_set_adapdata
c_func
(paren
op_amp
id|dib-&gt;i2c_adap
comma
id|dib
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i2c_add_adapter
c_func
(paren
op_amp
id|dib-&gt;i2c_adap
)paren
OL
l_int|0
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;could not add i2c adapter&quot;
)paren
suffix:semicolon
r_goto
id|err_i2c
suffix:semicolon
)brace
id|dib-&gt;demux.dmx.capabilities
op_assign
id|DMX_TS_FILTERING
op_or
id|DMX_SECTION_FILTERING
suffix:semicolon
id|dib-&gt;demux.priv
op_assign
(paren
r_void
op_star
)paren
id|dib
suffix:semicolon
id|dib-&gt;demux.filternum
op_assign
id|DIBUSB_MAX_PIDS
suffix:semicolon
id|dib-&gt;demux.feednum
op_assign
id|DIBUSB_MAX_PIDS
suffix:semicolon
id|dib-&gt;demux.start_feed
op_assign
id|dibusb_start_feed
suffix:semicolon
id|dib-&gt;demux.stop_feed
op_assign
id|dibusb_stop_feed
suffix:semicolon
id|dib-&gt;demux.write_to_decoder
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_dmx_init
c_func
(paren
op_amp
id|dib-&gt;demux
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;dvb_dmx_init failed: error %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err_dmx
suffix:semicolon
)brace
id|dib-&gt;dmxdev.filternum
op_assign
id|dib-&gt;demux.filternum
suffix:semicolon
id|dib-&gt;dmxdev.demux
op_assign
op_amp
id|dib-&gt;demux.dmx
suffix:semicolon
id|dib-&gt;dmxdev.capabilities
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_dmxdev_init
c_func
(paren
op_amp
id|dib-&gt;dmxdev
comma
id|dib-&gt;adapter
)paren
)paren
OL
l_int|0
)paren
(brace
id|err
c_func
(paren
l_string|&quot;dvb_dmxdev_init failed: error %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err_dmx_dev
suffix:semicolon
)brace
id|dvb_net_init
c_func
(paren
id|dib-&gt;adapter
comma
op_amp
id|dib-&gt;dvb_net
comma
op_amp
id|dib-&gt;demux.dmx
)paren
suffix:semicolon
r_goto
id|success
suffix:semicolon
id|err_dmx_dev
suffix:colon
id|dvb_dmx_release
c_func
(paren
op_amp
id|dib-&gt;demux
)paren
suffix:semicolon
id|err_dmx
suffix:colon
id|i2c_del_adapter
c_func
(paren
op_amp
id|dib-&gt;i2c_adap
)paren
suffix:semicolon
id|err_i2c
suffix:colon
id|dvb_unregister_adapter
c_func
(paren
id|dib-&gt;adapter
)paren
suffix:semicolon
id|err
suffix:colon
r_return
id|ret
suffix:semicolon
id|success
suffix:colon
id|dib-&gt;dvb_is_ready
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_dvb_exit
r_static
r_int
id|dibusb_dvb_exit
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
id|dib-&gt;dvb_is_ready
op_assign
l_int|0
suffix:semicolon
id|deb_info
c_func
(paren
l_string|&quot;unregistering DVB part&bslash;n&quot;
)paren
suffix:semicolon
id|dvb_net_release
c_func
(paren
op_amp
id|dib-&gt;dvb_net
)paren
suffix:semicolon
id|dib-&gt;demux.dmx
dot
id|close
c_func
(paren
op_amp
id|dib-&gt;demux.dmx
)paren
suffix:semicolon
id|dvb_dmxdev_release
c_func
(paren
op_amp
id|dib-&gt;dmxdev
)paren
suffix:semicolon
id|dvb_dmx_release
c_func
(paren
op_amp
id|dib-&gt;demux
)paren
suffix:semicolon
id|i2c_del_adapter
c_func
(paren
op_amp
id|dib-&gt;i2c_adap
)paren
suffix:semicolon
id|dvb_unregister_adapter
c_func
(paren
id|dib-&gt;adapter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_exit
r_static
r_int
id|dibusb_exit
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DIBUSB_TS_NUM_URBS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dib-&gt;buf_urb
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|deb_info
c_func
(paren
l_string|&quot;killing URB no. %d.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|usb_kill_urb
c_func
(paren
id|dib-&gt;buf_urb
(braket
id|i
)braket
)paren
suffix:semicolon
singleline_comment|// TODO kernel version ifdef for unlink_urb
id|deb_info
c_func
(paren
l_string|&quot;freeing URB no. %d.&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|dib-&gt;buf_urb
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
l_int|NULL
comma
id|DIBUSB_TS_BUFFER_SIZE
comma
id|dib-&gt;buffer
comma
id|dib-&gt;dma_handle
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_init
r_static
r_int
id|dibusb_init
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_int
id|ret
comma
id|i
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|dib-&gt;usb_sem
comma
l_int|1
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|dib-&gt;i2c_sem
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * when reloading the driver w/o replugging the device&n;&t; * a timeout occures, this helps&n;&t; */
id|usb_clear_halt
c_func
(paren
id|dib-&gt;udev
comma
id|COMMAND_PIPE
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|dib-&gt;udev
comma
id|RESULT_PIPE
)paren
suffix:semicolon
id|usb_clear_halt
c_func
(paren
id|dib-&gt;udev
comma
id|DATA_PIPE
)paren
suffix:semicolon
multiline_comment|/* dibusb_reset_cpu(dib); */
r_if
c_cond
(paren
(paren
id|dib-&gt;buffer
op_assign
id|pci_alloc_consistent
c_func
(paren
l_int|NULL
comma
id|DIBUSB_TS_BUFFER_SIZE
comma
op_amp
id|dib-&gt;dma_handle
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dib-&gt;buffer
comma
l_int|0
comma
id|DIBUSB_TS_BUFFER_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DIBUSB_TS_NUM_URBS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dib-&gt;buf_urb
(braket
id|i
)braket
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|dibusb_exit
c_func
(paren
id|dib
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|deb_info
c_func
(paren
l_string|&quot;submitting URB no. %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|usb_fill_bulk_urb
c_func
(paren
id|dib-&gt;buf_urb
(braket
id|i
)braket
comma
id|dib-&gt;udev
comma
id|DATA_PIPE
comma
op_amp
id|dib-&gt;buffer
(braket
id|i
op_star
id|DIBUSB_TS_URB_BUFFER_SIZE
)braket
comma
id|DIBUSB_TS_URB_BUFFER_SIZE
comma
id|dibusb_urb_complete
comma
id|dib
)paren
suffix:semicolon
id|dib-&gt;buf_urb
(braket
id|i
)braket
op_member_access_from_pointer
id|transfer_flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|usb_submit_urb
c_func
(paren
id|dib-&gt;buf_urb
(braket
id|i
)braket
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;could not submit buffer urb no. %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|dibusb_exit
c_func
(paren
id|dib
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DIBUSB_MAX_PIDS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|reg
op_assign
id|i
op_plus
id|DIB3000MB_REG_FIRST_PID
suffix:semicolon
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|pid
op_assign
l_int|0
suffix:semicolon
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|active
op_assign
l_int|0
suffix:semicolon
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|dib
op_assign
id|dib
suffix:semicolon
)brace
id|dib-&gt;feedcount
op_assign
l_int|0
suffix:semicolon
id|dib-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|dib-&gt;dvb_is_ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dibusb_dvb_init
c_func
(paren
id|dib
)paren
)paren
)paren
(brace
id|dibusb_exit
c_func
(paren
id|dib
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * load a firmware packet to the device&n; */
DECL|function|dibusb_writemem
r_static
r_int
id|dibusb_writemem
c_func
(paren
r_struct
id|usb_device
op_star
id|udev
comma
id|u16
id|addr
comma
id|u8
op_star
id|data
comma
id|u8
id|len
)paren
(brace
r_return
id|usb_control_msg
c_func
(paren
id|udev
comma
id|usb_sndctrlpipe
c_func
(paren
id|udev
comma
l_int|0
)paren
comma
l_int|0xa0
comma
id|USB_TYPE_VENDOR
comma
id|addr
comma
l_int|0x00
comma
id|data
comma
id|len
comma
l_int|5
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|dibusb_loadfirmware
r_static
r_int
id|dibusb_loadfirmware
c_func
(paren
r_struct
id|usb_device
op_star
id|udev
comma
r_struct
id|dibusb_device
op_star
id|dibdev
)paren
(brace
r_const
r_struct
id|firmware
op_star
id|fw
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|addr
suffix:semicolon
id|u8
op_star
id|b
comma
op_star
id|p
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|valid_firmware_filenames
)paren
op_div
r_sizeof
(paren
r_const
r_char
op_star
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|request_firmware
c_func
(paren
op_amp
id|fw
comma
id|valid_firmware_filenames
(braket
id|i
)braket
comma
op_amp
id|udev-&gt;dev
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|info
c_func
(paren
l_string|&quot;using firmware file (%s).&quot;
comma
id|valid_firmware_filenames
(braket
id|i
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|deb_info
c_func
(paren
l_string|&quot;tried to find &squot;%s&squot; firmware - unsuccessful. (%d)&bslash;n&quot;
comma
id|valid_firmware_filenames
(braket
id|i
)braket
comma
id|ret
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fw
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;did not find a valid firmware file. &quot;
l_string|&quot;Please see linux/Documentation/dvb/ for more details on firmware-problems.&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|p
op_assign
id|kmalloc
c_func
(paren
id|fw-&gt;size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
l_int|NULL
)paren
(brace
id|u8
id|reset
suffix:semicolon
multiline_comment|/*&n;&t;&t; * you cannot use the fw-&gt;data as buffer for&n;&t;&t; * usb_control_msg, a new buffer has to be&n;&t;&t; * created&n;&t;&t; */
id|memcpy
c_func
(paren
id|p
comma
id|fw-&gt;data
comma
id|fw-&gt;size
)paren
suffix:semicolon
multiline_comment|/* stop the CPU */
id|reset
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dibusb_writemem
c_func
(paren
id|udev
comma
id|DIBUSB_CPU_CSREG
comma
op_amp
id|reset
comma
l_int|1
)paren
)paren
op_ne
l_int|1
)paren
id|err
c_func
(paren
l_string|&quot;could not stop the USB controller CPU.&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|p
(braket
id|i
op_plus
l_int|3
)braket
op_eq
l_int|0
op_logical_and
id|i
OL
id|fw-&gt;size
suffix:semicolon
)paren
(brace
id|b
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|p
(braket
id|i
)braket
suffix:semicolon
id|addr
op_assign
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|b
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|ret
op_assign
id|dibusb_writemem
c_func
(paren
id|udev
comma
id|addr
comma
op_amp
id|b
(braket
l_int|4
)braket
comma
id|b
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|b
(braket
l_int|0
)braket
)paren
(brace
id|err
c_func
(paren
l_string|&quot;error while transferring firmware &quot;
l_string|&quot;(transferred size: %d, block size: %d)&quot;
comma
id|ret
comma
id|b
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_add_assign
l_int|5
op_plus
id|b
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/* length in ret */
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* restart the CPU */
id|reset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_or
id|dibusb_writemem
c_func
(paren
id|udev
comma
id|DIBUSB_CPU_CSREG
comma
op_amp
id|reset
comma
l_int|1
)paren
op_ne
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;could not restart the USB controller CPU.&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|release_firmware
c_func
(paren
id|fw
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * USB&n; */
DECL|function|dibusb_probe
r_static
r_int
id|dibusb_probe
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_device
op_star
id|udev
op_assign
id|interface_to_usbdev
c_func
(paren
id|intf
)paren
suffix:semicolon
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dibusb_device
op_star
id|dibdev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOMEM
comma
id|i
comma
id|cold
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DIBUSB_SUPPORTED_DEVICES
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|dibusb_devices
(braket
id|i
)braket
dot
id|cold_product_id
op_eq
id|udev-&gt;descriptor.idProduct
op_logical_or
id|dibusb_devices
(braket
id|i
)braket
dot
id|warm_product_id
op_eq
id|udev-&gt;descriptor.idProduct
)paren
(brace
id|dibdev
op_assign
op_amp
id|dibusb_devices
(braket
id|i
)braket
suffix:semicolon
id|cold
op_assign
id|dibdev-&gt;cold_product_id
op_eq
id|udev-&gt;descriptor.idProduct
suffix:semicolon
r_if
c_cond
(paren
id|cold
)paren
id|info
c_func
(paren
l_string|&quot;found a &squot;%s&squot; in cold state, will try to load a firmware&quot;
comma
id|dibdev-&gt;name
)paren
suffix:semicolon
r_else
id|info
c_func
(paren
l_string|&quot;found a &squot;%s&squot; in warm state.&quot;
comma
id|dibdev-&gt;name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dibdev
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;something went very wrong, &quot;
l_string|&quot;unknown product ID: %.4x&quot;
comma
id|udev-&gt;descriptor.idProduct
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cold
)paren
id|ret
op_assign
id|dibusb_loadfirmware
c_func
(paren
id|udev
comma
id|dibdev
)paren
suffix:semicolon
r_else
(brace
id|dib
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|usb_dibusb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dib
op_eq
l_int|NULL
)paren
(brace
id|err
c_func
(paren
l_string|&quot;no memory&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dib
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|usb_dibusb
)paren
)paren
suffix:semicolon
id|dib-&gt;udev
op_assign
id|udev
suffix:semicolon
id|dib-&gt;dibdev
op_assign
id|dibdev
suffix:semicolon
id|usb_set_intfdata
c_func
(paren
id|intf
comma
id|dib
)paren
suffix:semicolon
id|ret
op_assign
id|dibusb_init
c_func
(paren
id|dib
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|info
c_func
(paren
l_string|&quot;%s successfully initialized and connected.&quot;
comma
id|dibdev-&gt;name
)paren
suffix:semicolon
r_else
id|info
c_func
(paren
l_string|&quot;%s error while loading driver (%d)&quot;
comma
id|dibdev-&gt;name
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dibusb_disconnect
r_static
r_void
id|dibusb_disconnect
c_func
(paren
r_struct
id|usb_interface
op_star
id|intf
)paren
(brace
r_struct
id|usb_dibusb
op_star
id|dib
op_assign
id|usb_get_intfdata
c_func
(paren
id|intf
)paren
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|DRIVER_DESC
suffix:semicolon
id|usb_set_intfdata
c_func
(paren
id|intf
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dib
op_ne
l_int|NULL
)paren
(brace
id|name
op_assign
id|dib-&gt;dibdev-&gt;name
suffix:semicolon
id|dibusb_dvb_exit
c_func
(paren
id|dib
)paren
suffix:semicolon
id|dibusb_exit
c_func
(paren
id|dib
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dib
)paren
suffix:semicolon
)brace
id|info
c_func
(paren
l_string|&quot;%s successfully deinitialized and disconnected.&quot;
comma
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/* usb specific object needed to register this driver with the usb subsystem */
DECL|variable|dibusb_driver
r_static
r_struct
id|usb_driver
id|dibusb_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;dvb_dibusb&quot;
comma
dot
id|probe
op_assign
id|dibusb_probe
comma
dot
id|disconnect
op_assign
id|dibusb_disconnect
comma
dot
id|id_table
op_assign
id|dibusb_table
comma
)brace
suffix:semicolon
multiline_comment|/* module stuff */
DECL|function|usb_dibusb_init
r_static
r_int
id|__init
id|usb_dibusb_init
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|usb_register
c_func
(paren
op_amp
id|dibusb_driver
)paren
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;usb_register failed. Error number %d&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_dibusb_exit
r_static
r_void
id|__exit
id|usb_dibusb_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* deregister this driver from the USB subsystem */
id|usb_deregister
c_func
(paren
op_amp
id|dibusb_driver
)paren
suffix:semicolon
)brace
DECL|variable|usb_dibusb_init
id|module_init
(paren
id|usb_dibusb_init
)paren
suffix:semicolon
DECL|variable|usb_dibusb_exit
id|module_exit
(paren
id|usb_dibusb_exit
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
