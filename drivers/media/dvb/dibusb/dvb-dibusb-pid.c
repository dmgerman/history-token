multiline_comment|/*&n; * dvb-dibusb-pid.c is part of the driver for mobile USB Budget DVB-T devices &n; * based on reference design made by DiBcom (http://www.dibcom.fr/)&n; *&n; * Copyright (C) 2004-5 Patrick Boettcher (patrick.boettcher@desy.de)&n; *&n; * see dvb-dibusb-core.c for more copyright details.&n; *&n; * This file contains functions for initializing and handling the internal&n; * pid-list. This pid-list mirrors the information currently stored in the&n; * devices pid-list.&n; */
macro_line|#include &quot;dvb-dibusb.h&quot;
DECL|function|dibusb_pid_list_init
r_int
id|dibusb_pid_list_init
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_int
id|i
suffix:semicolon
id|dib-&gt;pid_list
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dibusb_pid
)paren
op_star
id|dib-&gt;dibdev-&gt;dev_cl-&gt;demod-&gt;pid_filter_count
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;pid_list
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|deb_xfer
c_func
(paren
l_string|&quot;initializing %d pids for the pid_list.&bslash;n&quot;
comma
id|dib-&gt;dibdev-&gt;dev_cl-&gt;demod-&gt;pid_filter_count
)paren
suffix:semicolon
id|dib-&gt;pid_list_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|memset
c_func
(paren
id|dib-&gt;pid_list
comma
l_int|0
comma
id|dib-&gt;dibdev-&gt;dev_cl-&gt;demod-&gt;pid_filter_count
op_star
(paren
r_sizeof
(paren
r_struct
id|dibusb_pid
)paren
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dib-&gt;dibdev-&gt;dev_cl-&gt;demod-&gt;pid_filter_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|index
op_assign
id|i
suffix:semicolon
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|pid
op_assign
l_int|0
suffix:semicolon
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|active
op_assign
l_int|0
suffix:semicolon
)brace
id|dib-&gt;init_state
op_or_assign
id|DIBUSB_STATE_PIDLIST
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dibusb_pid_list_exit
r_void
id|dibusb_pid_list_exit
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
)paren
(brace
r_if
c_cond
(paren
id|dib-&gt;init_state
op_amp
id|DIBUSB_STATE_PIDLIST
)paren
id|kfree
c_func
(paren
id|dib-&gt;pid_list
)paren
suffix:semicolon
id|dib-&gt;init_state
op_and_assign
op_complement
id|DIBUSB_STATE_PIDLIST
suffix:semicolon
)brace
multiline_comment|/* fetch a pid from pid_list and set it on or off */
DECL|function|dibusb_ctrl_pid
r_int
id|dibusb_ctrl_pid
c_func
(paren
r_struct
id|usb_dibusb
op_star
id|dib
comma
r_struct
id|dvb_demux_feed
op_star
id|dvbdmxfeed
comma
r_int
id|onoff
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|pid
op_assign
id|dvbdmxfeed-&gt;pid
suffix:semicolon
r_if
c_cond
(paren
id|onoff
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dib-&gt;pid_list_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dib-&gt;dibdev-&gt;dev_cl-&gt;demod-&gt;pid_filter_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|active
)paren
(brace
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|pid
op_assign
id|pid
suffix:semicolon
id|dib-&gt;pid_list
(braket
id|i
)braket
dot
id|active
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dvbdmxfeed-&gt;priv
op_assign
op_amp
id|dib-&gt;pid_list
(braket
id|ret
)braket
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dib-&gt;pid_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;xfer_ops.pid_ctrl
op_ne
l_int|NULL
)paren
id|dib-&gt;xfer_ops
dot
id|pid_ctrl
c_func
(paren
id|dib-&gt;fe
comma
id|dib-&gt;pid_list
(braket
id|ret
)braket
dot
id|index
comma
id|dib-&gt;pid_list
(braket
id|ret
)braket
dot
id|pid
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dibusb_pid
op_star
id|dpid
op_assign
id|dvbdmxfeed-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|dib-&gt;xfer_ops.pid_ctrl
op_ne
l_int|NULL
)paren
id|dib-&gt;xfer_ops
dot
id|pid_ctrl
c_func
(paren
id|dib-&gt;fe
comma
id|dpid-&gt;index
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
id|dpid-&gt;index
suffix:semicolon
id|dpid-&gt;pid
op_assign
l_int|0
suffix:semicolon
id|dpid-&gt;active
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* a free pid from the list */
id|deb_xfer
c_func
(paren
l_string|&quot;setting pid: %5d %04x at index %d &squot;%s&squot;&bslash;n&quot;
comma
id|pid
comma
id|pid
comma
id|ret
comma
id|onoff
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
