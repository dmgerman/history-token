multiline_comment|/*&n; * dvb_ca.c: generic DVB functions for EN50221 CAM interfaces&n; *&n; * Copyright (C) 2004 Andrew de Quincey&n; *&n; * Parts of this file were based on sources as follows:&n; *&n; * Copyright (C) 2003 Ralph Metzler &lt;rjkm@metzlerbros.de&gt;&n; *&n; * based on code:&n; *&n; * Copyright (C) 1999-2002 Ralph  Metzler&n; *                       &amp; Marcus Metzler for convergence integrated media GmbH&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version 2&n; * of the License, or (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; * Or, point your browser to http://www.gnu.org/copyleft/gpl.html&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/rwsem.h&gt;
macro_line|#include &quot;dvb_ca_en50221.h&quot;
macro_line|#include &quot;dvb_ringbuffer.h&quot;
DECL|variable|dvb_ca_en50221_debug
r_static
r_int
id|dvb_ca_en50221_debug
suffix:semicolon
id|module_param_named
c_func
(paren
id|cam_debug
comma
id|dvb_ca_en50221_debug
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|cam_debug
comma
l_string|&quot;enable verbose debug messages&quot;
)paren
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk if (dvb_ca_en50221_debug) printk
DECL|macro|INIT_TIMEOUT_SECS
mdefine_line|#define INIT_TIMEOUT_SECS 5
DECL|macro|HOST_LINK_BUF_SIZE
mdefine_line|#define HOST_LINK_BUF_SIZE 0x200
DECL|macro|RX_BUFFER_SIZE
mdefine_line|#define RX_BUFFER_SIZE 65535
DECL|macro|MAX_RX_PACKETS_PER_ITERATION
mdefine_line|#define MAX_RX_PACKETS_PER_ITERATION 10
DECL|macro|CTRLIF_DATA
mdefine_line|#define CTRLIF_DATA      0
DECL|macro|CTRLIF_COMMAND
mdefine_line|#define CTRLIF_COMMAND   1
DECL|macro|CTRLIF_STATUS
mdefine_line|#define CTRLIF_STATUS    1
DECL|macro|CTRLIF_SIZE_LOW
mdefine_line|#define CTRLIF_SIZE_LOW  2
DECL|macro|CTRLIF_SIZE_HIGH
mdefine_line|#define CTRLIF_SIZE_HIGH 3
DECL|macro|CMDREG_HC
mdefine_line|#define CMDREG_HC        1 /* Host control */
DECL|macro|CMDREG_SW
mdefine_line|#define CMDREG_SW        2 /* Size write */
DECL|macro|CMDREG_SR
mdefine_line|#define CMDREG_SR        4 /* Size read */
DECL|macro|CMDREG_RS
mdefine_line|#define CMDREG_RS        8 /* Reset interface */
DECL|macro|CMDREG_FRIE
mdefine_line|#define CMDREG_FRIE   0x40 /* Enable FR interrupt */
DECL|macro|CMDREG_DAIE
mdefine_line|#define CMDREG_DAIE   0x80 /* Enable DA interrupt */
DECL|macro|IRQEN
mdefine_line|#define IRQEN (CMDREG_DAIE)
DECL|macro|STATUSREG_RE
mdefine_line|#define STATUSREG_RE     1 /* read error */
DECL|macro|STATUSREG_WE
mdefine_line|#define STATUSREG_WE     2 /* write error */
DECL|macro|STATUSREG_FR
mdefine_line|#define STATUSREG_FR  0x40 /* module free */
DECL|macro|STATUSREG_DA
mdefine_line|#define STATUSREG_DA  0x80 /* data available */
DECL|macro|STATUSREG_TXERR
mdefine_line|#define STATUSREG_TXERR (STATUSREG_RE|STATUSREG_WE) /* general transfer error */
DECL|macro|DVB_CA_SLOTSTATE_NONE
mdefine_line|#define DVB_CA_SLOTSTATE_NONE           0
DECL|macro|DVB_CA_SLOTSTATE_UNINITIALISED
mdefine_line|#define DVB_CA_SLOTSTATE_UNINITIALISED  1
DECL|macro|DVB_CA_SLOTSTATE_RUNNING
mdefine_line|#define DVB_CA_SLOTSTATE_RUNNING        2
DECL|macro|DVB_CA_SLOTSTATE_INVALID
mdefine_line|#define DVB_CA_SLOTSTATE_INVALID        3
DECL|macro|DVB_CA_SLOTSTATE_WAITREADY
mdefine_line|#define DVB_CA_SLOTSTATE_WAITREADY      4
DECL|macro|DVB_CA_SLOTSTATE_VALIDATE
mdefine_line|#define DVB_CA_SLOTSTATE_VALIDATE       5
DECL|macro|DVB_CA_SLOTSTATE_WAITFR
mdefine_line|#define DVB_CA_SLOTSTATE_WAITFR         6
DECL|macro|DVB_CA_SLOTSTATE_LINKINIT
mdefine_line|#define DVB_CA_SLOTSTATE_LINKINIT       7
multiline_comment|/* Information on a CA slot */
DECL|struct|dvb_ca_slot
r_struct
id|dvb_ca_slot
(brace
multiline_comment|/* current state of the CAM */
DECL|member|slot_state
r_int
id|slot_state
suffix:semicolon
multiline_comment|/* Number of CAMCHANGES that have occurred since last processing */
DECL|member|camchange_count
id|atomic_t
id|camchange_count
suffix:semicolon
multiline_comment|/* Type of last CAMCHANGE */
DECL|member|camchange_type
r_int
id|camchange_type
suffix:semicolon
multiline_comment|/* base address of CAM config */
DECL|member|config_base
id|u32
id|config_base
suffix:semicolon
multiline_comment|/* value to write into Config Control register */
DECL|member|config_option
id|u8
id|config_option
suffix:semicolon
multiline_comment|/* if 1, the CAM supports DA IRQs */
DECL|member|da_irq_supported
id|u8
id|da_irq_supported
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* size of the buffer to use when talking to the CAM */
DECL|member|link_buf_size
r_int
id|link_buf_size
suffix:semicolon
multiline_comment|/* semaphore for syncing access to slot structure */
DECL|member|sem
r_struct
id|rw_semaphore
id|sem
suffix:semicolon
multiline_comment|/* buffer for incoming packets */
DECL|member|rx_buffer
r_struct
id|dvb_ringbuffer
id|rx_buffer
suffix:semicolon
multiline_comment|/* timer used during various states of the slot */
DECL|member|timeout
r_int
r_int
id|timeout
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Private CA-interface information */
DECL|struct|dvb_ca_private
r_struct
id|dvb_ca_private
(brace
multiline_comment|/* pointer back to the public data structure */
DECL|member|pub
r_struct
id|dvb_ca_en50221
op_star
id|pub
suffix:semicolon
multiline_comment|/* the DVB device */
DECL|member|dvbdev
r_struct
id|dvb_device
op_star
id|dvbdev
suffix:semicolon
multiline_comment|/* Flags describing the interface (DVB_CA_FLAG_*) */
DECL|member|flags
id|u32
id|flags
suffix:semicolon
multiline_comment|/* number of slots supported by this CA interface */
DECL|member|slot_count
r_int
r_int
id|slot_count
suffix:semicolon
multiline_comment|/* information on each slot */
DECL|member|slot_info
r_struct
id|dvb_ca_slot
op_star
id|slot_info
suffix:semicolon
multiline_comment|/* wait queues for read() and write() operations */
DECL|member|wait_queue
id|wait_queue_head_t
id|wait_queue
suffix:semicolon
multiline_comment|/* PID of the monitoring thread */
DECL|member|thread_pid
id|pid_t
id|thread_pid
suffix:semicolon
multiline_comment|/* Wait queue used when shutting thread down */
DECL|member|thread_queue
id|wait_queue_head_t
id|thread_queue
suffix:semicolon
multiline_comment|/* Flag indicating when thread should exit */
DECL|member|exit
r_int
m_exit
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Flag indicating if the CA device is open */
DECL|member|open
r_int
id|open
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Flag indicating the thread should wake up now */
DECL|member|wakeup
r_int
id|wakeup
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Delay the main thread should use */
DECL|member|delay
r_int
r_int
id|delay
suffix:semicolon
multiline_comment|/* Slot to start looking for data to read from in the next user-space read operation */
DECL|member|next_read_slot
r_int
id|next_read_slot
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|dvb_ca_en50221_thread_wakeup
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
)paren
suffix:semicolon
r_static
r_int
id|dvb_ca_en50221_read_data
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
comma
id|u8
op_star
id|ebuf
comma
r_int
id|ecount
)paren
suffix:semicolon
r_static
r_int
id|dvb_ca_en50221_write_data
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
comma
id|u8
op_star
id|ebuf
comma
r_int
id|ecount
)paren
suffix:semicolon
multiline_comment|/**&n; * Safely find needle in haystack.&n; *&n; * @param haystack Buffer to look in.&n; * @param hlen Number of bytes in haystack.&n; * @param needle Buffer to find.&n; * @param nlen Number of bytes in needle.&n; * @return Pointer into haystack needle was found at, or NULL if not found.&n; */
DECL|function|findstr
r_static
id|u8
op_star
id|findstr
c_func
(paren
id|u8
op_star
id|haystack
comma
r_int
id|hlen
comma
id|u8
op_star
id|needle
comma
r_int
id|nlen
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|hlen
OL
id|nlen
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|hlen
op_minus
id|nlen
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|haystack
op_plus
id|i
comma
id|needle
comma
id|nlen
)paren
)paren
r_return
id|haystack
op_plus
id|i
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************************** */
multiline_comment|/* EN50221 physical interface functions */
multiline_comment|/**&n; * Check CAM status.&n; */
DECL|function|dvb_ca_en50221_check_camstatus
r_static
r_int
id|dvb_ca_en50221_check_camstatus
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
)paren
(brace
r_int
id|slot_status
suffix:semicolon
r_int
id|cam_present_now
suffix:semicolon
r_int
id|cam_changed
suffix:semicolon
multiline_comment|/* IRQ mode */
r_if
c_cond
(paren
id|ca-&gt;flags
op_amp
id|DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE
)paren
(brace
r_return
(paren
id|atomic_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|camchange_count
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* poll mode */
id|slot_status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|poll_slot_status
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|ca-&gt;open
)paren
suffix:semicolon
id|cam_present_now
op_assign
(paren
id|slot_status
op_amp
id|DVB_CA_EN50221_POLL_CAM_PRESENT
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|cam_changed
op_assign
(paren
id|slot_status
op_amp
id|DVB_CA_EN50221_POLL_CAM_CHANGED
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cam_changed
)paren
(brace
r_int
id|cam_present_old
op_assign
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_ne
id|DVB_CA_SLOTSTATE_NONE
)paren
suffix:semicolon
id|cam_changed
op_assign
(paren
id|cam_present_now
op_ne
id|cam_present_old
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cam_changed
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cam_present_now
)paren
(brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|camchange_type
op_assign
id|DVB_CA_EN50221_CAMCHANGE_REMOVED
suffix:semicolon
)brace
r_else
(brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|camchange_type
op_assign
id|DVB_CA_EN50221_CAMCHANGE_INSERTED
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|camchange_count
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_eq
id|DVB_CA_SLOTSTATE_WAITREADY
)paren
op_logical_and
(paren
id|slot_status
op_amp
id|DVB_CA_EN50221_POLL_CAM_READY
)paren
)paren
(brace
singleline_comment|// move to validate state if reset is completed
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_VALIDATE
suffix:semicolon
)brace
)brace
r_return
id|cam_changed
suffix:semicolon
)brace
multiline_comment|/**&n; * Wait for flags to become set on the STATUS register on a CAM interface,&n; * checking for errors and timeout.&n; *&n; * @param ca CA instance.&n; * @param slot Slot on interface.&n; * @param waitfor Flags to wait for.&n; * @param timeout_ms Timeout in milliseconds.&n; *&n; * @return 0 on success, nonzero on error.&n; */
DECL|function|dvb_ca_en50221_wait_if_status
r_static
r_int
id|dvb_ca_en50221_wait_if_status
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
comma
id|u8
id|waitfor
comma
r_int
id|timeout_hz
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
r_int
r_int
id|start
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* loop until timeout elapsed */
id|start
op_assign
id|jiffies
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|timeout_hz
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* read the status and check for error */
r_int
id|res
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* if we got the flags, it was successful! */
r_if
c_cond
(paren
id|res
op_amp
id|waitfor
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s succeeded timeout:%lu&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|jiffies
op_minus
id|start
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* check for timeout */
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* wait for a bit */
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;%s failed timeout:%lu&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|jiffies
op_minus
id|start
)paren
suffix:semicolon
multiline_comment|/* if we get here, we&squot;ve timed out */
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/**&n; * Initialise the link layer connection to a CAM.&n; *&n; * @param ca CA instance.&n; * @param slot Slot id.&n; *&n; * @return 0 on success, nonzero on failure.&n; */
DECL|function|dvb_ca_en50221_link_init
r_static
r_int
id|dvb_ca_en50221_link_init
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|buf_size
suffix:semicolon
id|u8
id|buf
(braket
l_int|2
)braket
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* we&squot;ll be determining these during this function */
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|da_irq_supported
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set the host link buffer size temporarily. it will be overwritten with the&n;         * real negotiated size later. */
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|link_buf_size
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* read the buffer size from the CAM */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_COMMAND
comma
id|IRQEN
op_or
id|CMDREG_SR
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_ca_en50221_wait_if_status
c_func
(paren
id|ca
comma
id|slot
comma
id|STATUSREG_DA
comma
id|HZ
op_div
l_int|10
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_ca_en50221_read_data
c_func
(paren
id|ca
comma
id|slot
comma
id|buf
comma
l_int|2
)paren
)paren
op_ne
l_int|2
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_COMMAND
comma
id|IRQEN
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* store it, and choose the minimum of our buffer and the CAM&squot;s buffer size */
id|buf_size
op_assign
(paren
id|buf
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|buf
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|buf_size
OG
id|HOST_LINK_BUF_SIZE
)paren
id|buf_size
op_assign
id|HOST_LINK_BUF_SIZE
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|link_buf_size
op_assign
id|buf_size
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|buf_size
op_rshift
l_int|8
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|buf_size
op_amp
l_int|0xff
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Chosen link buffer size of %i&bslash;n&quot;
comma
id|buf_size
)paren
suffix:semicolon
multiline_comment|/* write the buffer size to the CAM */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_COMMAND
comma
id|IRQEN
op_or
id|CMDREG_SW
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_ca_en50221_wait_if_status
c_func
(paren
id|ca
comma
id|slot
comma
id|STATUSREG_FR
comma
id|HZ
op_div
l_int|10
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|dvb_ca_en50221_write_data
c_func
(paren
id|ca
comma
id|slot
comma
id|buf
comma
l_int|2
)paren
)paren
op_ne
l_int|2
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_COMMAND
comma
id|IRQEN
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
multiline_comment|/* success */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Read a tuple from attribute memory.&n; *&n; * @param ca CA instance.&n; * @param slot Slot id.&n; * @param address Address to read from. Updated.&n; * @param tupleType Tuple id byte. Updated.&n; * @param tupleLength Tuple length. Updated.&n; * @param tuple Dest buffer for tuple (must be 256 bytes). Updated.&n; *&n; * @return 0 on success, nonzero on error.&n; */
DECL|function|dvb_ca_en50221_read_tuple
r_static
r_int
id|dvb_ca_en50221_read_tuple
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
comma
r_int
op_star
id|address
comma
r_int
op_star
id|tupleType
comma
r_int
op_star
id|tupleLength
comma
id|u8
op_star
id|tuple
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|_tupleType
suffix:semicolon
r_int
id|_tupleLength
suffix:semicolon
r_int
id|_address
op_assign
op_star
id|address
suffix:semicolon
multiline_comment|/* grab the next tuple length and type */
r_if
c_cond
(paren
(paren
id|_tupleType
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_attribute_mem
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|_address
)paren
)paren
OL
l_int|0
)paren
r_return
id|_tupleType
suffix:semicolon
r_if
c_cond
(paren
id|_tupleType
op_eq
l_int|0xff
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;END OF CHAIN TUPLE type:0x%x&bslash;n&quot;
comma
id|_tupleType
)paren
suffix:semicolon
op_star
id|address
op_add_assign
l_int|2
suffix:semicolon
op_star
id|tupleType
op_assign
id|_tupleType
suffix:semicolon
op_star
id|tupleLength
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|_tupleLength
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_attribute_mem
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|_address
op_plus
l_int|2
)paren
)paren
OL
l_int|0
)paren
r_return
id|_tupleLength
suffix:semicolon
id|_address
op_add_assign
l_int|4
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;TUPLE type:0x%x length:%i&bslash;n&quot;
comma
id|_tupleType
comma
id|_tupleLength
)paren
suffix:semicolon
multiline_comment|/* read in the whole tuple */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|_tupleLength
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tuple
(braket
id|i
)braket
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_attribute_mem
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|_address
op_plus
(paren
id|i
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;  0x%02x: 0x%02x %c&bslash;n&quot;
comma
id|i
comma
id|tuple
(braket
id|i
)braket
op_amp
l_int|0xff
comma
(paren
(paren
id|tuple
(braket
id|i
)braket
OG
l_int|31
)paren
op_logical_and
(paren
id|tuple
(braket
id|i
)braket
OL
l_int|127
)paren
)paren
ques
c_cond
id|tuple
(braket
id|i
)braket
suffix:colon
l_char|&squot;.&squot;
)paren
suffix:semicolon
)brace
id|_address
op_add_assign
(paren
id|_tupleLength
op_star
l_int|2
)paren
suffix:semicolon
singleline_comment|// success
op_star
id|tupleType
op_assign
id|_tupleType
suffix:semicolon
op_star
id|tupleLength
op_assign
id|_tupleLength
suffix:semicolon
op_star
id|address
op_assign
id|_address
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Parse attribute memory of a CAM module, extracting Config register, and checking&n; * it is a DVB CAM module.&n; *&n; * @param ca CA instance.&n; * @param slot Slot id.&n; *&n; * @return 0 on success, &lt;0 on failure.&n; */
DECL|function|dvb_ca_en50221_parse_attributes
r_static
r_int
id|dvb_ca_en50221_parse_attributes
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
)paren
(brace
r_int
id|address
op_assign
l_int|0
suffix:semicolon
r_int
id|tupleLength
suffix:semicolon
r_int
id|tupleType
suffix:semicolon
id|u8
id|tuple
(braket
l_int|257
)braket
suffix:semicolon
r_char
op_star
id|dvb_str
suffix:semicolon
r_int
id|rasz
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|got_cftableentry
op_assign
l_int|0
suffix:semicolon
r_int
id|end_chain
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u16
id|manfid
op_assign
l_int|0
suffix:semicolon
id|u16
id|devid
op_assign
l_int|0
suffix:semicolon
singleline_comment|// CISTPL_DEVICE_0A
r_if
c_cond
(paren
(paren
id|status
op_assign
id|dvb_ca_en50221_read_tuple
c_func
(paren
id|ca
comma
id|slot
comma
op_amp
id|address
comma
op_amp
id|tupleType
comma
op_amp
id|tupleLength
comma
id|tuple
)paren
)paren
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|tupleType
op_ne
l_int|0x1D
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|// CISTPL_DEVICE_0C
r_if
c_cond
(paren
(paren
id|status
op_assign
id|dvb_ca_en50221_read_tuple
c_func
(paren
id|ca
comma
id|slot
comma
op_amp
id|address
comma
op_amp
id|tupleType
comma
op_amp
id|tupleLength
comma
id|tuple
)paren
)paren
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|tupleType
op_ne
l_int|0x1C
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|// CISTPL_VERS_1
r_if
c_cond
(paren
(paren
id|status
op_assign
id|dvb_ca_en50221_read_tuple
c_func
(paren
id|ca
comma
id|slot
comma
op_amp
id|address
comma
op_amp
id|tupleType
comma
op_amp
id|tupleLength
comma
id|tuple
)paren
)paren
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|tupleType
op_ne
l_int|0x15
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|// CISTPL_MANFID
r_if
c_cond
(paren
(paren
id|status
op_assign
id|dvb_ca_en50221_read_tuple
c_func
(paren
id|ca
comma
id|slot
comma
op_amp
id|address
comma
op_amp
id|tupleType
comma
op_amp
id|tupleLength
comma
id|tuple
)paren
)paren
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|tupleType
op_ne
l_int|0x20
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|tupleLength
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|manfid
op_assign
(paren
id|tuple
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|tuple
(braket
l_int|0
)braket
suffix:semicolon
id|devid
op_assign
(paren
id|tuple
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|tuple
(braket
l_int|2
)braket
suffix:semicolon
singleline_comment|// CISTPL_CONFIG
r_if
c_cond
(paren
(paren
id|status
op_assign
id|dvb_ca_en50221_read_tuple
c_func
(paren
id|ca
comma
id|slot
comma
op_amp
id|address
comma
op_amp
id|tupleType
comma
op_amp
id|tupleLength
comma
id|tuple
)paren
)paren
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|tupleType
op_ne
l_int|0x1A
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|tupleLength
OL
l_int|3
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* extract the configbase */
id|rasz
op_assign
id|tuple
(braket
l_int|0
)braket
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|tupleLength
OL
(paren
l_int|3
op_plus
id|rasz
op_plus
l_int|14
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_base
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rasz
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_base
op_or_assign
(paren
id|tuple
(braket
l_int|2
op_plus
id|i
)braket
op_lshift
(paren
l_int|8
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* check it contains the correct DVB string */
id|dvb_str
op_assign
id|findstr
c_func
(paren
id|tuple
comma
id|tupleLength
comma
l_string|&quot;DVB_CI_V&quot;
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvb_str
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|tupleLength
OL
(paren
(paren
id|dvb_str
op_minus
(paren
r_char
op_star
)paren
id|tuple
)paren
op_plus
l_int|12
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* is it a version we support? */
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|dvb_str
op_plus
l_int|8
comma
l_string|&quot;1.00&quot;
comma
l_int|4
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: Unsupported DVB CAM module version %c%c%c%c&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
comma
id|dvb_str
(braket
l_int|8
)braket
comma
id|dvb_str
(braket
l_int|9
)braket
comma
id|dvb_str
(braket
l_int|10
)braket
comma
id|dvb_str
(braket
l_int|11
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* process the CFTABLE_ENTRY tuples, and any after those */
r_while
c_loop
(paren
(paren
op_logical_neg
id|end_chain
)paren
op_logical_and
(paren
id|address
OL
l_int|0x1000
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|dvb_ca_en50221_read_tuple
c_func
(paren
id|ca
comma
id|slot
comma
op_amp
id|address
comma
op_amp
id|tupleType
comma
op_amp
id|tupleLength
comma
id|tuple
)paren
)paren
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_switch
c_cond
(paren
id|tupleType
)paren
(brace
r_case
l_int|0x1B
suffix:colon
singleline_comment|// CISTPL_CFTABLE_ENTRY
r_if
c_cond
(paren
id|tupleLength
OL
(paren
l_int|2
op_plus
l_int|11
op_plus
l_int|17
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* if we&squot;ve already parsed one, just use it */
r_if
c_cond
(paren
id|got_cftableentry
)paren
r_break
suffix:semicolon
multiline_comment|/* get the config option */
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_option
op_assign
id|tuple
(braket
l_int|0
)braket
op_amp
l_int|0x3f
suffix:semicolon
multiline_comment|/* OK, check it contains the correct strings */
r_if
c_cond
(paren
(paren
id|findstr
c_func
(paren
id|tuple
comma
id|tupleLength
comma
l_string|&quot;DVB_HOST&quot;
comma
l_int|8
)paren
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|findstr
c_func
(paren
id|tuple
comma
id|tupleLength
comma
l_string|&quot;DVB_CI_MODULE&quot;
comma
l_int|13
)paren
op_eq
l_int|NULL
)paren
)paren
r_break
suffix:semicolon
id|got_cftableentry
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x14
suffix:colon
singleline_comment|// CISTPL_NO_LINK
r_break
suffix:semicolon
r_case
l_int|0xFF
suffix:colon
singleline_comment|// CISTPL_END
id|end_chain
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Unknown tuple type - just skip this tuple and move to the next one */
id|dprintk
c_func
(paren
l_string|&quot;dvb_ca: Skipping unknown tuple type:0x%x length:0x%x&bslash;n&quot;
comma
id|tupleType
comma
id|tupleLength
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|address
OG
l_int|0x1000
)paren
op_logical_or
(paren
op_logical_neg
id|got_cftableentry
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Valid DVB CAM detected MANID:%x DEVID:%x CONFIGBASE:0x%x CONFIGOPTION:0x%x&bslash;n&quot;
comma
id|manfid
comma
id|devid
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_base
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_option
)paren
suffix:semicolon
singleline_comment|// success!
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Set CAM&squot;s configoption correctly.&n; *&n; * @param ca CA instance.&n; * @param slot Slot containing the CAM.&n; */
DECL|function|dvb_ca_en50221_set_configoption
r_static
r_int
id|dvb_ca_en50221_set_configoption
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
)paren
(brace
r_int
id|configoption
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* set the config option */
id|ca-&gt;pub
op_member_access_from_pointer
id|write_attribute_mem
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_base
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_option
)paren
suffix:semicolon
multiline_comment|/* check it */
id|configoption
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_attribute_mem
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_base
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Set configoption 0x%x, read configoption 0x%x&bslash;n&quot;
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|config_option
comma
id|configoption
op_amp
l_int|0x3f
)paren
suffix:semicolon
multiline_comment|/* fine! */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * This function talks to an EN50221 CAM control interface. It reads a buffer of&n; * data from the CAM. The data can either be stored in a supplied buffer, or&n; * automatically be added to the slot&squot;s rx_buffer.&n; *&n; * @param ca CA instance.&n; * @param slot Slot to read from.&n; * @param ebuf If non-NULL, the data will be written to this buffer. If NULL,&n; * the data will be added into the buffering system as a normal fragment.&n; * @param ecount Size of ebuf. Ignored if ebuf is NULL.&n; *&n; * @return Number of bytes read, or &lt; 0 on error&n; */
DECL|function|dvb_ca_en50221_read_data
r_static
r_int
id|dvb_ca_en50221_read_data
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
comma
id|u8
op_star
id|ebuf
comma
r_int
id|ecount
)paren
(brace
r_int
id|bytes_read
suffix:semicolon
r_int
id|status
suffix:semicolon
id|u8
id|buf
(braket
id|HOST_LINK_BUF_SIZE
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* check if we have space for a link buf in the rx_buffer */
r_if
c_cond
(paren
id|ebuf
op_eq
l_int|NULL
)paren
(brace
r_int
id|buf_free
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer.data
op_eq
l_int|NULL
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|buf_free
op_assign
id|dvb_ringbuffer_free
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf_free
OL
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|link_buf_size
op_plus
id|DVB_RINGBUFFER_PKTHDRSIZE
)paren
)paren
(brace
id|status
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
multiline_comment|/* check if there is data available */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_STATUS
)paren
)paren
OL
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|STATUSREG_DA
)paren
)paren
(brace
multiline_comment|/* no data */
id|status
op_assign
l_int|0
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* read the amount of data */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_SIZE_HIGH
)paren
)paren
OL
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
id|bytes_read
op_assign
id|status
op_lshift
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_SIZE_LOW
)paren
)paren
OL
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
id|bytes_read
op_or_assign
id|status
suffix:semicolon
multiline_comment|/* check it will fit */
r_if
c_cond
(paren
id|ebuf
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|bytes_read
OG
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|link_buf_size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: CAM tried to send a buffer larger than the link buffer size (%i &gt; %i)!&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
comma
id|bytes_read
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|link_buf_size
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_LINKINIT
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bytes_read
OL
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: CAM sent a buffer that was less than 2 bytes!&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_LINKINIT
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|bytes_read
OG
id|ecount
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: CAM tried to send a buffer larger than the ecount size!&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
multiline_comment|/* fill the buffer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bytes_read
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* read byte and check */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_DATA
)paren
)paren
OL
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
multiline_comment|/* OK, store it in the buffer */
id|buf
(braket
id|i
)braket
op_assign
id|status
suffix:semicolon
)brace
multiline_comment|/* check for read error (RE should now be 0) */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_STATUS
)paren
)paren
OL
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|STATUSREG_RE
)paren
(brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_LINKINIT
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* OK, add it to the receive buffer, or copy into external buffer if supplied */
r_if
c_cond
(paren
id|ebuf
op_eq
l_int|NULL
)paren
(brace
id|down_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer.data
op_eq
l_int|NULL
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|dvb_ringbuffer_pkt_write
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
id|buf
comma
id|bytes_read
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|ebuf
comma
id|buf
comma
id|bytes_read
)paren
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;Received CA packet for slot %i connection id 0x%x last_frag:%i size:0x%x&bslash;n&quot;
comma
id|slot
comma
id|buf
(braket
l_int|0
)braket
comma
(paren
id|buf
(braket
l_int|1
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0
comma
id|bytes_read
)paren
suffix:semicolon
multiline_comment|/* wake up readers when a last_fragment is received */
r_if
c_cond
(paren
(paren
id|buf
(braket
l_int|1
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0x00
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|ca-&gt;wait_queue
)paren
suffix:semicolon
)brace
id|status
op_assign
id|bytes_read
suffix:semicolon
m_exit
suffix:colon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/**&n; * This function talks to an EN50221 CAM control interface. It writes a buffer of data&n; * to a CAM.&n; *&n; * @param ca CA instance.&n; * @param slot Slot to write to.&n; * @param ebuf The data in this buffer is treated as a complete link-level packet to&n; * be written.&n; * @param count Size of ebuf.&n; *&n; * @return Number of bytes written, or &lt; 0 on error.&n; */
DECL|function|dvb_ca_en50221_write_data
r_static
r_int
id|dvb_ca_en50221_write_data
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
comma
id|u8
op_star
id|buf
comma
r_int
id|bytes_write
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// sanity check
r_if
c_cond
(paren
id|bytes_write
OG
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|link_buf_size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* check if interface is actually waiting for us to read from it, or if a read is in progress */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_STATUS
)paren
)paren
OL
l_int|0
)paren
r_goto
id|exitnowrite
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|STATUSREG_DA
op_or
id|STATUSREG_RE
)paren
)paren
(brace
id|status
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|exitnowrite
suffix:semicolon
)brace
multiline_comment|/* OK, set HC bit */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_COMMAND
comma
id|IRQEN
op_or
id|CMDREG_HC
)paren
)paren
op_ne
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
multiline_comment|/* check if interface is still free */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_STATUS
)paren
)paren
OL
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|STATUSREG_FR
)paren
)paren
(brace
multiline_comment|/* it wasn&squot;t free =&gt; try again later */
id|status
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* send the amount of data */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_SIZE_HIGH
comma
id|bytes_write
op_rshift
l_int|8
)paren
)paren
op_ne
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_SIZE_LOW
comma
id|bytes_write
op_amp
l_int|0xff
)paren
)paren
op_ne
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
multiline_comment|/* send the buffer */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bytes_write
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_DATA
comma
id|buf
(braket
id|i
)braket
)paren
)paren
op_ne
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* check for write error (WE should now be 0) */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_STATUS
)paren
)paren
OL
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|STATUSREG_WE
)paren
(brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_LINKINIT
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|status
op_assign
id|bytes_write
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Wrote CA packet for slot %i, connection id 0x%x last_frag:%i size:0x%x&bslash;n&quot;
comma
id|slot
comma
id|buf
(braket
l_int|0
)braket
comma
(paren
id|buf
(braket
l_int|1
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0
comma
id|bytes_write
)paren
suffix:semicolon
m_exit
suffix:colon
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_COMMAND
comma
id|IRQEN
)paren
suffix:semicolon
id|exitnowrite
suffix:colon
r_return
id|status
suffix:semicolon
)brace
DECL|variable|dvb_ca_en50221_camchange_irq
id|EXPORT_SYMBOL
c_func
(paren
id|dvb_ca_en50221_camchange_irq
)paren
suffix:semicolon
multiline_comment|/* ******************************************************************************** */
multiline_comment|/* EN50221 higher level functions */
multiline_comment|/**&n; * A CAM has been removed =&gt; shut it down.&n; *&n; * @param ca CA instance.&n; * @param slot Slot to shut down.&n; */
DECL|function|dvb_ca_en50221_slot_shutdown
r_static
r_int
id|dvb_ca_en50221_slot_shutdown
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
id|slot
)paren
(brace
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
id|ca-&gt;pub
op_member_access_from_pointer
id|slot_shutdown
c_func
(paren
id|ca-&gt;pub
comma
id|slot
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_NONE
suffix:semicolon
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer.data
)paren
id|vfree
c_func
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer.data
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer.data
op_assign
l_int|NULL
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
multiline_comment|/* need to wake up all processes to check if they&squot;re now&n;           trying to write to a defunct CAM */
id|wake_up_interruptible
c_func
(paren
op_amp
id|ca-&gt;wait_queue
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Slot %i shutdown&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
multiline_comment|/* success */
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|dvb_ca_en50221_camready_irq
id|EXPORT_SYMBOL
c_func
(paren
id|dvb_ca_en50221_camready_irq
)paren
suffix:semicolon
multiline_comment|/**&n; * A CAMCHANGE IRQ has occurred.&n; *&n; * @param ca CA instance.&n; * @param slot Slot concerned.&n; * @param change_type One of the DVB_CA_CAMCHANGE_* values.&n; */
DECL|function|dvb_ca_en50221_camchange_irq
r_void
id|dvb_ca_en50221_camchange_irq
c_func
(paren
r_struct
id|dvb_ca_en50221
op_star
id|pubca
comma
r_int
id|slot
comma
r_int
id|change_type
)paren
(brace
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|pubca
op_member_access_from_pointer
r_private
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;CAMCHANGE IRQ slot:%i change_type:%i&bslash;n&quot;
comma
id|slot
comma
id|change_type
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|change_type
)paren
(brace
r_case
id|DVB_CA_EN50221_CAMCHANGE_REMOVED
suffix:colon
r_case
id|DVB_CA_EN50221_CAMCHANGE_INSERTED
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|camchange_type
op_assign
id|change_type
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|camchange_count
)paren
suffix:semicolon
id|dvb_ca_en50221_thread_wakeup
c_func
(paren
id|ca
)paren
suffix:semicolon
)brace
DECL|variable|dvb_ca_en50221_frda_irq
id|EXPORT_SYMBOL
c_func
(paren
id|dvb_ca_en50221_frda_irq
)paren
suffix:semicolon
multiline_comment|/**&n; * A CAMREADY IRQ has occurred.&n; *&n; * @param ca CA instance.&n; * @param slot Slot concerned.&n; */
DECL|function|dvb_ca_en50221_camready_irq
r_void
id|dvb_ca_en50221_camready_irq
c_func
(paren
r_struct
id|dvb_ca_en50221
op_star
id|pubca
comma
r_int
id|slot
)paren
(brace
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|pubca
op_member_access_from_pointer
r_private
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;CAMREADY IRQ slot:%i&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_eq
id|DVB_CA_SLOTSTATE_WAITREADY
)paren
(brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_VALIDATE
suffix:semicolon
id|dvb_ca_en50221_thread_wakeup
c_func
(paren
id|ca
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * An FR or DA IRQ has occurred.&n; *&n; * @param ca CA instance.&n; * @param slot Slot concerned.&n; */
DECL|function|dvb_ca_en50221_frda_irq
r_void
id|dvb_ca_en50221_frda_irq
c_func
(paren
r_struct
id|dvb_ca_en50221
op_star
id|pubca
comma
r_int
id|slot
)paren
(brace
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|pubca
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;FR/DA IRQ slot:%i&bslash;n&quot;
comma
id|slot
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
)paren
(brace
r_case
id|DVB_CA_SLOTSTATE_LINKINIT
suffix:colon
id|flags
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|pubca
comma
id|slot
comma
id|CTRLIF_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|STATUSREG_DA
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;CAM supports DA IRQ&bslash;n&quot;
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|da_irq_supported
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_RUNNING
suffix:colon
r_if
c_cond
(paren
id|ca-&gt;open
)paren
id|dvb_ca_en50221_read_data
c_func
(paren
id|ca
comma
id|slot
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* ******************************************************************************** */
multiline_comment|/* EN50221 thread functions */
multiline_comment|/**&n; * Wake up the DVB CA thread&n; *&n; * @param ca CA instance.&n; */
DECL|function|dvb_ca_en50221_thread_wakeup
r_static
r_void
id|dvb_ca_en50221_thread_wakeup
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
)paren
(brace
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ca-&gt;wakeup
op_assign
l_int|1
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ca-&gt;thread_queue
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Used by the CA thread to determine if an early wakeup is necessary&n; *&n; * @param ca CA instance.&n; */
DECL|function|dvb_ca_en50221_thread_should_wakeup
r_static
r_int
id|dvb_ca_en50221_thread_should_wakeup
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
)paren
(brace
r_if
c_cond
(paren
id|ca-&gt;wakeup
)paren
(brace
id|ca-&gt;wakeup
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ca
op_member_access_from_pointer
m_exit
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Update the delay used by the thread.&n; *&n; * @param ca CA instance.&n; */
DECL|function|dvb_ca_en50221_thread_update_delay
r_static
r_void
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
)paren
(brace
r_int
id|delay
suffix:semicolon
r_int
id|curdelay
op_assign
l_int|100000000
suffix:semicolon
r_int
id|slot
suffix:semicolon
r_for
c_loop
(paren
id|slot
op_assign
l_int|0
suffix:semicolon
id|slot
OL
id|ca-&gt;slot_count
suffix:semicolon
id|slot
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
)paren
(brace
r_default
suffix:colon
r_case
id|DVB_CA_SLOTSTATE_NONE
suffix:colon
r_case
id|DVB_CA_SLOTSTATE_INVALID
suffix:colon
id|delay
op_assign
id|HZ
op_star
l_int|60
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ca-&gt;flags
op_amp
id|DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE
)paren
)paren
(brace
id|delay
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_UNINITIALISED
suffix:colon
r_case
id|DVB_CA_SLOTSTATE_WAITREADY
suffix:colon
r_case
id|DVB_CA_SLOTSTATE_VALIDATE
suffix:colon
r_case
id|DVB_CA_SLOTSTATE_WAITFR
suffix:colon
r_case
id|DVB_CA_SLOTSTATE_LINKINIT
suffix:colon
id|delay
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_RUNNING
suffix:colon
id|delay
op_assign
id|HZ
op_star
l_int|60
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ca-&gt;flags
op_amp
id|DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE
)paren
)paren
(brace
id|delay
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ca-&gt;open
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|da_irq_supported
)paren
op_logical_or
(paren
op_logical_neg
(paren
id|ca-&gt;flags
op_amp
id|DVB_CA_EN50221_FLAG_IRQ_DA
)paren
)paren
)paren
(brace
id|delay
op_assign
id|HZ
op_div
l_int|100
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|delay
OL
id|curdelay
)paren
id|curdelay
op_assign
id|delay
suffix:semicolon
)brace
id|ca-&gt;delay
op_assign
id|curdelay
suffix:semicolon
)brace
multiline_comment|/**&n; * Kernel thread which monitors CA slots for CAM changes, and performs data transfers.&n; */
DECL|function|dvb_ca_en50221_thread
r_static
r_int
id|dvb_ca_en50221_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|data
suffix:semicolon
r_char
id|name
(braket
l_int|15
)braket
suffix:semicolon
r_int
id|slot
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|pktcount
suffix:semicolon
r_void
op_star
id|rxbuf
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* setup kernel thread */
id|snprintf
c_func
(paren
id|name
comma
r_sizeof
(paren
id|name
)paren
comma
l_string|&quot;kdvb-ca-%i:%i&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
comma
id|ca-&gt;dvbdev-&gt;id
)paren
suffix:semicolon
id|lock_kernel
(paren
)paren
suffix:semicolon
id|daemonize
(paren
id|name
)paren
suffix:semicolon
id|sigfillset
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
id|unlock_kernel
(paren
)paren
suffix:semicolon
multiline_comment|/* choose the correct initial delay */
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
multiline_comment|/* main loop */
r_while
c_loop
(paren
op_logical_neg
id|ca
op_member_access_from_pointer
m_exit
)paren
(brace
multiline_comment|/* sleep for a bit */
r_if
c_cond
(paren
op_logical_neg
id|ca-&gt;wakeup
)paren
(brace
id|flags
op_assign
id|wait_event_interruptible_timeout
c_func
(paren
id|ca-&gt;thread_queue
comma
id|dvb_ca_en50221_thread_should_wakeup
c_func
(paren
id|ca
)paren
comma
id|ca-&gt;delay
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_eq
op_minus
id|ERESTARTSYS
)paren
op_logical_or
id|ca
op_member_access_from_pointer
m_exit
)paren
(brace
multiline_comment|/* got signal or quitting */
r_break
suffix:semicolon
)brace
)brace
id|ca-&gt;wakeup
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* go through all the slots processing them */
r_for
c_loop
(paren
id|slot
op_assign
l_int|0
suffix:semicolon
id|slot
OL
id|ca-&gt;slot_count
suffix:semicolon
id|slot
op_increment
)paren
(brace
singleline_comment|// check the cam status + deal with CAMCHANGEs
r_while
c_loop
(paren
id|dvb_ca_en50221_check_camstatus
c_func
(paren
id|ca
comma
id|slot
)paren
)paren
(brace
multiline_comment|/* clear down an old CI slot if necessary */
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_ne
id|DVB_CA_SLOTSTATE_NONE
)paren
id|dvb_ca_en50221_slot_shutdown
c_func
(paren
id|ca
comma
id|slot
)paren
suffix:semicolon
multiline_comment|/* if a CAM is NOW present, initialise it */
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|camchange_type
op_eq
id|DVB_CA_EN50221_CAMCHANGE_INSERTED
)paren
(brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_UNINITIALISED
suffix:semicolon
)brace
multiline_comment|/* we&squot;ve handled one CAMCHANGE */
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|camchange_count
)paren
suffix:semicolon
)brace
singleline_comment|// CAM state machine
r_switch
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
)paren
(brace
r_case
id|DVB_CA_SLOTSTATE_NONE
suffix:colon
r_case
id|DVB_CA_SLOTSTATE_INVALID
suffix:colon
singleline_comment|// no action needed
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_UNINITIALISED
suffix:colon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_WAITREADY
suffix:semicolon
id|ca-&gt;pub
op_member_access_from_pointer
id|slot_reset
c_func
(paren
id|ca-&gt;pub
comma
id|slot
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|INIT_TIMEOUT_SECS
op_star
id|HZ
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_WAITREADY
suffix:colon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adaptor %d: PC card did not respond :(&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_INVALID
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// no other action needed; will automatically change state when ready
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_VALIDATE
suffix:colon
r_if
c_cond
(paren
id|dvb_ca_en50221_parse_attributes
c_func
(paren
id|ca
comma
id|slot
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: Invalid PC card inserted :(&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_INVALID
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dvb_ca_en50221_set_configoption
c_func
(paren
id|ca
comma
id|slot
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: Unable to initialise CAM :(&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_INVALID
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ca-&gt;pub
op_member_access_from_pointer
id|write_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_COMMAND
comma
id|CMDREG_RS
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: Unable to reset CAM IF&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_INVALID
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;DVB CAM validated successfully&bslash;n&quot;
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|timeout
op_assign
id|jiffies
op_plus
(paren
id|INIT_TIMEOUT_SECS
op_star
id|HZ
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_WAITFR
suffix:semicolon
id|ca-&gt;wakeup
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_WAITFR
suffix:colon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|timeout
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: DVB CAM did not respond :(&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_INVALID
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|flags
op_assign
id|ca-&gt;pub
op_member_access_from_pointer
id|read_cam_control
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|CTRLIF_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|STATUSREG_FR
)paren
(brace
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_LINKINIT
suffix:semicolon
id|ca-&gt;wakeup
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_LINKINIT
suffix:colon
r_if
c_cond
(paren
id|dvb_ca_en50221_link_init
c_func
(paren
id|ca
comma
id|slot
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: DVB CAM link initialisation failed :(&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_INVALID
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rxbuf
op_assign
id|vmalloc
c_func
(paren
id|RX_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxbuf
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: Unable to allocate CAM rx buffer :(&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_INVALID
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|down_write
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
id|dvb_ringbuffer_init
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
id|rxbuf
comma
id|RX_BUFFER_SIZE
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
id|ca-&gt;pub
op_member_access_from_pointer
id|slot_ts_enable
c_func
(paren
id|ca-&gt;pub
comma
id|slot
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_RUNNING
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: DVB CAM detected and initialised successfully&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DVB_CA_SLOTSTATE_RUNNING
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|ca-&gt;open
)paren
r_continue
suffix:semicolon
singleline_comment|// no need to poll if the CAM supports IRQs
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|da_irq_supported
)paren
r_break
suffix:semicolon
singleline_comment|// poll mode
id|pktcount
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|dvb_ca_en50221_read_data
c_func
(paren
id|ca
comma
id|slot
comma
l_int|NULL
comma
l_int|0
)paren
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ca-&gt;open
)paren
r_break
suffix:semicolon
multiline_comment|/* if a CAMCHANGE occurred at some point, do not do any more processing of this slot */
r_if
c_cond
(paren
id|dvb_ca_en50221_check_camstatus
c_func
(paren
id|ca
comma
id|slot
)paren
)paren
(brace
singleline_comment|// we dont want to sleep on the next iteration so we can handle the cam change
id|ca-&gt;wakeup
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* check if we&squot;ve hit our limit this time */
r_if
c_cond
(paren
op_increment
id|pktcount
op_ge
id|MAX_RX_PACKETS_PER_ITERATION
)paren
(brace
singleline_comment|// dont sleep; there is likely to be more data to read
id|ca-&gt;wakeup
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* completed */
id|ca-&gt;thread_pid
op_assign
l_int|0
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|ca-&gt;thread_queue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ******************************************************************************** */
multiline_comment|/* EN50221 IO interface functions */
multiline_comment|/**&n; * Real ioctl implementation.&n; * NOTE: CA_SEND_MSG/CA_GET_MSG ioctls have userspace buffers passed to them.&n; *&n; * @param inode Inode concerned.&n; * @param file File concerned.&n; * @param cmd IOCTL command.&n; * @param arg Associated argument.&n; *&n; * @return 0 on success, &lt;0 on error.&n; */
DECL|function|dvb_ca_en50221_io_do_ioctl
r_static
r_int
id|dvb_ca_en50221_io_do_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|parg
)paren
(brace
r_struct
id|dvb_device
op_star
id|dvbdev
op_assign
(paren
r_struct
id|dvb_device
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|dvbdev-&gt;priv
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|slot
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CA_RESET
suffix:colon
r_for
c_loop
(paren
id|slot
op_assign
l_int|0
suffix:semicolon
id|slot
OL
id|ca-&gt;slot_count
suffix:semicolon
id|slot
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_ne
id|DVB_CA_SLOTSTATE_NONE
)paren
(brace
id|dvb_ca_en50221_slot_shutdown
c_func
(paren
id|ca
comma
id|slot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ca-&gt;flags
op_amp
id|DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE
)paren
id|dvb_ca_en50221_camchange_irq
c_func
(paren
id|ca-&gt;pub
comma
id|slot
comma
id|DVB_CA_EN50221_CAMCHANGE_INSERTED
)paren
suffix:semicolon
)brace
)brace
id|ca-&gt;next_read_slot
op_assign
l_int|0
suffix:semicolon
id|dvb_ca_en50221_thread_wakeup
c_func
(paren
id|ca
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CA_GET_CAP
suffix:colon
(brace
r_struct
id|ca_caps
op_star
id|caps
op_assign
(paren
r_struct
id|ca_caps
op_star
)paren
id|parg
suffix:semicolon
id|caps-&gt;slot_num
op_assign
id|ca-&gt;slot_count
suffix:semicolon
id|caps-&gt;slot_type
op_assign
id|CA_CI_LINK
suffix:semicolon
id|caps-&gt;descr_num
op_assign
l_int|0
suffix:semicolon
id|caps-&gt;descr_type
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|CA_GET_SLOT_INFO
suffix:colon
(brace
r_struct
id|ca_slot_info
op_star
id|info
op_assign
(paren
r_struct
id|ca_slot_info
op_star
)paren
id|parg
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;num
OG
id|ca-&gt;slot_count
)paren
op_logical_or
(paren
id|info-&gt;num
OL
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info-&gt;type
op_assign
id|CA_CI_LINK
suffix:semicolon
id|info-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ca-&gt;slot_info
(braket
id|info-&gt;num
)braket
dot
id|slot_state
op_ne
id|DVB_CA_SLOTSTATE_NONE
)paren
op_logical_and
(paren
id|ca-&gt;slot_info
(braket
id|info-&gt;num
)braket
dot
id|slot_state
op_ne
id|DVB_CA_SLOTSTATE_INVALID
)paren
)paren
(brace
id|info-&gt;flags
op_assign
id|CA_CI_MODULE_PRESENT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|info-&gt;num
)braket
dot
id|slot_state
op_eq
id|DVB_CA_SLOTSTATE_RUNNING
)paren
(brace
id|info-&gt;flags
op_or_assign
id|CA_CI_MODULE_READY
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/**&n; * Wrapper for ioctl implementation.&n; *&n; * @param inode Inode concerned.&n; * @param file File concerned.&n; * @param cmd IOCTL command.&n; * @param arg Associated argument.&n; *&n; * @return 0 on success, &lt;0 on error.&n; */
DECL|function|dvb_ca_en50221_io_ioctl
r_static
r_int
id|dvb_ca_en50221_io_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
id|dvb_usercopy
c_func
(paren
id|inode
comma
id|file
comma
id|cmd
comma
id|arg
comma
id|dvb_ca_en50221_io_do_ioctl
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * Implementation of write() syscall.&n; *&n; * @param file File structure.&n; * @param buf Source buffer.&n; * @param count Size of source buffer.&n; * @param ppos Position in file (ignored).&n; *&n; * @return Number of bytes read, or &lt;0 on error.&n; */
DECL|function|dvb_ca_en50221_io_write
r_static
id|ssize_t
id|dvb_ca_en50221_io_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|dvb_device
op_star
id|dvbdev
op_assign
(paren
r_struct
id|dvb_device
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|dvbdev-&gt;priv
suffix:semicolon
id|u8
id|slot
comma
id|connection_id
suffix:semicolon
r_int
id|status
suffix:semicolon
r_char
id|fragbuf
(braket
id|HOST_LINK_BUF_SIZE
)braket
suffix:semicolon
r_int
id|fragpos
op_assign
l_int|0
suffix:semicolon
r_int
id|fraglen
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|written
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Incoming packet has a 2 byte header. hdr[0] = slot_id, hdr[1] = connection_id */
r_if
c_cond
(paren
id|count
OL
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* extract slot &amp; connection id */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|slot
comma
id|buf
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|connection_id
comma
id|buf
op_plus
l_int|1
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|buf
op_add_assign
l_int|2
suffix:semicolon
id|count
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* check if the slot is actually running */
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_ne
id|DVB_CA_SLOTSTATE_RUNNING
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* fragment the packets &amp; store in the buffer */
r_while
c_loop
(paren
id|fragpos
OL
id|count
)paren
(brace
id|fraglen
op_assign
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|link_buf_size
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|count
op_minus
id|fragpos
)paren
OL
id|fraglen
)paren
id|fraglen
op_assign
id|count
op_minus
id|fragpos
suffix:semicolon
id|fragbuf
(braket
l_int|0
)braket
op_assign
id|connection_id
suffix:semicolon
id|fragbuf
(braket
l_int|1
)braket
op_assign
(paren
(paren
id|fragpos
op_plus
id|fraglen
)paren
OL
id|count
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|copy_from_user
c_func
(paren
id|fragbuf
op_plus
l_int|2
comma
id|buf
op_plus
id|fragpos
comma
id|fraglen
)paren
)paren
op_ne
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
op_div
l_int|2
suffix:semicolon
id|written
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
multiline_comment|/* check the CAM hasn&squot;t been removed/reset in the meantime */
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_ne
id|DVB_CA_SLOTSTATE_RUNNING
)paren
(brace
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|status
op_assign
id|dvb_ca_en50221_write_data
c_func
(paren
id|ca
comma
id|slot
comma
id|fragbuf
comma
id|fraglen
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
(paren
id|fraglen
op_plus
l_int|2
)paren
)paren
(brace
id|written
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_ne
op_minus
id|EAGAIN
)paren
r_goto
m_exit
suffix:semicolon
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|written
)paren
(brace
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|fragpos
op_add_assign
id|fraglen
suffix:semicolon
)brace
id|status
op_assign
id|count
op_plus
l_int|2
suffix:semicolon
m_exit
suffix:colon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/**&n; * Condition for waking up in dvb_ca_en50221_io_read_condition&n; */
DECL|function|dvb_ca_en50221_io_read_condition
r_static
r_int
id|dvb_ca_en50221_io_read_condition
c_func
(paren
r_struct
id|dvb_ca_private
op_star
id|ca
comma
r_int
op_star
id|result
comma
r_int
op_star
id|_slot
)paren
(brace
r_int
id|slot
suffix:semicolon
r_int
id|slot_count
op_assign
l_int|0
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_int
id|fraglen
suffix:semicolon
r_int
id|connection_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|u8
id|hdr
(braket
l_int|2
)braket
suffix:semicolon
id|slot
op_assign
id|ca-&gt;next_read_slot
suffix:semicolon
r_while
c_loop
(paren
(paren
id|slot_count
OL
id|ca-&gt;slot_count
)paren
op_logical_and
(paren
op_logical_neg
id|found
)paren
)paren
(brace
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|slot_state
op_ne
id|DVB_CA_SLOTSTATE_RUNNING
)paren
r_goto
id|nextslot
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer.data
op_eq
l_int|NULL
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|idx
op_assign
id|dvb_ringbuffer_pkt_next
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
op_minus
l_int|1
comma
op_amp
id|fraglen
)paren
suffix:semicolon
r_while
c_loop
(paren
id|idx
op_ne
op_minus
l_int|1
)paren
(brace
id|dvb_ringbuffer_pkt_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
id|idx
comma
l_int|0
comma
id|hdr
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|connection_id
op_eq
op_minus
l_int|1
)paren
id|connection_id
op_assign
id|hdr
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hdr
(braket
l_int|0
)braket
op_eq
id|connection_id
)paren
op_logical_and
(paren
(paren
id|hdr
(braket
l_int|1
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
)paren
(brace
op_star
id|_slot
op_assign
id|slot
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|idx
op_assign
id|dvb_ringbuffer_pkt_next
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
id|idx
comma
op_amp
id|fraglen
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
id|nextslot
suffix:colon
id|slot
op_assign
(paren
id|slot
op_plus
l_int|1
)paren
op_mod
id|ca-&gt;slot_count
suffix:semicolon
id|slot_count
op_increment
suffix:semicolon
)brace
id|ca-&gt;next_read_slot
op_assign
id|slot
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
multiline_comment|/**&n; * Implementation of read() syscall.&n; *&n; * @param file File structure.&n; * @param buf Destination buffer.&n; * @param count Size of destination buffer.&n; * @param ppos Position in file (ignored).&n; *&n; * @return Number of bytes read, or &lt;0 on error.&n; */
DECL|function|dvb_ca_en50221_io_read
r_static
id|ssize_t
id|dvb_ca_en50221_io_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|dvb_device
op_star
id|dvbdev
op_assign
(paren
r_struct
id|dvb_device
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|dvbdev-&gt;priv
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|u8
id|hdr
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|slot
suffix:semicolon
r_int
id|connection_id
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|idx
comma
id|idx2
suffix:semicolon
r_int
id|last_fragment
op_assign
l_int|0
suffix:semicolon
r_int
id|fraglen
suffix:semicolon
r_int
id|pktlen
suffix:semicolon
r_int
id|dispose
op_assign
l_int|0
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Outgoing packet has a 2 byte header. hdr[0] = slot_id, hdr[1] = connection_id */
r_if
c_cond
(paren
id|count
OL
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* wait for some data */
r_if
c_cond
(paren
(paren
id|status
op_assign
id|dvb_ca_en50221_io_read_condition
c_func
(paren
id|ca
comma
op_amp
id|result
comma
op_amp
id|slot
)paren
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* if we&squot;re in nonblocking mode, exit immediately */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
multiline_comment|/* wait for some data */
id|status
op_assign
id|wait_event_interruptible
c_func
(paren
id|ca-&gt;wait_queue
comma
id|dvb_ca_en50221_io_read_condition
(paren
id|ca
comma
op_amp
id|result
comma
op_amp
id|slot
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
OL
l_int|0
)paren
op_logical_or
(paren
id|result
OL
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|result
)paren
r_return
id|result
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|idx
op_assign
id|dvb_ringbuffer_pkt_next
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
op_minus
l_int|1
comma
op_amp
id|fraglen
)paren
suffix:semicolon
id|pktlen
op_assign
l_int|2
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|idx
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca adapter %d: BUG: read packet ended before last_fragment encountered&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|dvb_ringbuffer_pkt_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
id|idx
comma
l_int|0
comma
id|hdr
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|connection_id
op_eq
op_minus
l_int|1
)paren
id|connection_id
op_assign
id|hdr
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hdr
(braket
l_int|0
)braket
op_eq
id|connection_id
)paren
(brace
r_if
c_cond
(paren
id|pktlen
OL
id|count
)paren
(brace
r_if
c_cond
(paren
(paren
id|pktlen
op_plus
id|fraglen
op_minus
l_int|2
)paren
OG
id|count
)paren
(brace
id|fraglen
op_assign
id|count
op_minus
id|pktlen
suffix:semicolon
)brace
r_else
(brace
id|fraglen
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|status
op_assign
id|dvb_ringbuffer_pkt_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
id|idx
comma
l_int|2
comma
id|buf
op_plus
id|pktlen
comma
id|fraglen
comma
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
r_goto
m_exit
suffix:semicolon
)brace
id|pktlen
op_add_assign
id|fraglen
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|hdr
(braket
l_int|1
)braket
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
id|last_fragment
op_assign
l_int|1
suffix:semicolon
id|dispose
op_assign
l_int|1
suffix:semicolon
)brace
id|idx2
op_assign
id|dvb_ringbuffer_pkt_next
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
id|idx
comma
op_amp
id|fraglen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dispose
)paren
id|dvb_ringbuffer_pkt_dispose
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|rx_buffer
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
id|idx2
suffix:semicolon
id|dispose
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|last_fragment
)paren
suffix:semicolon
id|hdr
(braket
l_int|0
)braket
op_assign
id|slot
suffix:semicolon
id|hdr
(braket
l_int|1
)braket
op_assign
id|connection_id
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|hdr
comma
l_int|2
)paren
)paren
op_ne
l_int|0
)paren
r_goto
m_exit
suffix:semicolon
id|status
op_assign
id|pktlen
suffix:semicolon
m_exit
suffix:colon
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/**&n; * Implementation of file open syscall.&n; *&n; * @param inode Inode concerned.&n; * @param file File concerned.&n; *&n; * @return 0 on success, &lt;0 on failure.&n; */
DECL|function|dvb_ca_en50221_io_open
r_static
r_int
id|dvb_ca_en50221_io_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|dvb_device
op_star
id|dvbdev
op_assign
(paren
r_struct
id|dvb_device
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|dvbdev-&gt;priv
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|try_module_get
c_func
(paren
id|ca-&gt;pub-&gt;owner
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|err
op_assign
id|dvb_generic_open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ca-&gt;slot_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|slot_state
op_eq
id|DVB_CA_SLOTSTATE_RUNNING
)paren
(brace
id|down_write
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|rx_buffer.data
op_ne
l_int|NULL
)paren
(brace
id|dvb_ringbuffer_flush
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|rx_buffer
)paren
suffix:semicolon
)brace
id|up_write
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|sem
)paren
suffix:semicolon
)brace
)brace
id|ca-&gt;open
op_assign
l_int|1
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
id|dvb_ca_en50221_thread_wakeup
c_func
(paren
id|ca
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Implementation of file close syscall.&n; *&n; * @param inode Inode concerned.&n; * @param file File concerned.&n; *&n; * @return 0 on success, &lt;0 on failure.&n; */
DECL|function|dvb_ca_en50221_io_release
r_static
r_int
id|dvb_ca_en50221_io_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|dvb_device
op_star
id|dvbdev
op_assign
(paren
r_struct
id|dvb_device
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|dvbdev-&gt;priv
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* mark the CA device as closed */
id|ca-&gt;open
op_assign
l_int|0
suffix:semicolon
id|dvb_ca_en50221_thread_update_delay
c_func
(paren
id|ca
)paren
suffix:semicolon
id|err
op_assign
id|dvb_generic_release
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|ca-&gt;pub-&gt;owner
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Implementation of poll() syscall.&n; *&n; * @param file File concerned.&n; * @param wait poll wait table.&n; *&n; * @return Standard poll mask.&n; */
DECL|function|dvb_ca_en50221_io_poll
r_static
r_int
r_int
id|dvb_ca_en50221_io_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|dvb_device
op_star
id|dvbdev
op_assign
(paren
r_struct
id|dvb_device
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|dvbdev-&gt;priv
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_int
id|slot
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvb_ca_en50221_io_read_condition
c_func
(paren
id|ca
comma
op_amp
id|result
comma
op_amp
id|slot
)paren
op_eq
l_int|1
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
id|mask
op_or_assign
id|POLLIN
suffix:semicolon
)brace
multiline_comment|/* if there is something, return now */
r_if
c_cond
(paren
id|mask
)paren
r_return
id|mask
suffix:semicolon
multiline_comment|/* wait for something to happen */
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|ca-&gt;wait_queue
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dvb_ca_en50221_io_read_condition
c_func
(paren
id|ca
comma
op_amp
id|result
comma
op_amp
id|slot
)paren
op_eq
l_int|1
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|slot
)braket
dot
id|sem
)paren
suffix:semicolon
id|mask
op_or_assign
id|POLLIN
suffix:semicolon
)brace
r_return
id|mask
suffix:semicolon
)brace
DECL|variable|dvb_ca_en50221_init
id|EXPORT_SYMBOL
c_func
(paren
id|dvb_ca_en50221_init
)paren
suffix:semicolon
DECL|variable|dvb_ca_fops
r_static
r_struct
id|file_operations
id|dvb_ca_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|dvb_ca_en50221_io_read
comma
dot
id|write
op_assign
id|dvb_ca_en50221_io_write
comma
dot
id|ioctl
op_assign
id|dvb_ca_en50221_io_ioctl
comma
dot
id|open
op_assign
id|dvb_ca_en50221_io_open
comma
dot
id|release
op_assign
id|dvb_ca_en50221_io_release
comma
dot
id|poll
op_assign
id|dvb_ca_en50221_io_poll
comma
)brace
suffix:semicolon
DECL|variable|dvbdev_ca
r_static
r_struct
id|dvb_device
id|dvbdev_ca
op_assign
(brace
dot
id|priv
op_assign
l_int|NULL
comma
dot
id|users
op_assign
l_int|1
comma
dot
id|readers
op_assign
l_int|1
comma
dot
id|writers
op_assign
l_int|1
comma
dot
id|fops
op_assign
op_amp
id|dvb_ca_fops
comma
)brace
suffix:semicolon
multiline_comment|/* ******************************************************************************** */
multiline_comment|/* Initialisation/shutdown functions */
multiline_comment|/**&n; * Initialise a new DVB CA EN50221 interface device.&n; *&n; * @param dvb_adapter DVB adapter to attach the new CA device to.&n; * @param ca The dvb_ca instance.&n; * @param flags Flags describing the CA device (DVB_CA_FLAG_*).&n; * @param slot_count Number of slots supported.&n; *&n; * @return 0 on success, nonzero on failure&n; */
DECL|function|dvb_ca_en50221_init
r_int
id|dvb_ca_en50221_init
c_func
(paren
r_struct
id|dvb_adapter
op_star
id|dvb_adapter
comma
r_struct
id|dvb_ca_en50221
op_star
id|pubca
comma
r_int
id|flags
comma
r_int
id|slot_count
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slot_count
OL
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* initialise the system data */
r_if
c_cond
(paren
(paren
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dvb_ca_private
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ca
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dvb_ca_private
)paren
)paren
suffix:semicolon
id|ca-&gt;pub
op_assign
id|pubca
suffix:semicolon
id|ca-&gt;flags
op_assign
id|flags
suffix:semicolon
id|ca-&gt;slot_count
op_assign
id|slot_count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ca-&gt;slot_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dvb_ca_slot
)paren
op_star
id|slot_count
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ca-&gt;slot_info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dvb_ca_slot
)paren
op_star
id|slot_count
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ca-&gt;wait_queue
)paren
suffix:semicolon
id|ca-&gt;thread_pid
op_assign
l_int|0
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ca-&gt;thread_queue
)paren
suffix:semicolon
id|ca
op_member_access_from_pointer
m_exit
op_assign
l_int|0
suffix:semicolon
id|ca-&gt;open
op_assign
l_int|0
suffix:semicolon
id|ca-&gt;wakeup
op_assign
l_int|0
suffix:semicolon
id|ca-&gt;next_read_slot
op_assign
l_int|0
suffix:semicolon
id|pubca
op_member_access_from_pointer
r_private
op_assign
id|ca
suffix:semicolon
multiline_comment|/* register the DVB device */
id|ret
op_assign
id|dvb_register_device
c_func
(paren
id|dvb_adapter
comma
op_amp
id|ca-&gt;dvbdev
comma
op_amp
id|dvbdev_ca
comma
id|ca
comma
id|DVB_DEVICE_CA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* now initialise each slot */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|slot_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dvb_ca_slot
)paren
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|slot_state
op_assign
id|DVB_CA_SLOTSTATE_NONE
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|camchange_count
comma
l_int|0
)paren
suffix:semicolon
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|camchange_type
op_assign
id|DVB_CA_EN50221_CAMCHANGE_REMOVED
suffix:semicolon
id|init_rwsem
c_func
(paren
op_amp
id|ca-&gt;slot_info
(braket
id|i
)braket
dot
id|sem
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* create a kthread for monitoring this CA device */
id|ret
op_assign
id|kernel_thread
(paren
id|dvb_ca_en50221_thread
comma
id|ca
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca_init: failed to start kernel_thread (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|ca-&gt;thread_pid
op_assign
id|ret
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|ca
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|ca-&gt;dvbdev
op_ne
l_int|NULL
)paren
id|dvb_unregister_device
c_func
(paren
id|ca-&gt;dvbdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ca-&gt;slot_info
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|ca-&gt;slot_info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ca
)paren
suffix:semicolon
)brace
id|pubca
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|dvb_ca_en50221_release
id|EXPORT_SYMBOL
c_func
(paren
id|dvb_ca_en50221_release
)paren
suffix:semicolon
multiline_comment|/**&n; * Release a DVB CA EN50221 interface device.&n; *&n; * @param ca_dev The dvb_device_t instance for the CA device.&n; * @param ca The associated dvb_ca instance.&n; */
DECL|function|dvb_ca_en50221_release
r_void
id|dvb_ca_en50221_release
c_func
(paren
r_struct
id|dvb_ca_en50221
op_star
id|pubca
)paren
(brace
r_struct
id|dvb_ca_private
op_star
id|ca
op_assign
(paren
r_struct
id|dvb_ca_private
op_star
)paren
id|pubca
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* shutdown the thread if there was one */
r_if
c_cond
(paren
id|ca-&gt;thread_pid
)paren
(brace
r_if
c_cond
(paren
id|kill_proc
c_func
(paren
id|ca-&gt;thread_pid
comma
l_int|0
comma
l_int|1
)paren
op_eq
op_minus
id|ESRCH
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dvb_ca_release adapter %d: thread PID %d already died&bslash;n&quot;
comma
id|ca-&gt;dvbdev-&gt;adapter-&gt;num
comma
id|ca-&gt;thread_pid
)paren
suffix:semicolon
)brace
r_else
(brace
id|ca
op_member_access_from_pointer
m_exit
op_assign
l_int|1
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|dvb_ca_en50221_thread_wakeup
c_func
(paren
id|ca
)paren
suffix:semicolon
id|wait_event_interruptible
c_func
(paren
id|ca-&gt;thread_queue
comma
id|ca-&gt;thread_pid
op_eq
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ca-&gt;slot_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dvb_ca_en50221_slot_shutdown
c_func
(paren
id|ca
comma
id|i
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ca-&gt;slot_info
)paren
suffix:semicolon
id|dvb_unregister_device
c_func
(paren
id|ca-&gt;dvbdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ca
)paren
suffix:semicolon
id|pubca
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
)brace
eof
