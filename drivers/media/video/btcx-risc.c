multiline_comment|/*&n;    $Id: btcx-risc.c,v 1.6 2005/02/21 13:57:59 kraxel Exp $&n;&n;    btcx-risc.c&n;&n;    bt848/bt878/cx2388x risc code generator.&n;&n;    (c) 2000-03 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/videodev2.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;btcx-risc.h&quot;
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;some code shared by bttv and cx88xx drivers&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Gerd Knorr&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|debug
r_static
r_int
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;debug messages, default is 0 (no)&quot;
)paren
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------- */
multiline_comment|/* allocate/free risc memory                                  */
DECL|variable|memcnt
r_static
r_int
id|memcnt
suffix:semicolon
DECL|function|btcx_riscmem_free
r_void
id|btcx_riscmem_free
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
comma
r_struct
id|btcx_riscmem
op_star
id|risc
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|risc-&gt;cpu
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
(brace
id|memcnt
op_decrement
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;btcx: riscmem free [%d] dma=%lx&bslash;n&quot;
comma
id|memcnt
comma
(paren
r_int
r_int
)paren
id|risc-&gt;dma
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|pci
comma
id|risc-&gt;size
comma
id|risc-&gt;cpu
comma
id|risc-&gt;dma
)paren
suffix:semicolon
id|memset
c_func
(paren
id|risc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|risc
)paren
)paren
suffix:semicolon
)brace
DECL|function|btcx_riscmem_alloc
r_int
id|btcx_riscmem_alloc
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
comma
r_struct
id|btcx_riscmem
op_star
id|risc
comma
r_int
r_int
id|size
)paren
(brace
id|u32
op_star
id|cpu
suffix:semicolon
id|dma_addr_t
id|dma
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|risc-&gt;cpu
op_logical_and
id|risc-&gt;size
OL
id|size
)paren
id|btcx_riscmem_free
c_func
(paren
id|pci
comma
id|risc
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|risc-&gt;cpu
)paren
(brace
id|cpu
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pci
comma
id|size
comma
op_amp
id|dma
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|cpu
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|risc-&gt;cpu
op_assign
id|cpu
suffix:semicolon
id|risc-&gt;dma
op_assign
id|dma
suffix:semicolon
id|risc-&gt;size
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
(brace
id|memcnt
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;btcx: riscmem alloc [%d] dma=%lx cpu=%p size=%d&bslash;n&quot;
comma
id|memcnt
comma
(paren
r_int
r_int
)paren
id|dma
comma
id|cpu
comma
id|size
)paren
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
id|risc-&gt;cpu
comma
l_int|0
comma
id|risc-&gt;size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------- */
multiline_comment|/* screen overlay helpers                                     */
r_int
DECL|function|btcx_screen_clips
id|btcx_screen_clips
c_func
(paren
r_int
id|swidth
comma
r_int
id|sheight
comma
r_struct
id|v4l2_rect
op_star
id|win
comma
r_struct
id|v4l2_clip
op_star
id|clips
comma
r_int
r_int
id|n
)paren
(brace
r_if
c_cond
(paren
id|win-&gt;left
OL
l_int|0
)paren
(brace
multiline_comment|/* left */
id|clips
(braket
id|n
)braket
dot
id|c.left
op_assign
l_int|0
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.top
op_assign
l_int|0
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.width
op_assign
op_minus
id|win-&gt;left
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.height
op_assign
id|win-&gt;height
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|win-&gt;left
op_plus
id|win-&gt;width
OG
id|swidth
)paren
(brace
multiline_comment|/* right */
id|clips
(braket
id|n
)braket
dot
id|c.left
op_assign
id|swidth
op_minus
id|win-&gt;left
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.top
op_assign
l_int|0
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.width
op_assign
id|win-&gt;width
op_minus
id|clips
(braket
id|n
)braket
dot
id|c.left
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.height
op_assign
id|win-&gt;height
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|win-&gt;top
OL
l_int|0
)paren
(brace
multiline_comment|/* top */
id|clips
(braket
id|n
)braket
dot
id|c.left
op_assign
l_int|0
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.top
op_assign
l_int|0
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.width
op_assign
id|win-&gt;width
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.height
op_assign
op_minus
id|win-&gt;top
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|win-&gt;top
op_plus
id|win-&gt;height
OG
id|sheight
)paren
(brace
multiline_comment|/* bottom */
id|clips
(braket
id|n
)braket
dot
id|c.left
op_assign
l_int|0
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.top
op_assign
id|sheight
op_minus
id|win-&gt;top
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.width
op_assign
id|win-&gt;width
suffix:semicolon
id|clips
(braket
id|n
)braket
dot
id|c.height
op_assign
id|win-&gt;height
op_minus
id|clips
(braket
id|n
)braket
dot
id|c.top
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
r_return
id|n
suffix:semicolon
)brace
r_int
DECL|function|btcx_align
id|btcx_align
c_func
(paren
r_struct
id|v4l2_rect
op_star
id|win
comma
r_struct
id|v4l2_clip
op_star
id|clips
comma
r_int
r_int
id|n
comma
r_int
id|mask
)paren
(brace
id|s32
id|nx
comma
id|nw
comma
id|dx
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
multiline_comment|/* fixup window */
id|nx
op_assign
(paren
id|win-&gt;left
op_plus
id|mask
)paren
op_amp
op_complement
id|mask
suffix:semicolon
id|nw
op_assign
(paren
id|win-&gt;width
)paren
op_amp
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|nx
op_plus
id|nw
OG
id|win-&gt;left
op_plus
id|win-&gt;width
)paren
id|nw
op_sub_assign
id|mask
op_plus
l_int|1
suffix:semicolon
id|dx
op_assign
id|nx
op_minus
id|win-&gt;left
suffix:semicolon
id|win-&gt;left
op_assign
id|nx
suffix:semicolon
id|win-&gt;width
op_assign
id|nw
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;btcx: window align %dx%d+%d+%d [dx=%d]&bslash;n&quot;
comma
id|win-&gt;width
comma
id|win-&gt;height
comma
id|win-&gt;left
comma
id|win-&gt;top
comma
id|dx
)paren
suffix:semicolon
multiline_comment|/* fixup clips */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
(brace
id|nx
op_assign
(paren
id|clips
(braket
id|i
)braket
dot
id|c.left
op_minus
id|dx
)paren
op_amp
op_complement
id|mask
suffix:semicolon
id|nw
op_assign
(paren
id|clips
(braket
id|i
)braket
dot
id|c.width
)paren
op_amp
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|nx
op_plus
id|nw
OL
id|clips
(braket
id|i
)braket
dot
id|c.left
op_minus
id|dx
op_plus
id|clips
(braket
id|i
)braket
dot
id|c.width
)paren
id|nw
op_add_assign
id|mask
op_plus
l_int|1
suffix:semicolon
id|clips
(braket
id|i
)braket
dot
id|c.left
op_assign
id|nx
suffix:semicolon
id|clips
(braket
id|i
)braket
dot
id|c.width
op_assign
id|nw
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;btcx:   clip align %dx%d+%d+%d&bslash;n&quot;
comma
id|clips
(braket
id|i
)braket
dot
id|c.width
comma
id|clips
(braket
id|i
)braket
dot
id|c.height
comma
id|clips
(braket
id|i
)braket
dot
id|c.left
comma
id|clips
(braket
id|i
)braket
dot
id|c.top
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|btcx_sort_clips
id|btcx_sort_clips
c_func
(paren
r_struct
id|v4l2_clip
op_star
id|clips
comma
r_int
r_int
id|nclips
)paren
(brace
r_struct
id|v4l2_clip
id|swap
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|n
suffix:semicolon
r_if
c_cond
(paren
id|nclips
OL
l_int|2
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|nclips
op_minus
l_int|2
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_for
c_loop
(paren
id|n
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|i
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|clips
(braket
id|j
)braket
dot
id|c.left
OG
id|clips
(braket
id|j
op_plus
l_int|1
)braket
dot
id|c.left
)paren
(brace
id|swap
op_assign
id|clips
(braket
id|j
)braket
suffix:semicolon
id|clips
(braket
id|j
)braket
op_assign
id|clips
(braket
id|j
op_plus
l_int|1
)braket
suffix:semicolon
id|clips
(braket
id|j
op_plus
l_int|1
)braket
op_assign
id|swap
suffix:semicolon
id|n
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|n
)paren
r_break
suffix:semicolon
)brace
)brace
r_void
DECL|function|btcx_calc_skips
id|btcx_calc_skips
c_func
(paren
r_int
id|line
comma
r_int
id|width
comma
r_int
r_int
op_star
id|maxy
comma
r_struct
id|btcx_skiplist
op_star
id|skips
comma
r_int
r_int
op_star
id|nskips
comma
r_const
r_struct
id|v4l2_clip
op_star
id|clips
comma
r_int
r_int
id|nclips
)paren
(brace
r_int
r_int
id|clip
comma
id|skip
suffix:semicolon
r_int
id|end
comma
id|maxline
suffix:semicolon
id|skip
op_assign
l_int|0
suffix:semicolon
id|maxline
op_assign
l_int|9999
suffix:semicolon
r_for
c_loop
(paren
id|clip
op_assign
l_int|0
suffix:semicolon
id|clip
OL
id|nclips
suffix:semicolon
id|clip
op_increment
)paren
(brace
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
id|clips
(braket
id|clip
)braket
dot
id|c.left
op_plus
id|clips
(braket
id|clip
)braket
dot
id|c.width
op_le
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|clips
(braket
id|clip
)braket
dot
id|c.left
OG
(paren
r_int
)paren
id|width
)paren
r_break
suffix:semicolon
multiline_comment|/* vertical range */
r_if
c_cond
(paren
id|line
OG
id|clips
(braket
id|clip
)braket
dot
id|c.top
op_plus
id|clips
(braket
id|clip
)braket
dot
id|c.height
op_minus
l_int|1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|line
OL
id|clips
(braket
id|clip
)braket
dot
id|c.top
)paren
(brace
r_if
c_cond
(paren
id|maxline
OG
id|clips
(braket
id|clip
)braket
dot
id|c.top
op_minus
l_int|1
)paren
id|maxline
op_assign
id|clips
(braket
id|clip
)braket
dot
id|c.top
op_minus
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|maxline
OG
id|clips
(braket
id|clip
)braket
dot
id|c.top
op_plus
id|clips
(braket
id|clip
)braket
dot
id|c.height
op_minus
l_int|1
)paren
id|maxline
op_assign
id|clips
(braket
id|clip
)braket
dot
id|c.top
op_plus
id|clips
(braket
id|clip
)braket
dot
id|c.height
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* horizontal range */
r_if
c_cond
(paren
l_int|0
op_eq
id|skip
op_logical_or
id|clips
(braket
id|clip
)braket
dot
id|c.left
OG
id|skips
(braket
id|skip
op_minus
l_int|1
)braket
dot
id|end
)paren
(brace
multiline_comment|/* new one */
id|skips
(braket
id|skip
)braket
dot
id|start
op_assign
id|clips
(braket
id|clip
)braket
dot
id|c.left
suffix:semicolon
r_if
c_cond
(paren
id|skips
(braket
id|skip
)braket
dot
id|start
OL
l_int|0
)paren
id|skips
(braket
id|skip
)braket
dot
id|start
op_assign
l_int|0
suffix:semicolon
id|skips
(braket
id|skip
)braket
dot
id|end
op_assign
id|clips
(braket
id|clip
)braket
dot
id|c.left
op_plus
id|clips
(braket
id|clip
)braket
dot
id|c.width
suffix:semicolon
r_if
c_cond
(paren
id|skips
(braket
id|skip
)braket
dot
id|end
OG
id|width
)paren
id|skips
(braket
id|skip
)braket
dot
id|end
op_assign
id|width
suffix:semicolon
id|skip
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* overlaps -- expand last one */
id|end
op_assign
id|clips
(braket
id|clip
)braket
dot
id|c.left
op_plus
id|clips
(braket
id|clip
)braket
dot
id|c.width
suffix:semicolon
r_if
c_cond
(paren
id|skips
(braket
id|skip
op_minus
l_int|1
)braket
dot
id|end
OL
id|end
)paren
id|skips
(braket
id|skip
op_minus
l_int|1
)braket
dot
id|end
op_assign
id|end
suffix:semicolon
r_if
c_cond
(paren
id|skips
(braket
id|skip
op_minus
l_int|1
)braket
dot
id|end
OG
id|width
)paren
id|skips
(braket
id|skip
op_minus
l_int|1
)braket
dot
id|end
op_assign
id|width
suffix:semicolon
)brace
)brace
op_star
id|nskips
op_assign
id|skip
suffix:semicolon
op_star
id|maxy
op_assign
id|maxline
suffix:semicolon
r_if
c_cond
(paren
id|debug
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;btcx: skips line %d-%d:&quot;
comma
id|line
comma
id|maxline
)paren
suffix:semicolon
r_for
c_loop
(paren
id|skip
op_assign
l_int|0
suffix:semicolon
id|skip
OL
op_star
id|nskips
suffix:semicolon
id|skip
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %d-%d&quot;
comma
id|skips
(braket
id|skip
)braket
dot
id|start
comma
id|skips
(braket
id|skip
)braket
dot
id|end
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ---------------------------------------------------------- */
DECL|variable|btcx_riscmem_alloc
id|EXPORT_SYMBOL
c_func
(paren
id|btcx_riscmem_alloc
)paren
suffix:semicolon
DECL|variable|btcx_riscmem_free
id|EXPORT_SYMBOL
c_func
(paren
id|btcx_riscmem_free
)paren
suffix:semicolon
DECL|variable|btcx_screen_clips
id|EXPORT_SYMBOL
c_func
(paren
id|btcx_screen_clips
)paren
suffix:semicolon
DECL|variable|btcx_align
id|EXPORT_SYMBOL
c_func
(paren
id|btcx_align
)paren
suffix:semicolon
DECL|variable|btcx_sort_clips
id|EXPORT_SYMBOL
c_func
(paren
id|btcx_sort_clips
)paren
suffix:semicolon
DECL|variable|btcx_calc_skips
id|EXPORT_SYMBOL
c_func
(paren
id|btcx_calc_skips
)paren
suffix:semicolon
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
