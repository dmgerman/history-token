multiline_comment|/* Driver for Bt832 CMOS Camera Video Processor&n;    i2c-adresses: 0x88 or 0x8a&n;&n;  The BT832 interfaces to a Quartzsight Digital Camera (352x288, 25 or 30 fps)&n;  via a 9 pin connector ( 4-wire SDATA, 2-wire i2c, SCLK, VCC, GND).&n;  It outputs an 8-bit 4:2:2 YUV or YCrCb video signal which can be directly&n;  connected to bt848/bt878 GPIO pins on this purpose.&n;  (see: VLSI Vision Ltd. www.vvl.co.uk for camera datasheets)&n;  &n;  Supported Cards:&n;  -  Pixelview Rev.4E: 0x8a&n;&t;&t;GPIO 0x400000 toggles Bt832 RESET, and the chip changes to i2c 0x88 !&n;&n;  (c) Gunther Mayer, 2002&n;&n;  STATUS:&n;  - detect chip and hexdump&n;  - reset chip and leave low power mode&n;  - detect camera present&n;&n;  TODO:&n;  - make it work (find correct setup for Bt832 and Bt878)&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &quot;id.h&quot;
macro_line|#include &quot;audiochip.h&quot;
macro_line|#include &quot;bttv.h&quot;
macro_line|#include &quot;bt832.h&quot;
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Addresses to scan */
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
)braket
op_assign
(brace
id|I2C_BT832_ALT1
op_rshift
l_int|1
comma
id|I2C_BT832_ALT2
op_rshift
l_int|1
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
id|I2C_CLIENT_INSMOD
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|macro|dprintk
mdefine_line|#define dprintk     if (debug) printk
r_static
r_int
id|bt832_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
suffix:semicolon
DECL|struct|bt832
r_struct
id|bt832
(brace
DECL|member|client
r_struct
id|i2c_client
id|client
suffix:semicolon
)brace
suffix:semicolon
DECL|function|bt832_hexdump
r_int
id|bt832_hexdump
c_func
(paren
r_struct
id|i2c_client
op_star
id|i2c_client_s
comma
r_int
r_char
op_star
id|buf
)paren
(brace
r_int
id|i
comma
id|rc
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x80
suffix:semicolon
singleline_comment|// start at register 0 with auto-increment
r_if
c_cond
(paren
l_int|1
op_ne
(paren
id|rc
op_assign
id|i2c_master_send
c_func
(paren
id|i2c_client_s
comma
id|buf
comma
l_int|1
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;bt832: i2c i/o error: rc == %d (should be 1)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|65
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|65
op_ne
(paren
id|rc
op_assign
id|i2c_master_recv
c_func
(paren
id|i2c_client_s
comma
id|buf
comma
l_int|65
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;bt832: i2c i/o error: rc == %d (should be 65)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
singleline_comment|// Note: On READ the first byte is the current index
singleline_comment|//  (e.g. 0x80, what we just wrote)
r_if
c_cond
(paren
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;BT832 hexdump:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|65
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
op_ne
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|i
op_minus
l_int|1
)paren
op_mod
l_int|8
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|i
op_minus
l_int|1
)paren
op_mod
l_int|16
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Return: 1 (is a bt832), 0 (No bt832 here)
DECL|function|bt832_init
r_int
id|bt832_init
c_func
(paren
r_struct
id|i2c_client
op_star
id|i2c_client_s
)paren
(brace
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|buf
op_assign
id|kmalloc
c_func
(paren
l_int|65
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|bt832_hexdump
c_func
(paren
id|i2c_client_s
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
l_int|0x40
)braket
op_ne
l_int|0x31
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;bt832: this i2c chip is no bt832 (id=%02x). Detaching.&bslash;n&quot;
comma
id|buf
(braket
l_int|0x40
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Write 0 tp VPSTATUS&bslash;n&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|BT832_VP_STATUS
suffix:semicolon
singleline_comment|// Reg.52
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
(paren
id|rc
op_assign
id|i2c_master_send
c_func
(paren
id|i2c_client_s
comma
id|buf
comma
l_int|2
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;bt832: i2c i/o error VPS: rc == %d (should be 2)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|bt832_hexdump
c_func
(paren
id|i2c_client_s
comma
id|buf
)paren
suffix:semicolon
singleline_comment|// Leave low power mode:
id|printk
c_func
(paren
l_string|&quot;Bt832: leave low power mode.&bslash;n&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|BT832_CAM_SETUP0
suffix:semicolon
singleline_comment|//0x39 57
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x08
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
(paren
id|rc
op_assign
id|i2c_master_send
c_func
(paren
id|i2c_client_s
comma
id|buf
comma
l_int|2
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;bt832: i2c i/o error LLPM: rc == %d (should be 2)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|bt832_hexdump
c_func
(paren
id|i2c_client_s
comma
id|buf
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Write 0 tp VPSTATUS&bslash;n&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|BT832_VP_STATUS
suffix:semicolon
singleline_comment|// Reg.52
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
(paren
id|rc
op_assign
id|i2c_master_send
c_func
(paren
id|i2c_client_s
comma
id|buf
comma
l_int|2
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;bt832: i2c i/o error VPS: rc == %d (should be 2)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|bt832_hexdump
c_func
(paren
id|i2c_client_s
comma
id|buf
)paren
suffix:semicolon
singleline_comment|// Enable Output
id|printk
c_func
(paren
l_string|&quot;Enable Output&bslash;n&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|BT832_VP_CONTROL1
suffix:semicolon
singleline_comment|// Reg.40
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x27
op_amp
(paren
op_complement
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// Default | !skip
r_if
c_cond
(paren
l_int|2
op_ne
(paren
id|rc
op_assign
id|i2c_master_send
c_func
(paren
id|i2c_client_s
comma
id|buf
comma
l_int|2
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;bt832: i2c i/o error EO: rc == %d (should be 2)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|bt832_hexdump
c_func
(paren
id|i2c_client_s
comma
id|buf
)paren
suffix:semicolon
macro_line|#if 0
singleline_comment|// Full 30/25 Frame rate
id|printk
c_func
(paren
l_string|&quot;Full 30/25 Frame rate&bslash;n&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|BT832_VP_CONTROL0
suffix:semicolon
singleline_comment|// Reg.39
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_ne
(paren
id|rc
op_assign
id|i2c_master_send
c_func
(paren
id|i2c_client_s
comma
id|buf
comma
l_int|2
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;bt832: i2c i/o error FFR: rc == %d (should be 2)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|bt832_hexdump
c_func
(paren
id|i2c_client_s
comma
id|buf
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if 1
singleline_comment|// for testing (even works when no camera attached)
id|printk
c_func
(paren
l_string|&quot;bt832: *** Generate NTSC M Bars *****&bslash;n&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
id|BT832_VP_TESTCONTROL0
suffix:semicolon
singleline_comment|// Reg. 42
id|buf
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
singleline_comment|// Generate NTSC System M bars, Generate Frame timing internally
r_if
c_cond
(paren
l_int|2
op_ne
(paren
id|rc
op_assign
id|i2c_master_send
c_func
(paren
id|i2c_client_s
comma
id|buf
comma
l_int|2
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;bt832: i2c i/o error MBAR: rc == %d (should be 2)&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;Bt832: Camera Present: %s&bslash;n&quot;
comma
(paren
id|buf
(braket
l_int|1
op_plus
id|BT832_CAM_STATUS
)braket
op_amp
id|BT832_56_CAMERA_PRESENT
)paren
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
id|bt832_hexdump
c_func
(paren
id|i2c_client_s
comma
id|buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|bt832_attach
r_static
r_int
id|bt832_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_int
id|addr
comma
r_int
r_int
id|flags
comma
r_int
id|kind
)paren
(brace
r_struct
id|bt832
op_star
id|t
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bt832_attach&bslash;n&quot;
)paren
suffix:semicolon
id|client_template.adapter
op_assign
id|adap
suffix:semicolon
id|client_template.addr
op_assign
id|addr
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bt832: chip found @ 0x%x&bslash;n&quot;
comma
id|addr
op_lshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
id|t
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|t
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|t
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|t
)paren
)paren
suffix:semicolon
id|t-&gt;client
op_assign
id|client_template
suffix:semicolon
id|t-&gt;client.data
op_assign
id|t
suffix:semicolon
id|i2c_attach_client
c_func
(paren
op_amp
id|t-&gt;client
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bt832_init
c_func
(paren
op_amp
id|t-&gt;client
)paren
)paren
(brace
id|bt832_detach
c_func
(paren
op_amp
id|t-&gt;client
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bt832_probe
r_static
r_int
id|bt832_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_int
id|rc
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bt832_probe&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|adap-&gt;id
)paren
(brace
r_case
id|I2C_ALGO_BIT
op_or
id|I2C_HW_B_BT848
suffix:colon
r_case
id|I2C_ALGO_BIT
op_or
id|I2C_HW_B_RIVA
suffix:colon
r_case
id|I2C_ALGO_SAA7134
suffix:colon
id|printk
c_func
(paren
l_string|&quot;bt832: probing %s i2c adapter [id=0x%x]&bslash;n&quot;
comma
id|adap-&gt;name
comma
id|adap-&gt;id
)paren
suffix:semicolon
id|rc
op_assign
id|i2c_probe
c_func
(paren
id|adap
comma
op_amp
id|addr_data
comma
id|bt832_attach
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;bt832: ignoring %s i2c adapter [id=0x%x]&bslash;n&quot;
comma
id|adap-&gt;name
comma
id|adap-&gt;id
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* nothing */
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|bt832_detach
r_static
r_int
id|bt832_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|bt832
op_star
id|t
op_assign
(paren
r_struct
id|bt832
op_star
)paren
id|client-&gt;data
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bt832: detach.&bslash;n&quot;
)paren
suffix:semicolon
id|i2c_detach_client
c_func
(paren
id|client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|t
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|bt832_command
id|bt832_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|bt832
op_star
id|t
op_assign
(paren
r_struct
id|bt832
op_star
)paren
id|client-&gt;data
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;bt832: command %x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|BT832_HEXDUMP
suffix:colon
(brace
r_int
r_char
op_star
id|buf
suffix:semicolon
id|buf
op_assign
id|kmalloc
c_func
(paren
l_int|65
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|bt832_hexdump
c_func
(paren
op_amp
id|t-&gt;client
comma
id|buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BT832_REATTACH
suffix:colon
id|printk
c_func
(paren
l_string|&quot;bt832: re-attach&bslash;n&quot;
)paren
suffix:semicolon
id|i2c_del_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
id|i2c_add_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;i2c bt832 driver&quot;
comma
dot
id|id
op_assign
op_minus
l_int|1
comma
multiline_comment|/* FIXME */
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
id|bt832_probe
comma
dot
id|detach_client
op_assign
id|bt832_detach
comma
dot
id|command
op_assign
id|bt832_command
comma
)brace
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;bt832&quot;
comma
dot
id|flags
op_assign
id|I2C_CLIENT_ALLOW_USE
comma
dot
id|driver
op_assign
op_amp
id|driver
comma
)brace
suffix:semicolon
DECL|function|bt832_init_module
r_int
id|bt832_init_module
c_func
(paren
r_void
)paren
(brace
id|i2c_add_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bt832_cleanup_module
r_static
r_void
id|bt832_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|variable|bt832_init_module
id|module_init
c_func
(paren
id|bt832_init_module
)paren
suffix:semicolon
DECL|variable|bt832_cleanup_module
id|module_exit
c_func
(paren
id|bt832_cleanup_module
)paren
suffix:semicolon
eof
