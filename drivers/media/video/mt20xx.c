multiline_comment|/*&n; * $Id: mt20xx.c,v 1.3 2005/02/15 15:59:35 kraxel Exp $&n; *&n; * i2c tv tuner chip device driver&n; * controls microtune tuners, mt2032 + mt2050 at the moment.&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;media/tuner.h&gt;
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|variable|optimize_vco
r_static
r_int
r_int
id|optimize_vco
op_assign
l_int|1
suffix:semicolon
id|module_param
c_func
(paren
id|optimize_vco
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
DECL|variable|tv_antenna
r_static
r_int
r_int
id|tv_antenna
op_assign
l_int|1
suffix:semicolon
id|module_param
c_func
(paren
id|tv_antenna
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
DECL|variable|radio_antenna
r_static
r_int
r_int
id|radio_antenna
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|radio_antenna
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|macro|MT2032
mdefine_line|#define MT2032 0x04
DECL|macro|MT2030
mdefine_line|#define MT2030 0x06
DECL|macro|MT2040
mdefine_line|#define MT2040 0x07
DECL|macro|MT2050
mdefine_line|#define MT2050 0x42
DECL|variable|microtune_part
r_static
r_char
op_star
id|microtune_part
(braket
)braket
op_assign
(brace
(braket
id|MT2030
)braket
op_assign
l_string|&quot;MT2030&quot;
comma
(braket
id|MT2032
)braket
op_assign
l_string|&quot;MT2032&quot;
comma
(braket
id|MT2040
)braket
op_assign
l_string|&quot;MT2040&quot;
comma
(braket
id|MT2050
)braket
op_assign
l_string|&quot;MT2050&quot;
comma
)brace
suffix:semicolon
singleline_comment|// IsSpurInBand()?
DECL|function|mt2032_spurcheck
r_static
r_int
id|mt2032_spurcheck
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
id|f1
comma
r_int
id|f2
comma
r_int
id|spectrum_from
comma
r_int
id|spectrum_to
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
id|n1
op_assign
l_int|1
comma
id|n2
comma
id|f
suffix:semicolon
id|f1
op_assign
id|f1
op_div
l_int|1000
suffix:semicolon
singleline_comment|//scale to kHz to avoid 32bit overflows
id|f2
op_assign
id|f2
op_div
l_int|1000
suffix:semicolon
id|spectrum_from
op_div_assign
l_int|1000
suffix:semicolon
id|spectrum_to
op_div_assign
l_int|1000
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;spurcheck f1=%d f2=%d  from=%d to=%d&bslash;n&quot;
comma
id|f1
comma
id|f2
comma
id|spectrum_from
comma
id|spectrum_to
)paren
suffix:semicolon
r_do
(brace
id|n2
op_assign
op_minus
id|n1
suffix:semicolon
id|f
op_assign
id|n1
op_star
(paren
id|f1
op_minus
id|f2
)paren
suffix:semicolon
r_do
(brace
id|n2
op_decrement
suffix:semicolon
id|f
op_assign
id|f
op_minus
id|f2
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;spurtest n1=%d n2=%d ftest=%d&bslash;n&quot;
comma
id|n1
comma
id|n2
comma
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|f
OG
id|spectrum_from
)paren
op_logical_and
(paren
id|f
OL
id|spectrum_to
)paren
)paren
(brace
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032 spurcheck triggered: %d&bslash;n&quot;
comma
id|n1
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|f
OG
(paren
id|f2
op_minus
id|spectrum_to
)paren
)paren
op_logical_or
(paren
id|n2
OG
op_minus
l_int|5
)paren
)paren
suffix:semicolon
id|n1
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|n1
OL
l_int|5
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|mt2032_compute_freq
r_static
r_int
id|mt2032_compute_freq
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_int
id|rfin
comma
r_int
r_int
id|if1
comma
r_int
r_int
id|if2
comma
r_int
r_int
id|spectrum_from
comma
r_int
r_int
id|spectrum_to
comma
r_int
r_char
op_star
id|buf
comma
r_int
op_star
id|ret_sel
comma
r_int
r_int
id|xogc
)paren
singleline_comment|//all in Hz
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_int
id|fref
comma
id|lo1
comma
id|lo1n
comma
id|lo1a
comma
id|s
comma
id|sel
comma
id|lo1freq
comma
id|desired_lo1
comma
id|desired_lo2
comma
id|lo2
comma
id|lo2n
comma
id|lo2a
comma
id|lo2num
comma
id|lo2freq
suffix:semicolon
id|fref
op_assign
l_int|5250
op_star
l_int|1000
suffix:semicolon
singleline_comment|//5.25MHz
id|desired_lo1
op_assign
id|rfin
op_plus
id|if1
suffix:semicolon
id|lo1
op_assign
(paren
l_int|2
op_star
(paren
id|desired_lo1
op_div
l_int|1000
)paren
op_plus
(paren
id|fref
op_div
l_int|1000
)paren
)paren
op_div
(paren
l_int|2
op_star
id|fref
op_div
l_int|1000
)paren
suffix:semicolon
id|lo1n
op_assign
id|lo1
op_div
l_int|8
suffix:semicolon
id|lo1a
op_assign
id|lo1
op_minus
(paren
id|lo1n
op_star
l_int|8
)paren
suffix:semicolon
id|s
op_assign
id|rfin
op_div
l_int|1000
op_div
l_int|1000
op_plus
l_int|1090
suffix:semicolon
r_if
c_cond
(paren
id|optimize_vco
)paren
(brace
r_if
c_cond
(paren
id|s
OG
l_int|1890
)paren
(brace
id|sel
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s
OG
l_int|1720
)paren
(brace
id|sel
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s
OG
l_int|1530
)paren
(brace
id|sel
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s
OG
l_int|1370
)paren
(brace
id|sel
op_assign
l_int|3
suffix:semicolon
)brace
r_else
id|sel
op_assign
l_int|4
suffix:semicolon
singleline_comment|// &gt;1090
)brace
r_else
(brace
r_if
c_cond
(paren
id|s
OG
l_int|1790
)paren
(brace
id|sel
op_assign
l_int|0
suffix:semicolon
)brace
singleline_comment|// &lt;1958
r_else
r_if
c_cond
(paren
id|s
OG
l_int|1617
)paren
(brace
id|sel
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s
OG
l_int|1449
)paren
(brace
id|sel
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s
OG
l_int|1291
)paren
(brace
id|sel
op_assign
l_int|3
suffix:semicolon
)brace
r_else
id|sel
op_assign
l_int|4
suffix:semicolon
singleline_comment|// &gt;1090
)brace
op_star
id|ret_sel
op_assign
id|sel
suffix:semicolon
id|lo1freq
op_assign
(paren
id|lo1a
op_plus
l_int|8
op_star
id|lo1n
)paren
op_star
id|fref
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032: rfin=%d lo1=%d lo1n=%d lo1a=%d sel=%d, lo1freq=%d&bslash;n&quot;
comma
id|rfin
comma
id|lo1
comma
id|lo1n
comma
id|lo1a
comma
id|sel
comma
id|lo1freq
)paren
suffix:semicolon
id|desired_lo2
op_assign
id|lo1freq
op_minus
id|rfin
op_minus
id|if2
suffix:semicolon
id|lo2
op_assign
(paren
id|desired_lo2
)paren
op_div
id|fref
suffix:semicolon
id|lo2n
op_assign
id|lo2
op_div
l_int|8
suffix:semicolon
id|lo2a
op_assign
id|lo2
op_minus
(paren
id|lo2n
op_star
l_int|8
)paren
suffix:semicolon
id|lo2num
op_assign
(paren
(paren
id|desired_lo2
op_div
l_int|1000
)paren
op_mod
(paren
id|fref
op_div
l_int|1000
)paren
)paren
op_star
l_int|3780
op_div
(paren
id|fref
op_div
l_int|1000
)paren
suffix:semicolon
singleline_comment|//scale to fit in 32bit arith
id|lo2freq
op_assign
(paren
id|lo2a
op_plus
l_int|8
op_star
id|lo2n
)paren
op_star
id|fref
op_plus
id|lo2num
op_star
(paren
id|fref
op_div
l_int|1000
)paren
op_div
l_int|3780
op_star
l_int|1000
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032: rfin=%d lo2=%d lo2n=%d lo2a=%d num=%d lo2freq=%d&bslash;n&quot;
comma
id|rfin
comma
id|lo2
comma
id|lo2n
comma
id|lo2a
comma
id|lo2num
comma
id|lo2freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lo1a
l_int|7
op_logical_or
id|lo1n
l_int|48
op_logical_or
id|lo2a
l_int|7
op_logical_or
id|lo2n
l_int|30
)paren
(brace
id|tuner_info
c_func
(paren
l_string|&quot;mt2032: frequency parameters out of range: %d %d %d %d&bslash;n&quot;
comma
id|lo1a
comma
id|lo1n
comma
id|lo2a
comma
id|lo2n
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|mt2032_spurcheck
c_func
(paren
id|c
comma
id|lo1freq
comma
id|desired_lo2
comma
id|spectrum_from
comma
id|spectrum_to
)paren
suffix:semicolon
singleline_comment|// should recalculate lo1 (one step up/down)
singleline_comment|// set up MT2032 register map for transfer over i2c
id|buf
(braket
l_int|0
)braket
op_assign
id|lo1n
op_minus
l_int|1
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|lo1a
op_or
(paren
id|sel
op_lshift
l_int|4
)paren
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0x86
suffix:semicolon
singleline_comment|// LOGC
id|buf
(braket
l_int|3
)braket
op_assign
l_int|0x0f
suffix:semicolon
singleline_comment|//reserved
id|buf
(braket
l_int|4
)braket
op_assign
l_int|0x1f
suffix:semicolon
id|buf
(braket
l_int|5
)braket
op_assign
(paren
id|lo2n
op_minus
l_int|1
)paren
op_or
(paren
id|lo2a
op_lshift
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rfin
OG
l_int|400
op_star
l_int|1000
op_star
l_int|1000
)paren
(brace
id|buf
(braket
l_int|6
)braket
op_assign
l_int|0xe4
suffix:semicolon
)brace
r_else
id|buf
(braket
l_int|6
)braket
op_assign
l_int|0xf4
suffix:semicolon
singleline_comment|// set PKEN per rev 1.2
id|buf
(braket
l_int|7
)braket
op_assign
l_int|8
op_plus
id|xogc
suffix:semicolon
id|buf
(braket
l_int|8
)braket
op_assign
l_int|0xc3
suffix:semicolon
singleline_comment|//reserved
id|buf
(braket
l_int|9
)braket
op_assign
l_int|0x4e
suffix:semicolon
singleline_comment|//reserved
id|buf
(braket
l_int|10
)braket
op_assign
l_int|0xec
suffix:semicolon
singleline_comment|//reserved
id|buf
(braket
l_int|11
)braket
op_assign
(paren
id|lo2num
op_amp
l_int|0xff
)paren
suffix:semicolon
id|buf
(braket
l_int|12
)braket
op_assign
(paren
id|lo2num
op_rshift
l_int|8
)paren
op_or
l_int|0x80
suffix:semicolon
singleline_comment|// Lo2RST
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mt2032_check_lo_lock
r_static
r_int
id|mt2032_check_lo_lock
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_try
comma
id|lock
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_for
c_loop
(paren
r_try
op_assign
l_int|0
suffix:semicolon
r_try
OL
l_int|10
suffix:semicolon
r_try
op_increment
)paren
(brace
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x0e
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|i2c_master_recv
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032 Reg.E=0x%02x&bslash;n&quot;
comma
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|lock
op_assign
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0x06
suffix:semicolon
r_if
c_cond
(paren
id|lock
op_eq
l_int|6
)paren
r_break
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032: pll wait 1ms for lock (0x%2x)&bslash;n&quot;
comma
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
r_return
id|lock
suffix:semicolon
)brace
DECL|function|mt2032_optimize_vco
r_static
r_int
id|mt2032_optimize_vco
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
id|sel
comma
r_int
id|lock
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|tad1
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|i2c_master_recv
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032 Reg.F=0x%02x&bslash;n&quot;
comma
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|tad1
op_assign
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0x07
suffix:semicolon
r_if
c_cond
(paren
id|tad1
op_eq
l_int|0
)paren
(brace
r_return
id|lock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tad1
op_eq
l_int|1
)paren
(brace
r_return
id|lock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tad1
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|sel
op_eq
l_int|0
)paren
(brace
r_return
id|lock
suffix:semicolon
)brace
r_else
id|sel
op_decrement
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|sel
OL
l_int|4
)paren
(brace
id|sel
op_increment
suffix:semicolon
)brace
r_else
r_return
id|lock
suffix:semicolon
)brace
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032 optimize_vco: sel=%d&bslash;n&quot;
comma
id|sel
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|sel
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
id|lock
op_assign
id|mt2032_check_lo_lock
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
id|lock
suffix:semicolon
)brace
DECL|function|mt2032_set_if_freq
r_static
r_void
id|mt2032_set_if_freq
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_int
id|rfin
comma
r_int
r_int
id|if1
comma
r_int
r_int
id|if2
comma
r_int
r_int
id|from
comma
r_int
r_int
id|to
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|21
)braket
suffix:semicolon
r_int
id|lint_try
comma
id|ret
comma
id|sel
comma
id|lock
op_assign
l_int|0
suffix:semicolon
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032_set_if_freq rfin=%d if1=%d if2=%d from=%d to=%d&bslash;n&quot;
comma
id|rfin
comma
id|if1
comma
id|if2
comma
id|from
comma
id|to
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|i2c_master_recv
c_func
(paren
id|c
comma
id|buf
comma
l_int|21
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|mt2032_compute_freq
c_func
(paren
id|c
comma
id|rfin
comma
id|if1
comma
id|if2
comma
id|from
comma
id|to
comma
op_amp
id|buf
(braket
l_int|1
)braket
comma
op_amp
id|sel
comma
id|t-&gt;xogc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
suffix:semicolon
singleline_comment|// send only the relevant registers per Rev. 1.2
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|4
)paren
suffix:semicolon
id|buf
(braket
l_int|5
)braket
op_assign
l_int|5
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
op_plus
l_int|5
comma
l_int|4
)paren
suffix:semicolon
id|buf
(braket
l_int|11
)braket
op_assign
l_int|11
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
op_plus
l_int|11
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|3
)paren
(brace
id|tuner_warn
c_func
(paren
l_string|&quot;i2c i/o error: rc == %d (should be 3)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
singleline_comment|// wait for PLLs to lock (per manual), retry LINT if not.
r_for
c_loop
(paren
id|lint_try
op_assign
l_int|0
suffix:semicolon
id|lint_try
OL
l_int|2
suffix:semicolon
id|lint_try
op_increment
)paren
(brace
id|lock
op_assign
id|mt2032_check_lo_lock
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|optimize_vco
)paren
(brace
id|lock
op_assign
id|mt2032_optimize_vco
c_func
(paren
id|c
comma
id|sel
comma
id|lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lock
op_eq
l_int|6
)paren
(brace
r_break
suffix:semicolon
)brace
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032: re-init PLLs by LINT&bslash;n&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|7
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x80
op_plus
l_int|8
op_plus
id|t-&gt;xogc
suffix:semicolon
singleline_comment|// set LINT to re-init PLLs
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|8
op_plus
id|t-&gt;xogc
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lock
op_ne
l_int|6
)paren
id|tuner_warn
c_func
(paren
l_string|&quot;MT2032 Fatal Error: PLLs didn&squot;t lock.&bslash;n&quot;
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|2
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x20
suffix:semicolon
singleline_comment|// LOGC for optimal phase noise
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|2
)paren
id|tuner_warn
c_func
(paren
l_string|&quot;i2c i/o error: rc == %d (should be 2)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
DECL|function|mt2032_set_tv_freq
r_static
r_void
id|mt2032_set_tv_freq
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_int
id|freq
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
id|if2
comma
id|from
comma
id|to
suffix:semicolon
singleline_comment|// signal bandwidth and picture carrier
r_if
c_cond
(paren
id|t-&gt;std
op_amp
id|V4L2_STD_525_60
)paren
(brace
singleline_comment|// NTSC
id|from
op_assign
l_int|40750
op_star
l_int|1000
suffix:semicolon
id|to
op_assign
l_int|46750
op_star
l_int|1000
suffix:semicolon
id|if2
op_assign
l_int|45750
op_star
l_int|1000
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// PAL
id|from
op_assign
l_int|32900
op_star
l_int|1000
suffix:semicolon
id|to
op_assign
l_int|39900
op_star
l_int|1000
suffix:semicolon
id|if2
op_assign
l_int|38900
op_star
l_int|1000
suffix:semicolon
)brace
id|mt2032_set_if_freq
c_func
(paren
id|c
comma
id|freq
op_star
l_int|62500
multiline_comment|/* freq*1000*1000/16 */
comma
l_int|1090
op_star
l_int|1000
op_star
l_int|1000
comma
id|if2
comma
id|from
comma
id|to
)paren
suffix:semicolon
)brace
DECL|function|mt2032_set_radio_freq
r_static
r_void
id|mt2032_set_radio_freq
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_int
id|freq
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
id|if2
op_assign
id|t-&gt;radio_if2
suffix:semicolon
singleline_comment|// per Manual for FM tuning: first if center freq. 1085 MHz
id|mt2032_set_if_freq
c_func
(paren
id|c
comma
id|freq
op_star
l_int|62500
multiline_comment|/* freq*1000*1000/16 */
comma
l_int|1085
op_star
l_int|1000
op_star
l_int|1000
comma
id|if2
comma
id|if2
comma
id|if2
)paren
suffix:semicolon
)brace
singleline_comment|// Initalization as described in &quot;MT203x Programming Procedures&quot;, Rev 1.2, Feb.2001
DECL|function|mt2032_init
r_static
r_int
id|mt2032_init
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|21
)braket
suffix:semicolon
r_int
id|ret
comma
id|xogc
comma
id|xok
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Initialize Registers per spec.
id|buf
(braket
l_int|1
)braket
op_assign
l_int|2
suffix:semicolon
singleline_comment|// Index to register 2
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0xff
suffix:semicolon
id|buf
(braket
l_int|3
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|buf
(braket
l_int|4
)braket
op_assign
l_int|0x1f
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
op_plus
l_int|1
comma
l_int|4
)paren
suffix:semicolon
id|buf
(braket
l_int|5
)braket
op_assign
l_int|6
suffix:semicolon
singleline_comment|// Index register 6
id|buf
(braket
l_int|6
)braket
op_assign
l_int|0xe4
suffix:semicolon
id|buf
(braket
l_int|7
)braket
op_assign
l_int|0x8f
suffix:semicolon
id|buf
(braket
l_int|8
)braket
op_assign
l_int|0xc3
suffix:semicolon
id|buf
(braket
l_int|9
)braket
op_assign
l_int|0x4e
suffix:semicolon
id|buf
(braket
l_int|10
)braket
op_assign
l_int|0xec
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
op_plus
l_int|5
comma
l_int|6
)paren
suffix:semicolon
id|buf
(braket
l_int|12
)braket
op_assign
l_int|13
suffix:semicolon
singleline_comment|// Index register 13
id|buf
(braket
l_int|13
)braket
op_assign
l_int|0x32
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
op_plus
l_int|12
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// Adjust XOGC (register 7), wait for XOK
id|xogc
op_assign
l_int|7
suffix:semicolon
r_do
(brace
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032: xogc = 0x%02x&bslash;n&quot;
comma
id|xogc
op_amp
l_int|0x07
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x0e
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|i2c_master_recv
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|xok
op_assign
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0x01
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032: xok = 0x%02x&bslash;n&quot;
comma
id|xok
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xok
op_eq
l_int|1
)paren
r_break
suffix:semicolon
id|xogc
op_decrement
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2032: xogc = 0x%02x&bslash;n&quot;
comma
id|xogc
op_amp
l_int|0x07
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xogc
op_eq
l_int|3
)paren
(brace
id|xogc
op_assign
l_int|4
suffix:semicolon
singleline_comment|// min. 4 per spec
r_break
suffix:semicolon
)brace
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x07
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x88
op_plus
id|xogc
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|2
)paren
id|tuner_warn
c_func
(paren
l_string|&quot;i2c i/o error: rc == %d (should be 2)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|xok
op_ne
l_int|1
)paren
suffix:semicolon
id|t-&gt;xogc
op_assign
id|xogc
suffix:semicolon
id|t-&gt;tv_freq
op_assign
id|mt2032_set_tv_freq
suffix:semicolon
id|t-&gt;radio_freq
op_assign
id|mt2032_set_radio_freq
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|mt2050_set_antenna
r_static
r_void
id|mt2050_set_antenna
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_char
id|antenna
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|6
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|antenna
ques
c_cond
l_int|0x11
suffix:colon
l_int|0x10
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2050: enabled antenna connector %d&bslash;n&quot;
comma
id|antenna
)paren
suffix:semicolon
)brace
DECL|function|mt2050_set_if_freq
r_static
r_void
id|mt2050_set_if_freq
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_int
id|freq
comma
r_int
r_int
id|if2
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_int
id|if1
op_assign
l_int|1218
op_star
l_int|1000
op_star
l_int|1000
suffix:semicolon
r_int
r_int
id|f_lo1
comma
id|f_lo2
comma
id|lo1
comma
id|lo2
comma
id|f_lo1_modulo
comma
id|f_lo2_modulo
comma
id|num1
comma
id|num2
comma
id|div1a
comma
id|div1b
comma
id|div2a
comma
id|div2b
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|6
)braket
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2050_set_if_freq freq=%d if1=%d if2=%d&bslash;n&quot;
comma
id|freq
comma
id|if1
comma
id|if2
)paren
suffix:semicolon
id|f_lo1
op_assign
id|freq
op_plus
id|if1
suffix:semicolon
id|f_lo1
op_assign
(paren
id|f_lo1
op_div
l_int|1000000
)paren
op_star
l_int|1000000
suffix:semicolon
id|f_lo2
op_assign
id|f_lo1
op_minus
id|freq
op_minus
id|if2
suffix:semicolon
id|f_lo2
op_assign
(paren
id|f_lo2
op_div
l_int|50000
)paren
op_star
l_int|50000
suffix:semicolon
id|lo1
op_assign
id|f_lo1
op_div
l_int|4000000
suffix:semicolon
id|lo2
op_assign
id|f_lo2
op_div
l_int|4000000
suffix:semicolon
id|f_lo1_modulo
op_assign
id|f_lo1
op_minus
(paren
id|lo1
op_star
l_int|4000000
)paren
suffix:semicolon
id|f_lo2_modulo
op_assign
id|f_lo2
op_minus
(paren
id|lo2
op_star
l_int|4000000
)paren
suffix:semicolon
id|num1
op_assign
l_int|4
op_star
id|f_lo1_modulo
op_div
l_int|4000000
suffix:semicolon
id|num2
op_assign
l_int|4096
op_star
(paren
id|f_lo2_modulo
op_div
l_int|1000
)paren
op_div
l_int|4000
suffix:semicolon
singleline_comment|// todo spurchecks
id|div1a
op_assign
(paren
id|lo1
op_div
l_int|12
)paren
op_minus
l_int|1
suffix:semicolon
id|div1b
op_assign
id|lo1
op_minus
(paren
id|div1a
op_plus
l_int|1
)paren
op_star
l_int|12
suffix:semicolon
id|div2a
op_assign
(paren
id|lo2
op_div
l_int|8
)paren
op_minus
l_int|1
suffix:semicolon
id|div2b
op_assign
id|lo2
op_minus
(paren
id|div2a
op_plus
l_int|1
)paren
op_star
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|tuner_debug
OG
l_int|1
)paren
(brace
id|tuner_dbg
c_func
(paren
l_string|&quot;lo1 lo2 = %d %d&bslash;n&quot;
comma
id|lo1
comma
id|lo2
)paren
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;num1 num2 div1a div1b div2a div2b= %x %x %x %x %x %x&bslash;n&quot;
comma
id|num1
comma
id|num2
comma
id|div1a
comma
id|div1b
comma
id|div2a
comma
id|div2b
)paren
suffix:semicolon
)brace
id|buf
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|4
op_star
id|div1b
op_plus
id|num1
suffix:semicolon
r_if
c_cond
(paren
id|freq
OL
l_int|275
op_star
l_int|1000
op_star
l_int|1000
)paren
(brace
id|buf
(braket
l_int|1
)braket
op_assign
id|buf
(braket
l_int|1
)braket
op_or
l_int|0x80
suffix:semicolon
)brace
id|buf
(braket
l_int|2
)braket
op_assign
id|div1a
suffix:semicolon
id|buf
(braket
l_int|3
)braket
op_assign
l_int|32
op_star
id|div2b
op_plus
id|num2
op_div
l_int|256
suffix:semicolon
id|buf
(braket
l_int|4
)braket
op_assign
id|num2
op_minus
(paren
id|num2
op_div
l_int|256
)paren
op_star
l_int|256
suffix:semicolon
id|buf
(braket
l_int|5
)braket
op_assign
id|div2a
suffix:semicolon
r_if
c_cond
(paren
id|num2
op_ne
l_int|0
)paren
(brace
id|buf
(braket
l_int|5
)braket
op_assign
id|buf
(braket
l_int|5
)braket
op_or
l_int|0x40
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tuner_debug
OG
l_int|1
)paren
(brace
r_int
id|i
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;bufs is: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%x &quot;
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|6
)paren
id|tuner_warn
c_func
(paren
l_string|&quot;i2c i/o error: rc == %d (should be 6)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
DECL|function|mt2050_set_tv_freq
r_static
r_void
id|mt2050_set_tv_freq
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_int
id|freq
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_int
id|if2
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;std
op_amp
id|V4L2_STD_525_60
)paren
(brace
singleline_comment|// NTSC
id|if2
op_assign
l_int|45750
op_star
l_int|1000
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// PAL
id|if2
op_assign
l_int|38900
op_star
l_int|1000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|V4L2_TUNER_DIGITAL_TV
op_eq
id|t-&gt;mode
)paren
(brace
singleline_comment|// DVB (pinnacle 300i)
id|if2
op_assign
l_int|36150
op_star
l_int|1000
suffix:semicolon
)brace
id|mt2050_set_if_freq
c_func
(paren
id|c
comma
id|freq
op_star
l_int|62500
comma
id|if2
)paren
suffix:semicolon
id|mt2050_set_antenna
c_func
(paren
id|c
comma
id|tv_antenna
)paren
suffix:semicolon
)brace
DECL|function|mt2050_set_radio_freq
r_static
r_void
id|mt2050_set_radio_freq
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_int
id|freq
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
id|if2
op_assign
id|t-&gt;radio_if2
suffix:semicolon
id|mt2050_set_if_freq
c_func
(paren
id|c
comma
id|freq
op_star
l_int|62500
comma
id|if2
)paren
suffix:semicolon
id|mt2050_set_antenna
c_func
(paren
id|c
comma
id|radio_antenna
)paren
suffix:semicolon
)brace
DECL|function|mt2050_init
r_static
r_int
id|mt2050_init
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|6
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x10
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|//  power
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// m1lo
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x0d
suffix:semicolon
id|ret
op_assign
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|i2c_master_recv
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;mt2050: sro is %x&bslash;n&quot;
comma
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|t-&gt;tv_freq
op_assign
id|mt2050_set_tv_freq
suffix:semicolon
id|t-&gt;radio_freq
op_assign
id|mt2050_set_radio_freq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|microtune_init
r_int
id|microtune_init
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_struct
id|tuner
op_star
id|t
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|21
)braket
suffix:semicolon
r_int
id|company_code
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
r_sizeof
(paren
id|buf
)paren
)paren
suffix:semicolon
id|t-&gt;tv_freq
op_assign
l_int|NULL
suffix:semicolon
id|t-&gt;radio_freq
op_assign
l_int|NULL
suffix:semicolon
id|name
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|c
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|i2c_master_recv
c_func
(paren
id|c
comma
id|buf
comma
l_int|21
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tuner_debug
)paren
(brace
r_int
id|i
suffix:semicolon
id|tuner_dbg
c_func
(paren
l_string|&quot;MT20xx hexdump:&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|21
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|8
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; &quot;
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|company_code
op_assign
id|buf
(braket
l_int|0x11
)braket
op_lshift
l_int|8
op_or
id|buf
(braket
l_int|0x12
)braket
suffix:semicolon
id|tuner_info
c_func
(paren
l_string|&quot;microtune: companycode=%04x part=%02x rev=%02x&bslash;n&quot;
comma
id|company_code
comma
id|buf
(braket
l_int|0x13
)braket
comma
id|buf
(braket
l_int|0x14
)braket
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* seems to cause more problems than it solves ... */
r_switch
c_cond
(paren
id|company_code
)paren
(brace
r_case
l_int|0x30bf
suffix:colon
r_case
l_int|0x3cbf
suffix:colon
r_case
l_int|0x3dbf
suffix:colon
r_case
l_int|0x4d54
suffix:colon
r_case
l_int|0x8e81
suffix:colon
r_case
l_int|0x8e91
suffix:colon
multiline_comment|/* ok (?) */
r_break
suffix:semicolon
r_default
suffix:colon
id|tuner_warn
c_func
(paren
l_string|&quot;tuner: microtune: unknown companycode&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|buf
(braket
l_int|0x13
)braket
OL
id|ARRAY_SIZE
c_func
(paren
id|microtune_part
)paren
op_logical_and
l_int|NULL
op_ne
id|microtune_part
(braket
id|buf
(braket
l_int|0x13
)braket
)braket
)paren
id|name
op_assign
id|microtune_part
(braket
id|buf
(braket
l_int|0x13
)braket
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|buf
(braket
l_int|0x13
)braket
)paren
(brace
r_case
id|MT2032
suffix:colon
id|mt2032_init
c_func
(paren
id|c
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MT2050
suffix:colon
id|mt2050_init
c_func
(paren
id|c
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|tuner_info
c_func
(paren
l_string|&quot;microtune %s found, not (yet?) supported, sorry :-/&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|strlcpy
c_func
(paren
id|c-&gt;name
comma
id|name
comma
r_sizeof
(paren
id|c-&gt;name
)paren
)paren
suffix:semicolon
id|tuner_info
c_func
(paren
l_string|&quot;microtune %s found, OK&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
