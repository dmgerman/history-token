multiline_comment|/*&n; * generic helper functions for video4linux capture buffers, to handle&n; * memory management and PCI DMA.  Right now bttv + saa7134 use it.&n; *&n; * The functions expect the hardware being able to scatter gatter&n; * (i.e. the buffers are not linear in physical memory, but fragmented&n; * into PAGE_SIZE chunks).  They also assume the driver does not need&n; * to touch the video data (thus it is probably not useful for USB as&n; * data often must be uncompressed by the drivers).&n; * &n; * (c) 2001,02 Gerd Knorr &lt;kraxel@bytesex.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/iobuf.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;video-buf.h&quot;
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;helper module to manage video4linux pci dma buffers&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(level, fmt, arg...)&t;if (debug &gt;= level) &bslash;&n;&t;printk(KERN_DEBUG &quot;vbuf: &quot; fmt, ## arg)
r_struct
id|scatterlist
op_star
DECL|function|videobuf_vmalloc_to_sg
id|videobuf_vmalloc_to_sg
c_func
(paren
r_int
r_char
op_star
id|virt
comma
r_int
id|nr_pages
)paren
(brace
r_struct
id|scatterlist
op_star
id|sglist
suffix:semicolon
r_struct
id|page
op_star
id|pg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|sglist
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
id|nr_pages
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sglist
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|sglist
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
id|nr_pages
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_pages
suffix:semicolon
id|i
op_increment
comma
id|virt
op_add_assign
id|PAGE_SIZE
)paren
(brace
id|pg
op_assign
id|vmalloc_to_page
c_func
(paren
id|virt
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|pg
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|PageHighMem
c_func
(paren
id|pg
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|sglist
(braket
id|i
)braket
dot
id|page
op_assign
id|pg
suffix:semicolon
id|sglist
(braket
id|i
)braket
dot
id|length
op_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_return
id|sglist
suffix:semicolon
id|err
suffix:colon
id|kfree
c_func
(paren
id|sglist
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_struct
id|scatterlist
op_star
DECL|function|videobuf_iobuf_to_sg
id|videobuf_iobuf_to_sg
c_func
(paren
r_struct
id|kiobuf
op_star
id|iobuf
)paren
(brace
r_struct
id|scatterlist
op_star
id|sglist
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|sglist
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
id|iobuf-&gt;nr_pages
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sglist
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|sglist
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
id|iobuf-&gt;nr_pages
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|iobuf-&gt;maplist
(braket
l_int|0
)braket
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|PageHighMem
c_func
(paren
id|iobuf-&gt;maplist
(braket
l_int|0
)braket
)paren
)paren
multiline_comment|/* DMA to highmem pages might not work */
r_goto
id|err
suffix:semicolon
id|sglist
(braket
l_int|0
)braket
dot
id|page
op_assign
id|iobuf-&gt;maplist
(braket
l_int|0
)braket
suffix:semicolon
id|sglist
(braket
l_int|0
)braket
dot
id|offset
op_assign
id|iobuf-&gt;offset
suffix:semicolon
id|sglist
(braket
l_int|0
)braket
dot
id|length
op_assign
id|PAGE_SIZE
op_minus
id|iobuf-&gt;offset
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|iobuf-&gt;nr_pages
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|iobuf-&gt;maplist
(braket
id|i
)braket
)paren
r_goto
id|err
suffix:semicolon
r_if
c_cond
(paren
id|PageHighMem
c_func
(paren
id|iobuf-&gt;maplist
(braket
id|i
)braket
)paren
)paren
r_goto
id|err
suffix:semicolon
id|sglist
(braket
id|i
)braket
dot
id|page
op_assign
id|iobuf-&gt;maplist
(braket
id|i
)braket
suffix:semicolon
id|sglist
(braket
id|i
)braket
dot
id|length
op_assign
id|PAGE_SIZE
suffix:semicolon
)brace
r_return
id|sglist
suffix:semicolon
id|err
suffix:colon
id|kfree
c_func
(paren
id|sglist
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|videobuf_dma_init_user
r_int
id|videobuf_dma_init_user
c_func
(paren
r_struct
id|videobuf_dmabuf
op_star
id|dma
comma
r_int
id|direction
comma
r_int
r_int
id|data
comma
r_int
r_int
id|size
)paren
(brace
r_int
id|err
comma
id|rw
op_assign
l_int|0
suffix:semicolon
id|dma-&gt;direction
op_assign
id|direction
suffix:semicolon
r_switch
c_cond
(paren
id|dma-&gt;direction
)paren
(brace
r_case
id|PCI_DMA_FROMDEVICE
suffix:colon
id|rw
op_assign
id|READ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DMA_TODEVICE
suffix:colon
id|rw
op_assign
id|WRITE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|err
op_assign
id|alloc_kiovec
c_func
(paren
l_int|1
comma
op_amp
id|dma-&gt;iobuf
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|err
op_assign
id|map_user_kiobuf
c_func
(paren
id|rw
comma
id|dma-&gt;iobuf
comma
id|data
comma
id|size
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;map_user_kiobuf: %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dma-&gt;nr_pages
op_assign
id|dma-&gt;iobuf-&gt;nr_pages
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|videobuf_dma_init_kernel
r_int
id|videobuf_dma_init_kernel
c_func
(paren
r_struct
id|videobuf_dmabuf
op_star
id|dma
comma
r_int
id|direction
comma
r_int
id|nr_pages
)paren
(brace
id|dma-&gt;direction
op_assign
id|direction
suffix:semicolon
id|dma-&gt;vmalloc
op_assign
id|vmalloc_32
c_func
(paren
id|nr_pages
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|dma-&gt;vmalloc
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;vmalloc_32(%d pages) failed&bslash;n&quot;
comma
id|nr_pages
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dma-&gt;vmalloc
comma
l_int|0
comma
id|nr_pages
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|dma-&gt;nr_pages
op_assign
id|nr_pages
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|videobuf_dma_pci_map
r_int
id|videobuf_dma_pci_map
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|videobuf_dmabuf
op_star
id|dma
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|dma-&gt;nr_pages
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;iobuf
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|err
op_assign
id|lock_kiovec
c_func
(paren
l_int|1
comma
op_amp
id|dma-&gt;iobuf
comma
l_int|1
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;lock_kiovec: %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|dma-&gt;sglist
op_assign
id|videobuf_iobuf_to_sg
c_func
(paren
id|dma-&gt;iobuf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma-&gt;vmalloc
)paren
(brace
id|dma-&gt;sglist
op_assign
id|videobuf_vmalloc_to_sg
(paren
id|dma-&gt;vmalloc
comma
id|dma-&gt;nr_pages
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|dma-&gt;sglist
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;scatterlist is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dma-&gt;sglen
op_assign
id|pci_map_sg
c_func
(paren
id|dev
comma
id|dma-&gt;sglist
comma
id|dma-&gt;nr_pages
comma
id|dma-&gt;direction
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|videobuf_dma_pci_sync
r_int
id|videobuf_dma_pci_sync
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|videobuf_dmabuf
op_star
id|dma
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dma-&gt;sglen
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|pci_dma_sync_sg
c_func
(paren
id|dev
comma
id|dma-&gt;sglist
comma
id|dma-&gt;nr_pages
comma
id|dma-&gt;direction
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|videobuf_dma_pci_unmap
r_int
id|videobuf_dma_pci_unmap
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|videobuf_dmabuf
op_star
id|dma
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dma-&gt;sglen
)paren
r_return
l_int|0
suffix:semicolon
id|pci_unmap_sg
c_func
(paren
id|dev
comma
id|dma-&gt;sglist
comma
id|dma-&gt;nr_pages
comma
id|dma-&gt;direction
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dma-&gt;sglist
)paren
suffix:semicolon
id|dma-&gt;sglist
op_assign
l_int|NULL
suffix:semicolon
id|dma-&gt;sglen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;iobuf
)paren
id|unlock_kiovec
c_func
(paren
l_int|1
comma
op_amp
id|dma-&gt;iobuf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|videobuf_dma_free
r_int
id|videobuf_dma_free
c_func
(paren
r_struct
id|videobuf_dmabuf
op_star
id|dma
)paren
(brace
r_if
c_cond
(paren
id|dma-&gt;sglen
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma-&gt;iobuf
)paren
(brace
id|unmap_kiobuf
c_func
(paren
id|dma-&gt;iobuf
)paren
suffix:semicolon
id|free_kiovec
c_func
(paren
l_int|1
comma
op_amp
id|dma-&gt;iobuf
)paren
suffix:semicolon
id|dma-&gt;iobuf
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma-&gt;vmalloc
)paren
(brace
id|vfree
c_func
(paren
id|dma-&gt;vmalloc
)paren
suffix:semicolon
id|dma-&gt;vmalloc
op_assign
l_int|NULL
suffix:semicolon
)brace
id|dma-&gt;direction
op_assign
id|PCI_DMA_NONE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|videobuf_alloc
r_void
op_star
id|videobuf_alloc
c_func
(paren
r_int
id|size
comma
r_int
id|type
)paren
(brace
r_struct
id|videobuf_buffer
op_star
id|vb
suffix:semicolon
id|vb
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|vb
)paren
(brace
id|memset
c_func
(paren
id|vb
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|vb-&gt;type
op_assign
id|type
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|vb-&gt;done
)paren
suffix:semicolon
)brace
r_return
id|vb
suffix:semicolon
)brace
DECL|function|videobuf_waiton
r_int
id|videobuf_waiton
c_func
(paren
r_struct
id|videobuf_buffer
op_star
id|vb
comma
r_int
id|non_blocking
comma
r_int
id|intr
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|vb-&gt;done
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
id|vb-&gt;state
op_eq
id|STATE_ACTIVE
op_logical_or
id|vb-&gt;state
op_eq
id|STATE_QUEUED
)paren
(brace
r_if
c_cond
(paren
id|non_blocking
)paren
(brace
id|retval
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_break
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|intr
ques
c_cond
id|TASK_INTERRUPTIBLE
suffix:colon
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;buffer waiton: -EINTR&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|vb-&gt;done
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_int
DECL|function|videobuf_iolock
id|videobuf_iolock
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci
comma
r_struct
id|videobuf_buffer
op_star
id|vb
)paren
(brace
r_int
id|err
comma
id|pages
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|vb-&gt;baddr
)paren
(brace
multiline_comment|/* no userspace addr -- kernel bounce buffer */
id|pages
op_assign
id|PAGE_ALIGN
c_func
(paren
id|vb-&gt;size
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;kernel buf size=%ld (%d pages)&bslash;n&quot;
comma
id|vb-&gt;size
comma
id|pages
)paren
suffix:semicolon
id|err
op_assign
id|videobuf_dma_init_kernel
c_func
(paren
op_amp
id|vb-&gt;dma
comma
id|PCI_DMA_FROMDEVICE
comma
id|pages
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
r_return
id|err
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* dma directly to userspace */
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;user buf addr=%08lx size=%ld&bslash;n&quot;
comma
id|vb-&gt;baddr
comma
id|vb-&gt;bsize
)paren
suffix:semicolon
id|err
op_assign
id|videobuf_dma_init_user
c_func
(paren
op_amp
id|vb-&gt;dma
comma
id|PCI_DMA_FROMDEVICE
comma
id|vb-&gt;baddr
comma
id|vb-&gt;bsize
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|videobuf_dma_pci_map
c_func
(paren
id|pci
comma
op_amp
id|vb-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef HAVE_V4L2
r_extern
r_void
DECL|function|videobuf_status
id|videobuf_status
c_func
(paren
r_struct
id|v4l2_buffer
op_star
id|b
comma
r_struct
id|videobuf_buffer
op_star
id|vb
)paren
(brace
id|b-&gt;index
op_assign
id|vb-&gt;i
suffix:semicolon
id|b-&gt;type
op_assign
id|vb-&gt;type
suffix:semicolon
id|b-&gt;offset
op_assign
id|vb-&gt;boff
suffix:semicolon
id|b-&gt;length
op_assign
id|vb-&gt;bsize
suffix:semicolon
id|b-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vb-&gt;map
)paren
id|b-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_MAPPED
suffix:semicolon
r_switch
c_cond
(paren
id|vb-&gt;state
)paren
(brace
r_case
id|STATE_PREPARED
suffix:colon
r_case
id|STATE_QUEUED
suffix:colon
r_case
id|STATE_ACTIVE
suffix:colon
id|b-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_QUEUED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_DONE
suffix:colon
r_case
id|STATE_ERROR
suffix:colon
id|b-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_DONE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_NEEDS_INIT
suffix:colon
r_case
id|STATE_IDLE
suffix:colon
multiline_comment|/* nothing */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vb-&gt;field
op_amp
id|VBUF_FIELD_INTER
)paren
)paren
(brace
r_if
c_cond
(paren
id|vb-&gt;field
op_amp
id|VBUF_FIELD_ODD
)paren
id|b-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_TOPFIELD
suffix:semicolon
r_if
c_cond
(paren
id|vb-&gt;field
op_amp
id|VBUF_FIELD_EVEN
)paren
id|b-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_BOTFIELD
suffix:semicolon
)brace
id|b-&gt;timestamp
op_assign
id|vb-&gt;ts
suffix:semicolon
id|b-&gt;bytesused
op_assign
id|vb-&gt;size
suffix:semicolon
id|b-&gt;sequence
op_assign
id|vb-&gt;field_count
op_rshift
l_int|1
suffix:semicolon
)brace
macro_line|#endif /* HAVE_V4L2 */
multiline_comment|/* --------------------------------------------------------------------- */
r_static
r_void
DECL|function|videobuf_vm_open
id|videobuf_vm_open
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|videobuf_mapping
op_star
id|map
op_assign
id|vma-&gt;vm_private_data
suffix:semicolon
id|map-&gt;count
op_increment
suffix:semicolon
)brace
r_static
r_void
DECL|function|videobuf_vm_close
id|videobuf_vm_close
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|videobuf_mapping
op_star
id|map
op_assign
id|vma-&gt;vm_private_data
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* down(&amp;fh-&gt;lock); FIXME */
id|map-&gt;count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|map-&gt;count
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;munmap %p&bslash;n&quot;
comma
id|map
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VIDEO_MAX_FRAME
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|map-&gt;buflist
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|map
op_ne
id|map
)paren
r_continue
suffix:semicolon
id|map-&gt;buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|map
op_assign
l_int|NULL
suffix:semicolon
id|map-&gt;buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|baddr
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|free
)paren
id|map-&gt;buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|free
c_func
(paren
id|vma-&gt;vm_file
comma
id|map-&gt;buflist
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|map
)paren
suffix:semicolon
)brace
multiline_comment|/* up(&amp;fh-&gt;lock); FIXME */
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Get a anonymous page for the mapping.  Make sure we can DMA to that&n; * memory location with 32bit PCI devices (i.e. don&squot;t use highmem for&n; * now ...).  Bounce buffers don&squot;t work very well for the data rates&n; * video capture has.&n; */
r_static
r_struct
id|page
op_star
DECL|function|videobuf_vm_nopage
id|videobuf_vm_nopage
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_int
r_int
id|vaddr
comma
r_int
id|write_access
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;nopage: fault @ %08lx [vma %08lx-%08lx]&bslash;n&quot;
comma
id|vaddr
comma
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vaddr
OG
id|vma-&gt;vm_end
)paren
r_return
id|NOPAGE_SIGBUS
suffix:semicolon
id|page
op_assign
id|alloc_page
c_func
(paren
id|GFP_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
id|NOPAGE_OOM
suffix:semicolon
id|clear_user_page
c_func
(paren
id|page_address
c_func
(paren
id|page
)paren
comma
id|vaddr
)paren
suffix:semicolon
r_return
id|page
suffix:semicolon
)brace
DECL|variable|videobuf_vm_ops
r_static
r_struct
id|vm_operations_struct
id|videobuf_vm_ops
op_assign
(brace
id|open
suffix:colon
id|videobuf_vm_open
comma
id|close
suffix:colon
id|videobuf_vm_close
comma
id|nopage
suffix:colon
id|videobuf_vm_nopage
comma
)brace
suffix:semicolon
DECL|function|videobuf_mmap_setup
r_int
id|videobuf_mmap_setup
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|videobuf_buffer
op_star
op_star
id|buflist
comma
r_int
id|msize
comma
r_int
id|bcount
comma
r_int
id|bsize
comma
r_int
id|type
comma
id|videobuf_buffer_free
id|free
)paren
(brace
r_int
id|i
comma
id|err
suffix:semicolon
id|err
op_assign
id|videobuf_mmap_free
c_func
(paren
id|file
comma
id|buflist
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
r_return
id|err
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bcount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buflist
(braket
id|i
)braket
op_assign
id|videobuf_alloc
c_func
(paren
id|msize
comma
id|type
)paren
suffix:semicolon
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|i
op_assign
id|i
suffix:semicolon
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|boff
op_assign
id|bsize
op_star
id|i
suffix:semicolon
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|bsize
op_assign
id|bsize
suffix:semicolon
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|free
op_assign
id|free
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;mmap setup: %d buffers, %d bytes each&bslash;n&quot;
comma
id|bcount
comma
id|bsize
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|videobuf_mmap_free
r_int
id|videobuf_mmap_free
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|videobuf_buffer
op_star
op_star
id|buflist
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VIDEO_MAX_FRAME
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|buflist
(braket
id|i
)braket
op_logical_and
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|map
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VIDEO_MAX_FRAME
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|buflist
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|free
)paren
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|free
c_func
(paren
id|file
comma
id|buflist
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buflist
(braket
id|i
)braket
)paren
suffix:semicolon
id|buflist
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|videobuf_mmap_mapper
r_int
id|videobuf_mmap_mapper
c_func
(paren
r_struct
id|vm_area_struct
op_star
id|vma
comma
r_struct
id|videobuf_buffer
op_star
op_star
id|buflist
)paren
(brace
r_struct
id|videobuf_mapping
op_star
id|map
suffix:semicolon
r_int
id|first
comma
id|last
comma
id|size
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;mmap app bug: PROT_WRITE please&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_SHARED
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;mmap app bug: MAP_SHARED please&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* look for first buffer to map */
r_for
c_loop
(paren
id|first
op_assign
l_int|0
suffix:semicolon
id|first
OL
id|VIDEO_MAX_FRAME
suffix:semicolon
id|first
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|buflist
(braket
id|first
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|buflist
(braket
id|first
)braket
op_member_access_from_pointer
id|boff
op_eq
(paren
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|VIDEO_MAX_FRAME
op_eq
id|first
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;mmap app bug: offset invalid [offset=0x%lx]&bslash;n&quot;
comma
(paren
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* look for last buffer to map */
r_for
c_loop
(paren
id|size
op_assign
l_int|0
comma
id|last
op_assign
id|first
suffix:semicolon
id|last
OL
id|VIDEO_MAX_FRAME
suffix:semicolon
id|last
op_increment
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|buflist
(braket
id|last
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|buflist
(braket
id|last
)braket
op_member_access_from_pointer
id|map
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|size
op_add_assign
id|buflist
(braket
id|last
)braket
op_member_access_from_pointer
id|bsize
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|VIDEO_MAX_FRAME
op_eq
id|last
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;mmap app bug: size invalid [size=0x%lx]&bslash;n&quot;
comma
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* create mapping + update buffer list */
id|map
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|videobuf_mapping
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|map
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_for
c_loop
(paren
id|size
op_assign
l_int|0
comma
id|i
op_assign
id|first
suffix:semicolon
id|i
op_le
id|last
suffix:semicolon
id|size
op_add_assign
id|buflist
(braket
id|i
op_increment
)braket
op_member_access_from_pointer
id|bsize
)paren
(brace
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|map
op_assign
id|map
suffix:semicolon
id|buflist
(braket
id|i
)braket
op_member_access_from_pointer
id|baddr
op_assign
id|vma-&gt;vm_start
op_plus
id|size
suffix:semicolon
)brace
id|map-&gt;count
op_assign
l_int|1
suffix:semicolon
id|map-&gt;start
op_assign
id|vma-&gt;vm_start
suffix:semicolon
id|map-&gt;end
op_assign
id|vma-&gt;vm_end
suffix:semicolon
id|map-&gt;buflist
op_assign
id|buflist
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
op_amp
id|videobuf_vm_ops
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
id|VM_DONTEXPAND
suffix:semicolon
id|vma-&gt;vm_private_data
op_assign
id|map
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;mmap %p: %08lx-%08lx pgoff %08lx bufs %d-%d&bslash;n&quot;
comma
id|map
comma
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_end
comma
id|vma-&gt;vm_pgoff
comma
id|first
comma
id|last
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|videobuf_vmalloc_to_sg
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_vmalloc_to_sg
)paren
suffix:semicolon
DECL|variable|videobuf_iobuf_to_sg
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_iobuf_to_sg
)paren
suffix:semicolon
DECL|variable|videobuf_dma_init_user
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_dma_init_user
)paren
suffix:semicolon
DECL|variable|videobuf_dma_init_kernel
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_dma_init_kernel
)paren
suffix:semicolon
DECL|variable|videobuf_dma_pci_map
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_dma_pci_map
)paren
suffix:semicolon
DECL|variable|videobuf_dma_pci_sync
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_dma_pci_sync
)paren
suffix:semicolon
DECL|variable|videobuf_dma_pci_unmap
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_dma_pci_unmap
)paren
suffix:semicolon
DECL|variable|videobuf_dma_free
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_dma_free
)paren
suffix:semicolon
DECL|variable|videobuf_alloc
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_alloc
)paren
suffix:semicolon
DECL|variable|videobuf_waiton
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_waiton
)paren
suffix:semicolon
DECL|variable|videobuf_iolock
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_iolock
)paren
suffix:semicolon
macro_line|#ifdef HAVE_V4L2
DECL|variable|videobuf_status
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_status
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|videobuf_mmap_setup
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_mmap_setup
)paren
suffix:semicolon
DECL|variable|videobuf_mmap_free
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_mmap_free
)paren
suffix:semicolon
DECL|variable|videobuf_mmap_mapper
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|videobuf_mmap_mapper
)paren
suffix:semicolon
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
