multiline_comment|/*&n; * (incomplete) Driver for the VINO (Video In No Out) system found in SGI Indys.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License version 2 as published by the Free Software Foundation.&n; *&n; * Copyright (C) 2003 Ladislav Michl &lt;ladis@linux-mips.org&gt;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-sgi.h&gt;
macro_line|#include &lt;asm/addrspace.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bootinfo.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/paccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/sgi/ip22.h&gt;
macro_line|#include &lt;asm/sgi/hpc3.h&gt;
macro_line|#include &lt;asm/sgi/mc.h&gt;
macro_line|#include &quot;vino.h&quot;
multiline_comment|/* debugging? */
macro_line|#if 1
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x...)     printk(x);
macro_line|#else
DECL|macro|DEBUG
mdefine_line|#define DEBUG(x...)
macro_line|#endif
multiline_comment|/* VINO ASIC registers */
DECL|variable|vino
r_struct
id|sgi_vino
op_star
id|vino
suffix:semicolon
DECL|variable|vinostr
r_static
r_const
r_char
op_star
id|vinostr
op_assign
l_string|&quot;VINO IndyCam/TV&quot;
suffix:semicolon
DECL|variable|threshold_a
r_static
r_int
id|threshold_a
op_assign
l_int|512
suffix:semicolon
DECL|variable|threshold_b
r_static
r_int
id|threshold_b
op_assign
l_int|512
suffix:semicolon
DECL|struct|vino_device
r_struct
id|vino_device
(brace
DECL|member|vdev
r_struct
id|video_device
id|vdev
suffix:semicolon
DECL|macro|VINO_CHAN_A
mdefine_line|#define VINO_CHAN_A&t;&t;1
DECL|macro|VINO_CHAN_B
mdefine_line|#define VINO_CHAN_B&t;&t;2
DECL|member|chan
r_int
id|chan
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|vino_client
r_struct
id|vino_client
(brace
DECL|member|driver
r_struct
id|i2c_client
op_star
id|driver
suffix:semicolon
DECL|member|owner
r_int
id|owner
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|vino_video
r_struct
id|vino_video
(brace
DECL|member|chA
r_struct
id|vino_device
id|chA
suffix:semicolon
DECL|member|chB
r_struct
id|vino_device
id|chB
suffix:semicolon
DECL|member|decoder
r_struct
id|vino_client
id|decoder
suffix:semicolon
DECL|member|camera
r_struct
id|vino_client
id|camera
suffix:semicolon
DECL|member|input_lock
r_struct
id|semaphore
id|input_lock
suffix:semicolon
multiline_comment|/* Loaded into VINO descriptors to clear End Of Descriptors table&n;&t; * interupt condition */
DECL|member|dummy_page
r_int
r_int
id|dummy_page
suffix:semicolon
DECL|member|dummy_buf
r_int
r_int
id|dummy_buf
(braket
l_int|4
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|8
)paren
)paren
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|Vino
r_static
r_struct
id|vino_video
op_star
id|Vino
suffix:semicolon
DECL|function|i2c_vino_getctrl
r_int
id|i2c_vino_getctrl
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_return
id|vino-&gt;i2c_control
suffix:semicolon
)brace
DECL|function|i2c_vino_setctrl
r_void
id|i2c_vino_setctrl
c_func
(paren
r_void
op_star
id|data
comma
r_int
id|val
)paren
(brace
id|vino-&gt;i2c_control
op_assign
id|val
suffix:semicolon
)brace
DECL|function|i2c_vino_rdata
r_int
id|i2c_vino_rdata
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_return
id|vino-&gt;i2c_data
suffix:semicolon
)brace
DECL|function|i2c_vino_wdata
r_void
id|i2c_vino_wdata
c_func
(paren
r_void
op_star
id|data
comma
r_int
id|val
)paren
(brace
id|vino-&gt;i2c_data
op_assign
id|val
suffix:semicolon
)brace
DECL|variable|i2c_sgi_vino_data
r_static
r_struct
id|i2c_algo_sgi_data
id|i2c_sgi_vino_data
op_assign
(brace
dot
id|getctrl
op_assign
op_amp
id|i2c_vino_getctrl
comma
dot
id|setctrl
op_assign
op_amp
id|i2c_vino_setctrl
comma
dot
id|rdata
op_assign
op_amp
id|i2c_vino_rdata
comma
dot
id|wdata
op_assign
op_amp
id|i2c_vino_wdata
comma
dot
id|xfer_timeout
op_assign
l_int|200
comma
dot
id|ack_timeout
op_assign
l_int|1000
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * There are two possible clients on VINO I2C bus, so we limit usage only&n; * to them.&n; */
DECL|function|i2c_vino_client_reg
r_static
r_int
id|i2c_vino_client_reg
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|Vino-&gt;input_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|client-&gt;driver-&gt;id
)paren
(brace
r_case
id|I2C_DRIVERID_SAA7191
suffix:colon
r_if
c_cond
(paren
id|Vino-&gt;decoder.driver
)paren
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
id|Vino-&gt;decoder.driver
op_assign
id|client
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2C_DRIVERID_INDYCAM
suffix:colon
r_if
c_cond
(paren
id|Vino-&gt;camera.driver
)paren
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
id|Vino-&gt;camera.driver
op_assign
id|client
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|res
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|Vino-&gt;input_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|i2c_vino_client_unreg
r_static
r_int
id|i2c_vino_client_unreg
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|Vino-&gt;input_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|client
op_eq
id|Vino-&gt;decoder.driver
)paren
(brace
r_if
c_cond
(paren
id|Vino-&gt;decoder.owner
)paren
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
id|Vino-&gt;decoder.driver
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|client
op_eq
id|Vino-&gt;camera.driver
)paren
(brace
r_if
c_cond
(paren
id|Vino-&gt;camera.owner
)paren
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
id|Vino-&gt;camera.driver
op_assign
l_int|NULL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|Vino-&gt;input_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|variable|vino_i2c_adapter
r_static
r_struct
id|i2c_adapter
id|vino_i2c_adapter
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;VINO I2C bus&quot;
comma
dot
id|id
op_assign
id|I2C_HW_SGI_VINO
comma
dot
id|algo_data
op_assign
op_amp
id|i2c_sgi_vino_data
comma
dot
id|client_register
op_assign
op_amp
id|i2c_vino_client_reg
comma
dot
id|client_unregister
op_assign
op_amp
id|i2c_vino_client_unreg
comma
)brace
suffix:semicolon
DECL|function|vino_i2c_add_bus
r_static
r_int
id|vino_i2c_add_bus
c_func
(paren
r_void
)paren
(brace
r_return
id|i2c_sgi_add_bus
c_func
(paren
op_amp
id|vino_i2c_adapter
)paren
suffix:semicolon
)brace
DECL|function|vino_i2c_del_bus
r_static
r_int
id|vino_i2c_del_bus
c_func
(paren
r_void
)paren
(brace
r_return
id|i2c_sgi_del_bus
c_func
(paren
op_amp
id|vino_i2c_adapter
)paren
suffix:semicolon
)brace
DECL|function|vino_interrupt
r_static
r_void
id|vino_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
)brace
DECL|function|vino_open
r_static
r_int
id|vino_open
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
id|flags
)paren
(brace
r_struct
id|vino_device
op_star
id|videv
op_assign
(paren
r_struct
id|vino_device
op_star
)paren
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vino_close
r_static
r_void
id|vino_close
c_func
(paren
r_struct
id|video_device
op_star
id|dev
)paren
(brace
r_struct
id|vino_device
op_star
id|videv
op_assign
(paren
r_struct
id|vino_device
op_star
)paren
id|dev
suffix:semicolon
)brace
DECL|function|vino_mmap
r_static
r_int
id|vino_mmap
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_const
r_char
op_star
id|adr
comma
r_int
r_int
id|size
)paren
(brace
r_struct
id|vino_device
op_star
id|videv
op_assign
(paren
r_struct
id|vino_device
op_star
)paren
id|dev
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|vino_ioctl
r_static
r_int
id|vino_ioctl
c_func
(paren
r_struct
id|video_device
op_star
id|dev
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|vino_device
op_star
id|videv
op_assign
(paren
r_struct
id|vino_device
op_star
)paren
id|dev
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|vino_device
r_static
r_const
r_struct
id|video_device
id|vino_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_SUBCAPTURE
comma
dot
id|hardware
op_assign
id|VID_HARDWARE_VINO
comma
dot
id|name
op_assign
l_string|&quot;VINO&quot;
comma
dot
id|open
op_assign
id|vino_open
comma
dot
id|close
op_assign
id|vino_close
comma
dot
id|ioctl
op_assign
id|vino_ioctl
comma
dot
id|mmap
op_assign
id|vino_mmap
comma
)brace
suffix:semicolon
DECL|function|vino_init
r_static
r_int
id|__init
id|vino_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|rev
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* VINO is Indy specific beast */
r_if
c_cond
(paren
id|ip22_is_fullhouse
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * VINO is in the EISA address space, so the sysid register will tell&n;&t; * us if the EISA_PRESENT pin on MC has been pulled low.&n;&t; *&n;&t; * If EISA_PRESENT is not set we definitely don&squot;t have a VINO equiped&n;&t; * system.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sgimc-&gt;systemid
op_amp
id|SGIMC_SYSID_EPRESENT
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VINO not found&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|vino
op_assign
(paren
r_struct
id|sgi_vino
op_star
)paren
id|ioremap
c_func
(paren
id|VINO_BASE
comma
r_sizeof
(paren
r_struct
id|sgi_vino
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vino
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Okay, once we know that VINO is present we&squot;ll read its revision&n;&t; * safe way. One never knows... */
r_if
c_cond
(paren
id|get_dbe
c_func
(paren
id|rev
comma
op_amp
(paren
id|vino-&gt;rev_id
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VINO: failed to read revision register&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out_unmap
suffix:semicolon
)brace
r_if
c_cond
(paren
id|VINO_ID_VALUE
c_func
(paren
id|rev
)paren
op_ne
id|VINO_CHIP_ID
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VINO is not VINO (Rev/ID: 0x%04lx)&bslash;n&quot;
comma
id|rev
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out_unmap
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;VINO Rev: 0x%02lx&bslash;n&quot;
comma
id|VINO_REV_NUM
c_func
(paren
id|rev
)paren
)paren
suffix:semicolon
id|Vino
op_assign
(paren
r_struct
id|vino_video
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|vino_video
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Vino
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_unmap
suffix:semicolon
)brace
id|Vino-&gt;dummy_page
op_assign
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
op_or
id|GFP_DMA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Vino-&gt;dummy_page
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_free_vino
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|Vino-&gt;dummy_buf
(braket
id|i
)braket
op_assign
id|PHYSADDR
c_func
(paren
id|Vino-&gt;dummy_page
)paren
suffix:semicolon
id|vino-&gt;control
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* prevent VINO from throwing spurious interrupts */
id|vino-&gt;a.next_4_desc
op_assign
id|PHYSADDR
c_func
(paren
id|Vino-&gt;dummy_buf
)paren
suffix:semicolon
id|vino-&gt;b.next_4_desc
op_assign
id|PHYSADDR
c_func
(paren
id|Vino-&gt;dummy_buf
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|vino-&gt;intr_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set threshold level */
id|vino-&gt;a.fifo_thres
op_assign
id|threshold_a
suffix:semicolon
id|vino-&gt;b.fifo_thres
op_assign
id|threshold_b
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|Vino-&gt;input_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|SGI_VINO_IRQ
comma
id|vino_interrupt
comma
l_int|0
comma
id|vinostr
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VINO: irq%02d registration failed&bslash;n&quot;
comma
id|SGI_VINO_IRQ
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out_free_page
suffix:semicolon
)brace
id|ret
op_assign
id|vino_i2c_add_bus
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VINO: I2C bus registration failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_free_irq
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|Vino-&gt;chA.vdev
comma
id|VFL_TYPE_GRABBER
comma
op_minus
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, chnl %d: device registration failed.&bslash;n&quot;
comma
id|Vino-&gt;chA.vdev.name
comma
id|Vino-&gt;chA.chan
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_i2c_del_bus
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|Vino-&gt;chB.vdev
comma
id|VFL_TYPE_GRABBER
comma
op_minus
l_int|1
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s, chnl %d: device registration failed.&bslash;n&quot;
comma
id|Vino-&gt;chB.vdev.name
comma
id|Vino-&gt;chB.chan
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_unregister_vdev
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_unregister_vdev
suffix:colon
id|video_unregister_device
c_func
(paren
op_amp
id|Vino-&gt;chA.vdev
)paren
suffix:semicolon
id|out_i2c_del_bus
suffix:colon
id|vino_i2c_del_bus
c_func
(paren
)paren
suffix:semicolon
id|out_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|SGI_VINO_IRQ
comma
l_int|NULL
)paren
suffix:semicolon
id|out_free_page
suffix:colon
id|free_page
c_func
(paren
id|Vino-&gt;dummy_page
)paren
suffix:semicolon
id|out_free_vino
suffix:colon
id|kfree
c_func
(paren
id|Vino
)paren
suffix:semicolon
id|out_unmap
suffix:colon
id|iounmap
c_func
(paren
id|vino
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|vino_exit
r_static
r_void
id|__exit
id|vino_exit
c_func
(paren
r_void
)paren
(brace
id|video_unregister_device
c_func
(paren
op_amp
id|Vino-&gt;chA.vdev
)paren
suffix:semicolon
id|video_unregister_device
c_func
(paren
op_amp
id|Vino-&gt;chB.vdev
)paren
suffix:semicolon
id|vino_i2c_del_bus
c_func
(paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|SGI_VINO_IRQ
comma
l_int|NULL
)paren
suffix:semicolon
id|free_page
c_func
(paren
id|Vino-&gt;dummy_page
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|Vino
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|vino
)paren
suffix:semicolon
)brace
DECL|variable|vino_init
id|module_init
c_func
(paren
id|vino_init
)paren
suffix:semicolon
DECL|variable|vino_exit
id|module_exit
c_func
(paren
id|vino_exit
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Video4Linux driver for SGI Indy VINO (IndyCam)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
