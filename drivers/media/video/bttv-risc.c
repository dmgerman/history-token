multiline_comment|/*&n;    $Id: bttv-risc.c,v 1.8 2004/10/06 17:30:51 kraxel Exp $&n;&n;    bttv-risc.c  --  interfaces to other kernel modules&n;&n;    bttv risc code handling&n;&t;- memory management&n;&t;- generation&n;&n;    (c) 2000-2003 Gerd Knorr &lt;kraxel@bytesex.org&gt;&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &quot;bttvp.h&quot;
DECL|macro|VCR_HACK_LINES
mdefine_line|#define VCR_HACK_LINES 4
multiline_comment|/* ---------------------------------------------------------- */
multiline_comment|/* risc code generators                                       */
r_int
DECL|function|bttv_risc_packed
id|bttv_risc_packed
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|btcx_riscmem
op_star
id|risc
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|bpl
comma
r_int
r_int
id|padding
comma
r_int
r_int
id|lines
)paren
(brace
id|u32
id|instructions
comma
id|line
comma
id|todo
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
id|u32
op_star
id|rp
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* estimate risc mem: worst case is one write per page border +&n;&t;   one write per scan line + sync + jump (all 2 dwords) */
id|instructions
op_assign
(paren
id|bpl
op_star
id|lines
)paren
op_div
id|PAGE_SIZE
op_plus
id|lines
suffix:semicolon
id|instructions
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|btcx_riscmem_alloc
c_func
(paren
id|btv-&gt;c.pci
comma
id|risc
comma
id|instructions
op_star
l_int|8
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* sync instruction */
id|rp
op_assign
id|risc-&gt;cpu
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* scan lines */
id|sg
op_assign
id|sglist
suffix:semicolon
r_for
c_loop
(paren
id|line
op_assign
l_int|0
suffix:semicolon
id|line
OL
id|lines
suffix:semicolon
id|line
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|btv-&gt;opt_vcr_hack
)paren
op_logical_and
(paren
id|line
op_ge
(paren
id|lines
op_minus
id|VCR_HACK_LINES
)paren
)paren
)paren
r_continue
suffix:semicolon
r_while
c_loop
(paren
id|offset
op_logical_and
id|offset
op_ge
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
(brace
id|offset
op_sub_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bpl
op_le
id|sg_dma_len
c_func
(paren
id|sg
)paren
op_minus
id|offset
)paren
(brace
multiline_comment|/* fits into current chunk */
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_WRITE
op_or
id|BT848_RISC_SOL
op_or
id|BT848_RISC_EOL
op_or
id|bpl
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|offset
op_add_assign
id|bpl
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* scanline needs to be splitted */
id|todo
op_assign
id|bpl
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_WRITE
op_or
id|BT848_RISC_SOL
op_or
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
op_minus
id|offset
)paren
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|todo
op_sub_assign
(paren
id|sg_dma_len
c_func
(paren
id|sg
)paren
op_minus
id|offset
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|sg
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|todo
OG
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
(brace
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_WRITE
op_or
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|todo
op_sub_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
id|sg
op_increment
suffix:semicolon
)brace
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_WRITE
op_or
id|BT848_RISC_EOL
op_or
id|todo
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|sg
)paren
)paren
suffix:semicolon
id|offset
op_add_assign
id|todo
suffix:semicolon
)brace
id|offset
op_add_assign
id|padding
suffix:semicolon
)brace
multiline_comment|/* save pointer to jmp instruction address */
id|risc-&gt;jmp
op_assign
id|rp
suffix:semicolon
id|BUG_ON
c_func
(paren
(paren
id|risc-&gt;jmp
op_minus
id|risc-&gt;cpu
op_plus
l_int|2
)paren
op_div
l_int|4
OG
id|risc-&gt;size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|bttv_risc_planar
id|bttv_risc_planar
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|btcx_riscmem
op_star
id|risc
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
r_int
id|yoffset
comma
r_int
r_int
id|ybpl
comma
r_int
r_int
id|ypadding
comma
r_int
r_int
id|ylines
comma
r_int
r_int
id|uoffset
comma
r_int
r_int
id|voffset
comma
r_int
r_int
id|hshift
comma
r_int
r_int
id|vshift
comma
r_int
r_int
id|cpadding
)paren
(brace
r_int
r_int
id|instructions
comma
id|line
comma
id|todo
comma
id|ylen
comma
id|chroma
suffix:semicolon
id|u32
op_star
id|rp
comma
id|ri
suffix:semicolon
r_struct
id|scatterlist
op_star
id|ysg
suffix:semicolon
r_struct
id|scatterlist
op_star
id|usg
suffix:semicolon
r_struct
id|scatterlist
op_star
id|vsg
suffix:semicolon
r_int
id|topfield
op_assign
(paren
l_int|0
op_eq
id|yoffset
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* estimate risc mem: worst case is one write per page border +&n;&t;   one write per scan line (5 dwords)&n;&t;   plus sync + jump (2 dwords) */
id|instructions
op_assign
(paren
id|ybpl
op_star
id|ylines
op_star
l_int|2
)paren
op_div
id|PAGE_SIZE
op_plus
id|ylines
suffix:semicolon
id|instructions
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|btcx_riscmem_alloc
c_func
(paren
id|btv-&gt;c.pci
comma
id|risc
comma
id|instructions
op_star
l_int|4
op_star
l_int|5
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* sync instruction */
id|rp
op_assign
id|risc-&gt;cpu
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM3
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* scan lines */
id|ysg
op_assign
id|sglist
suffix:semicolon
id|usg
op_assign
id|sglist
suffix:semicolon
id|vsg
op_assign
id|sglist
suffix:semicolon
r_for
c_loop
(paren
id|line
op_assign
l_int|0
suffix:semicolon
id|line
OL
id|ylines
suffix:semicolon
id|line
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|btv-&gt;opt_vcr_hack
)paren
op_logical_and
(paren
id|line
op_ge
(paren
id|ylines
op_minus
id|VCR_HACK_LINES
)paren
)paren
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|vshift
)paren
(brace
r_case
l_int|0
suffix:colon
id|chroma
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|topfield
)paren
id|chroma
op_assign
(paren
(paren
id|line
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_else
id|chroma
op_assign
(paren
(paren
id|line
op_amp
l_int|1
)paren
op_eq
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|topfield
)paren
id|chroma
op_assign
(paren
(paren
id|line
op_amp
l_int|3
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_else
id|chroma
op_assign
(paren
(paren
id|line
op_amp
l_int|3
)paren
op_eq
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|chroma
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|todo
op_assign
id|ybpl
suffix:semicolon
id|todo
OG
l_int|0
suffix:semicolon
id|todo
op_sub_assign
id|ylen
)paren
(brace
multiline_comment|/* go to next sg entry if needed */
r_while
c_loop
(paren
id|yoffset
op_logical_and
id|yoffset
op_ge
id|sg_dma_len
c_func
(paren
id|ysg
)paren
)paren
(brace
id|yoffset
op_sub_assign
id|sg_dma_len
c_func
(paren
id|ysg
)paren
suffix:semicolon
id|ysg
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|uoffset
op_logical_and
id|uoffset
op_ge
id|sg_dma_len
c_func
(paren
id|usg
)paren
)paren
(brace
id|uoffset
op_sub_assign
id|sg_dma_len
c_func
(paren
id|usg
)paren
suffix:semicolon
id|usg
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|voffset
op_logical_and
id|voffset
op_ge
id|sg_dma_len
c_func
(paren
id|vsg
)paren
)paren
(brace
id|voffset
op_sub_assign
id|sg_dma_len
c_func
(paren
id|vsg
)paren
suffix:semicolon
id|vsg
op_increment
suffix:semicolon
)brace
multiline_comment|/* calculate max number of bytes we can write */
id|ylen
op_assign
id|todo
suffix:semicolon
r_if
c_cond
(paren
id|yoffset
op_plus
id|ylen
OG
id|sg_dma_len
c_func
(paren
id|ysg
)paren
)paren
id|ylen
op_assign
id|sg_dma_len
c_func
(paren
id|ysg
)paren
op_minus
id|yoffset
suffix:semicolon
r_if
c_cond
(paren
id|chroma
)paren
(brace
r_if
c_cond
(paren
id|uoffset
op_plus
(paren
id|ylen
op_rshift
id|hshift
)paren
OG
id|sg_dma_len
c_func
(paren
id|usg
)paren
)paren
id|ylen
op_assign
(paren
id|sg_dma_len
c_func
(paren
id|usg
)paren
op_minus
id|uoffset
)paren
op_lshift
id|hshift
suffix:semicolon
r_if
c_cond
(paren
id|voffset
op_plus
(paren
id|ylen
op_rshift
id|hshift
)paren
OG
id|sg_dma_len
c_func
(paren
id|vsg
)paren
)paren
id|ylen
op_assign
(paren
id|sg_dma_len
c_func
(paren
id|vsg
)paren
op_minus
id|voffset
)paren
op_lshift
id|hshift
suffix:semicolon
id|ri
op_assign
id|BT848_RISC_WRITE123
suffix:semicolon
)brace
r_else
(brace
id|ri
op_assign
id|BT848_RISC_WRITE1S23
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ybpl
op_eq
id|todo
)paren
id|ri
op_or_assign
id|BT848_RISC_SOL
suffix:semicolon
r_if
c_cond
(paren
id|ylen
op_eq
id|todo
)paren
id|ri
op_or_assign
id|BT848_RISC_EOL
suffix:semicolon
multiline_comment|/* write risc instruction */
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|ri
op_or
id|ylen
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
id|ylen
op_rshift
id|hshift
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|ylen
op_rshift
id|hshift
)paren
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|ysg
)paren
op_plus
id|yoffset
)paren
suffix:semicolon
id|yoffset
op_add_assign
id|ylen
suffix:semicolon
r_if
c_cond
(paren
id|chroma
)paren
(brace
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|usg
)paren
op_plus
id|uoffset
)paren
suffix:semicolon
id|uoffset
op_add_assign
id|ylen
op_rshift
id|hshift
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
id|vsg
)paren
op_plus
id|voffset
)paren
suffix:semicolon
id|voffset
op_add_assign
id|ylen
op_rshift
id|hshift
suffix:semicolon
)brace
)brace
id|yoffset
op_add_assign
id|ypadding
suffix:semicolon
r_if
c_cond
(paren
id|chroma
)paren
(brace
id|uoffset
op_add_assign
id|cpadding
suffix:semicolon
id|voffset
op_add_assign
id|cpadding
suffix:semicolon
)brace
)brace
multiline_comment|/* save pointer to jmp instruction address */
id|risc-&gt;jmp
op_assign
id|rp
suffix:semicolon
id|BUG_ON
c_func
(paren
(paren
id|risc-&gt;jmp
op_minus
id|risc-&gt;cpu
op_plus
l_int|2
)paren
op_div
l_int|4
OG
id|risc-&gt;size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|bttv_risc_overlay
id|bttv_risc_overlay
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|btcx_riscmem
op_star
id|risc
comma
r_const
r_struct
id|bttv_format
op_star
id|fmt
comma
r_struct
id|bttv_overlay
op_star
id|ov
comma
r_int
id|skip_even
comma
r_int
id|skip_odd
)paren
(brace
r_int
id|instructions
comma
id|rc
comma
id|line
comma
id|maxy
comma
id|start
comma
id|end
comma
id|skip
comma
id|nskips
suffix:semicolon
r_struct
id|btcx_skiplist
op_star
id|skips
suffix:semicolon
id|u32
op_star
id|rp
comma
id|ri
comma
id|ra
suffix:semicolon
id|u32
id|addr
suffix:semicolon
multiline_comment|/* skip list for window clipping */
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
id|skips
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|skips
)paren
op_star
id|ov-&gt;nclips
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* estimate risc mem: worst case is (clip+1) * lines instructions&n;&t;   + sync + jump (all 2 dwords) */
id|instructions
op_assign
(paren
id|ov-&gt;nclips
op_plus
l_int|1
)paren
op_star
(paren
(paren
id|skip_even
op_logical_or
id|skip_odd
)paren
ques
c_cond
id|ov-&gt;w.height
op_rshift
l_int|1
suffix:colon
id|ov-&gt;w.height
)paren
suffix:semicolon
id|instructions
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|btcx_riscmem_alloc
c_func
(paren
id|btv-&gt;c.pci
comma
id|risc
comma
id|instructions
op_star
l_int|8
)paren
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|skips
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* sync instruction */
id|rp
op_assign
id|risc-&gt;cpu
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_SYNC
op_or
id|BT848_FIFO_STATUS_FM1
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|addr
op_assign
(paren
r_int
r_int
)paren
id|btv-&gt;fbuf.base
suffix:semicolon
id|addr
op_add_assign
id|btv-&gt;fbuf.fmt.bytesperline
op_star
id|ov-&gt;w.top
suffix:semicolon
id|addr
op_add_assign
(paren
id|fmt-&gt;depth
op_rshift
l_int|3
)paren
op_star
id|ov-&gt;w.left
suffix:semicolon
multiline_comment|/* scan lines */
r_for
c_loop
(paren
id|maxy
op_assign
op_minus
l_int|1
comma
id|line
op_assign
l_int|0
suffix:semicolon
id|line
OL
id|ov-&gt;w.height
suffix:semicolon
id|line
op_increment
comma
id|addr
op_add_assign
id|btv-&gt;fbuf.fmt.bytesperline
)paren
(brace
r_if
c_cond
(paren
(paren
id|btv-&gt;opt_vcr_hack
)paren
op_logical_and
(paren
id|line
op_ge
(paren
id|ov-&gt;w.height
op_minus
id|VCR_HACK_LINES
)paren
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|line
op_mod
l_int|2
)paren
op_eq
l_int|0
op_logical_and
id|skip_even
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|line
op_mod
l_int|2
)paren
op_eq
l_int|1
op_logical_and
id|skip_odd
)paren
r_continue
suffix:semicolon
multiline_comment|/* calculate clipping */
r_if
c_cond
(paren
id|line
OG
id|maxy
)paren
id|btcx_calc_skips
c_func
(paren
id|line
comma
id|ov-&gt;w.width
comma
op_amp
id|maxy
comma
id|skips
comma
op_amp
id|nskips
comma
id|ov-&gt;clips
comma
id|ov-&gt;nclips
)paren
suffix:semicolon
multiline_comment|/* write out risc code */
r_for
c_loop
(paren
id|start
op_assign
l_int|0
comma
id|skip
op_assign
l_int|0
suffix:semicolon
id|start
OL
id|ov-&gt;w.width
suffix:semicolon
id|start
op_assign
id|end
)paren
(brace
r_if
c_cond
(paren
id|skip
op_ge
id|nskips
)paren
(brace
id|ri
op_assign
id|BT848_RISC_WRITE
suffix:semicolon
id|end
op_assign
id|ov-&gt;w.width
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|start
OL
id|skips
(braket
id|skip
)braket
dot
id|start
)paren
(brace
id|ri
op_assign
id|BT848_RISC_WRITE
suffix:semicolon
id|end
op_assign
id|skips
(braket
id|skip
)braket
dot
id|start
suffix:semicolon
)brace
r_else
(brace
id|ri
op_assign
id|BT848_RISC_SKIP
suffix:semicolon
id|end
op_assign
id|skips
(braket
id|skip
)braket
dot
id|end
suffix:semicolon
id|skip
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|BT848_RISC_WRITE
op_eq
id|ri
)paren
id|ra
op_assign
id|addr
op_plus
(paren
id|fmt-&gt;depth
op_rshift
l_int|3
)paren
op_star
id|start
suffix:semicolon
r_else
id|ra
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|start
)paren
id|ri
op_or_assign
id|BT848_RISC_SOL
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;w.width
op_eq
id|end
)paren
id|ri
op_or_assign
id|BT848_RISC_EOL
suffix:semicolon
id|ri
op_or_assign
(paren
id|fmt-&gt;depth
op_rshift
l_int|3
)paren
op_star
(paren
id|end
op_minus
id|start
)paren
suffix:semicolon
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|ri
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|ra
)paren
op_star
(paren
id|rp
op_increment
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|ra
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* save pointer to jmp instruction address */
id|risc-&gt;jmp
op_assign
id|rp
suffix:semicolon
id|BUG_ON
c_func
(paren
(paren
id|risc-&gt;jmp
op_minus
id|risc-&gt;cpu
op_plus
l_int|2
)paren
op_div
l_int|4
OG
id|risc-&gt;size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|skips
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------- */
r_void
DECL|function|bttv_calc_geo
id|bttv_calc_geo
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|bttv_geometry
op_star
id|geo
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|interleaved
comma
r_int
id|norm
)paren
(brace
r_const
r_struct
id|bttv_tvnorm
op_star
id|tvnorm
op_assign
op_amp
id|bttv_tvnorms
(braket
id|norm
)braket
suffix:semicolon
id|u32
id|xsf
comma
id|sr
suffix:semicolon
r_int
id|vdelay
suffix:semicolon
r_int
id|swidth
op_assign
id|tvnorm-&gt;swidth
suffix:semicolon
r_int
id|totalwidth
op_assign
id|tvnorm-&gt;totalwidth
suffix:semicolon
r_int
id|scaledtwidth
op_assign
id|tvnorm-&gt;scaledtwidth
suffix:semicolon
r_if
c_cond
(paren
id|bttv_tvcards
(braket
id|btv-&gt;c.type
)braket
dot
id|muxsel
(braket
id|btv-&gt;input
)braket
OL
l_int|0
)paren
(brace
id|swidth
op_assign
l_int|720
suffix:semicolon
id|totalwidth
op_assign
l_int|858
suffix:semicolon
id|scaledtwidth
op_assign
l_int|858
suffix:semicolon
)brace
id|vdelay
op_assign
id|tvnorm-&gt;vdelay
suffix:semicolon
macro_line|#if 0 /* FIXME */
r_if
c_cond
(paren
id|vdelay
OL
id|btv-&gt;vbi.lines
op_star
l_int|2
)paren
id|vdelay
op_assign
id|btv-&gt;vbi.lines
op_star
l_int|2
suffix:semicolon
macro_line|#endif
id|xsf
op_assign
(paren
id|width
op_star
id|scaledtwidth
)paren
op_div
id|swidth
suffix:semicolon
id|geo-&gt;hscale
op_assign
(paren
(paren
id|totalwidth
op_star
l_int|4096UL
)paren
op_div
id|xsf
op_minus
l_int|4096
)paren
suffix:semicolon
id|geo-&gt;hdelay
op_assign
id|tvnorm-&gt;hdelayx1
suffix:semicolon
id|geo-&gt;hdelay
op_assign
(paren
id|geo-&gt;hdelay
op_star
id|width
)paren
op_div
id|swidth
suffix:semicolon
id|geo-&gt;hdelay
op_and_assign
l_int|0x3fe
suffix:semicolon
id|sr
op_assign
(paren
(paren
id|tvnorm-&gt;sheight
op_rshift
(paren
id|interleaved
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
)paren
op_star
l_int|512
)paren
op_div
id|height
op_minus
l_int|512
suffix:semicolon
id|geo-&gt;vscale
op_assign
(paren
l_int|0x10000UL
op_minus
id|sr
)paren
op_amp
l_int|0x1fff
suffix:semicolon
id|geo-&gt;crop
op_assign
(paren
(paren
id|width
op_rshift
l_int|8
)paren
op_amp
l_int|0x03
)paren
op_or
(paren
(paren
id|geo-&gt;hdelay
op_rshift
l_int|6
)paren
op_amp
l_int|0x0c
)paren
op_or
(paren
(paren
id|tvnorm-&gt;sheight
op_rshift
l_int|4
)paren
op_amp
l_int|0x30
)paren
op_or
(paren
(paren
id|vdelay
op_rshift
l_int|2
)paren
op_amp
l_int|0xc0
)paren
suffix:semicolon
id|geo-&gt;vscale
op_or_assign
id|interleaved
ques
c_cond
(paren
id|BT848_VSCALE_INT
op_lshift
l_int|8
)paren
suffix:colon
l_int|0
suffix:semicolon
id|geo-&gt;vdelay
op_assign
id|vdelay
suffix:semicolon
id|geo-&gt;width
op_assign
id|width
suffix:semicolon
id|geo-&gt;sheight
op_assign
id|tvnorm-&gt;sheight
suffix:semicolon
id|geo-&gt;vtotal
op_assign
id|tvnorm-&gt;vtotal
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;opt_combfilter
)paren
(brace
id|geo-&gt;vtc
op_assign
(paren
id|width
OL
l_int|193
)paren
ques
c_cond
l_int|2
suffix:colon
(paren
(paren
id|width
OL
l_int|385
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|geo-&gt;comb
op_assign
(paren
id|width
OL
l_int|769
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|geo-&gt;vtc
op_assign
l_int|0
suffix:semicolon
id|geo-&gt;comb
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_void
DECL|function|bttv_apply_geo
id|bttv_apply_geo
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|bttv_geometry
op_star
id|geo
comma
r_int
id|odd
)paren
(brace
r_int
id|off
op_assign
id|odd
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|geo-&gt;comb
)paren
id|btor
c_func
(paren
id|BT848_VSCALE_COMB
comma
id|BT848_E_VSCALE_HI
op_plus
id|off
)paren
suffix:semicolon
r_else
id|btand
c_func
(paren
op_complement
id|BT848_VSCALE_COMB
comma
id|BT848_E_VSCALE_HI
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;vtc
comma
id|BT848_E_VTC
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;hscale
op_rshift
l_int|8
comma
id|BT848_E_HSCALE_HI
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;hscale
op_amp
l_int|0xff
comma
id|BT848_E_HSCALE_LO
op_plus
id|off
)paren
suffix:semicolon
id|btaor
c_func
(paren
(paren
id|geo-&gt;vscale
op_rshift
l_int|8
)paren
comma
l_int|0xe0
comma
id|BT848_E_VSCALE_HI
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;vscale
op_amp
l_int|0xff
comma
id|BT848_E_VSCALE_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;width
op_amp
l_int|0xff
comma
id|BT848_E_HACTIVE_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;hdelay
op_amp
l_int|0xff
comma
id|BT848_E_HDELAY_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;sheight
op_amp
l_int|0xff
comma
id|BT848_E_VACTIVE_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;vdelay
op_amp
l_int|0xff
comma
id|BT848_E_VDELAY_LO
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;crop
comma
id|BT848_E_CROP
op_plus
id|off
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;vtotal
op_rshift
l_int|8
comma
id|BT848_VTOTAL_HI
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|geo-&gt;vtotal
op_amp
l_int|0xff
comma
id|BT848_VTOTAL_LO
)paren
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------- */
multiline_comment|/* risc group / risc main loop / dma management               */
r_void
DECL|function|bttv_set_dma
id|bttv_set_dma
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
id|override
)paren
(brace
r_int
r_int
id|cmd
suffix:semicolon
r_int
id|capctl
suffix:semicolon
id|btv-&gt;cap_ctl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|btv-&gt;curr.top
)paren
id|btv-&gt;cap_ctl
op_or_assign
l_int|0x02
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|btv-&gt;curr.bottom
)paren
id|btv-&gt;cap_ctl
op_or_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|btv-&gt;cvbi
)paren
id|btv-&gt;cap_ctl
op_or_assign
l_int|0x0c
suffix:semicolon
id|capctl
op_assign
l_int|0
suffix:semicolon
id|capctl
op_or_assign
(paren
id|btv-&gt;cap_ctl
op_amp
l_int|0x03
)paren
ques
c_cond
l_int|0x03
suffix:colon
l_int|0x00
suffix:semicolon
multiline_comment|/* capture  */
id|capctl
op_or_assign
(paren
id|btv-&gt;cap_ctl
op_amp
l_int|0x0c
)paren
ques
c_cond
l_int|0x0c
suffix:colon
l_int|0x00
suffix:semicolon
multiline_comment|/* vbi data */
id|capctl
op_or_assign
id|override
suffix:semicolon
id|d2printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: capctl=%x lirq=%d top=%08Lx/%08Lx even=%08Lx/%08Lx&bslash;n&quot;
comma
id|btv-&gt;c.nr
comma
id|capctl
comma
id|btv-&gt;loop_irq
comma
id|btv-&gt;cvbi
ques
c_cond
(paren
r_int
r_int
r_int
)paren
id|btv-&gt;cvbi-&gt;top.dma
suffix:colon
l_int|0
comma
id|btv-&gt;curr.top
ques
c_cond
(paren
r_int
r_int
r_int
)paren
id|btv-&gt;curr.top-&gt;top.dma
suffix:colon
l_int|0
comma
id|btv-&gt;cvbi
ques
c_cond
(paren
r_int
r_int
r_int
)paren
id|btv-&gt;cvbi-&gt;bottom.dma
suffix:colon
l_int|0
comma
id|btv-&gt;curr.bottom
ques
c_cond
(paren
r_int
r_int
r_int
)paren
id|btv-&gt;curr.bottom-&gt;bottom.dma
suffix:colon
l_int|0
)paren
suffix:semicolon
id|cmd
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
r_if
c_cond
(paren
id|btv-&gt;loop_irq
)paren
(brace
id|cmd
op_or_assign
id|BT848_RISC_IRQ
suffix:semicolon
id|cmd
op_or_assign
(paren
id|btv-&gt;loop_irq
op_amp
l_int|0x0f
)paren
op_lshift
l_int|16
suffix:semicolon
id|cmd
op_or_assign
(paren
op_complement
id|btv-&gt;loop_irq
op_amp
l_int|0x0f
)paren
op_lshift
l_int|20
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btv-&gt;curr.frame_irq
op_logical_or
id|btv-&gt;loop_irq
op_logical_or
id|btv-&gt;cvbi
)paren
(brace
id|mod_timer
c_func
(paren
op_amp
id|btv-&gt;timeout
comma
id|jiffies
op_plus
id|BTTV_TIMEOUT
)paren
suffix:semicolon
)brace
r_else
(brace
id|del_timer
c_func
(paren
op_amp
id|btv-&gt;timeout
)paren
suffix:semicolon
)brace
id|btv-&gt;main.cpu
(braket
id|RISC_SLOT_LOOP
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|capctl
comma
op_complement
l_int|0x0f
comma
id|BT848_CAP_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|capctl
)paren
(brace
r_if
c_cond
(paren
id|btv-&gt;dma_on
)paren
r_return
suffix:semicolon
id|btwrite
c_func
(paren
id|btv-&gt;main.dma
comma
id|BT848_RISC_STRT_ADD
)paren
suffix:semicolon
id|btor
c_func
(paren
l_int|3
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
id|btv-&gt;dma_on
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|btv-&gt;dma_on
)paren
r_return
suffix:semicolon
id|btand
c_func
(paren
op_complement
l_int|3
comma
id|BT848_GPIO_DMA_CTL
)paren
suffix:semicolon
id|btv-&gt;dma_on
op_assign
l_int|0
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
r_int
DECL|function|bttv_risc_init_main
id|bttv_risc_init_main
c_func
(paren
r_struct
id|bttv
op_star
id|btv
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|btcx_riscmem_alloc
c_func
(paren
id|btv-&gt;c.pci
comma
op_amp
id|btv-&gt;main
comma
id|PAGE_SIZE
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: risc main @ %08Lx&bslash;n&quot;
comma
id|btv-&gt;c.nr
comma
(paren
r_int
r_int
r_int
)paren
id|btv-&gt;main.dma
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_SYNC
op_or
id|BT848_RISC_RESYNC
op_or
id|BT848_FIFO_STATUS_VRE
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|2
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_JUMP
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|3
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|btv-&gt;main.dma
op_plus
(paren
l_int|4
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
multiline_comment|/* top field */
id|btv-&gt;main.cpu
(braket
l_int|4
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_JUMP
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|5
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|btv-&gt;main.dma
op_plus
(paren
l_int|6
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|6
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_JUMP
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|7
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|btv-&gt;main.dma
op_plus
(paren
l_int|8
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|8
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_SYNC
op_or
id|BT848_RISC_RESYNC
op_or
id|BT848_FIFO_STATUS_VRO
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|9
)braket
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* bottom field */
id|btv-&gt;main.cpu
(braket
l_int|10
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_JUMP
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|11
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|btv-&gt;main.dma
op_plus
(paren
l_int|12
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|12
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_JUMP
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|13
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|btv-&gt;main.dma
op_plus
(paren
l_int|14
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
multiline_comment|/* jump back to top field */
id|btv-&gt;main.cpu
(braket
l_int|14
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|BT848_RISC_JUMP
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
l_int|15
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|btv-&gt;main.dma
op_plus
(paren
l_int|0
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|bttv_risc_hook
id|bttv_risc_hook
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_int
id|slot
comma
r_struct
id|btcx_riscmem
op_star
id|risc
comma
r_int
id|irqflags
)paren
(brace
r_int
r_int
id|cmd
suffix:semicolon
r_int
r_int
id|next
op_assign
id|btv-&gt;main.dma
op_plus
(paren
(paren
id|slot
op_plus
l_int|2
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|risc
)paren
(brace
id|d2printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: risc=%p slot[%d]=NULL&bslash;n&quot;
comma
id|btv-&gt;c.nr
comma
id|risc
comma
id|slot
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
id|slot
op_plus
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|next
)paren
suffix:semicolon
)brace
r_else
(brace
id|d2printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: risc=%p slot[%d]=%08Lx irq=%d&bslash;n&quot;
comma
id|btv-&gt;c.nr
comma
id|risc
comma
id|slot
comma
(paren
r_int
r_int
r_int
)paren
id|risc-&gt;dma
comma
id|irqflags
)paren
suffix:semicolon
id|cmd
op_assign
id|BT848_RISC_JUMP
suffix:semicolon
r_if
c_cond
(paren
id|irqflags
)paren
(brace
id|cmd
op_or_assign
id|BT848_RISC_IRQ
suffix:semicolon
id|cmd
op_or_assign
(paren
id|irqflags
op_amp
l_int|0x0f
)paren
op_lshift
l_int|16
suffix:semicolon
id|cmd
op_or_assign
(paren
op_complement
id|irqflags
op_amp
l_int|0x0f
)paren
op_lshift
l_int|20
suffix:semicolon
)brace
id|risc-&gt;jmp
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|risc-&gt;jmp
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|next
)paren
suffix:semicolon
id|btv-&gt;main.cpu
(braket
id|slot
op_plus
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|risc-&gt;dma
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|bttv_dma_free
id|bttv_dma_free
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|bttv_buffer
op_star
id|buf
)paren
(brace
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|videobuf_waiton
c_func
(paren
op_amp
id|buf-&gt;vb
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|videobuf_dma_pci_unmap
c_func
(paren
id|btv-&gt;c.pci
comma
op_amp
id|buf-&gt;vb.dma
)paren
suffix:semicolon
id|videobuf_dma_free
c_func
(paren
op_amp
id|buf-&gt;vb.dma
)paren
suffix:semicolon
id|btcx_riscmem_free
c_func
(paren
id|btv-&gt;c.pci
comma
op_amp
id|buf-&gt;bottom
)paren
suffix:semicolon
id|btcx_riscmem_free
c_func
(paren
id|btv-&gt;c.pci
comma
op_amp
id|buf-&gt;top
)paren
suffix:semicolon
id|buf-&gt;vb.state
op_assign
id|STATE_NEEDS_INIT
suffix:semicolon
)brace
r_int
DECL|function|bttv_buffer_activate_vbi
id|bttv_buffer_activate_vbi
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|bttv_buffer
op_star
id|vbi
)paren
(brace
multiline_comment|/* vbi capture */
r_if
c_cond
(paren
id|vbi
)paren
(brace
id|vbi-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|vbi-&gt;vb.queue
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_O_VBI
comma
op_amp
id|vbi-&gt;top
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_E_VBI
comma
op_amp
id|vbi-&gt;bottom
comma
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_O_VBI
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_E_VBI
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|bttv_buffer_activate_video
id|bttv_buffer_activate_video
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|bttv_buffer_set
op_star
id|set
)paren
(brace
multiline_comment|/* video capture */
r_if
c_cond
(paren
l_int|NULL
op_ne
id|set-&gt;top
op_logical_and
l_int|NULL
op_ne
id|set-&gt;bottom
)paren
(brace
r_if
c_cond
(paren
id|set-&gt;top
op_eq
id|set-&gt;bottom
)paren
(brace
id|set-&gt;top-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|set-&gt;top-&gt;vb.queue.next
)paren
id|list_del
c_func
(paren
op_amp
id|set-&gt;top-&gt;vb.queue
)paren
suffix:semicolon
)brace
r_else
(brace
id|set-&gt;top-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
id|set-&gt;bottom-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|set-&gt;top-&gt;vb.queue.next
)paren
id|list_del
c_func
(paren
op_amp
id|set-&gt;top-&gt;vb.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set-&gt;bottom-&gt;vb.queue.next
)paren
id|list_del
c_func
(paren
op_amp
id|set-&gt;bottom-&gt;vb.queue
)paren
suffix:semicolon
)brace
id|bttv_apply_geo
c_func
(paren
id|btv
comma
op_amp
id|set-&gt;top-&gt;geo
comma
l_int|1
)paren
suffix:semicolon
id|bttv_apply_geo
c_func
(paren
id|btv
comma
op_amp
id|set-&gt;bottom-&gt;geo
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_O_FIELD
comma
op_amp
id|set-&gt;top-&gt;top
comma
id|set-&gt;top_irq
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_E_FIELD
comma
op_amp
id|set-&gt;bottom-&gt;bottom
comma
id|set-&gt;frame_irq
)paren
suffix:semicolon
id|btaor
c_func
(paren
(paren
id|set-&gt;top-&gt;btformat
op_amp
l_int|0xf0
)paren
op_or
(paren
id|set-&gt;bottom-&gt;btformat
op_amp
l_int|0x0f
)paren
comma
op_complement
l_int|0xff
comma
id|BT848_COLOR_FMT
)paren
suffix:semicolon
id|btaor
c_func
(paren
(paren
id|set-&gt;top-&gt;btswap
op_amp
l_int|0x0a
)paren
op_or
(paren
id|set-&gt;bottom-&gt;btswap
op_amp
l_int|0x05
)paren
comma
op_complement
l_int|0x0f
comma
id|BT848_COLOR_CTL
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
l_int|NULL
op_ne
id|set-&gt;top
)paren
(brace
id|set-&gt;top-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|set-&gt;top-&gt;vb.queue.next
)paren
id|list_del
c_func
(paren
op_amp
id|set-&gt;top-&gt;vb.queue
)paren
suffix:semicolon
id|bttv_apply_geo
c_func
(paren
id|btv
comma
op_amp
id|set-&gt;top-&gt;geo
comma
l_int|1
)paren
suffix:semicolon
id|bttv_apply_geo
c_func
(paren
id|btv
comma
op_amp
id|set-&gt;top-&gt;geo
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_O_FIELD
comma
op_amp
id|set-&gt;top-&gt;top
comma
id|set-&gt;frame_irq
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_E_FIELD
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|set-&gt;top-&gt;btformat
op_amp
l_int|0xff
comma
op_complement
l_int|0xff
comma
id|BT848_COLOR_FMT
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|set-&gt;top-&gt;btswap
op_amp
l_int|0x0f
comma
op_complement
l_int|0x0f
comma
id|BT848_COLOR_CTL
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
l_int|NULL
op_ne
id|set-&gt;bottom
)paren
(brace
id|set-&gt;bottom-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|set-&gt;bottom-&gt;vb.queue.next
)paren
id|list_del
c_func
(paren
op_amp
id|set-&gt;bottom-&gt;vb.queue
)paren
suffix:semicolon
id|bttv_apply_geo
c_func
(paren
id|btv
comma
op_amp
id|set-&gt;bottom-&gt;geo
comma
l_int|1
)paren
suffix:semicolon
id|bttv_apply_geo
c_func
(paren
id|btv
comma
op_amp
id|set-&gt;bottom-&gt;geo
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_O_FIELD
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_E_FIELD
comma
op_amp
id|set-&gt;bottom-&gt;bottom
comma
id|set-&gt;frame_irq
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|set-&gt;bottom-&gt;btformat
op_amp
l_int|0xff
comma
op_complement
l_int|0xff
comma
id|BT848_COLOR_FMT
)paren
suffix:semicolon
id|btaor
c_func
(paren
id|set-&gt;bottom-&gt;btswap
op_amp
l_int|0x0f
comma
op_complement
l_int|0x0f
comma
id|BT848_COLOR_CTL
)paren
suffix:semicolon
)brace
r_else
(brace
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_O_FIELD
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_hook
c_func
(paren
id|btv
comma
id|RISC_SLOT_E_FIELD
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------- */
multiline_comment|/* calculate geometry, build risc code */
r_int
DECL|function|bttv_buffer_risc
id|bttv_buffer_risc
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|bttv_buffer
op_star
id|buf
)paren
(brace
r_const
r_struct
id|bttv_tvnorm
op_star
id|tvnorm
op_assign
id|bttv_tvnorms
op_plus
id|buf-&gt;tvnorm
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: buffer field: %s  format: %s  size: %dx%d&bslash;n&quot;
comma
id|btv-&gt;c.nr
comma
id|v4l2_field_names
(braket
id|buf-&gt;vb.field
)braket
comma
id|buf-&gt;fmt-&gt;name
comma
id|buf-&gt;vb.width
comma
id|buf-&gt;vb.height
)paren
suffix:semicolon
multiline_comment|/* packed pixel modes */
r_if
c_cond
(paren
id|buf-&gt;fmt-&gt;flags
op_amp
id|FORMAT_FLAGS_PACKED
)paren
(brace
r_int
id|bpl
op_assign
(paren
id|buf-&gt;fmt-&gt;depth
op_rshift
l_int|3
)paren
op_star
id|buf-&gt;vb.width
suffix:semicolon
r_int
id|bpf
op_assign
id|bpl
op_star
(paren
id|buf-&gt;vb.height
op_rshift
l_int|1
)paren
suffix:semicolon
id|bttv_calc_geo
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;geo
comma
id|buf-&gt;vb.width
comma
id|buf-&gt;vb.height
comma
id|V4L2_FIELD_HAS_BOTH
c_func
(paren
id|buf-&gt;vb.field
)paren
comma
id|buf-&gt;tvnorm
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|buf-&gt;vb.field
)paren
(brace
r_case
id|V4L2_FIELD_TOP
suffix:colon
id|bttv_risc_packed
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|bpl
comma
l_int|0
comma
id|buf-&gt;vb.height
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_BOTTOM
suffix:colon
id|bttv_risc_packed
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|bpl
comma
l_int|0
comma
id|buf-&gt;vb.height
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_INTERLACED
suffix:colon
id|bttv_risc_packed
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|bpl
comma
id|bpl
comma
id|buf-&gt;vb.height
op_rshift
l_int|1
)paren
suffix:semicolon
id|bttv_risc_packed
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|buf-&gt;vb.dma.sglist
comma
id|bpl
comma
id|bpl
comma
id|bpl
comma
id|buf-&gt;vb.height
op_rshift
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_SEQ_TB
suffix:colon
id|bttv_risc_packed
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|bpl
comma
l_int|0
comma
id|buf-&gt;vb.height
op_rshift
l_int|1
)paren
suffix:semicolon
id|bttv_risc_packed
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|buf-&gt;vb.dma.sglist
comma
id|bpf
comma
id|bpl
comma
l_int|0
comma
id|buf-&gt;vb.height
op_rshift
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* planar modes */
r_if
c_cond
(paren
id|buf-&gt;fmt-&gt;flags
op_amp
id|FORMAT_FLAGS_PLANAR
)paren
(brace
r_int
id|uoffset
comma
id|voffset
suffix:semicolon
r_int
id|ypadding
comma
id|cpadding
comma
id|lines
suffix:semicolon
multiline_comment|/* calculate chroma offsets */
id|uoffset
op_assign
id|buf-&gt;vb.width
op_star
id|buf-&gt;vb.height
suffix:semicolon
id|voffset
op_assign
id|buf-&gt;vb.width
op_star
id|buf-&gt;vb.height
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;fmt-&gt;flags
op_amp
id|FORMAT_FLAGS_CrCb
)paren
(brace
multiline_comment|/* Y-Cr-Cb plane order */
id|uoffset
op_rshift_assign
id|buf-&gt;fmt-&gt;hshift
suffix:semicolon
id|uoffset
op_rshift_assign
id|buf-&gt;fmt-&gt;vshift
suffix:semicolon
id|uoffset
op_add_assign
id|voffset
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Y-Cb-Cr plane order */
id|voffset
op_rshift_assign
id|buf-&gt;fmt-&gt;hshift
suffix:semicolon
id|voffset
op_rshift_assign
id|buf-&gt;fmt-&gt;vshift
suffix:semicolon
id|voffset
op_add_assign
id|uoffset
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|buf-&gt;vb.field
)paren
(brace
r_case
id|V4L2_FIELD_TOP
suffix:colon
id|bttv_calc_geo
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;geo
comma
id|buf-&gt;vb.width
comma
id|buf-&gt;vb.height
comma
l_int|0
comma
id|buf-&gt;tvnorm
)paren
suffix:semicolon
id|bttv_risc_planar
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|buf-&gt;vb.width
comma
l_int|0
comma
id|buf-&gt;vb.height
comma
id|uoffset
comma
id|voffset
comma
id|buf-&gt;fmt-&gt;hshift
comma
id|buf-&gt;fmt-&gt;vshift
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_BOTTOM
suffix:colon
id|bttv_calc_geo
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;geo
comma
id|buf-&gt;vb.width
comma
id|buf-&gt;vb.height
comma
l_int|0
comma
id|buf-&gt;tvnorm
)paren
suffix:semicolon
id|bttv_risc_planar
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|buf-&gt;vb.width
comma
l_int|0
comma
id|buf-&gt;vb.height
comma
id|uoffset
comma
id|voffset
comma
id|buf-&gt;fmt-&gt;hshift
comma
id|buf-&gt;fmt-&gt;vshift
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_INTERLACED
suffix:colon
id|bttv_calc_geo
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;geo
comma
id|buf-&gt;vb.width
comma
id|buf-&gt;vb.height
comma
l_int|1
comma
id|buf-&gt;tvnorm
)paren
suffix:semicolon
id|lines
op_assign
id|buf-&gt;vb.height
op_rshift
l_int|1
suffix:semicolon
id|ypadding
op_assign
id|buf-&gt;vb.width
suffix:semicolon
id|cpadding
op_assign
id|buf-&gt;vb.width
op_rshift
id|buf-&gt;fmt-&gt;hshift
suffix:semicolon
id|bttv_risc_planar
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|buf-&gt;vb.width
comma
id|ypadding
comma
id|lines
comma
id|uoffset
comma
id|voffset
comma
id|buf-&gt;fmt-&gt;hshift
comma
id|buf-&gt;fmt-&gt;vshift
comma
id|cpadding
)paren
suffix:semicolon
id|bttv_risc_planar
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|buf-&gt;vb.dma.sglist
comma
id|ypadding
comma
id|buf-&gt;vb.width
comma
id|ypadding
comma
id|lines
comma
id|uoffset
op_plus
id|cpadding
comma
id|voffset
op_plus
id|cpadding
comma
id|buf-&gt;fmt-&gt;hshift
comma
id|buf-&gt;fmt-&gt;vshift
comma
id|cpadding
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_SEQ_TB
suffix:colon
id|bttv_calc_geo
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;geo
comma
id|buf-&gt;vb.width
comma
id|buf-&gt;vb.height
comma
l_int|1
comma
id|buf-&gt;tvnorm
)paren
suffix:semicolon
id|lines
op_assign
id|buf-&gt;vb.height
op_rshift
l_int|1
suffix:semicolon
id|ypadding
op_assign
id|buf-&gt;vb.width
suffix:semicolon
id|cpadding
op_assign
id|buf-&gt;vb.width
op_rshift
id|buf-&gt;fmt-&gt;hshift
suffix:semicolon
id|bttv_risc_planar
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|buf-&gt;vb.width
comma
l_int|0
comma
id|lines
comma
id|uoffset
op_rshift
l_int|1
comma
id|voffset
op_rshift
l_int|1
comma
id|buf-&gt;fmt-&gt;hshift
comma
id|buf-&gt;fmt-&gt;vshift
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_planar
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|buf-&gt;vb.dma.sglist
comma
id|lines
op_star
id|ypadding
comma
id|buf-&gt;vb.width
comma
l_int|0
comma
id|lines
comma
id|lines
op_star
id|ypadding
op_plus
(paren
id|uoffset
op_rshift
l_int|1
)paren
comma
id|lines
op_star
id|ypadding
op_plus
(paren
id|voffset
op_rshift
l_int|1
)paren
comma
id|buf-&gt;fmt-&gt;hshift
comma
id|buf-&gt;fmt-&gt;vshift
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* raw data */
r_if
c_cond
(paren
id|buf-&gt;fmt-&gt;flags
op_amp
id|FORMAT_FLAGS_RAW
)paren
(brace
multiline_comment|/* build risc code */
id|buf-&gt;vb.field
op_assign
id|V4L2_FIELD_SEQ_TB
suffix:semicolon
id|bttv_calc_geo
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;geo
comma
id|tvnorm-&gt;swidth
comma
id|tvnorm-&gt;sheight
comma
l_int|1
comma
id|buf-&gt;tvnorm
)paren
suffix:semicolon
id|bttv_risc_packed
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|RAW_BPL
comma
l_int|0
comma
id|RAW_LINES
)paren
suffix:semicolon
id|bttv_risc_packed
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|buf-&gt;vb.dma.sglist
comma
id|buf-&gt;vb.size
op_div
l_int|2
comma
id|RAW_BPL
comma
l_int|0
comma
id|RAW_LINES
)paren
suffix:semicolon
)brace
multiline_comment|/* copy format info */
id|buf-&gt;btformat
op_assign
id|buf-&gt;fmt-&gt;btformat
suffix:semicolon
id|buf-&gt;btswap
op_assign
id|buf-&gt;fmt-&gt;btswap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------- */
multiline_comment|/* calculate geometry, build risc code */
r_int
DECL|function|bttv_overlay_risc
id|bttv_overlay_risc
c_func
(paren
r_struct
id|bttv
op_star
id|btv
comma
r_struct
id|bttv_overlay
op_star
id|ov
comma
r_const
r_struct
id|bttv_format
op_star
id|fmt
comma
r_struct
id|bttv_buffer
op_star
id|buf
)paren
(brace
multiline_comment|/* check interleave, bottom+top fields */
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;bttv%d: overlay fields: %s format: %s  size: %dx%d&bslash;n&quot;
comma
id|btv-&gt;c.nr
comma
id|v4l2_field_names
(braket
id|buf-&gt;vb.field
)braket
comma
id|fmt-&gt;name
comma
id|ov-&gt;w.width
comma
id|ov-&gt;w.height
)paren
suffix:semicolon
multiline_comment|/* calculate geometry */
id|bttv_calc_geo
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;geo
comma
id|ov-&gt;w.width
comma
id|ov-&gt;w.height
comma
id|V4L2_FIELD_HAS_BOTH
c_func
(paren
id|ov-&gt;field
)paren
comma
id|ov-&gt;tvnorm
)paren
suffix:semicolon
multiline_comment|/* build risc code */
r_switch
c_cond
(paren
id|ov-&gt;field
)paren
(brace
r_case
id|V4L2_FIELD_TOP
suffix:colon
id|bttv_risc_overlay
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|fmt
comma
id|ov
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_BOTTOM
suffix:colon
id|bttv_risc_overlay
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|fmt
comma
id|ov
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_FIELD_INTERLACED
suffix:colon
macro_line|#if 0
id|bttv_risc_overlay
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|fmt
comma
id|ov
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|bttv_risc_overlay
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|fmt
comma
id|ov
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
macro_line|#else
id|bttv_risc_overlay
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;top
comma
id|fmt
comma
id|ov
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|bttv_risc_overlay
c_func
(paren
id|btv
comma
op_amp
id|buf-&gt;bottom
comma
id|fmt
comma
id|ov
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* copy format info */
id|buf-&gt;btformat
op_assign
id|fmt-&gt;btformat
suffix:semicolon
id|buf-&gt;btswap
op_assign
id|fmt-&gt;btswap
suffix:semicolon
id|buf-&gt;vb.field
op_assign
id|ov-&gt;field
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
