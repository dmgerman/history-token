multiline_comment|/*&n; * $Id: video-buf-dvb.c,v 1.7 2004/12/09 12:51:35 kraxel Exp $&n; *&n; * some helper function for simple DVB cards which simply DMA the&n; * complete transport stream and let the computer sort everything else&n; * (i.e. we are using the software demux, ...).  Also uses the&n; * video-buf to manage DMA buffers.&n; *&n; * (c) 2004 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SUSE Labs]&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kthread.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &lt;media/video-buf.h&gt;
macro_line|#include &lt;media/video-buf-dvb.h&gt;
multiline_comment|/* ------------------------------------------------------------------ */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|debug
r_static
r_int
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;enable debug messages&quot;
)paren
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(fmt, arg...)&t;if (debug)&t;&t;&t;&bslash;&n;&t;printk(KERN_DEBUG &quot;%s/dvb: &quot; fmt, dvb-&gt;name , ## arg)
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|videobuf_dvb_thread
r_static
r_int
id|videobuf_dvb_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|videobuf_dvb
op_star
id|dvb
op_assign
id|data
suffix:semicolon
r_struct
id|videobuf_buffer
op_star
id|buf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;dvb thread started&bslash;n&quot;
)paren
suffix:semicolon
id|videobuf_read_start
c_func
(paren
op_amp
id|dvb-&gt;dvbq
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* fetch next buffer */
id|buf
op_assign
id|list_entry
c_func
(paren
id|dvb-&gt;dvbq.stream.next
comma
r_struct
id|videobuf_buffer
comma
id|stream
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|buf-&gt;stream
)paren
suffix:semicolon
id|err
op_assign
id|videobuf_waiton
c_func
(paren
id|buf
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
l_int|0
op_ne
id|err
)paren
suffix:semicolon
multiline_comment|/* no more feeds left or stop_feed() asked us to quit */
r_if
c_cond
(paren
l_int|0
op_eq
id|dvb-&gt;nfeeds
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|kthread_should_stop
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;flags
op_amp
id|PF_FREEZE
)paren
id|refrigerator
c_func
(paren
id|PF_FREEZE
)paren
suffix:semicolon
multiline_comment|/* feed buffer data to demux */
r_if
c_cond
(paren
id|buf-&gt;state
op_eq
id|STATE_DONE
)paren
id|dvb_dmx_swfilter
c_func
(paren
op_amp
id|dvb-&gt;demux
comma
id|buf-&gt;dma.vmalloc
comma
id|buf-&gt;size
)paren
suffix:semicolon
multiline_comment|/* requeue buffer */
id|list_add_tail
c_func
(paren
op_amp
id|buf-&gt;stream
comma
op_amp
id|dvb-&gt;dvbq.stream
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|dvb-&gt;dvbq.irqlock
comma
id|flags
)paren
suffix:semicolon
id|dvb-&gt;dvbq.ops
op_member_access_from_pointer
id|buf_queue
c_func
(paren
op_amp
id|dvb-&gt;dvbq
comma
id|buf
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|dvb-&gt;dvbq.irqlock
comma
id|flags
)paren
suffix:semicolon
)brace
id|videobuf_read_stop
c_func
(paren
op_amp
id|dvb-&gt;dvbq
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;dvb thread stopped&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Hmm, linux becomes *very* unhappy without this ... */
r_while
c_loop
(paren
op_logical_neg
id|kthread_should_stop
c_func
(paren
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|videobuf_dvb_start_feed
r_static
r_int
id|videobuf_dvb_start_feed
c_func
(paren
r_struct
id|dvb_demux_feed
op_star
id|feed
)paren
(brace
r_struct
id|dvb_demux
op_star
id|demux
op_assign
id|feed-&gt;demux
suffix:semicolon
r_struct
id|videobuf_dvb
op_star
id|dvb
op_assign
id|demux-&gt;priv
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|demux-&gt;dmx.frontend
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dvb-&gt;lock
)paren
suffix:semicolon
id|dvb-&gt;nfeeds
op_increment
suffix:semicolon
id|rc
op_assign
id|dvb-&gt;nfeeds
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_ne
id|dvb-&gt;thread
)paren
r_goto
id|out
suffix:semicolon
id|dvb-&gt;thread
op_assign
id|kthread_run
c_func
(paren
id|videobuf_dvb_thread
comma
id|dvb
comma
l_string|&quot;%s dvb&quot;
comma
id|dvb-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dvb-&gt;thread
)paren
)paren
(brace
id|rc
op_assign
id|PTR_ERR
c_func
(paren
id|dvb-&gt;thread
)paren
suffix:semicolon
id|dvb-&gt;thread
op_assign
l_int|NULL
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|dvb-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|videobuf_dvb_stop_feed
r_static
r_int
id|videobuf_dvb_stop_feed
c_func
(paren
r_struct
id|dvb_demux_feed
op_star
id|feed
)paren
(brace
r_struct
id|dvb_demux
op_star
id|demux
op_assign
id|feed-&gt;demux
suffix:semicolon
r_struct
id|videobuf_dvb
op_star
id|dvb
op_assign
id|demux-&gt;priv
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dvb-&gt;lock
)paren
suffix:semicolon
id|dvb-&gt;nfeeds
op_decrement
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|dvb-&gt;nfeeds
op_logical_and
l_int|NULL
op_ne
id|dvb-&gt;thread
)paren
(brace
singleline_comment|// FIXME: cx8802_cancel_buffers(dev);
id|err
op_assign
id|kthread_stop
c_func
(paren
id|dvb-&gt;thread
)paren
suffix:semicolon
id|dvb-&gt;thread
op_assign
l_int|NULL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dvb-&gt;lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|videobuf_dvb_register
r_int
id|videobuf_dvb_register
c_func
(paren
r_struct
id|videobuf_dvb
op_star
id|dvb
comma
r_struct
id|module
op_star
id|module
comma
r_void
op_star
id|adapter_priv
)paren
(brace
r_int
id|result
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|dvb-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* register adapter */
id|result
op_assign
id|dvb_register_adapter
c_func
(paren
op_amp
id|dvb-&gt;adapter
comma
id|dvb-&gt;name
comma
id|module
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: dvb_register_adapter failed (errno = %d)&bslash;n&quot;
comma
id|dvb-&gt;name
comma
id|result
)paren
suffix:semicolon
r_goto
id|fail_adapter
suffix:semicolon
)brace
id|dvb-&gt;adapter-&gt;priv
op_assign
id|adapter_priv
suffix:semicolon
multiline_comment|/* register frontend */
id|result
op_assign
id|dvb_register_frontend
c_func
(paren
id|dvb-&gt;adapter
comma
id|dvb-&gt;frontend
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: dvb_register_frontend failed (errno = %d)&bslash;n&quot;
comma
id|dvb-&gt;name
comma
id|result
)paren
suffix:semicolon
r_goto
id|fail_frontend
suffix:semicolon
)brace
multiline_comment|/* register demux stuff */
id|dvb-&gt;demux.dmx.capabilities
op_assign
id|DMX_TS_FILTERING
op_or
id|DMX_SECTION_FILTERING
op_or
id|DMX_MEMORY_BASED_FILTERING
suffix:semicolon
id|dvb-&gt;demux.priv
op_assign
id|dvb
suffix:semicolon
id|dvb-&gt;demux.filternum
op_assign
l_int|256
suffix:semicolon
id|dvb-&gt;demux.feednum
op_assign
l_int|256
suffix:semicolon
id|dvb-&gt;demux.start_feed
op_assign
id|videobuf_dvb_start_feed
suffix:semicolon
id|dvb-&gt;demux.stop_feed
op_assign
id|videobuf_dvb_stop_feed
suffix:semicolon
id|result
op_assign
id|dvb_dmx_init
c_func
(paren
op_amp
id|dvb-&gt;demux
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: dvb_dmx_init failed (errno = %d)&bslash;n&quot;
comma
id|dvb-&gt;name
comma
id|result
)paren
suffix:semicolon
r_goto
id|fail_dmx
suffix:semicolon
)brace
id|dvb-&gt;dmxdev.filternum
op_assign
l_int|256
suffix:semicolon
id|dvb-&gt;dmxdev.demux
op_assign
op_amp
id|dvb-&gt;demux.dmx
suffix:semicolon
id|dvb-&gt;dmxdev.capabilities
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|dvb_dmxdev_init
c_func
(paren
op_amp
id|dvb-&gt;dmxdev
comma
id|dvb-&gt;adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: dvb_dmxdev_init failed (errno = %d)&bslash;n&quot;
comma
id|dvb-&gt;name
comma
id|result
)paren
suffix:semicolon
r_goto
id|fail_dmxdev
suffix:semicolon
)brace
id|dvb-&gt;fe_hw.source
op_assign
id|DMX_FRONTEND_0
suffix:semicolon
id|result
op_assign
id|dvb-&gt;demux.dmx
dot
id|add_frontend
c_func
(paren
op_amp
id|dvb-&gt;demux.dmx
comma
op_amp
id|dvb-&gt;fe_hw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: add_frontend failed (DMX_FRONTEND_0, errno = %d)&bslash;n&quot;
comma
id|dvb-&gt;name
comma
id|result
)paren
suffix:semicolon
r_goto
id|fail_fe_hw
suffix:semicolon
)brace
id|dvb-&gt;fe_mem.source
op_assign
id|DMX_MEMORY_FE
suffix:semicolon
id|result
op_assign
id|dvb-&gt;demux.dmx
dot
id|add_frontend
c_func
(paren
op_amp
id|dvb-&gt;demux.dmx
comma
op_amp
id|dvb-&gt;fe_mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: add_frontend failed (DMX_MEMORY_FE, errno = %d)&bslash;n&quot;
comma
id|dvb-&gt;name
comma
id|result
)paren
suffix:semicolon
r_goto
id|fail_fe_mem
suffix:semicolon
)brace
id|result
op_assign
id|dvb-&gt;demux.dmx
dot
id|connect_frontend
c_func
(paren
op_amp
id|dvb-&gt;demux.dmx
comma
op_amp
id|dvb-&gt;fe_hw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: connect_frontend failed (errno = %d)&bslash;n&quot;
comma
id|dvb-&gt;name
comma
id|result
)paren
suffix:semicolon
r_goto
id|fail_fe_conn
suffix:semicolon
)brace
multiline_comment|/* register network adapter */
id|dvb_net_init
c_func
(paren
id|dvb-&gt;adapter
comma
op_amp
id|dvb-&gt;net
comma
op_amp
id|dvb-&gt;demux.dmx
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail_fe_conn
suffix:colon
id|dvb-&gt;demux.dmx
dot
id|remove_frontend
c_func
(paren
op_amp
id|dvb-&gt;demux.dmx
comma
op_amp
id|dvb-&gt;fe_mem
)paren
suffix:semicolon
id|fail_fe_mem
suffix:colon
id|dvb-&gt;demux.dmx
dot
id|remove_frontend
c_func
(paren
op_amp
id|dvb-&gt;demux.dmx
comma
op_amp
id|dvb-&gt;fe_hw
)paren
suffix:semicolon
id|fail_fe_hw
suffix:colon
id|dvb_dmxdev_release
c_func
(paren
op_amp
id|dvb-&gt;dmxdev
)paren
suffix:semicolon
id|fail_dmxdev
suffix:colon
id|dvb_dmx_release
c_func
(paren
op_amp
id|dvb-&gt;demux
)paren
suffix:semicolon
id|fail_dmx
suffix:colon
id|dvb_unregister_frontend
c_func
(paren
id|dvb-&gt;frontend
)paren
suffix:semicolon
id|fail_frontend
suffix:colon
id|dvb_unregister_adapter
c_func
(paren
id|dvb-&gt;adapter
)paren
suffix:semicolon
id|fail_adapter
suffix:colon
r_return
id|result
suffix:semicolon
)brace
DECL|function|videobuf_dvb_unregister
r_void
id|videobuf_dvb_unregister
c_func
(paren
r_struct
id|videobuf_dvb
op_star
id|dvb
)paren
(brace
id|dvb_net_release
c_func
(paren
op_amp
id|dvb-&gt;net
)paren
suffix:semicolon
id|dvb-&gt;demux.dmx
dot
id|remove_frontend
c_func
(paren
op_amp
id|dvb-&gt;demux.dmx
comma
op_amp
id|dvb-&gt;fe_mem
)paren
suffix:semicolon
id|dvb-&gt;demux.dmx
dot
id|remove_frontend
c_func
(paren
op_amp
id|dvb-&gt;demux.dmx
comma
op_amp
id|dvb-&gt;fe_hw
)paren
suffix:semicolon
id|dvb_dmxdev_release
c_func
(paren
op_amp
id|dvb-&gt;dmxdev
)paren
suffix:semicolon
id|dvb_dmx_release
c_func
(paren
op_amp
id|dvb-&gt;demux
)paren
suffix:semicolon
id|dvb_unregister_frontend
c_func
(paren
id|dvb-&gt;frontend
)paren
suffix:semicolon
id|dvb_unregister_adapter
c_func
(paren
id|dvb-&gt;adapter
)paren
suffix:semicolon
)brace
DECL|variable|videobuf_dvb_register
id|EXPORT_SYMBOL
c_func
(paren
id|videobuf_dvb_register
)paren
suffix:semicolon
DECL|variable|videobuf_dvb_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|videobuf_dvb_unregister
)paren
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------ */
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * compile-command: &quot;make DVB=1&quot;&n; * End:&n; */
eof
