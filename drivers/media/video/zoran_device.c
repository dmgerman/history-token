multiline_comment|/*&n; * Zoran zr36057/zr36067 PCI controller driver, for the&n; * Pinnacle/Miro DC10/DC10+/DC30/DC30+, Iomega Buz, Linux&n; * Media Labs LML33/LML33R10.&n; *&n; * This part handles device access (PCI/I2C/codec/...)&n; * &n; * Copyright (C) 2000 Serguei Miridonov &lt;mirsev@cicese.mx&gt;&n; *&n; * Currently maintained by:&n; *   Ronald Bultje    &lt;rbultje@ronald.bitfreak.net&gt;&n; *   Laurent Pinchart &lt;laurent.pinchart@skynet.be&gt;&n; *   Mailinglist      &lt;mjpeg-users@lists.sf.net&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/sem.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/video_decoder.h&gt;
macro_line|#include &lt;linux/video_encoder.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;videocodec.h&quot;
macro_line|#include &quot;zoran.h&quot;
macro_line|#include &quot;zoran_device.h&quot;
DECL|macro|IRQ_MASK
mdefine_line|#define IRQ_MASK ( ZR36057_ISR_GIRQ0 | &bslash;&n;&t;&t;   ZR36057_ISR_GIRQ1 | &bslash;&n;&t;&t;   ZR36057_ISR_JPEGRepIRQ )
r_extern
r_const
r_struct
id|zoran_format
id|zoran_formats
(braket
)braket
suffix:semicolon
r_extern
r_const
r_int
id|zoran_num_formats
suffix:semicolon
r_extern
r_int
op_star
id|zr_debug
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(num, format, args...) &bslash;&n;&t;do { &bslash;&n;&t;&t;if (*zr_debug &gt;= num) &bslash;&n;&t;&t;&t;printk(format, ##args); &bslash;&n;&t;} while (0)
DECL|variable|lml33dpath
r_static
r_int
id|lml33dpath
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1 will use digital path in capture&n;&t;&t;&t;&t; * mode instead of analog. It can be&n;&t;&t;&t;&t; * used for picture adjustments using&n;&t;&t;&t;&t; * tool like xawtv while watching image&n;&t;&t;&t;&t; * on TV monitor connected to the output.&n;&t;&t;&t;&t; * However, due to absence of 75 Ohm&n;&t;&t;&t;&t; * load on Bt819 input, there will be&n;&t;&t;&t;&t; * some image imperfections */
id|MODULE_PARM
c_func
(paren
id|lml33dpath
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|lml33dpath
comma
l_string|&quot;Use digital path capture mode (on LML33 cards)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * General Purpose I/O and Guest bus access&n; */
multiline_comment|/*&n; * This is a bit tricky. When a board lacks a GPIO function, the corresponding&n; * GPIO bit number in the card_info structure is set to 0.&n; */
r_void
DECL|function|GPIO
id|GPIO
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|bit
comma
r_int
r_int
id|value
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|u32
id|mask
suffix:semicolon
multiline_comment|/* Make sure the bit number is legal&n;&t; * A bit number of -1 (lacking) gives a mask of 0,&n;&t; * making it harmless */
id|mask
op_assign
(paren
l_int|1
op_lshift
(paren
l_int|24
op_plus
id|bit
)paren
)paren
op_amp
l_int|0xff000000
suffix:semicolon
id|reg
op_assign
id|btread
c_func
(paren
id|ZR36057_GPPGCR1
)paren
op_amp
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|reg
op_or_assign
id|mask
suffix:semicolon
)brace
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_GPPGCR1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait til post office is no longer busy&n; */
r_int
DECL|function|post_office_wait
id|post_office_wait
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|u32
id|por
suffix:semicolon
singleline_comment|//      while (((por = btread(ZR36057_POR)) &amp; (ZR36057_POR_POPen | ZR36057_POR_POTime)) == ZR36057_POR_POPen) {
r_while
c_loop
(paren
(paren
id|por
op_assign
id|btread
c_func
(paren
id|ZR36057_POR
)paren
)paren
op_amp
id|ZR36057_POR_POPen
)paren
(brace
multiline_comment|/* wait for something to happen */
)brace
r_if
c_cond
(paren
(paren
id|por
op_amp
id|ZR36057_POR_POTime
)paren
op_logical_and
op_logical_neg
id|zr-&gt;card.gws_not_connected
)paren
(brace
multiline_comment|/* In LML33/BUZ &bslash;GWS line is not connected, so it has always timeout set */
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;%s: pop timeout %08x&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|por
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|post_office_write
id|post_office_write
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
r_int
id|guest
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|value
)paren
(brace
id|u32
id|por
suffix:semicolon
id|por
op_assign
id|ZR36057_POR_PODir
op_or
id|ZR36057_POR_POTime
op_or
(paren
(paren
id|guest
op_amp
l_int|7
)paren
op_lshift
l_int|20
)paren
op_or
(paren
(paren
id|reg
op_amp
l_int|7
)paren
op_lshift
l_int|16
)paren
op_or
(paren
id|value
op_amp
l_int|0xFF
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|por
comma
id|ZR36057_POR
)paren
suffix:semicolon
r_return
id|post_office_wait
c_func
(paren
id|zr
)paren
suffix:semicolon
)brace
r_int
DECL|function|post_office_read
id|post_office_read
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
r_int
id|guest
comma
r_int
r_int
id|reg
)paren
(brace
id|u32
id|por
suffix:semicolon
id|por
op_assign
id|ZR36057_POR_POTime
op_or
(paren
(paren
id|guest
op_amp
l_int|7
)paren
op_lshift
l_int|20
)paren
op_or
(paren
(paren
id|reg
op_amp
l_int|7
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|por
comma
id|ZR36057_POR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|post_office_wait
c_func
(paren
id|zr
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|btread
c_func
(paren
id|ZR36057_POR
)paren
op_amp
l_int|0xFF
suffix:semicolon
)brace
multiline_comment|/*&n; * detect guests&n; */
r_static
r_void
DECL|function|dump_guests
id|dump_guests
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_if
c_cond
(paren
op_star
id|zr_debug
OG
l_int|2
)paren
(brace
r_int
id|i
comma
id|guest
(braket
l_int|8
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|// Don&squot;t read jpeg codec here
id|guest
(braket
id|i
)braket
op_assign
id|post_office_read
c_func
(paren
id|zr
comma
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Guests:&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 0x%02x&quot;
comma
id|guest
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_int
r_int
DECL|function|get_time
id|get_time
(paren
r_void
)paren
(brace
r_struct
id|timeval
id|tv
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
r_return
(paren
l_int|1000000
op_star
id|tv.tv_sec
op_plus
id|tv.tv_usec
)paren
suffix:semicolon
)brace
r_void
DECL|function|detect_guest_activity
id|detect_guest_activity
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|timeout
comma
id|i
comma
id|j
comma
id|res
comma
id|guest
(braket
l_int|8
)braket
comma
id|guest0
(braket
l_int|8
)braket
comma
id|change
(braket
l_int|8
)braket
(braket
l_int|3
)braket
suffix:semicolon
r_int
r_int
id|t0
comma
id|t1
suffix:semicolon
id|dump_guests
c_func
(paren
id|zr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Detecting guests activity, please wait...&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
singleline_comment|// Don&squot;t read jpeg codec here
id|guest0
(braket
id|i
)braket
op_assign
id|guest
(braket
id|i
)braket
op_assign
id|post_office_read
c_func
(paren
id|zr
comma
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
id|timeout
op_assign
l_int|0
suffix:semicolon
id|j
op_assign
l_int|0
suffix:semicolon
id|t0
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
OL
l_int|10000
)paren
(brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|timeout
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
(paren
id|i
OL
l_int|8
)paren
op_logical_and
(paren
id|j
OL
l_int|8
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|res
op_assign
id|post_office_read
c_func
(paren
id|zr
comma
id|i
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ne
id|guest
(braket
id|i
)braket
)paren
(brace
id|t1
op_assign
id|get_time
c_func
(paren
)paren
suffix:semicolon
id|change
(braket
id|j
)braket
(braket
l_int|0
)braket
op_assign
(paren
id|t1
op_minus
id|t0
)paren
suffix:semicolon
id|t0
op_assign
id|t1
suffix:semicolon
id|change
(braket
id|j
)braket
(braket
l_int|1
)braket
op_assign
id|i
suffix:semicolon
id|change
(braket
id|j
)braket
(braket
l_int|2
)braket
op_assign
id|res
suffix:semicolon
id|j
op_increment
suffix:semicolon
id|guest
(braket
id|i
)braket
op_assign
id|res
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|j
op_ge
l_int|8
)paren
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: Guests:&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; 0x%02x&quot;
comma
id|guest0
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: No activity detected.&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|j
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %6d: %d =&gt; 0x%02x&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|change
(braket
id|i
)braket
(braket
l_int|0
)braket
comma
id|change
(braket
id|i
)braket
(braket
l_int|1
)braket
comma
id|change
(braket
id|i
)braket
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * JPEG Codec access&n; */
r_void
DECL|function|jpeg_codec_sleep
id|jpeg_codec_sleep
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|sleep
)paren
(brace
id|GPIO
c_func
(paren
id|zr
comma
id|zr-&gt;card.gpio
(braket
id|GPIO_JPEG_SLEEP
)braket
comma
op_logical_neg
id|sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sleep
)paren
(brace
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: jpeg_codec_sleep() - wake GPIO=0x%08x&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|btread
c_func
(paren
id|ZR36057_GPPGCR1
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: jpeg_codec_sleep() - sleep GPIO=0x%08x&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|btread
c_func
(paren
id|ZR36057_GPPGCR1
)paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
)brace
r_int
DECL|function|jpeg_codec_reset
id|jpeg_codec_reset
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
multiline_comment|/* Take the codec out of sleep */
id|jpeg_codec_sleep
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;card.gpcs
(braket
id|GPCS_JPEG_RESET
)braket
op_ne
l_int|0xff
)paren
(brace
id|post_office_write
c_func
(paren
id|zr
comma
id|zr-&gt;card.gpcs
(braket
id|GPCS_JPEG_RESET
)braket
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|GPIO
c_func
(paren
id|zr
comma
id|zr-&gt;card.gpio
(braket
id|GPIO_JPEG_RESET
)braket
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|GPIO
c_func
(paren
id|zr
comma
id|zr-&gt;card.gpio
(braket
id|GPIO_JPEG_RESET
)braket
comma
l_int|1
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   Set the registers for the size we have specified. Don&squot;t bother&n; *   trying to understand this without the ZR36057 manual in front of&n; *   you [AC].&n; *&n; *   PS: The manual is free for download in .pdf format from&n; *   www.zoran.com - nicely done those folks.&n; */
r_static
r_void
DECL|function|zr36057_adjust_vfe
id|zr36057_adjust_vfe
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
id|u32
id|reg
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|BUZ_MODE_MOTION_DECOMPRESS
suffix:colon
id|btand
c_func
(paren
op_complement
id|ZR36057_VFESPFR_ExtFl
comma
id|ZR36057_VFESPFR
)paren
suffix:semicolon
id|reg
op_assign
id|btread
c_func
(paren
id|ZR36057_VFEHCR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
op_logical_and
id|zr-&gt;card.type
op_ne
id|LML33R10
)paren
(brace
id|reg
op_add_assign
(paren
(paren
l_int|1
op_lshift
l_int|10
)paren
op_or
l_int|1
)paren
suffix:semicolon
)brace
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFEHCR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_MOTION_COMPRESS
suffix:colon
r_case
id|BUZ_MODE_IDLE
suffix:colon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|zr-&gt;norm
op_eq
id|VIDEO_MODE_NTSC
op_logical_or
(paren
id|zr-&gt;card.type
op_eq
id|LML33R10
op_logical_and
id|zr-&gt;norm
op_eq
id|VIDEO_MODE_PAL
)paren
)paren
id|btand
c_func
(paren
op_complement
id|ZR36057_VFESPFR_ExtFl
comma
id|ZR36057_VFESPFR
)paren
suffix:semicolon
r_else
id|btor
c_func
(paren
id|ZR36057_VFESPFR_ExtFl
comma
id|ZR36057_VFESPFR
)paren
suffix:semicolon
id|reg
op_assign
id|btread
c_func
(paren
id|ZR36057_VFEHCR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
op_logical_and
id|zr-&gt;card.type
op_ne
id|LML33R10
)paren
(brace
id|reg
op_sub_assign
(paren
(paren
l_int|1
op_lshift
l_int|10
)paren
op_or
l_int|1
)paren
suffix:semicolon
)brace
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFEHCR
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * set geometry&n; */
r_static
r_void
DECL|function|zr36057_set_vfe
id|zr36057_set_vfe
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|video_width
comma
r_int
id|video_height
comma
r_const
r_struct
id|zoran_format
op_star
id|format
)paren
(brace
r_struct
id|tvnorm
op_star
id|tvn
suffix:semicolon
r_int
id|HStart
comma
id|HEnd
comma
id|VStart
comma
id|VEnd
suffix:semicolon
r_int
id|DispMode
suffix:semicolon
r_int
id|VidWinWid
comma
id|VidWinHt
suffix:semicolon
r_int
id|hcrop1
comma
id|hcrop2
comma
id|vcrop1
comma
id|vcrop2
suffix:semicolon
r_int
id|Wa
comma
id|We
comma
id|Ha
comma
id|He
suffix:semicolon
r_int
id|X
comma
id|Y
comma
id|HorDcm
comma
id|VerDcm
suffix:semicolon
id|u32
id|reg
suffix:semicolon
r_int
id|mask_line_size
suffix:semicolon
id|tvn
op_assign
id|zr-&gt;timing
suffix:semicolon
id|Wa
op_assign
id|tvn-&gt;Wa
suffix:semicolon
id|Ha
op_assign
id|tvn-&gt;Ha
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_INFO
l_string|&quot;%s: set_vfe() - width = %d, height = %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|video_width
comma
id|video_height
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;norm
op_ne
id|VIDEO_MODE_PAL
op_logical_and
id|zr-&gt;norm
op_ne
id|VIDEO_MODE_NTSC
op_logical_and
id|zr-&gt;norm
op_ne
id|VIDEO_MODE_SECAM
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: set_vfe() - norm = %d not valid&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|zr-&gt;norm
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video_width
template_param
id|Ha
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: set_vfe: w=%d h=%d not valid&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|video_width
comma
id|video_height
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/**** zr36057 ****/
multiline_comment|/* horizontal */
id|VidWinWid
op_assign
id|video_width
suffix:semicolon
id|X
op_assign
(paren
id|VidWinWid
op_star
l_int|64
op_plus
id|tvn-&gt;Wa
op_minus
l_int|1
)paren
op_div
id|tvn-&gt;Wa
suffix:semicolon
id|We
op_assign
(paren
id|VidWinWid
op_star
l_int|64
)paren
op_div
id|X
suffix:semicolon
id|HorDcm
op_assign
l_int|64
op_minus
id|X
suffix:semicolon
id|hcrop1
op_assign
l_int|2
op_star
(paren
(paren
id|tvn-&gt;Wa
op_minus
id|We
)paren
op_div
l_int|4
)paren
suffix:semicolon
id|hcrop2
op_assign
id|tvn-&gt;Wa
op_minus
id|We
op_minus
id|hcrop1
suffix:semicolon
id|HStart
op_assign
id|tvn-&gt;HStart
ques
c_cond
id|tvn-&gt;HStart
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* (Ronald) Original comment:&n;&t; * &quot;| 1 Doesn&squot;t have any effect, tested on both a DC10 and a DC10+&quot;&n;&t; * this is false. It inverses chroma values on the LML33R10 (so Cr&n;&t; * suddenly is shown as Cb and reverse, really cool effect if you&n;&t; * want to see blue faces, not useful otherwise). So don&squot;t use |1.&n;&t; * However, the DC10 has &squot;0&squot; as HStart, but does need |1, so we&n;&t; * use a dirty check...&n;&t; */
id|HEnd
op_assign
id|HStart
op_plus
id|tvn-&gt;Wa
op_minus
l_int|1
suffix:semicolon
id|HStart
op_add_assign
id|hcrop1
suffix:semicolon
id|HEnd
op_sub_assign
id|hcrop2
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|HStart
op_amp
id|ZR36057_VFEHCR_Hmask
)paren
op_lshift
id|ZR36057_VFEHCR_HStart
)paren
op_or
(paren
(paren
id|HEnd
op_amp
id|ZR36057_VFEHCR_Hmask
)paren
op_lshift
id|ZR36057_VFEHCR_HEnd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;card.vfe_pol.hsync_pol
)paren
id|reg
op_or_assign
id|ZR36057_VFEHCR_HSPol
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFEHCR
)paren
suffix:semicolon
multiline_comment|/* Vertical */
id|DispMode
op_assign
op_logical_neg
(paren
id|video_height
OG
id|BUZ_MAX_HEIGHT
op_div
l_int|2
)paren
suffix:semicolon
id|VidWinHt
op_assign
id|DispMode
ques
c_cond
id|video_height
suffix:colon
id|video_height
op_div
l_int|2
suffix:semicolon
id|Y
op_assign
(paren
id|VidWinHt
op_star
l_int|64
op_star
l_int|2
op_plus
id|tvn-&gt;Ha
op_minus
l_int|1
)paren
op_div
id|tvn-&gt;Ha
suffix:semicolon
id|He
op_assign
(paren
id|VidWinHt
op_star
l_int|64
)paren
op_div
id|Y
suffix:semicolon
id|VerDcm
op_assign
l_int|64
op_minus
id|Y
suffix:semicolon
id|vcrop1
op_assign
(paren
id|tvn-&gt;Ha
op_div
l_int|2
op_minus
id|He
)paren
op_div
l_int|2
suffix:semicolon
id|vcrop2
op_assign
id|tvn-&gt;Ha
op_div
l_int|2
op_minus
id|He
op_minus
id|vcrop1
suffix:semicolon
id|VStart
op_assign
id|tvn-&gt;VStart
suffix:semicolon
id|VEnd
op_assign
id|VStart
op_plus
id|tvn-&gt;Ha
op_div
l_int|2
suffix:semicolon
singleline_comment|// - 1; FIXME SnapShot times out with -1 in 768*576 on the DC10 - LP
id|VStart
op_add_assign
id|vcrop1
suffix:semicolon
id|VEnd
op_sub_assign
id|vcrop2
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|VStart
op_amp
id|ZR36057_VFEVCR_Vmask
)paren
op_lshift
id|ZR36057_VFEVCR_VStart
)paren
op_or
(paren
(paren
id|VEnd
op_amp
id|ZR36057_VFEVCR_Vmask
)paren
op_lshift
id|ZR36057_VFEVCR_VEnd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;card.vfe_pol.vsync_pol
)paren
id|reg
op_or_assign
id|ZR36057_VFEVCR_VSPol
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFEVCR
)paren
suffix:semicolon
multiline_comment|/* scaler and pixel format */
id|reg
op_assign
l_int|0
suffix:semicolon
id|reg
op_or_assign
(paren
id|HorDcm
op_lshift
id|ZR36057_VFESPFR_HorDcm
)paren
suffix:semicolon
id|reg
op_or_assign
(paren
id|VerDcm
op_lshift
id|ZR36057_VFESPFR_VerDcm
)paren
suffix:semicolon
id|reg
op_or_assign
(paren
id|DispMode
op_lshift
id|ZR36057_VFESPFR_DispMode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|format-&gt;palette
op_ne
id|VIDEO_PALETTE_YUV422
)paren
id|reg
op_or_assign
id|ZR36057_VFESPFR_LittleEndian
suffix:semicolon
multiline_comment|/* RJ: I don&squot;t know, why the following has to be the opposite&n;&t; * of the corresponding ZR36060 setting, but only this way&n;&t; * we get the correct colors when uncompressing to the screen  */
singleline_comment|//reg |= ZR36057_VFESPFR_VCLKPol; /**/
multiline_comment|/* RJ: Don&squot;t know if that is needed for NTSC also */
r_if
c_cond
(paren
id|zr-&gt;norm
op_ne
id|VIDEO_MODE_NTSC
)paren
id|reg
op_or_assign
id|ZR36057_VFESPFR_ExtFl
suffix:semicolon
singleline_comment|// NEEDED!!!!!!! Wolfgang
id|reg
op_or_assign
id|ZR36057_VFESPFR_TopField
suffix:semicolon
r_switch
c_cond
(paren
id|format-&gt;palette
)paren
(brace
r_case
id|VIDEO_PALETTE_YUV422
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_YUV422
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB555
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_RGB555
op_or
id|ZR36057_VFESPFR_ErrDif
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB565
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_RGB565
op_or
id|ZR36057_VFESPFR_ErrDif
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB24
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_RGB888
op_or
id|ZR36057_VFESPFR_Pack24
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_PALETTE_RGB32
suffix:colon
id|reg
op_or_assign
id|ZR36057_VFESPFR_RGB888
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;%s: set_vfe() - unknown color_fmt=%x&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|format-&gt;palette
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HorDcm
op_ge
l_int|48
)paren
(brace
id|reg
op_or_assign
l_int|3
op_lshift
id|ZR36057_VFESPFR_HFilter
suffix:semicolon
multiline_comment|/* 5 tap filter */
)brace
r_else
r_if
c_cond
(paren
id|HorDcm
op_ge
l_int|32
)paren
(brace
id|reg
op_or_assign
l_int|2
op_lshift
id|ZR36057_VFESPFR_HFilter
suffix:semicolon
multiline_comment|/* 4 tap filter */
)brace
r_else
r_if
c_cond
(paren
id|HorDcm
op_ge
l_int|16
)paren
(brace
id|reg
op_or_assign
l_int|1
op_lshift
id|ZR36057_VFESPFR_HFilter
suffix:semicolon
multiline_comment|/* 3 tap filter */
)brace
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFESPFR
)paren
suffix:semicolon
multiline_comment|/* display configuration */
id|reg
op_assign
(paren
l_int|16
op_lshift
id|ZR36057_VDCR_MinPix
)paren
op_or
(paren
id|VidWinHt
op_lshift
id|ZR36057_VDCR_VidWinHt
)paren
op_or
(paren
id|VidWinWid
op_lshift
id|ZR36057_VDCR_VidWinWid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_TRITON
)paren
singleline_comment|// || zr-&gt;revision &lt; 1) // Revision 1 has also Triton support
id|reg
op_and_assign
op_complement
id|ZR36057_VDCR_Triton
suffix:semicolon
r_else
id|reg
op_or_assign
id|ZR36057_VDCR_Triton
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
multiline_comment|/* (Ronald) don&squot;t write this if overlay_mask = NULL */
r_if
c_cond
(paren
id|zr-&gt;overlay_mask
)paren
(brace
multiline_comment|/* Write overlay clipping mask data, but don&squot;t enable overlay clipping */
multiline_comment|/* RJ: since this makes only sense on the screen, we use &n;&t;&t; * zr-&gt;overlay_settings.width instead of video_width */
id|mask_line_size
op_assign
(paren
id|BUZ_MAX_WIDTH
op_plus
l_int|31
)paren
op_div
l_int|32
suffix:semicolon
id|reg
op_assign
id|virt_to_bus
c_func
(paren
id|zr-&gt;overlay_mask
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_MMTR
)paren
suffix:semicolon
id|reg
op_assign
id|virt_to_bus
c_func
(paren
id|zr-&gt;overlay_mask
op_plus
id|mask_line_size
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_MMBR
)paren
suffix:semicolon
id|reg
op_assign
id|mask_line_size
op_minus
(paren
id|zr-&gt;overlay_settings.width
op_plus
l_int|31
)paren
op_div
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|DispMode
op_eq
l_int|0
)paren
id|reg
op_add_assign
id|mask_line_size
suffix:semicolon
id|reg
op_lshift_assign
id|ZR36057_OCR_MaskStride
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_OCR
)paren
suffix:semicolon
)brace
id|zr36057_adjust_vfe
c_func
(paren
id|zr
comma
id|zr-&gt;codec_mode
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Switch overlay on or off&n; */
r_void
DECL|function|zr36057_overlay
id|zr36057_overlay
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|on
)paren
(brace
id|u32
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
(brace
multiline_comment|/* do the necessary settings ... */
id|btand
c_func
(paren
op_complement
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
multiline_comment|/* switch it off first */
id|zr36057_set_vfe
c_func
(paren
id|zr
comma
id|zr-&gt;overlay_settings.width
comma
id|zr-&gt;overlay_settings.height
comma
id|zr-&gt;overlay_settings.format
)paren
suffix:semicolon
multiline_comment|/* Start and length of each line MUST be 4-byte aligned.&n;&t;&t; * This should be allready checked before the call to this routine.&n;&t;&t; * All error messages are internal driver checking only! */
multiline_comment|/* video display top and bottom registers */
id|reg
op_assign
(paren
id|u32
)paren
id|zr-&gt;buffer.base
op_plus
id|zr-&gt;overlay_settings.x
op_star
(paren
(paren
id|zr-&gt;overlay_settings.format-&gt;depth
op_plus
l_int|7
)paren
op_div
l_int|8
)paren
op_plus
id|zr-&gt;overlay_settings.y
op_star
id|zr-&gt;buffer.bytesperline
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
l_int|3
)paren
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zr36057_overlay() - video_address not aligned&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;overlay_settings.height
OG
id|BUZ_MAX_HEIGHT
op_div
l_int|2
)paren
id|reg
op_add_assign
id|zr-&gt;buffer.bytesperline
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDBR
)paren
suffix:semicolon
multiline_comment|/* video stride, status, and frame grab register */
id|reg
op_assign
id|zr-&gt;buffer.bytesperline
op_minus
id|zr-&gt;overlay_settings.width
op_star
(paren
(paren
id|zr-&gt;overlay_settings.format-&gt;depth
op_plus
l_int|7
)paren
op_div
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;overlay_settings.height
OG
id|BUZ_MAX_HEIGHT
op_div
l_int|2
)paren
id|reg
op_add_assign
id|zr-&gt;buffer.bytesperline
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
l_int|3
)paren
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zr36057_overlay() - video_stride not aligned&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_lshift
id|ZR36057_VSSFGR_DispStride
)paren
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VSSFGR_VidOvf
suffix:semicolon
multiline_comment|/* clear overflow status */
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VSSFGR
)paren
suffix:semicolon
multiline_comment|/* Set overlay clipping */
r_if
c_cond
(paren
id|zr-&gt;overlay_settings.clipcount
OG
l_int|0
)paren
id|btor
c_func
(paren
id|ZR36057_OCR_OvlEnable
comma
id|ZR36057_OCR
)paren
suffix:semicolon
multiline_comment|/* ... and switch it on */
id|btor
c_func
(paren
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Switch it off */
id|btand
c_func
(paren
op_complement
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * The overlay mask has one bit for each pixel on a scan line,&n; *  and the maximum window size is BUZ_MAX_WIDTH * BUZ_MAX_HEIGHT pixels.&n; */
r_void
DECL|function|write_overlay_mask
id|write_overlay_mask
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|video_clip
op_star
id|vp
comma
r_int
id|count
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|mask_line_size
op_assign
(paren
id|BUZ_MAX_WIDTH
op_plus
l_int|31
)paren
op_div
l_int|32
suffix:semicolon
id|u32
op_star
id|mask
suffix:semicolon
r_int
id|x
comma
id|y
comma
id|width
comma
id|height
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
id|u32
id|reg
suffix:semicolon
multiline_comment|/* fill mask with one bits */
id|memset
c_func
(paren
id|fh-&gt;overlay_mask
comma
op_complement
l_int|0
comma
id|mask_line_size
op_star
l_int|4
op_star
id|BUZ_MAX_HEIGHT
)paren
suffix:semicolon
id|reg
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/* pick up local copy of clip */
id|x
op_assign
id|vp
(braket
id|i
)braket
dot
id|x
suffix:semicolon
id|y
op_assign
id|vp
(braket
id|i
)braket
dot
id|y
suffix:semicolon
id|width
op_assign
id|vp
(braket
id|i
)braket
dot
id|width
suffix:semicolon
id|height
op_assign
id|vp
(braket
id|i
)braket
dot
id|height
suffix:semicolon
multiline_comment|/* trim clips that extend beyond the window */
r_if
c_cond
(paren
id|x
OL
l_int|0
)paren
(brace
id|width
op_add_assign
id|x
suffix:semicolon
id|x
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y
OL
l_int|0
)paren
(brace
id|height
op_add_assign
id|y
suffix:semicolon
id|y
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_plus
id|width
OG
id|fh-&gt;overlay_settings.width
)paren
(brace
id|width
op_assign
id|fh-&gt;overlay_settings.width
op_minus
id|x
suffix:semicolon
)brace
r_if
c_cond
(paren
id|y
op_plus
id|height
OG
id|fh-&gt;overlay_settings.height
)paren
(brace
id|height
op_assign
id|fh-&gt;overlay_settings.height
op_minus
id|y
suffix:semicolon
)brace
multiline_comment|/* ignore degenerate clips */
r_if
c_cond
(paren
id|height
op_le
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|width
op_le
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* apply clip for each scan line */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|height
suffix:semicolon
op_increment
id|j
)paren
(brace
multiline_comment|/* reset bit for each pixel */
multiline_comment|/* this can be optimized later if need be */
id|mask
op_assign
id|fh-&gt;overlay_mask
op_plus
(paren
id|y
op_plus
id|j
)paren
op_star
id|mask_line_size
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|width
suffix:semicolon
op_increment
id|k
)paren
(brace
id|mask
(braket
(paren
id|x
op_plus
id|k
)paren
op_div
l_int|32
)braket
op_and_assign
op_complement
(paren
(paren
id|u32
)paren
l_int|1
op_lshift
(paren
id|x
op_plus
id|k
)paren
op_mod
l_int|32
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Enable/Disable uncompressed memory grabbing of the 36057 */
r_void
DECL|function|zr36057_set_memgrab
id|zr36057_set_memgrab
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|mode
)paren
(brace
r_if
c_cond
(paren
id|mode
)paren
(brace
r_if
c_cond
(paren
id|btread
c_func
(paren
id|ZR36057_VSSFGR
)paren
op_amp
(paren
id|ZR36057_VSSFGR_SnapShot
op_or
id|ZR36057_VSSFGR_FrameGrab
)paren
)paren
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_WARNING
l_string|&quot;%s: zr36057_set_memgrab(1) with SnapShot or FrameGrab on!?&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
multiline_comment|/* switch on VSync interrupts */
id|btwrite
c_func
(paren
id|IRQ_MASK
comma
id|ZR36057_ISR
)paren
suffix:semicolon
singleline_comment|// Clear Interrupts
id|btor
c_func
(paren
id|zr-&gt;card.vsync_int
comma
id|ZR36057_ICR
)paren
suffix:semicolon
singleline_comment|// SW
multiline_comment|/* enable SnapShot */
id|btor
c_func
(paren
id|ZR36057_VSSFGR_SnapShot
comma
id|ZR36057_VSSFGR
)paren
suffix:semicolon
multiline_comment|/* Set zr36057 video front end  and enable video */
id|zr36057_set_vfe
c_func
(paren
id|zr
comma
id|zr-&gt;v4l_settings.width
comma
id|zr-&gt;v4l_settings.height
comma
id|zr-&gt;v4l_settings.format
)paren
suffix:semicolon
id|zr-&gt;v4l_memgrab_active
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|zr-&gt;v4l_memgrab_active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* switch off VSync interrupts */
id|btand
c_func
(paren
op_complement
id|zr-&gt;card.vsync_int
comma
id|ZR36057_ICR
)paren
suffix:semicolon
singleline_comment|// SW
multiline_comment|/* reenable grabbing to screen if it was running */
r_if
c_cond
(paren
id|zr-&gt;v4l_overlay_active
)paren
(brace
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|btand
c_func
(paren
op_complement
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_VSSFGR_SnapShot
comma
id|ZR36057_VSSFGR
)paren
suffix:semicolon
)brace
)brace
)brace
r_int
DECL|function|wait_grab_pending
id|wait_grab_pending
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* wait until all pending grabs are finished */
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
r_return
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|zr-&gt;v4l_pend_tail
op_ne
id|zr-&gt;v4l_pend_head
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *                                                                           *&n; *  Set up the Buz-specific MJPEG part                                       *&n; *                                                                           *&n; *****************************************************************************/
r_static
r_inline
r_void
DECL|function|set_frame
id|set_frame
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|val
)paren
(brace
id|GPIO
c_func
(paren
id|zr
comma
id|zr-&gt;card.gpio
(braket
id|GPIO_JPEG_FRAME
)braket
comma
id|val
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|set_videobus_dir
id|set_videobus_dir
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|val
)paren
(brace
r_switch
c_cond
(paren
id|zr-&gt;card.type
)paren
(brace
r_case
id|LML33
suffix:colon
r_case
id|LML33R10
suffix:colon
r_if
c_cond
(paren
id|lml33dpath
op_eq
l_int|0
)paren
id|GPIO
c_func
(paren
id|zr
comma
l_int|5
comma
id|val
)paren
suffix:semicolon
r_else
id|GPIO
c_func
(paren
id|zr
comma
l_int|5
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|GPIO
c_func
(paren
id|zr
comma
id|zr-&gt;card.gpio
(braket
id|GPIO_VID_DIR
)braket
comma
id|zr-&gt;card.gpio_pol
(braket
id|GPIO_VID_DIR
)braket
ques
c_cond
op_logical_neg
id|val
suffix:colon
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|init_jpeg_queue
id|init_jpeg_queue
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* re-initialize DMA ring stuff */
id|zr-&gt;jpg_que_head
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_dma_head
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_dma_tail
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_que_tail
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_seq_num
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_error
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;num_errors
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_err_seq
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_err_shift
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_queued_num
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zr-&gt;jpg_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zr-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
multiline_comment|/* nothing going on */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BUZ_NUM_STAT_COM
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zr-&gt;stat_com
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* mark as unavailable to zr36057 */
)brace
)brace
r_static
r_void
DECL|function|zr36057_set_jpg
id|zr36057_set_jpg
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_struct
id|tvnorm
op_star
id|tvn
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|tvn
op_assign
id|zr-&gt;timing
suffix:semicolon
multiline_comment|/* assert P_Reset, disable code transfer, deassert Active */
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_JPC
)paren
suffix:semicolon
multiline_comment|/* MJPEG compression mode */
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|BUZ_MODE_MOTION_COMPRESS
suffix:colon
r_default
suffix:colon
id|reg
op_assign
id|ZR36057_JMC_MJPGCmpMode
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_MOTION_DECOMPRESS
suffix:colon
id|reg
op_assign
id|ZR36057_JMC_MJPGExpMode
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_JMC_SyncMstr
suffix:semicolon
multiline_comment|/* RJ: The following is experimental - improves the output to screen */
singleline_comment|//if(zr-&gt;jpg_settings.VFIFO_FB) reg |= ZR36057_JMC_VFIFO_FB; // No, it doesn&squot;t. SM
r_break
suffix:semicolon
r_case
id|BUZ_MODE_STILL_COMPRESS
suffix:colon
id|reg
op_assign
id|ZR36057_JMC_JPGCmpMode
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_STILL_DECOMPRESS
suffix:colon
id|reg
op_assign
id|ZR36057_JMC_JPGExpMode
suffix:semicolon
r_break
suffix:semicolon
)brace
id|reg
op_or_assign
id|ZR36057_JMC_JPG
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;jpg_settings.field_per_buff
op_eq
l_int|1
)paren
id|reg
op_or_assign
id|ZR36057_JMC_Fld_per_buff
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_JMC
)paren
suffix:semicolon
multiline_comment|/* vertical */
id|btor
c_func
(paren
id|ZR36057_VFEVCR_VSPol
comma
id|ZR36057_VFEVCR
)paren
suffix:semicolon
id|reg
op_assign
(paren
l_int|6
op_lshift
id|ZR36057_VSP_VsyncSize
)paren
op_or
(paren
id|tvn-&gt;Ht
op_lshift
id|ZR36057_VSP_FrmTot
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VSP
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|zr-&gt;jpg_settings.img_y
op_plus
id|tvn-&gt;VStart
)paren
op_lshift
id|ZR36057_FVAP_NAY
)paren
op_or
(paren
id|zr-&gt;jpg_settings.img_height
op_lshift
id|ZR36057_FVAP_PAY
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_FVAP
)paren
suffix:semicolon
multiline_comment|/* horizontal */
r_if
c_cond
(paren
id|zr-&gt;card.vfe_pol.hsync_pol
)paren
id|btor
c_func
(paren
id|ZR36057_VFEHCR_HSPol
comma
id|ZR36057_VFEHCR
)paren
suffix:semicolon
r_else
id|btand
c_func
(paren
op_complement
id|ZR36057_VFEHCR_HSPol
comma
id|ZR36057_VFEHCR
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|tvn-&gt;HSyncStart
)paren
op_lshift
id|ZR36057_HSP_HsyncStart
)paren
op_or
(paren
id|tvn-&gt;Wt
op_lshift
id|ZR36057_HSP_LineTot
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_HSP
)paren
suffix:semicolon
id|reg
op_assign
(paren
(paren
id|zr-&gt;jpg_settings.img_x
op_plus
id|tvn-&gt;HStart
op_plus
l_int|4
)paren
op_lshift
id|ZR36057_FHAP_NAX
)paren
op_or
(paren
id|zr-&gt;jpg_settings.img_width
op_lshift
id|ZR36057_FHAP_PAX
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_FHAP
)paren
suffix:semicolon
multiline_comment|/* field process parameters */
r_if
c_cond
(paren
id|zr-&gt;jpg_settings.odd_even
)paren
id|reg
op_assign
id|ZR36057_FPP_Odd_Even
suffix:semicolon
r_else
id|reg
op_assign
l_int|0
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_FPP
)paren
suffix:semicolon
multiline_comment|/* Set proper VCLK Polarity, else colors will be wrong during playback */
singleline_comment|//btor(ZR36057_VFESPFR_VCLKPol, ZR36057_VFESPFR);
multiline_comment|/* code base address */
id|reg
op_assign
id|virt_to_bus
c_func
(paren
id|zr-&gt;stat_com
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_JCBA
)paren
suffix:semicolon
multiline_comment|/* FIFO threshold (FIFO is 160. double words) */
multiline_comment|/* NOTE: decimal values here */
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|BUZ_MODE_STILL_COMPRESS
suffix:colon
r_case
id|BUZ_MODE_MOTION_COMPRESS
suffix:colon
r_if
c_cond
(paren
id|zr-&gt;card.type
op_ne
id|BUZ
)paren
id|reg
op_assign
l_int|140
suffix:semicolon
r_else
id|reg
op_assign
l_int|60
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_STILL_DECOMPRESS
suffix:colon
r_case
id|BUZ_MODE_MOTION_DECOMPRESS
suffix:colon
id|reg
op_assign
l_int|20
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|reg
op_assign
l_int|80
suffix:semicolon
r_break
suffix:semicolon
)brace
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_JCFT
)paren
suffix:semicolon
id|zr36057_adjust_vfe
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
)brace
r_void
DECL|function|print_interrupts
id|print_interrupts
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|res
comma
id|noerr
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: interrupts received:&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zr-&gt;field_counter
)paren
template_param
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; FD:%d&quot;
comma
id|res
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zr-&gt;intr_counter_GIRQ1
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; GIRQ1:%d&quot;
comma
id|res
)paren
suffix:semicolon
id|noerr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zr-&gt;intr_counter_GIRQ0
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; GIRQ0:%d&quot;
comma
id|res
)paren
suffix:semicolon
id|noerr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zr-&gt;intr_counter_CodRepIRQ
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; CodRepIRQ:%d&quot;
comma
id|res
)paren
suffix:semicolon
id|noerr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zr-&gt;intr_counter_JPEGRepIRQ
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; JPEGRepIRQ:%d&quot;
comma
id|res
)paren
suffix:semicolon
id|noerr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;JPEG_max_missed
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; JPEG delays: max=%d min=%d&quot;
comma
id|zr-&gt;JPEG_max_missed
comma
id|zr-&gt;JPEG_min_missed
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;END_event_missed
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; ENDs missed: %d&quot;
comma
id|zr-&gt;END_event_missed
)paren
suffix:semicolon
)brace
singleline_comment|//if (zr-&gt;jpg_queued_num) {
id|printk
c_func
(paren
l_string|&quot; queue_state=%ld/%ld/%ld/%ld&quot;
comma
id|zr-&gt;jpg_que_tail
comma
id|zr-&gt;jpg_dma_tail
comma
id|zr-&gt;jpg_dma_head
comma
id|zr-&gt;jpg_que_head
)paren
suffix:semicolon
singleline_comment|//}
r_if
c_cond
(paren
op_logical_neg
id|noerr
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;: no interrupts detected.&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_void
DECL|function|clear_interrupt_counters
id|clear_interrupt_counters
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|zr-&gt;intr_counter_GIRQ1
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;intr_counter_GIRQ0
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;intr_counter_CodRepIRQ
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;intr_counter_JPEGRepIRQ
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;field_counter
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;IRQ1_in
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;IRQ1_out
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_in
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_out
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_0
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_1
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;END_event_missed
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_missed
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_max_missed
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_min_missed
op_assign
l_int|0x7fffffff
suffix:semicolon
)brace
r_static
id|u32
DECL|function|count_reset_interrupt
id|count_reset_interrupt
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|u32
id|isr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|isr
op_assign
id|btread
c_func
(paren
id|ZR36057_ISR
)paren
op_amp
l_int|0x78000000
)paren
)paren
(brace
r_if
c_cond
(paren
id|isr
op_amp
id|ZR36057_ISR_GIRQ1
)paren
(brace
id|btwrite
c_func
(paren
id|ZR36057_ISR_GIRQ1
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|zr-&gt;intr_counter_GIRQ1
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|ZR36057_ISR_GIRQ0
)paren
(brace
id|btwrite
c_func
(paren
id|ZR36057_ISR_GIRQ0
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|zr-&gt;intr_counter_GIRQ0
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|ZR36057_ISR_CodRepIRQ
)paren
(brace
id|btwrite
c_func
(paren
id|ZR36057_ISR_CodRepIRQ
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|zr-&gt;intr_counter_CodRepIRQ
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|ZR36057_ISR_JPEGRepIRQ
)paren
(brace
id|btwrite
c_func
(paren
id|ZR36057_ISR_JPEGRepIRQ
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|zr-&gt;intr_counter_JPEGRepIRQ
op_increment
suffix:semicolon
)brace
)brace
r_return
id|isr
suffix:semicolon
)brace
multiline_comment|/* hack */
r_extern
r_void
id|zr36016_write
(paren
r_struct
id|videocodec
op_star
id|codec
comma
id|u16
id|reg
comma
id|u32
id|val
)paren
suffix:semicolon
r_void
DECL|function|jpeg_start
id|jpeg_start
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|reg
suffix:semicolon
id|zr-&gt;frame_num
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* deassert P_reset, disable code transfer, deassert Active */
id|btwrite
c_func
(paren
id|ZR36057_JPC_P_Reset
comma
id|ZR36057_JPC
)paren
suffix:semicolon
multiline_comment|/* stop flushing the internal code buffer */
id|btand
c_func
(paren
op_complement
id|ZR36057_MCTCR_CFlush
comma
id|ZR36057_MCTCR
)paren
suffix:semicolon
multiline_comment|/* enable code transfer */
id|btor
c_func
(paren
id|ZR36057_JPC_CodTrnsEn
comma
id|ZR36057_JPC
)paren
suffix:semicolon
multiline_comment|/* clear IRQs */
id|btwrite
c_func
(paren
id|IRQ_MASK
comma
id|ZR36057_ISR
)paren
suffix:semicolon
multiline_comment|/* enable the JPEG IRQs */
id|btwrite
c_func
(paren
id|zr-&gt;card.jpeg_int
op_or
id|ZR36057_ICR_JPEGRepIRQ
op_or
id|ZR36057_ICR_IntPinEn
comma
id|ZR36057_ICR
)paren
suffix:semicolon
id|set_frame
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
singleline_comment|// &bslash;FRAME
multiline_comment|/* set the JPEG codec guest ID */
id|reg
op_assign
(paren
id|zr-&gt;card.gpcs
(braket
l_int|1
)braket
op_lshift
id|ZR36057_JCGI_JPEGuestID
)paren
op_or
(paren
l_int|0
op_lshift
id|ZR36057_JCGI_JPEGuestReg
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_JCGI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;card.video_vfe
op_eq
id|CODEC_TYPE_ZR36016
op_logical_and
id|zr-&gt;card.video_codec
op_eq
id|CODEC_TYPE_ZR36050
)paren
(brace
multiline_comment|/* Enable processing on the ZR36016 */
r_if
c_cond
(paren
id|zr-&gt;vfe
)paren
id|zr36016_write
c_func
(paren
id|zr-&gt;vfe
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* load the address of the GO register in the ZR36050 latch */
id|post_office_write
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* assert Active */
id|btor
c_func
(paren
id|ZR36057_JPC_Active
comma
id|ZR36057_JPC
)paren
suffix:semicolon
multiline_comment|/* enable the Go generation */
id|btor
c_func
(paren
id|ZR36057_JMC_Go_en
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|30
)paren
suffix:semicolon
id|set_frame
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// /FRAME
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: jpeg_start&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|zr36057_enable_jpg
id|zr36057_enable_jpg
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_static
r_int
id|zero
op_assign
l_int|0
suffix:semicolon
r_static
r_int
id|one
op_assign
l_int|1
suffix:semicolon
r_struct
id|vfe_settings
id|cap
suffix:semicolon
r_int
id|field_size
op_assign
id|zr-&gt;jpg_buffers.buffer_size
op_div
id|zr-&gt;jpg_settings.field_per_buff
suffix:semicolon
id|zr-&gt;codec_mode
op_assign
id|mode
suffix:semicolon
id|cap.x
op_assign
id|zr-&gt;jpg_settings.img_x
suffix:semicolon
id|cap.y
op_assign
id|zr-&gt;jpg_settings.img_y
suffix:semicolon
id|cap.width
op_assign
id|zr-&gt;jpg_settings.img_width
suffix:semicolon
id|cap.height
op_assign
id|zr-&gt;jpg_settings.img_height
suffix:semicolon
id|cap.decimation
op_assign
id|zr-&gt;jpg_settings.HorDcm
op_or
(paren
id|zr-&gt;jpg_settings.VerDcm
op_lshift
l_int|8
)paren
suffix:semicolon
id|cap.quality
op_assign
id|zr-&gt;jpg_settings.jpg_comp.quality
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
id|BUZ_MODE_MOTION_COMPRESS
suffix:colon
multiline_comment|/* In motion compress mode, the decoder output must be enabled, and&n;&t;&t; * the video bus direction set to input.&n;&t;&t; */
id|set_videobus_dir
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_ENABLE_OUTPUT
comma
op_amp
id|one
)paren
suffix:semicolon
id|encoder_command
c_func
(paren
id|zr
comma
id|ENCODER_SET_INPUT
comma
op_amp
id|zero
)paren
suffix:semicolon
multiline_comment|/* Take the JPEG codec and the VFE out of sleep */
id|jpeg_codec_sleep
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Setup the JPEG codec */
id|zr-&gt;codec
op_member_access_from_pointer
id|control
c_func
(paren
id|zr-&gt;codec
comma
id|CODEC_S_JPEG_TDS_BYTE
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|field_size
)paren
suffix:semicolon
id|zr-&gt;codec
op_member_access_from_pointer
id|set_video
c_func
(paren
id|zr-&gt;codec
comma
id|zr-&gt;timing
comma
op_amp
id|cap
comma
op_amp
id|zr-&gt;card.vfe_pol
)paren
suffix:semicolon
id|zr-&gt;codec
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|zr-&gt;codec
comma
id|CODEC_DO_COMPRESSION
)paren
suffix:semicolon
multiline_comment|/* Setup the VFE */
r_if
c_cond
(paren
id|zr-&gt;vfe
)paren
(brace
id|zr-&gt;vfe
op_member_access_from_pointer
id|control
c_func
(paren
id|zr-&gt;vfe
comma
id|CODEC_S_JPEG_TDS_BYTE
comma
r_sizeof
(paren
r_int
)paren
comma
op_amp
id|field_size
)paren
suffix:semicolon
id|zr-&gt;vfe
op_member_access_from_pointer
id|set_video
c_func
(paren
id|zr-&gt;vfe
comma
id|zr-&gt;timing
comma
op_amp
id|cap
comma
op_amp
id|zr-&gt;card.vfe_pol
)paren
suffix:semicolon
id|zr-&gt;vfe
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|zr-&gt;vfe
comma
id|CODEC_DO_COMPRESSION
)paren
suffix:semicolon
)brace
id|init_jpeg_queue
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36057_set_jpg
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
singleline_comment|// &bslash;P_Reset, ... Video param, FIFO
id|clear_interrupt_counters
c_func
(paren
id|zr
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_INFO
l_string|&quot;%s: enable_jpg(MOTION_COMPRESS)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_MOTION_DECOMPRESS
suffix:colon
multiline_comment|/* In motion decompression mode, the decoder output must be disabled, and&n;&t;&t; * the video bus direction set to output.&n;&t;&t; */
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_ENABLE_OUTPUT
comma
op_amp
id|zero
)paren
suffix:semicolon
id|set_videobus_dir
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
id|encoder_command
c_func
(paren
id|zr
comma
id|ENCODER_SET_INPUT
comma
op_amp
id|one
)paren
suffix:semicolon
multiline_comment|/* Take the JPEG codec and the VFE out of sleep */
id|jpeg_codec_sleep
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Setup the VFE */
r_if
c_cond
(paren
id|zr-&gt;vfe
)paren
(brace
id|zr-&gt;vfe
op_member_access_from_pointer
id|set_video
c_func
(paren
id|zr-&gt;vfe
comma
id|zr-&gt;timing
comma
op_amp
id|cap
comma
op_amp
id|zr-&gt;card.vfe_pol
)paren
suffix:semicolon
id|zr-&gt;vfe
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|zr-&gt;vfe
comma
id|CODEC_DO_EXPANSION
)paren
suffix:semicolon
)brace
multiline_comment|/* Setup the JPEG codec */
id|zr-&gt;codec
op_member_access_from_pointer
id|set_video
c_func
(paren
id|zr-&gt;codec
comma
id|zr-&gt;timing
comma
op_amp
id|cap
comma
op_amp
id|zr-&gt;card.vfe_pol
)paren
suffix:semicolon
id|zr-&gt;codec
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|zr-&gt;codec
comma
id|CODEC_DO_EXPANSION
)paren
suffix:semicolon
id|init_jpeg_queue
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36057_set_jpg
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
singleline_comment|// &bslash;P_Reset, ... Video param, FIFO
id|clear_interrupt_counters
c_func
(paren
id|zr
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_INFO
l_string|&quot;%s: enable_jpg(MOTION_DECOMPRESS)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BUZ_MODE_IDLE
suffix:colon
r_default
suffix:colon
multiline_comment|/* shut down processing */
id|btand
c_func
(paren
op_complement
(paren
id|zr-&gt;card.jpeg_int
op_or
id|ZR36057_ICR_JPEGRepIRQ
)paren
comma
id|ZR36057_ICR
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|zr-&gt;card.jpeg_int
op_or
id|ZR36057_ICR_JPEGRepIRQ
comma
id|ZR36057_ISR
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_JMC_Go_en
comma
id|ZR36057_JMC
)paren
suffix:semicolon
singleline_comment|// &bslash;Go_en
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|20
)paren
suffix:semicolon
id|set_videobus_dir
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|set_frame
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|// /FRAME
id|btor
c_func
(paren
id|ZR36057_MCTCR_CFlush
comma
id|ZR36057_MCTCR
)paren
suffix:semicolon
singleline_comment|// /CFlush
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_JPC
)paren
suffix:semicolon
singleline_comment|// &bslash;P_Reset,&bslash;CodTrnsEn,&bslash;Active
id|btand
c_func
(paren
op_complement
id|ZR36057_JMC_VFIFO_FB
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_JMC_SyncMstr
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|jpeg_codec_reset
c_func
(paren
id|zr
)paren
suffix:semicolon
id|jpeg_codec_sleep
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
id|zr36057_adjust_vfe
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_ENABLE_OUTPUT
comma
op_amp
id|one
)paren
suffix:semicolon
id|encoder_command
c_func
(paren
id|zr
comma
id|ENCODER_SET_INPUT
comma
op_amp
id|zero
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_INFO
l_string|&quot;%s: enable_jpg(IDLE)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* when this is called the spinlock must be held */
r_void
DECL|function|zoran_feed_stat_com
id|zoran_feed_stat_com
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
multiline_comment|/* move frames from pending queue to DMA */
r_int
id|frame
comma
id|i
comma
id|max_stat_com
suffix:semicolon
id|max_stat_com
op_assign
(paren
id|zr-&gt;jpg_settings.TmpDcm
op_eq
l_int|1
)paren
ques
c_cond
id|BUZ_NUM_STAT_COM
suffix:colon
(paren
id|BUZ_NUM_STAT_COM
op_rshift
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|zr-&gt;jpg_dma_head
op_minus
id|zr-&gt;jpg_dma_tail
)paren
OL
id|max_stat_com
op_logical_and
id|zr-&gt;jpg_dma_head
OL
id|zr-&gt;jpg_que_head
)paren
(brace
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_dma_head
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;jpg_settings.TmpDcm
op_eq
l_int|1
)paren
(brace
multiline_comment|/* fill 1 stat_com entry */
id|i
op_assign
(paren
id|zr-&gt;jpg_dma_head
op_minus
id|zr-&gt;jpg_err_shift
)paren
op_amp
id|BUZ_MASK_STAT_COM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|zr-&gt;stat_com
(braket
id|i
)braket
op_amp
l_int|1
)paren
)paren
r_break
suffix:semicolon
id|zr-&gt;stat_com
(braket
id|i
)braket
op_assign
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
dot
id|frag_tab_bus
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fill 2 stat_com entries */
id|i
op_assign
(paren
(paren
id|zr-&gt;jpg_dma_head
op_minus
id|zr-&gt;jpg_err_shift
)paren
op_amp
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|zr-&gt;stat_com
(braket
id|i
)braket
op_amp
l_int|1
)paren
)paren
r_break
suffix:semicolon
id|zr-&gt;stat_com
(braket
id|i
)braket
op_assign
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
dot
id|frag_tab_bus
suffix:semicolon
id|zr-&gt;stat_com
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
dot
id|frag_tab_bus
suffix:semicolon
)brace
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_DMA
suffix:semicolon
id|zr-&gt;jpg_dma_head
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
id|zr-&gt;jpg_queued_num
op_increment
suffix:semicolon
)brace
multiline_comment|/* when this is called the spinlock must be held */
r_static
r_void
DECL|function|zoran_reap_stat_com
id|zoran_reap_stat_com
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
multiline_comment|/* move frames from DMA queue to done queue */
r_int
id|i
suffix:semicolon
id|u32
id|stat_com
suffix:semicolon
r_int
r_int
id|seq
suffix:semicolon
r_int
r_int
id|dif
suffix:semicolon
r_struct
id|zoran_jpg_buffer
op_star
id|buffer
suffix:semicolon
r_int
id|frame
suffix:semicolon
multiline_comment|/* In motion decompress we don&squot;t have a hardware frame counter,&n;&t; * we just count the interrupts here */
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
(brace
id|zr-&gt;jpg_seq_num
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
id|zr-&gt;jpg_dma_tail
OL
id|zr-&gt;jpg_dma_head
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;jpg_settings.TmpDcm
op_eq
l_int|1
)paren
id|i
op_assign
(paren
id|zr-&gt;jpg_dma_tail
op_minus
id|zr-&gt;jpg_err_shift
)paren
op_amp
id|BUZ_MASK_STAT_COM
suffix:semicolon
r_else
id|i
op_assign
(paren
(paren
id|zr-&gt;jpg_dma_tail
op_minus
id|zr-&gt;jpg_err_shift
)paren
op_amp
l_int|1
)paren
op_star
l_int|2
op_plus
l_int|1
suffix:semicolon
id|stat_com
op_assign
id|zr-&gt;stat_com
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat_com
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_dma_tail
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
id|buffer
op_assign
op_amp
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|buffer-&gt;bs.timestamp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_COMPRESS
)paren
(brace
id|buffer-&gt;bs.length
op_assign
(paren
id|stat_com
op_amp
l_int|0x7fffff
)paren
op_rshift
l_int|1
suffix:semicolon
multiline_comment|/* update sequence number with the help of the counter in stat_com */
id|seq
op_assign
(paren
(paren
id|stat_com
op_rshift
l_int|24
)paren
op_plus
id|zr-&gt;jpg_err_seq
)paren
op_amp
l_int|0xff
suffix:semicolon
id|dif
op_assign
(paren
id|seq
op_minus
id|zr-&gt;jpg_seq_num
)paren
op_amp
l_int|0xff
suffix:semicolon
id|zr-&gt;jpg_seq_num
op_add_assign
id|dif
suffix:semicolon
)brace
r_else
(brace
id|buffer-&gt;bs.length
op_assign
l_int|0
suffix:semicolon
)brace
id|buffer-&gt;bs.seq
op_assign
id|zr-&gt;jpg_settings.TmpDcm
op_eq
l_int|2
ques
c_cond
(paren
id|zr-&gt;jpg_seq_num
op_rshift
l_int|1
)paren
suffix:colon
id|zr-&gt;jpg_seq_num
suffix:semicolon
id|buffer-&gt;state
op_assign
id|BUZ_STATE_DONE
suffix:semicolon
id|zr-&gt;jpg_dma_tail
op_increment
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|error_handler
id|error_handler
(paren
r_struct
id|zoran
op_star
id|zr
comma
id|u32
id|astat
comma
id|u32
id|stat
)paren
(brace
multiline_comment|/* This is JPEG error handling part */
r_if
c_cond
(paren
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_MOTION_COMPRESS
)paren
op_logical_and
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
)paren
(brace
singleline_comment|//dprintk(1, KERN_ERR &quot;%s: Internal error: error handling request in mode %d&bslash;n&quot;, ZR_DEVNAME(zr), zr-&gt;codec_mode);
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|stat
op_amp
l_int|1
)paren
op_eq
l_int|0
op_logical_and
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_COMPRESS
op_logical_and
id|zr-&gt;jpg_dma_tail
op_minus
id|zr-&gt;jpg_que_tail
op_ge
id|zr-&gt;jpg_buffers.num_buffers
)paren
(brace
multiline_comment|/* No free buffers... */
id|zoran_reap_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zoran_feed_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
)paren
suffix:semicolon
id|zr-&gt;JPEG_missed
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;JPEG_error
op_ne
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t; * First entry: error just happened during normal operation&n;&t;&t; * &n;&t;&t; * In BUZ_MODE_MOTION_COMPRESS:&n;&t;&t; * &n;&t;&t; * Possible glitch in TV signal. In this case we should&n;&t;&t; * stop the codec and wait for good quality signal before&n;&t;&t; * restarting it to avoid further problems&n;&t;&t; * &n;&t;&t; * In BUZ_MODE_MOTION_DECOMPRESS:&n;&t;&t; * &n;&t;&t; * Bad JPEG frame: we have to mark it as processed (codec crashed&n;&t;&t; * and was not able to do it itself), and to remove it from queue.&n;&t;&t; */
id|btand
c_func
(paren
op_complement
id|ZR36057_JMC_Go_en
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|stat
op_assign
id|stat
op_or
(paren
id|post_office_read
c_func
(paren
id|zr
comma
l_int|7
comma
l_int|0
)paren
op_amp
l_int|3
)paren
op_lshift
l_int|8
suffix:semicolon
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_JPC
)paren
suffix:semicolon
id|btor
c_func
(paren
id|ZR36057_MCTCR_CFlush
comma
id|ZR36057_MCTCR
)paren
suffix:semicolon
id|jpeg_codec_reset
c_func
(paren
id|zr
)paren
suffix:semicolon
id|jpeg_codec_sleep
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
id|zr-&gt;JPEG_error
op_assign
l_int|1
suffix:semicolon
id|zr-&gt;num_errors
op_increment
suffix:semicolon
multiline_comment|/* Report error */
r_if
c_cond
(paren
op_star
id|zr_debug
OG
l_int|1
op_logical_and
id|zr-&gt;num_errors
op_le
l_int|8
)paren
(brace
r_int
id|frame
suffix:semicolon
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_dma_tail
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: JPEG error stat=0x%08x(0x%08x) queue_state=%ld/%ld/%ld/%ld seq=%ld frame=%ld. Codec stopped. &quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|stat
comma
id|zr-&gt;last_isr
comma
id|zr-&gt;jpg_que_tail
comma
id|zr-&gt;jpg_dma_tail
comma
id|zr-&gt;jpg_dma_head
comma
id|zr-&gt;jpg_que_head
comma
id|zr-&gt;jpg_seq_num
comma
id|frame
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;stat_com frames:&quot;
)paren
suffix:semicolon
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|BUZ_NUM_STAT_COM
suffix:semicolon
id|j
op_increment
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zr-&gt;jpg_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;stat_com
(braket
id|j
)braket
op_eq
id|zr-&gt;jpg_buffers
dot
id|buffer
(braket
id|i
)braket
dot
id|frag_tab_bus
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;% d-&gt;%d&quot;
comma
id|j
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Find an entry in stat_com and rotate contents */
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;jpg_settings.TmpDcm
op_eq
l_int|1
)paren
id|i
op_assign
(paren
id|zr-&gt;jpg_dma_tail
op_minus
id|zr-&gt;jpg_err_shift
)paren
op_amp
id|BUZ_MASK_STAT_COM
suffix:semicolon
r_else
id|i
op_assign
(paren
(paren
id|zr-&gt;jpg_dma_tail
op_minus
id|zr-&gt;jpg_err_shift
)paren
op_amp
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
(brace
multiline_comment|/* Mimic zr36067 operation */
id|zr-&gt;stat_com
(braket
id|i
)braket
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;jpg_settings.TmpDcm
op_ne
l_int|1
)paren
id|zr-&gt;stat_com
(braket
id|i
op_plus
l_int|1
)braket
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/* Refill */
id|zoran_reap_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zoran_feed_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
)paren
suffix:semicolon
multiline_comment|/* Find an entry in stat_com again after refill */
r_if
c_cond
(paren
id|zr-&gt;jpg_settings.TmpDcm
op_eq
l_int|1
)paren
id|i
op_assign
(paren
id|zr-&gt;jpg_dma_tail
op_minus
id|zr-&gt;jpg_err_shift
)paren
op_amp
id|BUZ_MASK_STAT_COM
suffix:semicolon
r_else
id|i
op_assign
(paren
(paren
id|zr-&gt;jpg_dma_tail
op_minus
id|zr-&gt;jpg_err_shift
)paren
op_amp
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
)paren
(brace
multiline_comment|/* Rotate stat_comm entries to make current entry first */
r_int
id|j
suffix:semicolon
id|u32
id|bus_addr
(braket
id|BUZ_NUM_STAT_COM
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|bus_addr
comma
id|zr-&gt;stat_com
comma
r_sizeof
(paren
id|bus_addr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|BUZ_NUM_STAT_COM
suffix:semicolon
id|j
op_increment
)paren
(brace
id|zr-&gt;stat_com
(braket
id|j
)braket
op_assign
id|bus_addr
(braket
(paren
id|i
op_plus
id|j
)paren
op_amp
id|BUZ_MASK_STAT_COM
)braket
suffix:semicolon
)brace
id|zr-&gt;jpg_err_shift
op_add_assign
id|i
suffix:semicolon
id|zr-&gt;jpg_err_shift
op_and_assign
id|BUZ_MASK_STAT_COM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_COMPRESS
)paren
id|zr-&gt;jpg_err_seq
op_assign
id|zr-&gt;jpg_seq_num
suffix:semicolon
multiline_comment|/* + 1; */
)brace
)brace
multiline_comment|/* Now the stat_comm buffer is ready for restart */
r_do
(brace
r_int
id|status
comma
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_COMPRESS
)paren
(brace
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_GET_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
id|mode
op_assign
id|CODEC_DO_COMPRESSION
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
l_int|0
suffix:semicolon
id|mode
op_assign
id|CODEC_DO_EXPANSION
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
op_logical_or
(paren
id|status
op_amp
id|DECODER_STATUS_GOOD
)paren
)paren
(brace
multiline_comment|/********** RESTART code *************/
id|jpeg_codec_reset
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr-&gt;codec
op_member_access_from_pointer
id|set_mode
c_func
(paren
id|zr-&gt;codec
comma
id|mode
)paren
suffix:semicolon
id|zr36057_set_jpg
c_func
(paren
id|zr
comma
id|zr-&gt;codec_mode
)paren
suffix:semicolon
id|jpeg_start
c_func
(paren
id|zr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;num_errors
op_le
l_int|8
)paren
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_INFO
l_string|&quot;%s: Restart&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|zr-&gt;JPEG_missed
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_error
op_assign
l_int|2
suffix:semicolon
multiline_comment|/********** End RESTART code ***********/
)brace
)brace
r_while
c_loop
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|irqreturn_t
DECL|function|zoran_irq
id|zoran_irq
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u32
id|stat
comma
id|astat
suffix:semicolon
r_int
id|count
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|zr
op_assign
(paren
r_struct
id|zoran
op_star
)paren
id|dev_id
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;testing
)paren
(brace
multiline_comment|/* Testing interrupts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|stat
op_assign
id|count_reset_interrupt
c_func
(paren
id|zr
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|count
op_increment
OG
l_int|100
)paren
(brace
id|btand
c_func
(paren
op_complement
id|ZR36057_ICR_IntPinEn
comma
id|ZR36057_ICR
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: IRQ lockup while testing, isr=0x%08x, cleared int mask&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|stat
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;test_q
)paren
suffix:semicolon
)brace
)brace
id|zr-&gt;last_isr
op_assign
id|stat
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* get/clear interrupt status bits */
id|stat
op_assign
id|count_reset_interrupt
c_func
(paren
id|zr
)paren
suffix:semicolon
id|astat
op_assign
id|stat
op_amp
id|IRQ_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|astat
)paren
(brace
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|4
comma
id|KERN_DEBUG
l_string|&quot;zoran_irq: astat: 0x%08x, mask: 0x%08x&bslash;n&quot;
comma
id|astat
comma
id|btread
c_func
(paren
id|ZR36057_ICR
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|astat
op_amp
id|zr-&gt;card.vsync_int
)paren
(brace
singleline_comment|// SW
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
op_logical_or
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_COMPRESS
)paren
(brace
multiline_comment|/* count missed interrupts */
id|zr-&gt;JPEG_missed
op_increment
suffix:semicolon
)brace
singleline_comment|//post_office_read(zr,1,0);
multiline_comment|/* Interrupts may still happen when&n;&t;&t;&t; * zr-&gt;v4l_memgrab_active is switched off.&n;&t;&t;&t; * We simply ignore them */
r_if
c_cond
(paren
id|zr-&gt;v4l_memgrab_active
)paren
(brace
multiline_comment|/* A lot more checks should be here ... */
r_if
c_cond
(paren
(paren
id|btread
c_func
(paren
id|ZR36057_VSSFGR
)paren
op_amp
id|ZR36057_VSSFGR_SnapShot
)paren
op_eq
l_int|0
)paren
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_WARNING
l_string|&quot;%s: BuzIRQ with SnapShot off ???&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_grab_frame
op_ne
id|NO_GRAB_ACTIVE
)paren
(brace
multiline_comment|/* There is a grab on a frame going on, check if it has finished */
r_if
c_cond
(paren
(paren
id|btread
c_func
(paren
id|ZR36057_VSSFGR
)paren
op_amp
id|ZR36057_VSSFGR_FrameGrab
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* it is finished, notify the user */
id|zr-&gt;v4l_buffers.buffer
(braket
id|zr-&gt;v4l_grab_frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_DONE
suffix:semicolon
id|zr-&gt;v4l_buffers.buffer
(braket
id|zr-&gt;v4l_grab_frame
)braket
dot
id|bs.seq
op_assign
id|zr-&gt;v4l_grab_seq
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|zr-&gt;v4l_buffers.buffer
(braket
id|zr-&gt;v4l_grab_frame
)braket
dot
id|bs.timestamp
)paren
suffix:semicolon
id|zr-&gt;v4l_grab_frame
op_assign
id|NO_GRAB_ACTIVE
suffix:semicolon
id|zr-&gt;v4l_pend_tail
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|zr-&gt;v4l_grab_frame
op_eq
id|NO_GRAB_ACTIVE
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
)paren
suffix:semicolon
multiline_comment|/* Check if there is another grab queued */
r_if
c_cond
(paren
id|zr-&gt;v4l_grab_frame
op_eq
id|NO_GRAB_ACTIVE
op_logical_and
id|zr-&gt;v4l_pend_tail
op_ne
id|zr-&gt;v4l_pend_head
)paren
(brace
r_int
id|frame
op_assign
id|zr-&gt;v4l_pend
(braket
id|zr-&gt;v4l_pend_tail
op_amp
id|V4L_MASK_FRAME
)braket
suffix:semicolon
id|u32
id|reg
suffix:semicolon
id|zr-&gt;v4l_grab_frame
op_assign
id|frame
suffix:semicolon
multiline_comment|/* Set zr36057 video front end and enable video */
multiline_comment|/* Buffer address */
id|reg
op_assign
id|zr-&gt;v4l_buffers.buffer
(braket
id|frame
)braket
dot
id|fbuffer_bus
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_settings.height
OG
id|BUZ_MAX_HEIGHT
op_div
l_int|2
)paren
id|reg
op_add_assign
id|zr-&gt;v4l_settings
dot
id|bytesperline
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDBR
)paren
suffix:semicolon
multiline_comment|/* video stride, status, and frame grab register */
id|reg
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_settings.height
OG
id|BUZ_MAX_HEIGHT
op_div
l_int|2
)paren
id|reg
op_add_assign
id|zr-&gt;v4l_settings
dot
id|bytesperline
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_lshift
id|ZR36057_VSSFGR_DispStride
)paren
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VSSFGR_VidOvf
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VSSFGR_SnapShot
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VSSFGR_FrameGrab
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VSSFGR
)paren
suffix:semicolon
id|btor
c_func
(paren
id|ZR36057_VDCR_VidEn
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* even if we don&squot;t grab, we do want to increment&n;&t;&t;&t; * the sequence counter to see lost frames */
id|zr-&gt;v4l_grab_seq
op_increment
suffix:semicolon
)brace
macro_line|#if (IRQ_MASK &amp; ZR36057_ISR_CodRepIRQ)
r_if
c_cond
(paren
id|astat
op_amp
id|ZR36057_ISR_CodRepIRQ
)paren
(brace
id|zr-&gt;intr_counter_CodRepIRQ
op_increment
suffix:semicolon
id|IDEBUG
c_func
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;%s: ZR36057_ISR_CodRepIRQ&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
)paren
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_ICR_CodRepIRQ
comma
id|ZR36057_ICR
)paren
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* (IRQ_MASK &amp; ZR36057_ISR_CodRepIRQ) */
macro_line|#if (IRQ_MASK &amp; ZR36057_ISR_JPEGRepIRQ)
r_if
c_cond
(paren
id|astat
op_amp
id|ZR36057_ISR_JPEGRepIRQ
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
op_logical_or
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_COMPRESS
)paren
(brace
r_if
c_cond
(paren
op_star
id|zr_debug
OG
l_int|1
op_logical_and
(paren
op_logical_neg
id|zr-&gt;frame_num
op_logical_or
id|zr-&gt;JPEG_error
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: first frame ready: state=0x%08x odd_even=%d field_per_buff=%d delay=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|stat
comma
id|zr-&gt;jpg_settings.odd_even
comma
id|zr-&gt;jpg_settings
dot
id|field_per_buff
comma
id|zr-&gt;JPEG_missed
)paren
suffix:semicolon
(brace
r_char
id|sc
(braket
)braket
op_assign
l_string|&quot;0000&quot;
suffix:semicolon
r_char
id|sv
(braket
l_int|5
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|strcpy
c_func
(paren
id|sv
comma
id|sc
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;stat_com
(braket
id|i
)braket
op_amp
l_int|1
)paren
id|sv
(braket
id|i
)braket
op_assign
l_char|&squot;1&squot;
suffix:semicolon
)brace
id|sv
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: stat_com=%s queue_state=%ld/%ld/%ld/%ld&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|sv
comma
id|zr-&gt;jpg_que_tail
comma
id|zr-&gt;jpg_dma_tail
comma
id|zr-&gt;jpg_dma_head
comma
id|zr-&gt;jpg_que_head
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|zr-&gt;JPEG_missed
OG
id|zr-&gt;JPEG_max_missed
)paren
singleline_comment|// Get statistics
id|zr-&gt;JPEG_max_missed
op_assign
id|zr-&gt;JPEG_missed
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;JPEG_missed
OL
id|zr-&gt;JPEG_min_missed
)paren
id|zr-&gt;JPEG_min_missed
op_assign
id|zr-&gt;JPEG_missed
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|zr_debug
OG
l_int|2
op_logical_and
id|zr-&gt;frame_num
OL
l_int|6
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: seq=%ld stat_com:&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|zr-&gt;jpg_seq_num
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; %08x&quot;
comma
id|zr-&gt;stat_com
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|zr-&gt;frame_num
op_increment
suffix:semicolon
id|zr-&gt;JPEG_missed
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;JPEG_error
op_assign
l_int|0
suffix:semicolon
id|zoran_reap_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zoran_feed_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
)paren
suffix:semicolon
)brace
multiline_comment|/*else {&n;&t;&t;&t;      dprintk(1,&n;&t;&t;&t;&t;&t;KERN_ERR&n;&t;&t;&t;&t;&t;&quot;%s: JPEG interrupt while not in motion (de)compress mode!&bslash;n&quot;,&n;&t;&t;&t;&t;&t;ZR_DEVNAME(zr));&n;&t;&t;&t;}*/
)brace
macro_line|#endif&t;&t;&t;&t;/* (IRQ_MASK &amp; ZR36057_ISR_JPEGRepIRQ) */
multiline_comment|/* DATERR, too many fields missed, error processing */
r_if
c_cond
(paren
(paren
id|astat
op_amp
id|zr-&gt;card.jpeg_int
)paren
op_logical_or
id|zr-&gt;JPEG_missed
OG
l_int|25
op_logical_or
id|zr-&gt;JPEG_error
op_eq
l_int|1
op_logical_or
(paren
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
op_logical_and
(paren
id|zr-&gt;frame_num
op_amp
(paren
id|zr-&gt;JPEG_missed
OG
id|zr-&gt;jpg_settings.field_per_buff
)paren
)paren
)paren
)paren
(brace
id|error_handler
c_func
(paren
id|zr
comma
id|astat
comma
id|stat
)paren
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|10
)paren
(brace
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_WARNING
l_string|&quot;%s: irq loop %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
l_int|20
)paren
(brace
id|btand
c_func
(paren
op_complement
id|ZR36057_ICR_IntPinEn
comma
id|ZR36057_ICR
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_ERR
l_string|&quot;%s: IRQ lockup, cleared int mask&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|zr-&gt;last_isr
op_assign
id|stat
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_void
DECL|function|zoran_set_pci_master
id|zoran_set_pci_master
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|set_master
)paren
(brace
r_if
c_cond
(paren
id|set_master
)paren
(brace
id|pci_set_master
c_func
(paren
id|zr-&gt;pci_dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|u16
id|command
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|zr-&gt;pci_dev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
id|command
op_and_assign
op_complement
id|PCI_COMMAND_MASTER
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|zr-&gt;pci_dev
comma
id|PCI_COMMAND
comma
id|command
)paren
suffix:semicolon
)brace
)brace
r_void
DECL|function|zoran_init_hardware
id|zoran_init_hardware
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
r_int
id|j
comma
id|zero
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Enable bus-mastering */
id|zoran_set_pci_master
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Initialize the board */
r_if
c_cond
(paren
id|zr-&gt;card.init
)paren
(brace
id|zr-&gt;card
dot
id|init
c_func
(paren
id|zr
)paren
suffix:semicolon
)brace
id|j
op_assign
id|zr-&gt;card.input
(braket
id|zr-&gt;input
)braket
dot
id|muxsel
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_NORM
comma
op_amp
id|zr-&gt;norm
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_INPUT
comma
op_amp
id|j
)paren
suffix:semicolon
id|encoder_command
c_func
(paren
id|zr
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
id|encoder_command
c_func
(paren
id|zr
comma
id|ENCODER_SET_NORM
comma
op_amp
id|zr-&gt;norm
)paren
suffix:semicolon
id|encoder_command
c_func
(paren
id|zr
comma
id|ENCODER_SET_INPUT
comma
op_amp
id|zero
)paren
suffix:semicolon
multiline_comment|/* toggle JPEG codec sleep to sync PLL */
id|jpeg_codec_sleep
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
id|jpeg_codec_sleep
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* set individual interrupt enables (without GIRQ1)&n;&t; * but don&squot;t global enable until zoran_open() */
singleline_comment|//btwrite(IRQ_MASK &amp; ~ZR36057_ISR_GIRQ1, ZR36057_ICR);  // SW
singleline_comment|// It looks like using only JPEGRepIRQEn is not always reliable,
singleline_comment|// may be when JPEG codec crashes it won&squot;t generate IRQ? So,
multiline_comment|/*CP*/
singleline_comment|//        btwrite(IRQ_MASK, ZR36057_ICR); // Enable Vsync interrupts too. SM    WHY ? LP
id|zr36057_init_vfe
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|BUZ_MODE_IDLE
)paren
suffix:semicolon
id|btwrite
c_func
(paren
id|IRQ_MASK
comma
id|ZR36057_ISR
)paren
suffix:semicolon
singleline_comment|// Clears interrupts
)brace
r_void
DECL|function|zr36057_restart
id|zr36057_restart
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_SPGPPCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|btor
c_func
(paren
id|ZR36057_SPGPPCR_SoftReset
comma
id|ZR36057_SPGPPCR
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* assert P_Reset */
id|btwrite
c_func
(paren
l_int|0
comma
id|ZR36057_JPC
)paren
suffix:semicolon
multiline_comment|/* set up GPIO direction - all output */
id|btwrite
c_func
(paren
id|ZR36057_SPGPPCR_SoftReset
op_or
l_int|0
comma
id|ZR36057_SPGPPCR
)paren
suffix:semicolon
multiline_comment|/* set up GPIO pins and guest bus timing */
id|btwrite
c_func
(paren
(paren
l_int|0x81
op_lshift
l_int|24
)paren
op_or
l_int|0x8888
comma
id|ZR36057_GPPGCR1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * initialize video front end&n; */
r_void
DECL|function|zr36057_init_vfe
id|zr36057_init_vfe
(paren
r_struct
id|zoran
op_star
id|zr
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|reg
op_assign
id|btread
c_func
(paren
id|ZR36057_VFESPFR
)paren
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VFESPFR_LittleEndian
suffix:semicolon
id|reg
op_and_assign
op_complement
id|ZR36057_VFESPFR_VCLKPol
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VFESPFR_ExtFl
suffix:semicolon
id|reg
op_or_assign
id|ZR36057_VFESPFR_TopField
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VFESPFR
)paren
suffix:semicolon
id|reg
op_assign
id|btread
c_func
(paren
id|ZR36057_VDCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_pci_problems
op_amp
id|PCIPCI_TRITON
)paren
singleline_comment|// || zr-&gt;revision &lt; 1) // Revision 1 has also Triton support
id|reg
op_and_assign
op_complement
id|ZR36057_VDCR_Triton
suffix:semicolon
r_else
id|reg
op_or_assign
id|ZR36057_VDCR_Triton
suffix:semicolon
id|btwrite
c_func
(paren
id|reg
comma
id|ZR36057_VDCR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interface to decoder and encoder chips using i2c bus&n; */
r_int
DECL|function|decoder_command
id|decoder_command
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|cmd
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;decoder
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;card.type
op_eq
id|LML33
op_logical_and
(paren
id|cmd
op_eq
id|DECODER_SET_NORM
op_logical_or
id|DECODER_SET_INPUT
)paren
)paren
(brace
r_int
id|res
suffix:semicolon
singleline_comment|// Bt819 needs to reset its FIFO buffer using #FRST pin and
singleline_comment|// LML33 card uses GPIO(7) for that.
id|GPIO
c_func
(paren
id|zr
comma
l_int|7
comma
l_int|0
)paren
suffix:semicolon
id|res
op_assign
id|zr-&gt;decoder-&gt;driver
op_member_access_from_pointer
id|command
c_func
(paren
id|zr-&gt;decoder
comma
id|cmd
comma
id|data
)paren
suffix:semicolon
singleline_comment|// Pull #FRST high.
id|GPIO
c_func
(paren
id|zr
comma
l_int|7
comma
l_int|1
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_else
r_return
id|zr-&gt;decoder-&gt;driver
op_member_access_from_pointer
id|command
c_func
(paren
id|zr-&gt;decoder
comma
id|cmd
comma
id|data
)paren
suffix:semicolon
)brace
r_int
DECL|function|encoder_command
id|encoder_command
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|cmd
comma
r_void
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;encoder
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|zr-&gt;encoder-&gt;driver
op_member_access_from_pointer
id|command
c_func
(paren
id|zr-&gt;encoder
comma
id|cmd
comma
id|data
)paren
suffix:semicolon
)brace
eof
