multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * Should you need to contact me, the author, you can do so either by&n; * e-mail - mail your message to &lt;vojtech@ucw.cz&gt;, or by paper mail:&n; * Vojtech Pavlik, Simunkova 1594, Prague 8, 182 00 Czech Republic&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &quot;saa7134-reg.h&quot;
macro_line|#include &quot;saa7134.h&quot;
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|variable|flyvideo_codes
r_static
id|IR_KEYTAB_TYPE
id|flyvideo_codes
(braket
id|IR_KEYTAB_SIZE
)braket
op_assign
(brace
(braket
l_int|15
)braket
op_assign
id|KEY_KP0
comma
(braket
l_int|3
)braket
op_assign
id|KEY_KP1
comma
(braket
l_int|4
)braket
op_assign
id|KEY_KP2
comma
(braket
l_int|5
)braket
op_assign
id|KEY_KP3
comma
(braket
l_int|7
)braket
op_assign
id|KEY_KP4
comma
(braket
l_int|8
)braket
op_assign
id|KEY_KP5
comma
(braket
l_int|9
)braket
op_assign
id|KEY_KP6
comma
(braket
l_int|11
)braket
op_assign
id|KEY_KP7
comma
(braket
l_int|12
)braket
op_assign
id|KEY_KP8
comma
(braket
l_int|13
)braket
op_assign
id|KEY_KP9
comma
(braket
l_int|14
)braket
op_assign
id|KEY_TUNER
comma
singleline_comment|// Air/Cable
(braket
l_int|17
)braket
op_assign
id|KEY_VIDEO
comma
singleline_comment|// Video
(braket
l_int|21
)braket
op_assign
id|KEY_AUDIO
comma
singleline_comment|// Audio
(braket
l_int|0
)braket
op_assign
id|KEY_POWER
comma
singleline_comment|// Pover
(braket
l_int|2
)braket
op_assign
id|KEY_ZOOM
comma
singleline_comment|// Fullscreen
(braket
l_int|27
)braket
op_assign
id|KEY_MUTE
comma
singleline_comment|// Mute
(braket
l_int|20
)braket
op_assign
id|KEY_VOLUMEUP
comma
(braket
l_int|23
)braket
op_assign
id|KEY_VOLUMEDOWN
comma
(braket
l_int|18
)braket
op_assign
id|KEY_CHANNELUP
comma
singleline_comment|// Channel +
(braket
l_int|19
)braket
op_assign
id|KEY_CHANNELDOWN
comma
singleline_comment|// Channel - 
(braket
l_int|6
)braket
op_assign
id|KEY_AGAIN
comma
singleline_comment|// Recal
(braket
l_int|16
)braket
op_assign
id|KEY_KPENTER
comma
singleline_comment|// Enter
macro_line|#if 1 /* FIXME */
(braket
l_int|26
)braket
op_assign
id|KEY_F22
comma
singleline_comment|// Stereo
(braket
l_int|24
)braket
op_assign
id|KEY_EDIT
comma
singleline_comment|// AV Source
macro_line|#endif
)brace
suffix:semicolon
DECL|variable|cinergy_codes
r_static
id|IR_KEYTAB_TYPE
id|cinergy_codes
(braket
id|IR_KEYTAB_SIZE
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
id|KEY_KP0
comma
(braket
l_int|1
)braket
op_assign
id|KEY_KP1
comma
(braket
l_int|2
)braket
op_assign
id|KEY_KP2
comma
(braket
l_int|3
)braket
op_assign
id|KEY_KP3
comma
(braket
l_int|4
)braket
op_assign
id|KEY_KP4
comma
(braket
l_int|5
)braket
op_assign
id|KEY_KP5
comma
(braket
l_int|6
)braket
op_assign
id|KEY_KP6
comma
(braket
l_int|7
)braket
op_assign
id|KEY_KP7
comma
(braket
l_int|8
)braket
op_assign
id|KEY_KP8
comma
(braket
l_int|9
)braket
op_assign
id|KEY_KP9
comma
(braket
l_int|0x0a
)braket
op_assign
id|KEY_POWER
comma
(braket
l_int|0x0b
)braket
op_assign
id|KEY_PROG1
comma
singleline_comment|// app
(braket
l_int|0x0c
)braket
op_assign
id|KEY_ZOOM
comma
singleline_comment|// zoom/fullscreen
(braket
l_int|0x0d
)braket
op_assign
id|KEY_CHANNELUP
comma
singleline_comment|// channel
(braket
l_int|0x0e
)braket
op_assign
id|KEY_CHANNELDOWN
comma
singleline_comment|// channel-
(braket
l_int|0x0f
)braket
op_assign
id|KEY_VOLUMEUP
comma
(braket
l_int|0x10
)braket
op_assign
id|KEY_VOLUMEDOWN
comma
(braket
l_int|0x11
)braket
op_assign
id|KEY_TUNER
comma
singleline_comment|// AV
(braket
l_int|0x12
)braket
op_assign
id|KEY_NUMLOCK
comma
singleline_comment|// -/--
(braket
l_int|0x13
)braket
op_assign
id|KEY_AUDIO
comma
singleline_comment|// audio
(braket
l_int|0x14
)braket
op_assign
id|KEY_MUTE
comma
(braket
l_int|0x15
)braket
op_assign
id|KEY_UP
comma
(braket
l_int|0x16
)braket
op_assign
id|KEY_DOWN
comma
(braket
l_int|0x17
)braket
op_assign
id|KEY_LEFT
comma
(braket
l_int|0x18
)braket
op_assign
id|KEY_RIGHT
comma
(braket
l_int|0x19
)braket
op_assign
id|BTN_LEFT
comma
(braket
l_int|0x1a
)braket
op_assign
id|BTN_RIGHT
comma
(braket
l_int|0x1b
)braket
op_assign
id|KEY_WWW
comma
singleline_comment|// text
(braket
l_int|0x1c
)braket
op_assign
id|KEY_REWIND
comma
(braket
l_int|0x1d
)braket
op_assign
id|KEY_FORWARD
comma
(braket
l_int|0x1e
)braket
op_assign
id|KEY_RECORD
comma
(braket
l_int|0x1f
)braket
op_assign
id|KEY_PLAY
comma
(braket
l_int|0x20
)braket
op_assign
id|KEY_PREVIOUSSONG
comma
(braket
l_int|0x21
)braket
op_assign
id|KEY_NEXTSONG
comma
(braket
l_int|0x22
)braket
op_assign
id|KEY_PAUSE
comma
(braket
l_int|0x23
)braket
op_assign
id|KEY_STOP
comma
)brace
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|function|build_key
r_static
r_int
id|build_key
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
r_struct
id|saa7134_ir
op_star
id|ir
op_assign
id|dev-&gt;remote
suffix:semicolon
id|u32
id|gpio
comma
id|data
suffix:semicolon
multiline_comment|/* rising SAA7134_GPIO_GPRESCAN reads the status */
id|saa_clearb
c_func
(paren
id|SAA7134_GPIO_GPMODE3
comma
id|SAA7134_GPIO_GPRESCAN
)paren
suffix:semicolon
id|saa_setb
c_func
(paren
id|SAA7134_GPIO_GPMODE3
comma
id|SAA7134_GPIO_GPRESCAN
)paren
suffix:semicolon
id|gpio
op_assign
id|saa_readl
c_func
(paren
id|SAA7134_GPIO_GPSTATUS0
op_rshift
l_int|2
)paren
suffix:semicolon
id|data
op_assign
id|ir_extract_bits
c_func
(paren
id|gpio
comma
id|ir-&gt;mask_keycode
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: build_key gpio=0x%x mask=0x%x data=%d&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|gpio
comma
id|ir-&gt;mask_keycode
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ir-&gt;mask_keydown
op_logical_and
(paren
l_int|0
op_ne
(paren
id|gpio
op_amp
id|ir-&gt;mask_keydown
)paren
)paren
)paren
op_logical_or
(paren
id|ir-&gt;mask_keyup
op_logical_and
(paren
l_int|0
op_eq
(paren
id|gpio
op_amp
id|ir-&gt;mask_keyup
)paren
)paren
)paren
)paren
(brace
id|ir_input_keydown
c_func
(paren
op_amp
id|ir-&gt;dev
comma
op_amp
id|ir-&gt;ir
comma
id|data
comma
id|data
)paren
suffix:semicolon
)brace
r_else
(brace
id|ir_input_nokey
c_func
(paren
op_amp
id|ir-&gt;dev
comma
op_amp
id|ir-&gt;ir
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|function|saa7134_input_irq
r_void
id|saa7134_input_irq
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
id|build_key
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|saa7134_input_init1
r_int
id|saa7134_input_init1
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
r_struct
id|saa7134_ir
op_star
id|ir
suffix:semicolon
id|IR_KEYTAB_TYPE
op_star
id|ir_codes
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|mask_keycode
op_assign
l_int|0
suffix:semicolon
id|u32
id|mask_keydown
op_assign
l_int|0
suffix:semicolon
id|u32
id|mask_keyup
op_assign
l_int|0
suffix:semicolon
r_int
id|ir_type
op_assign
id|IR_TYPE_OTHER
suffix:semicolon
multiline_comment|/* detect &amp; configure */
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;has_remote
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;board
)paren
(brace
r_case
id|SAA7134_BOARD_FLYVIDEO2000
suffix:colon
r_case
id|SAA7134_BOARD_FLYVIDEO3000
suffix:colon
id|ir_codes
op_assign
id|flyvideo_codes
suffix:semicolon
id|mask_keycode
op_assign
l_int|0xEC00000
suffix:semicolon
id|mask_keydown
op_assign
l_int|0x0040000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA7134_BOARD_CINERGY400
suffix:colon
r_case
id|SAA7134_BOARD_CINERGY600
suffix:colon
id|ir_codes
op_assign
id|cinergy_codes
suffix:semicolon
id|mask_keycode
op_assign
l_int|0x00003f
suffix:semicolon
id|mask_keyup
op_assign
l_int|0x040000
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|ir_codes
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Oops: IR config error [card=%d]&bslash;n&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;board
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|ir
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ir
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|ir
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|ir
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ir
)paren
)paren
suffix:semicolon
multiline_comment|/* init hardware-specific stuff */
id|ir-&gt;mask_keycode
op_assign
id|mask_keycode
suffix:semicolon
id|ir-&gt;mask_keydown
op_assign
id|mask_keydown
suffix:semicolon
id|ir-&gt;mask_keyup
op_assign
id|mask_keyup
suffix:semicolon
multiline_comment|/* init input device */
id|snprintf
c_func
(paren
id|ir-&gt;name
comma
r_sizeof
(paren
id|ir-&gt;name
)paren
comma
l_string|&quot;saa7134 IR (%s)&quot;
comma
id|saa7134_boards
(braket
id|dev-&gt;board
)braket
dot
id|name
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|ir-&gt;phys
comma
r_sizeof
(paren
id|ir-&gt;phys
)paren
comma
l_string|&quot;pci-%s/ir0&quot;
comma
id|pci_name
c_func
(paren
id|dev-&gt;pci
)paren
)paren
suffix:semicolon
id|ir_input_init
c_func
(paren
op_amp
id|ir-&gt;dev
comma
op_amp
id|ir-&gt;ir
comma
id|ir_type
comma
id|ir_codes
)paren
suffix:semicolon
id|ir-&gt;dev.name
op_assign
id|ir-&gt;name
suffix:semicolon
id|ir-&gt;dev.phys
op_assign
id|ir-&gt;phys
suffix:semicolon
id|ir-&gt;dev.id.bustype
op_assign
id|BUS_PCI
suffix:semicolon
id|ir-&gt;dev.id.version
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;pci-&gt;subsystem_vendor
)paren
(brace
id|ir-&gt;dev.id.vendor
op_assign
id|dev-&gt;pci-&gt;subsystem_vendor
suffix:semicolon
id|ir-&gt;dev.id.product
op_assign
id|dev-&gt;pci-&gt;subsystem_device
suffix:semicolon
)brace
r_else
(brace
id|ir-&gt;dev.id.vendor
op_assign
id|dev-&gt;pci-&gt;vendor
suffix:semicolon
id|ir-&gt;dev.id.product
op_assign
id|dev-&gt;pci-&gt;device
suffix:semicolon
)brace
multiline_comment|/* all done */
id|dev-&gt;remote
op_assign
id|ir
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|dev-&gt;remote-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: registered input device for IR&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa7134_input_fini
r_void
id|saa7134_input_fini
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|dev-&gt;remote
)paren
r_return
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|dev-&gt;remote-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev-&gt;remote
)paren
suffix:semicolon
id|dev-&gt;remote
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
