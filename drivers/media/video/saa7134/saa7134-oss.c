multiline_comment|/*&n; * $Id: saa7134-oss.c,v 1.11 2004/11/07 13:17:15 kraxel Exp $&n; *&n; * device driver for philips saa7134 based TV cards&n; * oss dsp interface&n; *&n; * (c) 2001,02 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &quot;saa7134-reg.h&quot;
macro_line|#include &quot;saa7134.h&quot;
multiline_comment|/* ------------------------------------------------------------------ */
DECL|variable|oss_debug
r_static
r_int
r_int
id|oss_debug
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|oss_debug
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|oss_debug
comma
l_string|&quot;enable debug messages [oss]&quot;
)paren
suffix:semicolon
DECL|variable|oss_rate
r_static
r_int
r_int
id|oss_rate
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|oss_rate
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|oss_rate
comma
l_string|&quot;sample rate (valid are: 32000,48000)&quot;
)paren
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(fmt, arg...)&t;if (oss_debug) &bslash;&n;&t;printk(KERN_DEBUG &quot;%s/oss: &quot; fmt, dev-&gt;name , ## arg)
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|dsp_buffer_conf
r_static
r_int
id|dsp_buffer_conf
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
comma
r_int
id|blksize
comma
r_int
id|blocks
)paren
(brace
id|blksize
op_and_assign
op_complement
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|blksize
OL
l_int|0x100
)paren
id|blksize
op_assign
l_int|0x100
suffix:semicolon
r_if
c_cond
(paren
id|blksize
OG
l_int|0x10000
)paren
id|blksize
op_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|blocks
OL
l_int|2
)paren
id|blocks
op_assign
l_int|2
suffix:semicolon
r_while
c_loop
(paren
(paren
id|blksize
op_star
id|blocks
)paren
op_amp
op_complement
id|PAGE_MASK
)paren
id|blocks
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|blksize
op_star
id|blocks
)paren
OG
l_int|1024
op_star
l_int|1024
)paren
id|blocks
op_assign
l_int|1024
op_star
l_int|1024
op_div
id|blksize
suffix:semicolon
id|dev-&gt;oss.blocks
op_assign
id|blocks
suffix:semicolon
id|dev-&gt;oss.blksize
op_assign
id|blksize
suffix:semicolon
id|dev-&gt;oss.bufsize
op_assign
id|blksize
op_star
id|blocks
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;buffer config: %d blocks / %d bytes, %d kB total&bslash;n&quot;
comma
id|blocks
comma
id|blksize
comma
id|blksize
op_star
id|blocks
op_div
l_int|1024
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dsp_buffer_init
r_static
r_int
id|dsp_buffer_init
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;oss.bufsize
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|videobuf_dma_init
c_func
(paren
op_amp
id|dev-&gt;oss.dma
)paren
suffix:semicolon
id|err
op_assign
id|videobuf_dma_init_kernel
c_func
(paren
op_amp
id|dev-&gt;oss.dma
comma
id|PCI_DMA_FROMDEVICE
comma
id|dev-&gt;oss.bufsize
op_rshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
r_return
id|err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dsp_buffer_free
r_static
r_int
id|dsp_buffer_free
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;oss.blksize
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|videobuf_dma_free
c_func
(paren
op_amp
id|dev-&gt;oss.dma
)paren
suffix:semicolon
id|dev-&gt;oss.blocks
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;oss.blksize
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;oss.bufsize
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dsp_dma_start
r_static
r_void
id|dsp_dma_start
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
id|dev-&gt;oss.dma_blk
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;oss.dma_running
op_assign
l_int|1
suffix:semicolon
id|saa7134_set_dmabits
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|dsp_dma_stop
r_static
r_void
id|dsp_dma_stop
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
id|dev-&gt;oss.dma_blk
op_assign
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;oss.dma_running
op_assign
l_int|0
suffix:semicolon
id|saa7134_set_dmabits
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|dsp_rec_start
r_static
r_int
id|dsp_rec_start
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
r_int
id|err
comma
id|bswap
comma
id|sign
suffix:semicolon
id|u32
id|fmt
comma
id|control
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* prepare buffer */
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|err
op_assign
id|videobuf_dma_pci_map
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|dev-&gt;oss.dma
)paren
)paren
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|err
op_assign
id|saa7134_pgtable_alloc
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|dev-&gt;oss.pt
)paren
)paren
)paren
r_goto
id|fail1
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|err
op_assign
id|saa7134_pgtable_build
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|dev-&gt;oss.pt
comma
id|dev-&gt;oss.dma.sglist
comma
id|dev-&gt;oss.dma.sglen
comma
l_int|0
)paren
)paren
)paren
r_goto
id|fail2
suffix:semicolon
multiline_comment|/* sample format */
r_switch
c_cond
(paren
id|dev-&gt;oss.afmt
)paren
(brace
r_case
id|AFMT_U8
suffix:colon
r_case
id|AFMT_S8
suffix:colon
id|fmt
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AFMT_U16_LE
suffix:colon
r_case
id|AFMT_U16_BE
suffix:colon
r_case
id|AFMT_S16_LE
suffix:colon
r_case
id|AFMT_S16_BE
suffix:colon
id|fmt
op_assign
l_int|0x01
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|fail2
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|dev-&gt;oss.afmt
)paren
(brace
r_case
id|AFMT_S8
suffix:colon
r_case
id|AFMT_S16_LE
suffix:colon
r_case
id|AFMT_S16_BE
suffix:colon
id|sign
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sign
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|dev-&gt;oss.afmt
)paren
(brace
r_case
id|AFMT_U16_BE
suffix:colon
r_case
id|AFMT_S16_BE
suffix:colon
id|bswap
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|bswap
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|dev-&gt;pci-&gt;device
)paren
(brace
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7134
suffix:colon
r_if
c_cond
(paren
l_int|1
op_eq
id|dev-&gt;oss.channels
)paren
id|fmt
op_or_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_eq
id|dev-&gt;oss.channels
)paren
id|fmt
op_or_assign
(paren
l_int|3
op_lshift
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sign
)paren
id|fmt
op_or_assign
l_int|0x04
suffix:semicolon
id|fmt
op_or_assign
(paren
id|TV
op_eq
id|dev-&gt;oss.input
)paren
ques
c_cond
l_int|0xc0
suffix:colon
l_int|0x80
suffix:semicolon
id|saa_writeb
c_func
(paren
id|SAA7134_NUM_SAMPLES0
comma
(paren
id|dev-&gt;oss.blksize
op_amp
l_int|0x0000ff
)paren
)paren
suffix:semicolon
id|saa_writeb
c_func
(paren
id|SAA7134_NUM_SAMPLES1
comma
(paren
id|dev-&gt;oss.blksize
op_amp
l_int|0x00ff00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|saa_writeb
c_func
(paren
id|SAA7134_NUM_SAMPLES2
comma
(paren
id|dev-&gt;oss.blksize
op_amp
l_int|0xff0000
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
id|saa_writeb
c_func
(paren
id|SAA7134_AUDIO_FORMAT_CTRL
comma
id|fmt
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7133
suffix:colon
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7135
suffix:colon
r_if
c_cond
(paren
l_int|1
op_eq
id|dev-&gt;oss.channels
)paren
id|fmt
op_or_assign
(paren
l_int|1
op_lshift
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|2
op_eq
id|dev-&gt;oss.channels
)paren
id|fmt
op_or_assign
(paren
l_int|2
op_lshift
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sign
)paren
id|fmt
op_or_assign
l_int|0x04
suffix:semicolon
id|saa_writel
c_func
(paren
l_int|0x588
op_rshift
l_int|2
comma
id|dev-&gt;oss.blksize
op_minus
l_int|4
)paren
suffix:semicolon
id|saa_writel
c_func
(paren
l_int|0x58c
op_rshift
l_int|2
comma
l_int|0x543210
op_or
(paren
id|fmt
op_lshift
l_int|24
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;rec_start: afmt=%d ch=%d  =&gt;  fmt=0x%x swap=%c&bslash;n&quot;
comma
id|dev-&gt;oss.afmt
comma
id|dev-&gt;oss.channels
comma
id|fmt
comma
id|bswap
ques
c_cond
l_char|&squot;b&squot;
suffix:colon
l_char|&squot;-&squot;
)paren
suffix:semicolon
multiline_comment|/* dma: setup channel 6 (= AUDIO) */
id|control
op_assign
id|SAA7134_RS_CONTROL_BURST_16
op_or
id|SAA7134_RS_CONTROL_ME
op_or
(paren
id|dev-&gt;oss.pt.dma
op_rshift
l_int|12
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bswap
)paren
id|control
op_or_assign
id|SAA7134_RS_CONTROL_BSWAP
suffix:semicolon
id|saa_writel
c_func
(paren
id|SAA7134_RS_BA1
c_func
(paren
l_int|6
)paren
comma
l_int|0
)paren
suffix:semicolon
id|saa_writel
c_func
(paren
id|SAA7134_RS_BA2
c_func
(paren
l_int|6
)paren
comma
id|dev-&gt;oss.blksize
)paren
suffix:semicolon
id|saa_writel
c_func
(paren
id|SAA7134_RS_PITCH
c_func
(paren
l_int|6
)paren
comma
l_int|0
)paren
suffix:semicolon
id|saa_writel
c_func
(paren
id|SAA7134_RS_CONTROL
c_func
(paren
l_int|6
)paren
comma
id|control
)paren
suffix:semicolon
multiline_comment|/* start dma */
id|dev-&gt;oss.recording_on
op_assign
l_int|1
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
id|dsp_dma_start
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail2
suffix:colon
id|saa7134_pgtable_free
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|dev-&gt;oss.pt
)paren
suffix:semicolon
id|fail1
suffix:colon
id|videobuf_dma_pci_unmap
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|dev-&gt;oss.dma
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|dsp_rec_stop
r_static
r_int
id|dsp_rec_stop
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;rec_stop dma_blk=%d&bslash;n&quot;
comma
id|dev-&gt;oss.dma_blk
)paren
suffix:semicolon
multiline_comment|/* stop dma */
id|dev-&gt;oss.recording_on
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
id|dsp_dma_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* unlock buffer */
id|saa7134_pgtable_free
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|dev-&gt;oss.pt
)paren
suffix:semicolon
id|videobuf_dma_pci_unmap
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|dev-&gt;oss.dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|dsp_open
r_static
r_int
id|dsp_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|saa7134_dev
op_star
id|h
comma
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
r_int
id|err
suffix:semicolon
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|saa7134_devlist
)paren
(brace
id|h
op_assign
id|list_entry
c_func
(paren
id|list
comma
r_struct
id|saa7134_dev
comma
id|devlist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;oss.minor_dsp
op_eq
id|minor
)paren
id|dev
op_assign
id|h
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;oss.users_dsp
)paren
r_goto
id|fail1
suffix:semicolon
id|dev-&gt;oss.users_dsp
op_increment
suffix:semicolon
id|file-&gt;private_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;oss.afmt
op_assign
id|AFMT_U8
suffix:semicolon
id|dev-&gt;oss.channels
op_assign
l_int|1
suffix:semicolon
id|dev-&gt;oss.read_count
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;oss.read_offset
op_assign
l_int|0
suffix:semicolon
id|dsp_buffer_conf
c_func
(paren
id|dev
comma
id|PAGE_SIZE
comma
l_int|64
)paren
suffix:semicolon
id|err
op_assign
id|dsp_buffer_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|err
)paren
r_goto
id|fail2
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail2
suffix:colon
id|dev-&gt;oss.users_dsp
op_decrement
suffix:semicolon
id|fail1
suffix:colon
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|dsp_release
r_static
r_int
id|dsp_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|saa7134_dev
op_star
id|dev
op_assign
id|file-&gt;private_data
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;oss.recording_on
)paren
id|dsp_rec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dsp_buffer_free
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;oss.users_dsp
op_decrement
suffix:semicolon
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dsp_read
r_static
id|ssize_t
id|dsp_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|saa7134_dev
op_star
id|dev
op_assign
id|file-&gt;private_data
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|bytes
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|dev-&gt;oss.wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
multiline_comment|/* wait for data if needed */
r_if
c_cond
(paren
l_int|0
op_eq
id|dev-&gt;oss.read_count
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;oss.recording_on
)paren
(brace
id|err
op_assign
id|dsp_rec_start
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|ret
)paren
id|ret
op_assign
id|err
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;oss.recording_on
op_logical_and
op_logical_neg
id|dev-&gt;oss.dma_running
)paren
(brace
multiline_comment|/* recover from overruns */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
id|dsp_dma_start
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|ret
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|dev-&gt;oss.read_count
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|ret
)paren
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* copy data to userspace */
id|bytes
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|bytes
OG
id|dev-&gt;oss.read_count
)paren
id|bytes
op_assign
id|dev-&gt;oss.read_count
suffix:semicolon
r_if
c_cond
(paren
id|bytes
OG
id|dev-&gt;oss.bufsize
op_minus
id|dev-&gt;oss.read_offset
)paren
id|bytes
op_assign
id|dev-&gt;oss.bufsize
op_minus
id|dev-&gt;oss.read_offset
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
op_plus
id|ret
comma
id|dev-&gt;oss.dma.vmalloc
op_plus
id|dev-&gt;oss.read_offset
comma
id|bytes
)paren
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ret
op_add_assign
id|bytes
suffix:semicolon
id|count
op_sub_assign
id|bytes
suffix:semicolon
id|dev-&gt;oss.read_count
op_sub_assign
id|bytes
suffix:semicolon
id|dev-&gt;oss.read_offset
op_add_assign
id|bytes
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;oss.read_offset
op_eq
id|dev-&gt;oss.bufsize
)paren
id|dev-&gt;oss.read_offset
op_assign
l_int|0
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dev-&gt;oss.wq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dsp_write
r_static
id|ssize_t
id|dsp_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|dsp_ioctl
r_static
r_int
id|dsp_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|saa7134_dev
op_star
id|dev
op_assign
id|file-&gt;private_data
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|__user
op_star
id|p
op_assign
id|argp
suffix:semicolon
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|oss_debug
OG
l_int|1
)paren
id|saa7134_print_ioctl
c_func
(paren
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_return
id|put_user
c_func
(paren
id|dev-&gt;oss.rate
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
id|dev-&gt;oss.channels
op_assign
id|val
ques
c_cond
l_int|2
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;oss.recording_on
)paren
(brace
id|dsp_rec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dsp_rec_start
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|dev-&gt;oss.channels
op_minus
l_int|1
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|1
op_logical_and
id|val
op_ne
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
id|dev-&gt;oss.channels
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;oss.recording_on
)paren
(brace
id|dsp_rec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dsp_rec_start
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_return
id|put_user
c_func
(paren
id|dev-&gt;oss.channels
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask */
r_return
id|put_user
c_func
(paren
id|AFMT_U8
op_or
id|AFMT_S8
op_or
id|AFMT_U16_LE
op_or
id|AFMT_U16_BE
op_or
id|AFMT_S16_LE
op_or
id|AFMT_S16_BE
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Selects ONE fmt */
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|AFMT_QUERY
suffix:colon
multiline_comment|/* nothing to do */
r_break
suffix:semicolon
r_case
id|AFMT_U8
suffix:colon
r_case
id|AFMT_S8
suffix:colon
r_case
id|AFMT_U16_LE
suffix:colon
r_case
id|AFMT_U16_BE
suffix:colon
r_case
id|AFMT_S16_LE
suffix:colon
r_case
id|AFMT_S16_BE
suffix:colon
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
id|dev-&gt;oss.afmt
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;oss.recording_on
)paren
(brace
id|dsp_rec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dsp_rec_start
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|dev-&gt;oss.afmt
comma
id|p
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_switch
c_cond
(paren
id|dev-&gt;oss.afmt
)paren
(brace
r_case
id|AFMT_U8
suffix:colon
r_case
id|AFMT_S8
suffix:colon
r_return
id|put_user
c_func
(paren
l_int|8
comma
id|p
)paren
suffix:semicolon
r_case
id|AFMT_U16_LE
suffix:colon
r_case
id|AFMT_U16_BE
suffix:colon
r_case
id|AFMT_S16_LE
suffix:colon
r_case
id|AFMT_S16_BE
suffix:colon
r_return
id|put_user
c_func
(paren
l_int|16
comma
id|p
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;oss.recording_on
)paren
id|dsp_rec_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_return
id|put_user
c_func
(paren
id|dev-&gt;oss.blksize
comma
id|p
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;oss.recording_on
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|dsp_buffer_free
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* used to be arg &gt;&gt; 16 instead of val &gt;&gt; 16; fixed */
id|dsp_buffer_conf
c_func
(paren
id|dev
comma
l_int|1
op_lshift
(paren
id|val
op_amp
l_int|0xffff
)paren
comma
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
)paren
suffix:semicolon
id|dsp_buffer_init
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
multiline_comment|/* NOP */
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
(brace
id|audio_buf_info
id|info
suffix:semicolon
id|info.fragsize
op_assign
id|dev-&gt;oss.blksize
suffix:semicolon
id|info.fragstotal
op_assign
id|dev-&gt;oss.blocks
suffix:semicolon
id|info.bytes
op_assign
id|dev-&gt;oss.read_count
suffix:semicolon
id|info.fragments
op_assign
id|info.bytes
op_div
id|info.fragsize
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|dsp_poll
r_static
r_int
r_int
id|dsp_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|saa7134_dev
op_star
id|dev
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|dev-&gt;oss.wq
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|dev-&gt;oss.read_count
)paren
(brace
id|down
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;oss.recording_on
)paren
id|dsp_rec_start
c_func
(paren
id|dev
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
)brace
r_else
id|mask
op_or_assign
(paren
id|POLLIN
op_or
id|POLLRDNORM
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|variable|saa7134_dsp_fops
r_struct
id|file_operations
id|saa7134_dsp_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|dsp_open
comma
dot
id|release
op_assign
id|dsp_release
comma
dot
id|read
op_assign
id|dsp_read
comma
dot
id|write
op_assign
id|dsp_write
comma
dot
id|ioctl
op_assign
id|dsp_ioctl
comma
dot
id|poll
op_assign
id|dsp_poll
comma
dot
id|llseek
op_assign
id|no_llseek
comma
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------ */
r_static
r_int
DECL|function|mixer_recsrc_7134
id|mixer_recsrc_7134
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
r_int
id|analog_io
comma
id|rate
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;oss.input
)paren
(brace
r_case
id|TV
suffix:colon
id|saa_andorb
c_func
(paren
id|SAA7134_AUDIO_FORMAT_CTRL
comma
l_int|0xc0
comma
l_int|0xc0
)paren
suffix:semicolon
id|saa_andorb
c_func
(paren
id|SAA7134_SIF_SAMPLE_FREQ
comma
l_int|0x03
comma
l_int|0x00
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LINE1
suffix:colon
r_case
id|LINE2
suffix:colon
id|analog_io
op_assign
(paren
id|LINE1
op_eq
id|dev-&gt;oss.input
)paren
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x08
suffix:semicolon
id|rate
op_assign
(paren
l_int|32000
op_eq
id|dev-&gt;oss.rate
)paren
ques
c_cond
l_int|0x01
suffix:colon
l_int|0x03
suffix:semicolon
id|saa_andorb
c_func
(paren
id|SAA7134_ANALOG_IO_SELECT
comma
l_int|0x08
comma
id|analog_io
)paren
suffix:semicolon
id|saa_andorb
c_func
(paren
id|SAA7134_AUDIO_FORMAT_CTRL
comma
l_int|0xc0
comma
l_int|0x80
)paren
suffix:semicolon
id|saa_andorb
c_func
(paren
id|SAA7134_SIF_SAMPLE_FREQ
comma
l_int|0x03
comma
id|rate
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|mixer_recsrc_7133
id|mixer_recsrc_7133
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
id|u32
id|value
op_assign
l_int|0xbbbbbb
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;oss.input
)paren
(brace
r_case
id|TV
suffix:colon
id|value
op_assign
l_int|0xbbbb10
suffix:semicolon
multiline_comment|/* MAIN */
r_break
suffix:semicolon
r_case
id|LINE1
suffix:colon
id|value
op_assign
l_int|0xbbbb32
suffix:semicolon
multiline_comment|/* AUX1 */
r_break
suffix:semicolon
r_case
id|LINE2
suffix:colon
id|value
op_assign
l_int|0xbbbb54
suffix:semicolon
multiline_comment|/* AUX2 */
r_break
suffix:semicolon
)brace
id|saa_dsp_writel
c_func
(paren
id|dev
comma
l_int|0x46c
op_rshift
l_int|2
comma
id|value
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|mixer_recsrc
id|mixer_recsrc
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
comma
r_enum
id|saa7134_audio_in
id|src
)paren
(brace
r_static
r_const
r_char
op_star
id|iname
(braket
)braket
op_assign
(brace
l_string|&quot;Oops&quot;
comma
l_string|&quot;TV&quot;
comma
l_string|&quot;LINE1&quot;
comma
l_string|&quot;LINE2&quot;
)brace
suffix:semicolon
id|dev-&gt;oss.count
op_increment
suffix:semicolon
id|dev-&gt;oss.input
op_assign
id|src
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;mixer input = %s&bslash;n&quot;
comma
id|iname
(braket
id|dev-&gt;oss.input
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;pci-&gt;device
)paren
(brace
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7134
suffix:colon
id|mixer_recsrc_7134
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7133
suffix:colon
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7135
suffix:colon
id|mixer_recsrc_7133
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|mixer_level
id|mixer_level
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
comma
r_enum
id|saa7134_audio_in
id|src
comma
r_int
id|level
)paren
(brace
r_switch
c_cond
(paren
id|dev-&gt;pci-&gt;device
)paren
(brace
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7134
suffix:colon
r_switch
c_cond
(paren
id|src
)paren
(brace
r_case
id|TV
suffix:colon
multiline_comment|/* nothing */
r_break
suffix:semicolon
r_case
id|LINE1
suffix:colon
id|saa_andorb
c_func
(paren
id|SAA7134_ANALOG_IO_SELECT
comma
l_int|0x10
comma
(paren
l_int|100
op_eq
id|level
)paren
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x10
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LINE2
suffix:colon
id|saa_andorb
c_func
(paren
id|SAA7134_ANALOG_IO_SELECT
comma
l_int|0x20
comma
(paren
l_int|100
op_eq
id|level
)paren
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7133
suffix:colon
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7135
suffix:colon
multiline_comment|/* nothing */
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|mixer_open
r_static
r_int
id|mixer_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|saa7134_dev
op_star
id|h
comma
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|saa7134_devlist
)paren
(brace
id|h
op_assign
id|list_entry
c_func
(paren
id|list
comma
r_struct
id|saa7134_dev
comma
id|devlist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;oss.minor_mixer
op_eq
id|minor
)paren
id|dev
op_assign
id|h
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|file-&gt;private_data
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mixer_release
r_static
r_int
id|mixer_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mixer_ioctl
r_static
r_int
id|mixer_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|saa7134_dev
op_star
id|dev
op_assign
id|file-&gt;private_data
suffix:semicolon
r_enum
id|saa7134_audio_in
id|input
suffix:semicolon
r_int
id|val
comma
id|ret
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|__user
op_star
id|p
op_assign
id|argp
suffix:semicolon
r_if
c_cond
(paren
id|oss_debug
OG
l_int|1
)paren
id|saa7134_print_ioctl
c_func
(paren
id|dev-&gt;name
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
id|p
)paren
suffix:semicolon
r_case
id|SOUND_MIXER_INFO
suffix:colon
(brace
id|mixer_info
id|info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.id
comma
l_string|&quot;TV audio&quot;
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.name
comma
id|dev-&gt;name
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
id|info.modify_counter
op_assign
id|dev-&gt;oss.count
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|SOUND_OLD_MIXER_INFO
suffix:colon
(brace
id|_old_mixer_info
id|info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.id
comma
l_string|&quot;TV audio&quot;
comma
r_sizeof
(paren
id|info.id
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
id|info.name
comma
id|dev-&gt;name
comma
r_sizeof
(paren
id|info.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_CAPS
)paren
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_CAP_EXCL_INPUT
comma
id|p
)paren
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_STEREODEVS
)paren
suffix:colon
r_return
id|put_user
c_func
(paren
l_int|0
comma
id|p
)paren
suffix:semicolon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_RECMASK
)paren
suffix:colon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_DEVMASK
)paren
suffix:colon
id|val
op_assign
id|SOUND_MASK_LINE1
op_or
id|SOUND_MASK_LINE2
suffix:semicolon
r_if
c_cond
(paren
l_int|32000
op_eq
id|dev-&gt;oss.rate
)paren
id|val
op_or_assign
id|SOUND_MASK_VIDEO
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
id|p
)paren
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_RECSRC
)paren
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|input
op_assign
id|dev-&gt;oss.input
suffix:semicolon
r_if
c_cond
(paren
l_int|32000
op_eq
id|dev-&gt;oss.rate
op_logical_and
id|val
op_amp
id|SOUND_MASK_VIDEO
op_logical_and
id|dev-&gt;oss.input
op_ne
id|TV
)paren
id|input
op_assign
id|TV
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|SOUND_MASK_LINE1
op_logical_and
id|dev-&gt;oss.input
op_ne
id|LINE1
)paren
id|input
op_assign
id|LINE1
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|SOUND_MASK_LINE2
op_logical_and
id|dev-&gt;oss.input
op_ne
id|LINE2
)paren
id|input
op_assign
id|LINE2
suffix:semicolon
r_if
c_cond
(paren
id|input
op_ne
id|dev-&gt;oss.input
)paren
id|mixer_recsrc
c_func
(paren
id|dev
comma
id|input
)paren
suffix:semicolon
multiline_comment|/* fall throuth */
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_RECSRC
)paren
suffix:colon
r_switch
c_cond
(paren
id|dev-&gt;oss.input
)paren
(brace
r_case
id|TV
suffix:colon
id|ret
op_assign
id|SOUND_MASK_VIDEO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LINE1
suffix:colon
id|ret
op_assign
id|SOUND_MASK_LINE1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LINE2
suffix:colon
id|ret
op_assign
id|SOUND_MASK_LINE2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|put_user
c_func
(paren
id|ret
comma
id|p
)paren
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_VIDEO
)paren
suffix:colon
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_VIDEO
)paren
suffix:colon
r_if
c_cond
(paren
l_int|32000
op_ne
id|dev-&gt;oss.rate
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|put_user
c_func
(paren
l_int|100
op_or
l_int|100
op_lshift
l_int|8
comma
id|p
)paren
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_LINE1
)paren
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_and_assign
l_int|0xff
suffix:semicolon
id|val
op_assign
(paren
id|val
op_le
l_int|50
)paren
ques
c_cond
l_int|50
suffix:colon
l_int|100
suffix:semicolon
id|dev-&gt;oss.line1
op_assign
id|val
suffix:semicolon
id|mixer_level
c_func
(paren
id|dev
comma
id|LINE1
comma
id|dev-&gt;oss.line1
)paren
suffix:semicolon
multiline_comment|/* fall throuth */
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_LINE1
)paren
suffix:colon
r_return
id|put_user
c_func
(paren
id|dev-&gt;oss.line1
op_or
id|dev-&gt;oss.line1
op_lshift
l_int|8
comma
id|p
)paren
suffix:semicolon
r_case
id|MIXER_WRITE
c_func
(paren
id|SOUND_MIXER_LINE2
)paren
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|val
op_and_assign
l_int|0xff
suffix:semicolon
id|val
op_assign
(paren
id|val
op_le
l_int|50
)paren
ques
c_cond
l_int|50
suffix:colon
l_int|100
suffix:semicolon
id|dev-&gt;oss.line2
op_assign
id|val
suffix:semicolon
id|mixer_level
c_func
(paren
id|dev
comma
id|LINE2
comma
id|dev-&gt;oss.line2
)paren
suffix:semicolon
multiline_comment|/* fall throuth */
r_case
id|MIXER_READ
c_func
(paren
id|SOUND_MIXER_LINE2
)paren
suffix:colon
r_return
id|put_user
c_func
(paren
id|dev-&gt;oss.line2
op_or
id|dev-&gt;oss.line2
op_lshift
l_int|8
comma
id|p
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|variable|saa7134_mixer_fops
r_struct
id|file_operations
id|saa7134_mixer_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|mixer_open
comma
dot
id|release
op_assign
id|mixer_release
comma
dot
id|ioctl
op_assign
id|mixer_ioctl
comma
dot
id|llseek
op_assign
id|no_llseek
comma
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|saa7134_oss_init1
r_int
id|saa7134_oss_init1
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
multiline_comment|/* general */
id|init_MUTEX
c_func
(paren
op_amp
id|dev-&gt;oss.lock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev-&gt;oss.wq
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;pci-&gt;device
)paren
(brace
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7133
suffix:colon
r_case
id|PCI_DEVICE_ID_PHILIPS_SAA7135
suffix:colon
id|saa_writel
c_func
(paren
l_int|0x588
op_rshift
l_int|2
comma
l_int|0x00000fff
)paren
suffix:semicolon
id|saa_writel
c_func
(paren
l_int|0x58c
op_rshift
l_int|2
comma
l_int|0x00543210
)paren
suffix:semicolon
id|saa_dsp_writel
c_func
(paren
id|dev
comma
l_int|0x46c
op_rshift
l_int|2
comma
l_int|0xbbbbbb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* dsp */
id|dev-&gt;oss.rate
op_assign
l_int|32000
suffix:semicolon
r_if
c_cond
(paren
id|oss_rate
)paren
id|dev-&gt;oss.rate
op_assign
id|oss_rate
suffix:semicolon
id|dev-&gt;oss.rate
op_assign
(paren
id|dev-&gt;oss.rate
OG
l_int|40000
)paren
ques
c_cond
l_int|48000
suffix:colon
l_int|32000
suffix:semicolon
multiline_comment|/* mixer */
id|dev-&gt;oss.line1
op_assign
l_int|50
suffix:semicolon
id|dev-&gt;oss.line2
op_assign
l_int|50
suffix:semicolon
id|mixer_level
c_func
(paren
id|dev
comma
id|LINE1
comma
id|dev-&gt;oss.line1
)paren
suffix:semicolon
id|mixer_level
c_func
(paren
id|dev
comma
id|LINE2
comma
id|dev-&gt;oss.line2
)paren
suffix:semicolon
id|mixer_recsrc
c_func
(paren
id|dev
comma
(paren
id|dev-&gt;oss.rate
op_eq
l_int|32000
)paren
ques
c_cond
id|TV
suffix:colon
id|LINE2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa7134_oss_fini
r_int
id|saa7134_oss_fini
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
)paren
(brace
multiline_comment|/* nothing */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa7134_irq_oss_done
r_void
id|saa7134_irq_oss_done
c_func
(paren
r_struct
id|saa7134_dev
op_star
id|dev
comma
r_int
r_int
id|status
)paren
(brace
r_int
id|next_blk
comma
id|reg
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dev-&gt;slock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UNSET
op_eq
id|dev-&gt;oss.dma_blk
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;irq: recording stopped&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|status
op_amp
l_int|0x0f000000
)paren
)paren
id|dprintk
c_func
(paren
l_string|&quot;irq: lost %ld&bslash;n&quot;
comma
(paren
id|status
op_rshift
l_int|24
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
(paren
id|status
op_amp
l_int|0x10000000
)paren
)paren
(brace
multiline_comment|/* odd */
r_if
c_cond
(paren
l_int|0
op_eq
(paren
id|dev-&gt;oss.dma_blk
op_amp
l_int|0x01
)paren
)paren
id|reg
op_assign
id|SAA7134_RS_BA1
c_func
(paren
l_int|6
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* even */
r_if
c_cond
(paren
l_int|0
op_eq
(paren
id|dev-&gt;oss.dma_blk
op_amp
l_int|0x00
)paren
)paren
id|reg
op_assign
id|SAA7134_RS_BA2
c_func
(paren
l_int|6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|reg
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;irq: field oops [%s]&bslash;n&quot;
comma
(paren
id|status
op_amp
l_int|0x10000000
)paren
ques
c_cond
l_string|&quot;even&quot;
suffix:colon
l_string|&quot;odd&quot;
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;oss.read_count
op_ge
id|dev-&gt;oss.blksize
op_star
(paren
id|dev-&gt;oss.blocks
op_minus
l_int|2
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;irq: overrun [full=%d/%d]&bslash;n&quot;
comma
id|dev-&gt;oss.read_count
comma
id|dev-&gt;oss.bufsize
)paren
suffix:semicolon
id|dsp_dma_stop
c_func
(paren
id|dev
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/* next block addr */
id|next_blk
op_assign
(paren
id|dev-&gt;oss.dma_blk
op_plus
l_int|2
)paren
op_mod
id|dev-&gt;oss.blocks
suffix:semicolon
id|saa_writel
c_func
(paren
id|reg
comma
id|next_blk
op_star
id|dev-&gt;oss.blksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oss_debug
OG
l_int|2
)paren
id|dprintk
c_func
(paren
l_string|&quot;irq: ok, %s, next_blk=%d, addr=%x&bslash;n&quot;
comma
(paren
id|status
op_amp
l_int|0x10000000
)paren
ques
c_cond
l_string|&quot;even&quot;
suffix:colon
l_string|&quot;odd &quot;
comma
id|next_blk
comma
id|next_blk
op_star
id|dev-&gt;oss.blksize
)paren
suffix:semicolon
multiline_comment|/* update status &amp; wake waiting readers */
id|dev-&gt;oss.dma_blk
op_assign
(paren
id|dev-&gt;oss.dma_blk
op_plus
l_int|1
)paren
op_mod
id|dev-&gt;oss.blocks
suffix:semicolon
id|dev-&gt;oss.read_count
op_add_assign
id|dev-&gt;oss.blksize
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|dev-&gt;oss.wq
)paren
suffix:semicolon
id|done
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|dev-&gt;slock
)paren
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------- */
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
