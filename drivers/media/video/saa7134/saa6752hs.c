macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;media/id.h&gt;
DECL|macro|MPEG_VIDEO_TARGET_BITRATE_MAX
mdefine_line|#define MPEG_VIDEO_TARGET_BITRATE_MAX  27000
DECL|macro|MPEG_VIDEO_MAX_BITRATE_MAX
mdefine_line|#define MPEG_VIDEO_MAX_BITRATE_MAX     27000
DECL|macro|MPEG_TOTAL_TARGET_BITRATE_MAX
mdefine_line|#define MPEG_TOTAL_TARGET_BITRATE_MAX  27000
DECL|macro|MPEG_PID_MAX
mdefine_line|#define MPEG_PID_MAX ((1 &lt;&lt; 14) - 1)
multiline_comment|/* Addresses to scan */
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
l_int|0x20
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_i2c_range
r_static
r_int
r_int
id|normal_i2c_range
(braket
)braket
op_assign
(brace
id|I2C_CLIENT_END
)brace
suffix:semicolon
id|I2C_CLIENT_INSMOD
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;device driver for saa6752hs MPEG2 encoder&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Andrew de Quincey&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
suffix:semicolon
DECL|struct|saa6752hs_state
r_struct
id|saa6752hs_state
(brace
DECL|member|client
r_struct
id|i2c_client
id|client
suffix:semicolon
DECL|member|params
r_struct
id|v4l2_mpeg_compression
id|params
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|saa6752hs_command
r_enum
id|saa6752hs_command
(brace
DECL|enumerator|SAA6752HS_COMMAND_RESET
id|SAA6752HS_COMMAND_RESET
op_assign
l_int|0
comma
DECL|enumerator|SAA6752HS_COMMAND_STOP
id|SAA6752HS_COMMAND_STOP
op_assign
l_int|1
comma
DECL|enumerator|SAA6752HS_COMMAND_START
id|SAA6752HS_COMMAND_START
op_assign
l_int|2
comma
DECL|enumerator|SAA6752HS_COMMAND_PAUSE
id|SAA6752HS_COMMAND_PAUSE
op_assign
l_int|3
comma
DECL|enumerator|SAA6752HS_COMMAND_RECONFIGURE
id|SAA6752HS_COMMAND_RECONFIGURE
op_assign
l_int|4
comma
DECL|enumerator|SAA6752HS_COMMAND_SLEEP
id|SAA6752HS_COMMAND_SLEEP
op_assign
l_int|5
comma
DECL|enumerator|SAA6752HS_COMMAND_RECONFIGURE_FORCE
id|SAA6752HS_COMMAND_RECONFIGURE_FORCE
op_assign
l_int|6
comma
DECL|enumerator|SAA6752HS_COMMAND_MAX
id|SAA6752HS_COMMAND_MAX
)brace
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|variable|PAT
r_static
id|u8
id|PAT
(braket
)braket
op_assign
(brace
l_int|0xc2
comma
singleline_comment|// i2c register
l_int|0x00
comma
singleline_comment|// table number for encoder
l_int|0x47
comma
singleline_comment|// sync
l_int|0x40
comma
l_int|0x00
comma
singleline_comment|// transport_error_indicator(0), payload_unit_start(1), transport_priority(0), pid(0)
l_int|0x10
comma
singleline_comment|// transport_scrambling_control(00), adaptation_field_control(01), continuity_counter(0)
l_int|0x00
comma
singleline_comment|// PSI pointer to start of table
l_int|0x00
comma
singleline_comment|// tid(0)
l_int|0xb0
comma
l_int|0x0d
comma
singleline_comment|// section_syntax_indicator(1), section_length(13)
l_int|0x00
comma
l_int|0x01
comma
singleline_comment|// transport_stream_id(1)
l_int|0xc1
comma
singleline_comment|// version_number(0), current_next_indicator(1)
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// section_number(0), last_section_number(0)
l_int|0x00
comma
l_int|0x01
comma
singleline_comment|// program_number(1)
l_int|0xe0
comma
l_int|0x00
comma
singleline_comment|// PMT PID
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
singleline_comment|// CRC32
)brace
suffix:semicolon
DECL|variable|PMT
r_static
id|u8
id|PMT
(braket
)braket
op_assign
(brace
l_int|0xc2
comma
singleline_comment|// i2c register
l_int|0x01
comma
singleline_comment|// table number for encoder
l_int|0x47
comma
singleline_comment|// sync
l_int|0x40
comma
l_int|0x00
comma
singleline_comment|// transport_error_indicator(0), payload_unit_start(1), transport_priority(0), pid
l_int|0x10
comma
singleline_comment|// transport_scrambling_control(00), adaptation_field_control(01), continuity_counter(0)
l_int|0x00
comma
singleline_comment|// PSI pointer to start of table
l_int|0x02
comma
singleline_comment|// tid(2)
l_int|0xb0
comma
l_int|0x17
comma
singleline_comment|// section_syntax_indicator(1), section_length(23)
l_int|0x00
comma
l_int|0x01
comma
singleline_comment|// program_number(1)
l_int|0xc1
comma
singleline_comment|// version_number(0), current_next_indicator(1)
l_int|0x00
comma
l_int|0x00
comma
singleline_comment|// section_number(0), last_section_number(0)
l_int|0xe0
comma
l_int|0x00
comma
singleline_comment|// PCR_PID
l_int|0xf0
comma
l_int|0x00
comma
singleline_comment|// program_info_length(0)
l_int|0x02
comma
l_int|0xe0
comma
l_int|0x00
comma
l_int|0xf0
comma
l_int|0x00
comma
singleline_comment|// video stream type(2), pid
l_int|0x04
comma
l_int|0xe0
comma
l_int|0x00
comma
l_int|0xf0
comma
l_int|0x00
comma
singleline_comment|// audio stream type(4), pid
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
singleline_comment|// CRC32
)brace
suffix:semicolon
DECL|variable|param_defaults
r_static
r_struct
id|v4l2_mpeg_compression
id|param_defaults
op_assign
(brace
dot
id|st_type
op_assign
id|V4L2_MPEG_TS_2
comma
dot
id|st_bitrate
op_assign
(brace
dot
id|mode
op_assign
id|V4L2_BITRATE_CBR
comma
dot
id|target
op_assign
l_int|7000
comma
)brace
comma
dot
id|ts_pid_pmt
op_assign
l_int|16
comma
dot
id|ts_pid_video
op_assign
l_int|260
comma
dot
id|ts_pid_audio
op_assign
l_int|256
comma
dot
id|ts_pid_pcr
op_assign
l_int|259
comma
dot
id|vi_type
op_assign
id|V4L2_MPEG_VI_2
comma
dot
id|vi_aspect_ratio
op_assign
id|V4L2_MPEG_ASPECT_4_3
comma
dot
id|vi_bitrate
op_assign
(brace
dot
id|mode
op_assign
id|V4L2_BITRATE_VBR
comma
dot
id|target
op_assign
l_int|4000
comma
dot
id|max
op_assign
l_int|6000
comma
)brace
comma
dot
id|au_type
op_assign
id|V4L2_MPEG_AU_2_II
comma
dot
id|au_bitrate
op_assign
(brace
dot
id|mode
op_assign
id|V4L2_BITRATE_CBR
comma
dot
id|target
op_assign
l_int|256
comma
)brace
comma
macro_line|#if 0
multiline_comment|/* FIXME: size? via S_FMT? */
dot
id|video_format
op_assign
id|MPEG_VIDEO_FORMAT_D1
comma
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/* ---------------------------------------------------------------------- */
DECL|function|saa6752hs_chip_command
r_static
r_int
id|saa6752hs_chip_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_enum
id|saa6752hs_command
id|command
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|3
)braket
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
singleline_comment|// execute the command
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|SAA6752HS_COMMAND_RESET
suffix:colon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA6752HS_COMMAND_STOP
suffix:colon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x03
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA6752HS_COMMAND_START
suffix:colon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x02
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA6752HS_COMMAND_PAUSE
suffix:colon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x04
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA6752HS_COMMAND_RECONFIGURE
suffix:colon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x05
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA6752HS_COMMAND_SLEEP
suffix:colon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x06
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SAA6752HS_COMMAND_RECONFIGURE_FORCE
suffix:colon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x07
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|// set it and wait for it to be so
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|timeout
op_assign
id|jiffies
op_plus
id|HZ
op_star
l_int|3
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
singleline_comment|// get the current status
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x10
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
id|i2c_master_recv
c_func
(paren
id|client
comma
id|buf
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
(braket
l_int|0
)braket
op_amp
l_int|0x20
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
(brace
id|status
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// wait a bit
id|msleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
singleline_comment|// delay a bit to let encoder settle
id|msleep
c_func
(paren
l_int|50
)paren
suffix:semicolon
singleline_comment|// done
r_return
id|status
suffix:semicolon
)brace
DECL|function|saa6752hs_set_bitrate
r_static
r_int
id|saa6752hs_set_bitrate
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_struct
id|v4l2_mpeg_compression
op_star
id|params
)paren
(brace
id|u8
id|buf
(braket
l_int|3
)braket
suffix:semicolon
singleline_comment|// set the bitrate mode
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x71
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
(paren
id|params-&gt;vi_bitrate.mode
op_eq
id|V4L2_BITRATE_VBR
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// set the video bitrate
r_if
c_cond
(paren
id|params-&gt;vi_bitrate.mode
op_eq
id|V4L2_BITRATE_VBR
)paren
(brace
singleline_comment|// set the target bitrate
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x80
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|params-&gt;vi_bitrate.target
op_rshift
l_int|8
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|params-&gt;vi_bitrate.target
op_amp
l_int|0xff
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
singleline_comment|// set the max bitrate
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x81
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|params-&gt;vi_bitrate.max
op_rshift
l_int|8
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|params-&gt;vi_bitrate.max
op_amp
l_int|0xff
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
)brace
r_else
(brace
singleline_comment|// set the target bitrate (no max bitrate for CBR)
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x81
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|params-&gt;vi_bitrate.target
op_rshift
l_int|8
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|params-&gt;vi_bitrate.target
op_amp
l_int|0xff
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
)brace
singleline_comment|// set the audio bitrate
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x94
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
(paren
l_int|256
op_eq
id|params-&gt;au_bitrate.target
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// set the total bitrate
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xb1
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
id|params-&gt;st_bitrate.target
op_rshift
l_int|8
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|params-&gt;st_bitrate.target
op_amp
l_int|0xff
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
singleline_comment|// return success
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa6752hs_set_params
r_static
r_void
id|saa6752hs_set_params
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_struct
id|v4l2_mpeg_compression
op_star
id|params
)paren
(brace
r_struct
id|saa6752hs_state
op_star
id|h
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
multiline_comment|/* check PIDs */
r_if
c_cond
(paren
id|params-&gt;ts_pid_pmt
op_le
id|MPEG_PID_MAX
)paren
id|h-&gt;params.ts_pid_pmt
op_assign
id|params-&gt;ts_pid_pmt
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;ts_pid_pcr
op_le
id|MPEG_PID_MAX
)paren
id|h-&gt;params.ts_pid_pcr
op_assign
id|params-&gt;ts_pid_pcr
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;ts_pid_video
op_le
id|MPEG_PID_MAX
)paren
id|h-&gt;params.ts_pid_video
op_assign
id|params-&gt;ts_pid_video
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;ts_pid_audio
op_le
id|MPEG_PID_MAX
)paren
id|h-&gt;params.ts_pid_audio
op_assign
id|params-&gt;ts_pid_audio
suffix:semicolon
multiline_comment|/* check bitrate parameters */
r_if
c_cond
(paren
(paren
id|params-&gt;vi_bitrate.mode
op_eq
id|V4L2_BITRATE_CBR
)paren
op_logical_or
(paren
id|params-&gt;vi_bitrate.mode
op_eq
id|V4L2_BITRATE_VBR
)paren
)paren
id|h-&gt;params.vi_bitrate.mode
op_assign
id|params-&gt;vi_bitrate.mode
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;vi_bitrate.mode
op_ne
id|V4L2_BITRATE_NONE
)paren
id|h-&gt;params.st_bitrate.target
op_assign
id|params-&gt;st_bitrate.target
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;vi_bitrate.mode
op_ne
id|V4L2_BITRATE_NONE
)paren
id|h-&gt;params.vi_bitrate.target
op_assign
id|params-&gt;vi_bitrate.target
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;vi_bitrate.mode
op_eq
id|V4L2_BITRATE_VBR
)paren
id|h-&gt;params.vi_bitrate.max
op_assign
id|params-&gt;vi_bitrate.max
suffix:semicolon
r_if
c_cond
(paren
id|params-&gt;au_bitrate.mode
op_ne
id|V4L2_BITRATE_NONE
)paren
id|h-&gt;params.au_bitrate.target
op_assign
id|params-&gt;au_bitrate.target
suffix:semicolon
multiline_comment|/* aspect ratio */
r_if
c_cond
(paren
id|params-&gt;vi_aspect_ratio
op_eq
id|V4L2_MPEG_ASPECT_4_3
op_logical_or
id|params-&gt;vi_aspect_ratio
op_eq
id|V4L2_MPEG_ASPECT_16_9
)paren
id|h-&gt;params.vi_aspect_ratio
op_assign
id|params-&gt;vi_aspect_ratio
suffix:semicolon
multiline_comment|/* range checks */
r_if
c_cond
(paren
id|h-&gt;params.st_bitrate.target
OG
id|MPEG_TOTAL_TARGET_BITRATE_MAX
)paren
id|h-&gt;params.st_bitrate.target
op_assign
id|MPEG_TOTAL_TARGET_BITRATE_MAX
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;params.vi_bitrate.target
OG
id|MPEG_VIDEO_TARGET_BITRATE_MAX
)paren
id|h-&gt;params.vi_bitrate.target
op_assign
id|MPEG_VIDEO_TARGET_BITRATE_MAX
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;params.vi_bitrate.max
OG
id|MPEG_VIDEO_MAX_BITRATE_MAX
)paren
id|h-&gt;params.vi_bitrate.max
op_assign
id|MPEG_VIDEO_MAX_BITRATE_MAX
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;params.au_bitrate.target
op_le
l_int|256
)paren
id|h-&gt;params.au_bitrate.target
op_assign
l_int|256
suffix:semicolon
r_else
id|h-&gt;params.au_bitrate.target
op_assign
l_int|384
suffix:semicolon
)brace
DECL|function|saa6752hs_init
r_static
r_int
id|saa6752hs_init
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
r_char
id|buf
(braket
l_int|9
)braket
comma
id|buf2
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|saa6752hs_state
op_star
id|h
suffix:semicolon
id|u32
id|crc
suffix:semicolon
r_int
r_char
id|localPAT
(braket
l_int|256
)braket
suffix:semicolon
r_int
r_char
id|localPMT
(braket
l_int|256
)braket
suffix:semicolon
id|h
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
singleline_comment|// Set video format - must be done first as it resets other settings
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x41
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0
multiline_comment|/* MPEG_VIDEO_FORMAT_D1 */
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// set bitrate
id|saa6752hs_set_bitrate
c_func
(paren
id|client
comma
op_amp
id|h-&gt;params
)paren
suffix:semicolon
singleline_comment|// Set GOP structure {3, 13}
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x72
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x03
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0x0D
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
singleline_comment|// Set minimum Q-scale {4}
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x82
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// Set maximum Q-scale {12}
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0x83
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x0C
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// Set Output Protocol
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xD0
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x81
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// Set video output stream format {TS}
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xB0
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0x05
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* compute PAT */
id|memcpy
c_func
(paren
id|localPAT
comma
id|PAT
comma
r_sizeof
(paren
id|PAT
)paren
)paren
suffix:semicolon
id|localPAT
(braket
l_int|17
)braket
op_assign
l_int|0xe0
op_or
(paren
(paren
id|h-&gt;params.ts_pid_pmt
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|localPAT
(braket
l_int|18
)braket
op_assign
id|h-&gt;params.ts_pid_pmt
op_amp
l_int|0xff
suffix:semicolon
id|crc
op_assign
id|crc32_be
c_func
(paren
op_complement
l_int|0
comma
op_amp
id|localPAT
(braket
l_int|7
)braket
comma
r_sizeof
(paren
id|PAT
)paren
op_minus
l_int|7
op_minus
l_int|4
)paren
suffix:semicolon
id|localPAT
(braket
r_sizeof
(paren
id|PAT
)paren
op_minus
l_int|4
)braket
op_assign
(paren
id|crc
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|localPAT
(braket
r_sizeof
(paren
id|PAT
)paren
op_minus
l_int|3
)braket
op_assign
(paren
id|crc
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|localPAT
(braket
r_sizeof
(paren
id|PAT
)paren
op_minus
l_int|2
)braket
op_assign
(paren
id|crc
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|localPAT
(braket
r_sizeof
(paren
id|PAT
)paren
op_minus
l_int|1
)braket
op_assign
id|crc
op_amp
l_int|0xFF
suffix:semicolon
multiline_comment|/* compute PMT */
id|memcpy
c_func
(paren
id|localPMT
comma
id|PMT
comma
r_sizeof
(paren
id|PMT
)paren
)paren
suffix:semicolon
id|localPMT
(braket
l_int|3
)braket
op_assign
l_int|0x40
op_or
(paren
(paren
id|h-&gt;params.ts_pid_pmt
op_rshift
l_int|8
)paren
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|localPMT
(braket
l_int|4
)braket
op_assign
id|h-&gt;params.ts_pid_pmt
op_amp
l_int|0xff
suffix:semicolon
id|localPMT
(braket
l_int|15
)braket
op_assign
l_int|0xE0
op_or
(paren
(paren
id|h-&gt;params.ts_pid_pcr
op_rshift
l_int|8
)paren
op_amp
l_int|0x0F
)paren
suffix:semicolon
id|localPMT
(braket
l_int|16
)braket
op_assign
id|h-&gt;params.ts_pid_pcr
op_amp
l_int|0xFF
suffix:semicolon
id|localPMT
(braket
l_int|20
)braket
op_assign
l_int|0xE0
op_or
(paren
(paren
id|h-&gt;params.ts_pid_video
op_rshift
l_int|8
)paren
op_amp
l_int|0x0F
)paren
suffix:semicolon
id|localPMT
(braket
l_int|21
)braket
op_assign
id|h-&gt;params.ts_pid_video
op_amp
l_int|0xFF
suffix:semicolon
id|localPMT
(braket
l_int|25
)braket
op_assign
l_int|0xE0
op_or
(paren
(paren
id|h-&gt;params.ts_pid_audio
op_rshift
l_int|8
)paren
op_amp
l_int|0x0F
)paren
suffix:semicolon
id|localPMT
(braket
l_int|26
)braket
op_assign
id|h-&gt;params.ts_pid_audio
op_amp
l_int|0xFF
suffix:semicolon
id|crc
op_assign
id|crc32_be
c_func
(paren
op_complement
l_int|0
comma
op_amp
id|localPMT
(braket
l_int|7
)braket
comma
r_sizeof
(paren
id|PMT
)paren
op_minus
l_int|7
op_minus
l_int|4
)paren
suffix:semicolon
id|localPMT
(braket
r_sizeof
(paren
id|PMT
)paren
op_minus
l_int|4
)braket
op_assign
(paren
id|crc
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|localPMT
(braket
r_sizeof
(paren
id|PMT
)paren
op_minus
l_int|3
)braket
op_assign
(paren
id|crc
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|localPMT
(braket
r_sizeof
(paren
id|PMT
)paren
op_minus
l_int|2
)braket
op_assign
(paren
id|crc
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|localPMT
(braket
r_sizeof
(paren
id|PMT
)paren
op_minus
l_int|1
)braket
op_assign
id|crc
op_amp
l_int|0xFF
suffix:semicolon
singleline_comment|// Set Audio PID
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xC1
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
(paren
id|h-&gt;params.ts_pid_audio
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|h-&gt;params.ts_pid_audio
op_amp
l_int|0xFF
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
singleline_comment|// Set Video PID
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xC0
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
(paren
id|h-&gt;params.ts_pid_video
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|h-&gt;params.ts_pid_video
op_amp
l_int|0xFF
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
singleline_comment|// Set PCR PID
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xC4
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
(paren
id|h-&gt;params.ts_pid_pcr
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
id|h-&gt;params.ts_pid_pcr
op_amp
l_int|0xFF
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|3
)paren
suffix:semicolon
singleline_comment|// Send SI tables
id|i2c_master_send
c_func
(paren
id|client
comma
id|localPAT
comma
r_sizeof
(paren
id|PAT
)paren
)paren
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|localPMT
comma
r_sizeof
(paren
id|PMT
)paren
)paren
suffix:semicolon
singleline_comment|// mute then unmute audio. This removes buzzing artefacts
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xa4
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|1
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|2
)paren
suffix:semicolon
singleline_comment|// start it going
id|saa6752hs_chip_command
c_func
(paren
id|client
comma
id|SAA6752HS_COMMAND_START
)paren
suffix:semicolon
singleline_comment|// readout current state
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xE1
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0xA7
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0xFE
suffix:semicolon
id|buf
(braket
l_int|3
)braket
op_assign
l_int|0x82
suffix:semicolon
id|buf
(braket
l_int|4
)braket
op_assign
l_int|0xB0
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|5
)paren
suffix:semicolon
id|i2c_master_recv
c_func
(paren
id|client
comma
id|buf2
comma
l_int|4
)paren
suffix:semicolon
singleline_comment|// change aspect ratio
id|buf
(braket
l_int|0
)braket
op_assign
l_int|0xE0
suffix:semicolon
id|buf
(braket
l_int|1
)braket
op_assign
l_int|0xA7
suffix:semicolon
id|buf
(braket
l_int|2
)braket
op_assign
l_int|0xFE
suffix:semicolon
id|buf
(braket
l_int|3
)braket
op_assign
l_int|0x82
suffix:semicolon
id|buf
(braket
l_int|4
)braket
op_assign
l_int|0xB0
suffix:semicolon
id|buf
(braket
l_int|5
)braket
op_assign
id|buf2
(braket
l_int|0
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|h-&gt;params.vi_aspect_ratio
)paren
(brace
r_case
id|V4L2_MPEG_ASPECT_16_9
suffix:colon
id|buf
(braket
l_int|6
)braket
op_assign
id|buf2
(braket
l_int|1
)braket
op_or
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_MPEG_ASPECT_4_3
suffix:colon
r_default
suffix:colon
id|buf
(braket
l_int|6
)braket
op_assign
id|buf2
(braket
l_int|1
)braket
op_amp
l_int|0xBF
suffix:semicolon
r_break
suffix:semicolon
r_break
suffix:semicolon
)brace
id|buf
(braket
l_int|7
)braket
op_assign
id|buf2
(braket
l_int|2
)braket
suffix:semicolon
id|buf
(braket
l_int|8
)braket
op_assign
id|buf2
(braket
l_int|3
)braket
suffix:semicolon
id|i2c_master_send
c_func
(paren
id|client
comma
id|buf
comma
l_int|9
)paren
suffix:semicolon
singleline_comment|// return success
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa6752hs_attach
r_static
r_int
id|saa6752hs_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_int
id|addr
comma
r_int
id|kind
)paren
(brace
r_struct
id|saa6752hs_state
op_star
id|h
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;saa6752hs: chip found @ 0x%x&bslash;n&quot;
comma
id|addr
op_lshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
id|h
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|h
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|h
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|h
)paren
)paren
suffix:semicolon
id|h-&gt;client
op_assign
id|client_template
suffix:semicolon
id|h-&gt;params
op_assign
id|param_defaults
suffix:semicolon
id|h-&gt;client.adapter
op_assign
id|adap
suffix:semicolon
id|h-&gt;client.addr
op_assign
id|addr
suffix:semicolon
id|i2c_set_clientdata
c_func
(paren
op_amp
id|h-&gt;client
comma
id|h
)paren
suffix:semicolon
id|i2c_attach_client
c_func
(paren
op_amp
id|h-&gt;client
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa6752hs_probe
r_static
r_int
id|saa6752hs_probe
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_if
c_cond
(paren
id|adap
op_member_access_from_pointer
r_class
op_amp
id|I2C_CLASS_TV_ANALOG
)paren
r_return
id|i2c_probe
c_func
(paren
id|adap
comma
op_amp
id|addr_data
comma
id|saa6752hs_attach
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|saa6752hs_detach
r_static
r_int
id|saa6752hs_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|saa6752hs_state
op_star
id|h
suffix:semicolon
id|h
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
id|i2c_detach_client
c_func
(paren
id|client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|h
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|saa6752hs_command
id|saa6752hs_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|saa6752hs_state
op_star
id|h
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_struct
id|v4l2_mpeg_compression
op_star
id|params
op_assign
id|arg
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOC_S_MPEGCOMP
suffix:colon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|params
)paren
(brace
multiline_comment|/* apply settings and start encoder */
id|saa6752hs_init
c_func
(paren
id|client
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|saa6752hs_set_params
c_func
(paren
id|client
comma
id|params
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|VIDIOC_G_MPEGCOMP
suffix:colon
op_star
id|params
op_assign
id|h-&gt;params
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* nothing */
r_break
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;i2c saa6752hs MPEG encoder&quot;
comma
dot
id|id
op_assign
id|I2C_DRIVERID_SAA6752HS
comma
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
id|saa6752hs_probe
comma
dot
id|detach_client
op_assign
id|saa6752hs_detach
comma
dot
id|command
op_assign
id|saa6752hs_command
comma
)brace
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
op_assign
(brace
id|I2C_DEVNAME
c_func
(paren
l_string|&quot;saa6752hs&quot;
)paren
comma
dot
id|flags
op_assign
id|I2C_CLIENT_ALLOW_USE
comma
dot
id|driver
op_assign
op_amp
id|driver
comma
)brace
suffix:semicolon
DECL|function|saa6752hs_init_module
r_static
r_int
id|__init
id|saa6752hs_init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|i2c_add_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|function|saa6752hs_cleanup_module
r_static
r_void
id|__exit
id|saa6752hs_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|variable|saa6752hs_init_module
id|module_init
c_func
(paren
id|saa6752hs_init_module
)paren
suffix:semicolon
DECL|variable|saa6752hs_cleanup_module
id|module_exit
c_func
(paren
id|saa6752hs_cleanup_module
)paren
suffix:semicolon
multiline_comment|/*&n; * Overrides for Emacs so that we follow Linus&squot;s tabbing style.&n; * ---------------------------------------------------------------------------&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
