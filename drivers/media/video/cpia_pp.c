multiline_comment|/*&n; * cpia_pp CPiA Parallel Port driver&n; *&n; * Supports CPiA based parallel port Video Camera&squot;s.&n; *&n; * (C) Copyright 1999 Bas Huisman &lt;bhuism@cs.utwente.nl&gt;&n; * (C) Copyright 1999-2000 Scott J. Bertin &lt;sbertin@securenym.net&gt;,&n; * (C) Copyright 1999-2000 Peter Pregler &lt;Peter_Pregler@email.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
multiline_comment|/* define _CPIA_DEBUG_ for verbose debug output (see cpia.h) */
multiline_comment|/* #define _CPIA_DEBUG_  1 */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/parport.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
multiline_comment|/* #define _CPIA_DEBUG_&t;&t;define for verbose debug output */
macro_line|#include &quot;cpia.h&quot;
r_static
r_int
id|cpia_pp_open
c_func
(paren
r_void
op_star
id|privdata
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_registerCallback
c_func
(paren
r_void
op_star
id|privdata
comma
r_void
(paren
op_star
id|cb
)paren
(paren
r_void
op_star
id|cbdata
)paren
comma
r_void
op_star
id|cbdata
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_transferCmd
c_func
(paren
r_void
op_star
id|privdata
comma
id|u8
op_star
id|command
comma
id|u8
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_streamStart
c_func
(paren
r_void
op_star
id|privdata
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_streamStop
c_func
(paren
r_void
op_star
id|privdata
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_streamRead
c_func
(paren
r_void
op_star
id|privdata
comma
id|u8
op_star
id|buffer
comma
r_int
id|noblock
)paren
suffix:semicolon
r_static
r_int
id|cpia_pp_close
c_func
(paren
r_void
op_star
id|privdata
)paren
suffix:semicolon
DECL|macro|ABOUT
mdefine_line|#define ABOUT &quot;Parallel port driver for Vision CPiA based cameras&quot;
DECL|macro|PACKET_LENGTH
mdefine_line|#define PACKET_LENGTH  8
multiline_comment|/* Magic numbers for defining port-device mappings */
DECL|macro|PPCPIA_PARPORT_UNSPEC
mdefine_line|#define PPCPIA_PARPORT_UNSPEC -4
DECL|macro|PPCPIA_PARPORT_AUTO
mdefine_line|#define PPCPIA_PARPORT_AUTO -3
DECL|macro|PPCPIA_PARPORT_OFF
mdefine_line|#define PPCPIA_PARPORT_OFF -2
DECL|macro|PPCPIA_PARPORT_NONE
mdefine_line|#define PPCPIA_PARPORT_NONE -1
macro_line|#ifdef MODULE
DECL|variable|parport_nr
r_static
r_int
id|parport_nr
(braket
id|PARPORT_MAX
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|PARPORT_MAX
op_minus
l_int|1
)braket
op_assign
id|PPCPIA_PARPORT_UNSPEC
)brace
suffix:semicolon
DECL|variable|parport
r_static
r_char
op_star
id|parport
(braket
id|PARPORT_MAX
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;B. Huisman &lt;bhuism@cs.utwente.nl&gt; &amp; Peter Pregler &lt;Peter_Pregler@email.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Parallel port driver for Vision CPiA based cameras&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|parport
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|PARPORT_MAX
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|parport
comma
l_string|&quot;&squot;auto&squot; or a list of parallel port numbers. Just like lp.&quot;
)paren
suffix:semicolon
macro_line|#else
DECL|variable|__initdata
r_static
r_int
id|parport_nr
(braket
id|PARPORT_MAX
)braket
id|__initdata
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|PARPORT_MAX
op_minus
l_int|1
)braket
op_assign
id|PPCPIA_PARPORT_UNSPEC
)brace
suffix:semicolon
DECL|variable|parport_ptr
r_static
r_int
id|parport_ptr
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
DECL|struct|pp_cam_entry
r_struct
id|pp_cam_entry
(brace
DECL|member|pdev
r_struct
id|pardevice
op_star
id|pdev
suffix:semicolon
DECL|member|port
r_struct
id|parport
op_star
id|port
suffix:semicolon
DECL|member|cb_task
r_struct
id|work_struct
id|cb_task
suffix:semicolon
DECL|member|open_count
r_int
id|open_count
suffix:semicolon
DECL|member|wq_stream
id|wait_queue_head_t
id|wq_stream
suffix:semicolon
multiline_comment|/* image state flags */
DECL|member|image_ready
r_int
id|image_ready
suffix:semicolon
multiline_comment|/* we got an interrupt */
DECL|member|image_complete
r_int
id|image_complete
suffix:semicolon
multiline_comment|/* we have seen 4 EOI */
DECL|member|streaming
r_int
id|streaming
suffix:semicolon
multiline_comment|/* we are in streaming mode */
DECL|member|stream_irq
r_int
id|stream_irq
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|cpia_pp_ops
r_static
r_struct
id|cpia_camera_ops
id|cpia_pp_ops
op_assign
(brace
id|cpia_pp_open
comma
id|cpia_pp_registerCallback
comma
id|cpia_pp_transferCmd
comma
id|cpia_pp_streamStart
comma
id|cpia_pp_streamStop
comma
id|cpia_pp_streamRead
comma
id|cpia_pp_close
comma
l_int|1
comma
id|THIS_MODULE
)brace
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|cam_list
)paren
suffix:semicolon
DECL|variable|cam_list_lock_pp
r_static
id|spinlock_t
id|cam_list_lock_pp
suffix:semicolon
multiline_comment|/* FIXME */
DECL|function|cpia_parport_enable_irq
r_static
r_void
id|cpia_parport_enable_irq
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
id|parport_enable_irq
c_func
(paren
id|port
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|cpia_parport_disable_irq
r_static
r_void
id|cpia_parport_disable_irq
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
id|parport_disable_irq
c_func
(paren
id|port
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Special CPiA PPC modes: These are invoked by using the 1284 Extensibility&n; * Link Flag during negotiation */
DECL|macro|UPLOAD_FLAG
mdefine_line|#define UPLOAD_FLAG  0x08
DECL|macro|NIBBLE_TRANSFER
mdefine_line|#define NIBBLE_TRANSFER 0x01
DECL|macro|ECP_TRANSFER
mdefine_line|#define ECP_TRANSFER 0x03
DECL|macro|PARPORT_CHUNK_SIZE
mdefine_line|#define PARPORT_CHUNK_SIZE&t;PAGE_SIZE
multiline_comment|/****************************************************************************&n; *&n; *  CPiA-specific  low-level parport functions for nibble uploads&n; *&n; ***************************************************************************/
multiline_comment|/*  CPiA nonstandard &quot;Nibble&quot; mode (no nDataAvail signal after each byte). */
multiline_comment|/* The standard kernel parport_ieee1284_read_nibble() fails with the CPiA... */
DECL|function|cpia_read_nibble
r_static
r_int
id|cpia_read_nibble
(paren
r_struct
id|parport
op_star
id|port
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
multiline_comment|/* adapted verbatim, with one change, from &n;&t;   parport_ieee1284_read_nibble() in drivers/parport/ieee1284-ops.c */
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|byte
op_assign
l_int|0
suffix:semicolon
id|len
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* in nibbles */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|nibble
suffix:semicolon
multiline_comment|/* The CPiA firmware suppresses the use of nDataAvail (nFault LO)&n;&t;&t; * after every second nibble to signal that more&n;&t;&t; * data is available.  (the total number of Bytes that&n;&t;&t; * should be sent is known; if too few are received, an error&n;&t;&t; * will be recorded after a timeout).  &n;&t;&t; * This is incompatible with parport_ieee1284_read_nibble(),&n;&t;&t; * which expects to find nFault LO after every second nibble.&n;&t;&t; */
multiline_comment|/* Solution: modify cpia_read_nibble to only check for &n;&t;&t; * nDataAvail before the first nibble is sent.&n;&t;&t; */
multiline_comment|/* Does the error line indicate end of data? */
r_if
c_cond
(paren
(paren
(paren
id|i
multiline_comment|/*&amp; 1*/
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|parport_read_status
c_func
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_ERROR
)paren
)paren
(brace
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DNA
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s: No more nibble data (%d bytes)&bslash;n&quot;
comma
id|port-&gt;name
comma
id|i
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Go to reverse idle phase. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
id|port-&gt;physport-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_IDLE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Event 7: Set nAutoFd low. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
multiline_comment|/* Event 9: nAck goes low. */
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_DATA
suffix:semicolon
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
l_int|0
)paren
)paren
(brace
multiline_comment|/* Timeout -- no more data? */
id|DBG
c_func
(paren
l_string|&quot;%s: Nibble timeout at event 9 (%d bytes)&bslash;n&quot;
comma
id|port-&gt;name
comma
id|i
op_div
l_int|2
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Read a nibble. */
id|nibble
op_assign
id|parport_read_status
(paren
id|port
)paren
op_rshift
l_int|3
suffix:semicolon
id|nibble
op_and_assign
op_complement
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nibble
op_amp
l_int|0x10
)paren
op_eq
l_int|0
)paren
id|nibble
op_or_assign
l_int|8
suffix:semicolon
id|nibble
op_and_assign
l_int|0xf
suffix:semicolon
multiline_comment|/* Event 10: Set nAutoFd high. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 11: nAck goes high. */
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
id|PARPORT_STATUS_ACK
)paren
)paren
(brace
multiline_comment|/* Timeout -- no more data? */
id|DBG
c_func
(paren
l_string|&quot;%s: Nibble timeout at event 11&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_amp
l_int|1
)paren
(brace
multiline_comment|/* Second nibble */
id|byte
op_or_assign
id|nibble
op_lshift
l_int|4
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|byte
suffix:semicolon
)brace
r_else
id|byte
op_assign
id|nibble
suffix:semicolon
)brace
id|i
op_div_assign
l_int|2
suffix:semicolon
multiline_comment|/* i is now in bytes */
r_if
c_cond
(paren
id|i
op_eq
id|len
)paren
(brace
multiline_comment|/* Read the last nibble without checking data avail. */
id|port
op_assign
id|port-&gt;physport
suffix:semicolon
r_if
c_cond
(paren
id|parport_read_status
(paren
id|port
)paren
op_amp
id|PARPORT_STATUS_ERROR
)paren
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DNA
suffix:semicolon
r_else
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_HBUSY_DAVAIL
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* CPiA nonstandard &quot;Nibble Stream&quot; mode (2 nibbles per cycle, instead of 1)&n; * (See CPiA Data sheet p. 31) &n; * &n; * &quot;Nibble Stream&quot; mode used by CPiA for uploads to non-ECP ports is a &n; * nonstandard variant of nibble mode which allows the same (mediocre) &n; * data flow of 8 bits per cycle as software-enabled ECP by TRISTATE-capable &n; * parallel ports, but works also for  non-TRISTATE-capable ports.&n; * (Standard nibble mode only send 4 bits per cycle)&n; *&n; */
DECL|function|cpia_read_nibble_stream
r_static
r_int
id|cpia_read_nibble_stream
c_func
(paren
r_struct
id|parport
op_star
id|port
comma
r_void
op_star
id|buffer
comma
r_int
id|len
comma
r_int
id|flags
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|buffer
suffix:semicolon
r_int
id|endseen
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|nibble
(braket
l_int|2
)braket
comma
id|byte
op_assign
l_int|0
suffix:semicolon
r_int
id|j
suffix:semicolon
multiline_comment|/* Image Data is complete when 4 consecutive EOI bytes (0xff) are seen */
r_if
c_cond
(paren
id|endseen
OG
l_int|3
)paren
r_break
suffix:semicolon
multiline_comment|/* Event 7: Set nAutoFd low. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
id|PARPORT_CONTROL_AUTOFD
)paren
suffix:semicolon
multiline_comment|/* Event 9: nAck goes low. */
id|port-&gt;ieee1284.phase
op_assign
id|IEEE1284_PH_REV_DATA
suffix:semicolon
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
l_int|0
)paren
)paren
(brace
multiline_comment|/* Timeout -- no more data? */
id|DBG
c_func
(paren
l_string|&quot;%s: Nibble timeout at event 9 (%d bytes)&bslash;n&quot;
comma
id|port-&gt;name
comma
id|i
op_div
l_int|2
)paren
suffix:semicolon
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Read lower nibble */
id|nibble
(braket
l_int|0
)braket
op_assign
id|parport_read_status
(paren
id|port
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* Event 10: Set nAutoFd high. */
id|parport_frob_control
(paren
id|port
comma
id|PARPORT_CONTROL_AUTOFD
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Event 11: nAck goes high. */
r_if
c_cond
(paren
id|parport_wait_peripheral
(paren
id|port
comma
id|PARPORT_STATUS_ACK
comma
id|PARPORT_STATUS_ACK
)paren
)paren
(brace
multiline_comment|/* Timeout -- no more data? */
id|DBG
c_func
(paren
l_string|&quot;%s: Nibble timeout at event 11&bslash;n&quot;
comma
id|port-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Read upper nibble */
id|nibble
(braket
l_int|1
)braket
op_assign
id|parport_read_status
(paren
id|port
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* reassemble the byte */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
id|nibble
(braket
id|j
)braket
op_and_assign
op_complement
l_int|8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nibble
(braket
id|j
)braket
op_amp
l_int|0x10
)paren
op_eq
l_int|0
)paren
id|nibble
(braket
id|j
)braket
op_or_assign
l_int|8
suffix:semicolon
id|nibble
(braket
id|j
)braket
op_and_assign
l_int|0xf
suffix:semicolon
)brace
id|byte
op_assign
(paren
id|nibble
(braket
l_int|0
)braket
op_or
(paren
id|nibble
(braket
l_int|1
)braket
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|byte
suffix:semicolon
r_if
c_cond
(paren
id|byte
op_eq
id|EOI
)paren
(brace
id|endseen
op_increment
suffix:semicolon
)brace
r_else
id|endseen
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  EndTransferMode&n; *&n; ***************************************************************************/
DECL|function|EndTransferMode
r_static
r_void
id|EndTransferMode
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
)paren
(brace
id|parport_negotiate
c_func
(paren
id|cam-&gt;port
comma
id|IEEE1284_MODE_COMPAT
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  ForwardSetup&n; *&n; ***************************************************************************/
DECL|function|ForwardSetup
r_static
r_int
id|ForwardSetup
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
)paren
(brace
r_int
id|retry
suffix:semicolon
multiline_comment|/* The CPiA uses ECP protocol for Downloads from the Host to the camera. &n;&t; * This will be software-emulated if ECP hardware is not present&n;&t; */
multiline_comment|/* the usual camera maximum response time is 10ms, but after receiving&n;&t; * some commands, it needs up to 40ms. (Data Sheet p. 32)*/
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|4
suffix:semicolon
op_increment
id|retry
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parport_negotiate
c_func
(paren
id|cam-&gt;port
comma
id|IEEE1284_MODE_ECP
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retry
op_eq
l_int|4
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Unable to negotiate IEEE1284 ECP Download mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  ReverseSetup&n; *&n; ***************************************************************************/
DECL|function|ReverseSetup
r_static
r_int
id|ReverseSetup
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
comma
r_int
id|extensibility
)paren
(brace
r_int
id|retry
suffix:semicolon
r_int
id|upload_mode
comma
id|mode
op_assign
id|IEEE1284_MODE_ECP
suffix:semicolon
r_int
id|transfer_mode
op_assign
id|ECP_TRANSFER
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cam-&gt;port-&gt;modes
op_amp
id|PARPORT_MODE_ECP
)paren
op_logical_and
op_logical_neg
(paren
id|cam-&gt;port-&gt;modes
op_amp
id|PARPORT_MODE_TRISTATE
)paren
)paren
(brace
id|mode
op_assign
id|IEEE1284_MODE_NIBBLE
suffix:semicolon
id|transfer_mode
op_assign
id|NIBBLE_TRANSFER
suffix:semicolon
)brace
id|upload_mode
op_assign
id|mode
suffix:semicolon
r_if
c_cond
(paren
id|extensibility
)paren
(brace
id|mode
op_assign
id|UPLOAD_FLAG
op_or
id|transfer_mode
op_or
id|IEEE1284_EXT_LINK
suffix:semicolon
)brace
multiline_comment|/* the usual camera maximum response time is 10ms, but after &n;&t; * receiving some commands, it needs up to 40ms. */
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
l_int|4
suffix:semicolon
op_increment
id|retry
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parport_negotiate
c_func
(paren
id|cam-&gt;port
comma
id|mode
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retry
op_eq
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|extensibility
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Unable to negotiate upload extensibility mode&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|DBG
c_func
(paren
l_string|&quot;Unable to negotiate upload mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|extensibility
)paren
(brace
id|cam-&gt;port-&gt;ieee1284.mode
op_assign
id|upload_mode
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  WritePacket&n; *&n; ***************************************************************************/
DECL|function|WritePacket
r_static
r_int
id|WritePacket
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
comma
r_const
id|u8
op_star
id|packet
comma
r_int
id|size
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|size_written
suffix:semicolon
r_if
c_cond
(paren
id|packet
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ForwardSetup
c_func
(paren
id|cam
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Write failed in setup&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|size_written
op_assign
id|parport_write
c_func
(paren
id|cam-&gt;port
comma
id|packet
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size_written
op_ne
id|size
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Write failed, wrote %d/%d&bslash;n&quot;
comma
id|size_written
comma
id|size
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|EndTransferMode
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  ReadPacket&n; *&n; ***************************************************************************/
DECL|function|ReadPacket
r_static
r_int
id|ReadPacket
c_func
(paren
r_struct
id|pp_cam_entry
op_star
id|cam
comma
id|u8
op_star
id|packet
comma
r_int
id|size
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|packet
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ReverseSetup
c_func
(paren
id|cam
comma
l_int|0
)paren
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* support for CPiA variant nibble reads */
r_if
c_cond
(paren
id|cam-&gt;port-&gt;ieee1284.mode
op_eq
id|IEEE1284_MODE_NIBBLE
)paren
(brace
r_if
c_cond
(paren
id|cpia_read_nibble
c_func
(paren
id|cam-&gt;port
comma
id|packet
comma
id|size
comma
l_int|0
)paren
op_ne
id|size
)paren
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|parport_read
c_func
(paren
id|cam-&gt;port
comma
id|packet
comma
id|size
)paren
op_ne
id|size
)paren
(brace
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|EndTransferMode
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_streamStart&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_streamStart
r_static
r_int
id|cpia_pp_streamStart
c_func
(paren
r_void
op_star
id|privdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|cam-&gt;streaming
op_assign
l_int|1
suffix:semicolon
id|cam-&gt;image_ready
op_assign
l_int|0
suffix:semicolon
singleline_comment|//if (ReverseSetup(cam,1)) return -EIO;
r_if
c_cond
(paren
id|cam-&gt;stream_irq
)paren
(brace
id|cpia_parport_enable_irq
c_func
(paren
id|cam-&gt;port
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_streamStop&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_streamStop
r_static
r_int
id|cpia_pp_streamStop
c_func
(paren
r_void
op_star
id|privdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|cam-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|cpia_parport_disable_irq
c_func
(paren
id|cam-&gt;port
)paren
suffix:semicolon
singleline_comment|//EndTransferMode(cam);
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_streamRead&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_read
r_static
r_int
id|cpia_pp_read
c_func
(paren
r_struct
id|parport
op_star
id|port
comma
id|u8
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_int
id|bytes_read
suffix:semicolon
multiline_comment|/* support for CPiA variant &quot;nibble stream&quot; reads */
r_if
c_cond
(paren
id|port-&gt;ieee1284.mode
op_eq
id|IEEE1284_MODE_NIBBLE
)paren
(brace
id|bytes_read
op_assign
id|cpia_read_nibble_stream
c_func
(paren
id|port
comma
id|buffer
comma
id|len
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|new_bytes
suffix:semicolon
r_for
c_loop
(paren
id|bytes_read
op_assign
l_int|0
suffix:semicolon
id|bytes_read
OL
id|len
suffix:semicolon
id|bytes_read
op_add_assign
id|new_bytes
)paren
(brace
id|new_bytes
op_assign
id|parport_read
c_func
(paren
id|port
comma
id|buffer
op_plus
id|bytes_read
comma
id|len
op_minus
id|bytes_read
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_bytes
OL
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
)brace
r_return
id|bytes_read
suffix:semicolon
)brace
DECL|function|cpia_pp_streamRead
r_static
r_int
id|cpia_pp_streamRead
c_func
(paren
r_void
op_star
id|privdata
comma
id|u8
op_star
id|buffer
comma
r_int
id|noblock
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
r_int
id|read_bytes
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|endseen
comma
id|block_size
comma
id|new_bytes
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: cam is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: buffer is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
singleline_comment|//if(cam-&gt;streaming) DBG(&quot;%d / %d&bslash;n&quot;, cam-&gt;image_ready, noblock);
r_if
c_cond
(paren
id|cam-&gt;stream_irq
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|cam-&gt;image_ready
)paren
suffix:semicolon
id|cam-&gt;image_ready
op_decrement
suffix:semicolon
)brace
id|cam-&gt;image_complete
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
l_int|0
multiline_comment|/*cam-&gt;streaming*/
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cam-&gt;image_ready
)paren
(brace
r_if
c_cond
(paren
id|noblock
)paren
(brace
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|cam-&gt;wq_stream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
id|DBG
c_func
(paren
l_string|&quot;%d&bslash;n&quot;
comma
id|cam-&gt;image_ready
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ReverseSetup
c_func
(paren
id|cam
comma
l_int|1
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;unable to ReverseSetup&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|endseen
op_assign
l_int|0
suffix:semicolon
id|block_size
op_assign
id|PARPORT_CHUNK_SIZE
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|cam-&gt;image_complete
)paren
(brace
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
id|new_bytes
op_assign
id|cpia_pp_read
c_func
(paren
id|cam-&gt;port
comma
id|buffer
comma
id|block_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_bytes
op_le
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
id|i
op_assign
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
op_increment
id|i
OL
id|new_bytes
op_logical_and
id|endseen
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
op_star
id|buffer
op_eq
id|EOI
)paren
(brace
id|endseen
op_increment
suffix:semicolon
)brace
r_else
(brace
id|endseen
op_assign
l_int|0
suffix:semicolon
)brace
id|buffer
op_increment
suffix:semicolon
)brace
id|read_bytes
op_add_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
id|endseen
op_eq
l_int|4
)paren
(brace
id|cam-&gt;image_complete
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|CPIA_MAX_IMAGE_SIZE
op_minus
id|read_bytes
op_le
id|PARPORT_CHUNK_SIZE
)paren
(brace
id|block_size
op_assign
id|CPIA_MAX_IMAGE_SIZE
op_minus
id|read_bytes
suffix:semicolon
)brace
)brace
id|EndTransferMode
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
id|cam-&gt;image_complete
ques
c_cond
id|read_bytes
suffix:colon
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_transferCmd&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_transferCmd
r_static
r_int
id|cpia_pp_transferCmd
c_func
(paren
r_void
op_star
id|privdata
comma
id|u8
op_star
id|command
comma
id|u8
op_star
id|data
)paren
(brace
r_int
id|err
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
id|databytes
suffix:semicolon
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: cam is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: command is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|databytes
op_assign
(paren
(paren
(paren
r_int
)paren
id|command
(braket
l_int|7
)braket
)paren
op_lshift
l_int|8
)paren
op_or
id|command
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|WritePacket
c_func
(paren
id|cam
comma
id|command
comma
id|PACKET_LENGTH
)paren
)paren
OL
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Error writing command&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command
(braket
l_int|0
)braket
op_eq
id|DATA_IN
)paren
(brace
id|u8
id|buffer
(braket
l_int|8
)braket
suffix:semicolon
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: data is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|ReadPacket
c_func
(paren
id|cam
comma
id|buffer
comma
l_int|8
)paren
)paren
OL
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Error reading command result&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|data
comma
id|buffer
comma
id|databytes
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|command
(braket
l_int|0
)braket
op_eq
id|DATA_OUT
)paren
(brace
r_if
c_cond
(paren
id|databytes
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|data
op_eq
l_int|NULL
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Internal driver error: data is NULL&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|WritePacket
c_func
(paren
id|cam
comma
id|data
comma
id|databytes
)paren
)paren
OL
l_int|0
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Error writing command data&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
)brace
)brace
r_else
(brace
id|DBG
c_func
(paren
l_string|&quot;Unexpected first byte of command: %x&bslash;n&quot;
comma
id|command
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_open&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_open
r_static
r_int
id|cpia_pp_open
c_func
(paren
r_void
op_star
id|privdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
(paren
r_struct
id|pp_cam_entry
op_star
)paren
id|privdata
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;open_count
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|parport_claim
c_func
(paren
id|cam-&gt;pdev
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;failed to claim the port&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|parport_negotiate
c_func
(paren
id|cam-&gt;port
comma
id|IEEE1284_MODE_COMPAT
)paren
suffix:semicolon
id|parport_data_forward
c_func
(paren
id|cam-&gt;port
)paren
suffix:semicolon
id|parport_write_control
c_func
(paren
id|cam-&gt;port
comma
id|PARPORT_CONTROL_SELECT
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|parport_write_control
c_func
(paren
id|cam-&gt;port
comma
id|PARPORT_CONTROL_SELECT
op_or
id|PARPORT_CONTROL_INIT
)paren
suffix:semicolon
)brace
op_increment
id|cam-&gt;open_count
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_registerCallback&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_registerCallback
r_static
r_int
id|cpia_pp_registerCallback
c_func
(paren
r_void
op_star
id|privdata
comma
r_void
(paren
op_star
id|cb
)paren
(paren
r_void
op_star
id|cbdata
)paren
comma
r_void
op_star
id|cbdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;port-&gt;irq
op_ne
id|PARPORT_IRQ_NONE
)paren
(brace
id|INIT_WORK
c_func
(paren
op_amp
id|cam-&gt;cb_task
comma
id|cb
comma
id|cbdata
)paren
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_close&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_close
r_static
r_int
id|cpia_pp_close
c_func
(paren
r_void
op_star
id|privdata
)paren
(brace
r_struct
id|pp_cam_entry
op_star
id|cam
op_assign
id|privdata
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|cam-&gt;open_count
op_eq
l_int|0
)paren
(brace
id|parport_release
c_func
(paren
id|cam-&gt;pdev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; *  cpia_pp_register&n; *&n; ***************************************************************************/
DECL|function|cpia_pp_register
r_static
r_int
id|cpia_pp_register
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_struct
id|pardevice
op_star
id|pdev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|pp_cam_entry
op_star
id|cam
suffix:semicolon
r_struct
id|cam_data
op_star
id|cpia
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;modes
op_amp
id|PARPORT_MODE_PCSPP
)paren
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;port is not supported by CPiA driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|cam
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pp_cam_entry
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_eq
l_int|NULL
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;failed to allocate camera structure&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cam
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pp_cam_entry
)paren
)paren
suffix:semicolon
id|pdev
op_assign
id|parport_register_device
c_func
(paren
id|port
comma
l_string|&quot;cpia_pp&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;failed to parport_register_device&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|cam-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|cam-&gt;port
op_assign
id|port
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cam-&gt;wq_stream
)paren
suffix:semicolon
id|cam-&gt;streaming
op_assign
l_int|0
suffix:semicolon
id|cam-&gt;stream_irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cpia
op_assign
id|cpia_register_camera
c_func
(paren
op_amp
id|cpia_pp_ops
comma
id|cam
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|LOG
c_func
(paren
l_string|&quot;failed to cpia_register_camera&bslash;n&quot;
)paren
suffix:semicolon
id|parport_unregister_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|cam_list_lock_pp
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|cpia-&gt;cam_data_list
comma
op_amp
id|cam_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cam_list_lock_pp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cpia_pp_detach
r_static
r_void
id|cpia_pp_detach
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|cam_data
op_star
id|cpia
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|pp_cam_entry
op_star
id|cam
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cam_list_lock_pp
)paren
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
op_amp
id|cam_list
)paren
(brace
id|cpia
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cam_data
comma
id|cam_data_list
)paren
suffix:semicolon
id|cam
op_assign
(paren
r_struct
id|pp_cam_entry
op_star
)paren
id|cpia-&gt;lowlevel_data
suffix:semicolon
r_if
c_cond
(paren
id|cam
op_logical_and
id|cam-&gt;port-&gt;number
op_eq
id|port-&gt;number
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|cpia-&gt;cam_data_list
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cpia
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|cam_list_lock_pp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpia
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;cpia_pp_detach failed to find cam_data in cam_list&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cam
op_assign
(paren
r_struct
id|pp_cam_entry
op_star
)paren
id|cpia-&gt;lowlevel_data
suffix:semicolon
id|cpia_unregister_camera
c_func
(paren
id|cpia
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;open_count
OG
l_int|0
)paren
(brace
id|cpia_pp_close
c_func
(paren
id|cam
)paren
suffix:semicolon
)brace
id|parport_unregister_device
c_func
(paren
id|cam-&gt;pdev
)paren
suffix:semicolon
id|cpia-&gt;lowlevel_data
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|cam
)paren
suffix:semicolon
)brace
DECL|function|cpia_pp_attach
r_static
r_void
id|cpia_pp_attach
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_switch
c_cond
(paren
id|parport_nr
(braket
l_int|0
)braket
)paren
(brace
r_case
id|PPCPIA_PARPORT_UNSPEC
suffix:colon
r_case
id|PPCPIA_PARPORT_AUTO
suffix:colon
r_if
c_cond
(paren
id|port-&gt;probe_info
(braket
l_int|0
)braket
dot
r_class
op_ne
id|PARPORT_CLASS_MEDIA
op_logical_or
id|port-&gt;probe_info
(braket
l_int|0
)braket
dot
id|cmdset
op_eq
l_int|NULL
op_logical_or
id|strncmp
c_func
(paren
id|port-&gt;probe_info
(braket
l_int|0
)braket
dot
id|cmdset
comma
l_string|&quot;CPIA_1&quot;
comma
l_int|6
)paren
op_ne
l_int|0
)paren
r_return
suffix:semicolon
id|cpia_pp_register
c_func
(paren
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|PARPORT_MAX
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;number
op_eq
id|parport_nr
(braket
id|i
)braket
)paren
(brace
id|cpia_pp_register
c_func
(paren
id|port
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
DECL|variable|cpia_pp_driver
r_static
r_struct
id|parport_driver
id|cpia_pp_driver
op_assign
(brace
l_string|&quot;cpia_pp&quot;
comma
id|cpia_pp_attach
comma
id|cpia_pp_detach
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|cpia_pp_init
r_int
id|cpia_pp_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s v%d.%d.%d&bslash;n&quot;
comma
id|ABOUT
comma
id|CPIA_PP_MAJ_VER
comma
id|CPIA_PP_MIN_VER
comma
id|CPIA_PP_PATCH_VER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_nr
(braket
l_int|0
)braket
op_eq
id|PPCPIA_PARPORT_OFF
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;  disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|cam_list_lock_pp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_register_driver
(paren
op_amp
id|cpia_pp_driver
)paren
)paren
(brace
id|LOG
(paren
l_string|&quot;unable to register with parport&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|parport
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/* The user gave some parameters.  Let&squot;s see what they were. */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|parport
(braket
l_int|0
)braket
comma
l_string|&quot;auto&quot;
comma
l_int|4
)paren
)paren
(brace
id|parport_nr
(braket
l_int|0
)braket
op_assign
id|PPCPIA_PARPORT_AUTO
suffix:semicolon
)brace
r_else
(brace
r_int
id|n
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|PARPORT_MAX
op_logical_and
id|parport
(braket
id|n
)braket
suffix:semicolon
id|n
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|parport
(braket
id|n
)braket
comma
l_string|&quot;none&quot;
comma
l_int|4
)paren
)paren
(brace
id|parport_nr
(braket
id|n
)braket
op_assign
id|PPCPIA_PARPORT_NONE
suffix:semicolon
)brace
r_else
(brace
r_char
op_star
id|ep
suffix:semicolon
r_int
r_int
id|r
op_assign
id|simple_strtoul
c_func
(paren
id|parport
(braket
id|n
)braket
comma
op_amp
id|ep
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_ne
id|parport
(braket
id|n
)braket
)paren
(brace
id|parport_nr
(braket
id|n
)braket
op_assign
id|r
suffix:semicolon
)brace
r_else
(brace
id|LOG
c_func
(paren
l_string|&quot;bad port specifier `%s&squot;&bslash;n&quot;
comma
id|parport
(braket
id|n
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
macro_line|#if defined(CONFIG_KMOD) &amp;&amp; defined(CONFIG_PNP_PARPORT_MODULE)
r_if
c_cond
(paren
id|parport_enumerate
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|parport_enumerate
c_func
(paren
)paren
op_member_access_from_pointer
id|probe_info.model
)paren
(brace
id|request_module
c_func
(paren
l_string|&quot;parport_probe&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|cpia_pp_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|parport_unregister_driver
(paren
op_amp
id|cpia_pp_driver
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#else /* !MODULE */
DECL|function|cpia_pp_setup
r_static
r_int
id|__init
id|cpia_pp_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|str
comma
l_string|&quot;parport&quot;
comma
l_int|7
)paren
)paren
(brace
r_int
id|n
op_assign
id|simple_strtoul
c_func
(paren
id|str
op_plus
l_int|7
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parport_ptr
OL
id|PARPORT_MAX
)paren
(brace
id|parport_nr
(braket
id|parport_ptr
op_increment
)braket
op_assign
id|n
suffix:semicolon
)brace
r_else
(brace
id|LOG
c_func
(paren
l_string|&quot;too many ports, %s ignored.&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;auto&quot;
)paren
)paren
(brace
id|parport_nr
(braket
l_int|0
)braket
op_assign
id|PPCPIA_PARPORT_AUTO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;none&quot;
)paren
)paren
(brace
id|parport_nr
(braket
id|parport_ptr
op_increment
)braket
op_assign
id|PPCPIA_PARPORT_NONE
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;cpia_pp=&quot;
comma
id|cpia_pp_setup
)paren
suffix:semicolon
macro_line|#endif /* !MODULE */
eof
