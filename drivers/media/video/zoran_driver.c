multiline_comment|/*&n; * Zoran zr36057/zr36067 PCI controller driver, for the&n; * Pinnacle/Miro DC10/DC10+/DC30/DC30+, Iomega Buz, Linux&n; * Media Labs LML33/LML33R10.&n; *&n; * Copyright (C) 2000 Serguei Miridonov &lt;mirsev@cicese.mx&gt;&n; *&n; * Changes for BUZ by Wolfgang Scherr &lt;scherr@net4you.net&gt;&n; *&n; * Changes for DC10/DC30 by Laurent Pinchart &lt;laurent.pinchart@skynet.be&gt;&n; *&n; * Changes for LML33R10 by Maxim Yevtyushkin &lt;max@linuxmedialabs.com&gt;&n; *&n; * Changes for videodev2/v4l2 by Ronald Bultje &lt;rbultje@ronald.bitfreak.net&gt;&n; *&n; * Based on&n; *&n; * Miro DC10 driver&n; * Copyright (C) 1999 Wolfgang Scherr &lt;scherr@net4you.net&gt;&n; *&n; * Iomega Buz driver version 1.0&n; * Copyright (C) 1999 Rainer Johanni &lt;Rainer@Johanni.de&gt;&n; *&n; * buz.0.0.3&n; * Copyright (C) 1998 Dave Perks &lt;dperks@ibm.net&gt;&n; *&n; * bttv - Bt848 frame grabber driver&n; * Copyright (C) 1996,97,98 Ralph  Metzler (rjkm@thp.uni-koeln.de)&n; *                        &amp; Marcus Metzler (mocm@thp.uni-koeln.de)&n; *&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/byteorder/generic.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
DECL|macro|MAP_NR
mdefine_line|#define     MAP_NR(x)       virt_to_page(x)
DECL|macro|ZORAN_HARDWARE
mdefine_line|#define     ZORAN_HARDWARE  VID_HARDWARE_ZR36067
DECL|macro|ZORAN_VID_TYPE
mdefine_line|#define     ZORAN_VID_TYPE  ( &bslash;&n;&t;&t;&t;&t;VID_TYPE_CAPTURE | &bslash;&n;&t;&t;&t;&t;VID_TYPE_OVERLAY | &bslash;&n;&t;&t;&t;&t;VID_TYPE_CLIPPING | &bslash;&n;&t;&t;&t;&t;VID_TYPE_FRAMERAM | &bslash;&n;&t;&t;&t;&t;VID_TYPE_SCALES | &bslash;&n;&t;&t;&t;&t;VID_TYPE_MJPEG_DECODER | &bslash;&n;&t;&t;&t;&t;VID_TYPE_MJPEG_ENCODER &bslash;&n;&t;&t;&t;     )
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &quot;videocodec.h&quot;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/video_decoder.h&gt;
macro_line|#include &lt;linux/video_encoder.h&gt;
macro_line|#include &quot;zoran.h&quot;
macro_line|#include &quot;zoran_device.h&quot;
macro_line|#include &quot;zoran_card.h&quot;
macro_line|#ifdef HAVE_V4L2
multiline_comment|/* we declare some card type definitions here, they mean&n;&t; * the same as the v4l1 ZORAN_VID_TYPE above, except it&squot;s v4l2 */
DECL|macro|ZORAN_V4L2_VID_FLAGS
mdefine_line|#define ZORAN_V4L2_VID_FLAGS ( &bslash;&n;&t;&t;&t;&t;V4L2_CAP_STREAMING |&bslash;&n;&t;&t;&t;&t;V4L2_CAP_VIDEO_CAPTURE |&bslash;&n;&t;&t;&t;&t;V4L2_CAP_VIDEO_OUTPUT |&bslash;&n;&t;&t;&t;&t;V4L2_CAP_VIDEO_OVERLAY &bslash;&n;                              )
macro_line|#endif
macro_line|#include &lt;asm/byteorder.h&gt;
DECL|variable|zoran_formats
r_const
r_struct
id|zoran_format
id|zoran_formats
(braket
)braket
op_assign
(brace
(brace
dot
id|name
op_assign
l_string|&quot;15-bit RGB&quot;
comma
dot
id|palette
op_assign
id|VIDEO_PALETTE_RGB555
comma
macro_line|#ifdef HAVE_V4L2
macro_line|#ifdef __LITTLE_ENDIAN
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_RGB555
comma
macro_line|#else
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_RGB555X
comma
macro_line|#endif
dot
id|colorspace
op_assign
id|V4L2_COLORSPACE_SRGB
comma
macro_line|#endif
dot
id|depth
op_assign
l_int|15
comma
dot
id|flags
op_assign
id|ZORAN_FORMAT_CAPTURE
op_or
id|ZORAN_FORMAT_OVERLAY
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;16-bit RGB&quot;
comma
dot
id|palette
op_assign
id|VIDEO_PALETTE_RGB565
comma
macro_line|#ifdef HAVE_V4L2
macro_line|#ifdef __LITTLE_ENDIAN
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_RGB565
comma
macro_line|#else
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_RGB565X
comma
macro_line|#endif
dot
id|colorspace
op_assign
id|V4L2_COLORSPACE_SRGB
comma
macro_line|#endif
dot
id|depth
op_assign
l_int|16
comma
dot
id|flags
op_assign
id|ZORAN_FORMAT_CAPTURE
op_or
id|ZORAN_FORMAT_OVERLAY
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;24-bit RGB&quot;
comma
dot
id|palette
op_assign
id|VIDEO_PALETTE_RGB24
comma
macro_line|#ifdef HAVE_V4L2
macro_line|#ifdef __LITTLE_ENDIAN
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_BGR24
comma
macro_line|#else
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_RGB24
comma
macro_line|#endif
dot
id|colorspace
op_assign
id|V4L2_COLORSPACE_SRGB
comma
macro_line|#endif
dot
id|depth
op_assign
l_int|24
comma
dot
id|flags
op_assign
id|ZORAN_FORMAT_CAPTURE
op_or
id|ZORAN_FORMAT_OVERLAY
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;32-bit RGB&quot;
comma
dot
id|palette
op_assign
id|VIDEO_PALETTE_RGB32
comma
macro_line|#ifdef HAVE_V4L2
macro_line|#ifdef __LITTLE_ENDIAN
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_BGR32
comma
macro_line|#else
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_RGB32
comma
macro_line|#endif
dot
id|colorspace
op_assign
id|V4L2_COLORSPACE_SRGB
comma
macro_line|#endif
dot
id|depth
op_assign
l_int|32
comma
dot
id|flags
op_assign
id|ZORAN_FORMAT_CAPTURE
op_or
id|ZORAN_FORMAT_OVERLAY
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;4:2:2, packed, YUYV&quot;
comma
dot
id|palette
op_assign
id|VIDEO_PALETTE_YUV422
comma
macro_line|#ifdef HAVE_V4L2
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_YUYV
comma
dot
id|colorspace
op_assign
id|V4L2_COLORSPACE_SMPTE170M
comma
macro_line|#endif
dot
id|depth
op_assign
l_int|16
comma
dot
id|flags
op_assign
id|ZORAN_FORMAT_CAPTURE
op_or
id|ZORAN_FORMAT_OVERLAY
comma
)brace
comma
(brace
dot
id|name
op_assign
l_string|&quot;Hardware-encoded Motion-JPEG&quot;
comma
dot
id|palette
op_assign
op_minus
l_int|1
comma
macro_line|#ifdef HAVE_V4L2
dot
id|fourcc
op_assign
id|V4L2_PIX_FMT_MJPEG
comma
dot
id|colorspace
op_assign
id|V4L2_COLORSPACE_SMPTE170M
comma
macro_line|#endif
dot
id|depth
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|ZORAN_FORMAT_CAPTURE
op_or
id|ZORAN_FORMAT_PLAYBACK
op_or
id|ZORAN_FORMAT_COMPRESSED
comma
)brace
)brace
suffix:semicolon
DECL|variable|zoran_num_formats
r_static
r_const
r_int
id|zoran_num_formats
op_assign
(paren
r_sizeof
(paren
id|zoran_formats
)paren
op_div
r_sizeof
(paren
r_struct
id|zoran_format
)paren
)paren
suffix:semicolon
singleline_comment|// RJ: Test only - want to test BUZ_USE_HIMEM even when CONFIG_BIGPHYS_AREA is defined
macro_line|#if !defined(CONFIG_BIGPHYS_AREA)
singleline_comment|//#undef CONFIG_BIGPHYS_AREA
DECL|macro|BUZ_USE_HIMEM
mdefine_line|#define BUZ_USE_HIMEM
macro_line|#endif
macro_line|#if defined(CONFIG_BIGPHYS_AREA)
macro_line|#   include &lt;linux/bigphysarea.h&gt;
macro_line|#endif
r_extern
r_int
op_star
id|zr_debug
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(num, format, args...) &bslash;&n;&t;do { &bslash;&n;&t;&t;if (*zr_debug &gt;= num) &bslash;&n;&t;&t;&t;printk(format, ##args);&t;&bslash;&n;&t;} while (0)
r_extern
r_int
id|v4l_nbufs
suffix:semicolon
r_extern
r_int
id|v4l_bufsize
suffix:semicolon
r_extern
r_int
id|jpg_nbufs
suffix:semicolon
r_extern
r_int
id|jpg_bufsize
suffix:semicolon
r_extern
r_int
id|pass_through
suffix:semicolon
DECL|variable|lock_norm
r_static
r_int
id|lock_norm
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1=Don&squot;t change TV standard (norm) */
id|module_param
c_func
(paren
id|lock_norm
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|lock_norm
comma
l_string|&quot;Users can&squot;t change norm&quot;
)paren
suffix:semicolon
macro_line|#ifdef HAVE_V4L2
multiline_comment|/* small helper function for calculating buffersizes for v4l2&n;&t; * we calculate the nearest higher power-of-two, which&n;&t; * will be the recommended buffersize */
r_static
id|__u32
DECL|function|zoran_v4l2_calc_bufsize
id|zoran_v4l2_calc_bufsize
(paren
r_struct
id|zoran_jpg_settings
op_star
id|settings
)paren
(brace
id|__u8
id|div
op_assign
id|settings-&gt;VerDcm
op_star
id|settings-&gt;HorDcm
op_star
id|settings-&gt;TmpDcm
suffix:semicolon
id|__u32
id|num
op_assign
(paren
l_int|1024
op_star
l_int|512
)paren
op_div
(paren
id|div
)paren
suffix:semicolon
id|__u32
id|result
op_assign
l_int|2
suffix:semicolon
id|num
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|num
)paren
(brace
id|num
op_rshift_assign
l_int|1
suffix:semicolon
id|result
op_lshift_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
OG
id|jpg_bufsize
)paren
r_return
id|jpg_bufsize
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|8192
)paren
r_return
l_int|8192
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* forward references */
r_static
r_void
id|v4l_fbuffer_free
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_void
id|jpg_fbuffer_free
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
multiline_comment|/*&n; *   Allocate the V4L grab buffers&n; *&n; *   These have to be pysically contiguous.&n; *   If v4l_bufsize &lt;= MAX_KMALLOC_MEM we use kmalloc&n; *   else we try to allocate them with bigphysarea_alloc_pages&n; *   if the bigphysarea patch is present in the kernel,&n; *   else we try to use high memory (if the user has bootet&n; *   Linux with the necessary memory left over).&n; */
macro_line|#if defined(BUZ_USE_HIMEM) &amp;&amp; !defined(CONFIG_BIGPHYS_AREA)
r_static
r_int
r_int
DECL|function|get_high_mem
id|get_high_mem
(paren
r_int
r_int
id|size
)paren
(brace
multiline_comment|/*&n; * Check if there is usable memory at the end of Linux memory&n; * of at least size. Return the physical address of this memory,&n; * return 0 on failure.&n; *&n; * The idea is from Alexandro Rubini&squot;s book &quot;Linux device drivers&quot;.&n; * The driver from him which is downloadable from O&squot;Reilly&squot;s&n; * web site misses the &quot;virt_to_phys(high_memory)&quot; part&n; * (and therefore doesn&squot;t work at all - at least with 2.2.x kernels).&n; *&n; * It should be unnecessary to mention that THIS IS DANGEROUS,&n; * if more than one driver at a time has the idea to use this memory!!!!&n; */
r_volatile
r_int
r_char
id|__iomem
op_star
id|mem
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_int
r_int
id|hi_mem_ph
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
multiline_comment|/* Map the high memory to user space */
id|hi_mem_ph
op_assign
id|virt_to_phys
c_func
(paren
id|high_memory
)paren
suffix:semicolon
id|mem
op_assign
id|ioremap
c_func
(paren
id|hi_mem_ph
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: get_high_mem() - ioremap failed&bslash;n&quot;
comma
id|ZORAN_NAME
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Check if it is memory */
id|c
op_assign
id|i
op_amp
l_int|0xff
suffix:semicolon
id|writeb
c_func
(paren
id|c
comma
id|mem
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|mem
op_plus
id|i
)paren
op_ne
id|c
)paren
r_break
suffix:semicolon
id|c
op_assign
l_int|255
op_minus
id|c
suffix:semicolon
id|writeb
c_func
(paren
id|c
comma
id|mem
op_plus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|readb
c_func
(paren
id|mem
op_plus
id|i
)paren
op_ne
id|c
)paren
r_break
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|mem
op_plus
id|i
)paren
suffix:semicolon
multiline_comment|/* zero out memory */
multiline_comment|/* give the kernel air to breath */
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|0x3ffff
)paren
op_eq
l_int|0x3ffff
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|iounmap
c_func
(paren
id|mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|size
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: get_high_mem() - requested %lu, avail %lu&bslash;n&quot;
comma
id|ZORAN_NAME
comma
id|size
comma
id|i
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|hi_mem_ph
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|v4l_fbuffer_alloc
id|v4l_fbuffer_alloc
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|i
comma
id|off
suffix:semicolon
r_int
r_char
op_star
id|mem
suffix:semicolon
macro_line|#if defined(BUZ_USE_HIMEM) &amp;&amp; !defined(CONFIG_BIGPHYS_AREA)
r_int
r_int
id|pmem
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* we might have old buffers lying around... */
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.ready_to_be_freed
)paren
(brace
id|v4l_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;v4l_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
)paren
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_WARNING
l_string|&quot;%s: v4l_fbuffer_alloc() - buffer %d allready allocated!?&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
singleline_comment|//udelay(20);
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.buffer_size
op_le
id|MAX_KMALLOC_MEM
)paren
(brace
multiline_comment|/* Use kmalloc */
id|mem
op_assign
(paren
r_int
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|fh-&gt;v4l_buffers
dot
id|buffer_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_fbuffer_alloc() - kmalloc for V4L buf %d failed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
id|v4l_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
op_assign
id|mem
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer_phys
op_assign
id|virt_to_phys
c_func
(paren
id|mem
)paren
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer_bus
op_assign
id|virt_to_bus
c_func
(paren
id|mem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
id|off
op_add_assign
id|PAGE_SIZE
)paren
id|SetPageReserved
c_func
(paren
id|MAP_NR
c_func
(paren
id|mem
op_plus
id|off
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|4
comma
id|KERN_INFO
l_string|&quot;%s: v4l_fbuffer_alloc() - V4L frame %d mem 0x%lx (bus: 0x%lx)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
comma
(paren
r_int
r_int
)paren
id|mem
comma
id|virt_to_bus
c_func
(paren
id|mem
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#if defined(CONFIG_BIGPHYS_AREA)
multiline_comment|/* Use bigphysarea_alloc_pages */
r_int
id|n
op_assign
(paren
id|fh-&gt;v4l_buffers.buffer_size
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
op_div
id|PAGE_SIZE
suffix:semicolon
id|mem
op_assign
(paren
r_int
r_char
op_star
)paren
id|bigphysarea_alloc_pages
c_func
(paren
id|n
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_fbuffer_alloc() - bigphysarea_alloc_pages for V4L buf %d failed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
id|v4l_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
op_assign
id|mem
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer_phys
op_assign
id|virt_to_phys
c_func
(paren
id|mem
)paren
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer_bus
op_assign
id|virt_to_bus
c_func
(paren
id|mem
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|4
comma
id|KERN_INFO
l_string|&quot;%s: Bigphysarea frame %d mem 0x%x (bus: 0x%x)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
comma
(paren
r_int
)paren
id|mem
comma
(paren
r_int
)paren
id|virt_to_bus
c_func
(paren
id|mem
)paren
)paren
suffix:semicolon
multiline_comment|/* Zero out the allocated memory */
id|memset
c_func
(paren
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
comma
l_int|0
comma
id|fh-&gt;v4l_buffers.buffer_size
)paren
suffix:semicolon
macro_line|#elif defined(BUZ_USE_HIMEM)
multiline_comment|/* Use high memory which has been left at boot time */
multiline_comment|/* Ok., Ok. this is an evil hack - we make&n;&t;&t;&t; * the assumption that physical addresses are&n;&t;&t;&t; * the same as bus addresses (true at least&n;&t;&t;&t; * for Intel processors). The whole method of&n;&t;&t;&t; * obtaining and using this memory is not very&n;&t;&t;&t; * nice - but I hope it saves some poor users&n;&t;&t;&t; * from kernel hacking, which might have even&n;&t;&t;&t; * more evil results */
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
r_int
id|size
op_assign
id|fh-&gt;v4l_buffers.num_buffers
op_star
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
id|pmem
op_assign
id|get_high_mem
c_func
(paren
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmem
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_fbuffer_alloc() - get_high_mem (size = %d KB) for V4L bufs failed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|size
op_rshift
l_int|10
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|fh-&gt;v4l_buffers.buffer
(braket
l_int|0
)braket
dot
id|fbuffer
op_assign
l_int|NULL
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
l_int|0
)braket
dot
id|fbuffer_phys
op_assign
id|pmem
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
l_int|0
)braket
dot
id|fbuffer_bus
op_assign
id|pmem
suffix:semicolon
id|dprintk
c_func
(paren
l_int|4
comma
id|KERN_INFO
l_string|&quot;%s: v4l_fbuffer_alloc() - using %d KB high memory&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|size
op_rshift
l_int|10
)paren
suffix:semicolon
)brace
r_else
(brace
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
op_assign
l_int|NULL
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer_phys
op_assign
id|pmem
op_plus
id|i
op_star
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer_bus
op_assign
id|pmem
op_plus
id|i
op_star
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* No bigphysarea present, usage of high memory disabled,&n;&t;&t;&t; * but user wants buffers of more than MAX_KMALLOC_MEM */
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_fbuffer_alloc() - no bigphysarea_patch present, usage of high memory disabled,&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_fbuffer_alloc() - sorry, could not allocate %d V4L buffers of size %d KB.&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fh-&gt;v4l_buffers.num_buffers
comma
id|fh-&gt;v4l_buffers.buffer_size
op_rshift
l_int|10
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
macro_line|#endif
)brace
)brace
id|fh-&gt;v4l_buffers.allocated
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* free the V4L grab buffers */
r_static
r_void
DECL|function|v4l_fbuffer_free
id|v4l_fbuffer_free
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|i
comma
id|off
suffix:semicolon
r_int
r_char
op_star
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
l_int|4
comma
id|KERN_INFO
l_string|&quot;%s: v4l_fbuffer_free()&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;v4l_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.buffer_size
op_le
id|MAX_KMALLOC_MEM
)paren
(brace
id|mem
op_assign
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
id|off
op_add_assign
id|PAGE_SIZE
)paren
id|ClearPageReserved
c_func
(paren
id|MAP_NR
c_func
(paren
id|mem
op_plus
id|off
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
)paren
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_BIGPHYS_AREA)
r_else
id|bigphysarea_free_pages
c_func
(paren
(paren
r_void
op_star
)paren
id|fh-&gt;v4l_buffers
dot
id|buffer
(braket
id|i
)braket
dot
id|fbuffer
)paren
suffix:semicolon
macro_line|#endif
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer
op_assign
l_int|NULL
suffix:semicolon
)brace
id|fh-&gt;v4l_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;v4l_buffers.ready_to_be_freed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   Allocate the MJPEG grab buffers.&n; *&n; *   If the requested buffer size is smaller than MAX_KMALLOC_MEM,&n; *   kmalloc is used to request a physically contiguous area,&n; *   else we allocate the memory in framgents with get_zeroed_page.&n; *&n; *   If a Natoma chipset is present and this is a revision 1 zr36057,&n; *   each MJPEG buffer needs to be physically contiguous.&n; *   (RJ: This statement is from Dave Perks&squot; original driver,&n; *   I could never check it because I have a zr36067)&n; *   The driver cares about this because it reduces the buffer&n; *   size to MAX_KMALLOC_MEM in that case (which forces contiguous allocation).&n; *&n; *   RJ: The contents grab buffers needs never be accessed in the driver.&n; *       Therefore there is no need to allocate them with vmalloc in order&n; *       to get a contiguous virtual memory space.&n; *       I don&squot;t understand why many other drivers first allocate them with&n; *       vmalloc (which uses internally also get_zeroed_page, but delivers you&n; *       virtual addresses) and then again have to make a lot of efforts&n; *       to get the physical address.&n; *&n; *   Ben Capper:&n; *       On big-endian architectures (such as ppc) some extra steps&n; *       are needed. When reading and writing to the stat_com array&n; *       and fragment buffers, the device expects to see little-&n; *       endian values. The use of cpu_to_le32() and le32_to_cpu()&n; *       in this function (and one or two others in zoran_device.c)&n; *       ensure that these values are always stored in little-endian&n; *       form, regardless of architecture. The zr36057 does Very Bad&n; *       Things on big endian architectures if the stat_com array&n; *       and fragment buffers are not little-endian.&n; */
r_static
r_int
DECL|function|jpg_fbuffer_alloc
id|jpg_fbuffer_alloc
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|off
suffix:semicolon
r_int
r_int
id|mem
suffix:semicolon
multiline_comment|/* we might have old buffers lying around */
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.ready_to_be_freed
)paren
(brace
id|jpg_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;jpg_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
)paren
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_WARNING
l_string|&quot;%s: jpg_fbuffer_alloc() - buffer %d allready allocated!?&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Allocate fragment table for this buffer */
id|mem
op_assign
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_fbuffer_alloc() - get_zeroed_page (frag_tab) failed for buffer %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
id|jpg_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
comma
l_int|0
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
op_assign
(paren
id|u32
op_star
)paren
id|mem
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab_bus
op_assign
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
)paren
suffix:semicolon
singleline_comment|//if (alloc_contig) {
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.need_contiguous
)paren
(brace
id|mem
op_assign
(paren
r_int
r_int
)paren
id|kmalloc
c_func
(paren
id|fh-&gt;jpg_buffers
dot
id|buffer_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_fbuffer_alloc() - kmalloc failed for buffer %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
id|jpg_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
)paren
)paren
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
id|fh-&gt;jpg_buffers.buffer_size
op_div
l_int|4
)paren
op_lshift
l_int|1
)paren
op_or
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|fh-&gt;jpg_buffers.buffer_size
suffix:semicolon
id|off
op_add_assign
id|PAGE_SIZE
)paren
id|SetPageReserved
c_func
(paren
id|MAP_NR
c_func
(paren
id|mem
op_plus
id|off
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* jpg_bufsize is allreay page aligned */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|fh-&gt;jpg_buffers.buffer_size
op_div
id|PAGE_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
id|mem
op_assign
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_fbuffer_alloc() - get_zeroed_page failed for buffer %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
id|jpg_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
)paren
)paren
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_plus
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|PAGE_SIZE
op_div
l_int|4
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
id|SetPageReserved
c_func
(paren
id|MAP_NR
c_func
(paren
id|mem
)paren
)paren
suffix:semicolon
)brace
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_minus
l_int|1
)braket
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|dprintk
c_func
(paren
l_int|4
comma
id|KERN_DEBUG
l_string|&quot;%s: jpg_fbuffer_alloc() - %d KB allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
(paren
id|fh-&gt;jpg_buffers.num_buffers
op_star
id|fh-&gt;jpg_buffers.buffer_size
)paren
op_rshift
l_int|10
)paren
suffix:semicolon
id|fh-&gt;jpg_buffers.allocated
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* free the MJPEG grab buffers */
r_static
r_void
DECL|function|jpg_fbuffer_free
id|jpg_fbuffer_free
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|off
suffix:semicolon
r_int
r_char
op_star
id|mem
suffix:semicolon
id|dprintk
c_func
(paren
l_int|4
comma
id|KERN_DEBUG
l_string|&quot;%s: jpg_fbuffer_free()&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;jpg_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
)paren
r_continue
suffix:semicolon
singleline_comment|//if (alloc_contig) {
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.need_contiguous
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|0
)braket
)paren
(brace
id|mem
op_assign
(paren
r_int
r_char
op_star
)paren
id|bus_to_virt
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|off
op_assign
l_int|0
suffix:semicolon
id|off
OL
id|fh-&gt;jpg_buffers.buffer_size
suffix:semicolon
id|off
op_add_assign
id|PAGE_SIZE
)paren
id|ClearPageReserved
c_func
(paren
id|MAP_NR
(paren
id|mem
op_plus
id|off
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|mem
)paren
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|fh-&gt;jpg_buffers.buffer_size
op_div
id|PAGE_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
)paren
r_break
suffix:semicolon
id|ClearPageReserved
c_func
(paren
id|MAP_NR
(paren
id|bus_to_virt
(paren
id|le32_to_cpu
(paren
id|fh-&gt;jpg_buffers
dot
id|buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
)paren
)paren
)paren
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|bus_to_virt
(paren
id|le32_to_cpu
(paren
id|fh-&gt;jpg_buffers
dot
id|buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
)paren
)paren
)paren
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
)paren
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
op_assign
l_int|NULL
suffix:semicolon
)brace
id|fh-&gt;jpg_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;jpg_buffers.ready_to_be_freed
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   V4L Buffer grabbing&n; */
r_static
r_int
DECL|function|zoran_v4l_set_format
id|zoran_v4l_set_format
(paren
r_struct
id|file
op_star
id|file
comma
r_int
id|width
comma
r_int
id|height
comma
r_const
r_struct
id|zoran_format
op_star
id|format
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|bpp
suffix:semicolon
multiline_comment|/* Check size and format of the grab wanted */
r_if
c_cond
(paren
id|height
template_param
id|BUZ_MAX_WIDTH
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_set_format() - wrong frame size (%dx%d)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|width
comma
id|height
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|bpp
op_assign
(paren
id|format-&gt;depth
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
multiline_comment|/* Check against available buffer size */
r_if
c_cond
(paren
id|height
op_star
id|width
op_star
id|bpp
OG
id|fh-&gt;v4l_buffers.buffer_size
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_set_format() - video buffer size (%d kB) is too small&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fh-&gt;v4l_buffers.buffer_size
op_rshift
l_int|10
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* The video front end needs 4-byte alinged line sizes */
r_if
c_cond
(paren
(paren
id|bpp
op_eq
l_int|2
op_logical_and
(paren
id|width
op_amp
l_int|1
)paren
)paren
op_logical_or
(paren
id|bpp
op_eq
l_int|3
op_logical_and
(paren
id|width
op_amp
l_int|3
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_set_format() - wrong frame alingment&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|fh-&gt;v4l_settings.width
op_assign
id|width
suffix:semicolon
id|fh-&gt;v4l_settings.height
op_assign
id|height
suffix:semicolon
id|fh-&gt;v4l_settings.format
op_assign
id|format
suffix:semicolon
id|fh-&gt;v4l_settings.bytesperline
op_assign
id|bpp
op_star
id|fh-&gt;v4l_settings.width
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|zoran_v4l_queue_frame
id|zoran_v4l_queue_frame
(paren
r_struct
id|file
op_star
id|file
comma
r_int
id|num
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;v4l_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_queue_frame() - buffers not yet allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* No grabbing outside the buffer range! */
r_if
c_cond
(paren
id|num
op_ge
id|fh-&gt;v4l_buffers.num_buffers
op_logical_or
id|num
OL
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_queue_frame() - buffer %d is out of range&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|num
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
id|zr-&gt;v4l_buffers
op_assign
id|fh-&gt;v4l_buffers
suffix:semicolon
id|fh-&gt;v4l_buffers.active
op_assign
id|ZORAN_ACTIVE
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_queue_frame() - another session is already capturing&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
multiline_comment|/* make sure a grab isn&squot;t going on currently with this buffer */
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
r_switch
c_cond
(paren
id|zr-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|state
)paren
(brace
r_default
suffix:colon
(brace
)brace
r_case
id|BUZ_STATE_PEND
suffix:colon
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
id|fh-&gt;v4l_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|zr-&gt;v4l_buffers.allocated
op_assign
l_int|0
suffix:semicolon
)brace
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* what are you doing? */
r_break
suffix:semicolon
r_case
id|BUZ_STATE_DONE
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_WARNING
l_string|&quot;%s: v4l_queue_frame() - queueing buffer %d in state DONE!?&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|num
)paren
suffix:semicolon
r_case
id|BUZ_STATE_USER
suffix:colon
multiline_comment|/* since there is at least one unused buffer there&squot;s room for at least&n;&t;&t;&t; * one more pend[] entry */
id|zr-&gt;v4l_pend
(braket
id|zr-&gt;v4l_pend_head
op_increment
op_amp
id|V4L_MASK_FRAME
)braket
op_assign
id|num
suffix:semicolon
id|zr-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|state
op_assign
id|BUZ_STATE_PEND
suffix:semicolon
id|zr-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|bs.length
op_assign
id|fh-&gt;v4l_settings.bytesperline
op_star
id|zr-&gt;v4l_settings.height
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|num
)braket
op_assign
id|zr-&gt;v4l_buffers.buffer
(braket
id|num
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_and
id|zr-&gt;v4l_buffers.active
op_eq
id|ZORAN_FREE
)paren
id|zr-&gt;v4l_buffers.active
op_assign
id|fh-&gt;v4l_buffers.active
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_static
r_int
DECL|function|v4l_grab
id|v4l_grab
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|video_mmap
op_star
id|mp
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num_formats
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zoran_formats
(braket
id|i
)braket
dot
id|palette
op_eq
id|mp-&gt;format
op_logical_and
id|zoran_formats
(braket
id|i
)braket
dot
id|flags
op_amp
id|ZORAN_FORMAT_CAPTURE
op_logical_and
op_logical_neg
(paren
id|zoran_formats
(braket
id|i
)braket
dot
id|flags
op_amp
id|ZORAN_FORMAT_COMPRESSED
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|zoran_num_formats
op_logical_or
id|zoran_formats
(braket
id|i
)braket
dot
id|depth
op_eq
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_grab() - wrong bytes-per-pixel format&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * To minimize the time spent in the IRQ routine, we avoid setting up&n;&t; * the video front end there.&n;&t; * If this grab has different parameters from a running streaming capture&n;&t; * we stop the streaming capture and start it over again.&n;&t; */
r_if
c_cond
(paren
id|zr-&gt;v4l_memgrab_active
op_logical_and
(paren
id|zr-&gt;v4l_settings.width
op_ne
id|mp-&gt;width
op_logical_or
id|zr-&gt;v4l_settings.height
op_ne
id|mp-&gt;height
op_logical_or
id|zr-&gt;v4l_settings.format-&gt;palette
op_ne
id|mp-&gt;format
)paren
)paren
(brace
id|res
op_assign
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_v4l_set_format
c_func
(paren
id|file
comma
id|mp-&gt;width
comma
id|mp-&gt;height
comma
op_amp
id|zoran_formats
(braket
id|i
)braket
)paren
)paren
)paren
r_return
id|res
suffix:semicolon
id|zr-&gt;v4l_settings
op_assign
id|fh-&gt;v4l_settings
suffix:semicolon
multiline_comment|/* queue the frame in the pending queue */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_v4l_queue_frame
c_func
(paren
id|file
comma
id|mp-&gt;frame
)paren
)paren
)paren
(brace
id|fh-&gt;v4l_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* put the 36057 into frame grabbing mode */
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_and
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
singleline_comment|//dprintk(4, KERN_INFO &quot;%s: Frame grab 3...&bslash;n&quot;, ZR_DEVNAME(zr));
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * Sync on a V4L buffer&n; */
r_static
r_int
DECL|function|v4l_sync
id|v4l_sync
(paren
r_struct
id|file
op_star
id|file
comma
r_int
id|frame
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_sync() - no grab active for this session&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* check passed-in frame number */
r_if
c_cond
(paren
id|frame
op_ge
id|fh-&gt;v4l_buffers.num_buffers
op_logical_or
id|frame
OL
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_sync() - frame %d is invalid&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|frame
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Check if is buffer was queued at all */
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_eq
id|BUZ_STATE_USER
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l_sync() - attempt to sync on a buffer which was not queued?&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPROTO
suffix:semicolon
)brace
multiline_comment|/* wait on this buffer to get ready */
r_while
c_loop
(paren
id|zr-&gt;v4l_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_eq
id|BUZ_STATE_PEND
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
comma
l_int|10
op_star
id|HZ
)paren
)paren
r_return
op_minus
id|ETIME
suffix:semicolon
r_else
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
multiline_comment|/* buffer should now be in BUZ_STATE_DONE */
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_ne
id|BUZ_STATE_DONE
)paren
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_ERR
l_string|&quot;%s: v4l_sync() - internal state error&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|zr-&gt;v4l_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|frame
)braket
op_assign
id|zr-&gt;v4l_buffers.buffer
(braket
id|frame
)braket
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Check if streaming capture has finished */
r_if
c_cond
(paren
id|zr-&gt;v4l_pend_tail
op_eq
id|zr-&gt;v4l_pend_head
)paren
(brace
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.active
op_eq
id|ZORAN_ACTIVE
)paren
(brace
id|fh-&gt;v4l_buffers.active
op_assign
id|zr-&gt;v4l_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|zr-&gt;v4l_buffers.allocated
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   Queue a MJPEG buffer for capture/playback&n; */
r_static
r_int
DECL|function|zoran_jpg_queue_frame
id|zoran_jpg_queue_frame
(paren
r_struct
id|file
op_star
id|file
comma
r_int
id|num
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Check if buffers are allocated */
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;jpg_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_queue_frame() - buffers not yet allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* No grabbing outside the buffer range! */
r_if
c_cond
(paren
id|num
op_ge
id|fh-&gt;jpg_buffers.num_buffers
op_logical_or
id|num
OL
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_queue_frame() - buffer %d out of range&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|num
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* what is the codec mode right now? */
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_IDLE
)paren
(brace
id|zr-&gt;jpg_settings
op_assign
id|fh-&gt;jpg_settings
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|mode
)paren
(brace
multiline_comment|/* wrong codec mode active - invalid */
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_queue_frame() - codec in wrong mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
id|zr-&gt;jpg_buffers
op_assign
id|fh-&gt;jpg_buffers
suffix:semicolon
id|fh-&gt;jpg_buffers.active
op_assign
id|ZORAN_ACTIVE
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_queue_frame() - another session is already capturing&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_and
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_IDLE
)paren
(brace
multiline_comment|/* Ok load up the jpeg codec */
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|mode
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
r_switch
c_cond
(paren
id|zr-&gt;jpg_buffers.buffer
(braket
id|num
)braket
dot
id|state
)paren
(brace
r_case
id|BUZ_STATE_DONE
suffix:colon
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_WARNING
l_string|&quot;%s: jpg_queue_frame() - queing frame in BUZ_STATE_DONE state!?&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_case
id|BUZ_STATE_USER
suffix:colon
multiline_comment|/* since there is at least one unused buffer there&squot;s room for at&n;&t;&t;&t; *least one more pend[] entry */
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_que_head
op_increment
op_amp
id|BUZ_MASK_FRAME
)braket
op_assign
id|num
suffix:semicolon
id|zr-&gt;jpg_buffers.buffer
(braket
id|num
)braket
dot
id|state
op_assign
id|BUZ_STATE_PEND
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|num
)braket
op_assign
id|zr-&gt;jpg_buffers.buffer
(braket
id|num
)braket
suffix:semicolon
id|zoran_feed_stat_com
c_func
(paren
id|zr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_case
id|BUZ_STATE_DMA
suffix:colon
r_case
id|BUZ_STATE_PEND
suffix:colon
r_if
c_cond
(paren
id|zr-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
id|fh-&gt;jpg_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|zr-&gt;jpg_buffers.allocated
op_assign
l_int|0
suffix:semicolon
)brace
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* what are you doing? */
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_and
id|zr-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
id|zr-&gt;jpg_buffers.active
op_assign
id|fh-&gt;jpg_buffers.active
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
r_static
r_int
DECL|function|jpg_qbuf
id|jpg_qbuf
(paren
r_struct
id|file
op_star
id|file
comma
r_int
id|frame
comma
r_enum
id|zoran_codec_mode
id|mode
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Does the user want to stop streaming? */
r_if
c_cond
(paren
id|frame
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|mode
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_qbuf(-1) - session not active&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|fh-&gt;jpg_buffers.active
op_assign
id|zr-&gt;jpg_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|zr-&gt;jpg_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|BUZ_MODE_IDLE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_qbuf() - stop streaming but not in streaming mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_jpg_queue_frame
c_func
(paren
id|file
comma
id|frame
comma
id|mode
)paren
)paren
)paren
r_return
id|res
suffix:semicolon
multiline_comment|/* Start the jpeg codec when the first frame is queued  */
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_and
id|zr-&gt;jpg_que_head
op_eq
l_int|1
)paren
id|jpeg_start
c_func
(paren
id|zr
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; *   Sync on a MJPEG buffer&n; */
r_static
r_int
DECL|function|jpg_sync
id|jpg_sync
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|zoran_sync
op_star
id|bs
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|frame
comma
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_sync() - capture is not currently active&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_MOTION_DECOMPRESS
op_logical_and
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_MOTION_COMPRESS
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_sync() - codec not in streaming mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_while
c_loop
(paren
id|zr-&gt;jpg_que_tail
op_eq
id|zr-&gt;jpg_dma_tail
)paren
(brace
r_if
c_cond
(paren
id|zr-&gt;jpg_dma_tail
op_eq
id|zr-&gt;jpg_dma_head
)paren
r_break
suffix:semicolon
id|timeout
op_assign
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
comma
l_int|10
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
r_int
id|isr
suffix:semicolon
id|btand
c_func
(paren
op_complement
id|ZR36057_JMC_Go_en
comma
id|ZR36057_JMC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|zr-&gt;codec
op_member_access_from_pointer
id|control
c_func
(paren
id|zr-&gt;codec
comma
id|CODEC_G_STATUS
comma
r_sizeof
(paren
id|isr
)paren
comma
op_amp
id|isr
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: jpg_sync() - timeout: codec isr=0x%02x&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|isr
)paren
suffix:semicolon
r_return
op_minus
id|ETIME
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;jpg_dma_tail
op_ne
id|zr-&gt;jpg_dma_head
)paren
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_que_tail
op_increment
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
r_else
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_que_tail
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
multiline_comment|/* buffer should now be in BUZ_STATE_DONE */
r_if
c_cond
(paren
op_star
id|zr_debug
OG
l_int|0
)paren
r_if
c_cond
(paren
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_ne
id|BUZ_STATE_DONE
)paren
id|dprintk
c_func
(paren
l_int|2
comma
id|KERN_ERR
l_string|&quot;%s: jpg_sync() - internal state error&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
op_star
id|bs
op_assign
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
dot
id|bs
suffix:semicolon
id|bs-&gt;frame
op_assign
id|frame
suffix:semicolon
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
op_assign
id|zr-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|zr-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|zoran_open_init_session
id|zoran_open_init_session
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
multiline_comment|/* Per default, map the V4L Buffers */
id|fh-&gt;map_mode
op_assign
id|ZORAN_MAP_MODE_RAW
suffix:semicolon
multiline_comment|/* take over the card&squot;s current settings */
id|fh-&gt;overlay_settings
op_assign
id|zr-&gt;overlay_settings
suffix:semicolon
id|fh-&gt;overlay_settings.is_set
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;overlay_settings.format
op_assign
id|zr-&gt;overlay_settings.format
suffix:semicolon
id|fh-&gt;overlay_active
op_assign
id|ZORAN_FREE
suffix:semicolon
multiline_comment|/* v4l settings */
id|fh-&gt;v4l_settings
op_assign
id|zr-&gt;v4l_settings
suffix:semicolon
multiline_comment|/* v4l_buffers */
id|memset
c_func
(paren
op_amp
id|fh-&gt;v4l_buffers
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zoran_v4l_struct
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VIDEO_MAX_FRAME
suffix:semicolon
id|i
op_increment
)paren
(brace
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
multiline_comment|/* nothing going on */
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|bs.frame
op_assign
id|i
suffix:semicolon
)brace
id|fh-&gt;v4l_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;v4l_buffers.ready_to_be_freed
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;v4l_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer_size
op_assign
id|v4l_bufsize
suffix:semicolon
id|fh-&gt;v4l_buffers.num_buffers
op_assign
id|v4l_nbufs
suffix:semicolon
multiline_comment|/* jpg settings */
id|fh-&gt;jpg_settings
op_assign
id|zr-&gt;jpg_settings
suffix:semicolon
multiline_comment|/* jpg_buffers */
id|memset
c_func
(paren
op_amp
id|fh-&gt;jpg_buffers
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zoran_jpg_struct
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BUZ_MAX_FRAME
suffix:semicolon
id|i
op_increment
)paren
(brace
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
multiline_comment|/* nothing going on */
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|bs.frame
op_assign
id|i
suffix:semicolon
)brace
id|fh-&gt;jpg_buffers.need_contiguous
op_assign
id|zr-&gt;jpg_buffers.need_contiguous
suffix:semicolon
id|fh-&gt;jpg_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;jpg_buffers.ready_to_be_freed
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;jpg_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer_size
op_assign
id|jpg_bufsize
suffix:semicolon
id|fh-&gt;jpg_buffers.num_buffers
op_assign
id|jpg_nbufs
suffix:semicolon
)brace
r_static
r_void
DECL|function|zoran_close_end_session
id|zoran_close_end_session
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
multiline_comment|/* overlay */
r_if
c_cond
(paren
id|fh-&gt;overlay_active
op_ne
id|ZORAN_FREE
)paren
(brace
id|fh-&gt;overlay_active
op_assign
id|zr-&gt;overlay_active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|zr-&gt;v4l_overlay_active
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|zr-&gt;overlay_mask
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* v4l capture */
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|zr-&gt;v4l_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_buffers.active
op_assign
id|fh-&gt;v4l_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
)brace
multiline_comment|/* v4l buffers */
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.allocated
op_logical_or
id|fh-&gt;v4l_buffers.ready_to_be_freed
)paren
(brace
id|v4l_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
)brace
multiline_comment|/* jpg capture */
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|BUZ_MODE_IDLE
)paren
suffix:semicolon
id|zr-&gt;jpg_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_buffers.active
op_assign
id|fh-&gt;jpg_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
)brace
multiline_comment|/* jpg buffers */
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.allocated
op_logical_or
id|fh-&gt;jpg_buffers.ready_to_be_freed
)paren
(brace
id|jpg_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *   Open a zoran card. Right now the flags stuff is just playing&n; */
r_static
r_int
DECL|function|zoran_open
id|zoran_open
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_int
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|zoran_fh
op_star
id|fh
suffix:semicolon
r_int
id|i
comma
id|res
comma
id|first_open
op_assign
l_int|0
comma
id|have_module_locks
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* find the device */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zoran
(braket
id|i
)braket
dot
id|video_dev-&gt;minor
op_eq
id|minor
)paren
(brace
id|zr
op_assign
op_amp
id|zoran
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|zr
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: device not found!&bslash;n&quot;
comma
id|ZORAN_NAME
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|open_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* see fs/device.c - the kernel already locks during open(),&n;&t; * so locking ourselves only causes deadlocks */
multiline_comment|/*down(&amp;zr-&gt;resource_lock);*/
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;decoder
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: no TV decoder loaded for device!&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|open_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* try to grab a module lock */
r_if
c_cond
(paren
op_logical_neg
id|try_module_get
c_func
(paren
id|THIS_MODULE
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: failed to acquire my own lock! PANIC!&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|open_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|try_module_get
c_func
(paren
id|zr-&gt;decoder-&gt;driver-&gt;owner
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: failed to grab ownership of i2c decoder&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EIO
suffix:semicolon
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
r_goto
id|open_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;encoder
op_logical_and
op_logical_neg
id|try_module_get
c_func
(paren
id|zr-&gt;encoder-&gt;driver-&gt;owner
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: failed to grab ownership of i2c encoder&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EIO
suffix:semicolon
id|module_put
c_func
(paren
id|zr-&gt;decoder-&gt;driver-&gt;owner
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
r_goto
id|open_unlock_and_return
suffix:semicolon
)brace
id|have_module_locks
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;user
op_ge
l_int|2048
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: too many users (%d) on device&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|zr-&gt;user
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|open_unlock_and_return
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;%s: zoran_open(%s, pid=[%d]), users(-)=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|zr-&gt;user
)paren
suffix:semicolon
multiline_comment|/* now, create the open()-specific file_ops struct */
id|fh
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zoran_fh
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fh
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zoran_open() - allocation of zoran_fh failed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|open_unlock_and_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|fh
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zoran_fh
)paren
)paren
suffix:semicolon
multiline_comment|/* used to be BUZ_MAX_WIDTH/HEIGHT, but that gives overflows&n;&t; * on norm-change! */
id|fh-&gt;overlay_mask
op_assign
id|kmalloc
c_func
(paren
(paren
(paren
l_int|768
op_plus
l_int|31
)paren
op_div
l_int|32
)paren
op_star
l_int|576
op_star
l_int|4
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;overlay_mask
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zoran_open() - allocation of overlay_mask failed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fh
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|open_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;user
op_increment
op_eq
l_int|0
)paren
id|first_open
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*up(&amp;zr-&gt;resource_lock);*/
multiline_comment|/* default setup - TODO: look at flags */
r_if
c_cond
(paren
id|first_open
)paren
(brace
multiline_comment|/* First device open */
id|zr36057_restart
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zoran_open_init_params
c_func
(paren
id|zr
)paren
suffix:semicolon
id|zoran_init_hardware
c_func
(paren
id|zr
)paren
suffix:semicolon
id|btor
c_func
(paren
id|ZR36057_ICR_IntPinEn
comma
id|ZR36057_ICR
)paren
suffix:semicolon
)brace
multiline_comment|/* set file_ops stuff */
id|file-&gt;private_data
op_assign
id|fh
suffix:semicolon
id|fh-&gt;zr
op_assign
id|zr
suffix:semicolon
id|zoran_open_init_session
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|open_unlock_and_return
suffix:colon
multiline_comment|/* if we grabbed locks, release them accordingly */
r_if
c_cond
(paren
id|have_module_locks
)paren
(brace
id|module_put
c_func
(paren
id|zr-&gt;decoder-&gt;driver-&gt;owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;encoder
)paren
(brace
id|module_put
c_func
(paren
id|zr-&gt;encoder-&gt;driver-&gt;owner
)paren
suffix:semicolon
)brace
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
)brace
multiline_comment|/* if there&squot;s no device found, we didn&squot;t obtain the lock either */
r_if
c_cond
(paren
id|zr
)paren
(brace
multiline_comment|/*up(&amp;zr-&gt;resource_lock);*/
)brace
r_return
id|res
suffix:semicolon
)brace
r_static
r_int
DECL|function|zoran_close
id|zoran_close
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_INFO
l_string|&quot;%s: zoran_close(%s, pid=[%d]), users(+)=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|zr-&gt;user
)paren
suffix:semicolon
multiline_comment|/* kernel locks (fs/device.c), so don&squot;t do that ourselves&n;&t; * (prevents deadlocks) */
multiline_comment|/*down(&amp;zr-&gt;resource_lock);*/
id|zoran_close_end_session
c_func
(paren
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;user
op_decrement
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Last process */
multiline_comment|/* Clean up JPEG process */
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;jpg_capq
)paren
suffix:semicolon
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|BUZ_MODE_IDLE
)paren
suffix:semicolon
id|zr-&gt;jpg_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
multiline_comment|/* disable interrupts */
id|btand
c_func
(paren
op_complement
id|ZR36057_ICR_IntPinEn
comma
id|ZR36057_ICR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|zr_debug
OG
l_int|1
)paren
id|print_interrupts
c_func
(paren
id|zr
)paren
suffix:semicolon
multiline_comment|/* Overlay off */
id|zr-&gt;v4l_overlay_active
op_assign
l_int|0
suffix:semicolon
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|zr-&gt;overlay_mask
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* capture off */
id|wake_up_interruptible
c_func
(paren
op_amp
id|zr-&gt;v4l_capq
)paren
suffix:semicolon
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|zr-&gt;v4l_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|zoran_set_pci_master
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pass_through
)paren
(brace
multiline_comment|/* Switch to color bar */
r_int
id|zero
op_assign
l_int|0
comma
id|two
op_assign
l_int|2
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_ENABLE_OUTPUT
comma
op_amp
id|zero
)paren
suffix:semicolon
id|encoder_command
c_func
(paren
id|zr
comma
id|ENCODER_SET_INPUT
comma
op_amp
id|two
)paren
suffix:semicolon
)brace
)brace
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|fh-&gt;overlay_mask
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fh
)paren
suffix:semicolon
multiline_comment|/* release locks on the i2c modules */
id|module_put
c_func
(paren
id|zr-&gt;decoder-&gt;driver-&gt;owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;encoder
)paren
(brace
id|module_put
c_func
(paren
id|zr-&gt;encoder-&gt;driver-&gt;owner
)paren
suffix:semicolon
)brace
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
multiline_comment|/*up(&amp;zr-&gt;resource_lock);*/
id|dprintk
c_func
(paren
l_int|4
comma
id|KERN_INFO
l_string|&quot;%s: zoran_close() done&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|zoran_read
id|zoran_read
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|data
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
multiline_comment|/* we simply don&squot;t support read() (yet)... */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|zoran_write
id|zoran_write
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|data
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
multiline_comment|/* ...and the same goes for write() */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|setup_fbuffer
id|setup_fbuffer
(paren
r_struct
id|file
op_star
id|file
comma
r_void
op_star
id|base
comma
r_const
r_struct
id|zoran_format
op_star
id|fmt
comma
r_int
id|width
comma
r_int
id|height
comma
r_int
id|bytesperline
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
multiline_comment|/* (Ronald) v4l/v4l2 guidelines */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* we need a bytesperline value, even if not given */
r_if
c_cond
(paren
op_logical_neg
id|bytesperline
)paren
id|bytesperline
op_assign
id|width
op_star
(paren
(paren
id|fmt-&gt;depth
op_plus
l_int|7
)paren
op_amp
op_complement
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|zr-&gt;overlay_active
)paren
(brace
multiline_comment|/* dzjee... stupid users... don&squot;t even bother to turn off&n;&t;&t; * overlay before changing the memory location...&n;&t;&t; * normally, we would return errors here. However, one of&n;&t;&t; * the tools that does this is... xawtv! and since xawtv&n;&t;&t; * is used by +/- 99% of the users, we&squot;d rather be user-&n;&t;&t; * friendly and silently do as if nothing went wrong */
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_ERR
l_string|&quot;%s: setup_fbuffer() - forced overlay turnoff because framebuffer changed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|fmt-&gt;flags
op_amp
id|ZORAN_FORMAT_OVERLAY
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_fbuffer() - no valid overlay format given&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|height
op_le
l_int|0
op_logical_or
id|width
op_le
l_int|0
op_logical_or
id|bytesperline
op_le
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_fbuffer() - invalid height/width/bpl value (%d|%d|%d)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|width
comma
id|height
comma
id|bytesperline
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bytesperline
op_amp
l_int|3
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_fbuffer() - bytesperline (%d) must be 4-byte aligned&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|bytesperline
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|zr-&gt;buffer.base
op_assign
(paren
r_void
op_star
)paren
(paren
(paren
r_int
r_int
)paren
id|base
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
id|zr-&gt;buffer.height
op_assign
id|height
suffix:semicolon
id|zr-&gt;buffer.width
op_assign
id|width
suffix:semicolon
id|zr-&gt;buffer.depth
op_assign
id|fmt-&gt;depth
suffix:semicolon
id|zr-&gt;overlay_settings.format
op_assign
id|fmt
suffix:semicolon
id|zr-&gt;buffer.bytesperline
op_assign
id|bytesperline
suffix:semicolon
multiline_comment|/* The user should set new window parameters */
id|zr-&gt;overlay_settings.is_set
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|setup_window
id|setup_window
(paren
r_struct
id|file
op_star
id|file
comma
r_int
id|x
comma
r_int
id|y
comma
r_int
id|width
comma
r_int
id|height
comma
r_struct
id|video_clip
id|__user
op_star
id|clips
comma
r_int
id|clipcount
comma
r_void
id|__user
op_star
id|bitmap
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_struct
id|video_clip
op_star
id|vcp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|on
comma
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;buffer.base
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_window() - frame buffer has to be set first&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;overlay_settings.format
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_window() - no overlay format set&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The video front end needs 4-byte alinged line sizes, we correct that&n;&t; * silently here if necessary&n;&t; */
r_if
c_cond
(paren
id|zr-&gt;buffer.depth
op_eq
l_int|15
op_logical_or
id|zr-&gt;buffer.depth
op_eq
l_int|16
)paren
(brace
id|end
op_assign
(paren
id|x
op_plus
id|width
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
multiline_comment|/* round down */
id|x
op_assign
(paren
id|x
op_plus
l_int|1
)paren
op_amp
op_complement
l_int|1
suffix:semicolon
multiline_comment|/* round up */
id|width
op_assign
id|end
op_minus
id|x
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;buffer.depth
op_eq
l_int|24
)paren
(brace
id|end
op_assign
(paren
id|x
op_plus
id|width
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* round down */
id|x
op_assign
(paren
id|x
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
multiline_comment|/* round up */
id|width
op_assign
id|end
op_minus
id|x
suffix:semicolon
)brace
r_if
c_cond
(paren
id|width
OG
id|BUZ_MAX_WIDTH
)paren
id|width
op_assign
id|BUZ_MAX_WIDTH
suffix:semicolon
r_if
c_cond
(paren
id|height
OG
id|BUZ_MAX_HEIGHT
)paren
id|height
op_assign
id|BUZ_MAX_HEIGHT
suffix:semicolon
multiline_comment|/* Check for vaild parameters */
r_if
c_cond
(paren
id|width
template_param
id|BUZ_MAX_HEIGHT
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_window() - width = %d or height = %d invalid&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|width
comma
id|height
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|fh-&gt;overlay_settings.x
op_assign
id|x
suffix:semicolon
id|fh-&gt;overlay_settings.y
op_assign
id|y
suffix:semicolon
id|fh-&gt;overlay_settings.width
op_assign
id|width
suffix:semicolon
id|fh-&gt;overlay_settings.height
op_assign
id|height
suffix:semicolon
id|fh-&gt;overlay_settings.clipcount
op_assign
id|clipcount
suffix:semicolon
multiline_comment|/*&n;&t; * If an overlay is running, we have to switch it off&n;&t; * and switch it on again in order to get the new settings in effect.&n;&t; *&n;&t; * We also want to avoid that the overlay mask is written&n;&t; * when an overlay is running.&n;&t; */
id|on
op_assign
id|zr-&gt;v4l_overlay_active
op_logical_and
op_logical_neg
id|zr-&gt;v4l_memgrab_active
op_logical_and
id|zr-&gt;overlay_active
op_ne
id|ZORAN_FREE
op_logical_and
id|fh-&gt;overlay_active
op_ne
id|ZORAN_FREE
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *   Write the overlay mask if clips are wanted.&n;&t; *   We prefer a bitmap.&n;&t; */
r_if
c_cond
(paren
id|bitmap
)paren
(brace
multiline_comment|/* fake value - it just means we want clips */
id|fh-&gt;overlay_settings.clipcount
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|fh-&gt;overlay_mask
comma
id|bitmap
comma
(paren
id|width
op_star
id|height
op_plus
l_int|7
)paren
op_div
l_int|8
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|clipcount
OG
l_int|0
)paren
(brace
multiline_comment|/* write our own bitmap from the clips */
id|vcp
op_assign
id|vmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
(paren
id|clipcount
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vcp
op_eq
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_window() - Alloc of clip mask failed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
(paren
id|vcp
comma
id|clips
comma
r_sizeof
(paren
r_struct
id|video_clip
)paren
op_star
id|clipcount
)paren
)paren
(brace
id|vfree
c_func
(paren
id|vcp
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|write_overlay_mask
c_func
(paren
id|file
comma
id|vcp
comma
id|clipcount
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|vcp
)paren
suffix:semicolon
)brace
id|fh-&gt;overlay_settings.is_set
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;overlay_active
op_ne
id|ZORAN_FREE
op_logical_and
id|zr-&gt;overlay_active
op_ne
id|ZORAN_FREE
)paren
id|zr-&gt;overlay_settings
op_assign
id|fh-&gt;overlay_settings
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Make sure the changes come into effect */
r_return
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|setup_overlay
id|setup_overlay
(paren
r_struct
id|file
op_star
id|file
comma
r_int
id|on
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
multiline_comment|/* If there is nothing to do, return immediatly */
r_if
c_cond
(paren
(paren
id|on
op_logical_and
id|fh-&gt;overlay_active
op_ne
id|ZORAN_FREE
)paren
op_logical_or
(paren
op_logical_neg
id|on
op_logical_and
id|fh-&gt;overlay_active
op_eq
id|ZORAN_FREE
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* check whether we&squot;re touching someone else&squot;s overlay */
r_if
c_cond
(paren
id|on
op_logical_and
id|zr-&gt;overlay_active
op_ne
id|ZORAN_FREE
op_logical_and
id|fh-&gt;overlay_active
op_eq
id|ZORAN_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_overlay() - overlay is already active for another session&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|on
op_logical_and
id|zr-&gt;overlay_active
op_ne
id|ZORAN_FREE
op_logical_and
id|fh-&gt;overlay_active
op_eq
id|ZORAN_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_overlay() - you cannot cancel someone else&squot;s session&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|on
op_eq
l_int|0
)paren
(brace
id|zr-&gt;overlay_active
op_assign
id|fh-&gt;overlay_active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|zr-&gt;v4l_overlay_active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* When a grab is running, the video simply&n;&t;&t; * won&squot;t be switched on any more */
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|zr-&gt;overlay_mask
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;buffer.base
op_logical_or
op_logical_neg
id|fh-&gt;overlay_settings.is_set
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_overlay() - buffer or window not set&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;overlay_settings.format
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: setup_overlay() - no overlay format set&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|zr-&gt;overlay_active
op_assign
id|fh-&gt;overlay_active
op_assign
id|ZORAN_LOCKED
suffix:semicolon
id|zr-&gt;v4l_overlay_active
op_assign
l_int|1
suffix:semicolon
id|zr-&gt;overlay_mask
op_assign
id|fh-&gt;overlay_mask
suffix:semicolon
id|zr-&gt;overlay_settings
op_assign
id|fh-&gt;overlay_settings
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* When a grab is running, the video will be&n;&t;&t; * switched on when grab is finished */
)brace
multiline_comment|/* Make sure the changes come into effect */
r_return
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
)brace
macro_line|#ifdef HAVE_V4L2
multiline_comment|/* get the status of a buffer in the clients buffer queue */
r_static
r_int
DECL|function|zoran_v4l2_buffer_status
id|zoran_v4l2_buffer_status
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|v4l2_buffer
op_star
id|buf
comma
r_int
id|num
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
id|buf-&gt;flags
op_assign
id|V4L2_BUF_FLAG_MAPPED
suffix:semicolon
r_switch
c_cond
(paren
id|fh-&gt;map_mode
)paren
(brace
r_case
id|ZORAN_MAP_MODE_RAW
suffix:colon
multiline_comment|/* check range */
r_if
c_cond
(paren
id|num
OL
l_int|0
op_logical_or
id|num
op_ge
id|fh-&gt;v4l_buffers.num_buffers
op_logical_or
op_logical_neg
id|fh-&gt;v4l_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l2_buffer_status() - wrong number or buffers not allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf-&gt;type
op_assign
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:semicolon
id|buf-&gt;length
op_assign
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
multiline_comment|/* get buffer */
id|buf-&gt;bytesused
op_assign
id|fh-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|bs.length
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|state
op_eq
id|BUZ_STATE_DONE
op_logical_or
id|fh-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|state
op_eq
id|BUZ_STATE_USER
)paren
(brace
id|buf-&gt;sequence
op_assign
id|fh-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|bs.seq
suffix:semicolon
id|buf-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_DONE
suffix:semicolon
id|buf-&gt;timestamp
op_assign
id|fh-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|bs.timestamp
suffix:semicolon
)brace
r_else
(brace
id|buf-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_QUEUED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fh-&gt;v4l_settings.height
op_le
id|BUZ_MAX_HEIGHT
op_div
l_int|2
)paren
id|buf-&gt;field
op_assign
id|V4L2_FIELD_TOP
suffix:semicolon
r_else
id|buf-&gt;field
op_assign
id|V4L2_FIELD_INTERLACED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
r_case
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:colon
multiline_comment|/* check range */
r_if
c_cond
(paren
id|num
OL
l_int|0
op_logical_or
id|num
op_ge
id|fh-&gt;jpg_buffers.num_buffers
op_logical_or
op_logical_neg
id|fh-&gt;jpg_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: v4l2_buffer_status() - wrong number or buffers not allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf-&gt;type
op_assign
(paren
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_JPG_REC
)paren
ques
c_cond
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
suffix:semicolon
id|buf-&gt;length
op_assign
id|fh-&gt;jpg_buffers.buffer_size
suffix:semicolon
multiline_comment|/* these variables are only written after frame has been captured */
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|num
)braket
dot
id|state
op_eq
id|BUZ_STATE_DONE
op_logical_or
id|fh-&gt;jpg_buffers.buffer
(braket
id|num
)braket
dot
id|state
op_eq
id|BUZ_STATE_USER
)paren
(brace
id|buf-&gt;sequence
op_assign
id|fh-&gt;jpg_buffers.buffer
(braket
id|num
)braket
dot
id|bs.seq
suffix:semicolon
id|buf-&gt;timestamp
op_assign
id|fh-&gt;jpg_buffers.buffer
(braket
id|num
)braket
dot
id|bs.timestamp
suffix:semicolon
id|buf-&gt;bytesused
op_assign
id|fh-&gt;jpg_buffers.buffer
(braket
id|num
)braket
dot
id|bs.length
suffix:semicolon
id|buf-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_DONE
suffix:semicolon
)brace
r_else
(brace
id|buf-&gt;flags
op_or_assign
id|V4L2_BUF_FLAG_QUEUED
suffix:semicolon
)brace
multiline_comment|/* which fields are these? */
r_if
c_cond
(paren
id|fh-&gt;jpg_settings.TmpDcm
op_ne
l_int|1
)paren
id|buf-&gt;field
op_assign
id|fh-&gt;jpg_settings
dot
id|odd_even
ques
c_cond
id|V4L2_FIELD_TOP
suffix:colon
id|V4L2_FIELD_BOTTOM
suffix:semicolon
r_else
id|buf-&gt;field
op_assign
id|fh-&gt;jpg_settings
dot
id|odd_even
ques
c_cond
id|V4L2_FIELD_SEQ_TB
suffix:colon
id|V4L2_FIELD_SEQ_BT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|5
comma
id|KERN_ERR
l_string|&quot;%s: v4l2_buffer_status() - invalid buffer type|map_mode (%d|%d)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf-&gt;memory
op_assign
id|V4L2_MEMORY_MMAP
suffix:semicolon
id|buf-&gt;index
op_assign
id|num
suffix:semicolon
id|buf-&gt;m.offset
op_assign
id|buf-&gt;length
op_star
id|num
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_static
r_int
DECL|function|zoran_set_norm
id|zoran_set_norm
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|norm
)paren
multiline_comment|/* VIDEO_MODE_* */
(brace
r_int
id|norm_encoder
comma
id|on
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.active
op_ne
id|ZORAN_FREE
op_logical_or
id|zr-&gt;jpg_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_WARNING
l_string|&quot;%s: set_norm() called while in playback/capture mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lock_norm
op_logical_and
id|norm
op_ne
id|zr-&gt;norm
)paren
(brace
r_if
c_cond
(paren
id|lock_norm
OG
l_int|1
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_WARNING
l_string|&quot;%s: set_norm() - TV standard is locked, can not switch norm&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_WARNING
l_string|&quot;%s: set_norm() - TV standard is locked, norm was not changed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|norm
op_assign
id|zr-&gt;norm
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|norm
op_ne
id|VIDEO_MODE_AUTO
op_logical_and
(paren
id|norm
OL
l_int|0
op_logical_or
id|norm
op_ge
id|zr-&gt;card.norms
op_logical_or
op_logical_neg
id|zr-&gt;card.tvn
(braket
id|norm
)braket
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: set_norm() - unsupported norm %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|norm
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|norm
op_eq
id|VIDEO_MODE_AUTO
)paren
(brace
r_int
id|status
suffix:semicolon
multiline_comment|/* if we have autodetect, ... */
r_struct
id|video_decoder_capability
id|caps
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_GET_CAPABILITIES
comma
op_amp
id|caps
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|caps.flags
op_amp
id|VIDEO_DECODER_AUTO
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: norm=auto unsupported&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_NORM
comma
op_amp
id|norm
)paren
suffix:semicolon
multiline_comment|/* let changes come into effect */
id|ssleep
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_GET_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|DECODER_STATUS_GOOD
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: set_norm() - no norm detected&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
multiline_comment|/* reset norm */
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_NORM
comma
op_amp
id|zr-&gt;norm
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|DECODER_STATUS_NTSC
)paren
id|norm
op_assign
id|VIDEO_MODE_NTSC
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|DECODER_STATUS_SECAM
)paren
id|norm
op_assign
id|VIDEO_MODE_SECAM
suffix:semicolon
r_else
id|norm
op_assign
id|VIDEO_MODE_PAL
suffix:semicolon
)brace
id|zr-&gt;timing
op_assign
id|zr-&gt;card.tvn
(braket
id|norm
)braket
suffix:semicolon
id|norm_encoder
op_assign
id|norm
suffix:semicolon
multiline_comment|/* We switch overlay off and on since a change in the&n;&t; * norm needs different VFE settings */
id|on
op_assign
id|zr-&gt;overlay_active
op_logical_and
op_logical_neg
id|zr-&gt;v4l_memgrab_active
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_NORM
comma
op_amp
id|norm
)paren
suffix:semicolon
id|encoder_command
c_func
(paren
id|zr
comma
id|ENCODER_SET_NORM
comma
op_amp
id|norm_encoder
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|zr36057_overlay
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Make sure the changes come into effect */
id|zr-&gt;norm
op_assign
id|norm
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|zoran_set_input
id|zoran_set_input
(paren
r_struct
id|zoran
op_star
id|zr
comma
r_int
id|input
)paren
(brace
r_int
id|realinput
suffix:semicolon
r_if
c_cond
(paren
id|input
op_eq
id|zr-&gt;input
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.active
op_ne
id|ZORAN_FREE
op_logical_or
id|zr-&gt;jpg_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_WARNING
l_string|&quot;%s: set_input() called while in playback/capture mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|input
OL
l_int|0
op_logical_or
id|input
op_ge
id|zr-&gt;card.inputs
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: set_input() - unnsupported input %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|input
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|realinput
op_assign
id|zr-&gt;card.input
(braket
id|input
)braket
dot
id|muxsel
suffix:semicolon
id|zr-&gt;input
op_assign
id|input
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_INPUT
comma
op_amp
id|realinput
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   ioctl routine&n; */
r_static
r_int
DECL|function|zoran_do_ioctl
id|zoran_do_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
multiline_comment|/* CAREFUL: used in multiple places here */
r_struct
id|zoran_jpg_settings
id|settings
suffix:semicolon
multiline_comment|/* we might have older buffers lying around... We don&squot;t want&n;&t; * to wait, but we do want to try cleaning them up ASAP. So&n;&t; * we try to obtain the lock and free them. If that fails, we&n;&t; * don&squot;t do anything and wait for the next turn. In the end,&n;&t; * zoran_close() or a new allocation will still free them...&n;&t; * This is just a &squot;the sooner the better&squot; extra &squot;feature&squot;&n;&t; *&n;&t; * We don&squot;t free the buffers right on munmap() because that&n;&t; * causes oopses (kfree() inside munmap() oopses for no&n;&t; * apparent reason - it&squot;s also not reproduceable in any way,&n;&t; * but moving the free code outside the munmap() handler fixes&n;&t; * all this... If someone knows why, please explain me (Ronald)&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|down_trylock
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
)paren
(brace
multiline_comment|/* we obtained it! Let&squot;s try to free some things */
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.ready_to_be_freed
)paren
id|jpg_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.ready_to_be_freed
)paren
id|v4l_fbuffer_free
c_func
(paren
id|file
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_struct
id|video_capability
op_star
id|vcap
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCGCAP&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vcap
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_capability
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|vcap-&gt;name
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
r_sizeof
(paren
id|vcap-&gt;name
)paren
)paren
suffix:semicolon
id|vcap-&gt;type
op_assign
id|ZORAN_VID_TYPE
suffix:semicolon
id|vcap-&gt;channels
op_assign
id|zr-&gt;card.inputs
suffix:semicolon
id|vcap-&gt;audios
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|vcap-&gt;maxwidth
op_assign
id|BUZ_MAX_WIDTH
suffix:semicolon
id|vcap-&gt;maxheight
op_assign
id|BUZ_MAX_HEIGHT
suffix:semicolon
id|vcap-&gt;minwidth
op_assign
id|BUZ_MIN_WIDTH
suffix:semicolon
id|vcap-&gt;minheight
op_assign
id|BUZ_MIN_HEIGHT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
op_star
id|vchan
op_assign
id|arg
suffix:semicolon
r_int
id|channel
op_assign
id|vchan-&gt;channel
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCGCHAN - channel=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|vchan-&gt;channel
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vchan
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_channel
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|channel
OG
id|zr-&gt;card.inputs
op_logical_or
id|channel
OL
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOCGCHAN on not existing channel %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|vchan-&gt;name
comma
id|zr-&gt;card.input
(braket
id|channel
)braket
dot
id|name
)paren
suffix:semicolon
id|vchan-&gt;tuners
op_assign
l_int|0
suffix:semicolon
id|vchan-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|vchan-&gt;type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|vchan-&gt;norm
op_assign
id|zr-&gt;norm
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|vchan-&gt;channel
op_assign
id|channel
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* RJ: the documentation at http://roadrunner.swansea.linux.org.uk/v4lapi.shtml says:&n;&t;&t; * &n;&t;&t; * * &quot;The VIDIOCSCHAN ioctl takes an integer argument and switches the capture to this input.&quot;&n;&t;&t; * *                                 ^^^^^^^&n;&t;&t; * * The famos BTTV driver has it implemented with a struct video_channel argument&n;&t;&t; * * and we follow it for compatibility reasons&n;&t;&t; * *&n;&t;&t; * * BTW: this is the only way the user can set the norm!&n;&t;&t; */
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_struct
id|video_channel
op_star
id|vchan
op_assign
id|arg
suffix:semicolon
r_int
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCSCHAN - channel=%d, norm=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|vchan-&gt;channel
comma
id|vchan-&gt;norm
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_set_input
c_func
(paren
id|zr
comma
id|vchan-&gt;channel
)paren
)paren
)paren
r_goto
id|schan_unlock_and_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_set_norm
c_func
(paren
id|zr
comma
id|vchan-&gt;norm
)paren
)paren
)paren
r_goto
id|schan_unlock_and_return
suffix:semicolon
multiline_comment|/* Make sure the changes come into effect */
id|res
op_assign
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
id|schan_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
op_star
id|vpict
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCGPICT&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vpict
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_picture
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|vpict-&gt;hue
op_assign
id|zr-&gt;hue
suffix:semicolon
id|vpict-&gt;brightness
op_assign
id|zr-&gt;brightness
suffix:semicolon
id|vpict-&gt;contrast
op_assign
id|zr-&gt;contrast
suffix:semicolon
id|vpict-&gt;colour
op_assign
id|zr-&gt;saturation
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;overlay_settings.format
)paren
(brace
id|vpict-&gt;depth
op_assign
id|fh-&gt;overlay_settings.format-&gt;depth
suffix:semicolon
id|vpict-&gt;palette
op_assign
id|fh-&gt;overlay_settings.format-&gt;palette
suffix:semicolon
)brace
r_else
(brace
id|vpict-&gt;depth
op_assign
l_int|0
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
op_star
id|vpict
op_assign
id|arg
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCSPICT - bri=%d, hue=%d, col=%d, con=%d, dep=%d, pal=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|vpict-&gt;brightness
comma
id|vpict-&gt;hue
comma
id|vpict-&gt;colour
comma
id|vpict-&gt;contrast
comma
id|vpict-&gt;depth
comma
id|vpict-&gt;palette
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num_formats
suffix:semicolon
id|i
op_increment
)paren
(brace
r_const
r_struct
id|zoran_format
op_star
id|fmt
op_assign
op_amp
id|zoran_formats
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;palette
op_ne
op_minus
l_int|1
op_logical_and
id|fmt-&gt;flags
op_amp
id|ZORAN_FORMAT_OVERLAY
op_logical_and
id|fmt-&gt;palette
op_eq
id|vpict-&gt;palette
op_logical_and
id|fmt-&gt;depth
op_eq
id|vpict-&gt;depth
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|zoran_num_formats
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOCSPICT - Invalid palette %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|vpict-&gt;palette
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_PICTURE
comma
id|vpict
)paren
suffix:semicolon
id|zr-&gt;hue
op_assign
id|vpict-&gt;hue
suffix:semicolon
id|zr-&gt;contrast
op_assign
id|vpict-&gt;contrast
suffix:semicolon
id|zr-&gt;saturation
op_assign
id|vpict-&gt;colour
suffix:semicolon
id|zr-&gt;brightness
op_assign
id|vpict-&gt;brightness
suffix:semicolon
id|fh-&gt;overlay_settings.format
op_assign
op_amp
id|zoran_formats
(braket
id|i
)braket
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCCAPTURE
suffix:colon
(brace
r_int
op_star
id|on
op_assign
id|arg
comma
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCCAPTURE - on=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|on
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|setup_overlay
c_func
(paren
id|file
comma
op_star
id|on
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
op_star
id|vwin
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCGWIN&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|vwin
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_window
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|vwin-&gt;x
op_assign
id|fh-&gt;overlay_settings.x
suffix:semicolon
id|vwin-&gt;y
op_assign
id|fh-&gt;overlay_settings.y
suffix:semicolon
id|vwin-&gt;width
op_assign
id|fh-&gt;overlay_settings.width
suffix:semicolon
id|vwin-&gt;height
op_assign
id|fh-&gt;overlay_settings.height
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|vwin-&gt;clipcount
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_struct
id|video_window
op_star
id|vwin
op_assign
id|arg
suffix:semicolon
r_int
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCSWIN - x=%d, y=%d, w=%d, h=%d, clipcount=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|vwin-&gt;x
comma
id|vwin-&gt;y
comma
id|vwin-&gt;width
comma
id|vwin-&gt;height
comma
id|vwin-&gt;clipcount
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|setup_window
c_func
(paren
id|file
comma
id|vwin-&gt;x
comma
id|vwin-&gt;y
comma
id|vwin-&gt;width
comma
id|vwin-&gt;height
comma
id|vwin-&gt;clips
comma
id|vwin-&gt;clipcount
comma
l_int|NULL
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCGFBUF
suffix:colon
(brace
r_struct
id|video_buffer
op_star
id|vbuf
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCGFBUF&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
op_star
id|vbuf
op_assign
id|zr-&gt;buffer
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCSFBUF
suffix:colon
(brace
r_struct
id|video_buffer
op_star
id|vbuf
op_assign
id|arg
suffix:semicolon
r_int
id|i
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCSFBUF - base=%p, w=%d, h=%d, depth=%d, bpl=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|vbuf-&gt;base
comma
id|vbuf-&gt;width
comma
id|vbuf-&gt;height
comma
id|vbuf-&gt;depth
comma
id|vbuf-&gt;bytesperline
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num_formats
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|zoran_formats
(braket
id|i
)braket
dot
id|depth
op_eq
id|vbuf-&gt;depth
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|zoran_num_formats
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOCSFBUF - invalid fbuf depth %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|vbuf-&gt;depth
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|setup_fbuffer
c_func
(paren
id|file
comma
id|vbuf-&gt;base
comma
op_amp
id|zoran_formats
(braket
id|i
)braket
comma
id|vbuf-&gt;width
comma
id|vbuf-&gt;height
comma
id|vbuf-&gt;bytesperline
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCSYNC
suffix:colon
(brace
r_int
op_star
id|frame
op_assign
id|arg
comma
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCSYNC - frame=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|frame
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|v4l_sync
c_func
(paren
id|file
comma
op_star
id|frame
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
id|zr-&gt;v4l_sync_tail
op_increment
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCMCAPTURE
suffix:colon
(brace
r_struct
id|video_mmap
op_star
id|vmap
op_assign
id|arg
suffix:semicolon
r_int
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCMCAPTURE - frame=%d, geom=%dx%d, fmt=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|vmap-&gt;frame
comma
id|vmap-&gt;width
comma
id|vmap-&gt;height
comma
id|vmap-&gt;format
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|v4l_grab
c_func
(paren
id|file
comma
id|vmap
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCGMBUF
suffix:colon
(brace
r_struct
id|video_mbuf
op_star
id|vmbuf
op_assign
id|arg
suffix:semicolon
r_int
id|i
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCGMBUF&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|vmbuf-&gt;size
op_assign
id|fh-&gt;v4l_buffers.num_buffers
op_star
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
id|vmbuf-&gt;frames
op_assign
id|fh-&gt;v4l_buffers.num_buffers
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|vmbuf-&gt;frames
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vmbuf-&gt;offsets
(braket
id|i
)braket
op_assign
id|i
op_star
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.allocated
op_logical_or
id|fh-&gt;v4l_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOCGMBUF - buffers already allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|v4l1reqbuf_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|v4l_fbuffer_alloc
c_func
(paren
id|file
)paren
)paren
(brace
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|v4l1reqbuf_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* The next mmap will map the V4L buffers */
id|fh-&gt;map_mode
op_assign
id|ZORAN_MAP_MODE_RAW
suffix:semicolon
id|v4l1reqbuf_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCGUNIT
suffix:colon
(brace
r_struct
id|video_unit
op_star
id|vunit
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOCGUNIT&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|vunit-&gt;video
op_assign
id|zr-&gt;video_dev-&gt;minor
suffix:semicolon
id|vunit-&gt;vbi
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vunit-&gt;radio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vunit-&gt;audio
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
id|vunit-&gt;teletext
op_assign
id|VIDEO_NO_UNIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * RJ: In principal we could support subcaptures for V4L grabbing.&n;&t;&t; *     Not even the famous BTTV driver has them, however.&n;&t;&t; *     If there should be a strong demand, one could consider&n;&t;&t; *     to implement them.&n;&t;&t; */
r_case
id|VIDIOCGCAPTURE
suffix:colon
(brace
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOCGCAPTURE not supported&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOCSCAPTURE
suffix:colon
(brace
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOCSCAPTURE not supported&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BUZIOC_G_PARAMS
suffix:colon
(brace
r_struct
id|zoran_params
op_star
id|bparams
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: BUZIOC_G_PARAMS&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|bparams
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|zoran_params
)paren
)paren
suffix:semicolon
id|bparams-&gt;major_version
op_assign
id|MAJOR_VERSION
suffix:semicolon
id|bparams-&gt;minor_version
op_assign
id|MINOR_VERSION
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|bparams-&gt;norm
op_assign
id|zr-&gt;norm
suffix:semicolon
id|bparams-&gt;input
op_assign
id|zr-&gt;input
suffix:semicolon
id|bparams-&gt;decimation
op_assign
id|fh-&gt;jpg_settings.decimation
suffix:semicolon
id|bparams-&gt;HorDcm
op_assign
id|fh-&gt;jpg_settings.HorDcm
suffix:semicolon
id|bparams-&gt;VerDcm
op_assign
id|fh-&gt;jpg_settings.VerDcm
suffix:semicolon
id|bparams-&gt;TmpDcm
op_assign
id|fh-&gt;jpg_settings.TmpDcm
suffix:semicolon
id|bparams-&gt;field_per_buff
op_assign
id|fh-&gt;jpg_settings.field_per_buff
suffix:semicolon
id|bparams-&gt;img_x
op_assign
id|fh-&gt;jpg_settings.img_x
suffix:semicolon
id|bparams-&gt;img_y
op_assign
id|fh-&gt;jpg_settings.img_y
suffix:semicolon
id|bparams-&gt;img_width
op_assign
id|fh-&gt;jpg_settings.img_width
suffix:semicolon
id|bparams-&gt;img_height
op_assign
id|fh-&gt;jpg_settings.img_height
suffix:semicolon
id|bparams-&gt;odd_even
op_assign
id|fh-&gt;jpg_settings.odd_even
suffix:semicolon
id|bparams-&gt;quality
op_assign
id|fh-&gt;jpg_settings.jpg_comp.quality
suffix:semicolon
id|bparams-&gt;APPn
op_assign
id|fh-&gt;jpg_settings.jpg_comp.APPn
suffix:semicolon
id|bparams-&gt;APP_len
op_assign
id|fh-&gt;jpg_settings.jpg_comp.APP_len
suffix:semicolon
id|memcpy
c_func
(paren
id|bparams-&gt;APP_data
comma
id|fh-&gt;jpg_settings.jpg_comp.APP_data
comma
r_sizeof
(paren
id|bparams-&gt;APP_data
)paren
)paren
suffix:semicolon
id|bparams-&gt;COM_len
op_assign
id|zr-&gt;jpg_settings.jpg_comp.COM_len
suffix:semicolon
id|memcpy
c_func
(paren
id|bparams-&gt;COM_data
comma
id|fh-&gt;jpg_settings.jpg_comp.COM_data
comma
r_sizeof
(paren
id|bparams-&gt;COM_data
)paren
)paren
suffix:semicolon
id|bparams-&gt;jpeg_markers
op_assign
id|fh-&gt;jpg_settings.jpg_comp.jpeg_markers
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|bparams-&gt;VFIFO_FB
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BUZIOC_S_PARAMS
suffix:colon
(brace
r_struct
id|zoran_params
op_star
id|bparams
op_assign
id|arg
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: BUZIOC_S_PARAMS&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|settings.decimation
op_assign
id|bparams-&gt;decimation
suffix:semicolon
id|settings.HorDcm
op_assign
id|bparams-&gt;HorDcm
suffix:semicolon
id|settings.VerDcm
op_assign
id|bparams-&gt;VerDcm
suffix:semicolon
id|settings.TmpDcm
op_assign
id|bparams-&gt;TmpDcm
suffix:semicolon
id|settings.field_per_buff
op_assign
id|bparams-&gt;field_per_buff
suffix:semicolon
id|settings.img_x
op_assign
id|bparams-&gt;img_x
suffix:semicolon
id|settings.img_y
op_assign
id|bparams-&gt;img_y
suffix:semicolon
id|settings.img_width
op_assign
id|bparams-&gt;img_width
suffix:semicolon
id|settings.img_height
op_assign
id|bparams-&gt;img_height
suffix:semicolon
id|settings.odd_even
op_assign
id|bparams-&gt;odd_even
suffix:semicolon
id|settings.jpg_comp.quality
op_assign
id|bparams-&gt;quality
suffix:semicolon
id|settings.jpg_comp.APPn
op_assign
id|bparams-&gt;APPn
suffix:semicolon
id|settings.jpg_comp.APP_len
op_assign
id|bparams-&gt;APP_len
suffix:semicolon
id|memcpy
c_func
(paren
id|settings.jpg_comp.APP_data
comma
id|bparams-&gt;APP_data
comma
r_sizeof
(paren
id|bparams-&gt;APP_data
)paren
)paren
suffix:semicolon
id|settings.jpg_comp.COM_len
op_assign
id|bparams-&gt;COM_len
suffix:semicolon
id|memcpy
c_func
(paren
id|settings.jpg_comp.COM_data
comma
id|bparams-&gt;COM_data
comma
r_sizeof
(paren
id|bparams-&gt;COM_data
)paren
)paren
suffix:semicolon
id|settings.jpg_comp.jpeg_markers
op_assign
id|bparams-&gt;jpeg_markers
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_IDLE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: BUZIOC_S_PARAMS called, but Buz in capture/playback mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|sparams_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* Check the params first before overwriting our&n;&t;&t; * nternal values */
r_if
c_cond
(paren
id|zoran_check_jpg_settings
c_func
(paren
id|zr
comma
op_amp
id|settings
)paren
)paren
(brace
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|sparams_unlock_and_return
suffix:semicolon
)brace
id|fh-&gt;jpg_settings
op_assign
id|settings
suffix:semicolon
id|sparams_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BUZIOC_REQBUFS
suffix:colon
(brace
r_struct
id|zoran_requestbuffers
op_star
id|breq
op_assign
id|arg
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: BUZIOC_REQBUFS - count=%lu, size=%lu&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|breq-&gt;count
comma
id|breq-&gt;size
)paren
suffix:semicolon
multiline_comment|/* Enforce reasonable lower and upper limits */
r_if
c_cond
(paren
id|breq-&gt;count
OL
l_int|4
)paren
id|breq-&gt;count
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* Could be choosen smaller */
r_if
c_cond
(paren
id|breq-&gt;count
OG
id|jpg_nbufs
)paren
id|breq-&gt;count
op_assign
id|jpg_nbufs
suffix:semicolon
id|breq-&gt;size
op_assign
id|PAGE_ALIGN
c_func
(paren
id|breq-&gt;size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|breq-&gt;size
OL
l_int|8192
)paren
id|breq-&gt;size
op_assign
l_int|8192
suffix:semicolon
multiline_comment|/* Arbitrary */
multiline_comment|/* breq-&gt;size is limited by 1 page for the stat_com&n;&t;&t; * tables to a Maximum of 2 MB */
r_if
c_cond
(paren
id|breq-&gt;size
OG
id|jpg_bufsize
)paren
id|breq-&gt;size
op_assign
id|jpg_bufsize
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.need_contiguous
op_logical_and
id|breq-&gt;size
OG
id|MAX_KMALLOC_MEM
)paren
id|breq-&gt;size
op_assign
id|MAX_KMALLOC_MEM
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.allocated
op_logical_or
id|fh-&gt;v4l_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: BUZIOC_REQBUFS - buffers allready allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|jpgreqbuf_unlock_and_return
suffix:semicolon
)brace
id|fh-&gt;jpg_buffers.num_buffers
op_assign
id|breq-&gt;count
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer_size
op_assign
id|breq-&gt;size
suffix:semicolon
r_if
c_cond
(paren
id|jpg_fbuffer_alloc
c_func
(paren
id|file
)paren
)paren
(brace
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|jpgreqbuf_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* The next mmap will map the MJPEG buffers - could&n;&t;&t; * also be *_PLAY, but it doesn&squot;t matter here */
id|fh-&gt;map_mode
op_assign
id|ZORAN_MAP_MODE_JPG_REC
suffix:semicolon
id|jpgreqbuf_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BUZIOC_QBUF_CAPT
suffix:colon
(brace
r_int
op_star
id|frame
op_assign
id|arg
comma
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: BUZIOC_QBUF_CAPT - frame=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|frame
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|jpg_qbuf
c_func
(paren
id|file
comma
op_star
id|frame
comma
id|BUZ_MODE_MOTION_COMPRESS
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BUZIOC_QBUF_PLAY
suffix:colon
(brace
r_int
op_star
id|frame
op_assign
id|arg
comma
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: BUZIOC_QBUF_PLAY - frame=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|frame
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|jpg_qbuf
c_func
(paren
id|file
comma
op_star
id|frame
comma
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BUZIOC_SYNC
suffix:colon
(brace
r_struct
id|zoran_sync
op_star
id|bsync
op_assign
id|arg
suffix:semicolon
r_int
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: BUZIOC_SYNC&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|jpg_sync
c_func
(paren
id|file
comma
id|bsync
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BUZIOC_G_STATUS
suffix:colon
(brace
r_struct
id|zoran_status
op_star
id|bstat
op_assign
id|arg
suffix:semicolon
r_int
id|norm
comma
id|input
comma
id|status
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: BUZIOC_G_STATUS&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_IDLE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: BUZIOC_G_STATUS called but Buz in capture/playback mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|input
op_assign
id|zr-&gt;card.input
(braket
id|bstat-&gt;input
)braket
dot
id|muxsel
suffix:semicolon
id|norm
op_assign
id|VIDEO_MODE_AUTO
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_ne
id|BUZ_MODE_IDLE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: BUZIOC_G_STATUS called, but Buz in capture/playback mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|gstat_unlock_and_return
suffix:semicolon
)brace
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_INPUT
comma
op_amp
id|input
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_NORM
comma
op_amp
id|norm
)paren
suffix:semicolon
multiline_comment|/* sleep 1 second */
id|ssleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Get status of video decoder */
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_GET_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
multiline_comment|/* restore previous input and norm */
id|input
op_assign
id|zr-&gt;card.input
(braket
id|zr-&gt;input
)braket
dot
id|muxsel
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_INPUT
comma
op_amp
id|input
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_NORM
comma
op_amp
id|zr-&gt;norm
)paren
suffix:semicolon
id|gstat_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|bstat-&gt;signal
op_assign
(paren
id|status
op_amp
id|DECODER_STATUS_GOOD
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|DECODER_STATUS_NTSC
)paren
id|bstat-&gt;norm
op_assign
id|VIDEO_MODE_NTSC
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|DECODER_STATUS_SECAM
)paren
id|bstat-&gt;norm
op_assign
id|VIDEO_MODE_SECAM
suffix:semicolon
r_else
id|bstat-&gt;norm
op_assign
id|VIDEO_MODE_PAL
suffix:semicolon
id|bstat-&gt;color
op_assign
(paren
id|status
op_amp
id|DECODER_STATUS_COLOR
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#ifdef HAVE_V4L2
multiline_comment|/* The new video4linux2 capture interface - much nicer than video4linux1, since&n;&t;&t; * it allows for integrating the JPEG capturing calls inside standard v4l2&n;&t;&t; */
r_case
id|VIDIOC_QUERYCAP
suffix:colon
(brace
r_struct
id|v4l2_capability
op_star
id|cap
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_QUERYCAP&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cap
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cap
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cap-&gt;card
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
r_sizeof
(paren
id|cap-&gt;card
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|cap-&gt;driver
comma
l_string|&quot;zoran&quot;
comma
r_sizeof
(paren
id|cap-&gt;driver
)paren
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|cap-&gt;bus_info
comma
r_sizeof
(paren
id|cap-&gt;bus_info
)paren
comma
l_string|&quot;PCI:%s&quot;
comma
id|zr-&gt;pci_dev-&gt;slot_name
)paren
suffix:semicolon
id|cap-&gt;version
op_assign
id|KERNEL_VERSION
c_func
(paren
id|MAJOR_VERSION
comma
id|MINOR_VERSION
comma
id|RELEASE_VERSION
)paren
suffix:semicolon
id|cap-&gt;capabilities
op_assign
id|ZORAN_V4L2_VID_FLAGS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_ENUM_FMT
suffix:colon
(brace
r_struct
id|v4l2_fmtdesc
op_star
id|fmt
op_assign
id|arg
suffix:semicolon
r_int
id|index
op_assign
id|fmt-&gt;index
comma
id|num
op_assign
op_minus
l_int|1
comma
id|i
comma
id|flag
op_assign
l_int|0
comma
id|type
op_assign
id|fmt-&gt;type
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_ENUM_FMT - index=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fmt-&gt;index
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fmt-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
id|flag
op_assign
id|ZORAN_FORMAT_CAPTURE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
suffix:colon
id|flag
op_assign
id|ZORAN_FORMAT_PLAYBACK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_BUF_TYPE_VIDEO_OVERLAY
suffix:colon
id|flag
op_assign
id|ZORAN_FORMAT_OVERLAY
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_ENUM_FMT - unknown type %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fmt-&gt;type
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num_formats
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|zoran_formats
(braket
id|i
)braket
dot
id|flags
op_amp
id|flag
)paren
id|num
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|num
op_eq
id|fmt-&gt;index
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fmt-&gt;index
OL
l_int|0
multiline_comment|/* late, but not too late */
op_logical_or
id|i
op_eq
id|zoran_num_formats
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
id|fmt
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fmt
)paren
)paren
suffix:semicolon
id|fmt-&gt;index
op_assign
id|index
suffix:semicolon
id|fmt-&gt;type
op_assign
id|type
suffix:semicolon
id|strncpy
c_func
(paren
id|fmt-&gt;description
comma
id|zoran_formats
(braket
id|i
)braket
dot
id|name
comma
l_int|31
)paren
suffix:semicolon
id|fmt-&gt;pixelformat
op_assign
id|zoran_formats
(braket
id|i
)braket
dot
id|fourcc
suffix:semicolon
r_if
c_cond
(paren
id|zoran_formats
(braket
id|i
)braket
dot
id|flags
op_amp
id|ZORAN_FORMAT_COMPRESSED
)paren
id|fmt-&gt;flags
op_or_assign
id|V4L2_FMT_FLAG_COMPRESSED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_G_FMT
suffix:colon
(brace
r_struct
id|v4l2_format
op_star
id|fmt
op_assign
id|arg
suffix:semicolon
r_int
id|type
op_assign
id|fmt-&gt;type
suffix:semicolon
id|dprintk
c_func
(paren
l_int|5
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_G_FMT&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fmt
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fmt
)paren
)paren
suffix:semicolon
id|fmt-&gt;type
op_assign
id|type
suffix:semicolon
r_switch
c_cond
(paren
id|fmt-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_OVERLAY
suffix:colon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|fmt-&gt;fmt.win.w.left
op_assign
id|fh-&gt;overlay_settings.x
suffix:semicolon
id|fmt-&gt;fmt.win.w.top
op_assign
id|fh-&gt;overlay_settings.y
suffix:semicolon
id|fmt-&gt;fmt.win.w.width
op_assign
id|fh-&gt;overlay_settings.width
suffix:semicolon
id|fmt-&gt;fmt.win.w.height
op_assign
id|fh-&gt;overlay_settings.height
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;overlay_settings.width
op_star
l_int|2
OG
id|BUZ_MAX_HEIGHT
)paren
id|fmt-&gt;fmt.win.field
op_assign
id|V4L2_FIELD_INTERLACED
suffix:semicolon
r_else
id|fmt-&gt;fmt.win.field
op_assign
id|V4L2_FIELD_TOP
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
r_case
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
suffix:colon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;type
op_eq
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
op_logical_and
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_RAW
)paren
(brace
id|fmt-&gt;fmt.pix.width
op_assign
id|fh-&gt;v4l_settings.width
suffix:semicolon
id|fmt-&gt;fmt.pix.height
op_assign
id|fh-&gt;v4l_settings.height
suffix:semicolon
id|fmt-&gt;fmt.pix.sizeimage
op_assign
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
id|fmt-&gt;fmt.pix.pixelformat
op_assign
id|fh-&gt;v4l_settings.format-&gt;fourcc
suffix:semicolon
id|fmt-&gt;fmt.pix.colorspace
op_assign
id|fh-&gt;v4l_settings.format-&gt;colorspace
suffix:semicolon
id|fmt-&gt;fmt.pix.bytesperline
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|BUZ_MAX_HEIGHT
OL
(paren
id|fh-&gt;v4l_settings.height
op_star
l_int|2
)paren
)paren
id|fmt-&gt;fmt.pix.field
op_assign
id|V4L2_FIELD_INTERLACED
suffix:semicolon
r_else
id|fmt-&gt;fmt.pix.field
op_assign
id|V4L2_FIELD_TOP
suffix:semicolon
)brace
r_else
(brace
id|fmt-&gt;fmt.pix.width
op_assign
id|fh-&gt;jpg_settings.img_width
op_div
id|fh-&gt;jpg_settings.HorDcm
suffix:semicolon
id|fmt-&gt;fmt.pix.height
op_assign
id|fh-&gt;jpg_settings.img_height
op_div
(paren
id|fh-&gt;jpg_settings.VerDcm
op_star
id|fh-&gt;jpg_settings.TmpDcm
)paren
suffix:semicolon
id|fmt-&gt;fmt.pix.sizeimage
op_assign
id|zoran_v4l2_calc_bufsize
c_func
(paren
op_amp
id|fh
op_member_access_from_pointer
id|jpg_settings
)paren
suffix:semicolon
id|fmt-&gt;fmt.pix.pixelformat
op_assign
id|V4L2_PIX_FMT_MJPEG
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_settings.TmpDcm
op_eq
l_int|1
)paren
id|fmt-&gt;fmt.pix.field
op_assign
(paren
id|fh-&gt;jpg_settings
dot
id|odd_even
ques
c_cond
id|V4L2_FIELD_SEQ_BT
suffix:colon
id|V4L2_FIELD_SEQ_BT
)paren
suffix:semicolon
r_else
id|fmt-&gt;fmt.pix.field
op_assign
(paren
id|fh-&gt;jpg_settings
dot
id|odd_even
ques
c_cond
id|V4L2_FIELD_TOP
suffix:colon
id|V4L2_FIELD_BOTTOM
)paren
suffix:semicolon
id|fmt-&gt;fmt.pix.bytesperline
op_assign
l_int|0
suffix:semicolon
id|fmt-&gt;fmt.pix.colorspace
op_assign
id|V4L2_COLORSPACE_SMPTE170M
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_G_FMT - unsupported type %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fmt-&gt;type
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_S_FMT
suffix:colon
(brace
r_struct
id|v4l2_format
op_star
id|fmt
op_assign
id|arg
suffix:semicolon
r_int
id|i
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|__u32
id|printformat
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_S_FMT - type=%d, &quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fmt-&gt;type
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fmt-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_OVERLAY
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;x=%d, y=%d, w=%d, h=%d, cnt=%d, map=0x%p&bslash;n&quot;
comma
id|fmt-&gt;fmt.win.w.left
comma
id|fmt-&gt;fmt.win.w.top
comma
id|fmt-&gt;fmt.win.w.width
comma
id|fmt-&gt;fmt.win.w.height
comma
id|fmt-&gt;fmt.win.clipcount
comma
id|fmt-&gt;fmt.win.bitmap
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|setup_window
c_func
(paren
id|file
comma
id|fmt-&gt;fmt.win.w.left
comma
id|fmt-&gt;fmt.win.w.top
comma
id|fmt-&gt;fmt.win.w.width
comma
id|fmt-&gt;fmt.win.w.height
comma
(paren
r_struct
id|video_clip
id|__user
op_star
)paren
id|fmt-&gt;fmt.win.clips
comma
id|fmt-&gt;fmt.win.clipcount
comma
id|fmt-&gt;fmt.win.bitmap
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
r_case
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
suffix:colon
id|printformat
op_assign
id|__cpu_to_le32
c_func
(paren
id|fmt-&gt;fmt.pix.pixelformat
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;size=%dx%d, fmt=0x%x (%4.4s)&bslash;n&quot;
comma
id|fmt-&gt;fmt.pix.width
comma
id|fmt-&gt;fmt.pix.height
comma
id|fmt-&gt;fmt.pix.pixelformat
comma
(paren
r_char
op_star
)paren
op_amp
id|printformat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.bytesperline
OG
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_int|5
comma
id|KERN_ERR
l_string|&quot;%s: bpl not supported&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* we can be requested to do JPEG/raw playback/capture */
r_if
c_cond
(paren
op_logical_neg
(paren
id|fmt-&gt;type
op_eq
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
op_logical_or
(paren
id|fmt-&gt;type
op_eq
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
op_logical_and
id|fmt-&gt;fmt.pix.pixelformat
op_eq
id|V4L2_PIX_FMT_MJPEG
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_FMT - unknown type %d/0x%x(%4.4s) combination&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fmt-&gt;type
comma
id|fmt-&gt;fmt.pix.pixelformat
comma
(paren
r_char
op_star
)paren
op_amp
id|printformat
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.pixelformat
op_eq
id|V4L2_PIX_FMT_MJPEG
)paren
(brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|settings
op_assign
id|fh-&gt;jpg_settings
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.allocated
op_logical_or
id|fh-&gt;jpg_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_FMT - cannot change capture mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|sfmtjpg_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* we actually need to set &squot;real&squot; parameters now */
r_if
c_cond
(paren
(paren
id|fmt-&gt;fmt.pix.height
op_star
l_int|2
)paren
OG
id|BUZ_MAX_HEIGHT
)paren
id|settings.TmpDcm
op_assign
l_int|1
suffix:semicolon
r_else
id|settings.TmpDcm
op_assign
l_int|2
suffix:semicolon
id|settings.decimation
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.height
op_le
id|fh-&gt;jpg_settings.img_height
op_div
l_int|2
)paren
id|settings.VerDcm
op_assign
l_int|2
suffix:semicolon
r_else
id|settings.VerDcm
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.width
op_le
id|fh-&gt;jpg_settings.img_width
op_div
l_int|4
)paren
id|settings.HorDcm
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.width
op_le
id|fh-&gt;jpg_settings.img_width
op_div
l_int|2
)paren
id|settings.HorDcm
op_assign
l_int|2
suffix:semicolon
r_else
id|settings.HorDcm
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|settings.TmpDcm
op_eq
l_int|1
)paren
id|settings.field_per_buff
op_assign
l_int|2
suffix:semicolon
r_else
id|settings.field_per_buff
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* check */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_check_jpg_settings
c_func
(paren
id|zr
comma
op_amp
id|settings
)paren
)paren
)paren
r_goto
id|sfmtjpg_unlock_and_return
suffix:semicolon
multiline_comment|/* it&squot;s ok, so set them */
id|fh-&gt;jpg_settings
op_assign
id|settings
suffix:semicolon
multiline_comment|/* tell the user what we actually did */
id|fmt-&gt;fmt.pix.width
op_assign
id|settings.img_width
op_div
id|settings.HorDcm
suffix:semicolon
id|fmt-&gt;fmt.pix.height
op_assign
id|settings.img_height
op_star
l_int|2
op_div
(paren
id|settings.TmpDcm
op_star
id|settings.VerDcm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|settings.TmpDcm
op_eq
l_int|1
)paren
id|fmt-&gt;fmt.pix.field
op_assign
(paren
id|fh-&gt;jpg_settings
dot
id|odd_even
ques
c_cond
id|V4L2_FIELD_SEQ_TB
suffix:colon
id|V4L2_FIELD_SEQ_BT
)paren
suffix:semicolon
r_else
id|fmt-&gt;fmt.pix.field
op_assign
(paren
id|fh-&gt;jpg_settings
dot
id|odd_even
ques
c_cond
id|V4L2_FIELD_TOP
suffix:colon
id|V4L2_FIELD_BOTTOM
)paren
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer_size
op_assign
id|zoran_v4l2_calc_bufsize
c_func
(paren
op_amp
id|fh
op_member_access_from_pointer
id|jpg_settings
)paren
suffix:semicolon
id|fmt-&gt;fmt.pix.sizeimage
op_assign
id|fh-&gt;jpg_buffers.buffer_size
suffix:semicolon
multiline_comment|/* we hereby abuse this variable to show that&n;&t;&t;&t;&t; * we&squot;re gonna do mjpeg capture */
id|fh-&gt;map_mode
op_assign
(paren
id|fmt-&gt;type
op_eq
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
)paren
ques
c_cond
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:semicolon
id|sfmtjpg_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num_formats
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.pixelformat
op_eq
id|zoran_formats
(braket
id|i
)braket
dot
id|fourcc
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|zoran_num_formats
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_FMT - unknown/unsupported format 0x%x (%4.4s)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fmt-&gt;fmt.pix.pixelformat
comma
(paren
r_char
op_star
)paren
op_amp
id|printformat
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.allocated
op_logical_or
(paren
id|fh-&gt;v4l_buffers.allocated
op_logical_and
id|fh-&gt;v4l_buffers.active
op_ne
id|ZORAN_FREE
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_FMT - cannot change capture mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|sfmtv4l_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.height
OG
id|BUZ_MAX_HEIGHT
)paren
id|fmt-&gt;fmt.pix.height
op_assign
id|BUZ_MAX_HEIGHT
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.width
OG
id|BUZ_MAX_WIDTH
)paren
id|fmt-&gt;fmt.pix.width
op_assign
id|BUZ_MAX_WIDTH
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_v4l_set_format
c_func
(paren
id|file
comma
id|fmt-&gt;fmt.pix
dot
id|width
comma
id|fmt-&gt;fmt.pix
dot
id|height
comma
op_amp
id|zoran_formats
(braket
id|i
)braket
)paren
)paren
)paren
r_goto
id|sfmtv4l_unlock_and_return
suffix:semicolon
multiline_comment|/* tell the user the&n;&t;&t;&t;&t; * results/missing stuff */
id|fmt-&gt;fmt.pix.sizeimage
op_assign
id|fh-&gt;v4l_buffers.buffer_size
multiline_comment|/*zr-&gt;gbpl * zr-&gt;gheight */
suffix:semicolon
r_if
c_cond
(paren
id|BUZ_MAX_HEIGHT
OL
(paren
id|fh-&gt;v4l_settings.height
op_star
l_int|2
)paren
)paren
id|fmt-&gt;fmt.pix.field
op_assign
id|V4L2_FIELD_INTERLACED
suffix:semicolon
r_else
id|fmt-&gt;fmt.pix.field
op_assign
id|V4L2_FIELD_TOP
suffix:semicolon
id|fh-&gt;map_mode
op_assign
id|ZORAN_MAP_MODE_RAW
suffix:semicolon
id|sfmtv4l_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
l_string|&quot;unsupported&bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_FMT - unsupported type %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fmt-&gt;type
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_G_FBUF
suffix:colon
(brace
r_struct
id|v4l2_framebuffer
op_star
id|fb
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_G_FBUF&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|fb
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fb
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|fb-&gt;base
op_assign
id|zr-&gt;buffer.base
suffix:semicolon
id|fb-&gt;fmt.width
op_assign
id|zr-&gt;buffer.width
suffix:semicolon
id|fb-&gt;fmt.height
op_assign
id|zr-&gt;buffer.height
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;overlay_settings.format
)paren
(brace
id|fb-&gt;fmt.pixelformat
op_assign
id|fh-&gt;overlay_settings.format-&gt;fourcc
suffix:semicolon
)brace
id|fb-&gt;fmt.bytesperline
op_assign
id|zr-&gt;buffer.bytesperline
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|fb-&gt;fmt.colorspace
op_assign
id|V4L2_COLORSPACE_SRGB
suffix:semicolon
id|fb-&gt;fmt.field
op_assign
id|V4L2_FIELD_INTERLACED
suffix:semicolon
id|fb-&gt;flags
op_assign
id|V4L2_FBUF_FLAG_OVERLAY
suffix:semicolon
id|fb-&gt;capability
op_assign
id|V4L2_FBUF_CAP_LIST_CLIPPING
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_S_FBUF
suffix:colon
(brace
r_int
id|i
comma
id|res
op_assign
l_int|0
suffix:semicolon
r_struct
id|v4l2_framebuffer
op_star
id|fb
op_assign
id|arg
suffix:semicolon
id|__u32
id|printformat
op_assign
id|__cpu_to_le32
c_func
(paren
id|fb-&gt;fmt.pixelformat
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_S_FBUF - base=0x%p, size=%dx%d, bpl=%d, fmt=0x%x (%4.4s)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fb-&gt;base
comma
id|fb-&gt;fmt.width
comma
id|fb-&gt;fmt.height
comma
id|fb-&gt;fmt.bytesperline
comma
id|fb-&gt;fmt.pixelformat
comma
(paren
r_char
op_star
)paren
op_amp
id|printformat
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num_formats
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|zoran_formats
(braket
id|i
)braket
dot
id|fourcc
op_eq
id|fb-&gt;fmt.pixelformat
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|zoran_num_formats
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_FBUF - format=0x%x (%4.4s) not allowed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fb-&gt;fmt.pixelformat
comma
(paren
r_char
op_star
)paren
op_amp
id|printformat
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|setup_fbuffer
c_func
(paren
id|file
comma
id|fb-&gt;base
comma
op_amp
id|zoran_formats
(braket
id|i
)braket
comma
id|fb-&gt;fmt.width
comma
id|fb-&gt;fmt.height
comma
id|fb-&gt;fmt.bytesperline
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_OVERLAY
suffix:colon
(brace
r_int
op_star
id|on
op_assign
id|arg
comma
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_PREVIEW - on=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|on
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|setup_overlay
c_func
(paren
id|file
comma
op_star
id|on
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_REQBUFS
suffix:colon
(brace
r_struct
id|v4l2_requestbuffers
op_star
id|req
op_assign
id|arg
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_REQBUFS - type=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|req-&gt;type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;memory
op_ne
id|V4L2_MEMORY_MMAP
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: only MEMORY_MMAP capture is supported, not %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|req-&gt;memory
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.allocated
op_logical_or
id|fh-&gt;jpg_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_REQBUFS - buffers allready allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|v4l2reqbuf_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_RAW
op_logical_and
id|req-&gt;type
op_eq
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
)paren
(brace
multiline_comment|/* control user input */
r_if
c_cond
(paren
id|req-&gt;count
OL
l_int|2
)paren
id|req-&gt;count
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;count
OG
id|v4l_nbufs
)paren
id|req-&gt;count
op_assign
id|v4l_nbufs
suffix:semicolon
id|fh-&gt;v4l_buffers.num_buffers
op_assign
id|req-&gt;count
suffix:semicolon
r_if
c_cond
(paren
id|v4l_fbuffer_alloc
c_func
(paren
id|file
)paren
)paren
(brace
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|v4l2reqbuf_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* The next mmap will map the V4L buffers */
id|fh-&gt;map_mode
op_assign
id|ZORAN_MAP_MODE_RAW
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_JPG_REC
op_logical_or
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_JPG_PLAY
)paren
(brace
multiline_comment|/* we need to calculate size ourselves now */
r_if
c_cond
(paren
id|req-&gt;count
OL
l_int|4
)paren
id|req-&gt;count
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;count
OG
id|jpg_nbufs
)paren
id|req-&gt;count
op_assign
id|jpg_nbufs
suffix:semicolon
id|fh-&gt;jpg_buffers.num_buffers
op_assign
id|req-&gt;count
suffix:semicolon
id|fh-&gt;jpg_buffers.buffer_size
op_assign
id|zoran_v4l2_calc_bufsize
c_func
(paren
op_amp
id|fh-&gt;jpg_settings
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jpg_fbuffer_alloc
c_func
(paren
id|file
)paren
)paren
(brace
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|v4l2reqbuf_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* The next mmap will map the MJPEG buffers */
r_if
c_cond
(paren
id|req-&gt;type
op_eq
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
)paren
id|fh-&gt;map_mode
op_assign
id|ZORAN_MAP_MODE_JPG_REC
suffix:semicolon
r_else
id|fh-&gt;map_mode
op_assign
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_REQBUFS - unknown type %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|req-&gt;type
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|v4l2reqbuf_unlock_and_return
suffix:semicolon
)brace
id|v4l2reqbuf_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_QUERYBUF
suffix:colon
(brace
r_struct
id|v4l2_buffer
op_star
id|buf
op_assign
id|arg
suffix:semicolon
id|__u32
id|type
op_assign
id|buf-&gt;type
suffix:semicolon
r_int
id|index
op_assign
id|buf-&gt;index
comma
id|res
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_QUERYBUF - index=%d, type=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;index
comma
id|buf-&gt;type
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
r_sizeof
(paren
id|buf
)paren
)paren
suffix:semicolon
id|buf-&gt;type
op_assign
id|type
suffix:semicolon
id|buf-&gt;index
op_assign
id|index
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|res
op_assign
id|zoran_v4l2_buffer_status
c_func
(paren
id|file
comma
id|buf
comma
id|buf-&gt;index
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_QBUF
suffix:colon
(brace
r_struct
id|v4l2_buffer
op_star
id|buf
op_assign
id|arg
suffix:semicolon
r_int
id|res
op_assign
l_int|0
comma
id|codec_mode
comma
id|buf_type
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_QBUF - type=%d, index=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
comma
id|buf-&gt;index
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fh-&gt;map_mode
)paren
(brace
r_case
id|ZORAN_MAP_MODE_RAW
suffix:colon
r_if
c_cond
(paren
id|buf-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_QBUF - invalid buf-&gt;type=%d for map_mode=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|qbuf_unlock_and_return
suffix:semicolon
)brace
id|res
op_assign
id|zoran_v4l_queue_frame
c_func
(paren
id|file
comma
id|buf-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_goto
id|qbuf_unlock_and_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
op_logical_and
id|fh-&gt;v4l_buffers.active
op_eq
id|ZORAN_LOCKED
)paren
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
r_case
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:colon
r_if
c_cond
(paren
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_JPG_PLAY
)paren
(brace
id|buf_type
op_assign
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
suffix:semicolon
id|codec_mode
op_assign
id|BUZ_MODE_MOTION_DECOMPRESS
suffix:semicolon
)brace
r_else
(brace
id|buf_type
op_assign
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:semicolon
id|codec_mode
op_assign
id|BUZ_MODE_MOTION_COMPRESS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf-&gt;type
op_ne
id|buf_type
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_QBUF - invalid buf-&gt;type=%d for map_mode=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|qbuf_unlock_and_return
suffix:semicolon
)brace
id|res
op_assign
id|zoran_jpg_queue_frame
c_func
(paren
id|file
comma
id|buf-&gt;index
comma
id|codec_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ne
l_int|0
)paren
r_goto
id|qbuf_unlock_and_return
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;codec_mode
op_eq
id|BUZ_MODE_IDLE
op_logical_and
id|fh-&gt;jpg_buffers.active
op_eq
id|ZORAN_LOCKED
)paren
(brace
id|zr36057_enable_jpg
c_func
(paren
id|zr
comma
id|codec_mode
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_QBUF - unsupported type %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|qbuf_unlock_and_return
suffix:semicolon
)brace
id|qbuf_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_DQBUF
suffix:colon
(brace
r_struct
id|v4l2_buffer
op_star
id|buf
op_assign
id|arg
suffix:semicolon
r_int
id|res
op_assign
l_int|0
comma
id|buf_type
comma
id|num
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* compiler borks here (?) */
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_DQBUF - type=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fh-&gt;map_mode
)paren
(brace
r_case
id|ZORAN_MAP_MODE_RAW
suffix:colon
r_if
c_cond
(paren
id|buf-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_QBUF - invalid buf-&gt;type=%d for map_mode=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|dqbuf_unlock_and_return
suffix:semicolon
)brace
id|num
op_assign
id|zr-&gt;v4l_pend
(braket
id|zr-&gt;v4l_sync_tail
op_amp
id|V4L_MASK_FRAME
)braket
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
op_logical_and
id|zr-&gt;v4l_buffers.buffer
(braket
id|num
)braket
dot
id|state
op_ne
id|BUZ_STATE_DONE
)paren
(brace
id|res
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|dqbuf_unlock_and_return
suffix:semicolon
)brace
id|res
op_assign
id|v4l_sync
c_func
(paren
id|file
comma
id|num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_goto
id|dqbuf_unlock_and_return
suffix:semicolon
r_else
id|zr-&gt;v4l_sync_tail
op_increment
suffix:semicolon
id|res
op_assign
id|zoran_v4l2_buffer_status
c_func
(paren
id|file
comma
id|buf
comma
id|num
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
r_case
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:colon
(brace
r_struct
id|zoran_sync
id|bs
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_JPG_PLAY
)paren
id|buf_type
op_assign
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
suffix:semicolon
r_else
id|buf_type
op_assign
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;type
op_ne
id|buf_type
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_QBUF - invalid buf-&gt;type=%d for map_mode=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|dqbuf_unlock_and_return
suffix:semicolon
)brace
id|num
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr
op_member_access_from_pointer
id|jpg_que_tail
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
op_logical_and
id|zr-&gt;jpg_buffers.buffer
(braket
id|num
)braket
dot
id|state
op_ne
id|BUZ_STATE_DONE
)paren
(brace
id|res
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|dqbuf_unlock_and_return
suffix:semicolon
)brace
id|res
op_assign
id|jpg_sync
c_func
(paren
id|file
comma
op_amp
id|bs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_goto
id|dqbuf_unlock_and_return
suffix:semicolon
id|res
op_assign
id|zoran_v4l2_buffer_status
c_func
(paren
id|file
comma
id|buf
comma
id|bs.frame
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_DQBUF - unsupported type %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|buf-&gt;type
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|dqbuf_unlock_and_return
suffix:semicolon
)brace
id|dqbuf_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_STREAMON
suffix:colon
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_STREAMON&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fh-&gt;map_mode
)paren
(brace
r_case
id|ZORAN_MAP_MODE_RAW
suffix:colon
multiline_comment|/* raw capture */
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.active
op_ne
id|ZORAN_ACTIVE
op_logical_or
id|fh-&gt;v4l_buffers.active
op_ne
id|ZORAN_ACTIVE
)paren
(brace
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|strmon_unlock_and_return
suffix:semicolon
)brace
id|zr-&gt;v4l_buffers.active
op_assign
id|fh-&gt;v4l_buffers.active
op_assign
id|ZORAN_LOCKED
suffix:semicolon
id|zr-&gt;v4l_settings
op_assign
id|fh-&gt;v4l_settings
suffix:semicolon
id|zr-&gt;v4l_sync_tail
op_assign
id|zr-&gt;v4l_pend_tail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|zr-&gt;v4l_memgrab_active
op_logical_and
id|zr-&gt;v4l_pend_head
op_ne
id|zr-&gt;v4l_pend_tail
)paren
(brace
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|1
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
r_case
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:colon
multiline_comment|/* what is the codec mode right now? */
r_if
c_cond
(paren
id|zr-&gt;jpg_buffers.active
op_ne
id|ZORAN_ACTIVE
op_logical_or
id|fh-&gt;jpg_buffers.active
op_ne
id|ZORAN_ACTIVE
)paren
(brace
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|strmon_unlock_and_return
suffix:semicolon
)brace
id|zr-&gt;jpg_buffers.active
op_assign
id|fh-&gt;jpg_buffers.active
op_assign
id|ZORAN_LOCKED
suffix:semicolon
r_if
c_cond
(paren
id|zr-&gt;jpg_que_head
op_ne
id|zr-&gt;jpg_que_tail
)paren
(brace
multiline_comment|/* Start the jpeg codec when the first frame is queued  */
id|jpeg_start
c_func
(paren
id|zr
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_STREAMON - invalid map mode %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|strmon_unlock_and_return
suffix:semicolon
)brace
id|strmon_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_STREAMOFF
suffix:colon
(brace
r_int
id|i
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_STREAMOFF&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fh-&gt;map_mode
)paren
(brace
r_case
id|ZORAN_MAP_MODE_RAW
suffix:colon
multiline_comment|/* raw capture */
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.active
op_eq
id|ZORAN_FREE
op_logical_and
id|zr-&gt;v4l_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|res
op_assign
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* stay off other&squot;s settings! */
r_goto
id|strmoff_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;v4l_buffers.active
op_eq
id|ZORAN_FREE
)paren
r_goto
id|strmoff_unlock_and_return
suffix:semicolon
multiline_comment|/* unload capture */
r_if
c_cond
(paren
id|zr-&gt;v4l_memgrab_active
)paren
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;v4l_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
id|zr-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|state
op_assign
id|BUZ_STATE_USER
suffix:semicolon
id|fh-&gt;v4l_buffers
op_assign
id|zr-&gt;v4l_buffers
suffix:semicolon
id|zr-&gt;v4l_buffers.active
op_assign
id|fh-&gt;v4l_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
id|zr-&gt;v4l_grab_seq
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_pend_head
op_assign
id|zr-&gt;v4l_pend_tail
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_sync_tail
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
r_case
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:colon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
op_logical_and
id|zr-&gt;jpg_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|res
op_assign
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* stay off other&squot;s settings! */
r_goto
id|strmoff_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zr-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
)paren
r_goto
id|strmoff_unlock_and_return
suffix:semicolon
id|res
op_assign
id|jpg_qbuf
c_func
(paren
id|file
comma
op_minus
l_int|1
comma
(paren
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_JPG_REC
)paren
ques
c_cond
id|BUZ_MODE_MOTION_COMPRESS
suffix:colon
id|BUZ_MODE_MOTION_DECOMPRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_goto
id|strmoff_unlock_and_return
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_STREAMOFF - invalid map mode %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|strmoff_unlock_and_return
suffix:semicolon
)brace
id|strmoff_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_QUERYCTRL
suffix:colon
(brace
r_struct
id|v4l2_queryctrl
op_star
id|ctrl
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_QUERYCTRL - id=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|ctrl-&gt;id
)paren
suffix:semicolon
multiline_comment|/* we only support hue/saturation/contrast/brightness */
r_if
c_cond
(paren
id|ctrl-&gt;id
template_param
id|V4L2_CID_HUE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_else
(brace
r_int
id|id
op_assign
id|ctrl-&gt;id
suffix:semicolon
id|memset
c_func
(paren
id|ctrl
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ctrl
)paren
)paren
suffix:semicolon
id|ctrl-&gt;id
op_assign
id|id
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ctrl-&gt;id
)paren
(brace
r_case
id|V4L2_CID_BRIGHTNESS
suffix:colon
id|strncpy
c_func
(paren
id|ctrl-&gt;name
comma
l_string|&quot;Brightness&quot;
comma
l_int|31
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_CONTRAST
suffix:colon
id|strncpy
c_func
(paren
id|ctrl-&gt;name
comma
l_string|&quot;Contrast&quot;
comma
l_int|31
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_SATURATION
suffix:colon
id|strncpy
c_func
(paren
id|ctrl-&gt;name
comma
l_string|&quot;Saturation&quot;
comma
l_int|31
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_HUE
suffix:colon
id|strncpy
c_func
(paren
id|ctrl-&gt;name
comma
l_string|&quot;Hue&quot;
comma
l_int|31
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ctrl-&gt;minimum
op_assign
l_int|0
suffix:semicolon
id|ctrl-&gt;maximum
op_assign
l_int|65535
suffix:semicolon
id|ctrl-&gt;step
op_assign
l_int|1
suffix:semicolon
id|ctrl-&gt;default_value
op_assign
l_int|32768
suffix:semicolon
id|ctrl-&gt;type
op_assign
id|V4L2_CTRL_TYPE_INTEGER
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_G_CTRL
suffix:colon
(brace
r_struct
id|v4l2_control
op_star
id|ctrl
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_G_CTRL - id=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|ctrl-&gt;id
)paren
suffix:semicolon
multiline_comment|/* we only support hue/saturation/contrast/brightness */
r_if
c_cond
(paren
id|ctrl-&gt;id
template_param
id|V4L2_CID_HUE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl-&gt;id
)paren
(brace
r_case
id|V4L2_CID_BRIGHTNESS
suffix:colon
id|ctrl-&gt;value
op_assign
id|zr-&gt;brightness
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_CONTRAST
suffix:colon
id|ctrl-&gt;value
op_assign
id|zr-&gt;contrast
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_SATURATION
suffix:colon
id|ctrl-&gt;value
op_assign
id|zr-&gt;saturation
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_HUE
suffix:colon
id|ctrl-&gt;value
op_assign
id|zr-&gt;hue
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_S_CTRL
suffix:colon
(brace
r_struct
id|v4l2_control
op_star
id|ctrl
op_assign
id|arg
suffix:semicolon
r_struct
id|video_picture
id|pict
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_S_CTRL - id=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|ctrl-&gt;id
)paren
suffix:semicolon
multiline_comment|/* we only support hue/saturation/contrast/brightness */
r_if
c_cond
(paren
id|ctrl-&gt;id
template_param
id|V4L2_CID_HUE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ctrl-&gt;value
template_param
l_int|65535
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_CTRL - invalid value %d for id=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|ctrl-&gt;value
comma
id|ctrl-&gt;id
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ctrl-&gt;id
)paren
(brace
r_case
id|V4L2_CID_BRIGHTNESS
suffix:colon
id|zr-&gt;brightness
op_assign
id|ctrl-&gt;value
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_CONTRAST
suffix:colon
id|zr-&gt;contrast
op_assign
id|ctrl-&gt;value
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_SATURATION
suffix:colon
id|zr-&gt;saturation
op_assign
id|ctrl-&gt;value
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_CID_HUE
suffix:colon
id|zr-&gt;hue
op_assign
id|ctrl-&gt;value
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pict.brightness
op_assign
id|zr-&gt;brightness
suffix:semicolon
id|pict.contrast
op_assign
id|zr-&gt;contrast
suffix:semicolon
id|pict.colour
op_assign
id|zr-&gt;saturation
suffix:semicolon
id|pict.hue
op_assign
id|zr-&gt;hue
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_SET_PICTURE
comma
op_amp
id|pict
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_ENUMSTD
suffix:colon
(brace
r_struct
id|v4l2_standard
op_star
id|std
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_ENUMSTD - index=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|std-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|std-&gt;index
OL
l_int|0
op_logical_or
id|std-&gt;index
op_ge
(paren
id|zr-&gt;card.norms
op_plus
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_else
(brace
r_int
id|id
op_assign
id|std-&gt;index
suffix:semicolon
id|memset
c_func
(paren
id|std
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|std
)paren
)paren
suffix:semicolon
id|std-&gt;index
op_assign
id|id
suffix:semicolon
)brace
r_if
c_cond
(paren
id|std-&gt;index
op_eq
id|zr-&gt;card.norms
)paren
(brace
multiline_comment|/* if we have autodetect, ... */
r_struct
id|video_decoder_capability
id|caps
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_GET_CAPABILITIES
comma
op_amp
id|caps
)paren
suffix:semicolon
r_if
c_cond
(paren
id|caps.flags
op_amp
id|VIDEO_DECODER_AUTO
)paren
(brace
id|std-&gt;id
op_assign
id|V4L2_STD_ALL
suffix:semicolon
id|strncpy
c_func
(paren
id|std-&gt;name
comma
l_string|&quot;Autodetect&quot;
comma
l_int|31
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|std-&gt;index
)paren
(brace
r_case
l_int|0
suffix:colon
id|std-&gt;id
op_assign
id|V4L2_STD_PAL
suffix:semicolon
id|strncpy
c_func
(paren
id|std-&gt;name
comma
l_string|&quot;PAL&quot;
comma
l_int|31
)paren
suffix:semicolon
id|std-&gt;frameperiod.numerator
op_assign
l_int|1
suffix:semicolon
id|std-&gt;frameperiod.denominator
op_assign
l_int|25
suffix:semicolon
id|std-&gt;framelines
op_assign
id|zr-&gt;card.tvn
(braket
l_int|0
)braket
op_member_access_from_pointer
id|Ht
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|std-&gt;id
op_assign
id|V4L2_STD_NTSC
suffix:semicolon
id|strncpy
c_func
(paren
id|std-&gt;name
comma
l_string|&quot;NTSC&quot;
comma
l_int|31
)paren
suffix:semicolon
id|std-&gt;frameperiod.numerator
op_assign
l_int|1001
suffix:semicolon
id|std-&gt;frameperiod.denominator
op_assign
l_int|30000
suffix:semicolon
id|std-&gt;framelines
op_assign
id|zr-&gt;card.tvn
(braket
l_int|1
)braket
op_member_access_from_pointer
id|Ht
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|std-&gt;id
op_assign
id|V4L2_STD_SECAM
suffix:semicolon
id|strncpy
c_func
(paren
id|std-&gt;name
comma
l_string|&quot;SECAM&quot;
comma
l_int|31
)paren
suffix:semicolon
id|std-&gt;frameperiod.numerator
op_assign
l_int|1
suffix:semicolon
id|std-&gt;frameperiod.denominator
op_assign
l_int|25
suffix:semicolon
id|std-&gt;framelines
op_assign
id|zr-&gt;card.tvn
(braket
l_int|2
)braket
op_member_access_from_pointer
id|Ht
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_G_STD
suffix:colon
(brace
id|v4l2_std_id
op_star
id|std
op_assign
id|arg
suffix:semicolon
r_int
id|norm
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_G_STD&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|norm
op_assign
id|zr-&gt;norm
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|norm
)paren
(brace
r_case
id|VIDEO_MODE_PAL
suffix:colon
op_star
id|std
op_assign
id|V4L2_STD_PAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_MODE_NTSC
suffix:colon
op_star
id|std
op_assign
id|V4L2_STD_NTSC
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VIDEO_MODE_SECAM
suffix:colon
op_star
id|std
op_assign
id|V4L2_STD_SECAM
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_S_STD
suffix:colon
(brace
r_int
id|norm
op_assign
op_minus
l_int|1
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|v4l2_std_id
op_star
id|std
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_S_STD - norm=0x%llx&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|std
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|std
op_eq
id|V4L2_STD_PAL
)paren
id|norm
op_assign
id|VIDEO_MODE_PAL
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|std
op_eq
id|V4L2_STD_NTSC
)paren
id|norm
op_assign
id|VIDEO_MODE_NTSC
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|std
op_eq
id|V4L2_STD_SECAM
)paren
id|norm
op_assign
id|VIDEO_MODE_SECAM
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|std
op_eq
id|V4L2_STD_ALL
)paren
id|norm
op_assign
id|VIDEO_MODE_AUTO
suffix:semicolon
r_else
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_STD - invalid norm 0x%llx&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|std
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_set_norm
c_func
(paren
id|zr
comma
id|norm
)paren
)paren
)paren
r_goto
id|sstd_unlock_and_return
suffix:semicolon
id|res
op_assign
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
id|sstd_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_ENUMINPUT
suffix:colon
(brace
r_struct
id|v4l2_input
op_star
id|inp
op_assign
id|arg
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_ENUMINPUT - index=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|inp-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inp-&gt;index
OL
l_int|0
op_logical_or
id|inp-&gt;index
op_ge
id|zr-&gt;card.inputs
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_else
(brace
r_int
id|id
op_assign
id|inp-&gt;index
suffix:semicolon
id|memset
c_func
(paren
id|inp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|inp
)paren
)paren
suffix:semicolon
id|inp-&gt;index
op_assign
id|id
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|inp-&gt;name
comma
id|zr-&gt;card.input
(braket
id|inp-&gt;index
)braket
dot
id|name
comma
r_sizeof
(paren
id|inp-&gt;name
)paren
op_minus
l_int|1
)paren
suffix:semicolon
id|inp-&gt;type
op_assign
id|V4L2_INPUT_TYPE_CAMERA
suffix:semicolon
id|inp-&gt;std
op_assign
id|V4L2_STD_ALL
suffix:semicolon
multiline_comment|/* Get status of video decoder */
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|decoder_command
c_func
(paren
id|zr
comma
id|DECODER_GET_STATUS
comma
op_amp
id|status
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|DECODER_STATUS_GOOD
)paren
)paren
(brace
id|inp-&gt;status
op_or_assign
id|V4L2_IN_ST_NO_POWER
suffix:semicolon
id|inp-&gt;status
op_or_assign
id|V4L2_IN_ST_NO_SIGNAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|DECODER_STATUS_COLOR
)paren
)paren
id|inp-&gt;status
op_or_assign
id|V4L2_IN_ST_NO_COLOR
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_G_INPUT
suffix:colon
(brace
r_int
op_star
id|input
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_G_INPUT&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
op_star
id|input
op_assign
id|zr-&gt;input
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_S_INPUT
suffix:colon
(brace
r_int
op_star
id|input
op_assign
id|arg
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_S_INPUT - input=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|input
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_set_input
c_func
(paren
id|zr
comma
op_star
id|input
)paren
)paren
)paren
r_goto
id|sinput_unlock_and_return
suffix:semicolon
multiline_comment|/* Make sure the changes come into effect */
id|res
op_assign
id|wait_grab_pending
c_func
(paren
id|zr
)paren
suffix:semicolon
id|sinput_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_ENUMOUTPUT
suffix:colon
(brace
r_struct
id|v4l2_output
op_star
id|outp
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_ENUMOUTPUT - index=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|outp-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outp-&gt;index
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
id|outp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|outp
)paren
)paren
suffix:semicolon
id|outp-&gt;index
op_assign
l_int|0
suffix:semicolon
id|outp-&gt;type
op_assign
id|V4L2_OUTPUT_TYPE_ANALOGVGAOVERLAY
suffix:semicolon
id|strncpy
c_func
(paren
id|outp-&gt;name
comma
l_string|&quot;Autodetect&quot;
comma
l_int|31
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_G_OUTPUT
suffix:colon
(brace
r_int
op_star
id|output
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_G_OUTPUT&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
op_star
id|output
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_S_OUTPUT
suffix:colon
(brace
r_int
op_star
id|output
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_S_OUTPUT - output=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|output
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|output
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* cropping (sub-frame capture) */
r_case
id|VIDIOC_CROPCAP
suffix:colon
(brace
r_struct
id|v4l2_cropcap
op_star
id|cropcap
op_assign
id|arg
suffix:semicolon
r_int
id|type
op_assign
id|cropcap-&gt;type
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_CROPCAP - type=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|cropcap-&gt;type
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cropcap
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cropcap
)paren
)paren
suffix:semicolon
id|cropcap-&gt;type
op_assign
id|type
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cropcap-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
op_logical_and
(paren
id|cropcap-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
op_logical_or
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_RAW
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_CROPCAP - subcapture only supported for compressed capture&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|cropcap_unlock_and_return
suffix:semicolon
)brace
id|cropcap-&gt;bounds.top
op_assign
id|cropcap-&gt;bounds.left
op_assign
l_int|0
suffix:semicolon
id|cropcap-&gt;bounds.width
op_assign
id|BUZ_MAX_WIDTH
suffix:semicolon
id|cropcap-&gt;bounds.height
op_assign
id|BUZ_MAX_HEIGHT
suffix:semicolon
id|cropcap-&gt;defrect.top
op_assign
id|cropcap-&gt;defrect.left
op_assign
l_int|0
suffix:semicolon
id|cropcap-&gt;defrect.width
op_assign
id|BUZ_MIN_WIDTH
suffix:semicolon
id|cropcap-&gt;defrect.height
op_assign
id|BUZ_MIN_HEIGHT
suffix:semicolon
id|cropcap_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_G_CROP
suffix:colon
(brace
r_struct
id|v4l2_crop
op_star
id|crop
op_assign
id|arg
suffix:semicolon
r_int
id|type
op_assign
id|crop-&gt;type
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_G_CROP - type=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|crop-&gt;type
)paren
suffix:semicolon
id|memset
c_func
(paren
id|crop
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|crop
)paren
)paren
suffix:semicolon
id|crop-&gt;type
op_assign
id|type
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|crop-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
op_logical_and
(paren
id|crop-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
op_logical_or
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_RAW
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_G_CROP - subcapture only supported for compressed capture&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|gcrop_unlock_and_return
suffix:semicolon
)brace
id|crop-&gt;c.top
op_assign
id|fh-&gt;jpg_settings.img_y
suffix:semicolon
id|crop-&gt;c.left
op_assign
id|fh-&gt;jpg_settings.img_x
suffix:semicolon
id|crop-&gt;c.width
op_assign
id|fh-&gt;jpg_settings.img_width
suffix:semicolon
id|crop-&gt;c.height
op_assign
id|fh-&gt;jpg_settings.img_height
suffix:semicolon
id|gcrop_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_S_CROP
suffix:colon
(brace
r_struct
id|v4l2_crop
op_star
id|crop
op_assign
id|arg
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|settings
op_assign
id|fh-&gt;jpg_settings
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_CROP - type=%d, x=%d,y=%d,w=%d,h=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|crop-&gt;type
comma
id|crop-&gt;c.left
comma
id|crop-&gt;c.top
comma
id|crop-&gt;c.width
comma
id|crop-&gt;c.height
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.allocated
op_logical_or
id|fh-&gt;v4l_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_S_CROP - cannot change settings while active&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|scrop_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|crop-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
op_logical_and
(paren
id|crop-&gt;type
op_ne
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
op_logical_or
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_RAW
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: VIDIOC_G_CROP - subcapture only supported for compressed capture&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|scrop_unlock_and_return
suffix:semicolon
)brace
multiline_comment|/* move into a form that we understand */
id|settings.img_x
op_assign
id|crop-&gt;c.left
suffix:semicolon
id|settings.img_y
op_assign
id|crop-&gt;c.top
suffix:semicolon
id|settings.img_width
op_assign
id|crop-&gt;c.width
suffix:semicolon
id|settings.img_height
op_assign
id|crop-&gt;c.height
suffix:semicolon
multiline_comment|/* check validity */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_check_jpg_settings
c_func
(paren
id|zr
comma
op_amp
id|settings
)paren
)paren
)paren
r_goto
id|scrop_unlock_and_return
suffix:semicolon
multiline_comment|/* accept */
id|fh-&gt;jpg_settings
op_assign
id|settings
suffix:semicolon
id|scrop_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_G_JPEGCOMP
suffix:colon
(brace
r_struct
id|v4l2_jpegcompression
op_star
id|params
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_G_JPEGCOMP&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|params
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|params
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
id|params-&gt;quality
op_assign
id|fh-&gt;jpg_settings.jpg_comp.quality
suffix:semicolon
id|params-&gt;APPn
op_assign
id|fh-&gt;jpg_settings.jpg_comp.APPn
suffix:semicolon
id|memcpy
c_func
(paren
id|params-&gt;APP_data
comma
id|fh-&gt;jpg_settings.jpg_comp.APP_data
comma
id|fh-&gt;jpg_settings.jpg_comp.APP_len
)paren
suffix:semicolon
id|params-&gt;APP_len
op_assign
id|fh-&gt;jpg_settings.jpg_comp.APP_len
suffix:semicolon
id|memcpy
c_func
(paren
id|params-&gt;COM_data
comma
id|fh-&gt;jpg_settings.jpg_comp.COM_data
comma
id|fh-&gt;jpg_settings.jpg_comp.COM_len
)paren
suffix:semicolon
id|params-&gt;COM_len
op_assign
id|fh-&gt;jpg_settings.jpg_comp.COM_len
suffix:semicolon
id|params-&gt;jpeg_markers
op_assign
id|fh-&gt;jpg_settings.jpg_comp.jpeg_markers
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_S_JPEGCOMP
suffix:colon
(brace
r_struct
id|v4l2_jpegcompression
op_star
id|params
op_assign
id|arg
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|settings
op_assign
id|fh-&gt;jpg_settings
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_S_JPEGCOMP - quality=%d, APPN=%d, APP_len=%d, COM_len=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|params-&gt;quality
comma
id|params-&gt;APPn
comma
id|params-&gt;APP_len
comma
id|params-&gt;COM_len
)paren
suffix:semicolon
id|settings.jpg_comp
op_assign
op_star
id|params
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.active
op_ne
id|ZORAN_FREE
op_logical_or
id|fh-&gt;jpg_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_WARNING
l_string|&quot;%s: VIDIOC_S_JPEGCOMP called while in playback/capture mode&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|sjpegc_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_check_jpg_settings
c_func
(paren
id|zr
comma
op_amp
id|settings
)paren
)paren
)paren
r_goto
id|sjpegc_unlock_and_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;jpg_buffers.allocated
)paren
id|fh-&gt;jpg_buffers.buffer_size
op_assign
id|zoran_v4l2_calc_bufsize
c_func
(paren
op_amp
id|fh-&gt;jpg_settings
)paren
suffix:semicolon
id|fh-&gt;jpg_settings.jpg_comp
op_assign
op_star
id|params
op_assign
id|settings.jpg_comp
suffix:semicolon
id|sjpegc_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_QUERYSTD
suffix:colon
multiline_comment|/* why is this useful? */
(brace
id|v4l2_std_id
op_star
id|std
op_assign
id|arg
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_QUERY_STD - std=0x%llx&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
op_star
id|std
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|std
op_eq
id|V4L2_STD_ALL
op_logical_or
op_star
id|std
op_eq
id|V4L2_STD_NTSC
op_logical_or
op_star
id|std
op_eq
id|V4L2_STD_PAL
op_logical_or
(paren
op_star
id|std
op_eq
id|V4L2_STD_SECAM
op_logical_and
id|zr-&gt;card.norms
op_eq
l_int|3
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VIDIOC_TRY_FMT
suffix:colon
(brace
r_struct
id|v4l2_format
op_star
id|fmt
op_assign
id|arg
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_DEBUG
l_string|&quot;%s: VIDIOC_TRY_FMT - type=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fmt-&gt;type
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fmt-&gt;type
)paren
(brace
r_case
id|V4L2_BUF_TYPE_VIDEO_OVERLAY
suffix:colon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.win.w.width
OG
id|BUZ_MAX_WIDTH
)paren
id|fmt-&gt;fmt.win.w.width
op_assign
id|BUZ_MAX_WIDTH
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.win.w.width
OL
id|BUZ_MIN_WIDTH
)paren
id|fmt-&gt;fmt.win.w.width
op_assign
id|BUZ_MIN_WIDTH
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.win.w.height
OG
id|BUZ_MAX_HEIGHT
)paren
id|fmt-&gt;fmt.win.w.height
op_assign
id|BUZ_MAX_HEIGHT
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.win.w.height
OL
id|BUZ_MIN_HEIGHT
)paren
id|fmt-&gt;fmt.win.w.height
op_assign
id|BUZ_MIN_HEIGHT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
suffix:colon
r_case
id|V4L2_BUF_TYPE_VIDEO_OUTPUT
suffix:colon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.bytesperline
OG
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.pixelformat
op_eq
id|V4L2_PIX_FMT_MJPEG
)paren
(brace
id|settings
op_assign
id|fh-&gt;jpg_settings
suffix:semicolon
multiline_comment|/* we actually need to set &squot;real&squot; parameters now */
r_if
c_cond
(paren
(paren
id|fmt-&gt;fmt.pix.height
op_star
l_int|2
)paren
OG
id|BUZ_MAX_HEIGHT
)paren
id|settings.TmpDcm
op_assign
l_int|1
suffix:semicolon
r_else
id|settings.TmpDcm
op_assign
l_int|2
suffix:semicolon
id|settings.decimation
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.height
op_le
id|fh-&gt;jpg_settings.img_height
op_div
l_int|2
)paren
id|settings.VerDcm
op_assign
l_int|2
suffix:semicolon
r_else
id|settings.VerDcm
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.width
op_le
id|fh-&gt;jpg_settings.img_width
op_div
l_int|4
)paren
id|settings.HorDcm
op_assign
l_int|4
suffix:semicolon
r_else
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.width
op_le
id|fh-&gt;jpg_settings.img_width
op_div
l_int|2
)paren
id|settings.HorDcm
op_assign
l_int|2
suffix:semicolon
r_else
id|settings.HorDcm
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|settings.TmpDcm
op_eq
l_int|1
)paren
id|settings.field_per_buff
op_assign
l_int|2
suffix:semicolon
r_else
id|settings.field_per_buff
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* check */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|zoran_check_jpg_settings
c_func
(paren
id|zr
comma
op_amp
id|settings
)paren
)paren
)paren
r_goto
id|tryfmt_unlock_and_return
suffix:semicolon
multiline_comment|/* tell the user what we actually did */
id|fmt-&gt;fmt.pix.width
op_assign
id|settings.img_width
op_div
id|settings.HorDcm
suffix:semicolon
id|fmt-&gt;fmt.pix.height
op_assign
id|settings.img_height
op_star
l_int|2
op_div
(paren
id|settings.TmpDcm
op_star
id|settings.VerDcm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|settings.TmpDcm
op_eq
l_int|1
)paren
id|fmt-&gt;fmt.pix.field
op_assign
(paren
id|fh-&gt;jpg_settings
dot
id|odd_even
ques
c_cond
id|V4L2_FIELD_SEQ_TB
suffix:colon
id|V4L2_FIELD_SEQ_BT
)paren
suffix:semicolon
r_else
id|fmt-&gt;fmt.pix.field
op_assign
(paren
id|fh-&gt;jpg_settings
dot
id|odd_even
ques
c_cond
id|V4L2_FIELD_TOP
suffix:colon
id|V4L2_FIELD_BOTTOM
)paren
suffix:semicolon
id|fmt-&gt;fmt.pix.sizeimage
op_assign
id|zoran_v4l2_calc_bufsize
c_func
(paren
op_amp
id|settings
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|fmt-&gt;type
op_eq
id|V4L2_BUF_TYPE_VIDEO_CAPTURE
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|zoran_num_formats
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|zoran_formats
(braket
id|i
)braket
dot
id|fourcc
op_eq
id|fmt-&gt;fmt.pix.pixelformat
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|zoran_num_formats
)paren
(brace
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|tryfmt_unlock_and_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.width
OG
id|BUZ_MAX_WIDTH
)paren
id|fmt-&gt;fmt.pix.width
op_assign
id|BUZ_MAX_WIDTH
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.width
OL
id|BUZ_MIN_WIDTH
)paren
id|fmt-&gt;fmt.pix.width
op_assign
id|BUZ_MIN_WIDTH
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.height
OG
id|BUZ_MAX_HEIGHT
)paren
id|fmt-&gt;fmt.pix.height
op_assign
id|BUZ_MAX_HEIGHT
suffix:semicolon
r_if
c_cond
(paren
id|fmt-&gt;fmt.pix.height
OL
id|BUZ_MIN_HEIGHT
)paren
id|fmt-&gt;fmt.pix.height
op_assign
id|BUZ_MIN_HEIGHT
suffix:semicolon
)brace
r_else
(brace
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|tryfmt_unlock_and_return
suffix:semicolon
)brace
id|tryfmt_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_DEBUG
l_string|&quot;%s: UNKNOWN ioctl cmd: 0x%x&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|zoran_ioctl
id|zoran_ioctl
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
id|video_usercopy
c_func
(paren
id|inode
comma
id|file
comma
id|cmd
comma
id|arg
comma
id|zoran_do_ioctl
)paren
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|zoran_poll
id|zoran_poll
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
id|wait_queue_head_t
op_star
id|queue
op_assign
l_int|NULL
suffix:semicolon
r_int
id|res
op_assign
l_int|0
comma
id|frame
suffix:semicolon
multiline_comment|/* we should check whether buffers are ready to be synced on&n;&t; * (w/o waits - O_NONBLOCK) here&n;&t; * if ready for read (sync), return POLLIN|POLLRDNORM,&n;&t; * if ready for write (sync), return POLLOUT|POLLWRNORM,&n;&t; * if error, return POLLERR,&n;&t; * if no buffers queued or so, return POLLNVAL&n;&t; */
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|fh-&gt;map_mode
)paren
(brace
r_case
id|ZORAN_MAP_MODE_RAW
suffix:colon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.active
op_eq
id|ZORAN_FREE
op_logical_or
id|zr-&gt;v4l_pend_head
op_eq
id|zr-&gt;v4l_pend_tail
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;%s: zoran_poll() - no buffers queued&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
id|POLLNVAL
suffix:semicolon
r_goto
id|poll_unlock_and_return
suffix:semicolon
)brace
id|queue
op_assign
op_amp
id|zr-&gt;v4l_capq
suffix:semicolon
id|frame
op_assign
id|zr-&gt;v4l_pend
(braket
id|zr-&gt;v4l_pend_tail
op_amp
id|V4L_MASK_FRAME
)braket
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
id|queue
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_eq
id|BUZ_STATE_DONE
)paren
id|res
op_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
r_case
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:colon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.active
op_eq
id|ZORAN_FREE
op_logical_or
id|zr-&gt;jpg_que_head
op_eq
id|zr-&gt;jpg_que_tail
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;%s: zoran_poll() - no buffers queued&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
id|POLLNVAL
suffix:semicolon
r_goto
id|poll_unlock_and_return
suffix:semicolon
)brace
id|queue
op_assign
op_amp
id|zr-&gt;jpg_capq
suffix:semicolon
id|frame
op_assign
id|zr-&gt;jpg_pend
(braket
id|zr-&gt;jpg_que_tail
op_amp
id|BUZ_MASK_FRAME
)braket
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
id|queue
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|frame
)braket
dot
id|state
op_eq
id|BUZ_STATE_DONE
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_JPG_REC
)paren
id|res
op_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_else
id|res
op_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
l_string|&quot;%s: zoran_poll() - internal error, unknown map_mode=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
id|res
op_assign
id|POLLNVAL
suffix:semicolon
r_goto
id|poll_unlock_and_return
suffix:semicolon
)brace
id|poll_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * This maps the buffers to user space.&n; *&n; * Depending on the state of fh-&gt;map_mode&n; * the V4L or the MJPEG buffers are mapped&n; * per buffer or all together&n; *&n; * Note that we need to connect to some&n; * unmap signal event to unmap the de-allocate&n; * the buffer accordingly (zoran_vm_close())&n; */
r_static
r_void
DECL|function|zoran_vm_open
id|zoran_vm_open
(paren
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|zoran_mapping
op_star
id|map
op_assign
id|vma-&gt;vm_private_data
suffix:semicolon
id|map-&gt;count
op_increment
suffix:semicolon
)brace
r_static
r_void
DECL|function|zoran_vm_close
id|zoran_vm_close
(paren
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|zoran_mapping
op_star
id|map
op_assign
id|vma-&gt;vm_private_data
suffix:semicolon
r_struct
id|file
op_star
id|file
op_assign
id|map-&gt;file
suffix:semicolon
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|map-&gt;count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|map-&gt;count
op_eq
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|fh-&gt;map_mode
)paren
(brace
r_case
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
r_case
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_INFO
l_string|&quot;%s: munmap(MJPEG)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;jpg_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|map
op_eq
id|map
)paren
(brace
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|map
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|map
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;jpg_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|map
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|fh-&gt;jpg_buffers.num_buffers
)paren
(brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|jpg_qbuf
c_func
(paren
id|file
comma
op_minus
l_int|1
comma
id|zr-&gt;codec_mode
)paren
suffix:semicolon
id|zr-&gt;jpg_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;jpg_buffers.active
op_assign
id|fh-&gt;jpg_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
)brace
singleline_comment|//jpg_fbuffer_free(file);
id|fh-&gt;jpg_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;jpg_buffers.ready_to_be_freed
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ZORAN_MAP_MODE_RAW
suffix:colon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_INFO
l_string|&quot;%s: munmap(V4L)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;v4l_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|map
op_eq
id|map
)paren
(brace
multiline_comment|/* unqueue/unmap */
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|map
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|map
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fh-&gt;v4l_buffers.num_buffers
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|map
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|fh-&gt;v4l_buffers.num_buffers
)paren
(brace
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.active
op_ne
id|ZORAN_FREE
)paren
(brace
id|zr36057_set_memgrab
c_func
(paren
id|zr
comma
l_int|0
)paren
suffix:semicolon
id|zr-&gt;v4l_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|zr-&gt;v4l_buffers.active
op_assign
id|fh-&gt;v4l_buffers.active
op_assign
id|ZORAN_FREE
suffix:semicolon
)brace
singleline_comment|//v4l_fbuffer_free(file);
id|fh-&gt;v4l_buffers.allocated
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;v4l_buffers.ready_to_be_freed
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: munmap() - internal error - unknown map mode %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
DECL|variable|zoran_vm_ops
r_static
r_struct
id|vm_operations_struct
id|zoran_vm_ops
op_assign
(brace
dot
id|open
op_assign
id|zoran_vm_open
comma
dot
id|close
op_assign
id|zoran_vm_close
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|zoran_mmap
id|zoran_mmap
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|zoran_fh
op_star
id|fh
op_assign
id|file-&gt;private_data
suffix:semicolon
r_struct
id|zoran
op_star
id|zr
op_assign
id|fh-&gt;zr
suffix:semicolon
r_int
r_int
id|size
op_assign
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
)paren
suffix:semicolon
r_int
r_int
id|offset
op_assign
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_int
r_int
id|page
comma
id|start
op_assign
id|vma-&gt;vm_start
comma
id|todo
comma
id|pos
comma
id|fraglen
suffix:semicolon
r_int
id|first
comma
id|last
suffix:semicolon
r_struct
id|zoran_mapping
op_star
id|map
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_int|3
comma
id|KERN_INFO
l_string|&quot;%s: mmap(%s) of 0x%08lx-0x%08lx (size=%lu)&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fh-&gt;map_mode
op_eq
id|ZORAN_MAP_MODE_RAW
ques
c_cond
l_string|&quot;V4L&quot;
suffix:colon
l_string|&quot;MJPEG&quot;
comma
id|vma-&gt;vm_start
comma
id|vma-&gt;vm_end
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_SHARED
)paren
op_logical_or
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
)paren
op_logical_or
op_logical_neg
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: mmap() - no MAP_SHARED/PROT_{READ,WRITE} given&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|fh-&gt;map_mode
)paren
(brace
r_case
id|ZORAN_MAP_MODE_JPG_REC
suffix:colon
r_case
id|ZORAN_MAP_MODE_JPG_PLAY
suffix:colon
multiline_comment|/* lock */
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
multiline_comment|/* Map the MJPEG buffers */
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;jpg_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zoran_mmap(MJPEG) - buffers not yet allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|jpg_mmap_unlock_and_return
suffix:semicolon
)brace
id|first
op_assign
id|offset
op_div
id|fh-&gt;jpg_buffers.buffer_size
suffix:semicolon
id|last
op_assign
id|first
op_minus
l_int|1
op_plus
id|size
op_div
id|fh-&gt;jpg_buffers.buffer_size
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_mod
id|fh-&gt;jpg_buffers.buffer_size
op_ne
l_int|0
op_logical_or
id|size
op_mod
id|fh-&gt;jpg_buffers.buffer_size
op_ne
l_int|0
op_logical_or
id|first
OL
l_int|0
op_logical_or
id|last
OL
l_int|0
op_logical_or
id|first
op_ge
id|fh-&gt;jpg_buffers.num_buffers
op_logical_or
id|last
op_ge
id|fh-&gt;jpg_buffers.num_buffers
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: mmap(MJPEG) - offset=%lu or size=%lu invalid for bufsize=%d and numbufs=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|offset
comma
id|size
comma
id|fh-&gt;jpg_buffers.buffer_size
comma
id|fh-&gt;jpg_buffers.num_buffers
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|jpg_mmap_unlock_and_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|first
suffix:semicolon
id|i
op_le
id|last
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|map
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: mmap(MJPEG) - buffer %d already mapped&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|jpg_mmap_unlock_and_return
suffix:semicolon
)brace
)brace
multiline_comment|/* map these buffers (v4l_buffers[i]) */
id|map
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zoran_mapping
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|map
)paren
(brace
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|jpg_mmap_unlock_and_return
suffix:semicolon
)brace
id|map-&gt;file
op_assign
id|file
suffix:semicolon
id|map-&gt;count
op_assign
l_int|1
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
op_amp
id|zoran_vm_ops
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
id|VM_DONTEXPAND
suffix:semicolon
id|vma-&gt;vm_private_data
op_assign
id|map
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|first
suffix:semicolon
id|i
op_le
id|last
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|fh-&gt;jpg_buffers.buffer_size
op_div
id|PAGE_SIZE
suffix:semicolon
id|j
op_increment
)paren
(brace
id|fraglen
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_plus
l_int|1
)braket
)paren
op_amp
op_complement
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
id|todo
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|todo
OG
id|fraglen
)paren
id|todo
op_assign
id|fraglen
suffix:semicolon
id|pos
op_assign
id|le32_to_cpu
c_func
(paren
(paren
r_int
r_int
)paren
id|fh-&gt;jpg_buffers
dot
id|buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
)braket
)paren
suffix:semicolon
multiline_comment|/* should just be pos on i386 */
id|page
op_assign
id|virt_to_phys
c_func
(paren
id|bus_to_virt
c_func
(paren
id|pos
)paren
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|remap_pfn_range
c_func
(paren
id|vma
comma
id|start
comma
id|page
comma
id|todo
comma
id|PAGE_SHARED
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zoran_mmap(V4L) - remap_pfn_range failed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|jpg_mmap_unlock_and_return
suffix:semicolon
)brace
id|size
op_sub_assign
id|todo
suffix:semicolon
id|start
op_add_assign
id|todo
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|frag_tab
(braket
l_int|2
op_star
id|j
op_plus
l_int|1
)braket
)paren
op_amp
l_int|1
)paren
r_break
suffix:semicolon
multiline_comment|/* was last fragment */
)brace
id|fh-&gt;jpg_buffers.buffer
(braket
id|i
)braket
dot
id|map
op_assign
id|map
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|jpg_mmap_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ZORAN_MAP_MODE_RAW
suffix:colon
id|down
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
multiline_comment|/* Map the V4L buffers */
r_if
c_cond
(paren
op_logical_neg
id|fh-&gt;v4l_buffers.allocated
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zoran_mmap(V4L) - buffers not yet allocated&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|v4l_mmap_unlock_and_return
suffix:semicolon
)brace
id|first
op_assign
id|offset
op_div
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
id|last
op_assign
id|first
op_minus
l_int|1
op_plus
id|size
op_div
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_mod
id|fh-&gt;v4l_buffers.buffer_size
op_ne
l_int|0
op_logical_or
id|size
op_mod
id|fh-&gt;v4l_buffers.buffer_size
op_ne
l_int|0
op_logical_or
id|first
OL
l_int|0
op_logical_or
id|last
OL
l_int|0
op_logical_or
id|first
op_ge
id|fh-&gt;v4l_buffers.num_buffers
op_logical_or
id|last
op_ge
id|fh-&gt;v4l_buffers.buffer_size
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: mmap(V4L) - offset=%lu or size=%lu invalid for bufsize=%d and numbufs=%d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|offset
comma
id|size
comma
id|fh-&gt;v4l_buffers.buffer_size
comma
id|fh-&gt;v4l_buffers.num_buffers
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|v4l_mmap_unlock_and_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|first
suffix:semicolon
id|i
op_le
id|last
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|map
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: mmap(V4L) - buffer %d already mapped&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|i
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|v4l_mmap_unlock_and_return
suffix:semicolon
)brace
)brace
multiline_comment|/* map these buffers (v4l_buffers[i]) */
id|map
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|zoran_mapping
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|map
)paren
(brace
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|v4l_mmap_unlock_and_return
suffix:semicolon
)brace
id|map-&gt;file
op_assign
id|file
suffix:semicolon
id|map-&gt;count
op_assign
l_int|1
suffix:semicolon
id|vma-&gt;vm_ops
op_assign
op_amp
id|zoran_vm_ops
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
id|VM_DONTEXPAND
suffix:semicolon
id|vma-&gt;vm_private_data
op_assign
id|map
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|first
suffix:semicolon
id|i
op_le
id|last
suffix:semicolon
id|i
op_increment
)paren
(brace
id|todo
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|todo
OG
id|fh-&gt;v4l_buffers.buffer_size
)paren
id|todo
op_assign
id|fh-&gt;v4l_buffers.buffer_size
suffix:semicolon
id|page
op_assign
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|fbuffer_phys
suffix:semicolon
r_if
c_cond
(paren
id|remap_pfn_range
c_func
(paren
id|vma
comma
id|start
comma
id|page
op_rshift
id|PAGE_SHIFT
comma
id|todo
comma
id|PAGE_SHARED
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zoran_mmap(V4L)i - remap_pfn_range failed&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|v4l_mmap_unlock_and_return
suffix:semicolon
)brace
id|size
op_sub_assign
id|todo
suffix:semicolon
id|start
op_add_assign
id|todo
suffix:semicolon
id|fh-&gt;v4l_buffers.buffer
(braket
id|i
)braket
dot
id|map
op_assign
id|map
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
id|v4l_mmap_unlock_and_return
suffix:colon
id|up
c_func
(paren
op_amp
id|zr-&gt;resource_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_int|1
comma
id|KERN_ERR
l_string|&quot;%s: zoran_mmap() - internal error - unknown map mode %d&bslash;n&quot;
comma
id|ZR_DEVNAME
c_func
(paren
id|zr
)paren
comma
id|fh-&gt;map_mode
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|zoran_fops
r_static
r_struct
id|file_operations
id|zoran_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|zoran_open
comma
dot
id|release
op_assign
id|zoran_close
comma
dot
id|ioctl
op_assign
id|zoran_ioctl
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|zoran_read
comma
dot
id|write
op_assign
id|zoran_write
comma
dot
id|mmap
op_assign
id|zoran_mmap
comma
dot
id|poll
op_assign
id|zoran_poll
comma
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_struct
id|video_device
id|zoran_template
id|__devinitdata
op_assign
(brace
dot
id|name
op_assign
id|ZORAN_NAME
comma
dot
id|type
op_assign
id|ZORAN_VID_TYPE
comma
macro_line|#ifdef HAVE_V4L2
dot
id|type2
op_assign
id|ZORAN_V4L2_VID_FLAGS
comma
macro_line|#endif
dot
id|hardware
op_assign
id|ZORAN_HARDWARE
comma
dot
id|fops
op_assign
op_amp
id|zoran_fops
comma
dot
id|release
op_assign
op_amp
id|zoran_vdev_release
comma
dot
id|minor
op_assign
op_minus
l_int|1
)brace
suffix:semicolon
eof
