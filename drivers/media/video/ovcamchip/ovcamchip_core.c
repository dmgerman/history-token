multiline_comment|/* Shared Code for OmniVision Camera Chip Drivers&n; *&n; * Copyright (c) 2004 Mark McClelland &lt;mark@alpha.dyndns.org&gt;&n; * http://alpha.dyndns.org/ov511/&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License as published by the&n; * Free Software Foundation; either version 2 of the License, or (at your&n; * option) any later version. NO WARRANTY OF ANY KIND is expressed or implied.&n; */
DECL|macro|DEBUG
mdefine_line|#define DEBUG
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &quot;ovcamchip_priv.h&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v2.27 for Linux 2.6&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Mark McClelland &lt;mark@alpha.dyndns.org&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;OV camera chip I2C driver&quot;
DECL|macro|PINFO
mdefine_line|#define PINFO(fmt, args...) printk(KERN_INFO &quot;ovcamchip: &quot; fmt &quot;&bslash;n&quot; , ## args);
DECL|macro|PERROR
mdefine_line|#define PERROR(fmt, args...) printk(KERN_ERR &quot;ovcamchip: &quot; fmt &quot;&bslash;n&quot; , ## args);
macro_line|#ifdef DEBUG
DECL|variable|ovcamchip_debug
r_int
id|ovcamchip_debug
op_assign
l_int|0
suffix:semicolon
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug level: 0=none, 1=inits, 2=warning, 3=config, 4=functions, 5=all&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* By default, let bridge driver tell us if chip is monochrome. mono=0&n; * will ignore that and always treat chips as color. mono=1 will force&n; * monochrome mode for all chips. */
DECL|variable|mono
r_static
r_int
id|mono
op_assign
op_minus
l_int|1
suffix:semicolon
id|module_param
c_func
(paren
id|mono
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mono
comma
l_string|&quot;1=chips are monochrome (OVx1xx), 0=force color, -1=autodetect (default)&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Registers common to all chips, that are needed for detection */
DECL|macro|GENERIC_REG_ID_HIGH
mdefine_line|#define GENERIC_REG_ID_HIGH       0x1C&t;/* manufacturer ID MSB */
DECL|macro|GENERIC_REG_ID_LOW
mdefine_line|#define GENERIC_REG_ID_LOW        0x1D&t;/* manufacturer ID LSB */
DECL|macro|GENERIC_REG_COM_I
mdefine_line|#define GENERIC_REG_COM_I         0x29&t;/* misc ID bits */
r_extern
r_struct
id|ovcamchip_ops
id|ov6x20_ops
suffix:semicolon
r_extern
r_struct
id|ovcamchip_ops
id|ov6x30_ops
suffix:semicolon
r_extern
r_struct
id|ovcamchip_ops
id|ov7x10_ops
suffix:semicolon
r_extern
r_struct
id|ovcamchip_ops
id|ov7x20_ops
suffix:semicolon
r_extern
r_struct
id|ovcamchip_ops
id|ov76be_ops
suffix:semicolon
DECL|variable|chip_names
r_static
r_char
op_star
id|chip_names
(braket
id|NUM_CC_TYPES
)braket
op_assign
(brace
(braket
id|CC_UNKNOWN
)braket
op_assign
l_string|&quot;Unknown chip&quot;
comma
(braket
id|CC_OV76BE
)braket
op_assign
l_string|&quot;OV76BE&quot;
comma
(braket
id|CC_OV7610
)braket
op_assign
l_string|&quot;OV7610&quot;
comma
(braket
id|CC_OV7620
)braket
op_assign
l_string|&quot;OV7620&quot;
comma
(braket
id|CC_OV7620AE
)braket
op_assign
l_string|&quot;OV7620AE&quot;
comma
(braket
id|CC_OV6620
)braket
op_assign
l_string|&quot;OV6620&quot;
comma
(braket
id|CC_OV6630
)braket
op_assign
l_string|&quot;OV6630&quot;
comma
(braket
id|CC_OV6630AE
)braket
op_assign
l_string|&quot;OV6630AE&quot;
comma
(braket
id|CC_OV6630AF
)braket
op_assign
l_string|&quot;OV6630AF&quot;
comma
)brace
suffix:semicolon
multiline_comment|/* Forward declarations */
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
suffix:semicolon
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|function|ov_write_regvals
r_int
id|ov_write_regvals
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_struct
id|ovcamchip_regvals
op_star
id|rvals
)paren
(brace
r_int
id|rc
suffix:semicolon
r_while
c_loop
(paren
id|rvals-&gt;reg
op_ne
l_int|0xff
)paren
(brace
id|rc
op_assign
id|ov_write
c_func
(paren
id|c
comma
id|rvals-&gt;reg
comma
id|rvals-&gt;val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|rvals
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Writes bits at positions specified by mask to an I2C reg. Bits that are in&n; * the same position as 1&squot;s in &quot;mask&quot; are cleared and set to &quot;value&quot;. Bits&n; * that are in the same position as 0&squot;s in &quot;mask&quot; are preserved, regardless&n; * of their respective state in &quot;value&quot;.&n; */
DECL|function|ov_write_mask
r_int
id|ov_write_mask
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
comma
r_int
r_char
id|mask
)paren
(brace
r_int
id|rc
suffix:semicolon
r_int
r_char
id|oldval
comma
id|newval
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|0xff
)paren
(brace
id|newval
op_assign
id|value
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|ov_read
c_func
(paren
id|c
comma
id|reg
comma
op_amp
id|oldval
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|oldval
op_and_assign
(paren
op_complement
id|mask
)paren
suffix:semicolon
multiline_comment|/* Clear the masked bits */
id|value
op_and_assign
id|mask
suffix:semicolon
multiline_comment|/* Enforce mask on value */
id|newval
op_assign
id|oldval
op_or
id|value
suffix:semicolon
multiline_comment|/* Set the desired bits */
)brace
r_return
id|ov_write
c_func
(paren
id|c
comma
id|reg
comma
id|newval
)paren
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
multiline_comment|/* Reset the chip and ensure that I2C is synchronized. Returns &lt;0 if failure.&n; */
DECL|function|init_camchip
r_static
r_int
id|init_camchip
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_int
id|i
comma
id|success
suffix:semicolon
r_int
r_char
id|high
comma
id|low
suffix:semicolon
multiline_comment|/* Reset the chip */
id|ov_write
c_func
(paren
id|c
comma
l_int|0x12
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|msleep
c_func
(paren
l_int|150
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|success
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|I2C_DETECT_RETRIES
op_logical_and
op_logical_neg
id|success
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ov_read
c_func
(paren
id|c
comma
id|GENERIC_REG_ID_HIGH
comma
op_amp
id|high
)paren
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ov_read
c_func
(paren
id|c
comma
id|GENERIC_REG_ID_LOW
comma
op_amp
id|low
)paren
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|high
op_eq
l_int|0x7F
op_logical_and
id|low
op_eq
l_int|0xA2
)paren
(brace
id|success
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Reset the chip */
id|ov_write
c_func
(paren
id|c
comma
l_int|0x12
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* Wait for it to initialize */
id|msleep
c_func
(paren
l_int|150
)paren
suffix:semicolon
multiline_comment|/* Dummy read to sync I2C */
id|ov_read
c_func
(paren
id|c
comma
l_int|0x00
comma
op_amp
id|low
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|success
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;I2C synced in %d attempt(s)&quot;
comma
id|i
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This detects the OV7610, OV7620, or OV76BE chip. */
DECL|function|ov7xx0_detect
r_static
r_int
id|ov7xx0_detect
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_struct
id|ovcamchip
op_star
id|ov
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* Detect chip (sub)type */
id|rc
op_assign
id|ov_read
c_func
(paren
id|c
comma
id|GENERIC_REG_COM_I
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|PERROR
c_func
(paren
l_string|&quot;Error detecting ov7xx0 type&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|3
)paren
op_eq
l_int|3
)paren
(brace
id|PINFO
c_func
(paren
l_string|&quot;Camera chip is an OV7610&quot;
)paren
suffix:semicolon
id|ov-&gt;subtype
op_assign
id|CC_OV7610
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|3
)paren
op_eq
l_int|1
)paren
(brace
id|rc
op_assign
id|ov_read
c_func
(paren
id|c
comma
l_int|0x15
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|PERROR
c_func
(paren
l_string|&quot;Error detecting ov7xx0 type&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
op_amp
l_int|1
)paren
(brace
id|PINFO
c_func
(paren
l_string|&quot;Camera chip is an OV7620AE&quot;
)paren
suffix:semicolon
multiline_comment|/* OV7620 is a close enough match for now. There are&n;&t;&t;&t; * some definite differences though, so this should be&n;&t;&t;&t; * fixed */
id|ov-&gt;subtype
op_assign
id|CC_OV7620
suffix:semicolon
)brace
r_else
(brace
id|PINFO
c_func
(paren
l_string|&quot;Camera chip is an OV76BE&quot;
)paren
suffix:semicolon
id|ov-&gt;subtype
op_assign
id|CC_OV76BE
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|PINFO
c_func
(paren
l_string|&quot;Camera chip is an OV7620&quot;
)paren
suffix:semicolon
id|ov-&gt;subtype
op_assign
id|CC_OV7620
suffix:semicolon
)brace
r_else
(brace
id|PERROR
c_func
(paren
l_string|&quot;Unknown camera chip version: %d&quot;
comma
id|val
op_amp
l_int|3
)paren
suffix:semicolon
r_return
op_minus
id|ENOSYS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;subtype
op_eq
id|CC_OV76BE
)paren
id|ov-&gt;sops
op_assign
op_amp
id|ov76be_ops
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ov-&gt;subtype
op_eq
id|CC_OV7620
)paren
id|ov-&gt;sops
op_assign
op_amp
id|ov7x20_ops
suffix:semicolon
r_else
id|ov-&gt;sops
op_assign
op_amp
id|ov7x10_ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This detects the OV6620, OV6630, OV6630AE, or OV6630AF chip. */
DECL|function|ov6xx0_detect
r_static
r_int
id|ov6xx0_detect
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_struct
id|ovcamchip
op_star
id|ov
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|4
comma
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* Detect chip (sub)type */
id|rc
op_assign
id|ov_read
c_func
(paren
id|c
comma
id|GENERIC_REG_COM_I
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|PERROR
c_func
(paren
l_string|&quot;Error detecting ov6xx0 type&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|ov-&gt;subtype
op_assign
id|CC_OV6630
suffix:semicolon
id|PINFO
c_func
(paren
l_string|&quot;Camera chip is an OV6630&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|3
)paren
op_eq
l_int|1
)paren
(brace
id|ov-&gt;subtype
op_assign
id|CC_OV6620
suffix:semicolon
id|PINFO
c_func
(paren
l_string|&quot;Camera chip is an OV6620&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|3
)paren
op_eq
l_int|2
)paren
(brace
id|ov-&gt;subtype
op_assign
id|CC_OV6630
suffix:semicolon
id|PINFO
c_func
(paren
l_string|&quot;Camera chip is an OV6630AE&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|3
)paren
op_eq
l_int|3
)paren
(brace
id|ov-&gt;subtype
op_assign
id|CC_OV6630
suffix:semicolon
id|PINFO
c_func
(paren
l_string|&quot;Camera chip is an OV6630AF&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ov-&gt;subtype
op_eq
id|CC_OV6620
)paren
id|ov-&gt;sops
op_assign
op_amp
id|ov6x20_ops
suffix:semicolon
r_else
id|ov-&gt;sops
op_assign
op_amp
id|ov6x30_ops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ovcamchip_detect
r_static
r_int
id|ovcamchip_detect
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
multiline_comment|/* Ideally we would just try a single register write and see if it NAKs.&n;&t; * That isn&squot;t possible since the OV518 can&squot;t report I2C transaction&n;&t; * failures. So, we have to try to initialize the chip (i.e. reset it&n;&t; * and check the ID registers) to detect its presence. */
multiline_comment|/* Test for 7xx0 */
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Testing for 0V7xx0&quot;
)paren
suffix:semicolon
id|c-&gt;addr
op_assign
id|OV7xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|init_camchip
c_func
(paren
id|c
)paren
OL
l_int|0
)paren
(brace
multiline_comment|/* Test for 6xx0 */
id|PDEBUG
c_func
(paren
l_int|3
comma
l_string|&quot;Testing for 0V6xx0&quot;
)paren
suffix:semicolon
id|c-&gt;addr
op_assign
id|OV6xx0_SID
suffix:semicolon
r_if
c_cond
(paren
id|init_camchip
c_func
(paren
id|c
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov6xx0_detect
c_func
(paren
id|c
)paren
OL
l_int|0
)paren
(brace
id|PERROR
c_func
(paren
l_string|&quot;Failed to init OV6xx0&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|ov7xx0_detect
c_func
(paren
id|c
)paren
OL
l_int|0
)paren
(brace
id|PERROR
c_func
(paren
l_string|&quot;Failed to init OV7xx0&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|function|ovcamchip_attach
r_static
r_int
id|ovcamchip_attach
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|ovcamchip
op_star
id|ov
suffix:semicolon
r_struct
id|i2c_client
op_star
id|c
suffix:semicolon
multiline_comment|/* I2C is not a PnP bus, so we can never be certain that we&squot;re talking&n;&t; * to the right chip. To prevent damage to EEPROMS and such, only&n;&t; * attach to adapters that are known to contain OV camera chips. */
r_switch
c_cond
(paren
id|adap-&gt;id
)paren
(brace
r_case
(paren
id|I2C_ALGO_SMBUS
op_or
id|I2C_HW_SMBUS_OV511
)paren
suffix:colon
r_case
(paren
id|I2C_ALGO_SMBUS
op_or
id|I2C_HW_SMBUS_OV518
)paren
suffix:colon
r_case
(paren
id|I2C_ALGO_SMBUS
op_or
id|I2C_HW_SMBUS_OVFX2
)paren
suffix:colon
r_case
(paren
id|I2C_ALGO_SMBUS
op_or
id|I2C_HW_SMBUS_W9968CF
)paren
suffix:colon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Adapter ID 0x%06x accepted&quot;
comma
id|adap-&gt;id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Adapter ID 0x%06x rejected&quot;
comma
id|adap-&gt;id
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|c
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|c
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|no_client
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|c
comma
op_amp
id|client_template
comma
r_sizeof
op_star
id|c
)paren
suffix:semicolon
id|c-&gt;adapter
op_assign
id|adap
suffix:semicolon
id|strcpy
c_func
(paren
id|i2c_clientname
c_func
(paren
id|c
)paren
comma
l_string|&quot;OV????&quot;
)paren
suffix:semicolon
id|ov
op_assign
id|kmalloc
c_func
(paren
r_sizeof
op_star
id|ov
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|no_ov
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ov
comma
l_int|0
comma
r_sizeof
op_star
id|ov
)paren
suffix:semicolon
id|i2c_set_clientdata
c_func
(paren
id|c
comma
id|ov
)paren
suffix:semicolon
id|rc
op_assign
id|ovcamchip_detect
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
id|strcpy
c_func
(paren
id|i2c_clientname
c_func
(paren
id|c
)paren
comma
id|chip_names
(braket
id|ov-&gt;subtype
)braket
)paren
suffix:semicolon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;Camera chip detection complete&quot;
)paren
suffix:semicolon
id|i2c_attach_client
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
id|error
suffix:colon
id|kfree
c_func
(paren
id|ov
)paren
suffix:semicolon
id|no_ov
suffix:colon
id|kfree
c_func
(paren
id|c
)paren
suffix:semicolon
id|no_client
suffix:colon
id|PDEBUG
c_func
(paren
l_int|1
comma
l_string|&quot;returning %d&quot;
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ovcamchip_detach
r_static
r_int
id|ovcamchip_detach
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
)paren
(brace
r_struct
id|ovcamchip
op_star
id|ov
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|ov-&gt;sops
op_member_access_from_pointer
id|free
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|i2c_detach_client
c_func
(paren
id|c
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ov
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ovcamchip_command
r_static
r_int
id|ovcamchip_command
c_func
(paren
r_struct
id|i2c_client
op_star
id|c
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|ovcamchip
op_star
id|ov
op_assign
id|i2c_get_clientdata
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ov-&gt;initialized
op_logical_and
id|cmd
op_ne
id|OVCAMCHIP_CMD_Q_SUBTYPE
op_logical_and
id|cmd
op_ne
id|OVCAMCHIP_CMD_INITIALIZE
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|c-&gt;dev
comma
l_string|&quot;ERROR: Camera chip not initialized yet!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OVCAMCHIP_CMD_Q_SUBTYPE
suffix:colon
(brace
op_star
(paren
r_int
op_star
)paren
id|arg
op_assign
id|ov-&gt;subtype
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|OVCAMCHIP_CMD_INITIALIZE
suffix:colon
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|mono
op_eq
op_minus
l_int|1
)paren
id|ov-&gt;mono
op_assign
op_star
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_else
id|ov-&gt;mono
op_assign
id|mono
suffix:semicolon
r_if
c_cond
(paren
id|ov-&gt;mono
)paren
(brace
r_if
c_cond
(paren
id|ov-&gt;subtype
op_ne
id|CC_OV7620
)paren
id|dev_warn
c_func
(paren
op_amp
id|c-&gt;dev
comma
l_string|&quot;Warning: Monochrome not &quot;
l_string|&quot;implemented for this chip&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|dev_info
c_func
(paren
op_amp
id|c-&gt;dev
comma
l_string|&quot;Initializing chip as &quot;
l_string|&quot;monochrome&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|ov-&gt;sops
op_member_access_from_pointer
id|init
c_func
(paren
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|ov-&gt;initialized
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
id|ov-&gt;sops
op_member_access_from_pointer
id|command
c_func
(paren
id|c
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ----------------------------------------------------------------------- */
DECL|variable|driver
r_static
r_struct
id|i2c_driver
id|driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;ovcamchip&quot;
comma
dot
id|id
op_assign
id|I2C_DRIVERID_OVCAMCHIP
comma
dot
r_class
op_assign
id|I2C_CLASS_CAM_DIGITAL
comma
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
id|ovcamchip_attach
comma
dot
id|detach_client
op_assign
id|ovcamchip_detach
comma
dot
id|command
op_assign
id|ovcamchip_command
comma
)brace
suffix:semicolon
DECL|variable|client_template
r_static
r_struct
id|i2c_client
id|client_template
op_assign
(brace
id|I2C_DEVNAME
c_func
(paren
l_string|&quot;(unset)&quot;
)paren
comma
dot
id|driver
op_assign
op_amp
id|driver
comma
)brace
suffix:semicolon
DECL|function|ovcamchip_init
r_static
r_int
id|__init
id|ovcamchip_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef DEBUG
id|ovcamchip_debug
op_assign
id|debug
suffix:semicolon
macro_line|#endif
id|PINFO
c_func
(paren
id|DRIVER_VERSION
l_string|&quot; : &quot;
id|DRIVER_DESC
)paren
suffix:semicolon
r_return
id|i2c_add_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|function|ovcamchip_exit
r_static
r_void
id|__exit
id|ovcamchip_exit
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|variable|ovcamchip_init
id|module_init
c_func
(paren
id|ovcamchip_init
)paren
suffix:semicolon
DECL|variable|ovcamchip_exit
id|module_exit
c_func
(paren
id|ovcamchip_exit
)paren
suffix:semicolon
eof
