multiline_comment|/*&n;&t;Winbond w9966cf Webcam parport driver.&n;&n;&t;Version 0.32&n;&n;&t;Copyright (C) 2001 Jakob Kemi &lt;jakob.kemi@post.utfors.se&gt;&n;&n;&t;This program is free software; you can redistribute it and/or modify&n;&t;it under the terms of the GNU General Public License as published by&n;&t;the Free Software Foundation; either version 2 of the License, or&n;&t;(at your option) any later version.&n;&n;&t;This program is distributed in the hope that it will be useful,&n;&t;but WITHOUT ANY WARRANTY; without even the implied warranty of&n;&t;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;&t;GNU General Public License for more details.&n;&n;&t;You should have received a copy of the GNU General Public License&n;&t;along with this program; if not, write to the Free Software&n;&t;Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;*/
multiline_comment|/*&n;&t;Supported devices:&n;&t;*Lifeview FlyCam Supra (using the Philips saa7111a chip)&n;&n;&t;Does any other model using the w9966 interface chip exist ?&n;&n;&t;Todo:&n;&t;&n;&t;*Add a working EPP mode, since DMA ECP read isn&squot;t implemented&n;&t;in the parport drivers. (That&squot;s why it&squot;s so sloow)&n;&n;&t;*Add support for other ccd-control chips than the saa7111&n;&t;please send me feedback on what kind of chips you have.&n;&n;&t;*Add proper probing. I don&squot;t know what&squot;s wrong with the IEEE1284&n;&t;parport drivers but (IEEE1284_MODE_NIBBLE|IEEE1284_DEVICE_ID)&n;&t;and nibble read seems to be broken for some peripherals.&n;&n;&t;*Add probing for onboard SRAM, port directions etc. (if possible)&n;&n;&t;*Add support for the hardware compressed modes (maybe using v4l2)&n;&n;&t;*Fix better support for the capture window (no skewed images, v4l&n;&t;interface to capt. window)&n;&n;&t;*Probably some bugs that I don&squot;t know of&n;&n;&t;Please support me by sending feedback!&n;&t;&n;&t;Changes:&n;&t;&n;&t;Alan Cox:&t;Removed RGB mode for kernel merge, added THIS_MODULE&n;&t;&t;&t;and owner support for newer module locks&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/videodev.h&gt;
macro_line|#include &lt;linux/parport.h&gt;
singleline_comment|//#define DEBUG&t;&t;&t;&t;// Undef me for production
macro_line|#ifdef DEBUG
DECL|macro|DPRINTF
mdefine_line|#define DPRINTF(x, a...) printk(KERN_DEBUG &quot;W9966: %s(): &quot;x, __FUNCTION__ , ##a)
macro_line|#else
DECL|macro|DPRINTF
mdefine_line|#define DPRINTF(x...)
macro_line|#endif
multiline_comment|/*&n; *&t;Defines, simple typedefs etc.&n; */
DECL|macro|W9966_DRIVERNAME
mdefine_line|#define W9966_DRIVERNAME&t;&quot;W9966CF Webcam&quot;
DECL|macro|W9966_MAXCAMS
mdefine_line|#define W9966_MAXCAMS&t;&t;4&t;
singleline_comment|// Maximum number of cameras
DECL|macro|W9966_RBUFFER
mdefine_line|#define W9966_RBUFFER&t;&t;2048&t;
singleline_comment|// Read buffer (must be an even number)
DECL|macro|W9966_SRAMSIZE
mdefine_line|#define W9966_SRAMSIZE&t;&t;131072&t;
singleline_comment|// 128kb
DECL|macro|W9966_SRAMID
mdefine_line|#define W9966_SRAMID&t;&t;0x02&t;
singleline_comment|// check w9966cf.pdf
singleline_comment|// Empirically determined window limits
DECL|macro|W9966_WND_MIN_X
mdefine_line|#define W9966_WND_MIN_X&t;&t;16
DECL|macro|W9966_WND_MIN_Y
mdefine_line|#define W9966_WND_MIN_Y&t;&t;14
DECL|macro|W9966_WND_MAX_X
mdefine_line|#define W9966_WND_MAX_X&t;&t;705
DECL|macro|W9966_WND_MAX_Y
mdefine_line|#define W9966_WND_MAX_Y&t;&t;253
DECL|macro|W9966_WND_MAX_W
mdefine_line|#define W9966_WND_MAX_W&t;&t;(W9966_WND_MAX_X - W9966_WND_MIN_X)
DECL|macro|W9966_WND_MAX_H
mdefine_line|#define W9966_WND_MAX_H&t;&t;(W9966_WND_MAX_Y - W9966_WND_MIN_Y)
singleline_comment|// Keep track of our current state
DECL|macro|W9966_STATE_PDEV
mdefine_line|#define W9966_STATE_PDEV&t;0x01
DECL|macro|W9966_STATE_CLAIMED
mdefine_line|#define W9966_STATE_CLAIMED&t;0x02
DECL|macro|W9966_STATE_VDEV
mdefine_line|#define W9966_STATE_VDEV&t;0x04
DECL|macro|W9966_I2C_W_ID
mdefine_line|#define W9966_I2C_W_ID&t;&t;0x48
DECL|macro|W9966_I2C_R_ID
mdefine_line|#define W9966_I2C_R_ID&t;&t;0x49
DECL|macro|W9966_I2C_R_DATA
mdefine_line|#define W9966_I2C_R_DATA&t;0x08
DECL|macro|W9966_I2C_R_CLOCK
mdefine_line|#define W9966_I2C_R_CLOCK&t;0x04
DECL|macro|W9966_I2C_W_DATA
mdefine_line|#define W9966_I2C_W_DATA&t;0x02
DECL|macro|W9966_I2C_W_CLOCK
mdefine_line|#define W9966_I2C_W_CLOCK&t;0x01
DECL|struct|w9966_dev
r_struct
id|w9966_dev
(brace
DECL|member|dev_state
r_int
r_char
id|dev_state
suffix:semicolon
DECL|member|i2c_state
r_int
r_char
id|i2c_state
suffix:semicolon
DECL|member|ppmode
r_int
r_int
id|ppmode
suffix:semicolon
DECL|member|pport
r_struct
id|parport
op_star
id|pport
suffix:semicolon
DECL|member|pdev
r_struct
id|pardevice
op_star
id|pdev
suffix:semicolon
DECL|member|vdev
r_struct
id|video_device
id|vdev
suffix:semicolon
DECL|member|width
r_int
r_int
id|width
suffix:semicolon
DECL|member|height
r_int
r_int
id|height
suffix:semicolon
DECL|member|brightness
r_int
r_char
id|brightness
suffix:semicolon
DECL|member|contrast
r_int
r_char
id|contrast
suffix:semicolon
DECL|member|color
r_int
r_char
id|color
suffix:semicolon
DECL|member|hue
r_int
r_char
id|hue
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Module specific properties&n; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jakob Kemi &lt;jakob.kemi@post.utfors.se&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Winbond w9966cf WebCam driver (0.32)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|variable|pardev
r_static
r_const
r_char
op_star
id|pardev
(braket
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|W9966_MAXCAMS
)braket
op_assign
l_string|&quot;&quot;
)brace
suffix:semicolon
macro_line|#else
DECL|variable|pardev
r_static
r_const
r_char
op_star
id|pardev
(braket
)braket
op_assign
(brace
(braket
l_int|0
dot
dot
dot
id|W9966_MAXCAMS
)braket
op_assign
l_string|&quot;aggressive&quot;
)brace
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|pardev
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|W9966_MAXCAMS
)paren
l_string|&quot;s&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pardev
comma
l_string|&quot;pardev: where to search for&bslash;n&bslash;&n;&bslash;teach camera. &squot;aggressive&squot; means brute-force search.&bslash;n&bslash;&n;&bslash;tEg: &gt;pardev=parport3,aggressive,parport2,parport1&lt; would assign&bslash;n&bslash;&n;&bslash;tcam 1 to parport3 and search every parport for cam 2 etc...&quot;
)paren
suffix:semicolon
DECL|variable|parmode
r_static
r_int
id|parmode
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|parmode
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|parmode
comma
l_string|&quot;parmode: transfer mode (0=auto, 1=ecp, 2=epp&quot;
)paren
suffix:semicolon
DECL|variable|video_nr
r_static
r_int
id|video_nr
op_assign
op_minus
l_int|1
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|video_nr
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Private data&n; */
DECL|variable|w9966_cams
r_static
r_struct
id|w9966_dev
id|w9966_cams
(braket
id|W9966_MAXCAMS
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;Private function declares&n; */
r_static
r_inline
r_void
id|w9966_setState
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|mask
comma
r_int
id|val
)paren
suffix:semicolon
r_static
r_inline
r_int
id|w9966_getState
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|mask
comma
r_int
id|val
)paren
suffix:semicolon
r_static
r_inline
r_void
id|w9966_pdev_claim
c_func
(paren
r_struct
id|w9966_dev
op_star
id|vdev
)paren
suffix:semicolon
r_static
r_inline
r_void
id|w9966_pdev_release
c_func
(paren
r_struct
id|w9966_dev
op_star
id|vdev
)paren
suffix:semicolon
r_static
r_int
id|w9966_rReg
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|reg
)paren
suffix:semicolon
r_static
r_int
id|w9966_wReg
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|reg
comma
r_int
id|data
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|w9966_rReg_i2c
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|reg
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|w9966_wReg_i2c
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|reg
comma
r_int
id|data
)paren
suffix:semicolon
r_static
r_int
id|w9966_findlen
c_func
(paren
r_int
id|near
comma
r_int
id|size
comma
r_int
id|maxlen
)paren
suffix:semicolon
r_static
r_int
id|w9966_calcscale
c_func
(paren
r_int
id|size
comma
r_int
id|min
comma
r_int
id|max
comma
r_int
op_star
id|beg
comma
r_int
op_star
id|end
comma
r_int
r_char
op_star
id|factor
)paren
suffix:semicolon
r_static
r_int
id|w9966_setup
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|x1
comma
r_int
id|y1
comma
r_int
id|x2
comma
r_int
id|y2
comma
r_int
id|w
comma
r_int
id|h
)paren
suffix:semicolon
r_static
r_int
id|w9966_init
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_struct
id|parport
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|w9966_term
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
suffix:semicolon
r_static
r_inline
r_void
id|w9966_i2c_setsda
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_inline
r_int
id|w9966_i2c_setscl
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|state
)paren
suffix:semicolon
r_static
r_inline
r_int
id|w9966_i2c_getsda
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
suffix:semicolon
r_static
r_inline
r_int
id|w9966_i2c_getscl
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
suffix:semicolon
r_static
r_int
id|w9966_i2c_wbyte
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|data
)paren
suffix:semicolon
macro_line|#if 0
r_static
r_int
id|w9966_i2c_rbyte
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
suffix:semicolon
macro_line|#endif
r_static
r_int
id|w9966_v4l_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
id|ssize_t
id|w9966_v4l_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
DECL|variable|w9966_fops
r_static
r_struct
id|file_operations
id|w9966_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|video_exclusive_open
comma
dot
id|release
op_assign
id|video_exclusive_release
comma
dot
id|ioctl
op_assign
id|w9966_v4l_ioctl
comma
dot
id|read
op_assign
id|w9966_v4l_read
comma
dot
id|llseek
op_assign
id|no_llseek
comma
)brace
suffix:semicolon
DECL|variable|w9966_template
r_static
r_struct
id|video_device
id|w9966_template
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|W9966_DRIVERNAME
comma
dot
id|type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_SCALES
comma
dot
id|hardware
op_assign
id|VID_HARDWARE_W9966
comma
dot
id|fops
op_assign
op_amp
id|w9966_fops
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Private function defines&n; */
singleline_comment|// Set camera phase flags, so we know what to uninit when terminating 
DECL|function|w9966_setState
r_static
r_inline
r_void
id|w9966_setState
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|mask
comma
r_int
id|val
)paren
(brace
id|cam-&gt;dev_state
op_assign
(paren
id|cam-&gt;dev_state
op_amp
op_complement
id|mask
)paren
op_xor
id|val
suffix:semicolon
)brace
singleline_comment|// Get camera phase flags
DECL|function|w9966_getState
r_static
r_inline
r_int
id|w9966_getState
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|mask
comma
r_int
id|val
)paren
(brace
r_return
(paren
(paren
id|cam-&gt;dev_state
op_amp
id|mask
)paren
op_eq
id|val
)paren
suffix:semicolon
)brace
singleline_comment|// Claim parport for ourself
DECL|function|w9966_pdev_claim
r_static
r_inline
r_void
id|w9966_pdev_claim
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
(brace
r_if
c_cond
(paren
id|w9966_getState
c_func
(paren
id|cam
comma
id|W9966_STATE_CLAIMED
comma
id|W9966_STATE_CLAIMED
)paren
)paren
r_return
suffix:semicolon
id|parport_claim_or_block
c_func
(paren
id|cam-&gt;pdev
)paren
suffix:semicolon
id|w9966_setState
c_func
(paren
id|cam
comma
id|W9966_STATE_CLAIMED
comma
id|W9966_STATE_CLAIMED
)paren
suffix:semicolon
)brace
singleline_comment|// Release parport for others to use
DECL|function|w9966_pdev_release
r_static
r_inline
r_void
id|w9966_pdev_release
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
(brace
r_if
c_cond
(paren
id|w9966_getState
c_func
(paren
id|cam
comma
id|W9966_STATE_CLAIMED
comma
l_int|0
)paren
)paren
r_return
suffix:semicolon
id|parport_release
c_func
(paren
id|cam-&gt;pdev
)paren
suffix:semicolon
id|w9966_setState
c_func
(paren
id|cam
comma
id|W9966_STATE_CLAIMED
comma
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|// Read register from W9966 interface-chip
singleline_comment|// Expects a claimed pdev
singleline_comment|// -1 on error, else register data (byte)
DECL|function|w9966_rReg
r_static
r_int
id|w9966_rReg
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|reg
)paren
(brace
singleline_comment|// ECP, read, regtransfer, REG, REG, REG, REG, REG
r_const
r_int
r_char
id|addr
op_assign
l_int|0x80
op_or
(paren
id|reg
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
id|parport_negotiate
c_func
(paren
id|cam-&gt;pport
comma
id|cam-&gt;ppmode
op_or
id|IEEE1284_ADDR
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|parport_write
c_func
(paren
id|cam-&gt;pport
comma
op_amp
id|addr
comma
l_int|1
)paren
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|parport_negotiate
c_func
(paren
id|cam-&gt;pport
comma
id|cam-&gt;ppmode
op_or
id|IEEE1284_DATA
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|parport_read
c_func
(paren
id|cam-&gt;pport
comma
op_amp
id|val
comma
l_int|1
)paren
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
singleline_comment|// Write register to W9966 interface-chip
singleline_comment|// Expects a claimed pdev
singleline_comment|// -1 on error
DECL|function|w9966_wReg
r_static
r_int
id|w9966_wReg
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
singleline_comment|// ECP, write, regtransfer, REG, REG, REG, REG, REG
r_const
r_int
r_char
id|addr
op_assign
l_int|0xc0
op_or
(paren
id|reg
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_const
r_int
r_char
id|val
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|parport_negotiate
c_func
(paren
id|cam-&gt;pport
comma
id|cam-&gt;ppmode
op_or
id|IEEE1284_ADDR
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|parport_write
c_func
(paren
id|cam-&gt;pport
comma
op_amp
id|addr
comma
l_int|1
)paren
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|parport_negotiate
c_func
(paren
id|cam-&gt;pport
comma
id|cam-&gt;ppmode
op_or
id|IEEE1284_DATA
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|parport_write
c_func
(paren
id|cam-&gt;pport
comma
op_amp
id|val
comma
l_int|1
)paren
op_ne
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Initialize camera device. Setup all internal flags, set a
singleline_comment|// default video mode, setup ccd-chip, register v4l device etc..
singleline_comment|// Also used for &squot;probing&squot; of hardware.
singleline_comment|// -1 on error
DECL|function|w9966_init
r_static
r_int
id|w9966_init
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_struct
id|parport
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
id|cam-&gt;dev_state
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|cam-&gt;pport
op_assign
id|port
suffix:semicolon
id|cam-&gt;brightness
op_assign
l_int|128
suffix:semicolon
id|cam-&gt;contrast
op_assign
l_int|64
suffix:semicolon
id|cam-&gt;color
op_assign
l_int|64
suffix:semicolon
id|cam-&gt;hue
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Select requested transfer mode
r_switch
c_cond
(paren
id|parmode
)paren
(brace
r_default
suffix:colon
(brace
)brace
singleline_comment|// Auto-detect (priority: hw-ecp, hw-epp, sw-ecp)
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|port-&gt;modes
op_amp
id|PARPORT_MODE_ECP
)paren
id|cam-&gt;ppmode
op_assign
id|IEEE1284_MODE_ECP
suffix:semicolon
r_else
r_if
c_cond
(paren
id|port-&gt;modes
op_amp
id|PARPORT_MODE_EPP
)paren
id|cam-&gt;ppmode
op_assign
id|IEEE1284_MODE_EPP
suffix:semicolon
r_else
id|cam-&gt;ppmode
op_assign
id|IEEE1284_MODE_ECP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
singleline_comment|// hw- or sw-ecp
id|cam-&gt;ppmode
op_assign
id|IEEE1284_MODE_ECP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
singleline_comment|// hw- or sw-epp
id|cam-&gt;ppmode
op_assign
id|IEEE1284_MODE_EPP
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// Tell the parport driver that we exists
id|cam-&gt;pdev
op_assign
id|parport_register_device
c_func
(paren
id|port
comma
l_string|&quot;w9966&quot;
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cam-&gt;pdev
op_eq
l_int|NULL
)paren
(brace
id|DPRINTF
c_func
(paren
l_string|&quot;parport_register_device() failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|w9966_setState
c_func
(paren
id|cam
comma
id|W9966_STATE_PDEV
comma
id|W9966_STATE_PDEV
)paren
suffix:semicolon
id|w9966_pdev_claim
c_func
(paren
id|cam
)paren
suffix:semicolon
singleline_comment|// Setup a default capture mode
r_if
c_cond
(paren
id|w9966_setup
c_func
(paren
id|cam
comma
l_int|0
comma
l_int|0
comma
l_int|1023
comma
l_int|1023
comma
l_int|200
comma
l_int|160
)paren
op_ne
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
l_string|&quot;w9966_setup() failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|w9966_pdev_release
c_func
(paren
id|cam
)paren
suffix:semicolon
singleline_comment|// Fill in the video_device struct and register us to v4l
id|memcpy
c_func
(paren
op_amp
id|cam-&gt;vdev
comma
op_amp
id|w9966_template
comma
r_sizeof
(paren
r_struct
id|video_device
)paren
)paren
suffix:semicolon
id|cam-&gt;vdev.priv
op_assign
(paren
r_void
op_star
)paren
id|cam
suffix:semicolon
r_if
c_cond
(paren
id|video_register_device
c_func
(paren
op_amp
id|cam-&gt;vdev
comma
id|VFL_TYPE_GRABBER
comma
id|video_nr
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_setState
c_func
(paren
id|cam
comma
id|W9966_STATE_VDEV
comma
id|W9966_STATE_VDEV
)paren
suffix:semicolon
singleline_comment|// All ok
id|printk
c_func
(paren
l_string|&quot;w9966cf: Found and initialized a webcam on %s.&bslash;n&quot;
comma
id|cam-&gt;pport-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Terminate everything gracefully
DECL|function|w9966_term
r_static
r_void
id|w9966_term
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
(brace
singleline_comment|// Unregister from v4l
r_if
c_cond
(paren
id|w9966_getState
c_func
(paren
id|cam
comma
id|W9966_STATE_VDEV
comma
id|W9966_STATE_VDEV
)paren
)paren
(brace
id|video_unregister_device
c_func
(paren
op_amp
id|cam-&gt;vdev
)paren
suffix:semicolon
id|w9966_setState
c_func
(paren
id|cam
comma
id|W9966_STATE_VDEV
comma
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|// Terminate from IEEE1284 mode and release pdev block
r_if
c_cond
(paren
id|w9966_getState
c_func
(paren
id|cam
comma
id|W9966_STATE_PDEV
comma
id|W9966_STATE_PDEV
)paren
)paren
(brace
id|w9966_pdev_claim
c_func
(paren
id|cam
)paren
suffix:semicolon
id|parport_negotiate
c_func
(paren
id|cam-&gt;pport
comma
id|IEEE1284_MODE_COMPAT
)paren
suffix:semicolon
id|w9966_pdev_release
c_func
(paren
id|cam
)paren
suffix:semicolon
)brace
singleline_comment|// Unregister from parport
r_if
c_cond
(paren
id|w9966_getState
c_func
(paren
id|cam
comma
id|W9966_STATE_PDEV
comma
id|W9966_STATE_PDEV
)paren
)paren
(brace
id|parport_unregister_device
c_func
(paren
id|cam-&gt;pdev
)paren
suffix:semicolon
id|w9966_setState
c_func
(paren
id|cam
comma
id|W9966_STATE_PDEV
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// Find a good length for capture window (used both for W and H)
singleline_comment|// A bit ugly but pretty functional. The capture length
singleline_comment|// have to match the downscale
DECL|function|w9966_findlen
r_static
r_int
id|w9966_findlen
c_func
(paren
r_int
id|near
comma
r_int
id|size
comma
r_int
id|maxlen
)paren
(brace
r_int
id|bestlen
op_assign
id|size
suffix:semicolon
r_int
id|besterr
op_assign
id|abs
c_func
(paren
id|near
op_minus
id|bestlen
)paren
suffix:semicolon
r_int
id|len
suffix:semicolon
r_for
c_loop
(paren
id|len
op_assign
id|size
op_plus
l_int|1
suffix:semicolon
id|len
OL
id|maxlen
suffix:semicolon
id|len
op_increment
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
l_int|64
op_star
id|size
)paren
op_mod
id|len
)paren
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
id|err
op_assign
id|abs
c_func
(paren
id|near
op_minus
id|len
)paren
suffix:semicolon
singleline_comment|// Only continue as long as we keep getting better values
r_if
c_cond
(paren
id|err
OG
id|besterr
)paren
r_break
suffix:semicolon
id|besterr
op_assign
id|err
suffix:semicolon
id|bestlen
op_assign
id|len
suffix:semicolon
)brace
r_return
id|bestlen
suffix:semicolon
)brace
singleline_comment|// Modify capture window (if necessary) 
singleline_comment|// and calculate downscaling
singleline_comment|// Return -1 on error
DECL|function|w9966_calcscale
r_static
r_int
id|w9966_calcscale
c_func
(paren
r_int
id|size
comma
r_int
id|min
comma
r_int
id|max
comma
r_int
op_star
id|beg
comma
r_int
op_star
id|end
comma
r_int
r_char
op_star
id|factor
)paren
(brace
r_int
id|maxlen
op_assign
id|max
op_minus
id|min
suffix:semicolon
r_int
id|len
op_assign
op_star
id|end
op_minus
op_star
id|beg
op_plus
l_int|1
suffix:semicolon
r_int
id|newlen
op_assign
id|w9966_findlen
c_func
(paren
id|len
comma
id|size
comma
id|maxlen
)paren
suffix:semicolon
r_int
id|err
op_assign
id|newlen
op_minus
id|len
suffix:semicolon
singleline_comment|// Check for bad format
r_if
c_cond
(paren
id|newlen
OG
id|maxlen
op_logical_or
id|newlen
OL
id|size
)paren
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// Set factor (6 bit fixed)
op_star
id|factor
op_assign
(paren
l_int|64
op_star
id|size
)paren
op_div
id|newlen
suffix:semicolon
r_if
c_cond
(paren
op_star
id|factor
op_eq
l_int|64
)paren
op_star
id|factor
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// downscale is disabled
r_else
op_star
id|factor
op_or_assign
l_int|0x80
suffix:semicolon
singleline_comment|// set downscale-enable bit
singleline_comment|// Modify old beginning and end
op_star
id|beg
op_sub_assign
id|err
op_div
l_int|2
suffix:semicolon
op_star
id|end
op_add_assign
id|err
op_minus
(paren
id|err
op_div
l_int|2
)paren
suffix:semicolon
singleline_comment|// Move window if outside borders
r_if
c_cond
(paren
op_star
id|beg
OL
id|min
)paren
(brace
op_star
id|end
op_add_assign
id|min
op_minus
op_star
id|beg
suffix:semicolon
op_star
id|beg
op_add_assign
id|min
op_minus
op_star
id|beg
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|end
OG
id|max
)paren
(brace
op_star
id|beg
op_sub_assign
op_star
id|end
op_minus
id|max
suffix:semicolon
op_star
id|end
op_sub_assign
op_star
id|end
op_minus
id|max
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Setup the cameras capture window etc.
singleline_comment|// Expects a claimed pdev
singleline_comment|// return -1 on error
DECL|function|w9966_setup
r_static
r_int
id|w9966_setup
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|x1
comma
r_int
id|y1
comma
r_int
id|x2
comma
r_int
id|y2
comma
r_int
id|w
comma
r_int
id|h
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_int
r_int
id|enh_s
comma
id|enh_e
suffix:semicolon
r_int
r_char
id|scale_x
comma
id|scale_y
suffix:semicolon
r_int
r_char
id|regs
(braket
l_int|0x1c
)braket
suffix:semicolon
r_int
r_char
id|saa7111_regs
(braket
)braket
op_assign
(brace
l_int|0x21
comma
l_int|0x00
comma
l_int|0xd8
comma
l_int|0x23
comma
l_int|0x00
comma
l_int|0x80
comma
l_int|0x80
comma
l_int|0x00
comma
l_int|0x88
comma
l_int|0x10
comma
l_int|0x80
comma
l_int|0x40
comma
l_int|0x40
comma
l_int|0x00
comma
l_int|0x01
comma
l_int|0x00
comma
l_int|0x48
comma
l_int|0x0c
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0x71
comma
l_int|0xe7
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xc0
)brace
suffix:semicolon
r_if
c_cond
(paren
id|w
op_star
id|h
op_star
l_int|2
OG
id|W9966_SRAMSIZE
)paren
(brace
id|DPRINTF
c_func
(paren
l_string|&quot;capture window exceeds SRAM size!.&bslash;n&quot;
)paren
suffix:semicolon
id|w
op_assign
l_int|200
suffix:semicolon
id|h
op_assign
l_int|160
suffix:semicolon
singleline_comment|// Pick default values
)brace
id|w
op_and_assign
op_complement
l_int|0x1
suffix:semicolon
r_if
c_cond
(paren
id|w
OL
l_int|2
)paren
id|w
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|h
OL
l_int|1
)paren
id|h
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|w
OG
id|W9966_WND_MAX_W
)paren
id|w
op_assign
id|W9966_WND_MAX_W
suffix:semicolon
r_if
c_cond
(paren
id|h
OG
id|W9966_WND_MAX_H
)paren
id|h
op_assign
id|W9966_WND_MAX_H
suffix:semicolon
id|cam-&gt;width
op_assign
id|w
suffix:semicolon
id|cam-&gt;height
op_assign
id|h
suffix:semicolon
id|enh_s
op_assign
l_int|0
suffix:semicolon
id|enh_e
op_assign
id|w
op_star
id|h
op_star
l_int|2
suffix:semicolon
singleline_comment|// Modify capture window if necessary and calculate downscaling
r_if
c_cond
(paren
id|w9966_calcscale
c_func
(paren
id|w
comma
id|W9966_WND_MIN_X
comma
id|W9966_WND_MAX_X
comma
op_amp
id|x1
comma
op_amp
id|x2
comma
op_amp
id|scale_x
)paren
op_ne
l_int|0
op_logical_or
id|w9966_calcscale
c_func
(paren
id|h
comma
id|W9966_WND_MIN_Y
comma
id|W9966_WND_MAX_Y
comma
op_amp
id|y1
comma
op_amp
id|y2
comma
op_amp
id|scale_y
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|DPRINTF
c_func
(paren
l_string|&quot;%dx%d, x: %d&lt;-&gt;%d, y: %d&lt;-&gt;%d, sx: %d/64, sy: %d/64.&bslash;n&quot;
comma
id|w
comma
id|h
comma
id|x1
comma
id|x2
comma
id|y1
comma
id|y2
comma
id|scale_x
op_amp
op_complement
l_int|0x80
comma
id|scale_y
op_amp
op_complement
l_int|0x80
)paren
suffix:semicolon
singleline_comment|// Setup registers
id|regs
(braket
l_int|0x00
)braket
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// Set normal operation
id|regs
(braket
l_int|0x01
)braket
op_assign
l_int|0x18
suffix:semicolon
singleline_comment|// Capture mode
id|regs
(braket
l_int|0x02
)braket
op_assign
id|scale_y
suffix:semicolon
singleline_comment|// V-scaling
id|regs
(braket
l_int|0x03
)braket
op_assign
id|scale_x
suffix:semicolon
singleline_comment|// H-scaling
singleline_comment|// Capture window&t;
id|regs
(braket
l_int|0x04
)braket
op_assign
(paren
id|x1
op_amp
l_int|0x0ff
)paren
suffix:semicolon
singleline_comment|// X-start (8 low bits)
id|regs
(braket
l_int|0x05
)braket
op_assign
(paren
id|x1
op_amp
l_int|0x300
)paren
op_rshift
l_int|8
suffix:semicolon
singleline_comment|// X-start (2 high bits)
id|regs
(braket
l_int|0x06
)braket
op_assign
(paren
id|y1
op_amp
l_int|0x0ff
)paren
suffix:semicolon
singleline_comment|// Y-start (8 low bits)
id|regs
(braket
l_int|0x07
)braket
op_assign
(paren
id|y1
op_amp
l_int|0x300
)paren
op_rshift
l_int|8
suffix:semicolon
singleline_comment|// Y-start (2 high bits)
id|regs
(braket
l_int|0x08
)braket
op_assign
(paren
id|x2
op_amp
l_int|0x0ff
)paren
suffix:semicolon
singleline_comment|// X-end (8 low bits)
id|regs
(braket
l_int|0x09
)braket
op_assign
(paren
id|x2
op_amp
l_int|0x300
)paren
op_rshift
l_int|8
suffix:semicolon
singleline_comment|// X-end (2 high bits)
id|regs
(braket
l_int|0x0a
)braket
op_assign
(paren
id|y2
op_amp
l_int|0x0ff
)paren
suffix:semicolon
singleline_comment|// Y-end (8 low bits)
id|regs
(braket
l_int|0x0c
)braket
op_assign
id|W9966_SRAMID
suffix:semicolon
singleline_comment|// SRAM-banks (1x 128kb)
singleline_comment|// Enhancement layer
id|regs
(braket
l_int|0x0d
)braket
op_assign
(paren
id|enh_s
op_amp
l_int|0x000ff
)paren
suffix:semicolon
singleline_comment|// Enh. start (0-7)
id|regs
(braket
l_int|0x0e
)braket
op_assign
(paren
id|enh_s
op_amp
l_int|0x0ff00
)paren
op_rshift
l_int|8
suffix:semicolon
singleline_comment|// Enh. start (8-15)
id|regs
(braket
l_int|0x0f
)braket
op_assign
(paren
id|enh_s
op_amp
l_int|0x70000
)paren
op_rshift
l_int|16
suffix:semicolon
singleline_comment|// Enh. start (16-17/18??)
id|regs
(braket
l_int|0x10
)braket
op_assign
(paren
id|enh_e
op_amp
l_int|0x000ff
)paren
suffix:semicolon
singleline_comment|// Enh. end (0-7)
id|regs
(braket
l_int|0x11
)braket
op_assign
(paren
id|enh_e
op_amp
l_int|0x0ff00
)paren
op_rshift
l_int|8
suffix:semicolon
singleline_comment|// Enh. end (8-15)
id|regs
(braket
l_int|0x12
)braket
op_assign
(paren
id|enh_e
op_amp
l_int|0x70000
)paren
op_rshift
l_int|16
suffix:semicolon
singleline_comment|// Enh. end (16-17/18??)
singleline_comment|// Misc
id|regs
(braket
l_int|0x13
)braket
op_assign
l_int|0x40
suffix:semicolon
singleline_comment|// VEE control (raw 4:2:2)
id|regs
(braket
l_int|0x17
)braket
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// ???
id|regs
(braket
l_int|0x18
)braket
op_assign
id|cam-&gt;i2c_state
op_assign
l_int|0x00
suffix:semicolon
singleline_comment|// Serial bus
id|regs
(braket
l_int|0x19
)braket
op_assign
l_int|0xff
suffix:semicolon
singleline_comment|// I/O port direction control
id|regs
(braket
l_int|0x1a
)braket
op_assign
l_int|0xff
suffix:semicolon
singleline_comment|// I/O port data register
id|regs
(braket
l_int|0x1b
)braket
op_assign
l_int|0x10
suffix:semicolon
singleline_comment|// ???
singleline_comment|// SAA7111 chip settings
id|saa7111_regs
(braket
l_int|0x0a
)braket
op_assign
id|cam-&gt;brightness
suffix:semicolon
id|saa7111_regs
(braket
l_int|0x0b
)braket
op_assign
id|cam-&gt;contrast
suffix:semicolon
id|saa7111_regs
(braket
l_int|0x0c
)braket
op_assign
id|cam-&gt;color
suffix:semicolon
id|saa7111_regs
(braket
l_int|0x0d
)braket
op_assign
id|cam-&gt;hue
suffix:semicolon
singleline_comment|// Reset (ECP-fifo &amp; serial-bus)
r_if
c_cond
(paren
id|w9966_wReg
c_func
(paren
id|cam
comma
l_int|0x00
comma
l_int|0x03
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// Write regs to w9966cf chip
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x1c
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|w9966_wReg
c_func
(paren
id|cam
comma
id|i
comma
id|regs
(braket
id|i
)braket
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
singleline_comment|// Write regs to saa7111 chip
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x20
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|w9966_wReg_i2c
c_func
(paren
id|cam
comma
id|i
comma
id|saa7111_regs
(braket
id|i
)braket
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Ugly and primitive i2c protocol functions&n; */
singleline_comment|// Sets the data line on the i2c bus.
singleline_comment|// Expects a claimed pdev.
DECL|function|w9966_i2c_setsda
r_static
r_inline
r_void
id|w9966_i2c_setsda
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
id|cam-&gt;i2c_state
op_or_assign
id|W9966_I2C_W_DATA
suffix:semicolon
r_else
id|cam-&gt;i2c_state
op_and_assign
op_complement
id|W9966_I2C_W_DATA
suffix:semicolon
id|w9966_wReg
c_func
(paren
id|cam
comma
l_int|0x18
comma
id|cam-&gt;i2c_state
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
singleline_comment|// Sets the clock line on the i2c bus.
singleline_comment|// Expects a claimed pdev. -1 on error
DECL|function|w9966_i2c_setscl
r_static
r_inline
r_int
id|w9966_i2c_setscl
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|state
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
r_if
c_cond
(paren
id|state
)paren
id|cam-&gt;i2c_state
op_or_assign
id|W9966_I2C_W_CLOCK
suffix:semicolon
r_else
id|cam-&gt;i2c_state
op_and_assign
op_complement
id|W9966_I2C_W_CLOCK
suffix:semicolon
id|w9966_wReg
c_func
(paren
id|cam
comma
l_int|0x18
comma
id|cam-&gt;i2c_state
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
singleline_comment|// we go to high, we also expect the peripheral to ack.
r_if
c_cond
(paren
id|state
)paren
(brace
id|timeout
op_assign
id|jiffies
op_plus
l_int|100
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|w9966_i2c_getscl
c_func
(paren
id|cam
)paren
)paren
(brace
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|timeout
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Get peripheral data line
singleline_comment|// Expects a claimed pdev.
DECL|function|w9966_i2c_getsda
r_static
r_inline
r_int
id|w9966_i2c_getsda
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
(brace
r_const
r_int
r_char
id|state
op_assign
id|w9966_rReg
c_func
(paren
id|cam
comma
l_int|0x18
)paren
suffix:semicolon
r_return
(paren
(paren
id|state
op_amp
id|W9966_I2C_R_DATA
)paren
OG
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|// Get peripheral clock line
singleline_comment|// Expects a claimed pdev.
DECL|function|w9966_i2c_getscl
r_static
r_inline
r_int
id|w9966_i2c_getscl
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
(brace
r_const
r_int
r_char
id|state
op_assign
id|w9966_rReg
c_func
(paren
id|cam
comma
l_int|0x18
)paren
suffix:semicolon
r_return
(paren
(paren
id|state
op_amp
id|W9966_I2C_R_CLOCK
)paren
OG
l_int|0
)paren
suffix:semicolon
)brace
singleline_comment|// Write a byte with ack to the i2c bus.
singleline_comment|// Expects a claimed pdev. -1 on error
DECL|function|w9966_i2c_wbyte
r_static
r_int
id|w9966_i2c_wbyte
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
(paren
id|data
op_rshift
id|i
)paren
op_amp
l_int|0x01
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|1
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
)brace
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|1
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Read a data byte with ack from the i2c-bus
singleline_comment|// Expects a claimed pdev. -1 on error
macro_line|#if 0
r_static
r_int
id|w9966_i2c_rbyte
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
)paren
(brace
r_int
r_char
id|data
op_assign
l_int|0x00
suffix:semicolon
r_int
id|i
suffix:semicolon
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|1
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|data
op_assign
id|data
op_lshift
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_getsda
c_func
(paren
id|cam
)paren
)paren
id|data
op_or_assign
l_int|0x01
suffix:semicolon
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|data
suffix:semicolon
)brace
macro_line|#endif
singleline_comment|// Read a register from the i2c device.
singleline_comment|// Expects claimed pdev. -1 on error
macro_line|#if 0
r_static
r_int
id|w9966_rReg_i2c
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|reg
)paren
(brace
r_int
id|data
suffix:semicolon
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_wbyte
c_func
(paren
id|cam
comma
id|W9966_I2C_W_ID
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|w9966_i2c_wbyte
c_func
(paren
id|cam
comma
id|reg
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|1
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_wbyte
c_func
(paren
id|cam
comma
id|W9966_I2C_R_ID
)paren
op_eq
op_minus
l_int|1
op_logical_or
(paren
id|data
op_assign
id|w9966_i2c_rbyte
c_func
(paren
id|cam
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|1
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|1
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
macro_line|#endif
singleline_comment|// Write a register to the i2c device.
singleline_comment|// Expects claimed pdev. -1 on error
DECL|function|w9966_wReg_i2c
r_static
r_int
id|w9966_wReg_i2c
c_func
(paren
r_struct
id|w9966_dev
op_star
id|cam
comma
r_int
id|reg
comma
r_int
id|data
)paren
(brace
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_wbyte
c_func
(paren
id|cam
comma
id|W9966_I2C_W_ID
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|w9966_i2c_wbyte
c_func
(paren
id|cam
comma
id|reg
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|w9966_i2c_wbyte
c_func
(paren
id|cam
comma
id|data
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_i2c_setscl
c_func
(paren
id|cam
comma
l_int|1
)paren
op_eq
op_minus
l_int|1
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|w9966_i2c_setsda
c_func
(paren
id|cam
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Video4linux interfacing&n; */
DECL|function|w9966_v4l_do_ioctl
r_static
r_int
id|w9966_v4l_do_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|video_device
op_star
id|vdev
op_assign
id|video_devdata
c_func
(paren
id|file
)paren
suffix:semicolon
r_struct
id|w9966_dev
op_star
id|cam
op_assign
(paren
r_struct
id|w9966_dev
op_star
)paren
id|vdev-&gt;priv
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|VIDIOCGCAP
suffix:colon
(brace
r_static
r_struct
id|video_capability
id|vcap
op_assign
(brace
dot
id|name
op_assign
id|W9966_DRIVERNAME
comma
dot
id|type
op_assign
id|VID_TYPE_CAPTURE
op_or
id|VID_TYPE_SCALES
comma
dot
id|channels
op_assign
l_int|1
comma
dot
id|maxwidth
op_assign
id|W9966_WND_MAX_W
comma
dot
id|maxheight
op_assign
id|W9966_WND_MAX_H
comma
dot
id|minwidth
op_assign
l_int|2
comma
dot
id|minheight
op_assign
l_int|1
comma
)brace
suffix:semicolon
r_struct
id|video_capability
op_star
id|cap
op_assign
id|arg
suffix:semicolon
op_star
id|cap
op_assign
id|vcap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGCHAN
suffix:colon
(brace
r_struct
id|video_channel
op_star
id|vch
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|vch-&gt;channel
op_ne
l_int|0
)paren
(brace
singleline_comment|// We only support one channel (#0)
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|vch
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|vch
)paren
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|vch-&gt;name
comma
l_string|&quot;CCD-input&quot;
)paren
suffix:semicolon
id|vch-&gt;type
op_assign
id|VIDEO_TYPE_CAMERA
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSCHAN
suffix:colon
(brace
r_struct
id|video_channel
op_star
id|vch
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|vch-&gt;channel
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGTUNER
suffix:colon
(brace
r_struct
id|video_tuner
op_star
id|vtune
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|vtune-&gt;tuner
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|vtune-&gt;name
comma
l_string|&quot;no tuner&quot;
)paren
suffix:semicolon
id|vtune-&gt;rangelow
op_assign
l_int|0
suffix:semicolon
id|vtune-&gt;rangehigh
op_assign
l_int|0
suffix:semicolon
id|vtune-&gt;flags
op_assign
id|VIDEO_TUNER_NORM
suffix:semicolon
id|vtune-&gt;mode
op_assign
id|VIDEO_MODE_AUTO
suffix:semicolon
id|vtune-&gt;signal
op_assign
l_int|0xffff
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSTUNER
suffix:colon
(brace
r_struct
id|video_tuner
op_star
id|vtune
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|vtune-&gt;tuner
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vtune-&gt;mode
op_ne
id|VIDEO_MODE_AUTO
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGPICT
suffix:colon
(brace
r_struct
id|video_picture
id|vpic
op_assign
(brace
id|cam-&gt;brightness
op_lshift
l_int|8
comma
singleline_comment|// brightness
(paren
id|cam-&gt;hue
op_plus
l_int|128
)paren
op_lshift
l_int|8
comma
singleline_comment|// hue
id|cam-&gt;color
op_lshift
l_int|9
comma
singleline_comment|// color
id|cam-&gt;contrast
op_lshift
l_int|9
comma
singleline_comment|// contrast
l_int|0x8000
comma
singleline_comment|// whiteness
l_int|16
comma
id|VIDEO_PALETTE_YUV422
singleline_comment|// bpp, palette format
)brace
suffix:semicolon
r_struct
id|video_picture
op_star
id|pic
op_assign
id|arg
suffix:semicolon
op_star
id|pic
op_assign
id|vpic
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSPICT
suffix:colon
(brace
r_struct
id|video_picture
op_star
id|vpic
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|vpic-&gt;depth
op_ne
l_int|16
op_logical_or
id|vpic-&gt;palette
op_ne
id|VIDEO_PALETTE_YUV422
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|cam-&gt;brightness
op_assign
id|vpic-&gt;brightness
op_rshift
l_int|8
suffix:semicolon
id|cam-&gt;hue
op_assign
(paren
id|vpic-&gt;hue
op_rshift
l_int|8
)paren
op_minus
l_int|128
suffix:semicolon
id|cam-&gt;color
op_assign
id|vpic-&gt;colour
op_rshift
l_int|9
suffix:semicolon
id|cam-&gt;contrast
op_assign
id|vpic-&gt;contrast
op_rshift
l_int|9
suffix:semicolon
id|w9966_pdev_claim
c_func
(paren
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
id|w9966_wReg_i2c
c_func
(paren
id|cam
comma
l_int|0x0a
comma
id|cam-&gt;brightness
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|w9966_wReg_i2c
c_func
(paren
id|cam
comma
l_int|0x0b
comma
id|cam-&gt;contrast
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|w9966_wReg_i2c
c_func
(paren
id|cam
comma
l_int|0x0c
comma
id|cam-&gt;color
)paren
op_eq
op_minus
l_int|1
op_logical_or
id|w9966_wReg_i2c
c_func
(paren
id|cam
comma
l_int|0x0d
comma
id|cam-&gt;hue
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|w9966_pdev_release
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|w9966_pdev_release
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCSWIN
suffix:colon
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|video_window
op_star
id|vwin
op_assign
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|vwin-&gt;flags
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vwin-&gt;clipcount
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vwin-&gt;width
template_param
id|W9966_WND_MAX_W
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vwin-&gt;height
template_param
id|W9966_WND_MAX_H
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
singleline_comment|// Update camera regs
id|w9966_pdev_claim
c_func
(paren
id|cam
)paren
suffix:semicolon
id|ret
op_assign
id|w9966_setup
c_func
(paren
id|cam
comma
l_int|0
comma
l_int|0
comma
l_int|1023
comma
l_int|1023
comma
id|vwin-&gt;width
comma
id|vwin-&gt;height
)paren
suffix:semicolon
id|w9966_pdev_release
c_func
(paren
id|cam
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|DPRINTF
c_func
(paren
l_string|&quot;VIDIOCSWIN: w9966_setup() failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|VIDIOCGWIN
suffix:colon
(brace
r_struct
id|video_window
op_star
id|vwin
op_assign
id|arg
suffix:semicolon
id|memset
c_func
(paren
id|vwin
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|vwin
)paren
)paren
suffix:semicolon
id|vwin-&gt;width
op_assign
id|cam-&gt;width
suffix:semicolon
id|vwin-&gt;height
op_assign
id|cam-&gt;height
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Unimplemented
r_case
id|VIDIOCCAPTURE
suffix:colon
r_case
id|VIDIOCGFBUF
suffix:colon
r_case
id|VIDIOCSFBUF
suffix:colon
r_case
id|VIDIOCKEY
suffix:colon
r_case
id|VIDIOCGFREQ
suffix:colon
r_case
id|VIDIOCSFREQ
suffix:colon
r_case
id|VIDIOCGAUDIO
suffix:colon
r_case
id|VIDIOCSAUDIO
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|w9966_v4l_ioctl
r_static
r_int
id|w9966_v4l_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
id|video_usercopy
c_func
(paren
id|inode
comma
id|file
comma
id|cmd
comma
id|arg
comma
id|w9966_v4l_do_ioctl
)paren
suffix:semicolon
)brace
singleline_comment|// Capture data
DECL|function|w9966_v4l_read
r_static
id|ssize_t
id|w9966_v4l_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|video_device
op_star
id|vdev
op_assign
id|video_devdata
c_func
(paren
id|file
)paren
suffix:semicolon
r_struct
id|w9966_dev
op_star
id|cam
op_assign
(paren
r_struct
id|w9966_dev
op_star
)paren
id|vdev-&gt;priv
suffix:semicolon
r_int
r_char
id|addr
op_assign
l_int|0xa0
suffix:semicolon
singleline_comment|// ECP, read, CCD-transfer, 00000
r_int
r_char
op_star
id|dest
op_assign
(paren
r_int
r_char
op_star
)paren
id|buf
suffix:semicolon
r_int
r_int
id|dleft
op_assign
id|count
suffix:semicolon
r_int
r_char
op_star
id|tbuf
suffix:semicolon
singleline_comment|// Why would anyone want more than this??
r_if
c_cond
(paren
id|count
OG
id|cam-&gt;width
op_star
id|cam-&gt;height
op_star
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|w9966_pdev_claim
c_func
(paren
id|cam
)paren
suffix:semicolon
id|w9966_wReg
c_func
(paren
id|cam
comma
l_int|0x00
comma
l_int|0x02
)paren
suffix:semicolon
singleline_comment|// Reset ECP-FIFO buffer
id|w9966_wReg
c_func
(paren
id|cam
comma
l_int|0x00
comma
l_int|0x00
)paren
suffix:semicolon
singleline_comment|// Return to normal operation
id|w9966_wReg
c_func
(paren
id|cam
comma
l_int|0x01
comma
l_int|0x98
)paren
suffix:semicolon
singleline_comment|// Enable capture
singleline_comment|// write special capture-addr and negotiate into data transfer&t;
r_if
c_cond
(paren
(paren
id|parport_negotiate
c_func
(paren
id|cam-&gt;pport
comma
id|cam-&gt;ppmode
op_or
id|IEEE1284_ADDR
)paren
op_ne
l_int|0
)paren
op_logical_or
(paren
id|parport_write
c_func
(paren
id|cam-&gt;pport
comma
op_amp
id|addr
comma
l_int|1
)paren
op_ne
l_int|1
)paren
op_logical_or
(paren
id|parport_negotiate
c_func
(paren
id|cam-&gt;pport
comma
id|cam-&gt;ppmode
op_or
id|IEEE1284_DATA
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|w9966_pdev_release
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|tbuf
op_assign
id|kmalloc
c_func
(paren
id|W9966_RBUFFER
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tbuf
op_eq
l_int|NULL
)paren
(brace
id|count
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_while
c_loop
(paren
id|dleft
OG
l_int|0
)paren
(brace
r_int
r_int
id|tsize
op_assign
(paren
id|dleft
OG
id|W9966_RBUFFER
)paren
ques
c_cond
id|W9966_RBUFFER
suffix:colon
id|dleft
suffix:semicolon
r_if
c_cond
(paren
id|parport_read
c_func
(paren
id|cam-&gt;pport
comma
id|tbuf
comma
id|tsize
)paren
OL
id|tsize
)paren
(brace
id|count
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|dest
comma
id|tbuf
comma
id|tsize
)paren
op_ne
l_int|0
)paren
(brace
id|count
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dest
op_add_assign
id|tsize
suffix:semicolon
id|dleft
op_sub_assign
id|tsize
suffix:semicolon
)brace
id|w9966_wReg
c_func
(paren
id|cam
comma
l_int|0x01
comma
l_int|0x18
)paren
suffix:semicolon
singleline_comment|// Disable capture
id|out
suffix:colon
id|kfree
c_func
(paren
id|tbuf
)paren
suffix:semicolon
id|w9966_pdev_release
c_func
(paren
id|cam
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
singleline_comment|// Called once for every parport on init
DECL|function|w9966_attach
r_static
r_void
id|w9966_attach
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|W9966_MAXCAMS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|w9966_cams
(braket
id|i
)braket
dot
id|dev_state
op_ne
l_int|0
)paren
singleline_comment|// Cam is already assigned
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|pardev
(braket
id|i
)braket
comma
l_string|&quot;aggressive&quot;
)paren
op_eq
l_int|0
op_logical_or
id|strcmp
c_func
(paren
id|pardev
(braket
id|i
)braket
comma
id|port-&gt;name
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|w9966_init
c_func
(paren
op_amp
id|w9966_cams
(braket
id|i
)braket
comma
id|port
)paren
op_ne
l_int|0
)paren
id|w9966_term
c_func
(paren
op_amp
id|w9966_cams
(braket
id|i
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// return
)brace
)brace
)brace
singleline_comment|// Called once for every parport on termination
DECL|function|w9966_detach
r_static
r_void
id|w9966_detach
c_func
(paren
r_struct
id|parport
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|W9966_MAXCAMS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|w9966_cams
(braket
id|i
)braket
dot
id|dev_state
op_ne
l_int|0
op_logical_and
id|w9966_cams
(braket
id|i
)braket
dot
id|pport
op_eq
id|port
)paren
id|w9966_term
c_func
(paren
op_amp
id|w9966_cams
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
DECL|variable|w9966_ppd
r_static
r_struct
id|parport_driver
id|w9966_ppd
op_assign
(brace
dot
id|name
op_assign
id|W9966_DRIVERNAME
comma
dot
id|attach
op_assign
id|w9966_attach
comma
dot
id|detach
op_assign
id|w9966_detach
comma
)brace
suffix:semicolon
singleline_comment|// Module entry point
DECL|function|w9966_mod_init
r_static
r_int
id|__init
id|w9966_mod_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|W9966_MAXCAMS
suffix:semicolon
id|i
op_increment
)paren
id|w9966_cams
(braket
id|i
)braket
dot
id|dev_state
op_assign
l_int|0
suffix:semicolon
r_return
id|parport_register_driver
c_func
(paren
op_amp
id|w9966_ppd
)paren
suffix:semicolon
)brace
singleline_comment|// Module cleanup
DECL|function|w9966_mod_term
r_static
r_void
id|__exit
id|w9966_mod_term
c_func
(paren
r_void
)paren
(brace
id|parport_unregister_driver
c_func
(paren
op_amp
id|w9966_ppd
)paren
suffix:semicolon
)brace
DECL|variable|w9966_mod_init
id|module_init
c_func
(paren
id|w9966_mod_init
)paren
suffix:semicolon
DECL|variable|w9966_mod_term
id|module_exit
c_func
(paren
id|w9966_mod_term
)paren
suffix:semicolon
eof
