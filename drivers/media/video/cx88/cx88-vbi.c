multiline_comment|/*&n; * $Id: cx88-vbi.c,v 1.14 2004/11/07 13:17:15 kraxel Exp $&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &quot;cx88.h&quot;
DECL|variable|vbibufs
r_static
r_int
r_int
id|vbibufs
op_assign
l_int|4
suffix:semicolon
id|module_param
c_func
(paren
id|vbibufs
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|vbibufs
comma
l_string|&quot;number of vbi buffers, range 2-32&quot;
)paren
suffix:semicolon
DECL|variable|vbi_debug
r_static
r_int
r_int
id|vbi_debug
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|vbi_debug
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|vbi_debug
comma
l_string|&quot;enable debug messages [vbi]&quot;
)paren
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(level,fmt, arg...)&t;if (vbi_debug &gt;= level) &bslash;&n;&t;printk(KERN_DEBUG &quot;%s: &quot; fmt, dev-&gt;core-&gt;name , ## arg)
multiline_comment|/* ------------------------------------------------------------------ */
DECL|function|cx8800_vbi_fmt
r_void
id|cx8800_vbi_fmt
c_func
(paren
r_struct
id|cx8800_dev
op_star
id|dev
comma
r_struct
id|v4l2_format
op_star
id|f
)paren
(brace
id|memset
c_func
(paren
op_amp
id|f-&gt;fmt.vbi
comma
l_int|0
comma
r_sizeof
(paren
id|f-&gt;fmt.vbi
)paren
)paren
suffix:semicolon
id|f-&gt;fmt.vbi.samples_per_line
op_assign
id|VBI_LINE_LENGTH
suffix:semicolon
id|f-&gt;fmt.vbi.sample_format
op_assign
id|V4L2_PIX_FMT_GREY
suffix:semicolon
id|f-&gt;fmt.vbi.offset
op_assign
l_int|244
suffix:semicolon
id|f-&gt;fmt.vbi.count
(braket
l_int|0
)braket
op_assign
id|VBI_LINE_COUNT
suffix:semicolon
id|f-&gt;fmt.vbi.count
(braket
l_int|1
)braket
op_assign
id|VBI_LINE_COUNT
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;core-&gt;tvnorm-&gt;id
op_amp
id|V4L2_STD_525_60
)paren
(brace
multiline_comment|/* ntsc */
id|f-&gt;fmt.vbi.sampling_rate
op_assign
l_int|28636363
suffix:semicolon
id|f-&gt;fmt.vbi.start
(braket
l_int|0
)braket
op_assign
l_int|10
op_minus
l_int|1
suffix:semicolon
id|f-&gt;fmt.vbi.start
(braket
l_int|1
)braket
op_assign
l_int|273
op_minus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;core-&gt;tvnorm-&gt;id
op_amp
id|V4L2_STD_625_50
)paren
(brace
multiline_comment|/* pal */
id|f-&gt;fmt.vbi.sampling_rate
op_assign
l_int|35468950
suffix:semicolon
id|f-&gt;fmt.vbi.start
(braket
l_int|0
)braket
op_assign
l_int|7
op_minus
l_int|1
suffix:semicolon
id|f-&gt;fmt.vbi.start
(braket
l_int|1
)braket
op_assign
l_int|319
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|cx8800_start_vbi_dma
r_int
id|cx8800_start_vbi_dma
c_func
(paren
r_struct
id|cx8800_dev
op_star
id|dev
comma
r_struct
id|cx88_dmaqueue
op_star
id|q
comma
r_struct
id|cx88_buffer
op_star
id|buf
)paren
(brace
r_struct
id|cx88_core
op_star
id|core
op_assign
id|dev-&gt;core
suffix:semicolon
multiline_comment|/* setup fifo + format */
id|cx88_sram_channel_setup
c_func
(paren
id|dev-&gt;core
comma
op_amp
id|cx88_sram_channels
(braket
id|SRAM_CH24
)braket
comma
id|buf-&gt;vb.width
comma
id|buf-&gt;risc.dma
)paren
suffix:semicolon
id|cx_write
c_func
(paren
id|MO_VBOS_CONTROL
comma
(paren
(paren
l_int|1
op_lshift
l_int|18
)paren
op_or
singleline_comment|// comb filter delay fixup
(paren
l_int|1
op_lshift
l_int|15
)paren
op_or
singleline_comment|// enable vbi capture
(paren
l_int|1
op_lshift
l_int|11
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* reset counter */
id|cx_write
c_func
(paren
id|MO_VBI_GPCNTRL
comma
id|GP_COUNT_CONTROL_RESET
)paren
suffix:semicolon
id|q-&gt;count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* enable irqs */
id|cx_set
c_func
(paren
id|MO_PCI_INTMSK
comma
l_int|0x00fc01
)paren
suffix:semicolon
id|cx_set
c_func
(paren
id|MO_VID_INTMSK
comma
l_int|0x0f0088
)paren
suffix:semicolon
multiline_comment|/* enable capture */
id|cx_set
c_func
(paren
id|VID_CAPTURE_CONTROL
comma
l_int|0x18
)paren
suffix:semicolon
multiline_comment|/* start dma */
id|cx_set
c_func
(paren
id|MO_DEV_CNTRL2
comma
(paren
l_int|1
op_lshift
l_int|5
)paren
)paren
suffix:semicolon
id|cx_set
c_func
(paren
id|MO_VID_DMACNTRL
comma
l_int|0x88
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cx8800_stop_vbi_dma
r_int
id|cx8800_stop_vbi_dma
c_func
(paren
r_struct
id|cx8800_dev
op_star
id|dev
)paren
(brace
r_struct
id|cx88_core
op_star
id|core
op_assign
id|dev-&gt;core
suffix:semicolon
multiline_comment|/* stop dma */
id|cx_clear
c_func
(paren
id|MO_VID_DMACNTRL
comma
l_int|0x88
)paren
suffix:semicolon
multiline_comment|/* disable capture */
id|cx_clear
c_func
(paren
id|VID_CAPTURE_CONTROL
comma
l_int|0x18
)paren
suffix:semicolon
multiline_comment|/* disable irqs */
id|cx_clear
c_func
(paren
id|MO_PCI_INTMSK
comma
l_int|0x000001
)paren
suffix:semicolon
id|cx_clear
c_func
(paren
id|MO_VID_INTMSK
comma
l_int|0x0f0088
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cx8800_restart_vbi_queue
r_int
id|cx8800_restart_vbi_queue
c_func
(paren
r_struct
id|cx8800_dev
op_star
id|dev
comma
r_struct
id|cx88_dmaqueue
op_star
id|q
)paren
(brace
r_struct
id|cx88_buffer
op_star
id|buf
suffix:semicolon
r_struct
id|list_head
op_star
id|item
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|q-&gt;active
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|buf
op_assign
id|list_entry
c_func
(paren
id|q-&gt;active.next
comma
r_struct
id|cx88_buffer
comma
id|vb.queue
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;restart_queue [%p/%d]: restart dma&bslash;n&quot;
comma
id|buf
comma
id|buf-&gt;vb.i
)paren
suffix:semicolon
id|cx8800_start_vbi_dma
c_func
(paren
id|dev
comma
id|q
comma
id|buf
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|item
comma
op_amp
id|q-&gt;active
)paren
(brace
id|buf
op_assign
id|list_entry
c_func
(paren
id|item
comma
r_struct
id|cx88_buffer
comma
id|vb.queue
)paren
suffix:semicolon
id|buf-&gt;count
op_assign
id|q-&gt;count
op_increment
suffix:semicolon
)brace
id|mod_timer
c_func
(paren
op_amp
id|q-&gt;timeout
comma
id|jiffies
op_plus
id|BUFFER_TIMEOUT
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cx8800_vbi_timeout
r_void
id|cx8800_vbi_timeout
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|cx8800_dev
op_star
id|dev
op_assign
(paren
r_struct
id|cx8800_dev
op_star
)paren
id|data
suffix:semicolon
r_struct
id|cx88_core
op_star
id|core
op_assign
id|dev-&gt;core
suffix:semicolon
r_struct
id|cx88_dmaqueue
op_star
id|q
op_assign
op_amp
id|dev-&gt;vbiq
suffix:semicolon
r_struct
id|cx88_buffer
op_star
id|buf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|cx88_sram_channel_dump
c_func
(paren
id|dev-&gt;core
comma
op_amp
id|cx88_sram_channels
(braket
id|SRAM_CH24
)braket
)paren
suffix:semicolon
id|cx_clear
c_func
(paren
id|MO_VID_DMACNTRL
comma
l_int|0x88
)paren
suffix:semicolon
id|cx_clear
c_func
(paren
id|VID_CAPTURE_CONTROL
comma
l_int|0x18
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|q-&gt;active
)paren
)paren
(brace
id|buf
op_assign
id|list_entry
c_func
(paren
id|q-&gt;active.next
comma
r_struct
id|cx88_buffer
comma
id|vb.queue
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|buf-&gt;vb.queue
)paren
suffix:semicolon
id|buf-&gt;vb.state
op_assign
id|STATE_ERROR
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|buf-&gt;vb.done
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s/0: [%p/%d] timeout - dma=0x%08lx&bslash;n&quot;
comma
id|dev-&gt;core-&gt;name
comma
id|buf
comma
id|buf-&gt;vb.i
comma
(paren
r_int
r_int
)paren
id|buf-&gt;risc.dma
)paren
suffix:semicolon
)brace
id|cx8800_restart_vbi_queue
c_func
(paren
id|dev
comma
id|q
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dev-&gt;slock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------ */
r_static
r_int
DECL|function|vbi_setup
id|vbi_setup
c_func
(paren
r_struct
id|videobuf_queue
op_star
id|q
comma
r_int
r_int
op_star
id|count
comma
r_int
r_int
op_star
id|size
)paren
(brace
op_star
id|size
op_assign
id|VBI_LINE_COUNT
op_star
id|VBI_LINE_LENGTH
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
op_star
id|count
)paren
op_star
id|count
op_assign
id|vbibufs
suffix:semicolon
r_if
c_cond
(paren
op_star
id|count
OL
l_int|2
)paren
op_star
id|count
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_star
id|count
OG
l_int|32
)paren
op_star
id|count
op_assign
l_int|32
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|vbi_prepare
id|vbi_prepare
c_func
(paren
r_struct
id|videobuf_queue
op_star
id|q
comma
r_struct
id|videobuf_buffer
op_star
id|vb
comma
r_enum
id|v4l2_field
id|field
)paren
(brace
r_struct
id|cx8800_fh
op_star
id|fh
op_assign
id|q-&gt;priv_data
suffix:semicolon
r_struct
id|cx8800_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|cx88_buffer
op_star
id|buf
op_assign
id|container_of
c_func
(paren
id|vb
comma
r_struct
id|cx88_buffer
comma
id|vb
)paren
suffix:semicolon
r_int
r_int
id|size
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|size
op_assign
id|VBI_LINE_COUNT
op_star
id|VBI_LINE_LENGTH
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|buf-&gt;vb.baddr
op_logical_and
id|buf-&gt;vb.bsize
OL
id|size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|STATE_NEEDS_INIT
op_eq
id|buf-&gt;vb.state
)paren
(brace
id|buf-&gt;vb.width
op_assign
id|VBI_LINE_LENGTH
suffix:semicolon
id|buf-&gt;vb.height
op_assign
id|VBI_LINE_COUNT
suffix:semicolon
id|buf-&gt;vb.size
op_assign
id|size
suffix:semicolon
id|buf-&gt;vb.field
op_assign
id|V4L2_FIELD_SEQ_TB
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
(paren
id|rc
op_assign
id|videobuf_iolock
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;vb
comma
l_int|NULL
)paren
)paren
)paren
r_goto
id|fail
suffix:semicolon
id|cx88_risc_buffer
c_func
(paren
id|dev-&gt;pci
comma
op_amp
id|buf-&gt;risc
comma
id|buf-&gt;vb.dma.sglist
comma
l_int|0
comma
id|buf-&gt;vb.width
op_star
id|buf-&gt;vb.height
comma
id|buf-&gt;vb.width
comma
l_int|0
comma
id|buf-&gt;vb.height
)paren
suffix:semicolon
)brace
id|buf-&gt;vb.state
op_assign
id|STATE_PREPARED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|cx88_free_buffer
c_func
(paren
id|dev-&gt;pci
comma
id|buf
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_void
DECL|function|vbi_queue
id|vbi_queue
c_func
(paren
r_struct
id|videobuf_queue
op_star
id|vq
comma
r_struct
id|videobuf_buffer
op_star
id|vb
)paren
(brace
r_struct
id|cx88_buffer
op_star
id|buf
op_assign
id|container_of
c_func
(paren
id|vb
comma
r_struct
id|cx88_buffer
comma
id|vb
)paren
suffix:semicolon
r_struct
id|cx88_buffer
op_star
id|prev
suffix:semicolon
r_struct
id|cx8800_fh
op_star
id|fh
op_assign
id|vq-&gt;priv_data
suffix:semicolon
r_struct
id|cx8800_dev
op_star
id|dev
op_assign
id|fh-&gt;dev
suffix:semicolon
r_struct
id|cx88_dmaqueue
op_star
id|q
op_assign
op_amp
id|dev-&gt;vbiq
suffix:semicolon
multiline_comment|/* add jump to stopper */
id|buf-&gt;risc.jmp
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|RISC_JUMP
op_or
id|RISC_IRQ1
op_or
id|RISC_CNT_INC
)paren
suffix:semicolon
id|buf-&gt;risc.jmp
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|q-&gt;stopper.dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|q-&gt;active
)paren
)paren
(brace
id|list_add_tail
c_func
(paren
op_amp
id|buf-&gt;vb.queue
comma
op_amp
id|q-&gt;active
)paren
suffix:semicolon
id|cx8800_start_vbi_dma
c_func
(paren
id|dev
comma
id|q
comma
id|buf
)paren
suffix:semicolon
id|buf-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
id|buf-&gt;count
op_assign
id|q-&gt;count
op_increment
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|q-&gt;timeout
comma
id|jiffies
op_plus
id|BUFFER_TIMEOUT
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;[%p/%d] vbi_queue - first active&bslash;n&quot;
comma
id|buf
comma
id|buf-&gt;vb.i
)paren
suffix:semicolon
)brace
r_else
(brace
id|prev
op_assign
id|list_entry
c_func
(paren
id|q-&gt;active.prev
comma
r_struct
id|cx88_buffer
comma
id|vb.queue
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|buf-&gt;vb.queue
comma
op_amp
id|q-&gt;active
)paren
suffix:semicolon
id|buf-&gt;vb.state
op_assign
id|STATE_ACTIVE
suffix:semicolon
id|buf-&gt;count
op_assign
id|q-&gt;count
op_increment
suffix:semicolon
id|prev-&gt;risc.jmp
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|buf-&gt;risc.dma
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_int|2
comma
l_string|&quot;[%p/%d] buffer_queue - append to active&bslash;n&quot;
comma
id|buf
comma
id|buf-&gt;vb.i
)paren
suffix:semicolon
)brace
)brace
DECL|function|vbi_release
r_static
r_void
id|vbi_release
c_func
(paren
r_struct
id|videobuf_queue
op_star
id|q
comma
r_struct
id|videobuf_buffer
op_star
id|vb
)paren
(brace
r_struct
id|cx88_buffer
op_star
id|buf
op_assign
id|container_of
c_func
(paren
id|vb
comma
r_struct
id|cx88_buffer
comma
id|vb
)paren
suffix:semicolon
r_struct
id|cx8800_fh
op_star
id|fh
op_assign
id|q-&gt;priv_data
suffix:semicolon
id|cx88_free_buffer
c_func
(paren
id|fh-&gt;dev-&gt;pci
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|variable|cx8800_vbi_qops
r_struct
id|videobuf_queue_ops
id|cx8800_vbi_qops
op_assign
(brace
dot
id|buf_setup
op_assign
id|vbi_setup
comma
dot
id|buf_prepare
op_assign
id|vbi_prepare
comma
dot
id|buf_queue
op_assign
id|vbi_queue
comma
dot
id|buf_release
op_assign
id|vbi_release
comma
)brace
suffix:semicolon
multiline_comment|/* ------------------------------------------------------------------ */
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
