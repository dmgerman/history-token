multiline_comment|/*&n; *  Many thanks to Fred Seidel &lt;seidel@metabox.de&gt;, the&n; *  designer of the RDS decoder hardware. With his help&n; *  I was able to code this driver.&n; *  Thanks also to Norberto Pellicci, Dominic Mounteney&n; *  &lt;DMounteney@pinnaclesys.com&gt; and www.teleauskunft.de&n; *  for good hints on finding Fred. It was somewhat hard&n; *  to locate him here in Germany... [:&n; *&n; * Revision history:&n; *&n; *   2000-08-09  Robert Siemer &lt;Robert.Siemer@gmx.de&gt;&n; *        RDS support for MiroSound PCM20 radio&n; */
DECL|macro|_NO_VERSION_
mdefine_line|#define _NO_VERSION_
multiline_comment|/* #include &lt;linux/kernel.h&gt; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;../../sound/aci.h&quot;
macro_line|#include &quot;miropcm20-rds-core.h&quot;
DECL|macro|DEBUG
mdefine_line|#define DEBUG 0
DECL|variable|aci_rds_sem
r_static
r_struct
id|semaphore
id|aci_rds_sem
suffix:semicolon
DECL|macro|RDS_DATASHIFT
mdefine_line|#define RDS_DATASHIFT          2   /* Bit 2 */
DECL|macro|RDS_DATAMASK
mdefine_line|#define RDS_DATAMASK        (1 &lt;&lt; RDS_DATASHIFT)
DECL|macro|RDS_BUSYMASK
mdefine_line|#define RDS_BUSYMASK        0x10   /* Bit 4 */
DECL|macro|RDS_CLOCKMASK
mdefine_line|#define RDS_CLOCKMASK       0x08   /* Bit 3 */
DECL|macro|RDS_DATA
mdefine_line|#define RDS_DATA(x)         (((x) &gt;&gt; RDS_DATASHIFT) &amp; 1) 
macro_line|#if DEBUG
DECL|function|print_matrix
r_static
r_void
id|print_matrix
c_func
(paren
r_char
id|array
(braket
)braket
comma
r_int
r_int
id|length
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aci-rds: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|7
suffix:semicolon
id|j
op_ge
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d&quot;
comma
(paren
id|array
(braket
id|i
)braket
op_rshift
id|j
)paren
op_amp
l_int|0x1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_mod
l_int|8
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot; byte-border&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* DEBUG */
DECL|function|byte2trans
r_static
r_int
id|byte2trans
c_func
(paren
r_int
r_char
id|byte
comma
r_int
r_char
id|sendbuffer
(braket
)braket
comma
r_int
id|size
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ne
l_int|8
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|sendbuffer
(braket
l_int|7
op_minus
id|i
)braket
op_assign
(paren
id|byte
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
ques
c_cond
id|RDS_DATAMASK
suffix:colon
l_int|0
suffix:semicolon
id|sendbuffer
(braket
l_int|0
)braket
op_or_assign
id|RDS_CLOCKMASK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rds_waitread
r_static
r_int
id|rds_waitread
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|byte
suffix:semicolon
r_int
id|i
op_assign
l_int|2000
suffix:semicolon
r_do
(brace
id|byte
op_assign
id|inb
c_func
(paren
id|RDS_REGISTER
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|byte
op_amp
id|RDS_BUSYMASK
)paren
op_logical_and
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;rds_waitread()&quot;
)paren
suffix:semicolon
id|print_matrix
c_func
(paren
op_amp
id|byte
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
r_return
(paren
id|byte
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;aci-rds: rds_waitread() timeout...&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* dont use any ..._nowait() function if you are not sure what you do... */
DECL|function|rds_rawwrite_nowait
r_static
r_inline
r_void
id|rds_rawwrite_nowait
c_func
(paren
r_int
r_char
id|byte
)paren
(brace
macro_line|#if DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;rds_rawwrite()&quot;
)paren
suffix:semicolon
id|print_matrix
c_func
(paren
op_amp
id|byte
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
id|byte
comma
id|RDS_REGISTER
)paren
suffix:semicolon
)brace
DECL|function|rds_rawwrite
r_static
r_int
id|rds_rawwrite
c_func
(paren
r_int
r_char
id|byte
)paren
(brace
r_if
c_cond
(paren
id|rds_waitread
c_func
(paren
)paren
op_ge
l_int|0
)paren
(brace
id|rds_rawwrite_nowait
c_func
(paren
id|byte
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|rds_write
r_static
r_int
id|rds_write
c_func
(paren
r_int
r_char
id|cmd
)paren
(brace
r_int
r_char
id|sendbuffer
(braket
l_int|8
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|byte2trans
c_func
(paren
id|cmd
comma
id|sendbuffer
comma
l_int|8
)paren
op_ne
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rds_rawwrite
c_func
(paren
id|sendbuffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rds_readcycle_nowait
r_static
r_int
id|rds_readcycle_nowait
c_func
(paren
r_void
)paren
(brace
id|rds_rawwrite_nowait
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
id|rds_waitread
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|rds_readcycle
r_static
r_int
id|rds_readcycle
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|rds_rawwrite
c_func
(paren
l_int|0
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
id|rds_waitread
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|rds_read
r_static
r_int
id|rds_read
c_func
(paren
r_int
r_char
id|databuffer
(braket
)braket
comma
r_int
id|datasize
)paren
(brace
DECL|macro|READSIZE
mdefine_line|#define READSIZE (8*datasize)
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|datasize
OL
l_int|1
)paren
multiline_comment|/* nothing to read */
r_return
l_int|0
suffix:semicolon
multiline_comment|/* to be able to use rds_readcycle_nowait()&n;&t;   I have to waitread() here */
r_if
c_cond
(paren
id|rds_waitread
c_func
(paren
)paren
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|databuffer
comma
l_int|0
comma
id|datasize
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|READSIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|j
op_assign
id|rds_readcycle_nowait
c_func
(paren
)paren
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|databuffer
(braket
id|i
op_div
l_int|8
)braket
op_or_assign
(paren
id|RDS_DATA
c_func
(paren
id|j
)paren
op_lshift
(paren
l_int|7
op_minus
(paren
id|i
op_mod
l_int|8
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rds_ack
r_static
r_int
id|rds_ack
c_func
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
id|rds_readcycle
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|RDS_DATAMASK
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* ACK  */
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;aci-rds: NACK&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* NACK */
)brace
)brace
DECL|function|aci_rds_cmd
r_int
id|aci_rds_cmd
c_func
(paren
r_int
r_char
id|cmd
comma
r_int
r_char
id|databuffer
(braket
)braket
comma
r_int
id|datasize
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|aci_rds_sem
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
id|rds_write
c_func
(paren
id|cmd
)paren
suffix:semicolon
multiline_comment|/* RDS_RESET doesn&squot;t need further processing */
r_if
c_cond
(paren
id|cmd
op_ne
id|RDS_RESET
op_logical_and
(paren
id|rds_ack
c_func
(paren
)paren
op_logical_or
id|rds_read
c_func
(paren
id|databuffer
comma
id|datasize
)paren
)paren
)paren
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
id|ret
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|aci_rds_sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|aci_rds_cmd
id|EXPORT_SYMBOL
c_func
(paren
id|aci_rds_cmd
)paren
suffix:semicolon
DECL|function|attach_aci_rds
r_int
id|__init
id|attach_aci_rds
c_func
(paren
r_void
)paren
(brace
id|init_MUTEX
c_func
(paren
op_amp
id|aci_rds_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unload_aci_rds
r_void
id|__exit
id|unload_aci_rds
c_func
(paren
r_void
)paren
(brace
)brace
eof
