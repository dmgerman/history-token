multiline_comment|/*&n; **********************************************************************&n; *     joystick.c - Creative EMU10K1 Joystick port driver&n; *     Copyright 2000 Rui Sousa.&n; *&n; **********************************************************************&n; *&n; *     Date                 Author          Summary of changes&n; *     ----                 ------          ------------------&n; *     April  1, 2000       Rui Sousa       initial version &n; *     April 28, 2000       Rui Sousa       fixed a kernel oops,&n; *&t;&t;&t;&t;&t;    make use of kcompat24 for&n; *&t;&t;&t;&t;&t;    2.2 kernels compatibility.&n; *     May    1, 2000       Rui Sousa       improved kernel compatibility&n; *                                          layer.&n; *&n; **********************************************************************&n; *&n; *     This program is free software; you can redistribute it and/or&n; *     modify it under the terms of the GNU General Public License as&n; *     published by the Free Software Foundation; either version 2 of&n; *     the License, or (at your option) any later version.&n; *&n; *     This program is distributed in the hope that it will be useful,&n; *     but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *     GNU General Public License for more details.&n; *&n; *     You should have received a copy of the GNU General Public&n; *     License along with this program; if not, write to the Free&n; *     Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139,&n; *     USA.&n; *&n; **********************************************************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/list.h&gt;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;0.3.1&quot;
macro_line|#ifndef PCI_VENDOR_ID_CREATIVE
DECL|macro|PCI_VENDOR_ID_CREATIVE
mdefine_line|#define PCI_VENDOR_ID_CREATIVE 0x1102
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_CREATIVE_EMU10K1_JOYSTICK
DECL|macro|PCI_DEVICE_ID_CREATIVE_EMU10K1_JOYSTICK
mdefine_line|#define PCI_DEVICE_ID_CREATIVE_EMU10K1_JOYSTICK 0x7002
macro_line|#endif
multiline_comment|/* PCI function 1 registers, address = &lt;val&gt; + PCIBASE1 */
DECL|macro|JOYSTICK1
mdefine_line|#define JOYSTICK1               0x00            /* Analog joystick port register                */
DECL|macro|JOYSTICK2
mdefine_line|#define JOYSTICK2               0x01            /* Analog joystick port register                */
DECL|macro|JOYSTICK3
mdefine_line|#define JOYSTICK3               0x02            /* Analog joystick port register                */
DECL|macro|JOYSTICK4
mdefine_line|#define JOYSTICK4               0x03            /* Analog joystick port register                */
DECL|macro|JOYSTICK5
mdefine_line|#define JOYSTICK5               0x04            /* Analog joystick port register                */
DECL|macro|JOYSTICK6
mdefine_line|#define JOYSTICK6               0x05            /* Analog joystick port register                */
DECL|macro|JOYSTICK7
mdefine_line|#define JOYSTICK7               0x06            /* Analog joystick port register                */
DECL|macro|JOYSTICK8
mdefine_line|#define JOYSTICK8               0x07            /* Analog joystick port register                */
multiline_comment|/* When writing, any write causes JOYSTICK_COMPARATOR output enable to be pulsed on write.      */
multiline_comment|/* When reading, use these bitfields: */
DECL|macro|JOYSTICK_BUTTONS
mdefine_line|#define JOYSTICK_BUTTONS        0x0f            /* Joystick button data                         */
DECL|macro|JOYSTICK_COMPARATOR
mdefine_line|#define JOYSTICK_COMPARATOR     0xf0            /* Joystick comparator data                     */
DECL|macro|NR_DEV
mdefine_line|#define NR_DEV 5
DECL|variable|io
r_static
r_int
id|io
(braket
id|NR_DEV
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|EMU10K1_JOYSTICK
id|EMU10K1_JOYSTICK
op_assign
l_int|0
)brace
suffix:semicolon
DECL|variable|card_names
r_static
r_char
op_star
id|card_names
(braket
)braket
op_assign
(brace
l_string|&quot;EMU10K1 Joystick Port&quot;
)brace
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|emu10k1_joy_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_VENDOR_ID_CREATIVE
comma
id|PCI_DEVICE_ID_CREATIVE_EMU10K1_JOYSTICK
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
id|EMU10K1_JOYSTICK
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|emu10k1_joy_pci_tbl
)paren
suffix:semicolon
DECL|struct|emu10k1_joy_card
r_struct
id|emu10k1_joy_card
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
DECL|member|iobase
r_int
r_int
id|iobase
suffix:semicolon
DECL|member|length
r_int
r_int
id|length
suffix:semicolon
DECL|member|addr_changed
id|u8
id|addr_changed
suffix:semicolon
)brace
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|emu10k1_joy_devs
)paren
suffix:semicolon
DECL|variable|devindex
r_static
r_int
r_int
id|devindex
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Driver initialization routine */
DECL|function|emu10k1_joy_probe
r_static
r_int
id|__devinit
id|emu10k1_joy_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pci_id
)paren
(brace
r_struct
id|emu10k1_joy_card
op_star
id|card
suffix:semicolon
id|u16
id|model
suffix:semicolon
id|u8
id|chiprev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|emu10k1_joy_card
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;emu10k1-joy: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|emu10k1_joy_card
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;emu10k1-joy: couldn&squot;t enable device&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|card-&gt;iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
suffix:semicolon
id|card-&gt;length
op_assign
id|pci_resource_len
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_region
c_func
(paren
id|card-&gt;iobase
comma
id|card-&gt;length
comma
id|card_names
(braket
id|pci_id-&gt;driver_data
)braket
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;emu10k1-joy: IO space in use&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
id|card
)paren
suffix:semicolon
id|card-&gt;pci_dev
op_assign
id|pci_dev
suffix:semicolon
id|card-&gt;addr_changed
op_assign
l_int|0
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pci_dev
comma
id|PCI_REVISION_ID
comma
op_amp
id|chiprev
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|pci_dev
comma
id|PCI_SUBSYSTEM_ID
comma
op_amp
id|model
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;emu10k1-joy: %s rev %d model 0x%x found, IO at 0x%04lx-0x%04lx&bslash;n&quot;
comma
id|card_names
(braket
id|pci_id-&gt;driver_data
)braket
comma
id|chiprev
comma
id|model
comma
id|card-&gt;iobase
comma
id|card-&gt;iobase
op_plus
id|card-&gt;length
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io
(braket
id|devindex
)braket
)paren
(brace
r_if
c_cond
(paren
(paren
id|io
(braket
id|devindex
)braket
op_amp
op_complement
l_int|0x18
)paren
op_ne
l_int|0x200
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;emu10k1-joy: invalid io value&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|card-&gt;iobase
comma
id|card-&gt;length
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|card-&gt;addr_changed
op_assign
l_int|1
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_BASE_ADDRESS_0
comma
id|io
(braket
id|devindex
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;emu10k1-joy: IO ports mirrored at 0x%03x&bslash;n&quot;
comma
id|io
(braket
id|devindex
)braket
)paren
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|card-&gt;list
comma
op_amp
id|emu10k1_joy_devs
)paren
suffix:semicolon
id|devindex
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|emu10k1_joy_remove
r_static
r_void
id|__devexit
id|emu10k1_joy_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|emu10k1_joy_card
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;addr_changed
)paren
(brace
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_BASE_ADDRESS_0
comma
id|card-&gt;iobase
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|card-&gt;iobase
comma
id|card-&gt;length
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|card-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|MODULE_PARM
c_func
(paren
id|io
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|NR_DEV
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|io
comma
l_string|&quot;sets joystick port address&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Rui Sousa (Email to: emu10k1-devel@opensource.creative.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Creative EMU10K1 PCI Joystick Port v&quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;nCopyright (C) 2000 Rui Sousa&quot;
)paren
suffix:semicolon
DECL|variable|emu10k1_joy_pci_driver
r_static
r_struct
id|pci_driver
id|emu10k1_joy_pci_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;emu10k1 joystick&quot;
comma
id|id_table
suffix:colon
id|emu10k1_joy_pci_tbl
comma
id|probe
suffix:colon
id|emu10k1_joy_probe
comma
id|remove
suffix:colon
id|emu10k1_joy_remove
comma
)brace
suffix:semicolon
DECL|function|emu10k1_joy_init_module
r_static
r_int
id|__init
id|emu10k1_joy_init_module
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Creative EMU10K1 PCI Joystick Port, version &quot;
id|DRIVER_VERSION
l_string|&quot;, &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|emu10k1_joy_pci_driver
)paren
suffix:semicolon
)brace
DECL|function|emu10k1_joy_cleanup_module
r_static
r_void
id|__exit
id|emu10k1_joy_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|emu10k1_joy_pci_driver
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|emu10k1_joy_init_module
id|module_init
c_func
(paren
id|emu10k1_joy_init_module
)paren
suffix:semicolon
DECL|variable|emu10k1_joy_cleanup_module
id|module_exit
c_func
(paren
id|emu10k1_joy_cleanup_module
)paren
suffix:semicolon
eof
