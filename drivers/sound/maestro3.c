multiline_comment|/*****************************************************************************&n; *&n; *      ESS Maestro3/Allegro driver for Linux 2.4.x&n; *&n; *      This program is free software; you can redistribute it and/or modify&n; *      it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *      This program is distributed in the hope that it will be useful,&n; *      but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *      GNU General Public License for more details.&n; *&n; *      You should have received a copy of the GNU General Public License&n; *      along with this program; if not, write to the Free Software&n; *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *    (c) Copyright 2000 Zach Brown &lt;zab@zabbo.net&gt;&n; *&n; * I need to thank many people for helping make this driver happen.  &n; * As always, Eric Brombaugh was a hacking machine and killed many bugs&n; * that I was too dumb to notice.  Howard Kim at ESS provided reference boards &n; * and as much docs as he could.  Todd and Mick at Dell tested snapshots on &n; * an army of laptops.  msw and deviant at Red Hat also humoured me by hanging&n; * their laptops every few hours in the name of science.&n; * &n; * Shouts go out to Mike &quot;DJ XPCom&quot; Ang.&n; *&n; * History&n; *  v1.22 - Feb 28 2001 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   allocate mem at insmod/setup, rather than open&n; *   limit pci dma addresses to 28bit, thanks guys.&n; *  v1.21 - Feb 04 2001 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   fix up really dumb notifier -&gt; suspend oops&n; *  v1.20 - Jan 30 2001 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   get rid of pm callback and use pci_dev suspend/resume instead&n; *   m3_probe cleanups, including pm oops think-o&n; *  v1.10 - Jan 6 2001 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   revert to lame remap_page_range mmap() just to make it work&n; *   record mmap fixed.&n; *   fix up incredibly broken open/release resource management&n; *   duh.  fix record format setting.&n; *   add SMP locking and cleanup formatting here and there&n; *  v1.00 - Dec 16 2000 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   port to sexy 2.4 interfaces&n; *   properly align instance allocations so recording works&n; *   clean up function namespace a little :/&n; *   update PCI IDs based on mail from ESS&n; *   arbitrarily bump version number to show its 2.4 now, &n; *      2.2 will stay 0., oss_audio port gets 2.&n; *  v0.03 - Nov 05 2000 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   disable recording but allow dsp to be opened read &n; *   pull out most silly compat defines&n; *  v0.02 - Nov 04 2000 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   changed clocking setup for m3, slowdown fixed.&n; *   codec reset is hopefully reliable now&n; *   rudimentary apm/power management makes suspend/resume work&n; *  v0.01 - Oct 31 2000 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   first release&n; *  v0.00 - Sep 09 2000 - Zach Brown &lt;zab@zabbo.net&gt;&n; *   first pass derivation from maestro.c&n; *&n; * TODO&n; *  in/out allocated contiguously so fullduplex mmap will work?&n; *  no beep on init (mute)&n; *  resetup msrc data memory if freq changes?&n; *&n; *  --&n; *&n; *  Allow me to ramble a bit about the m3 architecture.  The core of the&n; *  chip is the &squot;assp&squot;, the custom ESS dsp that runs the show.  It has&n; *  a small amount of code and data ram.  ESS drops binary dsp code images&n; *  on our heads, but we don&squot;t get to see specs on the dsp.  &n; *&n; *  The constant piece of code on the dsp is the &squot;kernel&squot;.  It also has a &n; *  chunk of the dsp memory that is statically set aside for its control&n; *  info.  This is the KDATA defines in maestro3.h.  Part of its core&n; *  data is a list of code addresses that point to the pieces of DSP code&n; *  that it should walk through in its loop.  These other pieces of code&n; *  do the real work.  The kernel presumably jumps into each of them in turn.&n; *  These code images tend to have their own data area, and one can have&n; *  multiple data areas representing different states for each of the &squot;client&n; *  instance&squot; code portions.  There is generally a list in the kernel data&n; *  that points to the data instances for a given piece of code.&n; *&n; *  We&squot;ve only been given the binary image for the &squot;minisrc&squot;, mini sample &n; *  rate converter.  This is rather annoying because it limits the work&n; *  we can do on the dsp, but it also greatly simplifies the job of managing&n; *  dsp data memory for the code and data for our playing streams :).  We&n; *  statically allocate the minisrc code into a region we &squot;know&squot; to be free&n; *  based on the map of the binary kernel image we&squot;re loading.  We also &n; *  statically allocate the data areas for the maximum number of pcm streams&n; *  we can be dealing with.  This max is set by the length of the static list&n; *  in the kernel data that records the number of minisrc data regions we&n; *  can have.  Thats right, all software dsp mixing with static code list&n; *  limits.  Rock.&n; *&n; *  How sound goes in and out is still a relative mystery.  It appears&n; *  that the dsp has the ability to get input and output through various&n; *  &squot;connections&squot;.  To do IO from or to a connection, you put the address&n; *  of the minisrc client area in the static kernel data lists for that &n; *  input or output.  so for pcm -&gt; dsp -&gt; mixer, we put the minisrc data&n; *  instance in the DMA list and also in the list for the mixer.  I guess&n; *  it Just Knows which is in/out, and we give some dma control info that&n; *  helps.  There are all sorts of cool inputs/outputs that it seems we can&squot;t&n; *  use without dsp code images that know how to use them.&n; *&n; *  So at init time we preload all the memory allocation stuff and set some&n; *  system wide parameters.  When we really get a sound to play we build&n; *  up its minisrc header (stream parameters, buffer addresses, input/output&n; *  settings).  Then we throw its header on the various lists.  We also&n; *  tickle some KDATA settings that ask the assp to raise clock interrupts&n; *  and do some amount of software mixing before handing data to the ac97.&n; *&n; *  Sorry for the vague details.  Feel free to ask Eric or myself if you&n; *  happen to be trying to use this driver elsewhere.  Please accept my&n; *  apologies for the quality of the OSS support code, its passed through&n; *  too many hands now and desperately wants to be rethought.&n; */
multiline_comment|/*****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sound.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/soundcard.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/hardirq.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/ac97_codec.h&gt;
multiline_comment|/*&n;  * for crizappy mmap()&n;  */
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &quot;maestro3.h&quot;
DECL|macro|M_DEBUG
mdefine_line|#define M_DEBUG 1
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION      &quot;1.22&quot;
DECL|macro|M3_MODULE_NAME
mdefine_line|#define M3_MODULE_NAME      &quot;maestro3&quot;
DECL|macro|PFX
mdefine_line|#define PFX                 M3_MODULE_NAME &quot;: &quot;
DECL|macro|M3_STATE_MAGIC
mdefine_line|#define M3_STATE_MAGIC      0x734d724d
DECL|macro|M3_CARD_MAGIC
mdefine_line|#define M3_CARD_MAGIC       0x646e6f50
DECL|macro|ESS_FMT_STEREO
mdefine_line|#define ESS_FMT_STEREO      0x01
DECL|macro|ESS_FMT_16BIT
mdefine_line|#define ESS_FMT_16BIT       0x02
DECL|macro|ESS_FMT_MASK
mdefine_line|#define ESS_FMT_MASK        0x03
DECL|macro|ESS_DAC_SHIFT
mdefine_line|#define ESS_DAC_SHIFT       0   
DECL|macro|ESS_ADC_SHIFT
mdefine_line|#define ESS_ADC_SHIFT       4
DECL|macro|DAC_RUNNING
mdefine_line|#define DAC_RUNNING         1
DECL|macro|ADC_RUNNING
mdefine_line|#define ADC_RUNNING         2
DECL|macro|SND_DEV_DSP16
mdefine_line|#define SND_DEV_DSP16       5 
macro_line|#ifdef M_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
DECL|macro|DPMOD
mdefine_line|#define DPMOD   1   /* per module load */
DECL|macro|DPSTR
mdefine_line|#define DPSTR   2   /* per &squot;stream&squot; */
DECL|macro|DPSYS
mdefine_line|#define DPSYS   3   /* per syscall */
DECL|macro|DPCRAP
mdefine_line|#define DPCRAP  4   /* stuff the user shouldn&squot;t see unless they&squot;re really debuggin */
DECL|macro|DPINT
mdefine_line|#define DPINT   5   /* per interrupt, LOTS */
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(DP, args...) {if (debug &gt;= (DP)) printk(KERN_DEBUG PFX args);}
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(x)
macro_line|#endif
DECL|struct|m3_list
r_struct
id|m3_list
(brace
DECL|member|curlen
r_int
id|curlen
suffix:semicolon
DECL|member|mem_addr
id|u16
id|mem_addr
suffix:semicolon
DECL|member|max
r_int
id|max
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|external_amp
r_int
id|external_amp
op_assign
l_int|1
suffix:semicolon
DECL|struct|m3_state
r_struct
id|m3_state
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|card
r_struct
id|m3_card
op_star
id|card
suffix:semicolon
DECL|member|fmt
DECL|member|enable
r_int
r_char
id|fmt
comma
id|enable
suffix:semicolon
DECL|member|index
r_int
id|index
suffix:semicolon
multiline_comment|/* this locks around the oss state in the driver */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|open_sem
r_struct
id|semaphore
id|open_sem
suffix:semicolon
DECL|member|open_wait
id|wait_queue_head_t
id|open_wait
suffix:semicolon
DECL|member|open_mode
id|mode_t
id|open_mode
suffix:semicolon
DECL|member|dev_audio
r_int
id|dev_audio
suffix:semicolon
DECL|struct|assp_instance
r_struct
id|assp_instance
(brace
DECL|member|code
DECL|member|data
id|u16
id|code
comma
id|data
suffix:semicolon
DECL|member|dac_inst
DECL|member|adc_inst
)brace
id|dac_inst
comma
id|adc_inst
suffix:semicolon
multiline_comment|/* should be in dmabuf */
DECL|member|rateadc
DECL|member|ratedac
r_int
r_int
id|rateadc
comma
id|ratedac
suffix:semicolon
DECL|struct|dmabuf
r_struct
id|dmabuf
(brace
DECL|member|rawbuf
r_void
op_star
id|rawbuf
suffix:semicolon
DECL|member|buforder
r_int
id|buforder
suffix:semicolon
DECL|member|numfrag
r_int
id|numfrag
suffix:semicolon
DECL|member|fragshift
r_int
id|fragshift
suffix:semicolon
DECL|member|hwptr
DECL|member|swptr
r_int
id|hwptr
comma
id|swptr
suffix:semicolon
DECL|member|total_bytes
r_int
id|total_bytes
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|error
r_int
id|error
suffix:semicolon
multiline_comment|/* over/underrun */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
multiline_comment|/* redundant, but makes calculations easier */
DECL|member|fragsize
r_int
id|fragsize
suffix:semicolon
DECL|member|dmasize
r_int
id|dmasize
suffix:semicolon
DECL|member|fragsamples
r_int
id|fragsamples
suffix:semicolon
multiline_comment|/* OSS stuff */
DECL|member|mapped
r_int
id|mapped
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ready
r_int
id|ready
suffix:colon
l_int|1
suffix:semicolon
DECL|member|endcleared
r_int
id|endcleared
suffix:colon
l_int|1
suffix:semicolon
DECL|member|ossfragshift
r_int
id|ossfragshift
suffix:semicolon
DECL|member|ossmaxfrags
r_int
id|ossmaxfrags
suffix:semicolon
DECL|member|subdivision
r_int
id|subdivision
suffix:semicolon
multiline_comment|/* new in m3 */
DECL|member|mixer_index
DECL|member|dma_index
DECL|member|msrc_index
DECL|member|adc1_index
r_int
id|mixer_index
comma
id|dma_index
comma
id|msrc_index
comma
id|adc1_index
suffix:semicolon
DECL|member|in_lists
r_int
id|in_lists
suffix:semicolon
multiline_comment|/* 2.4.. */
DECL|member|handle
id|dma_addr_t
id|handle
suffix:semicolon
DECL|member|dma_dac
DECL|member|dma_adc
)brace
id|dma_dac
comma
id|dma_adc
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|m3_card
r_struct
id|m3_card
(brace
DECL|member|magic
r_int
r_int
id|magic
suffix:semicolon
DECL|member|next
r_struct
id|m3_card
op_star
id|next
suffix:semicolon
DECL|member|ac97
r_struct
id|ac97_codec
op_star
id|ac97
suffix:semicolon
DECL|member|ac97_lock
id|spinlock_t
id|ac97_lock
suffix:semicolon
DECL|member|card_type
r_int
id|card_type
suffix:semicolon
DECL|macro|NR_DSPS
mdefine_line|#define NR_DSPS 1
DECL|macro|MAX_DSPS
mdefine_line|#define MAX_DSPS NR_DSPS
DECL|member|channels
r_struct
id|m3_state
id|channels
(braket
id|MAX_DSPS
)braket
suffix:semicolon
multiline_comment|/* this locks around the physical registers on the card */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* hardware resources */
DECL|member|pcidev
r_struct
id|pci_dev
op_star
id|pcidev
suffix:semicolon
DECL|member|iobase
id|u32
id|iobase
suffix:semicolon
DECL|member|irq
id|u32
id|irq
suffix:semicolon
DECL|member|dacs_active
r_int
id|dacs_active
suffix:semicolon
DECL|member|timer_users
r_int
id|timer_users
suffix:semicolon
DECL|member|msrc_list
r_struct
id|m3_list
id|msrc_list
comma
DECL|member|mixer_list
id|mixer_list
comma
DECL|member|adc1_list
id|adc1_list
comma
DECL|member|dma_list
id|dma_list
suffix:semicolon
multiline_comment|/* for storing reset state..*/
DECL|member|reset_state
id|u8
id|reset_state
suffix:semicolon
DECL|member|suspend_mem
id|u16
op_star
id|suspend_mem
suffix:semicolon
DECL|member|in_suspend
r_int
id|in_suspend
suffix:semicolon
DECL|member|suspend_queue
id|wait_queue_head_t
id|suspend_queue
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * an arbitrary volume we set the internal&n; * volume settings to so that the ac97 volume&n; * range is a little less insane.  0x7fff is &n; * max.&n; */
DECL|macro|ARB_VOLUME
mdefine_line|#define ARB_VOLUME ( 0x6800 )
DECL|variable|sample_shift
r_static
r_const
r_int
id|sample_shift
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|1
comma
l_int|2
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|ESS_ALLEGRO
id|ESS_ALLEGRO
comma
DECL|enumerator|ESS_MAESTRO3
id|ESS_MAESTRO3
comma
multiline_comment|/*&n;     * a maestro3 with &squot;hardware strapping&squot;, only&n;     * found inside ESS?&n;     */
DECL|enumerator|ESS_MAESTRO3HW
id|ESS_MAESTRO3HW
comma
)brace
suffix:semicolon
DECL|variable|card_names
r_static
r_char
op_star
id|card_names
(braket
)braket
op_assign
(brace
(braket
id|ESS_ALLEGRO
)braket
op_assign
l_string|&quot;Allegro&quot;
comma
(braket
id|ESS_MAESTRO3
)braket
op_assign
l_string|&quot;Maestro3(i)&quot;
comma
(braket
id|ESS_MAESTRO3HW
)braket
op_assign
l_string|&quot;Maestro3(i)hw&quot;
)brace
suffix:semicolon
macro_line|#ifndef PCI_VENDOR_ESS
DECL|macro|PCI_VENDOR_ESS
mdefine_line|#define PCI_VENDOR_ESS      0x125D
macro_line|#endif
DECL|macro|M3_DEVICE
mdefine_line|#define M3_DEVICE(DEV, TYPE)                &bslash;&n;{                                           &bslash;&n;vendor: PCI_VENDOR_ESS,                     &bslash;&n;device: DEV,                                &bslash;&n;subvendor: PCI_ANY_ID,                      &bslash;&n;subdevice: PCI_ANY_ID,                      &bslash;&n;class:  PCI_CLASS_MULTIMEDIA_AUDIO &lt;&lt; 8,    &bslash;&n;class_mask: 0xffff &lt;&lt; 8,                    &bslash;&n;driver_data: TYPE,                          &bslash;&n;}
DECL|variable|__initdata
r_static
r_struct
id|pci_device_id
id|m3_id_table
(braket
)braket
id|__initdata
op_assign
(brace
id|M3_DEVICE
c_func
(paren
l_int|0x1988
comma
id|ESS_ALLEGRO
)paren
comma
id|M3_DEVICE
c_func
(paren
l_int|0x1998
comma
id|ESS_MAESTRO3
)paren
comma
id|M3_DEVICE
c_func
(paren
l_int|0x199a
comma
id|ESS_MAESTRO3HW
)paren
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|m3_id_table
)paren
suffix:semicolon
multiline_comment|/*&n; * reports seem to indicate that the m3 is limited&n; * to 28bit bus addresses.  aaaargggh...&n; */
DECL|macro|M3_PCI_DMA_MASK
mdefine_line|#define M3_PCI_DMA_MASK 0x0fffffff
r_static
r_int
DECL|function|ld2
id|ld2
c_func
(paren
r_int
r_int
id|x
)paren
(brace
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|x
op_ge
l_int|0x10000
)paren
(brace
id|x
op_rshift_assign
l_int|16
suffix:semicolon
id|r
op_add_assign
l_int|16
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|0x100
)paren
(brace
id|x
op_rshift_assign
l_int|8
suffix:semicolon
id|r
op_add_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|0x10
)paren
(brace
id|x
op_rshift_assign
l_int|4
suffix:semicolon
id|r
op_add_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|4
)paren
(brace
id|x
op_rshift_assign
l_int|2
suffix:semicolon
id|r
op_add_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|x
op_ge
l_int|2
)paren
id|r
op_increment
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|variable|devs
r_static
r_struct
id|m3_card
op_star
id|devs
suffix:semicolon
multiline_comment|/*&n; * I&squot;m not very good at laying out functions in a file :)&n; */
r_static
r_int
id|m3_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|event
comma
r_void
op_star
id|buf
)paren
suffix:semicolon
r_static
r_int
id|m3_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
id|u32
id|state
)paren
suffix:semicolon
r_static
r_void
id|check_suspend
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
suffix:semicolon
DECL|variable|m3_reboot_nb
r_struct
id|notifier_block
id|m3_reboot_nb
op_assign
(brace
id|m3_notifier
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
DECL|function|m3_outw
r_static
r_void
id|m3_outw
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
id|u16
id|value
comma
r_int
r_int
id|reg
)paren
(brace
id|check_suspend
c_func
(paren
id|card
)paren
suffix:semicolon
id|outw
c_func
(paren
id|value
comma
id|card-&gt;iobase
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|m3_inw
r_static
id|u16
id|m3_inw
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_int
r_int
id|reg
)paren
(brace
id|check_suspend
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|inw
c_func
(paren
id|card-&gt;iobase
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|m3_outb
r_static
r_void
id|m3_outb
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
id|u8
id|value
comma
r_int
r_int
id|reg
)paren
(brace
id|check_suspend
c_func
(paren
id|card
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|card-&gt;iobase
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|m3_inb
r_static
id|u8
id|m3_inb
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_int
r_int
id|reg
)paren
(brace
id|check_suspend
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|card-&gt;iobase
op_plus
id|reg
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * access 16bit words to the code or data regions of the dsp&squot;s memory.&n; * index addresses 16bit words.&n; */
DECL|function|__m3_assp_read
r_static
id|u16
id|__m3_assp_read
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
id|u16
id|region
comma
id|u16
id|index
)paren
(brace
id|m3_outw
c_func
(paren
id|card
comma
id|region
op_amp
id|MEMTYPE_MASK
comma
id|DSP_PORT_MEMORY_TYPE
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
id|index
comma
id|DSP_PORT_MEMORY_INDEX
)paren
suffix:semicolon
r_return
id|m3_inw
c_func
(paren
id|card
comma
id|DSP_PORT_MEMORY_DATA
)paren
suffix:semicolon
)brace
DECL|function|m3_assp_read
r_static
id|u16
id|m3_assp_read
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
id|u16
id|region
comma
id|u16
id|index
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|ret
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|card-&gt;lock
)paren
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
id|__m3_assp_read
c_func
(paren
id|card
comma
id|region
comma
id|index
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|card-&gt;lock
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__m3_assp_write
r_static
r_void
id|__m3_assp_write
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
id|u16
id|region
comma
id|u16
id|index
comma
id|u16
id|data
)paren
(brace
id|m3_outw
c_func
(paren
id|card
comma
id|region
op_amp
id|MEMTYPE_MASK
comma
id|DSP_PORT_MEMORY_TYPE
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
id|index
comma
id|DSP_PORT_MEMORY_INDEX
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
id|data
comma
id|DSP_PORT_MEMORY_DATA
)paren
suffix:semicolon
)brace
DECL|function|m3_assp_write
r_static
r_void
id|m3_assp_write
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
id|u16
id|region
comma
id|u16
id|index
comma
id|u16
id|data
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
(paren
id|card-&gt;lock
)paren
comma
id|flags
)paren
suffix:semicolon
id|__m3_assp_write
c_func
(paren
id|card
comma
id|region
comma
id|index
comma
id|data
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
(paren
id|card-&gt;lock
)paren
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|m3_assp_halt
r_static
r_void
id|m3_assp_halt
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
id|card-&gt;reset_state
op_assign
id|m3_inb
c_func
(paren
id|card
comma
id|DSP_PORT_CONTROL_REG_B
)paren
op_amp
op_complement
id|REGB_STOP_CLOCK
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|m3_outb
c_func
(paren
id|card
comma
id|card-&gt;reset_state
op_amp
op_complement
id|REGB_ENABLE_RESET
comma
id|DSP_PORT_CONTROL_REG_B
)paren
suffix:semicolon
)brace
DECL|function|m3_assp_continue
r_static
r_void
id|m3_assp_continue
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
id|m3_outb
c_func
(paren
id|card
comma
id|card-&gt;reset_state
op_or
id|REGB_ENABLE_RESET
comma
id|DSP_PORT_CONTROL_REG_B
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This makes me sad. the maestro3 has lists&n; * internally that must be packed.. 0 terminates,&n; * apparently, or maybe all unused entries have&n; * to be 0, the lists have static lengths set&n; * by the binary code images.&n; */
DECL|function|m3_add_list
r_static
r_int
id|m3_add_list
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_struct
id|m3_list
op_star
id|list
comma
id|u16
id|val
)paren
(brace
id|DPRINTK
c_func
(paren
id|DPSTR
comma
l_string|&quot;adding val 0x%x to list 0x%p at pos %d&bslash;n&quot;
comma
id|val
comma
id|list
comma
id|list-&gt;curlen
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|list-&gt;mem_addr
op_plus
id|list-&gt;curlen
comma
id|val
)paren
suffix:semicolon
r_return
id|list-&gt;curlen
op_increment
suffix:semicolon
)brace
DECL|function|m3_remove_list
r_static
r_void
id|m3_remove_list
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_struct
id|m3_list
op_star
id|list
comma
r_int
id|index
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
id|lastindex
op_assign
id|list-&gt;curlen
op_minus
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSTR
comma
l_string|&quot;removing ind %d from list 0x%p&bslash;n&quot;
comma
id|index
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|index
op_ne
id|lastindex
)paren
(brace
id|val
op_assign
id|m3_assp_read
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|list-&gt;mem_addr
op_plus
id|lastindex
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|list-&gt;mem_addr
op_plus
id|index
comma
id|val
)paren
suffix:semicolon
)brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|list-&gt;mem_addr
op_plus
id|lastindex
comma
l_int|0
)paren
suffix:semicolon
id|list-&gt;curlen
op_decrement
suffix:semicolon
)brace
DECL|function|set_fmt
r_static
r_void
id|set_fmt
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
r_char
id|mask
comma
r_int
r_char
id|data
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|s-&gt;fmt
op_assign
(paren
id|s-&gt;fmt
op_amp
id|mask
)paren
op_or
id|data
suffix:semicolon
id|tmp
op_assign
(paren
id|s-&gt;fmt
op_rshift
id|ESS_DAC_SHIFT
)paren
op_amp
id|ESS_FMT_MASK
suffix:semicolon
multiline_comment|/* write to &squot;mono&squot; word */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|1
comma
(paren
id|tmp
op_amp
id|ESS_FMT_STEREO
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
multiline_comment|/* write to &squot;8bit&squot; word */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|2
comma
(paren
id|tmp
op_amp
id|ESS_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|s-&gt;fmt
op_rshift
id|ESS_ADC_SHIFT
)paren
op_amp
id|ESS_FMT_MASK
suffix:semicolon
multiline_comment|/* write to &squot;mono&squot; word */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|1
comma
(paren
id|tmp
op_amp
id|ESS_FMT_STEREO
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
multiline_comment|/* write to &squot;8bit&squot; word */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|2
comma
(paren
id|tmp
op_amp
id|ESS_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|set_dac_rate
r_static
r_void
id|set_dac_rate
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
r_int
id|rate
)paren
(brace
id|u32
id|freq
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|8000
)paren
id|rate
op_assign
l_int|8000
suffix:semicolon
id|s-&gt;ratedac
op_assign
id|rate
suffix:semicolon
id|freq
op_assign
(paren
(paren
id|rate
op_lshift
l_int|15
)paren
op_plus
l_int|24000
)paren
op_div
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|freq
)paren
(brace
id|freq
op_decrement
suffix:semicolon
)brace
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_FREQUENCY
comma
id|freq
)paren
suffix:semicolon
)brace
DECL|function|set_adc_rate
r_static
r_void
id|set_adc_rate
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
r_int
id|rate
)paren
(brace
id|u32
id|freq
suffix:semicolon
r_if
c_cond
(paren
id|rate
OG
l_int|48000
)paren
id|rate
op_assign
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|rate
OL
l_int|8000
)paren
id|rate
op_assign
l_int|8000
suffix:semicolon
id|s-&gt;rateadc
op_assign
id|rate
suffix:semicolon
id|freq
op_assign
(paren
(paren
id|rate
op_lshift
l_int|15
)paren
op_plus
l_int|24000
)paren
op_div
l_int|48000
suffix:semicolon
r_if
c_cond
(paren
id|freq
)paren
(brace
id|freq
op_decrement
suffix:semicolon
)brace
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_FREQUENCY
comma
id|freq
)paren
suffix:semicolon
)brace
DECL|function|inc_timer_users
r_static
r_void
id|inc_timer_users
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|card-&gt;timer_users
op_increment
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSYS
comma
l_string|&quot;inc timer users now %d&bslash;n&quot;
comma
id|card-&gt;timer_users
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;timer_users
op_ne
l_int|1
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|__m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_TIMER_COUNT_RELOAD
comma
l_int|240
)paren
suffix:semicolon
id|__m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_TIMER_COUNT_CURRENT
comma
l_int|240
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
id|m3_inw
c_func
(paren
id|card
comma
id|HOST_INT_CTRL
)paren
op_or
id|CLKRUN_GEN_ENABLE
comma
id|HOST_INT_CTRL
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|dec_timer_users
r_static
r_void
id|dec_timer_users
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|card-&gt;timer_users
op_decrement
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSYS
comma
l_string|&quot;dec timer users now %d&bslash;n&quot;
comma
id|card-&gt;timer_users
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;timer_users
OG
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|__m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_TIMER_COUNT_RELOAD
comma
l_int|0
)paren
suffix:semicolon
id|__m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_TIMER_COUNT_CURRENT
comma
l_int|0
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
id|m3_inw
c_func
(paren
id|card
comma
id|HOST_INT_CTRL
)paren
op_amp
op_complement
id|CLKRUN_GEN_ENABLE
comma
id|HOST_INT_CTRL
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * {start,stop}_{adc,dac} should be called&n; * while holding the &squot;state&squot; lock and they&n; * will try to grab the &squot;card&squot; lock..&n; */
DECL|function|stop_adc
r_static
r_void
id|stop_adc
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;enable
op_amp
id|ADC_RUNNING
)paren
)paren
r_return
suffix:semicolon
id|s-&gt;enable
op_and_assign
op_complement
id|ADC_RUNNING
suffix:semicolon
id|dec_timer_users
c_func
(paren
id|s-&gt;card
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_INSTANCE_READY
comma
l_int|0
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_ADC1_REQUEST
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|stop_dac
r_static
r_void
id|stop_dac
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;enable
op_amp
id|DAC_RUNNING
)paren
)paren
r_return
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSYS
comma
l_string|&quot;stop_dac()&bslash;n&quot;
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_INSTANCE_READY
comma
l_int|0
)paren
suffix:semicolon
id|s-&gt;enable
op_and_assign
op_complement
id|DAC_RUNNING
suffix:semicolon
id|s-&gt;card-&gt;dacs_active
op_decrement
suffix:semicolon
id|dec_timer_users
c_func
(paren
id|s-&gt;card
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_MIXER_TASK_NUMBER
comma
id|s-&gt;card-&gt;dacs_active
)paren
suffix:semicolon
)brace
DECL|function|start_dac
r_static
r_void
id|start_dac
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|s-&gt;dma_dac.mapped
op_logical_and
id|s-&gt;dma_dac.count
OL
l_int|1
)paren
op_logical_or
op_logical_neg
id|s-&gt;dma_dac.ready
op_logical_or
(paren
id|s-&gt;enable
op_amp
id|DAC_RUNNING
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
id|DPSYS
comma
l_string|&quot;start_dac()&bslash;n&quot;
)paren
suffix:semicolon
id|s-&gt;enable
op_or_assign
id|DAC_RUNNING
suffix:semicolon
id|s-&gt;card-&gt;dacs_active
op_increment
suffix:semicolon
id|inc_timer_users
c_func
(paren
id|s-&gt;card
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_INSTANCE_READY
comma
l_int|1
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_MIXER_TASK_NUMBER
comma
id|s-&gt;card-&gt;dacs_active
)paren
suffix:semicolon
)brace
DECL|function|start_adc
r_static
r_void
id|start_adc
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|s-&gt;dma_adc.mapped
op_logical_and
id|s-&gt;dma_adc.count
op_ge
(paren
r_int
)paren
(paren
id|s-&gt;dma_adc.dmasize
op_minus
l_int|2
op_star
id|s-&gt;dma_adc.fragsize
)paren
)paren
op_logical_or
op_logical_neg
id|s-&gt;dma_adc.ready
op_logical_or
(paren
id|s-&gt;enable
op_amp
id|ADC_RUNNING
)paren
)paren
r_return
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSYS
comma
l_string|&quot;start_adc()&bslash;n&quot;
)paren
suffix:semicolon
id|s-&gt;enable
op_or_assign
id|ADC_RUNNING
suffix:semicolon
id|inc_timer_users
c_func
(paren
id|s-&gt;card
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_ADC1_REQUEST
comma
l_int|1
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_INSTANCE_READY
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|struct|play_vals
r_static
r_struct
id|play_vals
(brace
DECL|member|addr
DECL|member|val
id|u16
id|addr
comma
id|val
suffix:semicolon
DECL|variable|pv
)brace
id|pv
(braket
)braket
op_assign
(brace
(brace
id|CDATA_LEFT_VOLUME
comma
id|ARB_VOLUME
)brace
comma
(brace
id|CDATA_RIGHT_VOLUME
comma
id|ARB_VOLUME
)brace
comma
(brace
id|SRC3_DIRECTION_OFFSET
comma
l_int|0
)brace
comma
multiline_comment|/* +1, +2 are stereo/16 bit */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|3
comma
l_int|0x0000
)brace
comma
multiline_comment|/* fraction? */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|4
comma
l_int|0
)brace
comma
multiline_comment|/* first l */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|5
comma
l_int|0
)brace
comma
multiline_comment|/* first r */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|6
comma
l_int|0
)brace
comma
multiline_comment|/* second l */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|7
comma
l_int|0
)brace
comma
multiline_comment|/* second r */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|8
comma
l_int|0
)brace
comma
multiline_comment|/* delta l */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|9
comma
l_int|0
)brace
comma
multiline_comment|/* delta r */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|10
comma
l_int|0x8000
)brace
comma
multiline_comment|/* round */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|11
comma
l_int|0xFF00
)brace
comma
multiline_comment|/* higher bute mark */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|13
comma
l_int|0
)brace
comma
multiline_comment|/* temp0 */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|14
comma
l_int|0
)brace
comma
multiline_comment|/* c fraction */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|15
comma
l_int|0
)brace
comma
multiline_comment|/* counter */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|16
comma
l_int|8
)brace
comma
multiline_comment|/* numin */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|17
comma
l_int|50
op_star
l_int|2
)brace
comma
multiline_comment|/* numout */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|18
comma
id|MINISRC_BIQUAD_STAGE
op_minus
l_int|1
)brace
comma
multiline_comment|/* numstage */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|20
comma
l_int|0
)brace
comma
multiline_comment|/* filtertap */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|21
comma
l_int|0
)brace
multiline_comment|/* booster */
)brace
suffix:semicolon
multiline_comment|/* the mode passed should be already shifted and masked */
DECL|function|m3_play_setup
r_static
r_void
id|m3_play_setup
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
id|mode
comma
id|u32
id|rate
comma
r_void
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
r_int
id|dsp_in_size
op_assign
id|MINISRC_IN_BUFFER_SIZE
op_minus
(paren
l_int|0x20
op_star
l_int|2
)paren
suffix:semicolon
r_int
id|dsp_out_size
op_assign
id|MINISRC_OUT_BUFFER_SIZE
op_minus
(paren
l_int|0x20
op_star
l_int|2
)paren
suffix:semicolon
r_int
id|dsp_in_buffer
op_assign
id|s-&gt;dac_inst.data
op_plus
(paren
id|MINISRC_TMP_BUFFER_SIZE
op_div
l_int|2
)paren
suffix:semicolon
r_int
id|dsp_out_buffer
op_assign
id|dsp_in_buffer
op_plus
(paren
id|dsp_in_size
op_div
l_int|2
)paren
op_plus
l_int|1
suffix:semicolon
r_struct
id|dmabuf
op_star
id|db
op_assign
op_amp
id|s-&gt;dma_dac
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSTR
comma
l_string|&quot;mode=%d rate=%d buf=%p len=%d.&bslash;n&quot;
comma
id|mode
comma
id|rate
comma
id|buffer
comma
id|size
)paren
suffix:semicolon
DECL|macro|LO
mdefine_line|#define LO(x) ((x) &amp; 0xffff)
DECL|macro|HI
mdefine_line|#define HI(x) LO((x) &gt;&gt; 16)
multiline_comment|/* host dma buffer pointers */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_HOST_SRC_ADDRL
comma
id|LO
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_HOST_SRC_ADDRH
comma
id|HI
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_HOST_SRC_END_PLUS_1L
comma
id|LO
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
op_plus
id|size
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_HOST_SRC_END_PLUS_1H
comma
id|HI
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
op_plus
id|size
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_HOST_SRC_CURRENTL
comma
id|LO
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_HOST_SRC_CURRENTH
comma
id|HI
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
)paren
)paren
suffix:semicolon
DECL|macro|LO
macro_line|#undef LO
DECL|macro|HI
macro_line|#undef HI
multiline_comment|/* dsp buffers */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_IN_BUF_BEGIN
comma
id|dsp_in_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_IN_BUF_END_PLUS_1
comma
id|dsp_in_buffer
op_plus
(paren
id|dsp_in_size
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_IN_BUF_HEAD
comma
id|dsp_in_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_IN_BUF_TAIL
comma
id|dsp_in_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_OUT_BUF_BEGIN
comma
id|dsp_out_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_OUT_BUF_END_PLUS_1
comma
id|dsp_out_buffer
op_plus
(paren
id|dsp_out_size
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_OUT_BUF_HEAD
comma
id|dsp_out_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_OUT_BUF_TAIL
comma
id|dsp_out_buffer
)paren
suffix:semicolon
multiline_comment|/*&n;     * some per client initializers&n;     */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|12
comma
id|s-&gt;dac_inst.data
op_plus
l_int|40
op_plus
l_int|8
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|19
comma
id|s-&gt;dac_inst.code
op_plus
id|MINISRC_COEF_LOC
)paren
suffix:semicolon
multiline_comment|/* enable or disable low pass filter? */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|22
comma
id|s-&gt;ratedac
OG
l_int|45000
ques
c_cond
l_int|0xff
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* tell it which way dma is going? */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|CDATA_DMA_CONTROL
comma
id|DMACONTROL_AUTOREPEAT
op_plus
id|DMAC_PAGE3_SELECTOR
op_plus
id|DMAC_BLOCKF_SELECTOR
)paren
suffix:semicolon
multiline_comment|/*&n;     * set an armload of static initializers&n;     */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|pv
)paren
op_div
r_sizeof
(paren
id|pv
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;dac_inst.data
op_plus
id|pv
(braket
id|i
)braket
dot
id|addr
comma
id|pv
(braket
id|i
)braket
dot
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;     * put us in the lists if we&squot;re not already there&n;     */
r_if
c_cond
(paren
id|db-&gt;in_lists
op_eq
l_int|0
)paren
(brace
id|db-&gt;msrc_index
op_assign
id|m3_add_list
c_func
(paren
id|s-&gt;card
comma
op_amp
id|s-&gt;card-&gt;msrc_list
comma
id|s-&gt;dac_inst.data
op_rshift
id|DP_SHIFT_COUNT
)paren
suffix:semicolon
id|db-&gt;dma_index
op_assign
id|m3_add_list
c_func
(paren
id|s-&gt;card
comma
op_amp
id|s-&gt;card-&gt;dma_list
comma
id|s-&gt;dac_inst.data
op_rshift
id|DP_SHIFT_COUNT
)paren
suffix:semicolon
id|db-&gt;mixer_index
op_assign
id|m3_add_list
c_func
(paren
id|s-&gt;card
comma
op_amp
id|s-&gt;card-&gt;mixer_list
comma
id|s-&gt;dac_inst.data
op_rshift
id|DP_SHIFT_COUNT
)paren
suffix:semicolon
id|db-&gt;in_lists
op_assign
l_int|1
suffix:semicolon
)brace
id|set_dac_rate
c_func
(paren
id|s
comma
id|rate
)paren
suffix:semicolon
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *    Native record driver &n; */
DECL|struct|rec_vals
r_static
r_struct
id|rec_vals
(brace
DECL|member|addr
DECL|member|val
id|u16
id|addr
comma
id|val
suffix:semicolon
DECL|variable|rv
)brace
id|rv
(braket
)braket
op_assign
(brace
(brace
id|CDATA_LEFT_VOLUME
comma
id|ARB_VOLUME
)brace
comma
(brace
id|CDATA_RIGHT_VOLUME
comma
id|ARB_VOLUME
)brace
comma
(brace
id|SRC3_DIRECTION_OFFSET
comma
l_int|1
)brace
comma
multiline_comment|/* +1, +2 are stereo/16 bit */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|3
comma
l_int|0x0000
)brace
comma
multiline_comment|/* fraction? */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|4
comma
l_int|0
)brace
comma
multiline_comment|/* first l */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|5
comma
l_int|0
)brace
comma
multiline_comment|/* first r */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|6
comma
l_int|0
)brace
comma
multiline_comment|/* second l */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|7
comma
l_int|0
)brace
comma
multiline_comment|/* second r */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|8
comma
l_int|0
)brace
comma
multiline_comment|/* delta l */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|9
comma
l_int|0
)brace
comma
multiline_comment|/* delta r */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|10
comma
l_int|0x8000
)brace
comma
multiline_comment|/* round */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|11
comma
l_int|0xFF00
)brace
comma
multiline_comment|/* higher bute mark */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|13
comma
l_int|0
)brace
comma
multiline_comment|/* temp0 */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|14
comma
l_int|0
)brace
comma
multiline_comment|/* c fraction */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|15
comma
l_int|0
)brace
comma
multiline_comment|/* counter */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|16
comma
l_int|50
)brace
comma
multiline_comment|/* numin */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|17
comma
l_int|8
)brace
comma
multiline_comment|/* numout */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|18
comma
l_int|0
)brace
comma
multiline_comment|/* numstage */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|19
comma
l_int|0
)brace
comma
multiline_comment|/* coef */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|20
comma
l_int|0
)brace
comma
multiline_comment|/* filtertap */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|21
comma
l_int|0
)brace
comma
multiline_comment|/* booster */
(brace
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|22
comma
l_int|0xff
)brace
multiline_comment|/* skip lpf */
)brace
suffix:semicolon
multiline_comment|/* again, passed mode is alrady shifted/masked */
DECL|function|m3_rec_setup
r_static
r_void
id|m3_rec_setup
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
id|mode
comma
id|u32
id|rate
comma
r_void
op_star
id|buffer
comma
r_int
id|size
)paren
(brace
r_int
id|dsp_in_size
op_assign
id|MINISRC_IN_BUFFER_SIZE
op_plus
(paren
l_int|0x10
op_star
l_int|2
)paren
suffix:semicolon
r_int
id|dsp_out_size
op_assign
id|MINISRC_OUT_BUFFER_SIZE
op_minus
(paren
l_int|0x10
op_star
l_int|2
)paren
suffix:semicolon
r_int
id|dsp_in_buffer
op_assign
id|s-&gt;adc_inst.data
op_plus
(paren
id|MINISRC_TMP_BUFFER_SIZE
op_div
l_int|2
)paren
suffix:semicolon
r_int
id|dsp_out_buffer
op_assign
id|dsp_in_buffer
op_plus
(paren
id|dsp_in_size
op_div
l_int|2
)paren
op_plus
l_int|1
suffix:semicolon
r_struct
id|dmabuf
op_star
id|db
op_assign
op_amp
id|s-&gt;dma_adc
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSTR
comma
l_string|&quot;rec_setup mode=%d rate=%d buf=%p len=%d.&bslash;n&quot;
comma
id|mode
comma
id|rate
comma
id|buffer
comma
id|size
)paren
suffix:semicolon
DECL|macro|LO
mdefine_line|#define LO(x) ((x) &amp; 0xffff)
DECL|macro|HI
mdefine_line|#define HI(x) LO((x) &gt;&gt; 16)
multiline_comment|/* host dma buffer pointers */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_HOST_SRC_ADDRL
comma
id|LO
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_HOST_SRC_ADDRH
comma
id|HI
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_HOST_SRC_END_PLUS_1L
comma
id|LO
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
op_plus
id|size
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_HOST_SRC_END_PLUS_1H
comma
id|HI
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
op_plus
id|size
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_HOST_SRC_CURRENTL
comma
id|LO
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_HOST_SRC_CURRENTH
comma
id|HI
c_func
(paren
id|virt_to_bus
c_func
(paren
id|buffer
)paren
)paren
)paren
suffix:semicolon
DECL|macro|LO
macro_line|#undef LO
DECL|macro|HI
macro_line|#undef HI
multiline_comment|/* dsp buffers */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_IN_BUF_BEGIN
comma
id|dsp_in_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_IN_BUF_END_PLUS_1
comma
id|dsp_in_buffer
op_plus
(paren
id|dsp_in_size
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_IN_BUF_HEAD
comma
id|dsp_in_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_IN_BUF_TAIL
comma
id|dsp_in_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_OUT_BUF_BEGIN
comma
id|dsp_out_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_OUT_BUF_END_PLUS_1
comma
id|dsp_out_buffer
op_plus
(paren
id|dsp_out_size
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_OUT_BUF_HEAD
comma
id|dsp_out_buffer
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_OUT_BUF_TAIL
comma
id|dsp_out_buffer
)paren
suffix:semicolon
multiline_comment|/*&n;     * some per client initializers&n;     */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|SRC3_DIRECTION_OFFSET
op_plus
l_int|12
comma
id|s-&gt;adc_inst.data
op_plus
l_int|40
op_plus
l_int|8
)paren
suffix:semicolon
multiline_comment|/* tell it which way dma is going? */
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|CDATA_DMA_CONTROL
comma
id|DMACONTROL_DIRECTION
op_plus
id|DMACONTROL_AUTOREPEAT
op_plus
id|DMAC_PAGE3_SELECTOR
op_plus
id|DMAC_BLOCKF_SELECTOR
)paren
suffix:semicolon
multiline_comment|/*&n;     * set an armload of static initializers&n;     */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|rv
)paren
op_div
r_sizeof
(paren
id|rv
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|s-&gt;card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|s-&gt;adc_inst.data
op_plus
id|rv
(braket
id|i
)braket
dot
id|addr
comma
id|rv
(braket
id|i
)braket
dot
id|val
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;     * put us in the lists if we&squot;re not already there&n;     */
r_if
c_cond
(paren
id|db-&gt;in_lists
op_eq
l_int|0
)paren
(brace
id|db-&gt;adc1_index
op_assign
id|m3_add_list
c_func
(paren
id|s-&gt;card
comma
op_amp
id|s-&gt;card-&gt;adc1_list
comma
id|s-&gt;adc_inst.data
op_rshift
id|DP_SHIFT_COUNT
)paren
suffix:semicolon
id|db-&gt;dma_index
op_assign
id|m3_add_list
c_func
(paren
id|s-&gt;card
comma
op_amp
id|s-&gt;card-&gt;dma_list
comma
id|s-&gt;adc_inst.data
op_rshift
id|DP_SHIFT_COUNT
)paren
suffix:semicolon
id|db-&gt;msrc_index
op_assign
id|m3_add_list
c_func
(paren
id|s-&gt;card
comma
op_amp
id|s-&gt;card-&gt;msrc_list
comma
id|s-&gt;adc_inst.data
op_rshift
id|DP_SHIFT_COUNT
)paren
suffix:semicolon
id|db-&gt;in_lists
op_assign
l_int|1
suffix:semicolon
)brace
id|set_adc_rate
c_func
(paren
id|s
comma
id|rate
)paren
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|set_dmaa
r_static
r_void
id|set_dmaa
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|count
)paren
(brace
id|DPRINTK
c_func
(paren
id|DPINT
comma
l_string|&quot;set_dmaa??&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|set_dmac
r_static
r_void
id|set_dmac
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|count
)paren
(brace
id|DPRINTK
c_func
(paren
id|DPINT
comma
l_string|&quot;set_dmac??&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|get_dma_pos
id|u32
id|get_dma_pos
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_int
id|instance_addr
)paren
(brace
id|u16
id|hi
op_assign
l_int|0
comma
id|lo
op_assign
l_int|0
suffix:semicolon
r_int
id|retry
op_assign
l_int|10
suffix:semicolon
multiline_comment|/*&n;     * try and get a valid answer&n;     */
r_while
c_loop
(paren
id|retry
op_decrement
)paren
(brace
id|hi
op_assign
id|m3_assp_read
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|instance_addr
op_plus
id|CDATA_HOST_SRC_CURRENTH
)paren
suffix:semicolon
id|lo
op_assign
id|m3_assp_read
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|instance_addr
op_plus
id|CDATA_HOST_SRC_CURRENTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_eq
id|m3_assp_read
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|instance_addr
op_plus
id|CDATA_HOST_SRC_CURRENTH
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_return
id|lo
op_or
(paren
id|hi
op_lshift
l_int|16
)paren
suffix:semicolon
)brace
DECL|function|get_dmaa
id|u32
id|get_dmaa
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
id|u32
id|offset
suffix:semicolon
id|offset
op_assign
id|get_dma_pos
c_func
(paren
id|s-&gt;card
comma
id|s-&gt;dac_inst.data
)paren
op_minus
id|virt_to_bus
c_func
(paren
id|s-&gt;dma_dac.rawbuf
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPINT
comma
l_string|&quot;get_dmaa: 0x%08x&bslash;n&quot;
comma
id|offset
)paren
suffix:semicolon
r_return
id|offset
suffix:semicolon
)brace
DECL|function|get_dmac
id|u32
id|get_dmac
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
id|u32
id|offset
suffix:semicolon
id|offset
op_assign
id|get_dma_pos
c_func
(paren
id|s-&gt;card
comma
id|s-&gt;adc_inst.data
)paren
op_minus
id|virt_to_bus
c_func
(paren
id|s-&gt;dma_adc.rawbuf
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPINT
comma
l_string|&quot;get_dmac: 0x%08x&bslash;n&quot;
comma
id|offset
)paren
suffix:semicolon
r_return
id|offset
suffix:semicolon
)brace
r_static
r_void
id|m3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
DECL|function|prog_dmabuf
id|prog_dmabuf
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
id|rec
)paren
(brace
r_struct
id|dmabuf
op_star
id|db
op_assign
id|rec
ques
c_cond
op_amp
id|s-&gt;dma_adc
suffix:colon
op_amp
id|s-&gt;dma_dac
suffix:semicolon
r_int
id|rate
op_assign
id|rec
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
suffix:semicolon
r_int
id|bytepersec
suffix:semicolon
r_int
id|bufs
suffix:semicolon
r_int
r_char
id|fmt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fmt
op_assign
id|s-&gt;fmt
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|fmt
op_rshift_assign
id|ESS_ADC_SHIFT
suffix:semicolon
)brace
r_else
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|fmt
op_rshift_assign
id|ESS_DAC_SHIFT
suffix:semicolon
)brace
id|fmt
op_and_assign
id|ESS_FMT_MASK
suffix:semicolon
id|db-&gt;hwptr
op_assign
id|db-&gt;swptr
op_assign
id|db-&gt;total_bytes
op_assign
id|db-&gt;count
op_assign
id|db-&gt;error
op_assign
id|db-&gt;endcleared
op_assign
l_int|0
suffix:semicolon
id|bytepersec
op_assign
id|rate
op_lshift
id|sample_shift
(braket
id|fmt
)braket
suffix:semicolon
id|bufs
op_assign
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;ossfragshift
)paren
(brace
r_if
c_cond
(paren
(paren
l_int|1000
op_lshift
id|db-&gt;ossfragshift
)paren
OL
id|bytepersec
)paren
id|db-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|1000
)paren
suffix:semicolon
r_else
id|db-&gt;fragshift
op_assign
id|db-&gt;ossfragshift
suffix:semicolon
)brace
r_else
(brace
id|db-&gt;fragshift
op_assign
id|ld2
c_func
(paren
id|bytepersec
op_div
l_int|100
op_div
(paren
id|db-&gt;subdivision
ques
c_cond
id|db-&gt;subdivision
suffix:colon
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;fragshift
OL
l_int|3
)paren
id|db-&gt;fragshift
op_assign
l_int|3
suffix:semicolon
)brace
id|db-&gt;numfrag
op_assign
id|bufs
op_rshift
id|db-&gt;fragshift
suffix:semicolon
r_while
c_loop
(paren
id|db-&gt;numfrag
template_param
l_int|3
)paren
(brace
id|db-&gt;fragshift
op_decrement
suffix:semicolon
id|db-&gt;numfrag
op_assign
id|bufs
op_rshift
id|db-&gt;fragshift
suffix:semicolon
)brace
id|db-&gt;fragsize
op_assign
l_int|1
op_lshift
id|db-&gt;fragshift
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;ossmaxfrags
op_ge
l_int|4
op_logical_and
id|db-&gt;ossmaxfrags
OL
id|db-&gt;numfrag
)paren
id|db-&gt;numfrag
op_assign
id|db-&gt;ossmaxfrags
suffix:semicolon
id|db-&gt;fragsamples
op_assign
id|db-&gt;fragsize
op_rshift
id|sample_shift
(braket
id|fmt
)braket
suffix:semicolon
id|db-&gt;dmasize
op_assign
id|db-&gt;numfrag
op_lshift
id|db-&gt;fragshift
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSTR
comma
l_string|&quot;prog_dmabuf: numfrag: %d fragsize: %d dmasize: %d&bslash;n&quot;
comma
id|db-&gt;numfrag
comma
id|db-&gt;fragsize
comma
id|db-&gt;dmasize
)paren
suffix:semicolon
id|memset
c_func
(paren
id|db-&gt;rawbuf
comma
(paren
id|fmt
op_amp
id|ESS_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
comma
id|db-&gt;dmasize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec
)paren
id|m3_rec_setup
c_func
(paren
id|s
comma
id|fmt
comma
id|s-&gt;rateadc
comma
id|db-&gt;rawbuf
comma
id|db-&gt;dmasize
)paren
suffix:semicolon
r_else
id|m3_play_setup
c_func
(paren
id|s
comma
id|fmt
comma
id|s-&gt;ratedac
comma
id|db-&gt;rawbuf
comma
id|db-&gt;dmasize
)paren
suffix:semicolon
id|db-&gt;ready
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|clear_advance
r_static
r_void
id|clear_advance
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
r_int
r_char
id|c
op_assign
(paren
(paren
id|s-&gt;fmt
op_rshift
id|ESS_DAC_SHIFT
)paren
op_amp
id|ESS_FMT_16BIT
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|0x80
suffix:semicolon
r_int
r_char
op_star
id|buf
op_assign
id|s-&gt;dma_dac.rawbuf
suffix:semicolon
r_int
id|bsize
op_assign
id|s-&gt;dma_dac.dmasize
suffix:semicolon
r_int
id|bptr
op_assign
id|s-&gt;dma_dac.swptr
suffix:semicolon
r_int
id|len
op_assign
id|s-&gt;dma_dac.fragsize
suffix:semicolon
r_if
c_cond
(paren
id|bptr
op_plus
id|len
OG
id|bsize
)paren
(brace
r_int
id|x
op_assign
id|bsize
op_minus
id|bptr
suffix:semicolon
id|memset
c_func
(paren
id|buf
op_plus
id|bptr
comma
id|c
comma
id|x
)paren
suffix:semicolon
multiline_comment|/* account for wrapping? */
id|bptr
op_assign
l_int|0
suffix:semicolon
id|len
op_sub_assign
id|x
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buf
op_plus
id|bptr
comma
id|c
comma
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* call with spinlock held! */
DECL|function|m3_update_ptr
r_static
r_void
id|m3_update_ptr
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
r_int
id|hwptr
suffix:semicolon
r_int
id|diff
suffix:semicolon
multiline_comment|/* update ADC pointer */
r_if
c_cond
(paren
id|s-&gt;dma_adc.ready
)paren
(brace
id|hwptr
op_assign
id|get_dmac
c_func
(paren
id|s
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|diff
op_assign
(paren
id|s-&gt;dma_adc.dmasize
op_plus
id|hwptr
op_minus
id|s-&gt;dma_adc.hwptr
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|s-&gt;dma_adc.hwptr
op_assign
id|hwptr
suffix:semicolon
id|s-&gt;dma_adc.total_bytes
op_add_assign
id|diff
suffix:semicolon
id|s-&gt;dma_adc.count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_adc.fragsize
)paren
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.mapped
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
OG
(paren
r_int
)paren
(paren
id|s-&gt;dma_adc.dmasize
op_minus
(paren
(paren
l_int|3
op_star
id|s-&gt;dma_adc.fragsize
)paren
op_rshift
l_int|1
)paren
)paren
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
multiline_comment|/* brute force everyone back in sync, sigh */
id|s-&gt;dma_adc.count
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_adc.swptr
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_adc.hwptr
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_adc.error
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* update DAC pointer */
r_if
c_cond
(paren
id|s-&gt;dma_dac.ready
)paren
(brace
id|hwptr
op_assign
id|get_dmaa
c_func
(paren
id|s
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
id|diff
op_assign
(paren
id|s-&gt;dma_dac.dmasize
op_plus
id|hwptr
op_minus
id|s-&gt;dma_dac.hwptr
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPINT
comma
l_string|&quot;updating dac: hwptr: %6d diff: %6d count: %6d&bslash;n&quot;
comma
id|hwptr
comma
id|diff
comma
id|s-&gt;dma_dac.count
)paren
suffix:semicolon
id|s-&gt;dma_dac.hwptr
op_assign
id|hwptr
suffix:semicolon
id|s-&gt;dma_dac.total_bytes
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
(brace
id|s-&gt;dma_dac.count
op_add_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|s-&gt;dma_dac.count
op_sub_assign
id|diff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_le
l_int|0
)paren
(brace
id|DPRINTK
c_func
(paren
id|DPCRAP
comma
l_string|&quot;underflow! diff: %d (0x%x) count: %d (0x%x) hw: %d (0x%x) sw: %d (0x%x)&bslash;n&quot;
comma
id|diff
comma
id|diff
comma
id|s-&gt;dma_dac.count
comma
id|s-&gt;dma_dac.count
comma
id|hwptr
comma
id|hwptr
comma
id|s-&gt;dma_dac.swptr
comma
id|s-&gt;dma_dac.swptr
)paren
suffix:semicolon
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
multiline_comment|/* brute force everyone back in sync, sigh */
id|s-&gt;dma_dac.count
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|hwptr
suffix:semicolon
id|s-&gt;dma_dac.error
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_le
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
op_logical_and
op_logical_neg
id|s-&gt;dma_dac.endcleared
)paren
(brace
id|clear_advance
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.endcleared
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_plus
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
op_le
(paren
r_int
)paren
id|s-&gt;dma_dac.dmasize
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPINT
comma
l_string|&quot;waking up DAC count: %d sw: %d hw: %d&bslash;n&quot;
comma
id|s-&gt;dma_dac.count
comma
id|s-&gt;dma_dac.swptr
comma
id|hwptr
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|m3_interrupt
r_static
r_void
id|m3_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|m3_card
op_star
id|c
op_assign
(paren
r_struct
id|m3_card
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|m3_state
op_star
id|s
op_assign
op_amp
id|c-&gt;channels
(braket
l_int|0
)braket
suffix:semicolon
id|u8
id|status
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|c-&gt;iobase
op_plus
l_int|0x1A
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0xff
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/* presumably acking the ints? */
id|outw
c_func
(paren
id|status
comma
id|c-&gt;iobase
op_plus
l_int|0x1A
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;in_suspend
)paren
(brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;     * ack an assp int if its running&n;     * and has an int pending&n;     */
r_if
c_cond
(paren
id|status
op_amp
id|ASSP_INT_PENDING
)paren
(brace
id|u8
id|ctl
op_assign
id|inb
c_func
(paren
id|c-&gt;iobase
op_plus
id|ASSP_CONTROL_B
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctl
op_amp
id|STOP_ASSP_CLOCK
)paren
)paren
(brace
id|ctl
op_assign
id|inb
c_func
(paren
id|c-&gt;iobase
op_plus
id|ASSP_HOST_INT_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctl
op_amp
id|DSP2HOST_REQ_TIMER
)paren
(brace
id|outb
c_func
(paren
id|DSP2HOST_REQ_TIMER
comma
id|c-&gt;iobase
op_plus
id|ASSP_HOST_INT_STATUS
)paren
suffix:semicolon
multiline_comment|/* update adc/dac info if it was a timer int */
id|spin_lock
c_func
(paren
op_amp
id|s-&gt;lock
)paren
suffix:semicolon
id|m3_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|s-&gt;lock
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* XXX is this needed? */
r_if
c_cond
(paren
id|status
op_amp
l_int|0x40
)paren
(brace
id|outb
c_func
(paren
l_int|0x40
comma
id|c-&gt;iobase
op_plus
l_int|0x1A
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* --------------------------------------------------------------------- */
DECL|variable|invalid_magic
r_static
r_const
r_char
id|invalid_magic
(braket
)braket
op_assign
id|KERN_CRIT
id|PFX
l_string|&quot;invalid magic value in %s&bslash;n&quot;
suffix:semicolon
DECL|macro|VALIDATE_MAGIC
mdefine_line|#define VALIDATE_MAGIC(FOO,MAG)                         &bslash;&n;({                                                &bslash;&n;    if (!(FOO) || (FOO)-&gt;magic != MAG) { &bslash;&n;        printk(invalid_magic,__FUNCTION__);            &bslash;&n;        return -ENXIO;                    &bslash;&n;    }                                         &bslash;&n;})
DECL|macro|VALIDATE_STATE
mdefine_line|#define VALIDATE_STATE(a) VALIDATE_MAGIC(a,M3_STATE_MAGIC)
DECL|macro|VALIDATE_CARD
mdefine_line|#define VALIDATE_CARD(a) VALIDATE_MAGIC(a,M3_CARD_MAGIC)
multiline_comment|/* --------------------------------------------------------------------- */
DECL|function|drain_dac
r_static
r_int
id|drain_dac
c_func
(paren
r_struct
id|m3_state
op_star
id|s
comma
r_int
id|nonblock
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
r_int
id|tmo
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
op_logical_or
op_logical_neg
id|s-&gt;dma_dac.ready
)paren
r_return
l_int|0
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|count
op_assign
id|s-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|nonblock
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|tmo
op_assign
(paren
id|count
op_star
id|HZ
)paren
op_div
id|s-&gt;ratedac
suffix:semicolon
id|tmo
op_rshift_assign
id|sample_shift
(braket
(paren
id|s-&gt;fmt
op_rshift
id|ESS_DAC_SHIFT
)paren
op_amp
id|ESS_FMT_MASK
)braket
suffix:semicolon
multiline_comment|/* XXX this is just broken.  someone is waking us up alot, or schedule_timeout is broken.&n;            or something.  who cares. - zach */
r_if
c_cond
(paren
op_logical_neg
id|schedule_timeout
c_func
(paren
id|tmo
ques
c_cond
id|tmo
suffix:colon
l_int|1
)paren
op_logical_and
id|tmo
)paren
id|DPRINTK
c_func
(paren
id|DPCRAP
comma
l_string|&quot;dma timed out?? %ld&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_read
r_static
id|ssize_t
id|m3_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
(paren
r_struct
id|m3_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_WRITE
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_int
id|timed_out
suffix:semicolon
id|swptr
op_assign
id|s-&gt;dma_adc.swptr
suffix:semicolon
id|cnt
op_assign
id|s-&gt;dma_adc.dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
OL
id|cnt
)paren
id|cnt
op_assign
id|s-&gt;dma_adc.count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|timed_out
op_assign
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
comma
id|HZ
)paren
op_eq
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timed_out
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;read: chip lockup? dmasz %u fragsz %u count %u hwptr %u swptr %u&bslash;n&quot;
comma
id|s-&gt;dma_adc.dmasize
comma
id|s-&gt;dma_adc.fragsize
comma
id|s-&gt;dma_adc.count
comma
id|s-&gt;dma_adc.hwptr
comma
id|s-&gt;dma_adc.swptr
)paren
suffix:semicolon
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|set_dmac
c_func
(paren
id|s
comma
id|virt_to_bus
c_func
(paren
id|s-&gt;dma_adc.rawbuf
)paren
comma
id|s-&gt;dma_adc.numfrag
op_lshift
id|s-&gt;dma_adc.fragshift
)paren
suffix:semicolon
id|s-&gt;dma_adc.count
op_assign
id|s-&gt;dma_adc.hwptr
op_assign
id|s-&gt;dma_adc.swptr
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|s-&gt;dma_adc.rawbuf
op_plus
id|swptr
comma
id|cnt
)paren
)paren
(brace
id|ret
op_assign
id|ret
ques
c_cond
id|ret
suffix:colon
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|s-&gt;dma_adc.dmasize
suffix:semicolon
id|s-&gt;dma_adc.swptr
op_assign
id|swptr
suffix:semicolon
id|s-&gt;dma_adc.count
op_sub_assign
id|cnt
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|m3_write
r_static
id|ssize_t
id|m3_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
(paren
r_struct
id|m3_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|swptr
suffix:semicolon
r_int
id|cnt
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_dac.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
r_int
id|timed_out
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
OL
l_int|0
)paren
(brace
id|s-&gt;dma_dac.count
op_assign
l_int|0
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|s-&gt;dma_dac.hwptr
suffix:semicolon
)brace
id|swptr
op_assign
id|s-&gt;dma_dac.swptr
suffix:semicolon
id|cnt
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|swptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_plus
id|cnt
OG
id|s-&gt;dma_dac.dmasize
)paren
id|cnt
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|s-&gt;dma_dac.count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|timed_out
op_assign
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
comma
id|HZ
)paren
op_eq
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timed_out
)paren
(brace
id|DPRINTK
c_func
(paren
id|DPCRAP
comma
l_string|&quot;write: chip lockup? dmasz %u fragsz %u count %u hwptr %u swptr %u&bslash;n&quot;
comma
id|s-&gt;dma_dac.dmasize
comma
id|s-&gt;dma_dac.fragsize
comma
id|s-&gt;dma_dac.count
comma
id|s-&gt;dma_dac.hwptr
comma
id|s-&gt;dma_dac.swptr
)paren
suffix:semicolon
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|set_dmaa
c_func
(paren
id|s
comma
id|virt_to_bus
c_func
(paren
id|s-&gt;dma_dac.rawbuf
)paren
comma
id|s-&gt;dma_dac.numfrag
op_lshift
id|s-&gt;dma_dac.fragshift
)paren
suffix:semicolon
id|s-&gt;dma_dac.count
op_assign
id|s-&gt;dma_dac.hwptr
op_assign
id|s-&gt;dma_dac.swptr
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|s-&gt;dma_dac.rawbuf
op_plus
id|swptr
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSYS
comma
l_string|&quot;wrote %6d bytes at sw: %6d cnt: %6d while hw: %6d&bslash;n&quot;
comma
id|cnt
comma
id|swptr
comma
id|s-&gt;dma_dac.count
comma
id|s-&gt;dma_dac.hwptr
)paren
suffix:semicolon
id|swptr
op_assign
(paren
id|swptr
op_plus
id|cnt
)paren
op_mod
id|s-&gt;dma_dac.dmasize
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|swptr
suffix:semicolon
id|s-&gt;dma_dac.count
op_add_assign
id|cnt
suffix:semicolon
id|s-&gt;dma_dac.endcleared
op_assign
l_int|0
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|m3_poll
r_static
r_int
r_int
id|m3_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
(paren
r_struct
id|m3_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;dma_dac.wait
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;dma_adc.wait
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|m3_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_adc.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_adc.fragsize
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;dma_dac.count
op_ge
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|s-&gt;dma_dac.dmasize
op_ge
id|s-&gt;dma_dac.count
op_plus
(paren
r_int
)paren
id|s-&gt;dma_dac.fragsize
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|m3_mmap
r_static
r_int
id|m3_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
(paren
r_struct
id|m3_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|max_size
comma
id|size
comma
id|start
comma
id|offset
suffix:semicolon
r_struct
id|dmabuf
op_star
id|db
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|db
op_assign
op_amp
id|s-&gt;dma_dac
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_READ
)paren
(brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|db
op_assign
op_amp
id|s-&gt;dma_adc
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
id|max_size
op_assign
id|db-&gt;dmasize
suffix:semicolon
id|start
op_assign
id|vma-&gt;vm_start
suffix:semicolon
id|offset
op_assign
(paren
id|vma-&gt;vm_pgoff
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|size
op_assign
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|max_size
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|offset
OG
id|max_size
op_minus
id|size
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;     * this will be -&gt;nopage() once I can &n;     * ask Jeff what the hell I&squot;m doing wrong.&n;     */
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|remap_page_range
c_func
(paren
id|vma-&gt;vm_start
comma
id|virt_to_phys
c_func
(paren
id|db-&gt;rawbuf
)paren
comma
id|size
comma
id|vma-&gt;vm_page_prot
)paren
)paren
r_goto
id|out
suffix:semicolon
id|db-&gt;mapped
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * this function is a disaster..&n; */
DECL|macro|get_user_ret
mdefine_line|#define get_user_ret(x, ptr,  ret) ({ if(get_user(x, ptr)) return ret; })
DECL|function|m3_ioctl
r_static
r_int
id|m3_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
(paren
r_struct
id|m3_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|audio_buf_info
id|abinfo
suffix:semicolon
id|count_info
id|cinfo
suffix:semicolon
r_int
id|val
comma
id|mapped
comma
id|ret
suffix:semicolon
r_int
r_char
id|fmtm
comma
id|fmtd
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|mapped
op_assign
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
id|s-&gt;dma_dac.mapped
)paren
op_logical_or
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
op_logical_and
id|s-&gt;dma_adc.mapped
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSYS
comma
l_string|&quot;m3_ioctl: cmd %d&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|OSS_GETVERSION
suffix:colon
r_return
id|put_user
c_func
(paren
id|SOUND_VERSION
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SYNC
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
r_return
id|drain_dac
c_func
(paren
id|s
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SETDUPLEX
suffix:colon
multiline_comment|/* XXX fix */
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETCAPS
suffix:colon
r_return
id|put_user
c_func
(paren
id|DSP_CAP_DUPLEX
op_or
id|DSP_CAP_REALTIME
op_or
id|DSP_CAP_TRIGGER
op_or
id|DSP_CAP_MMAP
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_RESET
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|s-&gt;dma_dac.swptr
op_assign
id|s-&gt;dma_dac.hwptr
op_assign
id|s-&gt;dma_dac.count
op_assign
id|s-&gt;dma_dac.total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|synchronize_irq
c_func
(paren
)paren
suffix:semicolon
id|s-&gt;dma_adc.swptr
op_assign
id|s-&gt;dma_adc.hwptr
op_assign
id|s-&gt;dma_adc.count
op_assign
id|s-&gt;dma_adc.total_bytes
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SPEED
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
id|set_adc_rate
c_func
(paren
id|s
comma
id|val
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
id|set_dac_rate
c_func
(paren
id|s
comma
id|val
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_STEREO
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|fmtd
op_or_assign
id|ESS_FMT_STEREO
op_lshift
id|ESS_ADC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_FMT_STEREO
op_lshift
id|ESS_ADC_SHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|fmtd
op_or_assign
id|ESS_FMT_STEREO
op_lshift
id|ESS_DAC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_FMT_STEREO
op_lshift
id|ESS_DAC_SHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_CHANNELS
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
(brace
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
id|fmtd
op_or_assign
id|ESS_FMT_STEREO
op_lshift
id|ESS_ADC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_FMT_STEREO
op_lshift
id|ESS_ADC_SHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ge
l_int|2
)paren
id|fmtd
op_or_assign
id|ESS_FMT_STEREO
op_lshift
id|ESS_DAC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_FMT_STEREO
op_lshift
id|ESS_DAC_SHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|ESS_FMT_STEREO
op_lshift
id|ESS_ADC_SHIFT
)paren
suffix:colon
(paren
id|ESS_FMT_STEREO
op_lshift
id|ESS_DAC_SHIFT
)paren
)paren
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETFMTS
suffix:colon
multiline_comment|/* Returns a mask */
r_return
id|put_user
c_func
(paren
id|AFMT_U8
op_or
id|AFMT_S16_LE
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFMT
suffix:colon
multiline_comment|/* Selects ONE fmt*/
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
id|AFMT_QUERY
)paren
(brace
id|fmtd
op_assign
l_int|0
suffix:semicolon
id|fmtm
op_assign
op_complement
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_adc.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|fmtd
op_or_assign
id|ESS_FMT_16BIT
op_lshift
id|ESS_ADC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_FMT_16BIT
op_lshift
id|ESS_ADC_SHIFT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;dma_dac.ready
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
id|AFMT_S16_LE
)paren
id|fmtd
op_or_assign
id|ESS_FMT_16BIT
op_lshift
id|ESS_DAC_SHIFT
suffix:semicolon
r_else
id|fmtm
op_and_assign
op_complement
(paren
id|ESS_FMT_16BIT
op_lshift
id|ESS_DAC_SHIFT
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmtd
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|ESS_FMT_16BIT
op_lshift
id|ESS_ADC_SHIFT
)paren
suffix:colon
(paren
id|ESS_FMT_16BIT
op_lshift
id|ESS_DAC_SHIFT
)paren
)paren
)paren
ques
c_cond
id|AFMT_S16_LE
suffix:colon
id|AFMT_U8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_POST
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETTRIGGER
suffix:colon
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
op_logical_and
(paren
id|s-&gt;enable
op_amp
id|ADC_RUNNING
)paren
)paren
id|val
op_or_assign
id|PCM_ENABLE_INPUT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
op_logical_and
(paren
id|s-&gt;enable
op_amp
id|DAC_RUNNING
)paren
)paren
id|val
op_or_assign
id|PCM_ENABLE_OUTPUT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETTRIGGER
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_INPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_adc.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|PCM_ENABLE_OUTPUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;dma_dac.ready
op_logical_and
(paren
id|ret
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_else
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOSPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;enable
op_amp
id|DAC_RUNNING
)paren
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|m3_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|s-&gt;dma_dac.fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|s-&gt;dma_dac.dmasize
op_minus
id|s-&gt;dma_dac.count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|s-&gt;dma_dac.numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|s-&gt;dma_dac.fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETISPACE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;enable
op_amp
id|ADC_RUNNING
)paren
op_logical_and
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|val
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|m3_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|abinfo.fragsize
op_assign
id|s-&gt;dma_adc.fragsize
suffix:semicolon
id|abinfo.bytes
op_assign
id|s-&gt;dma_adc.count
suffix:semicolon
id|abinfo.fragstotal
op_assign
id|s-&gt;dma_adc.numfrag
suffix:semicolon
id|abinfo.fragments
op_assign
id|abinfo.bytes
op_rshift
id|s-&gt;dma_adc.fragshift
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|abinfo
comma
r_sizeof
(paren
id|abinfo
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_NONBLOCK
suffix:colon
id|file-&gt;f_flags
op_or_assign
id|O_NONBLOCK
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_GETODELAY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|m3_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|val
op_assign
id|s-&gt;dma_dac.count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETIPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|m3_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|s-&gt;dma_adc.total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|s-&gt;dma_adc.count
op_rshift
id|s-&gt;dma_adc.fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|s-&gt;dma_adc.hwptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.mapped
)paren
id|s-&gt;dma_adc.count
op_and_assign
id|s-&gt;dma_adc.fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETOPTR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|m3_update_ptr
c_func
(paren
id|s
)paren
suffix:semicolon
id|cinfo.bytes
op_assign
id|s-&gt;dma_dac.total_bytes
suffix:semicolon
id|cinfo.blocks
op_assign
id|s-&gt;dma_dac.count
op_rshift
id|s-&gt;dma_dac.fragshift
suffix:semicolon
id|cinfo.ptr
op_assign
id|s-&gt;dma_dac.hwptr
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.mapped
)paren
id|s-&gt;dma_dac.count
op_and_assign
id|s-&gt;dma_dac.fragsize
op_minus
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|cinfo
comma
r_sizeof
(paren
id|cinfo
)paren
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_GETBLKSIZE
suffix:colon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|0
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|s-&gt;dma_dac.fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|val
op_assign
id|prog_dmabuf
c_func
(paren
id|s
comma
l_int|1
)paren
)paren
)paren
r_return
id|val
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|s-&gt;dma_adc.fragsize
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SNDCTL_DSP_SETFRAGMENT
suffix:colon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|s-&gt;dma_adc.ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|s-&gt;dma_adc.ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossfragshift
OL
l_int|4
)paren
id|s-&gt;dma_adc.ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossfragshift
OG
l_int|15
)paren
id|s-&gt;dma_adc.ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ossmaxfrags
OL
l_int|4
)paren
id|s-&gt;dma_adc.ossmaxfrags
op_assign
l_int|4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|s-&gt;dma_dac.ossfragshift
op_assign
id|val
op_amp
l_int|0xffff
suffix:semicolon
id|s-&gt;dma_dac.ossmaxfrags
op_assign
(paren
id|val
op_rshift
l_int|16
)paren
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossfragshift
OL
l_int|4
)paren
id|s-&gt;dma_dac.ossfragshift
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossfragshift
OG
l_int|15
)paren
id|s-&gt;dma_dac.ossfragshift
op_assign
l_int|15
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.ossmaxfrags
OL
l_int|4
)paren
id|s-&gt;dma_dac.ossmaxfrags
op_assign
l_int|4
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SNDCTL_DSP_SUBDIVIDE
suffix:colon
r_if
c_cond
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
op_logical_and
id|s-&gt;dma_adc.subdivision
)paren
op_logical_or
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
op_logical_and
id|s-&gt;dma_dac.subdivision
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|get_user_ret
c_func
(paren
id|val
comma
(paren
r_int
op_star
)paren
id|arg
comma
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_ne
l_int|1
op_logical_and
id|val
op_ne
l_int|2
op_logical_and
id|val
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
id|s-&gt;dma_adc.subdivision
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|s-&gt;dma_dac.subdivision
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SOUND_PCM_READ_RATE
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
id|s-&gt;rateadc
suffix:colon
id|s-&gt;ratedac
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_CHANNELS
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|ESS_FMT_STEREO
op_lshift
id|ESS_ADC_SHIFT
)paren
suffix:colon
(paren
id|ESS_FMT_STEREO
op_lshift
id|ESS_DAC_SHIFT
)paren
)paren
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_READ_BITS
suffix:colon
r_return
id|put_user
c_func
(paren
(paren
id|s-&gt;fmt
op_amp
(paren
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
ques
c_cond
(paren
id|ESS_FMT_16BIT
op_lshift
id|ESS_ADC_SHIFT
)paren
suffix:colon
(paren
id|ESS_FMT_16BIT
op_lshift
id|ESS_DAC_SHIFT
)paren
)paren
)paren
ques
c_cond
l_int|16
suffix:colon
l_int|8
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SOUND_PCM_WRITE_FILTER
suffix:colon
r_case
id|SNDCTL_DSP_SETSYNCRO
suffix:colon
r_case
id|SOUND_PCM_READ_FILTER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|allocate_dmabuf
id|allocate_dmabuf
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_struct
id|dmabuf
op_star
id|db
)paren
(brace
r_int
id|order
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSTR
comma
l_string|&quot;allocating for dmabuf %p&bslash;n&quot;
comma
id|db
)paren
suffix:semicolon
multiline_comment|/* &n;     * alloc as big a chunk as we can, start with &n;     * 64k &squot;cause we&squot;re insane.  based on order cause&n;     * the amazingly complicated prog_dmabuf wants it.&n;     *&n;     * pci_alloc_sonsistent guarantees that it won&squot;t cross a natural&n;     * boundry; the m3 hardware can&squot;t have dma cross a 64k bus&n;     * address boundry.&n;     */
r_for
c_loop
(paren
id|order
op_assign
l_int|16
op_minus
id|PAGE_SHIFT
suffix:semicolon
id|order
op_ge
l_int|1
suffix:semicolon
id|order
op_decrement
)paren
(brace
id|db-&gt;rawbuf
op_assign
id|pci_alloc_consistent
c_func
(paren
id|pci_dev
comma
id|PAGE_SIZE
op_lshift
id|order
comma
op_amp
(paren
id|db-&gt;handle
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|db-&gt;rawbuf
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|db-&gt;rawbuf
)paren
r_return
l_int|1
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPSTR
comma
l_string|&quot;allocated %ld (%d) bytes at %p&bslash;n&quot;
comma
id|PAGE_SIZE
op_lshift
id|order
comma
id|order
comma
id|db-&gt;rawbuf
)paren
suffix:semicolon
(brace
r_struct
id|page
op_star
id|page
comma
op_star
id|pend
suffix:semicolon
id|pend
op_assign
id|virt_to_page
c_func
(paren
id|db-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|page
op_assign
id|virt_to_page
c_func
(paren
id|db-&gt;rawbuf
)paren
suffix:semicolon
id|page
op_le
id|pend
suffix:semicolon
id|page
op_increment
)paren
id|mem_map_reserve
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
id|db-&gt;buforder
op_assign
id|order
suffix:semicolon
id|db-&gt;ready
op_assign
l_int|0
suffix:semicolon
id|db-&gt;mapped
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|nuke_lists
id|nuke_lists
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_struct
id|dmabuf
op_star
id|db
)paren
(brace
id|m3_remove_list
c_func
(paren
id|card
comma
op_amp
(paren
id|card-&gt;dma_list
)paren
comma
id|db-&gt;dma_index
)paren
suffix:semicolon
id|m3_remove_list
c_func
(paren
id|card
comma
op_amp
(paren
id|card-&gt;msrc_list
)paren
comma
id|db-&gt;msrc_index
)paren
suffix:semicolon
id|db-&gt;in_lists
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|free_dmabuf
id|free_dmabuf
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_struct
id|dmabuf
op_star
id|db
)paren
(brace
r_if
c_cond
(paren
id|db-&gt;rawbuf
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
id|DPSTR
comma
l_string|&quot;freeing %p from dmabuf %p&bslash;n&quot;
comma
id|db-&gt;rawbuf
comma
id|db
)paren
suffix:semicolon
(brace
r_struct
id|page
op_star
id|page
comma
op_star
id|pend
suffix:semicolon
id|pend
op_assign
id|virt_to_page
c_func
(paren
id|db-&gt;rawbuf
op_plus
(paren
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|page
op_assign
id|virt_to_page
c_func
(paren
id|db-&gt;rawbuf
)paren
suffix:semicolon
id|page
op_le
id|pend
suffix:semicolon
id|page
op_increment
)paren
id|mem_map_unreserve
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
id|pci_free_consistent
c_func
(paren
id|pci_dev
comma
id|PAGE_SIZE
op_lshift
id|db-&gt;buforder
comma
id|db-&gt;rawbuf
comma
id|db-&gt;handle
)paren
suffix:semicolon
id|db-&gt;rawbuf
op_assign
l_int|NULL
suffix:semicolon
id|db-&gt;buforder
op_assign
l_int|0
suffix:semicolon
id|db-&gt;mapped
op_assign
l_int|0
suffix:semicolon
id|db-&gt;ready
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|m3_open
r_static
r_int
id|m3_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|m3_card
op_star
id|c
suffix:semicolon
r_struct
id|m3_state
op_star
id|s
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_char
id|fmtm
op_assign
op_complement
l_int|0
comma
id|fmts
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;     *    Scan the cards and find the channel. We only&n;     *    do this at open time so it is ok&n;     */
r_for
c_loop
(paren
id|c
op_assign
id|devs
suffix:semicolon
id|c
op_ne
l_int|NULL
suffix:semicolon
id|c
op_assign
id|c-&gt;next
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;channels
(braket
id|i
)braket
dot
id|dev_audio
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|c-&gt;channels
(braket
id|i
)braket
dot
id|dev_audio
op_xor
id|minor
)paren
op_amp
op_complement
l_int|0xf
)paren
(brace
r_continue
suffix:semicolon
)brace
id|s
op_assign
op_amp
id|c-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|s
suffix:semicolon
multiline_comment|/* wait for device to become free */
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
r_while
c_loop
(paren
id|s-&gt;open_mode
op_amp
id|file-&gt;f_mode
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
r_return
op_minus
id|EWOULDBLOCK
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|fmtm
op_and_assign
op_complement
(paren
(paren
id|ESS_FMT_STEREO
op_or
id|ESS_FMT_16BIT
)paren
op_lshift
id|ESS_ADC_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0xf
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|fmts
op_or_assign
id|ESS_FMT_16BIT
op_lshift
id|ESS_ADC_SHIFT
suffix:semicolon
id|s-&gt;dma_adc.ossfragshift
op_assign
id|s-&gt;dma_adc.ossmaxfrags
op_assign
id|s-&gt;dma_adc.subdivision
op_assign
l_int|0
suffix:semicolon
id|set_adc_rate
c_func
(paren
id|s
comma
l_int|8000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|fmtm
op_and_assign
op_complement
(paren
(paren
id|ESS_FMT_STEREO
op_or
id|ESS_FMT_16BIT
)paren
op_lshift
id|ESS_DAC_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|minor
op_amp
l_int|0xf
)paren
op_eq
id|SND_DEV_DSP16
)paren
id|fmts
op_or_assign
id|ESS_FMT_16BIT
op_lshift
id|ESS_DAC_SHIFT
suffix:semicolon
id|s-&gt;dma_dac.ossfragshift
op_assign
id|s-&gt;dma_dac.ossmaxfrags
op_assign
id|s-&gt;dma_dac.subdivision
op_assign
l_int|0
suffix:semicolon
id|set_dac_rate
c_func
(paren
id|s
comma
l_int|8000
)paren
suffix:semicolon
)brace
id|set_fmt
c_func
(paren
id|s
comma
id|fmtm
comma
id|fmts
)paren
suffix:semicolon
id|s-&gt;open_mode
op_or_assign
id|file-&gt;f_mode
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_release
r_static
r_int
id|m3_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
(paren
r_struct
id|m3_state
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|VALIDATE_STATE
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|drain_dac
c_func
(paren
id|s
comma
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_dac.in_lists
)paren
(brace
id|m3_remove_list
c_func
(paren
id|s-&gt;card
comma
op_amp
(paren
id|s-&gt;card-&gt;mixer_list
)paren
comma
id|s-&gt;dma_dac.mixer_index
)paren
suffix:semicolon
id|nuke_lists
c_func
(paren
id|s-&gt;card
comma
op_amp
(paren
id|s-&gt;dma_dac
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_READ
)paren
(brace
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.in_lists
)paren
(brace
id|m3_remove_list
c_func
(paren
id|s-&gt;card
comma
op_amp
(paren
id|s-&gt;card-&gt;adc1_list
)paren
comma
id|s-&gt;dma_adc.adc1_index
)paren
suffix:semicolon
id|nuke_lists
c_func
(paren
id|s-&gt;card
comma
op_amp
(paren
id|s-&gt;dma_adc
)paren
)paren
suffix:semicolon
)brace
)brace
id|s-&gt;open_mode
op_and_assign
(paren
op_complement
id|file-&gt;f_mode
)paren
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|s-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|s-&gt;open_sem
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for the ac97 serial bus to be free.&n; * return nonzero if the bus is still busy.&n; */
DECL|function|m3_ac97_wait
r_static
r_int
id|m3_ac97_wait
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_int
id|i
op_assign
l_int|10000
suffix:semicolon
r_while
c_loop
(paren
(paren
id|m3_inb
c_func
(paren
id|card
comma
l_int|0x30
)paren
op_amp
l_int|1
)paren
op_logical_and
id|i
op_decrement
)paren
(brace
suffix:semicolon
)brace
r_return
id|i
op_eq
l_int|0
suffix:semicolon
)brace
DECL|function|m3_ac97_read
id|u16
id|m3_ac97_read
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
)paren
(brace
id|u16
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|m3_card
op_star
id|card
op_assign
id|codec-&gt;private_data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;ac97_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m3_ac97_wait
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;serial bus busy reading reg 0x%x&bslash;n&quot;
comma
id|reg
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|m3_outb
c_func
(paren
id|card
comma
l_int|0x80
op_or
(paren
id|reg
op_amp
l_int|0x7f
)paren
comma
l_int|0x30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m3_ac97_wait
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;serial bus busy finishing read reg 0x%x&bslash;n&quot;
comma
id|reg
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|m3_inw
c_func
(paren
id|card
comma
l_int|0x32
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPCRAP
comma
l_string|&quot;reading 0x%04x from 0x%02x&bslash;n&quot;
comma
id|ret
comma
id|reg
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;ac97_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|m3_ac97_write
r_void
id|m3_ac97_write
c_func
(paren
r_struct
id|ac97_codec
op_star
id|codec
comma
id|u8
id|reg
comma
id|u16
id|val
)paren
(brace
r_struct
id|m3_card
op_star
id|card
op_assign
id|codec-&gt;private_data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|card-&gt;ac97_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m3_ac97_wait
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;serial bus busy writing 0x%x to 0x%x&bslash;n&quot;
comma
id|val
comma
id|reg
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
id|DPCRAP
comma
l_string|&quot;writing 0x%04x  to  0x%02x&bslash;n&quot;
comma
id|val
comma
id|reg
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
id|val
comma
l_int|0x32
)paren
suffix:semicolon
id|m3_outb
c_func
(paren
id|card
comma
id|reg
op_amp
l_int|0x7f
comma
l_int|0x30
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|card-&gt;ac97_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* OSS /dev/mixer file operation methods */
DECL|function|m3_open_mixdev
r_static
r_int
id|m3_open_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_struct
id|m3_card
op_star
id|card
op_assign
id|devs
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
id|devs
suffix:semicolon
id|card
op_ne
l_int|NULL
suffix:semicolon
id|card
op_assign
id|card-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|card-&gt;ac97
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|card-&gt;ac97-&gt;dev_mixer
op_eq
id|minor
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|file-&gt;private_data
op_assign
id|card-&gt;ac97
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_release_mixdev
r_static
r_int
id|m3_release_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_ioctl_mixdev
r_static
r_int
id|m3_ioctl_mixdev
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
op_assign
(paren
r_struct
id|ac97_codec
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_return
id|codec
op_member_access_from_pointer
id|mixer_ioctl
c_func
(paren
id|codec
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|variable|m3_mixer_fops
r_static
r_struct
id|file_operations
id|m3_mixer_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
id|no_llseek
comma
id|ioctl
suffix:colon
id|m3_ioctl_mixdev
comma
id|open
suffix:colon
id|m3_open_mixdev
comma
id|release
suffix:colon
id|m3_release_mixdev
comma
)brace
suffix:semicolon
DECL|function|remote_codec_config
r_void
id|remote_codec_config
c_func
(paren
r_int
id|io
comma
r_int
id|isremote
)paren
(brace
id|isremote
op_assign
id|isremote
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
id|io
op_plus
id|RING_BUS_CTRL_B
)paren
op_amp
op_complement
id|SECOND_CODEC_ID_MASK
)paren
op_or
id|isremote
comma
id|io
op_plus
id|RING_BUS_CTRL_B
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
id|io
op_plus
id|SDO_OUT_DEST_CTRL
)paren
op_amp
op_complement
id|COMMAND_ADDR_OUT
)paren
op_or
id|isremote
comma
id|io
op_plus
id|SDO_OUT_DEST_CTRL
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|inw
c_func
(paren
id|io
op_plus
id|SDO_IN_DEST_CTRL
)paren
op_amp
op_complement
id|STATUS_ADDR_IN
)paren
op_or
id|isremote
comma
id|io
op_plus
id|SDO_IN_DEST_CTRL
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * hack, returns non zero on err &n; */
DECL|function|try_read_vendor
r_static
r_int
id|try_read_vendor
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
id|u16
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|m3_ac97_wait
c_func
(paren
id|card
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|m3_outb
c_func
(paren
id|card
comma
l_int|0x80
op_or
(paren
id|AC97_VENDOR_ID1
op_amp
l_int|0x7f
)paren
comma
l_int|0x30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m3_ac97_wait
c_func
(paren
id|card
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|ret
op_assign
id|m3_inw
c_func
(paren
id|card
comma
l_int|0x32
)paren
suffix:semicolon
r_return
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_or
(paren
id|ret
op_eq
l_int|0xffff
)paren
suffix:semicolon
)brace
DECL|function|m3_codec_reset
r_static
r_void
id|m3_codec_reset
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_int
id|busywait
)paren
(brace
id|u16
id|dir
suffix:semicolon
r_int
id|delay1
op_assign
l_int|0
comma
id|delay2
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_int
id|io
op_assign
id|card-&gt;iobase
suffix:semicolon
r_switch
c_cond
(paren
id|card-&gt;card_type
)paren
(brace
multiline_comment|/*&n;         * the onboard codec on the allegro seems &n;         * to want to wait a very long time before&n;         * coming back to life &n;         */
r_case
id|ESS_ALLEGRO
suffix:colon
id|delay1
op_assign
l_int|50
suffix:semicolon
id|delay2
op_assign
l_int|800
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ESS_MAESTRO3
suffix:colon
r_case
id|ESS_MAESTRO3HW
suffix:colon
id|delay1
op_assign
l_int|20
suffix:semicolon
id|delay2
op_assign
l_int|500
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|dir
op_assign
id|inw
c_func
(paren
id|io
op_plus
id|GPIO_DIRECTION
)paren
suffix:semicolon
id|dir
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* assuming pci bus master? */
id|remote_codec_config
c_func
(paren
id|io
comma
l_int|0
)paren
suffix:semicolon
id|outw
c_func
(paren
id|IO_SRAM_ENABLE
comma
id|io
op_plus
id|RING_BUS_CTRL_A
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outw
c_func
(paren
id|dir
op_amp
op_complement
id|GPO_PRIMARY_AC97
comma
id|io
op_plus
id|GPIO_DIRECTION
)paren
suffix:semicolon
id|outw
c_func
(paren
op_complement
id|GPO_PRIMARY_AC97
comma
id|io
op_plus
id|GPIO_MASK
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0
comma
id|io
op_plus
id|GPIO_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
id|dir
op_or
id|GPO_PRIMARY_AC97
comma
id|io
op_plus
id|GPIO_DIRECTION
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busywait
)paren
(brace
id|mdelay
c_func
(paren
id|delay1
)paren
suffix:semicolon
)brace
r_else
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
(paren
id|delay1
op_star
id|HZ
)paren
op_div
l_int|1000
)paren
suffix:semicolon
)brace
id|outw
c_func
(paren
id|GPO_PRIMARY_AC97
comma
id|io
op_plus
id|GPIO_DATA
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
multiline_comment|/* ok, bring back the ac-link */
id|outw
c_func
(paren
id|IO_SRAM_ENABLE
op_or
id|SERIAL_AC_LINK_ENABLE
comma
id|io
op_plus
id|RING_BUS_CTRL_A
)paren
suffix:semicolon
id|outw
c_func
(paren
op_complement
l_int|0
comma
id|io
op_plus
id|GPIO_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busywait
)paren
(brace
id|mdelay
c_func
(paren
id|delay2
)paren
suffix:semicolon
)brace
r_else
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
(paren
id|delay2
op_star
id|HZ
)paren
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|try_read_vendor
c_func
(paren
id|card
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|delay1
op_add_assign
l_int|10
suffix:semicolon
id|delay2
op_add_assign
l_int|100
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;retrying codec reset with delays of %d and %d ms&bslash;n&quot;
comma
id|delay1
comma
id|delay2
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* more gung-ho reset that doesn&squot;t&n;     * seem to work anywhere :)&n;     */
id|tmp
op_assign
id|inw
c_func
(paren
id|io
op_plus
id|RING_BUS_CTRL_A
)paren
suffix:semicolon
id|outw
c_func
(paren
id|RAC_SDFS_ENABLE
op_or
id|LAC_SDFS_ENABLE
comma
id|io
op_plus
id|RING_BUS_CTRL_A
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|outw
c_func
(paren
id|tmp
comma
id|io
op_plus
id|RING_BUS_CTRL_A
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|m3_codec_install
r_static
r_int
id|__init
id|m3_codec_install
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_struct
id|ac97_codec
op_star
id|codec
suffix:semicolon
r_if
c_cond
(paren
(paren
id|codec
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ac97_codec
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|codec
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ac97_codec
)paren
)paren
suffix:semicolon
id|codec-&gt;private_data
op_assign
id|card
suffix:semicolon
id|codec-&gt;codec_read
op_assign
id|m3_ac97_read
suffix:semicolon
id|codec-&gt;codec_write
op_assign
id|m3_ac97_write
suffix:semicolon
multiline_comment|/* someday we should support secondary codecs.. */
id|codec-&gt;id
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ac97_probe_codec
c_func
(paren
id|codec
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;codec probe failed&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|codec
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|codec-&gt;dev_mixer
op_assign
id|register_sound_mixer
c_func
(paren
op_amp
id|m3_mixer_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;couldn&squot;t register mixer!&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|codec
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|card-&gt;ac97
op_assign
id|codec
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|MINISRC_LPF_LEN
mdefine_line|#define MINISRC_LPF_LEN 10
DECL|variable|minisrc_lpf
r_static
id|u16
id|minisrc_lpf
(braket
id|MINISRC_LPF_LEN
)braket
op_assign
(brace
l_int|0X0743
comma
l_int|0X1104
comma
l_int|0X0A4C
comma
l_int|0XF88D
comma
l_int|0X242C
comma
l_int|0X1023
comma
l_int|0X1AA9
comma
l_int|0X0B60
comma
l_int|0XEFDD
comma
l_int|0X186F
)brace
suffix:semicolon
DECL|function|m3_assp_init
r_static
r_void
id|m3_assp_init
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* zero kernel data */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|REV_B_DATA_MEMORY_UNIT_LENGTH
op_star
id|NUM_UNITS_KERNEL_DATA
)paren
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_BASE_ADDR
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* zero mixer data? */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|REV_B_DATA_MEMORY_UNIT_LENGTH
op_star
id|NUM_UNITS_KERNEL_DATA
)paren
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_BASE_ADDR2
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* init dma pointer */
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_CURRENT_DMA
comma
id|KDATA_DMA_XFER0
)paren
suffix:semicolon
multiline_comment|/* write kernel into code memory.. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|assp_kernel_image
)paren
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_CODE
comma
id|REV_B_CODE_MEMORY_BEGIN
op_plus
id|i
comma
id|assp_kernel_image
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * We only have this one client and we know that 0x400&n;     * is free in our kernel&squot;s mem map, so lets just&n;     * drop it there.  It seems that the minisrc doesn&squot;t&n;     * need vectors, so we won&squot;t bother with them..&n;     */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|assp_minisrc_image
)paren
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_CODE
comma
l_int|0x400
op_plus
id|i
comma
id|assp_minisrc_image
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;     * write the coefficients for the low pass filter?&n;     */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MINISRC_LPF_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_CODE
comma
l_int|0x400
op_plus
id|MINISRC_COEF_LOC
op_plus
id|i
comma
id|minisrc_lpf
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_CODE
comma
l_int|0x400
op_plus
id|MINISRC_COEF_LOC
op_plus
id|MINISRC_LPF_LEN
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/*&n;     * the minisrc is the only thing on&n;     * our task list..&n;     */
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_TASK0
comma
l_int|0x400
)paren
suffix:semicolon
multiline_comment|/*&n;     * init the mixer number..&n;     */
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_MIXER_TASK_NUMBER
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;     * EXTREME KERNEL MASTER VOLUME&n;     */
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_DAC_LEFT_VOLUME
comma
id|ARB_VOLUME
)paren
suffix:semicolon
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_DAC_RIGHT_VOLUME
comma
id|ARB_VOLUME
)paren
suffix:semicolon
id|card-&gt;mixer_list.mem_addr
op_assign
id|KDATA_MIXER_XFER0
suffix:semicolon
id|card-&gt;mixer_list.max
op_assign
id|MAX_VIRTUAL_MIXER_CHANNELS
suffix:semicolon
id|card-&gt;adc1_list.mem_addr
op_assign
id|KDATA_ADC1_XFER0
suffix:semicolon
id|card-&gt;adc1_list.max
op_assign
id|MAX_VIRTUAL_ADC1_CHANNELS
suffix:semicolon
id|card-&gt;dma_list.mem_addr
op_assign
id|KDATA_DMA_XFER0
suffix:semicolon
id|card-&gt;dma_list.max
op_assign
id|MAX_VIRTUAL_DMA_CHANNELS
suffix:semicolon
id|card-&gt;msrc_list.mem_addr
op_assign
id|KDATA_INSTANCE0_MINISRC
suffix:semicolon
id|card-&gt;msrc_list.max
op_assign
id|MAX_INSTANCE_MINISRC
suffix:semicolon
)brace
DECL|function|setup_msrc
r_static
r_int
id|setup_msrc
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_struct
id|assp_instance
op_star
id|inst
comma
r_int
id|index
)paren
(brace
r_int
id|data_bytes
op_assign
l_int|2
op_star
(paren
id|MINISRC_TMP_BUFFER_SIZE
op_div
l_int|2
op_plus
id|MINISRC_IN_BUFFER_SIZE
op_div
l_int|2
op_plus
l_int|1
op_plus
id|MINISRC_OUT_BUFFER_SIZE
op_div
l_int|2
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|address
comma
id|i
suffix:semicolon
multiline_comment|/*&n;     * the revb memory map has 0x1100 through 0x1c00&n;     * free.  &n;     */
multiline_comment|/*&n;     * align instance address to 256 bytes so that it&squot;s&n;     * shifted list address is aligned.  &n;     * list address = (mem address &gt;&gt; 1) &gt;&gt; 7;&n;     */
id|data_bytes
op_assign
(paren
id|data_bytes
op_plus
l_int|255
)paren
op_amp
op_complement
l_int|255
suffix:semicolon
id|address
op_assign
l_int|0x1100
op_plus
(paren
(paren
id|data_bytes
op_div
l_int|2
)paren
op_star
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|address
op_plus
(paren
id|data_bytes
op_div
l_int|2
)paren
)paren
op_ge
l_int|0x1c00
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;no memory for %d bytes at ind %d (addr 0x%x)&bslash;n&quot;
comma
id|data_bytes
comma
id|index
comma
id|address
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data_bytes
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|address
op_plus
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
id|inst-&gt;code
op_assign
l_int|0x400
suffix:semicolon
id|inst-&gt;data
op_assign
id|address
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_assp_client_init
r_static
r_int
id|m3_assp_client_init
c_func
(paren
r_struct
id|m3_state
op_star
id|s
)paren
(brace
id|setup_msrc
c_func
(paren
id|s-&gt;card
comma
op_amp
(paren
id|s-&gt;dac_inst
)paren
comma
id|s-&gt;index
op_star
l_int|2
)paren
suffix:semicolon
id|setup_msrc
c_func
(paren
id|s-&gt;card
comma
op_amp
(paren
id|s-&gt;adc_inst
)paren
comma
(paren
id|s-&gt;index
op_star
l_int|2
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_amp_enable
r_static
r_void
id|m3_amp_enable
c_func
(paren
r_struct
id|m3_card
op_star
id|card
comma
r_int
id|enable
)paren
(brace
multiline_comment|/* &n;     * this works for the reference board, have to find&n;     * out about others&n;     *&n;     * this needs more magic for 4 speaker, but..&n;     */
r_int
id|io
op_assign
id|card-&gt;iobase
suffix:semicolon
id|u16
id|gpo
comma
id|polarity_port
comma
id|polarity
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|external_amp
)paren
(brace
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|card-&gt;card_type
)paren
(brace
r_case
id|ESS_ALLEGRO
suffix:colon
id|polarity_port
op_assign
l_int|0x1800
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* presumably this is for all &squot;maestro3&squot;s.. */
id|polarity_port
op_assign
l_int|0x1100
suffix:semicolon
r_break
suffix:semicolon
)brace
id|gpo
op_assign
(paren
id|polarity_port
op_rshift
l_int|8
)paren
op_amp
l_int|0x0F
suffix:semicolon
id|polarity
op_assign
id|polarity_port
op_rshift
l_int|12
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
id|polarity
op_assign
op_logical_neg
id|polarity
suffix:semicolon
id|polarity
op_assign
id|polarity
op_lshift
id|gpo
suffix:semicolon
id|gpo
op_assign
l_int|1
op_lshift
id|gpo
suffix:semicolon
id|outw
c_func
(paren
op_complement
id|gpo
comma
id|io
op_plus
id|GPIO_MASK
)paren
suffix:semicolon
id|outw
c_func
(paren
id|inw
c_func
(paren
id|io
op_plus
id|GPIO_DIRECTION
)paren
op_or
id|gpo
comma
id|io
op_plus
id|GPIO_DIRECTION
)paren
suffix:semicolon
id|outw
c_func
(paren
(paren
id|GPO_SECONDARY_AC97
op_or
id|GPO_PRIMARY_AC97
op_or
id|polarity
)paren
comma
id|io
op_plus
id|GPIO_DATA
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0xffff
comma
id|io
op_plus
id|GPIO_MASK
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|maestro_config
id|maestro_config
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_struct
id|pci_dev
op_star
id|pcidev
op_assign
id|card-&gt;pcidev
suffix:semicolon
id|u32
id|n
suffix:semicolon
id|u8
id|t
suffix:semicolon
multiline_comment|/* makes as much sense as &squot;n&squot;, no? */
id|pci_read_config_dword
c_func
(paren
id|pcidev
comma
id|PCI_ALLEGRO_CONFIG
comma
op_amp
id|n
)paren
suffix:semicolon
id|n
op_and_assign
id|REDUCED_DEBOUNCE
suffix:semicolon
id|n
op_or_assign
id|PM_CTRL_ENABLE
op_or
id|CLK_DIV_BY_49
op_or
id|USE_PCI_TIMING
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pcidev
comma
id|PCI_ALLEGRO_CONFIG
comma
id|n
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RESET_ASSP
comma
id|card-&gt;iobase
op_plus
id|ASSP_CONTROL_B
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pcidev
comma
id|PCI_ALLEGRO_CONFIG
comma
op_amp
id|n
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
id|INT_CLK_SELECT
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;card_type
op_ge
id|ESS_MAESTRO3
)paren
(brace
id|n
op_and_assign
op_complement
id|INT_CLK_MULT_ENABLE
suffix:semicolon
id|n
op_or_assign
id|INT_CLK_SRC_NOT_PCI
suffix:semicolon
)brace
id|n
op_and_assign
op_complement
(paren
id|CLK_MULT_MODE_SELECT
op_or
id|CLK_MULT_MODE_SELECT_2
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pcidev
comma
id|PCI_ALLEGRO_CONFIG
comma
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;card_type
op_le
id|ESS_ALLEGRO
)paren
(brace
id|pci_read_config_dword
c_func
(paren
id|pcidev
comma
id|PCI_USER_CONFIG
comma
op_amp
id|n
)paren
suffix:semicolon
id|n
op_or_assign
id|IN_CLK_12MHZ_SELECT
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pcidev
comma
id|PCI_USER_CONFIG
comma
id|n
)paren
suffix:semicolon
)brace
id|t
op_assign
id|inb
c_func
(paren
id|card-&gt;iobase
op_plus
id|ASSP_CONTROL_A
)paren
suffix:semicolon
id|t
op_and_assign
op_complement
(paren
id|DSP_CLK_36MHZ_SELECT
op_or
id|ASSP_CLK_49MHZ_SELECT
)paren
suffix:semicolon
id|t
op_or_assign
id|ASSP_CLK_49MHZ_SELECT
suffix:semicolon
id|t
op_or_assign
id|ASSP_0_WS_ENABLE
suffix:semicolon
id|outb
c_func
(paren
id|t
comma
id|card-&gt;iobase
op_plus
id|ASSP_CONTROL_A
)paren
suffix:semicolon
id|outb
c_func
(paren
id|RUN_ASSP
comma
id|card-&gt;iobase
op_plus
id|ASSP_CONTROL_B
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_enable_ints
r_static
r_void
id|m3_enable_ints
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_int
r_int
id|io
op_assign
id|card-&gt;iobase
suffix:semicolon
id|outw
c_func
(paren
id|ASSP_INT_ENABLE
comma
id|io
op_plus
id|HOST_INT_CTRL
)paren
suffix:semicolon
id|outb
c_func
(paren
id|inb
c_func
(paren
id|io
op_plus
id|ASSP_CONTROL_C
)paren
op_or
id|ASSP_HOST_INT_ENABLE
comma
id|io
op_plus
id|ASSP_CONTROL_C
)paren
suffix:semicolon
)brace
DECL|variable|m3_audio_fops
r_static
r_struct
id|file_operations
id|m3_audio_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|llseek
suffix:colon
op_amp
id|no_llseek
comma
id|read
suffix:colon
op_amp
id|m3_read
comma
id|write
suffix:colon
op_amp
id|m3_write
comma
id|poll
suffix:colon
op_amp
id|m3_poll
comma
id|ioctl
suffix:colon
op_amp
id|m3_ioctl
comma
id|mmap
suffix:colon
op_amp
id|m3_mmap
comma
id|open
suffix:colon
op_amp
id|m3_open
comma
id|release
suffix:colon
op_amp
id|m3_release
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PM
DECL|function|alloc_dsp_suspendmem
r_int
id|alloc_dsp_suspendmem
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_int
id|len
op_assign
r_sizeof
(paren
id|u16
)paren
op_star
(paren
id|REV_B_CODE_MEMORY_LENGTH
op_plus
id|REV_B_DATA_MEMORY_LENGTH
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card-&gt;suspend_mem
op_assign
id|vmalloc
c_func
(paren
id|len
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_dsp_suspendmem
r_void
id|free_dsp_suspendmem
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;suspend_mem
)paren
(brace
id|vfree
c_func
(paren
id|card-&gt;suspend_mem
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
DECL|macro|alloc_dsp_suspendmem
mdefine_line|#define alloc_dsp_suspendmem(args...) 0
DECL|macro|free_dsp_suspendmem
mdefine_line|#define free_dsp_suspendmem(args...) 
macro_line|#endif
multiline_comment|/*&n; * great day!  this function is ugly as hell.&n; */
DECL|function|m3_probe
r_static
r_int
id|__init
id|m3_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pci_id
)paren
(brace
id|u32
id|n
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|m3_card
op_star
id|card
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|card_type
op_assign
id|pci_id-&gt;driver_data
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;in maestro_install&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pci_dev
comma
id|M3_PCI_DMA_MASK
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;architecture does not support limiting to 28bit PCI bus addresses&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|m3_card
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|card
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|m3_card
)paren
)paren
suffix:semicolon
id|card-&gt;pcidev
op_assign
id|pci_dev
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|card-&gt;suspend_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
comma
id|pci_resource_len
(paren
id|pci_dev
comma
l_int|0
)paren
comma
id|M3_MODULE_NAME
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;unable to reserve I/O space.&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|card-&gt;iobase
op_assign
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alloc_dsp_suspendmem
c_func
(paren
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;couldn&squot;t alloc %d bytes for saving dsp state on suspend&bslash;n&quot;
comma
id|REV_B_CODE_MEMORY_LENGTH
op_plus
id|REV_B_DATA_MEMORY_LENGTH
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|card-&gt;card_type
op_assign
id|card_type
suffix:semicolon
id|card-&gt;irq
op_assign
id|pci_dev-&gt;irq
suffix:semicolon
id|card-&gt;next
op_assign
id|devs
suffix:semicolon
id|card-&gt;magic
op_assign
id|M3_CARD_MAGIC
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;ac97_lock
)paren
suffix:semicolon
id|devs
op_assign
id|card
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
op_amp
(paren
id|card-&gt;channels
(braket
id|i
)braket
)paren
suffix:semicolon
id|s-&gt;dev_audio
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Configuring ESS %s found at IO 0x%04X IRQ %d&bslash;n&quot;
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
id|card-&gt;iobase
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_SUBSYSTEM_VENDOR_ID
comma
op_amp
id|n
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot; subvendor id: 0x%08x&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
id|maestro_config
c_func
(paren
id|card
)paren
suffix:semicolon
id|m3_assp_halt
c_func
(paren
id|card
)paren
suffix:semicolon
id|m3_codec_reset
c_func
(paren
id|card
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|m3_codec_install
c_func
(paren
id|card
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|m3_assp_init
c_func
(paren
id|card
)paren
suffix:semicolon
id|m3_amp_enable
c_func
(paren
id|card
comma
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
id|s-&gt;index
op_assign
id|i
suffix:semicolon
id|s-&gt;card
op_assign
id|card
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;dma_adc.wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;dma_dac.wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;open_wait
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|s-&gt;lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
(paren
id|s-&gt;open_sem
)paren
)paren
suffix:semicolon
id|s-&gt;magic
op_assign
id|M3_STATE_MAGIC
suffix:semicolon
id|m3_assp_client_init
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dma_adc.ready
op_logical_or
id|s-&gt;dma_dac.ready
op_logical_or
id|s-&gt;dma_adc.rawbuf
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;initing a dsp device that is already in use?&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* register devices */
r_if
c_cond
(paren
(paren
id|s-&gt;dev_audio
op_assign
id|register_sound_dsp
c_func
(paren
op_amp
id|m3_audio_fops
comma
op_minus
l_int|1
)paren
)paren
OL
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|allocate_dmabuf
c_func
(paren
id|card-&gt;pcidev
comma
op_amp
(paren
id|s-&gt;dma_adc
)paren
)paren
op_logical_or
id|allocate_dmabuf
c_func
(paren
id|card-&gt;pcidev
comma
op_amp
(paren
id|s-&gt;dma_dac
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|card-&gt;irq
comma
id|m3_interrupt
comma
id|SA_SHIRQ
comma
id|card_names
(braket
id|card-&gt;card_type
)braket
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;unable to allocate irq %d,&bslash;n&quot;
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
id|card
)paren
suffix:semicolon
id|m3_enable_ints
c_func
(paren
id|card
)paren
suffix:semicolon
id|m3_assp_continue
c_func
(paren
id|card
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;iobase
)paren
(brace
id|release_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pci_dev
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
id|free_dsp_suspendmem
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;ac97
)paren
(brace
id|unregister_sound_mixer
c_func
(paren
id|card-&gt;ac97-&gt;dev_mixer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card-&gt;ac97
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dev_audio
op_ne
op_minus
l_int|1
)paren
(brace
id|unregister_sound_dsp
c_func
(paren
id|s-&gt;dev_audio
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|m3_remove
r_static
r_void
id|m3_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|m3_card
op_star
id|card
suffix:semicolon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|m3_reboot_nb
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|card
op_assign
id|devs
)paren
)paren
(brace
r_int
id|i
suffix:semicolon
id|devs
op_assign
id|devs-&gt;next
suffix:semicolon
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
id|unregister_sound_mixer
c_func
(paren
id|card-&gt;ac97-&gt;dev_mixer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card-&gt;ac97
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dev_audio
OL
l_int|0
)paren
(brace
r_continue
suffix:semicolon
)brace
id|unregister_sound_dsp
c_func
(paren
id|s-&gt;dev_audio
)paren
suffix:semicolon
id|free_dmabuf
c_func
(paren
id|card-&gt;pcidev
comma
op_amp
id|s-&gt;dma_adc
)paren
suffix:semicolon
id|free_dmabuf
c_func
(paren
id|card-&gt;pcidev
comma
op_amp
id|s-&gt;dma_dac
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|card-&gt;iobase
comma
l_int|256
)paren
suffix:semicolon
id|free_dsp_suspendmem
c_func
(paren
id|card
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|devs
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * some bioses like the sound chip to be powered down&n; * at shutdown.  We&squot;re just calling _suspend to&n; * achieve that..&n; */
DECL|function|m3_notifier
r_static
r_int
id|m3_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|event
comma
r_void
op_star
id|buf
)paren
(brace
r_struct
id|m3_card
op_star
id|card
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;notifier suspending all cards&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
id|devs
suffix:semicolon
id|card
op_ne
l_int|NULL
suffix:semicolon
id|card
op_assign
id|card-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;in_suspend
)paren
(brace
id|m3_suspend
c_func
(paren
id|card-&gt;pcidev
comma
l_int|3
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX legal? */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_suspend
r_static
r_int
id|m3_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
id|u32
id|state
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|m3_card
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
multiline_comment|/* must be a better way.. */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;pm in dev %p&bslash;n&quot;
comma
id|card
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dev_audio
op_eq
op_minus
l_int|1
)paren
(brace
r_continue
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;stop_adc/dac() device %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|stop_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|stop_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* give the assp a chance to idle.. */
id|m3_assp_halt
c_func
(paren
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;suspend_mem
)paren
(brace
r_int
id|index
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;saving code&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|REV_B_CODE_MEMORY_BEGIN
suffix:semicolon
id|i
op_le
id|REV_B_CODE_MEMORY_END
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;suspend_mem
(braket
id|index
op_increment
)braket
op_assign
id|m3_assp_read
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_CODE
comma
id|i
)paren
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;saving data&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|REV_B_DATA_MEMORY_BEGIN
suffix:semicolon
id|i
op_le
id|REV_B_DATA_MEMORY_END
suffix:semicolon
id|i
op_increment
)paren
(brace
id|card-&gt;suspend_mem
(braket
id|index
op_increment
)braket
op_assign
id|m3_assp_read
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|i
)paren
suffix:semicolon
)brace
)brace
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;powering down apci regs&bslash;n&quot;
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
l_int|0xffff
comma
l_int|0x54
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
l_int|0xffff
comma
l_int|0x56
)paren
suffix:semicolon
id|card-&gt;in_suspend
op_assign
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_resume
r_static
r_int
id|m3_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|index
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|m3_card
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* paranoia */
id|cli
c_func
(paren
)paren
suffix:semicolon
id|card-&gt;in_suspend
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;resuming&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* first lets just bring everything back. .*/
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;bringing power back on card 0x%p&bslash;n&quot;
comma
id|card
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
l_int|0
comma
l_int|0x54
)paren
suffix:semicolon
id|m3_outw
c_func
(paren
id|card
comma
l_int|0
comma
l_int|0x56
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;restoring pci configs and reseting codec&bslash;n&quot;
)paren
suffix:semicolon
id|maestro_config
c_func
(paren
id|card
)paren
suffix:semicolon
id|m3_assp_halt
c_func
(paren
id|card
)paren
suffix:semicolon
id|m3_codec_reset
c_func
(paren
id|card
comma
l_int|1
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;restoring dsp code card&bslash;n&quot;
)paren
suffix:semicolon
id|index
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|REV_B_CODE_MEMORY_BEGIN
suffix:semicolon
id|i
op_le
id|REV_B_CODE_MEMORY_END
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_CODE
comma
id|i
comma
id|card-&gt;suspend_mem
(braket
id|index
op_increment
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|REV_B_DATA_MEMORY_BEGIN
suffix:semicolon
id|i
op_le
id|REV_B_DATA_MEMORY_END
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|i
comma
id|card-&gt;suspend_mem
(braket
id|index
op_increment
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* tell the dma engine to restart itself */
id|m3_assp_write
c_func
(paren
id|card
comma
id|MEMTYPE_INTERNAL_DATA
comma
id|KDATA_DMA_ACTIVE
comma
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;resuming dsp&bslash;n&quot;
)paren
suffix:semicolon
id|m3_assp_continue
c_func
(paren
id|card
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;enabling ints&bslash;n&quot;
)paren
suffix:semicolon
id|m3_enable_ints
c_func
(paren
id|card
)paren
suffix:semicolon
multiline_comment|/* bring back the old school flavor */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SOUND_MIXER_NRDEVICES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|state
op_assign
id|card-&gt;ac97-&gt;mixer_state
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supported_mixer
c_func
(paren
id|card-&gt;ac97
comma
id|i
)paren
)paren
r_continue
suffix:semicolon
id|card-&gt;ac97
op_member_access_from_pointer
id|write_mixer
c_func
(paren
id|card-&gt;ac97
comma
id|i
comma
id|state
op_amp
l_int|0xff
comma
(paren
id|state
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
id|m3_amp_enable
c_func
(paren
id|card
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* &n;     * now we flip on the music &n;     */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_DSPS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|m3_state
op_star
id|s
op_assign
op_amp
id|card-&gt;channels
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;dev_audio
op_eq
op_minus
l_int|1
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;         * db-&gt;ready makes it so these guys can be&n;         * called unconditionally..&n;         */
id|DPRINTK
c_func
(paren
id|DPMOD
comma
l_string|&quot;turning on dacs ind %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|start_dac
c_func
(paren
id|s
)paren
suffix:semicolon
id|start_adc
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* &n;     * all right, we think things are ready, &n;     * wake up people who were using the device &n;     * when we suspended&n;     */
id|wake_up
c_func
(paren
op_amp
id|card-&gt;suspend_queue
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Zach Brown &lt;zab@zabbo.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ESS Maestro3/Allegro Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifdef M_DEBUG
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|external_amp
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|m3_pci_driver
r_static
r_struct
id|pci_driver
id|m3_pci_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ess_m3_audio&quot;
comma
id|id_table
suffix:colon
id|m3_id_table
comma
id|probe
suffix:colon
id|m3_probe
comma
id|remove
suffix:colon
id|m3_remove
comma
id|suspend
suffix:colon
id|m3_suspend
comma
id|resume
suffix:colon
id|m3_resume
comma
)brace
suffix:semicolon
DECL|function|m3_init_module
r_static
r_int
id|__init
id|m3_init_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pci_present
c_func
(paren
)paren
)paren
multiline_comment|/* No PCI bus in this machine! */
r_return
op_minus
id|ENODEV
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;version &quot;
id|DRIVER_VERSION
l_string|&quot; built at &quot;
id|__TIME__
l_string|&quot; &quot;
id|__DATE__
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_reboot_notifier
c_func
(paren
op_amp
id|m3_reboot_nb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;reboot notifier registration failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* ? */
)brace
r_if
c_cond
(paren
op_logical_neg
id|pci_register_driver
c_func
(paren
op_amp
id|m3_pci_driver
)paren
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|m3_pci_driver
)paren
suffix:semicolon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|m3_reboot_nb
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|m3_cleanup_module
r_static
r_void
id|__exit
id|m3_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|m3_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|m3_init_module
id|module_init
c_func
(paren
id|m3_init_module
)paren
suffix:semicolon
DECL|variable|m3_cleanup_module
id|module_exit
c_func
(paren
id|m3_cleanup_module
)paren
suffix:semicolon
DECL|function|check_suspend
r_void
id|check_suspend
c_func
(paren
r_struct
id|m3_card
op_star
id|card
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;in_suspend
)paren
(brace
r_return
suffix:semicolon
)brace
id|card-&gt;in_suspend
op_increment
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|card-&gt;suspend_queue
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|card-&gt;suspend_queue
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
)brace
eof
