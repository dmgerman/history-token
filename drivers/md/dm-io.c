multiline_comment|/*&n; * Copyright (C) 2003 Sistina Software&n; *&n; * This file is released under the GPL.&n; */
macro_line|#include &quot;dm-io.h&quot;
macro_line|#include &lt;linux/bio.h&gt;
macro_line|#include &lt;linux/mempool.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
DECL|macro|BIO_POOL_SIZE
mdefine_line|#define BIO_POOL_SIZE 256
multiline_comment|/*-----------------------------------------------------------------&n; * Bio set, move this to bio.c&n; *---------------------------------------------------------------*/
DECL|macro|BV_NAME_SIZE
mdefine_line|#define BV_NAME_SIZE 16
DECL|struct|biovec_pool
r_struct
id|biovec_pool
(brace
DECL|member|nr_vecs
r_int
id|nr_vecs
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
id|BV_NAME_SIZE
)braket
suffix:semicolon
DECL|member|slab
id|kmem_cache_t
op_star
id|slab
suffix:semicolon
DECL|member|pool
id|mempool_t
op_star
id|pool
suffix:semicolon
DECL|member|allocated
id|atomic_t
id|allocated
suffix:semicolon
multiline_comment|/* FIXME: debug */
)brace
suffix:semicolon
DECL|macro|BIOVEC_NR_POOLS
mdefine_line|#define BIOVEC_NR_POOLS 6
DECL|struct|bio_set
r_struct
id|bio_set
(brace
DECL|member|name
r_char
id|name
(braket
id|BV_NAME_SIZE
)braket
suffix:semicolon
DECL|member|bio_slab
id|kmem_cache_t
op_star
id|bio_slab
suffix:semicolon
DECL|member|bio_pool
id|mempool_t
op_star
id|bio_pool
suffix:semicolon
DECL|member|pools
r_struct
id|biovec_pool
id|pools
(braket
id|BIOVEC_NR_POOLS
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|bio_set_exit
r_static
r_void
id|bio_set_exit
c_func
(paren
r_struct
id|bio_set
op_star
id|bs
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|biovec_pool
op_star
id|bp
suffix:semicolon
r_if
c_cond
(paren
id|bs-&gt;bio_pool
)paren
id|mempool_destroy
c_func
(paren
id|bs-&gt;bio_pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bs-&gt;bio_slab
)paren
id|kmem_cache_destroy
c_func
(paren
id|bs-&gt;bio_slab
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BIOVEC_NR_POOLS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bp
op_assign
id|bs-&gt;pools
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;pool
)paren
id|mempool_destroy
c_func
(paren
id|bp-&gt;pool
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bp-&gt;slab
)paren
id|kmem_cache_destroy
c_func
(paren
id|bp-&gt;slab
)paren
suffix:semicolon
)brace
)brace
DECL|function|mk_name
r_static
r_void
id|mk_name
c_func
(paren
r_char
op_star
id|str
comma
r_int
id|len
comma
r_const
r_char
op_star
id|prefix
comma
r_int
id|count
)paren
(brace
id|snprintf
c_func
(paren
id|str
comma
id|len
comma
l_string|&quot;%s-%u&quot;
comma
id|prefix
comma
id|count
)paren
suffix:semicolon
)brace
DECL|function|bio_set_init
r_static
r_int
id|bio_set_init
c_func
(paren
r_struct
id|bio_set
op_star
id|bs
comma
r_const
r_char
op_star
id|slab_prefix
comma
r_int
id|pool_entries
comma
r_int
id|scale
)paren
(brace
multiline_comment|/* FIXME: this must match bvec_index(), why not go the&n;&t; * whole hog and have a pool per power of 2 ? */
r_static
r_int
id|_vec_lengths
(braket
id|BIOVEC_NR_POOLS
)braket
op_assign
(brace
l_int|1
comma
l_int|4
comma
l_int|16
comma
l_int|64
comma
l_int|128
comma
id|BIO_MAX_PAGES
)brace
suffix:semicolon
r_int
id|i
comma
id|size
suffix:semicolon
r_struct
id|biovec_pool
op_star
id|bp
suffix:semicolon
multiline_comment|/* zero the bs so we can tear down properly on error */
id|memset
c_func
(paren
id|bs
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|bs
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up the bio pool.&n;&t; */
id|snprintf
c_func
(paren
id|bs-&gt;name
comma
r_sizeof
(paren
id|bs-&gt;name
)paren
comma
l_string|&quot;%s-bio&quot;
comma
id|slab_prefix
)paren
suffix:semicolon
id|bs-&gt;bio_slab
op_assign
id|kmem_cache_create
c_func
(paren
id|bs-&gt;name
comma
r_sizeof
(paren
r_struct
id|bio
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bs-&gt;bio_slab
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;can&squot;t init bio slab&quot;
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
id|bs-&gt;bio_pool
op_assign
id|mempool_create
c_func
(paren
id|pool_entries
comma
id|mempool_alloc_slab
comma
id|mempool_free_slab
comma
id|bs-&gt;bio_slab
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bs-&gt;bio_pool
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;can&squot;t init bio pool&quot;
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set up the biovec pools.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BIOVEC_NR_POOLS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bp
op_assign
id|bs-&gt;pools
op_plus
id|i
suffix:semicolon
id|bp-&gt;nr_vecs
op_assign
id|_vec_lengths
(braket
id|i
)braket
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|bp-&gt;allocated
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* FIXME: debug */
id|size
op_assign
id|bp-&gt;nr_vecs
op_star
r_sizeof
(paren
r_struct
id|bio_vec
)paren
suffix:semicolon
id|mk_name
c_func
(paren
id|bp-&gt;name
comma
r_sizeof
(paren
id|bp-&gt;name
)paren
comma
id|slab_prefix
comma
id|i
)paren
suffix:semicolon
id|bp-&gt;slab
op_assign
id|kmem_cache_create
c_func
(paren
id|bp-&gt;name
comma
id|size
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bp-&gt;slab
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;can&squot;t init biovec slab cache&quot;
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ge
id|scale
)paren
id|pool_entries
op_rshift_assign
l_int|1
suffix:semicolon
id|bp-&gt;pool
op_assign
id|mempool_create
c_func
(paren
id|pool_entries
comma
id|mempool_alloc_slab
comma
id|mempool_free_slab
comma
id|bp-&gt;slab
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bp-&gt;pool
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;can&squot;t init biovec mempool&quot;
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|bad
suffix:colon
id|bio_set_exit
c_func
(paren
id|bs
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* FIXME: blech */
DECL|function|bvec_index
r_static
r_inline
r_int
id|bvec_index
c_func
(paren
r_int
id|nr
)paren
(brace
r_switch
c_cond
(paren
id|nr
)paren
(brace
r_case
l_int|1
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
l_int|2
dot
dot
dot
l_int|4
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
l_int|5
dot
dot
dot
l_int|16
suffix:colon
r_return
l_int|2
suffix:semicolon
r_case
l_int|17
dot
dot
dot
l_int|64
suffix:colon
r_return
l_int|3
suffix:semicolon
r_case
l_int|65
dot
dot
dot
l_int|128
suffix:colon
r_return
l_int|4
suffix:semicolon
r_case
l_int|129
dot
dot
dot
id|BIO_MAX_PAGES
suffix:colon
r_return
l_int|5
suffix:semicolon
)brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bs_bio_init
r_static
r_inline
r_void
id|bs_bio_init
c_func
(paren
r_struct
id|bio
op_star
id|bio
)paren
(brace
id|bio-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
id|bio-&gt;bi_flags
op_assign
l_int|1
op_lshift
id|BIO_UPTODATE
suffix:semicolon
id|bio-&gt;bi_rw
op_assign
l_int|0
suffix:semicolon
id|bio-&gt;bi_vcnt
op_assign
l_int|0
suffix:semicolon
id|bio-&gt;bi_idx
op_assign
l_int|0
suffix:semicolon
id|bio-&gt;bi_phys_segments
op_assign
l_int|0
suffix:semicolon
id|bio-&gt;bi_hw_segments
op_assign
l_int|0
suffix:semicolon
id|bio-&gt;bi_size
op_assign
l_int|0
suffix:semicolon
id|bio-&gt;bi_max_vecs
op_assign
l_int|0
suffix:semicolon
id|bio-&gt;bi_end_io
op_assign
l_int|NULL
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|bio-&gt;bi_cnt
comma
l_int|1
)paren
suffix:semicolon
id|bio-&gt;bi_private
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|variable|_bio_count
r_static
r_int
id|_bio_count
op_assign
l_int|0
suffix:semicolon
DECL|function|bio_set_alloc
r_struct
id|bio
op_star
id|bio_set_alloc
c_func
(paren
r_struct
id|bio_set
op_star
id|bs
comma
r_int
id|gfp_mask
comma
r_int
id|nr_iovecs
)paren
(brace
r_struct
id|biovec_pool
op_star
id|bp
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bv
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|idx
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
id|bio
op_assign
id|mempool_alloc
c_func
(paren
id|bs-&gt;bio_pool
comma
id|gfp_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|bio
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|bio_init
c_func
(paren
id|bio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|nr_iovecs
)paren
)paren
(brace
id|idx
op_assign
id|bvec_index
c_func
(paren
id|nr_iovecs
)paren
suffix:semicolon
id|bp
op_assign
id|bs-&gt;pools
op_plus
id|idx
suffix:semicolon
id|bv
op_assign
id|mempool_alloc
c_func
(paren
id|bp-&gt;pool
comma
id|gfp_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bv
)paren
(brace
id|mempool_free
c_func
(paren
id|bio
comma
id|bs-&gt;bio_pool
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|bv
comma
l_int|0
comma
id|bp-&gt;nr_vecs
op_star
r_sizeof
(paren
op_star
id|bv
)paren
)paren
suffix:semicolon
id|bio-&gt;bi_flags
op_or_assign
id|idx
op_lshift
id|BIO_POOL_OFFSET
suffix:semicolon
id|bio-&gt;bi_max_vecs
op_assign
id|bp-&gt;nr_vecs
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|bp-&gt;allocated
)paren
suffix:semicolon
)brace
id|bio-&gt;bi_io_vec
op_assign
id|bv
suffix:semicolon
r_return
id|bio
suffix:semicolon
)brace
DECL|function|bio_set_free
r_static
r_void
id|bio_set_free
c_func
(paren
r_struct
id|bio_set
op_star
id|bs
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_struct
id|biovec_pool
op_star
id|bp
op_assign
id|bs-&gt;pools
op_plus
id|BIO_POOL_IDX
c_func
(paren
id|bio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|bp-&gt;allocated
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|mempool_free
c_func
(paren
id|bio-&gt;bi_io_vec
comma
id|bp-&gt;pool
)paren
suffix:semicolon
id|mempool_free
c_func
(paren
id|bio
comma
id|bs-&gt;bio_pool
)paren
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * dm-io proper&n; *---------------------------------------------------------------*/
DECL|variable|_bios
r_static
r_struct
id|bio_set
id|_bios
suffix:semicolon
multiline_comment|/* FIXME: can we shrink this ? */
DECL|struct|io
r_struct
id|io
(brace
DECL|member|error
r_int
r_int
id|error
suffix:semicolon
DECL|member|count
id|atomic_t
id|count
suffix:semicolon
DECL|member|sleeper
r_struct
id|task_struct
op_star
id|sleeper
suffix:semicolon
DECL|member|callback
id|io_notify_fn
id|callback
suffix:semicolon
DECL|member|context
r_void
op_star
id|context
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * io contexts are only dynamically allocated for asynchronous&n; * io.  Since async io is likely to be the majority of io we&squot;ll&n; * have the same number of io contexts as buffer heads ! (FIXME:&n; * must reduce this).&n; */
DECL|variable|_num_ios
r_static
r_int
id|_num_ios
suffix:semicolon
DECL|variable|_io_pool
r_static
id|mempool_t
op_star
id|_io_pool
suffix:semicolon
DECL|function|alloc_io
r_static
r_void
op_star
id|alloc_io
c_func
(paren
r_int
id|gfp_mask
comma
r_void
op_star
id|pool_data
)paren
(brace
r_return
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|io
)paren
comma
id|gfp_mask
)paren
suffix:semicolon
)brace
DECL|function|free_io
r_static
r_void
id|free_io
c_func
(paren
r_void
op_star
id|element
comma
r_void
op_star
id|pool_data
)paren
(brace
id|kfree
c_func
(paren
id|element
)paren
suffix:semicolon
)brace
DECL|function|pages_to_ios
r_static
r_int
r_int
id|pages_to_ios
c_func
(paren
r_int
r_int
id|pages
)paren
(brace
r_return
l_int|4
op_star
id|pages
suffix:semicolon
multiline_comment|/* too many ? */
)brace
DECL|function|resize_pool
r_static
r_int
id|resize_pool
c_func
(paren
r_int
r_int
id|new_ios
)paren
(brace
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|_io_pool
)paren
(brace
r_if
c_cond
(paren
id|new_ios
op_eq
l_int|0
)paren
(brace
multiline_comment|/* free off the pool */
id|mempool_destroy
c_func
(paren
id|_io_pool
)paren
suffix:semicolon
id|_io_pool
op_assign
l_int|NULL
suffix:semicolon
id|bio_set_exit
c_func
(paren
op_amp
id|_bios
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* resize the pool */
id|r
op_assign
id|mempool_resize
c_func
(paren
id|_io_pool
comma
id|new_ios
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* create new pool */
id|_io_pool
op_assign
id|mempool_create
c_func
(paren
id|new_ios
comma
id|alloc_io
comma
id|free_io
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_io_pool
)paren
id|r
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|r
op_assign
id|bio_set_init
c_func
(paren
op_amp
id|_bios
comma
l_string|&quot;dm-io&quot;
comma
l_int|512
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|mempool_destroy
c_func
(paren
id|_io_pool
)paren
suffix:semicolon
id|_io_pool
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
id|_num_ios
op_assign
id|new_ios
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|dm_io_get
r_int
id|dm_io_get
c_func
(paren
r_int
r_int
id|num_pages
)paren
(brace
r_return
id|resize_pool
c_func
(paren
id|_num_ios
op_plus
id|pages_to_ios
c_func
(paren
id|num_pages
)paren
)paren
suffix:semicolon
)brace
DECL|function|dm_io_put
r_void
id|dm_io_put
c_func
(paren
r_int
r_int
id|num_pages
)paren
(brace
id|resize_pool
c_func
(paren
id|_num_ios
op_minus
id|pages_to_ios
c_func
(paren
id|num_pages
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * We need to keep track of which region a bio is doing io for.&n; * In order to save a memory allocation we store this the last&n; * bvec which we know is unused (blech).&n; *---------------------------------------------------------------*/
DECL|function|bio_set_region
r_static
r_inline
r_void
id|bio_set_region
c_func
(paren
r_struct
id|bio
op_star
id|bio
comma
r_int
id|region
)paren
(brace
id|bio-&gt;bi_io_vec
(braket
id|bio-&gt;bi_max_vecs
op_minus
l_int|1
)braket
dot
id|bv_len
op_assign
id|region
suffix:semicolon
)brace
DECL|function|bio_get_region
r_static
r_inline
r_int
id|bio_get_region
c_func
(paren
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_return
id|bio-&gt;bi_io_vec
(braket
id|bio-&gt;bi_max_vecs
op_minus
l_int|1
)braket
dot
id|bv_len
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * We need an io object to keep track of the number of bios that&n; * have been dispatched for a particular io.&n; *---------------------------------------------------------------*/
DECL|function|dec_count
r_static
r_void
id|dec_count
c_func
(paren
r_struct
id|io
op_star
id|io
comma
r_int
r_int
id|region
comma
r_int
id|error
)paren
(brace
r_if
c_cond
(paren
id|error
)paren
id|set_bit
c_func
(paren
id|region
comma
op_amp
id|io-&gt;error
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|io-&gt;count
)paren
)paren
(brace
r_if
c_cond
(paren
id|io-&gt;sleeper
)paren
id|wake_up_process
c_func
(paren
id|io-&gt;sleeper
)paren
suffix:semicolon
r_else
(brace
r_int
id|r
op_assign
id|io-&gt;error
suffix:semicolon
id|io_notify_fn
id|fn
op_assign
id|io-&gt;callback
suffix:semicolon
r_void
op_star
id|context
op_assign
id|io-&gt;context
suffix:semicolon
id|mempool_free
c_func
(paren
id|io
comma
id|_io_pool
)paren
suffix:semicolon
id|fn
c_func
(paren
id|r
comma
id|context
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* FIXME Move this to bio.h? */
DECL|function|zero_fill_bio
r_static
r_void
id|zero_fill_bio
c_func
(paren
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bv
suffix:semicolon
r_int
id|i
suffix:semicolon
id|bio_for_each_segment
c_func
(paren
id|bv
comma
id|bio
comma
id|i
)paren
(brace
r_char
op_star
id|data
op_assign
id|bvec_kmap_irq
c_func
(paren
id|bv
comma
op_amp
id|flags
)paren
suffix:semicolon
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
id|bv-&gt;bv_len
)paren
suffix:semicolon
id|flush_dcache_page
c_func
(paren
id|bv-&gt;bv_page
)paren
suffix:semicolon
id|bvec_kunmap_irq
c_func
(paren
id|data
comma
op_amp
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|endio
r_static
r_int
id|endio
c_func
(paren
r_struct
id|bio
op_star
id|bio
comma
r_int
r_int
id|done
comma
r_int
id|error
)paren
(brace
r_struct
id|io
op_star
id|io
op_assign
(paren
r_struct
id|io
op_star
)paren
id|bio-&gt;bi_private
suffix:semicolon
multiline_comment|/* keep going until we&squot;ve finished */
r_if
c_cond
(paren
id|bio-&gt;bi_size
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|error
op_logical_and
id|bio_data_dir
c_func
(paren
id|bio
)paren
op_eq
id|READ
)paren
id|zero_fill_bio
c_func
(paren
id|bio
)paren
suffix:semicolon
id|dec_count
c_func
(paren
id|io
comma
id|bio_get_region
c_func
(paren
id|bio
)paren
comma
id|error
)paren
suffix:semicolon
id|bio_put
c_func
(paren
id|bio
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bio_dtr
r_static
r_void
id|bio_dtr
c_func
(paren
r_struct
id|bio
op_star
id|bio
)paren
(brace
id|_bio_count
op_decrement
suffix:semicolon
id|bio_set_free
c_func
(paren
op_amp
id|_bios
comma
id|bio
)paren
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * These little objects provide an abstraction for getting a new&n; * destination page for io.&n; *---------------------------------------------------------------*/
DECL|struct|dpages
r_struct
id|dpages
(brace
DECL|member|get_page
r_void
(paren
op_star
id|get_page
)paren
(paren
r_struct
id|dpages
op_star
id|dp
comma
r_struct
id|page
op_star
op_star
id|p
comma
r_int
r_int
op_star
id|len
comma
r_int
op_star
id|offset
)paren
suffix:semicolon
DECL|member|next_page
r_void
(paren
op_star
id|next_page
)paren
(paren
r_struct
id|dpages
op_star
id|dp
)paren
suffix:semicolon
DECL|member|context_u
r_int
id|context_u
suffix:semicolon
DECL|member|context_ptr
r_void
op_star
id|context_ptr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Functions for getting the pages from a list.&n; */
DECL|function|list_get_page
r_static
r_void
id|list_get_page
c_func
(paren
r_struct
id|dpages
op_star
id|dp
comma
r_struct
id|page
op_star
op_star
id|p
comma
r_int
r_int
op_star
id|len
comma
r_int
op_star
id|offset
)paren
(brace
r_int
id|o
op_assign
id|dp-&gt;context_u
suffix:semicolon
r_struct
id|page_list
op_star
id|pl
op_assign
(paren
r_struct
id|page_list
op_star
)paren
id|dp-&gt;context_ptr
suffix:semicolon
op_star
id|p
op_assign
id|pl-&gt;page
suffix:semicolon
op_star
id|len
op_assign
id|PAGE_SIZE
op_minus
id|o
suffix:semicolon
op_star
id|offset
op_assign
id|o
suffix:semicolon
)brace
DECL|function|list_next_page
r_static
r_void
id|list_next_page
c_func
(paren
r_struct
id|dpages
op_star
id|dp
)paren
(brace
r_struct
id|page_list
op_star
id|pl
op_assign
(paren
r_struct
id|page_list
op_star
)paren
id|dp-&gt;context_ptr
suffix:semicolon
id|dp-&gt;context_ptr
op_assign
id|pl-&gt;next
suffix:semicolon
id|dp-&gt;context_u
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|list_dp_init
r_static
r_void
id|list_dp_init
c_func
(paren
r_struct
id|dpages
op_star
id|dp
comma
r_struct
id|page_list
op_star
id|pl
comma
r_int
id|offset
)paren
(brace
id|dp-&gt;get_page
op_assign
id|list_get_page
suffix:semicolon
id|dp-&gt;next_page
op_assign
id|list_next_page
suffix:semicolon
id|dp-&gt;context_u
op_assign
id|offset
suffix:semicolon
id|dp-&gt;context_ptr
op_assign
id|pl
suffix:semicolon
)brace
multiline_comment|/*&n; * Functions for getting the pages from a bvec.&n; */
DECL|function|bvec_get_page
r_static
r_void
id|bvec_get_page
c_func
(paren
r_struct
id|dpages
op_star
id|dp
comma
r_struct
id|page
op_star
op_star
id|p
comma
r_int
r_int
op_star
id|len
comma
r_int
op_star
id|offset
)paren
(brace
r_struct
id|bio_vec
op_star
id|bvec
op_assign
(paren
r_struct
id|bio_vec
op_star
)paren
id|dp-&gt;context_ptr
suffix:semicolon
op_star
id|p
op_assign
id|bvec-&gt;bv_page
suffix:semicolon
op_star
id|len
op_assign
id|bvec-&gt;bv_len
suffix:semicolon
op_star
id|offset
op_assign
id|bvec-&gt;bv_offset
suffix:semicolon
)brace
DECL|function|bvec_next_page
r_static
r_void
id|bvec_next_page
c_func
(paren
r_struct
id|dpages
op_star
id|dp
)paren
(brace
r_struct
id|bio_vec
op_star
id|bvec
op_assign
(paren
r_struct
id|bio_vec
op_star
)paren
id|dp-&gt;context_ptr
suffix:semicolon
id|dp-&gt;context_ptr
op_assign
id|bvec
op_plus
l_int|1
suffix:semicolon
)brace
DECL|function|bvec_dp_init
r_static
r_void
id|bvec_dp_init
c_func
(paren
r_struct
id|dpages
op_star
id|dp
comma
r_struct
id|bio_vec
op_star
id|bvec
)paren
(brace
id|dp-&gt;get_page
op_assign
id|bvec_get_page
suffix:semicolon
id|dp-&gt;next_page
op_assign
id|bvec_next_page
suffix:semicolon
id|dp-&gt;context_ptr
op_assign
id|bvec
suffix:semicolon
)brace
DECL|function|vm_get_page
r_static
r_void
id|vm_get_page
c_func
(paren
r_struct
id|dpages
op_star
id|dp
comma
r_struct
id|page
op_star
op_star
id|p
comma
r_int
r_int
op_star
id|len
comma
r_int
op_star
id|offset
)paren
(brace
op_star
id|p
op_assign
id|vmalloc_to_page
c_func
(paren
id|dp-&gt;context_ptr
)paren
suffix:semicolon
op_star
id|offset
op_assign
id|dp-&gt;context_u
suffix:semicolon
op_star
id|len
op_assign
id|PAGE_SIZE
op_minus
id|dp-&gt;context_u
suffix:semicolon
)brace
DECL|function|vm_next_page
r_static
r_void
id|vm_next_page
c_func
(paren
r_struct
id|dpages
op_star
id|dp
)paren
(brace
id|dp-&gt;context_ptr
op_add_assign
id|PAGE_SIZE
op_minus
id|dp-&gt;context_u
suffix:semicolon
id|dp-&gt;context_u
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|vm_dp_init
r_static
r_void
id|vm_dp_init
c_func
(paren
r_struct
id|dpages
op_star
id|dp
comma
r_void
op_star
id|data
)paren
(brace
id|dp-&gt;get_page
op_assign
id|vm_get_page
suffix:semicolon
id|dp-&gt;next_page
op_assign
id|vm_next_page
suffix:semicolon
id|dp-&gt;context_u
op_assign
(paren
(paren
r_int
r_int
)paren
id|data
)paren
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|dp-&gt;context_ptr
op_assign
id|data
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * IO routines that accept a list of pages.&n; *---------------------------------------------------------------*/
DECL|function|do_region
r_static
r_void
id|do_region
c_func
(paren
r_int
id|rw
comma
r_int
r_int
id|region
comma
r_struct
id|io_region
op_star
id|where
comma
r_struct
id|dpages
op_star
id|dp
comma
r_struct
id|io
op_star
id|io
)paren
(brace
r_struct
id|bio
op_star
id|bio
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_int
id|num_bvecs
suffix:semicolon
id|sector_t
id|remaining
op_assign
id|where-&gt;count
suffix:semicolon
r_while
c_loop
(paren
id|remaining
)paren
(brace
multiline_comment|/*&n;&t;&t; * Allocate a suitably sized bio, we add an extra&n;&t;&t; * bvec for bio_get/set_region().&n;&t;&t; */
id|num_bvecs
op_assign
(paren
id|remaining
op_div
(paren
id|PAGE_SIZE
op_rshift
l_int|9
)paren
)paren
op_plus
l_int|2
suffix:semicolon
id|_bio_count
op_increment
suffix:semicolon
id|bio
op_assign
id|bio_set_alloc
c_func
(paren
op_amp
id|_bios
comma
id|GFP_NOIO
comma
id|num_bvecs
)paren
suffix:semicolon
id|bio-&gt;bi_sector
op_assign
id|where-&gt;sector
op_plus
(paren
id|where-&gt;count
op_minus
id|remaining
)paren
suffix:semicolon
id|bio-&gt;bi_bdev
op_assign
id|where-&gt;bdev
suffix:semicolon
id|bio-&gt;bi_end_io
op_assign
id|endio
suffix:semicolon
id|bio-&gt;bi_private
op_assign
id|io
suffix:semicolon
id|bio-&gt;bi_destructor
op_assign
id|bio_dtr
suffix:semicolon
id|bio_set_region
c_func
(paren
id|bio
comma
id|region
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Try and add as many pages as possible.&n;&t;&t; */
r_while
c_loop
(paren
id|remaining
)paren
(brace
id|dp
op_member_access_from_pointer
id|get_page
c_func
(paren
id|dp
comma
op_amp
id|page
comma
op_amp
id|len
comma
op_amp
id|offset
)paren
suffix:semicolon
id|len
op_assign
id|min
c_func
(paren
id|len
comma
id|to_bytes
c_func
(paren
id|remaining
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bio_add_page
c_func
(paren
id|bio
comma
id|page
comma
id|len
comma
id|offset
)paren
)paren
r_break
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|remaining
op_sub_assign
id|to_sector
c_func
(paren
id|len
)paren
suffix:semicolon
id|dp
op_member_access_from_pointer
id|next_page
c_func
(paren
id|dp
)paren
suffix:semicolon
)brace
id|atomic_inc
c_func
(paren
op_amp
id|io-&gt;count
)paren
suffix:semicolon
id|submit_bio
c_func
(paren
id|rw
comma
id|bio
)paren
suffix:semicolon
)brace
)brace
DECL|function|dispatch_io
r_static
r_void
id|dispatch_io
c_func
(paren
r_int
id|rw
comma
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_struct
id|dpages
op_star
id|dp
comma
r_struct
id|io
op_star
id|io
comma
r_int
id|sync
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|dpages
id|old_pages
op_assign
op_star
id|dp
suffix:semicolon
r_if
c_cond
(paren
id|sync
)paren
id|rw
op_or_assign
(paren
l_int|1
op_lshift
id|BIO_RW_SYNC
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * For multiple regions we need to be careful to rewind&n;&t; * the dp object for each call to do_region.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_regions
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|dp
op_assign
id|old_pages
suffix:semicolon
r_if
c_cond
(paren
id|where
(braket
id|i
)braket
dot
id|count
)paren
id|do_region
c_func
(paren
id|rw
comma
id|i
comma
id|where
op_plus
id|i
comma
id|dp
comma
id|io
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Drop the extra refence that we were holding to avoid&n;&t; * the io being completed too early.&n;&t; */
id|dec_count
c_func
(paren
id|io
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sync_io
r_static
r_int
id|sync_io
c_func
(paren
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_int
id|rw
comma
r_struct
id|dpages
op_star
id|dp
comma
r_int
r_int
op_star
id|error_bits
)paren
(brace
r_struct
id|io
id|io
suffix:semicolon
r_if
c_cond
(paren
id|num_regions
OG
l_int|1
op_logical_and
id|rw
op_ne
id|WRITE
)paren
(brace
id|WARN_ON
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|io.error
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|io.count
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* see dispatch_io() */
id|io.sleeper
op_assign
id|current
suffix:semicolon
id|dispatch_io
c_func
(paren
id|rw
comma
id|num_regions
comma
id|where
comma
id|dp
comma
op_amp
id|io
comma
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|io.count
)paren
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|io_schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|io.count
)paren
)paren
r_return
op_minus
id|EINTR
suffix:semicolon
op_star
id|error_bits
op_assign
id|io.error
suffix:semicolon
r_return
id|io.error
ques
c_cond
op_minus
id|EIO
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|async_io
r_static
r_int
id|async_io
c_func
(paren
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_int
id|rw
comma
r_struct
id|dpages
op_star
id|dp
comma
id|io_notify_fn
id|fn
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|io
op_star
id|io
suffix:semicolon
r_if
c_cond
(paren
id|num_regions
OG
l_int|1
op_logical_and
id|rw
op_ne
id|WRITE
)paren
(brace
id|WARN_ON
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|fn
c_func
(paren
l_int|1
comma
id|context
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|io
op_assign
id|mempool_alloc
c_func
(paren
id|_io_pool
comma
id|GFP_NOIO
)paren
suffix:semicolon
id|io-&gt;error
op_assign
l_int|0
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|io-&gt;count
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* see dispatch_io() */
id|io-&gt;sleeper
op_assign
l_int|NULL
suffix:semicolon
id|io-&gt;callback
op_assign
id|fn
suffix:semicolon
id|io-&gt;context
op_assign
id|context
suffix:semicolon
id|dispatch_io
c_func
(paren
id|rw
comma
id|num_regions
comma
id|where
comma
id|dp
comma
id|io
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dm_io_sync
r_int
id|dm_io_sync
c_func
(paren
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_int
id|rw
comma
r_struct
id|page_list
op_star
id|pl
comma
r_int
r_int
id|offset
comma
r_int
r_int
op_star
id|error_bits
)paren
(brace
r_struct
id|dpages
id|dp
suffix:semicolon
id|list_dp_init
c_func
(paren
op_amp
id|dp
comma
id|pl
comma
id|offset
)paren
suffix:semicolon
r_return
id|sync_io
c_func
(paren
id|num_regions
comma
id|where
comma
id|rw
comma
op_amp
id|dp
comma
id|error_bits
)paren
suffix:semicolon
)brace
DECL|function|dm_io_sync_bvec
r_int
id|dm_io_sync_bvec
c_func
(paren
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_int
id|rw
comma
r_struct
id|bio_vec
op_star
id|bvec
comma
r_int
r_int
op_star
id|error_bits
)paren
(brace
r_struct
id|dpages
id|dp
suffix:semicolon
id|bvec_dp_init
c_func
(paren
op_amp
id|dp
comma
id|bvec
)paren
suffix:semicolon
r_return
id|sync_io
c_func
(paren
id|num_regions
comma
id|where
comma
id|rw
comma
op_amp
id|dp
comma
id|error_bits
)paren
suffix:semicolon
)brace
DECL|function|dm_io_sync_vm
r_int
id|dm_io_sync_vm
c_func
(paren
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_int
id|rw
comma
r_void
op_star
id|data
comma
r_int
r_int
op_star
id|error_bits
)paren
(brace
r_struct
id|dpages
id|dp
suffix:semicolon
id|vm_dp_init
c_func
(paren
op_amp
id|dp
comma
id|data
)paren
suffix:semicolon
r_return
id|sync_io
c_func
(paren
id|num_regions
comma
id|where
comma
id|rw
comma
op_amp
id|dp
comma
id|error_bits
)paren
suffix:semicolon
)brace
DECL|function|dm_io_async
r_int
id|dm_io_async
c_func
(paren
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_int
id|rw
comma
r_struct
id|page_list
op_star
id|pl
comma
r_int
r_int
id|offset
comma
id|io_notify_fn
id|fn
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|dpages
id|dp
suffix:semicolon
id|list_dp_init
c_func
(paren
op_amp
id|dp
comma
id|pl
comma
id|offset
)paren
suffix:semicolon
r_return
id|async_io
c_func
(paren
id|num_regions
comma
id|where
comma
id|rw
comma
op_amp
id|dp
comma
id|fn
comma
id|context
)paren
suffix:semicolon
)brace
DECL|function|dm_io_async_bvec
r_int
id|dm_io_async_bvec
c_func
(paren
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_int
id|rw
comma
r_struct
id|bio_vec
op_star
id|bvec
comma
id|io_notify_fn
id|fn
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|dpages
id|dp
suffix:semicolon
id|bvec_dp_init
c_func
(paren
op_amp
id|dp
comma
id|bvec
)paren
suffix:semicolon
r_return
id|async_io
c_func
(paren
id|num_regions
comma
id|where
comma
id|rw
comma
op_amp
id|dp
comma
id|fn
comma
id|context
)paren
suffix:semicolon
)brace
DECL|function|dm_io_async_vm
r_int
id|dm_io_async_vm
c_func
(paren
r_int
r_int
id|num_regions
comma
r_struct
id|io_region
op_star
id|where
comma
r_int
id|rw
comma
r_void
op_star
id|data
comma
id|io_notify_fn
id|fn
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|dpages
id|dp
suffix:semicolon
id|vm_dp_init
c_func
(paren
op_amp
id|dp
comma
id|data
)paren
suffix:semicolon
r_return
id|async_io
c_func
(paren
id|num_regions
comma
id|where
comma
id|rw
comma
op_amp
id|dp
comma
id|fn
comma
id|context
)paren
suffix:semicolon
)brace
DECL|variable|dm_io_get
id|EXPORT_SYMBOL
c_func
(paren
id|dm_io_get
)paren
suffix:semicolon
DECL|variable|dm_io_put
id|EXPORT_SYMBOL
c_func
(paren
id|dm_io_put
)paren
suffix:semicolon
DECL|variable|dm_io_sync
id|EXPORT_SYMBOL
c_func
(paren
id|dm_io_sync
)paren
suffix:semicolon
DECL|variable|dm_io_async
id|EXPORT_SYMBOL
c_func
(paren
id|dm_io_async
)paren
suffix:semicolon
DECL|variable|dm_io_sync_bvec
id|EXPORT_SYMBOL
c_func
(paren
id|dm_io_sync_bvec
)paren
suffix:semicolon
DECL|variable|dm_io_async_bvec
id|EXPORT_SYMBOL
c_func
(paren
id|dm_io_async_bvec
)paren
suffix:semicolon
DECL|variable|dm_io_sync_vm
id|EXPORT_SYMBOL
c_func
(paren
id|dm_io_sync_vm
)paren
suffix:semicolon
DECL|variable|dm_io_async_vm
id|EXPORT_SYMBOL
c_func
(paren
id|dm_io_async_vm
)paren
suffix:semicolon
eof
