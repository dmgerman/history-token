multiline_comment|/*&n; * raid6main.c : Multiple Devices driver for Linux&n; *&t;   Copyright (C) 1996, 1997 Ingo Molnar, Miguel de Icaza, Gadi Oxman&n; *&t;   Copyright (C) 1999, 2000 Ingo Molnar&n; *&t;   Copyright (C) 2002, 2003 H. Peter Anvin&n; *&n; * RAID-6 management functions.  This code is derived from raid5.c.&n; * Last merge from raid5.c bkcvs version 1.79 (kernel 2.6.1).&n; *&n; * Thanks to Penguin Computing for making the RAID-6 development possible&n; * by donating a test server!&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * You should have received a copy of the GNU General Public License&n; * (for example /usr/src/linux/COPYING); if not, write to the Free&n; * Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/highmem.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &quot;raid6.h&quot;
multiline_comment|/*&n; * Stripe cache&n; */
DECL|macro|NR_STRIPES
mdefine_line|#define NR_STRIPES&t;&t;256
DECL|macro|STRIPE_SIZE
mdefine_line|#define STRIPE_SIZE&t;&t;PAGE_SIZE
DECL|macro|STRIPE_SHIFT
mdefine_line|#define STRIPE_SHIFT&t;&t;(PAGE_SHIFT - 9)
DECL|macro|STRIPE_SECTORS
mdefine_line|#define STRIPE_SECTORS&t;&t;(STRIPE_SIZE&gt;&gt;9)
DECL|macro|IO_THRESHOLD
mdefine_line|#define&t;IO_THRESHOLD&t;&t;1
DECL|macro|HASH_PAGES
mdefine_line|#define HASH_PAGES&t;&t;1
DECL|macro|HASH_PAGES_ORDER
mdefine_line|#define HASH_PAGES_ORDER&t;0
DECL|macro|NR_HASH
mdefine_line|#define NR_HASH&t;&t;&t;(HASH_PAGES * PAGE_SIZE / sizeof(struct stripe_head *))
DECL|macro|HASH_MASK
mdefine_line|#define HASH_MASK&t;&t;(NR_HASH - 1)
DECL|macro|stripe_hash
mdefine_line|#define stripe_hash(conf, sect)&t;((conf)-&gt;stripe_hashtbl[((sect) &gt;&gt; STRIPE_SHIFT) &amp; HASH_MASK])
multiline_comment|/* bio&squot;s attached to a stripe+device for I/O are linked together in bi_sector&n; * order without overlap.  There may be several bio&squot;s per stripe+device, and&n; * a bio could span several devices.&n; * When walking this list for a particular stripe+device, we must never proceed&n; * beyond a bio that extends past this device, as the next bio might no longer&n; * be valid.&n; * This macro is used to determine the &squot;next&squot; bio in the list, given the sector&n; * of the current stripe+device&n; */
DECL|macro|r5_next_bio
mdefine_line|#define r5_next_bio(bio, sect) ( ( bio-&gt;bi_sector + (bio-&gt;bi_size&gt;&gt;9) &lt; sect + STRIPE_SECTORS) ? bio-&gt;bi_next : NULL)
multiline_comment|/*&n; * The following can be used to debug the driver&n; */
DECL|macro|RAID6_DEBUG
mdefine_line|#define RAID6_DEBUG&t;0&t;/* Extremely verbose printk */
DECL|macro|RAID6_PARANOIA
mdefine_line|#define RAID6_PARANOIA&t;1&t;/* Check spinlocks */
DECL|macro|RAID6_DUMPSTATE
mdefine_line|#define RAID6_DUMPSTATE 0&t;/* Include stripe cache state in /proc/mdstat */
macro_line|#if RAID6_PARANOIA &amp;&amp; defined(CONFIG_SMP)
DECL|macro|CHECK_DEVLOCK
macro_line|# define CHECK_DEVLOCK() if (!spin_is_locked(&amp;conf-&gt;device_lock)) BUG()
macro_line|#else
DECL|macro|CHECK_DEVLOCK
macro_line|# define CHECK_DEVLOCK()
macro_line|#endif
DECL|macro|PRINTK
mdefine_line|#define PRINTK(x...) ((void)(RAID6_DEBUG &amp;&amp; printk(KERN_DEBUG x)))
macro_line|#if RAID6_DEBUG
DECL|macro|inline
macro_line|#undef inline
DECL|macro|__inline__
macro_line|#undef __inline__
DECL|macro|inline
mdefine_line|#define inline
DECL|macro|__inline__
mdefine_line|#define __inline__
macro_line|#endif
macro_line|#if !RAID6_USE_EMPTY_ZERO_PAGE
multiline_comment|/* In .bss so it&squot;s zeroed */
DECL|variable|raid6_empty_zero_page
r_const
r_char
id|raid6_empty_zero_page
(braket
id|PAGE_SIZE
)braket
id|__attribute__
c_func
(paren
(paren
id|aligned
c_func
(paren
l_int|256
)paren
)paren
)paren
suffix:semicolon
macro_line|#endif
DECL|function|raid6_next_disk
r_static
r_inline
r_int
id|raid6_next_disk
c_func
(paren
r_int
id|disk
comma
r_int
id|raid_disks
)paren
(brace
id|disk
op_increment
suffix:semicolon
r_return
(paren
id|disk
OL
id|raid_disks
)paren
ques
c_cond
id|disk
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|print_raid6_conf
(paren
id|raid6_conf_t
op_star
id|conf
)paren
suffix:semicolon
DECL|function|__release_stripe
r_static
r_inline
r_void
id|__release_stripe
c_func
(paren
id|raid6_conf_t
op_star
id|conf
comma
r_struct
id|stripe_head
op_star
id|sh
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|sh-&gt;count
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|sh-&gt;lru
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|conf-&gt;active_stripes
)paren
op_eq
l_int|0
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|STRIPE_DELAYED
comma
op_amp
id|sh-&gt;state
)paren
)paren
id|list_add_tail
c_func
(paren
op_amp
id|sh-&gt;lru
comma
op_amp
id|conf-&gt;delayed_list
)paren
suffix:semicolon
r_else
id|list_add_tail
c_func
(paren
op_amp
id|sh-&gt;lru
comma
op_amp
id|conf-&gt;handle_list
)paren
suffix:semicolon
id|md_wakeup_thread
c_func
(paren
id|conf-&gt;mddev-&gt;thread
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|STRIPE_PREREAD_ACTIVE
comma
op_amp
id|sh-&gt;state
)paren
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|conf-&gt;preread_active_stripes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|conf-&gt;preread_active_stripes
)paren
OL
id|IO_THRESHOLD
)paren
id|md_wakeup_thread
c_func
(paren
id|conf-&gt;mddev-&gt;thread
)paren
suffix:semicolon
)brace
id|list_add_tail
c_func
(paren
op_amp
id|sh-&gt;lru
comma
op_amp
id|conf-&gt;inactive_list
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|conf-&gt;active_stripes
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;inactive_blocked
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|conf-&gt;active_stripes
)paren
OL
(paren
id|NR_STRIPES
op_star
l_int|3
op_div
l_int|4
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|conf-&gt;wait_for_stripe
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|release_stripe
r_static
r_void
id|release_stripe
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
id|__release_stripe
c_func
(paren
id|conf
comma
id|sh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|remove_hash
r_static
r_void
id|remove_hash
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;remove_hash(), stripe %llu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh-&gt;hash_pprev
)paren
(brace
r_if
c_cond
(paren
id|sh-&gt;hash_next
)paren
id|sh-&gt;hash_next-&gt;hash_pprev
op_assign
id|sh-&gt;hash_pprev
suffix:semicolon
op_star
id|sh-&gt;hash_pprev
op_assign
id|sh-&gt;hash_next
suffix:semicolon
id|sh-&gt;hash_pprev
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|insert_hash
r_static
id|__inline__
r_void
id|insert_hash
c_func
(paren
id|raid6_conf_t
op_star
id|conf
comma
r_struct
id|stripe_head
op_star
id|sh
)paren
(brace
r_struct
id|stripe_head
op_star
op_star
id|shp
op_assign
op_amp
id|stripe_hash
c_func
(paren
id|conf
comma
id|sh-&gt;sector
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;insert_hash(), stripe %llu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
)paren
suffix:semicolon
id|CHECK_DEVLOCK
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sh-&gt;hash_next
op_assign
op_star
id|shp
)paren
op_ne
l_int|NULL
)paren
(paren
op_star
id|shp
)paren
op_member_access_from_pointer
id|hash_pprev
op_assign
op_amp
id|sh-&gt;hash_next
suffix:semicolon
op_star
id|shp
op_assign
id|sh
suffix:semicolon
id|sh-&gt;hash_pprev
op_assign
id|shp
suffix:semicolon
)brace
multiline_comment|/* find an idle stripe, make sure it is unhashed, and return it. */
DECL|function|get_free_stripe
r_static
r_struct
id|stripe_head
op_star
id|get_free_stripe
c_func
(paren
id|raid6_conf_t
op_star
id|conf
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|first
suffix:semicolon
id|CHECK_DEVLOCK
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|conf-&gt;inactive_list
)paren
)paren
r_goto
id|out
suffix:semicolon
id|first
op_assign
id|conf-&gt;inactive_list.next
suffix:semicolon
id|sh
op_assign
id|list_entry
c_func
(paren
id|first
comma
r_struct
id|stripe_head
comma
id|lru
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
id|first
)paren
suffix:semicolon
id|remove_hash
c_func
(paren
id|sh
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|conf-&gt;active_stripes
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|sh
suffix:semicolon
)brace
DECL|function|shrink_buffers
r_static
r_void
id|shrink_buffers
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|num
)paren
(brace
r_struct
id|page
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_continue
suffix:semicolon
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|page
op_assign
l_int|NULL
suffix:semicolon
id|page_cache_release
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
)brace
DECL|function|grow_buffers
r_static
r_int
id|grow_buffers
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|num
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_assign
id|alloc_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|page
op_assign
id|page
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|raid6_build_block
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|i
)paren
suffix:semicolon
DECL|function|init_stripe
r_static
r_inline
r_void
id|init_stripe
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
id|sector_t
id|sector
comma
r_int
id|pd_idx
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
id|disks
op_assign
id|conf-&gt;raid_disks
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sh-&gt;count
)paren
op_ne
l_int|0
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|CHECK_DEVLOCK
c_func
(paren
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;init_stripe called, stripe %llu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
)paren
suffix:semicolon
id|remove_hash
c_func
(paren
id|sh
)paren
suffix:semicolon
id|sh-&gt;sector
op_assign
id|sector
suffix:semicolon
id|sh-&gt;pd_idx
op_assign
id|pd_idx
suffix:semicolon
id|sh-&gt;state
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
r_struct
id|r5dev
op_star
id|dev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;toread
op_logical_or
id|dev-&gt;towrite
op_logical_or
id|dev-&gt;written
op_logical_or
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;sector=%llx i=%d %p %p %p %d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
comma
id|dev-&gt;toread
comma
id|dev-&gt;towrite
comma
id|dev-&gt;written
comma
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|raid6_build_block
c_func
(paren
id|sh
comma
id|i
)paren
suffix:semicolon
)brace
id|insert_hash
c_func
(paren
id|conf
comma
id|sh
)paren
suffix:semicolon
)brace
DECL|function|__find_stripe
r_static
r_struct
id|stripe_head
op_star
id|__find_stripe
c_func
(paren
id|raid6_conf_t
op_star
id|conf
comma
id|sector_t
id|sector
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
id|CHECK_DEVLOCK
c_func
(paren
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;__find_stripe, sector %llu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sector
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sh
op_assign
id|stripe_hash
c_func
(paren
id|conf
comma
id|sector
)paren
suffix:semicolon
id|sh
suffix:semicolon
id|sh
op_assign
id|sh-&gt;hash_next
)paren
r_if
c_cond
(paren
id|sh-&gt;sector
op_eq
id|sector
)paren
r_return
id|sh
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;__stripe %llu not in cache&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sector
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
id|unplug_slaves
c_func
(paren
id|mddev_t
op_star
id|mddev
)paren
suffix:semicolon
DECL|function|get_active_stripe
r_static
r_struct
id|stripe_head
op_star
id|get_active_stripe
c_func
(paren
id|raid6_conf_t
op_star
id|conf
comma
id|sector_t
id|sector
comma
r_int
id|pd_idx
comma
r_int
id|noblock
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;get_stripe, sector %llu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sector
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_do
(brace
id|sh
op_assign
id|__find_stripe
c_func
(paren
id|conf
comma
id|sector
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sh
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;inactive_blocked
)paren
id|sh
op_assign
id|get_free_stripe
c_func
(paren
id|conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|noblock
op_logical_and
id|sh
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sh
)paren
(brace
id|conf-&gt;inactive_blocked
op_assign
l_int|1
suffix:semicolon
id|wait_event_lock_irq
c_func
(paren
id|conf-&gt;wait_for_stripe
comma
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|conf-&gt;inactive_list
)paren
op_logical_and
(paren
id|atomic_read
c_func
(paren
op_amp
id|conf-&gt;active_stripes
)paren
OL
(paren
id|NR_STRIPES
op_star
l_int|3
op_div
l_int|4
)paren
op_logical_or
op_logical_neg
id|conf-&gt;inactive_blocked
)paren
comma
id|conf-&gt;device_lock
comma
id|unplug_slaves
c_func
(paren
id|conf-&gt;mddev
)paren
suffix:semicolon
)paren
suffix:semicolon
id|conf-&gt;inactive_blocked
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|init_stripe
c_func
(paren
id|sh
comma
id|sector
comma
id|pd_idx
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sh-&gt;count
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|sh-&gt;lru
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
)paren
id|atomic_inc
c_func
(paren
op_amp
id|conf-&gt;active_stripes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|sh-&gt;lru
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|sh-&gt;lru
)paren
suffix:semicolon
)brace
)brace
)brace
r_while
c_loop
(paren
id|sh
op_eq
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
)paren
id|atomic_inc
c_func
(paren
op_amp
id|sh-&gt;count
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_return
id|sh
suffix:semicolon
)brace
DECL|function|grow_stripes
r_static
r_int
id|grow_stripes
c_func
(paren
id|raid6_conf_t
op_star
id|conf
comma
r_int
id|num
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
id|kmem_cache_t
op_star
id|sc
suffix:semicolon
r_int
id|devs
op_assign
id|conf-&gt;raid_disks
suffix:semicolon
id|sprintf
c_func
(paren
id|conf-&gt;cache_name
comma
l_string|&quot;raid6/%s&quot;
comma
id|mdname
c_func
(paren
id|conf-&gt;mddev
)paren
)paren
suffix:semicolon
id|sc
op_assign
id|kmem_cache_create
c_func
(paren
id|conf-&gt;cache_name
comma
r_sizeof
(paren
r_struct
id|stripe_head
)paren
op_plus
(paren
id|devs
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|r5dev
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sc
)paren
r_return
l_int|1
suffix:semicolon
id|conf-&gt;slab_cache
op_assign
id|sc
suffix:semicolon
r_while
c_loop
(paren
id|num
op_decrement
)paren
(brace
id|sh
op_assign
id|kmem_cache_alloc
c_func
(paren
id|sc
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sh
)paren
r_return
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|sh
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sh
)paren
op_plus
(paren
id|devs
op_minus
l_int|1
)paren
op_star
r_sizeof
(paren
r_struct
id|r5dev
)paren
)paren
suffix:semicolon
id|sh-&gt;raid_conf
op_assign
id|conf
suffix:semicolon
id|sh-&gt;lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_if
c_cond
(paren
id|grow_buffers
c_func
(paren
id|sh
comma
id|conf-&gt;raid_disks
)paren
)paren
(brace
id|shrink_buffers
c_func
(paren
id|sh
comma
id|conf-&gt;raid_disks
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|sc
comma
id|sh
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* we just created an active stripe so... */
id|atomic_set
c_func
(paren
op_amp
id|sh-&gt;count
comma
l_int|1
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|conf-&gt;active_stripes
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sh-&gt;lru
)paren
suffix:semicolon
id|release_stripe
c_func
(paren
id|sh
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|shrink_stripes
r_static
r_void
id|shrink_stripes
c_func
(paren
id|raid6_conf_t
op_star
id|conf
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|sh
op_assign
id|get_free_stripe
c_func
(paren
id|conf
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sh
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sh-&gt;count
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|shrink_buffers
c_func
(paren
id|sh
comma
id|conf-&gt;raid_disks
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|conf-&gt;slab_cache
comma
id|sh
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|conf-&gt;active_stripes
)paren
suffix:semicolon
)brace
id|kmem_cache_destroy
c_func
(paren
id|conf-&gt;slab_cache
)paren
suffix:semicolon
id|conf-&gt;slab_cache
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|raid6_end_read_request
r_static
r_int
id|raid6_end_read_request
(paren
r_struct
id|bio
op_star
id|bi
comma
r_int
r_int
id|bytes_done
comma
r_int
id|error
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
op_assign
id|bi-&gt;bi_private
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
id|disks
op_assign
id|conf-&gt;raid_disks
comma
id|i
suffix:semicolon
r_int
id|uptodate
op_assign
id|test_bit
c_func
(paren
id|BIO_UPTODATE
comma
op_amp
id|bi-&gt;bi_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bi-&gt;bi_size
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|disks
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|bi
op_eq
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|req
)paren
r_break
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;end_read_request %llu/%d, count: %d, uptodate %d.&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
comma
id|atomic_read
c_func
(paren
op_amp
id|sh-&gt;count
)paren
comma
id|uptodate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|disks
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uptodate
)paren
(brace
macro_line|#if 0
r_struct
id|bio
op_star
id|bio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* we can return a buffer if we bypassed the cache or&n;&t;&t; * if the top buffer is not in highmem.  If there are&n;&t;&t; * multiple buffers, leave the extra work to&n;&t;&t; * handle_stripe&n;&t;&t; */
id|buffer
op_assign
id|sh-&gt;bh_read
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_logical_and
(paren
op_logical_neg
id|PageHighMem
c_func
(paren
id|buffer-&gt;b_page
)paren
op_logical_or
id|buffer-&gt;b_page
op_eq
id|bh-&gt;b_page
)paren
)paren
(brace
id|sh-&gt;bh_read
(braket
id|i
)braket
op_assign
id|buffer-&gt;b_reqnext
suffix:semicolon
id|buffer-&gt;b_reqnext
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|buffer
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh-&gt;bh_page
(braket
id|i
)braket
op_eq
id|bh-&gt;b_page
)paren
id|set_buffer_uptodate
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
)paren
(brace
r_if
c_cond
(paren
id|buffer-&gt;b_page
op_ne
id|bh-&gt;b_page
)paren
id|memcpy
c_func
(paren
id|buffer-&gt;b_data
comma
id|bh-&gt;b_data
comma
id|bh-&gt;b_size
)paren
suffix:semicolon
id|buffer
op_member_access_from_pointer
id|b_end_io
c_func
(paren
id|buffer
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#else
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|md_error
c_func
(paren
id|conf-&gt;mddev
comma
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
id|rdev_dec_pending
c_func
(paren
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
comma
id|conf-&gt;mddev
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* must restore b_page before unlocking buffer... */
r_if
c_cond
(paren
id|sh-&gt;bh_page
(braket
id|i
)braket
op_ne
id|bh-&gt;b_page
)paren
(brace
id|bh-&gt;b_page
op_assign
id|sh-&gt;bh_page
(braket
id|i
)braket
suffix:semicolon
id|bh-&gt;b_data
op_assign
id|page_address
c_func
(paren
id|bh-&gt;b_page
)paren
suffix:semicolon
id|clear_buffer_uptodate
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
macro_line|#endif
id|clear_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|release_stripe
c_func
(paren
id|sh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|raid6_end_write_request
r_static
r_int
id|raid6_end_write_request
(paren
r_struct
id|bio
op_star
id|bi
comma
r_int
r_int
id|bytes_done
comma
r_int
id|error
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
op_assign
id|bi-&gt;bi_private
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
id|disks
op_assign
id|conf-&gt;raid_disks
comma
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|uptodate
op_assign
id|test_bit
c_func
(paren
id|BIO_UPTODATE
comma
op_amp
id|bi-&gt;bi_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bi-&gt;bi_size
)paren
r_return
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|disks
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|bi
op_eq
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|req
)paren
r_break
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;end_write_request %llu/%d, count %d, uptodate: %d.&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
comma
id|atomic_read
c_func
(paren
op_amp
id|sh-&gt;count
)paren
comma
id|uptodate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|disks
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uptodate
)paren
id|md_error
c_func
(paren
id|conf-&gt;mddev
comma
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
)paren
suffix:semicolon
id|rdev_dec_pending
c_func
(paren
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
comma
id|conf-&gt;mddev
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|__release_stripe
c_func
(paren
id|conf
comma
id|sh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|sector_t
id|compute_blocknr
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|i
)paren
suffix:semicolon
DECL|function|raid6_build_block
r_static
r_void
id|raid6_build_block
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|i
)paren
(brace
r_struct
id|r5dev
op_star
id|dev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
suffix:semicolon
r_int
id|pd_idx
op_assign
id|sh-&gt;pd_idx
suffix:semicolon
r_int
id|qd_idx
op_assign
id|raid6_next_disk
c_func
(paren
id|pd_idx
comma
id|sh-&gt;raid_conf-&gt;raid_disks
)paren
suffix:semicolon
id|bio_init
c_func
(paren
op_amp
id|dev-&gt;req
)paren
suffix:semicolon
id|dev-&gt;req.bi_io_vec
op_assign
op_amp
id|dev-&gt;vec
suffix:semicolon
id|dev-&gt;req.bi_vcnt
op_increment
suffix:semicolon
id|dev-&gt;vec.bv_page
op_assign
id|dev-&gt;page
suffix:semicolon
id|dev-&gt;vec.bv_len
op_assign
id|STRIPE_SIZE
suffix:semicolon
id|dev-&gt;vec.bv_offset
op_assign
l_int|0
suffix:semicolon
id|dev-&gt;req.bi_sector
op_assign
id|sh-&gt;sector
suffix:semicolon
id|dev-&gt;req.bi_private
op_assign
id|sh
suffix:semicolon
id|dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|pd_idx
op_logical_and
id|i
op_ne
id|qd_idx
)paren
id|dev-&gt;sector
op_assign
id|compute_blocknr
c_func
(paren
id|sh
comma
id|i
)paren
suffix:semicolon
)brace
DECL|function|error
r_static
r_void
id|error
c_func
(paren
id|mddev_t
op_star
id|mddev
comma
id|mdk_rdev_t
op_star
id|rdev
)paren
(brace
r_char
id|b
(braket
id|BDEVNAME_SIZE
)braket
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
(paren
id|raid6_conf_t
op_star
)paren
id|mddev
op_member_access_from_pointer
r_private
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;raid6: error called&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rdev-&gt;faulty
)paren
(brace
id|mddev-&gt;sb_dirty
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rdev-&gt;in_sync
)paren
(brace
id|conf-&gt;working_disks
op_decrement
suffix:semicolon
id|mddev-&gt;degraded
op_increment
suffix:semicolon
id|conf-&gt;failed_disks
op_increment
suffix:semicolon
id|rdev-&gt;in_sync
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if recovery was running, make sure it aborts.&n;&t;&t;&t; */
id|set_bit
c_func
(paren
id|MD_RECOVERY_ERR
comma
op_amp
id|mddev-&gt;recovery
)paren
suffix:semicolon
)brace
id|rdev-&gt;faulty
op_assign
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_ALERT
l_string|&quot;raid6: Disk failure on %s, disabling device.&quot;
l_string|&quot; Operation continuing on %d devices&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|rdev-&gt;bdev
comma
id|b
)paren
comma
id|conf-&gt;working_disks
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Input: a &squot;big&squot; sector number,&n; * Output: index of the data and parity disk, and the sector # in them.&n; */
DECL|function|raid6_compute_sector
r_static
id|sector_t
id|raid6_compute_sector
c_func
(paren
id|sector_t
id|r_sector
comma
r_int
r_int
id|raid_disks
comma
r_int
r_int
id|data_disks
comma
r_int
r_int
op_star
id|dd_idx
comma
r_int
r_int
op_star
id|pd_idx
comma
id|raid6_conf_t
op_star
id|conf
)paren
(brace
r_int
id|stripe
suffix:semicolon
r_int
r_int
id|chunk_number
suffix:semicolon
r_int
r_int
id|chunk_offset
suffix:semicolon
id|sector_t
id|new_sector
suffix:semicolon
r_int
id|sectors_per_chunk
op_assign
id|conf-&gt;chunk_size
op_rshift
l_int|9
suffix:semicolon
multiline_comment|/* First compute the information on this sector */
multiline_comment|/*&n;&t; * Compute the chunk number and the sector offset inside the chunk&n;&t; */
id|chunk_offset
op_assign
id|sector_div
c_func
(paren
id|r_sector
comma
id|sectors_per_chunk
)paren
suffix:semicolon
id|chunk_number
op_assign
id|r_sector
suffix:semicolon
r_if
c_cond
(paren
id|r_sector
op_ne
id|chunk_number
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;raid6: ERROR: r_sector = %llu, chunk_number = %lu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|r_sector
comma
(paren
r_int
r_int
)paren
id|chunk_number
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Compute the stripe number&n;&t; */
id|stripe
op_assign
id|chunk_number
op_div
id|data_disks
suffix:semicolon
multiline_comment|/*&n;&t; * Compute the data disk and parity disk indexes inside the stripe&n;&t; */
op_star
id|dd_idx
op_assign
id|chunk_number
op_mod
id|data_disks
suffix:semicolon
multiline_comment|/*&n;&t; * Select the parity disk based on the user selected algorithm.&n;&t; */
multiline_comment|/**** FIX THIS ****/
r_switch
c_cond
(paren
id|conf-&gt;algorithm
)paren
(brace
r_case
id|ALGORITHM_LEFT_ASYMMETRIC
suffix:colon
op_star
id|pd_idx
op_assign
id|raid_disks
op_minus
l_int|1
op_minus
(paren
id|stripe
op_mod
id|raid_disks
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pd_idx
op_eq
id|raid_disks
op_minus
l_int|1
)paren
(paren
op_star
id|dd_idx
)paren
op_increment
suffix:semicolon
multiline_comment|/* Q D D D P */
r_else
r_if
c_cond
(paren
op_star
id|dd_idx
op_ge
op_star
id|pd_idx
)paren
(paren
op_star
id|dd_idx
)paren
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* D D P Q D */
r_break
suffix:semicolon
r_case
id|ALGORITHM_RIGHT_ASYMMETRIC
suffix:colon
op_star
id|pd_idx
op_assign
id|stripe
op_mod
id|raid_disks
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pd_idx
op_eq
id|raid_disks
op_minus
l_int|1
)paren
(paren
op_star
id|dd_idx
)paren
op_increment
suffix:semicolon
multiline_comment|/* Q D D D P */
r_else
r_if
c_cond
(paren
op_star
id|dd_idx
op_ge
op_star
id|pd_idx
)paren
(paren
op_star
id|dd_idx
)paren
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* D D P Q D */
r_break
suffix:semicolon
r_case
id|ALGORITHM_LEFT_SYMMETRIC
suffix:colon
op_star
id|pd_idx
op_assign
id|raid_disks
op_minus
l_int|1
op_minus
(paren
id|stripe
op_mod
id|raid_disks
)paren
suffix:semicolon
op_star
id|dd_idx
op_assign
(paren
op_star
id|pd_idx
op_plus
l_int|2
op_plus
op_star
id|dd_idx
)paren
op_mod
id|raid_disks
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ALGORITHM_RIGHT_SYMMETRIC
suffix:colon
op_star
id|pd_idx
op_assign
id|stripe
op_mod
id|raid_disks
suffix:semicolon
op_star
id|dd_idx
op_assign
(paren
op_star
id|pd_idx
op_plus
l_int|2
op_plus
op_star
id|dd_idx
)paren
op_mod
id|raid_disks
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;raid6: unsupported algorithm %d&bslash;n&quot;
comma
id|conf-&gt;algorithm
)paren
suffix:semicolon
)brace
id|PRINTK
c_func
(paren
l_string|&quot;raid6: chunk_number = %lu, pd_idx = %u, dd_idx = %u&bslash;n&quot;
comma
id|chunk_number
comma
op_star
id|pd_idx
comma
op_star
id|dd_idx
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Finally, compute the new sector number&n;&t; */
id|new_sector
op_assign
(paren
id|sector_t
)paren
id|stripe
op_star
id|sectors_per_chunk
op_plus
id|chunk_offset
suffix:semicolon
r_return
id|new_sector
suffix:semicolon
)brace
DECL|function|compute_blocknr
r_static
id|sector_t
id|compute_blocknr
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|i
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
id|raid_disks
op_assign
id|conf-&gt;raid_disks
comma
id|data_disks
op_assign
id|raid_disks
op_minus
l_int|2
suffix:semicolon
id|sector_t
id|new_sector
op_assign
id|sh-&gt;sector
comma
id|check
suffix:semicolon
r_int
id|sectors_per_chunk
op_assign
id|conf-&gt;chunk_size
op_rshift
l_int|9
suffix:semicolon
id|sector_t
id|stripe
suffix:semicolon
r_int
id|chunk_offset
suffix:semicolon
r_int
id|chunk_number
comma
id|dummy1
comma
id|dummy2
comma
id|dd_idx
op_assign
id|i
suffix:semicolon
id|sector_t
id|r_sector
suffix:semicolon
r_int
id|i0
op_assign
id|i
suffix:semicolon
id|chunk_offset
op_assign
id|sector_div
c_func
(paren
id|new_sector
comma
id|sectors_per_chunk
)paren
suffix:semicolon
id|stripe
op_assign
id|new_sector
suffix:semicolon
r_if
c_cond
(paren
id|new_sector
op_ne
id|stripe
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;raid6: ERROR: new_sector = %llu, stripe = %lu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|new_sector
comma
(paren
r_int
r_int
)paren
id|stripe
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|conf-&gt;algorithm
)paren
(brace
r_case
id|ALGORITHM_LEFT_ASYMMETRIC
suffix:colon
r_case
id|ALGORITHM_RIGHT_ASYMMETRIC
suffix:colon
r_if
c_cond
(paren
id|sh-&gt;pd_idx
op_eq
id|raid_disks
op_minus
l_int|1
)paren
id|i
op_decrement
suffix:semicolon
multiline_comment|/* Q D D D P */
r_else
r_if
c_cond
(paren
id|i
OG
id|sh-&gt;pd_idx
)paren
id|i
op_sub_assign
l_int|2
suffix:semicolon
multiline_comment|/* D D P Q D */
r_break
suffix:semicolon
r_case
id|ALGORITHM_LEFT_SYMMETRIC
suffix:colon
r_case
id|ALGORITHM_RIGHT_SYMMETRIC
suffix:colon
r_if
c_cond
(paren
id|sh-&gt;pd_idx
op_eq
id|raid_disks
op_minus
l_int|1
)paren
id|i
op_decrement
suffix:semicolon
multiline_comment|/* Q D D D P */
r_else
(brace
multiline_comment|/* D D P Q D */
r_if
c_cond
(paren
id|i
OL
id|sh-&gt;pd_idx
)paren
id|i
op_add_assign
id|raid_disks
suffix:semicolon
id|i
op_sub_assign
(paren
id|sh-&gt;pd_idx
op_plus
l_int|2
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;raid6: unsupported algorithm %d&bslash;n&quot;
comma
id|conf-&gt;algorithm
)paren
suffix:semicolon
)brace
id|PRINTK
c_func
(paren
l_string|&quot;raid6: compute_blocknr: pd_idx = %u, i0 = %u, i = %u&bslash;n&quot;
comma
id|sh-&gt;pd_idx
comma
id|i0
comma
id|i
)paren
suffix:semicolon
id|chunk_number
op_assign
id|stripe
op_star
id|data_disks
op_plus
id|i
suffix:semicolon
id|r_sector
op_assign
(paren
id|sector_t
)paren
id|chunk_number
op_star
id|sectors_per_chunk
op_plus
id|chunk_offset
suffix:semicolon
id|check
op_assign
id|raid6_compute_sector
(paren
id|r_sector
comma
id|raid_disks
comma
id|data_disks
comma
op_amp
id|dummy1
comma
op_amp
id|dummy2
comma
id|conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|check
op_ne
id|sh-&gt;sector
op_logical_or
id|dummy1
op_ne
id|dd_idx
op_logical_or
id|dummy2
op_ne
id|sh-&gt;pd_idx
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;raid6: compute_blocknr: map not correct&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|r_sector
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy data between a page in the stripe cache, and one or more bion&n; * The page could align with the middle of the bio, or there could be&n; * several bion, each with several bio_vecs, which cover part of the page&n; * Multiple bion are linked together on bi_next.  There may be extras&n; * at the end of this list.  We ignore them.&n; */
DECL|function|copy_data
r_static
r_void
id|copy_data
c_func
(paren
r_int
id|frombio
comma
r_struct
id|bio
op_star
id|bio
comma
r_struct
id|page
op_star
id|page
comma
id|sector_t
id|sector
)paren
(brace
r_char
op_star
id|pa
op_assign
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bvl
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|bio
op_logical_and
id|bio-&gt;bi_sector
OL
id|sector
op_plus
id|STRIPE_SECTORS
suffix:semicolon
id|bio
op_assign
id|r5_next_bio
c_func
(paren
id|bio
comma
id|sector
)paren
)paren
(brace
r_int
id|page_offset
suffix:semicolon
r_if
c_cond
(paren
id|bio-&gt;bi_sector
op_ge
id|sector
)paren
id|page_offset
op_assign
(paren
r_int
)paren
(paren
id|bio-&gt;bi_sector
op_minus
id|sector
)paren
op_star
l_int|512
suffix:semicolon
r_else
id|page_offset
op_assign
(paren
r_int
)paren
(paren
id|sector
op_minus
id|bio-&gt;bi_sector
)paren
op_star
op_minus
l_int|512
suffix:semicolon
id|bio_for_each_segment
c_func
(paren
id|bvl
comma
id|bio
comma
id|i
)paren
(brace
r_int
id|len
op_assign
id|bio_iovec_idx
c_func
(paren
id|bio
comma
id|i
)paren
op_member_access_from_pointer
id|bv_len
suffix:semicolon
r_int
id|clen
suffix:semicolon
r_int
id|b_offset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|page_offset
OL
l_int|0
)paren
(brace
id|b_offset
op_assign
op_minus
id|page_offset
suffix:semicolon
id|page_offset
op_add_assign
id|b_offset
suffix:semicolon
id|len
op_sub_assign
id|b_offset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OG
l_int|0
op_logical_and
id|page_offset
op_plus
id|len
OG
id|STRIPE_SIZE
)paren
id|clen
op_assign
id|STRIPE_SIZE
op_minus
id|page_offset
suffix:semicolon
r_else
id|clen
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|clen
OG
l_int|0
)paren
(brace
r_char
op_star
id|ba
op_assign
id|__bio_kmap_atomic
c_func
(paren
id|bio
comma
id|i
comma
id|KM_USER0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frombio
)paren
id|memcpy
c_func
(paren
id|pa
op_plus
id|page_offset
comma
id|ba
op_plus
id|b_offset
comma
id|clen
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|ba
op_plus
id|b_offset
comma
id|pa
op_plus
id|page_offset
comma
id|clen
)paren
suffix:semicolon
id|__bio_kunmap_atomic
c_func
(paren
id|ba
comma
id|KM_USER0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|clen
OL
id|len
)paren
multiline_comment|/* hit end of page */
r_break
suffix:semicolon
id|page_offset
op_add_assign
id|len
suffix:semicolon
)brace
)brace
)brace
DECL|macro|check_xor
mdefine_line|#define check_xor() &t;do { &t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;   if (count == MAX_XOR_BLOCKS) {&t;&t;&bslash;&n;&t;&t;&t;&t;xor_block(count, STRIPE_SIZE, ptr);&t;&bslash;&n;&t;&t;&t;&t;count = 1;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;   }&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;} while(0)
multiline_comment|/* Compute P and Q syndromes */
DECL|function|compute_parity
r_static
r_void
id|compute_parity
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|method
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
id|i
comma
id|pd_idx
op_assign
id|sh-&gt;pd_idx
comma
id|qd_idx
comma
id|d0_idx
comma
id|disks
op_assign
id|conf-&gt;raid_disks
comma
id|count
suffix:semicolon
r_struct
id|bio
op_star
id|chosen
suffix:semicolon
multiline_comment|/**** FIX THIS: This could be very bad if disks is close to 256 ****/
r_void
op_star
id|ptrs
(braket
id|disks
)braket
suffix:semicolon
id|qd_idx
op_assign
id|raid6_next_disk
c_func
(paren
id|pd_idx
comma
id|disks
)paren
suffix:semicolon
id|d0_idx
op_assign
id|raid6_next_disk
c_func
(paren
id|qd_idx
comma
id|disks
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;compute_parity, stripe %llu, method %d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|method
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|method
)paren
(brace
r_case
id|READ_MODIFY_WRITE
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* READ_MODIFY_WRITE N/A for RAID-6 */
r_case
id|RECONSTRUCT_WRITE
suffix:colon
r_case
id|UPDATE_PARITY
suffix:colon
multiline_comment|/* Is this right? */
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
r_if
c_cond
(paren
id|i
op_ne
id|pd_idx
op_logical_and
id|i
op_ne
id|qd_idx
op_logical_and
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|towrite
)paren
(brace
id|chosen
op_assign
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|towrite
suffix:semicolon
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|towrite
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|written
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|written
op_assign
id|chosen
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CHECK_PARITY
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Not implemented yet */
)brace
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
r_if
c_cond
(paren
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|written
)paren
(brace
id|sector_t
id|sector
op_assign
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|sector
suffix:semicolon
r_struct
id|bio
op_star
id|wbi
op_assign
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|written
suffix:semicolon
r_while
c_loop
(paren
id|wbi
op_logical_and
id|wbi-&gt;bi_sector
OL
id|sector
op_plus
id|STRIPE_SECTORS
)paren
(brace
id|copy_data
c_func
(paren
l_int|1
comma
id|wbi
comma
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|page
comma
id|sector
)paren
suffix:semicolon
id|wbi
op_assign
id|r5_next_bio
c_func
(paren
id|wbi
comma
id|sector
)paren
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
singleline_comment|//&t;switch(method) {
singleline_comment|//&t;case RECONSTRUCT_WRITE:
singleline_comment|//&t;case CHECK_PARITY:
singleline_comment|//&t;case UPDATE_PARITY:
multiline_comment|/* Note that unlike RAID-5, the ordering of the disks matters greatly. */
multiline_comment|/* FIX: Is this ordering of drives even remotely optimal? */
id|count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|d0_idx
suffix:semicolon
r_do
(brace
id|ptrs
(braket
id|count
op_increment
)braket
op_assign
id|page_address
c_func
(paren
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
id|i
op_assign
id|raid6_next_disk
c_func
(paren
id|i
comma
id|disks
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_ne
id|d0_idx
)paren
suffix:semicolon
singleline_comment|//&t;&t;break;
singleline_comment|//&t;}
id|raid6_call
dot
id|gen_syndrome
c_func
(paren
id|disks
comma
id|STRIPE_SIZE
comma
id|ptrs
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|method
)paren
(brace
r_case
id|RECONSTRUCT_WRITE
suffix:colon
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|pd_idx
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|qd_idx
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|sh-&gt;dev
(braket
id|pd_idx
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|sh-&gt;dev
(braket
id|qd_idx
)braket
dot
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UPDATE_PARITY
suffix:colon
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|pd_idx
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|qd_idx
)braket
dot
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Compute one missing block */
DECL|function|compute_block_1
r_static
r_void
id|compute_block_1
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|dd_idx
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
id|i
comma
id|count
comma
id|disks
op_assign
id|conf-&gt;raid_disks
suffix:semicolon
r_void
op_star
id|ptr
(braket
id|MAX_XOR_BLOCKS
)braket
comma
op_star
id|p
suffix:semicolon
r_int
id|pd_idx
op_assign
id|sh-&gt;pd_idx
suffix:semicolon
r_int
id|qd_idx
op_assign
id|raid6_next_disk
c_func
(paren
id|pd_idx
comma
id|disks
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;compute_block_1, stripe %llu, idx %d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|dd_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dd_idx
op_eq
id|qd_idx
)paren
(brace
multiline_comment|/* We&squot;re actually computing the Q drive */
id|compute_parity
c_func
(paren
id|sh
comma
id|UPDATE_PARITY
)paren
suffix:semicolon
)brace
r_else
(brace
id|ptr
(braket
l_int|0
)braket
op_assign
id|page_address
c_func
(paren
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|page
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ptr
(braket
l_int|0
)braket
comma
l_int|0
comma
id|STRIPE_SIZE
)paren
suffix:semicolon
id|count
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|dd_idx
op_logical_or
id|i
op_eq
id|qd_idx
)paren
r_continue
suffix:semicolon
id|p
op_assign
id|page_address
c_func
(paren
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
)paren
id|ptr
(braket
id|count
op_increment
)braket
op_assign
id|p
suffix:semicolon
r_else
id|PRINTK
c_func
(paren
l_string|&quot;compute_block() %d, stripe %llu, %d&quot;
l_string|&quot; not present&bslash;n&quot;
comma
id|dd_idx
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
)paren
suffix:semicolon
id|check_xor
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_ne
l_int|1
)paren
id|xor_block
c_func
(paren
id|count
comma
id|STRIPE_SIZE
comma
id|ptr
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Compute two missing blocks */
DECL|function|compute_block_2
r_static
r_void
id|compute_block_2
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_int
id|dd_idx1
comma
r_int
id|dd_idx2
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
id|i
comma
id|count
comma
id|disks
op_assign
id|conf-&gt;raid_disks
suffix:semicolon
r_int
id|pd_idx
op_assign
id|sh-&gt;pd_idx
suffix:semicolon
r_int
id|qd_idx
op_assign
id|raid6_next_disk
c_func
(paren
id|pd_idx
comma
id|disks
)paren
suffix:semicolon
r_int
id|d0_idx
op_assign
id|raid6_next_disk
c_func
(paren
id|qd_idx
comma
id|disks
)paren
suffix:semicolon
r_int
id|faila
comma
id|failb
suffix:semicolon
multiline_comment|/* faila and failb are disk numbers relative to d0_idx */
multiline_comment|/* pd_idx become disks-2 and qd_idx become disks-1 */
id|faila
op_assign
(paren
id|dd_idx1
OL
id|d0_idx
)paren
ques
c_cond
id|dd_idx1
op_plus
(paren
id|disks
op_minus
id|d0_idx
)paren
suffix:colon
id|dd_idx1
op_minus
id|d0_idx
suffix:semicolon
id|failb
op_assign
(paren
id|dd_idx2
OL
id|d0_idx
)paren
ques
c_cond
id|dd_idx2
op_plus
(paren
id|disks
op_minus
id|d0_idx
)paren
suffix:colon
id|dd_idx2
op_minus
id|d0_idx
suffix:semicolon
id|BUG_ON
c_func
(paren
id|faila
op_eq
id|failb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|failb
OL
id|faila
)paren
(brace
r_int
id|tmp
op_assign
id|faila
suffix:semicolon
id|faila
op_assign
id|failb
suffix:semicolon
id|failb
op_assign
id|tmp
suffix:semicolon
)brace
id|PRINTK
c_func
(paren
l_string|&quot;compute_block_2, stripe %llu, idx %d,%d (%d,%d)&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|dd_idx1
comma
id|dd_idx2
comma
id|faila
comma
id|failb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|failb
op_eq
id|disks
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Q disk is one of the missing disks */
r_if
c_cond
(paren
id|faila
op_eq
id|disks
op_minus
l_int|2
)paren
(brace
multiline_comment|/* Missing P+Q, just recompute */
id|compute_parity
c_func
(paren
id|sh
comma
id|UPDATE_PARITY
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We&squot;re missing D+Q; recompute D from P */
id|compute_block_1
c_func
(paren
id|sh
comma
(paren
id|dd_idx1
op_eq
id|qd_idx
)paren
ques
c_cond
id|dd_idx2
suffix:colon
id|dd_idx1
)paren
suffix:semicolon
id|compute_parity
c_func
(paren
id|sh
comma
id|UPDATE_PARITY
)paren
suffix:semicolon
multiline_comment|/* Is this necessary? */
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* We&squot;re missing D+P or D+D; build pointer table */
(brace
multiline_comment|/**** FIX THIS: This could be very bad if disks is close to 256 ****/
r_void
op_star
id|ptrs
(braket
id|disks
)braket
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
id|d0_idx
suffix:semicolon
r_do
(brace
id|ptrs
(braket
id|count
op_increment
)braket
op_assign
id|page_address
c_func
(paren
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|page
)paren
suffix:semicolon
id|i
op_assign
id|raid6_next_disk
c_func
(paren
id|i
comma
id|disks
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
op_ne
id|d0_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|failb
op_eq
id|disks
op_minus
l_int|2
)paren
(brace
multiline_comment|/* We&squot;re missing D+P. */
id|raid6_datap_recov
c_func
(paren
id|disks
comma
id|STRIPE_SIZE
comma
id|faila
comma
id|ptrs
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* We&squot;re missing D+D. */
id|raid6_2data_recov
c_func
(paren
id|disks
comma
id|STRIPE_SIZE
comma
id|faila
comma
id|failb
comma
id|ptrs
)paren
suffix:semicolon
)brace
multiline_comment|/* Both the above update both missing blocks */
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|dd_idx1
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|dd_idx2
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Each stripe/dev can have one or more bion attached.&n; * toread/towrite point to the first in a chain.&n; * The bi_next chain must be in order.&n; */
DECL|function|add_stripe_bio
r_static
r_void
id|add_stripe_bio
(paren
r_struct
id|stripe_head
op_star
id|sh
comma
r_struct
id|bio
op_star
id|bi
comma
r_int
id|dd_idx
comma
r_int
id|forwrite
)paren
(brace
r_struct
id|bio
op_star
op_star
id|bip
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;adding bh b#%llu to stripe s#%llu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|bi-&gt;bi_sector
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sh-&gt;lock
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|forwrite
)paren
id|bip
op_assign
op_amp
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|towrite
suffix:semicolon
r_else
id|bip
op_assign
op_amp
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|toread
suffix:semicolon
r_while
c_loop
(paren
op_star
id|bip
op_logical_and
(paren
op_star
id|bip
)paren
op_member_access_from_pointer
id|bi_sector
OL
id|bi-&gt;bi_sector
)paren
(brace
id|BUG_ON
c_func
(paren
(paren
op_star
id|bip
)paren
op_member_access_from_pointer
id|bi_sector
op_plus
(paren
(paren
op_star
id|bip
)paren
op_member_access_from_pointer
id|bi_size
op_rshift
l_int|9
)paren
OG
id|bi-&gt;bi_sector
)paren
suffix:semicolon
id|bip
op_assign
op_amp
(paren
op_star
id|bip
)paren
op_member_access_from_pointer
id|bi_next
suffix:semicolon
)brace
multiline_comment|/* FIXME do I need to worry about overlapping bion */
r_if
c_cond
(paren
op_star
id|bip
op_logical_and
id|bi-&gt;bi_next
op_logical_and
(paren
op_star
id|bip
)paren
op_ne
id|bi-&gt;bi_next
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|bip
)paren
id|bi-&gt;bi_next
op_assign
op_star
id|bip
suffix:semicolon
op_star
id|bip
op_assign
id|bi
suffix:semicolon
id|bi-&gt;bi_phys_segments
op_increment
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sh-&gt;lock
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;added bi b#%llu to stripe s#%llu, disk %d.&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|bi-&gt;bi_sector
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|dd_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|forwrite
)paren
(brace
multiline_comment|/* check if page is coverred */
id|sector_t
id|sector
op_assign
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|sector
suffix:semicolon
r_for
c_loop
(paren
id|bi
op_assign
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|towrite
suffix:semicolon
id|sector
OL
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|sector
op_plus
id|STRIPE_SECTORS
op_logical_and
id|bi
op_logical_and
id|bi-&gt;bi_sector
op_le
id|sector
suffix:semicolon
id|bi
op_assign
id|r5_next_bio
c_func
(paren
id|bi
comma
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|sector
)paren
)paren
(brace
r_if
c_cond
(paren
id|bi-&gt;bi_sector
op_plus
(paren
id|bi-&gt;bi_size
op_rshift
l_int|9
)paren
op_ge
id|sector
)paren
id|sector
op_assign
id|bi-&gt;bi_sector
op_plus
(paren
id|bi-&gt;bi_size
op_rshift
l_int|9
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sector
op_ge
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|sector
op_plus
id|STRIPE_SECTORS
)paren
id|set_bit
c_func
(paren
id|R5_OVERWRITE
comma
op_amp
id|sh-&gt;dev
(braket
id|dd_idx
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * handle_stripe - do things to a stripe.&n; *&n; * We lock the stripe and then examine the state of various bits&n; * to see what needs to be done.&n; * Possible results:&n; *    return some read request which now have data&n; *    return some write requests which are safely on disc&n; *    schedule a read on some buffers&n; *    schedule a write of some buffers&n; *    return confirmation of parity correctness&n; *&n; * Parity calculations are done inside the stripe lock&n; * buffers are taken off read_list or write_list, and bh_cache buffers&n; * get BH_Lock set before the stripe lock is released.&n; *&n; */
DECL|function|handle_stripe
r_static
r_void
id|handle_stripe
c_func
(paren
r_struct
id|stripe_head
op_star
id|sh
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|sh-&gt;raid_conf
suffix:semicolon
r_int
id|disks
op_assign
id|conf-&gt;raid_disks
suffix:semicolon
r_struct
id|bio
op_star
id|return_bi
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|bio
op_star
id|bi
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|syncing
suffix:semicolon
r_int
id|locked
op_assign
l_int|0
comma
id|uptodate
op_assign
l_int|0
comma
id|to_read
op_assign
l_int|0
comma
id|to_write
op_assign
l_int|0
comma
id|failed
op_assign
l_int|0
comma
id|written
op_assign
l_int|0
suffix:semicolon
r_int
id|non_overwrite
op_assign
l_int|0
suffix:semicolon
r_int
id|failed_num
(braket
l_int|2
)braket
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_struct
id|r5dev
op_star
id|dev
comma
op_star
id|pdev
comma
op_star
id|qdev
suffix:semicolon
r_int
id|pd_idx
op_assign
id|sh-&gt;pd_idx
suffix:semicolon
r_int
id|qd_idx
op_assign
id|raid6_next_disk
c_func
(paren
id|pd_idx
comma
id|disks
)paren
suffix:semicolon
r_int
id|p_failed
comma
id|q_failed
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;handling stripe %llu, state=%#lx cnt=%d, pd_idx=%d, qd_idx=%d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|sh-&gt;state
comma
id|atomic_read
c_func
(paren
op_amp
id|sh-&gt;count
)paren
comma
id|pd_idx
comma
id|qd_idx
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sh-&gt;lock
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|STRIPE_DELAYED
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|syncing
op_assign
id|test_bit
c_func
(paren
id|STRIPE_SYNCING
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
multiline_comment|/* Now to look around and see what can be done */
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
id|mdk_rdev_t
op_star
id|rdev
suffix:semicolon
id|dev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
suffix:semicolon
id|clear_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|R5_Syncio
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;check %d: state 0x%lx read %p write %p written %p&bslash;n&quot;
comma
id|i
comma
id|dev-&gt;flags
comma
id|dev-&gt;toread
comma
id|dev-&gt;towrite
comma
id|dev-&gt;written
)paren
suffix:semicolon
multiline_comment|/* maybe we can reply to a read */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|dev-&gt;flags
)paren
op_logical_and
id|dev-&gt;toread
)paren
(brace
r_struct
id|bio
op_star
id|rbi
comma
op_star
id|rbi2
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;Return read for disc %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|rbi
op_assign
id|dev-&gt;toread
suffix:semicolon
id|dev-&gt;toread
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rbi
op_logical_and
id|rbi-&gt;bi_sector
OL
id|dev-&gt;sector
op_plus
id|STRIPE_SECTORS
)paren
(brace
id|copy_data
c_func
(paren
l_int|0
comma
id|rbi
comma
id|dev-&gt;page
comma
id|dev-&gt;sector
)paren
suffix:semicolon
id|rbi2
op_assign
id|r5_next_bio
c_func
(paren
id|rbi
comma
id|dev-&gt;sector
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|rbi-&gt;bi_phys_segments
op_eq
l_int|0
)paren
(brace
id|rbi-&gt;bi_next
op_assign
id|return_bi
suffix:semicolon
id|return_bi
op_assign
id|rbi
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|rbi
op_assign
id|rbi2
suffix:semicolon
)brace
)brace
multiline_comment|/* now count some things */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
)paren
id|locked
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|dev-&gt;flags
)paren
)paren
id|uptodate
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;toread
)paren
id|to_read
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;towrite
)paren
(brace
id|to_write
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_OVERWRITE
comma
op_amp
id|dev-&gt;flags
)paren
)paren
id|non_overwrite
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;written
)paren
id|written
op_increment
suffix:semicolon
id|rdev
op_assign
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
suffix:semicolon
multiline_comment|/* FIXME, should I be looking rdev */
r_if
c_cond
(paren
op_logical_neg
id|rdev
op_logical_or
op_logical_neg
id|rdev-&gt;in_sync
)paren
(brace
r_if
c_cond
(paren
id|failed
OL
l_int|2
)paren
id|failed_num
(braket
id|failed
)braket
op_assign
id|i
suffix:semicolon
id|failed
op_increment
suffix:semicolon
)brace
r_else
id|set_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
)brace
id|PRINTK
c_func
(paren
l_string|&quot;locked=%d uptodate=%d to_read=%d&quot;
l_string|&quot; to_write=%d failed=%d failed_num=%d,%d&bslash;n&quot;
comma
id|locked
comma
id|uptodate
comma
id|to_read
comma
id|to_write
comma
id|failed
comma
id|failed_num
(braket
l_int|0
)braket
comma
id|failed_num
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* check if the array has lost &gt;2 devices and, if so, some requests might&n;&t; * need to be failed&n;&t; */
r_if
c_cond
(paren
id|failed
OG
l_int|2
op_logical_and
id|to_read
op_plus
id|to_write
op_plus
id|written
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
multiline_comment|/* fail all writes first */
id|bi
op_assign
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|towrite
suffix:semicolon
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|towrite
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|bi
)paren
id|to_write
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|bi
op_logical_and
id|bi-&gt;bi_sector
OL
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|sector
op_plus
id|STRIPE_SECTORS
)paren
(brace
r_struct
id|bio
op_star
id|nextbi
op_assign
id|r5_next_bio
c_func
(paren
id|bi
comma
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|sector
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|BIO_UPTODATE
comma
op_amp
id|bi-&gt;bi_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|bi-&gt;bi_phys_segments
op_eq
l_int|0
)paren
(brace
id|md_write_end
c_func
(paren
id|conf-&gt;mddev
)paren
suffix:semicolon
id|bi-&gt;bi_next
op_assign
id|return_bi
suffix:semicolon
id|return_bi
op_assign
id|bi
suffix:semicolon
)brace
id|bi
op_assign
id|nextbi
suffix:semicolon
)brace
multiline_comment|/* and fail all &squot;written&squot; */
id|bi
op_assign
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|written
suffix:semicolon
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|written
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|bi
op_logical_and
id|bi-&gt;bi_sector
OL
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|sector
op_plus
id|STRIPE_SECTORS
)paren
(brace
r_struct
id|bio
op_star
id|bi2
op_assign
id|r5_next_bio
c_func
(paren
id|bi
comma
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|sector
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|BIO_UPTODATE
comma
op_amp
id|bi-&gt;bi_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|bi-&gt;bi_phys_segments
op_eq
l_int|0
)paren
(brace
id|md_write_end
c_func
(paren
id|conf-&gt;mddev
)paren
suffix:semicolon
id|bi-&gt;bi_next
op_assign
id|return_bi
suffix:semicolon
id|return_bi
op_assign
id|bi
suffix:semicolon
)brace
id|bi
op_assign
id|bi2
suffix:semicolon
)brace
multiline_comment|/* fail any reads if this device is non-operational */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
)paren
(brace
id|bi
op_assign
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|toread
suffix:semicolon
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|toread
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|bi
)paren
id|to_read
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|bi
op_logical_and
id|bi-&gt;bi_sector
OL
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|sector
op_plus
id|STRIPE_SECTORS
)paren
(brace
r_struct
id|bio
op_star
id|nextbi
op_assign
id|r5_next_bio
c_func
(paren
id|bi
comma
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|sector
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|BIO_UPTODATE
comma
op_amp
id|bi-&gt;bi_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|bi-&gt;bi_phys_segments
op_eq
l_int|0
)paren
(brace
id|bi-&gt;bi_next
op_assign
id|return_bi
suffix:semicolon
id|return_bi
op_assign
id|bi
suffix:semicolon
)brace
id|bi
op_assign
id|nextbi
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|failed
OG
l_int|2
op_logical_and
id|syncing
)paren
(brace
id|md_done_sync
c_func
(paren
id|conf-&gt;mddev
comma
id|STRIPE_SECTORS
comma
l_int|0
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|STRIPE_SYNCING
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|syncing
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * might be able to return some write requests if the parity blocks&n;&t; * are safe, or on a failed drive&n;&t; */
id|pdev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|pd_idx
)braket
suffix:semicolon
id|p_failed
op_assign
(paren
id|failed
op_ge
l_int|1
op_logical_and
id|failed_num
(braket
l_int|0
)braket
op_eq
id|pd_idx
)paren
op_logical_or
(paren
id|failed
op_ge
l_int|2
op_logical_and
id|failed_num
(braket
l_int|1
)braket
op_eq
id|pd_idx
)paren
suffix:semicolon
id|qdev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|qd_idx
)braket
suffix:semicolon
id|q_failed
op_assign
(paren
id|failed
op_ge
l_int|1
op_logical_and
id|failed_num
(braket
l_int|0
)braket
op_eq
id|qd_idx
)paren
op_logical_or
(paren
id|failed
op_ge
l_int|2
op_logical_and
id|failed_num
(braket
l_int|1
)braket
op_eq
id|qd_idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|written
op_logical_and
(paren
id|p_failed
op_logical_or
(paren
(paren
id|test_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|pdev-&gt;flags
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|pdev-&gt;flags
)paren
op_logical_and
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|pdev-&gt;flags
)paren
)paren
)paren
)paren
op_logical_and
(paren
id|q_failed
op_logical_or
(paren
(paren
id|test_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|qdev-&gt;flags
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|qdev-&gt;flags
)paren
op_logical_and
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|qdev-&gt;flags
)paren
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* any written block on an uptodate or failed drive can be&n;&t;&t; * returned.  Note that if we &squot;wrote&squot; to a failed drive,&n;&t;&t; * it will be UPTODATE, but never LOCKED, so we don&squot;t need&n;&t;&t; * to test &squot;failed&squot; directly.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
r_if
c_cond
(paren
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|written
)paren
(brace
id|dev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
op_logical_and
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|dev-&gt;flags
)paren
)paren
(brace
multiline_comment|/* We can return any write requests */
r_struct
id|bio
op_star
id|wbi
comma
op_star
id|wbi2
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;Return write for stripe %llu disc %d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|wbi
op_assign
id|dev-&gt;written
suffix:semicolon
id|dev-&gt;written
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|wbi
op_logical_and
id|wbi-&gt;bi_sector
OL
id|dev-&gt;sector
op_plus
id|STRIPE_SECTORS
)paren
(brace
id|wbi2
op_assign
id|r5_next_bio
c_func
(paren
id|wbi
comma
id|dev-&gt;sector
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|wbi-&gt;bi_phys_segments
op_eq
l_int|0
)paren
(brace
id|md_write_end
c_func
(paren
id|conf-&gt;mddev
)paren
suffix:semicolon
id|wbi-&gt;bi_next
op_assign
id|return_bi
suffix:semicolon
id|return_bi
op_assign
id|wbi
suffix:semicolon
)brace
id|wbi
op_assign
id|wbi2
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Now we might consider reading some blocks, either to check/generate&n;&t; * parity, or to satisfy requests&n;&t; * or to load a block that is being partially written.&n;&t; */
r_if
c_cond
(paren
id|to_read
op_logical_or
id|non_overwrite
op_logical_or
(paren
id|syncing
op_logical_and
(paren
id|uptodate
OL
id|disks
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
id|dev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|dev-&gt;flags
)paren
op_logical_and
(paren
id|dev-&gt;toread
op_logical_or
(paren
id|dev-&gt;towrite
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_OVERWRITE
comma
op_amp
id|dev-&gt;flags
)paren
)paren
op_logical_or
id|syncing
op_logical_or
(paren
id|failed
op_ge
l_int|1
op_logical_and
(paren
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|0
)braket
)braket
dot
id|toread
op_logical_or
(paren
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|0
)braket
)braket
dot
id|towrite
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_OVERWRITE
comma
op_amp
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|0
)braket
)braket
dot
id|flags
)paren
)paren
)paren
)paren
op_logical_or
(paren
id|failed
op_ge
l_int|2
op_logical_and
(paren
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|1
)braket
)braket
dot
id|toread
op_logical_or
(paren
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|1
)braket
)braket
dot
id|towrite
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_OVERWRITE
comma
op_amp
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|1
)braket
)braket
dot
id|flags
)paren
)paren
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* we would like to get this block, possibly&n;&t;&t;&t;&t; * by computing it, but we might not be able to&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|uptodate
op_eq
id|disks
op_minus
l_int|1
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;Computing stripe %llu block %d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
)paren
suffix:semicolon
id|compute_block_1
c_func
(paren
id|sh
comma
id|i
)paren
suffix:semicolon
id|uptodate
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|uptodate
op_eq
id|disks
op_minus
l_int|2
op_logical_and
id|failed
op_ge
l_int|2
)paren
(brace
multiline_comment|/* Computing 2-failure is *very* expensive; only do it if failed &gt;= 2 */
r_int
id|other
suffix:semicolon
r_for
c_loop
(paren
id|other
op_assign
id|disks
suffix:semicolon
id|other
op_decrement
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|other
op_eq
id|i
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|other
)braket
dot
id|flags
)paren
)paren
r_break
suffix:semicolon
)brace
id|BUG_ON
c_func
(paren
id|other
OL
l_int|0
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;Computing stripe %llu blocks %d,%d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
comma
id|other
)paren
suffix:semicolon
id|compute_block_2
c_func
(paren
id|sh
comma
id|i
comma
id|other
)paren
suffix:semicolon
id|uptodate
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|dev-&gt;flags
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_Wantread
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* if I am just reading this block and we don&squot;t have&n;&t;&t;&t;&t;&t;   a failed drive, or any pending writes then sidestep the cache */
r_if
c_cond
(paren
id|sh-&gt;bh_read
(braket
id|i
)braket
op_logical_and
op_logical_neg
id|sh-&gt;bh_read
(braket
id|i
)braket
op_member_access_from_pointer
id|b_reqnext
op_logical_and
op_logical_neg
id|syncing
op_logical_and
op_logical_neg
id|failed
op_logical_and
op_logical_neg
id|to_write
)paren
(brace
id|sh-&gt;bh_cache
(braket
id|i
)braket
op_member_access_from_pointer
id|b_page
op_assign
id|sh-&gt;bh_read
(braket
id|i
)braket
op_member_access_from_pointer
id|b_page
suffix:semicolon
id|sh-&gt;bh_cache
(braket
id|i
)braket
op_member_access_from_pointer
id|b_data
op_assign
id|sh-&gt;bh_read
(braket
id|i
)braket
op_member_access_from_pointer
id|b_data
suffix:semicolon
)brace
macro_line|#endif
id|locked
op_increment
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;Reading block %d (sync=%d)&bslash;n&quot;
comma
id|i
comma
id|syncing
)paren
suffix:semicolon
r_if
c_cond
(paren
id|syncing
)paren
id|md_sync_acct
c_func
(paren
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev-&gt;bdev
comma
id|STRIPE_SECTORS
)paren
suffix:semicolon
)brace
)brace
)brace
id|set_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
)brace
multiline_comment|/* now to consider writing and what else, if anything should be read */
r_if
c_cond
(paren
id|to_write
)paren
(brace
r_int
id|rcw
op_assign
l_int|0
comma
id|must_compute
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
id|dev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Would I have to read this buffer for reconstruct_write */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_OVERWRITE
comma
op_amp
id|dev-&gt;flags
)paren
op_logical_and
id|i
op_ne
id|pd_idx
op_logical_and
id|i
op_ne
id|qd_idx
op_logical_and
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
macro_line|#if 0
op_logical_or
id|sh-&gt;bh_page
(braket
id|i
)braket
op_ne
id|bh-&gt;b_page
macro_line|#endif
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|dev-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|dev-&gt;flags
)paren
)paren
id|rcw
op_increment
suffix:semicolon
r_else
(brace
id|PRINTK
c_func
(paren
l_string|&quot;raid6: must_compute: disk %d flags=%#lx&bslash;n&quot;
comma
id|i
comma
id|dev-&gt;flags
)paren
suffix:semicolon
id|must_compute
op_increment
suffix:semicolon
)brace
)brace
)brace
id|PRINTK
c_func
(paren
l_string|&quot;for sector %llu, rcw=%d, must_compute=%d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|rcw
comma
id|must_compute
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rcw
OG
l_int|0
)paren
multiline_comment|/* want reconstruct write, but need to get some data */
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
id|dev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_OVERWRITE
comma
op_amp
id|dev-&gt;flags
)paren
op_logical_and
op_logical_neg
(paren
id|failed
op_eq
l_int|0
op_logical_and
(paren
id|i
op_eq
id|pd_idx
op_logical_or
id|i
op_eq
id|qd_idx
)paren
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|dev-&gt;flags
)paren
op_logical_and
id|test_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|dev-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|STRIPE_PREREAD_ACTIVE
comma
op_amp
id|sh-&gt;state
)paren
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;Read_old stripe %llu block %d for Reconstruct&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_Wantread
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
id|locked
op_increment
suffix:semicolon
)brace
r_else
(brace
id|PRINTK
c_func
(paren
l_string|&quot;Request delayed stripe %llu block %d for Reconstruct&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|STRIPE_DELAYED
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* now if nothing is locked, and if we have enough data, we can start a write request */
r_if
c_cond
(paren
id|locked
op_eq
l_int|0
op_logical_and
id|rcw
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|must_compute
OG
l_int|0
)paren
(brace
multiline_comment|/* We have failed blocks and need to compute them */
r_switch
c_cond
(paren
id|failed
)paren
(brace
r_case
l_int|0
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_case
l_int|1
suffix:colon
id|compute_block_1
c_func
(paren
id|sh
comma
id|failed_num
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|compute_block_2
c_func
(paren
id|sh
comma
id|failed_num
(braket
l_int|0
)braket
comma
id|failed_num
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* This request should have been failed? */
)brace
)brace
id|PRINTK
c_func
(paren
l_string|&quot;Computing parity for stripe %llu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
)paren
suffix:semicolon
id|compute_parity
c_func
(paren
id|sh
comma
id|RECONSTRUCT_WRITE
)paren
suffix:semicolon
multiline_comment|/* now every locked buffer is ready to be written */
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;Writing stripe %llu block %d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|i
)paren
suffix:semicolon
id|locked
op_increment
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_Wantwrite
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
macro_line|#if 0 /**** FIX: I don&squot;t understand the logic here... ****/
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|R5_Insync
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
op_logical_or
(paren
(paren
id|i
op_eq
id|pd_idx
op_logical_or
id|i
op_eq
id|qd_idx
)paren
op_logical_and
id|failed
op_eq
l_int|0
)paren
)paren
multiline_comment|/* FIX? */
id|set_bit
c_func
(paren
id|STRIPE_INSYNC
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|STRIPE_PREREAD_ACTIVE
comma
op_amp
id|sh-&gt;state
)paren
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|conf-&gt;preread_active_stripes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|conf-&gt;preread_active_stripes
)paren
OL
id|IO_THRESHOLD
)paren
id|md_wakeup_thread
c_func
(paren
id|conf-&gt;mddev-&gt;thread
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* maybe we need to check and possibly fix the parity for this stripe&n;&t; * Any reads will already have been scheduled, so we just see if enough data&n;&t; * is available&n;&t; */
r_if
c_cond
(paren
id|syncing
op_logical_and
id|locked
op_eq
l_int|0
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|STRIPE_INSYNC
comma
op_amp
id|sh-&gt;state
)paren
op_logical_and
id|failed
op_le
l_int|2
)paren
(brace
id|set_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
macro_line|#if 0 /* RAID-6: Don&squot;t support CHECK PARITY yet */
r_if
c_cond
(paren
id|failed
op_eq
l_int|0
)paren
(brace
r_char
op_star
id|pagea
suffix:semicolon
r_if
c_cond
(paren
id|uptodate
op_ne
id|disks
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|compute_parity
c_func
(paren
id|sh
comma
id|CHECK_PARITY
)paren
suffix:semicolon
id|uptodate
op_decrement
suffix:semicolon
id|pagea
op_assign
id|page_address
c_func
(paren
id|sh-&gt;dev
(braket
id|pd_idx
)braket
dot
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
(paren
id|u32
op_star
)paren
id|pagea
)paren
op_eq
l_int|0
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
id|pagea
comma
id|pagea
op_plus
l_int|4
comma
id|STRIPE_SIZE
op_minus
l_int|4
)paren
)paren
(brace
multiline_comment|/* parity is correct (on disc, not in buffer any more) */
id|set_bit
c_func
(paren
id|STRIPE_INSYNC
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|STRIPE_INSYNC
comma
op_amp
id|sh-&gt;state
)paren
)paren
(brace
r_int
id|failed_needupdate
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|r5dev
op_star
id|adev
comma
op_star
id|bdev
suffix:semicolon
r_if
c_cond
(paren
id|failed
OL
l_int|1
)paren
id|failed_num
(braket
l_int|0
)braket
op_assign
id|pd_idx
suffix:semicolon
r_if
c_cond
(paren
id|failed
OL
l_int|2
)paren
id|failed_num
(braket
l_int|1
)braket
op_assign
(paren
id|failed_num
(braket
l_int|0
)braket
op_eq
id|qd_idx
)paren
ques
c_cond
id|pd_idx
suffix:colon
id|qd_idx
suffix:semicolon
id|failed_needupdate
(braket
l_int|0
)braket
op_assign
op_logical_neg
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|0
)braket
)braket
dot
id|flags
)paren
suffix:semicolon
id|failed_needupdate
(braket
l_int|1
)braket
op_assign
op_logical_neg
id|test_bit
c_func
(paren
id|R5_UPTODATE
comma
op_amp
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|1
)braket
)braket
dot
id|flags
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;sync: failed=%d num=%d,%d fnu=%u%u&bslash;n&quot;
comma
id|failed
comma
id|failed_num
(braket
l_int|0
)braket
comma
id|failed_num
(braket
l_int|1
)braket
comma
id|failed_needupdate
(braket
l_int|0
)braket
comma
id|failed_needupdate
(braket
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#if 0  /* RAID-6: This code seems to require that CHECK_PARITY destroys the uptodateness of the parity */
multiline_comment|/* should be able to compute the missing block(s) and write to spare */
r_if
c_cond
(paren
id|failed_needupdate
(braket
l_int|0
)braket
op_xor
id|failed_needupdate
(braket
l_int|1
)braket
)paren
(brace
r_if
c_cond
(paren
id|uptodate
op_plus
l_int|1
op_ne
id|disks
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|compute_block_1
c_func
(paren
id|sh
comma
id|failed_needupdate
(braket
l_int|0
)braket
ques
c_cond
id|failed_num
(braket
l_int|0
)braket
suffix:colon
id|failed_num
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|uptodate
op_increment
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|failed_needupdate
(braket
l_int|0
)braket
op_amp
id|failed_needupdate
(braket
l_int|1
)braket
)paren
(brace
r_if
c_cond
(paren
id|uptodate
op_plus
l_int|2
op_ne
id|disks
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|compute_block_2
c_func
(paren
id|sh
comma
id|failed_num
(braket
l_int|0
)braket
comma
id|failed_num
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|uptodate
op_add_assign
l_int|2
suffix:semicolon
)brace
macro_line|#else
id|compute_block_2
c_func
(paren
id|sh
comma
id|failed_num
(braket
l_int|0
)braket
comma
id|failed_num
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|uptodate
op_add_assign
id|failed_needupdate
(braket
l_int|0
)braket
op_plus
id|failed_needupdate
(braket
l_int|1
)braket
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|uptodate
op_ne
id|disks
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;Marking for sync stripe %llu blocks %d,%d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|failed_num
(braket
l_int|0
)braket
comma
id|failed_num
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/**** FIX: Should we really do both of these unconditionally? ****/
id|adev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|0
)braket
)braket
suffix:semicolon
id|locked
op_add_assign
op_logical_neg
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|adev-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|adev-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_Wantwrite
comma
op_amp
id|adev-&gt;flags
)paren
suffix:semicolon
id|bdev
op_assign
op_amp
id|sh-&gt;dev
(braket
id|failed_num
(braket
l_int|1
)braket
)braket
suffix:semicolon
id|locked
op_add_assign
op_logical_neg
id|test_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|bdev-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|bdev-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_Wantwrite
comma
op_amp
id|bdev-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|STRIPE_INSYNC
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_Syncio
comma
op_amp
id|adev-&gt;flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|R5_Syncio
comma
op_amp
id|bdev-&gt;flags
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|syncing
op_logical_and
id|locked
op_eq
l_int|0
op_logical_and
id|test_bit
c_func
(paren
id|STRIPE_INSYNC
comma
op_amp
id|sh-&gt;state
)paren
)paren
(brace
id|md_done_sync
c_func
(paren
id|conf-&gt;mddev
comma
id|STRIPE_SECTORS
comma
l_int|1
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|STRIPE_SYNCING
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|sh-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|bi
op_assign
id|return_bi
)paren
)paren
(brace
r_int
id|bytes
op_assign
id|bi-&gt;bi_size
suffix:semicolon
id|return_bi
op_assign
id|bi-&gt;bi_next
suffix:semicolon
id|bi-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
id|bi-&gt;bi_size
op_assign
l_int|0
suffix:semicolon
id|bi
op_member_access_from_pointer
id|bi_end_io
c_func
(paren
id|bi
comma
id|bytes
comma
l_int|0
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|disks
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)paren
(brace
r_int
id|rw
suffix:semicolon
r_struct
id|bio
op_star
id|bi
suffix:semicolon
id|mdk_rdev_t
op_star
id|rdev
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|R5_Wantwrite
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
)paren
id|rw
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|R5_Wantread
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
)paren
id|rw
op_assign
l_int|0
suffix:semicolon
r_else
r_continue
suffix:semicolon
id|bi
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|req
suffix:semicolon
id|bi-&gt;bi_rw
op_assign
id|rw
suffix:semicolon
r_if
c_cond
(paren
id|rw
)paren
id|bi-&gt;bi_end_io
op_assign
id|raid6_end_write_request
suffix:semicolon
r_else
id|bi-&gt;bi_end_io
op_assign
id|raid6_end_read_request
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|rdev
op_assign
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
suffix:semicolon
r_if
c_cond
(paren
id|rdev
op_logical_and
id|rdev-&gt;faulty
)paren
id|rdev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rdev
)paren
id|atomic_inc
c_func
(paren
op_amp
id|rdev-&gt;nr_pending
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rdev
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|R5_Syncio
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
)paren
id|md_sync_acct
c_func
(paren
id|rdev-&gt;bdev
comma
id|STRIPE_SECTORS
)paren
suffix:semicolon
id|bi-&gt;bi_bdev
op_assign
id|rdev-&gt;bdev
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;for %llu schedule op %ld on disc %d&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|bi-&gt;bi_rw
comma
id|i
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|sh-&gt;count
)paren
suffix:semicolon
id|bi-&gt;bi_sector
op_assign
id|sh-&gt;sector
op_plus
id|rdev-&gt;data_offset
suffix:semicolon
id|bi-&gt;bi_flags
op_assign
l_int|1
op_lshift
id|BIO_UPTODATE
suffix:semicolon
id|bi-&gt;bi_vcnt
op_assign
l_int|1
suffix:semicolon
id|bi-&gt;bi_idx
op_assign
l_int|0
suffix:semicolon
id|bi-&gt;bi_io_vec
op_assign
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|vec
suffix:semicolon
id|bi-&gt;bi_io_vec
(braket
l_int|0
)braket
dot
id|bv_len
op_assign
id|STRIPE_SIZE
suffix:semicolon
id|bi-&gt;bi_io_vec
(braket
l_int|0
)braket
dot
id|bv_offset
op_assign
l_int|0
suffix:semicolon
id|bi-&gt;bi_size
op_assign
id|STRIPE_SIZE
suffix:semicolon
id|bi-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
id|generic_make_request
c_func
(paren
id|bi
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINTK
c_func
(paren
l_string|&quot;skip op %ld on disc %d for sector %llu&bslash;n&quot;
comma
id|bi-&gt;bi_rw
comma
id|i
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|R5_LOCKED
comma
op_amp
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|STRIPE_HANDLE
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|raid6_activate_delayed
r_static
r_inline
r_void
id|raid6_activate_delayed
c_func
(paren
id|raid6_conf_t
op_star
id|conf
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|conf-&gt;preread_active_stripes
)paren
OL
id|IO_THRESHOLD
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|conf-&gt;delayed_list
)paren
)paren
(brace
r_struct
id|list_head
op_star
id|l
op_assign
id|conf-&gt;delayed_list.next
suffix:semicolon
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
id|sh
op_assign
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|stripe_head
comma
id|lru
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
id|l
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|STRIPE_DELAYED
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|STRIPE_PREREAD_ACTIVE
comma
op_amp
id|sh-&gt;state
)paren
)paren
id|atomic_inc
c_func
(paren
op_amp
id|conf-&gt;preread_active_stripes
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|sh-&gt;lru
comma
op_amp
id|conf-&gt;handle_list
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|unplug_slaves
r_static
r_void
id|unplug_slaves
c_func
(paren
id|mddev_t
op_star
id|mddev
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|mddev_to_conf
c_func
(paren
id|mddev
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mddev-&gt;raid_disks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mdk_rdev_t
op_star
id|rdev
op_assign
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
suffix:semicolon
r_if
c_cond
(paren
id|rdev
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|rdev-&gt;nr_pending
)paren
)paren
(brace
id|request_queue_t
op_star
id|r_queue
op_assign
id|bdev_get_queue
c_func
(paren
id|rdev-&gt;bdev
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|rdev-&gt;nr_pending
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r_queue
op_logical_and
id|r_queue-&gt;unplug_fn
)paren
id|r_queue
op_member_access_from_pointer
id|unplug_fn
c_func
(paren
id|r_queue
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|rdev-&gt;nr_pending
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|raid6_unplug_device
r_static
r_void
id|raid6_unplug_device
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
id|mddev_t
op_star
id|mddev
op_assign
id|q-&gt;queuedata
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
id|mddev_to_conf
c_func
(paren
id|mddev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk_remove_plug
c_func
(paren
id|q
)paren
)paren
id|raid6_activate_delayed
c_func
(paren
id|conf
)paren
suffix:semicolon
id|md_wakeup_thread
c_func
(paren
id|mddev-&gt;thread
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|conf-&gt;device_lock
comma
id|flags
)paren
suffix:semicolon
id|unplug_slaves
c_func
(paren
id|mddev
)paren
suffix:semicolon
)brace
DECL|function|raid6_issue_flush
r_static
r_int
id|raid6_issue_flush
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|gendisk
op_star
id|disk
comma
id|sector_t
op_star
id|error_sector
)paren
(brace
id|mddev_t
op_star
id|mddev
op_assign
id|q-&gt;queuedata
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
id|mddev_to_conf
c_func
(paren
id|mddev
)paren
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|mddev-&gt;raid_disks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mdk_rdev_t
op_star
id|rdev
op_assign
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
suffix:semicolon
r_if
c_cond
(paren
id|rdev
op_logical_and
op_logical_neg
id|rdev-&gt;faulty
)paren
(brace
r_struct
id|block_device
op_star
id|bdev
op_assign
id|rdev-&gt;bdev
suffix:semicolon
id|request_queue_t
op_star
id|r_queue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bdev
)paren
r_continue
suffix:semicolon
id|r_queue
op_assign
id|bdev_get_queue
c_func
(paren
id|bdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r_queue
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r_queue-&gt;issue_flush_fn
)paren
(brace
id|ret
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ret
op_assign
id|r_queue
op_member_access_from_pointer
id|issue_flush_fn
c_func
(paren
id|r_queue
comma
id|bdev-&gt;bd_disk
comma
id|error_sector
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_break
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|raid6_plug_device
r_static
r_inline
r_void
id|raid6_plug_device
c_func
(paren
id|raid6_conf_t
op_star
id|conf
)paren
(brace
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|blk_plug_device
c_func
(paren
id|conf-&gt;mddev-&gt;queue
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
)brace
DECL|function|make_request
r_static
r_int
id|make_request
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|bio
op_star
id|bi
)paren
(brace
id|mddev_t
op_star
id|mddev
op_assign
id|q-&gt;queuedata
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
id|mddev_to_conf
c_func
(paren
id|mddev
)paren
suffix:semicolon
r_const
r_int
r_int
id|raid_disks
op_assign
id|conf-&gt;raid_disks
suffix:semicolon
r_const
r_int
r_int
id|data_disks
op_assign
id|raid_disks
op_minus
l_int|2
suffix:semicolon
r_int
r_int
id|dd_idx
comma
id|pd_idx
suffix:semicolon
id|sector_t
id|new_sector
suffix:semicolon
id|sector_t
id|logical_sector
comma
id|last_sector
suffix:semicolon
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
r_if
c_cond
(paren
id|bio_data_dir
c_func
(paren
id|bi
)paren
op_eq
id|WRITE
)paren
(brace
id|disk_stat_inc
c_func
(paren
id|mddev-&gt;gendisk
comma
id|writes
)paren
suffix:semicolon
id|disk_stat_add
c_func
(paren
id|mddev-&gt;gendisk
comma
id|write_sectors
comma
id|bio_sectors
c_func
(paren
id|bi
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|disk_stat_inc
c_func
(paren
id|mddev-&gt;gendisk
comma
id|reads
)paren
suffix:semicolon
id|disk_stat_add
c_func
(paren
id|mddev-&gt;gendisk
comma
id|read_sectors
comma
id|bio_sectors
c_func
(paren
id|bi
)paren
)paren
suffix:semicolon
)brace
id|logical_sector
op_assign
id|bi-&gt;bi_sector
op_amp
op_complement
(paren
(paren
id|sector_t
)paren
id|STRIPE_SECTORS
op_minus
l_int|1
)paren
suffix:semicolon
id|last_sector
op_assign
id|bi-&gt;bi_sector
op_plus
(paren
id|bi-&gt;bi_size
op_rshift
l_int|9
)paren
suffix:semicolon
id|bi-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
id|bi-&gt;bi_phys_segments
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* over-loaded to count active stripes */
r_if
c_cond
(paren
id|bio_data_dir
c_func
(paren
id|bi
)paren
op_eq
id|WRITE
)paren
id|md_write_start
c_func
(paren
id|mddev
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|logical_sector
OL
id|last_sector
suffix:semicolon
id|logical_sector
op_add_assign
id|STRIPE_SECTORS
)paren
(brace
id|new_sector
op_assign
id|raid6_compute_sector
c_func
(paren
id|logical_sector
comma
id|raid_disks
comma
id|data_disks
comma
op_amp
id|dd_idx
comma
op_amp
id|pd_idx
comma
id|conf
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;raid6: make_request, sector %Lu logical %Lu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|new_sector
comma
(paren
r_int
r_int
r_int
)paren
id|logical_sector
)paren
suffix:semicolon
id|sh
op_assign
id|get_active_stripe
c_func
(paren
id|conf
comma
id|new_sector
comma
id|pd_idx
comma
(paren
id|bi-&gt;bi_rw
op_amp
id|RWA_MASK
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
)paren
(brace
id|add_stripe_bio
c_func
(paren
id|sh
comma
id|bi
comma
id|dd_idx
comma
(paren
id|bi-&gt;bi_rw
op_amp
id|RW_MASK
)paren
)paren
suffix:semicolon
id|raid6_plug_device
c_func
(paren
id|conf
)paren
suffix:semicolon
id|handle_stripe
c_func
(paren
id|sh
)paren
suffix:semicolon
id|release_stripe
c_func
(paren
id|sh
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* cannot get stripe for read-ahead, just give-up */
id|clear_bit
c_func
(paren
id|BIO_UPTODATE
comma
op_amp
id|bi-&gt;bi_flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|bi-&gt;bi_phys_segments
op_eq
l_int|0
)paren
(brace
r_int
id|bytes
op_assign
id|bi-&gt;bi_size
suffix:semicolon
r_if
c_cond
(paren
id|bio_data_dir
c_func
(paren
id|bi
)paren
op_eq
id|WRITE
)paren
id|md_write_end
c_func
(paren
id|mddev
)paren
suffix:semicolon
id|bi-&gt;bi_size
op_assign
l_int|0
suffix:semicolon
id|bi
op_member_access_from_pointer
id|bi_end_io
c_func
(paren
id|bi
comma
id|bytes
comma
l_int|0
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME go_faster isn&squot;t used */
DECL|function|sync_request
r_static
r_int
id|sync_request
(paren
id|mddev_t
op_star
id|mddev
comma
id|sector_t
id|sector_nr
comma
r_int
id|go_faster
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
(paren
id|raid6_conf_t
op_star
)paren
id|mddev
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
r_int
id|sectors_per_chunk
op_assign
id|conf-&gt;chunk_size
op_rshift
l_int|9
suffix:semicolon
id|sector_t
id|x
suffix:semicolon
r_int
r_int
id|stripe
suffix:semicolon
r_int
id|chunk_offset
suffix:semicolon
r_int
id|dd_idx
comma
id|pd_idx
suffix:semicolon
id|sector_t
id|first_sector
suffix:semicolon
r_int
id|raid_disks
op_assign
id|conf-&gt;raid_disks
suffix:semicolon
r_int
id|data_disks
op_assign
id|raid_disks
op_minus
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|sector_nr
op_ge
id|mddev-&gt;size
op_lshift
l_int|1
)paren
(brace
multiline_comment|/* just being told to finish up .. nothing much to do */
id|unplug_slaves
c_func
(paren
id|mddev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|x
op_assign
id|sector_nr
suffix:semicolon
id|chunk_offset
op_assign
id|sector_div
c_func
(paren
id|x
comma
id|sectors_per_chunk
)paren
suffix:semicolon
id|stripe
op_assign
id|x
suffix:semicolon
id|BUG_ON
c_func
(paren
id|x
op_ne
id|stripe
)paren
suffix:semicolon
id|first_sector
op_assign
id|raid6_compute_sector
c_func
(paren
(paren
id|sector_t
)paren
id|stripe
op_star
id|data_disks
op_star
id|sectors_per_chunk
op_plus
id|chunk_offset
comma
id|raid_disks
comma
id|data_disks
comma
op_amp
id|dd_idx
comma
op_amp
id|pd_idx
comma
id|conf
)paren
suffix:semicolon
id|sh
op_assign
id|get_active_stripe
c_func
(paren
id|conf
comma
id|sector_nr
comma
id|pd_idx
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sh
op_eq
l_int|NULL
)paren
(brace
id|sh
op_assign
id|get_active_stripe
c_func
(paren
id|conf
comma
id|sector_nr
comma
id|pd_idx
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* make sure we don&squot;t swamp the stripe cache if someone else&n;&t;&t; * is trying to get access&n;&t;&t; */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|sh-&gt;lock
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|STRIPE_SYNCING
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|STRIPE_INSYNC
comma
op_amp
id|sh-&gt;state
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sh-&gt;lock
)paren
suffix:semicolon
id|handle_stripe
c_func
(paren
id|sh
)paren
suffix:semicolon
id|release_stripe
c_func
(paren
id|sh
)paren
suffix:semicolon
r_return
id|STRIPE_SECTORS
suffix:semicolon
)brace
multiline_comment|/*&n; * This is our raid6 kernel thread.&n; *&n; * We scan the hash table for stripes which can be handled now.&n; * During the scan, completed stripes are saved for us by the interrupt&n; * handler, so that they will not have to wait for our next wakeup.&n; */
DECL|function|raid6d
r_static
r_void
id|raid6d
(paren
id|mddev_t
op_star
id|mddev
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
id|mddev_to_conf
c_func
(paren
id|mddev
)paren
suffix:semicolon
r_int
id|handled
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;+++ raid6d active&bslash;n&quot;
)paren
suffix:semicolon
id|md_check_recovery
c_func
(paren
id|mddev
)paren
suffix:semicolon
id|md_handle_safemode
c_func
(paren
id|mddev
)paren
suffix:semicolon
id|handled
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_struct
id|list_head
op_star
id|first
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|conf-&gt;handle_list
)paren
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|conf-&gt;preread_active_stripes
)paren
OL
id|IO_THRESHOLD
op_logical_and
op_logical_neg
id|blk_queue_plugged
c_func
(paren
id|mddev-&gt;queue
)paren
op_logical_and
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|conf-&gt;delayed_list
)paren
)paren
id|raid6_activate_delayed
c_func
(paren
id|conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|conf-&gt;handle_list
)paren
)paren
r_break
suffix:semicolon
id|first
op_assign
id|conf-&gt;handle_list.next
suffix:semicolon
id|sh
op_assign
id|list_entry
c_func
(paren
id|first
comma
r_struct
id|stripe_head
comma
id|lru
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
id|first
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|sh-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sh-&gt;count
)paren
op_ne
l_int|1
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|handled
op_increment
suffix:semicolon
id|handle_stripe
c_func
(paren
id|sh
)paren
suffix:semicolon
id|release_stripe
c_func
(paren
id|sh
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
)brace
id|PRINTK
c_func
(paren
l_string|&quot;%d stripes handled&bslash;n&quot;
comma
id|handled
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|unplug_slaves
c_func
(paren
id|mddev
)paren
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;--- raid6d inactive&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|run
r_static
r_int
id|run
(paren
id|mddev_t
op_star
id|mddev
)paren
(brace
id|raid6_conf_t
op_star
id|conf
suffix:semicolon
r_int
id|raid_disk
comma
id|memory
suffix:semicolon
id|mdk_rdev_t
op_star
id|rdev
suffix:semicolon
r_struct
id|disk_info
op_star
id|disk
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|mddev-&gt;level
op_ne
l_int|6
)paren
(brace
id|PRINTK
c_func
(paren
l_string|&quot;raid6: %s: raid level not set to 6 (%d)&bslash;n&quot;
comma
id|mdname
c_func
(paren
id|mddev
)paren
comma
id|mddev-&gt;level
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|mddev
op_member_access_from_pointer
r_private
op_assign
id|kmalloc
(paren
r_sizeof
(paren
id|raid6_conf_t
)paren
op_plus
id|mddev-&gt;raid_disks
op_star
r_sizeof
(paren
r_struct
id|disk_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conf
op_assign
id|mddev
op_member_access_from_pointer
r_private
)paren
op_eq
l_int|NULL
)paren
r_goto
m_abort
suffix:semicolon
id|memset
(paren
id|conf
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|conf
)paren
op_plus
id|mddev-&gt;raid_disks
op_star
r_sizeof
(paren
r_struct
id|disk_info
)paren
)paren
suffix:semicolon
id|conf-&gt;mddev
op_assign
id|mddev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|conf-&gt;stripe_hashtbl
op_assign
(paren
r_struct
id|stripe_head
op_star
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|HASH_PAGES_ORDER
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
m_abort
suffix:semicolon
id|memset
c_func
(paren
id|conf-&gt;stripe_hashtbl
comma
l_int|0
comma
id|HASH_PAGES
op_star
id|PAGE_SIZE
)paren
suffix:semicolon
id|conf-&gt;device_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|conf-&gt;wait_for_stripe
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|conf-&gt;handle_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|conf-&gt;delayed_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|conf-&gt;inactive_list
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|conf-&gt;active_stripes
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|conf-&gt;preread_active_stripes
comma
l_int|0
)paren
suffix:semicolon
id|mddev-&gt;queue-&gt;unplug_fn
op_assign
id|raid6_unplug_device
suffix:semicolon
id|mddev-&gt;queue-&gt;issue_flush_fn
op_assign
id|raid6_issue_flush
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;raid6: run(%s) called.&bslash;n&quot;
comma
id|mdname
c_func
(paren
id|mddev
)paren
)paren
suffix:semicolon
id|ITERATE_RDEV
c_func
(paren
id|mddev
comma
id|rdev
comma
id|tmp
)paren
(brace
id|raid_disk
op_assign
id|rdev-&gt;raid_disk
suffix:semicolon
r_if
c_cond
(paren
id|raid_disk
op_ge
id|mddev-&gt;raid_disks
op_logical_or
id|raid_disk
OL
l_int|0
)paren
r_continue
suffix:semicolon
id|disk
op_assign
id|conf-&gt;disks
op_plus
id|raid_disk
suffix:semicolon
id|disk-&gt;rdev
op_assign
id|rdev
suffix:semicolon
r_if
c_cond
(paren
id|rdev-&gt;in_sync
)paren
(brace
r_char
id|b
(braket
id|BDEVNAME_SIZE
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;raid6: device %s operational as raid&quot;
l_string|&quot; disk %d&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|rdev-&gt;bdev
comma
id|b
)paren
comma
id|raid_disk
)paren
suffix:semicolon
id|conf-&gt;working_disks
op_increment
suffix:semicolon
)brace
)brace
id|conf-&gt;raid_disks
op_assign
id|mddev-&gt;raid_disks
suffix:semicolon
multiline_comment|/*&n;&t; * 0 for a fully functional array, 1 or 2 for a degraded array.&n;&t; */
id|mddev-&gt;degraded
op_assign
id|conf-&gt;failed_disks
op_assign
id|conf-&gt;raid_disks
op_minus
id|conf-&gt;working_disks
suffix:semicolon
id|conf-&gt;mddev
op_assign
id|mddev
suffix:semicolon
id|conf-&gt;chunk_size
op_assign
id|mddev-&gt;chunk_size
suffix:semicolon
id|conf-&gt;level
op_assign
id|mddev-&gt;level
suffix:semicolon
id|conf-&gt;algorithm
op_assign
id|mddev-&gt;layout
suffix:semicolon
id|conf-&gt;max_nr_stripes
op_assign
id|NR_STRIPES
suffix:semicolon
multiline_comment|/* device size must be a multiple of chunk size */
id|mddev-&gt;size
op_and_assign
op_complement
(paren
id|mddev-&gt;chunk_size
op_div
l_int|1024
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;raid_disks
OL
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;raid6: not enough configured devices for %s (%d, minimum 4)&bslash;n&quot;
comma
id|mdname
c_func
(paren
id|mddev
)paren
comma
id|conf-&gt;raid_disks
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|conf-&gt;chunk_size
op_logical_or
id|conf-&gt;chunk_size
op_mod
l_int|4
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;raid6: invalid chunk size %d for %s&bslash;n&quot;
comma
id|conf-&gt;chunk_size
comma
id|mdname
c_func
(paren
id|mddev
)paren
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conf-&gt;algorithm
OG
id|ALGORITHM_RIGHT_SYMMETRIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;raid6: unsupported parity algorithm %d for %s&bslash;n&quot;
comma
id|conf-&gt;algorithm
comma
id|mdname
c_func
(paren
id|mddev
)paren
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mddev-&gt;degraded
OG
l_int|2
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;raid6: not enough operational devices for %s&quot;
l_string|&quot; (%d/%d failed)&bslash;n&quot;
comma
id|mdname
c_func
(paren
id|mddev
)paren
comma
id|conf-&gt;failed_disks
comma
id|conf-&gt;raid_disks
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
macro_line|#if 0&t;&t;&t;&t;/* FIX: For now */
r_if
c_cond
(paren
id|mddev-&gt;degraded
OG
l_int|0
op_logical_and
id|mddev-&gt;recovery_cp
op_ne
id|MaxSector
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;raid6: cannot start dirty degraded array for %s&bslash;n&quot;
comma
id|mdname
c_func
(paren
id|mddev
)paren
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
macro_line|#endif
(brace
id|mddev-&gt;thread
op_assign
id|md_register_thread
c_func
(paren
id|raid6d
comma
id|mddev
comma
l_string|&quot;%s_raid6&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mddev-&gt;thread
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;raid6: couldn&squot;t allocate thread for %s&bslash;n&quot;
comma
id|mdname
c_func
(paren
id|mddev
)paren
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
)brace
id|memory
op_assign
id|conf-&gt;max_nr_stripes
op_star
(paren
r_sizeof
(paren
r_struct
id|stripe_head
)paren
op_plus
id|conf-&gt;raid_disks
op_star
(paren
(paren
r_sizeof
(paren
r_struct
id|bio
)paren
op_plus
id|PAGE_SIZE
)paren
)paren
)paren
op_div
l_int|1024
suffix:semicolon
r_if
c_cond
(paren
id|grow_stripes
c_func
(paren
id|conf
comma
id|conf-&gt;max_nr_stripes
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;raid6: couldn&squot;t allocate %dkB for buffers&bslash;n&quot;
comma
id|memory
)paren
suffix:semicolon
id|shrink_stripes
c_func
(paren
id|conf
)paren
suffix:semicolon
id|md_unregister_thread
c_func
(paren
id|mddev-&gt;thread
)paren
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;raid6: allocated %dkB for %s&bslash;n&quot;
comma
id|memory
comma
id|mdname
c_func
(paren
id|mddev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mddev-&gt;degraded
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;raid6: raid level %d set %s active with %d out of %d&quot;
l_string|&quot; devices, algorithm %d&bslash;n&quot;
comma
id|conf-&gt;level
comma
id|mdname
c_func
(paren
id|mddev
)paren
comma
id|mddev-&gt;raid_disks
op_minus
id|mddev-&gt;degraded
comma
id|mddev-&gt;raid_disks
comma
id|conf-&gt;algorithm
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;raid6: raid level %d set %s active with %d&quot;
l_string|&quot; out of %d devices, algorithm %d&bslash;n&quot;
comma
id|conf-&gt;level
comma
id|mdname
c_func
(paren
id|mddev
)paren
comma
id|mddev-&gt;raid_disks
op_minus
id|mddev-&gt;degraded
comma
id|mddev-&gt;raid_disks
comma
id|conf-&gt;algorithm
)paren
suffix:semicolon
id|print_raid6_conf
c_func
(paren
id|conf
)paren
suffix:semicolon
multiline_comment|/* read-ahead size must cover two whole stripes, which is&n;&t; * 2 * (n-2) * chunksize where &squot;n&squot; is the number of raid devices&n;&t; */
(brace
r_int
id|stripe
op_assign
(paren
id|mddev-&gt;raid_disks
op_minus
l_int|2
)paren
op_star
id|mddev-&gt;chunk_size
op_div
id|PAGE_CACHE_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|mddev-&gt;queue-&gt;backing_dev_info.ra_pages
OL
l_int|2
op_star
id|stripe
)paren
id|mddev-&gt;queue-&gt;backing_dev_info.ra_pages
op_assign
l_int|2
op_star
id|stripe
suffix:semicolon
)brace
multiline_comment|/* Ok, everything is just fine now */
id|mddev-&gt;array_size
op_assign
id|mddev-&gt;size
op_star
(paren
id|mddev-&gt;raid_disks
op_minus
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
m_abort
suffix:colon
r_if
c_cond
(paren
id|conf
)paren
(brace
id|print_raid6_conf
c_func
(paren
id|conf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conf-&gt;stripe_hashtbl
)paren
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|conf-&gt;stripe_hashtbl
comma
id|HASH_PAGES_ORDER
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|conf
)paren
suffix:semicolon
)brace
id|mddev
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ALERT
l_string|&quot;raid6: failed to run raid set %s&bslash;n&quot;
comma
id|mdname
c_func
(paren
id|mddev
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|stop
r_static
r_int
id|stop
(paren
id|mddev_t
op_star
id|mddev
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
(paren
id|raid6_conf_t
op_star
)paren
id|mddev
op_member_access_from_pointer
r_private
suffix:semicolon
id|md_unregister_thread
c_func
(paren
id|mddev-&gt;thread
)paren
suffix:semicolon
id|mddev-&gt;thread
op_assign
l_int|NULL
suffix:semicolon
id|shrink_stripes
c_func
(paren
id|conf
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|conf-&gt;stripe_hashtbl
comma
id|HASH_PAGES_ORDER
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|conf
)paren
suffix:semicolon
id|mddev
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if RAID6_DUMPSTATE
DECL|function|print_sh
r_static
r_void
id|print_sh
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_struct
id|stripe_head
op_star
id|sh
)paren
(brace
r_int
id|i
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;sh %llu, pd_idx %d, state %ld.&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|sh-&gt;pd_idx
comma
id|sh-&gt;state
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;sh %llu,  count %d.&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
comma
id|atomic_read
c_func
(paren
op_amp
id|sh-&gt;count
)paren
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;sh %llu, &quot;
comma
(paren
r_int
r_int
r_int
)paren
id|sh-&gt;sector
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sh-&gt;raid_conf-&gt;raid_disks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;(cache%d: %p %ld) &quot;
comma
id|i
comma
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|page
comma
id|sh-&gt;dev
(braket
id|i
)braket
dot
id|flags
)paren
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|printall
r_static
r_void
id|printall
(paren
r_struct
id|seq_file
op_star
id|seq
comma
id|raid6_conf_t
op_star
id|conf
)paren
(brace
r_struct
id|stripe_head
op_star
id|sh
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_HASH
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sh
op_assign
id|conf-&gt;stripe_hashtbl
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|sh
suffix:semicolon
id|sh
op_assign
id|sh-&gt;hash_next
)paren
(brace
r_if
c_cond
(paren
id|sh-&gt;raid_conf
op_ne
id|conf
)paren
r_continue
suffix:semicolon
id|print_sh
c_func
(paren
id|seq
comma
id|sh
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|status
r_static
r_void
id|status
(paren
r_struct
id|seq_file
op_star
id|seq
comma
id|mddev_t
op_star
id|mddev
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
(paren
id|raid6_conf_t
op_star
)paren
id|mddev
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|i
suffix:semicolon
id|seq_printf
(paren
id|seq
comma
l_string|&quot; level %d, %dk chunk, algorithm %d&quot;
comma
id|mddev-&gt;level
comma
id|mddev-&gt;chunk_size
op_rshift
l_int|10
comma
id|mddev-&gt;layout
)paren
suffix:semicolon
id|seq_printf
(paren
id|seq
comma
l_string|&quot; [%d/%d] [&quot;
comma
id|conf-&gt;raid_disks
comma
id|conf-&gt;working_disks
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|conf-&gt;raid_disks
suffix:semicolon
id|i
op_increment
)paren
id|seq_printf
(paren
id|seq
comma
l_string|&quot;%s&quot;
comma
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev
op_logical_and
id|conf-&gt;disks
(braket
id|i
)braket
dot
id|rdev-&gt;in_sync
ques
c_cond
l_string|&quot;U&quot;
suffix:colon
l_string|&quot;_&quot;
)paren
suffix:semicolon
id|seq_printf
(paren
id|seq
comma
l_string|&quot;]&quot;
)paren
suffix:semicolon
macro_line|#if RAID6_DUMPSTATE
id|seq_printf
(paren
id|seq
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printall
c_func
(paren
id|seq
comma
id|conf
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|print_raid6_conf
r_static
r_void
id|print_raid6_conf
(paren
id|raid6_conf_t
op_star
id|conf
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|disk_info
op_star
id|tmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RAID6 conf printout:&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conf
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;(conf==NULL)&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; --- rd:%d wd:%d fd:%d&bslash;n&quot;
comma
id|conf-&gt;raid_disks
comma
id|conf-&gt;working_disks
comma
id|conf-&gt;failed_disks
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|conf-&gt;raid_disks
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|b
(braket
id|BDEVNAME_SIZE
)braket
suffix:semicolon
id|tmp
op_assign
id|conf-&gt;disks
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|tmp-&gt;rdev
)paren
id|printk
c_func
(paren
l_string|&quot; disk %d, o:%d, dev:%s&bslash;n&quot;
comma
id|i
comma
op_logical_neg
id|tmp-&gt;rdev-&gt;faulty
comma
id|bdevname
c_func
(paren
id|tmp-&gt;rdev-&gt;bdev
comma
id|b
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|raid6_spare_active
r_static
r_int
id|raid6_spare_active
c_func
(paren
id|mddev_t
op_star
id|mddev
)paren
(brace
r_int
id|i
suffix:semicolon
id|raid6_conf_t
op_star
id|conf
op_assign
id|mddev
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|disk_info
op_star
id|tmp
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|conf-&gt;raid_disks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp
op_assign
id|conf-&gt;disks
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|tmp-&gt;rdev
op_logical_and
op_logical_neg
id|tmp-&gt;rdev-&gt;faulty
op_logical_and
op_logical_neg
id|tmp-&gt;rdev-&gt;in_sync
)paren
(brace
id|mddev-&gt;degraded
op_decrement
suffix:semicolon
id|conf-&gt;failed_disks
op_decrement
suffix:semicolon
id|conf-&gt;working_disks
op_increment
suffix:semicolon
id|tmp-&gt;rdev-&gt;in_sync
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|print_raid6_conf
c_func
(paren
id|conf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|raid6_remove_disk
r_static
r_int
id|raid6_remove_disk
c_func
(paren
id|mddev_t
op_star
id|mddev
comma
r_int
id|number
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|mddev
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|err
op_assign
l_int|1
suffix:semicolon
r_struct
id|disk_info
op_star
id|p
op_assign
id|conf-&gt;disks
op_plus
id|number
suffix:semicolon
id|print_raid6_conf
c_func
(paren
id|conf
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;rdev
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;rdev-&gt;in_sync
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|p-&gt;rdev-&gt;nr_pending
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
id|p-&gt;rdev
op_assign
l_int|NULL
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
id|MD_BUG
c_func
(paren
)paren
suffix:semicolon
m_abort
suffix:colon
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|print_raid6_conf
c_func
(paren
id|conf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|raid6_add_disk
r_static
r_int
id|raid6_add_disk
c_func
(paren
id|mddev_t
op_star
id|mddev
comma
id|mdk_rdev_t
op_star
id|rdev
)paren
(brace
id|raid6_conf_t
op_star
id|conf
op_assign
id|mddev
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|disk
suffix:semicolon
r_struct
id|disk_info
op_star
id|p
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * find the disk ...&n;&t; */
r_for
c_loop
(paren
id|disk
op_assign
l_int|0
suffix:semicolon
id|disk
OL
id|mddev-&gt;raid_disks
suffix:semicolon
id|disk
op_increment
)paren
r_if
c_cond
(paren
(paren
id|p
op_assign
id|conf-&gt;disks
op_plus
id|disk
)paren
op_member_access_from_pointer
id|rdev
op_eq
l_int|NULL
)paren
(brace
id|p-&gt;rdev
op_assign
id|rdev
suffix:semicolon
id|rdev-&gt;in_sync
op_assign
l_int|0
suffix:semicolon
id|rdev-&gt;raid_disk
op_assign
id|disk
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|conf-&gt;device_lock
)paren
suffix:semicolon
id|print_raid6_conf
c_func
(paren
id|conf
)paren
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
DECL|function|raid6_resize
r_static
r_int
id|raid6_resize
c_func
(paren
id|mddev_t
op_star
id|mddev
comma
id|sector_t
id|sectors
)paren
(brace
multiline_comment|/* no resync is happening, and there is enough space&n;&t; * on all devices, so we can resize.&n;&t; * We need to make sure resync covers any new space.&n;&t; * If the array is shrinking we should possibly wait until&n;&t; * any io in the removed space completes, but it hardly seems&n;&t; * worth it.&n;&t; */
id|sectors
op_and_assign
op_complement
(paren
(paren
id|sector_t
)paren
id|mddev-&gt;chunk_size
op_div
l_int|512
op_minus
l_int|1
)paren
suffix:semicolon
id|mddev-&gt;array_size
op_assign
(paren
id|sectors
op_star
(paren
id|mddev-&gt;raid_disks
op_minus
l_int|2
)paren
)paren
op_rshift
l_int|1
suffix:semicolon
id|set_capacity
c_func
(paren
id|mddev-&gt;gendisk
comma
id|mddev-&gt;array_size
op_lshift
l_int|1
)paren
suffix:semicolon
id|mddev-&gt;changed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sectors
op_div
l_int|2
OG
id|mddev-&gt;size
op_logical_and
id|mddev-&gt;recovery_cp
op_eq
id|MaxSector
)paren
(brace
id|mddev-&gt;recovery_cp
op_assign
id|mddev-&gt;size
op_lshift
l_int|1
suffix:semicolon
id|set_bit
c_func
(paren
id|MD_RECOVERY_NEEDED
comma
op_amp
id|mddev-&gt;recovery
)paren
suffix:semicolon
)brace
id|mddev-&gt;size
op_assign
id|sectors
op_div
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|raid6_personality
r_static
id|mdk_personality_t
id|raid6_personality
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;raid6&quot;
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|make_request
op_assign
id|make_request
comma
dot
id|run
op_assign
id|run
comma
dot
id|stop
op_assign
id|stop
comma
dot
id|status
op_assign
id|status
comma
dot
id|error_handler
op_assign
id|error
comma
dot
id|hot_add_disk
op_assign
id|raid6_add_disk
comma
dot
id|hot_remove_disk
op_assign
id|raid6_remove_disk
comma
dot
id|spare_active
op_assign
id|raid6_spare_active
comma
dot
id|sync_request
op_assign
id|sync_request
comma
dot
id|resize
op_assign
id|raid6_resize
comma
)brace
suffix:semicolon
DECL|function|raid6_init
r_static
r_int
id|__init
id|raid6_init
(paren
r_void
)paren
(brace
r_int
id|e
suffix:semicolon
id|e
op_assign
id|raid6_select_algo
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
)paren
r_return
id|e
suffix:semicolon
r_return
id|register_md_personality
(paren
id|RAID6
comma
op_amp
id|raid6_personality
)paren
suffix:semicolon
)brace
DECL|function|raid6_exit
r_static
r_void
id|raid6_exit
(paren
r_void
)paren
(brace
id|unregister_md_personality
(paren
id|RAID6
)paren
suffix:semicolon
)brace
DECL|variable|raid6_init
id|module_init
c_func
(paren
id|raid6_init
)paren
suffix:semicolon
DECL|variable|raid6_exit
id|module_exit
c_func
(paren
id|raid6_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_ALIAS
c_func
(paren
l_string|&quot;md-personality-8&quot;
)paren
suffix:semicolon
multiline_comment|/* RAID6 */
eof
