multiline_comment|/* -*- linux-c -*- ------------------------------------------------------- *&n; *&n; *   Copyright 2002 H. Peter Anvin - All Rights Reserved&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation, Inc., 53 Temple Place Ste 330,&n; *   Bostom MA 02111-1307, USA; either version 2 of the License, or&n; *   (at your option) any later version; incorporated herein by reference.&n; *&n; * ----------------------------------------------------------------------- */
multiline_comment|/*&n; * raid6recov.c&n; *&n; * RAID-6 data recovery in dual failure mode.  In single failure mode,&n; * use the RAID-5 algorithm (or, in the case of Q failure, just reconstruct&n; * the syndrome.)&n; */
macro_line|#include &quot;raid6.h&quot;
multiline_comment|/* Recover two failed data blocks. */
DECL|function|raid6_2data_recov
r_void
id|raid6_2data_recov
c_func
(paren
r_int
id|disks
comma
r_int
id|bytes
comma
r_int
id|faila
comma
r_int
id|failb
comma
r_void
op_star
op_star
id|ptrs
)paren
(brace
id|u8
op_star
id|p
comma
op_star
id|q
comma
op_star
id|dp
comma
op_star
id|dq
suffix:semicolon
id|u8
id|px
comma
id|qx
comma
id|db
suffix:semicolon
r_const
id|u8
op_star
id|pbmul
suffix:semicolon
multiline_comment|/* P multiplier table for B data */
r_const
id|u8
op_star
id|qmul
suffix:semicolon
multiline_comment|/* Q multiplier table (for both) */
id|p
op_assign
(paren
id|u8
op_star
)paren
id|ptrs
(braket
id|disks
op_minus
l_int|2
)braket
suffix:semicolon
id|q
op_assign
(paren
id|u8
op_star
)paren
id|ptrs
(braket
id|disks
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Compute syndrome with zero for the missing data pages&n;&t;   Use the dead data pages as temporary storage for&n;&t;   delta p and delta q */
id|dp
op_assign
(paren
id|u8
op_star
)paren
id|ptrs
(braket
id|faila
)braket
suffix:semicolon
id|ptrs
(braket
id|faila
)braket
op_assign
(paren
r_void
op_star
)paren
id|raid6_empty_zero_page
suffix:semicolon
id|ptrs
(braket
id|disks
op_minus
l_int|2
)braket
op_assign
id|dp
suffix:semicolon
id|dq
op_assign
(paren
id|u8
op_star
)paren
id|ptrs
(braket
id|failb
)braket
suffix:semicolon
id|ptrs
(braket
id|failb
)braket
op_assign
(paren
r_void
op_star
)paren
id|raid6_empty_zero_page
suffix:semicolon
id|ptrs
(braket
id|disks
op_minus
l_int|1
)braket
op_assign
id|dq
suffix:semicolon
id|raid6_call
dot
id|gen_syndrome
c_func
(paren
id|disks
comma
id|bytes
comma
id|ptrs
)paren
suffix:semicolon
multiline_comment|/* Restore pointer table */
id|ptrs
(braket
id|faila
)braket
op_assign
id|dp
suffix:semicolon
id|ptrs
(braket
id|failb
)braket
op_assign
id|dq
suffix:semicolon
id|ptrs
(braket
id|disks
op_minus
l_int|2
)braket
op_assign
id|p
suffix:semicolon
id|ptrs
(braket
id|disks
op_minus
l_int|1
)braket
op_assign
id|q
suffix:semicolon
multiline_comment|/* Now, pick the proper data tables */
id|pbmul
op_assign
id|raid6_gfmul
(braket
id|raid6_gfexi
(braket
id|failb
op_minus
id|faila
)braket
)braket
suffix:semicolon
id|qmul
op_assign
id|raid6_gfmul
(braket
id|raid6_gfinv
(braket
id|raid6_gfexp
(braket
id|faila
)braket
op_xor
id|raid6_gfexp
(braket
id|failb
)braket
)braket
)braket
suffix:semicolon
multiline_comment|/* Now do it... */
r_while
c_loop
(paren
id|bytes
op_decrement
)paren
(brace
id|px
op_assign
op_star
id|p
op_xor
op_star
id|dp
suffix:semicolon
id|qx
op_assign
id|qmul
(braket
op_star
id|q
op_xor
op_star
id|dq
)braket
suffix:semicolon
op_star
id|dq
op_increment
op_assign
id|db
op_assign
id|pbmul
(braket
id|px
)braket
op_xor
id|qx
suffix:semicolon
multiline_comment|/* Reconstructed B */
op_star
id|dp
op_increment
op_assign
id|db
op_xor
id|px
suffix:semicolon
multiline_comment|/* Reconstructed A */
id|p
op_increment
suffix:semicolon
id|q
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Recover failure of one data block plus the P block */
DECL|function|raid6_datap_recov
r_void
id|raid6_datap_recov
c_func
(paren
r_int
id|disks
comma
r_int
id|bytes
comma
r_int
id|faila
comma
r_void
op_star
op_star
id|ptrs
)paren
(brace
id|u8
op_star
id|p
comma
op_star
id|q
comma
op_star
id|dq
suffix:semicolon
r_const
id|u8
op_star
id|qmul
suffix:semicolon
multiline_comment|/* Q multiplier table */
id|p
op_assign
(paren
id|u8
op_star
)paren
id|ptrs
(braket
id|disks
op_minus
l_int|2
)braket
suffix:semicolon
id|q
op_assign
(paren
id|u8
op_star
)paren
id|ptrs
(braket
id|disks
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Compute syndrome with zero for the missing data page&n;&t;   Use the dead data page as temporary storage for delta q */
id|dq
op_assign
(paren
id|u8
op_star
)paren
id|ptrs
(braket
id|faila
)braket
suffix:semicolon
id|ptrs
(braket
id|faila
)braket
op_assign
(paren
r_void
op_star
)paren
id|raid6_empty_zero_page
suffix:semicolon
id|ptrs
(braket
id|disks
op_minus
l_int|1
)braket
op_assign
id|dq
suffix:semicolon
id|raid6_call
dot
id|gen_syndrome
c_func
(paren
id|disks
comma
id|bytes
comma
id|ptrs
)paren
suffix:semicolon
multiline_comment|/* Restore pointer table */
id|ptrs
(braket
id|faila
)braket
op_assign
id|dq
suffix:semicolon
id|ptrs
(braket
id|disks
op_minus
l_int|1
)braket
op_assign
id|q
suffix:semicolon
multiline_comment|/* Now, pick the proper data tables */
id|qmul
op_assign
id|raid6_gfmul
(braket
id|raid6_gfinv
(braket
id|raid6_gfexp
(braket
id|faila
)braket
)braket
)braket
suffix:semicolon
multiline_comment|/* Now do it... */
r_while
c_loop
(paren
id|bytes
op_decrement
)paren
(brace
op_star
id|p
op_increment
op_xor_assign
op_star
id|dq
op_assign
id|qmul
(braket
op_star
id|q
op_xor
op_star
id|dq
)braket
suffix:semicolon
id|q
op_increment
suffix:semicolon
id|dq
op_increment
suffix:semicolon
)brace
)brace
macro_line|#ifndef __KERNEL__&t;&t;/* Testing only */
multiline_comment|/* Recover two failed blocks. */
DECL|function|raid6_dual_recov
r_void
id|raid6_dual_recov
c_func
(paren
r_int
id|disks
comma
r_int
id|bytes
comma
r_int
id|faila
comma
r_int
id|failb
comma
r_void
op_star
op_star
id|ptrs
)paren
(brace
r_if
c_cond
(paren
id|faila
OG
id|failb
)paren
(brace
r_int
id|tmp
op_assign
id|faila
suffix:semicolon
id|faila
op_assign
id|failb
suffix:semicolon
id|failb
op_assign
id|tmp
suffix:semicolon
)brace
r_if
c_cond
(paren
id|failb
op_eq
id|disks
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|faila
op_eq
id|disks
op_minus
l_int|2
)paren
(brace
multiline_comment|/* P+Q failure.  Just rebuild the syndrome. */
id|raid6_call
dot
id|gen_syndrome
c_func
(paren
id|disks
comma
id|bytes
comma
id|ptrs
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* data+Q failure.  Reconstruct data from P,&n;&t;&t;&t;   then rebuild syndrome. */
multiline_comment|/* FIX */
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|failb
op_eq
id|disks
op_minus
l_int|2
)paren
(brace
multiline_comment|/* data+P failure. */
id|raid6_datap_recov
c_func
(paren
id|disks
comma
id|bytes
comma
id|faila
comma
id|ptrs
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* data+data failure. */
id|raid6_2data_recov
c_func
(paren
id|disks
comma
id|bytes
comma
id|faila
comma
id|failb
comma
id|ptrs
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
eof
