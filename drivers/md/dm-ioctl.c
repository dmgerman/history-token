multiline_comment|/*&n; * Copyright (C) 2001, 2002 Sistina Software (UK) Limited.&n; *&n; * This file is released under the GPL.&n; */
macro_line|#include &quot;dm.h&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/dm-ioctl.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|macro|DM_DRIVER_EMAIL
mdefine_line|#define DM_DRIVER_EMAIL &quot;dm@uk.sistina.com&quot;
multiline_comment|/*-----------------------------------------------------------------&n; * The ioctl interface needs to be able to look up devices by&n; * name or uuid.&n; *---------------------------------------------------------------*/
DECL|struct|hash_cell
r_struct
id|hash_cell
(brace
DECL|member|name_list
r_struct
id|list_head
id|name_list
suffix:semicolon
DECL|member|uuid_list
r_struct
id|list_head
id|uuid_list
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|uuid
r_char
op_star
id|uuid
suffix:semicolon
DECL|member|md
r_struct
id|mapped_device
op_star
id|md
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|NUM_BUCKETS
mdefine_line|#define NUM_BUCKETS 64
DECL|macro|MASK_BUCKETS
mdefine_line|#define MASK_BUCKETS (NUM_BUCKETS - 1)
DECL|variable|_name_buckets
r_static
r_struct
id|list_head
id|_name_buckets
(braket
id|NUM_BUCKETS
)braket
suffix:semicolon
DECL|variable|_uuid_buckets
r_static
r_struct
id|list_head
id|_uuid_buckets
(braket
id|NUM_BUCKETS
)braket
suffix:semicolon
r_void
id|dm_hash_remove_all
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * Guards access to all three tables.&n; */
r_static
id|DECLARE_RWSEM
c_func
(paren
id|_hash_lock
)paren
suffix:semicolon
DECL|function|init_buckets
r_static
r_void
id|init_buckets
c_func
(paren
r_struct
id|list_head
op_star
id|buckets
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_BUCKETS
suffix:semicolon
id|i
op_increment
)paren
id|INIT_LIST_HEAD
c_func
(paren
id|buckets
op_plus
id|i
)paren
suffix:semicolon
)brace
DECL|function|dm_hash_init
r_int
id|dm_hash_init
c_func
(paren
r_void
)paren
(brace
id|init_buckets
c_func
(paren
id|_name_buckets
)paren
suffix:semicolon
id|init_buckets
c_func
(paren
id|_uuid_buckets
)paren
suffix:semicolon
id|devfs_mk_dir
c_func
(paren
id|DM_DIR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dm_hash_exit
r_void
id|dm_hash_exit
c_func
(paren
r_void
)paren
(brace
id|dm_hash_remove_all
c_func
(paren
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
id|DM_DIR
)paren
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * Hash function:&n; * We&squot;re not really concerned with the str hash function being&n; * fast since it&squot;s only used by the ioctl interface.&n; *---------------------------------------------------------------*/
DECL|function|hash_str
r_static
r_int
r_int
id|hash_str
c_func
(paren
r_const
r_char
op_star
id|str
)paren
(brace
r_const
r_int
r_int
id|hash_mult
op_assign
l_int|2654435387U
suffix:semicolon
r_int
r_int
id|h
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_star
id|str
)paren
id|h
op_assign
(paren
id|h
op_plus
(paren
r_int
r_int
)paren
op_star
id|str
op_increment
)paren
op_star
id|hash_mult
suffix:semicolon
r_return
id|h
op_amp
id|MASK_BUCKETS
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * Code for looking up a device by name&n; *---------------------------------------------------------------*/
DECL|function|__get_name_cell
r_static
r_struct
id|hash_cell
op_star
id|__get_name_cell
c_func
(paren
r_const
r_char
op_star
id|str
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|hash_cell
op_star
id|hc
suffix:semicolon
r_int
r_int
id|h
op_assign
id|hash_str
c_func
(paren
id|str
)paren
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
id|_name_buckets
op_plus
id|h
)paren
(brace
id|hc
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|hash_cell
comma
id|name_list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|hc-&gt;name
comma
id|str
)paren
)paren
r_return
id|hc
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|__get_uuid_cell
r_static
r_struct
id|hash_cell
op_star
id|__get_uuid_cell
c_func
(paren
r_const
r_char
op_star
id|str
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|hash_cell
op_star
id|hc
suffix:semicolon
r_int
r_int
id|h
op_assign
id|hash_str
c_func
(paren
id|str
)paren
suffix:semicolon
id|list_for_each
(paren
id|tmp
comma
id|_uuid_buckets
op_plus
id|h
)paren
(brace
id|hc
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|hash_cell
comma
id|uuid_list
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|hc-&gt;uuid
comma
id|str
)paren
)paren
r_return
id|hc
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * Inserting, removing and renaming a device.&n; *---------------------------------------------------------------*/
DECL|function|kstrdup
r_static
r_inline
r_char
op_star
id|kstrdup
c_func
(paren
r_const
r_char
op_star
id|str
)paren
(brace
r_char
op_star
id|r
op_assign
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|str
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
id|strcpy
c_func
(paren
id|r
comma
id|str
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|alloc_cell
r_static
r_struct
id|hash_cell
op_star
id|alloc_cell
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|uuid
comma
r_struct
id|mapped_device
op_star
id|md
)paren
(brace
r_struct
id|hash_cell
op_star
id|hc
suffix:semicolon
id|hc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|hc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hc
)paren
r_return
l_int|NULL
suffix:semicolon
id|hc-&gt;name
op_assign
id|kstrdup
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hc-&gt;name
)paren
(brace
id|kfree
c_func
(paren
id|hc
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|uuid
)paren
id|hc-&gt;uuid
op_assign
l_int|NULL
suffix:semicolon
r_else
(brace
id|hc-&gt;uuid
op_assign
id|kstrdup
c_func
(paren
id|uuid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hc-&gt;uuid
)paren
(brace
id|kfree
c_func
(paren
id|hc-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hc
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hc-&gt;name_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|hc-&gt;uuid_list
)paren
suffix:semicolon
id|hc-&gt;md
op_assign
id|md
suffix:semicolon
r_return
id|hc
suffix:semicolon
)brace
DECL|function|free_cell
r_static
r_void
id|free_cell
c_func
(paren
r_struct
id|hash_cell
op_star
id|hc
)paren
(brace
r_if
c_cond
(paren
id|hc
)paren
(brace
id|kfree
c_func
(paren
id|hc-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hc-&gt;uuid
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * devfs stuff.&n; */
DECL|function|register_with_devfs
r_static
r_int
id|register_with_devfs
c_func
(paren
r_struct
id|hash_cell
op_star
id|hc
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|dm_disk
c_func
(paren
id|hc-&gt;md
)paren
suffix:semicolon
id|devfs_mk_bdev
c_func
(paren
id|MKDEV
c_func
(paren
id|disk-&gt;major
comma
id|disk-&gt;first_minor
)paren
comma
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
comma
id|DM_DIR
l_string|&quot;/%s&quot;
comma
id|hc-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unregister_with_devfs
r_static
r_int
id|unregister_with_devfs
c_func
(paren
r_struct
id|hash_cell
op_star
id|hc
)paren
(brace
id|devfs_remove
c_func
(paren
id|DM_DIR
l_string|&quot;/%s&quot;
comma
id|hc-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The kdev_t and uuid of a device can never change once it is&n; * initially inserted.&n; */
DECL|function|dm_hash_insert
r_int
id|dm_hash_insert
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|uuid
comma
r_struct
id|mapped_device
op_star
id|md
)paren
(brace
r_struct
id|hash_cell
op_star
id|cell
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate the new cells.&n;&t; */
id|cell
op_assign
id|alloc_cell
c_func
(paren
id|name
comma
id|uuid
comma
id|md
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cell
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * Insert the cell into all three hash tables.&n;&t; */
id|down_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__get_name_cell
c_func
(paren
id|name
)paren
)paren
r_goto
id|bad
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|cell-&gt;name_list
comma
id|_name_buckets
op_plus
id|hash_str
c_func
(paren
id|name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uuid
)paren
(brace
r_if
c_cond
(paren
id|__get_uuid_cell
c_func
(paren
id|uuid
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|cell-&gt;name_list
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|cell-&gt;uuid_list
comma
id|_uuid_buckets
op_plus
id|hash_str
c_func
(paren
id|uuid
)paren
)paren
suffix:semicolon
)brace
id|register_with_devfs
c_func
(paren
id|cell
)paren
suffix:semicolon
id|dm_get
c_func
(paren
id|md
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|bad
suffix:colon
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
id|free_cell
c_func
(paren
id|cell
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|__hash_remove
r_void
id|__hash_remove
c_func
(paren
r_struct
id|hash_cell
op_star
id|hc
)paren
(brace
multiline_comment|/* remove from the dev hash */
id|list_del
c_func
(paren
op_amp
id|hc-&gt;uuid_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|hc-&gt;name_list
)paren
suffix:semicolon
id|unregister_with_devfs
c_func
(paren
id|hc
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|hc-&gt;md
)paren
suffix:semicolon
id|free_cell
c_func
(paren
id|hc
)paren
suffix:semicolon
)brace
DECL|function|dm_hash_remove_all
r_void
id|dm_hash_remove_all
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|hash_cell
op_star
id|hc
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
comma
op_star
id|n
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_BUCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|list_for_each_safe
(paren
id|tmp
comma
id|n
comma
id|_name_buckets
op_plus
id|i
)paren
(brace
id|hc
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|hash_cell
comma
id|name_list
)paren
suffix:semicolon
id|__hash_remove
c_func
(paren
id|hc
)paren
suffix:semicolon
)brace
)brace
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
)brace
DECL|function|dm_hash_rename
r_int
id|dm_hash_rename
c_func
(paren
r_const
r_char
op_star
id|old
comma
r_const
r_char
op_star
r_new
)paren
(brace
r_char
op_star
id|new_name
comma
op_star
id|old_name
suffix:semicolon
r_struct
id|hash_cell
op_star
id|hc
suffix:semicolon
multiline_comment|/*&n;&t; * duplicate new.&n;&t; */
id|new_name
op_assign
id|kstrdup
c_func
(paren
r_new
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_name
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Is new free ?&n;&t; */
id|hc
op_assign
id|__get_name_cell
c_func
(paren
r_new
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hc
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;asked to rename to an already existing name %s -&gt; %s&quot;
comma
id|old
comma
r_new
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|new_name
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Is there such a device as &squot;old&squot; ?&n;&t; */
id|hc
op_assign
id|__get_name_cell
c_func
(paren
id|old
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hc
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;asked to rename a non existent device %s -&gt; %s&quot;
comma
id|old
comma
r_new
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|new_name
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * rename and move the name cell.&n;&t; */
id|unregister_with_devfs
c_func
(paren
id|hc
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|hc-&gt;name_list
)paren
suffix:semicolon
id|old_name
op_assign
id|hc-&gt;name
suffix:semicolon
id|hc-&gt;name
op_assign
id|new_name
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|hc-&gt;name_list
comma
id|_name_buckets
op_plus
id|hash_str
c_func
(paren
id|new_name
)paren
)paren
suffix:semicolon
multiline_comment|/* rename the device node in devfs */
id|register_with_devfs
c_func
(paren
id|hc
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|old_name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * Implementation of the ioctl commands&n; *---------------------------------------------------------------*/
multiline_comment|/*&n; * All the ioctl commands get dispatched to functions with this&n; * prototype.&n; */
DECL|typedef|ioctl_fn
r_typedef
r_int
(paren
op_star
id|ioctl_fn
)paren
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
suffix:semicolon
multiline_comment|/*&n; * Check a string doesn&squot;t overrun the chunk of&n; * memory we copied from userland.&n; */
DECL|function|valid_str
r_static
r_int
id|valid_str
c_func
(paren
r_char
op_star
id|str
comma
r_void
op_star
id|begin
comma
r_void
op_star
id|end
)paren
(brace
r_while
c_loop
(paren
(paren
(paren
r_void
op_star
)paren
id|str
op_ge
id|begin
)paren
op_logical_and
(paren
(paren
r_void
op_star
)paren
id|str
OL
id|end
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
op_star
id|str
op_increment
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|next_target
r_static
r_int
id|next_target
c_func
(paren
r_struct
id|dm_target_spec
op_star
id|last
comma
r_uint32
id|next
comma
r_void
op_star
id|begin
comma
r_void
op_star
id|end
comma
r_struct
id|dm_target_spec
op_star
op_star
id|spec
comma
r_char
op_star
op_star
id|params
)paren
(brace
op_star
id|spec
op_assign
(paren
r_struct
id|dm_target_spec
op_star
)paren
(paren
(paren
r_int
r_char
op_star
)paren
id|last
op_plus
id|next
)paren
suffix:semicolon
op_star
id|params
op_assign
(paren
r_char
op_star
)paren
(paren
op_star
id|spec
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|spec
OL
(paren
id|last
op_plus
l_int|1
)paren
op_logical_or
(paren
(paren
r_void
op_star
)paren
op_star
id|spec
OG
id|end
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|valid_str
c_func
(paren
op_star
id|params
comma
id|begin
comma
id|end
)paren
suffix:semicolon
)brace
DECL|function|populate_table
r_static
r_int
id|populate_table
c_func
(paren
r_struct
id|dm_table
op_star
id|table
comma
r_struct
id|dm_ioctl
op_star
id|args
)paren
(brace
r_int
id|r
comma
id|first
op_assign
l_int|1
suffix:semicolon
r_int
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_struct
id|dm_target_spec
op_star
id|spec
suffix:semicolon
r_char
op_star
id|params
suffix:semicolon
r_void
op_star
id|begin
comma
op_star
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|args-&gt;target_count
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;populate_table: no targets specified&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|begin
op_assign
(paren
r_void
op_star
)paren
id|args
suffix:semicolon
id|end
op_assign
id|begin
op_plus
id|args-&gt;data_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|args-&gt;target_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|first
)paren
id|r
op_assign
id|next_target
c_func
(paren
(paren
r_struct
id|dm_target_spec
op_star
)paren
id|args
comma
id|args-&gt;data_start
comma
id|begin
comma
id|end
comma
op_amp
id|spec
comma
op_amp
id|params
)paren
suffix:semicolon
r_else
id|r
op_assign
id|next_target
c_func
(paren
id|spec
comma
id|spec-&gt;next
comma
id|begin
comma
id|end
comma
op_amp
id|spec
comma
op_amp
id|params
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;unable to find target&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|r
op_assign
id|dm_table_add_target
c_func
(paren
id|table
comma
id|spec-&gt;target_type
comma
(paren
id|sector_t
)paren
id|spec-&gt;sector_start
comma
(paren
id|sector_t
)paren
id|spec-&gt;length
comma
id|params
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;internal error adding target to table&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|first
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|dm_table_complete
c_func
(paren
id|table
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Round up the ptr to the next &squot;align&squot; boundary.  Obviously&n; * &squot;align&squot; must be a power of 2.&n; */
DECL|function|align_ptr
r_static
r_inline
r_void
op_star
id|align_ptr
c_func
(paren
r_void
op_star
id|ptr
comma
r_int
r_int
id|align
)paren
(brace
id|align
op_decrement
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
(paren
id|ptr
op_plus
id|align
)paren
)paren
op_amp
op_complement
id|align
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copies a dm_ioctl and an optional additional payload to&n; * userland.&n; */
DECL|function|results_to_user
r_static
r_int
id|results_to_user
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|user
comma
r_struct
id|dm_ioctl
op_star
id|param
comma
r_void
op_star
id|data
comma
r_uint32
id|len
)paren
(brace
r_int
id|r
suffix:semicolon
r_void
op_star
id|ptr
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
(brace
id|ptr
op_assign
id|align_ptr
c_func
(paren
id|user
op_plus
l_int|1
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
id|param-&gt;data_start
op_assign
id|ptr
op_minus
(paren
r_void
op_star
)paren
id|user
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The version number has already been filled in, so we&n;&t; * just copy later fields.&n;&t; */
id|r
op_assign
id|copy_to_user
c_func
(paren
op_amp
id|user-&gt;data_size
comma
op_amp
id|param-&gt;data_size
comma
r_sizeof
(paren
op_star
id|param
)paren
op_minus
r_sizeof
(paren
id|param-&gt;version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
(brace
r_if
c_cond
(paren
id|param-&gt;data_start
op_plus
id|len
OG
id|param-&gt;data_size
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ptr
comma
id|data
comma
id|len
)paren
)paren
id|r
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*&n; * Fills in a dm_ioctl structure, ready for sending back to&n; * userland.&n; */
DECL|function|__info
r_static
r_int
id|__info
c_func
(paren
r_struct
id|mapped_device
op_star
id|md
comma
r_struct
id|dm_ioctl
op_star
id|param
)paren
(brace
r_struct
id|dm_table
op_star
id|table
suffix:semicolon
r_struct
id|block_device
op_star
id|bdev
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
op_assign
id|dm_disk
c_func
(paren
id|md
)paren
suffix:semicolon
id|param-&gt;flags
op_assign
id|DM_EXISTS_FLAG
suffix:semicolon
r_if
c_cond
(paren
id|dm_suspended
c_func
(paren
id|md
)paren
)paren
id|param-&gt;flags
op_or_assign
id|DM_SUSPEND_FLAG
suffix:semicolon
id|bdev
op_assign
id|bdget_disk
c_func
(paren
id|disk
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bdev
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|param-&gt;dev
op_assign
id|bdev-&gt;bd_dev
suffix:semicolon
id|param-&gt;open_count
op_assign
id|bdev-&gt;bd_openers
suffix:semicolon
id|bdput
c_func
(paren
id|bdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;policy
)paren
id|param-&gt;flags
op_or_assign
id|DM_READONLY_FLAG
suffix:semicolon
id|table
op_assign
id|dm_get_table
c_func
(paren
id|md
)paren
suffix:semicolon
id|param-&gt;target_count
op_assign
id|dm_table_get_num_targets
c_func
(paren
id|table
)paren
suffix:semicolon
id|dm_table_put
c_func
(paren
id|table
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Always use UUID for lookups if it&squot;s present, otherwise use name.&n; */
DECL|function|find_device
r_static
r_inline
r_struct
id|mapped_device
op_star
id|find_device
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
)paren
(brace
r_struct
id|hash_cell
op_star
id|hc
suffix:semicolon
r_struct
id|mapped_device
op_star
id|md
op_assign
l_int|NULL
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
id|hc
op_assign
op_star
id|param-&gt;uuid
ques
c_cond
id|__get_uuid_cell
c_func
(paren
id|param-&gt;uuid
)paren
suffix:colon
id|__get_name_cell
c_func
(paren
id|param-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hc
)paren
(brace
id|md
op_assign
id|hc-&gt;md
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Sneakily write in both the name and the uuid&n;&t;&t; * while we have the cell.&n;&t;&t; */
id|strlcpy
c_func
(paren
id|param-&gt;name
comma
id|hc-&gt;name
comma
r_sizeof
(paren
id|param-&gt;name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hc-&gt;uuid
)paren
id|strlcpy
c_func
(paren
id|param-&gt;uuid
comma
id|hc-&gt;uuid
comma
r_sizeof
(paren
id|param-&gt;uuid
)paren
)paren
suffix:semicolon
r_else
id|param-&gt;uuid
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|dm_get
c_func
(paren
id|md
)paren
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
r_return
id|md
suffix:semicolon
)brace
DECL|macro|ALIGNMENT
mdefine_line|#define ALIGNMENT sizeof(int)
DECL|function|_align
r_static
r_void
op_star
id|_align
c_func
(paren
r_void
op_star
id|ptr
comma
r_int
r_int
id|a
)paren
(brace
r_register
r_int
r_int
id|align
op_assign
op_decrement
id|a
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
(paren
(paren
(paren
r_int
r_int
)paren
id|ptr
op_plus
id|align
)paren
op_amp
op_complement
id|align
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copies device info back to user space, used by&n; * the create and info ioctls.&n; */
DECL|function|info
r_static
r_int
id|info
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_struct
id|mapped_device
op_star
id|md
suffix:semicolon
id|param-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|md
op_assign
id|find_device
c_func
(paren
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|md
)paren
multiline_comment|/*&n;&t;&t; * Device not found - returns cleared exists flag.&n;&t;&t; */
r_goto
id|out
suffix:semicolon
id|__info
c_func
(paren
id|md
comma
id|param
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|results_to_user
c_func
(paren
id|user
comma
id|param
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|get_mode
r_static
r_inline
r_int
id|get_mode
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
)paren
(brace
r_int
id|mode
op_assign
id|FMODE_READ
op_or
id|FMODE_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|param-&gt;flags
op_amp
id|DM_READONLY_FLAG
)paren
id|mode
op_assign
id|FMODE_READ
suffix:semicolon
r_return
id|mode
suffix:semicolon
)brace
DECL|function|check_name
r_static
r_int
id|check_name
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_if
c_cond
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;/&squot;
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;invalid device name&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|create
r_static
r_int
id|create
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_int
id|r
suffix:semicolon
r_struct
id|dm_table
op_star
id|t
suffix:semicolon
r_struct
id|mapped_device
op_star
id|md
suffix:semicolon
id|r
op_assign
id|check_name
c_func
(paren
id|param-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
id|r
op_assign
id|dm_table_create
c_func
(paren
op_amp
id|t
comma
id|get_mode
c_func
(paren
id|param
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
id|r
op_assign
id|populate_table
c_func
(paren
id|t
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|dm_table_put
c_func
(paren
id|t
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
r_if
c_cond
(paren
id|param-&gt;flags
op_amp
id|DM_PERSISTENT_DEV_FLAG
)paren
id|r
op_assign
id|dm_create_with_minor
c_func
(paren
id|minor
c_func
(paren
id|to_kdev_t
c_func
(paren
id|param-&gt;dev
)paren
)paren
comma
id|t
comma
op_amp
id|md
)paren
suffix:semicolon
r_else
id|r
op_assign
id|dm_create
c_func
(paren
id|t
comma
op_amp
id|md
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|dm_table_put
c_func
(paren
id|t
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
id|dm_table_put
c_func
(paren
id|t
)paren
suffix:semicolon
multiline_comment|/* md will have grabbed its own reference */
id|set_disk_ro
c_func
(paren
id|dm_disk
c_func
(paren
id|md
)paren
comma
(paren
id|param-&gt;flags
op_amp
id|DM_READONLY_FLAG
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|r
op_assign
id|dm_hash_insert
c_func
(paren
id|param-&gt;name
comma
op_star
id|param-&gt;uuid
ques
c_cond
id|param-&gt;uuid
suffix:colon
l_int|NULL
comma
id|md
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
r_return
id|r
ques
c_cond
id|r
suffix:colon
id|info
c_func
(paren
id|param
comma
id|user
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Build up the status struct for each target&n; */
DECL|function|__status
r_static
r_int
id|__status
c_func
(paren
r_struct
id|mapped_device
op_star
id|md
comma
r_struct
id|dm_ioctl
op_star
id|param
comma
r_char
op_star
id|outbuf
comma
r_int
op_star
id|len
)paren
(brace
r_int
r_int
id|i
comma
id|num_targets
suffix:semicolon
r_struct
id|dm_target_spec
op_star
id|spec
suffix:semicolon
r_char
op_star
id|outptr
suffix:semicolon
id|status_type_t
id|type
suffix:semicolon
r_struct
id|dm_table
op_star
id|table
op_assign
id|dm_get_table
c_func
(paren
id|md
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param-&gt;flags
op_amp
id|DM_STATUS_TABLE_FLAG
)paren
id|type
op_assign
id|STATUSTYPE_TABLE
suffix:semicolon
r_else
id|type
op_assign
id|STATUSTYPE_INFO
suffix:semicolon
id|outptr
op_assign
id|outbuf
suffix:semicolon
multiline_comment|/* Get all the target info */
id|num_targets
op_assign
id|dm_table_get_num_targets
c_func
(paren
id|table
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_targets
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dm_target
op_star
id|ti
op_assign
id|dm_table_get_target
c_func
(paren
id|table
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outptr
op_minus
id|outbuf
op_plus
r_sizeof
(paren
r_struct
id|dm_target_spec
)paren
OG
id|param-&gt;data_size
)paren
(brace
id|dm_table_put
c_func
(paren
id|table
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|spec
op_assign
(paren
r_struct
id|dm_target_spec
op_star
)paren
id|outptr
suffix:semicolon
id|spec-&gt;status
op_assign
l_int|0
suffix:semicolon
id|spec-&gt;sector_start
op_assign
id|ti-&gt;begin
suffix:semicolon
id|spec-&gt;length
op_assign
id|ti-&gt;len
suffix:semicolon
id|strlcpy
c_func
(paren
id|spec-&gt;target_type
comma
id|ti-&gt;type-&gt;name
comma
r_sizeof
(paren
id|spec-&gt;target_type
)paren
)paren
suffix:semicolon
id|outptr
op_add_assign
r_sizeof
(paren
r_struct
id|dm_target_spec
)paren
suffix:semicolon
multiline_comment|/* Get the status/table string from the target driver */
r_if
c_cond
(paren
id|ti-&gt;type-&gt;status
)paren
id|ti-&gt;type
op_member_access_from_pointer
id|status
c_func
(paren
id|ti
comma
id|type
comma
id|outptr
comma
id|outbuf
op_plus
id|param-&gt;data_size
op_minus
id|outptr
)paren
suffix:semicolon
r_else
id|outptr
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|outptr
op_add_assign
id|strlen
c_func
(paren
id|outptr
)paren
op_plus
l_int|1
suffix:semicolon
id|_align
c_func
(paren
id|outptr
comma
id|ALIGNMENT
)paren
suffix:semicolon
id|spec-&gt;next
op_assign
id|outptr
op_minus
id|outbuf
suffix:semicolon
)brace
id|param-&gt;target_count
op_assign
id|num_targets
suffix:semicolon
op_star
id|len
op_assign
id|outptr
op_minus
id|outbuf
suffix:semicolon
id|dm_table_put
c_func
(paren
id|table
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the status of a device as a text string for each&n; * target.&n; */
DECL|function|get_status
r_static
r_int
id|get_status
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_struct
id|mapped_device
op_star
id|md
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_char
op_star
id|outbuf
op_assign
l_int|NULL
suffix:semicolon
id|md
op_assign
id|find_device
c_func
(paren
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|md
)paren
multiline_comment|/*&n;&t;&t; * Device not found - returns cleared exists flag.&n;&t;&t; */
r_goto
id|out
suffix:semicolon
multiline_comment|/* We haven&squot;t a clue how long the resultant data will be so&n;&t;   just allocate as much as userland has allowed us and make sure&n;&t;   we don&squot;t overun it */
id|outbuf
op_assign
id|kmalloc
c_func
(paren
id|param-&gt;data_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|outbuf
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Get the status of all targets&n;&t; */
id|__status
c_func
(paren
id|md
comma
id|param
comma
id|outbuf
comma
op_amp
id|len
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup the basic dm_ioctl structure.&n;&t; */
id|__info
c_func
(paren
id|md
comma
id|param
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|md
)paren
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
id|ret
op_assign
id|results_to_user
c_func
(paren
id|user
comma
id|param
comma
id|outbuf
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outbuf
)paren
id|kfree
c_func
(paren
id|outbuf
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Wait for a device to report an event&n; */
DECL|function|wait_device_event
r_static
r_int
id|wait_device_event
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_struct
id|mapped_device
op_star
id|md
suffix:semicolon
r_struct
id|dm_table
op_star
id|table
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wq
comma
id|current
)paren
suffix:semicolon
id|md
op_assign
id|find_device
c_func
(paren
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|md
)paren
multiline_comment|/*&n;&t;&t; * Device not found - returns cleared exists flag.&n;&t;&t; */
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Setup the basic dm_ioctl structure.&n;&t; */
id|__info
c_func
(paren
id|md
comma
id|param
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for a notification event&n;&t; */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|table
op_assign
id|dm_get_table
c_func
(paren
id|md
)paren
suffix:semicolon
id|dm_table_add_wait_queue
c_func
(paren
id|table
comma
op_amp
id|wq
)paren
suffix:semicolon
id|dm_table_put
c_func
(paren
id|table
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
id|yield
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|results_to_user
c_func
(paren
id|user
comma
id|param
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Retrieves a list of devices used by a particular dm device.&n; */
DECL|function|dep
r_static
r_int
id|dep
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_int
id|r
suffix:semicolon
r_int
r_int
id|count
suffix:semicolon
r_struct
id|mapped_device
op_star
id|md
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_struct
id|dm_target_deps
op_star
id|deps
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dm_table
op_star
id|table
suffix:semicolon
id|md
op_assign
id|find_device
c_func
(paren
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|md
)paren
r_goto
id|out
suffix:semicolon
id|table
op_assign
id|dm_get_table
c_func
(paren
id|md
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup the basic dm_ioctl structure.&n;&t; */
id|__info
c_func
(paren
id|md
comma
id|param
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Count the devices.&n;&t; */
id|count
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
id|dm_table_get_devices
c_func
(paren
id|table
)paren
)paren
id|count
op_increment
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate a kernel space version of the dm_target_status&n;&t; * struct.&n;&t; */
r_if
c_cond
(paren
id|array_too_big
c_func
(paren
r_sizeof
(paren
op_star
id|deps
)paren
comma
r_sizeof
(paren
op_star
id|deps-&gt;dev
)paren
comma
id|count
)paren
)paren
(brace
id|dm_table_put
c_func
(paren
id|table
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|len
op_assign
r_sizeof
(paren
op_star
id|deps
)paren
op_plus
(paren
r_sizeof
(paren
op_star
id|deps-&gt;dev
)paren
op_star
id|count
)paren
suffix:semicolon
id|deps
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|deps
)paren
(brace
id|dm_table_put
c_func
(paren
id|table
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Fill in the devices.&n;&t; */
id|deps-&gt;count
op_assign
id|count
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
id|dm_table_get_devices
c_func
(paren
id|table
)paren
)paren
(brace
r_struct
id|dm_dev
op_star
id|dd
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|dm_dev
comma
id|list
)paren
suffix:semicolon
id|deps-&gt;dev
(braket
id|count
op_increment
)braket
op_assign
id|dd-&gt;bdev-&gt;bd_dev
suffix:semicolon
)brace
id|dm_table_put
c_func
(paren
id|table
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
id|out
suffix:colon
id|r
op_assign
id|results_to_user
c_func
(paren
id|user
comma
id|param
comma
id|deps
comma
id|len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|deps
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|remove
r_static
r_int
id|remove
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_struct
id|hash_cell
op_star
id|hc
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
id|hc
op_assign
op_star
id|param-&gt;uuid
ques
c_cond
id|__get_uuid_cell
c_func
(paren
id|param-&gt;uuid
)paren
suffix:colon
id|__get_name_cell
c_func
(paren
id|param-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hc
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;device doesn&squot;t appear to be in the dev hash table.&quot;
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * You may ask the interface to drop its reference to an&n;&t; * in use device.  This is no different to unlinking a&n;&t; * file that someone still has open.  The device will not&n;&t; * actually be destroyed until the last opener closes it.&n;&t; * The name and uuid of the device (both are interface&n;&t; * properties) will be available for reuse immediately.&n;&t; *&n;&t; * You don&squot;t want to drop a _suspended_ device from the&n;&t; * interface, since that will leave you with no way of&n;&t; * resuming it.&n;&t; */
r_if
c_cond
(paren
id|dm_suspended
c_func
(paren
id|hc-&gt;md
)paren
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;refusing to remove a suspended device.&quot;
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|__hash_remove
c_func
(paren
id|hc
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hash_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|remove_all
r_static
r_int
id|remove_all
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
id|dm_hash_remove_all
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|suspend
r_static
r_int
id|suspend
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_int
id|r
suffix:semicolon
r_struct
id|mapped_device
op_star
id|md
suffix:semicolon
id|md
op_assign
id|find_device
c_func
(paren
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|md
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|param-&gt;flags
op_amp
id|DM_SUSPEND_FLAG
)paren
id|r
op_assign
id|dm_suspend
c_func
(paren
id|md
)paren
suffix:semicolon
r_else
id|r
op_assign
id|dm_resume
c_func
(paren
id|md
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|reload
r_static
r_int
id|reload
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_int
id|r
suffix:semicolon
r_struct
id|mapped_device
op_star
id|md
suffix:semicolon
r_struct
id|dm_table
op_star
id|t
suffix:semicolon
id|r
op_assign
id|dm_table_create
c_func
(paren
op_amp
id|t
comma
id|get_mode
c_func
(paren
id|param
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
id|r
op_assign
id|populate_table
c_func
(paren
id|t
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|dm_table_put
c_func
(paren
id|t
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
id|md
op_assign
id|find_device
c_func
(paren
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|md
)paren
(brace
id|dm_table_put
c_func
(paren
id|t
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|r
op_assign
id|dm_swap_table
c_func
(paren
id|md
comma
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
id|dm_table_put
c_func
(paren
id|t
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
id|dm_table_put
c_func
(paren
id|t
)paren
suffix:semicolon
multiline_comment|/* md will have taken its own reference */
id|set_disk_ro
c_func
(paren
id|dm_disk
c_func
(paren
id|md
)paren
comma
(paren
id|param-&gt;flags
op_amp
id|DM_READONLY_FLAG
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
id|dm_put
c_func
(paren
id|md
)paren
suffix:semicolon
id|r
op_assign
id|info
c_func
(paren
id|param
comma
id|user
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|rename
r_static
r_int
id|rename
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_int
id|r
suffix:semicolon
r_char
op_star
id|new_name
op_assign
(paren
r_char
op_star
)paren
id|param
op_plus
id|param-&gt;data_start
suffix:semicolon
r_if
c_cond
(paren
id|valid_str
c_func
(paren
id|new_name
comma
(paren
r_void
op_star
)paren
id|param
comma
(paren
r_void
op_star
)paren
id|param
op_plus
id|param-&gt;data_size
)paren
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;Invalid new logical volume name supplied.&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|r
op_assign
id|check_name
c_func
(paren
id|new_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
r_return
id|dm_hash_rename
c_func
(paren
id|param-&gt;name
comma
id|new_name
)paren
suffix:semicolon
)brace
multiline_comment|/*-----------------------------------------------------------------&n; * Implementation of open/close/ioctl on the special char&n; * device.&n; *---------------------------------------------------------------*/
DECL|function|lookup_ioctl
r_static
id|ioctl_fn
id|lookup_ioctl
c_func
(paren
r_int
r_int
id|cmd
)paren
(brace
r_static
r_struct
(brace
r_int
id|cmd
suffix:semicolon
id|ioctl_fn
id|fn
suffix:semicolon
)brace
id|_ioctls
(braket
)braket
op_assign
(brace
(brace
id|DM_VERSION_CMD
comma
l_int|NULL
)brace
comma
multiline_comment|/* version is dealt with elsewhere */
(brace
id|DM_REMOVE_ALL_CMD
comma
id|remove_all
)brace
comma
(brace
id|DM_DEV_CREATE_CMD
comma
id|create
)brace
comma
(brace
id|DM_DEV_REMOVE_CMD
comma
id|remove
)brace
comma
(brace
id|DM_DEV_RELOAD_CMD
comma
id|reload
)brace
comma
(brace
id|DM_DEV_RENAME_CMD
comma
id|rename
)brace
comma
(brace
id|DM_DEV_SUSPEND_CMD
comma
id|suspend
)brace
comma
(brace
id|DM_DEV_DEPS_CMD
comma
id|dep
)brace
comma
(brace
id|DM_DEV_STATUS_CMD
comma
id|info
)brace
comma
(brace
id|DM_TARGET_STATUS_CMD
comma
id|get_status
)brace
comma
(brace
id|DM_TARGET_WAIT_CMD
comma
id|wait_device_event
)brace
comma
)brace
suffix:semicolon
r_return
(paren
id|cmd
op_ge
id|ARRAY_SIZE
c_func
(paren
id|_ioctls
)paren
)paren
ques
c_cond
l_int|NULL
suffix:colon
id|_ioctls
(braket
id|cmd
)braket
dot
id|fn
suffix:semicolon
)brace
multiline_comment|/*&n; * As well as checking the version compatibility this always&n; * copies the kernel interface version out.&n; */
DECL|function|check_version
r_static
r_int
id|check_version
c_func
(paren
r_int
r_int
id|cmd
comma
r_struct
id|dm_ioctl
op_star
id|user
)paren
(brace
r_uint32
id|version
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|version
comma
id|user-&gt;version
comma
r_sizeof
(paren
id|version
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|DM_VERSION_MAJOR
op_ne
id|version
(braket
l_int|0
)braket
)paren
op_logical_or
(paren
id|DM_VERSION_MINOR
OL
id|version
(braket
l_int|1
)braket
)paren
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;ioctl interface mismatch: &quot;
l_string|&quot;kernel(%u.%u.%u), user(%u.%u.%u), cmd(%d)&quot;
comma
id|DM_VERSION_MAJOR
comma
id|DM_VERSION_MINOR
comma
id|DM_VERSION_PATCHLEVEL
comma
id|version
(braket
l_int|0
)braket
comma
id|version
(braket
l_int|1
)braket
comma
id|version
(braket
l_int|2
)braket
comma
id|cmd
)paren
suffix:semicolon
id|r
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Fill in the kernel version.&n;&t; */
id|version
(braket
l_int|0
)braket
op_assign
id|DM_VERSION_MAJOR
suffix:semicolon
id|version
(braket
l_int|1
)braket
op_assign
id|DM_VERSION_MINOR
suffix:semicolon
id|version
(braket
l_int|2
)braket
op_assign
id|DM_VERSION_PATCHLEVEL
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user-&gt;version
comma
id|version
comma
r_sizeof
(paren
id|version
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|free_params
r_static
r_void
id|free_params
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|param
)paren
(brace
id|vfree
c_func
(paren
id|param
)paren
suffix:semicolon
)brace
DECL|function|copy_params
r_static
r_int
id|copy_params
c_func
(paren
r_struct
id|dm_ioctl
op_star
id|user
comma
r_struct
id|dm_ioctl
op_star
op_star
id|param
)paren
(brace
r_struct
id|dm_ioctl
id|tmp
comma
op_star
id|dmi
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|tmp
comma
id|user
comma
r_sizeof
(paren
id|tmp
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|tmp.data_size
OL
r_sizeof
(paren
id|tmp
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dmi
op_assign
(paren
r_struct
id|dm_ioctl
op_star
)paren
id|vmalloc
c_func
(paren
id|tmp.data_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dmi
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|dmi
comma
id|user
comma
id|tmp.data_size
)paren
)paren
(brace
id|vfree
c_func
(paren
id|dmi
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
op_star
id|param
op_assign
id|dmi
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|validate_params
r_static
r_int
id|validate_params
c_func
(paren
id|uint
id|cmd
comma
r_struct
id|dm_ioctl
op_star
id|param
)paren
(brace
multiline_comment|/* Ignores parameters */
r_if
c_cond
(paren
id|cmd
op_eq
id|DM_REMOVE_ALL_CMD
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Unless creating, either name of uuid but not both */
r_if
c_cond
(paren
id|cmd
op_ne
id|DM_DEV_CREATE_CMD
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
op_star
id|param-&gt;uuid
op_logical_and
op_logical_neg
op_star
id|param-&gt;name
)paren
op_logical_or
(paren
op_star
id|param-&gt;uuid
op_logical_and
op_star
id|param-&gt;name
)paren
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;one of name or uuid must be supplied&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/* Ensure strings are terminated */
id|param-&gt;name
(braket
id|DM_NAME_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|param-&gt;uuid
(braket
id|DM_UUID_LEN
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ctl_ioctl
r_static
r_int
id|ctl_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|uint
id|command
comma
id|ulong
id|u
)paren
(brace
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|cmd
suffix:semicolon
r_struct
id|dm_ioctl
op_star
id|param
suffix:semicolon
r_struct
id|dm_ioctl
op_star
id|user
op_assign
(paren
r_struct
id|dm_ioctl
op_star
)paren
id|u
suffix:semicolon
id|ioctl_fn
id|fn
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* only root can play with this */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|_IOC_TYPE
c_func
(paren
id|command
)paren
op_ne
id|DM_IOCTL
)paren
r_return
op_minus
id|ENOTTY
suffix:semicolon
id|cmd
op_assign
id|_IOC_NR
c_func
(paren
id|command
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check the interface version passed in.  This also&n;&t; * writes out the kernels interface version.&n;&t; */
id|r
op_assign
id|check_version
c_func
(paren
id|cmd
comma
id|user
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
multiline_comment|/*&n;&t; * Nothing more to do for the version command.&n;&t; */
r_if
c_cond
(paren
id|cmd
op_eq
id|DM_VERSION_CMD
)paren
r_return
l_int|0
suffix:semicolon
id|fn
op_assign
id|lookup_ioctl
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fn
)paren
(brace
id|DMWARN
c_func
(paren
l_string|&quot;dm_ctl_ioctl: unknown command 0x%x&quot;
comma
id|command
)paren
suffix:semicolon
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Copy the parameters into kernel space.&n;&t; */
id|r
op_assign
id|copy_params
c_func
(paren
id|user
comma
op_amp
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
id|r
op_assign
id|validate_params
c_func
(paren
id|cmd
comma
id|param
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|free_params
c_func
(paren
id|param
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
id|r
op_assign
id|fn
c_func
(paren
id|param
comma
id|user
)paren
suffix:semicolon
id|free_params
c_func
(paren
id|param
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|variable|_ctl_fops
r_static
r_struct
id|file_operations
id|_ctl_fops
op_assign
(brace
dot
id|ioctl
op_assign
id|ctl_ioctl
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|variable|_dm_misc
r_static
r_struct
id|miscdevice
id|_dm_misc
op_assign
(brace
dot
id|minor
op_assign
id|MISC_DYNAMIC_MINOR
comma
dot
id|name
op_assign
id|DM_NAME
comma
dot
id|devfs_name
op_assign
l_string|&quot;mapper/control&quot;
comma
dot
id|fops
op_assign
op_amp
id|_ctl_fops
)brace
suffix:semicolon
multiline_comment|/*&n; * Create misc character device and link to DM_DIR/control.&n; */
DECL|function|dm_interface_init
r_int
id|__init
id|dm_interface_init
c_func
(paren
r_void
)paren
(brace
r_int
id|r
suffix:semicolon
id|r
op_assign
id|dm_hash_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
r_return
id|r
suffix:semicolon
id|r
op_assign
id|misc_register
c_func
(paren
op_amp
id|_dm_misc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
(brace
id|DMERR
c_func
(paren
l_string|&quot;misc_register failed for control device&quot;
)paren
suffix:semicolon
id|dm_hash_exit
c_func
(paren
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
id|DMINFO
c_func
(paren
l_string|&quot;%d.%d.%d%s initialised: %s&quot;
comma
id|DM_VERSION_MAJOR
comma
id|DM_VERSION_MINOR
comma
id|DM_VERSION_PATCHLEVEL
comma
id|DM_VERSION_EXTRA
comma
id|DM_DRIVER_EMAIL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|misc_deregister
c_func
(paren
op_amp
id|_dm_misc
)paren
OL
l_int|0
)paren
id|DMERR
c_func
(paren
l_string|&quot;misc_deregister failed for control device&quot;
)paren
suffix:semicolon
id|dm_hash_exit
c_func
(paren
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|dm_interface_exit
r_void
id|dm_interface_exit
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|misc_deregister
c_func
(paren
op_amp
id|_dm_misc
)paren
OL
l_int|0
)paren
id|DMERR
c_func
(paren
l_string|&quot;misc_deregister failed for control device&quot;
)paren
suffix:semicolon
id|dm_hash_exit
c_func
(paren
)paren
suffix:semicolon
)brace
eof
