multiline_comment|/*&n; * Copyright (C) 2004 Red Hat, Inc. All rights reserved.&n; *&n; * This file is released under the GPL.&n; *&n; * Multipath hardware handler registration.&n; */
macro_line|#include &quot;dm.h&quot;
macro_line|#include &quot;dm-hw-handler.h&quot;
macro_line|#include &lt;linux/slab.h&gt;
DECL|struct|hwh_internal
r_struct
id|hwh_internal
(brace
DECL|member|hwht
r_struct
id|hw_handler_type
id|hwht
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|use
r_int
id|use
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|hwht_to_hwhi
mdefine_line|#define hwht_to_hwhi(__hwht) container_of((__hwht), struct hwh_internal, hwht)
r_static
id|LIST_HEAD
c_func
(paren
id|_hw_handlers
)paren
suffix:semicolon
r_static
id|DECLARE_RWSEM
c_func
(paren
id|_hwh_lock
)paren
suffix:semicolon
DECL|function|__find_hw_handler_type
r_struct
id|hwh_internal
op_star
id|__find_hw_handler_type
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|hwh_internal
op_star
id|hwhi
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|hwhi
comma
op_amp
id|_hw_handlers
comma
id|list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|name
comma
id|hwhi-&gt;hwht.name
)paren
)paren
r_return
id|hwhi
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|get_hw_handler
r_static
r_struct
id|hwh_internal
op_star
id|get_hw_handler
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|hwh_internal
op_star
id|hwhi
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
id|hwhi
op_assign
id|__find_hw_handler_type
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwhi
)paren
(brace
r_if
c_cond
(paren
(paren
id|hwhi-&gt;use
op_eq
l_int|0
)paren
op_logical_and
op_logical_neg
id|try_module_get
c_func
(paren
id|hwhi-&gt;hwht.module
)paren
)paren
id|hwhi
op_assign
l_int|NULL
suffix:semicolon
r_else
id|hwhi-&gt;use
op_increment
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
r_return
id|hwhi
suffix:semicolon
)brace
DECL|function|dm_get_hw_handler
r_struct
id|hw_handler_type
op_star
id|dm_get_hw_handler
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|hwh_internal
op_star
id|hwhi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
)paren
r_return
l_int|NULL
suffix:semicolon
id|hwhi
op_assign
id|get_hw_handler
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwhi
)paren
(brace
id|request_module
c_func
(paren
l_string|&quot;dm-%s&quot;
comma
id|name
)paren
suffix:semicolon
id|hwhi
op_assign
id|get_hw_handler
c_func
(paren
id|name
)paren
suffix:semicolon
)brace
r_return
id|hwhi
ques
c_cond
op_amp
id|hwhi-&gt;hwht
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|dm_put_hw_handler
r_void
id|dm_put_hw_handler
c_func
(paren
r_struct
id|hw_handler_type
op_star
id|hwht
)paren
(brace
r_struct
id|hwh_internal
op_star
id|hwhi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwht
)paren
r_return
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
id|hwhi
op_assign
id|__find_hw_handler_type
c_func
(paren
id|hwht-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwhi
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|hwhi-&gt;use
op_eq
l_int|0
)paren
id|module_put
c_func
(paren
id|hwhi-&gt;hwht.module
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwhi-&gt;use
OL
l_int|0
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
id|up_read
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
)brace
DECL|function|_alloc_hw_handler
r_static
r_struct
id|hwh_internal
op_star
id|_alloc_hw_handler
c_func
(paren
r_struct
id|hw_handler_type
op_star
id|hwht
)paren
(brace
r_struct
id|hwh_internal
op_star
id|hwhi
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|hwhi
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwhi
)paren
(brace
id|memset
c_func
(paren
id|hwhi
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|hwhi
)paren
)paren
suffix:semicolon
id|hwhi-&gt;hwht
op_assign
op_star
id|hwht
suffix:semicolon
)brace
r_return
id|hwhi
suffix:semicolon
)brace
DECL|function|dm_register_hw_handler
r_int
id|dm_register_hw_handler
c_func
(paren
r_struct
id|hw_handler_type
op_star
id|hwht
)paren
(brace
r_int
id|r
op_assign
l_int|0
suffix:semicolon
r_struct
id|hwh_internal
op_star
id|hwhi
op_assign
id|_alloc_hw_handler
c_func
(paren
id|hwht
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwhi
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__find_hw_handler_type
c_func
(paren
id|hwht-&gt;name
)paren
)paren
(brace
id|kfree
c_func
(paren
id|hwhi
)paren
suffix:semicolon
id|r
op_assign
op_minus
id|EEXIST
suffix:semicolon
)brace
r_else
id|list_add
c_func
(paren
op_amp
id|hwhi-&gt;list
comma
op_amp
id|_hw_handlers
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|dm_unregister_hw_handler
r_int
id|dm_unregister_hw_handler
c_func
(paren
r_struct
id|hw_handler_type
op_star
id|hwht
)paren
(brace
r_struct
id|hwh_internal
op_star
id|hwhi
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
id|hwhi
op_assign
id|__find_hw_handler_type
c_func
(paren
id|hwht-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwhi
)paren
(brace
id|up_write
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwhi-&gt;use
)paren
(brace
id|up_write
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
r_return
op_minus
id|ETXTBSY
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|hwhi-&gt;list
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|_hwh_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hwhi
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dm_scsi_err_handler
r_int
id|dm_scsi_err_handler
c_func
(paren
r_struct
id|hw_handler
op_star
id|hwh
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
macro_line|#if 0
r_int
id|sense_key
comma
id|asc
comma
id|ascq
suffix:semicolon
r_if
c_cond
(paren
id|bio-&gt;bi_error
op_amp
id|BIO_SENSE
)paren
(brace
multiline_comment|/* FIXME: This is just an initial guess. */
multiline_comment|/* key / asc / ascq */
id|sense_key
op_assign
(paren
id|bio-&gt;bi_error
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|asc
op_assign
(paren
id|bio-&gt;bi_error
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|ascq
op_assign
id|bio-&gt;bi_error
op_amp
l_int|0xff
suffix:semicolon
r_switch
c_cond
(paren
id|sense_key
)paren
(brace
multiline_comment|/* This block as a whole comes from the device.&n;&t;&t;&t; * So no point retrying on another path. */
r_case
l_int|0x03
suffix:colon
multiline_comment|/* Medium error */
r_case
l_int|0x05
suffix:colon
multiline_comment|/* Illegal request */
r_case
l_int|0x07
suffix:colon
multiline_comment|/* Data protect */
r_case
l_int|0x08
suffix:colon
multiline_comment|/* Blank check */
r_case
l_int|0x0a
suffix:colon
multiline_comment|/* copy aborted */
r_case
l_int|0x0c
suffix:colon
multiline_comment|/* obsolete - no clue ;-) */
r_case
l_int|0x0d
suffix:colon
multiline_comment|/* volume overflow */
r_case
l_int|0x0e
suffix:colon
multiline_comment|/* data miscompare */
r_case
l_int|0x0f
suffix:colon
multiline_comment|/* reserved - no idea either. */
r_return
id|MP_ERROR_IO
suffix:semicolon
multiline_comment|/* For these errors it&squot;s unclear whether they&n;&t;&t;&t; * come from the device or the controller.&n;&t;&t;&t; * So just lets try a different path, and if&n;&t;&t;&t; * it eventually succeeds, user-space will clear&n;&t;&t;&t; * the paths again... */
r_case
l_int|0x02
suffix:colon
multiline_comment|/* Not ready */
r_case
l_int|0x04
suffix:colon
multiline_comment|/* Hardware error */
r_case
l_int|0x09
suffix:colon
multiline_comment|/* vendor specific */
r_case
l_int|0x0b
suffix:colon
multiline_comment|/* Aborted command */
r_return
id|MP_FAIL_PATH
suffix:semicolon
r_case
l_int|0x06
suffix:colon
multiline_comment|/* Unit attention - might want to decode */
r_if
c_cond
(paren
id|asc
op_eq
l_int|0x04
op_logical_and
id|ascq
op_eq
l_int|0x01
)paren
multiline_comment|/* &quot;Unit in the process of&n;&t;&t;&t;&t; * becoming ready&quot; */
r_return
l_int|0
suffix:semicolon
r_return
id|MP_FAIL_PATH
suffix:semicolon
multiline_comment|/* FIXME: For Unit Not Ready we may want&n;&t;&t;&t; * to have a generic pg activation&n;&t;&t;&t; * feature (START_UNIT). */
multiline_comment|/* Should these two ever end up in the&n;&t;&t;&t; * error path? I don&squot;t think so. */
r_case
l_int|0x00
suffix:colon
multiline_comment|/* No sense */
r_case
l_int|0x01
suffix:colon
multiline_comment|/* Recovered error */
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* We got no idea how to decode the other kinds of errors -&gt;&n;&t; * assume generic error condition. */
r_return
id|MP_FAIL_PATH
suffix:semicolon
)brace
DECL|variable|dm_register_hw_handler
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|dm_register_hw_handler
)paren
suffix:semicolon
DECL|variable|dm_unregister_hw_handler
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|dm_unregister_hw_handler
)paren
suffix:semicolon
DECL|variable|dm_scsi_err_handler
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|dm_scsi_err_handler
)paren
suffix:semicolon
eof
