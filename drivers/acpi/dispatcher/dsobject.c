multiline_comment|/******************************************************************************&n; *&n; * Module Name: dsobject - Dispatcher object management routines&n; *              $Revision: 99 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 - 2002, R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acparser.h&quot;
macro_line|#include &quot;amlcode.h&quot;
macro_line|#include &quot;acdispat.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          ACPI_DISPATCHER
id|ACPI_MODULE_NAME
(paren
l_string|&quot;dsobject&quot;
)paren
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_init_one_object&n; *&n; * PARAMETERS:  Obj_handle      - Node&n; *              Level           - Current nesting level&n; *              Context         - Points to a init info struct&n; *              Return_value    - Not used&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Callback from Acpi_walk_namespace. Invoked for every object&n; *              within the namespace.&n; *&n; *              Currently, the only objects that require initialization are:&n; *              1) Methods&n; *              2) Operation Regions&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ds_init_one_object
id|acpi_ds_init_one_object
(paren
id|acpi_handle
id|obj_handle
comma
id|u32
id|level
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|return_value
)paren
(brace
id|acpi_object_type
id|type
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|acpi_init_walk_info
op_star
id|info
op_assign
(paren
id|acpi_init_walk_info
op_star
)paren
id|context
suffix:semicolon
id|ACPI_FUNCTION_NAME
(paren
l_string|&quot;Ds_init_one_object&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We are only interested in objects owned by the table that&n;&t; * was just loaded&n;&t; */
r_if
c_cond
(paren
(paren
(paren
id|acpi_namespace_node
op_star
)paren
id|obj_handle
)paren
op_member_access_from_pointer
id|owner_id
op_ne
id|info-&gt;table_desc-&gt;table_id
)paren
(brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|info-&gt;object_count
op_increment
suffix:semicolon
multiline_comment|/* And even then, we are only interested in a few object types */
id|type
op_assign
id|acpi_ns_get_type
(paren
id|obj_handle
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ACPI_TYPE_REGION
suffix:colon
id|status
op_assign
id|acpi_ds_initialize_region
(paren
id|obj_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Region %p [%4.4s] - Init failure, %s&bslash;n&quot;
comma
id|obj_handle
comma
(paren
(paren
id|acpi_namespace_node
op_star
)paren
id|obj_handle
)paren
op_member_access_from_pointer
id|name.ascii
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
id|info-&gt;op_region_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_METHOD
suffix:colon
id|info-&gt;method_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|acpi_dbg_level
op_amp
id|ACPI_LV_INIT
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_OK
comma
l_string|&quot;.&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Set the execution data width (32 or 64) based upon the&n;&t;&t; * revision number of the parent ACPI table.&n;&t;&t; * TBD: This is really for possible future support of integer width&n;&t;&t; * on a per-table basis. Currently, we just use a global for the width.&n;&t;&t; */
r_if
c_cond
(paren
id|info-&gt;table_desc-&gt;pointer-&gt;revision
op_eq
l_int|1
)paren
(brace
(paren
(paren
id|acpi_namespace_node
op_star
)paren
id|obj_handle
)paren
op_member_access_from_pointer
id|flags
op_or_assign
id|ANOBJ_DATA_WIDTH_32
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Always parse methods to detect errors, we may delete&n;&t;&t; * the parse tree below&n;&t;&t; */
id|status
op_assign
id|acpi_ds_parse_method
(paren
id|obj_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Method %p [%4.4s] - parse failure, %s&bslash;n&quot;
comma
id|obj_handle
comma
(paren
(paren
id|acpi_namespace_node
op_star
)paren
id|obj_handle
)paren
op_member_access_from_pointer
id|name.ascii
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* This parse failed, but we will continue parsing more methods */
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Delete the parse tree.  We simple re-parse the method&n;&t;&t; * for every execution since there isn&squot;t much overhead&n;&t;&t; */
id|acpi_ns_delete_namespace_subtree
(paren
id|obj_handle
)paren
suffix:semicolon
id|acpi_ns_delete_namespace_by_owner
(paren
(paren
(paren
id|acpi_namespace_node
op_star
)paren
id|obj_handle
)paren
op_member_access_from_pointer
id|object-&gt;method.owning_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_DEVICE
suffix:colon
id|info-&gt;device_count
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * We ignore errors from above, and always return OK, since&n;&t; * we don&squot;t want to abort the walk on a single error.&n;&t; */
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_initialize_objects&n; *&n; * PARAMETERS:  Table_desc      - Descriptor for parent ACPI table&n; *              Start_node      - Root of subtree to be initialized.&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Walk the namespace starting at &quot;Start_node&quot; and perform any&n; *              necessary initialization on the objects found therein&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ds_initialize_objects
id|acpi_ds_initialize_objects
(paren
id|acpi_table_desc
op_star
id|table_desc
comma
id|acpi_namespace_node
op_star
id|start_node
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|acpi_init_walk_info
id|info
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ds_initialize_objects&quot;
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;**** Starting initialization of namespace objects ****&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_OK
comma
l_string|&quot;Parsing Methods:&quot;
)paren
)paren
suffix:semicolon
id|info.method_count
op_assign
l_int|0
suffix:semicolon
id|info.op_region_count
op_assign
l_int|0
suffix:semicolon
id|info.object_count
op_assign
l_int|0
suffix:semicolon
id|info.device_count
op_assign
l_int|0
suffix:semicolon
id|info.table_desc
op_assign
id|table_desc
suffix:semicolon
multiline_comment|/* Walk entire namespace from the supplied root */
id|status
op_assign
id|acpi_walk_namespace
(paren
id|ACPI_TYPE_ANY
comma
id|start_node
comma
id|ACPI_UINT32_MAX
comma
id|acpi_ds_init_one_object
comma
op_amp
id|info
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Walk_namespace failed, %s&bslash;n&quot;
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_OK
comma
l_string|&quot;&bslash;nTable [%4.4s] - %hd Objects with %hd Devices %hd Methods %hd Regions&bslash;n&quot;
comma
id|table_desc-&gt;pointer-&gt;signature
comma
id|info.object_count
comma
id|info.device_count
comma
id|info.method_count
comma
id|info.op_region_count
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;%hd Methods, %hd Regions&bslash;n&quot;
comma
id|info.method_count
comma
id|info.op_region_count
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_init_object_from_op&n; *&n; * PARAMETERS:  Walk_state      - Current walk state&n; *              Op              - Parser op used to init the internal object&n; *              Opcode          - AML opcode associated with the object&n; *              Ret_obj_desc    - Namespace object to be initialized&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Initialize a namespace object from a parser Op and its&n; *              associated arguments.  The namespace object is a more compact&n; *              representation of the Op and its arguments.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_init_object_from_op
id|acpi_ds_init_object_from_op
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_parse_object
op_star
id|op
comma
id|u16
id|opcode
comma
id|acpi_operand_object
op_star
op_star
id|ret_obj_desc
)paren
(brace
r_const
id|acpi_opcode_info
op_star
id|op_info
suffix:semicolon
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|ACPI_FUNCTION_NAME
(paren
l_string|&quot;Ds_init_object_from_op&quot;
)paren
suffix:semicolon
id|obj_desc
op_assign
op_star
id|ret_obj_desc
suffix:semicolon
id|op_info
op_assign
id|acpi_ps_get_opcode_info
(paren
id|opcode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op_info
op_member_access_from_pointer
r_class
op_eq
id|AML_CLASS_UNKNOWN
)paren
(brace
multiline_comment|/* Unknown opcode */
r_return
(paren
id|AE_TYPE
)paren
suffix:semicolon
)brace
multiline_comment|/* Perform per-object initialization */
r_switch
c_cond
(paren
id|obj_desc-&gt;common.type
)paren
(brace
r_case
id|ACPI_TYPE_BUFFER
suffix:colon
multiline_comment|/*&n;&t;&t; * Defer evaluation of Buffer Term_arg operand&n;&t;&t; */
id|obj_desc-&gt;buffer.node
op_assign
(paren
id|acpi_namespace_node
op_star
)paren
id|walk_state-&gt;operands
(braket
l_int|0
)braket
suffix:semicolon
id|obj_desc-&gt;buffer.aml_start
op_assign
id|op-&gt;named.data
suffix:semicolon
id|obj_desc-&gt;buffer.aml_length
op_assign
id|op-&gt;named.length
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PACKAGE
suffix:colon
multiline_comment|/*&n;&t;&t; * Defer evaluation of Package Term_arg operand&n;&t;&t; */
id|obj_desc-&gt;package.node
op_assign
(paren
id|acpi_namespace_node
op_star
)paren
id|walk_state-&gt;operands
(braket
l_int|0
)braket
suffix:semicolon
id|obj_desc-&gt;package.aml_start
op_assign
id|op-&gt;named.data
suffix:semicolon
id|obj_desc-&gt;package.aml_length
op_assign
id|op-&gt;named.length
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_INTEGER
suffix:colon
id|obj_desc-&gt;integer.value
op_assign
id|op-&gt;common.value.integer
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_STRING
suffix:colon
id|obj_desc-&gt;string.pointer
op_assign
id|op-&gt;common.value.string
suffix:semicolon
id|obj_desc-&gt;string.length
op_assign
id|ACPI_STRLEN
(paren
id|op-&gt;common.value.string
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The string is contained in the ACPI table, don&squot;t ever try&n;&t;&t; * to delete it&n;&t;&t; */
id|obj_desc-&gt;common.flags
op_or_assign
id|AOPOBJ_STATIC_POINTER
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_METHOD
suffix:colon
r_break
suffix:semicolon
r_case
id|INTERNAL_TYPE_REFERENCE
suffix:colon
r_switch
c_cond
(paren
id|op_info-&gt;type
)paren
(brace
r_case
id|AML_TYPE_LOCAL_VARIABLE
suffix:colon
multiline_comment|/* Split the opcode into a base opcode + offset */
id|obj_desc-&gt;reference.opcode
op_assign
id|AML_LOCAL_OP
suffix:semicolon
id|obj_desc-&gt;reference.offset
op_assign
id|opcode
op_minus
id|AML_LOCAL_OP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_TYPE_METHOD_ARGUMENT
suffix:colon
multiline_comment|/* Split the opcode into a base opcode + offset */
id|obj_desc-&gt;reference.opcode
op_assign
id|AML_ARG_OP
suffix:semicolon
id|obj_desc-&gt;reference.offset
op_assign
id|opcode
op_minus
id|AML_ARG_OP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Constants, Literals, etc.. */
r_if
c_cond
(paren
id|op-&gt;common.aml_opcode
op_eq
id|AML_INT_NAMEPATH_OP
)paren
(brace
multiline_comment|/* Node was saved in Op */
id|obj_desc-&gt;reference.node
op_assign
id|op-&gt;common.node
suffix:semicolon
)brace
id|obj_desc-&gt;reference.opcode
op_assign
id|opcode
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unimplemented data type: %X&bslash;n&quot;
comma
id|obj_desc-&gt;common.type
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_build_internal_object&n; *&n; * PARAMETERS:  Walk_state      - Current walk state&n; *              Op              - Parser object to be translated&n; *              Obj_desc_ptr    - Where the ACPI internal object is returned&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Translate a parser Op object to the equivalent namespace object&n; *              Simple objects are any objects other than a package object!&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_build_internal_object
id|acpi_ds_build_internal_object
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_parse_object
op_star
id|op
comma
id|acpi_operand_object
op_star
op_star
id|obj_desc_ptr
)paren
(brace
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ds_build_internal_object&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;common.aml_opcode
op_eq
id|AML_INT_NAMEPATH_OP
)paren
(brace
multiline_comment|/*&n;&t;&t; * This is an object reference.  If this name was&n;&t;&t; * previously looked up in the namespace, it was stored in this op.&n;&t;&t; * Otherwise, go ahead and look it up now&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|op-&gt;common.node
)paren
(brace
id|status
op_assign
id|acpi_ns_lookup
(paren
id|walk_state-&gt;scope_info
comma
id|op-&gt;common.value.string
comma
id|ACPI_TYPE_ANY
comma
id|ACPI_IMODE_EXECUTE
comma
id|ACPI_NS_SEARCH_PARENT
op_or
id|ACPI_NS_DONT_OPEN_SCOPE
comma
l_int|NULL
comma
(paren
id|acpi_namespace_node
op_star
op_star
)paren
op_amp
(paren
id|op-&gt;common.node
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
id|AE_NOT_FOUND
)paren
(brace
id|name
op_assign
l_int|NULL
suffix:semicolon
id|status
op_assign
id|acpi_ns_externalize_name
(paren
id|ACPI_UINT32_MAX
comma
id|op-&gt;common.value.string
comma
l_int|NULL
comma
op_amp
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
id|ACPI_REPORT_WARNING
(paren
(paren
l_string|&quot;Reference %s at AML %X not found&bslash;n&quot;
comma
id|name
comma
id|op-&gt;common.aml_offset
)paren
)paren
suffix:semicolon
id|ACPI_MEM_FREE
(paren
id|name
)paren
suffix:semicolon
)brace
r_else
(brace
id|ACPI_REPORT_WARNING
(paren
(paren
l_string|&quot;Reference %s at AML %X not found&bslash;n&quot;
comma
id|op-&gt;common.value.string
comma
id|op-&gt;common.aml_offset
)paren
)paren
suffix:semicolon
)brace
op_star
id|obj_desc_ptr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* Create and init the internal ACPI object */
id|obj_desc
op_assign
id|acpi_ut_create_internal_object
(paren
(paren
id|acpi_ps_get_opcode_info
(paren
id|op-&gt;common.aml_opcode
)paren
)paren
op_member_access_from_pointer
id|object_type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_ds_init_object_from_op
(paren
id|walk_state
comma
id|op
comma
id|op-&gt;common.aml_opcode
comma
op_amp
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ut_remove_reference
(paren
id|obj_desc
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
op_star
id|obj_desc_ptr
op_assign
id|obj_desc
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_build_internal_buffer_obj&n; *&n; * PARAMETERS:  Op              - Parser object to be translated&n; *              Obj_desc_ptr    - Where the ACPI internal object is returned&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Translate a parser Op package object to the equivalent&n; *              namespace object&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_build_internal_buffer_obj
id|acpi_ds_build_internal_buffer_obj
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_parse_object
op_star
id|op
comma
id|u32
id|buffer_length
comma
id|acpi_operand_object
op_star
op_star
id|obj_desc_ptr
)paren
(brace
id|acpi_parse_object
op_star
id|arg
suffix:semicolon
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|acpi_parse_object
op_star
id|byte_list
suffix:semicolon
id|u32
id|byte_list_length
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ds_build_internal_buffer_obj&quot;
)paren
suffix:semicolon
id|obj_desc
op_assign
op_star
id|obj_desc_ptr
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc
)paren
(brace
multiline_comment|/*&n;&t;&t; * We are evaluating a Named buffer object &quot;Name (xxxx, Buffer)&quot;.&n;&t;&t; * The buffer object already exists (from the NS node)&n;&t;&t; */
)brace
r_else
(brace
multiline_comment|/* Create a new buffer object */
id|obj_desc
op_assign
id|acpi_ut_create_internal_object
(paren
id|ACPI_TYPE_BUFFER
)paren
suffix:semicolon
op_star
id|obj_desc_ptr
op_assign
id|obj_desc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Second arg is the buffer data (optional) Byte_list can be either&n;&t; * individual bytes or a string initializer.  In either case, a&n;&t; * Byte_list appears in the AML.&n;&t; */
id|arg
op_assign
id|op-&gt;common.value.arg
suffix:semicolon
multiline_comment|/* skip first arg */
id|byte_list
op_assign
id|arg-&gt;named.next
suffix:semicolon
r_if
c_cond
(paren
id|byte_list
)paren
(brace
r_if
c_cond
(paren
id|byte_list-&gt;common.aml_opcode
op_ne
id|AML_INT_BYTELIST_OP
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Expecting bytelist, got AML opcode %X in op %p&bslash;n&quot;
comma
id|byte_list-&gt;common.aml_opcode
comma
id|byte_list
)paren
)paren
suffix:semicolon
id|acpi_ut_remove_reference
(paren
id|obj_desc
)paren
suffix:semicolon
r_return
(paren
id|AE_TYPE
)paren
suffix:semicolon
)brace
id|byte_list_length
op_assign
id|byte_list-&gt;common.value.integer32
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The buffer length (number of bytes) will be the larger of:&n;&t; * 1) The specified buffer length and&n;&t; * 2) The length of the initializer byte list&n;&t; */
id|obj_desc-&gt;buffer.length
op_assign
id|buffer_length
suffix:semicolon
r_if
c_cond
(paren
id|byte_list_length
OG
id|buffer_length
)paren
(brace
id|obj_desc-&gt;buffer.length
op_assign
id|byte_list_length
suffix:semicolon
)brace
multiline_comment|/* Allocate the buffer */
r_if
c_cond
(paren
id|obj_desc-&gt;buffer.length
op_eq
l_int|0
)paren
(brace
id|obj_desc-&gt;buffer.pointer
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_REPORT_WARNING
(paren
(paren
l_string|&quot;Buffer created with zero length in AML&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|obj_desc-&gt;buffer.pointer
op_assign
id|ACPI_MEM_CALLOCATE
(paren
id|obj_desc-&gt;buffer.length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc-&gt;buffer.pointer
)paren
(brace
id|acpi_ut_delete_object_desc
(paren
id|obj_desc
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize buffer from the Byte_list (if present) */
r_if
c_cond
(paren
id|byte_list
)paren
(brace
id|ACPI_MEMCPY
(paren
id|obj_desc-&gt;buffer.pointer
comma
id|byte_list-&gt;named.data
comma
id|byte_list_length
)paren
suffix:semicolon
)brace
id|obj_desc-&gt;buffer.flags
op_or_assign
id|AOPOBJ_DATA_VALID
suffix:semicolon
id|op-&gt;common.node
op_assign
(paren
id|acpi_namespace_node
op_star
)paren
id|obj_desc
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_build_internal_package_obj&n; *&n; * PARAMETERS:  Op              - Parser object to be translated&n; *              Obj_desc_ptr    - Where the ACPI internal object is returned&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Translate a parser Op package object to the equivalent&n; *              namespace object&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_build_internal_package_obj
id|acpi_ds_build_internal_package_obj
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_parse_object
op_star
id|op
comma
id|u32
id|package_length
comma
id|acpi_operand_object
op_star
op_star
id|obj_desc_ptr
)paren
(brace
id|acpi_parse_object
op_star
id|arg
suffix:semicolon
id|acpi_parse_object
op_star
id|parent
suffix:semicolon
id|acpi_operand_object
op_star
id|obj_desc
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|package_list_length
suffix:semicolon
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ds_build_internal_package_obj&quot;
)paren
suffix:semicolon
multiline_comment|/* Find the parent of a possibly nested package */
id|parent
op_assign
id|op-&gt;common.parent
suffix:semicolon
r_while
c_loop
(paren
(paren
id|parent-&gt;common.aml_opcode
op_eq
id|AML_PACKAGE_OP
)paren
op_logical_or
(paren
id|parent-&gt;common.aml_opcode
op_eq
id|AML_VAR_PACKAGE_OP
)paren
)paren
(brace
id|parent
op_assign
id|parent-&gt;common.parent
suffix:semicolon
)brace
id|obj_desc
op_assign
op_star
id|obj_desc_ptr
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc
)paren
(brace
multiline_comment|/*&n;&t;&t; * We are evaluating a Named package object &quot;Name (xxxx, Package)&quot;.&n;&t;&t; * Get the existing package object from the NS node&n;&t;&t; */
)brace
r_else
(brace
id|obj_desc
op_assign
id|acpi_ut_create_internal_object
(paren
id|ACPI_TYPE_PACKAGE
)paren
suffix:semicolon
op_star
id|obj_desc_ptr
op_assign
id|obj_desc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|obj_desc-&gt;package.node
op_assign
id|parent-&gt;common.node
suffix:semicolon
)brace
id|obj_desc-&gt;package.count
op_assign
id|package_length
suffix:semicolon
multiline_comment|/* Count the number of items in the package list */
id|package_list_length
op_assign
l_int|0
suffix:semicolon
id|arg
op_assign
id|op-&gt;common.value.arg
suffix:semicolon
id|arg
op_assign
id|arg-&gt;common.next
suffix:semicolon
r_while
c_loop
(paren
id|arg
)paren
(brace
id|package_list_length
op_increment
suffix:semicolon
id|arg
op_assign
id|arg-&gt;common.next
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The package length (number of elements) will be the greater&n;&t; * of the specified length and the length of the initializer list&n;&t; */
r_if
c_cond
(paren
id|package_list_length
OG
id|package_length
)paren
(brace
id|obj_desc-&gt;package.count
op_assign
id|package_list_length
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Allocate the pointer array (array of pointers to the&n;&t; * individual objects). Add an extra pointer slot so&n;&t; * that the list is always null terminated.&n;&t; */
id|obj_desc-&gt;package.elements
op_assign
id|ACPI_MEM_CALLOCATE
(paren
(paren
(paren
id|ACPI_SIZE
)paren
id|obj_desc-&gt;package.count
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
r_void
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc-&gt;package.elements
)paren
(brace
id|acpi_ut_delete_object_desc
(paren
id|obj_desc
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now init the elements of the package&n;&t; */
id|i
op_assign
l_int|0
suffix:semicolon
id|arg
op_assign
id|op-&gt;common.value.arg
suffix:semicolon
id|arg
op_assign
id|arg-&gt;common.next
suffix:semicolon
r_while
c_loop
(paren
id|arg
)paren
(brace
r_if
c_cond
(paren
id|arg-&gt;common.aml_opcode
op_eq
id|AML_INT_RETURN_VALUE_OP
)paren
(brace
multiline_comment|/* Object (package or buffer) is already built */
id|obj_desc-&gt;package.elements
(braket
id|i
)braket
op_assign
id|ACPI_CAST_PTR
(paren
id|acpi_operand_object
comma
id|arg-&gt;common.node
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|acpi_ds_build_internal_object
(paren
id|walk_state
comma
id|arg
comma
op_amp
id|obj_desc-&gt;package.elements
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
id|arg
op_assign
id|arg-&gt;common.next
suffix:semicolon
)brace
id|obj_desc-&gt;package.flags
op_or_assign
id|AOPOBJ_DATA_VALID
suffix:semicolon
id|op-&gt;common.node
op_assign
(paren
id|acpi_namespace_node
op_star
)paren
id|obj_desc
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_create_node&n; *&n; * PARAMETERS:  Op              - Parser object to be translated&n; *              Obj_desc_ptr    - Where the ACPI internal object is returned&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_create_node
id|acpi_ds_create_node
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_namespace_node
op_star
id|node
comma
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;Ds_create_node&quot;
comma
id|op
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Because of the execution pass through the non-control-method&n;&t; * parts of the table, we can arrive here twice.  Only init&n;&t; * the named object node the first time through&n;&t; */
r_if
c_cond
(paren
id|acpi_ns_get_attached_object
(paren
id|node
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|op-&gt;common.value.arg
)paren
(brace
multiline_comment|/* No arguments, there is nothing to do */
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Build an internal object for the argument(s) */
id|status
op_assign
id|acpi_ds_build_internal_object
(paren
id|walk_state
comma
id|op-&gt;common.value.arg
comma
op_amp
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Re-type the object according to it&squot;s argument */
id|node-&gt;type
op_assign
id|obj_desc-&gt;common.type
suffix:semicolon
multiline_comment|/* Attach obj to node */
id|status
op_assign
id|acpi_ns_attach_object
(paren
id|node
comma
id|obj_desc
comma
id|node-&gt;type
)paren
suffix:semicolon
multiline_comment|/* Remove local reference to the object */
id|acpi_ut_remove_reference
(paren
id|obj_desc
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
eof
