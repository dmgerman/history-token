multiline_comment|/******************************************************************************&n; *&n; * Module Name: dsopcode - Dispatcher Op Region support and handling of&n; *                         &quot;control&quot; opcodes&n; *&n; *****************************************************************************/
multiline_comment|/*&n; * Copyright (C) 2000 - 2005, R. Byron Moore&n; * All rights reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification.&n; * 2. Redistributions in binary form must reproduce at minimum a disclaimer&n; *    substantially similar to the &quot;NO WARRANTY&quot; disclaimer below&n; *    (&quot;Disclaimer&quot;) and any redistribution must be conditioned upon&n; *    including a substantially similar Disclaimer requirement for further&n; *    binary redistribution.&n; * 3. Neither the names of the above-listed copyright holders nor the names&n; *    of any contributors may be used to endorse or promote products derived&n; *    from this software without specific prior written permission.&n; *&n; * Alternatively, this software may be distributed under the terms of the&n; * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free&n; * Software Foundation.&n; *&n; * NO WARRANTY&n; * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS&n; * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT&n; * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR&n; * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT&n; * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,&n; * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING&n; * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE&n; * POSSIBILITY OF SUCH DAMAGES.&n; */
macro_line|#include &lt;acpi/acpi.h&gt;
macro_line|#include &lt;acpi/acparser.h&gt;
macro_line|#include &lt;acpi/amlcode.h&gt;
macro_line|#include &lt;acpi/acdispat.h&gt;
macro_line|#include &lt;acpi/acinterp.h&gt;
macro_line|#include &lt;acpi/acnamesp.h&gt;
macro_line|#include &lt;acpi/acevents.h&gt;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          ACPI_DISPATCHER
id|ACPI_MODULE_NAME
(paren
l_string|&quot;dsopcode&quot;
)paren
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_execute_arguments&n; *&n; * PARAMETERS:  Node                - Parent NS node&n; *              aml_length          - Length of executable AML&n; *              aml_start           - Pointer to the AML&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Late (deferred) execution of region or field arguments&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_execute_arguments
id|acpi_ds_execute_arguments
(paren
r_struct
id|acpi_namespace_node
op_star
id|node
comma
r_struct
id|acpi_namespace_node
op_star
id|scope_node
comma
id|u32
id|aml_length
comma
id|u8
op_star
id|aml_start
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_union
id|acpi_parse_object
op_star
id|op
suffix:semicolon
r_struct
id|acpi_walk_state
op_star
id|walk_state
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;ds_execute_arguments&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate a new parser op to be the root of the parsed tree&n;&t; */
id|op
op_assign
id|acpi_ps_alloc_op
(paren
id|AML_INT_EVAL_SUBTREE_OP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/* Save the Node for use in acpi_ps_parse_aml */
id|op-&gt;common.node
op_assign
id|scope_node
suffix:semicolon
multiline_comment|/* Create and initialize a new parser state */
id|walk_state
op_assign
id|acpi_ds_create_walk_state
(paren
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|walk_state
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_ds_init_aml_walk
(paren
id|walk_state
comma
id|op
comma
l_int|NULL
comma
id|aml_start
comma
id|aml_length
comma
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ds_delete_walk_state
(paren
id|walk_state
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Mark this parse as a deferred opcode */
id|walk_state-&gt;parse_flags
op_assign
id|ACPI_PARSE_DEFERRED_OP
suffix:semicolon
id|walk_state-&gt;deferred_node
op_assign
id|node
suffix:semicolon
multiline_comment|/* Pass1: Parse the entire declaration */
id|status
op_assign
id|acpi_ps_parse_aml
(paren
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ps_delete_parse_tree
(paren
id|op
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Get and init the Op created above */
id|op-&gt;common.node
op_assign
id|node
suffix:semicolon
id|acpi_ps_delete_parse_tree
(paren
id|op
)paren
suffix:semicolon
multiline_comment|/* Evaluate the deferred arguments */
id|op
op_assign
id|acpi_ps_alloc_op
(paren
id|AML_INT_EVAL_SUBTREE_OP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|op-&gt;common.node
op_assign
id|scope_node
suffix:semicolon
multiline_comment|/* Create and initialize a new parser state */
id|walk_state
op_assign
id|acpi_ds_create_walk_state
(paren
l_int|0
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|walk_state
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/* Execute the opcode and arguments */
id|status
op_assign
id|acpi_ds_init_aml_walk
(paren
id|walk_state
comma
id|op
comma
l_int|NULL
comma
id|aml_start
comma
id|aml_length
comma
l_int|NULL
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ds_delete_walk_state
(paren
id|walk_state
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Mark this execution as a deferred opcode */
id|walk_state-&gt;deferred_node
op_assign
id|node
suffix:semicolon
id|status
op_assign
id|acpi_ps_parse_aml
(paren
id|walk_state
)paren
suffix:semicolon
id|acpi_ps_delete_parse_tree
(paren
id|op
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_get_buffer_field_arguments&n; *&n; * PARAMETERS:  obj_desc        - A valid buffer_field object&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Get buffer_field Buffer and Index. This implements the late&n; *              evaluation of these field attributes.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_get_buffer_field_arguments
id|acpi_ds_get_buffer_field_arguments
(paren
r_union
id|acpi_operand_object
op_star
id|obj_desc
)paren
(brace
r_union
id|acpi_operand_object
op_star
id|extra_desc
suffix:semicolon
r_struct
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;ds_get_buffer_field_arguments&quot;
comma
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc-&gt;common.flags
op_amp
id|AOPOBJ_DATA_VALID
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the AML pointer (method object) and buffer_field node */
id|extra_desc
op_assign
id|acpi_ns_get_secondary_object
(paren
id|obj_desc
)paren
suffix:semicolon
id|node
op_assign
id|obj_desc-&gt;buffer_field.node
suffix:semicolon
id|ACPI_DEBUG_EXEC
c_func
(paren
id|acpi_ut_display_init_pathname
(paren
id|ACPI_TYPE_BUFFER_FIELD
comma
id|node
comma
l_int|NULL
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[%4.4s] buffer_field Arg Init&bslash;n&quot;
comma
id|acpi_ut_get_node_name
(paren
id|node
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Execute the AML code for the term_arg arguments */
id|status
op_assign
id|acpi_ds_execute_arguments
(paren
id|node
comma
id|acpi_ns_get_parent_node
(paren
id|node
)paren
comma
id|extra_desc-&gt;extra.aml_length
comma
id|extra_desc-&gt;extra.aml_start
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_get_buffer_arguments&n; *&n; * PARAMETERS:  obj_desc        - A valid Buffer object&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Get Buffer length and initializer byte list.  This implements&n; *              the late evaluation of these attributes.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_get_buffer_arguments
id|acpi_ds_get_buffer_arguments
(paren
r_union
id|acpi_operand_object
op_star
id|obj_desc
)paren
(brace
r_struct
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;ds_get_buffer_arguments&quot;
comma
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc-&gt;common.flags
op_amp
id|AOPOBJ_DATA_VALID
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the Buffer node */
id|node
op_assign
id|obj_desc-&gt;buffer.node
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|ACPI_REPORT_ERROR
(paren
(paren
l_string|&quot;No pointer back to NS node in buffer obj %p&bslash;n&quot;
comma
id|obj_desc
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_AML_INTERNAL
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;Buffer Arg Init&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Execute the AML code for the term_arg arguments */
id|status
op_assign
id|acpi_ds_execute_arguments
(paren
id|node
comma
id|node
comma
id|obj_desc-&gt;buffer.aml_length
comma
id|obj_desc-&gt;buffer.aml_start
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_get_package_arguments&n; *&n; * PARAMETERS:  obj_desc        - A valid Package object&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Get Package length and initializer byte list.  This implements&n; *              the late evaluation of these attributes.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_get_package_arguments
id|acpi_ds_get_package_arguments
(paren
r_union
id|acpi_operand_object
op_star
id|obj_desc
)paren
(brace
r_struct
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;ds_get_package_arguments&quot;
comma
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc-&gt;common.flags
op_amp
id|AOPOBJ_DATA_VALID
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the Package node */
id|node
op_assign
id|obj_desc-&gt;package.node
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|ACPI_REPORT_ERROR
(paren
(paren
l_string|&quot;No pointer back to NS node in package %p&bslash;n&quot;
comma
id|obj_desc
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_AML_INTERNAL
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;Package Arg Init&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Execute the AML code for the term_arg arguments */
id|status
op_assign
id|acpi_ds_execute_arguments
(paren
id|node
comma
id|node
comma
id|obj_desc-&gt;package.aml_length
comma
id|obj_desc-&gt;package.aml_start
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_get_region_arguments&n; *&n; * PARAMETERS:  obj_desc        - A valid region object&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Get region address and length.  This implements the late&n; *              evaluation of these region attributes.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_get_region_arguments
id|acpi_ds_get_region_arguments
(paren
r_union
id|acpi_operand_object
op_star
id|obj_desc
)paren
(brace
r_struct
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_union
id|acpi_operand_object
op_star
id|extra_desc
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;ds_get_region_arguments&quot;
comma
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc-&gt;region.flags
op_amp
id|AOPOBJ_DATA_VALID
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|extra_desc
op_assign
id|acpi_ns_get_secondary_object
(paren
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|extra_desc
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the Region node */
id|node
op_assign
id|obj_desc-&gt;region.node
suffix:semicolon
id|ACPI_DEBUG_EXEC
(paren
id|acpi_ut_display_init_pathname
(paren
id|ACPI_TYPE_REGION
comma
id|node
comma
l_int|NULL
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[%4.4s] op_region Arg Init at AML %p&bslash;n&quot;
comma
id|acpi_ut_get_node_name
(paren
id|node
)paren
comma
id|extra_desc-&gt;extra.aml_start
)paren
)paren
suffix:semicolon
multiline_comment|/* Execute the argument AML */
id|status
op_assign
id|acpi_ds_execute_arguments
(paren
id|node
comma
id|acpi_ns_get_parent_node
(paren
id|node
)paren
comma
id|extra_desc-&gt;extra.aml_length
comma
id|extra_desc-&gt;extra.aml_start
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_initialize_region&n; *&n; * PARAMETERS:  Op              - A valid region Op object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Front end to ev_initialize_region&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_initialize_region
id|acpi_ds_initialize_region
(paren
id|acpi_handle
id|obj_handle
)paren
(brace
r_union
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|obj_handle
)paren
suffix:semicolon
multiline_comment|/* Namespace is NOT locked */
id|status
op_assign
id|acpi_ev_initialize_region
(paren
id|obj_desc
comma
id|FALSE
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_init_buffer_field&n; *&n; * PARAMETERS:  aml_opcode      - create_xxx_field&n; *              obj_desc        - buffer_field object&n; *              buffer_desc     - Host Buffer&n; *              offset_desc     - Offset into buffer&n; *              Length          - Length of field (CREATE_FIELD_OP only)&n; *              Result          - Where to store the result&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Perform actual initialization of a buffer field&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_init_buffer_field
id|acpi_ds_init_buffer_field
(paren
id|u16
id|aml_opcode
comma
r_union
id|acpi_operand_object
op_star
id|obj_desc
comma
r_union
id|acpi_operand_object
op_star
id|buffer_desc
comma
r_union
id|acpi_operand_object
op_star
id|offset_desc
comma
r_union
id|acpi_operand_object
op_star
id|length_desc
comma
r_union
id|acpi_operand_object
op_star
id|result_desc
)paren
(brace
id|u32
id|offset
suffix:semicolon
id|u32
id|bit_offset
suffix:semicolon
id|u32
id|bit_count
suffix:semicolon
id|u8
id|field_flags
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;ds_init_buffer_field&quot;
comma
id|obj_desc
)paren
suffix:semicolon
multiline_comment|/* Host object must be a Buffer */
r_if
c_cond
(paren
id|ACPI_GET_OBJECT_TYPE
(paren
id|buffer_desc
)paren
op_ne
id|ACPI_TYPE_BUFFER
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Target of Create Field is not a Buffer object - %s&bslash;n&quot;
comma
id|acpi_ut_get_object_type_name
(paren
id|buffer_desc
)paren
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_OPERAND_TYPE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The last parameter to all of these opcodes (result_desc) started&n;&t; * out as a name_string, and should therefore now be a NS node&n;&t; * after resolution in acpi_ex_resolve_operands().&n;&t; */
r_if
c_cond
(paren
id|ACPI_GET_DESCRIPTOR_TYPE
(paren
id|result_desc
)paren
op_ne
id|ACPI_DESC_TYPE_NAMED
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;(%s) destination not a NS Node [%s]&bslash;n&quot;
comma
id|acpi_ps_get_opcode_name
(paren
id|aml_opcode
)paren
comma
id|acpi_ut_get_descriptor_name
(paren
id|result_desc
)paren
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_OPERAND_TYPE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|offset
op_assign
(paren
id|u32
)paren
id|offset_desc-&gt;integer.value
suffix:semicolon
multiline_comment|/*&n;&t; * Setup the Bit offsets and counts, according to the opcode&n;&t; */
r_switch
c_cond
(paren
id|aml_opcode
)paren
(brace
r_case
id|AML_CREATE_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bits, count is in bits */
id|bit_offset
op_assign
id|offset
suffix:semicolon
id|bit_count
op_assign
(paren
id|u32
)paren
id|length_desc-&gt;integer.value
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_BIT_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bits, Field is one bit */
id|bit_offset
op_assign
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|1
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_BYTE_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bytes, field is one byte */
id|bit_offset
op_assign
l_int|8
op_star
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|8
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_WORD_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bytes, field is one word */
id|bit_offset
op_assign
l_int|8
op_star
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|16
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_WORD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_DWORD_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bytes, field is one dword */
id|bit_offset
op_assign
l_int|8
op_star
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|32
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_DWORD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_QWORD_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bytes, field is one qword */
id|bit_offset
op_assign
l_int|8
op_star
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|64
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_QWORD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unknown field creation opcode %02x&bslash;n&quot;
comma
id|aml_opcode
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_BAD_OPCODE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/* Entire field must fit within the current length of the buffer */
r_if
c_cond
(paren
(paren
id|bit_offset
op_plus
id|bit_count
)paren
OG
(paren
l_int|8
op_star
(paren
id|u32
)paren
id|buffer_desc-&gt;buffer.length
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Field [%4.4s] size %d exceeds Buffer [%4.4s] size %d (bits)&bslash;n&quot;
comma
id|acpi_ut_get_node_name
(paren
id|result_desc
)paren
comma
id|bit_offset
op_plus
id|bit_count
comma
id|acpi_ut_get_node_name
(paren
id|buffer_desc-&gt;buffer.node
)paren
comma
l_int|8
op_star
(paren
id|u32
)paren
id|buffer_desc-&gt;buffer.length
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_BUFFER_LIMIT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Initialize areas of the field object that are common to all fields&n;&t; * For field_flags, use LOCK_RULE = 0 (NO_LOCK), UPDATE_RULE = 0 (UPDATE_PRESERVE)&n;&t; */
id|status
op_assign
id|acpi_ex_prep_common_field_object
(paren
id|obj_desc
comma
id|field_flags
comma
l_int|0
comma
id|bit_offset
comma
id|bit_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_goto
id|cleanup
suffix:semicolon
)brace
id|obj_desc-&gt;buffer_field.buffer_obj
op_assign
id|buffer_desc
suffix:semicolon
multiline_comment|/* Reference count for buffer_desc inherits obj_desc count */
id|buffer_desc-&gt;common.reference_count
op_assign
(paren
id|u16
)paren
(paren
id|buffer_desc-&gt;common.reference_count
op_plus
id|obj_desc-&gt;common.reference_count
)paren
suffix:semicolon
id|cleanup
suffix:colon
multiline_comment|/* Always delete the operands */
id|acpi_ut_remove_reference
(paren
id|offset_desc
)paren
suffix:semicolon
id|acpi_ut_remove_reference
(paren
id|buffer_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aml_opcode
op_eq
id|AML_CREATE_FIELD_OP
)paren
(brace
id|acpi_ut_remove_reference
(paren
id|length_desc
)paren
suffix:semicolon
)brace
multiline_comment|/* On failure, delete the result descriptor */
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ut_remove_reference
(paren
id|result_desc
)paren
suffix:semicolon
multiline_comment|/* Result descriptor */
)brace
r_else
(brace
multiline_comment|/* Now the address and length are valid for this buffer_field */
id|obj_desc-&gt;buffer_field.flags
op_or_assign
id|AOPOBJ_DATA_VALID
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_eval_buffer_field_operands&n; *&n; * PARAMETERS:  walk_state      - Current walk&n; *              Op              - A valid buffer_field Op object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Get buffer_field Buffer and Index&n; *              Called from acpi_ds_exec_end_op during buffer_field parse tree walk&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_eval_buffer_field_operands
id|acpi_ds_eval_buffer_field_operands
(paren
r_struct
id|acpi_walk_state
op_star
id|walk_state
comma
r_union
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_union
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
r_struct
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
r_union
id|acpi_parse_object
op_star
id|next_op
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;ds_eval_buffer_field_operands&quot;
comma
id|op
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is where we evaluate the address and length fields of the&n;&t; * create_xxx_field declaration&n;&t; */
id|node
op_assign
id|op-&gt;common.node
suffix:semicolon
multiline_comment|/* next_op points to the op that holds the Buffer */
id|next_op
op_assign
id|op-&gt;common.value.arg
suffix:semicolon
multiline_comment|/* Evaluate/create the address and length operands */
id|status
op_assign
id|acpi_ds_create_operands
(paren
id|walk_state
comma
id|next_op
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
multiline_comment|/* Resolve the operands */
id|status
op_assign
id|acpi_ex_resolve_operands
(paren
id|op-&gt;common.aml_opcode
comma
id|ACPI_WALK_OPERANDS
comma
id|walk_state
)paren
suffix:semicolon
id|ACPI_DUMP_OPERANDS
(paren
id|ACPI_WALK_OPERANDS
comma
id|ACPI_IMODE_EXECUTE
comma
id|acpi_ps_get_opcode_name
(paren
id|op-&gt;common.aml_opcode
)paren
comma
id|walk_state-&gt;num_operands
comma
l_string|&quot;after acpi_ex_resolve_operands&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;(%s) bad operand(s) (%X)&bslash;n&quot;
comma
id|acpi_ps_get_opcode_name
(paren
id|op-&gt;common.aml_opcode
)paren
comma
id|status
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the Buffer Field */
r_if
c_cond
(paren
id|op-&gt;common.aml_opcode
op_eq
id|AML_CREATE_FIELD_OP
)paren
(brace
multiline_comment|/* NOTE: Slightly different operands for this opcode */
id|status
op_assign
id|acpi_ds_init_buffer_field
(paren
id|op-&gt;common.aml_opcode
comma
id|obj_desc
comma
id|walk_state-&gt;operands
(braket
l_int|0
)braket
comma
id|walk_state-&gt;operands
(braket
l_int|1
)braket
comma
id|walk_state-&gt;operands
(braket
l_int|2
)braket
comma
id|walk_state-&gt;operands
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* All other, create_xxx_field opcodes */
id|status
op_assign
id|acpi_ds_init_buffer_field
(paren
id|op-&gt;common.aml_opcode
comma
id|obj_desc
comma
id|walk_state-&gt;operands
(braket
l_int|0
)braket
comma
id|walk_state-&gt;operands
(braket
l_int|1
)braket
comma
l_int|NULL
comma
id|walk_state-&gt;operands
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_eval_region_operands&n; *&n; * PARAMETERS:  walk_state      - Current walk&n; *              Op              - A valid region Op object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Get region address and length&n; *              Called from acpi_ds_exec_end_op during op_region parse tree walk&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_eval_region_operands
id|acpi_ds_eval_region_operands
(paren
r_struct
id|acpi_walk_state
op_star
id|walk_state
comma
r_union
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_union
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
r_union
id|acpi_operand_object
op_star
id|operand_desc
suffix:semicolon
r_struct
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
r_union
id|acpi_parse_object
op_star
id|next_op
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;ds_eval_region_operands&quot;
comma
id|op
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is where we evaluate the address and length fields of the op_region declaration&n;&t; */
id|node
op_assign
id|op-&gt;common.node
suffix:semicolon
multiline_comment|/* next_op points to the op that holds the space_iD */
id|next_op
op_assign
id|op-&gt;common.value.arg
suffix:semicolon
multiline_comment|/* next_op points to address op */
id|next_op
op_assign
id|next_op-&gt;common.next
suffix:semicolon
multiline_comment|/* Evaluate/create the address and length operands */
id|status
op_assign
id|acpi_ds_create_operands
(paren
id|walk_state
comma
id|next_op
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Resolve the length and address operands to numbers */
id|status
op_assign
id|acpi_ex_resolve_operands
(paren
id|op-&gt;common.aml_opcode
comma
id|ACPI_WALK_OPERANDS
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|ACPI_DUMP_OPERANDS
(paren
id|ACPI_WALK_OPERANDS
comma
id|ACPI_IMODE_EXECUTE
comma
id|acpi_ps_get_opcode_name
(paren
id|op-&gt;common.aml_opcode
)paren
comma
l_int|1
comma
l_string|&quot;after acpi_ex_resolve_operands&quot;
)paren
suffix:semicolon
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get the length operand and save it&n;&t; * (at Top of stack)&n;&t; */
id|operand_desc
op_assign
id|walk_state-&gt;operands
(braket
id|walk_state-&gt;num_operands
op_minus
l_int|1
)braket
suffix:semicolon
id|obj_desc-&gt;region.length
op_assign
(paren
id|u32
)paren
id|operand_desc-&gt;integer.value
suffix:semicolon
id|acpi_ut_remove_reference
(paren
id|operand_desc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Get the address and save it&n;&t; * (at top of stack - 1)&n;&t; */
id|operand_desc
op_assign
id|walk_state-&gt;operands
(braket
id|walk_state-&gt;num_operands
op_minus
l_int|2
)braket
suffix:semicolon
id|obj_desc-&gt;region.address
op_assign
(paren
id|acpi_physical_address
)paren
id|operand_desc-&gt;integer.value
suffix:semicolon
id|acpi_ut_remove_reference
(paren
id|operand_desc
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;rgn_obj %p Addr %8.8X%8.8X Len %X&bslash;n&quot;
comma
id|obj_desc
comma
id|ACPI_FORMAT_UINT64
(paren
id|obj_desc-&gt;region.address
)paren
comma
id|obj_desc-&gt;region.length
)paren
)paren
suffix:semicolon
multiline_comment|/* Now the address and length are valid for this opregion */
id|obj_desc-&gt;region.flags
op_or_assign
id|AOPOBJ_DATA_VALID
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    acpi_ds_eval_data_object_operands&n; *&n; * PARAMETERS:  walk_state      - Current walk&n; *              Op              - A valid data_object Op object&n; *              obj_desc        - data_object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Get the operands and complete the following data object types:&n; *              Buffer, Package.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_eval_data_object_operands
id|acpi_ds_eval_data_object_operands
(paren
r_struct
id|acpi_walk_state
op_star
id|walk_state
comma
r_union
id|acpi_parse_object
op_star
id|op
comma
r_union
id|acpi_operand_object
op_star
id|obj_desc
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_union
id|acpi_operand_object
op_star
id|arg_desc
suffix:semicolon
id|u32
id|length
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;ds_eval_data_object_operands&quot;
)paren
suffix:semicolon
multiline_comment|/* The first operand (for all of these data objects) is the length */
id|status
op_assign
id|acpi_ds_create_operand
(paren
id|walk_state
comma
id|op-&gt;common.value.arg
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_ex_resolve_operands
(paren
id|walk_state-&gt;opcode
comma
op_amp
(paren
id|walk_state-&gt;operands
(braket
id|walk_state-&gt;num_operands
op_minus
l_int|1
)braket
)paren
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Extract length operand */
id|arg_desc
op_assign
id|walk_state-&gt;operands
(braket
id|walk_state-&gt;num_operands
op_minus
l_int|1
)braket
suffix:semicolon
id|length
op_assign
(paren
id|u32
)paren
id|arg_desc-&gt;integer.value
suffix:semicolon
multiline_comment|/* Cleanup for length operand */
id|status
op_assign
id|acpi_ds_obj_stack_pop
(paren
l_int|1
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|acpi_ut_remove_reference
(paren
id|arg_desc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Create the actual data object&n;&t; */
r_switch
c_cond
(paren
id|op-&gt;common.aml_opcode
)paren
(brace
r_case
id|AML_BUFFER_OP
suffix:colon
id|status
op_assign
id|acpi_ds_build_internal_buffer_obj
(paren
id|walk_state
comma
id|op
comma
id|length
comma
op_amp
id|obj_desc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_PACKAGE_OP
suffix:colon
r_case
id|AML_VAR_PACKAGE_OP
suffix:colon
id|status
op_assign
id|acpi_ds_build_internal_package_obj
(paren
id|walk_state
comma
id|op
comma
id|length
comma
op_amp
id|obj_desc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|return_ACPI_STATUS
(paren
id|AE_AML_BAD_OPCODE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Return the object in the walk_state, unless the parent is a package --&n;&t;&t; * in this case, the return object will be stored in the parse tree&n;&t;&t; * for the package.&n;&t;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|op-&gt;common.parent
)paren
op_logical_or
(paren
(paren
id|op-&gt;common.parent-&gt;common.aml_opcode
op_ne
id|AML_PACKAGE_OP
)paren
op_logical_and
(paren
id|op-&gt;common.parent-&gt;common.aml_opcode
op_ne
id|AML_VAR_PACKAGE_OP
)paren
op_logical_and
(paren
id|op-&gt;common.parent-&gt;common.aml_opcode
op_ne
id|AML_NAME_OP
)paren
)paren
)paren
(brace
id|walk_state-&gt;result_obj
op_assign
id|obj_desc
suffix:semicolon
)brace
)brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    acpi_ds_exec_begin_control_op&n; *&n; * PARAMETERS:  walk_list       - The list that owns the walk stack&n; *              Op              - The control Op&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Handles all control ops encountered during control method&n; *              execution.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ds_exec_begin_control_op
id|acpi_ds_exec_begin_control_op
(paren
r_struct
id|acpi_walk_state
op_star
id|walk_state
comma
r_union
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_union
id|acpi_generic_state
op_star
id|control_state
suffix:semicolon
id|ACPI_FUNCTION_NAME
(paren
l_string|&quot;ds_exec_begin_control_op&quot;
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;Op=%p Opcode=%2.2X State=%p&bslash;n&quot;
comma
id|op
comma
id|op-&gt;common.aml_opcode
comma
id|walk_state
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|op-&gt;common.aml_opcode
)paren
(brace
r_case
id|AML_IF_OP
suffix:colon
r_case
id|AML_WHILE_OP
suffix:colon
multiline_comment|/*&n;&t;&t; * IF/WHILE: Create a new control state to manage these&n;&t;&t; * constructs. We need to manage these as a stack, in order&n;&t;&t; * to handle nesting.&n;&t;&t; */
id|control_state
op_assign
id|acpi_ut_create_control_state
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|control_state
)paren
(brace
id|status
op_assign
id|AE_NO_MEMORY
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Save a pointer to the predicate for multiple executions&n;&t;&t; * of a loop&n;&t;&t; */
id|control_state-&gt;control.aml_predicate_start
op_assign
id|walk_state-&gt;parser_state.aml
op_minus
l_int|1
suffix:semicolon
id|control_state-&gt;control.package_end
op_assign
id|walk_state-&gt;parser_state.pkg_end
suffix:semicolon
id|control_state-&gt;control.opcode
op_assign
id|op-&gt;common.aml_opcode
suffix:semicolon
multiline_comment|/* Push the control state on this walk&squot;s control stack */
id|acpi_ut_push_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
comma
id|control_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_ELSE_OP
suffix:colon
multiline_comment|/* Predicate is in the state object */
multiline_comment|/* If predicate is true, the IF was executed, ignore ELSE part */
r_if
c_cond
(paren
id|walk_state-&gt;last_predicate
)paren
(brace
id|status
op_assign
id|AE_CTRL_TRUE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|AML_RETURN_OP
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    acpi_ds_exec_end_control_op&n; *&n; * PARAMETERS:  walk_list       - The list that owns the walk stack&n; *              Op              - The control Op&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Handles all control ops encountered during control method&n; *              execution.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ds_exec_end_control_op
id|acpi_ds_exec_end_control_op
(paren
r_struct
id|acpi_walk_state
op_star
id|walk_state
comma
r_union
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_union
id|acpi_generic_state
op_star
id|control_state
suffix:semicolon
id|ACPI_FUNCTION_NAME
(paren
l_string|&quot;ds_exec_end_control_op&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|op-&gt;common.aml_opcode
)paren
(brace
r_case
id|AML_IF_OP
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;[IF_OP] Op=%p&bslash;n&quot;
comma
id|op
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Save the result of the predicate in case there is an&n;&t;&t; * ELSE to come&n;&t;&t; */
id|walk_state-&gt;last_predicate
op_assign
(paren
id|u8
)paren
id|walk_state-&gt;control_state-&gt;common.value
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Pop the control state that was created at the start&n;&t;&t; * of the IF and free it&n;&t;&t; */
id|control_state
op_assign
id|acpi_ut_pop_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
)paren
suffix:semicolon
id|acpi_ut_delete_generic_state
(paren
id|control_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_ELSE_OP
suffix:colon
r_break
suffix:semicolon
r_case
id|AML_WHILE_OP
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;[WHILE_OP] Op=%p&bslash;n&quot;
comma
id|op
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|walk_state-&gt;control_state-&gt;common.value
)paren
(brace
multiline_comment|/* Predicate was true, go back and evaluate it again! */
id|status
op_assign
id|AE_CTRL_PENDING
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;[WHILE_OP] termination! Op=%p&bslash;n&quot;
comma
id|op
)paren
)paren
suffix:semicolon
multiline_comment|/* Pop this control state and free it */
id|control_state
op_assign
id|acpi_ut_pop_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
)paren
suffix:semicolon
id|walk_state-&gt;aml_last_while
op_assign
id|control_state-&gt;control.aml_predicate_start
suffix:semicolon
id|acpi_ut_delete_generic_state
(paren
id|control_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_RETURN_OP
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;[RETURN_OP] Op=%p Arg=%p&bslash;n&quot;
comma
id|op
comma
id|op-&gt;common.value.arg
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * One optional operand -- the return value&n;&t;&t; * It can be either an immediate operand or a result that&n;&t;&t; * has been bubbled up the tree&n;&t;&t; */
r_if
c_cond
(paren
id|op-&gt;common.value.arg
)paren
(brace
multiline_comment|/* Return statement has an immediate operand */
id|status
op_assign
id|acpi_ds_create_operands
(paren
id|walk_state
comma
id|op-&gt;common.value.arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * If value being returned is a Reference (such as&n;&t;&t;&t; * an arg or local), resolve it now because it may&n;&t;&t;&t; * cease to exist at the end of the method.&n;&t;&t;&t; */
id|status
op_assign
id|acpi_ex_resolve_to_value
(paren
op_amp
id|walk_state-&gt;operands
(braket
l_int|0
)braket
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Get the return value and save as the last result&n;&t;&t;&t; * value.  This is the only place where walk_state-&gt;return_desc&n;&t;&t;&t; * is set to anything other than zero!&n;&t;&t;&t; */
id|walk_state-&gt;return_desc
op_assign
id|walk_state-&gt;operands
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|walk_state-&gt;results
)paren
op_logical_and
(paren
id|walk_state-&gt;results-&gt;results.num_results
OG
l_int|0
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * The return value has come from a previous calculation.&n;&t;&t;&t; *&n;&t;&t;&t; * If value being returned is a Reference (such as&n;&t;&t;&t; * an arg or local), resolve it now because it may&n;&t;&t;&t; * cease to exist at the end of the method.&n;&t;&t;&t; *&n;&t;&t;&t; * Allow references created by the Index operator to return unchanged.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|ACPI_GET_DESCRIPTOR_TYPE
(paren
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
)paren
op_eq
id|ACPI_DESC_TYPE_OPERAND
)paren
op_logical_and
(paren
id|ACPI_GET_OBJECT_TYPE
(paren
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
)paren
op_eq
id|ACPI_TYPE_LOCAL_REFERENCE
)paren
op_logical_and
(paren
(paren
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
)paren
op_member_access_from_pointer
id|reference.opcode
op_ne
id|AML_INDEX_OP
)paren
)paren
(brace
id|status
op_assign
id|acpi_ex_resolve_to_value
(paren
op_amp
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
id|walk_state-&gt;return_desc
op_assign
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No return operand */
r_if
c_cond
(paren
id|walk_state-&gt;num_operands
)paren
(brace
id|acpi_ut_remove_reference
(paren
id|walk_state-&gt;operands
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|walk_state-&gt;operands
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|walk_state-&gt;num_operands
op_assign
l_int|0
suffix:semicolon
id|walk_state-&gt;return_desc
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;Completed RETURN_OP State=%p, ret_val=%p&bslash;n&quot;
comma
id|walk_state
comma
id|walk_state-&gt;return_desc
)paren
)paren
suffix:semicolon
multiline_comment|/* End the control method execution right now */
id|status
op_assign
id|AE_CTRL_TERMINATE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_NOOP_OP
suffix:colon
multiline_comment|/* Just do nothing! */
r_break
suffix:semicolon
r_case
id|AML_BREAK_POINT_OP
suffix:colon
multiline_comment|/* Call up to the OS service layer to handle this */
id|status
op_assign
id|acpi_os_signal
(paren
id|ACPI_SIGNAL_BREAKPOINT
comma
l_string|&quot;Executed AML Breakpoint opcode&quot;
)paren
suffix:semicolon
multiline_comment|/* If and when it returns, all done. */
r_break
suffix:semicolon
r_case
id|AML_BREAK_OP
suffix:colon
r_case
id|AML_CONTINUE_OP
suffix:colon
multiline_comment|/* ACPI 2.0 */
multiline_comment|/* Pop and delete control states until we find a while */
r_while
c_loop
(paren
id|walk_state-&gt;control_state
op_logical_and
(paren
id|walk_state-&gt;control_state-&gt;control.opcode
op_ne
id|AML_WHILE_OP
)paren
)paren
(brace
id|control_state
op_assign
id|acpi_ut_pop_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
)paren
suffix:semicolon
id|acpi_ut_delete_generic_state
(paren
id|control_state
)paren
suffix:semicolon
)brace
multiline_comment|/* No while found? */
r_if
c_cond
(paren
op_logical_neg
id|walk_state-&gt;control_state
)paren
(brace
r_return
(paren
id|AE_AML_NO_WHILE
)paren
suffix:semicolon
)brace
multiline_comment|/* Was: walk_state-&gt;aml_last_while = walk_state-&gt;control_state-&gt;Control.aml_predicate_start; */
id|walk_state-&gt;aml_last_while
op_assign
id|walk_state-&gt;control_state-&gt;control.package_end
suffix:semicolon
multiline_comment|/* Return status depending on opcode */
r_if
c_cond
(paren
id|op-&gt;common.aml_opcode
op_eq
id|AML_BREAK_OP
)paren
(brace
id|status
op_assign
id|AE_CTRL_BREAK
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|AE_CTRL_CONTINUE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unknown control opcode=%X Op=%p&bslash;n&quot;
comma
id|op-&gt;common.aml_opcode
comma
id|op
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_BAD_OPCODE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
eof
