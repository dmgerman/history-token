multiline_comment|/******************************************************************************&n; *&n; * Module Name: dsopcode - Dispatcher Op Region support and handling of&n; *                         &quot;control&quot; opcodes&n; *              $Revision: 73 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 - 2002, R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acparser.h&quot;
macro_line|#include &quot;amlcode.h&quot;
macro_line|#include &quot;acdispat.h&quot;
macro_line|#include &quot;acinterp.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
macro_line|#include &quot;acevents.h&quot;
macro_line|#include &quot;actables.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          ACPI_DISPATCHER
id|ACPI_MODULE_NAME
(paren
l_string|&quot;dsopcode&quot;
)paren
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_execute_arguments&n; *&n; * PARAMETERS:  Node                - Parent NS node&n; *              Extra_desc          - Has AML pointer and length&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Late execution of region or field arguments&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_execute_arguments
id|acpi_ds_execute_arguments
(paren
id|acpi_namespace_node
op_star
id|node
comma
id|acpi_operand_object
op_star
id|extra_desc
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|acpi_parse_object
op_star
id|op
suffix:semicolon
id|acpi_walk_state
op_star
id|walk_state
suffix:semicolon
id|acpi_parse_object
op_star
id|arg
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Acpi_ds_execute_arguments&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate a new parser op to be the root of the parsed&n;&t; * Buffer_field tree&n;&t; */
id|op
op_assign
id|acpi_ps_alloc_op
(paren
id|AML_SCOPE_OP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/* Save the Node for use in Acpi_ps_parse_aml */
id|op-&gt;node
op_assign
id|acpi_ns_get_parent_node
(paren
id|node
)paren
suffix:semicolon
multiline_comment|/* Create and initialize a new parser state */
id|walk_state
op_assign
id|acpi_ds_create_walk_state
(paren
id|TABLE_ID_DSDT
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|walk_state
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_ds_init_aml_walk
(paren
id|walk_state
comma
id|op
comma
l_int|NULL
comma
id|extra_desc-&gt;extra.aml_start
comma
id|extra_desc-&gt;extra.aml_length
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ds_delete_walk_state
(paren
id|walk_state
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|walk_state-&gt;parse_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Pass1: Parse the entire Buffer_field declaration */
id|status
op_assign
id|acpi_ps_parse_aml
(paren
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ps_delete_parse_tree
(paren
id|op
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Get and init the actual Field_unit Op created above */
id|arg
op_assign
id|op-&gt;value.arg
suffix:semicolon
id|op-&gt;node
op_assign
id|node
suffix:semicolon
id|arg-&gt;node
op_assign
id|node
suffix:semicolon
id|acpi_ps_delete_parse_tree
(paren
id|op
)paren
suffix:semicolon
multiline_comment|/* Evaluate the address and length arguments for the Buffer Field */
id|op
op_assign
id|acpi_ps_alloc_op
(paren
id|AML_SCOPE_OP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|op-&gt;node
op_assign
id|acpi_ns_get_parent_node
(paren
id|node
)paren
suffix:semicolon
multiline_comment|/* Create and initialize a new parser state */
id|walk_state
op_assign
id|acpi_ds_create_walk_state
(paren
id|TABLE_ID_DSDT
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|walk_state
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_ds_init_aml_walk
(paren
id|walk_state
comma
id|op
comma
l_int|NULL
comma
id|extra_desc-&gt;extra.aml_start
comma
id|extra_desc-&gt;extra.aml_length
comma
l_int|NULL
comma
l_int|NULL
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ds_delete_walk_state
(paren
id|walk_state
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_ps_parse_aml
(paren
id|walk_state
)paren
suffix:semicolon
id|acpi_ps_delete_parse_tree
(paren
id|op
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_get_buffer_field_arguments&n; *&n; * PARAMETERS:  Obj_desc        - A valid Buffer_field object&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Get Buffer_field Buffer and Index. This implements the late&n; *              evaluation of these field attributes.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_get_buffer_field_arguments
id|acpi_ds_get_buffer_field_arguments
(paren
id|acpi_operand_object
op_star
id|obj_desc
)paren
(brace
id|acpi_operand_object
op_star
id|extra_desc
suffix:semicolon
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;Ds_get_buffer_field_arguments&quot;
comma
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc-&gt;common.flags
op_amp
id|AOPOBJ_DATA_VALID
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the AML pointer (method object) and Buffer_field node */
id|extra_desc
op_assign
id|acpi_ns_get_secondary_object
(paren
id|obj_desc
)paren
suffix:semicolon
id|node
op_assign
id|obj_desc-&gt;buffer_field.node
suffix:semicolon
id|ACPI_DEBUG_EXEC
c_func
(paren
id|acpi_ut_display_init_pathname
(paren
id|node
comma
l_string|&quot; [Field]&quot;
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[%4.4s] Buffer_field JIT Init&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|node-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* Execute the AML code for the Term_arg arguments */
id|status
op_assign
id|acpi_ds_execute_arguments
(paren
id|node
comma
id|extra_desc
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_get_region_arguments&n; *&n; * PARAMETERS:  Obj_desc        - A valid region object&n; *&n; * RETURN:      Status.&n; *&n; * DESCRIPTION: Get region address and length.  This implements the late&n; *              evaluation of these region attributes.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_get_region_arguments
id|acpi_ds_get_region_arguments
(paren
id|acpi_operand_object
op_star
id|obj_desc
)paren
(brace
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|acpi_operand_object
op_star
id|region_obj2
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;Ds_get_region_arguments&quot;
comma
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc-&gt;region.flags
op_amp
id|AOPOBJ_DATA_VALID
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|region_obj2
op_assign
id|acpi_ns_get_secondary_object
(paren
id|obj_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_obj2
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the AML pointer (method object) and region node */
id|node
op_assign
id|obj_desc-&gt;region.node
suffix:semicolon
id|ACPI_DEBUG_EXEC
c_func
(paren
id|acpi_ut_display_init_pathname
(paren
id|node
comma
l_string|&quot; [Operation Region]&quot;
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[%4.4s] Op_region Init at AML %p&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|node-&gt;name
comma
id|region_obj2-&gt;extra.aml_start
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_ds_execute_arguments
(paren
id|node
comma
id|region_obj2
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_initialize_region&n; *&n; * PARAMETERS:  Op              - A valid region Op object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_initialize_region
id|acpi_ds_initialize_region
(paren
id|acpi_handle
id|obj_handle
)paren
(brace
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|obj_handle
)paren
suffix:semicolon
multiline_comment|/* Namespace is NOT locked */
id|status
op_assign
id|acpi_ev_initialize_region
(paren
id|obj_desc
comma
id|FALSE
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_eval_buffer_field_operands&n; *&n; * PARAMETERS:  Op              - A valid Buffer_field Op object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Get Buffer_field Buffer and Index&n; *              Called from Acpi_ds_exec_end_op during Buffer_field parse tree walk&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_eval_buffer_field_operands
id|acpi_ds_eval_buffer_field_operands
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_parse_object
op_star
id|next_op
suffix:semicolon
id|u32
id|offset
suffix:semicolon
id|u32
id|bit_offset
suffix:semicolon
id|u32
id|bit_count
suffix:semicolon
id|u8
id|field_flags
suffix:semicolon
id|acpi_operand_object
op_star
id|res_desc
op_assign
l_int|NULL
suffix:semicolon
id|acpi_operand_object
op_star
id|cnt_desc
op_assign
l_int|NULL
suffix:semicolon
id|acpi_operand_object
op_star
id|off_desc
op_assign
l_int|NULL
suffix:semicolon
id|acpi_operand_object
op_star
id|src_desc
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;Ds_eval_buffer_field_operands&quot;
comma
id|op
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is where we evaluate the address and length fields of the&n;&t; * Create_xxx_field declaration&n;&t; */
id|node
op_assign
id|op-&gt;node
suffix:semicolon
multiline_comment|/* Next_op points to the op that holds the Buffer */
id|next_op
op_assign
id|op-&gt;value.arg
suffix:semicolon
multiline_comment|/* Acpi_evaluate/create the address and length operands */
id|status
op_assign
id|acpi_ds_create_operands
(paren
id|walk_state
comma
id|next_op
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
multiline_comment|/* Resolve the operands */
id|status
op_assign
id|acpi_ex_resolve_operands
(paren
id|op-&gt;opcode
comma
id|ACPI_WALK_OPERANDS
comma
id|walk_state
)paren
suffix:semicolon
id|ACPI_DUMP_OPERANDS
(paren
id|ACPI_WALK_OPERANDS
comma
id|ACPI_IMODE_EXECUTE
comma
id|acpi_ps_get_opcode_name
(paren
id|op-&gt;opcode
)paren
comma
id|walk_state-&gt;num_operands
comma
l_string|&quot;after Acpi_ex_resolve_operands&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;(%s) bad operand(s) (%X)&bslash;n&quot;
comma
id|acpi_ps_get_opcode_name
(paren
id|op-&gt;opcode
)paren
comma
id|status
)paren
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/* Get the operands */
r_if
c_cond
(paren
id|AML_CREATE_FIELD_OP
op_eq
id|op-&gt;opcode
)paren
(brace
id|res_desc
op_assign
id|walk_state-&gt;operands
(braket
l_int|3
)braket
suffix:semicolon
id|cnt_desc
op_assign
id|walk_state-&gt;operands
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_else
(brace
id|res_desc
op_assign
id|walk_state-&gt;operands
(braket
l_int|2
)braket
suffix:semicolon
)brace
id|off_desc
op_assign
id|walk_state-&gt;operands
(braket
l_int|1
)braket
suffix:semicolon
id|src_desc
op_assign
id|walk_state-&gt;operands
(braket
l_int|0
)braket
suffix:semicolon
id|offset
op_assign
(paren
id|u32
)paren
id|off_desc-&gt;integer.value
suffix:semicolon
multiline_comment|/*&n;&t; * If Res_desc is a Name, it will be a direct name pointer after&n;&t; * Acpi_ex_resolve_operands()&n;&t; */
r_if
c_cond
(paren
id|ACPI_GET_DESCRIPTOR_TYPE
(paren
id|res_desc
)paren
op_ne
id|ACPI_DESC_TYPE_NAMED
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;(%s) destination must be a NS Node&bslash;n&quot;
comma
id|acpi_ps_get_opcode_name
(paren
id|op-&gt;opcode
)paren
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_OPERAND_TYPE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Setup the Bit offsets and counts, according to the opcode&n;&t; */
r_switch
c_cond
(paren
id|op-&gt;opcode
)paren
(brace
r_case
id|AML_CREATE_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bits, count is in bits */
id|bit_offset
op_assign
id|offset
suffix:semicolon
id|bit_count
op_assign
(paren
id|u32
)paren
id|cnt_desc-&gt;integer.value
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_BIT_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bits, Field is one bit */
id|bit_offset
op_assign
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|1
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_BYTE_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bytes, field is one byte */
id|bit_offset
op_assign
l_int|8
op_star
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|8
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_WORD_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bytes, field is one word */
id|bit_offset
op_assign
l_int|8
op_star
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|16
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_WORD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_DWORD_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bytes, field is one dword */
id|bit_offset
op_assign
l_int|8
op_star
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|32
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_DWORD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_CREATE_QWORD_FIELD_OP
suffix:colon
multiline_comment|/* Offset is in bytes, field is one qword */
id|bit_offset
op_assign
l_int|8
op_star
id|offset
suffix:semicolon
id|bit_count
op_assign
l_int|64
suffix:semicolon
id|field_flags
op_assign
id|AML_FIELD_ACCESS_QWORD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Internal error - unknown field creation opcode %02x&bslash;n&quot;
comma
id|op-&gt;opcode
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_BAD_OPCODE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Setup field according to the object type&n;&t; */
r_switch
c_cond
(paren
id|src_desc-&gt;common.type
)paren
(brace
multiline_comment|/* Source_buff :=  Term_arg=&gt;Buffer */
r_case
id|ACPI_TYPE_BUFFER
suffix:colon
r_if
c_cond
(paren
(paren
id|bit_offset
op_plus
id|bit_count
)paren
OG
(paren
l_int|8
op_star
(paren
id|u32
)paren
id|src_desc-&gt;buffer.length
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Field size %d exceeds Buffer size %d (bits)&bslash;n&quot;
comma
id|bit_offset
op_plus
id|bit_count
comma
l_int|8
op_star
(paren
id|u32
)paren
id|src_desc-&gt;buffer.length
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_BUFFER_LIMIT
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Initialize areas of the field object that are common to all fields&n;&t;&t; * For Field_flags, use LOCK_RULE = 0 (NO_LOCK), UPDATE_RULE = 0 (UPDATE_PRESERVE)&n;&t;&t; */
id|status
op_assign
id|acpi_ex_prep_common_field_object
(paren
id|obj_desc
comma
id|field_flags
comma
l_int|0
comma
id|bit_offset
comma
id|bit_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|obj_desc-&gt;buffer_field.buffer_obj
op_assign
id|src_desc
suffix:semicolon
multiline_comment|/* Reference count for Src_desc inherits Obj_desc count */
id|src_desc-&gt;common.reference_count
op_assign
(paren
id|u16
)paren
(paren
id|src_desc-&gt;common.reference_count
op_plus
id|obj_desc-&gt;common.reference_count
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Improper object type */
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
(paren
id|src_desc-&gt;common.type
OG
(paren
id|u8
)paren
id|INTERNAL_TYPE_REFERENCE
)paren
op_logical_or
op_logical_neg
id|acpi_ut_valid_object_type
(paren
id|src_desc-&gt;common.type
)paren
)paren
multiline_comment|/* This line MUST be a single line until Acpi_src can handle it (block deletion) */
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Tried to create field in invalid object type %X&bslash;n&quot;
comma
id|src_desc-&gt;common.type
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Tried to create field in improper object type - %s&bslash;n&quot;
comma
id|acpi_ut_get_type_name
(paren
id|src_desc-&gt;common.type
)paren
)paren
)paren
suffix:semicolon
)brace
id|status
op_assign
id|AE_AML_OPERAND_TYPE
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|AML_CREATE_FIELD_OP
op_eq
id|op-&gt;opcode
)paren
(brace
multiline_comment|/* Delete object descriptor unique to Create_field */
id|acpi_ut_remove_reference
(paren
id|cnt_desc
)paren
suffix:semicolon
id|cnt_desc
op_assign
l_int|NULL
suffix:semicolon
)brace
id|cleanup
suffix:colon
multiline_comment|/* Always delete the operands */
id|acpi_ut_remove_reference
(paren
id|off_desc
)paren
suffix:semicolon
id|acpi_ut_remove_reference
(paren
id|src_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AML_CREATE_FIELD_OP
op_eq
id|op-&gt;opcode
)paren
(brace
id|acpi_ut_remove_reference
(paren
id|cnt_desc
)paren
suffix:semicolon
)brace
multiline_comment|/* On failure, delete the result descriptor */
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|acpi_ut_remove_reference
(paren
id|res_desc
)paren
suffix:semicolon
multiline_comment|/* Result descriptor */
)brace
r_else
(brace
multiline_comment|/* Now the address and length are valid for this Buffer_field */
id|obj_desc-&gt;buffer_field.flags
op_or_assign
id|AOPOBJ_DATA_VALID
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_eval_region_operands&n; *&n; * PARAMETERS:  Op              - A valid region Op object&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Get region address and length&n; *              Called from Acpi_ds_exec_end_op during Op_region parse tree walk&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_ds_eval_region_operands
id|acpi_ds_eval_region_operands
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|acpi_operand_object
op_star
id|operand_desc
suffix:semicolon
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_parse_object
op_star
id|next_op
suffix:semicolon
id|ACPI_FUNCTION_TRACE_PTR
(paren
l_string|&quot;Ds_eval_region_operands&quot;
comma
id|op
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This is where we evaluate the address and length fields of the Op_region declaration&n;&t; */
id|node
op_assign
id|op-&gt;node
suffix:semicolon
multiline_comment|/* Next_op points to the op that holds the Space_iD */
id|next_op
op_assign
id|op-&gt;value.arg
suffix:semicolon
multiline_comment|/* Next_op points to address op */
id|next_op
op_assign
id|next_op-&gt;next
suffix:semicolon
multiline_comment|/* Acpi_evaluate/create the address and length operands */
id|status
op_assign
id|acpi_ds_create_operands
(paren
id|walk_state
comma
id|next_op
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Resolve the length and address operands to numbers */
id|status
op_assign
id|acpi_ex_resolve_operands
(paren
id|op-&gt;opcode
comma
id|ACPI_WALK_OPERANDS
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|ACPI_DUMP_OPERANDS
(paren
id|ACPI_WALK_OPERANDS
comma
id|ACPI_IMODE_EXECUTE
comma
id|acpi_ps_get_opcode_name
(paren
id|op-&gt;opcode
)paren
comma
l_int|1
comma
l_string|&quot;after Acpi_ex_resolve_operands&quot;
)paren
suffix:semicolon
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|obj_desc
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get the length operand and save it&n;&t; * (at Top of stack)&n;&t; */
id|operand_desc
op_assign
id|walk_state-&gt;operands
(braket
id|walk_state-&gt;num_operands
op_minus
l_int|1
)braket
suffix:semicolon
id|obj_desc-&gt;region.length
op_assign
(paren
id|u32
)paren
id|operand_desc-&gt;integer.value
suffix:semicolon
id|acpi_ut_remove_reference
(paren
id|operand_desc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Get the address and save it&n;&t; * (at top of stack - 1)&n;&t; */
id|operand_desc
op_assign
id|walk_state-&gt;operands
(braket
id|walk_state-&gt;num_operands
op_minus
l_int|2
)braket
suffix:semicolon
id|obj_desc-&gt;region.address
op_assign
(paren
id|ACPI_PHYSICAL_ADDRESS
)paren
id|operand_desc-&gt;integer.value
suffix:semicolon
id|acpi_ut_remove_reference
(paren
id|operand_desc
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;Rgn_obj %p Addr %8.8X%8.8X Len %X&bslash;n&quot;
comma
id|obj_desc
comma
id|ACPI_HIDWORD
(paren
id|obj_desc-&gt;region.address
)paren
comma
id|ACPI_LODWORD
(paren
id|obj_desc-&gt;region.address
)paren
comma
id|obj_desc-&gt;region.length
)paren
)paren
suffix:semicolon
multiline_comment|/* Now the address and length are valid for this opregion */
id|obj_desc-&gt;region.flags
op_or_assign
id|AOPOBJ_DATA_VALID
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_exec_begin_control_op&n; *&n; * PARAMETERS:  Walk_list       - The list that owns the walk stack&n; *              Op              - The control Op&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Handles all control ops encountered during control method&n; *              execution.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ds_exec_begin_control_op
id|acpi_ds_exec_begin_control_op
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_generic_state
op_star
id|control_state
suffix:semicolon
id|ACPI_FUNCTION_NAME
(paren
l_string|&quot;Ds_exec_begin_control_op&quot;
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;Op=%p Opcode=%2.2X State=%p&bslash;n&quot;
comma
id|op
comma
id|op-&gt;opcode
comma
id|walk_state
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|op-&gt;opcode
)paren
(brace
r_case
id|AML_IF_OP
suffix:colon
r_case
id|AML_WHILE_OP
suffix:colon
multiline_comment|/*&n;&t;&t; * IF/WHILE: Create a new control state to manage these&n;&t;&t; * constructs. We need to manage these as a stack, in order&n;&t;&t; * to handle nesting.&n;&t;&t; */
id|control_state
op_assign
id|acpi_ut_create_control_state
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|control_state
)paren
(brace
id|status
op_assign
id|AE_NO_MEMORY
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Save a pointer to the predicate for multiple executions&n;&t;&t; * of a loop&n;&t;&t; */
id|control_state-&gt;control.aml_predicate_start
op_assign
id|walk_state-&gt;parser_state.aml
op_minus
l_int|1
suffix:semicolon
id|control_state-&gt;control.package_end
op_assign
id|walk_state-&gt;parser_state.pkg_end
suffix:semicolon
id|control_state-&gt;control.opcode
op_assign
id|op-&gt;opcode
suffix:semicolon
multiline_comment|/* Push the control state on this walk&squot;s control stack */
id|acpi_ut_push_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
comma
id|control_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_ELSE_OP
suffix:colon
multiline_comment|/* Predicate is in the state object */
multiline_comment|/* If predicate is true, the IF was executed, ignore ELSE part */
r_if
c_cond
(paren
id|walk_state-&gt;last_predicate
)paren
(brace
id|status
op_assign
id|AE_CTRL_TRUE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|AML_RETURN_OP
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ds_exec_end_control_op&n; *&n; * PARAMETERS:  Walk_list       - The list that owns the walk stack&n; *              Op              - The control Op&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Handles all control ops encountered during control method&n; *              execution.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ds_exec_end_control_op
id|acpi_ds_exec_end_control_op
(paren
id|acpi_walk_state
op_star
id|walk_state
comma
id|acpi_parse_object
op_star
id|op
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_generic_state
op_star
id|control_state
suffix:semicolon
id|ACPI_FUNCTION_NAME
(paren
l_string|&quot;Ds_exec_end_control_op&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|op-&gt;opcode
)paren
(brace
r_case
id|AML_IF_OP
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;[IF_OP] Op=%p&bslash;n&quot;
comma
id|op
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Save the result of the predicate in case there is an&n;&t;&t; * ELSE to come&n;&t;&t; */
id|walk_state-&gt;last_predicate
op_assign
(paren
id|u8
)paren
id|walk_state-&gt;control_state-&gt;common.value
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Pop the control state that was created at the start&n;&t;&t; * of the IF and free it&n;&t;&t; */
id|control_state
op_assign
id|acpi_ut_pop_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
)paren
suffix:semicolon
id|acpi_ut_delete_generic_state
(paren
id|control_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_ELSE_OP
suffix:colon
r_break
suffix:semicolon
r_case
id|AML_WHILE_OP
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;[WHILE_OP] Op=%p&bslash;n&quot;
comma
id|op
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|walk_state-&gt;control_state-&gt;common.value
)paren
(brace
multiline_comment|/* Predicate was true, go back and evaluate it again! */
id|status
op_assign
id|AE_CTRL_PENDING
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;[WHILE_OP] termination! Op=%p&bslash;n&quot;
comma
id|op
)paren
)paren
suffix:semicolon
multiline_comment|/* Pop this control state and free it */
id|control_state
op_assign
id|acpi_ut_pop_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
)paren
suffix:semicolon
id|walk_state-&gt;aml_last_while
op_assign
id|control_state-&gt;control.aml_predicate_start
suffix:semicolon
id|acpi_ut_delete_generic_state
(paren
id|control_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_RETURN_OP
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;[RETURN_OP] Op=%p Arg=%p&bslash;n&quot;
comma
id|op
comma
id|op-&gt;value.arg
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * One optional operand -- the return value&n;&t;&t; * It can be either an immediate operand or a result that&n;&t;&t; * has been bubbled up the tree&n;&t;&t; */
r_if
c_cond
(paren
id|op-&gt;value.arg
)paren
(brace
multiline_comment|/* Return statement has an immediate operand */
id|status
op_assign
id|acpi_ds_create_operands
(paren
id|walk_state
comma
id|op-&gt;value.arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * If value being returned is a Reference (such as&n;&t;&t;&t; * an arg or local), resolve it now because it may&n;&t;&t;&t; * cease to exist at the end of the method.&n;&t;&t;&t; */
id|status
op_assign
id|acpi_ex_resolve_to_value
(paren
op_amp
id|walk_state-&gt;operands
(braket
l_int|0
)braket
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Get the return value and save as the last result&n;&t;&t;&t; * value.  This is the only place where Walk_state-&gt;Return_desc&n;&t;&t;&t; * is set to anything other than zero!&n;&t;&t;&t; */
id|walk_state-&gt;return_desc
op_assign
id|walk_state-&gt;operands
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|walk_state-&gt;results
)paren
op_logical_and
(paren
id|walk_state-&gt;results-&gt;results.num_results
OG
l_int|0
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * The return value has come from a previous calculation.&n;&t;&t;&t; *&n;&t;&t;&t; * If value being returned is a Reference (such as&n;&t;&t;&t; * an arg or local), resolve it now because it may&n;&t;&t;&t; * cease to exist at the end of the method.&n;&t;&t;&t; *&n;&t;&t;&t; * Allow references created by the Index operator to return unchanged.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|ACPI_GET_DESCRIPTOR_TYPE
(paren
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
)paren
op_eq
id|ACPI_DESC_TYPE_INTERNAL
)paren
op_logical_and
(paren
(paren
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
)paren
op_member_access_from_pointer
id|common.type
op_eq
id|INTERNAL_TYPE_REFERENCE
)paren
op_logical_and
(paren
(paren
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
)paren
op_member_access_from_pointer
id|reference.opcode
op_ne
id|AML_INDEX_OP
)paren
)paren
(brace
id|status
op_assign
id|acpi_ex_resolve_to_value
(paren
op_amp
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
comma
id|walk_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
id|walk_state-&gt;return_desc
op_assign
id|walk_state-&gt;results-&gt;results.obj_desc
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No return operand */
r_if
c_cond
(paren
id|walk_state-&gt;num_operands
)paren
(brace
id|acpi_ut_remove_reference
(paren
id|walk_state-&gt;operands
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
id|walk_state-&gt;operands
(braket
l_int|0
)braket
op_assign
l_int|NULL
suffix:semicolon
id|walk_state-&gt;num_operands
op_assign
l_int|0
suffix:semicolon
id|walk_state-&gt;return_desc
op_assign
l_int|NULL
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_DISPATCH
comma
l_string|&quot;Completed RETURN_OP State=%p, Ret_val=%p&bslash;n&quot;
comma
id|walk_state
comma
id|walk_state-&gt;return_desc
)paren
)paren
suffix:semicolon
multiline_comment|/* End the control method execution right now */
id|status
op_assign
id|AE_CTRL_TERMINATE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AML_NOOP_OP
suffix:colon
multiline_comment|/* Just do nothing! */
r_break
suffix:semicolon
r_case
id|AML_BREAK_POINT_OP
suffix:colon
multiline_comment|/* Call up to the OS service layer to handle this */
id|acpi_os_signal
(paren
id|ACPI_SIGNAL_BREAKPOINT
comma
l_string|&quot;Executed AML Breakpoint opcode&quot;
)paren
suffix:semicolon
multiline_comment|/* If and when it returns, all done. */
r_break
suffix:semicolon
r_case
id|AML_BREAK_OP
suffix:colon
r_case
id|AML_CONTINUE_OP
suffix:colon
multiline_comment|/* ACPI 2.0 */
multiline_comment|/* Pop and delete control states until we find a while */
r_while
c_loop
(paren
id|walk_state-&gt;control_state
op_logical_and
(paren
id|walk_state-&gt;control_state-&gt;control.opcode
op_ne
id|AML_WHILE_OP
)paren
)paren
(brace
id|control_state
op_assign
id|acpi_ut_pop_generic_state
(paren
op_amp
id|walk_state-&gt;control_state
)paren
suffix:semicolon
id|acpi_ut_delete_generic_state
(paren
id|control_state
)paren
suffix:semicolon
)brace
multiline_comment|/* No while found? */
r_if
c_cond
(paren
op_logical_neg
id|walk_state-&gt;control_state
)paren
(brace
r_return
(paren
id|AE_AML_NO_WHILE
)paren
suffix:semicolon
)brace
multiline_comment|/* Was: Walk_state-&gt;Aml_last_while = Walk_state-&gt;Control_state-&gt;Control.Aml_predicate_start; */
id|walk_state-&gt;aml_last_while
op_assign
id|walk_state-&gt;control_state-&gt;control.package_end
suffix:semicolon
multiline_comment|/* Return status depending on opcode */
r_if
c_cond
(paren
id|op-&gt;opcode
op_eq
id|AML_BREAK_OP
)paren
(brace
id|status
op_assign
id|AE_CTRL_BREAK
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|AE_CTRL_CONTINUE
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unknown control opcode=%X Op=%p&bslash;n&quot;
comma
id|op-&gt;opcode
comma
id|op
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_AML_BAD_OPCODE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
eof
