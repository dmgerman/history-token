multiline_comment|/******************************************************************************&n; *&n; * Module Name: evrgnini- ACPI Address_space (Op_region) init&n; *              $Revision: 62 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000 - 2002, R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acevents.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          ACPI_EVENTS
id|ACPI_MODULE_NAME
(paren
l_string|&quot;evrgnini&quot;
)paren
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_system_memory_region_setup&n; *&n; * PARAMETERS:  Region_obj          - Region we are interested in&n; *              Function            - Start or stop&n; *              Handler_context     - Address space handler context&n; *              Region_context      - Region specific context&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling, a nop for now&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ev_system_memory_region_setup
id|acpi_ev_system_memory_region_setup
(paren
id|acpi_handle
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|region_context
)paren
(brace
id|acpi_operand_object
op_star
id|region_desc
op_assign
(paren
id|acpi_operand_object
op_star
)paren
id|handle
suffix:semicolon
id|acpi_mem_space_context
op_star
id|local_region_context
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ev_system_memory_region_setup&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
r_if
c_cond
(paren
op_star
id|region_context
)paren
(brace
id|ACPI_MEM_FREE
(paren
op_star
id|region_context
)paren
suffix:semicolon
op_star
id|region_context
op_assign
l_int|NULL
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Create a new context */
id|local_region_context
op_assign
id|ACPI_MEM_CALLOCATE
(paren
r_sizeof
(paren
id|acpi_mem_space_context
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|local_region_context
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/* Save the region length and address for use in the handler */
id|local_region_context-&gt;length
op_assign
id|region_desc-&gt;region.length
suffix:semicolon
id|local_region_context-&gt;address
op_assign
id|region_desc-&gt;region.address
suffix:semicolon
op_star
id|region_context
op_assign
id|local_region_context
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_io_space_region_setup&n; *&n; * PARAMETERS:  Region_obj          - Region we are interested in&n; *              Function            - Start or stop&n; *              Handler_context     - Address space handler context&n; *              Region_context      - Region specific context&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ev_io_space_region_setup
id|acpi_ev_io_space_region_setup
(paren
id|acpi_handle
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|region_context
)paren
(brace
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ev_io_space_region_setup&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
op_star
id|region_context
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
op_star
id|region_context
op_assign
id|handler_context
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_pci_config_region_setup&n; *&n; * PARAMETERS:  Region_obj          - Region we are interested in&n; *              Function            - Start or stop&n; *              Handler_context     - Address space handler context&n; *              Region_context      - Region specific context&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling&n; *&n; * MUTEX:       Assumes namespace is not locked&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ev_pci_config_region_setup
id|acpi_ev_pci_config_region_setup
(paren
id|acpi_handle
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|region_context
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_integer
id|temp
suffix:semicolon
id|acpi_pci_id
op_star
id|pci_id
op_assign
op_star
id|region_context
suffix:semicolon
id|acpi_operand_object
op_star
id|handler_obj
suffix:semicolon
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_operand_object
op_star
id|region_obj
op_assign
(paren
id|acpi_operand_object
op_star
)paren
id|handle
suffix:semicolon
id|acpi_device_id
id|object_hID
suffix:semicolon
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ev_pci_config_region_setup&quot;
)paren
suffix:semicolon
id|handler_obj
op_assign
id|region_obj-&gt;region.addr_handler
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|handler_obj
)paren
(brace
multiline_comment|/*&n;&t;&t; * No installed handler. This shouldn&squot;t happen because the dispatch&n;&t;&t; * routine checks before we get here, but we check again just in case.&n;&t;&t; */
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_OPREGION
comma
l_string|&quot;Attempting to init a region %p, with no handler&bslash;n&quot;
comma
id|region_obj
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
r_if
c_cond
(paren
id|pci_id
)paren
(brace
id|ACPI_MEM_FREE
(paren
id|pci_id
)paren
suffix:semicolon
op_star
id|region_context
op_assign
l_int|NULL
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Create a new context */
id|pci_id
op_assign
id|ACPI_MEM_CALLOCATE
(paren
r_sizeof
(paren
id|acpi_pci_id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_id
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * For PCI Config space access, we have to pass the segment, bus,&n;&t; * device and function numbers.  This routine must acquire those.&n;&t; */
multiline_comment|/*&n;&t; * First get device and function numbers from the _ADR object&n;&t; * in the parent&squot;s scope.&n;&t; */
id|node
op_assign
id|acpi_ns_get_parent_node
(paren
id|region_obj-&gt;region.node
)paren
suffix:semicolon
multiline_comment|/* Evaluate the _ADR object */
id|status
op_assign
id|acpi_ut_evaluate_numeric_object
(paren
id|METHOD_NAME__ADR
comma
id|node
comma
op_amp
id|temp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The default is zero, and since the allocation above zeroed&n;&t; * the data, just do nothing on failure.&n;&t; */
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
id|pci_id-&gt;device
op_assign
id|ACPI_HIWORD
(paren
id|ACPI_LODWORD
(paren
id|temp
)paren
)paren
suffix:semicolon
id|pci_id-&gt;function
op_assign
id|ACPI_LOWORD
(paren
id|ACPI_LODWORD
(paren
id|temp
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get the _SEG and _BBN values from the device upon which the handler&n;&t; * is installed.&n;&t; *&n;&t; * We need to get the _SEG and _BBN objects relative to the PCI BUS device.&n;&t; * This is the device the handler has been registered to handle.&n;&t; */
multiline_comment|/*&n;&t; * If the Addr_handler.Node is still pointing to the root, we need&n;&t; * to scan upward for a PCI Root bridge and re-associate the Op_region&n;&t; * handlers with that device.&n;&t; */
r_if
c_cond
(paren
id|handler_obj-&gt;addr_handler.node
op_eq
id|acpi_gbl_root_node
)paren
(brace
multiline_comment|/*&n;&t;&t; * Node is currently the parent object&n;&t;&t; */
r_while
c_loop
(paren
id|node
op_ne
id|acpi_gbl_root_node
)paren
(brace
id|status
op_assign
id|acpi_ut_execute_HID
(paren
id|node
comma
op_amp
id|object_hID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
multiline_comment|/* Got a valid _HID, check if this is a PCI root */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ACPI_STRNCMP
(paren
id|object_hID.buffer
comma
id|PCI_ROOT_HID_STRING
comma
r_sizeof
(paren
id|PCI_ROOT_HID_STRING
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* Install a handler for this PCI root bridge */
id|status
op_assign
id|acpi_install_address_space_handler
(paren
(paren
id|acpi_handle
)paren
id|node
comma
id|ACPI_ADR_SPACE_PCI_CONFIG
comma
id|ACPI_DEFAULT_HANDLER
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_REPORT_ERROR
(paren
(paren
l_string|&quot;Could not install Pci_config handler for %4.4s, %s&bslash;n&quot;
comma
id|node-&gt;name.ascii
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|node
op_assign
id|acpi_ns_get_parent_node
(paren
id|node
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|node
op_assign
id|handler_obj-&gt;addr_handler.node
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The PCI segment number comes from the _SEG method&n;&t; */
id|status
op_assign
id|acpi_ut_evaluate_numeric_object
(paren
id|METHOD_NAME__SEG
comma
id|node
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
id|pci_id-&gt;segment
op_assign
id|ACPI_LOWORD
(paren
id|temp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The PCI bus number comes from the _BBN method&n;&t; */
id|status
op_assign
id|acpi_ut_evaluate_numeric_object
(paren
id|METHOD_NAME__BBN
comma
id|node
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
id|pci_id-&gt;bus
op_assign
id|ACPI_LOWORD
(paren
id|temp
)paren
suffix:semicolon
)brace
op_star
id|region_context
op_assign
id|pci_id
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_pci_bar_region_setup&n; *&n; * PARAMETERS:  Region_obj          - Region we are interested in&n; *              Function            - Start or stop&n; *              Handler_context     - Address space handler context&n; *              Region_context      - Region specific context&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling&n; *&n; * MUTEX:       Assumes namespace is not locked&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ev_pci_bar_region_setup
id|acpi_ev_pci_bar_region_setup
(paren
id|acpi_handle
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|region_context
)paren
(brace
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ev_pci_bar_region_setup&quot;
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_cmos_region_setup&n; *&n; * PARAMETERS:  Region_obj          - Region we are interested in&n; *              Function            - Start or stop&n; *              Handler_context     - Address space handler context&n; *              Region_context      - Region specific context&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling&n; *&n; * MUTEX:       Assumes namespace is not locked&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ev_cmos_region_setup
id|acpi_ev_cmos_region_setup
(paren
id|acpi_handle
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|region_context
)paren
(brace
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ev_cmos_region_setup&quot;
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_default_region_setup&n; *&n; * PARAMETERS:  Region_obj          - Region we are interested in&n; *              Function            - Start or stop&n; *              Handler_context     - Address space handler context&n; *              Region_context      - Region specific context&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Do any prep work for region handling&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ev_default_region_setup
id|acpi_ev_default_region_setup
(paren
id|acpi_handle
id|handle
comma
id|u32
id|function
comma
r_void
op_star
id|handler_context
comma
r_void
op_star
op_star
id|region_context
)paren
(brace
id|ACPI_FUNCTION_TRACE
(paren
l_string|&quot;Ev_default_region_setup&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|function
op_eq
id|ACPI_REGION_DEACTIVATE
)paren
(brace
op_star
id|region_context
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
op_star
id|region_context
op_assign
id|handler_context
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ev_initialize_region&n; *&n; * PARAMETERS:  Region_obj      - Region we are initializing&n; *              Acpi_ns_locked  - Is namespace locked?&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Initializes the region, finds any _REG methods and saves them&n; *              for execution at a later time&n; *&n; *              Get the appropriate address space handler for a newly&n; *              created region.&n; *&n; *              This also performs address space specific intialization.  For&n; *              example, PCI regions must have an _ADR object that contains&n; *              a PCI address in the scope of the definition.  This address is&n; *              required to perform an access to PCI config space.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ev_initialize_region
id|acpi_ev_initialize_region
(paren
id|acpi_operand_object
op_star
id|region_obj
comma
id|u8
id|acpi_ns_locked
)paren
(brace
id|acpi_operand_object
op_star
id|handler_obj
suffix:semicolon
id|acpi_operand_object
op_star
id|obj_desc
suffix:semicolon
id|ACPI_ADR_SPACE_TYPE
id|space_id
suffix:semicolon
id|acpi_namespace_node
op_star
id|node
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|acpi_namespace_node
op_star
id|method_node
suffix:semicolon
id|acpi_name
op_star
id|reg_name_ptr
op_assign
(paren
id|acpi_name
op_star
)paren
id|METHOD_NAME__REG
suffix:semicolon
id|acpi_operand_object
op_star
id|region_obj2
suffix:semicolon
id|ACPI_FUNCTION_TRACE_U32
(paren
l_string|&quot;Ev_initialize_region&quot;
comma
id|acpi_ns_locked
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_obj
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|region_obj-&gt;common.flags
op_amp
id|AOPOBJ_OBJECT_INITIALIZED
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|region_obj2
op_assign
id|acpi_ns_get_secondary_object
(paren
id|region_obj
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|region_obj2
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
id|node
op_assign
id|acpi_ns_get_parent_node
(paren
id|region_obj-&gt;region.node
)paren
suffix:semicolon
id|space_id
op_assign
id|region_obj-&gt;region.space_id
suffix:semicolon
id|region_obj-&gt;region.addr_handler
op_assign
l_int|NULL
suffix:semicolon
id|region_obj2-&gt;extra.method_REG
op_assign
l_int|NULL
suffix:semicolon
id|region_obj-&gt;common.flags
op_and_assign
op_complement
(paren
id|AOPOBJ_SETUP_COMPLETE
)paren
suffix:semicolon
id|region_obj-&gt;common.flags
op_or_assign
id|AOPOBJ_OBJECT_INITIALIZED
suffix:semicolon
multiline_comment|/*&n;&t; * Find any &quot;_REG&quot; method associated with this region definition&n;&t; */
id|status
op_assign
id|acpi_ns_search_node
(paren
op_star
id|reg_name_ptr
comma
id|node
comma
id|ACPI_TYPE_METHOD
comma
op_amp
id|method_node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * The _REG method is optional and there can be only one per region&n;&t;&t; * definition.  This will be executed when the handler is attached&n;&t;&t; * or removed&n;&t;&t; */
id|region_obj2-&gt;extra.method_REG
op_assign
id|method_node
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The following loop depends upon the root Node having no parent&n;&t; * ie: Acpi_gbl_Root_node-&gt;Parent_entry being set to NULL&n;&t; */
r_while
c_loop
(paren
id|node
)paren
(brace
multiline_comment|/*&n;&t;&t; * Check to see if a handler exists&n;&t;&t; */
id|handler_obj
op_assign
l_int|NULL
suffix:semicolon
id|obj_desc
op_assign
id|acpi_ns_get_attached_object
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Can only be a handler if the object exists&n;&t;&t;&t; */
r_switch
c_cond
(paren
id|node-&gt;type
)paren
(brace
r_case
id|ACPI_TYPE_DEVICE
suffix:colon
id|handler_obj
op_assign
id|obj_desc-&gt;device.addr_handler
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PROCESSOR
suffix:colon
id|handler_obj
op_assign
id|obj_desc-&gt;processor.addr_handler
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_THERMAL
suffix:colon
id|handler_obj
op_assign
id|obj_desc-&gt;thermal_zone.addr_handler
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Ignore other objects */
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|handler_obj
)paren
(brace
multiline_comment|/* Is this handler of the correct type? */
r_if
c_cond
(paren
id|handler_obj-&gt;addr_handler.space_id
op_eq
id|space_id
)paren
(brace
multiline_comment|/* Found correct handler */
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_OPREGION
comma
l_string|&quot;Found handler %p for region %p in obj %p&bslash;n&quot;
comma
id|handler_obj
comma
id|region_obj
comma
id|obj_desc
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_ev_attach_region
(paren
id|handler_obj
comma
id|region_obj
comma
id|acpi_ns_locked
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/* Try next handler in the list */
id|handler_obj
op_assign
id|handler_obj-&gt;addr_handler.next
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * This node does not have the handler we need;&n;&t;&t; * Pop up one level&n;&t;&t; */
id|node
op_assign
id|acpi_ns_get_parent_node
(paren
id|node
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If we get here, there is no handler for this region&n;&t; */
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_OPREGION
comma
l_string|&quot;No handler for Region_type %s(%X) (Region_obj %p)&bslash;n&quot;
comma
id|acpi_ut_get_region_name
(paren
id|space_id
)paren
comma
id|space_id
comma
id|region_obj
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_NOT_EXIST
)paren
suffix:semicolon
)brace
eof
