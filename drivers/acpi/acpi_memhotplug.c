multiline_comment|/*&n; * Copyright (C) 2004 Intel Corporation &lt;naveen.b.s@intel.com&gt;&n; *&n; * All rights reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or (at&n; * your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; * NON INFRINGEMENT.  See the GNU General Public License for more&n; * details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *&n; * ACPI based HotPlug driver that supports Memory Hotplug&n; * This driver fields notifications from firmare for memory add&n; * and remove operations and alerts the VM of the affected memory&n; * ranges.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/memory_hotplug.h&gt;
macro_line|#include &lt;acpi/acpi_drivers.h&gt;
DECL|macro|ACPI_MEMORY_DEVICE_COMPONENT
mdefine_line|#define ACPI_MEMORY_DEVICE_COMPONENT&t;&t;0x08000000UL
DECL|macro|ACPI_MEMORY_DEVICE_CLASS
mdefine_line|#define ACPI_MEMORY_DEVICE_CLASS&t;&t;&quot;memory&quot;
DECL|macro|ACPI_MEMORY_DEVICE_HID
mdefine_line|#define ACPI_MEMORY_DEVICE_HID&t;&t;&t;&quot;PNP0C80&quot;
DECL|macro|ACPI_MEMORY_DEVICE_DRIVER_NAME
mdefine_line|#define ACPI_MEMORY_DEVICE_DRIVER_NAME&t;&t;&quot;Hotplug Mem Driver&quot;
DECL|macro|ACPI_MEMORY_DEVICE_NAME
mdefine_line|#define ACPI_MEMORY_DEVICE_NAME&t;&t;&t;&quot;Hotplug Mem Device&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_MEMORY_DEVICE_COMPONENT
id|ACPI_MODULE_NAME
(paren
l_string|&quot;acpi_memory&quot;
)paren
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Naveen B S &lt;naveen.b.s@intel.com&gt;&quot;
)paren
suffix:semicolon
DECL|variable|ACPI_MEMORY_DEVICE_DRIVER_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|ACPI_MEMORY_DEVICE_DRIVER_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* ACPI _STA method values */
DECL|macro|ACPI_MEMORY_STA_PRESENT
mdefine_line|#define ACPI_MEMORY_STA_PRESENT&t;&t;(0x00000001UL)
DECL|macro|ACPI_MEMORY_STA_ENABLED
mdefine_line|#define ACPI_MEMORY_STA_ENABLED&t;&t;(0x00000002UL)
DECL|macro|ACPI_MEMORY_STA_FUNCTIONAL
mdefine_line|#define ACPI_MEMORY_STA_FUNCTIONAL&t;(0x00000008UL)
multiline_comment|/* Memory Device States */
DECL|macro|MEMORY_INVALID_STATE
mdefine_line|#define MEMORY_INVALID_STATE&t;0
DECL|macro|MEMORY_POWER_ON_STATE
mdefine_line|#define MEMORY_POWER_ON_STATE&t;1
DECL|macro|MEMORY_POWER_OFF_STATE
mdefine_line|#define MEMORY_POWER_OFF_STATE&t;2
r_static
r_int
id|acpi_memory_device_add
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
suffix:semicolon
r_static
r_int
id|acpi_memory_device_remove
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
suffix:semicolon
DECL|variable|acpi_memory_device_driver
r_static
r_struct
id|acpi_driver
id|acpi_memory_device_driver
op_assign
(brace
dot
id|name
op_assign
id|ACPI_MEMORY_DEVICE_DRIVER_NAME
comma
dot
r_class
op_assign
id|ACPI_MEMORY_DEVICE_CLASS
comma
dot
id|ids
op_assign
id|ACPI_MEMORY_DEVICE_HID
comma
dot
id|ops
op_assign
(brace
dot
id|add
op_assign
id|acpi_memory_device_add
comma
dot
id|remove
op_assign
id|acpi_memory_device_remove
comma
)brace
comma
)brace
suffix:semicolon
DECL|struct|acpi_memory_device
r_struct
id|acpi_memory_device
(brace
DECL|member|handle
id|acpi_handle
id|handle
suffix:semicolon
DECL|member|state
r_int
r_int
id|state
suffix:semicolon
multiline_comment|/* State of the memory device */
DECL|member|cache_attribute
r_int
r_int
id|cache_attribute
suffix:semicolon
multiline_comment|/* memory cache attribute */
DECL|member|read_write_attribute
r_int
r_int
id|read_write_attribute
suffix:semicolon
multiline_comment|/* memory read/write attribute */
DECL|member|start_addr
id|u64
id|start_addr
suffix:semicolon
multiline_comment|/* Memory Range start physical addr */
DECL|member|end_addr
id|u64
id|end_addr
suffix:semicolon
multiline_comment|/* Memory Range end physical addr */
)brace
suffix:semicolon
r_static
r_int
DECL|function|acpi_memory_get_device_resources
id|acpi_memory_get_device_resources
c_func
(paren
r_struct
id|acpi_memory_device
op_star
id|mem_device
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
id|ACPI_ALLOCATE_BUFFER
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|acpi_resource
op_star
id|resource
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_resource_address64
id|address64
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_get_device_resources&quot;
)paren
suffix:semicolon
multiline_comment|/* Get the range from the _CRS */
id|status
op_assign
id|acpi_get_current_resources
c_func
(paren
id|mem_device-&gt;handle
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|resource
op_assign
(paren
r_struct
id|acpi_resource
op_star
)paren
id|buffer.pointer
suffix:semicolon
id|status
op_assign
id|acpi_resource_to_address64
c_func
(paren
id|resource
comma
op_amp
id|address64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
r_if
c_cond
(paren
id|address64.resource_type
op_eq
id|ACPI_MEMORY_RANGE
)paren
(brace
multiline_comment|/* Populate the structure */
id|mem_device-&gt;cache_attribute
op_assign
id|address64.attribute.memory.cache_attribute
suffix:semicolon
id|mem_device-&gt;read_write_attribute
op_assign
id|address64.attribute.memory.read_write_attribute
suffix:semicolon
id|mem_device-&gt;start_addr
op_assign
id|address64.min_address_range
suffix:semicolon
id|mem_device-&gt;end_addr
op_assign
id|address64.max_address_range
suffix:semicolon
)brace
)brace
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_memory_get_device
id|acpi_memory_get_device
c_func
(paren
id|acpi_handle
id|handle
comma
r_struct
id|acpi_memory_device
op_star
op_star
id|mem_device
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|acpi_handle
id|phandle
suffix:semicolon
r_struct
id|acpi_device
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_device
op_star
id|pdevice
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_get_device&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_bus_get_device
c_func
(paren
id|handle
comma
op_amp
id|device
)paren
op_logical_and
id|device
)paren
r_goto
id|end
suffix:semicolon
id|status
op_assign
id|acpi_get_parent
c_func
(paren
id|handle
comma
op_amp
id|phandle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error in acpi_get_parent&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the parent device */
id|status
op_assign
id|acpi_bus_get_device
c_func
(paren
id|phandle
comma
op_amp
id|pdevice
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error in acpi_bus_get_device&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now add the notified device.  This creates the acpi_device&n;&t; * and invokes .add function&n;&t; */
id|status
op_assign
id|acpi_bus_add
c_func
(paren
op_amp
id|device
comma
id|pdevice
comma
id|handle
comma
id|ACPI_BUS_TYPE_DEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error in acpi_bus_add&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|end
suffix:colon
op_star
id|mem_device
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|mem_device
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;&bslash;n driver data not found&quot;
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_memory_check_device
id|acpi_memory_check_device
c_func
(paren
r_struct
id|acpi_memory_device
op_star
id|mem_device
)paren
(brace
r_int
r_int
id|current_status
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_check_device&quot;
)paren
suffix:semicolon
multiline_comment|/* Get device present/absent information from the _STA */
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|acpi_evaluate_integer
c_func
(paren
id|mem_device-&gt;handle
comma
l_string|&quot;_STA&quot;
comma
l_int|NULL
comma
op_amp
id|current_status
)paren
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check for device status. Device should be&n;&t; * present/enabled/functioning.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|current_status
op_amp
id|ACPI_MEMORY_STA_PRESENT
)paren
op_logical_and
(paren
id|current_status
op_amp
id|ACPI_MEMORY_STA_ENABLED
)paren
op_logical_and
(paren
id|current_status
op_amp
id|ACPI_MEMORY_STA_FUNCTIONAL
)paren
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_memory_enable_device
id|acpi_memory_enable_device
c_func
(paren
r_struct
id|acpi_memory_device
op_star
id|mem_device
)paren
(brace
r_int
id|result
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_enable_device&quot;
)paren
suffix:semicolon
multiline_comment|/* Get the range from the _CRS */
id|result
op_assign
id|acpi_memory_get_device_resources
c_func
(paren
id|mem_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;&bslash;nget_device_resources failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mem_device-&gt;state
op_assign
id|MEMORY_INVALID_STATE
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Tell the VM there is more memory here...&n;&t; * Note: Assume that this function returns zero on success&n;&t; */
id|result
op_assign
id|add_memory
c_func
(paren
id|mem_device-&gt;start_addr
comma
(paren
id|mem_device-&gt;end_addr
op_minus
id|mem_device-&gt;start_addr
)paren
op_plus
l_int|1
comma
id|mem_device-&gt;read_write_attribute
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;&bslash;nadd_memory failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mem_device-&gt;state
op_assign
id|MEMORY_INVALID_STATE
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_memory_powerdown_device
id|acpi_memory_powerdown_device
c_func
(paren
r_struct
id|acpi_memory_device
op_star
id|mem_device
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_object_list
id|arg_list
suffix:semicolon
r_union
id|acpi_object
id|arg
suffix:semicolon
r_int
r_int
id|current_status
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_powerdown_device&quot;
)paren
suffix:semicolon
multiline_comment|/* Issue the _EJ0 command */
id|arg_list.count
op_assign
l_int|1
suffix:semicolon
id|arg_list.pointer
op_assign
op_amp
id|arg
suffix:semicolon
id|arg.type
op_assign
id|ACPI_TYPE_INTEGER
suffix:semicolon
id|arg.integer.value
op_assign
l_int|1
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|mem_device-&gt;handle
comma
l_string|&quot;_EJ0&quot;
comma
op_amp
id|arg_list
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Return on _EJ0 failure */
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;_EJ0 failed.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
multiline_comment|/* Evalute _STA to check if the device is disabled */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|mem_device-&gt;handle
comma
l_string|&quot;_STA&quot;
comma
l_int|NULL
comma
op_amp
id|current_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
multiline_comment|/* Check for device status.  Device should be disabled */
r_if
c_cond
(paren
id|current_status
op_amp
id|ACPI_MEMORY_STA_ENABLED
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_memory_disable_device
id|acpi_memory_disable_device
c_func
(paren
r_struct
id|acpi_memory_device
op_star
id|mem_device
)paren
(brace
r_int
id|result
suffix:semicolon
id|u64
id|start
op_assign
id|mem_device-&gt;start_addr
suffix:semicolon
id|u64
id|len
op_assign
id|mem_device-&gt;end_addr
op_minus
id|start
op_plus
l_int|1
suffix:semicolon
r_int
r_int
id|attr
op_assign
id|mem_device-&gt;read_write_attribute
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_disable_device&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ask the VM to offline this memory range.&n;&t; * Note: Assume that this function returns zero on success&n;&t; */
id|result
op_assign
id|remove_memory
c_func
(paren
id|start
comma
id|len
comma
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Hot-Remove failed.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* Power-off and eject the device */
id|result
op_assign
id|acpi_memory_powerdown_device
c_func
(paren
id|mem_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Device Power Down failed.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Set the status of the device to invalid */
id|mem_device-&gt;state
op_assign
id|MEMORY_INVALID_STATE
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|mem_device-&gt;state
op_assign
id|MEMORY_POWER_OFF_STATE
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_void
DECL|function|acpi_memory_device_notify
id|acpi_memory_device_notify
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|event
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|acpi_memory_device
op_star
id|mem_device
suffix:semicolon
r_struct
id|acpi_device
op_star
id|device
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_device_notify&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|ACPI_NOTIFY_BUS_CHECK
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;&bslash;nReceived BUS CHECK notification for device&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Fall Through */
r_case
id|ACPI_NOTIFY_DEVICE_CHECK
suffix:colon
r_if
c_cond
(paren
id|event
op_eq
id|ACPI_NOTIFY_DEVICE_CHECK
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;&bslash;nReceived DEVICE CHECK notification for device&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_memory_get_device
c_func
(paren
id|handle
comma
op_amp
id|mem_device
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error in finding driver data&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acpi_memory_check_device
c_func
(paren
id|mem_device
)paren
)paren
(brace
r_if
c_cond
(paren
id|acpi_memory_enable_device
c_func
(paren
id|mem_device
)paren
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error in acpi_memory_enable_device&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_EJECT_REQUEST
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;&bslash;nReceived EJECT REQUEST notification for device&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_bus_get_device
c_func
(paren
id|handle
comma
op_amp
id|device
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Device doesn&squot;t exist&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mem_device
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_device
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Driver Data is NULL&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Currently disabling memory device from kernel mode&n;&t;&t; * TBD: Can also be disabled from user mode scripts&n;&t;&t; * TBD: Can also be disabled by Callback registration&n;&t;&t; * &t;with generic sysfs driver&n;&t;&t; */
r_if
c_cond
(paren
id|acpi_memory_disable_device
c_func
(paren
id|mem_device
)paren
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error in acpi_memory_disable_device&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * TBD: Invoke acpi_bus_remove to cleanup data structures&n;&t;&t; */
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Unsupported event [0x%x]&bslash;n&quot;
comma
id|event
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|return_VOID
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_memory_device_add
id|acpi_memory_device_add
c_func
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
r_int
id|result
suffix:semicolon
r_struct
id|acpi_memory_device
op_star
id|mem_device
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_device_add&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|mem_device
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpi_memory_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mem_device
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mem_device
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_memory_device
)paren
)paren
suffix:semicolon
id|mem_device-&gt;handle
op_assign
id|device-&gt;handle
suffix:semicolon
id|sprintf
c_func
(paren
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
l_string|&quot;%s&quot;
comma
id|ACPI_MEMORY_DEVICE_NAME
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|acpi_device_class
c_func
(paren
id|device
)paren
comma
l_string|&quot;%s&quot;
comma
id|ACPI_MEMORY_DEVICE_CLASS
)paren
suffix:semicolon
id|acpi_driver_data
c_func
(paren
id|device
)paren
op_assign
id|mem_device
suffix:semicolon
multiline_comment|/* Get the range from the _CRS */
id|result
op_assign
id|acpi_memory_get_device_resources
c_func
(paren
id|mem_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|kfree
c_func
(paren
id|mem_device
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the device state */
id|mem_device-&gt;state
op_assign
id|MEMORY_POWER_ON_STATE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s &bslash;n&quot;
comma
id|acpi_device_name
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_memory_device_remove
id|acpi_memory_device_remove
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
(brace
r_struct
id|acpi_memory_device
op_star
id|mem_device
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_device_remove&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
op_logical_or
op_logical_neg
id|acpi_driver_data
c_func
(paren
id|device
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|mem_device
op_assign
(paren
r_struct
id|acpi_memory_device
op_star
)paren
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mem_device
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Helper function to check for memory device&n; */
r_static
id|acpi_status
DECL|function|is_memory_device
id|is_memory_device
c_func
(paren
id|acpi_handle
id|handle
)paren
(brace
r_char
op_star
id|hardware_id
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
id|ACPI_ALLOCATE_BUFFER
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|acpi_device_info
op_star
id|info
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;is_memory_device&quot;
)paren
suffix:semicolon
id|status
op_assign
id|acpi_get_object_info
c_func
(paren
id|handle
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_ACPI_STATUS
c_func
(paren
id|AE_ERROR
)paren
suffix:semicolon
id|info
op_assign
id|buffer.pointer
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;valid
op_amp
id|ACPI_VALID_HID
)paren
)paren
(brace
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_ERROR
)paren
suffix:semicolon
)brace
id|hardware_id
op_assign
id|info-&gt;hardware_id.value
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hardware_id
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|strcmp
c_func
(paren
id|hardware_id
comma
id|ACPI_MEMORY_DEVICE_HID
)paren
)paren
)paren
id|status
op_assign
id|AE_ERROR
suffix:semicolon
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_static
id|acpi_status
DECL|function|acpi_memory_register_notify_handler
id|acpi_memory_register_notify_handler
(paren
id|acpi_handle
id|handle
comma
id|u32
id|level
comma
r_void
op_star
id|ctxt
comma
r_void
op_star
op_star
id|retv
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_register_notify_handler&quot;
)paren
suffix:semicolon
id|status
op_assign
id|is_memory_device
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
multiline_comment|/* continue */
id|status
op_assign
id|acpi_install_notify_handler
c_func
(paren
id|handle
comma
id|ACPI_SYSTEM_NOTIFY
comma
id|acpi_memory_device_notify
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error installing notify handler&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
multiline_comment|/* continue */
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_static
id|acpi_status
DECL|function|acpi_memory_deregister_notify_handler
id|acpi_memory_deregister_notify_handler
(paren
id|acpi_handle
id|handle
comma
id|u32
id|level
comma
r_void
op_star
id|ctxt
comma
r_void
op_star
op_star
id|retv
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_deregister_notify_handler&quot;
)paren
suffix:semicolon
id|status
op_assign
id|is_memory_device
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
multiline_comment|/* continue */
id|status
op_assign
id|acpi_remove_notify_handler
c_func
(paren
id|handle
comma
id|ACPI_SYSTEM_NOTIFY
comma
id|acpi_memory_device_notify
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error removing notify handler&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
multiline_comment|/* continue */
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_memory_device_init
id|acpi_memory_device_init
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_device_init&quot;
)paren
suffix:semicolon
id|result
op_assign
id|acpi_bus_register_driver
c_func
(paren
op_amp
id|acpi_memory_device_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|status
op_assign
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_DEVICE
comma
id|ACPI_ROOT_OBJECT
comma
id|ACPI_UINT32_MAX
comma
id|acpi_memory_register_notify_handler
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;walk_namespace failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|acpi_bus_unregister_driver
c_func
(paren
op_amp
id|acpi_memory_device_driver
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|acpi_memory_device_exit
id|acpi_memory_device_exit
(paren
r_void
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_memory_device_exit&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Adding this to un-install notification handlers for all the device&n;&t; * handles.&n;&t; */
id|status
op_assign
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_DEVICE
comma
id|ACPI_ROOT_OBJECT
comma
id|ACPI_UINT32_MAX
comma
id|acpi_memory_deregister_notify_handler
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;walk_namespace failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|acpi_bus_unregister_driver
c_func
(paren
op_amp
id|acpi_memory_device_driver
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
DECL|variable|acpi_memory_device_init
id|module_init
c_func
(paren
id|acpi_memory_device_init
)paren
suffix:semicolon
DECL|variable|acpi_memory_device_exit
id|module_exit
c_func
(paren
id|acpi_memory_device_exit
)paren
suffix:semicolon
eof
