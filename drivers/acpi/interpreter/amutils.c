multiline_comment|/******************************************************************************&n; *&n; * Module Name: amutils - interpreter/scanner utilities&n; *              $Revision: 69 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000, 2001 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acparser.h&quot;
macro_line|#include &quot;acinterp.h&quot;
macro_line|#include &quot;amlcode.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
macro_line|#include &quot;acevents.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          INTERPRETER
id|MODULE_NAME
(paren
l_string|&quot;amutils&quot;
)paren
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_enter_interpreter&n; *&n; * PARAMETERS:  None&n; *&n; * DESCRIPTION: Enter the interpreter execution region&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_aml_enter_interpreter
id|acpi_aml_enter_interpreter
(paren
r_void
)paren
(brace
id|acpi_cm_acquire_mutex
(paren
id|ACPI_MTX_EXECUTE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_exit_interpreter&n; *&n; * PARAMETERS:  None&n; *&n; * DESCRIPTION: Exit the interpreter execution region&n; *&n; * Cases where the interpreter is unlocked:&n; *      1) Completion of the execution of a control method&n; *      2) Method blocked on a Sleep() AML opcode&n; *      3) Method blocked on an Acquire() AML opcode&n; *      4) Method blocked on a Wait() AML opcode&n; *      5) Method blocked to acquire the global lock&n; *      6) Method blocked to execute a serialized control method that is&n; *          already executing&n; *      7) About to invoke a user-installed opregion handler&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_aml_exit_interpreter
id|acpi_aml_exit_interpreter
(paren
r_void
)paren
(brace
id|acpi_cm_release_mutex
(paren
id|ACPI_MTX_EXECUTE
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_validate_object_type&n; *&n; * PARAMETERS:  Type            Object type to validate&n; *&n; * DESCRIPTION: Determine if a type is a valid ACPI object type&n; *&n; ******************************************************************************/
id|u8
DECL|function|acpi_aml_validate_object_type
id|acpi_aml_validate_object_type
(paren
id|ACPI_OBJECT_TYPE
id|type
)paren
(brace
r_if
c_cond
(paren
(paren
id|type
OG
id|ACPI_TYPE_MAX
op_logical_and
id|type
OL
id|INTERNAL_TYPE_BEGIN
)paren
op_logical_or
(paren
id|type
OG
id|INTERNAL_TYPE_MAX
)paren
)paren
(brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_truncate_for32bit_table&n; *&n; * PARAMETERS:  Obj_desc        - Object to be truncated&n; *              Walk_state      - Current walk state&n; *                                (A method must be executing)&n; *&n; * RETURN:      none&n; *&n; * DESCRIPTION: Truncate a number to 32-bits if the currently executing method&n; *              belongs to a 32-bit ACPI table.&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_aml_truncate_for32bit_table
id|acpi_aml_truncate_for32bit_table
(paren
id|ACPI_OPERAND_OBJECT
op_star
id|obj_desc
comma
id|ACPI_WALK_STATE
op_star
id|walk_state
)paren
(brace
multiline_comment|/*&n;&t; * Object must be a valid number and we must be executing&n;&t; * a control method&n;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|obj_desc
)paren
op_logical_or
(paren
id|obj_desc-&gt;common.type
op_ne
id|ACPI_TYPE_INTEGER
)paren
op_logical_or
(paren
op_logical_neg
id|walk_state-&gt;method_node
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|walk_state-&gt;method_node-&gt;flags
op_amp
id|ANOBJ_DATA_WIDTH_32
)paren
(brace
multiline_comment|/*&n;&t;&t; * We are running a method that exists in a 32-bit ACPI table.&n;&t;&t; * Truncate the value to 32 bits by zeroing out the upper 32-bit field&n;&t;&t; */
id|obj_desc-&gt;integer.value
op_and_assign
(paren
id|ACPI_INTEGER
)paren
id|ACPI_UINT32_MAX
suffix:semicolon
)brace
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_acquire_global_lock&n; *&n; * PARAMETERS:  Rule            - Lock rule: Always_lock, Never_lock&n; *&n; * RETURN:      TRUE/FALSE indicating whether the lock was actually acquired&n; *&n; * DESCRIPTION: Obtain the global lock and keep track of this fact via two&n; *              methods.  A global variable keeps the state of the lock, and&n; *              the state is returned to the caller.&n; *&n; ******************************************************************************/
id|u8
DECL|function|acpi_aml_acquire_global_lock
id|acpi_aml_acquire_global_lock
(paren
id|u32
id|rule
)paren
(brace
id|u8
id|locked
op_assign
id|FALSE
suffix:semicolon
id|ACPI_STATUS
id|status
suffix:semicolon
multiline_comment|/*  Only attempt lock if the Rule says so */
r_if
c_cond
(paren
id|rule
op_eq
(paren
id|u32
)paren
id|GLOCK_ALWAYS_LOCK
)paren
(brace
multiline_comment|/*  OK to get the lock   */
id|status
op_assign
id|acpi_ev_acquire_global_lock
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
id|acpi_gbl_global_lock_set
op_assign
id|TRUE
suffix:semicolon
id|locked
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
r_return
(paren
id|locked
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_release_global_lock&n; *&n; * PARAMETERS:  Locked_by_me    - Return value from corresponding call to&n; *                                Acquire_global_lock.&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Release the global lock if it is locked.&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_aml_release_global_lock
id|acpi_aml_release_global_lock
(paren
id|u8
id|locked_by_me
)paren
(brace
multiline_comment|/* Only attempt unlock if the caller locked it */
r_if
c_cond
(paren
id|locked_by_me
)paren
(brace
multiline_comment|/* Double check against the global flag */
r_if
c_cond
(paren
id|acpi_gbl_global_lock_set
)paren
(brace
multiline_comment|/* OK, now release the lock */
id|acpi_ev_release_global_lock
(paren
)paren
suffix:semicolon
id|acpi_gbl_global_lock_set
op_assign
id|FALSE
suffix:semicolon
)brace
)brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_digits_needed&n; *&n; * PARAMETERS:  val             - Value to be represented&n; *              base            - Base of representation&n; *&n; * RETURN:      the number of digits needed to represent val in base&n; *&n; ******************************************************************************/
id|u32
DECL|function|acpi_aml_digits_needed
id|acpi_aml_digits_needed
(paren
id|ACPI_INTEGER
id|val
comma
id|u32
id|base
)paren
(brace
id|u32
id|num_digits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|base
OL
l_int|1
)paren
(brace
id|REPORT_ERROR
(paren
(paren
l_string|&quot;Aml_digits_needed: Internal error - Invalid base&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|num_digits
op_assign
l_int|1
op_plus
(paren
id|val
OL
l_int|0
)paren
suffix:semicolon
(paren
id|val
op_assign
id|ACPI_DIVIDE
(paren
id|val
comma
id|base
)paren
)paren
suffix:semicolon
op_increment
id|num_digits
)paren
(brace
suffix:semicolon
)brace
)brace
r_return
(paren
id|num_digits
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    ntohl&n; *&n; * PARAMETERS:  Value           - Value to be converted&n; *&n; * DESCRIPTION: Convert a 32-bit value to big-endian (swap the bytes)&n; *&n; ******************************************************************************/
r_static
id|u32
DECL|function|_ntohl
id|_ntohl
(paren
id|u32
id|value
)paren
(brace
r_union
(brace
id|u32
id|value
suffix:semicolon
id|u8
id|bytes
(braket
l_int|4
)braket
suffix:semicolon
)brace
id|out
suffix:semicolon
r_union
(brace
id|u32
id|value
suffix:semicolon
id|u8
id|bytes
(braket
l_int|4
)braket
suffix:semicolon
)brace
id|in
suffix:semicolon
id|in.value
op_assign
id|value
suffix:semicolon
id|out.bytes
(braket
l_int|0
)braket
op_assign
id|in.bytes
(braket
l_int|3
)braket
suffix:semicolon
id|out.bytes
(braket
l_int|1
)braket
op_assign
id|in.bytes
(braket
l_int|2
)braket
suffix:semicolon
id|out.bytes
(braket
l_int|2
)braket
op_assign
id|in.bytes
(braket
l_int|1
)braket
suffix:semicolon
id|out.bytes
(braket
l_int|3
)braket
op_assign
id|in.bytes
(braket
l_int|0
)braket
suffix:semicolon
r_return
(paren
id|out.value
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_eisa_id_to_string&n; *&n; * PARAMETERS:  Numeric_id      - EISA ID to be converted&n; *              Out_string      - Where to put the converted string (8 bytes)&n; *&n; * DESCRIPTION: Convert a numeric EISA ID to string representation&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_aml_eisa_id_to_string
id|acpi_aml_eisa_id_to_string
(paren
id|u32
id|numeric_id
comma
id|NATIVE_CHAR
op_star
id|out_string
)paren
(brace
id|u32
id|id
suffix:semicolon
multiline_comment|/* swap to big-endian to get contiguous bits */
id|id
op_assign
id|_ntohl
(paren
id|numeric_id
)paren
suffix:semicolon
id|out_string
(braket
l_int|0
)braket
op_assign
(paren
r_char
)paren
(paren
l_char|&squot;@&squot;
op_plus
(paren
(paren
id|id
op_rshift
l_int|26
)paren
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
id|out_string
(braket
l_int|1
)braket
op_assign
(paren
r_char
)paren
(paren
l_char|&squot;@&squot;
op_plus
(paren
(paren
id|id
op_rshift
l_int|21
)paren
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
id|out_string
(braket
l_int|2
)braket
op_assign
(paren
r_char
)paren
(paren
l_char|&squot;@&squot;
op_plus
(paren
(paren
id|id
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
)paren
)paren
suffix:semicolon
id|out_string
(braket
l_int|3
)braket
op_assign
id|acpi_gbl_hex_to_ascii
(braket
(paren
id|id
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|out_string
(braket
l_int|4
)braket
op_assign
id|acpi_gbl_hex_to_ascii
(braket
(paren
id|id
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|out_string
(braket
l_int|5
)braket
op_assign
id|acpi_gbl_hex_to_ascii
(braket
(paren
id|id
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
id|out_string
(braket
l_int|6
)braket
op_assign
id|acpi_gbl_hex_to_ascii
(braket
id|id
op_amp
l_int|0xf
)braket
suffix:semicolon
id|out_string
(braket
l_int|7
)braket
op_assign
l_int|0
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_aml_unsigned_integer_to_string&n; *&n; * PARAMETERS:  Value           - Value to be converted&n; *              Out_string      - Where to put the converted string (8 bytes)&n; *&n; * RETURN:      Convert a number to string representation&n; *&n; ******************************************************************************/
id|ACPI_STATUS
DECL|function|acpi_aml_unsigned_integer_to_string
id|acpi_aml_unsigned_integer_to_string
(paren
id|ACPI_INTEGER
id|value
comma
id|NATIVE_CHAR
op_star
id|out_string
)paren
(brace
id|u32
id|count
suffix:semicolon
id|u32
id|digits_needed
suffix:semicolon
id|digits_needed
op_assign
id|acpi_aml_digits_needed
(paren
id|value
comma
l_int|10
)paren
suffix:semicolon
id|out_string
(braket
id|digits_needed
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
id|digits_needed
suffix:semicolon
id|count
OG
l_int|0
suffix:semicolon
id|count
op_decrement
)paren
(brace
id|out_string
(braket
id|count
op_minus
l_int|1
)braket
op_assign
(paren
id|NATIVE_CHAR
)paren
(paren
l_char|&squot;0&squot;
op_plus
(paren
id|ACPI_MODULO
(paren
id|value
comma
l_int|10
)paren
)paren
)paren
suffix:semicolon
id|value
op_assign
id|ACPI_DIVIDE
(paren
id|value
comma
l_int|10
)paren
suffix:semicolon
)brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
eof
