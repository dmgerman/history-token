multiline_comment|/*******************************************************************************&n; *&n; * Module Name: utmisc - common utility procedures&n; *              $Revision: 50 $&n; *&n; ******************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000, 2001 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acevents.h&quot;
macro_line|#include &quot;achware.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
macro_line|#include &quot;acinterp.h&quot;
macro_line|#include &quot;amlcode.h&quot;
macro_line|#include &quot;acdebug.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          ACPI_UTILITIES
id|MODULE_NAME
(paren
l_string|&quot;utmisc&quot;
)paren
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_valid_acpi_name&n; *&n; * PARAMETERS:  Character           - The character to be examined&n; *&n; * RETURN:      1 if Character may appear in a name, else 0&n; *&n; * DESCRIPTION: Check for a valid ACPI name.  Each character must be one of:&n; *              1) Upper case alpha&n; *              2) numeric&n; *              3) underscore&n; *&n; ******************************************************************************/
id|u8
DECL|function|acpi_ut_valid_acpi_name
id|acpi_ut_valid_acpi_name
(paren
id|u32
id|name
)paren
(brace
id|NATIVE_CHAR
op_star
id|name_ptr
op_assign
(paren
id|NATIVE_CHAR
op_star
)paren
op_amp
id|name
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|FUNCTION_ENTRY
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_NAME_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|name_ptr
(braket
id|i
)braket
op_eq
l_char|&squot;_&squot;
)paren
op_logical_or
(paren
id|name_ptr
(braket
id|i
)braket
op_ge
l_char|&squot;A&squot;
op_logical_and
id|name_ptr
(braket
id|i
)braket
op_le
l_char|&squot;Z&squot;
)paren
op_logical_or
(paren
id|name_ptr
(braket
id|i
)braket
op_ge
l_char|&squot;0&squot;
op_logical_and
id|name_ptr
(braket
id|i
)braket
op_le
l_char|&squot;9&squot;
)paren
)paren
)paren
(brace
r_return
(paren
id|FALSE
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
id|TRUE
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_valid_acpi_character&n; *&n; * PARAMETERS:  Character           - The character to be examined&n; *&n; * RETURN:      1 if Character may appear in a name, else 0&n; *&n; * DESCRIPTION: Check for a printable character&n; *&n; ******************************************************************************/
id|u8
DECL|function|acpi_ut_valid_acpi_character
id|acpi_ut_valid_acpi_character
(paren
id|NATIVE_CHAR
id|character
)paren
(brace
id|FUNCTION_ENTRY
(paren
)paren
suffix:semicolon
r_return
(paren
(paren
id|u8
)paren
(paren
(paren
id|character
op_eq
l_char|&squot;_&squot;
)paren
op_logical_or
(paren
id|character
op_ge
l_char|&squot;A&squot;
op_logical_and
id|character
op_le
l_char|&squot;Z&squot;
)paren
op_logical_or
(paren
id|character
op_ge
l_char|&squot;0&squot;
op_logical_and
id|character
op_le
l_char|&squot;9&squot;
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_strupr&n; *&n; * PARAMETERS:  Src_string      - The source string to convert to&n; *&n; * RETURN:      Src_string&n; *&n; * DESCRIPTION: Convert string to uppercase&n; *&n; ******************************************************************************/
id|NATIVE_CHAR
op_star
DECL|function|acpi_ut_strupr
id|acpi_ut_strupr
(paren
id|NATIVE_CHAR
op_star
id|src_string
)paren
(brace
id|NATIVE_CHAR
op_star
id|string
suffix:semicolon
id|FUNCTION_ENTRY
(paren
)paren
suffix:semicolon
multiline_comment|/* Walk entire string, uppercasing the letters */
r_for
c_loop
(paren
id|string
op_assign
id|src_string
suffix:semicolon
op_star
id|string
suffix:semicolon
)paren
(brace
op_star
id|string
op_assign
(paren
r_char
)paren
id|TOUPPER
(paren
op_star
id|string
)paren
suffix:semicolon
id|string
op_increment
suffix:semicolon
)brace
r_return
(paren
id|src_string
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_mutex_initialize&n; *&n; * PARAMETERS:  None.&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Create the system mutex objects.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_mutex_initialize
id|acpi_ut_mutex_initialize
(paren
r_void
)paren
(brace
id|u32
id|i
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_mutex_initialize&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Create each of the predefined mutex objects&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_MTX
suffix:semicolon
id|i
op_increment
)paren
(brace
id|status
op_assign
id|acpi_ut_create_mutex
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_mutex_terminate&n; *&n; * PARAMETERS:  None.&n; *&n; * RETURN:      None.&n; *&n; * DESCRIPTION: Delete all of the system mutex objects.&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ut_mutex_terminate
id|acpi_ut_mutex_terminate
(paren
r_void
)paren
(brace
id|u32
id|i
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_mutex_terminate&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Delete each predefined mutex object&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_MTX
suffix:semicolon
id|i
op_increment
)paren
(brace
id|acpi_ut_delete_mutex
(paren
id|i
)paren
suffix:semicolon
)brace
id|return_VOID
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_create_mutex&n; *&n; * PARAMETERS:  Mutex_iD        - ID of the mutex to be created&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Create a mutex object.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_create_mutex
id|acpi_ut_create_mutex
(paren
id|ACPI_MUTEX_HANDLE
id|mutex_id
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE_U32
(paren
l_string|&quot;Ut_create_mutex&quot;
comma
id|mutex_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mutex_id
OG
id|MAX_MTX
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|mutex
)paren
(brace
id|status
op_assign
id|acpi_os_create_semaphore
(paren
l_int|1
comma
l_int|1
comma
op_amp
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|mutex
)paren
suffix:semicolon
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|owner_id
op_assign
id|ACPI_MUTEX_NOT_ACQUIRED
suffix:semicolon
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|use_count
op_assign
l_int|0
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_delete_mutex&n; *&n; * PARAMETERS:  Mutex_iD        - ID of the mutex to be deleted&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Delete a mutex object.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_delete_mutex
id|acpi_ut_delete_mutex
(paren
id|ACPI_MUTEX_HANDLE
id|mutex_id
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|FUNCTION_TRACE_U32
(paren
l_string|&quot;Ut_delete_mutex&quot;
comma
id|mutex_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mutex_id
OG
id|MAX_MTX
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_os_delete_semaphore
(paren
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|mutex
)paren
suffix:semicolon
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|mutex
op_assign
l_int|NULL
suffix:semicolon
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|owner_id
op_assign
id|ACPI_MUTEX_NOT_ACQUIRED
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_acquire_mutex&n; *&n; * PARAMETERS:  Mutex_iD        - ID of the mutex to be acquired&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Acquire a mutex object.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_acquire_mutex
id|acpi_ut_acquire_mutex
(paren
id|ACPI_MUTEX_HANDLE
id|mutex_id
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|u32
id|this_thread_id
suffix:semicolon
id|PROC_NAME
(paren
l_string|&quot;Ut_acquire_mutex&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mutex_id
OG
id|MAX_MTX
)paren
(brace
r_return
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|this_thread_id
op_assign
id|acpi_os_get_thread_id
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Deadlock prevention.  Check if this thread owns any mutexes of value&n;&t; * greater than or equal to this one.  If so, the thread has violated&n;&t; * the mutex ordering rule.  This indicates a coding error somewhere in&n;&t; * the ACPI subsystem code.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|mutex_id
suffix:semicolon
id|i
OL
id|MAX_MTX
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|acpi_gbl_acpi_mutex_info
(braket
id|i
)braket
dot
id|owner_id
op_eq
id|this_thread_id
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|mutex_id
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Mutex [%s] already acquired by this thread [%X]&bslash;n&quot;
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
comma
id|this_thread_id
)paren
)paren
suffix:semicolon
r_return
(paren
id|AE_ALREADY_ACQUIRED
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid acquire order: Thread %X owns [%s], wants [%s]&bslash;n&quot;
comma
id|this_thread_id
comma
id|acpi_ut_get_mutex_name
(paren
id|i
)paren
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
id|AE_ACQUIRE_DEADLOCK
)paren
suffix:semicolon
)brace
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_MUTEX
comma
l_string|&quot;Thread %X attempting to acquire Mutex [%s]&bslash;n&quot;
comma
id|this_thread_id
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_os_wait_semaphore
(paren
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|mutex
comma
l_int|1
comma
id|WAIT_FOREVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_MUTEX
comma
l_string|&quot;Thread %X acquired Mutex [%s]&bslash;n&quot;
comma
id|this_thread_id
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
)paren
)paren
suffix:semicolon
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|use_count
op_increment
suffix:semicolon
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|owner_id
op_assign
id|this_thread_id
suffix:semicolon
)brace
r_else
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Thread %X could not acquire Mutex [%s] %s&bslash;n&quot;
comma
id|this_thread_id
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_release_mutex&n; *&n; * PARAMETERS:  Mutex_iD        - ID of the mutex to be released&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Release a mutex object.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_release_mutex
id|acpi_ut_release_mutex
(paren
id|ACPI_MUTEX_HANDLE
id|mutex_id
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|u32
id|this_thread_id
suffix:semicolon
id|PROC_NAME
(paren
l_string|&quot;Ut_release_mutex&quot;
)paren
suffix:semicolon
id|this_thread_id
op_assign
id|acpi_os_get_thread_id
(paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_MUTEX
comma
l_string|&quot;Thread %X releasing Mutex [%s]&bslash;n&quot;
comma
id|this_thread_id
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mutex_id
OG
id|MAX_MTX
)paren
(brace
r_return
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Mutex must be acquired in order to release it!&n;&t; */
r_if
c_cond
(paren
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|owner_id
op_eq
id|ACPI_MUTEX_NOT_ACQUIRED
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Mutex [%s] is not acquired, cannot release&bslash;n&quot;
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
id|AE_NOT_ACQUIRED
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Deadlock prevention.  Check if this thread owns any mutexes of value&n;&t; * greater than this one.  If so, the thread has violated the mutex&n;&t; * ordering rule.  This indicates a coding error somewhere in&n;&t; * the ACPI subsystem code.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
id|mutex_id
suffix:semicolon
id|i
OL
id|MAX_MTX
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|acpi_gbl_acpi_mutex_info
(braket
id|i
)braket
dot
id|owner_id
op_eq
id|this_thread_id
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|mutex_id
)paren
(brace
r_continue
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid release order: owns [%s], releasing [%s]&bslash;n&quot;
comma
id|acpi_ut_get_mutex_name
(paren
id|i
)paren
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
)paren
)paren
suffix:semicolon
r_return
(paren
id|AE_RELEASE_DEADLOCK
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Mark unlocked FIRST */
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|owner_id
op_assign
id|ACPI_MUTEX_NOT_ACQUIRED
suffix:semicolon
id|status
op_assign
id|acpi_os_signal_semaphore
(paren
id|acpi_gbl_acpi_mutex_info
(braket
id|mutex_id
)braket
dot
id|mutex
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Thread %X could not release Mutex [%s] %s&bslash;n&quot;
comma
id|this_thread_id
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_MUTEX
comma
l_string|&quot;Thread %X released Mutex [%s]&bslash;n&quot;
comma
id|this_thread_id
comma
id|acpi_ut_get_mutex_name
(paren
id|mutex_id
)paren
)paren
)paren
suffix:semicolon
)brace
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_create_update_state_and_push&n; *&n; * PARAMETERS:  *Object         - Object to be added to the new state&n; *              Action          - Increment/Decrement&n; *              State_list      - List the state will be added to&n; *&n; * RETURN:      None&n; *&n; * DESCRIPTION: Create a new state and push it&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_create_update_state_and_push
id|acpi_ut_create_update_state_and_push
(paren
id|acpi_operand_object
op_star
id|object
comma
id|u16
id|action
comma
id|acpi_generic_state
op_star
op_star
id|state_list
)paren
(brace
id|acpi_generic_state
op_star
id|state
suffix:semicolon
id|FUNCTION_ENTRY
(paren
)paren
suffix:semicolon
multiline_comment|/* Ignore null objects; these are expected */
r_if
c_cond
(paren
op_logical_neg
id|object
)paren
(brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|state
op_assign
id|acpi_ut_create_update_state
(paren
id|object
comma
id|action
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
r_return
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|acpi_ut_push_generic_state
(paren
id|state_list
comma
id|state
)paren
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_create_pkg_state_and_push&n; *&n; * PARAMETERS:  *Object         - Object to be added to the new state&n; *              Action          - Increment/Decrement&n; *              State_list      - List the state will be added to&n; *&n; * RETURN:      None&n; *&n; * DESCRIPTION: Create a new state and push it&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_create_pkg_state_and_push
id|acpi_ut_create_pkg_state_and_push
(paren
r_void
op_star
id|internal_object
comma
r_void
op_star
id|external_object
comma
id|u16
id|index
comma
id|acpi_generic_state
op_star
op_star
id|state_list
)paren
(brace
id|acpi_generic_state
op_star
id|state
suffix:semicolon
id|FUNCTION_ENTRY
(paren
)paren
suffix:semicolon
id|state
op_assign
id|acpi_ut_create_pkg_state
(paren
id|internal_object
comma
id|external_object
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
r_return
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|acpi_ut_push_generic_state
(paren
id|state_list
comma
id|state
)paren
suffix:semicolon
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_push_generic_state&n; *&n; * PARAMETERS:  List_head           - Head of the state stack&n; *              State               - State object to push&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Push a state object onto a state stack&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ut_push_generic_state
id|acpi_ut_push_generic_state
(paren
id|acpi_generic_state
op_star
op_star
id|list_head
comma
id|acpi_generic_state
op_star
id|state
)paren
(brace
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_push_generic_state&quot;
)paren
suffix:semicolon
multiline_comment|/* Push the state object onto the front of the list (stack) */
id|state-&gt;common.next
op_assign
op_star
id|list_head
suffix:semicolon
op_star
id|list_head
op_assign
id|state
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_pop_generic_state&n; *&n; * PARAMETERS:  List_head           - Head of the state stack&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Pop a state object from a state stack&n; *&n; ******************************************************************************/
id|acpi_generic_state
op_star
DECL|function|acpi_ut_pop_generic_state
id|acpi_ut_pop_generic_state
(paren
id|acpi_generic_state
op_star
op_star
id|list_head
)paren
(brace
id|acpi_generic_state
op_star
id|state
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_pop_generic_state&quot;
)paren
suffix:semicolon
multiline_comment|/* Remove the state object at the head of the list (stack) */
id|state
op_assign
op_star
id|list_head
suffix:semicolon
r_if
c_cond
(paren
id|state
)paren
(brace
multiline_comment|/* Update the list head */
op_star
id|list_head
op_assign
id|state-&gt;common.next
suffix:semicolon
)brace
id|return_PTR
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_create_generic_state&n; *&n; * PARAMETERS:  None&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Create a generic state object.  Attempt to obtain one from&n; *              the global state cache;  If none available, create a new one.&n; *&n; ******************************************************************************/
id|acpi_generic_state
op_star
DECL|function|acpi_ut_create_generic_state
id|acpi_ut_create_generic_state
(paren
r_void
)paren
(brace
id|acpi_generic_state
op_star
id|state
suffix:semicolon
id|FUNCTION_ENTRY
(paren
)paren
suffix:semicolon
id|state
op_assign
id|acpi_ut_acquire_from_cache
(paren
id|ACPI_MEM_LIST_STATE
)paren
suffix:semicolon
multiline_comment|/* Initialize */
r_if
c_cond
(paren
id|state
)paren
(brace
id|state-&gt;common.data_type
op_assign
id|ACPI_DESC_TYPE_STATE
suffix:semicolon
)brace
r_return
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_create_update_state&n; *&n; * PARAMETERS:  Object              - Initial Object to be installed in the&n; *                                    state&n; *              Action              - Update action to be performed&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Create an &quot;Update State&quot; - a flavor of the generic state used&n; *              to update reference counts and delete complex objects such&n; *              as packages.&n; *&n; ******************************************************************************/
id|acpi_generic_state
op_star
DECL|function|acpi_ut_create_update_state
id|acpi_ut_create_update_state
(paren
id|acpi_operand_object
op_star
id|object
comma
id|u16
id|action
)paren
(brace
id|acpi_generic_state
op_star
id|state
suffix:semicolon
id|FUNCTION_TRACE_PTR
(paren
l_string|&quot;Ut_create_update_state&quot;
comma
id|object
)paren
suffix:semicolon
multiline_comment|/* Create the generic state object */
id|state
op_assign
id|acpi_ut_create_generic_state
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Init fields specific to the update struct */
id|state-&gt;update.object
op_assign
id|object
suffix:semicolon
id|state-&gt;update.value
op_assign
id|action
suffix:semicolon
id|return_PTR
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_create_pkg_state&n; *&n; * PARAMETERS:  Object              - Initial Object to be installed in the&n; *                                    state&n; *              Action              - Update action to be performed&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Create an &quot;Update State&quot; - a flavor of the generic state used&n; *              to update reference counts and delete complex objects such&n; *              as packages.&n; *&n; ******************************************************************************/
id|acpi_generic_state
op_star
DECL|function|acpi_ut_create_pkg_state
id|acpi_ut_create_pkg_state
(paren
r_void
op_star
id|internal_object
comma
r_void
op_star
id|external_object
comma
id|u16
id|index
)paren
(brace
id|acpi_generic_state
op_star
id|state
suffix:semicolon
id|FUNCTION_TRACE_PTR
(paren
l_string|&quot;Ut_create_pkg_state&quot;
comma
id|internal_object
)paren
suffix:semicolon
multiline_comment|/* Create the generic state object */
id|state
op_assign
id|acpi_ut_create_generic_state
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Init fields specific to the update struct */
id|state-&gt;pkg.source_object
op_assign
(paren
id|acpi_operand_object
op_star
)paren
id|internal_object
suffix:semicolon
id|state-&gt;pkg.dest_object
op_assign
id|external_object
suffix:semicolon
id|state-&gt;pkg.index
op_assign
id|index
suffix:semicolon
id|state-&gt;pkg.num_packages
op_assign
l_int|1
suffix:semicolon
id|return_PTR
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_create_control_state&n; *&n; * PARAMETERS:  None&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Create a &quot;Control State&quot; - a flavor of the generic state used&n; *              to support nested IF/WHILE constructs in the AML.&n; *&n; ******************************************************************************/
id|acpi_generic_state
op_star
DECL|function|acpi_ut_create_control_state
id|acpi_ut_create_control_state
(paren
r_void
)paren
(brace
id|acpi_generic_state
op_star
id|state
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_create_control_state&quot;
)paren
suffix:semicolon
multiline_comment|/* Create the generic state object */
id|state
op_assign
id|acpi_ut_create_generic_state
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Init fields specific to the control struct */
id|state-&gt;common.state
op_assign
id|CONTROL_CONDITIONAL_EXECUTING
suffix:semicolon
id|return_PTR
(paren
id|state
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_delete_generic_state&n; *&n; * PARAMETERS:  State               - The state object to be deleted&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Put a state object back into the global state cache.  The object&n; *              is not actually freed at this time.&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ut_delete_generic_state
id|acpi_ut_delete_generic_state
(paren
id|acpi_generic_state
op_star
id|state
)paren
(brace
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_delete_generic_state&quot;
)paren
suffix:semicolon
id|acpi_ut_release_to_cache
(paren
id|ACPI_MEM_LIST_STATE
comma
id|state
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_delete_generic_state_cache&n; *&n; * PARAMETERS:  None&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Purge the global state object cache.  Used during subsystem&n; *              termination.&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ut_delete_generic_state_cache
id|acpi_ut_delete_generic_state_cache
(paren
r_void
)paren
(brace
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_delete_generic_state_cache&quot;
)paren
suffix:semicolon
id|acpi_ut_delete_generic_cache
(paren
id|ACPI_MEM_LIST_STATE
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_resolve_package_references&n; *&n; * PARAMETERS:  Obj_desc        - The Package object on which to resolve refs&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Walk through a package and turn internal references into values&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_resolve_package_references
id|acpi_ut_resolve_package_references
(paren
id|acpi_operand_object
op_star
id|obj_desc
)paren
(brace
id|u32
id|count
suffix:semicolon
id|acpi_operand_object
op_star
id|sub_object
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_resolve_package_references&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|obj_desc-&gt;common.type
op_ne
id|ACPI_TYPE_PACKAGE
)paren
(brace
multiline_comment|/* The object must be a package */
id|REPORT_ERROR
(paren
(paren
l_string|&quot;Must resolve Package Refs on a Package&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_ERROR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * TBD: what about nested packages? */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|obj_desc-&gt;package.count
suffix:semicolon
id|count
op_increment
)paren
(brace
id|sub_object
op_assign
id|obj_desc-&gt;package.elements
(braket
id|count
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sub_object-&gt;common.type
op_eq
id|INTERNAL_TYPE_REFERENCE
)paren
(brace
r_if
c_cond
(paren
id|sub_object-&gt;reference.opcode
op_eq
id|AML_ZERO_OP
)paren
(brace
id|sub_object-&gt;common.type
op_assign
id|ACPI_TYPE_INTEGER
suffix:semicolon
id|sub_object-&gt;integer.value
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sub_object-&gt;reference.opcode
op_eq
id|AML_ONE_OP
)paren
(brace
id|sub_object-&gt;common.type
op_assign
id|ACPI_TYPE_INTEGER
suffix:semicolon
id|sub_object-&gt;integer.value
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sub_object-&gt;reference.opcode
op_eq
id|AML_ONES_OP
)paren
(brace
id|sub_object-&gt;common.type
op_assign
id|ACPI_TYPE_INTEGER
suffix:semicolon
id|sub_object-&gt;integer.value
op_assign
id|ACPI_INTEGER_MAX
suffix:semicolon
)brace
)brace
)brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
macro_line|#ifdef ACPI_DEBUG
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_display_init_pathname&n; *&n; * PARAMETERS:  Obj_handle          - Handle whose pathname will be displayed&n; *              Path                - Additional path string to be appended&n; *&n; * RETURN:      acpi_status&n; *&n; * DESCRIPTION: Display full pathnbame of an object, DEBUG ONLY&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ut_display_init_pathname
id|acpi_ut_display_init_pathname
(paren
id|acpi_handle
id|obj_handle
comma
r_char
op_star
id|path
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|u32
id|length
op_assign
l_int|128
suffix:semicolon
r_char
id|buffer
(braket
l_int|128
)braket
suffix:semicolon
id|PROC_NAME
(paren
l_string|&quot;Ut_display_init_pathname&quot;
)paren
suffix:semicolon
id|status
op_assign
id|acpi_ns_handle_to_pathname
(paren
id|obj_handle
comma
op_amp
id|length
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
(paren
id|status
)paren
)paren
(brace
r_if
c_cond
(paren
id|path
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INIT
comma
l_string|&quot;%s.%s&bslash;n&quot;
comma
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INIT
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|buffer
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_walk_package_tree&n; *&n; * PARAMETERS:  Obj_desc        - The Package object on which to resolve refs&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Walk through a package&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_ut_walk_package_tree
id|acpi_ut_walk_package_tree
(paren
id|acpi_operand_object
op_star
id|source_object
comma
r_void
op_star
id|target_object
comma
id|ACPI_PKG_CALLBACK
id|walk_callback
comma
r_void
op_star
id|context
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_generic_state
op_star
id|state_list
op_assign
l_int|NULL
suffix:semicolon
id|acpi_generic_state
op_star
id|state
suffix:semicolon
id|u32
id|this_index
suffix:semicolon
id|acpi_operand_object
op_star
id|this_source_obj
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Ut_walk_package_tree&quot;
)paren
suffix:semicolon
id|state
op_assign
id|acpi_ut_create_pkg_state
(paren
id|source_object
comma
id|target_object
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|state
)paren
(brace
id|this_index
op_assign
id|state-&gt;pkg.index
suffix:semicolon
id|this_source_obj
op_assign
(paren
id|acpi_operand_object
op_star
)paren
id|state-&gt;pkg.source_object-&gt;package.elements
(braket
id|this_index
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Check for&n;&t;&t; * 1) An uninitialized package element.  It is completely&n;&t;&t; *      legal to declare a package and leave it uninitialized&n;&t;&t; * 2) Not an internal object - can be a namespace node instead&n;&t;&t; * 3) Any type other than a package.  Packages are handled in else&n;&t;&t; *      case below.&n;&t;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|this_source_obj
)paren
op_logical_or
(paren
op_logical_neg
id|VALID_DESCRIPTOR_TYPE
(paren
id|this_source_obj
comma
id|ACPI_DESC_TYPE_INTERNAL
)paren
)paren
op_logical_or
(paren
op_logical_neg
id|IS_THIS_OBJECT_TYPE
(paren
id|this_source_obj
comma
id|ACPI_TYPE_PACKAGE
)paren
)paren
)paren
(brace
id|status
op_assign
id|walk_callback
(paren
id|ACPI_COPY_TYPE_SIMPLE
comma
id|this_source_obj
comma
id|state
comma
id|context
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
multiline_comment|/* TBD: must delete package created up to this point */
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
id|state-&gt;pkg.index
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|state-&gt;pkg.index
op_ge
id|state-&gt;pkg.source_object-&gt;package.count
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * We&squot;ve handled all of the objects at this level,  This means&n;&t;&t;&t;&t; * that we have just completed a package.  That package may&n;&t;&t;&t;&t; * have contained one or more packages itself.&n;&t;&t;&t;&t; *&n;&t;&t;&t;&t; * Delete this state and pop the previous state (package).&n;&t;&t;&t;&t; */
id|acpi_ut_delete_generic_state
(paren
id|state
)paren
suffix:semicolon
id|state
op_assign
id|acpi_ut_pop_generic_state
(paren
op_amp
id|state_list
)paren
suffix:semicolon
multiline_comment|/* Finished when there are no more states */
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;&t; * We have handled all of the objects in the top level&n;&t;&t;&t;&t;&t; * package just add the length of the package objects&n;&t;&t;&t;&t;&t; * and exit&n;&t;&t;&t;&t;&t; */
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t;&t; * Go back up a level and move the index past the just&n;&t;&t;&t;&t; * completed package object.&n;&t;&t;&t;&t; */
id|state-&gt;pkg.index
op_increment
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* This is a sub-object of type package */
id|status
op_assign
id|walk_callback
(paren
id|ACPI_COPY_TYPE_PACKAGE
comma
id|this_source_obj
comma
id|state
comma
id|context
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
multiline_comment|/* TBD: must delete package created up to this point */
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * The callback above returned a new target package object.&n;&t;&t;&t; */
multiline_comment|/*&n;&t;&t;&t; * Push the current state and create a new one&n;&t;&t;&t; */
id|acpi_ut_push_generic_state
(paren
op_amp
id|state_list
comma
id|state
)paren
suffix:semicolon
id|state
op_assign
id|acpi_ut_create_pkg_state
(paren
id|this_source_obj
comma
id|state-&gt;pkg.this_target_obj
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
multiline_comment|/* TBD: must delete package created up to this point */
id|return_ACPI_STATUS
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* We should never get here */
r_return
(paren
id|AE_AML_INTERNAL
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_report_error&n; *&n; * PARAMETERS:  Module_name         - Caller&squot;s module name (for error output)&n; *              Line_number         - Caller&squot;s line number (for error output)&n; *              Component_id        - Caller&squot;s component ID (for error output)&n; *              Message             - Error message to use on failure&n; *&n; * RETURN:      None&n; *&n; * DESCRIPTION: Print error message&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ut_report_error
id|acpi_ut_report_error
(paren
id|NATIVE_CHAR
op_star
id|module_name
comma
id|u32
id|line_number
comma
id|u32
id|component_id
)paren
(brace
id|acpi_os_printf
(paren
l_string|&quot;%8s-%04d: *** Error: &quot;
comma
id|module_name
comma
id|line_number
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_report_warning&n; *&n; * PARAMETERS:  Module_name         - Caller&squot;s module name (for error output)&n; *              Line_number         - Caller&squot;s line number (for error output)&n; *              Component_id        - Caller&squot;s component ID (for error output)&n; *              Message             - Error message to use on failure&n; *&n; * RETURN:      None&n; *&n; * DESCRIPTION: Print warning message&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ut_report_warning
id|acpi_ut_report_warning
(paren
id|NATIVE_CHAR
op_star
id|module_name
comma
id|u32
id|line_number
comma
id|u32
id|component_id
)paren
(brace
id|acpi_os_printf
(paren
l_string|&quot;%8s-%04d: *** Warning: &quot;
comma
id|module_name
comma
id|line_number
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_ut_report_info&n; *&n; * PARAMETERS:  Module_name         - Caller&squot;s module name (for error output)&n; *              Line_number         - Caller&squot;s line number (for error output)&n; *              Component_id        - Caller&squot;s component ID (for error output)&n; *              Message             - Error message to use on failure&n; *&n; * RETURN:      None&n; *&n; * DESCRIPTION: Print information message&n; *&n; ******************************************************************************/
r_void
DECL|function|acpi_ut_report_info
id|acpi_ut_report_info
(paren
id|NATIVE_CHAR
op_star
id|module_name
comma
id|u32
id|line_number
comma
id|u32
id|component_id
)paren
(brace
id|acpi_os_printf
(paren
l_string|&quot;%8s-%04d: *** Info: &quot;
comma
id|module_name
comma
id|line_number
)paren
suffix:semicolon
)brace
eof
