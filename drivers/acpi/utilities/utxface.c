multiline_comment|/******************************************************************************&n; *&n; * Module Name: utxface - External interfaces for &quot;global&quot; ACPI functions&n; *              $Revision: 82 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000, 2001 R. Byron Moore&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &quot;acpi.h&quot;
macro_line|#include &quot;acevents.h&quot;
macro_line|#include &quot;achware.h&quot;
macro_line|#include &quot;acnamesp.h&quot;
macro_line|#include &quot;acinterp.h&quot;
macro_line|#include &quot;amlcode.h&quot;
macro_line|#include &quot;acdebug.h&quot;
macro_line|#include &quot;acexcep.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT          ACPI_UTILITIES
id|MODULE_NAME
(paren
l_string|&quot;utxface&quot;
)paren
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_initialize_subsystem&n; *&n; * PARAMETERS:  None&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Initializes all global variables.  This is the first function&n; *              called, so any early initialization belongs here.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_initialize_subsystem
id|acpi_initialize_subsystem
(paren
r_void
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Acpi_initialize_subsystem&quot;
)paren
suffix:semicolon
id|DEBUG_EXEC
c_func
(paren
id|acpi_ut_init_stack_ptr_trace
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize all globals used by the subsystem */
id|acpi_ut_init_globals
(paren
)paren
suffix:semicolon
multiline_comment|/* Initialize the OS-Dependent layer */
id|status
op_assign
id|acpi_os_initialize
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|REPORT_ERROR
(paren
(paren
l_string|&quot;OSD failed to initialize, %s&bslash;n&quot;
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* Create the default mutex objects */
id|status
op_assign
id|acpi_ut_mutex_initialize
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|REPORT_ERROR
(paren
(paren
l_string|&quot;Global mutex creation failure, %s&bslash;n&quot;
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Initialize the namespace manager and&n;&t; * the root of the namespace tree&n;&t; */
id|status
op_assign
id|acpi_ns_root_initialize
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|REPORT_ERROR
(paren
(paren
l_string|&quot;Namespace initialization failure, %s&bslash;n&quot;
comma
id|acpi_format_exception
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* If configured, initialize the AML debugger */
id|DEBUGGER_EXEC
(paren
id|acpi_db_initialize
(paren
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_enable_subsystem&n; *&n; * PARAMETERS:  Flags           - Init/enable Options&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Completes the subsystem initialization including hardware.&n; *              Puts system into ACPI mode if it isn&squot;t already.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_enable_subsystem
id|acpi_enable_subsystem
(paren
id|u32
id|flags
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Acpi_enable_subsystem&quot;
)paren
suffix:semicolon
multiline_comment|/* Sanity check the FADT for valid values */
id|status
op_assign
id|acpi_ut_validate_fadt
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Install the default Op_region handlers. These are&n;&t; * installed unless other handlers have already been&n;&t; * installed via the Install_address_space_handler interface&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|ACPI_NO_ADDRESS_SPACE_INIT
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[Init] Installing default address space handlers&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_ev_install_default_address_space_handlers
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * We must initialize the hardware before we can enable ACPI.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|ACPI_NO_HARDWARE_INIT
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[Init] Initializing ACPI hardware&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_hw_initialize
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Enable ACPI on this platform&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|ACPI_NO_ACPI_ENABLE
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[Init] Going into ACPI mode&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_enable
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Acpi_enable failed.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Note:&n;&t; * We must have the hardware AND events initialized before we can execute&n;&t; * ANY control methods SAFELY.  Any control method can require ACPI hardware&n;&t; * support, so the hardware MUST be initialized before execution!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|ACPI_NO_EVENT_INIT
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[Init] Initializing ACPI events&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_ev_initialize
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Initialize all device objects in the namespace&n;&t; * This runs the _STA and _INI methods.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|ACPI_NO_DEVICE_INIT
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[Init] Initializing ACPI Devices&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_ns_initialize_devices
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Initialize the objects that remain uninitialized.  This&n;&t; * runs the executable AML that is part of the declaration of Op_regions&n;&t; * and Fields.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|ACPI_NO_OBJECT_INIT
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_EXEC
comma
l_string|&quot;[Init] Initializing ACPI Objects&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_ns_initialize_objects
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
id|acpi_gbl_startup_flags
op_or_assign
id|ACPI_INITIALIZED_OK
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************************&n; *&n; * FUNCTION:    Acpi_terminate&n; *&n; * PARAMETERS:  None&n; *&n; * RETURN:      Status&n; *&n; * DESCRIPTION: Shutdown the ACPI subsystem.  Release all resources.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_terminate
id|acpi_terminate
(paren
r_void
)paren
(brace
id|FUNCTION_TRACE
(paren
l_string|&quot;Acpi_terminate&quot;
)paren
suffix:semicolon
multiline_comment|/* Terminate the AML Debugger if present */
id|DEBUGGER_EXEC
c_func
(paren
id|acpi_gbl_db_terminate_threads
op_assign
id|TRUE
)paren
suffix:semicolon
multiline_comment|/* TBD: [Investigate] This is no longer needed?*/
multiline_comment|/*    Acpi_ut_release_mutex (ACPI_MTX_DEBUG_CMD_READY); */
multiline_comment|/* Shutdown and free all resources */
id|acpi_ut_subsystem_shutdown
(paren
)paren
suffix:semicolon
multiline_comment|/* Free the mutex objects */
id|acpi_ut_mutex_terminate
(paren
)paren
suffix:semicolon
macro_line|#ifdef ENABLE_DEBUGGER
multiline_comment|/* Shut down the debugger */
id|acpi_db_terminate
(paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now we can shutdown the OS-dependent layer */
id|acpi_os_terminate
(paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    Acpi_subsystem_status&n; *&n; * PARAMETERS:  None&n; *&n; * RETURN:      Status of the ACPI subsystem&n; *&n; * DESCRIPTION: Other drivers that use the ACPI subsystem should call this&n; *              before making any other calls, to ensure the subsystem initial-&n; *              ized successfully.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|acpi_subsystem_status
id|acpi_subsystem_status
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|acpi_gbl_startup_flags
op_amp
id|ACPI_INITIALIZED_OK
)paren
(brace
r_return
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
id|AE_ERROR
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/******************************************************************************&n; *&n; * FUNCTION:    Acpi_get_system_info&n; *&n; * PARAMETERS:  Out_buffer      - a pointer to a buffer to receive the&n; *                                resources for the device&n; *              Buffer_length   - the number of bytes available in the buffer&n; *&n; * RETURN:      Status          - the status of the call&n; *&n; * DESCRIPTION: This function is called to get information about the current&n; *              state of the ACPI subsystem.  It will return system information&n; *              in the Out_buffer.&n; *&n; *              If the function fails an appropriate status will be returned&n; *              and the value of Out_buffer is undefined.&n; *&n; ******************************************************************************/
id|acpi_status
DECL|function|acpi_get_system_info
id|acpi_get_system_info
(paren
id|acpi_buffer
op_star
id|out_buffer
)paren
(brace
id|acpi_system_info
op_star
id|info_ptr
suffix:semicolon
id|u32
id|i
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;Acpi_get_system_info&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Must have a valid buffer&n;&t; */
r_if
c_cond
(paren
(paren
op_logical_neg
id|out_buffer
)paren
op_logical_or
(paren
op_logical_neg
id|out_buffer-&gt;pointer
)paren
)paren
(brace
id|return_ACPI_STATUS
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|out_buffer-&gt;length
OL
r_sizeof
(paren
id|acpi_system_info
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Caller&squot;s buffer is too small&n;&t;&t; */
id|out_buffer-&gt;length
op_assign
r_sizeof
(paren
id|acpi_system_info
)paren
suffix:semicolon
id|return_ACPI_STATUS
(paren
id|AE_BUFFER_OVERFLOW
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Set return length and get data&n;&t; */
id|out_buffer-&gt;length
op_assign
r_sizeof
(paren
id|acpi_system_info
)paren
suffix:semicolon
id|info_ptr
op_assign
(paren
id|acpi_system_info
op_star
)paren
id|out_buffer-&gt;pointer
suffix:semicolon
id|info_ptr-&gt;acpi_ca_version
op_assign
id|ACPI_CA_VERSION
suffix:semicolon
multiline_comment|/* System flags (ACPI capabilities) */
id|info_ptr-&gt;flags
op_assign
id|acpi_gbl_system_flags
suffix:semicolon
multiline_comment|/* Timer resolution - 24 or 32 bits  */
r_if
c_cond
(paren
op_logical_neg
id|acpi_gbl_FADT
)paren
(brace
id|info_ptr-&gt;timer_resolution
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;tmr_val_ext
op_eq
l_int|0
)paren
(brace
id|info_ptr-&gt;timer_resolution
op_assign
l_int|24
suffix:semicolon
)brace
r_else
(brace
id|info_ptr-&gt;timer_resolution
op_assign
l_int|32
suffix:semicolon
)brace
multiline_comment|/* Clear the reserved fields */
id|info_ptr-&gt;reserved1
op_assign
l_int|0
suffix:semicolon
id|info_ptr-&gt;reserved2
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Current debug levels */
id|info_ptr-&gt;debug_layer
op_assign
id|acpi_dbg_layer
suffix:semicolon
id|info_ptr-&gt;debug_level
op_assign
id|acpi_dbg_level
suffix:semicolon
multiline_comment|/* Current status of the ACPI tables, per table type */
id|info_ptr-&gt;num_table_types
op_assign
id|NUM_ACPI_TABLES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ACPI_TABLES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|info_ptr-&gt;table_info
(braket
id|i
)braket
dot
id|count
op_assign
id|acpi_gbl_acpi_tables
(braket
id|i
)braket
dot
id|count
suffix:semicolon
)brace
id|return_ACPI_STATUS
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
eof
