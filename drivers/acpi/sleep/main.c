multiline_comment|/*&n; * sleep.c - ACPI sleep support.&n; *&n; * Copyright (c) 2004 David Shaohua Li &lt;shaohua.li@intel.com&gt;&n; * Copyright (c) 2000-2003 Patrick Mochel&n; * Copyright (c) 2003 Open Source Development Lab&n; *&n; * This file is released under the GPLv2.&n; *&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/dmi.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;acpi/acpi_bus.h&gt;
macro_line|#include &lt;acpi/acpi_drivers.h&gt;
macro_line|#include &quot;sleep.h&quot;
DECL|variable|sleep_states
id|u8
id|sleep_states
(braket
id|ACPI_S_STATE_COUNT
)braket
suffix:semicolon
DECL|variable|acpi_pm_ops
r_static
r_struct
id|pm_ops
id|acpi_pm_ops
suffix:semicolon
r_extern
r_void
id|do_suspend_lowlevel_s4bios
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|do_suspend_lowlevel
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|acpi_suspend_states
r_static
id|u32
id|acpi_suspend_states
(braket
)braket
op_assign
(brace
(braket
id|PM_SUSPEND_ON
)braket
op_assign
id|ACPI_STATE_S0
comma
(braket
id|PM_SUSPEND_STANDBY
)braket
op_assign
id|ACPI_STATE_S1
comma
(braket
id|PM_SUSPEND_MEM
)braket
op_assign
id|ACPI_STATE_S3
comma
(braket
id|PM_SUSPEND_DISK
)braket
op_assign
id|ACPI_STATE_S4
comma
)brace
suffix:semicolon
DECL|variable|init_8259A_after_S1
r_static
r_int
id|init_8259A_after_S1
suffix:semicolon
multiline_comment|/**&n; *&t;acpi_pm_prepare - Do preliminary suspend work.&n; *&t;@pm_state:&t;&t;suspend state we&squot;re entering.&n; *&n; *&t;Make sure we support the state. If we do, and we need it, set the&n; *&t;firmware waking vector and do arch-specific nastiness to get the &n; *&t;wakeup code to the waking vector. &n; */
DECL|function|acpi_pm_prepare
r_static
r_int
id|acpi_pm_prepare
c_func
(paren
id|suspend_state_t
id|pm_state
)paren
(brace
id|u32
id|acpi_state
op_assign
id|acpi_suspend_states
(braket
id|pm_state
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sleep_states
(braket
id|acpi_state
)braket
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* do we have a wakeup address for S2 and S3? */
multiline_comment|/* Here, we support only S4BIOS, those we set the wakeup address */
multiline_comment|/* S4OS is only supported for now via swsusp.. */
r_if
c_cond
(paren
id|pm_state
op_eq
id|PM_SUSPEND_MEM
op_logical_or
id|pm_state
op_eq
id|PM_SUSPEND_DISK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|acpi_wakeup_address
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|acpi_set_firmware_waking_vector
c_func
(paren
(paren
id|acpi_physical_address
)paren
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
id|acpi_wakeup_address
)paren
)paren
suffix:semicolon
)brace
id|ACPI_FLUSH_CPU_CACHE
c_func
(paren
)paren
suffix:semicolon
id|acpi_enable_wakeup_device_prep
c_func
(paren
id|acpi_state
)paren
suffix:semicolon
id|acpi_enter_sleep_state_prep
c_func
(paren
id|acpi_state
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;acpi_pm_enter - Actually enter a sleep state.&n; *&t;@pm_state:&t;&t;State we&squot;re entering.&n; *&n; *&t;Flush caches and go to sleep. For STR or STD, we have to call &n; *&t;arch-specific assembly, which in turn call acpi_enter_sleep_state().&n; *&t;It&squot;s unfortunate, but it works. Please fix if you&squot;re feeling frisky.&n; */
DECL|function|acpi_pm_enter
r_static
r_int
id|acpi_pm_enter
c_func
(paren
id|suspend_state_t
id|pm_state
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_int
r_int
id|flags
op_assign
l_int|0
suffix:semicolon
id|u32
id|acpi_state
op_assign
id|acpi_suspend_states
(braket
id|pm_state
)braket
suffix:semicolon
id|ACPI_FLUSH_CPU_CACHE
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Do arch specific saving of state. */
r_if
c_cond
(paren
id|pm_state
OG
id|PM_SUSPEND_STANDBY
)paren
(brace
r_int
id|error
op_assign
id|acpi_save_state_mem
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
)brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|acpi_enable_wakeup_device
c_func
(paren
id|acpi_state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|pm_state
)paren
(brace
r_case
id|PM_SUSPEND_STANDBY
suffix:colon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_enter_sleep_state
c_func
(paren
id|acpi_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_SUSPEND_MEM
suffix:colon
id|do_suspend_lowlevel
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PM_SUSPEND_DISK
suffix:colon
r_if
c_cond
(paren
id|acpi_pm_ops.pm_disk_mode
op_eq
id|PM_DISK_PLATFORM
)paren
id|status
op_assign
id|acpi_enter_sleep_state
c_func
(paren
id|acpi_state
)paren
suffix:semicolon
r_else
id|do_suspend_lowlevel_s4bios
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Back to C!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* restore processor state&n;&t; * We should only be here if we&squot;re coming back from STR or STD.&n;&t; * And, in the case of the latter, the memory image should have already&n;&t; * been loaded from disk.&n;&t; */
r_if
c_cond
(paren
id|pm_state
OG
id|PM_SUSPEND_STANDBY
)paren
id|acpi_restore_state_mem
c_func
(paren
)paren
suffix:semicolon
r_return
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;acpi_pm_finish - Finish up suspend sequence.&n; *&t;@pm_state:&t;&t;State we&squot;re coming out of.&n; *&n; *&t;This is called after we wake back up (or if entering the sleep state&n; *&t;failed). &n; */
DECL|function|acpi_pm_finish
r_static
r_int
id|acpi_pm_finish
c_func
(paren
id|suspend_state_t
id|pm_state
)paren
(brace
id|u32
id|acpi_state
op_assign
id|acpi_suspend_states
(braket
id|pm_state
)braket
suffix:semicolon
id|acpi_leave_sleep_state
c_func
(paren
id|acpi_state
)paren
suffix:semicolon
id|acpi_disable_wakeup_device
c_func
(paren
id|acpi_state
)paren
suffix:semicolon
multiline_comment|/* reset firmware waking vector */
id|acpi_set_firmware_waking_vector
c_func
(paren
(paren
id|acpi_physical_address
)paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|init_8259A_after_S1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Broken toshiba laptop -&gt; kicking interrupts&bslash;n&quot;
)paren
suffix:semicolon
id|init_8259A
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|acpi_suspend
r_int
id|acpi_suspend
c_func
(paren
id|u32
id|acpi_state
)paren
(brace
id|u32
id|states
(braket
)braket
op_assign
(brace
(braket
l_int|1
)braket
op_assign
id|PM_SUSPEND_STANDBY
comma
(braket
l_int|3
)braket
op_assign
id|PM_SUSPEND_MEM
comma
(braket
l_int|4
)braket
op_assign
id|PM_SUSPEND_DISK
comma
)brace
suffix:semicolon
r_if
c_cond
(paren
id|acpi_state
op_le
l_int|4
op_logical_and
id|states
(braket
id|acpi_state
)braket
)paren
r_return
id|pm_suspend
c_func
(paren
id|states
(braket
id|acpi_state
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|acpi_pm_ops
r_static
r_struct
id|pm_ops
id|acpi_pm_ops
op_assign
(brace
dot
id|prepare
op_assign
id|acpi_pm_prepare
comma
dot
id|enter
op_assign
id|acpi_pm_enter
comma
dot
id|finish
op_assign
id|acpi_pm_finish
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Toshiba fails to preserve interrupts over S1, reinitialization&n; * of 8259 is needed after S1 resume.&n; */
DECL|function|init_ints_after_s1
r_static
r_int
id|__init
id|init_ints_after_s1
c_func
(paren
r_struct
id|dmi_system_id
op_star
id|d
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s with broken S1 detected.&bslash;n&quot;
comma
id|d-&gt;ident
)paren
suffix:semicolon
id|init_8259A_after_S1
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|acpisleep_dmi_table
r_static
r_struct
id|dmi_system_id
id|__initdata
id|acpisleep_dmi_table
(braket
)braket
op_assign
(brace
(brace
dot
id|callback
op_assign
id|init_ints_after_s1
comma
dot
id|ident
op_assign
l_string|&quot;Toshiba Satellite 4030cdt&quot;
comma
dot
id|matches
op_assign
(brace
id|DMI_MATCH
c_func
(paren
id|DMI_PRODUCT_NAME
comma
l_string|&quot;S4030CDT/4.3&quot;
)paren
comma
)brace
comma
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|function|acpi_sleep_init
r_static
r_int
id|__init
id|acpi_sleep_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|dmi_check_system
c_func
(paren
id|acpisleep_dmi_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_disabled
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;(supports&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_S_STATE_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|u8
id|type_a
comma
id|type_b
suffix:semicolon
id|status
op_assign
id|acpi_get_sleep_type_data
c_func
(paren
id|i
comma
op_amp
id|type_a
comma
op_amp
id|type_b
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|sleep_states
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; S%d&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|ACPI_STATE_S4
)paren
(brace
r_if
c_cond
(paren
id|acpi_gbl_FACS-&gt;S4bios_f
)paren
(brace
id|sleep_states
(braket
id|i
)braket
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; S4bios&quot;
)paren
suffix:semicolon
id|acpi_pm_ops.pm_disk_mode
op_assign
id|PM_DISK_FIRMWARE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sleep_states
(braket
id|i
)braket
)paren
id|acpi_pm_ops.pm_disk_mode
op_assign
id|PM_DISK_PLATFORM
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
id|pm_set_ops
c_func
(paren
op_amp
id|acpi_pm_ops
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|acpi_sleep_init
id|late_initcall
c_func
(paren
id|acpi_sleep_init
)paren
suffix:semicolon
eof
