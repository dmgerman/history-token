multiline_comment|/* &n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or (at&n; *  your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but&n; *  WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *  General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; */
multiline_comment|/* Purpose: Prevent PCMCIA cards from using motherboard resources. */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;acpi/acpi_bus.h&gt;
macro_line|#include &lt;acpi/acpi_drivers.h&gt;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_SYSTEM_COMPONENT
id|ACPI_MODULE_NAME
(paren
l_string|&quot;acpi_motherboard&quot;
)paren
multiline_comment|/* Dell use PNP0C01 instead of PNP0C02 */
DECL|macro|ACPI_MB_HID1
mdefine_line|#define ACPI_MB_HID1&t;&t;&t;&quot;PNP0C01&quot;
DECL|macro|ACPI_MB_HID2
mdefine_line|#define ACPI_MB_HID2&t;&t;&t;&quot;PNP0C02&quot;
multiline_comment|/**&n; * Doesn&squot;t care about legacy IO ports, only IO ports beyond 0x1000 are reserved&n; * Doesn&squot;t care about the failure of &squot;request_region&squot;, since other may reserve &n; * the io ports as well&n; */
DECL|macro|IS_RESERVED_ADDR
mdefine_line|#define IS_RESERVED_ADDR(base, len) &bslash;&n;&t;(((len) &gt; 0) &amp;&amp; ((base) &gt; 0) &amp;&amp; ((base) + (len) &lt; IO_SPACE_LIMIT) &bslash;&n;&t;&amp;&amp; ((base) + (len) &gt; PCIBIOS_MIN_IO))
multiline_comment|/*&n; * Clearing the flag (IORESOURCE_BUSY) allows drivers to use&n; * the io ports if they really know they can use it, while&n; * still preventing hotplug PCI devices from using it. &n; */
r_static
id|acpi_status
DECL|function|acpi_reserve_io_ranges
id|acpi_reserve_io_ranges
(paren
r_struct
id|acpi_resource
op_star
id|res
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|resource
op_star
id|requested_res
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_reserve_io_ranges&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;id
op_eq
id|ACPI_RSTYPE_IO
)paren
(brace
r_struct
id|acpi_resource_io
op_star
id|io_res
op_assign
op_amp
id|res-&gt;data.io
suffix:semicolon
r_if
c_cond
(paren
id|io_res-&gt;min_base_address
op_ne
id|io_res-&gt;max_base_address
)paren
r_return
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
id|IS_RESERVED_ADDR
c_func
(paren
id|io_res-&gt;min_base_address
comma
id|io_res-&gt;range_length
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Motherboard resources 0x%08x - 0x%08x&bslash;n&quot;
comma
id|io_res-&gt;min_base_address
comma
id|io_res-&gt;min_base_address
op_plus
id|io_res-&gt;range_length
)paren
)paren
suffix:semicolon
id|requested_res
op_assign
id|request_region
c_func
(paren
id|io_res-&gt;min_base_address
comma
id|io_res-&gt;range_length
comma
l_string|&quot;motherboard&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|res-&gt;id
op_eq
id|ACPI_RSTYPE_FIXED_IO
)paren
(brace
r_struct
id|acpi_resource_fixed_io
op_star
id|fixed_io_res
op_assign
op_amp
id|res-&gt;data.fixed_io
suffix:semicolon
r_if
c_cond
(paren
id|IS_RESERVED_ADDR
c_func
(paren
id|fixed_io_res-&gt;base_address
comma
id|fixed_io_res-&gt;range_length
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Motherboard resources 0x%08x - 0x%08x&bslash;n&quot;
comma
id|fixed_io_res-&gt;base_address
comma
id|fixed_io_res-&gt;base_address
op_plus
id|fixed_io_res-&gt;range_length
)paren
)paren
suffix:semicolon
id|requested_res
op_assign
id|request_region
c_func
(paren
id|fixed_io_res-&gt;base_address
comma
id|fixed_io_res-&gt;range_length
comma
l_string|&quot;motherboard&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Memory mapped IO? */
)brace
r_if
c_cond
(paren
id|requested_res
)paren
id|requested_res-&gt;flags
op_and_assign
op_complement
id|IORESOURCE_BUSY
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
DECL|function|acpi_motherboard_add
r_static
r_int
id|acpi_motherboard_add
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_walk_resources
c_func
(paren
id|device-&gt;handle
comma
id|METHOD_NAME__CRS
comma
id|acpi_reserve_io_ranges
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|acpi_motherboard_driver1
r_static
r_struct
id|acpi_driver
id|acpi_motherboard_driver1
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;motherboard&quot;
comma
dot
r_class
op_assign
l_string|&quot;&quot;
comma
dot
id|ids
op_assign
id|ACPI_MB_HID1
comma
dot
id|ops
op_assign
(brace
dot
id|add
op_assign
id|acpi_motherboard_add
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|acpi_motherboard_driver2
r_static
r_struct
id|acpi_driver
id|acpi_motherboard_driver2
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;motherboard&quot;
comma
dot
r_class
op_assign
l_string|&quot;&quot;
comma
dot
id|ids
op_assign
id|ACPI_MB_HID2
comma
dot
id|ops
op_assign
(brace
dot
id|add
op_assign
id|acpi_motherboard_add
comma
)brace
comma
)brace
suffix:semicolon
r_static
r_void
id|__init
DECL|function|acpi_reserve_resources
id|acpi_reserve_resources
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;xpm1a_evt_blk.address
op_logical_and
id|acpi_gbl_FADT-&gt;pm1_evt_len
)paren
id|request_region
c_func
(paren
id|acpi_gbl_FADT-&gt;xpm1a_evt_blk.address
comma
id|acpi_gbl_FADT-&gt;pm1_evt_len
comma
l_string|&quot;PM1a_EVT_BLK&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;xpm1b_evt_blk.address
op_logical_and
id|acpi_gbl_FADT-&gt;pm1_evt_len
)paren
id|request_region
c_func
(paren
id|acpi_gbl_FADT-&gt;xpm1b_evt_blk.address
comma
id|acpi_gbl_FADT-&gt;pm1_evt_len
comma
l_string|&quot;PM1b_EVT_BLK&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;xpm1a_cnt_blk.address
op_logical_and
id|acpi_gbl_FADT-&gt;pm1_cnt_len
)paren
id|request_region
c_func
(paren
id|acpi_gbl_FADT-&gt;xpm1a_cnt_blk.address
comma
id|acpi_gbl_FADT-&gt;pm1_cnt_len
comma
l_string|&quot;PM1a_CNT_BLK&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;xpm1b_cnt_blk.address
op_logical_and
id|acpi_gbl_FADT-&gt;pm1_cnt_len
)paren
id|request_region
c_func
(paren
id|acpi_gbl_FADT-&gt;xpm1b_cnt_blk.address
comma
id|acpi_gbl_FADT-&gt;pm1_cnt_len
comma
l_string|&quot;PM1b_CNT_BLK&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;xpm_tmr_blk.address
op_logical_and
id|acpi_gbl_FADT-&gt;pm_tm_len
op_eq
l_int|4
)paren
id|request_region
c_func
(paren
id|acpi_gbl_FADT-&gt;xpm_tmr_blk.address
comma
l_int|4
comma
l_string|&quot;PM_TMR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;xpm2_cnt_blk.address
op_logical_and
id|acpi_gbl_FADT-&gt;pm2_cnt_len
)paren
id|request_region
c_func
(paren
id|acpi_gbl_FADT-&gt;xpm2_cnt_blk.address
comma
id|acpi_gbl_FADT-&gt;pm2_cnt_len
comma
l_string|&quot;PM2_CNT_BLK&quot;
)paren
suffix:semicolon
multiline_comment|/* Length of GPE blocks must be a non-negative multiple of 2 */
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;xgpe0_blk.address
op_logical_and
id|acpi_gbl_FADT-&gt;gpe0_blk_len
op_logical_and
op_logical_neg
(paren
id|acpi_gbl_FADT-&gt;gpe0_blk_len
op_amp
l_int|0x1
)paren
)paren
id|request_region
c_func
(paren
id|acpi_gbl_FADT-&gt;xgpe0_blk.address
comma
id|acpi_gbl_FADT-&gt;gpe0_blk_len
comma
l_string|&quot;GPE0_BLK&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_gbl_FADT-&gt;xgpe1_blk.address
op_logical_and
id|acpi_gbl_FADT-&gt;gpe1_blk_len
op_logical_and
op_logical_neg
(paren
id|acpi_gbl_FADT-&gt;gpe1_blk_len
op_amp
l_int|0x1
)paren
)paren
id|request_region
c_func
(paren
id|acpi_gbl_FADT-&gt;xgpe1_blk.address
comma
id|acpi_gbl_FADT-&gt;gpe1_blk_len
comma
l_string|&quot;GPE1_BLK&quot;
)paren
suffix:semicolon
)brace
DECL|function|acpi_motherboard_init
r_static
r_int
id|__init
id|acpi_motherboard_init
c_func
(paren
r_void
)paren
(brace
id|acpi_bus_register_driver
c_func
(paren
op_amp
id|acpi_motherboard_driver1
)paren
suffix:semicolon
id|acpi_bus_register_driver
c_func
(paren
op_amp
id|acpi_motherboard_driver2
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Guarantee motherboard IO reservation first&n;&t; * This module must run after scan.c&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|acpi_disabled
)paren
id|acpi_reserve_resources
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Reserve motherboard resources after PCI claim BARs,&n; * but before PCI assign resources for uninitialized PCI devices&n; */
DECL|variable|acpi_motherboard_init
id|fs_initcall
c_func
(paren
id|acpi_motherboard_init
)paren
suffix:semicolon
eof
