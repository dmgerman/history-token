multiline_comment|/*&n; * processor_throttling.c - Throttling submodule of the ACPI processor driver&n; *&n; *  Copyright (C) 2001, 2002 Andy Grover &lt;andrew.grover@intel.com&gt;&n; *  Copyright (C) 2001, 2002 Paul Diefenbaugh &lt;paul.s.diefenbaugh@intel.com&gt;&n; *  Copyright (C) 2004       Dominik Brodowski &lt;linux@brodo.de&gt;&n; *  Copyright (C) 2004  Anil S Keshavamurthy &lt;anil.s.keshavamurthy@intel.com&gt;&n; *  &t;&t;&t;- Added processor hotplug support&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or (at&n; *  your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but&n; *  WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *  General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;acpi/acpi_bus.h&gt;
macro_line|#include &lt;acpi/processor.h&gt;
DECL|macro|ACPI_PROCESSOR_COMPONENT
mdefine_line|#define ACPI_PROCESSOR_COMPONENT        0x01000000
DECL|macro|ACPI_PROCESSOR_CLASS
mdefine_line|#define ACPI_PROCESSOR_CLASS            &quot;processor&quot;
DECL|macro|ACPI_PROCESSOR_DRIVER_NAME
mdefine_line|#define ACPI_PROCESSOR_DRIVER_NAME      &quot;ACPI Processor Driver&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT              ACPI_PROCESSOR_COMPONENT
id|ACPI_MODULE_NAME
(paren
l_string|&quot;acpi_processor&quot;
)paren
multiline_comment|/* --------------------------------------------------------------------------&n;                              Throttling Control&n;   -------------------------------------------------------------------------- */
r_static
r_int
DECL|function|acpi_processor_get_throttling
id|acpi_processor_get_throttling
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
r_int
id|state
op_assign
l_int|0
suffix:semicolon
id|u32
id|value
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_mask
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_value
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_get_throttling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;flags.throttling
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|pr-&gt;throttling.state
op_assign
l_int|0
suffix:semicolon
id|duty_mask
op_assign
id|pr-&gt;throttling.state_count
op_minus
l_int|1
suffix:semicolon
id|duty_mask
op_lshift_assign
id|pr-&gt;throttling.duty_offset
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|value
op_assign
id|inl
c_func
(paren
id|pr-&gt;throttling.address
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Compute the current throttling state when throttling is enabled&n;&t; * (bit 4 is on).&n;&t; */
r_if
c_cond
(paren
id|value
op_amp
l_int|0x10
)paren
(brace
id|duty_value
op_assign
id|value
op_amp
id|duty_mask
suffix:semicolon
id|duty_value
op_rshift_assign
id|pr-&gt;throttling.duty_offset
suffix:semicolon
r_if
c_cond
(paren
id|duty_value
)paren
id|state
op_assign
id|pr-&gt;throttling.state_count
op_minus
id|duty_value
suffix:semicolon
)brace
id|pr-&gt;throttling.state
op_assign
id|state
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Throttling state is T%d (%d%% throttling applied)&bslash;n&quot;
comma
id|state
comma
id|pr-&gt;throttling.states
(braket
id|state
)braket
dot
id|performance
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|acpi_processor_set_throttling
r_int
id|acpi_processor_set_throttling
(paren
r_struct
id|acpi_processor
op_star
id|pr
comma
r_int
id|state
)paren
(brace
id|u32
id|value
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_mask
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_value
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_set_throttling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
OL
l_int|0
)paren
op_logical_or
(paren
id|state
OG
(paren
id|pr-&gt;throttling.state_count
op_minus
l_int|1
)paren
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;flags.throttling
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|pr-&gt;throttling.state
)paren
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Calculate the duty_value and duty_mask.&n;&t; */
r_if
c_cond
(paren
id|state
)paren
(brace
id|duty_value
op_assign
id|pr-&gt;throttling.state_count
op_minus
id|state
suffix:semicolon
id|duty_value
op_lshift_assign
id|pr-&gt;throttling.duty_offset
suffix:semicolon
multiline_comment|/* Used to clear all duty_value bits */
id|duty_mask
op_assign
id|pr-&gt;throttling.state_count
op_minus
l_int|1
suffix:semicolon
id|duty_mask
op_lshift_assign
id|acpi_fadt.duty_offset
suffix:semicolon
id|duty_mask
op_assign
op_complement
id|duty_mask
suffix:semicolon
)brace
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Disable throttling by writing a 0 to bit 4.  Note that we must&n;&t; * turn it off before you can change the duty_value.&n;&t; */
id|value
op_assign
id|inl
c_func
(paren
id|pr-&gt;throttling.address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
l_int|0x10
)paren
(brace
id|value
op_and_assign
l_int|0xFFFFFFEF
suffix:semicolon
id|outl
c_func
(paren
id|value
comma
id|pr-&gt;throttling.address
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Write the new duty_value and then enable throttling.  Note&n;&t; * that a state value of 0 leaves throttling disabled.&n;&t; */
r_if
c_cond
(paren
id|state
)paren
(brace
id|value
op_and_assign
id|duty_mask
suffix:semicolon
id|value
op_or_assign
id|duty_value
suffix:semicolon
id|outl
c_func
(paren
id|value
comma
id|pr-&gt;throttling.address
)paren
suffix:semicolon
id|value
op_or_assign
l_int|0x00000010
suffix:semicolon
id|outl
c_func
(paren
id|value
comma
id|pr-&gt;throttling.address
)paren
suffix:semicolon
)brace
id|pr-&gt;throttling.state
op_assign
id|state
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Throttling state set to T%d (%d%%)&bslash;n&quot;
comma
id|state
comma
(paren
id|pr-&gt;throttling.states
(braket
id|state
)braket
dot
id|performance
ques
c_cond
id|pr-&gt;throttling.states
(braket
id|state
)braket
dot
id|performance
op_div
l_int|10
suffix:colon
l_int|0
)paren
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_int
DECL|function|acpi_processor_get_throttling_info
id|acpi_processor_get_throttling_info
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|step
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_get_throttling_info&quot;
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;pblk_address[0x%08x] duty_offset[%d] duty_width[%d]&bslash;n&quot;
comma
id|pr-&gt;throttling.address
comma
id|pr-&gt;throttling.duty_offset
comma
id|pr-&gt;throttling.duty_width
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* TBD: Support ACPI 2.0 objects */
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;throttling.address
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;No throttling register&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;throttling.duty_width
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;No throttling states&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* TBD: Support duty_cycle values that span bit 4. */
r_else
r_if
c_cond
(paren
(paren
id|pr-&gt;throttling.duty_offset
op_plus
id|pr-&gt;throttling.duty_width
)paren
OG
l_int|4
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;duty_cycle spans bit 4&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * PIIX4 Errata: We don&squot;t support throttling on the original PIIX4.&n;&t; * This shouldn&squot;t be an issue as few (if any) mobile systems ever&n;&t; * used this part.&n;&t; */
r_if
c_cond
(paren
id|errata.piix4.throttle
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Throttling not supported on PIIX4 A- or B-step&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|pr-&gt;throttling.state_count
op_assign
l_int|1
op_lshift
id|acpi_fadt.duty_width
suffix:semicolon
multiline_comment|/*&n;&t; * Compute state values. Note that throttling displays a linear power/&n;&t; * performance relationship (at 50% performance the CPU will consume&n;&t; * 50% power).  Values are in 1/10th of a percent to preserve accuracy.&n;&t; */
id|step
op_assign
(paren
l_int|1000
op_div
id|pr-&gt;throttling.state_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pr-&gt;throttling.state_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pr-&gt;throttling.states
(braket
id|i
)braket
dot
id|performance
op_assign
id|step
op_star
id|i
suffix:semicolon
id|pr-&gt;throttling.states
(braket
id|i
)braket
dot
id|power
op_assign
id|step
op_star
id|i
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found %d throttling states&bslash;n&quot;
comma
id|pr-&gt;throttling.state_count
)paren
)paren
suffix:semicolon
id|pr-&gt;flags.throttling
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Disable throttling (if enabled).  We&squot;ll let subsequent policy (e.g.&n;&t; * thermal) decide to lower performance if it so chooses, but for now&n;&t; * we&squot;ll crank up the speed.&n;&t; */
id|result
op_assign
id|acpi_processor_get_throttling
c_func
(paren
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;throttling.state
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Disabling throttling (was T%d)&bslash;n&quot;
comma
id|pr-&gt;throttling.state
)paren
)paren
suffix:semicolon
id|result
op_assign
id|acpi_processor_set_throttling
c_func
(paren
id|pr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
)brace
id|end
suffix:colon
r_if
c_cond
(paren
id|result
)paren
id|pr-&gt;flags.throttling
op_assign
l_int|0
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* proc interface */
DECL|function|acpi_processor_throttling_seq_show
r_static
r_int
id|acpi_processor_throttling_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|offset
)paren
(brace
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_throttling_seq_show&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pr-&gt;throttling.state_count
OG
l_int|0
)paren
)paren
(brace
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;&lt;not supported&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|result
op_assign
id|acpi_processor_get_throttling
c_func
(paren
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;Could not determine current throttling state.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;state count:             %d&bslash;n&quot;
l_string|&quot;active state:            T%d&bslash;n&quot;
comma
id|pr-&gt;throttling.state_count
comma
id|pr-&gt;throttling.state
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;states:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pr-&gt;throttling.state_count
suffix:semicolon
id|i
op_increment
)paren
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;   %cT%d:                  %02d%%&bslash;n&quot;
comma
(paren
id|i
op_eq
id|pr-&gt;throttling.state
ques
c_cond
l_char|&squot;*&squot;
suffix:colon
l_char|&squot; &squot;
)paren
comma
id|i
comma
(paren
id|pr-&gt;throttling.states
(braket
id|i
)braket
dot
id|performance
ques
c_cond
id|pr-&gt;throttling.states
(braket
id|i
)braket
dot
id|performance
op_div
l_int|10
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|end
suffix:colon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|acpi_processor_throttling_open_fs
r_int
id|acpi_processor_throttling_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|acpi_processor_throttling_seq_show
comma
id|PDE
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|data
)paren
suffix:semicolon
)brace
DECL|function|acpi_processor_write_throttling
id|ssize_t
id|acpi_processor_write_throttling
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|data
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|seq_file
op_star
id|m
op_assign
(paren
r_struct
id|seq_file
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|m
op_member_access_from_pointer
r_private
suffix:semicolon
r_char
id|state_string
(braket
l_int|12
)braket
op_assign
(brace
l_char|&squot;&bslash;0&squot;
)brace
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_write_throttling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
op_logical_or
(paren
id|count
OG
r_sizeof
(paren
id|state_string
)paren
op_minus
l_int|1
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|state_string
comma
id|buffer
comma
id|count
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|state_string
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|result
op_assign
id|acpi_processor_set_throttling
c_func
(paren
id|pr
comma
id|simple_strtoul
c_func
(paren
id|state_string
comma
l_int|NULL
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|count
)paren
suffix:semicolon
)brace
DECL|variable|acpi_processor_throttling_fops
r_struct
id|file_operations
id|acpi_processor_throttling_fops
op_assign
(brace
dot
id|open
op_assign
id|acpi_processor_throttling_open_fs
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
eof
