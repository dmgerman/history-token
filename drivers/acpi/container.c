multiline_comment|/*&n; * acpi_container.c  - ACPI Generic Container Driver&n; * ($Revision: )&n; *&n; * Copyright (C) 2004 Anil S Keshavamurthy (anil.s.keshavamurthy@intel.com)&n; * Copyright (C) 2004 Keiichiro Tokunaga (tokunaga.keiich@jp.fujitsu.com)&n; * Copyright (C) 2004 Motoyuki Ito (motoyuki@soft.fujitsu.com)&n; * Copyright (C) 2004 Intel Corp.&n; * Copyright (C) 2004 FUJITSU LIMITED&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or (at&n; *  your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but&n; *  WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *  General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;acpi/acpi_bus.h&gt;
macro_line|#include &lt;acpi/acpi_drivers.h&gt;
macro_line|#include &lt;acpi/container.h&gt;
DECL|macro|ACPI_CONTAINER_DRIVER_NAME
mdefine_line|#define ACPI_CONTAINER_DRIVER_NAME&t;&quot;ACPI container driver&quot;
DECL|macro|ACPI_CONTAINER_DEVICE_NAME
mdefine_line|#define ACPI_CONTAINER_DEVICE_NAME&t;&quot;ACPI container device&quot;
DECL|macro|ACPI_CONTAINER_CLASS
mdefine_line|#define ACPI_CONTAINER_CLASS&t;&t;&quot;container&quot;
DECL|macro|INSTALL_NOTIFY_HANDLER
mdefine_line|#define INSTALL_NOTIFY_HANDLER&t;&t;1
DECL|macro|UNINSTALL_NOTIFY_HANDLER
mdefine_line|#define UNINSTALL_NOTIFY_HANDLER&t;2
DECL|macro|ACPI_CONTAINER_COMPONENT
mdefine_line|#define ACPI_CONTAINER_COMPONENT&t;0x01000000
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;&t;ACPI_CONTAINER_COMPONENT
id|ACPI_MODULE_NAME
(paren
l_string|&quot;acpi_container&quot;
)paren
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Anil S Keshavamurthy&quot;
)paren
suffix:semicolon
DECL|variable|ACPI_CONTAINER_DRIVER_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|ACPI_CONTAINER_DRIVER_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|ACPI_STA_PRESENT
mdefine_line|#define ACPI_STA_PRESENT&t;&t;(0x00000001)
r_static
r_int
id|acpi_container_add
c_func
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
suffix:semicolon
r_static
r_int
id|acpi_container_remove
c_func
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
suffix:semicolon
DECL|variable|acpi_container_driver
r_static
r_struct
id|acpi_driver
id|acpi_container_driver
op_assign
(brace
dot
id|name
op_assign
id|ACPI_CONTAINER_DRIVER_NAME
comma
dot
r_class
op_assign
id|ACPI_CONTAINER_CLASS
comma
dot
id|ids
op_assign
l_string|&quot;ACPI0004,PNP0A05,PNP0A06&quot;
comma
dot
id|ops
op_assign
(brace
dot
id|add
op_assign
id|acpi_container_add
comma
dot
id|remove
op_assign
id|acpi_container_remove
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*******************************************************************/
r_static
r_int
DECL|function|is_device_present
id|is_device_present
c_func
(paren
id|acpi_handle
id|handle
)paren
(brace
id|acpi_handle
id|temp
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_int
r_int
id|sta
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;is_device_present&quot;
)paren
suffix:semicolon
id|status
op_assign
id|acpi_get_handle
c_func
(paren
id|handle
comma
l_string|&quot;_STA&quot;
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_VALUE
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* _STA not found, assmue device present */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|handle
comma
l_string|&quot;_STA&quot;
comma
l_int|NULL
comma
op_amp
id|sta
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Firmware error */
id|return_VALUE
c_func
(paren
(paren
id|sta
op_amp
id|ACPI_STA_PRESENT
)paren
op_eq
id|ACPI_STA_PRESENT
)paren
suffix:semicolon
)brace
multiline_comment|/*******************************************************************/
r_static
r_int
DECL|function|acpi_container_add
id|acpi_container_add
c_func
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
r_struct
id|acpi_container
op_star
id|container
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_container_add&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;device is NULL&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|container
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpi_container
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|container
)paren
(brace
id|return_VALUE
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|container
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_container
)paren
)paren
suffix:semicolon
id|container-&gt;handle
op_assign
id|device-&gt;handle
suffix:semicolon
id|strcpy
c_func
(paren
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
id|ACPI_CONTAINER_DEVICE_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|acpi_device_class
c_func
(paren
id|device
)paren
comma
id|ACPI_CONTAINER_CLASS
)paren
suffix:semicolon
id|acpi_driver_data
c_func
(paren
id|device
)paren
op_assign
id|container
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Device &lt;%s&gt; bid &lt;%s&gt;&bslash;n&quot;
comma
"&bslash;"
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
id|acpi_device_bid
c_func
(paren
id|device
)paren
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_container_remove
id|acpi_container_remove
c_func
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_struct
id|acpi_container
op_star
id|pc
op_assign
l_int|NULL
suffix:semicolon
id|pc
op_assign
(paren
r_struct
id|acpi_container
op_star
)paren
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pc
)paren
id|kfree
c_func
(paren
id|pc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_static
r_int
DECL|function|container_run_sbin_hotplug
id|container_run_sbin_hotplug
c_func
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_char
op_star
id|action
)paren
(brace
r_char
op_star
id|argv
(braket
l_int|3
)braket
comma
op_star
id|envp
(braket
l_int|6
)braket
comma
id|action_str
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
r_int
id|len
suffix:semicolon
r_char
id|pathname
(braket
id|ACPI_PATHNAME_MAX
)braket
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_char
op_star
id|container_str
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
id|ACPI_PATHNAME_MAX
comma
id|pathname
)brace
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;container_run_sbin_hotplug&quot;
)paren
suffix:semicolon
id|status
op_assign
id|acpi_get_name
c_func
(paren
id|device-&gt;handle
comma
id|ACPI_FULL_PATHNAME
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|len
op_assign
id|strlen
c_func
(paren
l_string|&quot;CONTAINER=&quot;
)paren
op_plus
id|strlen
c_func
(paren
id|pathname
)paren
op_plus
l_int|1
suffix:semicolon
id|container_str
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|container_str
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sprintf
c_func
(paren
id|container_str
comma
l_string|&quot;CONTAINER=%s&quot;
comma
id|pathname
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|action_str
comma
l_string|&quot;ACTION=%s&quot;
comma
id|action
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|argv
(braket
id|i
op_increment
)braket
op_assign
id|hotplug_path
suffix:semicolon
id|argv
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;container&quot;
suffix:semicolon
id|argv
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
id|envp
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;HOME=/&quot;
suffix:semicolon
id|envp
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;PATH=/sbin;/bin;/usr/sbin;/usr/bin&quot;
suffix:semicolon
id|envp
(braket
id|i
op_increment
)braket
op_assign
id|action_str
suffix:semicolon
id|envp
(braket
id|i
op_increment
)braket
op_assign
id|container_str
suffix:semicolon
id|envp
(braket
id|i
op_increment
)braket
op_assign
l_string|&quot;PLATFORM=ACPI&quot;
suffix:semicolon
id|envp
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|ret
op_assign
id|call_usermodehelper
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
id|argv
comma
id|envp
comma
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|container_str
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|container_device_add
id|container_device_add
c_func
(paren
r_struct
id|acpi_device
op_star
op_star
id|device
comma
id|acpi_handle
id|handle
)paren
(brace
id|acpi_handle
id|phandle
suffix:semicolon
r_struct
id|acpi_device
op_star
id|pdev
suffix:semicolon
r_int
id|result
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;container_device_add&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_get_parent
c_func
(paren
id|handle
comma
op_amp
id|phandle
)paren
)paren
(brace
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_bus_get_device
c_func
(paren
id|phandle
comma
op_amp
id|pdev
)paren
)paren
(brace
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_bus_add
c_func
(paren
id|device
comma
id|pdev
comma
id|handle
comma
id|ACPI_BUS_TYPE_DEVICE
)paren
)paren
(brace
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|result
op_assign
id|acpi_bus_scan
c_func
(paren
op_star
id|device
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|container_notify_cb
id|container_notify_cb
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|type
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|acpi_device
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|present
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;container_notify_cb&quot;
)paren
suffix:semicolon
id|present
op_assign
id|is_device_present
c_func
(paren
id|handle
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ACPI_NOTIFY_BUS_CHECK
suffix:colon
multiline_comment|/* Fall through */
r_case
id|ACPI_NOTIFY_DEVICE_CHECK
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Container driver received %s event&bslash;n&quot;
comma
(paren
id|type
op_eq
id|ACPI_NOTIFY_BUS_CHECK
)paren
ques
c_cond
l_string|&quot;ACPI_NOTIFY_BUS_CHECK&quot;
suffix:colon
l_string|&quot;ACPI_NOTIFY_DEVICE_CHECK&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|present
)paren
(brace
id|status
op_assign
id|acpi_bus_get_device
c_func
(paren
id|handle
comma
op_amp
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
op_logical_or
op_logical_neg
id|device
)paren
(brace
id|result
op_assign
id|container_device_add
c_func
(paren
op_amp
id|device
comma
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|container_run_sbin_hotplug
c_func
(paren
id|device
comma
l_string|&quot;add&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* device exist and this is a remove request */
id|container_run_sbin_hotplug
c_func
(paren
id|device
comma
l_string|&quot;remove&quot;
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_case
id|ACPI_NOTIFY_EJECT_REQUEST
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|acpi_bus_get_device
c_func
(paren
id|handle
comma
op_amp
id|device
)paren
op_logical_and
id|device
)paren
(brace
id|container_run_sbin_hotplug
c_func
(paren
id|device
comma
l_string|&quot;remove&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|return_VOID
suffix:semicolon
)brace
r_static
id|acpi_status
DECL|function|container_walk_namespace_cb
id|container_walk_namespace_cb
c_func
(paren
id|acpi_handle
id|handle
comma
id|u32
id|lvl
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|rv
)paren
(brace
r_char
op_star
id|hid
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
id|ACPI_ALLOCATE_BUFFER
comma
l_int|NULL
)brace
suffix:semicolon
r_struct
id|acpi_device_info
op_star
id|info
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_int
op_star
id|action
op_assign
id|context
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;container_walk_namespace_cb&quot;
)paren
suffix:semicolon
id|status
op_assign
id|acpi_get_object_info
c_func
(paren
id|handle
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
op_logical_or
op_logical_neg
id|buffer.pointer
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|info
op_assign
id|buffer.pointer
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;valid
op_amp
id|ACPI_VALID_HID
)paren
id|hid
op_assign
id|info-&gt;hardware_id.value
suffix:semicolon
r_if
c_cond
(paren
id|hid
op_eq
l_int|NULL
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|hid
comma
l_string|&quot;ACPI0004&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|hid
comma
l_string|&quot;PNP0A05&quot;
)paren
op_logical_and
id|strcmp
c_func
(paren
id|hid
comma
l_string|&quot;PNP0A06&quot;
)paren
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
r_switch
c_cond
(paren
op_star
id|action
)paren
(brace
r_case
id|INSTALL_NOTIFY_HANDLER
suffix:colon
id|acpi_install_notify_handler
c_func
(paren
id|handle
comma
id|ACPI_SYSTEM_NOTIFY
comma
id|container_notify_cb
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|UNINSTALL_NOTIFY_HANDLER
suffix:colon
id|acpi_remove_notify_handler
c_func
(paren
id|handle
comma
id|ACPI_SYSTEM_NOTIFY
comma
id|container_notify_cb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|end
suffix:colon
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_int
id|__init
DECL|function|acpi_container_init
id|acpi_container_init
c_func
(paren
r_void
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|action
op_assign
id|INSTALL_NOTIFY_HANDLER
suffix:semicolon
id|result
op_assign
id|acpi_bus_register_driver
c_func
(paren
op_amp
id|acpi_container_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* register notify handler to every container device */
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_DEVICE
comma
id|ACPI_ROOT_OBJECT
comma
id|ACPI_UINT32_MAX
comma
id|container_walk_namespace_cb
comma
op_amp
id|action
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
id|__exit
DECL|function|acpi_container_exit
id|acpi_container_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|action
op_assign
id|UNINSTALL_NOTIFY_HANDLER
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_container_exit&quot;
)paren
suffix:semicolon
id|acpi_walk_namespace
c_func
(paren
id|ACPI_TYPE_DEVICE
comma
id|ACPI_ROOT_OBJECT
comma
id|ACPI_UINT32_MAX
comma
id|container_walk_namespace_cb
comma
op_amp
id|action
comma
l_int|NULL
)paren
suffix:semicolon
id|acpi_bus_unregister_driver
c_func
(paren
op_amp
id|acpi_container_driver
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
DECL|variable|acpi_container_init
id|module_init
c_func
(paren
id|acpi_container_init
)paren
suffix:semicolon
DECL|variable|acpi_container_exit
id|module_exit
c_func
(paren
id|acpi_container_exit
)paren
suffix:semicolon
eof
