multiline_comment|/*&n; *  acpi_thermal.c - ACPI Thermal Zone Driver ($Revision: 39 $)&n; *&n; *  Copyright (C) 2001, 2002 Andy Grover &lt;andrew.grover@intel.com&gt;&n; *  Copyright (C) 2001, 2002 Paul Diefenbaugh &lt;paul.s.diefenbaugh@intel.com&gt;&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or (at&n; *  your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but&n; *  WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *  General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; *  This driver fully implements the ACPI thermal policy as described in the&n; *  ACPI 2.0 Specification.&n; *&n; *  TBD: 1. Implement passive cooling hysteresis.&n; *       2. Enhance passive cooling (CPU) states/limit interface to support&n; *          concepts of &squot;multiple limiters&squot;, upper/lower limits, etc.&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &quot;acpi_bus.h&quot;
macro_line|#include &quot;acpi_drivers.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_THERMAL_COMPONENT
id|ACPI_MODULE_NAME
(paren
l_string|&quot;acpi_thermal&quot;
)paren
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Paul Diefenbaugh&quot;
)paren
suffix:semicolon
DECL|variable|ACPI_THERMAL_DRIVER_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|ACPI_THERMAL_DRIVER_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|tzp
r_static
r_int
id|tzp
op_assign
l_int|0
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|tzp
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|tzp
comma
l_string|&quot;Thermal zone polling frequency, in 1/10 seconds.&bslash;n&quot;
)paren
suffix:semicolon
DECL|macro|PREFIX
mdefine_line|#define PREFIX&t;&t;&t;&quot;ACPI: &quot;
DECL|macro|ACPI_THERMAL_MAX_ACTIVE
mdefine_line|#define ACPI_THERMAL_MAX_ACTIVE&t;10
DECL|macro|KELVIN_TO_CELSIUS
mdefine_line|#define KELVIN_TO_CELSIUS(t)&t;((t-2732+5)/10)
r_static
r_int
id|acpi_thermal_add
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
suffix:semicolon
r_static
r_int
id|acpi_thermal_remove
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
suffix:semicolon
DECL|variable|acpi_thermal_driver
r_static
r_struct
id|acpi_driver
id|acpi_thermal_driver
op_assign
(brace
id|name
suffix:colon
id|ACPI_THERMAL_DRIVER_NAME
comma
r_class
suffix:colon
id|ACPI_THERMAL_CLASS
comma
id|ids
suffix:colon
id|ACPI_THERMAL_HID
comma
id|ops
suffix:colon
(brace
id|add
suffix:colon
id|acpi_thermal_add
comma
id|remove
suffix:colon
id|acpi_thermal_remove
comma
)brace
comma
)brace
suffix:semicolon
DECL|struct|acpi_thermal_state
r_struct
id|acpi_thermal_state
(brace
DECL|member|critical
id|u8
id|critical
suffix:colon
l_int|1
suffix:semicolon
DECL|member|hot
id|u8
id|hot
suffix:colon
l_int|1
suffix:semicolon
DECL|member|passive
id|u8
id|passive
suffix:colon
l_int|1
suffix:semicolon
DECL|member|active
id|u8
id|active
suffix:colon
l_int|1
suffix:semicolon
DECL|member|reserved
id|u8
id|reserved
suffix:colon
l_int|4
suffix:semicolon
DECL|member|active_index
r_int
id|active_index
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_thermal_state_flags
r_struct
id|acpi_thermal_state_flags
(brace
DECL|member|valid
id|u8
id|valid
suffix:colon
l_int|1
suffix:semicolon
DECL|member|enabled
id|u8
id|enabled
suffix:colon
l_int|1
suffix:semicolon
DECL|member|reserved
id|u8
id|reserved
suffix:colon
l_int|6
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_thermal_critical
r_struct
id|acpi_thermal_critical
(brace
DECL|member|flags
r_struct
id|acpi_thermal_state_flags
id|flags
suffix:semicolon
DECL|member|temperature
r_int
r_int
id|temperature
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_thermal_hot
r_struct
id|acpi_thermal_hot
(brace
DECL|member|flags
r_struct
id|acpi_thermal_state_flags
id|flags
suffix:semicolon
DECL|member|temperature
r_int
r_int
id|temperature
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_thermal_passive
r_struct
id|acpi_thermal_passive
(brace
DECL|member|flags
r_struct
id|acpi_thermal_state_flags
id|flags
suffix:semicolon
DECL|member|temperature
r_int
r_int
id|temperature
suffix:semicolon
DECL|member|tc1
r_int
r_int
id|tc1
suffix:semicolon
DECL|member|tc2
r_int
r_int
id|tc2
suffix:semicolon
DECL|member|tsp
r_int
r_int
id|tsp
suffix:semicolon
DECL|member|devices
r_struct
id|acpi_handle_list
id|devices
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_thermal_active
r_struct
id|acpi_thermal_active
(brace
DECL|member|flags
r_struct
id|acpi_thermal_state_flags
id|flags
suffix:semicolon
DECL|member|temperature
r_int
r_int
id|temperature
suffix:semicolon
DECL|member|devices
r_struct
id|acpi_handle_list
id|devices
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_thermal_trips
r_struct
id|acpi_thermal_trips
(brace
DECL|member|critical
r_struct
id|acpi_thermal_critical
id|critical
suffix:semicolon
DECL|member|hot
r_struct
id|acpi_thermal_hot
id|hot
suffix:semicolon
DECL|member|passive
r_struct
id|acpi_thermal_passive
id|passive
suffix:semicolon
DECL|member|active
r_struct
id|acpi_thermal_active
id|active
(braket
id|ACPI_THERMAL_MAX_ACTIVE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_thermal_flags
r_struct
id|acpi_thermal_flags
(brace
DECL|member|cooling_mode
id|u8
id|cooling_mode
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* _SCP */
DECL|member|devices
id|u8
id|devices
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* _TZD */
DECL|member|reserved
id|u8
id|reserved
suffix:colon
l_int|6
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_thermal
r_struct
id|acpi_thermal
(brace
DECL|member|handle
id|acpi_handle
id|handle
suffix:semicolon
DECL|member|name
id|acpi_bus_id
id|name
suffix:semicolon
DECL|member|temperature
r_int
r_int
id|temperature
suffix:semicolon
DECL|member|last_temperature
r_int
r_int
id|last_temperature
suffix:semicolon
DECL|member|polling_frequency
r_int
r_int
id|polling_frequency
suffix:semicolon
DECL|member|cooling_mode
id|u8
id|cooling_mode
suffix:semicolon
DECL|member|flags
r_struct
id|acpi_thermal_flags
id|flags
suffix:semicolon
DECL|member|state
r_struct
id|acpi_thermal_state
id|state
suffix:semicolon
DECL|member|trips
r_struct
id|acpi_thermal_trips
id|trips
suffix:semicolon
DECL|member|devices
r_struct
id|acpi_handle_list
id|devices
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------&n;                             Thermal Zone Management&n;   -------------------------------------------------------------------------- */
r_static
r_int
DECL|function|acpi_thermal_get_temperature
id|acpi_thermal_get_temperature
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_get_temperature&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tz-&gt;last_temperature
op_assign
id|tz-&gt;temperature
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_TMP&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;temperature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Temperature is %lu dK&bslash;n&quot;
comma
id|tz-&gt;temperature
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_get_polling_frequency
id|acpi_thermal_get_polling_frequency
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_get_polling_frequency&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_TZP&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;polling_frequency
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Polling frequency is %lu dS&bslash;n&quot;
comma
id|tz-&gt;polling_frequency
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_set_polling
id|acpi_thermal_set_polling
(paren
r_struct
id|acpi_thermal
op_star
id|tz
comma
r_int
id|seconds
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_set_polling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tz-&gt;polling_frequency
op_assign
id|seconds
op_star
l_int|10
suffix:semicolon
multiline_comment|/* Convert value to deci-seconds */
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Polling frequency set to %lu seconds&bslash;n&quot;
comma
id|tz-&gt;polling_frequency
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_set_cooling_mode
id|acpi_thermal_set_cooling_mode
(paren
r_struct
id|acpi_thermal
op_star
id|tz
comma
r_int
id|mode
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_object
id|arg0
op_assign
(brace
id|ACPI_TYPE_INTEGER
)brace
suffix:semicolon
id|acpi_object_list
id|arg_list
op_assign
(brace
l_int|1
comma
op_amp
id|arg0
)brace
suffix:semicolon
id|acpi_handle
id|handle
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_set_cooling_mode&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|status
op_assign
id|acpi_get_handle
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_SCP&quot;
comma
op_amp
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;_SCP not present&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|arg0.integer.value
op_assign
id|mode
suffix:semicolon
id|status
op_assign
id|acpi_evaluate
c_func
(paren
id|handle
comma
l_int|NULL
comma
op_amp
id|arg_list
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|tz-&gt;cooling_mode
op_assign
id|mode
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Cooling mode [%s]&bslash;n&quot;
comma
id|mode
ques
c_cond
l_string|&quot;passive&quot;
suffix:colon
l_string|&quot;active&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_get_trip_points
id|acpi_thermal_get_trip_points
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_get_trip_points&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* Critical Shutdown (required) */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_CRT&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.critical.temperature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|tz-&gt;trips.critical.flags.valid
op_assign
l_int|0
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;No critical threshold&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
id|tz-&gt;trips.critical.flags.valid
op_assign
l_int|1
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found critical threshold [%lu]&bslash;n&quot;
comma
id|tz-&gt;trips.critical.temperature
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Critical Sleep (optional) */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_HOT&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.hot.temperature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|tz-&gt;trips.hot.flags.valid
op_assign
l_int|0
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;No hot threshold&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tz-&gt;trips.hot.flags.valid
op_assign
l_int|1
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found hot threshold [%lu]&bslash;n&quot;
comma
id|tz-&gt;trips.hot.temperature
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Passive: Processors (optional) */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_PSV&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.passive.temperature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|tz-&gt;trips.passive.flags.valid
op_assign
l_int|0
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;No passive threshold&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tz-&gt;trips.passive.flags.valid
op_assign
l_int|1
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_TC1&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.passive.tc1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|tz-&gt;trips.passive.flags.valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_TC2&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.passive.tc2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|tz-&gt;trips.passive.flags.valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_TSP&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.passive.tsp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|tz-&gt;trips.passive.flags.valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_reference
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_PSL&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.passive.devices
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|tz-&gt;trips.passive.flags.valid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz-&gt;trips.passive.flags.valid
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Invalid passive threshold&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_else
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found passive threshold [%lu]&bslash;n&quot;
comma
id|tz-&gt;trips.passive.temperature
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Active: Fans, etc. (optional) */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_THERMAL_MAX_ACTIVE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|name
(braket
l_int|5
)braket
op_assign
(brace
l_char|&squot;_&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;C&squot;
comma
(paren
l_char|&squot;0&squot;
op_plus
id|i
)paren
comma
l_char|&squot;&bslash;0&squot;
)brace
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|tz-&gt;handle
comma
id|name
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|temperature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
r_break
suffix:semicolon
id|name
(braket
l_int|2
)braket
op_assign
l_char|&squot;L&squot;
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_reference
c_func
(paren
id|tz-&gt;handle
comma
id|name
comma
l_int|NULL
comma
op_amp
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|devices
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|flags.valid
op_assign
l_int|1
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found active threshold [%d]:[%lu]&bslash;n&quot;
comma
id|i
comma
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|temperature
)paren
)paren
suffix:semicolon
)brace
r_else
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid active threshold [%d]&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_get_devices
id|acpi_thermal_get_devices
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_get_devices&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|status
op_assign
id|acpi_evaluate_reference
c_func
(paren
id|tz-&gt;handle
comma
l_string|&quot;_TZD&quot;
comma
l_int|NULL
comma
op_amp
id|tz-&gt;devices
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_call_usermode
id|acpi_thermal_call_usermode
(paren
r_char
op_star
id|path
)paren
(brace
r_char
op_star
id|argv
(braket
l_int|2
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
r_char
op_star
id|envp
(braket
l_int|3
)braket
op_assign
(brace
l_int|NULL
comma
l_int|NULL
comma
l_int|NULL
)brace
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_call_usermode&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
suffix:semicolon
id|argv
(braket
l_int|0
)braket
op_assign
id|path
suffix:semicolon
multiline_comment|/* minimal command environment */
id|envp
(braket
l_int|0
)braket
op_assign
l_string|&quot;HOME=/&quot;
suffix:semicolon
id|envp
(braket
l_int|1
)braket
op_assign
l_string|&quot;PATH=/sbin:/bin:/usr/sbin:/usr/bin&quot;
suffix:semicolon
id|call_usermodehelper
c_func
(paren
id|argv
(braket
l_int|0
)braket
comma
id|argv
comma
id|envp
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_critical
id|acpi_thermal_critical
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_device
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_critical&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
op_logical_neg
id|tz-&gt;trips.critical.flags.valid
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;temperature
op_ge
id|tz-&gt;trips.critical.temperature
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Critical trip point&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tz-&gt;trips.critical.flags.enabled
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tz-&gt;trips.critical.flags.enabled
)paren
id|tz-&gt;trips.critical.flags.enabled
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|acpi_bus_get_device
c_func
(paren
id|tz-&gt;handle
comma
op_amp
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
id|acpi_bus_generate_event
c_func
(paren
id|device
comma
id|ACPI_THERMAL_NOTIFY_CRITICAL
comma
id|tz-&gt;trips.critical.flags.enabled
)paren
suffix:semicolon
id|acpi_thermal_call_usermode
c_func
(paren
id|ACPI_THERMAL_PATH_POWEROFF
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_hot
id|acpi_thermal_hot
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_device
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_hot&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
op_logical_neg
id|tz-&gt;trips.hot.flags.valid
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;temperature
op_ge
id|tz-&gt;trips.hot.temperature
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Hot trip point&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|tz-&gt;trips.hot.flags.enabled
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tz-&gt;trips.hot.flags.enabled
)paren
id|tz-&gt;trips.hot.flags.enabled
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|acpi_bus_get_device
c_func
(paren
id|tz-&gt;handle
comma
op_amp
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
id|acpi_bus_generate_event
c_func
(paren
id|device
comma
id|ACPI_THERMAL_NOTIFY_HOT
comma
id|tz-&gt;trips.hot.flags.enabled
)paren
suffix:semicolon
multiline_comment|/* TBD: Call user-mode &quot;sleep(S4)&quot; function */
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_passive
id|acpi_thermal_passive
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_thermal_passive
op_star
id|passive
op_assign
l_int|NULL
suffix:semicolon
r_int
id|trend
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_passive&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
op_logical_neg
id|tz-&gt;trips.passive.flags.valid
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|passive
op_assign
op_amp
(paren
id|tz-&gt;trips.passive
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Above Trip?&n;&t; * -----------&n;&t; * Calculate the thermal trend (using the passive cooling equation)&n;&t; * and modify the performance limit for all passive cooling devices&n;&t; * accordingly.  Note that we assume symmetry.&n;&t; */
r_if
c_cond
(paren
id|tz-&gt;temperature
op_ge
id|passive-&gt;temperature
)paren
(brace
id|trend
op_assign
(paren
id|passive-&gt;tc1
op_star
(paren
id|tz-&gt;temperature
op_minus
id|tz-&gt;last_temperature
)paren
)paren
op_plus
(paren
id|passive-&gt;tc2
op_star
(paren
id|tz-&gt;temperature
op_minus
id|passive-&gt;temperature
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;trend[%d]=(tc1[%lu]*(tmp[%lu]-last[%lu]))+(tc2[%lu]*(tmp[%lu]-psv[%lu]))&bslash;n&quot;
comma
id|trend
comma
id|passive-&gt;tc1
comma
id|tz-&gt;temperature
comma
id|tz-&gt;last_temperature
comma
id|passive-&gt;tc2
comma
id|tz-&gt;temperature
comma
id|passive-&gt;temperature
)paren
)paren
suffix:semicolon
multiline_comment|/* Heating up? */
r_if
c_cond
(paren
id|trend
OG
l_int|0
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|passive-&gt;devices.count
suffix:semicolon
id|i
op_increment
)paren
id|acpi_processor_set_thermal_limit
c_func
(paren
id|passive-&gt;devices.handles
(braket
id|i
)braket
comma
id|ACPI_PROCESSOR_LIMIT_INCREMENT
)paren
suffix:semicolon
multiline_comment|/* Cooling off? */
r_else
r_if
c_cond
(paren
id|trend
OL
l_int|0
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|passive-&gt;devices.count
suffix:semicolon
id|i
op_increment
)paren
id|acpi_processor_set_thermal_limit
c_func
(paren
id|passive-&gt;devices.handles
(braket
id|i
)braket
comma
id|ACPI_PROCESSOR_LIMIT_DECREMENT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Below Trip?&n;&t; * -----------&n;&t; * Implement passive cooling hysteresis to slowly increase performance&n;&t; * and avoid thrashing around the passive trip point.  Note that we&n;&t; * assume symmetry.&n;&t; */
r_else
r_if
c_cond
(paren
id|tz-&gt;trips.passive.flags.enabled
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|passive-&gt;devices.count
suffix:semicolon
id|i
op_increment
)paren
id|result
op_assign
id|acpi_processor_set_thermal_limit
c_func
(paren
id|passive-&gt;devices.handles
(braket
id|i
)braket
comma
id|ACPI_PROCESSOR_LIMIT_DECREMENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|1
)paren
(brace
id|tz-&gt;trips.passive.flags.enabled
op_assign
l_int|0
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Disabling passive cooling (zone is cool)&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_active
id|acpi_thermal_active
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_thermal_active
op_star
id|active
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|j
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_active&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_THERMAL_MAX_ACTIVE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|active
op_assign
op_amp
(paren
id|tz-&gt;trips.active
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|active
op_logical_or
op_logical_neg
id|active-&gt;flags.valid
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Above Threshold?&n;&t;&t; * ----------------&n;&t;&t; * If not already enabled, turn ON all cooling devices&n;&t;&t; * associated with this active threshold.&n;&t;&t; */
r_if
c_cond
(paren
id|tz-&gt;temperature
op_ge
id|active-&gt;temperature
)paren
(brace
id|tz-&gt;state.active_index
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|active-&gt;flags.enabled
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|active-&gt;devices.count
suffix:semicolon
id|j
op_increment
)paren
(brace
id|result
op_assign
id|acpi_bus_set_power
c_func
(paren
id|active-&gt;devices.handles
(braket
id|j
)braket
comma
id|ACPI_STATE_D0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to turn cooling device [%p] &squot;on&squot;&bslash;n&quot;
comma
id|active-&gt;devices.handles
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|active-&gt;flags.enabled
op_assign
l_int|1
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Cooling device [%p] now &squot;on&squot;&bslash;n&quot;
comma
id|active-&gt;devices.handles
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t;&t; * Below Threshold?&n;&t;&t; * ----------------&n;&t;&t; * Turn OFF all cooling devices associated with this&n;&t;&t; * threshold.&n;&t;&t; */
r_else
r_if
c_cond
(paren
id|active-&gt;flags.enabled
)paren
(brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|active-&gt;devices.count
suffix:semicolon
id|j
op_increment
)paren
(brace
id|result
op_assign
id|acpi_bus_set_power
c_func
(paren
id|active-&gt;devices.handles
(braket
id|j
)braket
comma
id|ACPI_STATE_D3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to turn cooling device [%p] &squot;off&squot;&bslash;n&quot;
comma
id|active-&gt;devices.handles
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|active-&gt;flags.enabled
op_assign
l_int|0
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Cooling device [%p] now &squot;off&squot;&bslash;n&quot;
comma
id|active-&gt;devices.handles
(braket
id|j
)braket
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
id|acpi_thermal_check
(paren
r_void
op_star
id|context
)paren
suffix:semicolon
r_static
r_void
DECL|function|acpi_thermal_run
id|acpi_thermal_run
(paren
r_int
r_int
id|data
)paren
(brace
id|acpi_os_queue_for_execution
c_func
(paren
id|OSD_PRIORITY_GPE
comma
id|acpi_thermal_check
comma
(paren
r_void
op_star
)paren
id|data
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|acpi_thermal_check
id|acpi_thermal_check
(paren
r_void
op_star
id|data
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|sleep_time
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_check&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid (NULL) context.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
id|result
op_assign
id|acpi_thermal_get_temperature
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VOID
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tz-&gt;state
comma
l_int|0
comma
r_sizeof
(paren
id|tz-&gt;state
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check Trip Points&n;&t; * -----------------&n;&t; * Compare the current temperature to the trip point values to see&n;&t; * if we&squot;ve entered one of the thermal policy states.  Note that&n;&t; * this function determines when a state is entered, but the &n;&t; * individual policy decides when it is exited (e.g. hysteresis).&n;&t; */
r_if
c_cond
(paren
(paren
id|tz-&gt;trips.critical.flags.valid
)paren
op_logical_and
(paren
id|tz-&gt;temperature
op_ge
id|tz-&gt;trips.critical.temperature
)paren
)paren
id|tz-&gt;trips.critical.flags.enabled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tz-&gt;trips.hot.flags.valid
)paren
op_logical_and
(paren
id|tz-&gt;temperature
op_ge
id|tz-&gt;trips.hot.temperature
)paren
)paren
id|tz-&gt;trips.hot.flags.enabled
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tz-&gt;trips.passive.flags.valid
)paren
op_logical_and
(paren
id|tz-&gt;temperature
op_ge
id|tz-&gt;trips.passive.temperature
)paren
)paren
id|tz-&gt;trips.passive.flags.enabled
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_THERMAL_MAX_ACTIVE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|flags.valid
)paren
op_logical_and
(paren
id|tz-&gt;temperature
op_ge
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|temperature
)paren
)paren
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|flags.enabled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Invoke Policy&n;&t; * -------------&n;&t; * Separated from the above check to allow individual policy to &n;&t; * determine when to exit a given state.&n;&t; */
r_if
c_cond
(paren
id|tz-&gt;trips.critical.flags.enabled
)paren
id|acpi_thermal_critical
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;trips.hot.flags.enabled
)paren
id|acpi_thermal_hot
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;trips.passive.flags.enabled
)paren
id|acpi_thermal_passive
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;trips.active
(braket
l_int|0
)braket
dot
id|flags.enabled
)paren
id|acpi_thermal_active
c_func
(paren
id|tz
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Calculate State&n;&t; * ---------------&n;&t; * Again, separated from the above two to allow independent policy&n;&t; * decisions.&n;&t; */
r_if
c_cond
(paren
id|tz-&gt;trips.critical.flags.enabled
)paren
id|tz-&gt;state.critical
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;trips.hot.flags.enabled
)paren
id|tz-&gt;state.hot
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;trips.passive.flags.enabled
)paren
id|tz-&gt;state.passive
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_THERMAL_MAX_ACTIVE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|flags.enabled
)paren
id|tz-&gt;state.active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Calculate Sleep Time&n;&t; * --------------------&n;&t; * If we&squot;re in the passive state, use _TSP&squot;s value.  Otherwise&n;&t; * use the default polling frequency (e.g. _TZP).  If no polling&n;&t; * frequency is specified then we&squot;ll wait forever (at least until&n;&t; * a thermal event occurs).  Note that _TSP and _TZD values are&n;&t; * given in 1/10th seconds (we must covert to milliseconds).&n;&t; */
r_if
c_cond
(paren
id|tz-&gt;state.passive
)paren
id|sleep_time
op_assign
id|tz-&gt;trips.passive.tsp
op_star
l_int|100
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tz-&gt;polling_frequency
OG
l_int|0
)paren
id|sleep_time
op_assign
id|tz-&gt;polling_frequency
op_star
l_int|100
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;%s: temperature[%lu] sleep[%lu]&bslash;n&quot;
comma
id|tz-&gt;name
comma
id|tz-&gt;temperature
comma
id|sleep_time
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Schedule Next Poll&n;&t; * ------------------&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|sleep_time
)paren
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
(paren
id|tz-&gt;timer
)paren
)paren
)paren
id|del_timer
c_func
(paren
op_amp
(paren
id|tz-&gt;timer
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
(paren
id|tz-&gt;timer
)paren
)paren
)paren
id|mod_timer
c_func
(paren
op_amp
(paren
id|tz-&gt;timer
)paren
comma
(paren
id|HZ
op_star
id|sleep_time
)paren
op_div
l_int|1000
)paren
suffix:semicolon
r_else
(brace
id|tz-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|tz
suffix:semicolon
id|tz-&gt;timer.function
op_assign
id|acpi_thermal_run
suffix:semicolon
id|tz-&gt;timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
id|sleep_time
)paren
op_div
l_int|1000
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
(paren
id|tz-&gt;timer
)paren
)paren
suffix:semicolon
)brace
)brace
id|return_VOID
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                              FS Interface (/proc)&n;   -------------------------------------------------------------------------- */
DECL|variable|acpi_thermal_dir
r_struct
id|proc_dir_entry
op_star
id|acpi_thermal_dir
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
DECL|function|acpi_thermal_read_state
id|acpi_thermal_read_state
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_read_state&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
(paren
id|off
op_ne
l_int|0
)paren
)paren
r_goto
id|end
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;state:                   &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz-&gt;state.critical
op_logical_and
op_logical_neg
id|tz-&gt;state.hot
op_logical_and
op_logical_neg
id|tz-&gt;state.passive
op_logical_and
op_logical_neg
id|tz-&gt;state.active
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;ok&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|tz-&gt;state.critical
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;critical &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;state.hot
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;hot &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;state.passive
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;passive &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;state.active
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;active[%d]&quot;
comma
id|tz-&gt;state.active_index
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|end
suffix:colon
id|len
op_assign
(paren
id|p
op_minus
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
id|return_VALUE
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_read_temperature
id|acpi_thermal_read_temperature
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_read_temperature&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
(paren
id|off
op_ne
l_int|0
)paren
)paren
r_goto
id|end
suffix:semicolon
id|result
op_assign
id|acpi_thermal_get_temperature
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;temperature:             %lu C&bslash;n&quot;
comma
id|KELVIN_TO_CELSIUS
c_func
(paren
id|tz-&gt;temperature
)paren
)paren
suffix:semicolon
id|end
suffix:colon
id|len
op_assign
(paren
id|p
op_minus
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
id|return_VALUE
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_read_trip_points
id|acpi_thermal_read_trip_points
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|j
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_read_trip_points&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
(paren
id|off
op_ne
l_int|0
)paren
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;trips.critical.flags.valid
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;critical (S5):           %lu C&bslash;n&quot;
comma
id|KELVIN_TO_CELSIUS
c_func
(paren
id|tz-&gt;trips.critical.temperature
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;trips.hot.flags.valid
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;hot (S4):                %lu C&bslash;n&quot;
comma
id|KELVIN_TO_CELSIUS
c_func
(paren
id|tz-&gt;trips.hot.temperature
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tz-&gt;trips.passive.flags.valid
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;passive:                 %lu C: tc1=%lu tc2=%lu tsp=%lu devices=&quot;
comma
id|KELVIN_TO_CELSIUS
c_func
(paren
id|tz-&gt;trips.passive.temperature
)paren
comma
id|tz-&gt;trips.passive.tc1
comma
id|tz-&gt;trips.passive.tc2
comma
id|tz-&gt;trips.passive.tsp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|tz-&gt;trips.passive.devices.count
suffix:semicolon
id|j
op_increment
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;0x%p &quot;
comma
id|tz-&gt;trips.passive.devices.handles
(braket
id|j
)braket
)paren
suffix:semicolon
)brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ACPI_THERMAL_MAX_ACTIVE
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|flags.valid
)paren
)paren
r_break
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;active[%d]:               %lu C: devices=&quot;
comma
id|i
comma
id|KELVIN_TO_CELSIUS
c_func
(paren
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|temperature
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|devices.count
suffix:semicolon
id|j
op_increment
)paren
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;0x%p &quot;
comma
id|tz-&gt;trips.active
(braket
id|i
)braket
dot
id|devices.handles
(braket
id|j
)braket
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|end
suffix:colon
id|len
op_assign
(paren
id|p
op_minus
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
id|return_VALUE
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_read_cooling_mode
id|acpi_thermal_read_cooling_mode
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_read_cooling_mode&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
(paren
id|off
op_ne
l_int|0
)paren
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz-&gt;flags.cooling_mode
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&lt;not supported&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;cooling mode:            %s&bslash;n&quot;
comma
id|tz-&gt;cooling_mode
ques
c_cond
l_string|&quot;passive&quot;
suffix:colon
l_string|&quot;active&quot;
)paren
suffix:semicolon
id|end
suffix:colon
id|len
op_assign
(paren
id|p
op_minus
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
id|return_VALUE
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_write_cooling_mode
id|acpi_thermal_write_cooling_mode
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_char
id|mode_string
(braket
l_int|12
)braket
op_assign
(brace
l_char|&squot;&bslash;0&squot;
)brace
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_write_cooling_mode&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
(paren
id|count
OG
r_sizeof
(paren
id|mode_string
)paren
op_minus
l_int|1
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz-&gt;flags.cooling_mode
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|mode_string
comma
id|buffer
comma
id|count
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|mode_string
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|result
op_assign
id|acpi_thermal_set_cooling_mode
c_func
(paren
id|tz
comma
id|simple_strtoul
c_func
(paren
id|mode_string
comma
l_int|NULL
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|count
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_read_polling
id|acpi_thermal_read_polling
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_char
op_star
id|p
op_assign
id|page
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_read_polling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
(paren
id|off
op_ne
l_int|0
)paren
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz-&gt;polling_frequency
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;&lt;polling disabled&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;polling frequency:       %lu seconds&bslash;n&quot;
comma
(paren
id|tz-&gt;polling_frequency
op_div
l_int|10
)paren
)paren
suffix:semicolon
id|end
suffix:colon
id|len
op_assign
(paren
id|p
op_minus
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
id|return_VALUE
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_write_polling
id|acpi_thermal_write_polling
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_char
id|polling_string
(braket
l_int|12
)braket
op_assign
(brace
l_char|&squot;&bslash;0&squot;
)brace
suffix:semicolon
r_int
id|seconds
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_write_polling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
op_logical_or
(paren
id|count
OG
r_sizeof
(paren
id|polling_string
)paren
op_minus
l_int|1
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|polling_string
comma
id|buffer
comma
id|count
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|polling_string
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|seconds
op_assign
id|simple_strtoul
c_func
(paren
id|polling_string
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|acpi_thermal_set_polling
c_func
(paren
id|tz
comma
id|seconds
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
id|acpi_thermal_check
c_func
(paren
id|tz
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|count
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_add_fs
id|acpi_thermal_add_fs
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|entry
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_add_fs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_thermal_dir
)paren
(brace
id|acpi_thermal_dir
op_assign
id|proc_mkdir
c_func
(paren
id|ACPI_THERMAL_CLASS
comma
id|acpi_root_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_thermal_dir
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
(brace
id|acpi_device_dir
c_func
(paren
id|device
)paren
op_assign
id|proc_mkdir
c_func
(paren
id|acpi_device_bid
c_func
(paren
id|device
)paren
comma
id|acpi_thermal_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;state&squot; [R] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_THERMAL_FILE_STATE
comma
id|S_IRUGO
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_THERMAL_FILE_STATE
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;read_proc
op_assign
id|acpi_thermal_read_state
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;temperature&squot; [R] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_THERMAL_FILE_TEMPERATURE
comma
id|S_IRUGO
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_THERMAL_FILE_TEMPERATURE
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;read_proc
op_assign
id|acpi_thermal_read_temperature
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;trip_points&squot; [R] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_THERMAL_FILE_TRIP_POINTS
comma
id|S_IRUGO
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_THERMAL_FILE_POLLING_FREQ
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;read_proc
op_assign
id|acpi_thermal_read_trip_points
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;cooling_mode&squot; [R/W] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_THERMAL_FILE_COOLING_MODE
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_THERMAL_FILE_COOLING_MODE
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;read_proc
op_assign
id|acpi_thermal_read_cooling_mode
suffix:semicolon
id|entry-&gt;write_proc
op_assign
id|acpi_thermal_write_cooling_mode
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;polling_frequency&squot; [R/W] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_THERMAL_FILE_POLLING_FREQ
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_THERMAL_FILE_POLLING_FREQ
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;read_proc
op_assign
id|acpi_thermal_read_polling
suffix:semicolon
id|entry-&gt;write_proc
op_assign
id|acpi_thermal_write_polling
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_remove_fs
id|acpi_thermal_remove_fs
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_remove_fs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_thermal_dir
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
id|remove_proc_entry
c_func
(paren
id|acpi_device_bid
c_func
(paren
id|device
)paren
comma
id|acpi_thermal_dir
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                                 Driver Interface&n;   -------------------------------------------------------------------------- */
r_static
r_void
DECL|function|acpi_thermal_notify
id|acpi_thermal_notify
(paren
id|acpi_handle
id|handle
comma
id|u32
id|event
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|data
suffix:semicolon
r_struct
id|acpi_device
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_notify&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VOID
suffix:semicolon
r_if
c_cond
(paren
id|acpi_bus_get_device
c_func
(paren
id|tz-&gt;handle
comma
op_amp
id|device
)paren
)paren
id|return_VOID
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|ACPI_THERMAL_NOTIFY_TEMPERATURE
suffix:colon
id|acpi_thermal_check
c_func
(paren
id|tz
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_THERMAL_NOTIFY_THRESHOLDS
suffix:colon
id|acpi_thermal_get_trip_points
c_func
(paren
id|tz
)paren
suffix:semicolon
id|acpi_thermal_check
c_func
(paren
id|tz
)paren
suffix:semicolon
id|acpi_bus_generate_event
c_func
(paren
id|device
comma
id|event
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_THERMAL_NOTIFY_DEVICES
suffix:colon
r_if
c_cond
(paren
id|tz-&gt;flags.devices
)paren
id|acpi_thermal_get_devices
c_func
(paren
id|tz
)paren
suffix:semicolon
id|acpi_bus_generate_event
c_func
(paren
id|device
comma
id|event
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Unsupported event [0x%x]&bslash;n&quot;
comma
id|event
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|return_VOID
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_get_info
id|acpi_thermal_get_info
(paren
r_struct
id|acpi_thermal
op_star
id|tz
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_get_info&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* Get temperature [_TMP] (required) */
id|result
op_assign
id|acpi_thermal_get_temperature
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
multiline_comment|/* Set the cooling mode [_SCP] to active cooling (default) */
id|result
op_assign
id|acpi_thermal_set_cooling_mode
c_func
(paren
id|tz
comma
id|ACPI_THERMAL_MODE_ACTIVE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|tz-&gt;flags.cooling_mode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Get trip points [_CRT, _PSV, etc.] (required) */
id|result
op_assign
id|acpi_thermal_get_trip_points
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
multiline_comment|/* Get default polling frequency [_TZP] (optional) */
r_if
c_cond
(paren
id|tzp
)paren
id|tz-&gt;polling_frequency
op_assign
id|tzp
suffix:semicolon
r_else
id|acpi_thermal_get_polling_frequency
c_func
(paren
id|tz
)paren
suffix:semicolon
multiline_comment|/* Get devices in this thermal zone [_TZD] (optional) */
id|result
op_assign
id|acpi_thermal_get_devices
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|tz-&gt;flags.devices
op_assign
l_int|1
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_add
id|acpi_thermal_add
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_add&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tz
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpi_thermal
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tz
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|tz
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_thermal
)paren
)paren
suffix:semicolon
id|tz-&gt;handle
op_assign
id|device-&gt;handle
suffix:semicolon
id|sprintf
c_func
(paren
id|tz-&gt;name
comma
l_string|&quot;%s&quot;
comma
id|device-&gt;pnp.bus_id
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
l_string|&quot;%s&quot;
comma
id|ACPI_THERMAL_DEVICE_NAME
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|acpi_device_class
c_func
(paren
id|device
)paren
comma
l_string|&quot;%s&quot;
comma
id|ACPI_THERMAL_CLASS
)paren
suffix:semicolon
id|acpi_driver_data
c_func
(paren
id|device
)paren
op_assign
id|tz
suffix:semicolon
id|result
op_assign
id|acpi_thermal_get_info
c_func
(paren
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
id|result
op_assign
id|acpi_thermal_add_fs
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
id|acpi_thermal_check
c_func
(paren
id|tz
)paren
suffix:semicolon
id|status
op_assign
id|acpi_install_notify_handler
c_func
(paren
id|tz-&gt;handle
comma
id|ACPI_DEVICE_NOTIFY
comma
id|acpi_thermal_notify
comma
id|tz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error installing notify handler&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|init_timer
c_func
(paren
op_amp
id|tz-&gt;timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;%s [%s] (%lu C)&bslash;n&quot;
comma
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
id|acpi_device_bid
c_func
(paren
id|device
)paren
comma
id|KELVIN_TO_CELSIUS
c_func
(paren
id|tz-&gt;temperature
)paren
)paren
suffix:semicolon
id|end
suffix:colon
r_if
c_cond
(paren
id|result
)paren
(brace
id|acpi_thermal_remove_fs
c_func
(paren
id|device
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tz
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_thermal_remove
id|acpi_thermal_remove
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_struct
id|acpi_thermal
op_star
id|tz
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_remove&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
op_logical_or
op_logical_neg
id|acpi_driver_data
c_func
(paren
id|device
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|tz
op_assign
(paren
r_struct
id|acpi_thermal
op_star
)paren
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
(paren
id|tz-&gt;timer
)paren
)paren
)paren
id|del_timer
c_func
(paren
op_amp
(paren
id|tz-&gt;timer
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_remove_notify_handler
c_func
(paren
id|tz-&gt;handle
comma
id|ACPI_DEVICE_NOTIFY
comma
id|acpi_thermal_notify
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error removing notify handler&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Terminate policy */
r_if
c_cond
(paren
id|tz-&gt;trips.passive.flags.valid
op_logical_and
id|tz-&gt;trips.passive.flags.enabled
)paren
(brace
id|tz-&gt;trips.passive.flags.enabled
op_assign
l_int|0
suffix:semicolon
id|acpi_thermal_passive
c_func
(paren
id|tz
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tz-&gt;trips.active
(braket
l_int|0
)braket
dot
id|flags.valid
op_logical_and
id|tz-&gt;trips.active
(braket
l_int|0
)braket
dot
id|flags.enabled
)paren
(brace
id|tz-&gt;trips.active
(braket
l_int|0
)braket
dot
id|flags.enabled
op_assign
l_int|0
suffix:semicolon
id|acpi_thermal_active
c_func
(paren
id|tz
)paren
suffix:semicolon
)brace
id|acpi_thermal_remove_fs
c_func
(paren
id|device
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_thermal_init
id|acpi_thermal_init
(paren
r_void
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_init&quot;
)paren
suffix:semicolon
id|result
op_assign
id|acpi_bus_register_driver
c_func
(paren
op_amp
id|acpi_thermal_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|acpi_thermal_exit
id|acpi_thermal_exit
(paren
r_void
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_thermal_exit&quot;
)paren
suffix:semicolon
id|result
op_assign
id|acpi_bus_unregister_driver
c_func
(paren
op_amp
id|acpi_thermal_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|remove_proc_entry
c_func
(paren
id|ACPI_THERMAL_CLASS
comma
id|acpi_root_dir
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
DECL|variable|acpi_thermal_init
id|module_init
c_func
(paren
id|acpi_thermal_init
)paren
suffix:semicolon
DECL|variable|acpi_thermal_exit
id|module_exit
c_func
(paren
id|acpi_thermal_exit
)paren
suffix:semicolon
eof
