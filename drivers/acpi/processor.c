multiline_comment|/*&n; * acpi_processor.c - ACPI Processor Driver ($Revision: 71 $)&n; *&n; *  Copyright (C) 2001, 2002 Andy Grover &lt;andrew.grover@intel.com&gt;&n; *  Copyright (C) 2001, 2002 Paul Diefenbaugh &lt;paul.s.diefenbaugh@intel.com&gt;&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or (at&n; *  your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but&n; *  WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *  General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *  TBD:&n; *&t;1. Make # power/performance states dynamic.&n; *&t;2. Support duty_cycle values that span bit 4.&n; *&t;3. Optimize by having scheduler determine business instead of&n; *&t;   having us try to calculate it here.&n; *&t;4. Need C1 timing -- must modify kernel (IRQ handler) to get this.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#include &lt;linux/compatmac.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;acpi/acpi_bus.h&gt;
macro_line|#include &lt;acpi/acpi_drivers.h&gt;
macro_line|#include &lt;acpi/processor.h&gt;
DECL|macro|ACPI_PROCESSOR_COMPONENT
mdefine_line|#define ACPI_PROCESSOR_COMPONENT&t;0x01000000
DECL|macro|ACPI_PROCESSOR_CLASS
mdefine_line|#define ACPI_PROCESSOR_CLASS&t;&t;&quot;processor&quot;
DECL|macro|ACPI_PROCESSOR_DRIVER_NAME
mdefine_line|#define ACPI_PROCESSOR_DRIVER_NAME&t;&quot;ACPI Processor Driver&quot;
DECL|macro|ACPI_PROCESSOR_DEVICE_NAME
mdefine_line|#define ACPI_PROCESSOR_DEVICE_NAME&t;&quot;Processor&quot;
DECL|macro|ACPI_PROCESSOR_FILE_INFO
mdefine_line|#define ACPI_PROCESSOR_FILE_INFO&t;&quot;info&quot;
DECL|macro|ACPI_PROCESSOR_FILE_POWER
mdefine_line|#define ACPI_PROCESSOR_FILE_POWER&t;&quot;power&quot;
DECL|macro|ACPI_PROCESSOR_FILE_PERFORMANCE
mdefine_line|#define ACPI_PROCESSOR_FILE_PERFORMANCE&t;&quot;performance&quot;
DECL|macro|ACPI_PROCESSOR_FILE_THROTTLING
mdefine_line|#define ACPI_PROCESSOR_FILE_THROTTLING&t;&quot;throttling&quot;
DECL|macro|ACPI_PROCESSOR_FILE_LIMIT
mdefine_line|#define ACPI_PROCESSOR_FILE_LIMIT&t;&quot;limit&quot;
DECL|macro|ACPI_PROCESSOR_NOTIFY_PERFORMANCE
mdefine_line|#define ACPI_PROCESSOR_NOTIFY_PERFORMANCE 0x80
DECL|macro|ACPI_PROCESSOR_NOTIFY_POWER
mdefine_line|#define ACPI_PROCESSOR_NOTIFY_POWER&t;0x81
DECL|macro|US_TO_PM_TIMER_TICKS
mdefine_line|#define US_TO_PM_TIMER_TICKS(t)&t;&t;((t * (PM_TIMER_FREQUENCY/1000)) / 1000)
DECL|macro|C2_OVERHEAD
mdefine_line|#define C2_OVERHEAD&t;&t;&t;4&t;/* 1us (3.579 ticks per us) */
DECL|macro|C3_OVERHEAD
mdefine_line|#define C3_OVERHEAD&t;&t;&t;4&t;/* 1us (3.579 ticks per us) */
DECL|variable|POWER_OF_2
r_const
id|u32
id|POWER_OF_2
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|4
comma
l_int|8
comma
l_int|16
comma
l_int|32
comma
l_int|64
)brace
suffix:semicolon
DECL|macro|ACPI_PROCESSOR_LIMIT_USER
mdefine_line|#define ACPI_PROCESSOR_LIMIT_USER&t;0
DECL|macro|ACPI_PROCESSOR_LIMIT_THERMAL
mdefine_line|#define ACPI_PROCESSOR_LIMIT_THERMAL&t;1
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_PROCESSOR_COMPONENT
id|ACPI_MODULE_NAME
(paren
l_string|&quot;acpi_processor&quot;
)paren
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Paul Diefenbaugh&quot;
)paren
suffix:semicolon
DECL|variable|ACPI_PROCESSOR_DRIVER_NAME
id|MODULE_DESCRIPTION
c_func
(paren
id|ACPI_PROCESSOR_DRIVER_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
r_static
r_int
id|acpi_processor_add
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
suffix:semicolon
r_static
r_int
id|acpi_processor_remove
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
suffix:semicolon
r_static
r_int
id|acpi_processor_info_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|acpi_processor_throttling_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|acpi_processor_power_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|acpi_processor_limit_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
DECL|variable|acpi_processor_driver
r_static
r_struct
id|acpi_driver
id|acpi_processor_driver
op_assign
(brace
dot
id|name
op_assign
id|ACPI_PROCESSOR_DRIVER_NAME
comma
dot
r_class
op_assign
id|ACPI_PROCESSOR_CLASS
comma
dot
id|ids
op_assign
id|ACPI_PROCESSOR_HID
comma
dot
id|ops
op_assign
(brace
dot
id|add
op_assign
id|acpi_processor_add
comma
dot
id|remove
op_assign
id|acpi_processor_remove
comma
)brace
comma
)brace
suffix:semicolon
DECL|struct|acpi_processor_errata
r_struct
id|acpi_processor_errata
(brace
DECL|member|smp
id|u8
id|smp
suffix:semicolon
r_struct
(brace
DECL|member|throttle
id|u8
id|throttle
suffix:colon
l_int|1
suffix:semicolon
DECL|member|fdma
id|u8
id|fdma
suffix:colon
l_int|1
suffix:semicolon
DECL|member|reserved
id|u8
id|reserved
suffix:colon
l_int|6
suffix:semicolon
DECL|member|bmisx
id|u32
id|bmisx
suffix:semicolon
DECL|member|piix4
)brace
id|piix4
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|acpi_processor_info_fops
r_static
r_struct
id|file_operations
id|acpi_processor_info_fops
op_assign
(brace
dot
id|open
op_assign
id|acpi_processor_info_open_fs
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|variable|acpi_processor_power_fops
r_static
r_struct
id|file_operations
id|acpi_processor_power_fops
op_assign
(brace
dot
id|open
op_assign
id|acpi_processor_power_open_fs
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|variable|acpi_processor_throttling_fops
r_static
r_struct
id|file_operations
id|acpi_processor_throttling_fops
op_assign
(brace
dot
id|open
op_assign
id|acpi_processor_throttling_open_fs
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|variable|acpi_processor_limit_fops
r_static
r_struct
id|file_operations
id|acpi_processor_limit_fops
op_assign
(brace
dot
id|open
op_assign
id|acpi_processor_limit_open_fs
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
DECL|variable|processors
r_static
r_struct
id|acpi_processor
op_star
id|processors
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|errata
r_static
r_struct
id|acpi_processor_errata
id|errata
suffix:semicolon
DECL|variable|pm_idle_save
r_static
r_void
(paren
op_star
id|pm_idle_save
)paren
(paren
r_void
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------&n;                                Errata Handling&n;   -------------------------------------------------------------------------- */
r_int
DECL|function|acpi_processor_errata_piix4
id|acpi_processor_errata_piix4
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|u8
id|rev
op_assign
l_int|0
suffix:semicolon
id|u8
id|value1
op_assign
l_int|0
suffix:semicolon
id|u8
id|value2
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_errata_piix4&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Note that &squot;dev&squot; references the PIIX4 ACPI Controller.&n;&t; */
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_REVISION_ID
comma
op_amp
id|rev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rev
)paren
(brace
r_case
l_int|0
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found PIIX4 A-step&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found PIIX4 B-step&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found PIIX4E&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found PIIX4M&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found unknown PIIX4&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|rev
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* PIIX4 A-step */
r_case
l_int|1
suffix:colon
multiline_comment|/* PIIX4 B-step */
multiline_comment|/*&n;&t;&t; * See specification changes #13 (&quot;Manual Throttle Duty Cycle&quot;)&n;&t;&t; * and #14 (&quot;Enabling and Disabling Manual Throttle&quot;), plus&n;&t;&t; * erratum #5 (&quot;STPCLK# Deassertion Time&quot;) from the January &n;&t;&t; * 2002 PIIX4 specification update.  Applies to only older &n;&t;&t; * PIIX4 models.&n;&t;&t; */
id|errata.piix4.throttle
op_assign
l_int|1
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* PIIX4E */
r_case
l_int|3
suffix:colon
multiline_comment|/* PIIX4M */
multiline_comment|/*&n;&t;&t; * See erratum #18 (&quot;C3 Power State/BMIDE and Type-F DMA &n;&t;&t; * Livelock&quot;) from the January 2002 PIIX4 specification update.&n;&t;&t; * Applies to all PIIX4 models.&n;&t;&t; */
multiline_comment|/* &n;&t;&t; * BM-IDE&n;&t;&t; * ------&n;&t;&t; * Find the PIIX4 IDE Controller and get the Bus Master IDE &n;&t;&t; * Status register address.  We&squot;ll use this later to read &n;&t;&t; * each IDE controller&squot;s DMA status to make sure we catch all&n;&t;&t; * DMA activity.&n;&t;&t; */
id|dev
op_assign
id|pci_find_subsys
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371AB
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
id|errata.piix4.bmisx
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* &n;&t;&t; * Type-F DMA&n;&t;&t; * ----------&n;&t;&t; * Find the PIIX4 ISA Controller and read the Motherboard&n;&t;&t; * DMA controller&squot;s status to see if Type-F (Fast) DMA mode&n;&t;&t; * is enabled (bit 7) on either channel.  Note that we&squot;ll &n;&t;&t; * disable C3 support if this is enabled, as some legacy &n;&t;&t; * devices won&squot;t operate well if fast DMA is disabled.&n;&t;&t; */
id|dev
op_assign
id|pci_find_subsys
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371AB_0
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x76
comma
op_amp
id|value1
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x77
comma
op_amp
id|value2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value1
op_amp
l_int|0x80
)paren
op_logical_or
(paren
id|value2
op_amp
l_int|0x80
)paren
)paren
id|errata.piix4.fdma
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|errata.piix4.bmisx
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Bus master activity detection (BM-IDE) erratum enabled&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errata.piix4.fdma
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Type-F DMA livelock erratum (C3 disabled)&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_int
DECL|function|acpi_processor_errata
id|acpi_processor_errata
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_errata&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * PIIX4&n;&t; */
id|dev
op_assign
id|pci_find_subsys
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371AB_3
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
id|result
op_assign
id|acpi_processor_errata_piix4
c_func
(paren
id|dev
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                                Power Management&n;   -------------------------------------------------------------------------- */
r_static
r_inline
id|u32
DECL|function|ticks_elapsed
id|ticks_elapsed
(paren
id|u32
id|t1
comma
id|u32
id|t2
)paren
(brace
r_if
c_cond
(paren
id|t2
op_ge
id|t1
)paren
r_return
(paren
id|t2
op_minus
id|t1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|acpi_fadt.tmr_val_ext
)paren
r_return
(paren
(paren
(paren
l_int|0x00FFFFFF
op_minus
id|t1
)paren
op_plus
id|t2
)paren
op_amp
l_int|0x00FFFFFF
)paren
suffix:semicolon
r_else
r_return
(paren
(paren
l_int|0xFFFFFFFF
op_minus
id|t1
)paren
op_plus
id|t2
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|acpi_processor_power_activate
id|acpi_processor_power_activate
(paren
r_struct
id|acpi_processor
op_star
id|pr
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
r_return
suffix:semicolon
id|pr-&gt;power.states
(braket
id|pr-&gt;power.state
)braket
dot
id|promotion.count
op_assign
l_int|0
suffix:semicolon
id|pr-&gt;power.states
(braket
id|pr-&gt;power.state
)braket
dot
id|demotion.count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Cleanup from old state. */
r_switch
c_cond
(paren
id|pr-&gt;power.state
)paren
(brace
r_case
id|ACPI_STATE_C3
suffix:colon
multiline_comment|/* Disable bus master reload */
id|acpi_set_register
c_func
(paren
id|ACPI_BITREG_BUS_MASTER_RLD
comma
l_int|0
comma
id|ACPI_MTX_DO_NOT_LOCK
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Prepare to use new state. */
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|ACPI_STATE_C3
suffix:colon
multiline_comment|/* Enable bus master reload */
id|acpi_set_register
c_func
(paren
id|ACPI_BITREG_BUS_MASTER_RLD
comma
l_int|1
comma
id|ACPI_MTX_DO_NOT_LOCK
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|pr-&gt;power.state
op_assign
id|state
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_void
DECL|function|acpi_processor_idle
id|acpi_processor_idle
(paren
r_void
)paren
(brace
r_struct
id|acpi_processor
op_star
id|pr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_processor_cx
op_star
id|cx
op_assign
l_int|NULL
suffix:semicolon
r_int
id|next_state
op_assign
l_int|0
suffix:semicolon
r_int
id|sleep_ticks
op_assign
l_int|0
suffix:semicolon
id|u32
id|t1
comma
id|t2
op_assign
l_int|0
suffix:semicolon
id|pr
op_assign
id|processors
(braket
id|smp_processor_id
c_func
(paren
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Interrupts must be disabled during bus mastering calculations and&n;&t; * for C2/C3 transitions.&n;&t; */
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|cx
op_assign
op_amp
(paren
id|pr-&gt;power.states
(braket
id|pr-&gt;power.state
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check BM Activity&n;&t; * -----------------&n;&t; * Check for bus mastering activity (if required), record, and check&n;&t; * for demotion.&n;&t; */
r_if
c_cond
(paren
id|pr-&gt;flags.bm_check
)paren
(brace
id|u32
id|bm_status
op_assign
l_int|0
suffix:semicolon
id|pr-&gt;power.bm_activity
op_lshift_assign
l_int|1
suffix:semicolon
id|acpi_get_register
c_func
(paren
id|ACPI_BITREG_BUS_MASTER_STATUS
comma
op_amp
id|bm_status
comma
id|ACPI_MTX_DO_NOT_LOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bm_status
)paren
(brace
id|pr-&gt;power.bm_activity
op_increment
suffix:semicolon
id|acpi_set_register
c_func
(paren
id|ACPI_BITREG_BUS_MASTER_STATUS
comma
l_int|1
comma
id|ACPI_MTX_DO_NOT_LOCK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * PIIX4 Erratum #18: Note that BM_STS doesn&squot;t always reflect&n;&t;&t; * the true state of bus mastering activity; forcing us to &n;&t;&t; * manually check the BMIDEA bit of each IDE channel.&n;&t;&t; */
r_else
r_if
c_cond
(paren
id|errata.piix4.bmisx
)paren
(brace
r_if
c_cond
(paren
(paren
id|inb_p
c_func
(paren
id|errata.piix4.bmisx
op_plus
l_int|0x02
)paren
op_amp
l_int|0x01
)paren
op_logical_or
(paren
id|inb_p
c_func
(paren
id|errata.piix4.bmisx
op_plus
l_int|0x0A
)paren
op_amp
l_int|0x01
)paren
)paren
id|pr-&gt;power.bm_activity
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Apply bus mastering demotion policy.  Automatically demote&n;&t;&t; * to avoid a faulty transition.  Note that the processor &n;&t;&t; * won&squot;t enter a low-power state during this call (to this &n;&t;&t; * funciton) but should upon the next.&n;&t;&t; *&n;&t;&t; * TBD: A better policy might be to fallback to the demotion &n;&t;&t; *      state (use it for this quantum only) istead of &n;&t;&t; *      demoting -- and rely on duration as our sole demotion&n;&t;&t; *      qualification.  This may, however, introduce DMA &n;&t;&t; *      issues (e.g. floppy DMA transfer overrun/underrun).&n;&t;&t; */
r_if
c_cond
(paren
id|pr-&gt;power.bm_activity
op_amp
id|cx-&gt;demotion.threshold.bm
)paren
(brace
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|next_state
op_assign
id|cx-&gt;demotion.state
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
)brace
id|cx-&gt;usage
op_increment
suffix:semicolon
multiline_comment|/*&n;&t; * Sleep:&n;&t; * ------&n;&t; * Invoke the current Cx state to put the processor to sleep.&n;&t; */
r_switch
c_cond
(paren
id|pr-&gt;power.state
)paren
(brace
r_case
id|ACPI_STATE_C1
suffix:colon
multiline_comment|/* Invoke C1. */
id|safe_halt
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;                 * TBD: Can&squot;t get time duration while in C1, as resumes&n;&t;&t; *      go to an ISR rather than here.  Need to instrument&n;&t;&t; *      base interrupt handler.&n;&t;&t; */
id|sleep_ticks
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_STATE_C2
suffix:colon
multiline_comment|/* Get start time (ticks) */
id|t1
op_assign
id|inl
c_func
(paren
id|acpi_fadt.xpm_tmr_blk.address
)paren
suffix:semicolon
multiline_comment|/* Invoke C2 */
id|inb
c_func
(paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|address
)paren
suffix:semicolon
multiline_comment|/* Dummy op - must do something useless after P_LVL2 read */
id|t2
op_assign
id|inl
c_func
(paren
id|acpi_fadt.xpm_tmr_blk.address
)paren
suffix:semicolon
multiline_comment|/* Get end time (ticks) */
id|t2
op_assign
id|inl
c_func
(paren
id|acpi_fadt.xpm_tmr_blk.address
)paren
suffix:semicolon
multiline_comment|/* Re-enable interrupts */
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Compute time (ticks) that we were actually asleep */
id|sleep_ticks
op_assign
id|ticks_elapsed
c_func
(paren
id|t1
comma
id|t2
)paren
op_minus
id|cx-&gt;latency_ticks
op_minus
id|C2_OVERHEAD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_STATE_C3
suffix:colon
multiline_comment|/* Disable bus master arbitration */
id|acpi_set_register
c_func
(paren
id|ACPI_BITREG_ARB_DISABLE
comma
l_int|1
comma
id|ACPI_MTX_DO_NOT_LOCK
)paren
suffix:semicolon
multiline_comment|/* Get start time (ticks) */
id|t1
op_assign
id|inl
c_func
(paren
id|acpi_fadt.xpm_tmr_blk.address
)paren
suffix:semicolon
multiline_comment|/* Invoke C3 */
id|inb
c_func
(paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|address
)paren
suffix:semicolon
multiline_comment|/* Dummy op - must do something useless after P_LVL3 read */
id|t2
op_assign
id|inl
c_func
(paren
id|acpi_fadt.xpm_tmr_blk.address
)paren
suffix:semicolon
multiline_comment|/* Get end time (ticks) */
id|t2
op_assign
id|inl
c_func
(paren
id|acpi_fadt.xpm_tmr_blk.address
)paren
suffix:semicolon
multiline_comment|/* Enable bus master arbitration */
id|acpi_set_register
c_func
(paren
id|ACPI_BITREG_ARB_DISABLE
comma
l_int|0
comma
id|ACPI_MTX_DO_NOT_LOCK
)paren
suffix:semicolon
multiline_comment|/* Re-enable interrupts */
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Compute time (ticks) that we were actually asleep */
id|sleep_ticks
op_assign
id|ticks_elapsed
c_func
(paren
id|t1
comma
id|t2
)paren
op_minus
id|cx-&gt;latency_ticks
op_minus
id|C3_OVERHEAD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|next_state
op_assign
id|pr-&gt;power.state
suffix:semicolon
multiline_comment|/*&n;&t; * Promotion?&n;&t; * ----------&n;&t; * Track the number of longs (time asleep is greater than threshold)&n;&t; * and promote when the count threshold is reached.  Note that bus&n;&t; * mastering activity may prevent promotions.&n;&t; */
r_if
c_cond
(paren
id|cx-&gt;promotion.state
)paren
(brace
r_if
c_cond
(paren
id|sleep_ticks
OG
id|cx-&gt;promotion.threshold.ticks
)paren
(brace
id|cx-&gt;promotion.count
op_increment
suffix:semicolon
id|cx-&gt;demotion.count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cx-&gt;promotion.count
op_ge
id|cx-&gt;promotion.threshold.count
)paren
(brace
r_if
c_cond
(paren
id|pr-&gt;flags.bm_check
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pr-&gt;power.bm_activity
op_amp
id|cx-&gt;promotion.threshold.bm
)paren
)paren
(brace
id|next_state
op_assign
id|cx-&gt;promotion.state
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
)brace
r_else
(brace
id|next_state
op_assign
id|cx-&gt;promotion.state
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/*&n;&t; * Demotion?&n;&t; * ---------&n;&t; * Track the number of shorts (time asleep is less than time threshold)&n;&t; * and demote when the usage threshold is reached.&n;&t; */
r_if
c_cond
(paren
id|cx-&gt;demotion.state
)paren
(brace
r_if
c_cond
(paren
id|sleep_ticks
OL
id|cx-&gt;demotion.threshold.ticks
)paren
(brace
id|cx-&gt;demotion.count
op_increment
suffix:semicolon
id|cx-&gt;promotion.count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cx-&gt;demotion.count
op_ge
id|cx-&gt;demotion.threshold.count
)paren
(brace
id|next_state
op_assign
id|cx-&gt;demotion.state
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
)brace
)brace
id|end
suffix:colon
multiline_comment|/*&n;&t; * New Cx State?&n;&t; * -------------&n;&t; * If we&squot;re going to start using a new Cx state we must clean up&n;&t; * from the previous and prepare to use the new.&n;&t; */
r_if
c_cond
(paren
id|next_state
op_ne
id|pr-&gt;power.state
)paren
id|acpi_processor_power_activate
c_func
(paren
id|pr
comma
id|next_state
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_set_power_policy
id|acpi_processor_set_power_policy
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_set_power_policy&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * This function sets the default Cx state policy (OS idle handler).&n;&t; * Our scheme is to promote quickly to C2 but more conservatively&n;&t; * to C3.  We&squot;re favoring C2  for its characteristics of low latency&n;&t; * (quick response), good power savings, and ability to allow bus&n;&t; * mastering activity.  Note that the Cx state policy is completely&n;&t; * customizable and can be altered dynamically.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * C0/C1&n;&t; * -----&n;&t; */
id|pr-&gt;power.state
op_assign
id|ACPI_STATE_C1
suffix:semicolon
id|pr-&gt;power.default_state
op_assign
id|ACPI_STATE_C1
suffix:semicolon
multiline_comment|/*&n;&t; * C1/C2&n;&t; * -----&n;&t; * Set the default C1 promotion and C2 demotion policies, where we&n;&t; * promote from C1 to C2 after several (10) successive C1 transitions,&n;&t; * as we cannot (currently) measure the time spent in C1. Demote from&n;&t; * C2 to C1 anytime we experience a &squot;short&squot; (time spent in C2 is less&n;&t; * than the C2 transtion latency).  Note the simplifying assumption &n;&t; * that the &squot;cost&squot; of a transition is amortized when we sleep for at&n;&t; * least as long as the transition&squot;s latency (thus the total transition&n;&t; * time is two times the latency).&n;&t; *&n;&t; * TBD: Measure C1 sleep times by instrumenting the core IRQ handler.&n;&t; * TBD: Demote to default C-State after long periods of activity.&n;&t; * TBD: Investigate policy&squot;s use of CPU utilization -vs- sleep duration.&n;&t; */
r_if
c_cond
(paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|valid
)paren
(brace
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C1
)braket
dot
id|promotion.threshold.count
op_assign
l_int|10
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C1
)braket
dot
id|promotion.threshold.ticks
op_assign
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|latency_ticks
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C1
)braket
dot
id|promotion.state
op_assign
id|ACPI_STATE_C2
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|demotion.threshold.count
op_assign
l_int|1
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|demotion.threshold.ticks
op_assign
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|latency_ticks
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|demotion.state
op_assign
id|ACPI_STATE_C1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * C2/C3&n;&t; * -----&n;&t; * Set default C2 promotion and C3 demotion policies, where we promote&n;&t; * from C2 to C3 after several (4) cycles of no bus mastering activity&n;&t; * while maintaining sleep time criteria.  Demote immediately on a&n;&t; * short or whenever bus mastering activity occurs.&n;&t; */
r_if
c_cond
(paren
(paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|valid
)paren
op_logical_and
(paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|valid
)paren
)paren
(brace
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|promotion.threshold.count
op_assign
l_int|4
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|promotion.threshold.ticks
op_assign
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|latency_ticks
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|promotion.threshold.bm
op_assign
l_int|0x0F
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|promotion.state
op_assign
id|ACPI_STATE_C3
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|demotion.threshold.count
op_assign
l_int|1
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|demotion.threshold.ticks
op_assign
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|latency_ticks
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|demotion.threshold.bm
op_assign
l_int|0x0F
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|demotion.state
op_assign
id|ACPI_STATE_C2
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_int
DECL|function|acpi_processor_get_power_info
id|acpi_processor_get_power_info
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_get_power_info&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;lvl2[0x%08x] lvl3[0x%08x]&bslash;n&quot;
comma
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|address
comma
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|address
)paren
)paren
suffix:semicolon
multiline_comment|/* TBD: Support ACPI 2.0 objects */
multiline_comment|/*&n;&t; * C0&n;&t; * --&n;&t; * This state exists only as filler in our array.&n;&t; */
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C0
)braket
dot
id|valid
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * C1&n;&t; * --&n;&t; * ACPI requires C1 support for all processors.&n;&t; *&n;&t; * TBD: What about PROC_C1?&n;&t; */
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C1
)braket
dot
id|valid
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * C2&n;&t; * --&n;&t; * We&squot;re (currently) only supporting C2 on UP systems.&n;&t; *&n;&t; * TBD: Support for C2 on MP (P_LVL2_UP).&n;&t; */
r_if
c_cond
(paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|address
)paren
(brace
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|latency
op_assign
id|acpi_fadt.plvl2_lat
suffix:semicolon
multiline_comment|/*&n;&t;&t; * C2 latency must be less than or equal to 100 microseconds.&n;&t;&t; */
r_if
c_cond
(paren
id|acpi_fadt.plvl2_lat
op_ge
id|ACPI_PROCESSOR_MAX_C2_LATENCY
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;C2 latency too large [%d]&bslash;n&quot;
comma
id|acpi_fadt.plvl2_lat
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Only support C2 on UP systems (see TBD above).&n;&t;&t; */
r_else
r_if
c_cond
(paren
id|errata.smp
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;C2 not supported in SMP mode&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Otherwise we&squot;ve met all of our C2 requirements.&n;&t;&t; * Normalize the C2 latency to expidite policy.&n;&t;&t; */
r_else
(brace
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|valid
op_assign
l_int|1
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|latency_ticks
op_assign
id|US_TO_PM_TIMER_TICKS
c_func
(paren
id|acpi_fadt.plvl2_lat
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * C3&n;&t; * --&n;&t; * TBD: Investigate use of WBINVD on UP/SMP system in absence of&n;&t; *&t;bm_control.&n;&t; */
r_if
c_cond
(paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|address
)paren
(brace
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|latency
op_assign
id|acpi_fadt.plvl3_lat
suffix:semicolon
multiline_comment|/*&n;&t;&t; * C3 latency must be less than or equal to 1000 microseconds.&n;&t;&t; */
r_if
c_cond
(paren
id|acpi_fadt.plvl3_lat
op_ge
id|ACPI_PROCESSOR_MAX_C3_LATENCY
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;C3 latency too large [%d]&bslash;n&quot;
comma
id|acpi_fadt.plvl3_lat
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Only support C3 when bus mastering arbitration control&n;&t;&t; * is present (able to disable bus mastering to maintain&n;&t;&t; * cache coherency while in C3).&n;&t;&t; */
r_else
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;flags.bm_control
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;C3 support requires bus mastering control&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Only support C3 on UP systems, as bm_control is only viable&n;&t;&t; * on a UP system and flushing caches (e.g. WBINVD) is simply &n;&t;&t; * too costly (at this time).&n;&t;&t; */
r_else
r_if
c_cond
(paren
id|errata.smp
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;C3 not supported in SMP mode&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * PIIX4 Erratum #18: We don&squot;t support C3 when Type-F (fast) &n;&t;&t; * DMA transfers are used by any ISA device to avoid livelock.&n;&t;&t; * Note that we could disable Type-F DMA (as recommended by&n;&t;&t; * the erratum), but this is known to disrupt certain ISA &n;&t;&t; * devices thus we take the conservative approach.&n;&t;&t; */
r_else
r_if
c_cond
(paren
id|errata.piix4.fdma
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;C3 not supported on PIIX4 with Type-F DMA&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Otherwise we&squot;ve met all of our C3 requirements.  &n;&t;&t; * Normalize the C2 latency to expidite policy.  Enable&n;&t;&t; * checking of bus mastering status (bm_check) so we can &n;&t;&t; * use this in our C3 policy.&n;&t;&t; */
r_else
(brace
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|valid
op_assign
l_int|1
suffix:semicolon
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|latency_ticks
op_assign
id|US_TO_PM_TIMER_TICKS
c_func
(paren
id|acpi_fadt.plvl3_lat
)paren
suffix:semicolon
id|pr-&gt;flags.bm_check
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Set Default Policy&n;&t; * ------------------&n;&t; * Now that we know which state are supported, set the default&n;&t; * policy.  Note that this policy can be changed dynamically&n;&t; * (e.g. encourage deeper sleeps to conserve battery life when&n;&t; * not on AC).&n;&t; */
id|result
op_assign
id|acpi_processor_set_power_policy
c_func
(paren
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If this processor supports C2 or C3 we denote it as being &squot;power&n;&t; * manageable&squot;.  Note that there&squot;s really no policy involved for&n;&t; * when only C1 is supported.&n;&t; */
r_if
c_cond
(paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|valid
op_logical_or
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|valid
)paren
id|pr-&gt;flags.power
op_assign
l_int|1
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                              Performance Management&n;   -------------------------------------------------------------------------- */
r_int
DECL|function|acpi_processor_get_platform_limit
id|acpi_processor_get_platform_limit
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
id|acpi_status
id|status
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ppc
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_get_platform_limit&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * _PPC indicates the maximum state currently supported by the platform&n;&t; * (e.g. 0 = states 0..n; 1 = states 1..n; etc.&n;&t; */
id|status
op_assign
id|acpi_evaluate_integer
c_func
(paren
id|pr-&gt;handle
comma
l_string|&quot;_PPC&quot;
comma
l_int|NULL
comma
op_amp
id|ppc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
op_logical_and
id|status
op_ne
id|AE_NOT_FOUND
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error evaluating _PPC&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|pr-&gt;performance_platform_limit
op_assign
(paren
r_int
)paren
id|ppc
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|acpi_processor_get_platform_limit
id|EXPORT_SYMBOL
c_func
(paren
id|acpi_processor_get_platform_limit
)paren
suffix:semicolon
r_int
DECL|function|acpi_processor_register_performance
id|acpi_processor_register_performance
(paren
r_struct
id|acpi_processor_performance
op_star
id|performance
comma
r_struct
id|acpi_processor
op_star
op_star
id|pr
comma
r_int
r_int
id|cpu
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_register_performance&quot;
)paren
suffix:semicolon
op_star
id|pr
op_assign
id|processors
(braket
id|cpu
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|pr
)paren
op_member_access_from_pointer
id|performance
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EBUSY
)paren
suffix:semicolon
(paren
op_star
id|pr
)paren
op_member_access_from_pointer
id|performance
op_assign
id|performance
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|acpi_processor_register_performance
id|EXPORT_SYMBOL
c_func
(paren
id|acpi_processor_register_performance
)paren
suffix:semicolon
multiline_comment|/* for the rest of it, check cpufreq/acpi.c */
multiline_comment|/* --------------------------------------------------------------------------&n;                              Throttling Control&n;   -------------------------------------------------------------------------- */
r_static
r_int
DECL|function|acpi_processor_get_throttling
id|acpi_processor_get_throttling
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
r_int
id|state
op_assign
l_int|0
suffix:semicolon
id|u32
id|value
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_mask
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_value
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_get_throttling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;flags.throttling
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|pr-&gt;throttling.state
op_assign
l_int|0
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|duty_mask
op_assign
id|pr-&gt;throttling.state_count
op_minus
l_int|1
suffix:semicolon
id|duty_mask
op_lshift_assign
id|pr-&gt;throttling.duty_offset
suffix:semicolon
id|value
op_assign
id|inl
c_func
(paren
id|pr-&gt;throttling.address
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Compute the current throttling state when throttling is enabled&n;&t; * (bit 4 is on).&n;&t; */
r_if
c_cond
(paren
id|value
op_amp
l_int|0x10
)paren
(brace
id|duty_value
op_assign
id|value
op_amp
id|duty_mask
suffix:semicolon
id|duty_value
op_rshift_assign
id|pr-&gt;throttling.duty_offset
suffix:semicolon
r_if
c_cond
(paren
id|duty_value
)paren
id|state
op_assign
id|pr-&gt;throttling.state_count
op_minus
id|duty_value
suffix:semicolon
)brace
id|pr-&gt;throttling.state
op_assign
id|state
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Throttling state is T%d (%d%% throttling applied)&bslash;n&quot;
comma
id|state
comma
id|pr-&gt;throttling.states
(braket
id|state
)braket
dot
id|performance
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_set_throttling
id|acpi_processor_set_throttling
(paren
r_struct
id|acpi_processor
op_star
id|pr
comma
r_int
id|state
)paren
(brace
id|u32
id|value
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_mask
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_value
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_set_throttling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
OL
l_int|0
)paren
op_logical_or
(paren
id|state
OG
(paren
id|pr-&gt;throttling.state_count
op_minus
l_int|1
)paren
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;flags.throttling
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|pr-&gt;throttling.state
)paren
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Calculate the duty_value and duty_mask.&n;&t; */
r_if
c_cond
(paren
id|state
)paren
(brace
id|duty_value
op_assign
id|pr-&gt;throttling.state_count
op_minus
id|state
suffix:semicolon
id|duty_value
op_lshift_assign
id|pr-&gt;throttling.duty_offset
suffix:semicolon
multiline_comment|/* Used to clear all duty_value bits */
id|duty_mask
op_assign
id|pr-&gt;throttling.state_count
op_minus
l_int|1
suffix:semicolon
id|duty_mask
op_lshift_assign
id|acpi_fadt.duty_offset
suffix:semicolon
id|duty_mask
op_assign
op_complement
id|duty_mask
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Disable throttling by writing a 0 to bit 4.  Note that we must&n;&t; * turn it off before you can change the duty_value.&n;&t; */
id|value
op_assign
id|inl
c_func
(paren
id|pr-&gt;throttling.address
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_amp
l_int|0x10
)paren
(brace
id|value
op_and_assign
l_int|0xFFFFFFEF
suffix:semicolon
id|outl
c_func
(paren
id|value
comma
id|pr-&gt;throttling.address
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Write the new duty_value and then enable throttling.  Note&n;&t; * that a state value of 0 leaves throttling disabled.&n;&t; */
r_if
c_cond
(paren
id|state
)paren
(brace
id|value
op_and_assign
id|duty_mask
suffix:semicolon
id|value
op_or_assign
id|duty_value
suffix:semicolon
id|outl
c_func
(paren
id|value
comma
id|pr-&gt;throttling.address
)paren
suffix:semicolon
id|value
op_or_assign
l_int|0x00000010
suffix:semicolon
id|outl
c_func
(paren
id|value
comma
id|pr-&gt;throttling.address
)paren
suffix:semicolon
)brace
id|pr-&gt;throttling.state
op_assign
id|state
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Throttling state set to T%d (%d%%)&bslash;n&quot;
comma
id|state
comma
(paren
id|pr-&gt;throttling.states
(braket
id|state
)braket
dot
id|performance
ques
c_cond
id|pr-&gt;throttling.states
(braket
id|state
)braket
dot
id|performance
op_div
l_int|10
suffix:colon
l_int|0
)paren
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_get_throttling_info
id|acpi_processor_get_throttling_info
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|step
op_assign
l_int|0
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_get_throttling_info&quot;
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;pblk_address[0x%08x] duty_offset[%d] duty_width[%d]&bslash;n&quot;
comma
id|pr-&gt;throttling.address
comma
id|pr-&gt;throttling.duty_offset
comma
id|pr-&gt;throttling.duty_width
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
multiline_comment|/* TBD: Support ACPI 2.0 objects */
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;throttling.address
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;No throttling register&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;throttling.duty_width
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;No throttling states&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* TBD: Support duty_cycle values that span bit 4. */
r_else
r_if
c_cond
(paren
(paren
id|pr-&gt;throttling.duty_offset
op_plus
id|pr-&gt;throttling.duty_width
)paren
OG
l_int|4
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;duty_cycle spans bit 4&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * PIIX4 Errata: We don&squot;t support throttling on the original PIIX4.&n;&t; * This shouldn&squot;t be an issue as few (if any) mobile systems ever&n;&t; * used this part.&n;&t; */
r_if
c_cond
(paren
id|errata.piix4.throttle
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Throttling not supported on PIIX4 A- or B-step&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
id|pr-&gt;throttling.state_count
op_assign
id|POWER_OF_2
(braket
id|acpi_fadt.duty_width
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Compute state values. Note that throttling displays a linear power/&n;&t; * performance relationship (at 50% performance the CPU will consume&n;&t; * 50% power).  Values are in 1/10th of a percent to preserve accuracy.&n;&t; */
id|step
op_assign
(paren
l_int|1000
op_div
id|pr-&gt;throttling.state_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pr-&gt;throttling.state_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pr-&gt;throttling.states
(braket
id|i
)braket
dot
id|performance
op_assign
id|step
op_star
id|i
suffix:semicolon
id|pr-&gt;throttling.states
(braket
id|i
)braket
dot
id|power
op_assign
id|step
op_star
id|i
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found %d throttling states&bslash;n&quot;
comma
id|pr-&gt;throttling.state_count
)paren
)paren
suffix:semicolon
id|pr-&gt;flags.throttling
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Disable throttling (if enabled).  We&squot;ll let subsequent policy (e.g. &n;&t; * thermal) decide to lower performance if it so chooses, but for now &n;&t; * we&squot;ll crank up the speed.&n;&t; */
id|result
op_assign
id|acpi_processor_get_throttling
c_func
(paren
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;throttling.state
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Disabling throttling (was T%d)&bslash;n&quot;
comma
id|pr-&gt;throttling.state
)paren
)paren
suffix:semicolon
id|result
op_assign
id|acpi_processor_set_throttling
c_func
(paren
id|pr
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
)brace
id|end
suffix:colon
r_if
c_cond
(paren
id|result
)paren
id|pr-&gt;flags.throttling
op_assign
l_int|0
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                                 Limit Interface&n;   -------------------------------------------------------------------------- */
r_static
r_int
DECL|function|acpi_processor_apply_limit
id|acpi_processor_apply_limit
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|u16
id|px
op_assign
l_int|0
suffix:semicolon
id|u16
id|tx
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_apply_limit&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;flags.limit
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CPU_FREQ
r_if
c_cond
(paren
id|pr-&gt;flags.performance
)paren
(brace
id|px
op_assign
id|pr-&gt;performance_platform_limit
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;limit.user.px
OG
id|px
)paren
id|px
op_assign
id|pr-&gt;limit.user.px
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;limit.thermal.px
OG
id|px
)paren
id|px
op_assign
id|pr-&gt;limit.thermal.px
suffix:semicolon
(brace
r_struct
id|cpufreq_policy
id|policy
suffix:semicolon
id|policy.cpu
op_assign
id|pr-&gt;id
suffix:semicolon
id|cpufreq_get_policy
c_func
(paren
op_amp
id|policy
comma
id|pr-&gt;id
)paren
suffix:semicolon
id|policy.max
op_assign
id|pr-&gt;performance-&gt;states
(braket
id|px
)braket
dot
id|core_frequency
op_star
l_int|1000
suffix:semicolon
multiline_comment|/* racy */
id|result
op_assign
id|cpufreq_set_policy
c_func
(paren
op_amp
id|policy
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pr-&gt;performance_platform_limit
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Platform limit event detected. Consider using ACPI P-States CPUfreq driver&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pr-&gt;flags.throttling
)paren
(brace
r_if
c_cond
(paren
id|pr-&gt;limit.user.tx
OG
id|tx
)paren
id|tx
op_assign
id|pr-&gt;limit.user.tx
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;limit.thermal.tx
OG
id|tx
)paren
id|tx
op_assign
id|pr-&gt;limit.thermal.tx
suffix:semicolon
id|result
op_assign
id|acpi_processor_set_throttling
c_func
(paren
id|pr
comma
id|tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
)brace
id|pr-&gt;limit.state.px
op_assign
id|px
suffix:semicolon
id|pr-&gt;limit.state.tx
op_assign
id|tx
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Processor [%d] limit set to (P%d:T%d)&bslash;n&quot;
comma
id|pr-&gt;id
comma
id|pr-&gt;limit.state.px
comma
id|pr-&gt;limit.state.tx
)paren
)paren
suffix:semicolon
id|end
suffix:colon
r_if
c_cond
(paren
id|result
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to set limit&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
r_int
DECL|function|acpi_processor_set_thermal_limit
id|acpi_processor_set_thermal_limit
(paren
id|acpi_handle
id|handle
comma
r_int
id|type
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_processor
op_star
id|pr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_device
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
r_int
id|px
op_assign
l_int|0
suffix:semicolon
r_int
id|tx
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_set_thermal_limit&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|type
OL
id|ACPI_PROCESSOR_LIMIT_NONE
)paren
op_logical_or
(paren
id|type
OG
id|ACPI_PROCESSOR_LIMIT_DECREMENT
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|result
op_assign
id|acpi_bus_get_device
c_func
(paren
id|handle
comma
op_amp
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;flags.limit
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
multiline_comment|/* Thermal limits are always relative to the current Px/Tx state. */
r_if
c_cond
(paren
id|pr-&gt;flags.performance
)paren
id|pr-&gt;limit.thermal.px
op_assign
id|pr-&gt;performance-&gt;state
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;flags.throttling
)paren
id|pr-&gt;limit.thermal.tx
op_assign
id|pr-&gt;throttling.state
suffix:semicolon
multiline_comment|/*&n;&t; * Our default policy is to only use throttling at the lowest&n;&t; * performance state.&n;&t; */
id|px
op_assign
id|pr-&gt;limit.thermal.px
suffix:semicolon
id|tx
op_assign
id|pr-&gt;limit.thermal.tx
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|ACPI_PROCESSOR_LIMIT_NONE
suffix:colon
id|px
op_assign
l_int|0
suffix:semicolon
id|tx
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_PROCESSOR_LIMIT_INCREMENT
suffix:colon
r_if
c_cond
(paren
id|pr-&gt;flags.performance
)paren
(brace
r_if
c_cond
(paren
id|px
op_eq
(paren
id|pr-&gt;performance-&gt;state_count
op_minus
l_int|1
)paren
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;At maximum performance state&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_else
(brace
id|px
op_increment
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pr-&gt;flags.throttling
)paren
(brace
r_if
c_cond
(paren
id|tx
op_eq
(paren
id|pr-&gt;throttling.state_count
op_minus
l_int|1
)paren
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;At maximum throttling state&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_else
id|tx
op_increment
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_PROCESSOR_LIMIT_DECREMENT
suffix:colon
r_if
c_cond
(paren
id|pr-&gt;flags.performance
)paren
(brace
r_if
c_cond
(paren
id|px
op_eq
id|pr-&gt;performance_platform_limit
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;At minimum performance state&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_else
(brace
id|px
op_decrement
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pr-&gt;flags.throttling
)paren
(brace
r_if
c_cond
(paren
id|tx
op_eq
l_int|0
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;At minimum throttling state&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_else
id|tx
op_decrement
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|end
suffix:colon
id|pr-&gt;limit.thermal.px
op_assign
id|px
suffix:semicolon
id|pr-&gt;limit.thermal.tx
op_assign
id|tx
suffix:semicolon
id|result
op_assign
id|acpi_processor_apply_limit
c_func
(paren
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to set thermal limit&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Thermal limit now (P%d:T%d)&bslash;n&quot;
comma
id|pr-&gt;limit.thermal.px
comma
id|pr-&gt;limit.thermal.tx
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_get_limit_info
id|acpi_processor_get_limit_info
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_get_limit_info&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;flags.performance
op_logical_or
id|pr-&gt;flags.throttling
)paren
id|pr-&gt;flags.limit
op_assign
l_int|1
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                              FS Interface (/proc)&n;   -------------------------------------------------------------------------- */
DECL|variable|acpi_processor_dir
r_struct
id|proc_dir_entry
op_star
id|acpi_processor_dir
op_assign
l_int|NULL
suffix:semicolon
DECL|function|acpi_processor_info_seq_show
r_static
r_int
id|acpi_processor_info_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|offset
)paren
(brace
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_info_seq_show&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
r_goto
id|end
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;processor id:            %d&bslash;n&quot;
l_string|&quot;acpi id:                 %d&bslash;n&quot;
l_string|&quot;bus mastering control:   %s&bslash;n&quot;
l_string|&quot;power management:        %s&bslash;n&quot;
l_string|&quot;throttling control:      %s&bslash;n&quot;
l_string|&quot;performance management:  %s&bslash;n&quot;
l_string|&quot;limit interface:         %s&bslash;n&quot;
comma
id|pr-&gt;id
comma
id|pr-&gt;acpi_id
comma
id|pr-&gt;flags.bm_control
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|pr-&gt;flags.power
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|pr-&gt;flags.throttling
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|pr-&gt;flags.performance
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
comma
id|pr-&gt;flags.limit
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
id|end
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|acpi_processor_info_open_fs
r_static
r_int
id|acpi_processor_info_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|acpi_processor_info_seq_show
comma
id|PDE
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|data
)paren
suffix:semicolon
)brace
DECL|function|acpi_processor_power_seq_show
r_static
r_int
id|acpi_processor_power_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|offset
)paren
(brace
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_power_seq_show&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
r_goto
id|end
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;active state:            C%d&bslash;n&quot;
l_string|&quot;default state:           C%d&bslash;n&quot;
l_string|&quot;bus master activity:     %08x&bslash;n&quot;
comma
id|pr-&gt;power.state
comma
id|pr-&gt;power.default_state
comma
id|pr-&gt;power.bm_activity
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;states:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ACPI_C_STATE_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;   %cC%d:                  &quot;
comma
(paren
id|i
op_eq
id|pr-&gt;power.state
ques
c_cond
l_char|&squot;*&squot;
suffix:colon
l_char|&squot; &squot;
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;power.states
(braket
id|i
)braket
dot
id|valid
)paren
(brace
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;&lt;not supported&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pr-&gt;power.states
(braket
id|i
)braket
dot
id|promotion.state
)paren
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;promotion[C%d] &quot;
comma
id|pr-&gt;power.states
(braket
id|i
)braket
dot
id|promotion.state
)paren
suffix:semicolon
r_else
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;promotion[--] &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;power.states
(braket
id|i
)braket
dot
id|demotion.state
)paren
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;demotion[C%d] &quot;
comma
id|pr-&gt;power.states
(braket
id|i
)braket
dot
id|demotion.state
)paren
suffix:semicolon
r_else
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;demotion[--] &quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;latency[%03d] usage[%08d]&bslash;n&quot;
comma
id|pr-&gt;power.states
(braket
id|i
)braket
dot
id|latency
comma
id|pr-&gt;power.states
(braket
id|i
)braket
dot
id|usage
)paren
suffix:semicolon
)brace
id|end
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|acpi_processor_power_open_fs
r_static
r_int
id|acpi_processor_power_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|acpi_processor_power_seq_show
comma
id|PDE
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|data
)paren
suffix:semicolon
)brace
DECL|function|acpi_processor_throttling_seq_show
r_static
r_int
id|acpi_processor_throttling_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|offset
)paren
(brace
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_throttling_seq_show&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pr-&gt;throttling.state_count
OG
l_int|0
)paren
)paren
(brace
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;&lt;not supported&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|result
op_assign
id|acpi_processor_get_throttling
c_func
(paren
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;Could not determine current throttling state.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;state count:             %d&bslash;n&quot;
l_string|&quot;active state:            T%d&bslash;n&quot;
comma
id|pr-&gt;throttling.state_count
comma
id|pr-&gt;throttling.state
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;states:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pr-&gt;throttling.state_count
suffix:semicolon
id|i
op_increment
)paren
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;   %cT%d:                  %02d%%&bslash;n&quot;
comma
(paren
id|i
op_eq
id|pr-&gt;throttling.state
ques
c_cond
l_char|&squot;*&squot;
suffix:colon
l_char|&squot; &squot;
)paren
comma
id|i
comma
(paren
id|pr-&gt;throttling.states
(braket
id|i
)braket
dot
id|performance
ques
c_cond
id|pr-&gt;throttling.states
(braket
id|i
)braket
dot
id|performance
op_div
l_int|10
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|end
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|acpi_processor_throttling_open_fs
r_static
r_int
id|acpi_processor_throttling_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|acpi_processor_throttling_seq_show
comma
id|PDE
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|data
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_write_throttling
id|acpi_processor_write_throttling
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|data
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|data
suffix:semicolon
r_char
id|state_string
(braket
l_int|12
)braket
op_assign
(brace
l_char|&squot;&bslash;0&squot;
)brace
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_write_throttling&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
op_logical_or
(paren
id|count
OG
r_sizeof
(paren
id|state_string
)paren
op_minus
l_int|1
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|state_string
comma
id|buffer
comma
id|count
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|state_string
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|result
op_assign
id|acpi_processor_set_throttling
c_func
(paren
id|pr
comma
id|simple_strtoul
c_func
(paren
id|state_string
comma
l_int|NULL
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|count
)paren
suffix:semicolon
)brace
DECL|function|acpi_processor_limit_seq_show
r_static
r_int
id|acpi_processor_limit_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|offset
)paren
(brace
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_limit_seq_show&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr-&gt;flags.limit
)paren
(brace
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;&lt;not supported&gt;&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;active limit:            P%d:T%d&bslash;n&quot;
l_string|&quot;platform limit:          P%d:T0&bslash;n&quot;
l_string|&quot;user limit:              P%d:T%d&bslash;n&quot;
l_string|&quot;thermal limit:           P%d:T%d&bslash;n&quot;
comma
id|pr-&gt;limit.state.px
comma
id|pr-&gt;limit.state.tx
comma
id|pr-&gt;flags.performance
ques
c_cond
id|pr-&gt;performance_platform_limit
suffix:colon
l_int|0
comma
id|pr-&gt;limit.user.px
comma
id|pr-&gt;limit.user.tx
comma
id|pr-&gt;limit.thermal.px
comma
id|pr-&gt;limit.thermal.tx
)paren
suffix:semicolon
id|end
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|acpi_processor_limit_open_fs
r_static
r_int
id|acpi_processor_limit_open_fs
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|acpi_processor_limit_seq_show
comma
id|PDE
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|data
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_write_limit
id|acpi_processor_write_limit
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|data
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|data
suffix:semicolon
r_char
id|limit_string
(braket
l_int|25
)braket
op_assign
(brace
l_char|&squot;&bslash;0&squot;
)brace
suffix:semicolon
r_int
id|px
op_assign
l_int|0
suffix:semicolon
r_int
id|tx
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_write_limit&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
op_logical_or
(paren
id|count
OG
r_sizeof
(paren
id|limit_string
)paren
op_minus
l_int|1
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid argument&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|limit_string
comma
id|buffer
comma
id|count
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid data&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
)brace
id|limit_string
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|limit_string
comma
l_string|&quot;%d:%d&quot;
comma
op_amp
id|px
comma
op_amp
id|tx
)paren
op_ne
l_int|2
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid data format&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pr-&gt;flags.performance
)paren
(brace
r_if
c_cond
(paren
(paren
id|px
OL
id|pr-&gt;performance_platform_limit
)paren
op_logical_or
(paren
id|px
OG
(paren
id|pr-&gt;performance-&gt;state_count
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid px&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|pr-&gt;limit.user.px
op_assign
id|px
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pr-&gt;flags.throttling
)paren
(brace
r_if
c_cond
(paren
(paren
id|tx
OL
l_int|0
)paren
op_logical_or
(paren
id|tx
OG
(paren
id|pr-&gt;throttling.state_count
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid tx&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
id|pr-&gt;limit.user.tx
op_assign
id|tx
suffix:semicolon
)brace
id|result
op_assign
id|acpi_processor_apply_limit
c_func
(paren
id|pr
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|count
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_add_fs
id|acpi_processor_add_fs
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|entry
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_add_fs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
(brace
id|acpi_device_dir
c_func
(paren
id|device
)paren
op_assign
id|proc_mkdir
c_func
(paren
id|acpi_device_bid
c_func
(paren
id|device
)paren
comma
id|acpi_processor_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;info&squot; [R] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_PROCESSOR_FILE_INFO
comma
id|S_IRUGO
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_PROCESSOR_FILE_INFO
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;proc_fops
op_assign
op_amp
id|acpi_processor_info_fops
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;power&squot; [R] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_PROCESSOR_FILE_POWER
comma
id|S_IRUGO
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_PROCESSOR_FILE_POWER
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;proc_fops
op_assign
op_amp
id|acpi_processor_power_fops
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;throttling&squot; [R/W] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_PROCESSOR_FILE_THROTTLING
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_PROCESSOR_FILE_THROTTLING
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;proc_fops
op_assign
op_amp
id|acpi_processor_throttling_fops
suffix:semicolon
id|entry-&gt;proc_fops-&gt;write
op_assign
id|acpi_processor_write_throttling
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
multiline_comment|/* &squot;limit&squot; [R/W] */
id|entry
op_assign
id|create_proc_entry
c_func
(paren
id|ACPI_PROCESSOR_FILE_LIMIT
comma
id|S_IFREG
op_or
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to create &squot;%s&squot; fs entry&bslash;n&quot;
comma
id|ACPI_PROCESSOR_FILE_LIMIT
)paren
)paren
suffix:semicolon
r_else
(brace
id|entry-&gt;proc_fops
op_assign
op_amp
id|acpi_processor_limit_fops
suffix:semicolon
id|entry-&gt;proc_fops-&gt;write
op_assign
id|acpi_processor_write_limit
suffix:semicolon
id|entry-&gt;data
op_assign
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_remove_fs
id|acpi_processor_remove_fs
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_remove_fs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_device_dir
c_func
(paren
id|device
)paren
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|acpi_device_bid
c_func
(paren
id|device
)paren
comma
id|acpi_processor_dir
)paren
suffix:semicolon
id|acpi_device_dir
c_func
(paren
id|device
)paren
op_assign
l_int|NULL
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                                 Driver Interface&n;   -------------------------------------------------------------------------- */
r_static
r_int
DECL|function|acpi_processor_get_info
id|acpi_processor_get_info
(paren
r_struct
id|acpi_processor
op_star
id|pr
)paren
(brace
id|acpi_status
id|status
op_assign
l_int|0
suffix:semicolon
r_union
id|acpi_object
id|object
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
r_sizeof
(paren
r_union
id|acpi_object
)paren
comma
op_amp
id|object
)brace
suffix:semicolon
r_static
r_int
id|cpu_index
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_get_info&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_online_cpus
c_func
(paren
)paren
OG
l_int|1
)paren
id|errata.smp
op_assign
id|TRUE
suffix:semicolon
multiline_comment|/*&n;&t; *  Extra Processor objects may be enumerated on MP systems with&n;&t; *  less than the max # of CPUs. They should be ignored.&n;&t; */
r_if
c_cond
(paren
(paren
id|cpu_index
op_plus
l_int|1
)paren
OG
id|num_online_cpus
c_func
(paren
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|acpi_processor_errata
c_func
(paren
id|pr
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check to see if we have bus mastering arbitration control.  This&n;&t; * is required for proper C3 usage (to maintain cache coherency).&n;&t; */
r_if
c_cond
(paren
id|acpi_fadt.V1_pm2_cnt_blk
op_logical_and
id|acpi_fadt.pm2_cnt_len
)paren
(brace
id|pr-&gt;flags.bm_control
op_assign
l_int|1
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Bus mastering arbitration control present&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;No bus mastering arbitration control&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Evalute the processor object.  Note that it is common on SMP to&n;&t; * have the first (boot) processor with a valid PBLK address while&n;&t; * all others have a NULL address.&n;&t; */
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|pr-&gt;handle
comma
l_int|NULL
comma
l_int|NULL
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error evaluating processor object&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * TBD: Synch processor ID (via LAPIC/LSAPIC structures) on SMP.&n;&t; *&t;&gt;&gt;&gt; &squot;acpi_get_processor_id(acpi_id, &amp;id)&squot; in arch/xxx/acpi.c&n;&t; */
id|pr-&gt;id
op_assign
id|cpu_index
op_increment
suffix:semicolon
id|pr-&gt;acpi_id
op_assign
id|object.processor.proc_id
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Processor [%d:%d]&bslash;n&quot;
comma
id|pr-&gt;id
comma
id|pr-&gt;acpi_id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|object.processor.pblk_address
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;No PBLK (NULL address)&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|object.processor.pblk_length
OL
l_int|4
)paren
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid PBLK length [%d]&bslash;n&quot;
comma
id|object.processor.pblk_length
)paren
)paren
suffix:semicolon
r_else
(brace
id|pr-&gt;throttling.address
op_assign
id|object.processor.pblk_address
suffix:semicolon
id|pr-&gt;throttling.duty_offset
op_assign
id|acpi_fadt.duty_offset
suffix:semicolon
id|pr-&gt;throttling.duty_width
op_assign
id|acpi_fadt.duty_width
suffix:semicolon
r_if
c_cond
(paren
id|object.processor.pblk_length
op_ge
l_int|5
)paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C2
)braket
dot
id|address
op_assign
id|object.processor.pblk_address
op_plus
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|object.processor.pblk_length
op_ge
l_int|6
)paren
id|pr-&gt;power.states
(braket
id|ACPI_STATE_C3
)braket
dot
id|address
op_assign
id|object.processor.pblk_address
op_plus
l_int|5
suffix:semicolon
)brace
id|acpi_processor_get_power_info
c_func
(paren
id|pr
)paren
suffix:semicolon
id|pr-&gt;flags.performance
op_assign
l_int|0
suffix:semicolon
id|pr-&gt;performance_platform_limit
op_assign
l_int|0
suffix:semicolon
id|acpi_processor_get_platform_limit
c_func
(paren
id|pr
)paren
suffix:semicolon
id|acpi_processor_get_throttling_info
c_func
(paren
id|pr
)paren
suffix:semicolon
id|acpi_processor_get_limit_info
c_func
(paren
id|pr
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|acpi_processor_notify
id|acpi_processor_notify
(paren
id|acpi_handle
id|handle
comma
id|u32
id|event
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_processor
op_star
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|data
suffix:semicolon
r_struct
id|acpi_device
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_notify&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VOID
suffix:semicolon
r_if
c_cond
(paren
id|acpi_bus_get_device
c_func
(paren
id|pr-&gt;handle
comma
op_amp
id|device
)paren
)paren
id|return_VOID
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|ACPI_PROCESSOR_NOTIFY_PERFORMANCE
suffix:colon
id|result
op_assign
id|acpi_processor_get_platform_limit
c_func
(paren
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|result
)paren
id|acpi_processor_apply_limit
c_func
(paren
id|pr
)paren
suffix:semicolon
id|acpi_bus_generate_event
c_func
(paren
id|device
comma
id|event
comma
id|pr-&gt;performance_platform_limit
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_PROCESSOR_NOTIFY_POWER
suffix:colon
multiline_comment|/* TBD */
id|acpi_bus_generate_event
c_func
(paren
id|device
comma
id|event
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Unsupported event [0x%x]&bslash;n&quot;
comma
id|event
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|return_VOID
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_add
id|acpi_processor_add
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_struct
id|acpi_processor
op_star
id|pr
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_add&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|pr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpi_processor
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pr
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_processor
)paren
)paren
suffix:semicolon
id|pr-&gt;handle
op_assign
id|device-&gt;handle
suffix:semicolon
id|sprintf
c_func
(paren
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
l_string|&quot;%s&quot;
comma
id|ACPI_PROCESSOR_DEVICE_NAME
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|acpi_device_class
c_func
(paren
id|device
)paren
comma
l_string|&quot;%s&quot;
comma
id|ACPI_PROCESSOR_CLASS
)paren
suffix:semicolon
id|acpi_driver_data
c_func
(paren
id|device
)paren
op_assign
id|pr
suffix:semicolon
id|result
op_assign
id|acpi_processor_get_info
c_func
(paren
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
id|result
op_assign
id|acpi_processor_add_fs
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
id|status
op_assign
id|acpi_install_notify_handler
c_func
(paren
id|pr-&gt;handle
comma
id|ACPI_DEVICE_NOTIFY
comma
id|acpi_processor_notify
comma
id|pr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error installing notify handler&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|processors
(braket
id|pr-&gt;id
)braket
op_assign
id|pr
suffix:semicolon
multiline_comment|/*&n;&t; * Install the idle handler if processor power management is supported.&n;&t; * Note that the default idle handler (default_idle) will be used on &n;&t; * platforms that only support C1.&n;&t; */
r_if
c_cond
(paren
(paren
id|pr-&gt;id
op_eq
l_int|0
)paren
op_logical_and
(paren
id|pr-&gt;flags.power
)paren
)paren
(brace
id|pm_idle_save
op_assign
id|pm_idle
suffix:semicolon
id|pm_idle
op_assign
id|acpi_processor_idle
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;%s [%s] (supports&quot;
comma
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
id|acpi_device_bid
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|ACPI_C_STATE_COUNT
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|pr-&gt;power.states
(braket
id|i
)braket
dot
id|valid
)paren
id|printk
c_func
(paren
l_string|&quot; C%d&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pr-&gt;flags.throttling
)paren
id|printk
c_func
(paren
l_string|&quot;, %d throttling states&quot;
comma
id|pr-&gt;throttling.state_count
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
id|end
suffix:colon
r_if
c_cond
(paren
id|result
)paren
(brace
id|acpi_processor_remove_fs
c_func
(paren
id|device
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pr
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_processor_remove
id|acpi_processor_remove
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_struct
id|acpi_processor
op_star
id|pr
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_remove&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
op_logical_or
op_logical_neg
id|acpi_driver_data
c_func
(paren
id|device
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|pr
op_assign
(paren
r_struct
id|acpi_processor
op_star
)paren
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
multiline_comment|/* Unregister the idle handler when processor #0 is removed. */
r_if
c_cond
(paren
id|pr-&gt;id
op_eq
l_int|0
)paren
id|pm_idle
op_assign
id|pm_idle_save
suffix:semicolon
id|status
op_assign
id|acpi_remove_notify_handler
c_func
(paren
id|pr-&gt;handle
comma
id|ACPI_DEVICE_NOTIFY
comma
id|acpi_processor_notify
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error removing notify handler&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|acpi_processor_remove_fs
c_func
(paren
id|device
)paren
suffix:semicolon
id|processors
(braket
id|pr-&gt;id
)braket
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|pr
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|acpi_processor_init
id|acpi_processor_init
(paren
r_void
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_init&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|processors
comma
l_int|0
comma
r_sizeof
(paren
id|processors
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|errata
comma
l_int|0
comma
r_sizeof
(paren
id|errata
)paren
)paren
suffix:semicolon
id|acpi_processor_dir
op_assign
id|proc_mkdir
c_func
(paren
id|ACPI_PROCESSOR_CLASS
comma
id|acpi_root_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acpi_processor_dir
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|result
op_assign
id|acpi_bus_register_driver
c_func
(paren
op_amp
id|acpi_processor_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|remove_proc_entry
c_func
(paren
id|ACPI_PROCESSOR_CLASS
comma
id|acpi_root_dir
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|acpi_processor_exit
id|acpi_processor_exit
(paren
r_void
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_processor_exit&quot;
)paren
suffix:semicolon
id|acpi_bus_unregister_driver
c_func
(paren
op_amp
id|acpi_processor_driver
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|ACPI_PROCESSOR_CLASS
comma
id|acpi_root_dir
)paren
suffix:semicolon
id|return_VOID
suffix:semicolon
)brace
DECL|variable|acpi_processor_init
id|module_init
c_func
(paren
id|acpi_processor_init
)paren
suffix:semicolon
DECL|variable|acpi_processor_exit
id|module_exit
c_func
(paren
id|acpi_processor_exit
)paren
suffix:semicolon
DECL|variable|acpi_processor_set_thermal_limit
id|EXPORT_SYMBOL
c_func
(paren
id|acpi_processor_set_thermal_limit
)paren
suffix:semicolon
eof
