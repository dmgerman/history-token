multiline_comment|/*&n; *  pci_link.c - ACPI PCI Interrupt Link Device Driver ($Revision: 34 $)&n; *&n; *  Copyright (C) 2001, 2002 Andy Grover &lt;andrew.grover@intel.com&gt;&n; *  Copyright (C) 2001, 2002 Paul Diefenbaugh &lt;paul.s.diefenbaugh@intel.com&gt;&n; *  Copyright (C) 2002       Dominik Brodowski &lt;devel@brodo.de&gt;&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or (at&n; *  your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful, but&n; *  WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; *  General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  59 Temple Place, Suite 330, Boston, MA 02111-1307 USA.&n; *&n; * ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&n; *&n; * TBD: &n; *      1. Support more than one IRQ resource entry per link device (index).&n; *&t;2. Implement start/stop mechanism and use ACPI Bus Driver facilities&n; *&t;   for IRQ management (e.g. start()-&gt;_SRS).&n; */
macro_line|#include &lt;linux/sysdev.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;acpi/acpi_bus.h&gt;
macro_line|#include &lt;acpi/acpi_drivers.h&gt;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_PCI_COMPONENT
id|ACPI_MODULE_NAME
(paren
l_string|&quot;pci_link&quot;
)paren
DECL|macro|ACPI_PCI_LINK_CLASS
mdefine_line|#define ACPI_PCI_LINK_CLASS&t;&t;&quot;pci_irq_routing&quot;
DECL|macro|ACPI_PCI_LINK_HID
mdefine_line|#define ACPI_PCI_LINK_HID&t;&t;&quot;PNP0C0F&quot;
DECL|macro|ACPI_PCI_LINK_DRIVER_NAME
mdefine_line|#define ACPI_PCI_LINK_DRIVER_NAME&t;&quot;ACPI PCI Interrupt Link Driver&quot;
DECL|macro|ACPI_PCI_LINK_DEVICE_NAME
mdefine_line|#define ACPI_PCI_LINK_DEVICE_NAME&t;&quot;PCI Interrupt Link&quot;
DECL|macro|ACPI_PCI_LINK_FILE_INFO
mdefine_line|#define ACPI_PCI_LINK_FILE_INFO&t;&t;&quot;info&quot;
DECL|macro|ACPI_PCI_LINK_FILE_STATUS
mdefine_line|#define ACPI_PCI_LINK_FILE_STATUS&t;&quot;state&quot;
DECL|macro|ACPI_PCI_LINK_MAX_POSSIBLE
mdefine_line|#define ACPI_PCI_LINK_MAX_POSSIBLE 16
r_static
r_int
id|acpi_pci_link_add
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
suffix:semicolon
r_static
r_int
id|acpi_pci_link_remove
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
suffix:semicolon
DECL|variable|acpi_pci_link_driver
r_static
r_struct
id|acpi_driver
id|acpi_pci_link_driver
op_assign
(brace
dot
id|name
op_assign
id|ACPI_PCI_LINK_DRIVER_NAME
comma
dot
r_class
op_assign
id|ACPI_PCI_LINK_CLASS
comma
dot
id|ids
op_assign
id|ACPI_PCI_LINK_HID
comma
dot
id|ops
op_assign
(brace
dot
id|add
op_assign
id|acpi_pci_link_add
comma
dot
id|remove
op_assign
id|acpi_pci_link_remove
comma
)brace
comma
)brace
suffix:semicolon
DECL|struct|acpi_pci_link_irq
r_struct
id|acpi_pci_link_irq
(brace
DECL|member|active
id|u8
id|active
suffix:semicolon
multiline_comment|/* Current IRQ */
DECL|member|edge_level
id|u8
id|edge_level
suffix:semicolon
multiline_comment|/* All IRQs */
DECL|member|active_high_low
id|u8
id|active_high_low
suffix:semicolon
multiline_comment|/* All IRQs */
DECL|member|initialized
id|u8
id|initialized
suffix:semicolon
DECL|member|resource_type
id|u8
id|resource_type
suffix:semicolon
DECL|member|possible_count
id|u8
id|possible_count
suffix:semicolon
DECL|member|possible
id|u8
id|possible
(braket
id|ACPI_PCI_LINK_MAX_POSSIBLE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|acpi_pci_link
r_struct
id|acpi_pci_link
(brace
DECL|member|node
r_struct
id|list_head
id|node
suffix:semicolon
DECL|member|device
r_struct
id|acpi_device
op_star
id|device
suffix:semicolon
DECL|member|handle
id|acpi_handle
id|handle
suffix:semicolon
DECL|member|irq
r_struct
id|acpi_pci_link_irq
id|irq
suffix:semicolon
)brace
suffix:semicolon
r_static
r_struct
(brace
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|entries
r_struct
id|list_head
id|entries
suffix:semicolon
DECL|variable|acpi_link
)brace
id|acpi_link
suffix:semicolon
multiline_comment|/* --------------------------------------------------------------------------&n;                            PCI Link Device Management&n;   -------------------------------------------------------------------------- */
multiline_comment|/*&n; * set context (link) possible list from resource list&n; */
r_static
id|acpi_status
DECL|function|acpi_pci_link_check_possible
id|acpi_pci_link_check_possible
(paren
r_struct
id|acpi_resource
op_star
id|resource
comma
r_void
op_star
id|context
)paren
(brace
r_struct
id|acpi_pci_link
op_star
id|link
op_assign
(paren
r_struct
id|acpi_pci_link
op_star
)paren
id|context
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_check_possible&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|resource-&gt;id
)paren
(brace
r_case
id|ACPI_RSTYPE_START_DPF
suffix:colon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
r_case
id|ACPI_RSTYPE_IRQ
suffix:colon
(brace
r_struct
id|acpi_resource_irq
op_star
id|p
op_assign
op_amp
id|resource-&gt;data.irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
op_logical_or
op_logical_neg
id|p-&gt;number_of_interrupts
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Blank IRQ resource&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|p-&gt;number_of_interrupts
op_logical_and
id|i
OL
id|ACPI_PCI_LINK_MAX_POSSIBLE
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;interrupts
(braket
id|i
)braket
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Invalid IRQ %d&bslash;n&quot;
comma
id|p-&gt;interrupts
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|link-&gt;irq.possible
(braket
id|i
)braket
op_assign
id|p-&gt;interrupts
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;irq.possible_count
op_increment
suffix:semicolon
)brace
id|link-&gt;irq.edge_level
op_assign
id|p-&gt;edge_level
suffix:semicolon
id|link-&gt;irq.active_high_low
op_assign
id|p-&gt;active_high_low
suffix:semicolon
id|link-&gt;irq.resource_type
op_assign
id|ACPI_RSTYPE_IRQ
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|ACPI_RSTYPE_EXT_IRQ
suffix:colon
(brace
r_struct
id|acpi_resource_ext_irq
op_star
id|p
op_assign
op_amp
id|resource-&gt;data.extended_irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
op_logical_or
op_logical_neg
id|p-&gt;number_of_interrupts
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Blank EXT IRQ resource&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|p-&gt;number_of_interrupts
op_logical_and
id|i
OL
id|ACPI_PCI_LINK_MAX_POSSIBLE
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;interrupts
(braket
id|i
)braket
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Invalid IRQ %d&bslash;n&quot;
comma
id|p-&gt;interrupts
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|link-&gt;irq.possible
(braket
id|i
)braket
op_assign
id|p-&gt;interrupts
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;irq.possible_count
op_increment
suffix:semicolon
)brace
id|link-&gt;irq.edge_level
op_assign
id|p-&gt;edge_level
suffix:semicolon
id|link-&gt;irq.active_high_low
op_assign
id|p-&gt;active_high_low
suffix:semicolon
id|link-&gt;irq.resource_type
op_assign
id|ACPI_RSTYPE_EXT_IRQ
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Resource is not an IRQ entry&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_CTRL_TERMINATE
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_pci_link_get_possible
id|acpi_pci_link_get_possible
(paren
r_struct
id|acpi_pci_link
op_star
id|link
)paren
(brace
id|acpi_status
id|status
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_get_possible&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|status
op_assign
id|acpi_walk_resources
c_func
(paren
id|link-&gt;handle
comma
id|METHOD_NAME__PRS
comma
id|acpi_pci_link_check_possible
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error evaluating _PRS&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Found %d possible IRQs&bslash;n&quot;
comma
id|link-&gt;irq.possible_count
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
id|acpi_status
DECL|function|acpi_pci_link_check_current
id|acpi_pci_link_check_current
(paren
r_struct
id|acpi_resource
op_star
id|resource
comma
r_void
op_star
id|context
)paren
(brace
r_int
op_star
id|irq
op_assign
(paren
r_int
op_star
)paren
id|context
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_check_current&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|resource-&gt;id
)paren
(brace
r_case
id|ACPI_RSTYPE_IRQ
suffix:colon
(brace
r_struct
id|acpi_resource_irq
op_star
id|p
op_assign
op_amp
id|resource-&gt;data.irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
op_logical_or
op_logical_neg
id|p-&gt;number_of_interrupts
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * IRQ descriptors may have no IRQ# bits set,&n;&t;&t;&t; * particularly those those w/ _STA disabled&n;&t;&t;&t; */
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Blank IRQ resource&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
op_star
id|irq
op_assign
id|p-&gt;interrupts
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|ACPI_RSTYPE_EXT_IRQ
suffix:colon
(brace
r_struct
id|acpi_resource_ext_irq
op_star
id|p
op_assign
op_amp
id|resource-&gt;data.extended_irq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
op_logical_or
op_logical_neg
id|p-&gt;number_of_interrupts
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * extended IRQ descriptors must&n;&t;&t;&t; * return at least 1 IRQ&n;&t;&t;&t; */
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Blank EXT IRQ resource&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
op_star
id|irq
op_assign
id|p-&gt;interrupts
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Resource isn&squot;t an IRQ&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_CTRL_TERMINATE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Run _CRS and set link-&gt;irq.active&n; *&n; * return value:&n; * 0 - success&n; * !0 - failure&n; */
r_static
r_int
DECL|function|acpi_pci_link_get_current
id|acpi_pci_link_get_current
(paren
r_struct
id|acpi_pci_link
op_star
id|link
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_int
id|irq
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_get_current&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
op_logical_or
op_logical_neg
id|link-&gt;handle
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|link-&gt;irq.active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* in practice, status disabled is meaningless, ignore it */
r_if
c_cond
(paren
id|acpi_strict
)paren
(brace
multiline_comment|/* Query _STA, set link-&gt;device-&gt;status */
id|result
op_assign
id|acpi_bus_get_status
c_func
(paren
id|link-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to read status&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|link-&gt;device-&gt;status.enabled
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Link disabled&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n;&t; * Query and parse _CRS to get the current IRQ assignment. &n;&t; */
id|status
op_assign
id|acpi_walk_resources
c_func
(paren
id|link-&gt;handle
comma
id|METHOD_NAME__CRS
comma
id|acpi_pci_link_check_current
comma
op_amp
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error evaluating _CRS&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_strict
op_logical_and
op_logical_neg
id|irq
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;_CRS returned 0&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
id|link-&gt;irq.active
op_assign
id|irq
suffix:semicolon
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Link at IRQ %d &bslash;n&quot;
comma
id|link-&gt;irq.active
)paren
)paren
suffix:semicolon
id|end
suffix:colon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_pci_link_set
id|acpi_pci_link_set
(paren
r_struct
id|acpi_pci_link
op_star
id|link
comma
r_int
id|irq
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_struct
(brace
r_struct
id|acpi_resource
id|res
suffix:semicolon
r_struct
id|acpi_resource
id|end
suffix:semicolon
)brace
op_star
id|resource
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
op_assign
(brace
l_int|0
comma
l_int|NULL
)brace
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_set&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
op_logical_or
op_logical_neg
id|irq
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|resource
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|resource
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|resource
)paren
(brace
id|return_VALUE
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|resource
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|resource
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|buffer.length
op_assign
r_sizeof
(paren
op_star
id|resource
)paren
op_plus
l_int|1
suffix:semicolon
id|buffer.pointer
op_assign
id|resource
suffix:semicolon
r_switch
c_cond
(paren
id|link-&gt;irq.resource_type
)paren
(brace
r_case
id|ACPI_RSTYPE_IRQ
suffix:colon
id|resource-&gt;res.id
op_assign
id|ACPI_RSTYPE_IRQ
suffix:semicolon
id|resource-&gt;res.length
op_assign
r_sizeof
(paren
r_struct
id|acpi_resource
)paren
suffix:semicolon
id|resource-&gt;res.data.irq.edge_level
op_assign
id|link-&gt;irq.edge_level
suffix:semicolon
id|resource-&gt;res.data.irq.active_high_low
op_assign
id|link-&gt;irq.active_high_low
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;irq.edge_level
op_eq
id|ACPI_EDGE_SENSITIVE
)paren
id|resource-&gt;res.data.irq.shared_exclusive
op_assign
id|ACPI_EXCLUSIVE
suffix:semicolon
r_else
id|resource-&gt;res.data.irq.shared_exclusive
op_assign
id|ACPI_SHARED
suffix:semicolon
id|resource-&gt;res.data.irq.number_of_interrupts
op_assign
l_int|1
suffix:semicolon
id|resource-&gt;res.data.irq.interrupts
(braket
l_int|0
)braket
op_assign
id|irq
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_RSTYPE_EXT_IRQ
suffix:colon
id|resource-&gt;res.id
op_assign
id|ACPI_RSTYPE_EXT_IRQ
suffix:semicolon
id|resource-&gt;res.length
op_assign
r_sizeof
(paren
r_struct
id|acpi_resource
)paren
suffix:semicolon
id|resource-&gt;res.data.extended_irq.producer_consumer
op_assign
id|ACPI_CONSUMER
suffix:semicolon
id|resource-&gt;res.data.extended_irq.edge_level
op_assign
id|link-&gt;irq.edge_level
suffix:semicolon
id|resource-&gt;res.data.extended_irq.active_high_low
op_assign
id|link-&gt;irq.active_high_low
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;irq.edge_level
op_eq
id|ACPI_EDGE_SENSITIVE
)paren
id|resource-&gt;res.data.irq.shared_exclusive
op_assign
id|ACPI_EXCLUSIVE
suffix:semicolon
r_else
id|resource-&gt;res.data.irq.shared_exclusive
op_assign
id|ACPI_SHARED
suffix:semicolon
id|resource-&gt;res.data.extended_irq.number_of_interrupts
op_assign
l_int|1
suffix:semicolon
id|resource-&gt;res.data.extended_irq.interrupts
(braket
l_int|0
)braket
op_assign
id|irq
suffix:semicolon
multiline_comment|/* ignore resource_source, it&squot;s optional */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;ACPI BUG: resource_type %d&bslash;n&quot;
comma
id|link-&gt;irq.resource_type
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
id|resource-&gt;end.id
op_assign
id|ACPI_RSTYPE_END_TAG
suffix:semicolon
multiline_comment|/* Attempt to set the resource */
id|status
op_assign
id|acpi_set_current_resources
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|buffer
)paren
suffix:semicolon
multiline_comment|/* check for total failure */
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Error evaluating _SRS&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
multiline_comment|/* Query _STA, set device-&gt;status */
id|result
op_assign
id|acpi_bus_get_status
c_func
(paren
id|link-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to read status&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|link-&gt;device-&gt;status.enabled
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;%s [%s] disabled and referenced, BIOS bug.&bslash;n&quot;
comma
id|acpi_device_name
c_func
(paren
id|link-&gt;device
)paren
comma
id|acpi_device_bid
c_func
(paren
id|link-&gt;device
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Query _CRS, set link-&gt;irq.active */
id|result
op_assign
id|acpi_pci_link_get_current
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Is current setting not what we set?&n;&t; * set link-&gt;irq.active&n;&t; */
r_if
c_cond
(paren
id|link-&gt;irq.active
op_ne
id|irq
)paren
(brace
multiline_comment|/*&n;&t;&t; * policy: when _CRS doesn&squot;t return what we just _SRS&n;&t;&t; * assume _SRS worked and override _CRS value.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;%s [%s] BIOS reported IRQ %d, using IRQ %d&bslash;n&quot;
comma
id|acpi_device_name
c_func
(paren
id|link-&gt;device
)paren
comma
id|acpi_device_bid
c_func
(paren
id|link-&gt;device
)paren
comma
id|link-&gt;irq.active
comma
id|irq
)paren
suffix:semicolon
id|link-&gt;irq.active
op_assign
id|irq
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Set IRQ %d&bslash;n&quot;
comma
id|link-&gt;irq.active
)paren
)paren
suffix:semicolon
id|end
suffix:colon
id|kfree
c_func
(paren
id|resource
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                            PCI Link IRQ Management&n;   -------------------------------------------------------------------------- */
multiline_comment|/*&n; * &quot;acpi_irq_balance&quot; (default in APIC mode) enables ACPI to use PIC Interrupt&n; * Link Devices to move the PIRQs around to minimize sharing.&n; * &n; * &quot;acpi_irq_nobalance&quot; (default in PIC mode) tells ACPI not to move any PIC IRQs&n; * that the BIOS has already set to active.  This is necessary because&n; * ACPI has no automatic means of knowing what ISA IRQs are used.  Note that&n; * if the BIOS doesn&squot;t set a Link Device active, ACPI needs to program it&n; * even if acpi_irq_nobalance is set.&n; *&n; * A tables of penalties avoids directing PCI interrupts to well known&n; * ISA IRQs. Boot params are available to over-ride the default table:&n; *&n; * List interrupts that are free for PCI use.&n; * acpi_irq_pci=n[,m]&n; *&n; * List interrupts that should not be used for PCI:&n; * acpi_irq_isa=n[,m]&n; *&n; * Note that PCI IRQ routers have a list of possible IRQs,&n; * which may not include the IRQs this table says are available.&n; * &n; * Since this heuristic can&squot;t tell the difference between a link&n; * that no device will attach to, vs. a link which may be shared&n; * by multiple active devices -- it is not optimal.&n; *&n; * If interrupt performance is that important, get an IO-APIC system&n; * with a pin dedicated to each device.  Or for that matter, an MSI&n; * enabled system.&n; */
DECL|macro|ACPI_MAX_IRQS
mdefine_line|#define ACPI_MAX_IRQS&t;&t;256
DECL|macro|ACPI_MAX_ISA_IRQ
mdefine_line|#define ACPI_MAX_ISA_IRQ&t;16
DECL|macro|PIRQ_PENALTY_PCI_AVAILABLE
mdefine_line|#define PIRQ_PENALTY_PCI_AVAILABLE&t;(0)
DECL|macro|PIRQ_PENALTY_PCI_POSSIBLE
mdefine_line|#define PIRQ_PENALTY_PCI_POSSIBLE&t;(16*16)
DECL|macro|PIRQ_PENALTY_PCI_USING
mdefine_line|#define PIRQ_PENALTY_PCI_USING&t;&t;(16*16*16)
DECL|macro|PIRQ_PENALTY_ISA_TYPICAL
mdefine_line|#define PIRQ_PENALTY_ISA_TYPICAL&t;(16*16*16*16)
DECL|macro|PIRQ_PENALTY_ISA_USED
mdefine_line|#define PIRQ_PENALTY_ISA_USED&t;&t;(16*16*16*16*16)
DECL|macro|PIRQ_PENALTY_ISA_ALWAYS
mdefine_line|#define PIRQ_PENALTY_ISA_ALWAYS&t;&t;(16*16*16*16*16*16)
DECL|variable|acpi_irq_penalty
r_static
r_int
id|acpi_irq_penalty
(braket
id|ACPI_MAX_IRQS
)braket
op_assign
(brace
id|PIRQ_PENALTY_ISA_ALWAYS
comma
multiline_comment|/* IRQ0 timer */
id|PIRQ_PENALTY_ISA_ALWAYS
comma
multiline_comment|/* IRQ1 keyboard */
id|PIRQ_PENALTY_ISA_ALWAYS
comma
multiline_comment|/* IRQ2 cascade */
id|PIRQ_PENALTY_ISA_TYPICAL
comma
multiline_comment|/* IRQ3&t;serial */
id|PIRQ_PENALTY_ISA_TYPICAL
comma
multiline_comment|/* IRQ4&t;serial */
id|PIRQ_PENALTY_ISA_TYPICAL
comma
multiline_comment|/* IRQ5 sometimes SoundBlaster */
id|PIRQ_PENALTY_ISA_TYPICAL
comma
multiline_comment|/* IRQ6 */
id|PIRQ_PENALTY_ISA_TYPICAL
comma
multiline_comment|/* IRQ7 parallel, spurious */
id|PIRQ_PENALTY_ISA_TYPICAL
comma
multiline_comment|/* IRQ8 rtc, sometimes */
id|PIRQ_PENALTY_PCI_AVAILABLE
comma
multiline_comment|/* IRQ9  PCI, often acpi */
id|PIRQ_PENALTY_PCI_AVAILABLE
comma
multiline_comment|/* IRQ10 PCI */
id|PIRQ_PENALTY_PCI_AVAILABLE
comma
multiline_comment|/* IRQ11 PCI */
id|PIRQ_PENALTY_ISA_USED
comma
multiline_comment|/* IRQ12 mouse */
id|PIRQ_PENALTY_ISA_USED
comma
multiline_comment|/* IRQ13 fpe, sometimes */
id|PIRQ_PENALTY_ISA_USED
comma
multiline_comment|/* IRQ14 ide0 */
id|PIRQ_PENALTY_ISA_USED
comma
multiline_comment|/* IRQ15 ide1 */
multiline_comment|/* &gt;IRQ15 */
)brace
suffix:semicolon
r_int
id|__init
DECL|function|acpi_irq_penalty_init
id|acpi_irq_penalty_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_pci_link
op_star
id|link
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_irq_penalty_init&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Update penalties to facilitate IRQ balancing.&n;&t; */
id|list_for_each
c_func
(paren
id|node
comma
op_amp
id|acpi_link.entries
)paren
(brace
id|link
op_assign
id|list_entry
c_func
(paren
id|node
comma
r_struct
id|acpi_pci_link
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid link context&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * reflect the possible and active irqs in the penalty table --&n;&t;&t; * useful for breaking ties.&n;&t;&t; */
r_if
c_cond
(paren
id|link-&gt;irq.possible_count
)paren
(brace
r_int
id|penalty
op_assign
id|PIRQ_PENALTY_PCI_POSSIBLE
op_div
id|link-&gt;irq.possible_count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|link-&gt;irq.possible_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;irq.possible
(braket
id|i
)braket
OL
id|ACPI_MAX_ISA_IRQ
)paren
id|acpi_irq_penalty
(braket
id|link-&gt;irq.possible
(braket
id|i
)braket
)braket
op_add_assign
id|penalty
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|link-&gt;irq.active
)paren
(brace
id|acpi_irq_penalty
(braket
id|link-&gt;irq.active
)braket
op_add_assign
id|PIRQ_PENALTY_PCI_POSSIBLE
suffix:semicolon
)brace
)brace
multiline_comment|/* Add a penalty for the SCI */
id|acpi_irq_penalty
(braket
id|acpi_fadt.sci_int
)braket
op_add_assign
id|PIRQ_PENALTY_PCI_USING
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|acpi_irq_balance
r_static
r_int
id|acpi_irq_balance
suffix:semicolon
multiline_comment|/* 0: static, 1: balance */
DECL|function|acpi_pci_link_allocate
r_static
r_int
id|acpi_pci_link_allocate
c_func
(paren
r_struct
id|acpi_pci_link
op_star
id|link
)paren
(brace
r_int
id|irq
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_allocate&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;irq.initialized
)paren
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * search for active IRQ in list of possible IRQs.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|link-&gt;irq.possible_count
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;irq.active
op_eq
id|link-&gt;irq.possible
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * forget active IRQ that is not in possible list&n;&t; */
r_if
c_cond
(paren
id|i
op_eq
id|link-&gt;irq.possible_count
)paren
(brace
r_if
c_cond
(paren
id|acpi_strict
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;_CRS %d not found&quot;
l_string|&quot; in _PRS&bslash;n&quot;
comma
id|link-&gt;irq.active
)paren
suffix:semicolon
id|link-&gt;irq.active
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if active found, use it; else pick entry from end of possible list.&n;&t; */
r_if
c_cond
(paren
id|link-&gt;irq.active
)paren
(brace
id|irq
op_assign
id|link-&gt;irq.active
suffix:semicolon
)brace
r_else
(brace
id|irq
op_assign
id|link-&gt;irq.possible
(braket
id|link-&gt;irq.possible_count
op_minus
l_int|1
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_irq_balance
op_logical_or
op_logical_neg
id|link-&gt;irq.active
)paren
(brace
multiline_comment|/*&n;&t;&t; * Select the best IRQ.  This is done in reverse to promote&n;&t;&t; * the use of IRQs 9, 10, 11, and &gt;15.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
(paren
id|link-&gt;irq.possible_count
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|acpi_irq_penalty
(braket
id|irq
)braket
OG
id|acpi_irq_penalty
(braket
id|link-&gt;irq.possible
(braket
id|i
)braket
)braket
)paren
id|irq
op_assign
id|link-&gt;irq.possible
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/* Attempt to enable the link device at this IRQ. */
r_if
c_cond
(paren
id|acpi_pci_link_set
c_func
(paren
id|link
comma
id|irq
)paren
)paren
(brace
id|printk
c_func
(paren
id|PREFIX
l_string|&quot;Unable to set IRQ for %s [%s] (likely buggy ACPI BIOS).&bslash;n&quot;
l_string|&quot;Try pci=noacpi or acpi=off&bslash;n&quot;
comma
id|acpi_device_name
c_func
(paren
id|link-&gt;device
)paren
comma
id|acpi_device_bid
c_func
(paren
id|link-&gt;device
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
)brace
r_else
(brace
id|acpi_irq_penalty
(braket
id|link-&gt;irq.active
)braket
op_add_assign
id|PIRQ_PENALTY_PCI_USING
suffix:semicolon
id|printk
c_func
(paren
id|PREFIX
l_string|&quot;%s [%s] enabled at IRQ %d&bslash;n&quot;
comma
id|acpi_device_name
c_func
(paren
id|link-&gt;device
)paren
comma
id|acpi_device_bid
c_func
(paren
id|link-&gt;device
)paren
comma
id|link-&gt;irq.active
)paren
suffix:semicolon
)brace
id|link-&gt;irq.initialized
op_assign
l_int|1
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * acpi_pci_link_get_irq&n; * success: return IRQ &gt;= 0&n; * failure: return -1&n; */
r_int
DECL|function|acpi_pci_link_get_irq
id|acpi_pci_link_get_irq
(paren
id|acpi_handle
id|handle
comma
r_int
id|index
comma
r_int
op_star
id|edge_level
comma
r_int
op_star
id|active_high_low
comma
r_char
op_star
op_star
id|name
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_device
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_pci_link
op_star
id|link
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_get_irq&quot;
)paren
suffix:semicolon
id|result
op_assign
id|acpi_bus_get_device
c_func
(paren
id|handle
comma
op_amp
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid link device&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|link
op_assign
(paren
r_struct
id|acpi_pci_link
op_star
)paren
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid link context&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* TBD: Support multiple index (IRQ) entries per Link Device */
r_if
c_cond
(paren
id|index
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid index %d&bslash;n&quot;
comma
id|index
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_pci_link_allocate
c_func
(paren
id|link
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link-&gt;irq.active
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Link active IRQ is 0!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|edge_level
)paren
op_star
id|edge_level
op_assign
id|link-&gt;irq.edge_level
suffix:semicolon
r_if
c_cond
(paren
id|active_high_low
)paren
op_star
id|active_high_low
op_assign
id|link-&gt;irq.active_high_low
suffix:semicolon
r_if
c_cond
(paren
id|name
)paren
op_star
id|name
op_assign
id|acpi_device_bid
c_func
(paren
id|link-&gt;device
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|link-&gt;irq.active
)paren
suffix:semicolon
)brace
multiline_comment|/* --------------------------------------------------------------------------&n;                                 Driver Interface&n;   -------------------------------------------------------------------------- */
r_static
r_int
DECL|function|acpi_pci_link_add
id|acpi_pci_link_add
(paren
r_struct
id|acpi_device
op_star
id|device
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_struct
id|acpi_pci_link
op_star
id|link
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_add&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|link
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|acpi_pci_link
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|link
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|acpi_pci_link
)paren
)paren
suffix:semicolon
id|link-&gt;device
op_assign
id|device
suffix:semicolon
id|link-&gt;handle
op_assign
id|device-&gt;handle
suffix:semicolon
id|strcpy
c_func
(paren
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
id|ACPI_PCI_LINK_DEVICE_NAME
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|acpi_device_class
c_func
(paren
id|device
)paren
comma
id|ACPI_PCI_LINK_CLASS
)paren
suffix:semicolon
id|acpi_driver_data
c_func
(paren
id|device
)paren
op_assign
id|link
suffix:semicolon
id|result
op_assign
id|acpi_pci_link_get_possible
c_func
(paren
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
r_goto
id|end
suffix:semicolon
multiline_comment|/* query and set link-&gt;irq.active */
id|acpi_pci_link_get_current
c_func
(paren
id|link
)paren
suffix:semicolon
id|printk
c_func
(paren
id|PREFIX
l_string|&quot;%s [%s] (IRQs&quot;
comma
id|acpi_device_name
c_func
(paren
id|device
)paren
comma
id|acpi_device_bid
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|link-&gt;irq.possible_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|link-&gt;irq.active
op_eq
id|link-&gt;irq.possible
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; *%d&quot;
comma
id|link-&gt;irq.possible
(braket
id|i
)braket
)paren
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot; %d&quot;
comma
id|link-&gt;irq.possible
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
id|printk
c_func
(paren
l_string|&quot; *%d&quot;
comma
id|link-&gt;irq.active
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link-&gt;device-&gt;status.enabled
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, disabled.&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* TBD: Acquire/release lock */
id|list_add_tail
c_func
(paren
op_amp
id|link-&gt;node
comma
op_amp
id|acpi_link.entries
)paren
suffix:semicolon
id|acpi_link.count
op_increment
suffix:semicolon
id|end
suffix:colon
multiline_comment|/* disable all links -- to be activated on use */
id|acpi_ut_evaluate_object
c_func
(paren
id|link-&gt;handle
comma
l_string|&quot;_DIS&quot;
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|kfree
c_func
(paren
id|link
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|result
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_pci_link_resume
id|acpi_pci_link_resume
(paren
r_struct
id|acpi_pci_link
op_star
id|link
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_resume&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;irq.active
op_logical_and
id|link-&gt;irq.initialized
)paren
id|return_VALUE
c_func
(paren
id|acpi_pci_link_set
c_func
(paren
id|link
comma
id|link-&gt;irq.active
)paren
)paren
suffix:semicolon
r_else
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|irqrouter_resume
id|irqrouter_resume
c_func
(paren
r_struct
id|sys_device
op_star
id|dev
)paren
(brace
r_struct
id|list_head
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|acpi_pci_link
op_star
id|link
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;irqrouter_resume&quot;
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|node
comma
op_amp
id|acpi_link.entries
)paren
(brace
id|link
op_assign
id|list_entry
c_func
(paren
id|node
comma
r_struct
id|acpi_pci_link
comma
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|link
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid link context&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|acpi_pci_link_resume
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|acpi_pci_link_remove
id|acpi_pci_link_remove
(paren
r_struct
id|acpi_device
op_star
id|device
comma
r_int
id|type
)paren
(brace
r_struct
id|acpi_pci_link
op_star
id|link
op_assign
l_int|NULL
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_remove&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
op_logical_or
op_logical_neg
id|acpi_driver_data
c_func
(paren
id|device
)paren
)paren
id|return_VALUE
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|link
op_assign
(paren
r_struct
id|acpi_pci_link
op_star
)paren
id|acpi_driver_data
c_func
(paren
id|device
)paren
suffix:semicolon
multiline_comment|/* TBD: Acquire/release lock */
id|list_del
c_func
(paren
op_amp
id|link-&gt;node
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|link
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * modify acpi_irq_penalty[] from cmdline&n; */
DECL|function|acpi_irq_penalty_update
r_static
r_int
id|__init
id|acpi_irq_penalty_update
c_func
(paren
r_char
op_star
id|str
comma
r_int
id|used
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
id|irq
suffix:semicolon
id|retval
op_assign
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_break
suffix:semicolon
multiline_comment|/* no number found */
r_if
c_cond
(paren
id|irq
OL
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
id|ACPI_MAX_IRQS
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|used
)paren
id|acpi_irq_penalty
(braket
id|irq
)braket
op_add_assign
id|PIRQ_PENALTY_ISA_USED
suffix:semicolon
r_else
id|acpi_irq_penalty
(braket
id|irq
)braket
op_assign
id|PIRQ_PENALTY_PCI_AVAILABLE
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|2
)paren
multiline_comment|/* no next number */
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * We&squot;d like PNP to call this routine for the&n; * single ISA_USED value for each legacy device.&n; * But instead it calls us with each POSSIBLE setting.&n; * There is no ISA_POSSIBLE weight, so we simply use&n; * the (small) PCI_USING penalty.&n; */
DECL|function|acpi_penalize_isa_irq
r_void
id|acpi_penalize_isa_irq
c_func
(paren
r_int
id|irq
)paren
(brace
id|acpi_irq_penalty
(braket
id|irq
)braket
op_add_assign
id|PIRQ_PENALTY_PCI_USING
suffix:semicolon
)brace
multiline_comment|/*&n; * Over-ride default table to reserve additional IRQs for use by ISA&n; * e.g. acpi_irq_isa=5&n; * Useful for telling ACPI how not to interfere with your ISA sound card.&n; */
DECL|function|acpi_irq_isa
r_static
r_int
id|__init
id|acpi_irq_isa
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
id|acpi_irq_penalty_update
c_func
(paren
id|str
comma
l_int|1
)paren
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;acpi_irq_isa=&quot;
comma
id|acpi_irq_isa
)paren
suffix:semicolon
multiline_comment|/*&n; * Over-ride default table to free additional IRQs for use by PCI&n; * e.g. acpi_irq_pci=7,15&n; * Used for acpi_irq_balance to free up IRQs to reduce PCI IRQ sharing.&n; */
DECL|function|acpi_irq_pci
r_static
r_int
id|__init
id|acpi_irq_pci
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_return
id|acpi_irq_penalty_update
c_func
(paren
id|str
comma
l_int|0
)paren
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;acpi_irq_pci=&quot;
comma
id|acpi_irq_pci
)paren
suffix:semicolon
DECL|function|acpi_irq_nobalance_set
r_static
r_int
id|__init
id|acpi_irq_nobalance_set
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|acpi_irq_balance
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;acpi_irq_nobalance&quot;
comma
id|acpi_irq_nobalance_set
)paren
suffix:semicolon
DECL|function|acpi_irq_balance_set
r_int
id|__init
id|acpi_irq_balance_set
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|acpi_irq_balance
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;acpi_irq_balance&quot;
comma
id|acpi_irq_balance_set
)paren
suffix:semicolon
DECL|variable|irqrouter_sysdev_class
r_static
r_struct
id|sysdev_class
id|irqrouter_sysdev_class
op_assign
(brace
id|set_kset_name
c_func
(paren
l_string|&quot;irqrouter&quot;
)paren
comma
dot
id|resume
op_assign
id|irqrouter_resume
comma
)brace
suffix:semicolon
DECL|variable|device_irqrouter
r_static
r_struct
id|sys_device
id|device_irqrouter
op_assign
(brace
dot
id|id
op_assign
l_int|0
comma
dot
id|cls
op_assign
op_amp
id|irqrouter_sysdev_class
comma
)brace
suffix:semicolon
DECL|function|irqrouter_init_sysfs
r_static
r_int
id|__init
id|irqrouter_init_sysfs
c_func
(paren
r_void
)paren
(brace
r_int
id|error
suffix:semicolon
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;irqrouter_init_sysfs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_disabled
op_logical_or
id|acpi_noirq
)paren
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|error
op_assign
id|sysdev_class_register
c_func
(paren
op_amp
id|irqrouter_sysdev_class
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|error
op_assign
id|sysdev_register
c_func
(paren
op_amp
id|device_irqrouter
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
id|error
)paren
suffix:semicolon
)brace
DECL|variable|irqrouter_init_sysfs
id|device_initcall
c_func
(paren
id|irqrouter_init_sysfs
)paren
suffix:semicolon
DECL|function|acpi_pci_link_init
r_static
r_int
id|__init
id|acpi_pci_link_init
(paren
r_void
)paren
(brace
id|ACPI_FUNCTION_TRACE
c_func
(paren
l_string|&quot;acpi_pci_link_init&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_noirq
)paren
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|acpi_link.count
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|acpi_link.entries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acpi_bus_register_driver
c_func
(paren
op_amp
id|acpi_pci_link_driver
)paren
OL
l_int|0
)paren
id|return_VALUE
c_func
(paren
op_minus
id|ENODEV
)paren
suffix:semicolon
id|return_VALUE
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|acpi_pci_link_init
id|subsys_initcall
c_func
(paren
id|acpi_pci_link_init
)paren
suffix:semicolon
eof
