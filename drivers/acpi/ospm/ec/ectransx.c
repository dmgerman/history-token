multiline_comment|/*****************************************************************************&n; *&n; * Module Name: ectransx.c&n; *   $Revision: 24 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000, 2001 Andrew Grover&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;acpi.h&gt;
macro_line|#include &quot;ec.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_EC
id|MODULE_NAME
(paren
l_string|&quot;ectransx&quot;
)paren
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    ec_io_wait&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|ec_io_wait
id|ec_io_wait
(paren
id|EC_CONTEXT
op_star
id|ec
comma
id|EC_EVENT
id|wait_event
)paren
(brace
id|EC_STATUS
id|ec_status
op_assign
l_int|0
suffix:semicolon
id|u32
id|i
op_assign
l_int|100
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
op_logical_or
(paren
(paren
id|wait_event
op_ne
id|EC_EVENT_OUTPUT_BUFFER_FULL
)paren
op_logical_and
(paren
id|wait_event
op_ne
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
)paren
)paren
(brace
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Wait for Event:&n;&t; * ---------------&n;&t; * Poll the EC status register waiting for the event to occur.&n;&t; * Note that we&squot;ll wait a maximum of 1ms in 10us chunks.&n;&t; */
r_switch
c_cond
(paren
id|wait_event
)paren
(brace
r_case
id|EC_EVENT_OUTPUT_BUFFER_FULL
suffix:colon
r_do
(brace
id|acpi_os_read_port
c_func
(paren
id|ec-&gt;status_port
comma
op_amp
id|ec_status
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec_status
op_amp
id|EC_FLAG_OUTPUT_BUFFER
)paren
(brace
r_return
id|AE_OK
suffix:semicolon
)brace
id|acpi_os_stall
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC_EVENT_INPUT_BUFFER_EMPTY
suffix:colon
r_do
(brace
id|acpi_os_read_port
c_func
(paren
id|ec-&gt;status_port
comma
op_amp
id|ec_status
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ec_status
op_amp
id|EC_FLAG_INPUT_BUFFER
)paren
)paren
(brace
r_return
id|AE_OK
suffix:semicolon
)brace
id|acpi_os_stall
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|AE_TIME
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    ec_io_read&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|ec_io_read
id|ec_io_read
(paren
id|EC_CONTEXT
op_star
id|ec
comma
id|ACPI_IO_ADDRESS
id|io_port
comma
id|u8
op_star
id|data
comma
id|EC_EVENT
id|wait_event
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
op_logical_or
op_logical_neg
id|data
)paren
(brace
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
)brace
id|acpi_os_read_port
c_func
(paren
id|io_port
comma
(paren
id|u32
op_star
)paren
id|data
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_event
)paren
(brace
id|status
op_assign
id|ec_io_wait
c_func
(paren
id|ec
comma
id|wait_event
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    ec_io_write&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|ec_io_write
id|ec_io_write
(paren
id|EC_CONTEXT
op_star
id|ec
comma
id|ACPI_IO_ADDRESS
id|io_port
comma
id|u8
id|data
comma
id|EC_EVENT
id|wait_event
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
)paren
(brace
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
)brace
id|acpi_os_write_port
c_func
(paren
id|io_port
comma
id|data
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_event
)paren
(brace
id|status
op_assign
id|ec_io_wait
c_func
(paren
id|ec
comma
id|wait_event
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    ec_read&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|ec_read
id|ec_read
(paren
id|EC_CONTEXT
op_star
id|ec
comma
id|u8
id|address
comma
id|u8
op_star
id|data
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_read&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
op_logical_or
op_logical_neg
id|data
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ec-&gt;use_global_lock
)paren
(brace
id|status
op_assign
id|acpi_acquire_global_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Could not acquire Global Lock&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;command_port
comma
id|EC_COMMAND_READ
comma
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to send &squot;read command&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
id|address
comma
id|EC_EVENT_OUTPUT_BUFFER_FULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to send &squot;read address&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_read
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
id|data
comma
id|EC_EVENT_NONE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec-&gt;use_global_lock
)paren
(brace
id|acpi_release_global_lock
c_func
(paren
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Read data [%02x] from address [%02x] on ec [%02x].&bslash;n&quot;
comma
(paren
op_star
id|data
)paren
comma
id|address
comma
id|ec-&gt;device_handle
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    ec_write&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|ec_write
id|ec_write
(paren
id|EC_CONTEXT
op_star
id|ec
comma
id|u8
id|address
comma
id|u8
id|data
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_write&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
)paren
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec-&gt;use_global_lock
)paren
(brace
id|status
op_assign
id|acpi_acquire_global_lock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Could not acquire Global Lock&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
)brace
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;command_port
comma
id|EC_COMMAND_WRITE
comma
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to send &squot;write command&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
id|address
comma
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to send &squot;write address&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|ec_io_write
c_func
(paren
id|ec
comma
id|ec-&gt;data_port
comma
id|data
comma
id|EC_EVENT_INPUT_BUFFER_EMPTY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to send &squot;write data&squot; to EC.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ec-&gt;use_global_lock
)paren
(brace
id|acpi_release_global_lock
c_func
(paren
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Wrote data [%02x] to address [%02x] on ec [%02x].&bslash;n&quot;
comma
id|data
comma
id|address
comma
id|ec-&gt;device_handle
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    ec_transaction&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|ec_transaction
id|ec_transaction
(paren
id|EC_CONTEXT
op_star
id|ec
comma
id|EC_REQUEST
op_star
id|request
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;ec_transaction&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ec
op_logical_or
op_logical_neg
id|request
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Obtain mutex to serialize all EC transactions.&n;&t; */
id|status
op_assign
id|acpi_os_wait_semaphore
c_func
(paren
id|ec-&gt;mutex
comma
l_int|1
comma
id|EC_DEFAULT_TIMEOUT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Perform the transaction.&n;&t; */
r_switch
c_cond
(paren
id|request-&gt;command
)paren
(brace
r_case
id|EC_COMMAND_READ
suffix:colon
id|status
op_assign
id|ec_read
c_func
(paren
id|ec
comma
id|request-&gt;address
comma
op_amp
(paren
id|request-&gt;data
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EC_COMMAND_WRITE
suffix:colon
id|status
op_assign
id|ec_write
c_func
(paren
id|ec
comma
id|request-&gt;address
comma
id|request-&gt;data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
id|AE_SUPPORT
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Signal the mutex to indicate transaction completion.&n;&t; */
id|acpi_os_signal_semaphore
c_func
(paren
id|ec-&gt;mutex
comma
l_int|1
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
eof
