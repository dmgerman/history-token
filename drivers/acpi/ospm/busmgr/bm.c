multiline_comment|/******************************************************************************&n; *&n; * Module Name: bm.c&n; *   $Revision: 47 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000, 2001 Andrew Grover&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;acpi.h&gt;
macro_line|#include &quot;bm.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_BUS
id|MODULE_NAME
(paren
l_string|&quot;bm&quot;
)paren
multiline_comment|/****************************************************************************&n; *                                  Globals&n; ****************************************************************************/
r_extern
id|fadt_descriptor_rev2
id|acpi_fadt
suffix:semicolon
multiline_comment|/* TBD: Make dynamically sizeable. */
DECL|variable|node_list
id|BM_NODE_LIST
id|node_list
suffix:semicolon
multiline_comment|/****************************************************************************&n; *                            Internal Functions&n; ****************************************************************************/
multiline_comment|/*****************************************************************************&n; *&n; * FUNCTION:    bm_print_object&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
r_void
DECL|function|bm_print_object
id|bm_print_object
(paren
id|acpi_handle
id|handle
)paren
(brace
id|acpi_buffer
id|buffer
suffix:semicolon
id|acpi_handle
id|parent
suffix:semicolon
id|acpi_object_type
id|type
suffix:semicolon
id|buffer.length
op_assign
l_int|256
suffix:semicolon
id|buffer.pointer
op_assign
id|acpi_os_callocate
c_func
(paren
id|buffer.length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer.pointer
)paren
(brace
r_return
suffix:semicolon
)brace
id|acpi_get_name
c_func
(paren
id|handle
comma
id|ACPI_FULL_PATHNAME
comma
op_amp
id|buffer
)paren
suffix:semicolon
id|acpi_get_parent
c_func
(paren
id|handle
comma
op_amp
id|parent
)paren
suffix:semicolon
id|acpi_get_type
c_func
(paren
id|handle
comma
op_amp
id|type
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * TBD: Hack to get around scope identification problem.&n;&t; */
r_if
c_cond
(paren
id|type
op_eq
id|ACPI_TYPE_ANY
)paren
(brace
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_next_object
c_func
(paren
id|ACPI_TYPE_ANY
comma
id|handle
comma
l_int|0
comma
l_int|NULL
)paren
)paren
)paren
(brace
id|type
op_assign
id|INTERNAL_TYPE_SCOPE
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|INTERNAL_TYPE_SCOPE
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;SCOPE: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_INTEGER
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;SIMPLE (number): &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_STRING
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;SIMPLE (string): &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_BUFFER
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;SIMPLE (buffer): &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PACKAGE
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;SIMPLE (package): &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_FIELD_UNIT
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;FIELD UNIT: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_DEVICE
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;DEVICE: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_EVENT
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;EVENT: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_METHOD
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;CONTROL METHOD: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_MUTEX
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;MUTEX: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_REGION
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;OPERATION REGION: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_POWER
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;POWER RESOURCE: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PROCESSOR
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;PROCESSOR: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_THERMAL
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;THERMAL ZONE: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_BUFFER_FIELD
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;BUFFER FIELD: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_DDB_HANDLE
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;DDB HANDLE: &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|acpi_os_printf
c_func
(paren
l_string|&quot;OTHER (%d): &quot;
comma
id|type
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|acpi_os_printf
c_func
(paren
l_string|&quot;Object[%p][%s] parent[%p].&bslash;n&quot;
comma
id|handle
comma
(paren
r_char
op_star
)paren
id|buffer.pointer
comma
id|parent
)paren
suffix:semicolon
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_print_node&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
r_void
DECL|function|bm_print_node
id|bm_print_node
(paren
id|BM_NODE
op_star
id|node
comma
id|u32
id|flags
)paren
(brace
macro_line|#ifdef ACPI_DEBUG
id|acpi_buffer
id|buffer
suffix:semicolon
id|BM_DEVICE
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|type_string
op_assign
l_int|NULL
suffix:semicolon
id|PROC_NAME
c_func
(paren
l_string|&quot;bm_print_node&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
r_return
suffix:semicolon
)brace
id|device
op_assign
op_amp
(paren
id|node-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|BM_PRINT_PRESENT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|BM_DEVICE_PRESENT
c_func
(paren
id|device
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
id|buffer.length
op_assign
l_int|256
suffix:semicolon
id|buffer.pointer
op_assign
id|acpi_os_callocate
c_func
(paren
id|buffer.length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer.pointer
)paren
(brace
r_return
suffix:semicolon
)brace
id|acpi_get_name
c_func
(paren
id|device-&gt;acpi_handle
comma
id|ACPI_FULL_PATHNAME
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|device-&gt;id.type
)paren
(brace
r_case
id|BM_TYPE_SYSTEM
suffix:colon
id|type_string
op_assign
l_string|&quot; System&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BM_TYPE_SCOPE
suffix:colon
id|type_string
op_assign
l_string|&quot;  Scope&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BM_TYPE_PROCESSOR
suffix:colon
id|type_string
op_assign
l_string|&quot;   Proc&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BM_TYPE_THERMAL_ZONE
suffix:colon
id|type_string
op_assign
l_string|&quot;Thermal&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BM_TYPE_POWER_RESOURCE
suffix:colon
id|type_string
op_assign
l_string|&quot;  Power&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BM_TYPE_FIXED_BUTTON
suffix:colon
id|type_string
op_assign
l_string|&quot; Button&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BM_TYPE_DEVICE
suffix:colon
id|type_string
op_assign
l_string|&quot; Device&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|type_string
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|BM_PRINT_GROUP
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;+-------------------------------------------------------------------------------&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;| %s[%02x]:[%p] flags[%02x] hid[%s] %s&bslash;n&quot;
comma
id|type_string
comma
id|device-&gt;handle
comma
id|device-&gt;acpi_handle
comma
id|device-&gt;flags
comma
(paren
id|device-&gt;id.hid
(braket
l_int|0
)braket
ques
c_cond
id|device-&gt;id.hid
suffix:colon
l_string|&quot;       &quot;
)paren
comma
id|buffer.pointer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|BM_PRINT_IDENTIFICATION
)paren
(brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;|   identification: uid[%s] adr[%08x]&bslash;n&quot;
comma
id|device-&gt;id.uid
comma
id|device-&gt;id.adr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|BM_PRINT_LINKAGE
)paren
(brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;|   linkage: this[%p] parent[%p] next[%p]&bslash;n&quot;
comma
id|node
comma
id|node-&gt;parent
comma
id|node-&gt;next
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;|     scope.head[%p] scope.tail[%p]&bslash;n&quot;
comma
id|node-&gt;scope.head
comma
id|node-&gt;scope.tail
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|BM_PRINT_POWER
)paren
(brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;|   power: state[D%d] flags[%08x]&bslash;n&quot;
comma
id|device-&gt;power.state
comma
id|device-&gt;power.flags
)paren
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;|     S0[%02x] S1[%02x] S2[%02x] S3[%02x] S4[%02x] S5[%02x]&bslash;n&quot;
comma
id|device-&gt;power.dx_supported
(braket
l_int|0
)braket
comma
id|device-&gt;power.dx_supported
(braket
l_int|1
)braket
comma
id|device-&gt;power.dx_supported
(braket
l_int|2
)braket
comma
id|device-&gt;power.dx_supported
(braket
l_int|3
)braket
comma
id|device-&gt;power.dx_supported
(braket
l_int|4
)braket
comma
id|device-&gt;power.dx_supported
(braket
l_int|5
)braket
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|BM_PRINT_GROUP
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;+-------------------------------------------------------------------------------&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
macro_line|#endif /*ACPI_DEBUG*/
r_return
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_print_hierarchy&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
r_void
DECL|function|bm_print_hierarchy
id|bm_print_hierarchy
(paren
r_void
)paren
(brace
macro_line|#ifdef ACPI_DEBUG
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_print_hierarchy&quot;
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;+------------------------------------------------------------&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|node_list.count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bm_print_node
c_func
(paren
id|node_list.nodes
(braket
id|i
)braket
comma
id|BM_PRINT_GROUP
op_or
id|BM_PRINT_PRESENT
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT_RAW
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;+------------------------------------------------------------&bslash;n&quot;
)paren
)paren
suffix:semicolon
macro_line|#endif /*ACPI_DEBUG*/
id|return_VOID
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_status&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_status
id|bm_get_status
(paren
id|BM_DEVICE
op_star
id|device
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
)brace
id|device-&gt;status
op_assign
id|BM_STATUS_UNKNOWN
suffix:semicolon
multiline_comment|/*&n;&t; * Dynamic Status?&n;&t; * ---------------&n;&t; * If _STA isn&squot;t present we just return the default status.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|device-&gt;flags
op_amp
id|BM_FLAGS_DYNAMIC_STATUS
)paren
)paren
(brace
id|device-&gt;status
op_assign
id|BM_STATUS_DEFAULT
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Evaluate _STA:&n;&t; * --------------&n;&t; */
id|status
op_assign
id|bm_evaluate_simple_integer
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_STA&quot;
comma
op_amp
(paren
id|device-&gt;status
)paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_identification&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_identification
id|bm_get_identification
(paren
id|BM_DEVICE
op_star
id|device
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_device_info
id|info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|device-&gt;flags
op_amp
id|BM_FLAGS_IDENTIFIABLE
)paren
)paren
(brace
r_return
id|AE_OK
suffix:semicolon
)brace
id|device-&gt;id.uid
(braket
l_int|0
)braket
op_assign
id|BM_UID_UNKNOWN
suffix:semicolon
id|device-&gt;id.hid
(braket
l_int|0
)braket
op_assign
id|BM_HID_UNKNOWN
suffix:semicolon
id|device-&gt;id.adr
op_assign
id|BM_ADDRESS_UNKNOWN
suffix:semicolon
multiline_comment|/*&n;&t; * Get Object Info:&n;&t; * ----------------&n;&t; * Evalute _UID, _HID, and _ADR...&n;&t; */
id|status
op_assign
id|acpi_get_object_info
c_func
(paren
id|device-&gt;acpi_handle
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_return
id|status
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info.valid
op_amp
id|ACPI_VALID_UID
)paren
(brace
id|MEMCPY
c_func
(paren
(paren
r_void
op_star
)paren
id|device-&gt;id.uid
comma
(paren
r_void
op_star
)paren
id|info.unique_id
comma
r_sizeof
(paren
id|BM_DEVICE_UID
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info.valid
op_amp
id|ACPI_VALID_HID
)paren
(brace
id|MEMCPY
c_func
(paren
(paren
r_void
op_star
)paren
id|device-&gt;id.hid
comma
(paren
r_void
op_star
)paren
id|info.hardware_id
comma
r_sizeof
(paren
id|BM_DEVICE_HID
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info.valid
op_amp
id|ACPI_VALID_ADR
)paren
(brace
id|device-&gt;id.adr
op_assign
id|info.address
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_flags&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_flags
id|bm_get_flags
(paren
id|BM_DEVICE
op_star
id|device
)paren
(brace
id|acpi_handle
id|acpi_handle
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
r_return
id|AE_BAD_PARAMETER
suffix:semicolon
)brace
id|device-&gt;flags
op_assign
id|BM_FLAGS_UNKNOWN
suffix:semicolon
r_switch
c_cond
(paren
id|device-&gt;id.type
)paren
(brace
r_case
id|BM_TYPE_DEVICE
suffix:colon
multiline_comment|/*&n;&t;&t; * Presence of _DCK indicates a docking station.&n;&t;&t; */
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_DCK&quot;
comma
op_amp
id|acpi_handle
)paren
)paren
)paren
(brace
id|device-&gt;flags
op_or_assign
id|BM_FLAGS_DOCKING_STATION
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Presence of _EJD and/or _EJx indicates &squot;ejectable&squot;.&n;&t;&t; * TBD: _EJx...&n;&t;&t; */
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_EJD&quot;
comma
op_amp
id|acpi_handle
)paren
)paren
)paren
(brace
id|device-&gt;flags
op_or_assign
id|BM_FLAGS_EJECTABLE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Presence of _PR0 or _PS0 indicates &squot;power manageable&squot;.&n;&t;&t; */
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_PR0&quot;
comma
op_amp
id|acpi_handle
)paren
)paren
op_logical_or
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_PS0&quot;
comma
op_amp
id|acpi_handle
)paren
)paren
)paren
(brace
id|device-&gt;flags
op_or_assign
id|BM_FLAGS_POWER_CONTROL
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Presence of _CRS indicates &squot;configurable&squot;.&n;&t;&t; */
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_CRS&quot;
comma
op_amp
id|acpi_handle
)paren
)paren
)paren
(brace
id|device-&gt;flags
op_or_assign
id|BM_FLAGS_CONFIGURABLE
suffix:semicolon
)brace
multiline_comment|/* Fall through to next case statement. */
r_case
id|BM_TYPE_PROCESSOR
suffix:colon
r_case
id|BM_TYPE_THERMAL_ZONE
suffix:colon
r_case
id|BM_TYPE_POWER_RESOURCE
suffix:colon
multiline_comment|/*&n;&t;&t; * Presence of _HID or _ADR indicates &squot;identifiable&squot;.&n;&t;&t; */
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_HID&quot;
comma
op_amp
id|acpi_handle
)paren
)paren
op_logical_or
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_ADR&quot;
comma
op_amp
id|acpi_handle
)paren
)paren
)paren
(brace
id|device-&gt;flags
op_or_assign
id|BM_FLAGS_IDENTIFIABLE
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Presence of _STA indicates &squot;dynamic status&squot;.&n;&t;&t; */
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|acpi_get_handle
c_func
(paren
id|device-&gt;acpi_handle
comma
l_string|&quot;_STA&quot;
comma
op_amp
id|acpi_handle
)paren
)paren
)paren
(brace
id|device-&gt;flags
op_or_assign
id|BM_FLAGS_DYNAMIC_STATUS
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
id|AE_OK
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_add_namespace_device&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_add_namespace_device
id|bm_add_namespace_device
(paren
id|acpi_handle
id|acpi_handle
comma
id|acpi_object_type
id|acpi_type
comma
id|BM_NODE
op_star
id|parent
comma
id|BM_NODE
op_star
op_star
id|child
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|BM_DEVICE
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_add_namespace_device&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parent
op_logical_or
op_logical_neg
id|child
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node_list.count
OG
id|BM_HANDLES_MAX
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
(paren
op_star
id|child
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Create Node:&n;&t; * ------------&n;&t; */
id|node
op_assign
id|acpi_os_callocate
c_func
(paren
r_sizeof
(paren
id|BM_NODE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|node-&gt;parent
op_assign
id|parent
suffix:semicolon
id|node-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|device
op_assign
op_amp
(paren
id|node-&gt;device
)paren
suffix:semicolon
id|device-&gt;handle
op_assign
id|node_list.count
suffix:semicolon
id|device-&gt;acpi_handle
op_assign
id|acpi_handle
suffix:semicolon
multiline_comment|/*&n;&t; * Device Type:&n;&t; * ------------&n;&t; */
r_switch
c_cond
(paren
id|acpi_type
)paren
(brace
r_case
id|INTERNAL_TYPE_SCOPE
suffix:colon
id|device-&gt;id.type
op_assign
id|BM_TYPE_SCOPE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PROCESSOR
suffix:colon
id|device-&gt;id.type
op_assign
id|BM_TYPE_PROCESSOR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_THERMAL
suffix:colon
id|device-&gt;id.type
op_assign
id|BM_TYPE_THERMAL_ZONE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_POWER
suffix:colon
id|device-&gt;id.type
op_assign
id|BM_TYPE_POWER_RESOURCE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_DEVICE
suffix:colon
id|device-&gt;id.type
op_assign
id|BM_TYPE_DEVICE
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get Other Device Info:&n;&t; * ----------------------&n;&t; * But only if this device&squot;s parent is present (which implies&n;&t; * this device MAY be present).&n;&t; */
r_if
c_cond
(paren
id|BM_NODE_PRESENT
c_func
(paren
id|node-&gt;parent
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Device Flags&n;&t;&t; */
id|status
op_assign
id|bm_get_flags
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Device Identification&n;&t;&t; */
id|status
op_assign
id|bm_get_identification
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Device Status&n;&t;&t; */
id|status
op_assign
id|bm_get_status
c_func
(paren
id|device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Power Management:&n;&t;&t; * -----------------&n;&t;&t; * If this node doesn&squot;t provide direct power control&n;&t;&t; * then we inherit PM capabilities from its parent.&n;&t;&t; *&n;&t;&t; * TBD: Inherit!&n;&t;&t; */
r_if
c_cond
(paren
id|BM_IS_POWER_CONTROL
c_func
(paren
id|device
)paren
)paren
(brace
id|status
op_assign
id|bm_get_pm_capabilities
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
)brace
)brace
id|end
suffix:colon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|acpi_os_free
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Add to the node_list.&n;&t;&t; */
id|node_list.nodes
(braket
id|node_list.count
op_increment
)braket
op_assign
id|node
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Formulate Hierarchy:&n;&t;&t; * --------------------&n;&t;&t; * Arrange within the namespace by assigning the parent and&n;&t;&t; * adding to the parent device&squot;s list of children (scope).&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|parent-&gt;scope.head
)paren
(brace
id|parent-&gt;scope.head
op_assign
id|node
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|parent-&gt;scope.tail
)paren
(brace
(paren
id|parent-&gt;scope.head
)paren
op_member_access_from_pointer
id|next
op_assign
id|node
suffix:semicolon
)brace
r_else
(brace
(paren
id|parent-&gt;scope.tail
)paren
op_member_access_from_pointer
id|next
op_assign
id|node
suffix:semicolon
)brace
)brace
id|parent-&gt;scope.tail
op_assign
id|node
suffix:semicolon
(paren
op_star
id|child
)paren
op_assign
id|node
suffix:semicolon
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_enumerate_namespace&n; *&n; * PARAMETERS:  &lt;none&gt;&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_enumerate_namespace
id|bm_enumerate_namespace
(paren
r_void
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_handle
id|parent_handle
op_assign
id|ACPI_ROOT_OBJECT
suffix:semicolon
id|acpi_handle
id|child_handle
op_assign
l_int|NULL
suffix:semicolon
id|BM_NODE
op_star
id|parent
op_assign
l_int|NULL
suffix:semicolon
id|BM_NODE
op_star
id|child
op_assign
l_int|NULL
suffix:semicolon
id|acpi_object_type
id|acpi_type
op_assign
l_int|0
suffix:semicolon
id|u32
id|level
op_assign
l_int|1
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_enumerate_namespace&quot;
)paren
suffix:semicolon
id|parent
op_assign
id|node_list.nodes
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Enumerate ACPI Namespace:&n;&t; * -------------------------&n;&t; * Parse through the ACPI namespace, identify all &squot;devices&squot;,&n;&t; * and create a new entry for each in our collection.&n;&t; */
r_while
c_loop
(paren
id|level
OG
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Get the next object at this level.&n;&t;&t; */
id|status
op_assign
id|acpi_get_next_object
c_func
(paren
id|ACPI_TYPE_ANY
comma
id|parent_handle
comma
id|child_handle
comma
op_amp
id|child_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * TBD: This is a hack to get around the problem&n;&t;&t;&t; *       identifying scope objects.  Scopes&n;&t;&t;&t; *       somehow need to be uniquely identified.&n;&t;&t;&t; */
id|status
op_assign
id|acpi_get_type
c_func
(paren
id|child_handle
comma
op_amp
id|acpi_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
op_logical_and
(paren
id|acpi_type
op_eq
id|ACPI_TYPE_ANY
)paren
)paren
(brace
id|status
op_assign
id|acpi_get_next_object
c_func
(paren
id|ACPI_TYPE_ANY
comma
id|child_handle
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|acpi_type
op_assign
id|INTERNAL_TYPE_SCOPE
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t;&t; * Device?&n;&t;&t;&t; * -------&n;&t;&t;&t; * If this object is a &squot;device&squot;, insert into the&n;&t;&t;&t; * ACPI Bus Manager&squot;s local hierarchy and search&n;&t;&t;&t; * the object&squot;s scope for any child devices (a&n;&t;&t;&t; * depth-first search).&n;&t;&t;&t; */
r_switch
c_cond
(paren
id|acpi_type
)paren
(brace
r_case
id|INTERNAL_TYPE_SCOPE
suffix:colon
r_case
id|ACPI_TYPE_DEVICE
suffix:colon
r_case
id|ACPI_TYPE_PROCESSOR
suffix:colon
r_case
id|ACPI_TYPE_THERMAL
suffix:colon
r_case
id|ACPI_TYPE_POWER
suffix:colon
id|status
op_assign
id|bm_add_namespace_device
c_func
(paren
id|child_handle
comma
id|acpi_type
comma
id|parent
comma
op_amp
id|child
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|status
op_assign
id|acpi_get_next_object
c_func
(paren
id|ACPI_TYPE_ANY
comma
id|child_handle
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|level
op_increment
suffix:semicolon
id|parent_handle
op_assign
id|child_handle
suffix:semicolon
id|child_handle
op_assign
l_int|0
suffix:semicolon
id|parent
op_assign
id|child
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * Scope Exhausted:&n;&t;&t; * ----------------&n;&t;&t; * No more children in this object&squot;s scope, Go back up&n;&t;&t; * in the namespace tree to the object&squot;s parent.&n;&t;&t; */
r_else
(brace
id|level
op_decrement
suffix:semicolon
id|child_handle
op_assign
id|parent_handle
suffix:semicolon
id|acpi_get_parent
c_func
(paren
id|parent_handle
comma
op_amp
id|parent_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parent
)paren
(brace
id|parent
op_assign
id|parent-&gt;parent
suffix:semicolon
)brace
r_else
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NULL_ENTRY
)paren
suffix:semicolon
)brace
)brace
)brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_add_fixed_feature_device&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_add_fixed_feature_device
id|bm_add_fixed_feature_device
(paren
id|BM_NODE
op_star
id|parent
comma
id|BM_DEVICE_TYPE
id|device_type
comma
r_char
op_star
id|device_hid
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_add_fixed_feature_device&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parent
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node_list.count
OG
id|BM_HANDLES_MAX
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Allocate the new device and add to the device array.&n;&t; */
id|node
op_assign
id|acpi_os_callocate
c_func
(paren
r_sizeof
(paren
id|BM_NODE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get device info.&n;&t; */
id|node-&gt;device.handle
op_assign
id|node_list.count
suffix:semicolon
id|node-&gt;device.acpi_handle
op_assign
id|ACPI_ROOT_OBJECT
suffix:semicolon
id|node-&gt;device.id.type
op_assign
id|BM_TYPE_FIXED_BUTTON
suffix:semicolon
r_if
c_cond
(paren
id|device_hid
)paren
(brace
id|MEMCPY
c_func
(paren
(paren
r_void
op_star
)paren
id|node-&gt;device.id.hid
comma
id|device_hid
comma
r_sizeof
(paren
id|node-&gt;device.id.hid
)paren
)paren
suffix:semicolon
)brace
id|node-&gt;device.flags
op_assign
id|BM_FLAGS_FIXED_FEATURE
suffix:semicolon
id|node-&gt;device.status
op_assign
id|BM_STATUS_DEFAULT
suffix:semicolon
multiline_comment|/* TBD: Device PM capabilities */
multiline_comment|/*&n;&t; * Add to the node_list.&n;&t; */
id|node_list.nodes
(braket
id|node_list.count
op_increment
)braket
op_assign
id|node
suffix:semicolon
multiline_comment|/*&n;&t; * Formulate Hierarchy:&n;&t; * --------------------&n;&t; * Arrange within the namespace by assigning the parent and&n;&t; * adding to the parent device&squot;s list of children (scope).&n;&t; */
id|node-&gt;parent
op_assign
id|parent
suffix:semicolon
id|node-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|parent
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|parent-&gt;scope.head
)paren
(brace
id|parent-&gt;scope.head
op_assign
id|node
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|parent-&gt;scope.tail
)paren
(brace
(paren
id|parent-&gt;scope.head
)paren
op_member_access_from_pointer
id|next
op_assign
id|node
suffix:semicolon
)brace
r_else
(brace
(paren
id|parent-&gt;scope.tail
)paren
op_member_access_from_pointer
id|next
op_assign
id|node
suffix:semicolon
)brace
)brace
id|parent-&gt;scope.tail
op_assign
id|node
suffix:semicolon
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_enumerate_fixed_features&n; *&n; * PARAMETERS:  &lt;none&gt;&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_enumerate_fixed_features
id|bm_enumerate_fixed_features
(paren
r_void
)paren
(brace
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_enumerate_fixed_features&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Root Object:&n;&t; * ------------&n;&t; * Fabricate the root object, which happens to always get a&n;&t; * device_handle of zero.&n;&t; */
id|node_list.nodes
(braket
l_int|0
)braket
op_assign
id|acpi_os_callocate
c_func
(paren
r_sizeof
(paren
id|BM_NODE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
id|node_list.nodes
(braket
l_int|0
)braket
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
id|node_list.nodes
(braket
l_int|0
)braket
op_member_access_from_pointer
id|device.handle
op_assign
id|BM_HANDLE_ROOT
suffix:semicolon
id|node_list.nodes
(braket
l_int|0
)braket
op_member_access_from_pointer
id|device.acpi_handle
op_assign
id|ACPI_ROOT_OBJECT
suffix:semicolon
id|node_list.nodes
(braket
l_int|0
)braket
op_member_access_from_pointer
id|device.flags
op_assign
id|BM_FLAGS_UNKNOWN
suffix:semicolon
id|node_list.nodes
(braket
l_int|0
)braket
op_member_access_from_pointer
id|device.status
op_assign
id|BM_STATUS_DEFAULT
suffix:semicolon
id|node_list.nodes
(braket
l_int|0
)braket
op_member_access_from_pointer
id|device.id.type
op_assign
id|BM_TYPE_SYSTEM
suffix:semicolon
multiline_comment|/* TBD: Get system PM capabilities (Sx states?) */
id|node_list.count
op_increment
suffix:semicolon
multiline_comment|/*&n;&t; * Fixed Features:&n;&t; * ---------------&n;&t; * Enumerate fixed-feature devices (e.g. power and sleep buttons).&n;&t; */
r_if
c_cond
(paren
id|acpi_fadt.pwr_button
op_eq
l_int|0
)paren
(brace
id|bm_add_fixed_feature_device
c_func
(paren
id|node_list.nodes
(braket
l_int|0
)braket
comma
id|BM_TYPE_FIXED_BUTTON
comma
id|BM_HID_POWER_BUTTON
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_fadt.sleep_button
op_eq
l_int|0
)paren
(brace
id|bm_add_fixed_feature_device
c_func
(paren
id|node_list.nodes
(braket
l_int|0
)braket
comma
id|BM_TYPE_FIXED_BUTTON
comma
id|BM_HID_SLEEP_BUTTON
)paren
suffix:semicolon
)brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_handle&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_handle
id|bm_get_handle
(paren
id|acpi_handle
id|acpi_handle
comma
id|BM_HANDLE
op_star
id|device_handle
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_NOT_FOUND
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_get_handle&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device_handle
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
op_star
id|device_handle
op_assign
id|BM_HANDLE_UNKNOWN
suffix:semicolon
multiline_comment|/*&n;&t; * Search all devices for a match on the ACPI handle.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|node_list.count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|node_list.nodes
(braket
id|i
)braket
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid (NULL) node entry [%02x] detected.&bslash;n&quot;
comma
id|device_handle
)paren
)paren
suffix:semicolon
id|status
op_assign
id|AE_NULL_ENTRY
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node_list.nodes
(braket
id|i
)braket
op_member_access_from_pointer
id|device.acpi_handle
op_eq
id|acpi_handle
)paren
(brace
op_star
id|device_handle
op_assign
id|node_list.nodes
(braket
id|i
)braket
op_member_access_from_pointer
id|device.handle
suffix:semicolon
id|status
op_assign
id|AE_OK
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_node&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_node
id|bm_get_node
(paren
id|BM_HANDLE
id|device_handle
comma
id|acpi_handle
id|acpi_handle
comma
id|BM_NODE
op_star
op_star
id|node
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_get_node&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
multiline_comment|/* busmgr failed to init, but we&squot;re being called by subordinate drivers */
r_if
c_cond
(paren
id|node_list.count
OL
l_int|1
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NOT_FOUND
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If no device handle, resolve acpi handle to device handle.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|device_handle
op_logical_and
id|acpi_handle
)paren
(brace
id|status
op_assign
id|bm_get_handle
c_func
(paren
id|acpi_handle
comma
op_amp
id|device_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Valid device handle?&n;&t; */
r_if
c_cond
(paren
id|device_handle
OG
id|BM_HANDLES_MAX
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid node handle [%02x] detected.&bslash;n&quot;
comma
id|device_handle
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_ERROR
)paren
suffix:semicolon
)brace
op_star
id|node
op_assign
id|node_list.nodes
(braket
id|device_handle
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Valid node?&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|node
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Invalid (NULL) node entry [%02x] detected.&bslash;n&quot;
comma
id|device_handle
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_NULL_ENTRY
)paren
suffix:semicolon
)brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                            External Functions&n; ****************************************************************************/
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_initialize&n; *&n; * PARAMETERS:  &lt;none&gt;&n; *&n; * RETURN:      Exception code.&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_initialize
id|bm_initialize
(paren
r_void
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|u32
id|start
op_assign
l_int|0
suffix:semicolon
id|u32
id|stop
op_assign
l_int|0
suffix:semicolon
id|u32
id|elapsed
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_initialize&quot;
)paren
suffix:semicolon
id|MEMSET
c_func
(paren
op_amp
id|node_list
comma
l_int|0
comma
r_sizeof
(paren
id|BM_NODE_LIST
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_get_timer
c_func
(paren
op_amp
id|start
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Building device hierarchy.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Enumerate ACPI fixed-feature devices.&n;&t; */
id|status
op_assign
id|bm_enumerate_fixed_features
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Enumerate the ACPI namespace.&n;&t; */
id|status
op_assign
id|bm_enumerate_namespace
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|acpi_get_timer
c_func
(paren
op_amp
id|stop
)paren
suffix:semicolon
id|acpi_get_timer_duration
c_func
(paren
id|start
comma
id|stop
comma
op_amp
id|elapsed
)paren
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Building device hierarchy took [%d] microseconds.&bslash;n&quot;
comma
id|elapsed
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Display hierarchy.&n;&t; */
id|bm_print_hierarchy
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Register for all standard and device-specific notifications.&n;&t; */
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Registering for all device notifications.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_install_notify_handler
c_func
(paren
id|ACPI_ROOT_OBJECT
comma
id|ACPI_SYSTEM_NOTIFY
comma
op_amp
id|bm_notify
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to register for standard notifications.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_install_notify_handler
c_func
(paren
id|ACPI_ROOT_OBJECT
comma
id|ACPI_DEVICE_NOTIFY
comma
op_amp
id|bm_notify
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to register for device-specific notifications.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;ACPI Bus Manager enabled.&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize built-in power resource driver.&n;&t; */
id|bm_pr_initialize
c_func
(paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_terminate&n; *&n; * PARAMETERS:  &lt;none&gt;&n; *&n; * RETURN:      Exception code.&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_terminate
id|bm_terminate
(paren
r_void
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_terminate&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Terminate built-in power resource driver.&n;&t; */
id|bm_pr_terminate
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Unregister for all notifications.&n;&t; */
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Unregistering for device notifications.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|status
op_assign
id|acpi_remove_notify_handler
c_func
(paren
id|ACPI_ROOT_OBJECT
comma
id|ACPI_SYSTEM_NOTIFY
comma
op_amp
id|bm_notify
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to un-register for standard notifications.&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
id|status
op_assign
id|acpi_remove_notify_handler
c_func
(paren
id|ACPI_ROOT_OBJECT
comma
id|ACPI_DEVICE_NOTIFY
comma
op_amp
id|bm_notify
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_ERROR
comma
l_string|&quot;Unable to un-register for device-specific notifications.&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Parse through the device array, freeing all entries.&n;&t; */
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Removing device hierarchy.&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|node_list.count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|node_list.nodes
(braket
id|i
)braket
)paren
(brace
id|acpi_os_free
c_func
(paren
id|node_list.nodes
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;ACPI Bus Manager disabled.&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
eof
