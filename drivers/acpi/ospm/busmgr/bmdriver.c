multiline_comment|/*****************************************************************************&n; *&n; * Module Name: bmdriver.c&n; *   $Revision: 21 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000, 2001 Andrew Grover&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;acpi.h&gt;
macro_line|#include &quot;bm.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_BUS
id|MODULE_NAME
(paren
l_string|&quot;bmdriver&quot;
)paren
multiline_comment|/****************************************************************************&n; *                            External Functions&n; ****************************************************************************/
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_device_power_state&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_device_power_state
id|bm_get_device_power_state
(paren
id|BM_HANDLE
id|device_handle
comma
id|BM_POWER_STATE
op_star
id|state
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_get_device_power_state&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
op_star
id|state
op_assign
id|ACPI_STATE_UNKNOWN
suffix:semicolon
multiline_comment|/*&n;&t; * Resolve device handle to node.&n;&t; */
id|status
op_assign
id|bm_get_node
c_func
(paren
id|device_handle
comma
l_int|0
comma
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get the current power state.&n;&t; */
id|status
op_assign
id|bm_get_power_state
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
op_star
id|state
op_assign
id|node-&gt;device.power.state
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_set_device_power_state&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_set_device_power_state
id|bm_set_device_power_state
(paren
id|BM_HANDLE
id|device_handle
comma
id|BM_POWER_STATE
id|state
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_set_device_power_state&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Resolve device handle to node.&n;&t; */
id|status
op_assign
id|bm_get_node
c_func
(paren
id|device_handle
comma
l_int|0
comma
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set the current power state.&n;&t; */
id|status
op_assign
id|bm_set_power_state
c_func
(paren
id|node
comma
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_device_status&n; *&n; * PARAMETERS:&n; *    device_handle is really an index number into the array of BM_DEVICE&n; *                  structures in info_list.  This data item is passed to&n; *                  the registered program&squot;s &quot;notify&quot; callback.  It is used&n; *                  to retrieve the specific BM_DEVICE structure instance&n; *                  associated with the callback.&n; *    device_status is a pointer that receives the result of processing&n; *                  the device&squot;s associated ACPI _STA.&n; *&n; * RETURN:&n; *    The acpi_status value indicates success AE_OK or failure of the function&n; *&n; * DESCRIPTION: Evaluates the device&squot;s ACPI _STA, if it is present.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_device_status
id|bm_get_device_status
(paren
id|BM_HANDLE
id|device_handle
comma
id|BM_DEVICE_STATUS
op_star
id|device_status
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_get_device_status&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device_status
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
op_star
id|device_status
op_assign
id|BM_STATUS_UNKNOWN
suffix:semicolon
multiline_comment|/*&n;&t; * Resolve device handle to node.&n;&t; */
id|status
op_assign
id|bm_get_node
c_func
(paren
id|device_handle
comma
l_int|0
comma
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Parent Present?&n;&t; * ---------------&n;&t; * If the parent isn&squot;t present we can&squot;t evalute _STA on the child.&n;&t; * Return an unknown status.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|BM_NODE_PRESENT
c_func
(paren
id|node-&gt;parent
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Dynamic Status?&n;&t; * ---------------&n;&t; * If _STA isn&squot;t present we just return the default status.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|node-&gt;device.flags
op_amp
id|BM_FLAGS_DYNAMIC_STATUS
)paren
)paren
(brace
op_star
id|device_status
op_assign
id|BM_STATUS_DEFAULT
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Evaluate _STA:&n;&t; * --------------&n;&t; */
id|status
op_assign
id|bm_evaluate_simple_integer
c_func
(paren
id|node-&gt;device.acpi_handle
comma
l_string|&quot;_STA&quot;
comma
op_amp
(paren
id|node-&gt;device.status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
op_star
id|device_status
op_assign
id|node-&gt;device.status
suffix:semicolon
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_device_info&n; *&n; * PARAMETERS:&n; *    device_handle An index used to retrieve the associated BM_DEVICE info.&n; *    device        A pointer to a BM_DEVICE structure instance pointer.&n; *                  This pointed to BM_DEVICE structure will contain the&n; *                  this device&squot;s information.&n; *&n; * RETURN:&n; *    The acpi_status value indicates success AE_OK or failure of the function&n; *&n; * DESCRIPTION:&n; *    Using the device_handle this function retrieves this device&squot;s&n; *    BM_DEVICE structure instance and save&squot;s it in device.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_device_info
id|bm_get_device_info
(paren
id|BM_HANDLE
id|device_handle
comma
id|BM_DEVICE
op_star
op_star
id|device
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_get_device_info&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Resolve device handle to internal device.&n;&t; */
id|status
op_assign
id|bm_get_node
c_func
(paren
id|device_handle
comma
l_int|0
comma
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
op_star
id|device
op_assign
op_amp
(paren
id|node-&gt;device
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_get_device_context&n; *&n; *    device_handle An index used to retrieve the associated BM_DEVICE info.&n; *    context       A pointer to a BM_DRIVER_CONTEXT structure instance.&n; *&n; * RETURN:&n; *    The acpi_status value indicates success AE_OK or failure of the function&n; *&n; * DESCRIPTION:&n; *    Using the device_handle this function retrieves this device&squot;s&n; *    BM_DRIVER_CONTEXT structure instance and save&squot;s it in context.&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_get_device_context
id|bm_get_device_context
(paren
id|BM_HANDLE
id|device_handle
comma
id|BM_DRIVER_CONTEXT
op_star
id|context
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_get_device_context&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|context
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
op_star
id|context
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * Resolve device handle to internal device.&n;&t; */
id|status
op_assign
id|bm_get_node
c_func
(paren
id|device_handle
comma
l_int|0
comma
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|node-&gt;driver.context
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NULL_ENTRY
)paren
suffix:semicolon
)brace
op_star
id|context
op_assign
id|node-&gt;driver.context
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_register_driver&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_register_driver
id|bm_register_driver
(paren
id|BM_DEVICE_ID
op_star
id|criteria
comma
id|BM_DRIVER
op_star
id|driver
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_NOT_FOUND
suffix:semicolon
id|BM_HANDLE_LIST
id|device_list
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|BM_DEVICE
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_register_driver&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|criteria
op_logical_or
op_logical_neg
id|driver
op_logical_or
op_logical_neg
id|driver-&gt;notify
op_logical_or
op_logical_neg
id|driver-&gt;request
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|MEMSET
c_func
(paren
op_amp
id|device_list
comma
l_int|0
comma
r_sizeof
(paren
id|BM_HANDLE_LIST
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Find Matches:&n;&t; * -------------&n;&t; * Search through the entire device hierarchy for matches against&n;&t; * the given device criteria.&n;&t; */
id|status
op_assign
id|bm_search
c_func
(paren
id|BM_HANDLE_ROOT
comma
id|criteria
comma
op_amp
id|device_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Install driver:&n;&t; * ----------------&n;&t; * For each match, record the driver information and execute the&n;&t; * driver&squot;s Notify() funciton (if present) to notify the driver&n;&t; * of the device&squot;s presence.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|device_list.count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Resolve the device handle. */
id|status
op_assign
id|bm_get_node
c_func
(paren
id|device_list.handles
(braket
id|i
)braket
comma
l_int|0
comma
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|device
op_assign
op_amp
(paren
id|node-&gt;device
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Make sure another driver hasn&squot;t already registered for&n;&t;&t; * this device.&n;&t;&t; */
r_if
c_cond
(paren
id|BM_IS_DRIVER_CONTROL
c_func
(paren
id|device
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Another driver has already registered for device [%02x].&bslash;n&quot;
comma
id|device-&gt;handle
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Registering driver for device [%02x].&bslash;n&quot;
comma
id|device-&gt;handle
)paren
)paren
suffix:semicolon
multiline_comment|/* Notify driver of new device. */
id|status
op_assign
id|driver
op_member_access_from_pointer
id|notify
c_func
(paren
id|BM_NOTIFY_DEVICE_ADDED
comma
id|node-&gt;device.handle
comma
op_amp
(paren
id|node-&gt;driver.context
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|node-&gt;driver.notify
op_assign
id|driver-&gt;notify
suffix:semicolon
id|node-&gt;driver.request
op_assign
id|driver-&gt;request
suffix:semicolon
id|node-&gt;device.flags
op_or_assign
id|BM_FLAGS_DRIVER_CONTROL
suffix:semicolon
)brace
)brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_unregister_driver&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_unregister_driver
id|bm_unregister_driver
(paren
id|BM_DEVICE_ID
op_star
id|criteria
comma
id|BM_DRIVER
op_star
id|driver
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_NOT_FOUND
suffix:semicolon
id|BM_HANDLE_LIST
id|device_list
suffix:semicolon
id|BM_NODE
op_star
id|node
op_assign
l_int|NULL
suffix:semicolon
id|BM_DEVICE
op_star
id|device
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_unregister_driver&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|criteria
op_logical_or
op_logical_neg
id|driver
op_logical_or
op_logical_neg
id|driver-&gt;notify
op_logical_or
op_logical_neg
id|driver-&gt;request
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|MEMSET
c_func
(paren
op_amp
id|device_list
comma
l_int|0
comma
r_sizeof
(paren
id|BM_HANDLE_LIST
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Find Matches:&n;&t; * -------------&n;&t; * Search through the entire device hierarchy for matches against&n;&t; * the given device criteria.&n;&t; */
id|status
op_assign
id|bm_search
c_func
(paren
id|BM_HANDLE_ROOT
comma
id|criteria
comma
op_amp
id|device_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Remove driver:&n;&t; * ---------------&n;&t; * For each match, execute the driver&squot;s Notify() function to allow&n;&t; * the driver to cleanup each device instance.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|device_list.count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Resolve the device handle. */
id|status
op_assign
id|bm_get_node
c_func
(paren
id|device_list.handles
(braket
id|i
)braket
comma
l_int|0
comma
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_continue
suffix:semicolon
)brace
id|device
op_assign
op_amp
(paren
id|node-&gt;device
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Make sure driver has really registered for this device.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|BM_IS_DRIVER_CONTROL
c_func
(paren
id|device
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Driver hasn&squot;t registered for device [%02x].&bslash;n&quot;
comma
id|device-&gt;handle
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Unregistering driver for device [%02x].&bslash;n&quot;
comma
id|device-&gt;handle
)paren
)paren
suffix:semicolon
multiline_comment|/* Notify driver of device removal. */
id|status
op_assign
id|node-&gt;driver
dot
id|notify
c_func
(paren
id|BM_NOTIFY_DEVICE_REMOVED
comma
id|node-&gt;device.handle
comma
op_amp
(paren
id|node-&gt;driver.context
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|node-&gt;driver.notify
op_assign
l_int|NULL
suffix:semicolon
id|node-&gt;driver.request
op_assign
l_int|NULL
suffix:semicolon
id|node-&gt;driver.context
op_assign
l_int|NULL
suffix:semicolon
id|node-&gt;device.flags
op_and_assign
op_complement
id|BM_FLAGS_DRIVER_CONTROL
suffix:semicolon
)brace
)brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
eof
