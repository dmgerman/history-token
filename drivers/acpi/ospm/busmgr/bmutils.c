multiline_comment|/*****************************************************************************&n; *&n; * Module Name: bmutils.c&n; *   $Revision: 38 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000, 2001 Andrew Grover&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#include &lt;acpi.h&gt;
macro_line|#include &quot;bm.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_BUS
id|MODULE_NAME
(paren
l_string|&quot;bmutils&quot;
)paren
macro_line|#ifdef ACPI_DEBUG
DECL|macro|DEBUG_EVAL_ERROR
mdefine_line|#define DEBUG_EVAL_ERROR(l,h,p,s)    bm_print_eval_error(l,h,p,s)
macro_line|#else
mdefine_line|#define DEBUG_EVAL_ERROR(l,h,p,s)
macro_line|#endif
multiline_comment|/****************************************************************************&n; *                            External Functions&n; ****************************************************************************/
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_print_eval_error&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
r_void
DECL|function|bm_print_eval_error
id|bm_print_eval_error
(paren
id|u32
id|debug_level
comma
id|acpi_handle
id|handle
comma
id|acpi_string
id|pathname
comma
id|acpi_status
id|status
)paren
(brace
id|acpi_buffer
id|buffer
suffix:semicolon
id|acpi_status
id|local_status
suffix:semicolon
id|PROC_NAME
c_func
(paren
l_string|&quot;bm_print_eval_error&quot;
)paren
suffix:semicolon
id|buffer.length
op_assign
l_int|256
suffix:semicolon
id|buffer.pointer
op_assign
id|acpi_os_callocate
c_func
(paren
id|buffer.length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer.pointer
)paren
(brace
r_return
suffix:semicolon
)brace
id|local_status
op_assign
id|acpi_get_name
c_func
(paren
id|handle
comma
id|ACPI_FULL_PATHNAME
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|local_status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
c_func
(paren
(paren
id|ACPI_DEBUG_LEVEL
c_func
(paren
id|debug_level
)paren
comma
l_string|&quot;Evaluate object [%p], %s&bslash;n&quot;
comma
id|handle
comma
id|acpi_format_exception
c_func
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pathname
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Evaluate object [%s.%s], %s&bslash;n&quot;
comma
id|buffer.pointer
comma
id|pathname
comma
id|acpi_format_exception
c_func
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Evaluate object [%s], %s&bslash;n&quot;
comma
id|buffer.pointer
comma
id|acpi_format_exception
c_func
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
)brace
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_copy_to_buffer&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_copy_to_buffer
id|bm_copy_to_buffer
(paren
id|acpi_buffer
op_star
id|buffer
comma
r_void
op_star
id|data
comma
id|u32
id|length
)paren
(brace
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_copy_to_buffer&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
op_logical_or
(paren
op_logical_neg
id|buffer-&gt;pointer
)paren
op_logical_or
op_logical_neg
id|data
op_logical_or
(paren
id|length
op_eq
l_int|0
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
OG
id|buffer-&gt;length
)paren
(brace
id|buffer-&gt;length
op_assign
id|length
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_BUFFER_OVERFLOW
)paren
suffix:semicolon
)brace
id|buffer-&gt;length
op_assign
id|length
suffix:semicolon
id|MEMCPY
c_func
(paren
id|buffer-&gt;pointer
comma
id|data
comma
id|length
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_cast_buffer&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_cast_buffer
id|bm_cast_buffer
(paren
id|acpi_buffer
op_star
id|buffer
comma
r_void
op_star
op_star
id|pointer
comma
id|u32
id|length
)paren
(brace
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_cast_buffer&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
op_logical_or
op_logical_neg
id|buffer-&gt;pointer
op_logical_or
op_logical_neg
id|pointer
op_logical_or
id|length
op_eq
l_int|0
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
OG
id|buffer-&gt;length
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_DATA
)paren
suffix:semicolon
)brace
op_star
id|pointer
op_assign
id|buffer-&gt;pointer
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_extract_package_data&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
multiline_comment|/*&n; * TBD: Don&squot;t assume numbers (in ASL) are 32-bit values!!!!  (IA64)&n; * TBD: Issue with &squot;assumed&squot; types coming out of interpreter...&n; *       (e.g. toshiba _BIF)&n; */
id|acpi_status
DECL|function|bm_extract_package_data
id|bm_extract_package_data
(paren
id|acpi_object
op_star
id|package
comma
id|acpi_buffer
op_star
id|package_format
comma
id|acpi_buffer
op_star
id|buffer
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|u8
op_star
id|head
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
id|tail
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
op_star
id|pointer
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|tail_offset
op_assign
l_int|0
suffix:semicolon
id|acpi_object
op_star
id|element
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|size_required
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|format
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|format_count
op_assign
l_int|0
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_extract_package_data&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|package
op_logical_or
(paren
id|package-&gt;type
op_ne
id|ACPI_TYPE_PACKAGE
)paren
op_logical_or
(paren
id|package-&gt;package.count
op_eq
l_int|0
)paren
op_logical_or
op_logical_neg
id|package_format
op_logical_or
(paren
id|package_format-&gt;length
OL
l_int|1
)paren
op_logical_or
(paren
op_logical_neg
id|package_format-&gt;pointer
)paren
op_logical_or
op_logical_neg
id|buffer
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|format_count
op_assign
id|package_format-&gt;length
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|format_count
OG
id|package-&gt;package.count
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Format specifies more objects [%d] than exist in package [%d].&quot;
comma
id|format_count
comma
id|package-&gt;package.count
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_DATA
)paren
suffix:semicolon
)brace
id|format
op_assign
(paren
r_char
op_star
)paren
id|package_format-&gt;pointer
suffix:semicolon
multiline_comment|/*&n;&t; * Calculate size_required.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|format_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|element
op_assign
op_amp
(paren
id|package-&gt;package.elements
(braket
id|i
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|element-&gt;type
)paren
(brace
r_case
id|ACPI_TYPE_INTEGER
suffix:colon
r_switch
c_cond
(paren
id|format
(braket
id|i
)braket
)paren
(brace
r_case
l_char|&squot;N&squot;
suffix:colon
id|size_required
op_add_assign
r_sizeof
(paren
id|acpi_integer
)paren
suffix:semicolon
id|tail_offset
op_add_assign
r_sizeof
(paren
id|acpi_integer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;S&squot;
suffix:colon
id|size_required
op_add_assign
r_sizeof
(paren
id|u8
op_star
)paren
op_plus
r_sizeof
(paren
id|acpi_integer
)paren
op_plus
l_int|1
suffix:semicolon
id|tail_offset
op_add_assign
r_sizeof
(paren
id|acpi_integer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Invalid package element [%d]: got number, expecing [%c].&bslash;n&quot;
comma
id|i
comma
id|format
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_STRING
suffix:colon
r_case
id|ACPI_TYPE_BUFFER
suffix:colon
r_switch
c_cond
(paren
id|format
(braket
id|i
)braket
)paren
(brace
r_case
l_char|&squot;S&squot;
suffix:colon
id|size_required
op_add_assign
r_sizeof
(paren
id|u8
op_star
)paren
op_plus
id|element-&gt;string.length
op_plus
l_int|1
suffix:semicolon
id|tail_offset
op_add_assign
r_sizeof
(paren
id|u8
op_star
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;B&squot;
suffix:colon
id|size_required
op_add_assign
r_sizeof
(paren
id|u8
op_star
)paren
op_plus
id|element-&gt;buffer.length
suffix:semicolon
id|tail_offset
op_add_assign
r_sizeof
(paren
id|u8
op_star
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Invalid package element [%d] got string/buffer, expecing [%c].&bslash;n&quot;
comma
id|i
comma
id|format
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PACKAGE
suffix:colon
r_default
suffix:colon
multiline_comment|/* TBD: handle nested packages... */
id|return_ACPI_STATUS
c_func
(paren
id|AE_SUPPORT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|size_required
OG
id|buffer-&gt;length
)paren
(brace
id|buffer-&gt;length
op_assign
id|size_required
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_BUFFER_OVERFLOW
)paren
suffix:semicolon
)brace
id|buffer-&gt;length
op_assign
id|size_required
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer-&gt;pointer
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|head
op_assign
id|buffer-&gt;pointer
suffix:semicolon
id|tail
op_assign
id|buffer-&gt;pointer
op_plus
id|tail_offset
suffix:semicolon
multiline_comment|/*&n;&t; * Extract package data:&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|format_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|element
op_assign
op_amp
(paren
id|package-&gt;package.elements
(braket
id|i
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|element-&gt;type
)paren
(brace
r_case
id|ACPI_TYPE_INTEGER
suffix:colon
r_switch
c_cond
(paren
id|format
(braket
id|i
)braket
)paren
(brace
r_case
l_char|&squot;N&squot;
suffix:colon
op_star
(paren
(paren
id|acpi_integer
op_star
)paren
id|head
)paren
op_assign
id|element-&gt;integer.value
suffix:semicolon
id|head
op_add_assign
r_sizeof
(paren
id|acpi_integer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;S&squot;
suffix:colon
id|pointer
op_assign
(paren
id|u8
op_star
op_star
)paren
id|head
suffix:semicolon
op_star
id|pointer
op_assign
id|tail
suffix:semicolon
op_star
(paren
(paren
id|acpi_integer
op_star
)paren
id|tail
)paren
op_assign
id|element-&gt;integer.value
suffix:semicolon
id|head
op_add_assign
r_sizeof
(paren
id|acpi_integer
op_star
)paren
suffix:semicolon
id|tail
op_add_assign
r_sizeof
(paren
id|acpi_integer
)paren
suffix:semicolon
multiline_comment|/* NULL terminate string */
op_star
id|tail
op_assign
l_int|0
suffix:semicolon
id|tail
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Should never get here */
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_STRING
suffix:colon
r_case
id|ACPI_TYPE_BUFFER
suffix:colon
r_switch
c_cond
(paren
id|format
(braket
id|i
)braket
)paren
(brace
r_case
l_char|&squot;S&squot;
suffix:colon
id|pointer
op_assign
(paren
id|u8
op_star
op_star
)paren
id|head
suffix:semicolon
op_star
id|pointer
op_assign
id|tail
suffix:semicolon
id|memcpy
c_func
(paren
id|tail
comma
id|element-&gt;string.pointer
comma
id|element-&gt;string.length
)paren
suffix:semicolon
id|head
op_add_assign
r_sizeof
(paren
id|u8
op_star
)paren
suffix:semicolon
id|tail
op_add_assign
id|element-&gt;string.length
suffix:semicolon
multiline_comment|/* NULL terminate string */
op_star
id|tail
op_assign
l_int|0
suffix:semicolon
id|tail
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;B&squot;
suffix:colon
id|pointer
op_assign
(paren
id|u8
op_star
op_star
)paren
id|head
suffix:semicolon
op_star
id|pointer
op_assign
id|tail
suffix:semicolon
id|memcpy
c_func
(paren
id|tail
comma
id|element-&gt;buffer.pointer
comma
id|element-&gt;buffer.length
)paren
suffix:semicolon
id|head
op_add_assign
r_sizeof
(paren
id|u8
op_star
)paren
suffix:semicolon
id|tail
op_add_assign
id|element-&gt;buffer.length
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Should never get here */
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ACPI_TYPE_PACKAGE
suffix:colon
multiline_comment|/* TBD: handle nested packages... */
r_default
suffix:colon
multiline_comment|/* Should never get here */
r_break
suffix:semicolon
)brace
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_evaluate_object&n; *&n; * PARAMETERS:&n; *&n; * RETURN:      AE_OK&n; *              AE_BUFFER_OVERFLOW  Evaluated object returned data, but&n; *                                  caller did not provide buffer.&n; *&n; * DESCRIPTION: Helper for acpi_evaluate_object that handles buffer&n; *              allocation.  Note that the caller is responsible for&n; *              freeing buffer-&gt;pointer!&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_evaluate_object
id|bm_evaluate_object
(paren
id|acpi_handle
id|handle
comma
id|acpi_string
id|pathname
comma
id|acpi_object_list
op_star
id|arguments
comma
id|acpi_buffer
op_star
id|buffer
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_evaluate_object&quot;
)paren
suffix:semicolon
multiline_comment|/* If caller provided a buffer it must be unallocated/zero&squot;d. */
r_if
c_cond
(paren
(paren
id|buffer
)paren
op_logical_and
(paren
id|buffer-&gt;length
op_ne
l_int|0
op_logical_or
id|buffer-&gt;pointer
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Evalute Object:&n;&t; * ---------------&n;&t; * The first attempt is just to get the size of the object data&n;&t; * (that is unless there&squot;s no return data, e.g. _INI); the second&n;&t; * gets the data.&n;&t; */
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
id|pathname
comma
id|arguments
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|buffer
)paren
op_logical_and
(paren
id|status
op_eq
id|AE_BUFFER_OVERFLOW
)paren
)paren
(brace
multiline_comment|/* Gotta allocate -- CALLER MUST FREE! */
id|buffer-&gt;pointer
op_assign
id|acpi_os_callocate
c_func
(paren
id|buffer-&gt;length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer-&gt;pointer
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_NO_MEMORY
)paren
suffix:semicolon
)brace
multiline_comment|/* Re-evaluate -- this time it should work */
id|status
op_assign
id|acpi_evaluate_object
c_func
(paren
id|handle
comma
id|pathname
comma
id|arguments
comma
id|buffer
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_ne
id|AE_NOT_FOUND
)paren
(brace
id|DEBUG_EVAL_ERROR
c_func
(paren
id|ACPI_LV_WARN
comma
id|handle
comma
id|pathname
comma
id|status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buffer
op_logical_and
id|buffer-&gt;pointer
)paren
(brace
id|acpi_os_free
c_func
(paren
id|buffer-&gt;pointer
)paren
suffix:semicolon
id|buffer-&gt;pointer
op_assign
l_int|NULL
suffix:semicolon
id|buffer-&gt;length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_evaluate_simple_integer&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_evaluate_simple_integer
id|bm_evaluate_simple_integer
(paren
id|acpi_handle
id|handle
comma
id|acpi_string
id|pathname
comma
id|u32
op_star
id|data
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_object
op_star
id|element
op_assign
l_int|NULL
suffix:semicolon
id|acpi_buffer
id|buffer
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_evaluate_simple_integer&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|MEMSET
c_func
(paren
op_amp
id|buffer
comma
l_int|0
comma
r_sizeof
(paren
id|acpi_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Evaluate Object:&n;&t; * ----------------&n;&t; */
id|status
op_assign
id|bm_evaluate_object
c_func
(paren
id|handle
comma
id|pathname
comma
l_int|NULL
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;failed to evaluate object (%s)&bslash;n&quot;
comma
id|acpi_format_exception
c_func
(paren
id|status
)paren
)paren
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Validate Data:&n;&t; * --------------&n;&t; */
id|status
op_assign
id|bm_cast_buffer
c_func
(paren
op_amp
id|buffer
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|element
comma
r_sizeof
(paren
id|acpi_object
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_EVAL_ERROR
c_func
(paren
id|ACPI_LV_WARN
comma
id|handle
comma
id|pathname
comma
id|status
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|element-&gt;type
op_ne
id|ACPI_TYPE_INTEGER
)paren
(brace
id|status
op_assign
id|AE_BAD_DATA
suffix:semicolon
id|DEBUG_EVAL_ERROR
c_func
(paren
id|ACPI_LV_WARN
comma
id|handle
comma
id|pathname
comma
id|status
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
op_star
id|data
op_assign
id|element-&gt;integer.value
suffix:semicolon
id|end
suffix:colon
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    bm_evaluate_reference_list&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|bm_evaluate_reference_list
id|bm_evaluate_reference_list
(paren
id|acpi_handle
id|handle
comma
id|acpi_string
id|pathname
comma
id|BM_HANDLE_LIST
op_star
id|reference_list
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|acpi_object
op_star
id|package
op_assign
l_int|NULL
suffix:semicolon
id|acpi_object
op_star
id|element
op_assign
l_int|NULL
suffix:semicolon
id|acpi_handle
id|reference_handle
op_assign
l_int|NULL
suffix:semicolon
id|acpi_buffer
id|buffer
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;bm_evaluate_reference_list&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reference_list
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|MEMSET
c_func
(paren
op_amp
id|buffer
comma
l_int|0
comma
r_sizeof
(paren
id|acpi_buffer
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Evaluate Object:&n;&t; * ----------------&n;&t; */
id|status
op_assign
id|bm_evaluate_object
c_func
(paren
id|handle
comma
id|pathname
comma
l_int|NULL
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
r_goto
id|end
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Validate Package:&n;&t; * -----------------&n;&t; */
id|status
op_assign
id|bm_cast_buffer
c_func
(paren
op_amp
id|buffer
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|package
comma
r_sizeof
(paren
id|acpi_object
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|DEBUG_EVAL_ERROR
c_func
(paren
id|ACPI_LV_WARN
comma
id|handle
comma
id|pathname
comma
id|status
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|package-&gt;type
op_ne
id|ACPI_TYPE_PACKAGE
)paren
(brace
id|status
op_assign
id|AE_BAD_DATA
suffix:semicolon
id|DEBUG_EVAL_ERROR
c_func
(paren
id|ACPI_LV_WARN
comma
id|handle
comma
id|pathname
comma
id|status
)paren
suffix:semicolon
r_goto
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|package-&gt;package.count
OG
id|BM_HANDLES_MAX
)paren
(brace
id|package-&gt;package.count
op_assign
id|BM_HANDLES_MAX
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Parse Package Data:&n;&t; * -------------------&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|package-&gt;package.count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|element
op_assign
op_amp
(paren
id|package-&gt;package.elements
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|element
op_logical_or
(paren
id|element-&gt;type
op_ne
id|ACPI_TYPE_STRING
)paren
)paren
(brace
id|status
op_assign
id|AE_BAD_DATA
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Invalid element in package (not a device reference).&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|DEBUG_EVAL_ERROR
(paren
id|ACPI_LV_WARN
comma
id|handle
comma
id|pathname
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Resolve reference string (e.g. &quot;&bslash;_PR_.CPU_&quot;) to an&n;&t;&t; * acpi_handle.&n;&t;&t; */
id|status
op_assign
id|acpi_get_handle
c_func
(paren
id|handle
comma
id|element-&gt;string.pointer
comma
op_amp
id|reference_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|status
op_assign
id|AE_BAD_DATA
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to resolve device reference [%s].&bslash;n&quot;
comma
id|element-&gt;string.pointer
)paren
)paren
suffix:semicolon
id|DEBUG_EVAL_ERROR
(paren
id|ACPI_LV_WARN
comma
id|handle
comma
id|pathname
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Resolve acpi_handle to BM_HANDLE.&n;&t;&t; */
id|status
op_assign
id|bm_get_handle
c_func
(paren
id|reference_handle
comma
op_amp
(paren
id|reference_list-&gt;handles
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
(brace
id|status
op_assign
id|AE_BAD_DATA
suffix:semicolon
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_WARN
comma
l_string|&quot;Unable to resolve device reference for [%p].&bslash;n&quot;
comma
id|reference_handle
)paren
)paren
suffix:semicolon
id|DEBUG_EVAL_ERROR
(paren
id|ACPI_LV_WARN
comma
id|handle
comma
id|pathname
comma
id|status
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Resolved reference [%s]-&gt;[%p]-&gt;[%02x]&bslash;n&quot;
comma
id|element-&gt;string.pointer
comma
id|reference_handle
comma
id|reference_list-&gt;handles
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
(paren
id|reference_list-&gt;count
)paren
op_increment
suffix:semicolon
)brace
id|end
suffix:colon
id|acpi_os_free
c_func
(paren
id|buffer.pointer
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
eof
