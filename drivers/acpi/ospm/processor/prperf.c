multiline_comment|/*****************************************************************************&n; *&n; * Module Name: prperf.c&n; *              $Revision: 19 $&n; *&n; *****************************************************************************/
multiline_comment|/*&n; *  Copyright (C) 2000, 2001 Andrew Grover&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
multiline_comment|/*&n; * TBD: 1. Support ACPI 2.0 processor performance states (not just throttling).&n; *      2. Fully implement thermal -vs- power management limit control.&n; */
macro_line|#include &lt;acpi.h&gt;
macro_line|#include &lt;bm.h&gt;
macro_line|#include &quot;pr.h&quot;
DECL|macro|_COMPONENT
mdefine_line|#define _COMPONENT&t;&t;ACPI_PROCESSOR
id|MODULE_NAME
(paren
l_string|&quot;prperf&quot;
)paren
multiline_comment|/****************************************************************************&n; *                                  Globals&n; ****************************************************************************/
r_extern
id|fadt_descriptor_rev2
id|acpi_fadt
suffix:semicolon
DECL|variable|POWER_OF_2
r_const
id|u32
id|POWER_OF_2
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|2
comma
l_int|4
comma
l_int|8
comma
l_int|16
comma
l_int|32
comma
l_int|64
comma
l_int|128
comma
l_int|256
comma
l_int|512
)brace
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    pr_perf_get_frequency&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|pr_perf_get_frequency
id|pr_perf_get_frequency
(paren
id|PR_CONTEXT
op_star
id|processor
comma
id|u32
op_star
id|frequency
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;pr_perf_get_frequency&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|processor
op_logical_or
op_logical_neg
id|frequency
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
multiline_comment|/* TBD: Generic method to calculate processor frequency. */
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    pr_perf_get_state&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&t;&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
multiline_comment|/* TBD:&t;Include support for _real_ performance states (not just throttling). */
id|acpi_status
DECL|function|pr_perf_get_state
id|pr_perf_get_state
(paren
id|PR_CONTEXT
op_star
id|processor
comma
id|u32
op_star
id|state
)paren
(brace
id|u32
id|pblk_value
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_mask
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_cycle
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;pr_perf_get_state&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|processor
op_logical_or
op_logical_neg
id|state
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|processor-&gt;performance.state_count
op_eq
l_int|1
)paren
(brace
op_star
id|state
op_assign
l_int|0
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
id|acpi_os_read_port
c_func
(paren
id|processor-&gt;pblk.address
comma
op_amp
id|pblk_value
comma
l_int|32
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Throttling Enabled?&n;&t; * -------------------&n;&t; * If so, calculate the current throttling state, otherwise return&n;&t; * &squot;100% performance&squot; (state 0).&n;&t; */
r_if
c_cond
(paren
id|pblk_value
op_amp
l_int|0x00000010
)paren
(brace
id|duty_mask
op_assign
id|processor-&gt;performance.state_count
op_minus
l_int|1
suffix:semicolon
id|duty_mask
op_lshift_assign
id|acpi_fadt.duty_offset
suffix:semicolon
id|duty_cycle
op_assign
id|pblk_value
op_amp
id|duty_mask
suffix:semicolon
id|duty_cycle
op_rshift_assign
id|acpi_fadt.duty_offset
suffix:semicolon
r_if
c_cond
(paren
id|duty_cycle
op_eq
l_int|0
)paren
(brace
op_star
id|state
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
op_star
id|state
op_assign
id|processor-&gt;performance.state_count
op_minus
id|duty_cycle
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|state
op_assign
l_int|0
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Processor [%02x] is at performance state [%d%%].&bslash;n&quot;
comma
id|processor-&gt;device_handle
comma
id|processor-&gt;performance.state
(braket
op_star
id|state
)braket
dot
id|performance
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    pr_perf_set_state&n; *&n; * PARAMETERS:&n; *&n; * RETURN:      AE_OK&n; *              AE_BAD_PARAMETER&n; *              AE_BAD_DATA         Invalid target throttling state.&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
multiline_comment|/* TBD: Includes support for _real_ performance states (not just throttling). */
id|acpi_status
DECL|function|pr_perf_set_state
id|pr_perf_set_state
(paren
id|PR_CONTEXT
op_star
id|processor
comma
id|u32
id|state
)paren
(brace
id|u32
id|pblk_value
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_mask
op_assign
l_int|0
suffix:semicolon
id|u32
id|duty_cycle
op_assign
l_int|0
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;pr_perf_set_state&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|processor
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state
OG
(paren
id|processor-&gt;performance.state_count
op_minus
l_int|1
)paren
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_DATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|processor-&gt;performance.state_count
op_eq
l_int|1
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Calculate Duty Cycle/Mask:&n;&t; * --------------------------&n;&t; * Note that we don&squot;t support duty_cycle values that span bit 4.&n;&t; */
r_if
c_cond
(paren
id|state
)paren
(brace
id|duty_cycle
op_assign
id|processor-&gt;performance.state_count
op_minus
id|state
suffix:semicolon
id|duty_cycle
op_lshift_assign
id|acpi_fadt.duty_offset
suffix:semicolon
)brace
r_else
(brace
id|duty_cycle
op_assign
l_int|0
suffix:semicolon
)brace
id|duty_mask
op_assign
op_complement
(paren
(paren
id|u32
)paren
(paren
id|processor-&gt;performance.state_count
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|acpi_fadt.duty_offset
suffix:semicolon
id|i
op_increment
)paren
(brace
id|duty_mask
op_lshift_assign
id|acpi_fadt.duty_offset
suffix:semicolon
id|duty_mask
op_add_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Disable Throttling:&n;&t; * -------------------&n;&t; * Got to turn it off before you can change the duty_cycle value.&n;&t; * Throttling is disabled by writing a 0 to bit 4.&n;&t; */
id|acpi_os_read_port
c_func
(paren
id|processor-&gt;pblk.address
comma
op_amp
id|pblk_value
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pblk_value
op_amp
l_int|0x00000010
)paren
(brace
id|pblk_value
op_and_assign
l_int|0xFFFFFFEF
suffix:semicolon
id|acpi_os_write_port
c_func
(paren
id|processor-&gt;pblk.address
comma
id|pblk_value
comma
l_int|32
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set Duty Cycle:&n;&t; * ---------------&n;&t; * Mask off the old duty_cycle value, mask in the new.&n;&t; */
id|pblk_value
op_and_assign
id|duty_mask
suffix:semicolon
id|pblk_value
op_or_assign
id|duty_cycle
suffix:semicolon
id|acpi_os_write_port
c_func
(paren
id|processor-&gt;pblk.address
comma
id|pblk_value
comma
l_int|32
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Enable Throttling:&n;&t; * ------------------&n;&t; * But only for non-zero (non-100% performance) states.&n;&t; */
r_if
c_cond
(paren
id|state
)paren
(brace
id|pblk_value
op_or_assign
l_int|0x00000010
suffix:semicolon
id|acpi_os_write_port
c_func
(paren
id|processor-&gt;pblk.address
comma
id|pblk_value
comma
l_int|32
)paren
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Processor [%02x] set to performance state [%d%%].&bslash;n&quot;
comma
id|processor-&gt;device_handle
comma
id|processor-&gt;performance.state
(braket
id|state
)braket
dot
id|performance
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|AE_OK
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    pr_perf_set_limit&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|pr_perf_set_limit
id|pr_perf_set_limit
(paren
id|PR_CONTEXT
op_star
id|processor
comma
id|u32
id|limit
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|PR_PERFORMANCE
op_star
id|performance
op_assign
l_int|NULL
suffix:semicolon
id|FUNCTION_TRACE
(paren
l_string|&quot;pr_perf_set_limit&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|processor
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|performance
op_assign
op_amp
(paren
id|processor-&gt;performance
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set Limit:&n;&t; * ----------&n;&t; * TBD:  Properly manage thermal and power limits (only set&n;&t; *&t; performance state iff...).&n;&t; */
r_switch
c_cond
(paren
id|limit
)paren
(brace
r_case
id|PR_PERF_DEC
suffix:colon
r_if
c_cond
(paren
id|performance-&gt;active_state
OL
(paren
id|performance-&gt;state_count
op_minus
l_int|1
)paren
)paren
(brace
id|status
op_assign
id|pr_perf_set_state
c_func
(paren
id|processor
comma
(paren
id|performance-&gt;active_state
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PR_PERF_INC
suffix:colon
r_if
c_cond
(paren
id|performance-&gt;active_state
OG
l_int|0
)paren
(brace
id|status
op_assign
id|pr_perf_set_state
c_func
(paren
id|processor
comma
(paren
id|performance-&gt;active_state
op_plus
l_int|1
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PR_PERF_MAX
suffix:colon
r_if
c_cond
(paren
id|performance-&gt;active_state
op_ne
l_int|0
)paren
(brace
id|status
op_assign
id|pr_perf_set_state
c_func
(paren
id|processor
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
id|performance-&gt;thermal_limit
op_assign
id|limit
suffix:semicolon
)brace
id|ACPI_DEBUG_PRINT
(paren
(paren
id|ACPI_DB_INFO
comma
l_string|&quot;Processor [%02x] thermal performance limit set to [%d%%].&bslash;n&quot;
comma
id|processor-&gt;device_handle
comma
id|processor-&gt;performance.state
(braket
id|performance-&gt;active_state
)braket
dot
id|performance
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *                             External Functions&n; ****************************************************************************/
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    pr_perf_add_device&n; *&n; * PARAMETERS:  processor&t;&t;Our processor-specific context.&n; *&n; * RETURN:      AE_OK&n; *              AE_BAD_PARAMETER&n; *&n; * DESCRIPTION: Calculates the number of throttling states and the state&n; *              performance/power values.&n; *&n; ****************************************************************************/
multiline_comment|/* TBD: Support duty_cycle values that span bit 4. */
id|acpi_status
DECL|function|pr_perf_add_device
id|pr_perf_add_device
(paren
id|PR_CONTEXT
op_star
id|processor
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|u32
id|i
op_assign
l_int|0
suffix:semicolon
id|u32
id|performance_step
op_assign
l_int|0
suffix:semicolon
id|u32
id|percentage
op_assign
l_int|0
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;pr_perf_add_device&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|processor
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Valid PBLK?&n;&t; * -----------&n;&t; * For SMP it is common to have the first (boot) processor have a&n;&t; * valid PBLK while all others do not -- which implies that&n;&t; * throttling has system-wide effects (duty_cycle programmed into&n;&t; * the chipset effects all processors).&n;&t; */
r_if
c_cond
(paren
(paren
id|processor-&gt;pblk.length
OL
l_int|6
)paren
op_logical_or
op_logical_neg
id|processor-&gt;pblk.address
)paren
(brace
id|processor-&gt;performance.state_count
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Valid Duty Offset/Width?&n;&t; * ------------------------&n;&t; * We currently only support duty_cycle values that fall within&n;&t; * bits 0-3, as things get complicated when this value spans bit 4&n;&t; * (the throttling enable/disable bit).&n;&t; */
r_else
r_if
c_cond
(paren
(paren
id|acpi_fadt.duty_offset
op_plus
id|acpi_fadt.duty_width
)paren
OG
l_int|4
)paren
(brace
id|processor-&gt;performance.state_count
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Compute State Count:&n;&t; * --------------------&n;&t; * The number of throttling states is computed as 2^duty_width,&n;&t; * but limited by PR_MAX_THROTTLE_STATES.  Note that a duty_width&n;&t; * of zero results is one throttling state (100%).&n;&t; */
r_else
(brace
id|processor-&gt;performance.state_count
op_assign
id|POWER_OF_2
(braket
id|acpi_fadt.duty_width
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|processor-&gt;performance.state_count
OG
id|PR_MAX_THROTTLE_STATES
)paren
(brace
id|processor-&gt;performance.state_count
op_assign
id|PR_MAX_THROTTLE_STATES
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Compute State Values:&n;&t; * ---------------------&n;&t; * Note that clock throttling displays a linear power/performance&n;&t; * relationship (at 50% performance the CPU will consume 50% power).&n;&t; */
id|performance_step
op_assign
(paren
l_int|1000
op_div
id|processor-&gt;performance.state_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|processor-&gt;performance.state_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|percentage
op_assign
(paren
l_int|1000
op_minus
(paren
id|performance_step
op_star
id|i
)paren
)paren
op_div
l_int|10
suffix:semicolon
id|processor-&gt;performance.state
(braket
id|i
)braket
dot
id|performance
op_assign
id|percentage
suffix:semicolon
id|processor-&gt;performance.state
(braket
id|i
)braket
dot
id|power
op_assign
id|percentage
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Get Current State:&n;&t; * ------------------&n;&t; */
id|status
op_assign
id|pr_perf_get_state
c_func
(paren
id|processor
comma
op_amp
(paren
id|processor-&gt;performance.active_state
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * FUNCTION:    pr_perf_remove_device&n; *&n; * PARAMETERS:&n; *&n; * RETURN:&t;&n; *&n; * DESCRIPTION:&n; *&n; ****************************************************************************/
id|acpi_status
DECL|function|pr_perf_remove_device
id|pr_perf_remove_device
(paren
id|PR_CONTEXT
op_star
id|processor
)paren
(brace
id|acpi_status
id|status
op_assign
id|AE_OK
suffix:semicolon
id|FUNCTION_TRACE
c_func
(paren
l_string|&quot;pr_perf_remove_device&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|processor
)paren
(brace
id|return_ACPI_STATUS
c_func
(paren
id|AE_BAD_PARAMETER
)paren
suffix:semicolon
)brace
id|MEMSET
c_func
(paren
op_amp
(paren
id|processor-&gt;performance
)paren
comma
l_int|0
comma
r_sizeof
(paren
id|PR_PERFORMANCE
)paren
)paren
suffix:semicolon
id|return_ACPI_STATUS
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
eof
