multiline_comment|/*&n; *  Keyboard driver for Sharp Corgi models (SL-C7xx)&n; *&n; *  Copyright (c) 2004-2005 Richard Purdie&n; *&n; *  Based on xtkbd.c/locomkbd.c&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License version 2 as&n; *  published by the Free Software Foundation.&n; *&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/arch/corgi.h&gt;
macro_line|#include &lt;asm/arch/hardware.h&gt;
macro_line|#include &lt;asm/arch/pxa-regs.h&gt;
macro_line|#include &lt;asm/hardware/scoop.h&gt;
DECL|macro|KB_ROWS
mdefine_line|#define KB_ROWS&t;&t;&t;&t;8
DECL|macro|KB_COLS
mdefine_line|#define KB_COLS&t;&t;&t;&t;12
DECL|macro|KB_ROWMASK
mdefine_line|#define KB_ROWMASK(r)&t;&t;(1 &lt;&lt; (r))
DECL|macro|SCANCODE
mdefine_line|#define SCANCODE(r,c)&t;&t;( ((r)&lt;&lt;4) + (c) + 1 )
multiline_comment|/* zero code, 124 scancodes + 3 hinge combinations */
DECL|macro|NR_SCANCODES
mdefine_line|#define&t;NR_SCANCODES&t;&t;( SCANCODE(KB_ROWS-1,KB_COLS-1) +1 +1 +3 )
DECL|macro|SCAN_INTERVAL
mdefine_line|#define SCAN_INTERVAL&t;&t;(HZ/10)
DECL|macro|CORGIKBD_PRESSED
mdefine_line|#define CORGIKBD_PRESSED&t;1
DECL|macro|HINGE_SCAN_INTERVAL
mdefine_line|#define HINGE_SCAN_INTERVAL&t;&t;(HZ/4)
DECL|macro|CORGI_KEY_CALENDER
mdefine_line|#define CORGI_KEY_CALENDER&t;KEY_F1
DECL|macro|CORGI_KEY_ADDRESS
mdefine_line|#define CORGI_KEY_ADDRESS&t;KEY_F2
DECL|macro|CORGI_KEY_FN
mdefine_line|#define CORGI_KEY_FN&t;&t;KEY_F3 
DECL|macro|CORGI_KEY_OFF
mdefine_line|#define CORGI_KEY_OFF&t;&t;KEY_SUSPEND
DECL|macro|CORGI_KEY_EXOK
mdefine_line|#define CORGI_KEY_EXOK&t;&t;KEY_F5 
DECL|macro|CORGI_KEY_EXCANCEL
mdefine_line|#define CORGI_KEY_EXCANCEL&t;KEY_F6
DECL|macro|CORGI_KEY_EXJOGDOWN
mdefine_line|#define CORGI_KEY_EXJOGDOWN&t;KEY_F7 
DECL|macro|CORGI_KEY_EXJOGUP
mdefine_line|#define CORGI_KEY_EXJOGUP&t;KEY_F8 
DECL|macro|CORGI_KEY_JAP1
mdefine_line|#define CORGI_KEY_JAP1&t;&t;KEY_LEFTCTRL
DECL|macro|CORGI_KEY_JAP2
mdefine_line|#define CORGI_KEY_JAP2&t;&t;KEY_LEFTALT
DECL|macro|CORGI_KEY_OK
mdefine_line|#define CORGI_KEY_OK&t;&t;KEY_F11
DECL|macro|CORGI_KEY_MENU
mdefine_line|#define CORGI_KEY_MENU&t;&t;KEY_F12
DECL|macro|CORGI_HINGE_0
mdefine_line|#define CORGI_HINGE_0&t;&t;KEY_KP0
DECL|macro|CORGI_HINGE_1
mdefine_line|#define CORGI_HINGE_1&t;&t;KEY_KP1
DECL|macro|CORGI_HINGE_2
mdefine_line|#define CORGI_HINGE_2&t;&t;KEY_KP2
DECL|variable|corgikbd_keycode
r_static
r_int
r_char
id|corgikbd_keycode
(braket
id|NR_SCANCODES
)braket
op_assign
(brace
l_int|0
comma
multiline_comment|/* 0 */
l_int|0
comma
id|KEY_1
comma
id|KEY_3
comma
id|KEY_5
comma
id|KEY_6
comma
id|KEY_7
comma
id|KEY_9
comma
id|KEY_0
comma
id|KEY_BACKSPACE
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 1-16 */
l_int|0
comma
id|KEY_2
comma
id|KEY_4
comma
id|KEY_R
comma
id|KEY_Y
comma
id|KEY_8
comma
id|KEY_I
comma
id|KEY_O
comma
id|KEY_P
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 17-32 */
id|KEY_TAB
comma
id|KEY_Q
comma
id|KEY_E
comma
id|KEY_T
comma
id|KEY_G
comma
id|KEY_U
comma
id|KEY_J
comma
id|KEY_K
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 33-48 */
id|CORGI_KEY_CALENDER
comma
id|KEY_W
comma
id|KEY_S
comma
id|KEY_F
comma
id|KEY_V
comma
id|KEY_H
comma
id|KEY_M
comma
id|KEY_L
comma
l_int|0
comma
id|KEY_RIGHTSHIFT
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 49-64 */
id|CORGI_KEY_ADDRESS
comma
id|KEY_A
comma
id|KEY_D
comma
id|KEY_C
comma
id|KEY_B
comma
id|KEY_N
comma
id|KEY_DOT
comma
l_int|0
comma
id|KEY_ENTER
comma
l_int|0
comma
id|KEY_LEFTSHIFT
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 65-80 */
id|KEY_MAIL
comma
id|KEY_Z
comma
id|KEY_X
comma
id|KEY_MINUS
comma
id|KEY_SPACE
comma
id|KEY_COMMA
comma
l_int|0
comma
id|KEY_UP
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|CORGI_KEY_FN
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 81-96 */
id|KEY_SYSRQ
comma
id|CORGI_KEY_JAP1
comma
id|CORGI_KEY_JAP2
comma
id|KEY_CANCEL
comma
id|CORGI_KEY_OK
comma
id|CORGI_KEY_MENU
comma
id|KEY_LEFT
comma
id|KEY_DOWN
comma
id|KEY_RIGHT
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 97-112 */
id|CORGI_KEY_OFF
comma
id|CORGI_KEY_EXOK
comma
id|CORGI_KEY_EXCANCEL
comma
id|CORGI_KEY_EXJOGDOWN
comma
id|CORGI_KEY_EXJOGUP
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 113-124 */
id|CORGI_HINGE_0
comma
id|CORGI_HINGE_1
comma
id|CORGI_HINGE_2
multiline_comment|/* 125-127 */
)brace
suffix:semicolon
DECL|struct|corgikbd
r_struct
id|corgikbd
(brace
DECL|member|keycode
r_int
r_char
id|keycode
(braket
id|ARRAY_SIZE
c_func
(paren
id|corgikbd_keycode
)paren
)braket
suffix:semicolon
DECL|member|input
r_struct
id|input_dev
id|input
suffix:semicolon
DECL|member|phys
r_char
id|phys
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|state
r_int
r_char
id|state
(braket
id|ARRAY_SIZE
c_func
(paren
id|corgikbd_keycode
)paren
)braket
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|htimer
r_struct
id|timer_list
id|htimer
suffix:semicolon
)brace
suffix:semicolon
DECL|function|handle_scancode
r_static
r_void
id|handle_scancode
c_func
(paren
r_int
r_int
id|pressed
comma
r_int
r_int
id|scancode
comma
r_struct
id|corgikbd
op_star
id|corgikbd_data
)paren
(brace
r_if
c_cond
(paren
id|pressed
op_logical_and
op_logical_neg
(paren
id|corgikbd_data-&gt;state
(braket
id|scancode
)braket
op_amp
id|CORGIKBD_PRESSED
)paren
)paren
(brace
id|corgikbd_data-&gt;state
(braket
id|scancode
)braket
op_or_assign
id|CORGIKBD_PRESSED
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|corgikbd_data-&gt;input
comma
id|corgikbd_data-&gt;keycode
(braket
id|scancode
)braket
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|corgikbd_data-&gt;keycode
(braket
id|scancode
)braket
op_eq
id|CORGI_KEY_OFF
)paren
id|input_event
c_func
(paren
op_amp
id|corgikbd_data-&gt;input
comma
id|EV_PWR
comma
id|CORGI_KEY_OFF
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|pressed
op_logical_and
id|corgikbd_data-&gt;state
(braket
id|scancode
)braket
op_amp
id|CORGIKBD_PRESSED
)paren
(brace
id|corgikbd_data-&gt;state
(braket
id|scancode
)braket
op_and_assign
op_complement
id|CORGIKBD_PRESSED
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|corgikbd_data-&gt;input
comma
id|corgikbd_data-&gt;keycode
(braket
id|scancode
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|macro|KB_DISCHARGE_DELAY
mdefine_line|#define KB_DISCHARGE_DELAY&t;10
DECL|macro|KB_ACTIVATE_DELAY
mdefine_line|#define KB_ACTIVATE_DELAY&t;10
multiline_comment|/* Helper functions for reading the keyboard matrix &n; * Note: We should really be using pxa_gpio_mode to alter GPDR but it &n; *       requires a function call per GPIO bit which is excessive&n; *       when we need to access 12 bits at once multiple times.&n; * These functions must be called within local_irq_save()/local_irq_restore()&n; * or similar. &n; */
DECL|function|corgikbd_discharge_all
r_static
r_inline
r_void
id|corgikbd_discharge_all
c_func
(paren
r_void
)paren
(brace
singleline_comment|// STROBE All HiZ
id|GPCR2
op_assign
id|CORGI_GPIO_ALL_STROBE_BIT
suffix:semicolon
id|GPDR2
op_and_assign
op_complement
id|CORGI_GPIO_ALL_STROBE_BIT
suffix:semicolon
)brace
DECL|function|corgikbd_activate_all
r_static
r_inline
r_void
id|corgikbd_activate_all
c_func
(paren
r_void
)paren
(brace
singleline_comment|// STROBE ALL -&gt; High
id|GPSR2
op_assign
id|CORGI_GPIO_ALL_STROBE_BIT
suffix:semicolon
id|GPDR2
op_or_assign
id|CORGI_GPIO_ALL_STROBE_BIT
suffix:semicolon
id|udelay
c_func
(paren
id|KB_DISCHARGE_DELAY
)paren
suffix:semicolon
singleline_comment|// Clear any interrupts we may have triggered when altering the GPIO lines
id|GEDR1
op_assign
id|CORGI_GPIO_HIGH_SENSE_BIT
suffix:semicolon
id|GEDR2
op_assign
id|CORGI_GPIO_LOW_SENSE_BIT
suffix:semicolon
)brace
DECL|function|corgikbd_activate_col
r_static
r_inline
r_void
id|corgikbd_activate_col
c_func
(paren
r_int
id|col
)paren
(brace
singleline_comment|// STROBE col -&gt; High, not col -&gt; HiZ
id|GPSR2
op_assign
id|CORGI_GPIO_STROBE_BIT
c_func
(paren
id|col
)paren
suffix:semicolon
id|GPDR2
op_assign
(paren
id|GPDR2
op_amp
op_complement
id|CORGI_GPIO_ALL_STROBE_BIT
)paren
op_or
id|CORGI_GPIO_STROBE_BIT
c_func
(paren
id|col
)paren
suffix:semicolon
)brace
DECL|function|corgikbd_reset_col
r_static
r_inline
r_void
id|corgikbd_reset_col
c_func
(paren
r_int
id|col
)paren
(brace
singleline_comment|// STROBE col -&gt; Low
id|GPCR2
op_assign
id|CORGI_GPIO_STROBE_BIT
c_func
(paren
id|col
)paren
suffix:semicolon
singleline_comment|// STROBE col -&gt; out, not col -&gt; HiZ
id|GPDR2
op_assign
(paren
id|GPDR2
op_amp
op_complement
id|CORGI_GPIO_ALL_STROBE_BIT
)paren
op_or
id|CORGI_GPIO_STROBE_BIT
c_func
(paren
id|col
)paren
suffix:semicolon
)brace
DECL|macro|GET_ROWS_STATUS
mdefine_line|#define GET_ROWS_STATUS(c)&t;(((GPLR1 &amp; CORGI_GPIO_HIGH_SENSE_BIT) &gt;&gt; CORGI_GPIO_HIGH_SENSE_RSHIFT) | ((GPLR2 &amp; CORGI_GPIO_LOW_SENSE_BIT) &lt;&lt; CORGI_GPIO_LOW_SENSE_LSHIFT))
multiline_comment|/*&n; * The corgi keyboard only generates interrupts when a key is pressed.&n; * When a key is pressed, we enable a timer which then scans the&n; * keyboard to detect when the key is released.&n; */
multiline_comment|/* Scan the hardware keyboard and push any changes up through the input layer */
DECL|function|corgikbd_scankeyboard
r_static
r_void
id|corgikbd_scankeyboard
c_func
(paren
r_struct
id|corgikbd
op_star
id|corgikbd_data
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|row
comma
id|col
comma
id|rowd
comma
id|scancode
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|num_pressed
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|corgikbd_data-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regs
)paren
id|input_regs
c_func
(paren
op_amp
id|corgikbd_data-&gt;input
comma
id|regs
)paren
suffix:semicolon
id|num_pressed
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|col
OL
id|KB_COLS
suffix:semicolon
id|col
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t; * Discharge the output driver capacitatance&n;&t;&t; * in the keyboard matrix. (Yes it is significant..)&n;&t;&t; */
id|corgikbd_discharge_all
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|KB_DISCHARGE_DELAY
)paren
suffix:semicolon
id|corgikbd_activate_col
c_func
(paren
id|col
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|KB_ACTIVATE_DELAY
)paren
suffix:semicolon
id|rowd
op_assign
id|GET_ROWS_STATUS
c_func
(paren
id|col
)paren
suffix:semicolon
r_for
c_loop
(paren
id|row
op_assign
l_int|0
suffix:semicolon
id|row
OL
id|KB_ROWS
suffix:semicolon
id|row
op_increment
)paren
(brace
id|scancode
op_assign
id|SCANCODE
c_func
(paren
id|row
comma
id|col
)paren
suffix:semicolon
id|handle_scancode
c_func
(paren
(paren
id|rowd
op_amp
id|KB_ROWMASK
c_func
(paren
id|row
)paren
)paren
comma
id|scancode
comma
id|corgikbd_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rowd
op_amp
id|KB_ROWMASK
c_func
(paren
id|row
)paren
)paren
id|num_pressed
op_increment
suffix:semicolon
)brace
id|corgikbd_reset_col
c_func
(paren
id|col
)paren
suffix:semicolon
)brace
id|corgikbd_activate_all
c_func
(paren
)paren
suffix:semicolon
id|input_sync
c_func
(paren
op_amp
id|corgikbd_data-&gt;input
)paren
suffix:semicolon
multiline_comment|/* if any keys are pressed, enable the timer */
r_if
c_cond
(paren
id|num_pressed
)paren
id|mod_timer
c_func
(paren
op_amp
id|corgikbd_data-&gt;timer
comma
id|jiffies
op_plus
id|SCAN_INTERVAL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|corgikbd_data-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * corgi keyboard interrupt handler.&n; */
DECL|function|corgikbd_interrupt
r_static
id|irqreturn_t
id|corgikbd_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|corgikbd
op_star
id|corgikbd_data
op_assign
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|corgikbd_data-&gt;timer
)paren
)paren
(brace
multiline_comment|/** wait chattering delay **/
id|udelay
c_func
(paren
l_int|20
)paren
suffix:semicolon
id|corgikbd_scankeyboard
c_func
(paren
id|corgikbd_data
comma
id|regs
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * corgi timer checking for released keys&n; */
DECL|function|corgikbd_timer_callback
r_static
r_void
id|corgikbd_timer_callback
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|corgikbd
op_star
id|corgikbd_data
op_assign
(paren
r_struct
id|corgikbd
op_star
)paren
id|data
suffix:semicolon
id|corgikbd_scankeyboard
c_func
(paren
id|corgikbd_data
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The hinge switches generate no interrupt so they need to be &n; * monitored by a timer.&n; *&n; * When we detect changes, we debounce it and then pass the three &n; * positions the system can take as keypresses to the input system.&n; */
DECL|macro|HINGE_STABLE_COUNT
mdefine_line|#define HINGE_STABLE_COUNT 2
DECL|variable|sharpsl_hinge_state
r_static
r_int
id|sharpsl_hinge_state
op_assign
l_int|0
suffix:semicolon
DECL|variable|hinge_count
r_static
r_int
id|hinge_count
op_assign
l_int|0
suffix:semicolon
DECL|function|corgikbd_hinge_timer
r_static
r_void
id|corgikbd_hinge_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|corgikbd
op_star
id|corgikbd_data
op_assign
(paren
r_struct
id|corgikbd
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|gprr
suffix:semicolon
id|gprr
op_assign
id|read_scoop_reg
c_func
(paren
id|SCOOP_GPRR
)paren
op_amp
(paren
id|CORGI_SCP_SWA
op_or
id|CORGI_SCP_SWB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gprr
op_ne
id|sharpsl_hinge_state
)paren
(brace
id|hinge_count
op_assign
l_int|0
suffix:semicolon
id|sharpsl_hinge_state
op_assign
id|gprr
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hinge_count
OL
id|HINGE_STABLE_COUNT
)paren
(brace
id|hinge_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|hinge_count
op_ge
id|HINGE_STABLE_COUNT
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|corgikbd_data-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|corgikbd_data-&gt;input.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
suffix:semicolon
id|handle_scancode
c_func
(paren
(paren
id|sharpsl_hinge_state
op_eq
l_int|0x00
)paren
comma
l_int|125
comma
id|corgikbd_data
)paren
suffix:semicolon
multiline_comment|/* Keyboard with Landscape Screen */
id|handle_scancode
c_func
(paren
(paren
id|sharpsl_hinge_state
op_eq
l_int|0x08
)paren
comma
l_int|126
comma
id|corgikbd_data
)paren
suffix:semicolon
multiline_comment|/* No Keyboard with Portrait Screen */
id|handle_scancode
c_func
(paren
(paren
id|sharpsl_hinge_state
op_eq
l_int|0x0c
)paren
comma
l_int|127
comma
id|corgikbd_data
)paren
suffix:semicolon
multiline_comment|/* Keyboard and Screen Closed  */
id|corgikbd_data-&gt;input.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REP
)paren
op_or
id|BIT
c_func
(paren
id|EV_PWR
)paren
suffix:semicolon
id|input_sync
c_func
(paren
op_amp
id|corgikbd_data-&gt;input
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|corgikbd_data-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|mod_timer
c_func
(paren
op_amp
id|corgikbd_data-&gt;htimer
comma
id|jiffies
op_plus
id|HINGE_SCAN_INTERVAL
)paren
suffix:semicolon
)brace
DECL|function|corgikbd_probe
r_static
r_int
id|__init
id|corgikbd_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|corgikbd
op_star
id|corgikbd
suffix:semicolon
id|corgikbd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|corgikbd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|corgikbd
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|corgikbd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|corgikbd
)paren
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
id|corgikbd
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|corgikbd-&gt;phys
comma
l_string|&quot;corgikbd/input0&quot;
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
id|corgikbd-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* Init Keyboard rescan timer */
id|init_timer
c_func
(paren
op_amp
id|corgikbd-&gt;timer
)paren
suffix:semicolon
id|corgikbd-&gt;timer.function
op_assign
id|corgikbd_timer_callback
suffix:semicolon
id|corgikbd-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|corgikbd
suffix:semicolon
multiline_comment|/* Init Hinge Timer */
id|init_timer
c_func
(paren
op_amp
id|corgikbd-&gt;htimer
)paren
suffix:semicolon
id|corgikbd-&gt;htimer.function
op_assign
id|corgikbd_hinge_timer
suffix:semicolon
id|corgikbd-&gt;htimer.data
op_assign
(paren
r_int
r_int
)paren
id|corgikbd
suffix:semicolon
id|init_input_dev
c_func
(paren
op_amp
id|corgikbd-&gt;input
)paren
suffix:semicolon
id|corgikbd-&gt;input
dot
r_private
op_assign
id|corgikbd
suffix:semicolon
id|corgikbd-&gt;input.name
op_assign
l_string|&quot;Corgi Keyboard&quot;
suffix:semicolon
id|corgikbd-&gt;input.dev
op_assign
id|dev
suffix:semicolon
id|corgikbd-&gt;input.phys
op_assign
id|corgikbd-&gt;phys
suffix:semicolon
id|corgikbd-&gt;input.id.bustype
op_assign
id|BUS_HOST
suffix:semicolon
id|corgikbd-&gt;input.id.vendor
op_assign
l_int|0x0001
suffix:semicolon
id|corgikbd-&gt;input.id.product
op_assign
l_int|0x0001
suffix:semicolon
id|corgikbd-&gt;input.id.version
op_assign
l_int|0x0100
suffix:semicolon
id|corgikbd-&gt;input.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REP
)paren
op_or
id|BIT
c_func
(paren
id|EV_PWR
)paren
suffix:semicolon
id|corgikbd-&gt;input.keycode
op_assign
id|corgikbd-&gt;keycode
suffix:semicolon
id|corgikbd-&gt;input.keycodesize
op_assign
r_sizeof
(paren
r_int
r_char
)paren
suffix:semicolon
id|corgikbd-&gt;input.keycodemax
op_assign
id|ARRAY_SIZE
c_func
(paren
id|corgikbd_keycode
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|corgikbd-&gt;keycode
comma
id|corgikbd_keycode
comma
r_sizeof
(paren
id|corgikbd-&gt;keycode
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|corgikbd_keycode
)paren
suffix:semicolon
id|i
op_increment
)paren
id|set_bit
c_func
(paren
id|corgikbd-&gt;keycode
(braket
id|i
)braket
comma
id|corgikbd-&gt;input.keybit
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
id|corgikbd-&gt;input.keybit
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|corgikbd-&gt;input
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|corgikbd-&gt;htimer
comma
id|jiffies
op_plus
id|HINGE_SCAN_INTERVAL
)paren
suffix:semicolon
multiline_comment|/* Setup sense interrupts - RisingEdge Detect, sense lines as inputs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CORGI_KEY_SENSE_NUM
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pxa_gpio_mode
c_func
(paren
id|CORGI_GPIO_KEY_SENSE
c_func
(paren
id|i
)paren
op_or
id|GPIO_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|CORGI_IRQ_GPIO_KEY_SENSE
c_func
(paren
id|i
)paren
comma
id|corgikbd_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;corgikbd&quot;
comma
id|corgikbd
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;corgikbd: Can&squot;t get IRQ: %d !&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_else
id|set_irq_type
c_func
(paren
id|CORGI_IRQ_GPIO_KEY_SENSE
c_func
(paren
id|i
)paren
comma
id|IRQT_RISING
)paren
suffix:semicolon
)brace
multiline_comment|/* Set Strobe lines as outputs - set high */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CORGI_KEY_STROBE_NUM
suffix:semicolon
id|i
op_increment
)paren
id|pxa_gpio_mode
c_func
(paren
id|CORGI_GPIO_KEY_STROBE
c_func
(paren
id|i
)paren
op_or
id|GPIO_OUT
op_or
id|GPIO_DFLT_HIGH
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input: Corgi Keyboard Registered&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|corgikbd_remove
r_static
r_int
id|corgikbd_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|corgikbd
op_star
id|corgikbd
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CORGI_KEY_SENSE_NUM
suffix:semicolon
id|i
op_increment
)paren
id|free_irq
c_func
(paren
id|CORGI_IRQ_GPIO_KEY_SENSE
c_func
(paren
id|i
)paren
comma
id|corgikbd
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|corgikbd-&gt;htimer
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|corgikbd-&gt;timer
)paren
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|corgikbd-&gt;input
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|corgikbd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|corgikbd_driver
r_static
r_struct
id|device_driver
id|corgikbd_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;corgi-keyboard&quot;
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|corgikbd_probe
comma
dot
id|remove
op_assign
id|corgikbd_remove
comma
)brace
suffix:semicolon
DECL|function|corgikbd_init
r_static
r_int
id|__devinit
id|corgikbd_init
c_func
(paren
r_void
)paren
(brace
r_return
id|driver_register
c_func
(paren
op_amp
id|corgikbd_driver
)paren
suffix:semicolon
)brace
DECL|function|corgikbd_exit
r_static
r_void
id|__exit
id|corgikbd_exit
c_func
(paren
r_void
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|corgikbd_driver
)paren
suffix:semicolon
)brace
DECL|variable|corgikbd_init
id|module_init
c_func
(paren
id|corgikbd_init
)paren
suffix:semicolon
DECL|variable|corgikbd_exit
id|module_exit
c_func
(paren
id|corgikbd_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Richard Purdie &lt;rpurdie@rpsys.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Corgi Keyboard Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPLv2&quot;
)paren
suffix:semicolon
eof
