multiline_comment|/*&n; *  Copyright (c) 2005 John Lenz&n; *&n; * Based on from xtkbd.c&n; */
multiline_comment|/*&n; * LoCoMo keyboard driver for Linux/ARM&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;asm/hardware/locomo.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;John Lenz &lt;lenz@cs.wisc.edu&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;LoCoMo keyboard driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|LOCOMOKBD_NUMKEYS
mdefine_line|#define LOCOMOKBD_NUMKEYS &t;128
DECL|macro|KEY_ACTIVITY
mdefine_line|#define KEY_ACTIVITY&t;&t;KEY_F16
DECL|macro|KEY_CONTACT
mdefine_line|#define KEY_CONTACT&t;&t;KEY_F18
DECL|macro|KEY_CENTER
mdefine_line|#define KEY_CENTER&t;&t;KEY_F15
DECL|variable|locomokbd_keycode
r_static
r_int
r_char
id|locomokbd_keycode
(braket
id|LOCOMOKBD_NUMKEYS
)braket
op_assign
(brace
l_int|0
comma
id|KEY_ESC
comma
id|KEY_ACTIVITY
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 0 - 9 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|KEY_MENU
comma
id|KEY_HOME
comma
id|KEY_CONTACT
comma
multiline_comment|/* 10 - 19 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 20 - 29 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|KEY_CENTER
comma
l_int|0
comma
id|KEY_MAIL
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 30 - 39 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|KEY_RIGHT
comma
multiline_comment|/* 40 - 49 */
id|KEY_UP
comma
id|KEY_LEFT
comma
l_int|0
comma
l_int|0
comma
id|KEY_P
comma
l_int|0
comma
id|KEY_O
comma
id|KEY_I
comma
id|KEY_Y
comma
id|KEY_T
comma
multiline_comment|/* 50 - 59 */
id|KEY_E
comma
id|KEY_W
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|KEY_DOWN
comma
id|KEY_ENTER
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 60 - 69 */
id|KEY_BACKSPACE
comma
l_int|0
comma
id|KEY_L
comma
id|KEY_U
comma
id|KEY_H
comma
id|KEY_R
comma
id|KEY_D
comma
id|KEY_Q
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 70 - 79 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|KEY_ENTER
comma
id|KEY_RIGHTSHIFT
comma
id|KEY_K
comma
id|KEY_J
comma
multiline_comment|/* 80 - 89 */
id|KEY_G
comma
id|KEY_F
comma
id|KEY_X
comma
id|KEY_S
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 90 - 99 */
l_int|0
comma
l_int|0
comma
id|KEY_DOT
comma
l_int|0
comma
id|KEY_COMMA
comma
id|KEY_N
comma
id|KEY_B
comma
id|KEY_C
comma
id|KEY_Z
comma
id|KEY_A
comma
multiline_comment|/* 100 - 109 */
id|KEY_LEFTSHIFT
comma
id|KEY_TAB
comma
id|KEY_LEFTCTRL
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* 110 - 119 */
id|KEY_M
comma
id|KEY_SPACE
comma
id|KEY_V
comma
id|KEY_APOSTROPHE
comma
id|KEY_SLASH
comma
l_int|0
comma
l_int|0
comma
l_int|0
multiline_comment|/* 120 - 128 */
)brace
suffix:semicolon
DECL|macro|KB_ROWS
mdefine_line|#define KB_ROWS&t;&t;&t;16
DECL|macro|KB_COLS
mdefine_line|#define KB_COLS&t;&t;&t;8
DECL|macro|KB_ROWMASK
mdefine_line|#define KB_ROWMASK(r)&t;&t;(1 &lt;&lt; (r))
DECL|macro|SCANCODE
mdefine_line|#define SCANCODE(c,r)&t;&t;( ((c)&lt;&lt;4) + (r) + 1 )
DECL|macro|NR_SCANCODES
mdefine_line|#define&t;NR_SCANCODES&t;&t;128
DECL|macro|KB_DELAY
mdefine_line|#define KB_DELAY&t;&t;8
DECL|macro|SCAN_INTERVAL
mdefine_line|#define SCAN_INTERVAL&t;&t;(HZ/10)
DECL|macro|LOCOMOKBD_PRESSED
mdefine_line|#define LOCOMOKBD_PRESSED&t;1
DECL|struct|locomokbd
r_struct
id|locomokbd
(brace
DECL|member|keycode
r_int
r_char
id|keycode
(braket
id|LOCOMOKBD_NUMKEYS
)braket
suffix:semicolon
DECL|member|input
r_struct
id|input_dev
id|input
suffix:semicolon
DECL|member|phys
r_char
id|phys
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|ldev
r_struct
id|locomo_dev
op_star
id|ldev
suffix:semicolon
DECL|member|base
r_int
r_int
id|base
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* helper functions for reading the keyboard matrix */
DECL|function|locomokbd_charge_all
r_static
r_inline
r_void
id|locomokbd_charge_all
c_func
(paren
r_int
r_int
id|membase
)paren
(brace
id|locomo_writel
c_func
(paren
l_int|0x00FF
comma
id|membase
op_plus
id|LOCOMO_KSC
)paren
suffix:semicolon
)brace
DECL|function|locomokbd_activate_all
r_static
r_inline
r_void
id|locomokbd_activate_all
c_func
(paren
r_int
r_int
id|membase
)paren
(brace
r_int
r_int
id|r
suffix:semicolon
id|locomo_writel
c_func
(paren
l_int|0
comma
id|membase
op_plus
id|LOCOMO_KSC
)paren
suffix:semicolon
id|r
op_assign
id|locomo_readl
c_func
(paren
id|membase
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
id|r
op_and_assign
l_int|0xFEFF
suffix:semicolon
id|locomo_writel
c_func
(paren
id|r
comma
id|membase
op_plus
id|LOCOMO_KIC
)paren
suffix:semicolon
)brace
DECL|function|locomokbd_activate_col
r_static
r_inline
r_void
id|locomokbd_activate_col
c_func
(paren
r_int
r_int
id|membase
comma
r_int
id|col
)paren
(brace
r_int
r_int
id|nset
suffix:semicolon
r_int
r_int
id|nbset
suffix:semicolon
id|nset
op_assign
l_int|0xFF
op_amp
op_complement
(paren
l_int|1
op_lshift
id|col
)paren
suffix:semicolon
id|nbset
op_assign
(paren
id|nset
op_lshift
l_int|8
)paren
op_plus
id|nset
suffix:semicolon
id|locomo_writel
c_func
(paren
id|nbset
comma
id|membase
op_plus
id|LOCOMO_KSC
)paren
suffix:semicolon
)brace
DECL|function|locomokbd_reset_col
r_static
r_inline
r_void
id|locomokbd_reset_col
c_func
(paren
r_int
r_int
id|membase
comma
r_int
id|col
)paren
(brace
r_int
r_int
id|nbset
suffix:semicolon
id|nbset
op_assign
(paren
(paren
l_int|0xFF
op_amp
op_complement
(paren
l_int|1
op_lshift
id|col
)paren
)paren
op_lshift
l_int|8
)paren
op_plus
l_int|0xFF
suffix:semicolon
id|locomo_writel
c_func
(paren
id|nbset
comma
id|membase
op_plus
id|LOCOMO_KSC
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The LoCoMo keyboard only generates interrupts when a key is pressed.&n; * So when a key is pressed, we enable a timer.  This timer scans the&n; * keyboard, and this is how we detect when the key is released.&n; */
multiline_comment|/* Scan the hardware keyboard and push any changes up through the input layer */
DECL|function|locomokbd_scankeyboard
r_static
r_void
id|locomokbd_scankeyboard
c_func
(paren
r_struct
id|locomokbd
op_star
id|locomokbd
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|row
comma
id|col
comma
id|rowd
comma
id|scancode
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|num_pressed
suffix:semicolon
r_int
r_int
id|membase
op_assign
id|locomokbd-&gt;base
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|locomokbd-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regs
)paren
id|input_regs
c_func
(paren
op_amp
id|locomokbd-&gt;input
comma
id|regs
)paren
suffix:semicolon
id|locomokbd_charge_all
c_func
(paren
id|membase
)paren
suffix:semicolon
id|num_pressed
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|col
op_assign
l_int|0
suffix:semicolon
id|col
OL
id|KB_COLS
suffix:semicolon
id|col
op_increment
)paren
(brace
id|locomokbd_activate_col
c_func
(paren
id|membase
comma
id|col
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|KB_DELAY
)paren
suffix:semicolon
id|rowd
op_assign
op_complement
id|locomo_readl
c_func
(paren
id|membase
op_plus
id|LOCOMO_KIB
)paren
suffix:semicolon
r_for
c_loop
(paren
id|row
op_assign
l_int|0
suffix:semicolon
id|row
OL
id|KB_ROWS
suffix:semicolon
id|row
op_increment
)paren
(brace
id|scancode
op_assign
id|SCANCODE
c_func
(paren
id|col
comma
id|row
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rowd
op_amp
id|KB_ROWMASK
c_func
(paren
id|row
)paren
)paren
(brace
id|num_pressed
op_add_assign
l_int|1
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|locomokbd-&gt;input
comma
id|locomokbd-&gt;keycode
(braket
id|scancode
)braket
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|input_report_key
c_func
(paren
op_amp
id|locomokbd-&gt;input
comma
id|locomokbd-&gt;keycode
(braket
id|scancode
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
id|locomokbd_reset_col
c_func
(paren
id|membase
comma
id|col
)paren
suffix:semicolon
)brace
id|locomokbd_activate_all
c_func
(paren
id|membase
)paren
suffix:semicolon
id|input_sync
c_func
(paren
op_amp
id|locomokbd-&gt;input
)paren
suffix:semicolon
multiline_comment|/* if any keys are pressed, enable the timer */
r_if
c_cond
(paren
id|num_pressed
)paren
id|mod_timer
c_func
(paren
op_amp
id|locomokbd-&gt;timer
comma
id|jiffies
op_plus
id|SCAN_INTERVAL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|locomokbd-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * LoCoMo keyboard interrupt handler.&n; */
DECL|function|locomokbd_interrupt
r_static
id|irqreturn_t
id|locomokbd_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|locomokbd
op_star
id|locomokbd
op_assign
id|dev_id
suffix:semicolon
multiline_comment|/** wait chattering delay **/
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|locomokbd_scankeyboard
c_func
(paren
id|locomokbd
comma
id|regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * LoCoMo timer checking for released keys&n; */
DECL|function|locomokbd_timer_callback
r_static
r_void
id|locomokbd_timer_callback
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|locomokbd
op_star
id|locomokbd
op_assign
(paren
r_struct
id|locomokbd
op_star
)paren
id|data
suffix:semicolon
id|locomokbd_scankeyboard
c_func
(paren
id|locomokbd
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|locomokbd_probe
r_static
r_int
id|locomokbd_probe
c_func
(paren
r_struct
id|locomo_dev
op_star
id|dev
)paren
(brace
r_struct
id|locomokbd
op_star
id|locomokbd
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|locomokbd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|locomokbd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|locomokbd
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|locomokbd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|locomokbd
)paren
)paren
suffix:semicolon
multiline_comment|/* try and claim memory region */
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
(paren
r_int
r_int
)paren
id|dev-&gt;mapbase
comma
id|dev-&gt;length
comma
id|LOCOMO_DRIVER_NAME
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;locomokbd: Can&squot;t acquire access to io memory for keyboard&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|free
suffix:semicolon
)brace
id|locomokbd-&gt;ldev
op_assign
id|dev
suffix:semicolon
id|locomo_set_drvdata
c_func
(paren
id|dev
comma
id|locomokbd
)paren
suffix:semicolon
id|locomokbd-&gt;base
op_assign
(paren
r_int
r_int
)paren
id|dev-&gt;mapbase
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|locomokbd-&gt;lock
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|locomokbd-&gt;timer
)paren
suffix:semicolon
id|locomokbd-&gt;timer.function
op_assign
id|locomokbd_timer_callback
suffix:semicolon
id|locomokbd-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|locomokbd
suffix:semicolon
id|locomokbd-&gt;input.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REP
)paren
suffix:semicolon
id|init_input_dev
c_func
(paren
op_amp
id|locomokbd-&gt;input
)paren
suffix:semicolon
id|locomokbd-&gt;input.keycode
op_assign
id|locomokbd-&gt;keycode
suffix:semicolon
id|locomokbd-&gt;input.keycodesize
op_assign
r_sizeof
(paren
r_int
r_char
)paren
suffix:semicolon
id|locomokbd-&gt;input.keycodemax
op_assign
id|ARRAY_SIZE
c_func
(paren
id|locomokbd_keycode
)paren
suffix:semicolon
id|locomokbd-&gt;input
dot
r_private
op_assign
id|locomokbd
suffix:semicolon
id|memcpy
c_func
(paren
id|locomokbd-&gt;keycode
comma
id|locomokbd_keycode
comma
r_sizeof
(paren
id|locomokbd-&gt;keycode
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LOCOMOKBD_NUMKEYS
suffix:semicolon
id|i
op_increment
)paren
id|set_bit
c_func
(paren
id|locomokbd-&gt;keycode
(braket
id|i
)braket
comma
id|locomokbd-&gt;input.keybit
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
id|locomokbd-&gt;input.keybit
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|locomokbd-&gt;phys
comma
l_string|&quot;locomokbd/input0&quot;
)paren
suffix:semicolon
id|locomokbd-&gt;input.name
op_assign
l_string|&quot;LoCoMo keyboard&quot;
suffix:semicolon
id|locomokbd-&gt;input.phys
op_assign
id|locomokbd-&gt;phys
suffix:semicolon
id|locomokbd-&gt;input.id.bustype
op_assign
id|BUS_XTKBD
suffix:semicolon
id|locomokbd-&gt;input.id.vendor
op_assign
l_int|0x0001
suffix:semicolon
id|locomokbd-&gt;input.id.product
op_assign
l_int|0x0001
suffix:semicolon
id|locomokbd-&gt;input.id.version
op_assign
l_int|0x0100
suffix:semicolon
multiline_comment|/* attempt to get the interrupt */
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
(braket
l_int|0
)braket
comma
id|locomokbd_interrupt
comma
l_int|0
comma
l_string|&quot;locomokbd&quot;
comma
id|locomokbd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;locomokbd: Can&squot;t get irq for keyboard&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|input_register_device
c_func
(paren
op_amp
id|locomokbd-&gt;input
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input: LoCoMo keyboard on locomokbd&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|release_mem_region
c_func
(paren
(paren
r_int
r_int
)paren
id|dev-&gt;mapbase
comma
id|dev-&gt;length
)paren
suffix:semicolon
id|locomo_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|free
suffix:colon
id|kfree
c_func
(paren
id|locomokbd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|locomokbd_remove
r_static
r_int
id|locomokbd_remove
c_func
(paren
r_struct
id|locomo_dev
op_star
id|dev
)paren
(brace
r_struct
id|locomokbd
op_star
id|locomokbd
op_assign
id|locomo_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
(braket
l_int|0
)braket
comma
id|locomokbd
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|locomokbd-&gt;timer
)paren
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|locomokbd-&gt;input
)paren
suffix:semicolon
id|locomo_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
(paren
r_int
r_int
)paren
id|dev-&gt;mapbase
comma
id|dev-&gt;length
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|locomokbd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|keyboard_driver
r_static
r_struct
id|locomo_driver
id|keyboard_driver
op_assign
(brace
dot
id|drv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;locomokbd&quot;
)brace
comma
dot
id|devid
op_assign
id|LOCOMO_DEVID_KEYBOARD
comma
dot
id|probe
op_assign
id|locomokbd_probe
comma
dot
id|remove
op_assign
id|locomokbd_remove
comma
)brace
suffix:semicolon
DECL|function|locomokbd_init
r_static
r_int
id|__init
id|locomokbd_init
c_func
(paren
r_void
)paren
(brace
r_return
id|locomo_driver_register
c_func
(paren
op_amp
id|keyboard_driver
)paren
suffix:semicolon
)brace
DECL|function|locomokbd_exit
r_static
r_void
id|__exit
id|locomokbd_exit
c_func
(paren
r_void
)paren
(brace
id|locomo_driver_unregister
c_func
(paren
op_amp
id|keyboard_driver
)paren
suffix:semicolon
)brace
DECL|variable|locomokbd_init
id|module_init
c_func
(paren
id|locomokbd_init
)paren
suffix:semicolon
DECL|variable|locomokbd_exit
id|module_exit
c_func
(paren
id|locomokbd_exit
)paren
suffix:semicolon
eof
