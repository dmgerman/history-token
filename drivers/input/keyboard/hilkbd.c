multiline_comment|/*&n; *  linux/drivers/hil/hilkbd.c&n; *&n; *  Copyright (C) 1998 Philip Blundell &lt;philb@gnu.org&gt;&n; *  Copyright (C) 1999 Matthew Wilcox &lt;willy@bofh.ai&gt;&n; *  Copyright (C) 1999-2003 Helge Deller &lt;deller@gmx.de&gt;&n; *&n; *  Very basic HP Human Interface Loop (HIL) driver.&n; *  This driver handles the keyboard on HP300 (m68k) and on some &n; *  HP700 (parisc) series machines.&n; *&n; * &n; * This file is subject to the terms and conditions of the GNU General Public&n; * License version 2.  See the file COPYING in the main directory of this&n; * archive for more details.&n; */
macro_line|#include &lt;linux/pci_ids.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;linux/hil.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Philip Blundell, Matthew Wilcox, Helge Deller&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;HIL keyboard driver (basic functionality)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL v2&quot;
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PARISC)
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/parisc-device.h&gt;
DECL|variable|hil_base
r_static
r_int
r_int
id|hil_base
suffix:semicolon
multiline_comment|/* HPA for the HIL device */
DECL|variable|hil_irq
r_static
r_int
r_int
id|hil_irq
suffix:semicolon
DECL|macro|HILBASE
mdefine_line|#define HILBASE&t;&t;hil_base /* HPPA (parisc) port address */
DECL|macro|HIL_DATA
mdefine_line|#define HIL_DATA&t;&t;0x800
DECL|macro|HIL_CMD
mdefine_line|#define HIL_CMD&t;&t;0x801
DECL|macro|HIL_IRQ
mdefine_line|#define HIL_IRQ&t;&t;hil_irq
DECL|macro|hil_readb
mdefine_line|#define hil_readb(p)&t;&t;gsc_readb(p)
DECL|macro|hil_writeb
mdefine_line|#define hil_writeb(v,p)&t;gsc_writeb((v),(p))
macro_line|#elif defined(CONFIG_HP300)
DECL|macro|HILBASE
mdefine_line|#define HILBASE&t;&t;0xf0428000 /* HP300 (m86k) port address */
DECL|macro|HIL_DATA
mdefine_line|#define HIL_DATA&t;&t;0x1
DECL|macro|HIL_CMD
mdefine_line|#define HIL_CMD&t;&t;0x3
DECL|macro|HIL_IRQ
mdefine_line|#define HIL_IRQ&t;&t;2
DECL|macro|hil_readb
mdefine_line|#define hil_readb(p)&t;&t;readb(p)
DECL|macro|hil_writeb
mdefine_line|#define hil_writeb(v,p)&t;writeb((v),(p))
macro_line|#else
macro_line|#error &quot;HIL is not supported on this platform&quot;
macro_line|#endif
multiline_comment|/* HIL helper functions */
DECL|macro|hil_busy
mdefine_line|#define hil_busy()              (hil_readb(HILBASE + HIL_CMD) &amp; HIL_BUSY)
DECL|macro|hil_data_available
mdefine_line|#define hil_data_available()    (hil_readb(HILBASE + HIL_CMD) &amp; HIL_DATA_RDY)
DECL|macro|hil_status
mdefine_line|#define hil_status()            (hil_readb(HILBASE + HIL_CMD))
DECL|macro|hil_command
mdefine_line|#define hil_command(x)          do { hil_writeb((x), HILBASE + HIL_CMD); } while (0)
DECL|macro|hil_read_data
mdefine_line|#define hil_read_data()         (hil_readb(HILBASE + HIL_DATA))
DECL|macro|hil_write_data
mdefine_line|#define hil_write_data(x)       do { hil_writeb((x), HILBASE + HIL_DATA); } while (0)
multiline_comment|/* HIL constants */
DECL|macro|HIL_BUSY
mdefine_line|#define&t;HIL_BUSY&t;&t;0x02
DECL|macro|HIL_DATA_RDY
mdefine_line|#define&t;HIL_DATA_RDY&t;&t;0x01
DECL|macro|HIL_SETARD
mdefine_line|#define&t;HIL_SETARD&t;&t;0xA0&t;&t;/* set auto-repeat delay */
DECL|macro|HIL_SETARR
mdefine_line|#define&t;HIL_SETARR&t;&t;0xA2&t;&t;/* set auto-repeat rate */
DECL|macro|HIL_SETTONE
mdefine_line|#define&t;HIL_SETTONE&t;&t;0xA3&t;&t;/* set tone generator */
DECL|macro|HIL_CNMT
mdefine_line|#define&t;HIL_CNMT&t;&t;0xB2&t;&t;/* clear nmi */
DECL|macro|HIL_INTON
mdefine_line|#define&t;HIL_INTON&t;&t;0x5C&t;&t;/* Turn on interrupts. */
DECL|macro|HIL_INTOFF
mdefine_line|#define&t;HIL_INTOFF&t;&t;0x5D&t;&t;/* Turn off interrupts. */
DECL|macro|HIL_READKBDSADR
mdefine_line|#define&t;HIL_READKBDSADR&t; &t;0xF9
DECL|macro|HIL_WRITEKBDSADR
mdefine_line|#define&t;HIL_WRITEKBDSADR &t;0xE9
DECL|variable|hphilkeyb_keycode
r_static
r_int
r_int
id|hphilkeyb_keycode
(braket
id|HIL_KEYCODES_SET1_TBLSIZE
)braket
op_assign
(brace
id|HIL_KEYCODES_SET1
)brace
suffix:semicolon
multiline_comment|/* HIL structure */
r_static
r_struct
(brace
DECL|member|dev
r_struct
id|input_dev
id|dev
suffix:semicolon
DECL|member|curdev
r_int
r_int
id|curdev
suffix:semicolon
DECL|member|s
r_int
r_char
id|s
suffix:semicolon
DECL|member|c
r_int
r_char
id|c
suffix:semicolon
DECL|member|valid
r_int
id|valid
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|ptr
r_int
r_int
id|ptr
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|dev_id
r_void
op_star
id|dev_id
suffix:semicolon
multiline_comment|/* native bus device */
DECL|variable|hil_dev
)brace
id|hil_dev
suffix:semicolon
DECL|function|poll_finished
r_static
r_void
id|poll_finished
c_func
(paren
r_void
)paren
(brace
r_int
id|down
suffix:semicolon
r_int
id|key
suffix:semicolon
r_int
r_char
id|scode
suffix:semicolon
r_switch
c_cond
(paren
id|hil_dev.data
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0x40
suffix:colon
id|down
op_assign
(paren
id|hil_dev.data
(braket
l_int|1
)braket
op_amp
l_int|1
)paren
op_eq
l_int|0
suffix:semicolon
id|scode
op_assign
id|hil_dev.data
(braket
l_int|1
)braket
op_rshift
l_int|1
suffix:semicolon
id|key
op_assign
id|hphilkeyb_keycode
(braket
id|scode
)braket
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|hil_dev.dev
comma
id|key
comma
id|down
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|hil_dev.curdev
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|handle_status
r_static
r_inline
r_void
id|handle_status
c_func
(paren
r_int
r_char
id|s
comma
r_int
r_char
id|c
)paren
(brace
r_if
c_cond
(paren
id|c
op_amp
l_int|0x8
)paren
(brace
multiline_comment|/* End of block */
r_if
c_cond
(paren
id|c
op_amp
l_int|0x10
)paren
id|poll_finished
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|c
op_amp
l_int|0x10
)paren
(brace
r_if
c_cond
(paren
id|hil_dev.curdev
)paren
id|poll_finished
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* just in case */
id|hil_dev.curdev
op_assign
id|c
op_amp
l_int|7
suffix:semicolon
id|hil_dev.ptr
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|function|handle_data
r_static
r_inline
r_void
id|handle_data
c_func
(paren
r_int
r_char
id|s
comma
r_int
r_char
id|c
)paren
(brace
r_if
c_cond
(paren
id|hil_dev.curdev
)paren
(brace
id|hil_dev.data
(braket
id|hil_dev.ptr
op_increment
)braket
op_assign
id|c
suffix:semicolon
id|hil_dev.ptr
op_and_assign
l_int|15
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * Handle HIL interrupts.&n; */
DECL|function|hil_interrupt
r_static
id|irqreturn_t
id|hil_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|handle
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|s
comma
id|c
suffix:semicolon
id|s
op_assign
id|hil_status
c_func
(paren
)paren
suffix:semicolon
id|c
op_assign
id|hil_read_data
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|s
op_rshift
l_int|4
)paren
(brace
r_case
l_int|0x5
suffix:colon
id|handle_status
c_func
(paren
id|s
comma
id|c
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x6
suffix:colon
id|handle_data
c_func
(paren
id|s
comma
id|c
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x4
suffix:colon
id|hil_dev.s
op_assign
id|s
suffix:semicolon
id|hil_dev.c
op_assign
id|c
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
id|hil_dev.valid
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * Send a command to the HIL&n; */
DECL|function|hil_do
r_static
r_void
id|hil_do
c_func
(paren
r_int
r_char
id|cmd
comma
r_int
r_char
op_star
id|data
comma
r_int
r_int
id|len
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hil_dev.lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|hil_busy
c_func
(paren
)paren
)paren
multiline_comment|/* wait */
suffix:semicolon
id|hil_command
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
r_while
c_loop
(paren
id|hil_busy
c_func
(paren
)paren
)paren
multiline_comment|/* wait */
suffix:semicolon
id|hil_write_data
c_func
(paren
op_star
(paren
id|data
op_increment
)paren
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hil_dev.lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialise HIL. &n; */
r_static
r_int
id|__init
DECL|function|hil_keyb_init
id|hil_keyb_init
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|c
suffix:semicolon
r_int
r_int
id|i
comma
id|kbid
suffix:semicolon
id|wait_queue_head_t
id|hil_wait
suffix:semicolon
r_if
c_cond
(paren
id|hil_dev.dev.id.bustype
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* already initialized */
)brace
macro_line|#if defined(CONFIG_HP300)
r_if
c_cond
(paren
op_logical_neg
id|hwreg_present
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|HILBASE
op_plus
id|HIL_DATA
)paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|request_region
c_func
(paren
id|HILBASE
op_plus
id|HIL_DATA
comma
l_int|2
comma
l_string|&quot;hil&quot;
)paren
suffix:semicolon
macro_line|#endif
id|request_irq
c_func
(paren
id|HIL_IRQ
comma
id|hil_interrupt
comma
l_int|0
comma
l_string|&quot;hil&quot;
comma
id|hil_dev.dev_id
)paren
suffix:semicolon
multiline_comment|/* Turn on interrupts */
id|hil_do
c_func
(paren
id|HIL_INTON
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Look for keyboards */
id|hil_dev.valid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* clear any pending data */
id|hil_do
c_func
(paren
id|HIL_READKBDSADR
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|hil_wait
)paren
suffix:semicolon
id|wait_event_interruptible_timeout
c_func
(paren
id|hil_wait
comma
id|hil_dev.valid
comma
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hil_dev.valid
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HIL: timed out, assuming no keyboard present.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|c
op_assign
id|hil_dev.c
suffix:semicolon
id|hil_dev.valid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|0
)paren
(brace
id|kbid
op_assign
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HIL: no keyboard present.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|kbid
op_assign
id|ffz
c_func
(paren
op_complement
id|c
)paren
suffix:semicolon
multiline_comment|/* printk(KERN_INFO &quot;HIL: keyboard found at id %d&bslash;n&quot;, kbid); */
)brace
multiline_comment|/* set it to raw mode */
id|c
op_assign
l_int|0
suffix:semicolon
id|hil_do
c_func
(paren
id|HIL_WRITEKBDSADR
comma
op_amp
id|c
comma
l_int|1
)paren
suffix:semicolon
id|init_input_dev
c_func
(paren
op_amp
id|hil_dev.dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HIL_KEYCODES_SET1_TBLSIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hphilkeyb_keycode
(braket
id|i
)braket
op_ne
id|KEY_RESERVED
)paren
id|set_bit
c_func
(paren
id|hphilkeyb_keycode
(braket
id|i
)braket
comma
id|hil_dev.dev.keybit
)paren
suffix:semicolon
id|hil_dev.dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REP
)paren
suffix:semicolon
id|hil_dev.dev.ledbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|LED_NUML
)paren
op_or
id|BIT
c_func
(paren
id|LED_CAPSL
)paren
op_or
id|BIT
c_func
(paren
id|LED_SCROLLL
)paren
suffix:semicolon
id|hil_dev.dev.keycodemax
op_assign
id|HIL_KEYCODES_SET1_TBLSIZE
suffix:semicolon
id|hil_dev.dev.keycodesize
op_assign
r_sizeof
(paren
id|hphilkeyb_keycode
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hil_dev.dev.keycode
op_assign
id|hphilkeyb_keycode
suffix:semicolon
id|hil_dev.dev.name
op_assign
l_string|&quot;HIL keyboard&quot;
suffix:semicolon
id|hil_dev.dev.phys
op_assign
l_string|&quot;hpkbd/input0&quot;
suffix:semicolon
id|hil_dev.dev.id.bustype
op_assign
id|BUS_HIL
suffix:semicolon
id|hil_dev.dev.id.vendor
op_assign
id|PCI_VENDOR_ID_HP
suffix:semicolon
id|hil_dev.dev.id.product
op_assign
l_int|0x0001
suffix:semicolon
id|hil_dev.dev.id.version
op_assign
l_int|0x0010
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|hil_dev.dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input: %s, ID %d at 0x%08lx (irq %d) found and attached&bslash;n&quot;
comma
id|hil_dev.dev.name
comma
id|kbid
comma
id|HILBASE
comma
id|HIL_IRQ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_PARISC)
r_static
r_int
id|__init
DECL|function|hil_init_chip
id|hil_init_chip
c_func
(paren
r_struct
id|parisc_device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;HIL: IRQ not found for HIL bus at 0x%08lx&bslash;n&quot;
comma
id|dev-&gt;hpa
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hil_base
op_assign
id|dev-&gt;hpa
suffix:semicolon
id|hil_irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|hil_dev.dev_id
op_assign
id|dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Found HIL bus at 0x%08lx, IRQ %d&bslash;n&quot;
comma
id|hil_base
comma
id|hil_irq
)paren
suffix:semicolon
r_return
id|hil_keyb_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|hil_tbl
r_static
r_struct
id|parisc_device_id
id|hil_tbl
(braket
)braket
op_assign
(brace
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x00073
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|parisc
comma
id|hil_tbl
)paren
suffix:semicolon
DECL|variable|hil_driver
r_static
r_struct
id|parisc_driver
id|hil_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;HIL&quot;
comma
dot
id|id_table
op_assign
id|hil_tbl
comma
dot
id|probe
op_assign
id|hil_init_chip
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_PARISC */
DECL|function|hil_init
r_static
r_int
id|__init
id|hil_init
c_func
(paren
r_void
)paren
(brace
macro_line|#if defined(CONFIG_PARISC)
r_return
id|register_parisc_driver
c_func
(paren
op_amp
id|hil_driver
)paren
suffix:semicolon
macro_line|#else
r_return
id|hil_keyb_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|hil_exit
r_static
r_void
id|__exit
id|hil_exit
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|HIL_IRQ
)paren
(brace
id|disable_irq
c_func
(paren
id|HIL_IRQ
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|HIL_IRQ
comma
id|hil_dev.dev_id
)paren
suffix:semicolon
)brace
multiline_comment|/* Turn off interrupts */
id|hil_do
c_func
(paren
id|HIL_INTOFF
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|hil_dev.dev
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_PARISC)
id|unregister_parisc_driver
c_func
(paren
op_amp
id|hil_driver
)paren
suffix:semicolon
macro_line|#else
id|release_region
c_func
(paren
id|HILBASE
op_plus
id|HIL_DATA
comma
l_int|2
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|hil_init
id|module_init
c_func
(paren
id|hil_init
)paren
suffix:semicolon
DECL|variable|hil_exit
id|module_exit
c_func
(paren
id|hil_exit
)paren
suffix:semicolon
eof
