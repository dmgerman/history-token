multiline_comment|/*&n; * Generic linux-input device driver for keyboard devices&n; *&n; * Copyright (c) 2001 Brian S. Julin&n; * All rights reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification.&n; * 2. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * Alternatively, this software may be distributed under the terms of the&n; * GNU General Public License (&quot;GPL&quot;).&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; *&n; * References:&n; * HP-HIL Technical Reference Manual.  Hewlett Packard Product No. 45918A&n; *&n; */
macro_line|#include &lt;linux/hil.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/serio.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci_ids.h&gt;
DECL|macro|PREFIX
mdefine_line|#define PREFIX &quot;HIL KEYB: &quot;
DECL|macro|HIL_GENERIC_NAME
mdefine_line|#define HIL_GENERIC_NAME &quot;HIL keyboard&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Brian S. Julin &lt;bri@calyx.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
id|HIL_GENERIC_NAME
l_string|&quot; driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
DECL|macro|HIL_KBD_MAX_LENGTH
mdefine_line|#define HIL_KBD_MAX_LENGTH 16
DECL|macro|HIL_KBD_SET1_UPBIT
mdefine_line|#define HIL_KBD_SET1_UPBIT 0x01
DECL|macro|HIL_KBD_SET1_SHIFT
mdefine_line|#define HIL_KBD_SET1_SHIFT 1
DECL|variable|hil_kbd_set1
r_static
r_int
r_int
id|hil_kbd_set1
(braket
id|HIL_KEYCODES_SET1_TBLSIZE
)braket
op_assign
(brace
id|HIL_KEYCODES_SET1
)brace
suffix:semicolon
DECL|macro|HIL_KBD_SET2_UPBIT
mdefine_line|#define HIL_KBD_SET2_UPBIT 0x01
DECL|macro|HIL_KBD_SET2_SHIFT
mdefine_line|#define HIL_KBD_SET2_SHIFT 1
multiline_comment|/* Set2 is user defined */
DECL|macro|HIL_KBD_SET3_UPBIT
mdefine_line|#define HIL_KBD_SET3_UPBIT 0x80
DECL|macro|HIL_KBD_SET3_SHIFT
mdefine_line|#define HIL_KBD_SET3_SHIFT 0
DECL|variable|hil_kbd_set3
r_static
r_int
r_int
id|hil_kbd_set3
(braket
id|HIL_KEYCODES_SET3_TBLSIZE
)braket
op_assign
(brace
id|HIL_KEYCODES_SET3
)brace
suffix:semicolon
DECL|variable|hil_language
r_static
r_char
id|hil_language
(braket
)braket
(braket
l_int|16
)braket
op_assign
(brace
id|HIL_LOCALE_MAP
)brace
suffix:semicolon
DECL|struct|hil_kbd
r_struct
id|hil_kbd
(brace
DECL|member|dev
r_struct
id|input_dev
id|dev
suffix:semicolon
DECL|member|serio
r_struct
id|serio
op_star
id|serio
suffix:semicolon
multiline_comment|/* Input buffer and index for packets from HIL bus. */
DECL|member|data
id|hil_packet
id|data
(braket
id|HIL_KBD_MAX_LENGTH
)braket
suffix:semicolon
DECL|member|idx4
r_int
id|idx4
suffix:semicolon
multiline_comment|/* four counts per packet */
multiline_comment|/* Raw device info records from HIL bus, see hil.h for fields. */
DECL|member|idd
r_char
id|idd
(braket
id|HIL_KBD_MAX_LENGTH
)braket
suffix:semicolon
multiline_comment|/* DID byte and IDD record */
DECL|member|rsc
r_char
id|rsc
(braket
id|HIL_KBD_MAX_LENGTH
)braket
suffix:semicolon
multiline_comment|/* RSC record */
DECL|member|exd
r_char
id|exd
(braket
id|HIL_KBD_MAX_LENGTH
)braket
suffix:semicolon
multiline_comment|/* EXD record */
DECL|member|rnm
r_char
id|rnm
(braket
id|HIL_KBD_MAX_LENGTH
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* RNM record + NULL term. */
multiline_comment|/* Something to sleep around with. */
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Process a complete packet after transfer from the HIL */
DECL|function|hil_kbd_process_record
r_static
r_void
id|hil_kbd_process_record
c_func
(paren
r_struct
id|hil_kbd
op_star
id|kbd
)paren
(brace
r_struct
id|input_dev
op_star
id|dev
op_assign
op_amp
id|kbd-&gt;dev
suffix:semicolon
id|hil_packet
op_star
id|data
op_assign
id|kbd-&gt;data
suffix:semicolon
id|hil_packet
id|p
suffix:semicolon
r_int
id|idx
comma
id|i
comma
id|cnt
suffix:semicolon
id|idx
op_assign
id|kbd-&gt;idx4
op_div
l_int|4
suffix:semicolon
id|p
op_assign
id|data
(braket
id|idx
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_amp
op_complement
id|HIL_CMDCT_POL
)paren
op_eq
(paren
id|HIL_ERR_INT
op_or
id|HIL_PKT_CMD
op_or
id|HIL_CMD_POL
)paren
)paren
r_goto
id|report
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_amp
op_complement
id|HIL_CMDCT_RPL
)paren
op_eq
(paren
id|HIL_ERR_INT
op_or
id|HIL_PKT_CMD
op_or
id|HIL_CMD_RPL
)paren
)paren
r_goto
id|report
suffix:semicolon
multiline_comment|/* Not a poll response.  See if we are loading config records. */
r_switch
c_cond
(paren
id|p
op_amp
id|HIL_PKT_DATA_MASK
)paren
(brace
r_case
id|HIL_CMD_IDD
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|idx
suffix:semicolon
id|i
op_increment
)paren
id|kbd-&gt;idd
(braket
id|i
)braket
op_assign
id|kbd-&gt;data
(braket
id|i
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|HIL_KBD_MAX_LENGTH
suffix:semicolon
id|i
op_increment
)paren
id|kbd-&gt;idd
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIL_CMD_RSC
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|idx
suffix:semicolon
id|i
op_increment
)paren
id|kbd-&gt;rsc
(braket
id|i
)braket
op_assign
id|kbd-&gt;data
(braket
id|i
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|HIL_KBD_MAX_LENGTH
suffix:semicolon
id|i
op_increment
)paren
id|kbd-&gt;rsc
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIL_CMD_EXD
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|idx
suffix:semicolon
id|i
op_increment
)paren
id|kbd-&gt;exd
(braket
id|i
)braket
op_assign
id|kbd-&gt;data
(braket
id|i
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|HIL_KBD_MAX_LENGTH
suffix:semicolon
id|i
op_increment
)paren
id|kbd-&gt;exd
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIL_CMD_RNM
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|idx
suffix:semicolon
id|i
op_increment
)paren
id|kbd-&gt;rnm
(braket
id|i
)braket
op_assign
id|kbd-&gt;data
(braket
id|i
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|HIL_KBD_MAX_LENGTH
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|kbd-&gt;rnm
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* These occur when device isn&squot;t present */
r_if
c_cond
(paren
id|p
op_eq
(paren
id|HIL_ERR_INT
op_or
id|HIL_PKT_CMD
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Anything else we&squot;d like to know about. */
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Device sent unknown record %x&bslash;n&quot;
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
id|report
suffix:colon
id|cnt
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|kbd-&gt;data
(braket
l_int|0
)braket
op_amp
id|HIL_POL_CHARTYPE_MASK
)paren
(brace
r_case
id|HIL_POL_CHARTYPE_NONE
suffix:colon
r_break
suffix:semicolon
r_case
id|HIL_POL_CHARTYPE_ASCII
suffix:colon
r_while
c_loop
(paren
id|cnt
OL
id|idx
op_minus
l_int|1
)paren
id|input_report_key
c_func
(paren
id|dev
comma
id|kbd-&gt;data
(braket
id|cnt
op_increment
)braket
op_amp
l_int|0x7f
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIL_POL_CHARTYPE_RSVD1
suffix:colon
r_case
id|HIL_POL_CHARTYPE_RSVD2
suffix:colon
r_case
id|HIL_POL_CHARTYPE_BINARY
suffix:colon
r_while
c_loop
(paren
id|cnt
OL
id|idx
op_minus
l_int|1
)paren
id|input_report_key
c_func
(paren
id|dev
comma
id|kbd-&gt;data
(braket
id|cnt
op_increment
)braket
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIL_POL_CHARTYPE_SET1
suffix:colon
r_while
c_loop
(paren
id|cnt
OL
id|idx
op_minus
l_int|1
)paren
(brace
r_int
r_int
id|key
suffix:semicolon
r_int
id|up
suffix:semicolon
id|key
op_assign
id|kbd-&gt;data
(braket
id|cnt
op_increment
)braket
suffix:semicolon
id|up
op_assign
id|key
op_amp
id|HIL_KBD_SET1_UPBIT
suffix:semicolon
id|key
op_and_assign
(paren
op_complement
id|HIL_KBD_SET1_UPBIT
op_amp
l_int|0xff
)paren
suffix:semicolon
id|key
op_assign
id|hil_kbd_set1
(braket
id|key
op_rshift
id|HIL_KBD_SET1_SHIFT
)braket
suffix:semicolon
r_if
c_cond
(paren
id|key
op_ne
id|KEY_RESERVED
)paren
id|input_report_key
c_func
(paren
id|dev
comma
id|key
comma
op_logical_neg
id|up
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HIL_POL_CHARTYPE_SET2
suffix:colon
r_while
c_loop
(paren
id|cnt
OL
id|idx
op_minus
l_int|1
)paren
(brace
r_int
r_int
id|key
suffix:semicolon
r_int
id|up
suffix:semicolon
id|key
op_assign
id|kbd-&gt;data
(braket
id|cnt
op_increment
)braket
suffix:semicolon
id|up
op_assign
id|key
op_amp
id|HIL_KBD_SET2_UPBIT
suffix:semicolon
id|key
op_and_assign
(paren
op_complement
id|HIL_KBD_SET1_UPBIT
op_amp
l_int|0xff
)paren
suffix:semicolon
id|key
op_assign
id|key
op_rshift
id|HIL_KBD_SET2_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|key
op_ne
id|KEY_RESERVED
)paren
id|input_report_key
c_func
(paren
id|dev
comma
id|key
comma
op_logical_neg
id|up
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HIL_POL_CHARTYPE_SET3
suffix:colon
r_while
c_loop
(paren
id|cnt
OL
id|idx
op_minus
l_int|1
)paren
(brace
r_int
r_int
id|key
suffix:semicolon
r_int
id|up
suffix:semicolon
id|key
op_assign
id|kbd-&gt;data
(braket
id|cnt
op_increment
)braket
suffix:semicolon
id|up
op_assign
id|key
op_amp
id|HIL_KBD_SET3_UPBIT
suffix:semicolon
id|key
op_and_assign
(paren
op_complement
id|HIL_KBD_SET1_UPBIT
op_amp
l_int|0xff
)paren
suffix:semicolon
id|key
op_assign
id|hil_kbd_set3
(braket
id|key
op_rshift
id|HIL_KBD_SET3_SHIFT
)braket
suffix:semicolon
r_if
c_cond
(paren
id|key
op_ne
id|KEY_RESERVED
)paren
id|input_report_key
c_func
(paren
id|dev
comma
id|key
comma
op_logical_neg
id|up
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|out
suffix:colon
id|kbd-&gt;idx4
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|kbd-&gt;sem
)paren
suffix:semicolon
)brace
DECL|function|hil_kbd_process_err
r_static
r_void
id|hil_kbd_process_err
c_func
(paren
r_struct
id|hil_kbd
op_star
id|kbd
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;errored HIL packet&bslash;n&quot;
)paren
suffix:semicolon
id|kbd-&gt;idx4
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|kbd-&gt;sem
)paren
suffix:semicolon
)brace
DECL|function|hil_kbd_interrupt
r_static
id|irqreturn_t
id|hil_kbd_interrupt
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_int
r_char
id|data
comma
r_int
r_int
id|flags
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|hil_kbd
op_star
id|kbd
suffix:semicolon
id|hil_packet
id|packet
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|kbd
op_assign
(paren
r_struct
id|hil_kbd
op_star
)paren
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|kbd
op_eq
l_int|NULL
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kbd-&gt;idx4
op_ge
(paren
id|HIL_KBD_MAX_LENGTH
op_star
r_sizeof
(paren
id|hil_packet
)paren
)paren
)paren
(brace
id|hil_kbd_process_err
c_func
(paren
id|kbd
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|idx
op_assign
id|kbd-&gt;idx4
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|kbd-&gt;idx4
op_mod
l_int|4
)paren
)paren
id|kbd-&gt;data
(braket
id|idx
)braket
op_assign
l_int|0
suffix:semicolon
id|packet
op_assign
id|kbd-&gt;data
(braket
id|idx
)braket
suffix:semicolon
id|packet
op_or_assign
(paren
(paren
id|hil_packet
)paren
id|data
)paren
op_lshift
(paren
(paren
l_int|3
op_minus
(paren
id|kbd-&gt;idx4
op_mod
l_int|4
)paren
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|kbd-&gt;data
(braket
id|idx
)braket
op_assign
id|packet
suffix:semicolon
multiline_comment|/* Records of N 4-byte hil_packets must terminate with a command. */
r_if
c_cond
(paren
(paren
op_increment
(paren
id|kbd-&gt;idx4
)paren
)paren
op_mod
l_int|4
)paren
r_return
id|IRQ_HANDLED
suffix:semicolon
r_if
c_cond
(paren
(paren
id|packet
op_amp
l_int|0xffff0000
)paren
op_ne
id|HIL_ERR_INT
)paren
(brace
id|hil_kbd_process_err
c_func
(paren
id|kbd
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|packet
op_amp
id|HIL_PKT_CMD
)paren
id|hil_kbd_process_record
c_func
(paren
id|kbd
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|hil_kbd_disconnect
r_static
r_void
id|hil_kbd_disconnect
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|hil_kbd
op_star
id|kbd
suffix:semicolon
id|kbd
op_assign
(paren
r_struct
id|hil_kbd
op_star
)paren
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|kbd
op_eq
l_int|NULL
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|input_unregister_device
c_func
(paren
op_amp
id|kbd-&gt;dev
)paren
suffix:semicolon
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|kbd
)paren
suffix:semicolon
)brace
DECL|function|hil_kbd_connect
r_static
r_void
id|hil_kbd_connect
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_struct
id|serio_driver
op_star
id|drv
)paren
(brace
r_struct
id|hil_kbd
op_star
id|kbd
suffix:semicolon
r_uint8
id|did
comma
op_star
id|idd
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;type
op_ne
(paren
id|SERIO_HIL_MLC
op_or
id|SERIO_HIL
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|kbd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hil_kbd
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|kbd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hil_kbd
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serio_open
c_func
(paren
id|serio
comma
id|drv
)paren
)paren
r_goto
id|bail0
suffix:semicolon
id|serio
op_member_access_from_pointer
r_private
op_assign
id|kbd
suffix:semicolon
id|kbd-&gt;serio
op_assign
id|serio
suffix:semicolon
id|kbd-&gt;dev
dot
r_private
op_assign
id|kbd
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
(paren
id|kbd-&gt;sem
)paren
)paren
suffix:semicolon
multiline_comment|/* Get device info.  MLC driver supplies devid/status/etc. */
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_IDD
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|kbd-&gt;sem
)paren
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_RSC
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|kbd-&gt;sem
)paren
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_RNM
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|kbd-&gt;sem
)paren
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_EXD
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|kbd-&gt;sem
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
(paren
id|kbd-&gt;sem
)paren
)paren
suffix:semicolon
id|did
op_assign
id|kbd-&gt;idd
(braket
l_int|0
)braket
suffix:semicolon
id|idd
op_assign
id|kbd-&gt;idd
op_plus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|did
op_amp
id|HIL_IDD_DID_TYPE_MASK
)paren
(brace
r_case
id|HIL_IDD_DID_TYPE_KB_INTEGRAL
suffix:colon
r_case
id|HIL_IDD_DID_TYPE_KB_ITF
suffix:colon
r_case
id|HIL_IDD_DID_TYPE_KB_RSVD
suffix:colon
r_case
id|HIL_IDD_DID_TYPE_CHAR
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;HIL keyboard found (did = 0x%02x, lang = %s)&bslash;n&quot;
comma
id|did
comma
id|hil_language
(braket
id|did
op_amp
id|HIL_IDD_DID_TYPE_KB_LANG_MASK
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|bail1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HIL_IDD_NUM_BUTTONS
c_func
(paren
id|idd
)paren
op_logical_or
id|HIL_IDD_NUM_AXES_PER_SET
c_func
(paren
op_star
id|idd
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;keyboards only, no combo devices supported.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bail1
suffix:semicolon
)brace
id|kbd-&gt;dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REP
)paren
suffix:semicolon
id|kbd-&gt;dev.ledbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|LED_NUML
)paren
op_or
id|BIT
c_func
(paren
id|LED_CAPSL
)paren
op_or
id|BIT
c_func
(paren
id|LED_SCROLLL
)paren
suffix:semicolon
id|kbd-&gt;dev.keycodemax
op_assign
id|HIL_KEYCODES_SET1_TBLSIZE
suffix:semicolon
id|kbd-&gt;dev.keycodesize
op_assign
r_sizeof
(paren
id|hil_kbd_set1
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|kbd-&gt;dev.keycode
op_assign
id|hil_kbd_set1
suffix:semicolon
id|kbd-&gt;dev.name
op_assign
id|strlen
c_func
(paren
id|kbd-&gt;rnm
)paren
ques
c_cond
id|kbd-&gt;rnm
suffix:colon
id|HIL_GENERIC_NAME
suffix:semicolon
id|kbd-&gt;dev.phys
op_assign
l_string|&quot;hpkbd/input0&quot;
suffix:semicolon
multiline_comment|/* XXX */
id|kbd-&gt;dev.id.bustype
op_assign
id|BUS_HIL
suffix:semicolon
id|kbd-&gt;dev.id.vendor
op_assign
id|PCI_VENDOR_ID_HP
suffix:semicolon
id|kbd-&gt;dev.id.product
op_assign
l_int|0x0001
suffix:semicolon
multiline_comment|/* TODO: get from kbd-&gt;rsc */
id|kbd-&gt;dev.id.version
op_assign
l_int|0x0100
suffix:semicolon
multiline_comment|/* TODO: get from kbd-&gt;rsc */
id|kbd-&gt;dev.dev
op_assign
op_amp
id|serio-&gt;dev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_bit
c_func
(paren
id|hil_kbd_set1
(braket
id|i
)braket
comma
id|kbd-&gt;dev.keybit
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|hil_kbd_set3
(braket
id|i
)braket
comma
id|kbd-&gt;dev.keybit
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
l_int|0
comma
id|kbd-&gt;dev.keybit
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|kbd-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input: %s, ID: %d&bslash;n&quot;
comma
id|kbd-&gt;dev.name
comma
id|did
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_EK1
)paren
suffix:semicolon
multiline_comment|/* Enable Keyswitch Autorepeat 1 */
id|down
c_func
(paren
op_amp
(paren
id|kbd-&gt;sem
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
(paren
id|kbd-&gt;sem
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
id|bail1
suffix:colon
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|bail0
suffix:colon
id|kfree
c_func
(paren
id|kbd
)paren
suffix:semicolon
)brace
DECL|variable|hil_kbd_serio_drv
r_struct
id|serio_driver
id|hil_kbd_serio_drv
op_assign
(brace
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;hil_kbd&quot;
comma
)brace
comma
dot
id|description
op_assign
l_string|&quot;HP HIL keyboard driver&quot;
comma
dot
id|connect
op_assign
id|hil_kbd_connect
comma
dot
id|disconnect
op_assign
id|hil_kbd_disconnect
comma
dot
id|interrupt
op_assign
id|hil_kbd_interrupt
)brace
suffix:semicolon
DECL|function|hil_kbd_init
r_static
r_int
id|__init
id|hil_kbd_init
c_func
(paren
r_void
)paren
(brace
id|serio_register_driver
c_func
(paren
op_amp
id|hil_kbd_serio_drv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hil_kbd_exit
r_static
r_void
id|__exit
id|hil_kbd_exit
c_func
(paren
r_void
)paren
(brace
id|serio_unregister_driver
c_func
(paren
op_amp
id|hil_kbd_serio_drv
)paren
suffix:semicolon
)brace
DECL|variable|hil_kbd_init
id|module_init
c_func
(paren
id|hil_kbd_init
)paren
suffix:semicolon
DECL|variable|hil_kbd_exit
id|module_exit
c_func
(paren
id|hil_kbd_exit
)paren
suffix:semicolon
eof
