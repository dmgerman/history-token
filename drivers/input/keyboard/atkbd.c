multiline_comment|/*&n; * AT and PS/2 keyboard driver&n; *&n; * Copyright (c) 1999-2002 Vojtech Pavlik&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License version 2 as published by&n; * the Free Software Foundation.&n; */
multiline_comment|/*&n; * This driver can handle standard AT keyboards and PS/2 keyboards in&n; * Translated and Raw Set 2 and Set 3, as well as AT keyboards on dumb&n; * input-only controllers and AT keyboards connected over a one way RS232&n; * converter.&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/serio.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/libps2.h&gt;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;AT and PS/2 keyboard driver&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Vojtech Pavlik &lt;vojtech@suse.cz&gt;&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|atkbd_set
r_static
r_int
id|atkbd_set
op_assign
l_int|2
suffix:semicolon
id|module_param_named
c_func
(paren
id|set
comma
id|atkbd_set
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|set
comma
l_string|&quot;Select keyboard code set (2 = default, 3 = PS/2 native)&quot;
)paren
suffix:semicolon
macro_line|#if defined(__i386__) || defined(__x86_64__) || defined(__hppa__)
DECL|variable|atkbd_reset
r_static
r_int
id|atkbd_reset
suffix:semicolon
macro_line|#else
DECL|variable|atkbd_reset
r_static
r_int
id|atkbd_reset
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|module_param_named
c_func
(paren
id|reset
comma
id|atkbd_reset
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|reset
comma
l_string|&quot;Reset keyboard during initialization&quot;
)paren
suffix:semicolon
DECL|variable|atkbd_softrepeat
r_static
r_int
id|atkbd_softrepeat
suffix:semicolon
id|module_param_named
c_func
(paren
id|softrepeat
comma
id|atkbd_softrepeat
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|softrepeat
comma
l_string|&quot;Use software keyboard repeat&quot;
)paren
suffix:semicolon
DECL|variable|atkbd_softraw
r_static
r_int
id|atkbd_softraw
op_assign
l_int|1
suffix:semicolon
id|module_param_named
c_func
(paren
id|softraw
comma
id|atkbd_softraw
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|softraw
comma
l_string|&quot;Use software generated rawmode&quot;
)paren
suffix:semicolon
DECL|variable|atkbd_scroll
r_static
r_int
id|atkbd_scroll
suffix:semicolon
id|module_param_named
c_func
(paren
id|scroll
comma
id|atkbd_scroll
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|scroll
comma
l_string|&quot;Enable scroll-wheel on MS Office and similar keyboards&quot;
)paren
suffix:semicolon
DECL|variable|atkbd_extra
r_static
r_int
id|atkbd_extra
suffix:semicolon
id|module_param_named
c_func
(paren
id|extra
comma
id|atkbd_extra
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|extra
comma
l_string|&quot;Enable extra LEDs and keys on IBM RapidAcces, EzKey and similar keyboards&quot;
)paren
suffix:semicolon
id|__obsolete_setup
c_func
(paren
l_string|&quot;atkbd_set=&quot;
)paren
suffix:semicolon
id|__obsolete_setup
c_func
(paren
l_string|&quot;atkbd_reset&quot;
)paren
suffix:semicolon
id|__obsolete_setup
c_func
(paren
l_string|&quot;atkbd_softrepeat=&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Scancode to keycode tables. These are just the default setting, and&n; * are loadable via an userland utility.&n; */
macro_line|#if defined(__hppa__)
macro_line|#include &quot;hpps2atkbd.h&quot;
macro_line|#else
DECL|variable|atkbd_set2_keycode
r_static
r_int
r_char
id|atkbd_set2_keycode
(braket
l_int|512
)braket
op_assign
(brace
l_int|0
comma
l_int|67
comma
l_int|65
comma
l_int|63
comma
l_int|61
comma
l_int|59
comma
l_int|60
comma
l_int|88
comma
l_int|0
comma
l_int|68
comma
l_int|66
comma
l_int|64
comma
l_int|62
comma
l_int|15
comma
l_int|41
comma
l_int|117
comma
l_int|0
comma
l_int|56
comma
l_int|42
comma
l_int|93
comma
l_int|29
comma
l_int|16
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|44
comma
l_int|31
comma
l_int|30
comma
l_int|17
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|46
comma
l_int|45
comma
l_int|32
comma
l_int|18
comma
l_int|5
comma
l_int|4
comma
l_int|95
comma
l_int|0
comma
l_int|57
comma
l_int|47
comma
l_int|33
comma
l_int|20
comma
l_int|19
comma
l_int|6
comma
l_int|183
comma
l_int|0
comma
l_int|49
comma
l_int|48
comma
l_int|35
comma
l_int|34
comma
l_int|21
comma
l_int|7
comma
l_int|184
comma
l_int|0
comma
l_int|0
comma
l_int|50
comma
l_int|36
comma
l_int|22
comma
l_int|8
comma
l_int|9
comma
l_int|185
comma
l_int|0
comma
l_int|51
comma
l_int|37
comma
l_int|23
comma
l_int|24
comma
l_int|11
comma
l_int|10
comma
l_int|0
comma
l_int|0
comma
l_int|52
comma
l_int|53
comma
l_int|38
comma
l_int|39
comma
l_int|25
comma
l_int|12
comma
l_int|0
comma
l_int|0
comma
l_int|89
comma
l_int|40
comma
l_int|0
comma
l_int|26
comma
l_int|13
comma
l_int|0
comma
l_int|0
comma
l_int|58
comma
l_int|54
comma
l_int|28
comma
l_int|27
comma
l_int|0
comma
l_int|43
comma
l_int|0
comma
l_int|85
comma
l_int|0
comma
l_int|86
comma
l_int|91
comma
l_int|90
comma
l_int|92
comma
l_int|0
comma
l_int|14
comma
l_int|94
comma
l_int|0
comma
l_int|79
comma
l_int|124
comma
l_int|75
comma
l_int|71
comma
l_int|121
comma
l_int|0
comma
l_int|0
comma
l_int|82
comma
l_int|83
comma
l_int|80
comma
l_int|76
comma
l_int|77
comma
l_int|72
comma
l_int|1
comma
l_int|69
comma
l_int|87
comma
l_int|78
comma
l_int|81
comma
l_int|74
comma
l_int|55
comma
l_int|73
comma
l_int|70
comma
l_int|99
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|217
comma
l_int|100
comma
l_int|255
comma
l_int|0
comma
l_int|97
comma
l_int|165
comma
l_int|0
comma
l_int|0
comma
l_int|156
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|125
comma
l_int|173
comma
l_int|114
comma
l_int|0
comma
l_int|113
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|126
comma
l_int|128
comma
l_int|0
comma
l_int|0
comma
l_int|140
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|127
comma
l_int|159
comma
l_int|0
comma
l_int|115
comma
l_int|0
comma
l_int|164
comma
l_int|0
comma
l_int|0
comma
l_int|116
comma
l_int|158
comma
l_int|0
comma
l_int|150
comma
l_int|166
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|142
comma
l_int|157
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|155
comma
l_int|0
comma
l_int|98
comma
l_int|0
comma
l_int|0
comma
l_int|163
comma
l_int|0
comma
l_int|0
comma
l_int|226
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|255
comma
l_int|96
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|143
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|107
comma
l_int|0
comma
l_int|105
comma
l_int|102
comma
l_int|0
comma
l_int|0
comma
l_int|112
comma
l_int|110
comma
l_int|111
comma
l_int|108
comma
l_int|112
comma
l_int|106
comma
l_int|103
comma
l_int|0
comma
l_int|119
comma
l_int|0
comma
l_int|118
comma
l_int|109
comma
l_int|0
comma
l_int|99
comma
l_int|104
comma
l_int|119
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|65
comma
l_int|99
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|atkbd_set3_keycode
r_static
r_int
r_char
id|atkbd_set3_keycode
(braket
l_int|512
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|59
comma
l_int|1
comma
l_int|138
comma
l_int|128
comma
l_int|129
comma
l_int|130
comma
l_int|15
comma
l_int|41
comma
l_int|60
comma
l_int|131
comma
l_int|29
comma
l_int|42
comma
l_int|86
comma
l_int|58
comma
l_int|16
comma
l_int|2
comma
l_int|61
comma
l_int|133
comma
l_int|56
comma
l_int|44
comma
l_int|31
comma
l_int|30
comma
l_int|17
comma
l_int|3
comma
l_int|62
comma
l_int|134
comma
l_int|46
comma
l_int|45
comma
l_int|32
comma
l_int|18
comma
l_int|5
comma
l_int|4
comma
l_int|63
comma
l_int|135
comma
l_int|57
comma
l_int|47
comma
l_int|33
comma
l_int|20
comma
l_int|19
comma
l_int|6
comma
l_int|64
comma
l_int|136
comma
l_int|49
comma
l_int|48
comma
l_int|35
comma
l_int|34
comma
l_int|21
comma
l_int|7
comma
l_int|65
comma
l_int|137
comma
l_int|100
comma
l_int|50
comma
l_int|36
comma
l_int|22
comma
l_int|8
comma
l_int|9
comma
l_int|66
comma
l_int|125
comma
l_int|51
comma
l_int|37
comma
l_int|23
comma
l_int|24
comma
l_int|11
comma
l_int|10
comma
l_int|67
comma
l_int|126
comma
l_int|52
comma
l_int|53
comma
l_int|38
comma
l_int|39
comma
l_int|25
comma
l_int|12
comma
l_int|68
comma
l_int|113
comma
l_int|114
comma
l_int|40
comma
l_int|43
comma
l_int|26
comma
l_int|13
comma
l_int|87
comma
l_int|99
comma
l_int|97
comma
l_int|54
comma
l_int|28
comma
l_int|27
comma
l_int|43
comma
l_int|43
comma
l_int|88
comma
l_int|70
comma
l_int|108
comma
l_int|105
comma
l_int|119
comma
l_int|103
comma
l_int|111
comma
l_int|107
comma
l_int|14
comma
l_int|110
comma
l_int|0
comma
l_int|79
comma
l_int|106
comma
l_int|75
comma
l_int|71
comma
l_int|109
comma
l_int|102
comma
l_int|104
comma
l_int|82
comma
l_int|83
comma
l_int|80
comma
l_int|76
comma
l_int|77
comma
l_int|72
comma
l_int|69
comma
l_int|98
comma
l_int|0
comma
l_int|96
comma
l_int|81
comma
l_int|0
comma
l_int|78
comma
l_int|73
comma
l_int|55
comma
l_int|183
comma
l_int|184
comma
l_int|185
comma
l_int|186
comma
l_int|187
comma
l_int|74
comma
l_int|94
comma
l_int|92
comma
l_int|93
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|125
comma
l_int|126
comma
l_int|127
comma
l_int|112
comma
l_int|0
comma
l_int|0
comma
l_int|139
comma
l_int|150
comma
l_int|163
comma
l_int|165
comma
l_int|115
comma
l_int|152
comma
l_int|150
comma
l_int|166
comma
l_int|140
comma
l_int|160
comma
l_int|154
comma
l_int|113
comma
l_int|114
comma
l_int|167
comma
l_int|168
comma
l_int|148
comma
l_int|149
comma
l_int|147
comma
l_int|140
)brace
suffix:semicolon
DECL|variable|atkbd_unxlate_table
r_static
r_int
r_char
id|atkbd_unxlate_table
(braket
l_int|128
)braket
op_assign
(brace
l_int|0
comma
l_int|118
comma
l_int|22
comma
l_int|30
comma
l_int|38
comma
l_int|37
comma
l_int|46
comma
l_int|54
comma
l_int|61
comma
l_int|62
comma
l_int|70
comma
l_int|69
comma
l_int|78
comma
l_int|85
comma
l_int|102
comma
l_int|13
comma
l_int|21
comma
l_int|29
comma
l_int|36
comma
l_int|45
comma
l_int|44
comma
l_int|53
comma
l_int|60
comma
l_int|67
comma
l_int|68
comma
l_int|77
comma
l_int|84
comma
l_int|91
comma
l_int|90
comma
l_int|20
comma
l_int|28
comma
l_int|27
comma
l_int|35
comma
l_int|43
comma
l_int|52
comma
l_int|51
comma
l_int|59
comma
l_int|66
comma
l_int|75
comma
l_int|76
comma
l_int|82
comma
l_int|14
comma
l_int|18
comma
l_int|93
comma
l_int|26
comma
l_int|34
comma
l_int|33
comma
l_int|42
comma
l_int|50
comma
l_int|49
comma
l_int|58
comma
l_int|65
comma
l_int|73
comma
l_int|74
comma
l_int|89
comma
l_int|124
comma
l_int|17
comma
l_int|41
comma
l_int|88
comma
l_int|5
comma
l_int|6
comma
l_int|4
comma
l_int|12
comma
l_int|3
comma
l_int|11
comma
l_int|2
comma
l_int|10
comma
l_int|1
comma
l_int|9
comma
l_int|119
comma
l_int|126
comma
l_int|108
comma
l_int|117
comma
l_int|125
comma
l_int|123
comma
l_int|107
comma
l_int|115
comma
l_int|116
comma
l_int|121
comma
l_int|105
comma
l_int|114
comma
l_int|122
comma
l_int|112
comma
l_int|113
comma
l_int|127
comma
l_int|96
comma
l_int|97
comma
l_int|120
comma
l_int|7
comma
l_int|15
comma
l_int|23
comma
l_int|31
comma
l_int|39
comma
l_int|47
comma
l_int|55
comma
l_int|63
comma
l_int|71
comma
l_int|79
comma
l_int|86
comma
l_int|94
comma
l_int|8
comma
l_int|16
comma
l_int|24
comma
l_int|32
comma
l_int|40
comma
l_int|48
comma
l_int|56
comma
l_int|64
comma
l_int|72
comma
l_int|80
comma
l_int|87
comma
l_int|111
comma
l_int|19
comma
l_int|25
comma
l_int|57
comma
l_int|81
comma
l_int|83
comma
l_int|92
comma
l_int|95
comma
l_int|98
comma
l_int|99
comma
l_int|100
comma
l_int|101
comma
l_int|103
comma
l_int|104
comma
l_int|106
comma
l_int|109
comma
l_int|110
)brace
suffix:semicolon
DECL|macro|ATKBD_CMD_SETLEDS
mdefine_line|#define ATKBD_CMD_SETLEDS&t;0x10ed
DECL|macro|ATKBD_CMD_GSCANSET
mdefine_line|#define ATKBD_CMD_GSCANSET&t;0x11f0
DECL|macro|ATKBD_CMD_SSCANSET
mdefine_line|#define ATKBD_CMD_SSCANSET&t;0x10f0
DECL|macro|ATKBD_CMD_GETID
mdefine_line|#define ATKBD_CMD_GETID&t;&t;0x02f2
DECL|macro|ATKBD_CMD_SETREP
mdefine_line|#define ATKBD_CMD_SETREP&t;0x10f3
DECL|macro|ATKBD_CMD_ENABLE
mdefine_line|#define ATKBD_CMD_ENABLE&t;0x00f4
DECL|macro|ATKBD_CMD_RESET_DIS
mdefine_line|#define ATKBD_CMD_RESET_DIS&t;0x00f5
DECL|macro|ATKBD_CMD_SETALL_MBR
mdefine_line|#define ATKBD_CMD_SETALL_MBR&t;0x00fa
DECL|macro|ATKBD_CMD_RESET_BAT
mdefine_line|#define ATKBD_CMD_RESET_BAT&t;0x02ff
DECL|macro|ATKBD_CMD_RESEND
mdefine_line|#define ATKBD_CMD_RESEND&t;0x00fe
DECL|macro|ATKBD_CMD_EX_ENABLE
mdefine_line|#define ATKBD_CMD_EX_ENABLE&t;0x10ea
DECL|macro|ATKBD_CMD_EX_SETLEDS
mdefine_line|#define ATKBD_CMD_EX_SETLEDS&t;0x20eb
DECL|macro|ATKBD_CMD_OK_GETID
mdefine_line|#define ATKBD_CMD_OK_GETID&t;0x02e8
DECL|macro|ATKBD_RET_ACK
mdefine_line|#define ATKBD_RET_ACK&t;&t;0xfa
DECL|macro|ATKBD_RET_NAK
mdefine_line|#define ATKBD_RET_NAK&t;&t;0xfe
DECL|macro|ATKBD_RET_BAT
mdefine_line|#define ATKBD_RET_BAT&t;&t;0xaa
DECL|macro|ATKBD_RET_EMUL0
mdefine_line|#define ATKBD_RET_EMUL0&t;&t;0xe0
DECL|macro|ATKBD_RET_EMUL1
mdefine_line|#define ATKBD_RET_EMUL1&t;&t;0xe1
DECL|macro|ATKBD_RET_RELEASE
mdefine_line|#define ATKBD_RET_RELEASE&t;0xf0
DECL|macro|ATKBD_RET_HANGUEL
mdefine_line|#define ATKBD_RET_HANGUEL&t;0xf1
DECL|macro|ATKBD_RET_HANJA
mdefine_line|#define ATKBD_RET_HANJA&t;&t;0xf2
DECL|macro|ATKBD_RET_ERR
mdefine_line|#define ATKBD_RET_ERR&t;&t;0xff
DECL|macro|ATKBD_KEY_UNKNOWN
mdefine_line|#define ATKBD_KEY_UNKNOWN&t;  0
DECL|macro|ATKBD_KEY_NULL
mdefine_line|#define ATKBD_KEY_NULL&t;&t;255
DECL|macro|ATKBD_SCR_1
mdefine_line|#define ATKBD_SCR_1&t;&t;254
DECL|macro|ATKBD_SCR_2
mdefine_line|#define ATKBD_SCR_2&t;&t;253
DECL|macro|ATKBD_SCR_4
mdefine_line|#define ATKBD_SCR_4&t;&t;252
DECL|macro|ATKBD_SCR_8
mdefine_line|#define ATKBD_SCR_8&t;&t;251
DECL|macro|ATKBD_SCR_CLICK
mdefine_line|#define ATKBD_SCR_CLICK&t;&t;250
DECL|macro|ATKBD_SPECIAL
mdefine_line|#define ATKBD_SPECIAL&t;&t;250
DECL|variable|atkbd_scroll_keys
r_static
r_int
r_char
id|atkbd_scroll_keys
(braket
l_int|5
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
id|ATKBD_SCR_1
comma
l_int|0x45
)brace
comma
(brace
id|ATKBD_SCR_2
comma
l_int|0x29
)brace
comma
(brace
id|ATKBD_SCR_4
comma
l_int|0x36
)brace
comma
(brace
id|ATKBD_SCR_8
comma
l_int|0x27
)brace
comma
(brace
id|ATKBD_SCR_CLICK
comma
l_int|0x60
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * The atkbd control structure&n; */
DECL|struct|atkbd
r_struct
id|atkbd
(brace
DECL|member|ps2dev
r_struct
id|ps2dev
id|ps2dev
suffix:semicolon
multiline_comment|/* Written only during init */
DECL|member|name
r_char
id|name
(braket
l_int|64
)braket
suffix:semicolon
DECL|member|phys
r_char
id|phys
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|dev
r_struct
id|input_dev
id|dev
suffix:semicolon
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|keycode
r_int
r_char
id|keycode
(braket
l_int|512
)braket
suffix:semicolon
DECL|member|set
r_int
r_char
id|set
suffix:semicolon
DECL|member|translated
r_int
r_char
id|translated
suffix:semicolon
DECL|member|extra
r_int
r_char
id|extra
suffix:semicolon
DECL|member|write
r_int
r_char
id|write
suffix:semicolon
DECL|member|softrepeat
r_int
r_char
id|softrepeat
suffix:semicolon
DECL|member|softraw
r_int
r_char
id|softraw
suffix:semicolon
DECL|member|scroll
r_int
r_char
id|scroll
suffix:semicolon
DECL|member|enabled
r_int
r_char
id|enabled
suffix:semicolon
multiline_comment|/* Accessed only from interrupt */
DECL|member|emul
r_int
r_char
id|emul
suffix:semicolon
DECL|member|resend
r_int
r_char
id|resend
suffix:semicolon
DECL|member|release
r_int
r_char
id|release
suffix:semicolon
DECL|member|bat_xl
r_int
r_char
id|bat_xl
suffix:semicolon
DECL|member|last
r_int
r_int
id|last
suffix:semicolon
DECL|member|time
r_int
r_int
id|time
suffix:semicolon
)brace
suffix:semicolon
r_static
id|ssize_t
id|atkbd_attr_show_helper
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
id|ssize_t
(paren
op_star
id|handler
)paren
(paren
r_struct
id|atkbd
op_star
comma
r_char
op_star
)paren
)paren
suffix:semicolon
r_static
id|ssize_t
id|atkbd_attr_set_helper
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|ssize_t
(paren
op_star
id|handler
)paren
(paren
r_struct
id|atkbd
op_star
comma
r_const
r_char
op_star
comma
r_int
)paren
)paren
suffix:semicolon
DECL|macro|ATKBD_DEFINE_ATTR
mdefine_line|#define ATKBD_DEFINE_ATTR(_name)&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t atkbd_show_##_name(struct atkbd *, char *);&t;&t;&t;&bslash;&n;static ssize_t atkbd_set_##_name(struct atkbd *, const char *, size_t);&t;&t;&bslash;&n;static ssize_t atkbd_do_show_##_name(struct device *d, char *b)&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return atkbd_attr_show_helper(d, b, atkbd_show_##_name);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t atkbd_do_set_##_name(struct device *d, const char *b, size_t s)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return atkbd_attr_set_helper(d, b, s, atkbd_set_##_name);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static struct device_attribute atkbd_attr_##_name = &t;&t;&t;&t;&bslash;&n;&t;__ATTR(_name, S_IWUSR | S_IRUGO, atkbd_do_show_##_name, atkbd_do_set_##_name);
DECL|variable|extra
id|ATKBD_DEFINE_ATTR
c_func
(paren
id|extra
)paren
suffix:semicolon
DECL|variable|scroll
id|ATKBD_DEFINE_ATTR
c_func
(paren
id|scroll
)paren
suffix:semicolon
DECL|variable|set
id|ATKBD_DEFINE_ATTR
c_func
(paren
id|set
)paren
suffix:semicolon
DECL|variable|softrepeat
id|ATKBD_DEFINE_ATTR
c_func
(paren
id|softrepeat
)paren
suffix:semicolon
DECL|variable|softraw
id|ATKBD_DEFINE_ATTR
c_func
(paren
id|softraw
)paren
suffix:semicolon
DECL|function|atkbd_report_key
r_static
r_void
id|atkbd_report_key
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
comma
r_int
id|code
comma
r_int
id|value
)paren
(brace
id|input_regs
c_func
(paren
id|dev
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|value
op_eq
l_int|3
)paren
(brace
id|input_report_key
c_func
(paren
id|dev
comma
id|code
comma
l_int|1
)paren
suffix:semicolon
id|input_sync
c_func
(paren
id|dev
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
id|dev
comma
id|code
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|input_event
c_func
(paren
id|dev
comma
id|EV_KEY
comma
id|code
comma
id|value
)paren
suffix:semicolon
id|input_sync
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_interrupt(). Here takes place processing of data received from&n; * the keyboard into events.&n; */
DECL|function|atkbd_interrupt
r_static
id|irqreturn_t
id|atkbd_interrupt
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_int
r_char
id|data
comma
r_int
r_int
id|flags
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|atkbd
op_star
id|atkbd
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
r_int
id|code
op_assign
id|data
suffix:semicolon
r_int
id|scroll
op_assign
l_int|0
comma
id|click
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|value
suffix:semicolon
macro_line|#ifdef ATKBD_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;atkbd.c: Received %02x flags %02x&bslash;n&quot;
comma
id|data
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if !defined(__i386__) &amp;&amp; !defined (__x86_64__)
r_if
c_cond
(paren
(paren
id|flags
op_amp
(paren
id|SERIO_FRAME
op_or
id|SERIO_PARITY
)paren
)paren
op_logical_and
(paren
op_complement
id|flags
op_amp
id|SERIO_TIMEOUT
)paren
op_logical_and
op_logical_neg
id|atkbd-&gt;resend
op_logical_and
id|atkbd-&gt;write
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;atkbd.c: frame/parity error: %02x&bslash;n&quot;
comma
id|flags
)paren
suffix:semicolon
id|serio_write
c_func
(paren
id|serio
comma
id|ATKBD_CMD_RESEND
)paren
suffix:semicolon
id|atkbd-&gt;resend
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|flags
op_logical_and
id|data
op_eq
id|ATKBD_RET_ACK
)paren
id|atkbd-&gt;resend
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|atkbd-&gt;ps2dev.flags
op_amp
id|PS2_FLAG_ACK
)paren
)paren
r_if
c_cond
(paren
id|ps2_handle_ack
c_func
(paren
op_amp
id|atkbd-&gt;ps2dev
comma
id|data
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|atkbd-&gt;ps2dev.flags
op_amp
id|PS2_FLAG_CMD
)paren
)paren
r_if
c_cond
(paren
id|ps2_handle_response
c_func
(paren
op_amp
id|atkbd-&gt;ps2dev
comma
id|data
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atkbd-&gt;enabled
)paren
r_goto
id|out
suffix:semicolon
id|input_event
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
id|EV_MSC
comma
id|MSC_RAW
comma
id|code
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;translated
)paren
(brace
r_if
c_cond
(paren
id|atkbd-&gt;emul
op_logical_or
op_logical_neg
(paren
id|code
op_eq
id|ATKBD_RET_EMUL0
op_logical_or
id|code
op_eq
id|ATKBD_RET_EMUL1
op_logical_or
id|code
op_eq
id|ATKBD_RET_HANGUEL
op_logical_or
id|code
op_eq
id|ATKBD_RET_HANJA
op_logical_or
id|code
op_eq
id|ATKBD_RET_ERR
op_logical_or
(paren
id|code
op_eq
id|ATKBD_RET_BAT
op_logical_and
op_logical_neg
id|atkbd-&gt;bat_xl
)paren
)paren
)paren
(brace
id|atkbd-&gt;release
op_assign
id|code
op_rshift
l_int|7
suffix:semicolon
id|code
op_and_assign
l_int|0x7f
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|atkbd-&gt;emul
op_logical_and
(paren
id|code
op_amp
l_int|0x7f
)paren
op_eq
(paren
id|ATKBD_RET_BAT
op_amp
l_int|0x7f
)paren
)paren
id|atkbd-&gt;bat_xl
op_assign
op_logical_neg
id|atkbd-&gt;release
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|ATKBD_RET_BAT
suffix:colon
id|atkbd-&gt;enabled
op_assign
l_int|0
suffix:semicolon
id|serio_rescan
c_func
(paren
id|atkbd-&gt;ps2dev.serio
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|ATKBD_RET_EMUL0
suffix:colon
id|atkbd-&gt;emul
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|ATKBD_RET_EMUL1
suffix:colon
id|atkbd-&gt;emul
op_assign
l_int|2
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|ATKBD_RET_RELEASE
suffix:colon
id|atkbd-&gt;release
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|ATKBD_RET_HANGUEL
suffix:colon
id|atkbd_report_key
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
id|regs
comma
id|KEY_HANGUEL
comma
l_int|3
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|ATKBD_RET_HANJA
suffix:colon
id|atkbd_report_key
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
id|regs
comma
id|KEY_HANJA
comma
l_int|3
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
id|ATKBD_RET_ERR
suffix:colon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;atkbd.c: Keyboard on %s reports too many keys pressed.&bslash;n&quot;
comma
id|serio-&gt;phys
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atkbd-&gt;set
op_ne
l_int|3
)paren
id|code
op_assign
(paren
id|code
op_amp
l_int|0x7f
)paren
op_or
(paren
(paren
id|code
op_amp
l_int|0x80
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;emul
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|atkbd-&gt;emul
)paren
r_goto
id|out
suffix:semicolon
id|code
op_or_assign
(paren
id|atkbd-&gt;set
op_ne
l_int|3
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x100
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atkbd-&gt;keycode
(braket
id|code
)braket
op_ne
id|ATKBD_KEY_NULL
)paren
id|input_event
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
id|EV_MSC
comma
id|MSC_SCAN
comma
id|code
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|atkbd-&gt;keycode
(braket
id|code
)braket
)paren
(brace
r_case
id|ATKBD_KEY_NULL
suffix:colon
r_break
suffix:semicolon
r_case
id|ATKBD_KEY_UNKNOWN
suffix:colon
r_if
c_cond
(paren
id|data
op_eq
id|ATKBD_RET_ACK
op_logical_or
id|data
op_eq
id|ATKBD_RET_NAK
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;atkbd.c: Spurious %s on %s. Some program, &quot;
l_string|&quot;like XFree86, might be trying access hardware directly.&bslash;n&quot;
comma
id|data
op_eq
id|ATKBD_RET_ACK
ques
c_cond
l_string|&quot;ACK&quot;
suffix:colon
l_string|&quot;NAK&quot;
comma
id|serio-&gt;phys
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;atkbd.c: Unknown key %s &quot;
l_string|&quot;(%s set %d, code %#x on %s).&bslash;n&quot;
comma
id|atkbd-&gt;release
ques
c_cond
l_string|&quot;released&quot;
suffix:colon
l_string|&quot;pressed&quot;
comma
id|atkbd-&gt;translated
ques
c_cond
l_string|&quot;translated&quot;
suffix:colon
l_string|&quot;raw&quot;
comma
id|atkbd-&gt;set
comma
id|code
comma
id|serio-&gt;phys
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;atkbd.c: Use &squot;setkeycodes %s%02x &lt;keycode&gt;&squot; &quot;
l_string|&quot;to make it known.&bslash;n&quot;
comma
id|code
op_amp
l_int|0x80
ques
c_cond
l_string|&quot;e0&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|code
op_amp
l_int|0x7f
)paren
suffix:semicolon
)brace
id|input_sync
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATKBD_SCR_1
suffix:colon
id|scroll
op_assign
l_int|1
op_minus
id|atkbd-&gt;release
op_star
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATKBD_SCR_2
suffix:colon
id|scroll
op_assign
l_int|2
op_minus
id|atkbd-&gt;release
op_star
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATKBD_SCR_4
suffix:colon
id|scroll
op_assign
l_int|4
op_minus
id|atkbd-&gt;release
op_star
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATKBD_SCR_8
suffix:colon
id|scroll
op_assign
l_int|8
op_minus
id|atkbd-&gt;release
op_star
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ATKBD_SCR_CLICK
suffix:colon
id|click
op_assign
op_logical_neg
id|atkbd-&gt;release
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|value
op_assign
id|atkbd-&gt;release
ques
c_cond
l_int|0
suffix:colon
(paren
l_int|1
op_plus
(paren
op_logical_neg
id|atkbd-&gt;softrepeat
op_logical_and
id|test_bit
c_func
(paren
id|atkbd-&gt;keycode
(braket
id|code
)braket
comma
id|atkbd-&gt;dev.key
)paren
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|value
)paren
(brace
multiline_comment|/* Workaround Toshiba laptop multiple keypress */
r_case
l_int|0
suffix:colon
id|atkbd-&gt;last
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|atkbd-&gt;last
op_assign
id|code
suffix:semicolon
id|atkbd-&gt;time
op_assign
id|jiffies
op_plus
(paren
id|atkbd-&gt;dev.rep
(braket
id|REP_DELAY
)braket
op_star
id|HZ
op_plus
l_int|500
)paren
op_div
l_int|1000
op_div
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|time_after
c_func
(paren
id|jiffies
comma
id|atkbd-&gt;time
)paren
op_logical_and
id|atkbd-&gt;last
op_eq
id|code
)paren
id|value
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|atkbd_report_key
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
id|regs
comma
id|atkbd-&gt;keycode
(braket
id|code
)braket
comma
id|value
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scroll
op_logical_or
id|click
op_ne
op_minus
l_int|1
)paren
(brace
id|input_regs
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
id|regs
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
id|BTN_MIDDLE
comma
id|click
)paren
suffix:semicolon
id|input_report_rel
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
id|REL_WHEEL
comma
id|scroll
)paren
suffix:semicolon
id|input_sync
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
)brace
id|atkbd-&gt;release
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * Event callback from the input module. Events that change the state of&n; * the hardware are processed here.&n; */
DECL|function|atkbd_event
r_static
r_int
id|atkbd_event
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_int
r_int
id|code
comma
r_int
id|value
)paren
(brace
r_struct
id|atkbd
op_star
id|atkbd
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_const
r_int
id|period
(braket
l_int|32
)braket
op_assign
(brace
l_int|33
comma
l_int|37
comma
l_int|42
comma
l_int|46
comma
l_int|50
comma
l_int|54
comma
l_int|58
comma
l_int|63
comma
l_int|67
comma
l_int|75
comma
l_int|83
comma
l_int|92
comma
l_int|100
comma
l_int|109
comma
l_int|116
comma
l_int|125
comma
l_int|133
comma
l_int|149
comma
l_int|167
comma
l_int|182
comma
l_int|200
comma
l_int|217
comma
l_int|232
comma
l_int|250
comma
l_int|270
comma
l_int|303
comma
l_int|333
comma
l_int|370
comma
l_int|400
comma
l_int|435
comma
l_int|470
comma
l_int|500
)brace
suffix:semicolon
r_const
r_int
id|delay
(braket
l_int|4
)braket
op_assign
(brace
l_int|250
comma
l_int|500
comma
l_int|750
comma
l_int|1000
)brace
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atkbd-&gt;write
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|EV_LED
suffix:colon
id|param
(braket
l_int|0
)braket
op_assign
(paren
id|test_bit
c_func
(paren
id|LED_SCROLLL
comma
id|dev-&gt;led
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_NUML
comma
id|dev-&gt;led
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_CAPSL
comma
id|dev-&gt;led
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
id|ps2_schedule_command
c_func
(paren
op_amp
id|atkbd-&gt;ps2dev
comma
id|param
comma
id|ATKBD_CMD_SETLEDS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;extra
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
(paren
id|test_bit
c_func
(paren
id|LED_COMPOSE
comma
id|dev-&gt;led
)paren
ques
c_cond
l_int|0x01
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_SLEEP
comma
id|dev-&gt;led
)paren
ques
c_cond
l_int|0x02
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_SUSPEND
comma
id|dev-&gt;led
)paren
ques
c_cond
l_int|0x04
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_MISC
comma
id|dev-&gt;led
)paren
ques
c_cond
l_int|0x10
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_MUTE
comma
id|dev-&gt;led
)paren
ques
c_cond
l_int|0x20
suffix:colon
l_int|0
)paren
suffix:semicolon
id|ps2_schedule_command
c_func
(paren
op_amp
id|atkbd-&gt;ps2dev
comma
id|param
comma
id|ATKBD_CMD_EX_SETLEDS
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|EV_REP
suffix:colon
r_if
c_cond
(paren
id|atkbd-&gt;softrepeat
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_assign
id|j
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
l_int|32
op_logical_and
id|period
(braket
id|i
)braket
OL
id|dev-&gt;rep
(braket
id|REP_PERIOD
)braket
)paren
id|i
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|j
OL
l_int|4
op_logical_and
id|delay
(braket
id|j
)braket
OL
id|dev-&gt;rep
(braket
id|REP_DELAY
)braket
)paren
id|j
op_increment
suffix:semicolon
id|dev-&gt;rep
(braket
id|REP_PERIOD
)braket
op_assign
id|period
(braket
id|i
)braket
suffix:semicolon
id|dev-&gt;rep
(braket
id|REP_DELAY
)braket
op_assign
id|delay
(braket
id|j
)braket
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|i
op_or
(paren
id|j
op_lshift
l_int|5
)paren
suffix:semicolon
id|ps2_schedule_command
c_func
(paren
op_amp
id|atkbd-&gt;ps2dev
comma
id|param
comma
id|ATKBD_CMD_SETREP
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_enable() signals that interrupt handler is allowed to&n; * generate input events.&n; */
DECL|function|atkbd_enable
r_static
r_inline
r_void
id|atkbd_enable
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
)paren
(brace
id|serio_pause_rx
c_func
(paren
id|atkbd-&gt;ps2dev.serio
)paren
suffix:semicolon
id|atkbd-&gt;enabled
op_assign
l_int|1
suffix:semicolon
id|serio_continue_rx
c_func
(paren
id|atkbd-&gt;ps2dev.serio
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_disable() tells input handler that all incoming data except&n; * for ACKs and command response should be dropped.&n; */
DECL|function|atkbd_disable
r_static
r_inline
r_void
id|atkbd_disable
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
)paren
(brace
id|serio_pause_rx
c_func
(paren
id|atkbd-&gt;ps2dev.serio
)paren
suffix:semicolon
id|atkbd-&gt;enabled
op_assign
l_int|0
suffix:semicolon
id|serio_continue_rx
c_func
(paren
id|atkbd-&gt;ps2dev.serio
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_probe() probes for an AT keyboard on a serio port.&n; */
DECL|function|atkbd_probe
r_static
r_int
id|atkbd_probe
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
)paren
(brace
r_struct
id|ps2dev
op_star
id|ps2dev
op_assign
op_amp
id|atkbd-&gt;ps2dev
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*&n; * Some systems, where the bit-twiddling when testing the io-lines of the&n; * controller may confuse the keyboard need a full reset of the keyboard. On&n; * these systems the BIOS also usually doesn&squot;t do it for us.&n; */
r_if
c_cond
(paren
id|atkbd_reset
)paren
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
l_int|NULL
comma
id|ATKBD_CMD_RESET_BAT
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;atkbd.c: keyboard reset failed on %s&bslash;n&quot;
comma
id|ps2dev-&gt;serio-&gt;phys
)paren
suffix:semicolon
multiline_comment|/*&n; * Then we check the keyboard ID. We should get 0xab83 under normal conditions.&n; * Some keyboards report different values, but the first byte is always 0xab or&n; * 0xac. Some old AT keyboards don&squot;t report anything. If a mouse is connected, this&n; * should make sure we don&squot;t try to set the LEDs on it.&n; */
id|param
(braket
l_int|0
)braket
op_assign
id|param
(braket
l_int|1
)braket
op_assign
l_int|0xa5
suffix:semicolon
multiline_comment|/* initialize with invalid values */
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_GETID
)paren
)paren
(brace
multiline_comment|/*&n; * If the get ID command failed, we check if we can at least set the LEDs on&n; * the keyboard. This should work on every keyboard out there. It also turns&n; * the LEDs off, which we want anyway.&n; */
id|param
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_SETLEDS
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|atkbd-&gt;id
op_assign
l_int|0xabba
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
l_int|0xab
op_logical_and
id|param
(braket
l_int|0
)braket
op_ne
l_int|0xac
op_logical_and
multiline_comment|/* Regular and NCD Sun keyboards */
id|param
(braket
l_int|0
)braket
op_ne
l_int|0x2b
op_logical_and
id|param
(braket
l_int|0
)braket
op_ne
l_int|0x5d
op_logical_and
multiline_comment|/* Trust keyboard, raw and translated */
id|param
(braket
l_int|0
)braket
op_ne
l_int|0x60
op_logical_and
id|param
(braket
l_int|0
)braket
op_ne
l_int|0x47
)paren
multiline_comment|/* NMB SGI keyboard, raw and translated */
r_return
op_minus
l_int|1
suffix:semicolon
id|atkbd-&gt;id
op_assign
(paren
id|param
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
id|param
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;id
op_eq
l_int|0xaca1
op_logical_and
id|atkbd-&gt;translated
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;atkbd.c: NCD terminal keyboards are only supported on non-translating&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;atkbd.c: controllers. Use i8042.direct=1 to disable translation.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_select_set checks if a keyboard has a working Set 3 support, and&n; * sets it into that. Unfortunately there are keyboards that can be switched&n; * to Set 3, but don&squot;t work well in that (BTC Multimedia ...)&n; */
DECL|function|atkbd_select_set
r_static
r_int
id|atkbd_select_set
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_int
id|target_set
comma
r_int
id|allow_extra
)paren
(brace
r_struct
id|ps2dev
op_star
id|ps2dev
op_assign
op_amp
id|atkbd-&gt;ps2dev
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
id|atkbd-&gt;extra
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * For known special keyboards we can go ahead and set the correct set.&n; * We check for NCD PS/2 Sun, NorthGate OmniKey 101 and&n; * IBM RapidAccess / IBM EzButton / Chicony KBP-8993 keyboards.&n; */
r_if
c_cond
(paren
id|atkbd-&gt;translated
)paren
r_return
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;id
op_eq
l_int|0xaca1
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
l_int|3
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_SSCANSET
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|allow_extra
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
l_int|0x71
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_EX_ENABLE
)paren
)paren
(brace
id|atkbd-&gt;extra
op_assign
l_int|1
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|target_set
op_ne
l_int|3
)paren
r_return
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_OK_GETID
)paren
)paren
(brace
id|atkbd-&gt;id
op_assign
id|param
(braket
l_int|0
)braket
op_lshift
l_int|8
op_or
id|param
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
id|param
(braket
l_int|0
)braket
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_SSCANSET
)paren
)paren
r_return
l_int|2
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_GSCANSET
)paren
)paren
r_return
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
l_int|3
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_SSCANSET
)paren
)paren
r_return
l_int|2
suffix:semicolon
)brace
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_SETALL_MBR
)paren
suffix:semicolon
r_return
l_int|3
suffix:semicolon
)brace
DECL|function|atkbd_activate
r_static
r_int
id|atkbd_activate
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
)paren
(brace
r_struct
id|ps2dev
op_star
id|ps2dev
op_assign
op_amp
id|atkbd-&gt;ps2dev
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/*&n; * Set the LEDs to a defined state.&n; */
id|param
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_SETLEDS
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n; * Set autorepeat to fastest possible.&n; */
id|param
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|ATKBD_CMD_SETREP
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n; * Enable the keyboard to receive keystrokes.&n; */
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
l_int|NULL
comma
id|ATKBD_CMD_ENABLE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;atkbd.c: Failed to enable keyboard on %s&bslash;n&quot;
comma
id|ps2dev-&gt;serio-&gt;phys
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_cleanup() restores the keyboard state so that BIOS is happy after a&n; * reboot.&n; */
DECL|function|atkbd_cleanup
r_static
r_void
id|atkbd_cleanup
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|atkbd
op_star
id|atkbd
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
id|ps2_command
c_func
(paren
op_amp
id|atkbd-&gt;ps2dev
comma
l_int|NULL
comma
id|ATKBD_CMD_RESET_BAT
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_disconnect() closes and frees.&n; */
DECL|function|atkbd_disconnect
r_static
r_void
id|atkbd_disconnect
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|atkbd
op_star
id|atkbd
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
id|atkbd_disable
c_func
(paren
id|atkbd
)paren
suffix:semicolon
multiline_comment|/* make sure we don&squot;t have a command in flight */
id|synchronize_kernel
c_func
(paren
)paren
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_extra
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_scroll
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_set
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_softrepeat
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_softraw
)paren
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|atkbd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_set_device_attrs() initializes keyboard&squot;s keycode table&n; * according to the selected scancode set&n; */
DECL|function|atkbd_set_keycode_table
r_static
r_void
id|atkbd_set_keycode_table
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
id|memset
c_func
(paren
id|atkbd-&gt;keycode
comma
l_int|0
comma
r_sizeof
(paren
id|atkbd-&gt;keycode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;translated
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|128
suffix:semicolon
id|i
op_increment
)paren
(brace
id|atkbd-&gt;keycode
(braket
id|i
)braket
op_assign
id|atkbd_set2_keycode
(braket
id|atkbd_unxlate_table
(braket
id|i
)braket
)braket
suffix:semicolon
id|atkbd-&gt;keycode
(braket
id|i
op_or
l_int|0x80
)braket
op_assign
id|atkbd_set2_keycode
(braket
id|atkbd_unxlate_table
(braket
id|i
)braket
op_or
l_int|0x80
)braket
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;scroll
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|atkbd_unxlate_table
(braket
id|i
)braket
op_eq
id|atkbd_scroll_keys
(braket
id|j
)braket
(braket
l_int|1
)braket
)paren
id|atkbd-&gt;keycode
(braket
id|i
)braket
op_assign
id|atkbd_scroll_keys
(braket
id|j
)braket
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|atkbd_unxlate_table
(braket
id|i
)braket
op_or
l_int|0x80
)paren
op_eq
id|atkbd_scroll_keys
(braket
id|j
)braket
(braket
l_int|1
)braket
)paren
id|atkbd-&gt;keycode
(braket
id|i
op_or
l_int|0x80
)braket
op_assign
id|atkbd_scroll_keys
(braket
id|j
)braket
(braket
l_int|0
)braket
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|atkbd-&gt;set
op_eq
l_int|3
)paren
(brace
id|memcpy
c_func
(paren
id|atkbd-&gt;keycode
comma
id|atkbd_set3_keycode
comma
r_sizeof
(paren
id|atkbd-&gt;keycode
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|atkbd-&gt;keycode
comma
id|atkbd_set2_keycode
comma
r_sizeof
(paren
id|atkbd-&gt;keycode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;scroll
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|atkbd-&gt;keycode
(braket
id|atkbd_scroll_keys
(braket
id|i
)braket
(braket
l_int|1
)braket
)braket
op_assign
id|atkbd_scroll_keys
(braket
id|i
)braket
(braket
l_int|0
)braket
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * atkbd_set_device_attrs() sets up keyboard&squot;s input device structure&n; */
DECL|function|atkbd_set_device_attrs
r_static
r_void
id|atkbd_set_device_attrs
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
)paren
(brace
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|atkbd-&gt;dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|input_dev
)paren
)paren
suffix:semicolon
id|init_input_dev
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
id|atkbd-&gt;dev.name
op_assign
id|atkbd-&gt;name
suffix:semicolon
id|atkbd-&gt;dev.phys
op_assign
id|atkbd-&gt;phys
suffix:semicolon
id|atkbd-&gt;dev.id.bustype
op_assign
id|BUS_I8042
suffix:semicolon
id|atkbd-&gt;dev.id.vendor
op_assign
l_int|0x0001
suffix:semicolon
id|atkbd-&gt;dev.id.product
op_assign
id|atkbd-&gt;translated
ques
c_cond
l_int|1
suffix:colon
id|atkbd-&gt;set
suffix:semicolon
id|atkbd-&gt;dev.id.version
op_assign
id|atkbd-&gt;id
suffix:semicolon
id|atkbd-&gt;dev.event
op_assign
id|atkbd_event
suffix:semicolon
id|atkbd-&gt;dev
dot
r_private
op_assign
id|atkbd
suffix:semicolon
id|atkbd-&gt;dev.dev
op_assign
op_amp
id|atkbd-&gt;ps2dev.serio-&gt;dev
suffix:semicolon
id|atkbd-&gt;dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REP
)paren
op_or
id|BIT
c_func
(paren
id|EV_MSC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;write
)paren
(brace
id|atkbd-&gt;dev.evbit
(braket
l_int|0
)braket
op_or_assign
id|BIT
c_func
(paren
id|EV_LED
)paren
suffix:semicolon
id|atkbd-&gt;dev.ledbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|LED_NUML
)paren
op_or
id|BIT
c_func
(paren
id|LED_CAPSL
)paren
op_or
id|BIT
c_func
(paren
id|LED_SCROLLL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atkbd-&gt;extra
)paren
id|atkbd-&gt;dev.ledbit
(braket
l_int|0
)braket
op_or_assign
id|BIT
c_func
(paren
id|LED_COMPOSE
)paren
op_or
id|BIT
c_func
(paren
id|LED_SUSPEND
)paren
op_or
id|BIT
c_func
(paren
id|LED_SLEEP
)paren
op_or
id|BIT
c_func
(paren
id|LED_MUTE
)paren
op_or
id|BIT
c_func
(paren
id|LED_MISC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atkbd-&gt;softrepeat
)paren
(brace
id|atkbd-&gt;dev.rep
(braket
id|REP_DELAY
)braket
op_assign
l_int|250
suffix:semicolon
id|atkbd-&gt;dev.rep
(braket
id|REP_PERIOD
)braket
op_assign
l_int|33
suffix:semicolon
)brace
id|atkbd-&gt;dev.mscbit
(braket
l_int|0
)braket
op_assign
id|atkbd-&gt;softraw
ques
c_cond
id|BIT
c_func
(paren
id|MSC_SCAN
)paren
suffix:colon
id|BIT
c_func
(paren
id|MSC_RAW
)paren
op_or
id|BIT
c_func
(paren
id|MSC_SCAN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;scroll
)paren
(brace
id|atkbd-&gt;dev.evbit
(braket
l_int|0
)braket
op_or_assign
id|BIT
c_func
(paren
id|EV_REL
)paren
suffix:semicolon
id|atkbd-&gt;dev.relbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|REL_WHEEL
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|BTN_MIDDLE
comma
id|atkbd-&gt;dev.keybit
)paren
suffix:semicolon
)brace
id|atkbd-&gt;dev.keycode
op_assign
id|atkbd-&gt;keycode
suffix:semicolon
id|atkbd-&gt;dev.keycodesize
op_assign
r_sizeof
(paren
r_int
r_char
)paren
suffix:semicolon
id|atkbd-&gt;dev.keycodemax
op_assign
id|ARRAY_SIZE
c_func
(paren
id|atkbd_set2_keycode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|512
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|atkbd-&gt;keycode
(braket
id|i
)braket
op_logical_and
id|atkbd-&gt;keycode
(braket
id|i
)braket
OL
id|ATKBD_SPECIAL
)paren
id|set_bit
c_func
(paren
id|atkbd-&gt;keycode
(braket
id|i
)braket
comma
id|atkbd-&gt;dev.keybit
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_connect() is called when the serio module finds and interface&n; * that isn&squot;t handled yet by an appropriate device driver. We check if&n; * there is an AT keyboard out there and if yes, we register ourselves&n; * to the input module.&n; */
DECL|function|atkbd_connect
r_static
r_void
id|atkbd_connect
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_struct
id|serio_driver
op_star
id|drv
)paren
(brace
r_struct
id|atkbd
op_star
id|atkbd
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|atkbd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|atkbd
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|atkbd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|atkbd
)paren
)paren
suffix:semicolon
id|ps2_init
c_func
(paren
op_amp
id|atkbd-&gt;ps2dev
comma
id|serio
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|serio-&gt;type
op_amp
id|SERIO_TYPE
)paren
(brace
r_case
id|SERIO_8042_XL
suffix:colon
id|atkbd-&gt;translated
op_assign
l_int|1
suffix:semicolon
r_case
id|SERIO_8042
suffix:colon
r_if
c_cond
(paren
id|serio-&gt;write
)paren
id|atkbd-&gt;write
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SERIO_RS232
suffix:colon
r_if
c_cond
(paren
(paren
id|serio-&gt;type
op_amp
id|SERIO_PROTO
)paren
op_eq
id|SERIO_PS2SER
)paren
r_break
suffix:semicolon
r_default
suffix:colon
id|kfree
c_func
(paren
id|atkbd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|atkbd-&gt;softraw
op_assign
id|atkbd_softraw
suffix:semicolon
id|atkbd-&gt;softrepeat
op_assign
id|atkbd_softrepeat
suffix:semicolon
id|atkbd-&gt;scroll
op_assign
id|atkbd_scroll
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atkbd-&gt;write
)paren
id|atkbd-&gt;softrepeat
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;softrepeat
)paren
id|atkbd-&gt;softraw
op_assign
l_int|1
suffix:semicolon
id|serio
op_member_access_from_pointer
r_private
op_assign
id|atkbd
suffix:semicolon
r_if
c_cond
(paren
id|serio_open
c_func
(paren
id|serio
comma
id|drv
)paren
)paren
(brace
id|kfree
c_func
(paren
id|atkbd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atkbd-&gt;write
)paren
(brace
r_if
c_cond
(paren
id|atkbd_probe
c_func
(paren
id|atkbd
)paren
)paren
(brace
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|atkbd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|atkbd-&gt;set
op_assign
id|atkbd_select_set
c_func
(paren
id|atkbd
comma
id|atkbd_set
comma
id|atkbd_extra
)paren
suffix:semicolon
id|atkbd_activate
c_func
(paren
id|atkbd
)paren
suffix:semicolon
)brace
r_else
(brace
id|atkbd-&gt;set
op_assign
l_int|2
suffix:semicolon
id|atkbd-&gt;id
op_assign
l_int|0xab00
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atkbd-&gt;extra
)paren
id|sprintf
c_func
(paren
id|atkbd-&gt;name
comma
l_string|&quot;AT Set 2 Extra keyboard&quot;
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|atkbd-&gt;name
comma
l_string|&quot;AT %s Set %d keyboard&quot;
comma
id|atkbd-&gt;translated
ques
c_cond
l_string|&quot;Translated&quot;
suffix:colon
l_string|&quot;Raw&quot;
comma
id|atkbd-&gt;set
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|atkbd-&gt;phys
comma
l_string|&quot;%s/input0&quot;
comma
id|serio-&gt;phys
)paren
suffix:semicolon
id|atkbd_set_keycode_table
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|atkbd_set_device_attrs
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_extra
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_scroll
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_set
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_softrepeat
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|atkbd_attr_softraw
)paren
suffix:semicolon
id|atkbd_enable
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input: %s on %s&bslash;n&quot;
comma
id|atkbd-&gt;name
comma
id|serio-&gt;phys
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * atkbd_reconnect() tries to restore keyboard into a sane state and is&n; * most likely called on resume.&n; */
DECL|function|atkbd_reconnect
r_static
r_int
id|atkbd_reconnect
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|atkbd
op_star
id|atkbd
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|serio_driver
op_star
id|drv
op_assign
id|serio-&gt;drv
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atkbd
op_logical_or
op_logical_neg
id|drv
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;atkbd: reconnect request, but serio is disconnected, ignoring...&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|atkbd_disable
c_func
(paren
id|atkbd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;write
)paren
(brace
id|param
(braket
l_int|0
)braket
op_assign
(paren
id|test_bit
c_func
(paren
id|LED_SCROLLL
comma
id|atkbd-&gt;dev.led
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_NUML
comma
id|atkbd-&gt;dev.led
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_CAPSL
comma
id|atkbd-&gt;dev.led
)paren
ques
c_cond
l_int|4
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atkbd_probe
c_func
(paren
id|atkbd
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;set
op_ne
id|atkbd_select_set
c_func
(paren
id|atkbd
comma
id|atkbd-&gt;set
comma
id|atkbd-&gt;extra
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|atkbd_activate
c_func
(paren
id|atkbd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
op_amp
id|atkbd-&gt;ps2dev
comma
id|param
comma
id|ATKBD_CMD_SETLEDS
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|atkbd_enable
c_func
(paren
id|atkbd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|atkbd_drv
r_static
r_struct
id|serio_driver
id|atkbd_drv
op_assign
(brace
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;atkbd&quot;
comma
)brace
comma
dot
id|description
op_assign
id|DRIVER_DESC
comma
dot
id|interrupt
op_assign
id|atkbd_interrupt
comma
dot
id|connect
op_assign
id|atkbd_connect
comma
dot
id|reconnect
op_assign
id|atkbd_reconnect
comma
dot
id|disconnect
op_assign
id|atkbd_disconnect
comma
dot
id|cleanup
op_assign
id|atkbd_cleanup
comma
)brace
suffix:semicolon
DECL|function|atkbd_attr_show_helper
r_static
id|ssize_t
id|atkbd_attr_show_helper
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
id|ssize_t
(paren
op_star
id|handler
)paren
(paren
r_struct
id|atkbd
op_star
comma
r_char
op_star
)paren
)paren
(brace
r_struct
id|serio
op_star
id|serio
op_assign
id|to_serio_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|serio_pin_driver
c_func
(paren
id|serio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;drv
op_ne
op_amp
id|atkbd_drv
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|handler
c_func
(paren
(paren
r_struct
id|atkbd
op_star
)paren
id|serio
op_member_access_from_pointer
r_private
comma
id|buf
)paren
suffix:semicolon
id|out
suffix:colon
id|serio_unpin_driver
c_func
(paren
id|serio
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|atkbd_attr_set_helper
r_static
id|ssize_t
id|atkbd_attr_set_helper
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|ssize_t
(paren
op_star
id|handler
)paren
(paren
r_struct
id|atkbd
op_star
comma
r_const
r_char
op_star
comma
r_int
)paren
)paren
(brace
r_struct
id|serio
op_star
id|serio
op_assign
id|to_serio_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|atkbd
op_star
id|atkbd
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|serio_pin_driver
c_func
(paren
id|serio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;drv
op_ne
op_amp
id|atkbd_drv
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|atkbd
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
id|atkbd_disable
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|retval
op_assign
id|handler
c_func
(paren
id|atkbd
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|atkbd_enable
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|out
suffix:colon
id|serio_unpin_driver
c_func
(paren
id|serio
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|atkbd_show_extra
r_static
id|ssize_t
id|atkbd_show_extra
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|atkbd-&gt;extra
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|atkbd_set_extra
r_static
id|ssize_t
id|atkbd_set_extra
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_char
op_star
id|rest
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atkbd-&gt;write
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|value
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|rest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rest
op_logical_or
id|value
OG
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;extra
op_ne
id|value
)paren
(brace
multiline_comment|/* unregister device as it&squot;s properties will change */
id|input_unregister_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
id|atkbd-&gt;set
op_assign
id|atkbd_select_set
c_func
(paren
id|atkbd
comma
id|atkbd-&gt;set
comma
id|value
)paren
suffix:semicolon
id|atkbd_activate
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|atkbd_set_device_attrs
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|atkbd_show_scroll
r_static
id|ssize_t
id|atkbd_show_scroll
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|atkbd-&gt;scroll
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|atkbd_set_scroll
r_static
id|ssize_t
id|atkbd_set_scroll
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_char
op_star
id|rest
suffix:semicolon
id|value
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|rest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rest
op_logical_or
id|value
OG
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;scroll
op_ne
id|value
)paren
(brace
multiline_comment|/* unregister device as it&squot;s properties will change */
id|input_unregister_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
id|atkbd-&gt;scroll
op_assign
id|value
suffix:semicolon
id|atkbd_set_keycode_table
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|atkbd_set_device_attrs
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|atkbd_show_set
r_static
id|ssize_t
id|atkbd_show_set
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|atkbd-&gt;set
)paren
suffix:semicolon
)brace
DECL|function|atkbd_set_set
r_static
id|ssize_t
id|atkbd_set_set
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_char
op_star
id|rest
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atkbd-&gt;write
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|value
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|rest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rest
op_logical_or
(paren
id|value
op_ne
l_int|2
op_logical_and
id|value
op_ne
l_int|3
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;set
op_ne
id|value
)paren
(brace
multiline_comment|/* unregister device as it&squot;s properties will change */
id|input_unregister_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
id|atkbd-&gt;set
op_assign
id|atkbd_select_set
c_func
(paren
id|atkbd
comma
id|value
comma
id|atkbd-&gt;extra
)paren
suffix:semicolon
id|atkbd_activate
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|atkbd_set_keycode_table
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|atkbd_set_device_attrs
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|atkbd_show_softrepeat
r_static
id|ssize_t
id|atkbd_show_softrepeat
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|atkbd-&gt;softrepeat
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|atkbd_set_softrepeat
r_static
id|ssize_t
id|atkbd_set_softrepeat
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_char
op_star
id|rest
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atkbd-&gt;write
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|value
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|rest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rest
op_logical_or
id|value
OG
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;softrepeat
op_ne
id|value
)paren
(brace
multiline_comment|/* unregister device as it&squot;s properties will change */
id|input_unregister_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
id|atkbd-&gt;softrepeat
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;softrepeat
)paren
id|atkbd-&gt;softraw
op_assign
l_int|1
suffix:semicolon
id|atkbd_set_device_attrs
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|atkbd_show_softraw
r_static
id|ssize_t
id|atkbd_show_softraw
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|atkbd-&gt;softraw
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|atkbd_set_softraw
r_static
id|ssize_t
id|atkbd_set_softraw
c_func
(paren
r_struct
id|atkbd
op_star
id|atkbd
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_char
op_star
id|rest
suffix:semicolon
id|value
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|rest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rest
op_logical_or
id|value
OG
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|atkbd-&gt;softraw
op_ne
id|value
)paren
(brace
multiline_comment|/* unregister device as it&squot;s properties will change */
id|input_unregister_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
id|atkbd-&gt;softraw
op_assign
id|value
suffix:semicolon
id|atkbd_set_device_attrs
c_func
(paren
id|atkbd
)paren
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|atkbd-&gt;dev
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|atkbd_init
r_int
id|__init
id|atkbd_init
c_func
(paren
r_void
)paren
(brace
id|serio_register_driver
c_func
(paren
op_amp
id|atkbd_drv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|atkbd_exit
r_void
id|__exit
id|atkbd_exit
c_func
(paren
r_void
)paren
(brace
id|serio_unregister_driver
c_func
(paren
op_amp
id|atkbd_drv
)paren
suffix:semicolon
)brace
DECL|variable|atkbd_init
id|module_init
c_func
(paren
id|atkbd_init
)paren
suffix:semicolon
DECL|variable|atkbd_exit
id|module_exit
c_func
(paren
id|atkbd_exit
)paren
suffix:semicolon
eof
