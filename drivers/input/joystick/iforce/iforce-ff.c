multiline_comment|/*&n; * $Id: iforce-ff.c,v 1.9 2002/02/02 19:28:35 jdeneux Exp $&n; *&n; *  Copyright (c) 2000-2002 Vojtech Pavlik &lt;vojtech@ucw.cz&gt;&n; *  Copyright (c) 2001-2002 Johann Deneux &lt;deneux@ifrance.com&gt;&n; *&n; *  USB/RS232 I-Force joysticks and wheels.&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * Should you need to contact me, the author, you can do so either by&n; * e-mail - mail your message to &lt;vojtech@ucw.cz&gt;, or by paper mail:&n; * Vojtech Pavlik, Simunkova 1594, Prague 8, 182 00 Czech Republic&n; */
macro_line|#include &quot;iforce.h&quot;
multiline_comment|/*&n; * Set the magnitude of a constant force effect&n; * Return error code&n; *&n; * Note: caller must ensure exclusive access to device&n; */
DECL|function|make_magnitude_modifier
r_static
r_int
id|make_magnitude_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|resource
op_star
id|mod_chunk
comma
r_int
id|no_alloc
comma
id|__s16
id|level
)paren
(brace
r_int
r_char
id|data
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|no_alloc
)paren
(brace
id|down
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;device_memory
)paren
comma
id|mod_chunk
comma
l_int|2
comma
id|iforce-&gt;device_memory.start
comma
id|iforce-&gt;device_memory.end
comma
l_int|2L
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|HI
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|HIFIX80
c_func
(paren
id|level
)paren
suffix:semicolon
id|iforce_send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_MAGNITUDE
comma
id|data
)paren
suffix:semicolon
id|iforce_dump_packet
c_func
(paren
l_string|&quot;magnitude: &quot;
comma
id|FF_CMD_MAGNITUDE
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload the component of an effect dealing with the period, phase and magnitude&n; */
DECL|function|make_period_modifier
r_static
r_int
id|make_period_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|resource
op_star
id|mod_chunk
comma
r_int
id|no_alloc
comma
id|__s16
id|magnitude
comma
id|__s16
id|offset
comma
id|u16
id|period
comma
id|u16
id|phase
)paren
(brace
r_int
r_char
id|data
(braket
l_int|7
)braket
suffix:semicolon
id|period
op_assign
id|TIME_SCALE
c_func
(paren
id|period
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|no_alloc
)paren
(brace
id|down
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;device_memory
)paren
comma
id|mod_chunk
comma
l_int|0x0c
comma
id|iforce-&gt;device_memory.start
comma
id|iforce-&gt;device_memory.end
comma
l_int|2L
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|HI
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|HIFIX80
c_func
(paren
id|magnitude
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|HIFIX80
c_func
(paren
id|offset
)paren
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|HI
c_func
(paren
id|phase
)paren
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|LO
c_func
(paren
id|period
)paren
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|HI
c_func
(paren
id|period
)paren
suffix:semicolon
id|iforce_send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_PERIOD
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Uploads the part of an effect setting the envelope of the force&n; */
DECL|function|make_envelope_modifier
r_static
r_int
id|make_envelope_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|resource
op_star
id|mod_chunk
comma
r_int
id|no_alloc
comma
id|u16
id|attack_duration
comma
id|__s16
id|initial_level
comma
id|u16
id|fade_duration
comma
id|__s16
id|final_level
)paren
(brace
r_int
r_char
id|data
(braket
l_int|8
)braket
suffix:semicolon
id|attack_duration
op_assign
id|TIME_SCALE
c_func
(paren
id|attack_duration
)paren
suffix:semicolon
id|fade_duration
op_assign
id|TIME_SCALE
c_func
(paren
id|fade_duration
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|no_alloc
)paren
(brace
id|down
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;device_memory
)paren
comma
id|mod_chunk
comma
l_int|0x0e
comma
id|iforce-&gt;device_memory.start
comma
id|iforce-&gt;device_memory.end
comma
l_int|2L
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|HI
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|LO
c_func
(paren
id|attack_duration
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|HI
c_func
(paren
id|attack_duration
)paren
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|HI
c_func
(paren
id|initial_level
)paren
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|LO
c_func
(paren
id|fade_duration
)paren
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|HI
c_func
(paren
id|fade_duration
)paren
suffix:semicolon
id|data
(braket
l_int|7
)braket
op_assign
id|HI
c_func
(paren
id|final_level
)paren
suffix:semicolon
id|iforce_send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_ENVELOPE
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Component of spring, friction, inertia... effects&n; */
DECL|function|make_condition_modifier
r_static
r_int
id|make_condition_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|resource
op_star
id|mod_chunk
comma
r_int
id|no_alloc
comma
id|__u16
id|rsat
comma
id|__u16
id|lsat
comma
id|__s16
id|rk
comma
id|__s16
id|lk
comma
id|u16
id|db
comma
id|__s16
id|center
)paren
(brace
r_int
r_char
id|data
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|no_alloc
)paren
(brace
id|down
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;device_memory
)paren
comma
id|mod_chunk
comma
l_int|8
comma
id|iforce-&gt;device_memory.start
comma
id|iforce-&gt;device_memory.end
comma
l_int|2L
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|iforce-&gt;mem_mutex
)paren
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|HI
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
(paren
l_int|100
op_star
id|rk
)paren
op_rshift
l_int|15
suffix:semicolon
multiline_comment|/* Dangerous: the sign is extended by gcc on plateforms providing an arith shift */
id|data
(braket
l_int|3
)braket
op_assign
(paren
l_int|100
op_star
id|lk
)paren
op_rshift
l_int|15
suffix:semicolon
multiline_comment|/* This code is incorrect on cpus lacking arith shift */
id|center
op_assign
(paren
l_int|500
op_star
id|center
)paren
op_rshift
l_int|15
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|LO
c_func
(paren
id|center
)paren
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|HI
c_func
(paren
id|center
)paren
suffix:semicolon
id|db
op_assign
(paren
l_int|1000
op_star
id|db
)paren
op_rshift
l_int|16
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|LO
c_func
(paren
id|db
)paren
suffix:semicolon
id|data
(braket
l_int|7
)braket
op_assign
id|HI
c_func
(paren
id|db
)paren
suffix:semicolon
id|data
(braket
l_int|8
)braket
op_assign
(paren
l_int|100
op_star
id|rsat
)paren
op_rshift
l_int|16
suffix:semicolon
id|data
(braket
l_int|9
)braket
op_assign
(paren
l_int|100
op_star
id|lsat
)paren
op_rshift
l_int|16
suffix:semicolon
id|iforce_send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_CONDITION
comma
id|data
)paren
suffix:semicolon
id|iforce_dump_packet
c_func
(paren
l_string|&quot;condition&quot;
comma
id|FF_CMD_CONDITION
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_button
r_static
r_int
r_char
id|find_button
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_int
r_int
id|button
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|iforce-&gt;type-&gt;btn
(braket
id|i
)braket
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|iforce-&gt;type-&gt;btn
(braket
id|i
)braket
op_eq
id|button
)paren
r_return
id|i
op_plus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Analyse the changes in an effect, and tell if we need to send an condition&n; * parameter packet&n; */
DECL|function|need_condition_modifier
r_static
r_int
id|need_condition_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
r_new
)paren
(brace
r_int
id|id
op_assign
r_new
op_member_access_from_pointer
id|id
suffix:semicolon
r_struct
id|ff_effect
op_star
id|old
op_assign
op_amp
id|iforce-&gt;core_effects
(braket
id|id
)braket
dot
id|effect
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
r_new
op_member_access_from_pointer
id|type
op_ne
id|FF_SPRING
op_logical_and
r_new
op_member_access_from_pointer
id|type
op_ne
id|FF_FRICTION
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;iforce.c: bad effect type in need_condition_modifier&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_or_assign
id|old-&gt;u.condition
(braket
id|i
)braket
dot
id|right_saturation
op_ne
r_new
op_member_access_from_pointer
id|u.condition
(braket
id|i
)braket
dot
id|right_saturation
op_logical_or
id|old-&gt;u.condition
(braket
id|i
)braket
dot
id|left_saturation
op_ne
r_new
op_member_access_from_pointer
id|u.condition
(braket
id|i
)braket
dot
id|left_saturation
op_logical_or
id|old-&gt;u.condition
(braket
id|i
)braket
dot
id|right_coeff
op_ne
r_new
op_member_access_from_pointer
id|u.condition
(braket
id|i
)braket
dot
id|right_coeff
op_logical_or
id|old-&gt;u.condition
(braket
id|i
)braket
dot
id|left_coeff
op_ne
r_new
op_member_access_from_pointer
id|u.condition
(braket
id|i
)braket
dot
id|left_coeff
op_logical_or
id|old-&gt;u.condition
(braket
id|i
)braket
dot
id|deadband
op_ne
r_new
op_member_access_from_pointer
id|u.condition
(braket
id|i
)braket
dot
id|deadband
op_logical_or
id|old-&gt;u.condition
(braket
id|i
)braket
dot
id|center
op_ne
r_new
op_member_access_from_pointer
id|u.condition
(braket
id|i
)braket
dot
id|center
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Analyse the changes in an effect, and tell if we need to send a magnitude&n; * parameter packet&n; */
DECL|function|need_magnitude_modifier
r_static
r_int
id|need_magnitude_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
(brace
r_int
id|id
op_assign
id|effect-&gt;id
suffix:semicolon
r_struct
id|ff_effect
op_star
id|old
op_assign
op_amp
id|iforce-&gt;core_effects
(braket
id|id
)braket
dot
id|effect
suffix:semicolon
r_if
c_cond
(paren
id|effect-&gt;type
op_ne
id|FF_CONSTANT
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;iforce.c: bad effect type in need_envelope_modifier&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_return
(paren
id|old-&gt;u.constant.level
op_ne
id|effect-&gt;u.constant.level
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Analyse the changes in an effect, and tell if we need to send an envelope&n; * parameter packet&n; */
DECL|function|need_envelope_modifier
r_static
r_int
id|need_envelope_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
(brace
r_int
id|id
op_assign
id|effect-&gt;id
suffix:semicolon
r_struct
id|ff_effect
op_star
id|old
op_assign
op_amp
id|iforce-&gt;core_effects
(braket
id|id
)braket
dot
id|effect
suffix:semicolon
r_switch
c_cond
(paren
id|effect-&gt;type
)paren
(brace
r_case
id|FF_CONSTANT
suffix:colon
r_if
c_cond
(paren
id|old-&gt;u.constant.envelope.attack_length
op_ne
id|effect-&gt;u.constant.envelope.attack_length
op_logical_or
id|old-&gt;u.constant.envelope.attack_level
op_ne
id|effect-&gt;u.constant.envelope.attack_level
op_logical_or
id|old-&gt;u.constant.envelope.fade_length
op_ne
id|effect-&gt;u.constant.envelope.fade_length
op_logical_or
id|old-&gt;u.constant.envelope.fade_level
op_ne
id|effect-&gt;u.constant.envelope.fade_level
)paren
r_return
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_PERIODIC
suffix:colon
r_if
c_cond
(paren
id|old-&gt;u.periodic.envelope.attack_length
op_ne
id|effect-&gt;u.periodic.envelope.attack_length
op_logical_or
id|old-&gt;u.periodic.envelope.attack_level
op_ne
id|effect-&gt;u.periodic.envelope.attack_level
op_logical_or
id|old-&gt;u.periodic.envelope.fade_length
op_ne
id|effect-&gt;u.periodic.envelope.fade_length
op_logical_or
id|old-&gt;u.periodic.envelope.fade_level
op_ne
id|effect-&gt;u.periodic.envelope.fade_level
)paren
r_return
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;iforce.c: bad effect type in need_envelope_modifier&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*&n; * Analyse the changes in an effect, and tell if we need to send a periodic&n; * parameter effect&n; */
DECL|function|need_period_modifier
r_static
r_int
id|need_period_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
r_new
)paren
(brace
r_int
id|id
op_assign
r_new
op_member_access_from_pointer
id|id
suffix:semicolon
r_struct
id|ff_effect
op_star
id|old
op_assign
op_amp
id|iforce-&gt;core_effects
(braket
id|id
)braket
dot
id|effect
suffix:semicolon
r_if
c_cond
(paren
r_new
op_member_access_from_pointer
id|type
op_ne
id|FF_PERIODIC
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;iforce.c: bad effect type in need_periodic_modifier&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
r_return
(paren
id|old-&gt;u.periodic.period
op_ne
r_new
op_member_access_from_pointer
id|u.periodic.period
op_logical_or
id|old-&gt;u.periodic.magnitude
op_ne
r_new
op_member_access_from_pointer
id|u.periodic.magnitude
op_logical_or
id|old-&gt;u.periodic.offset
op_ne
r_new
op_member_access_from_pointer
id|u.periodic.offset
op_logical_or
id|old-&gt;u.periodic.phase
op_ne
r_new
op_member_access_from_pointer
id|u.periodic.phase
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Analyse the changes in an effect, and tell if we need to send an effect&n; * packet&n; */
DECL|function|need_core
r_static
r_int
id|need_core
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
r_new
)paren
(brace
r_int
id|id
op_assign
r_new
op_member_access_from_pointer
id|id
suffix:semicolon
r_struct
id|ff_effect
op_star
id|old
op_assign
op_amp
id|iforce-&gt;core_effects
(braket
id|id
)braket
dot
id|effect
suffix:semicolon
r_if
c_cond
(paren
id|old-&gt;direction
op_ne
r_new
op_member_access_from_pointer
id|direction
op_logical_or
id|old-&gt;trigger.button
op_ne
r_new
op_member_access_from_pointer
id|trigger.button
op_logical_or
id|old-&gt;trigger.interval
op_ne
r_new
op_member_access_from_pointer
id|trigger.interval
op_logical_or
id|old-&gt;replay.length
op_ne
r_new
op_member_access_from_pointer
id|replay.length
op_logical_or
id|old-&gt;replay.delay
op_ne
r_new
op_member_access_from_pointer
id|replay.delay
)paren
r_return
id|TRUE
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/*&n; * Send the part common to all effects to the device&n; */
DECL|function|make_core
r_static
r_int
id|make_core
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
id|u16
id|id
comma
id|u16
id|mod_id1
comma
id|u16
id|mod_id2
comma
id|u8
id|effect_type
comma
id|u8
id|axes
comma
id|u16
id|duration
comma
id|u16
id|delay
comma
id|u16
id|button
comma
id|u16
id|interval
comma
id|u16
id|direction
)paren
(brace
r_int
r_char
id|data
(braket
l_int|14
)braket
suffix:semicolon
id|duration
op_assign
id|TIME_SCALE
c_func
(paren
id|duration
)paren
suffix:semicolon
id|delay
op_assign
id|TIME_SCALE
c_func
(paren
id|delay
)paren
suffix:semicolon
id|interval
op_assign
id|TIME_SCALE
c_func
(paren
id|interval
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|id
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|effect_type
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|LO
c_func
(paren
id|axes
)paren
op_or
id|find_button
c_func
(paren
id|iforce
comma
id|button
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|LO
c_func
(paren
id|duration
)paren
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|HI
c_func
(paren
id|duration
)paren
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|HI
c_func
(paren
id|direction
)paren
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|LO
c_func
(paren
id|interval
)paren
suffix:semicolon
id|data
(braket
l_int|7
)braket
op_assign
id|HI
c_func
(paren
id|interval
)paren
suffix:semicolon
id|data
(braket
l_int|8
)braket
op_assign
id|LO
c_func
(paren
id|mod_id1
)paren
suffix:semicolon
id|data
(braket
l_int|9
)braket
op_assign
id|HI
c_func
(paren
id|mod_id1
)paren
suffix:semicolon
id|data
(braket
l_int|10
)braket
op_assign
id|LO
c_func
(paren
id|mod_id2
)paren
suffix:semicolon
id|data
(braket
l_int|11
)braket
op_assign
id|HI
c_func
(paren
id|mod_id2
)paren
suffix:semicolon
id|data
(braket
l_int|12
)braket
op_assign
id|LO
c_func
(paren
id|delay
)paren
suffix:semicolon
id|data
(braket
l_int|13
)braket
op_assign
id|HI
c_func
(paren
id|delay
)paren
suffix:semicolon
multiline_comment|/* Stop effect */
multiline_comment|/*&t;iforce_control_playback(iforce, id, 0);*/
id|iforce_send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_EFFECT
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* If needed, restart effect */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|FF_CORE_SHOULD_PLAY
comma
id|iforce-&gt;core_effects
(braket
id|id
)braket
dot
id|flags
)paren
)paren
(brace
multiline_comment|/* BUG: perhaps we should replay n times, instead of 1. But we do not know n */
id|iforce_control_playback
c_func
(paren
id|iforce
comma
id|id
comma
l_int|1
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload a periodic effect to the device&n; * See also iforce_upload_constant.&n; */
DECL|function|iforce_upload_periodic
r_int
id|iforce_upload_periodic
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
id|effect
comma
r_int
id|is_update
)paren
(brace
id|u8
id|wave_code
suffix:semicolon
r_int
id|core_id
op_assign
id|effect-&gt;id
suffix:semicolon
r_struct
id|iforce_core_effect
op_star
id|core_effect
op_assign
id|iforce-&gt;core_effects
op_plus
id|core_id
suffix:semicolon
r_struct
id|resource
op_star
id|mod1_chunk
op_assign
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|core_id
)braket
dot
id|mod1_chunk
)paren
suffix:semicolon
r_struct
id|resource
op_star
id|mod2_chunk
op_assign
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|core_id
)braket
dot
id|mod2_chunk
)paren
suffix:semicolon
r_int
id|param1_err
op_assign
l_int|1
suffix:semicolon
r_int
id|param2_err
op_assign
l_int|1
suffix:semicolon
r_int
id|core_err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_update
op_logical_or
id|need_period_modifier
c_func
(paren
id|iforce
comma
id|effect
)paren
)paren
(brace
id|param1_err
op_assign
id|make_period_modifier
c_func
(paren
id|iforce
comma
id|mod1_chunk
comma
id|is_update
comma
id|effect-&gt;u.periodic.magnitude
comma
id|effect-&gt;u.periodic.offset
comma
id|effect-&gt;u.periodic.period
comma
id|effect-&gt;u.periodic.phase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param1_err
)paren
r_return
id|param1_err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD1_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_update
op_logical_or
id|need_envelope_modifier
c_func
(paren
id|iforce
comma
id|effect
)paren
)paren
(brace
id|param2_err
op_assign
id|make_envelope_modifier
c_func
(paren
id|iforce
comma
id|mod2_chunk
comma
id|is_update
comma
id|effect-&gt;u.periodic.envelope.attack_length
comma
id|effect-&gt;u.periodic.envelope.attack_level
comma
id|effect-&gt;u.periodic.envelope.fade_length
comma
id|effect-&gt;u.periodic.envelope.fade_level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param2_err
)paren
r_return
id|param2_err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD2_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|effect-&gt;u.periodic.waveform
)paren
(brace
r_case
id|FF_SQUARE
suffix:colon
id|wave_code
op_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_TRIANGLE
suffix:colon
id|wave_code
op_assign
l_int|0x21
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_SINE
suffix:colon
id|wave_code
op_assign
l_int|0x22
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_SAW_UP
suffix:colon
id|wave_code
op_assign
l_int|0x23
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_SAW_DOWN
suffix:colon
id|wave_code
op_assign
l_int|0x24
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|wave_code
op_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_update
op_logical_or
id|need_core
c_func
(paren
id|iforce
comma
id|effect
)paren
)paren
(brace
id|core_err
op_assign
id|make_core
c_func
(paren
id|iforce
comma
id|effect-&gt;id
comma
id|mod1_chunk-&gt;start
comma
id|mod2_chunk-&gt;start
comma
id|wave_code
comma
l_int|0x20
comma
id|effect-&gt;replay.length
comma
id|effect-&gt;replay.delay
comma
id|effect-&gt;trigger.button
comma
id|effect-&gt;trigger.interval
comma
id|effect-&gt;direction
)paren
suffix:semicolon
)brace
multiline_comment|/* If one of the parameter creation failed, we already returned an&n;&t; * error code.&n;&t; * If the core creation failed, we return its error code.&n;&t; * Else: if one parameter at least was created, we return 0&n;&t; *       else we return 1;&n;&t; */
r_return
id|core_err
OL
l_int|0
ques
c_cond
id|core_err
suffix:colon
(paren
id|param1_err
op_logical_and
id|param2_err
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload a constant force effect&n; * Return value:&n; *  &lt;0 Error code&n; *  0 Ok, effect created or updated&n; *  1 effect did not change since last upload, and no packet was therefore sent&n; */
DECL|function|iforce_upload_constant
r_int
id|iforce_upload_constant
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
id|effect
comma
r_int
id|is_update
)paren
(brace
r_int
id|core_id
op_assign
id|effect-&gt;id
suffix:semicolon
r_struct
id|iforce_core_effect
op_star
id|core_effect
op_assign
id|iforce-&gt;core_effects
op_plus
id|core_id
suffix:semicolon
r_struct
id|resource
op_star
id|mod1_chunk
op_assign
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|core_id
)braket
dot
id|mod1_chunk
)paren
suffix:semicolon
r_struct
id|resource
op_star
id|mod2_chunk
op_assign
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|core_id
)braket
dot
id|mod2_chunk
)paren
suffix:semicolon
r_int
id|param1_err
op_assign
l_int|1
suffix:semicolon
r_int
id|param2_err
op_assign
l_int|1
suffix:semicolon
r_int
id|core_err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_update
op_logical_or
id|need_magnitude_modifier
c_func
(paren
id|iforce
comma
id|effect
)paren
)paren
(brace
id|param1_err
op_assign
id|make_magnitude_modifier
c_func
(paren
id|iforce
comma
id|mod1_chunk
comma
id|is_update
comma
id|effect-&gt;u.constant.level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param1_err
)paren
r_return
id|param1_err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD1_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_update
op_logical_or
id|need_envelope_modifier
c_func
(paren
id|iforce
comma
id|effect
)paren
)paren
(brace
id|param2_err
op_assign
id|make_envelope_modifier
c_func
(paren
id|iforce
comma
id|mod2_chunk
comma
id|is_update
comma
id|effect-&gt;u.constant.envelope.attack_length
comma
id|effect-&gt;u.constant.envelope.attack_level
comma
id|effect-&gt;u.constant.envelope.fade_length
comma
id|effect-&gt;u.constant.envelope.fade_level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param2_err
)paren
r_return
id|param2_err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD2_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_update
op_logical_or
id|need_core
c_func
(paren
id|iforce
comma
id|effect
)paren
)paren
(brace
id|core_err
op_assign
id|make_core
c_func
(paren
id|iforce
comma
id|effect-&gt;id
comma
id|mod1_chunk-&gt;start
comma
id|mod2_chunk-&gt;start
comma
l_int|0x00
comma
l_int|0x20
comma
id|effect-&gt;replay.length
comma
id|effect-&gt;replay.delay
comma
id|effect-&gt;trigger.button
comma
id|effect-&gt;trigger.interval
comma
id|effect-&gt;direction
)paren
suffix:semicolon
)brace
multiline_comment|/* If one of the parameter creation failed, we already returned an&n;&t; * error code.&n;&t; * If the core creation failed, we return its error code.&n;&t; * Else: if one parameter at least was created, we return 0&n;&t; *       else we return 1;&n;&t; */
r_return
id|core_err
OL
l_int|0
ques
c_cond
id|core_err
suffix:colon
(paren
id|param1_err
op_logical_and
id|param2_err
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload an condition effect. Those are for example friction, inertia, springs...&n; */
DECL|function|iforce_upload_condition
r_int
id|iforce_upload_condition
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
id|effect
comma
r_int
id|is_update
)paren
(brace
r_int
id|core_id
op_assign
id|effect-&gt;id
suffix:semicolon
r_struct
id|iforce_core_effect
op_star
id|core_effect
op_assign
id|iforce-&gt;core_effects
op_plus
id|core_id
suffix:semicolon
r_struct
id|resource
op_star
id|mod1_chunk
op_assign
op_amp
(paren
id|core_effect-&gt;mod1_chunk
)paren
suffix:semicolon
r_struct
id|resource
op_star
id|mod2_chunk
op_assign
op_amp
(paren
id|core_effect-&gt;mod2_chunk
)paren
suffix:semicolon
id|u8
id|type
suffix:semicolon
r_int
id|param_err
op_assign
l_int|1
suffix:semicolon
r_int
id|core_err
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|effect-&gt;type
)paren
(brace
r_case
id|FF_SPRING
suffix:colon
id|type
op_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_DAMPER
suffix:colon
id|type
op_assign
l_int|0x41
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_update
op_logical_or
id|need_condition_modifier
c_func
(paren
id|iforce
comma
id|effect
)paren
)paren
(brace
id|param_err
op_assign
id|make_condition_modifier
c_func
(paren
id|iforce
comma
id|mod1_chunk
comma
id|is_update
comma
id|effect-&gt;u.condition
(braket
l_int|0
)braket
dot
id|right_saturation
comma
id|effect-&gt;u.condition
(braket
l_int|0
)braket
dot
id|left_saturation
comma
id|effect-&gt;u.condition
(braket
l_int|0
)braket
dot
id|right_coeff
comma
id|effect-&gt;u.condition
(braket
l_int|0
)braket
dot
id|left_coeff
comma
id|effect-&gt;u.condition
(braket
l_int|0
)braket
dot
id|deadband
comma
id|effect-&gt;u.condition
(braket
l_int|0
)braket
dot
id|center
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param_err
)paren
r_return
id|param_err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD1_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
id|param_err
op_assign
id|make_condition_modifier
c_func
(paren
id|iforce
comma
id|mod2_chunk
comma
id|is_update
comma
id|effect-&gt;u.condition
(braket
l_int|1
)braket
dot
id|right_saturation
comma
id|effect-&gt;u.condition
(braket
l_int|1
)braket
dot
id|left_saturation
comma
id|effect-&gt;u.condition
(braket
l_int|1
)braket
dot
id|right_coeff
comma
id|effect-&gt;u.condition
(braket
l_int|1
)braket
dot
id|left_coeff
comma
id|effect-&gt;u.condition
(braket
l_int|1
)braket
dot
id|deadband
comma
id|effect-&gt;u.condition
(braket
l_int|1
)braket
dot
id|center
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param_err
)paren
r_return
id|param_err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD2_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_update
op_logical_or
id|need_core
c_func
(paren
id|iforce
comma
id|effect
)paren
)paren
(brace
id|core_err
op_assign
id|make_core
c_func
(paren
id|iforce
comma
id|effect-&gt;id
comma
id|mod1_chunk-&gt;start
comma
id|mod2_chunk-&gt;start
comma
id|type
comma
l_int|0xc0
comma
id|effect-&gt;replay.length
comma
id|effect-&gt;replay.delay
comma
id|effect-&gt;trigger.button
comma
id|effect-&gt;trigger.interval
comma
id|effect-&gt;direction
)paren
suffix:semicolon
)brace
multiline_comment|/* If the parameter creation failed, we already returned an&n;&t; * error code.&n;&t; * If the core creation failed, we return its error code.&n;&t; * Else: if a parameter  was created, we return 0&n;&t; *       else we return 1;&n;&t; */
r_return
id|core_err
OL
l_int|0
ques
c_cond
id|core_err
suffix:colon
id|param_err
suffix:semicolon
)brace
eof
