multiline_comment|/*&n; * PS/2 driver library&n; *&n; * Copyright (c) 1999-2002 Vojtech Pavlik&n; * Copyright (c) 2004 Dmitry Torokhov&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License version 2 as published by&n; * the Free Software Foundation.&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/serio.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/libps2.h&gt;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;PS/2 driver library&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Dmitry Torokhov &lt;dtor@mail.ru&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PS/2 driver library&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|ps2_init
id|EXPORT_SYMBOL
c_func
(paren
id|ps2_init
)paren
suffix:semicolon
DECL|variable|ps2_sendbyte
id|EXPORT_SYMBOL
c_func
(paren
id|ps2_sendbyte
)paren
suffix:semicolon
DECL|variable|ps2_command
id|EXPORT_SYMBOL
c_func
(paren
id|ps2_command
)paren
suffix:semicolon
DECL|variable|ps2_schedule_command
id|EXPORT_SYMBOL
c_func
(paren
id|ps2_schedule_command
)paren
suffix:semicolon
DECL|variable|ps2_handle_ack
id|EXPORT_SYMBOL
c_func
(paren
id|ps2_handle_ack
)paren
suffix:semicolon
DECL|variable|ps2_handle_response
id|EXPORT_SYMBOL
c_func
(paren
id|ps2_handle_response
)paren
suffix:semicolon
DECL|variable|ps2_cmd_aborted
id|EXPORT_SYMBOL
c_func
(paren
id|ps2_cmd_aborted
)paren
suffix:semicolon
multiline_comment|/* Work structure to schedule execution of a command */
DECL|struct|ps2work
r_struct
id|ps2work
(brace
DECL|member|work
r_struct
id|work_struct
id|work
suffix:semicolon
DECL|member|ps2dev
r_struct
id|ps2dev
op_star
id|ps2dev
suffix:semicolon
DECL|member|command
r_int
id|command
suffix:semicolon
DECL|member|param
r_int
r_char
id|param
(braket
l_int|0
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * ps2_sendbyte() sends a byte to the mouse, and waits for acknowledge.&n; * It doesn&squot;t handle retransmission, though it could - because when there would&n; * be need for retransmissions, the mouse has to be replaced anyway.&n; *&n; * ps2_sendbyte() can only be called from a process context&n; */
DECL|function|ps2_sendbyte
r_int
id|ps2_sendbyte
c_func
(paren
r_struct
id|ps2dev
op_star
id|ps2dev
comma
r_int
r_char
id|byte
comma
r_int
id|timeout
)paren
(brace
id|serio_pause_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
id|ps2dev-&gt;nak
op_assign
l_int|1
suffix:semicolon
id|ps2dev-&gt;flags
op_or_assign
id|PS2_FLAG_ACK
suffix:semicolon
id|serio_continue_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serio_write
c_func
(paren
id|ps2dev-&gt;serio
comma
id|byte
)paren
op_eq
l_int|0
)paren
id|wait_event_interruptible_timeout
c_func
(paren
id|ps2dev-&gt;wait
comma
op_logical_neg
(paren
id|ps2dev-&gt;flags
op_amp
id|PS2_FLAG_ACK
)paren
comma
id|msecs_to_jiffies
c_func
(paren
id|timeout
)paren
)paren
suffix:semicolon
id|serio_pause_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
id|ps2dev-&gt;flags
op_and_assign
op_complement
id|PS2_FLAG_ACK
suffix:semicolon
id|serio_continue_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
r_return
op_minus
id|ps2dev-&gt;nak
suffix:semicolon
)brace
multiline_comment|/*&n; * ps2_command() sends a command and its parameters to the mouse,&n; * then waits for the response and puts it in the param array.&n; *&n; * ps2_command() can only be called from a process context&n; */
DECL|function|ps2_command
r_int
id|ps2_command
c_func
(paren
r_struct
id|ps2dev
op_star
id|ps2dev
comma
r_int
r_char
op_star
id|param
comma
r_int
id|command
)paren
(brace
r_int
id|timeout
suffix:semicolon
r_int
id|send
op_assign
(paren
id|command
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
suffix:semicolon
r_int
id|receive
op_assign
(paren
id|command
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
id|down
c_func
(paren
op_amp
id|ps2dev-&gt;cmd_sem
)paren
suffix:semicolon
id|serio_pause_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
id|ps2dev-&gt;flags
op_assign
id|command
op_eq
id|PS2_CMD_GETID
ques
c_cond
id|PS2_FLAG_WAITID
suffix:colon
l_int|0
suffix:semicolon
id|ps2dev-&gt;cmdcnt
op_assign
id|receive
suffix:semicolon
r_if
c_cond
(paren
id|receive
op_logical_and
id|param
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|receive
suffix:semicolon
id|i
op_increment
)paren
id|ps2dev-&gt;cmdbuf
(braket
(paren
id|receive
op_minus
l_int|1
)paren
op_minus
id|i
)braket
op_assign
id|param
(braket
id|i
)braket
suffix:semicolon
id|serio_continue_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Some devices (Synaptics) peform the reset before&n;&t; * ACKing the reset command, and so it can take a long&n;&t; * time before the ACK arrrives.&n;&t; */
r_if
c_cond
(paren
id|command
op_amp
l_int|0xff
)paren
r_if
c_cond
(paren
id|ps2_sendbyte
c_func
(paren
id|ps2dev
comma
id|command
op_amp
l_int|0xff
comma
id|command
op_eq
id|PS2_CMD_RESET_BAT
ques
c_cond
l_int|1000
suffix:colon
l_int|200
)paren
)paren
r_goto
id|out
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|send
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ps2_sendbyte
c_func
(paren
id|ps2dev
comma
id|param
(braket
id|i
)braket
comma
l_int|200
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * The reset command takes a long time to execute.&n;&t; */
id|timeout
op_assign
id|msecs_to_jiffies
c_func
(paren
id|command
op_eq
id|PS2_CMD_RESET_BAT
ques
c_cond
l_int|4000
suffix:colon
l_int|500
)paren
suffix:semicolon
id|wait_event_interruptible_timeout
c_func
(paren
id|ps2dev-&gt;wait
comma
op_logical_neg
(paren
id|ps2dev-&gt;flags
op_amp
id|PS2_FLAG_CMD1
)paren
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ps2dev-&gt;cmdcnt
op_logical_and
id|timeout
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|command
op_eq
id|PS2_CMD_RESET_BAT
op_logical_and
id|timeout
OG
id|msecs_to_jiffies
c_func
(paren
l_int|100
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Device has sent the first response byte&n;&t;&t;&t; * after a reset command, reset is thus done,&n;&t;&t;&t; * shorten the timeout. The next byte will come&n;&t;&t;&t; * soon (keyboard) or not at all (mouse).&n;&t;&t;&t; */
id|timeout
op_assign
id|msecs_to_jiffies
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command
op_eq
id|PS2_CMD_GETID
op_logical_and
id|ps2dev-&gt;cmdbuf
(braket
id|receive
op_minus
l_int|1
)braket
op_ne
l_int|0xab
op_logical_and
multiline_comment|/* Regular keyboards */
id|ps2dev-&gt;cmdbuf
(braket
id|receive
op_minus
l_int|1
)braket
op_ne
l_int|0xac
op_logical_and
multiline_comment|/* NCD Sun keyboard */
id|ps2dev-&gt;cmdbuf
(braket
id|receive
op_minus
l_int|1
)braket
op_ne
l_int|0x2b
op_logical_and
multiline_comment|/* Trust keyboard, translated */
id|ps2dev-&gt;cmdbuf
(braket
id|receive
op_minus
l_int|1
)braket
op_ne
l_int|0x5d
op_logical_and
multiline_comment|/* Trust keyboard */
id|ps2dev-&gt;cmdbuf
(braket
id|receive
op_minus
l_int|1
)braket
op_ne
l_int|0x60
op_logical_and
multiline_comment|/* NMB SGI keyboard, translated */
id|ps2dev-&gt;cmdbuf
(braket
id|receive
op_minus
l_int|1
)braket
op_ne
l_int|0x47
)paren
(brace
multiline_comment|/* NMB SGI keyboard */
multiline_comment|/*&n;&t;&t;&t; * Device behind the port is not a keyboard&n;&t;&t;&t; * so we don&squot;t need to wait for the 2nd byte&n;&t;&t;&t; * of ID response.&n;&t;&t;&t; */
id|serio_pause_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
id|ps2dev-&gt;flags
op_assign
id|ps2dev-&gt;cmdcnt
op_assign
l_int|0
suffix:semicolon
id|serio_continue_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
)brace
id|wait_event_interruptible_timeout
c_func
(paren
id|ps2dev-&gt;wait
comma
op_logical_neg
(paren
id|ps2dev-&gt;flags
op_amp
id|PS2_FLAG_CMD
)paren
comma
id|timeout
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|param
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|receive
suffix:semicolon
id|i
op_increment
)paren
id|param
(braket
id|i
)braket
op_assign
id|ps2dev-&gt;cmdbuf
(braket
(paren
id|receive
op_minus
l_int|1
)paren
op_minus
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ps2dev-&gt;cmdcnt
op_logical_and
(paren
id|command
op_ne
id|PS2_CMD_RESET_BAT
op_logical_or
id|ps2dev-&gt;cmdcnt
op_ne
l_int|1
)paren
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|serio_pause_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
id|ps2dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|serio_continue_rx
c_func
(paren
id|ps2dev-&gt;serio
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ps2dev-&gt;cmd_sem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * ps2_execute_scheduled_command() sends a command, previously scheduled by&n; * ps2_schedule_command(), to a PS/2 device (keyboard, mouse, etc.)&n; */
DECL|function|ps2_execute_scheduled_command
r_static
r_void
id|ps2_execute_scheduled_command
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|ps2work
op_star
id|ps2work
op_assign
id|data
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2work-&gt;ps2dev
comma
id|ps2work-&gt;param
comma
id|ps2work-&gt;command
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ps2work
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ps2_schedule_command() allows to schedule delayed execution of a PS/2&n; * command and can be used to issue a command from an interrupt or softirq&n; * context.&n; */
DECL|function|ps2_schedule_command
r_int
id|ps2_schedule_command
c_func
(paren
r_struct
id|ps2dev
op_star
id|ps2dev
comma
r_int
r_char
op_star
id|param
comma
r_int
id|command
)paren
(brace
r_struct
id|ps2work
op_star
id|ps2work
suffix:semicolon
r_int
id|send
op_assign
(paren
id|command
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
suffix:semicolon
r_int
id|receive
op_assign
(paren
id|command
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ps2work
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ps2work
)paren
op_plus
id|max
c_func
(paren
id|send
comma
id|receive
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|ps2work
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ps2work
)paren
)paren
suffix:semicolon
id|ps2work-&gt;ps2dev
op_assign
id|ps2dev
suffix:semicolon
id|ps2work-&gt;command
op_assign
id|command
suffix:semicolon
id|memcpy
c_func
(paren
id|ps2work-&gt;param
comma
id|param
comma
id|send
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|ps2work-&gt;work
comma
id|ps2_execute_scheduled_command
comma
id|ps2work
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|schedule_work
c_func
(paren
op_amp
id|ps2work-&gt;work
)paren
)paren
(brace
id|kfree
c_func
(paren
id|ps2work
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * ps2_init() initializes ps2dev structure&n; */
DECL|function|ps2_init
r_void
id|ps2_init
c_func
(paren
r_struct
id|ps2dev
op_star
id|ps2dev
comma
r_struct
id|serio
op_star
id|serio
)paren
(brace
id|init_MUTEX
c_func
(paren
op_amp
id|ps2dev-&gt;cmd_sem
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|ps2dev-&gt;wait
)paren
suffix:semicolon
id|ps2dev-&gt;serio
op_assign
id|serio
suffix:semicolon
)brace
multiline_comment|/*&n; * ps2_handle_ack() is supposed to be used in interrupt handler&n; * to properly process ACK/NAK of a command from a PS/2 device.&n; */
DECL|function|ps2_handle_ack
r_int
id|ps2_handle_ack
c_func
(paren
r_struct
id|ps2dev
op_star
id|ps2dev
comma
r_int
r_char
id|data
)paren
(brace
r_switch
c_cond
(paren
id|data
)paren
(brace
r_case
id|PS2_RET_ACK
suffix:colon
id|ps2dev-&gt;nak
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PS2_RET_NAK
suffix:colon
id|ps2dev-&gt;nak
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Workaround for mice which don&squot;t ACK the Get ID command.&n;&t;&t; * These are valid mouse IDs that we recognize.&n;&t;&t; */
r_case
l_int|0x00
suffix:colon
r_case
l_int|0x03
suffix:colon
r_case
l_int|0x04
suffix:colon
r_if
c_cond
(paren
id|ps2dev-&gt;flags
op_amp
id|PS2_FLAG_WAITID
)paren
(brace
id|ps2dev-&gt;nak
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Fall through */
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ps2dev-&gt;nak
op_logical_and
id|ps2dev-&gt;cmdcnt
)paren
id|ps2dev-&gt;flags
op_or_assign
id|PS2_FLAG_CMD
op_or
id|PS2_FLAG_CMD1
suffix:semicolon
id|ps2dev-&gt;flags
op_and_assign
op_complement
id|PS2_FLAG_ACK
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ps2dev-&gt;wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
op_ne
id|PS2_RET_ACK
)paren
id|ps2_handle_response
c_func
(paren
id|ps2dev
comma
id|data
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * ps2_handle_response() is supposed to be used in interrupt handler&n; * to properly store device&squot;s response to a command and notify process&n; * waiting for completion of the command.&n; */
DECL|function|ps2_handle_response
r_int
id|ps2_handle_response
c_func
(paren
r_struct
id|ps2dev
op_star
id|ps2dev
comma
r_int
r_char
id|data
)paren
(brace
r_if
c_cond
(paren
id|ps2dev-&gt;cmdcnt
)paren
id|ps2dev-&gt;cmdbuf
(braket
op_decrement
id|ps2dev-&gt;cmdcnt
)braket
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|ps2dev-&gt;flags
op_amp
id|PS2_FLAG_CMD1
)paren
(brace
id|ps2dev-&gt;flags
op_and_assign
op_complement
id|PS2_FLAG_CMD1
suffix:semicolon
r_if
c_cond
(paren
id|ps2dev-&gt;cmdcnt
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ps2dev-&gt;wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ps2dev-&gt;cmdcnt
)paren
(brace
id|ps2dev-&gt;flags
op_and_assign
op_complement
id|PS2_FLAG_CMD
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|ps2dev-&gt;wait
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ps2_cmd_aborted
r_void
id|ps2_cmd_aborted
c_func
(paren
r_struct
id|ps2dev
op_star
id|ps2dev
)paren
(brace
r_if
c_cond
(paren
id|ps2dev-&gt;flags
op_amp
id|PS2_FLAG_ACK
)paren
id|ps2dev-&gt;nak
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ps2dev-&gt;flags
op_amp
(paren
id|PS2_FLAG_ACK
op_or
id|PS2_FLAG_CMD
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|ps2dev-&gt;wait
)paren
suffix:semicolon
id|ps2dev-&gt;flags
op_assign
l_int|0
suffix:semicolon
)brace
eof
