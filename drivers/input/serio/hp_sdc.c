multiline_comment|/*&n; * HP i8042-based System Device Controller driver.&n; *&n; * Copyright (c) 2001 Brian S. Julin&n; * All rights reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification.&n; * 2. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * Alternatively, this software may be distributed under the terms of the&n; * GNU General Public License (&quot;GPL&quot;).&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; *&n; * References:&n; * System Device Controller Microprocessor Firmware Theory of Operation&n; *      for Part Number 1820-4784 Revision B.  Dwg No. A-1820-4784-2&n; * Helge Deller&squot;s original hilkbd.c port for PA-RISC.&n; *&n; *&n; * Driver theory of operation:&n; *&n; * hp_sdc_put does all writing to the SDC.  ISR can run on a different &n; * CPU than hp_sdc_put, but only one CPU runs hp_sdc_put at a time &n; * (it cannot really benefit from SMP anyway.)  A tasket fit this perfectly.&n; *&n; * All data coming back from the SDC is sent via interrupt and can be read &n; * fully in the ISR, so there are no latency/throughput problems there.  &n; * The problem is with output, due to the slow clock speed of the SDC &n; * compared to the CPU.  This should not be too horrible most of the time, &n; * but if used with HIL devices that support the multibyte transfer command, &n; * keeping outbound throughput flowing at the 6500KBps that the HIL is &n; * capable of is more than can be done at HZ=100.&n; *&n; * Busy polling for IBF clear wastes CPU cycles and bus cycles.  hp_sdc.ibf &n; * is set to 0 when the IBF flag in the status register has cleared.  ISR &n; * may do this, and may also access the parts of queued transactions related &n; * to reading data back from the SDC, but otherwise will not touch the &n; * hp_sdc state. Whenever a register is written hp_sdc.ibf is set to 1.&n; *&n; * The i8042 write index and the values in the 4-byte input buffer&n; * starting at 0x70 are kept track of in hp_sdc.wi, and .r7[], respectively,&n; * to minimize the amount of IO needed to the SDC.  However these values &n; * do not need to be locked since they are only ever accessed by hp_sdc_put.&n; *&n; * A timer task schedules the tasklet once per second just to make&n; * sure it doesn&squot;t freeze up and to allow for bad reads to time out.&n; */
macro_line|#include &lt;linux/hp_sdc.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/hil.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
multiline_comment|/* Machine-specific abstraction */
macro_line|#if defined(__hppa__)
macro_line|# include &lt;asm/parisc-device.h&gt;
DECL|macro|sdc_readb
macro_line|# define sdc_readb(p)&t;&t;gsc_readb(p)
DECL|macro|sdc_writeb
macro_line|# define sdc_writeb(v,p)&t;gsc_writeb((v),(p))
macro_line|#elif defined(__mc68000__)
macro_line|# include &lt;asm/uaccess.h&gt;
DECL|macro|sdc_readb
macro_line|# define sdc_readb(p)&t;&t;in_8(p)
DECL|macro|sdc_writeb
macro_line|# define sdc_writeb(v,p)&t;out_8((p),(v))
macro_line|#else
macro_line|# error &quot;HIL is not supported on this platform&quot;
macro_line|#endif
DECL|macro|PREFIX
mdefine_line|#define PREFIX &quot;HP SDC: &quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Brian S. Julin &lt;bri@calyx.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;HP i8042-based SDC Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
DECL|variable|hp_sdc_request_timer_irq
id|EXPORT_SYMBOL
c_func
(paren
id|hp_sdc_request_timer_irq
)paren
suffix:semicolon
DECL|variable|hp_sdc_request_hil_irq
id|EXPORT_SYMBOL
c_func
(paren
id|hp_sdc_request_hil_irq
)paren
suffix:semicolon
DECL|variable|hp_sdc_request_cooked_irq
id|EXPORT_SYMBOL
c_func
(paren
id|hp_sdc_request_cooked_irq
)paren
suffix:semicolon
DECL|variable|hp_sdc_release_timer_irq
id|EXPORT_SYMBOL
c_func
(paren
id|hp_sdc_release_timer_irq
)paren
suffix:semicolon
DECL|variable|hp_sdc_release_hil_irq
id|EXPORT_SYMBOL
c_func
(paren
id|hp_sdc_release_hil_irq
)paren
suffix:semicolon
DECL|variable|hp_sdc_release_cooked_irq
id|EXPORT_SYMBOL
c_func
(paren
id|hp_sdc_release_cooked_irq
)paren
suffix:semicolon
DECL|variable|hp_sdc_enqueue_transaction
id|EXPORT_SYMBOL
c_func
(paren
id|hp_sdc_enqueue_transaction
)paren
suffix:semicolon
DECL|variable|hp_sdc_dequeue_transaction
id|EXPORT_SYMBOL
c_func
(paren
id|hp_sdc_dequeue_transaction
)paren
suffix:semicolon
DECL|variable|hp_sdc
r_static
id|hp_i8042_sdc
id|hp_sdc
suffix:semicolon
multiline_comment|/* All driver state is kept in here. */
multiline_comment|/*************** primitives for use in any context *********************/
DECL|function|hp_sdc_status_in8
r_static
r_inline
r_uint8
id|hp_sdc_status_in8
(paren
r_void
)paren
(brace
r_uint8
id|status
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|hp_sdc.ibf_lock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|sdc_readb
c_func
(paren
id|hp_sdc.status_io
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|HP_SDC_STATUS_IBF
)paren
)paren
id|hp_sdc.ibf
op_assign
l_int|0
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|hp_sdc.ibf_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|hp_sdc_data_in8
r_static
r_inline
r_uint8
id|hp_sdc_data_in8
(paren
r_void
)paren
(brace
r_return
id|sdc_readb
c_func
(paren
id|hp_sdc.data_io
)paren
suffix:semicolon
)brace
DECL|function|hp_sdc_status_out8
r_static
r_inline
r_void
id|hp_sdc_status_out8
(paren
r_uint8
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|hp_sdc.ibf_lock
comma
id|flags
)paren
suffix:semicolon
id|hp_sdc.ibf
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|0xf0
)paren
op_eq
l_int|0xe0
)paren
id|hp_sdc.wi
op_assign
l_int|0xff
suffix:semicolon
id|sdc_writeb
c_func
(paren
id|val
comma
id|hp_sdc.status_io
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|hp_sdc.ibf_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|hp_sdc_data_out8
r_static
r_inline
r_void
id|hp_sdc_data_out8
(paren
r_uint8
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|hp_sdc.ibf_lock
comma
id|flags
)paren
suffix:semicolon
id|hp_sdc.ibf
op_assign
l_int|1
suffix:semicolon
id|sdc_writeb
c_func
(paren
id|val
comma
id|hp_sdc.data_io
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|hp_sdc.ibf_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&t;Care must be taken to only invoke hp_sdc_spin_ibf when &n; *&t;absolutely needed, or in rarely invoked subroutines.  &n; *&t;Not only does it waste CPU cycles, it also wastes bus cycles. &n; */
DECL|function|hp_sdc_spin_ibf
r_static
r_inline
r_void
id|hp_sdc_spin_ibf
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|rwlock_t
op_star
id|lock
suffix:semicolon
id|lock
op_assign
op_amp
id|hp_sdc.ibf_lock
suffix:semicolon
id|read_lock_irqsave
c_func
(paren
id|lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp_sdc.ibf
)paren
(brace
id|read_unlock_irqrestore
c_func
(paren
id|lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
id|lock
)paren
suffix:semicolon
id|write_lock
c_func
(paren
id|lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sdc_readb
c_func
(paren
id|hp_sdc.status_io
)paren
op_amp
id|HP_SDC_STATUS_IBF
)paren
(brace
)brace
suffix:semicolon
id|hp_sdc.ibf
op_assign
l_int|0
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
id|lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/************************ Interrupt context functions ************************/
DECL|function|hp_sdc_take
r_static
r_void
id|hp_sdc_take
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_uint8
id|status
comma
r_uint8
id|data
)paren
(brace
id|hp_sdc_transaction
op_star
id|curr
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.rcurr
OL
l_int|0
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|curr
op_assign
id|hp_sdc.tq
(braket
id|hp_sdc.rcurr
)braket
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
id|curr-&gt;seq
(braket
id|curr-&gt;idx
op_increment
)braket
op_assign
id|status
suffix:semicolon
id|curr-&gt;seq
(braket
id|curr-&gt;idx
op_increment
)braket
op_assign
id|data
suffix:semicolon
id|hp_sdc.rqty
op_sub_assign
l_int|2
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|hp_sdc.rtv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.rqty
op_le
l_int|0
)paren
(brace
multiline_comment|/* All data has been gathered. */
r_if
c_cond
(paren
id|curr-&gt;seq
(braket
id|curr-&gt;actidx
)braket
op_amp
id|HP_SDC_ACT_SEMAPHORE
)paren
(brace
r_if
c_cond
(paren
id|curr-&gt;act.semaphore
)paren
id|up
c_func
(paren
id|curr-&gt;act.semaphore
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curr-&gt;seq
(braket
id|curr-&gt;actidx
)braket
op_amp
id|HP_SDC_ACT_CALLBACK
)paren
(brace
r_if
c_cond
(paren
id|curr-&gt;act.irqhook
)paren
id|curr-&gt;act
dot
id|irqhook
c_func
(paren
id|irq
comma
id|dev_id
comma
id|status
comma
id|data
)paren
suffix:semicolon
)brace
id|curr-&gt;actidx
op_assign
id|curr-&gt;idx
suffix:semicolon
id|curr-&gt;idx
op_increment
suffix:semicolon
multiline_comment|/* Return control of this transaction */
id|write_lock
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
id|hp_sdc.rcurr
op_assign
op_minus
l_int|1
suffix:semicolon
id|hp_sdc.rqty
op_assign
l_int|0
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
)brace
)brace
DECL|function|hp_sdc_isr
r_static
id|irqreturn_t
id|hp_sdc_isr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_uint8
id|status
comma
id|data
suffix:semicolon
id|status
op_assign
id|hp_sdc_status_in8
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Read data unconditionally to advance i8042. */
id|data
op_assign
id|hp_sdc_data_in8
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* For now we are ignoring these until we get the SDC to behave. */
r_if
c_cond
(paren
(paren
(paren
id|status
op_amp
l_int|0xf1
)paren
op_eq
l_int|0x51
)paren
op_logical_and
id|data
op_eq
l_int|0x82
)paren
(brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
op_amp
id|HP_SDC_STATUS_IRQMASK
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* This case is not documented. */
r_break
suffix:semicolon
r_case
id|HP_SDC_STATUS_USERTIMER
suffix:colon
r_case
id|HP_SDC_STATUS_PERIODIC
suffix:colon
r_case
id|HP_SDC_STATUS_TIMER
suffix:colon
id|read_lock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.timer
op_ne
l_int|NULL
)paren
id|hp_sdc
dot
id|timer
c_func
(paren
id|irq
comma
id|dev_id
comma
id|status
comma
id|data
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HP_SDC_STATUS_REG
suffix:colon
id|hp_sdc_take
c_func
(paren
id|irq
comma
id|dev_id
comma
id|status
comma
id|data
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HP_SDC_STATUS_HILCMD
suffix:colon
r_case
id|HP_SDC_STATUS_HILDATA
suffix:colon
id|read_lock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.hil
op_ne
l_int|NULL
)paren
id|hp_sdc
dot
id|hil
c_func
(paren
id|irq
comma
id|dev_id
comma
id|status
comma
id|data
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HP_SDC_STATUS_PUP
suffix:colon
id|read_lock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.pup
op_ne
l_int|NULL
)paren
id|hp_sdc
dot
id|pup
c_func
(paren
id|irq
comma
id|dev_id
comma
id|status
comma
id|data
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;HP SDC reports successful PUP.&bslash;n&quot;
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|read_lock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.cooked
op_ne
l_int|NULL
)paren
id|hp_sdc
dot
id|cooked
c_func
(paren
id|irq
comma
id|dev_id
comma
id|status
comma
id|data
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|hp_sdc_nmisr
r_static
id|irqreturn_t
id|hp_sdc_nmisr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|hp_sdc_status_in8
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;NMI !&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0&t;
r_if
c_cond
(paren
id|status
op_amp
id|HP_SDC_NMISTATUS_FHS
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.timer
op_ne
l_int|NULL
)paren
id|hp_sdc
dot
id|timer
c_func
(paren
id|irq
comma
id|dev_id
comma
id|status
comma
l_int|0
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* TODO: pass this on to the HIL handler, or do SAK here? */
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;HIL NMI&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/***************** Kernel (tasklet) context functions ****************/
r_int
r_int
id|hp_sdc_put
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|hp_sdc_tasklet
r_static
r_void
id|hp_sdc_tasklet
c_func
(paren
r_int
r_int
id|foo
)paren
(brace
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.rcurr
op_ge
l_int|0
)paren
(brace
r_struct
id|timeval
id|tv
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tv.tv_sec
OG
id|hp_sdc.rtv.tv_sec
)paren
id|tv.tv_usec
op_add_assign
l_int|1000000
suffix:semicolon
r_if
c_cond
(paren
id|tv.tv_usec
op_minus
id|hp_sdc.rtv.tv_usec
OG
id|HP_SDC_MAX_REG_DELAY
)paren
(brace
id|hp_sdc_transaction
op_star
id|curr
suffix:semicolon
r_uint8
id|tmp
suffix:semicolon
id|curr
op_assign
id|hp_sdc.tq
(braket
id|hp_sdc.rcurr
)braket
suffix:semicolon
multiline_comment|/* If this turns out to be a normal failure mode&n;&t;&t;&t; * we&squot;ll need to figure out a way to communicate&n;&t;&t;&t; * it back to the application. and be less verbose.&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;read timeout (%ius)!&bslash;n&quot;
comma
id|tv.tv_usec
op_minus
id|hp_sdc.rtv.tv_usec
)paren
suffix:semicolon
id|curr-&gt;idx
op_add_assign
id|hp_sdc.rqty
suffix:semicolon
id|hp_sdc.rqty
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|curr-&gt;seq
(braket
id|curr-&gt;actidx
)braket
suffix:semicolon
id|curr-&gt;seq
(braket
id|curr-&gt;actidx
)braket
op_or_assign
id|HP_SDC_ACT_DEAD
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|HP_SDC_ACT_SEMAPHORE
)paren
(brace
r_if
c_cond
(paren
id|curr-&gt;act.semaphore
)paren
id|up
c_func
(paren
id|curr-&gt;act.semaphore
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp
op_amp
id|HP_SDC_ACT_CALLBACK
)paren
(brace
multiline_comment|/* Note this means that irqhooks may be called&n;&t;&t;&t;&t; * in tasklet/bh context.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|curr-&gt;act.irqhook
)paren
id|curr-&gt;act
dot
id|irqhook
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
id|curr-&gt;actidx
op_assign
id|curr-&gt;idx
suffix:semicolon
id|curr-&gt;idx
op_increment
suffix:semicolon
id|hp_sdc.rcurr
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
id|hp_sdc_put
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|hp_sdc_put
r_int
r_int
id|hp_sdc_put
c_func
(paren
r_void
)paren
(brace
id|hp_sdc_transaction
op_star
id|curr
suffix:semicolon
r_uint8
id|act
suffix:semicolon
r_int
id|idx
comma
id|curridx
suffix:semicolon
r_int
id|limit
op_assign
l_int|0
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|hp_sdc.lock
)paren
suffix:semicolon
multiline_comment|/* If i8042 buffers are full, we cannot do anything that&n;&t;   requires output, so we skip to the administrativa. */
r_if
c_cond
(paren
id|hp_sdc.ibf
)paren
(brace
id|hp_sdc_status_in8
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.ibf
)paren
r_goto
id|finish
suffix:semicolon
)brace
id|anew
suffix:colon
multiline_comment|/* See if we are in the middle of a sequence. */
r_if
c_cond
(paren
id|hp_sdc.wcurr
OL
l_int|0
)paren
id|hp_sdc.wcurr
op_assign
l_int|0
suffix:semicolon
id|read_lock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.rcurr
op_eq
id|hp_sdc.wcurr
)paren
id|hp_sdc.wcurr
op_increment
suffix:semicolon
id|read_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.wcurr
op_ge
id|HP_SDC_QUEUE_LEN
)paren
id|hp_sdc.wcurr
op_assign
l_int|0
suffix:semicolon
id|curridx
op_assign
id|hp_sdc.wcurr
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.tq
(braket
id|curridx
)braket
op_ne
l_int|NULL
)paren
r_goto
id|start
suffix:semicolon
r_while
c_loop
(paren
op_increment
id|curridx
op_ne
id|hp_sdc.wcurr
)paren
(brace
r_if
c_cond
(paren
id|curridx
op_ge
id|HP_SDC_QUEUE_LEN
)paren
(brace
id|curridx
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Wrap to top */
r_continue
suffix:semicolon
)brace
id|read_lock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.rcurr
op_eq
id|curridx
)paren
(brace
id|read_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|read_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.tq
(braket
id|curridx
)braket
op_ne
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* Found one. */
)brace
r_if
c_cond
(paren
id|curridx
op_eq
id|hp_sdc.wcurr
)paren
(brace
multiline_comment|/* There&squot;s nothing queued to do. */
id|curridx
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|hp_sdc.wcurr
op_assign
id|curridx
suffix:semicolon
id|start
suffix:colon
multiline_comment|/* Check to see if the interrupt mask needs to be set. */
r_if
c_cond
(paren
id|hp_sdc.set_im
)paren
(brace
id|hp_sdc_status_out8
c_func
(paren
id|hp_sdc.im
op_or
id|HP_SDC_CMD_SET_IM
)paren
suffix:semicolon
id|hp_sdc.set_im
op_assign
l_int|0
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp_sdc.wcurr
op_eq
op_minus
l_int|1
)paren
r_goto
id|done
suffix:semicolon
id|curr
op_assign
id|hp_sdc.tq
(braket
id|curridx
)braket
suffix:semicolon
id|idx
op_assign
id|curr-&gt;actidx
suffix:semicolon
r_if
c_cond
(paren
id|curr-&gt;actidx
op_ge
id|curr-&gt;endidx
)paren
(brace
id|hp_sdc.tq
(braket
id|curridx
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Interleave outbound data between the transactions. */
id|hp_sdc.wcurr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.wcurr
op_ge
id|HP_SDC_QUEUE_LEN
)paren
id|hp_sdc.wcurr
op_assign
l_int|0
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|act
op_assign
id|curr-&gt;seq
(braket
id|idx
)braket
suffix:semicolon
id|idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|curr-&gt;idx
op_ge
id|curr-&gt;endidx
)paren
(brace
r_if
c_cond
(paren
id|act
op_amp
id|HP_SDC_ACT_DEALLOC
)paren
id|kfree
c_func
(paren
id|curr
)paren
suffix:semicolon
id|hp_sdc.tq
(braket
id|curridx
)braket
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Interleave outbound data between the transactions. */
id|hp_sdc.wcurr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.wcurr
op_ge
id|HP_SDC_QUEUE_LEN
)paren
id|hp_sdc.wcurr
op_assign
l_int|0
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
r_while
c_loop
(paren
id|act
op_amp
id|HP_SDC_ACT_PRECMD
)paren
(brace
r_if
c_cond
(paren
id|curr-&gt;idx
op_ne
id|idx
)paren
(brace
id|idx
op_increment
suffix:semicolon
id|act
op_and_assign
op_complement
id|HP_SDC_ACT_PRECMD
suffix:semicolon
r_break
suffix:semicolon
)brace
id|hp_sdc_status_out8
c_func
(paren
id|curr-&gt;seq
(braket
id|idx
)braket
)paren
suffix:semicolon
id|curr-&gt;idx
op_increment
suffix:semicolon
multiline_comment|/* act finished? */
r_if
c_cond
(paren
(paren
id|act
op_amp
id|HP_SDC_ACT_DURING
)paren
op_eq
id|HP_SDC_ACT_PRECMD
)paren
r_goto
id|actdone
suffix:semicolon
multiline_comment|/* skip quantity field if data-out sequence follows. */
r_if
c_cond
(paren
id|act
op_amp
id|HP_SDC_ACT_DATAOUT
)paren
id|curr-&gt;idx
op_increment
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
r_if
c_cond
(paren
id|act
op_amp
id|HP_SDC_ACT_DATAOUT
)paren
(brace
r_int
id|qty
suffix:semicolon
id|qty
op_assign
id|curr-&gt;seq
(braket
id|idx
)braket
suffix:semicolon
id|idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|curr-&gt;idx
op_minus
id|idx
OL
id|qty
)paren
(brace
id|hp_sdc_data_out8
c_func
(paren
id|curr-&gt;seq
(braket
id|curr-&gt;idx
)braket
)paren
suffix:semicolon
id|curr-&gt;idx
op_increment
suffix:semicolon
multiline_comment|/* act finished? */
r_if
c_cond
(paren
(paren
id|curr-&gt;idx
op_minus
id|idx
op_ge
id|qty
)paren
op_logical_and
(paren
(paren
id|act
op_amp
id|HP_SDC_ACT_DURING
)paren
op_eq
id|HP_SDC_ACT_DATAOUT
)paren
)paren
r_goto
id|actdone
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|idx
op_add_assign
id|qty
suffix:semicolon
id|act
op_and_assign
op_complement
id|HP_SDC_ACT_DATAOUT
suffix:semicolon
)brace
r_else
r_while
c_loop
(paren
id|act
op_amp
id|HP_SDC_ACT_DATAREG
)paren
(brace
r_int
id|mask
suffix:semicolon
r_uint8
id|w7
(braket
l_int|4
)braket
suffix:semicolon
id|mask
op_assign
id|curr-&gt;seq
(braket
id|idx
)braket
suffix:semicolon
r_if
c_cond
(paren
id|idx
op_ne
id|curr-&gt;idx
)paren
(brace
id|idx
op_increment
suffix:semicolon
id|idx
op_add_assign
op_logical_neg
op_logical_neg
(paren
id|mask
op_amp
l_int|1
)paren
suffix:semicolon
id|idx
op_add_assign
op_logical_neg
op_logical_neg
(paren
id|mask
op_amp
l_int|2
)paren
suffix:semicolon
id|idx
op_add_assign
op_logical_neg
op_logical_neg
(paren
id|mask
op_amp
l_int|4
)paren
suffix:semicolon
id|idx
op_add_assign
op_logical_neg
op_logical_neg
(paren
id|mask
op_amp
l_int|8
)paren
suffix:semicolon
id|act
op_and_assign
op_complement
id|HP_SDC_ACT_DATAREG
suffix:semicolon
r_break
suffix:semicolon
)brace
id|w7
(braket
l_int|0
)braket
op_assign
(paren
id|mask
op_amp
l_int|1
)paren
ques
c_cond
id|curr-&gt;seq
(braket
op_increment
id|idx
)braket
suffix:colon
id|hp_sdc.r7
(braket
l_int|0
)braket
suffix:semicolon
id|w7
(braket
l_int|1
)braket
op_assign
(paren
id|mask
op_amp
l_int|2
)paren
ques
c_cond
id|curr-&gt;seq
(braket
op_increment
id|idx
)braket
suffix:colon
id|hp_sdc.r7
(braket
l_int|1
)braket
suffix:semicolon
id|w7
(braket
l_int|2
)braket
op_assign
(paren
id|mask
op_amp
l_int|4
)paren
ques
c_cond
id|curr-&gt;seq
(braket
op_increment
id|idx
)braket
suffix:colon
id|hp_sdc.r7
(braket
l_int|2
)braket
suffix:semicolon
id|w7
(braket
l_int|3
)braket
op_assign
(paren
id|mask
op_amp
l_int|8
)paren
ques
c_cond
id|curr-&gt;seq
(braket
op_increment
id|idx
)braket
suffix:colon
id|hp_sdc.r7
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.wi
OG
l_int|0x73
op_logical_or
id|hp_sdc.wi
OL
l_int|0x70
op_logical_or
id|w7
(braket
id|hp_sdc.wi
op_minus
l_int|0x70
)braket
op_eq
id|hp_sdc.r7
(braket
id|hp_sdc.wi
op_minus
l_int|0x70
)braket
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Need to point the write index register */
r_while
c_loop
(paren
(paren
id|i
OL
l_int|4
)paren
op_logical_and
id|w7
(braket
id|i
)braket
op_eq
id|hp_sdc.r7
(braket
id|i
)braket
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|4
)paren
(brace
id|hp_sdc_status_out8
c_func
(paren
id|HP_SDC_CMD_SET_D0
op_plus
id|i
)paren
suffix:semicolon
id|hp_sdc.wi
op_assign
l_int|0x70
op_plus
id|i
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|act
op_amp
id|HP_SDC_ACT_DURING
)paren
op_eq
id|HP_SDC_ACT_DATAREG
)paren
r_goto
id|actdone
suffix:semicolon
id|curr-&gt;idx
op_assign
id|idx
suffix:semicolon
id|act
op_and_assign
op_complement
id|HP_SDC_ACT_DATAREG
suffix:semicolon
r_break
suffix:semicolon
)brace
id|hp_sdc_data_out8
c_func
(paren
id|w7
(braket
id|hp_sdc.wi
op_minus
l_int|0x70
)braket
)paren
suffix:semicolon
id|hp_sdc.r7
(braket
id|hp_sdc.wi
op_minus
l_int|0x70
)braket
op_assign
id|w7
(braket
id|hp_sdc.wi
op_minus
l_int|0x70
)braket
suffix:semicolon
id|hp_sdc.wi
op_increment
suffix:semicolon
multiline_comment|/* write index register autoincrements */
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|i
OL
l_int|4
)paren
op_logical_and
id|w7
(braket
id|i
)braket
op_eq
id|hp_sdc.r7
(braket
id|i
)braket
)paren
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|4
)paren
(brace
id|curr-&gt;idx
op_assign
id|idx
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|act
op_amp
id|HP_SDC_ACT_DURING
)paren
op_eq
id|HP_SDC_ACT_DATAREG
)paren
r_goto
id|actdone
suffix:semicolon
)brace
)brace
r_goto
id|finish
suffix:semicolon
)brace
multiline_comment|/* We don&squot;t go any further in the command if there is a pending read,&n;&t;   because we don&squot;t want interleaved results. */
id|read_lock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.rcurr
op_ge
l_int|0
)paren
(brace
id|read_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|read_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|act
op_amp
id|HP_SDC_ACT_POSTCMD
)paren
(brace
r_uint8
id|postcmd
suffix:semicolon
multiline_comment|/* curr-&gt;idx should == idx at this point. */
id|postcmd
op_assign
id|curr-&gt;seq
(braket
id|idx
)braket
suffix:semicolon
id|curr-&gt;idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|act
op_amp
id|HP_SDC_ACT_DATAIN
)paren
(brace
multiline_comment|/* Start a new read */
id|hp_sdc.rqty
op_assign
id|curr-&gt;seq
(braket
id|curr-&gt;idx
)braket
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|hp_sdc.rtv
)paren
suffix:semicolon
id|curr-&gt;idx
op_increment
suffix:semicolon
multiline_comment|/* Still need to lock here in case of spurious irq. */
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
id|hp_sdc.rcurr
op_assign
id|curridx
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
id|hp_sdc_status_out8
c_func
(paren
id|postcmd
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|hp_sdc_status_out8
c_func
(paren
id|postcmd
)paren
suffix:semicolon
r_goto
id|actdone
suffix:semicolon
)brace
id|actdone
suffix:colon
r_if
c_cond
(paren
id|act
op_amp
id|HP_SDC_ACT_SEMAPHORE
)paren
(brace
id|up
c_func
(paren
id|curr-&gt;act.semaphore
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|act
op_amp
id|HP_SDC_ACT_CALLBACK
)paren
(brace
id|curr-&gt;act
dot
id|irqhook
c_func
(paren
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|curr-&gt;idx
op_ge
id|curr-&gt;endidx
)paren
(brace
multiline_comment|/* This transaction is over. */
r_if
c_cond
(paren
id|act
op_amp
id|HP_SDC_ACT_DEALLOC
)paren
id|kfree
c_func
(paren
id|curr
)paren
suffix:semicolon
id|hp_sdc.tq
(braket
id|curridx
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|curr-&gt;actidx
op_assign
id|idx
op_plus
l_int|1
suffix:semicolon
id|curr-&gt;idx
op_assign
id|idx
op_plus
l_int|2
suffix:semicolon
)brace
multiline_comment|/* Interleave outbound data between the transactions. */
id|hp_sdc.wcurr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.wcurr
op_ge
id|HP_SDC_QUEUE_LEN
)paren
id|hp_sdc.wcurr
op_assign
l_int|0
suffix:semicolon
id|finish
suffix:colon
multiline_comment|/* If by some quirk IBF has cleared and our ISR has run to &n;&t;   see that that has happened, do it all again. */
r_if
c_cond
(paren
op_logical_neg
id|hp_sdc.ibf
op_logical_and
id|limit
op_increment
OL
l_int|20
)paren
r_goto
id|anew
suffix:semicolon
id|done
suffix:colon
r_if
c_cond
(paren
id|hp_sdc.wcurr
op_ge
l_int|0
)paren
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|hp_sdc.lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/******* Functions called in either user or kernel context ****/
DECL|function|hp_sdc_enqueue_transaction
r_int
id|hp_sdc_enqueue_transaction
c_func
(paren
id|hp_sdc_transaction
op_star
id|this
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|this
op_eq
l_int|NULL
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|hp_sdc.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Can&squot;t have same transaction on queue twice */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HP_SDC_QUEUE_LEN
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hp_sdc.tq
(braket
id|i
)braket
op_eq
id|this
)paren
r_goto
id|fail
suffix:semicolon
id|this-&gt;actidx
op_assign
l_int|0
suffix:semicolon
id|this-&gt;idx
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Search for empty slot */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HP_SDC_QUEUE_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hp_sdc.tq
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|hp_sdc.tq
(braket
id|i
)braket
op_assign
id|this
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|hp_sdc.lock
comma
id|flags
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|hp_sdc.lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;No free slot to add transaction.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
id|fail
suffix:colon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|hp_sdc.lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Transaction add failed: transaction already queued?&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|hp_sdc_dequeue_transaction
r_int
id|hp_sdc_dequeue_transaction
c_func
(paren
id|hp_sdc_transaction
op_star
id|this
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|write_lock_irqsave
c_func
(paren
op_amp
id|hp_sdc.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* TODO: don&squot;t remove it if it&squot;s not done. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HP_SDC_QUEUE_LEN
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hp_sdc.tq
(braket
id|i
)braket
op_eq
id|this
)paren
id|hp_sdc.tq
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|hp_sdc.lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/********************** User context functions **************************/
DECL|function|hp_sdc_request_timer_irq
r_int
id|hp_sdc_request_timer_irq
c_func
(paren
id|hp_sdc_irqhook
op_star
id|callback
)paren
(brace
r_if
c_cond
(paren
id|callback
op_eq
l_int|NULL
op_logical_or
id|hp_sdc.dev
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.timer
op_ne
l_int|NULL
)paren
(brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|hp_sdc.timer
op_assign
id|callback
suffix:semicolon
multiline_comment|/* Enable interrupts from the timers */
id|hp_sdc.im
op_and_assign
op_complement
id|HP_SDC_IM_FH
suffix:semicolon
id|hp_sdc.im
op_and_assign
op_complement
id|HP_SDC_IM_PT
suffix:semicolon
id|hp_sdc.im
op_and_assign
op_complement
id|HP_SDC_IM_TIMERS
suffix:semicolon
id|hp_sdc.set_im
op_assign
l_int|1
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_request_hil_irq
r_int
id|hp_sdc_request_hil_irq
c_func
(paren
id|hp_sdc_irqhook
op_star
id|callback
)paren
(brace
r_if
c_cond
(paren
id|callback
op_eq
l_int|NULL
op_logical_or
id|hp_sdc.dev
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.hil
op_ne
l_int|NULL
)paren
(brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|hp_sdc.hil
op_assign
id|callback
suffix:semicolon
id|hp_sdc.im
op_and_assign
op_complement
(paren
id|HP_SDC_IM_HIL
op_or
id|HP_SDC_IM_RESET
)paren
suffix:semicolon
id|hp_sdc.set_im
op_assign
l_int|1
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_request_cooked_irq
r_int
id|hp_sdc_request_cooked_irq
c_func
(paren
id|hp_sdc_irqhook
op_star
id|callback
)paren
(brace
r_if
c_cond
(paren
id|callback
op_eq
l_int|NULL
op_logical_or
id|hp_sdc.dev
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.cooked
op_ne
l_int|NULL
)paren
(brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Enable interrupts from the HIL MLC */
id|hp_sdc.cooked
op_assign
id|callback
suffix:semicolon
id|hp_sdc.im
op_and_assign
op_complement
(paren
id|HP_SDC_IM_HIL
op_or
id|HP_SDC_IM_RESET
)paren
suffix:semicolon
id|hp_sdc.set_im
op_assign
l_int|1
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_release_timer_irq
r_int
id|hp_sdc_release_timer_irq
c_func
(paren
id|hp_sdc_irqhook
op_star
id|callback
)paren
(brace
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|callback
op_ne
id|hp_sdc.timer
)paren
op_logical_or
(paren
id|hp_sdc.timer
op_eq
l_int|NULL
)paren
)paren
(brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Disable interrupts from the timers */
id|hp_sdc.timer
op_assign
l_int|NULL
suffix:semicolon
id|hp_sdc.im
op_or_assign
id|HP_SDC_IM_TIMERS
suffix:semicolon
id|hp_sdc.im
op_or_assign
id|HP_SDC_IM_FH
suffix:semicolon
id|hp_sdc.im
op_or_assign
id|HP_SDC_IM_PT
suffix:semicolon
id|hp_sdc.set_im
op_assign
l_int|1
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_release_hil_irq
r_int
id|hp_sdc_release_hil_irq
c_func
(paren
id|hp_sdc_irqhook
op_star
id|callback
)paren
(brace
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|callback
op_ne
id|hp_sdc.hil
)paren
op_logical_or
(paren
id|hp_sdc.hil
op_eq
l_int|NULL
)paren
)paren
(brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|hp_sdc.hil
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Disable interrupts from HIL only if there is no cooked driver. */
r_if
c_cond
(paren
id|hp_sdc.cooked
op_eq
l_int|NULL
)paren
(brace
id|hp_sdc.im
op_or_assign
(paren
id|HP_SDC_IM_HIL
op_or
id|HP_SDC_IM_RESET
)paren
suffix:semicolon
id|hp_sdc.set_im
op_assign
l_int|1
suffix:semicolon
)brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_release_cooked_irq
r_int
id|hp_sdc_release_cooked_irq
c_func
(paren
id|hp_sdc_irqhook
op_star
id|callback
)paren
(brace
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|callback
op_ne
id|hp_sdc.cooked
)paren
op_logical_or
(paren
id|hp_sdc.cooked
op_eq
l_int|NULL
)paren
)paren
(brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|hp_sdc.cooked
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Disable interrupts from HIL only if there is no raw HIL driver. */
r_if
c_cond
(paren
id|hp_sdc.hil
op_eq
l_int|NULL
)paren
(brace
id|hp_sdc.im
op_or_assign
(paren
id|HP_SDC_IM_HIL
op_or
id|HP_SDC_IM_RESET
)paren
suffix:semicolon
id|hp_sdc.set_im
op_assign
l_int|1
suffix:semicolon
)brace
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/************************* Keepalive timer task *********************/
DECL|function|hp_sdc_kicker
r_void
id|hp_sdc_kicker
(paren
r_int
r_int
id|data
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
multiline_comment|/* Re-insert the periodic task. */
id|mod_timer
c_func
(paren
op_amp
id|hp_sdc.kicker
comma
id|jiffies
op_plus
id|HZ
)paren
suffix:semicolon
)brace
multiline_comment|/************************** Module Initialization ***************************/
macro_line|#if defined(__hppa__)
DECL|variable|hp_sdc_tbl
r_static
r_struct
id|parisc_device_id
id|hp_sdc_tbl
(braket
)braket
op_assign
(brace
(brace
dot
id|hw_type
op_assign
id|HPHW_FIO
comma
dot
id|hversion_rev
op_assign
id|HVERSION_REV_ANY_ID
comma
dot
id|hversion
op_assign
id|HVERSION_ANY_ID
comma
dot
id|sversion
op_assign
l_int|0x73
comma
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|parisc
comma
id|hp_sdc_tbl
)paren
suffix:semicolon
r_static
r_int
id|__init
id|hp_sdc_init_hppa
c_func
(paren
r_struct
id|parisc_device
op_star
id|d
)paren
suffix:semicolon
DECL|variable|hp_sdc_driver
r_static
r_struct
id|parisc_driver
id|hp_sdc_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;HP SDC&quot;
comma
dot
id|id_table
op_assign
id|hp_sdc_tbl
comma
dot
id|probe
op_assign
id|hp_sdc_init_hppa
comma
)brace
suffix:semicolon
macro_line|#endif /* __hppa__ */
DECL|function|hp_sdc_init
r_static
r_int
id|__init
id|hp_sdc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|errstr
suffix:semicolon
id|hp_sdc_transaction
id|t_sync
suffix:semicolon
r_uint8
id|ts_sync
(braket
l_int|6
)braket
suffix:semicolon
r_struct
id|semaphore
id|s_sync
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|hp_sdc.lock
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|hp_sdc.ibf_lock
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|hp_sdc.rtq_lock
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|hp_sdc.hook_lock
)paren
suffix:semicolon
id|hp_sdc.timer
op_assign
l_int|NULL
suffix:semicolon
id|hp_sdc.hil
op_assign
l_int|NULL
suffix:semicolon
id|hp_sdc.pup
op_assign
l_int|NULL
suffix:semicolon
id|hp_sdc.cooked
op_assign
l_int|NULL
suffix:semicolon
id|hp_sdc.im
op_assign
id|HP_SDC_IM_MASK
suffix:semicolon
multiline_comment|/* Mask maskable irqs */
id|hp_sdc.set_im
op_assign
l_int|1
suffix:semicolon
id|hp_sdc.wi
op_assign
l_int|0xff
suffix:semicolon
id|hp_sdc.r7
(braket
l_int|0
)braket
op_assign
l_int|0xff
suffix:semicolon
id|hp_sdc.r7
(braket
l_int|1
)braket
op_assign
l_int|0xff
suffix:semicolon
id|hp_sdc.r7
(braket
l_int|2
)braket
op_assign
l_int|0xff
suffix:semicolon
id|hp_sdc.r7
(braket
l_int|3
)braket
op_assign
l_int|0xff
suffix:semicolon
id|hp_sdc.ibf
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HP_SDC_QUEUE_LEN
suffix:semicolon
id|i
op_increment
)paren
id|hp_sdc.tq
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|hp_sdc.wcurr
op_assign
op_minus
l_int|1
suffix:semicolon
id|hp_sdc.rcurr
op_assign
op_minus
l_int|1
suffix:semicolon
id|hp_sdc.rqty
op_assign
l_int|0
suffix:semicolon
id|hp_sdc.dev_err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|errstr
op_assign
l_string|&quot;IO not found for&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp_sdc.base_io
)paren
r_goto
id|err0
suffix:semicolon
id|errstr
op_assign
l_string|&quot;IRQ not found for&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp_sdc.irq
)paren
r_goto
id|err0
suffix:semicolon
id|hp_sdc.dev_err
op_assign
op_minus
id|EBUSY
suffix:semicolon
macro_line|#if defined(__hppa__)
id|errstr
op_assign
l_string|&quot;IO not available for&quot;
suffix:semicolon
r_if
c_cond
(paren
id|request_region
c_func
(paren
id|hp_sdc.data_io
comma
l_int|2
comma
id|hp_sdc_driver.name
)paren
)paren
r_goto
id|err0
suffix:semicolon
macro_line|#endif&t;
id|errstr
op_assign
l_string|&quot;IRQ not available for&quot;
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hp_sdc.irq
comma
op_amp
id|hp_sdc_isr
comma
l_int|0
comma
l_string|&quot;HP SDC&quot;
comma
(paren
r_void
op_star
)paren
id|hp_sdc.base_io
)paren
)paren
(brace
r_goto
id|err1
suffix:semicolon
)brace
id|errstr
op_assign
l_string|&quot;NMI not available for&quot;
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hp_sdc.nmi
comma
op_amp
id|hp_sdc_nmisr
comma
l_int|0
comma
l_string|&quot;HP SDC NMI&quot;
comma
(paren
r_void
op_star
)paren
id|hp_sdc.base_io
)paren
)paren
r_goto
id|err2
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;HP SDC at 0x%p, IRQ %d (NMI IRQ %d)&bslash;n&quot;
comma
(paren
r_void
op_star
)paren
id|hp_sdc.base_io
comma
id|hp_sdc.irq
comma
id|hp_sdc.nmi
)paren
suffix:semicolon
id|hp_sdc_status_in8
c_func
(paren
)paren
suffix:semicolon
id|hp_sdc_data_in8
c_func
(paren
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|hp_sdc.task
comma
id|hp_sdc_tasklet
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Sync the output buffer registers, thus scheduling hp_sdc_tasklet. */
id|t_sync.actidx
op_assign
l_int|0
suffix:semicolon
id|t_sync.idx
op_assign
l_int|1
suffix:semicolon
id|t_sync.endidx
op_assign
l_int|6
suffix:semicolon
id|t_sync.seq
op_assign
id|ts_sync
suffix:semicolon
id|ts_sync
(braket
l_int|0
)braket
op_assign
id|HP_SDC_ACT_DATAREG
op_or
id|HP_SDC_ACT_SEMAPHORE
suffix:semicolon
id|ts_sync
(braket
l_int|1
)braket
op_assign
l_int|0x0f
suffix:semicolon
id|ts_sync
(braket
l_int|2
)braket
op_assign
id|ts_sync
(braket
l_int|3
)braket
op_assign
id|ts_sync
(braket
l_int|4
)braket
op_assign
id|ts_sync
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|t_sync.act.semaphore
op_assign
op_amp
id|s_sync
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|s_sync
)paren
suffix:semicolon
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|t_sync
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|s_sync
)paren
suffix:semicolon
multiline_comment|/* Wait for t_sync to complete */
multiline_comment|/* Create the keepalive task */
id|init_timer
c_func
(paren
op_amp
id|hp_sdc.kicker
)paren
suffix:semicolon
id|hp_sdc.kicker.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|hp_sdc.kicker.function
op_assign
op_amp
id|hp_sdc_kicker
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|hp_sdc.kicker
)paren
suffix:semicolon
id|hp_sdc.dev_err
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err2
suffix:colon
id|free_irq
c_func
(paren
id|hp_sdc.irq
comma
l_int|NULL
)paren
suffix:semicolon
id|err1
suffix:colon
id|release_region
c_func
(paren
id|hp_sdc.data_io
comma
l_int|2
)paren
suffix:semicolon
id|err0
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;: %s SDC IO=0x%p IRQ=0x%x NMI=0x%x&bslash;n&quot;
comma
id|errstr
comma
(paren
r_void
op_star
)paren
id|hp_sdc.base_io
comma
id|hp_sdc.irq
comma
id|hp_sdc.nmi
)paren
suffix:semicolon
id|hp_sdc.dev
op_assign
l_int|NULL
suffix:semicolon
r_return
id|hp_sdc.dev_err
suffix:semicolon
)brace
macro_line|#if defined(__hppa__)
DECL|function|hp_sdc_init_hppa
r_static
r_int
id|__init
id|hp_sdc_init_hppa
c_func
(paren
r_struct
id|parisc_device
op_star
id|d
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|d
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.dev
op_ne
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* We only expect one SDC */
id|hp_sdc.dev
op_assign
id|d
suffix:semicolon
id|hp_sdc.irq
op_assign
id|d-&gt;irq
suffix:semicolon
id|hp_sdc.nmi
op_assign
id|d-&gt;aux_irq
suffix:semicolon
id|hp_sdc.base_io
op_assign
id|d-&gt;hpa
suffix:semicolon
id|hp_sdc.data_io
op_assign
id|d-&gt;hpa
op_plus
l_int|0x800
suffix:semicolon
id|hp_sdc.status_io
op_assign
id|d-&gt;hpa
op_plus
l_int|0x801
suffix:semicolon
r_return
id|hp_sdc_init
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* __hppa__ */
macro_line|#if !defined(__mc68000__) /* Link error on m68k! */
DECL|function|hp_sdc_exit
r_static
r_void
id|__exit
id|hp_sdc_exit
c_func
(paren
r_void
)paren
macro_line|#else
r_static
r_void
id|hp_sdc_exit
c_func
(paren
r_void
)paren
macro_line|#endif
(brace
id|write_lock_irq
c_func
(paren
op_amp
id|hp_sdc.lock
)paren
suffix:semicolon
multiline_comment|/* Turn off all maskable &quot;sub-function&quot; irq&squot;s. */
id|hp_sdc_spin_ibf
c_func
(paren
)paren
suffix:semicolon
id|sdc_writeb
c_func
(paren
id|HP_SDC_CMD_SET_IM
op_or
id|HP_SDC_IM_MASK
comma
id|hp_sdc.status_io
)paren
suffix:semicolon
multiline_comment|/* Wait until we know this has been processed by the i8042 */
id|hp_sdc_spin_ibf
c_func
(paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hp_sdc.nmi
comma
l_int|NULL
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|hp_sdc.irq
comma
l_int|NULL
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|hp_sdc.lock
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|hp_sdc.kicker
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|hp_sdc.task
)paren
suffix:semicolon
multiline_comment|/*        release_region(hp_sdc.data_io, 2); */
macro_line|#if defined(__hppa__)
r_if
c_cond
(paren
id|unregister_parisc_driver
c_func
(paren
op_amp
id|hp_sdc_driver
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Error unregistering HP SDC&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|hp_sdc_register
r_static
r_int
id|__init
id|hp_sdc_register
c_func
(paren
r_void
)paren
(brace
id|hp_sdc_transaction
id|tq_init
suffix:semicolon
r_uint8
id|tq_init_seq
(braket
l_int|5
)braket
suffix:semicolon
r_struct
id|semaphore
id|tq_init_sem
suffix:semicolon
macro_line|#if defined(__mc68000__)
id|mm_segment_t
id|fs
suffix:semicolon
r_int
r_char
id|i
suffix:semicolon
macro_line|#endif
id|hp_sdc.dev
op_assign
l_int|NULL
suffix:semicolon
id|hp_sdc.dev_err
op_assign
l_int|0
suffix:semicolon
macro_line|#if defined(__hppa__)
r_if
c_cond
(paren
id|register_parisc_driver
c_func
(paren
op_amp
id|hp_sdc_driver
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Error registering SDC with system bus tree.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#elif defined(__mc68000__)
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_HP300
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|hp_sdc.irq
op_assign
l_int|1
suffix:semicolon
id|hp_sdc.nmi
op_assign
l_int|7
suffix:semicolon
id|hp_sdc.base_io
op_assign
(paren
r_int
r_int
)paren
l_int|0xf0428000
suffix:semicolon
id|hp_sdc.data_io
op_assign
(paren
r_int
r_int
)paren
id|hp_sdc.base_io
op_plus
l_int|1
suffix:semicolon
id|hp_sdc.status_io
op_assign
(paren
r_int
r_int
)paren
id|hp_sdc.base_io
op_plus
l_int|3
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_user
c_func
(paren
id|i
comma
(paren
r_int
r_char
op_star
)paren
id|hp_sdc.data_io
)paren
)paren
id|hp_sdc.dev
op_assign
(paren
r_void
op_star
)paren
l_int|1
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
id|hp_sdc.dev_err
op_assign
id|hp_sdc_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|hp_sdc.dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;No SDC found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|hp_sdc.dev_err
suffix:semicolon
)brace
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
id|tq_init.actidx
op_assign
l_int|0
suffix:semicolon
id|tq_init.idx
op_assign
l_int|1
suffix:semicolon
id|tq_init.endidx
op_assign
l_int|5
suffix:semicolon
id|tq_init.seq
op_assign
id|tq_init_seq
suffix:semicolon
id|tq_init.act.semaphore
op_assign
op_amp
id|tq_init_sem
suffix:semicolon
id|tq_init_seq
(braket
l_int|0
)braket
op_assign
id|HP_SDC_ACT_POSTCMD
op_or
id|HP_SDC_ACT_DATAIN
op_or
id|HP_SDC_ACT_SEMAPHORE
suffix:semicolon
id|tq_init_seq
(braket
l_int|1
)braket
op_assign
id|HP_SDC_CMD_READ_KCC
suffix:semicolon
id|tq_init_seq
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|tq_init_seq
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|tq_init_seq
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|tq_init
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tq_init_seq
(braket
l_int|0
)braket
op_amp
id|HP_SDC_ACT_DEAD
)paren
op_eq
id|HP_SDC_ACT_DEAD
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Error reading config byte.&bslash;n&quot;
)paren
suffix:semicolon
id|hp_sdc_exit
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp_sdc.r11
op_assign
id|tq_init_seq
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.r11
op_amp
id|HP_SDC_CFG_NEW
)paren
(brace
r_char
op_star
id|str
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;New style SDC&bslash;n&quot;
)paren
suffix:semicolon
id|tq_init_seq
(braket
l_int|1
)braket
op_assign
id|HP_SDC_CMD_READ_XTD
suffix:semicolon
id|tq_init.actidx
op_assign
l_int|0
suffix:semicolon
id|tq_init.idx
op_assign
l_int|1
suffix:semicolon
id|down
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|tq_init
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tq_init_seq
(braket
l_int|0
)braket
op_amp
id|HP_SDC_ACT_DEAD
)paren
op_eq
id|HP_SDC_ACT_DEAD
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Error reading extended config byte.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp_sdc.r7e
op_assign
id|tq_init_seq
(braket
l_int|4
)braket
suffix:semicolon
id|HP_SDC_XTD_REV_STRINGS
c_func
(paren
id|hp_sdc.r7e
op_amp
id|HP_SDC_XTD_REV
comma
id|str
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;Revision: %s&bslash;n&quot;
comma
id|str
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc.r7e
op_amp
id|HP_SDC_XTD_BEEPER
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;TI SN76494 beeper present&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp_sdc.r7e
op_amp
id|HP_SDC_XTD_BBRTC
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;OKI MSM-58321 BBRTC present&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;Spunking the self test register to force PUP &quot;
l_string|&quot;on next firmware reset.&bslash;n&quot;
)paren
suffix:semicolon
id|tq_init_seq
(braket
l_int|0
)braket
op_assign
id|HP_SDC_ACT_PRECMD
op_or
id|HP_SDC_ACT_DATAOUT
op_or
id|HP_SDC_ACT_SEMAPHORE
suffix:semicolon
id|tq_init_seq
(braket
l_int|1
)braket
op_assign
id|HP_SDC_CMD_SET_STR
suffix:semicolon
id|tq_init_seq
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
id|tq_init_seq
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
id|tq_init.actidx
op_assign
l_int|0
suffix:semicolon
id|tq_init.idx
op_assign
l_int|1
suffix:semicolon
id|tq_init.endidx
op_assign
l_int|4
suffix:semicolon
id|down
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|tq_init
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|tq_init_sem
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;Old style SDC (1820-%s).&bslash;n&quot;
comma
(paren
id|hp_sdc.r11
op_amp
id|HP_SDC_CFG_REV
)paren
ques
c_cond
l_string|&quot;3300&quot;
suffix:colon
l_string|&quot;2564/3087&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hp_sdc_register
id|module_init
c_func
(paren
id|hp_sdc_register
)paren
suffix:semicolon
DECL|variable|hp_sdc_exit
id|module_exit
c_func
(paren
id|hp_sdc_exit
)paren
suffix:semicolon
multiline_comment|/* Timing notes:  These measurements taken on my 64MHz 7100-LC (715/64) &n; *                                              cycles cycles-adj    time&n; * between two consecutive mfctl(16)&squot;s:              4        n/a    63ns&n; * hp_sdc_spin_ibf when idle:                      119        115   1.7us&n; * gsc_writeb status register:                      83         79   1.2us&n; * IBF to clear after sending SET_IM:             6204       6006    93us&n; * IBF to clear after sending LOAD_RT:            4467       4352    68us  &n; * IBF to clear after sending two LOAD_RTs:      18974      18859   295us&n; * READ_T1, read status/data, IRQ, call handler: 35564        n/a   556us&n; * cmd to ~IBF READ_T1 2nd time right after:   5158403        n/a    81ms&n; * between IRQ received and ~IBF for above:    2578877        n/a    40ms&n; *&n; * Performance stats after a run of this module configuring HIL and&n; * receiving a few mouse events:&n; *&n; * status in8  282508 cycles 7128 calls&n; * status out8   8404 cycles  341 calls&n; * data out8     1734 cycles   78 calls&n; * isr         174324 cycles  617 calls (includes take)&n; * take          1241 cycles    2 calls&n; * put        1411504 cycles 6937 calls&n; * task       1655209 cycles 6937 calls (includes put)&n; *&n; */
eof
