multiline_comment|/*&n; *  NEC PC-9801 keyboard controller driver for Linux&n; *&n; *  Copyright (c) 1999-2002 Osamu Tomita &lt;tomita@cinet.co.jp&gt;&n; *    Based on i8042.c written by Vojtech Pavlik&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License version 2 as published by&n; * the Free Software Foundation.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/serio.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/io.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Osamu Tomita &lt;tomita@cinet.co.jp&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;NEC PC-9801 keyboard controller driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Names.&n; */
DECL|macro|KBD98_PHYS_DESC
mdefine_line|#define KBD98_PHYS_DESC &quot;isa0041/serio0&quot;
multiline_comment|/*&n; * IRQs.&n; */
DECL|macro|KBD98_IRQ
mdefine_line|#define KBD98_IRQ&t;1
multiline_comment|/*&n; * Register numbers.&n; */
DECL|macro|KBD98_COMMAND_REG
mdefine_line|#define KBD98_COMMAND_REG&t;0x43
DECL|macro|KBD98_STATUS_REG
mdefine_line|#define KBD98_STATUS_REG&t;0x43
DECL|macro|KBD98_DATA_REG
mdefine_line|#define KBD98_DATA_REG&t;&t;0x41
DECL|variable|kbd98io_lock
id|spinlock_t
id|kbd98io_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|kbd98_port
r_static
r_struct
id|serio
id|kbd98_port
suffix:semicolon
r_extern
r_struct
id|pt_regs
op_star
id|kbd_pt_regs
suffix:semicolon
r_static
id|irqreturn_t
id|kbd98io_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/*&n; * kbd98_flush() flushes all data that may be in the keyboard buffers&n; */
DECL|function|kbd98_flush
r_static
r_int
id|kbd98_flush
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|kbd98io_lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|KBD98_STATUS_REG
)paren
op_amp
l_int|0x02
)paren
multiline_comment|/* RxRDY */
id|inb
c_func
(paren
id|KBD98_DATA_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|KBD98_STATUS_REG
)paren
op_amp
l_int|0x38
)paren
id|printk
c_func
(paren
l_string|&quot;98kbd-io: Keyboard error!&bslash;n&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|kbd98io_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * kbd98_write() sends a byte out through the keyboard interface.&n; */
DECL|function|kbd98_write
r_static
r_int
id|kbd98_write
c_func
(paren
r_struct
id|serio
op_star
id|port
comma
r_int
r_char
id|c
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|kbd98io_lock
comma
id|flags
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
l_int|0x5f
)paren
suffix:semicolon
multiline_comment|/* wait */
id|outb
c_func
(paren
l_int|0x17
comma
id|KBD98_COMMAND_REG
)paren
suffix:semicolon
multiline_comment|/* enable send command */
id|outb
c_func
(paren
l_int|0
comma
l_int|0x5f
)paren
suffix:semicolon
multiline_comment|/* wait */
id|outb
c_func
(paren
id|c
comma
id|KBD98_DATA_REG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
l_int|0x5f
)paren
suffix:semicolon
multiline_comment|/* wait */
id|outb
c_func
(paren
l_int|0x16
comma
id|KBD98_COMMAND_REG
)paren
suffix:semicolon
multiline_comment|/* disable send command */
id|outb
c_func
(paren
l_int|0
comma
l_int|0x5f
)paren
suffix:semicolon
multiline_comment|/* wait */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|kbd98io_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * kbd98_open() is called when a port is open by the higher layer.&n; * It allocates the interrupt and enables in in the chip.&n; */
DECL|function|kbd98_open
r_static
r_int
id|kbd98_open
c_func
(paren
r_struct
id|serio
op_star
id|port
)paren
(brace
id|kbd98_flush
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|KBD98_IRQ
comma
id|kbd98io_interrupt
comma
l_int|0
comma
l_string|&quot;kbd98&quot;
comma
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;98kbd-io.c: Can&squot;t get irq %d for %s, unregistering the port.&bslash;n&quot;
comma
id|KBD98_IRQ
comma
l_string|&quot;KBD&quot;
)paren
suffix:semicolon
id|serio_unregister_port
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|kbd98_close
r_static
r_void
id|kbd98_close
c_func
(paren
r_struct
id|serio
op_star
id|port
)paren
(brace
id|free_irq
c_func
(paren
id|KBD98_IRQ
comma
l_int|NULL
)paren
suffix:semicolon
id|kbd98_flush
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Structures for registering the devices in the serio.c module.&n; */
DECL|variable|kbd98_port
r_static
r_struct
id|serio
id|kbd98_port
op_assign
(brace
dot
id|type
op_assign
id|SERIO_PC9800
comma
dot
id|write
op_assign
id|kbd98_write
comma
dot
id|open
op_assign
id|kbd98_open
comma
dot
id|close
op_assign
id|kbd98_close
comma
dot
id|driver
op_assign
l_int|NULL
comma
dot
id|name
op_assign
l_string|&quot;PC-9801 Kbd Port&quot;
comma
dot
id|phys
op_assign
id|KBD98_PHYS_DESC
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * kbd98io_interrupt() is the most important function in this driver -&n; * it handles the interrupts from keyboard, and sends incoming bytes&n; * to the upper layers.&n; */
DECL|function|kbd98io_interrupt
r_static
id|irqreturn_t
id|kbd98io_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|data
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|kbd98io_lock
comma
id|flags
)paren
suffix:semicolon
id|data
op_assign
id|inb
c_func
(paren
id|KBD98_DATA_REG
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|kbd98io_lock
comma
id|flags
)paren
suffix:semicolon
id|serio_interrupt
c_func
(paren
op_amp
id|kbd98_port
comma
id|data
comma
l_int|0
comma
id|regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|kbd98io_init
r_int
id|__init
id|kbd98io_init
c_func
(paren
r_void
)paren
(brace
id|serio_register_port
c_func
(paren
op_amp
id|kbd98_port
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;serio: PC-9801 %s port at %#lx,%#lx irq %d&bslash;n&quot;
comma
l_string|&quot;KBD&quot;
comma
(paren
r_int
r_int
)paren
id|KBD98_DATA_REG
comma
(paren
r_int
r_int
)paren
id|KBD98_COMMAND_REG
comma
id|KBD98_IRQ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|kbd98io_exit
r_void
id|__exit
id|kbd98io_exit
c_func
(paren
r_void
)paren
(brace
id|serio_unregister_port
c_func
(paren
op_amp
id|kbd98_port
)paren
suffix:semicolon
)brace
DECL|variable|kbd98io_init
id|module_init
c_func
(paren
id|kbd98io_init
)paren
suffix:semicolon
DECL|variable|kbd98io_exit
id|module_exit
c_func
(paren
id|kbd98io_exit
)paren
suffix:semicolon
eof
