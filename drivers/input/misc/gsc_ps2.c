multiline_comment|/*&n; * drivers/input/misc/gsc_ps2.c&n; *&n; * Copyright (c) 2002 Laurent Canet &lt;canetl@esiee.fr&gt;&n; * Copyright (c) 2002 Thibaut Varene &lt;varenet@esiee.fr&gt;&n; *&n; * Pieces of code based on linux-2.4&squot;s hp_mouse.c &amp; hp_keyb.c&n; * &t;Copyright (c) 1999 Alex deVries &lt;adevries@thepuffingroup.com&gt;&n; *&t;Copyright (c) 1999-2000 Philipp Rumpf &lt;prumpf@tux.org&gt;&n; *&t;Copyright (c) 2000 Xavier Debacker &lt;debackex@esiee.fr&gt;&n; *&t;Copyright (c) 2000-2001 Thomas Marteau &lt;marteaut@esiee.fr&gt;&n; *&n; * HP PS/2 Keyboard, found in PA/RISC Workstations&n; * very similar to AT keyboards, but without i8042&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; * &n; * STATUS:&n; * 11/09: lc: Only basic keyboard is supported, mouse still needs to be done.&n; * 11/12: tv: switching iomapping; cleaning code; improving module stuff.&n; * 11/13: lc &amp; tv: leds aren&squot;t working. auto_repeat/meta are. Generaly good behavior.&n; * 11/15: tv: 2AM: leds ARE working !&n; * 11/16: tv: 3AM: escaped keycodes emulation *handled*, some keycodes are&n; *&t;  still deliberately ignored (18), what are they used for ?&n; * 11/21: lc: mouse is now working&n; * 11/29: tv: first try for error handling in init sequence&n; *&n; * TODO:&n; * Error handling in init sequence&n; * SysRq handling&n; * Pause key handling&n; * Intellimouse &amp; other rodents handling (at least send an error when&n; * such a mouse is plugged : it will totally fault)&n; * Mouse: set scaling / Dino testing&n; * Bug chasing...&n; *&n; */
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;       /* interrupt.h wants struct pt_regs defined */
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sched.h&gt;        /* for request_irq/free_irq */        
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pc_keyb.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/kd.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* Debugging stuff */
DECL|macro|KBD_DEBUG
macro_line|#undef KBD_DEBUG
macro_line|#ifdef KBD_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt,args...) printk(KERN_DEBUG __FILE__ &quot;:&quot; fmt, ##args)
macro_line|#else 
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(x,...)
macro_line|#endif
multiline_comment|/* &n; * Driver constants&n; */
multiline_comment|/* PS/2 keyboard and mouse constants */
DECL|macro|AUX_RECONNECT
mdefine_line|#define AUX_RECONNECT&t;&t;0xAA&t;/* PS/2 Mouse end of test successful */
DECL|macro|AUX_REPLY_ACK
mdefine_line|#define AUX_REPLY_ACK&t;&t;0xFA
multiline_comment|/* Order of the mouse bytes coming to the host */
DECL|macro|PACKET_X
mdefine_line|#define PACKET_X&t;&t;1
DECL|macro|PACKET_Y
mdefine_line|#define PACKET_Y&t;&t;2
DECL|macro|PACKET_CTRL
mdefine_line|#define PACKET_CTRL&t;&t;0
DECL|macro|GSC_MOUSE_OFFSET
mdefine_line|#define GSC_MOUSE_OFFSET&t;0x0100&t;/* offset from keyboard to mouse port */
DECL|macro|GSC_DINO_OFFSET
mdefine_line|#define GSC_DINO_OFFSET&t;&t;0x800&t;/* offset for DINO controller versus LASI one */
DECL|macro|GSC_ID
mdefine_line|#define GSC_ID&t;&t;&t;0x00&t;/* ID and reset port offsets */
DECL|macro|GSC_RESET
mdefine_line|#define GSC_RESET&t;&t;0x00
DECL|macro|GSC_RCVDATA
mdefine_line|#define GSC_RCVDATA&t;&t;0x04&t;/* receive and transmit port offsets */
DECL|macro|GSC_XMTDATA
mdefine_line|#define GSC_XMTDATA&t;&t;0x04
DECL|macro|GSC_CONTROL
mdefine_line|#define GSC_CONTROL&t;&t;0x08&t;/* see: control register bits */
DECL|macro|GSC_STATUS
mdefine_line|#define GSC_STATUS&t;&t;0x0C&t;/* see: status register bits */
multiline_comment|/* Control register bits */
DECL|macro|GSC_CTRL_ENBL
mdefine_line|#define GSC_CTRL_ENBL&t;&t;0x01&t;/* enable interface */
DECL|macro|GSC_CTRL_LPBXR
mdefine_line|#define GSC_CTRL_LPBXR&t;&t;0x02&t;/* loopback operation */
DECL|macro|GSC_CTRL_DIAG
mdefine_line|#define GSC_CTRL_DIAG&t;&t;0x20&t;/* directly control clock/data line */
DECL|macro|GSC_CTRL_DATDIR
mdefine_line|#define GSC_CTRL_DATDIR&t;&t;0x40&t;/* data line direct control */
DECL|macro|GSC_CTRL_CLKDIR
mdefine_line|#define GSC_CTRL_CLKDIR&t;&t;0x80&t;/* clock line direct control */
multiline_comment|/* Status register bits */
DECL|macro|GSC_STAT_RBNE
mdefine_line|#define GSC_STAT_RBNE&t;&t;0x01&t;/* Receive Buffer Not Empty */
DECL|macro|GSC_STAT_TBNE
mdefine_line|#define GSC_STAT_TBNE&t;&t;0x02&t;/* Transmit Buffer Not Empty */
DECL|macro|GSC_STAT_TERR
mdefine_line|#define GSC_STAT_TERR&t;&t;0x04&t;/* Timeout Error */
DECL|macro|GSC_STAT_PERR
mdefine_line|#define GSC_STAT_PERR&t;&t;0x08&t;/* Parity Error */
DECL|macro|GSC_STAT_CMPINTR
mdefine_line|#define GSC_STAT_CMPINTR&t;0x10&t;/* Composite Interrupt */
DECL|macro|GSC_STAT_DATSHD
mdefine_line|#define GSC_STAT_DATSHD&t;&t;0x40&t;/* Data Line Shadow */
DECL|macro|GSC_STAT_CLKSHD
mdefine_line|#define GSC_STAT_CLKSHD&t;&t;0x80&t;/* Clock Line Shadow */
multiline_comment|/* Keycode map */
DECL|macro|KBD_ESCAPE0
mdefine_line|#define KBD_ESCAPE0&t;&t;0xe0
DECL|macro|KBD_ESCAPE1
mdefine_line|#define KBD_ESCAPE1&t;&t;0xe1
DECL|macro|KBD_RELEASE
mdefine_line|#define KBD_RELEASE&t;&t;0xf0
DECL|macro|KBD_ACK
mdefine_line|#define KBD_ACK&t;&t;&t;0xfa
DECL|macro|KBD_RESEND
mdefine_line|#define KBD_RESEND&t;&t;0xfe
DECL|macro|KBD_UNKNOWN
mdefine_line|#define KBD_UNKNOWN&t;&t;0
DECL|macro|KBD_TBLSIZE
mdefine_line|#define KBD_TBLSIZE&t;&t;512
multiline_comment|/* Mouse */
DECL|macro|MOUSE_LEFTBTN
mdefine_line|#define MOUSE_LEFTBTN&t;&t;0x1
DECL|macro|MOUSE_MIDBTN
mdefine_line|#define MOUSE_MIDBTN&t;&t;0x4
DECL|macro|MOUSE_RIGHTBTN
mdefine_line|#define MOUSE_RIGHTBTN&t;&t;0x2
DECL|macro|MOUSE_ALWAYS1
mdefine_line|#define MOUSE_ALWAYS1&t;&t;0x8
DECL|macro|MOUSE_XSIGN
mdefine_line|#define MOUSE_XSIGN&t;&t;0x10
DECL|macro|MOUSE_YSIGN
mdefine_line|#define MOUSE_YSIGN&t;&t;0x20
DECL|macro|MOUSE_XOVFLOW
mdefine_line|#define MOUSE_XOVFLOW&t;&t;0x40
DECL|macro|MOUSE_YOVFLOW
mdefine_line|#define MOUSE_YOVFLOW&t;&t;0x80
DECL|variable|hpkeyb_keycode
r_static
r_int
r_char
id|hpkeyb_keycode
(braket
id|KBD_TBLSIZE
)braket
op_assign
(brace
multiline_comment|/* 00 */
id|KBD_UNKNOWN
comma
id|KEY_F9
comma
id|KBD_UNKNOWN
comma
id|KEY_F5
comma
id|KEY_F3
comma
id|KEY_F1
comma
id|KEY_F2
comma
id|KEY_F12
comma
multiline_comment|/* 08 */
id|KBD_UNKNOWN
comma
id|KEY_F10
comma
id|KEY_F8
comma
id|KEY_F6
comma
id|KEY_F4
comma
id|KEY_TAB
comma
id|KEY_GRAVE
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 10 */
id|KBD_UNKNOWN
comma
id|KEY_LEFTALT
comma
id|KEY_LEFTSHIFT
comma
id|KBD_UNKNOWN
comma
id|KEY_LEFTCTRL
comma
id|KEY_Q
comma
id|KEY_1
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 18 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_Z
comma
id|KEY_S
comma
id|KEY_A
comma
id|KEY_W
comma
id|KEY_2
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 20 */
id|KBD_UNKNOWN
comma
id|KEY_C
comma
id|KEY_X
comma
id|KEY_D
comma
id|KEY_E
comma
id|KEY_4
comma
id|KEY_3
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 28 */
id|KBD_UNKNOWN
comma
id|KEY_SPACE
comma
id|KEY_V
comma
id|KEY_F
comma
id|KEY_T
comma
id|KEY_R
comma
id|KEY_5
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 30 */
id|KBD_UNKNOWN
comma
id|KEY_N
comma
id|KEY_B
comma
id|KEY_H
comma
id|KEY_G
comma
id|KEY_Y
comma
id|KEY_6
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 38 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_M
comma
id|KEY_J
comma
id|KEY_U
comma
id|KEY_7
comma
id|KEY_8
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 40 */
id|KBD_UNKNOWN
comma
id|KEY_COMMA
comma
id|KEY_K
comma
id|KEY_I
comma
id|KEY_O
comma
id|KEY_0
comma
id|KEY_9
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 48 */
id|KBD_UNKNOWN
comma
id|KEY_DOT
comma
id|KEY_SLASH
comma
id|KEY_L
comma
id|KEY_SEMICOLON
comma
id|KEY_P
comma
id|KEY_MINUS
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 50 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_APOSTROPHE
comma
id|KBD_UNKNOWN
comma
id|KEY_LEFTBRACE
comma
id|KEY_EQUAL
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 58 */
id|KEY_CAPSLOCK
comma
id|KEY_RIGHTSHIFT
comma
id|KEY_ENTER
comma
id|KEY_RIGHTBRACE
comma
id|KBD_UNKNOWN
comma
id|KEY_BACKSLASH
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 60 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_BACKSPACE
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 68 */
id|KBD_UNKNOWN
comma
id|KEY_KP1
comma
id|KBD_UNKNOWN
comma
id|KEY_KP4
comma
id|KEY_KP7
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 70 */
id|KEY_KP0
comma
id|KEY_KPDOT
comma
id|KEY_KP2
comma
id|KEY_KP5
comma
id|KEY_KP6
comma
id|KEY_KP8
comma
id|KEY_ESC
comma
id|KEY_NUMLOCK
comma
multiline_comment|/* 78 */
id|KEY_F11
comma
id|KEY_KPPLUS
comma
id|KEY_KP3
comma
id|KEY_KPMINUS
comma
id|KEY_KPASTERISK
comma
id|KEY_KP9
comma
id|KEY_SCROLLLOCK
comma
id|KEY_103RD
comma
multiline_comment|/* 80 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_F7
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 88 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 90 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 98 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* a0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* a8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* b0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* b8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* c0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* c8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* d0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* d8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* e0 */
id|KBD_ESCAPE0
comma
id|KBD_ESCAPE1
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* e8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* f0 */
id|KBD_RELEASE
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* f8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_ACK
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_RESEND
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* These are offset for escaped keycodes */
multiline_comment|/* 00 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 08 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 10 */
id|KBD_UNKNOWN
comma
id|KEY_RIGHTALT
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_RIGHTCTRL
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 18 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 20 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 28 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 30 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 38 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 40 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 48 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_KPSLASH
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 50 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 58 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_KPENTER
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 60 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 68 */
id|KBD_UNKNOWN
comma
id|KEY_END
comma
id|KBD_UNKNOWN
comma
id|KEY_LEFT
comma
id|KEY_HOME
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 70 */
id|KEY_INSERT
comma
id|KEY_DELETE
comma
id|KEY_DOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_RIGHT
comma
id|KEY_UP
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 78 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_PAGEDOWN
comma
id|KBD_UNKNOWN
comma
id|KEY_SYSRQ
comma
id|KEY_PAGEUP
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 80 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 88 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 90 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* 98 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* a0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* a8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* b0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* b8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* c0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* c8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* d0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* d8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* e0 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* e8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* f0 */
id|KBD_RELEASE
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
multiline_comment|/* f8 */
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
comma
id|KBD_UNKNOWN
)brace
suffix:semicolon
multiline_comment|/* Keyboard struct */
r_static
r_struct
(brace
DECL|member|dev
r_struct
id|input_dev
id|dev
suffix:semicolon
DECL|member|addr
r_char
op_star
id|addr
suffix:semicolon
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
DECL|member|scancode
r_int
r_int
id|scancode
suffix:semicolon
DECL|member|escaped
r_int
r_int
id|escaped
suffix:semicolon
DECL|member|released
r_int
r_int
id|released
suffix:semicolon
DECL|member|initialized
r_int
r_int
id|initialized
suffix:semicolon
)brace
DECL|variable|hpkeyb
id|hpkeyb
op_assign
(brace
dot
id|escaped
op_assign
l_int|0
comma
dot
id|released
op_assign
l_int|0
comma
dot
id|initialized
op_assign
l_int|0
)brace
suffix:semicolon
multiline_comment|/* Mouse struct */
r_static
r_struct
(brace
DECL|member|dev
r_struct
id|input_dev
id|dev
suffix:semicolon
DECL|member|addr
r_char
op_star
id|addr
suffix:semicolon
DECL|member|irq
r_int
r_int
id|irq
suffix:semicolon
DECL|member|initialized
r_int
r_int
id|initialized
suffix:semicolon
DECL|member|nbread
r_int
id|nbread
suffix:semicolon
DECL|member|bytes
r_int
r_char
id|bytes
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|last
r_int
r_int
id|last
suffix:semicolon
)brace
DECL|variable|hpmouse
id|hpmouse
op_assign
(brace
dot
id|initialized
op_assign
l_int|0
comma
dot
id|nbread
op_assign
l_int|0
)brace
suffix:semicolon
DECL|variable|gscps2_lock
r_static
id|spinlock_t
id|gscps2_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/*&n; * Various HW level routines&n; */
DECL|macro|gscps2_readb_input
mdefine_line|#define gscps2_readb_input(x)&t;&t;readb(x+GSC_RCVDATA)
DECL|macro|gscps2_readb_control
mdefine_line|#define gscps2_readb_control(x)&t;&t;readb(x+GSC_CONTROL)
DECL|macro|gscps2_readb_status
mdefine_line|#define gscps2_readb_status(x)&t;&t;readb(x+GSC_STATUS)
DECL|macro|gscps2_writeb_control
mdefine_line|#define gscps2_writeb_control(x, y)&t;writeb(x, y+GSC_CONTROL)
DECL|function|gscps2_writeb_output
r_static
r_inline
r_void
id|gscps2_writeb_output
c_func
(paren
id|u8
id|val
comma
r_char
op_star
id|addr
)paren
(brace
r_int
id|wait
op_assign
l_int|250
suffix:semicolon
multiline_comment|/* Keyboard is expected to react within 250ms */
r_while
c_loop
(paren
id|gscps2_readb_status
c_func
(paren
id|addr
)paren
op_amp
id|GSC_STAT_TBNE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|wait
)paren
r_return
suffix:semicolon
multiline_comment|/* This should not happen */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|val
comma
id|addr
op_plus
id|GSC_XMTDATA
)paren
suffix:semicolon
)brace
DECL|function|gscps2_wait_input
r_static
r_inline
r_int
r_char
id|gscps2_wait_input
c_func
(paren
r_char
op_star
id|addr
)paren
(brace
r_int
id|wait
op_assign
l_int|250
suffix:semicolon
multiline_comment|/* Keyboard is expected to react within 250ms */
r_while
c_loop
(paren
op_logical_neg
(paren
id|gscps2_readb_status
c_func
(paren
id|addr
)paren
op_amp
id|GSC_STAT_RBNE
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|wait
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* This should not happen */
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|gscps2_readb_input
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
DECL|function|gscps2_writeb_safe_output
r_static
r_int
id|gscps2_writeb_safe_output
c_func
(paren
id|u8
id|val
)paren
(brace
multiline_comment|/* This function waits for keyboard&squot;s ACK */
id|u8
id|scanread
op_assign
id|KBD_UNKNOWN
suffix:semicolon
r_int
id|loop
op_assign
l_int|5
suffix:semicolon
r_while
c_loop
(paren
id|hpkeyb_keycode
(braket
id|scanread
)braket
op_ne
id|KBD_ACK
op_logical_and
op_decrement
id|loop
OG
l_int|0
)paren
(brace
id|gscps2_writeb_output
c_func
(paren
id|val
comma
id|hpkeyb.addr
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|scanread
op_assign
id|gscps2_wait_input
c_func
(paren
id|hpkeyb.addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|loop
op_le
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset the PS2 port */
DECL|function|gscps2_reset
r_static
r_void
id|__init
id|gscps2_reset
c_func
(paren
r_char
op_star
id|addr
)paren
(brace
multiline_comment|/* reset the interface */
id|writeb
c_func
(paren
l_int|0xff
comma
id|addr
op_plus
id|GSC_RESET
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0x0
comma
id|addr
op_plus
id|GSC_RESET
)paren
suffix:semicolon
multiline_comment|/* enable it */
id|gscps2_writeb_control
c_func
(paren
id|gscps2_readb_control
c_func
(paren
id|addr
)paren
op_or
id|GSC_CTRL_ENBL
comma
id|addr
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * gscps2_kbd_docode() - PS2 Keyboard basic handler&n; *&n; * Receives a keyboard scancode, analyses it and sends it to the input layer.&n; */
DECL|function|gscps2_kbd_docode
r_static
r_void
id|gscps2_kbd_docode
c_func
(paren
r_void
)paren
(brace
r_int
id|scancode
op_assign
id|gscps2_readb_input
c_func
(paren
id|hpkeyb.addr
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;rel=%d scancode=%d, esc=%d &quot;
comma
id|hpkeyb.released
comma
id|scancode
comma
id|hpkeyb.escaped
)paren
suffix:semicolon
multiline_comment|/* Handle previously escaped scancodes */
r_if
c_cond
(paren
id|hpkeyb.escaped
op_eq
id|KBD_ESCAPE0
)paren
id|scancode
op_or_assign
l_int|0x100
suffix:semicolon
multiline_comment|/* jump to the next 256 chars of the table */
r_switch
c_cond
(paren
id|hpkeyb_keycode
(braket
id|scancode
)braket
)paren
(brace
r_case
id|KBD_RELEASE
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;release&bslash;n&quot;
)paren
suffix:semicolon
id|hpkeyb.released
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KBD_RESEND
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;resend request&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KBD_ACK
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;ACK&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KBD_ESCAPE0
suffix:colon
r_case
id|KBD_ESCAPE1
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;escape code %d&bslash;n&quot;
comma
id|hpkeyb_keycode
(braket
id|scancode
)braket
)paren
suffix:semicolon
id|hpkeyb.escaped
op_assign
id|hpkeyb_keycode
(braket
id|scancode
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|KBD_UNKNOWN
suffix:colon
id|DPRINTK
c_func
(paren
l_string|&quot;received unknown scancode %d, escape %d.&bslash;n&quot;
comma
id|scancode
comma
id|hpkeyb.escaped
)paren
suffix:semicolon
multiline_comment|/* This is a DPRINTK atm since we do not handle escaped scancodes cleanly */
r_if
c_cond
(paren
id|hpkeyb.escaped
)paren
id|hpkeyb.escaped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hpkeyb.released
)paren
id|hpkeyb.released
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|hpkeyb.scancode
op_assign
id|scancode
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;sent=%d, rel=%d&bslash;n&quot;
comma
id|hpkeyb.scancode
comma
id|hpkeyb.released
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|hpkeyb.dev
comma
id|hpkeyb_keycode
(braket
id|hpkeyb.scancode
)braket
comma
op_logical_neg
id|hpkeyb.released
)paren
suffix:semicolon
id|input_sync
c_func
(paren
op_amp
id|hpkeyb.dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpkeyb.escaped
)paren
id|hpkeyb.escaped
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hpkeyb.released
)paren
id|hpkeyb.released
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * gscps2_mouse_docode() - PS2 Mouse basic handler&n; *&n; * Receives mouse codes, processes them by packets of three, and sends&n; * correct events to the input layer.&n; */
DECL|function|gscps2_mouse_docode
r_static
r_void
id|gscps2_mouse_docode
c_func
(paren
r_void
)paren
(brace
r_int
id|xrel
comma
id|yrel
suffix:semicolon
multiline_comment|/* process BAT (end of basic tests) command */
r_if
c_cond
(paren
(paren
id|hpmouse.nbread
op_eq
l_int|1
)paren
op_logical_and
(paren
id|hpmouse.bytes
(braket
l_int|0
)braket
op_eq
id|AUX_RECONNECT
)paren
)paren
id|hpmouse.nbread
op_decrement
suffix:semicolon
multiline_comment|/* stolen from psmouse.c */
r_if
c_cond
(paren
id|hpmouse.nbread
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|hpmouse.last
op_plus
id|HZ
op_div
l_int|20
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s:%d : Lost mouse synchronization, throwing %d bytes away.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|hpmouse.nbread
)paren
suffix:semicolon
id|hpmouse.nbread
op_assign
l_int|0
suffix:semicolon
)brace
id|hpmouse.last
op_assign
id|jiffies
suffix:semicolon
id|hpmouse.bytes
(braket
id|hpmouse.nbread
op_increment
)braket
op_assign
id|gscps2_readb_input
c_func
(paren
id|hpmouse.addr
)paren
suffix:semicolon
multiline_comment|/* process packet */
r_if
c_cond
(paren
id|hpmouse.nbread
op_eq
l_int|3
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hpmouse.bytes
(braket
id|PACKET_CTRL
)braket
op_amp
id|MOUSE_ALWAYS1
)paren
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Mouse: error on packet always1 bit checking&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* XXX should exit now, bad data on the line! */
r_if
c_cond
(paren
(paren
id|hpmouse.bytes
(braket
id|PACKET_CTRL
)braket
op_amp
(paren
id|MOUSE_XOVFLOW
op_or
id|MOUSE_YOVFLOW
)paren
)paren
)paren
id|DPRINTK
c_func
(paren
l_string|&quot;Mouse: position overflow&bslash;n&quot;
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|hpmouse.dev
comma
id|BTN_LEFT
comma
id|hpmouse.bytes
(braket
id|PACKET_CTRL
)braket
op_amp
id|MOUSE_LEFTBTN
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|hpmouse.dev
comma
id|BTN_MIDDLE
comma
id|hpmouse.bytes
(braket
id|PACKET_CTRL
)braket
op_amp
id|MOUSE_MIDBTN
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
op_amp
id|hpmouse.dev
comma
id|BTN_RIGHT
comma
id|hpmouse.bytes
(braket
id|PACKET_CTRL
)braket
op_amp
id|MOUSE_RIGHTBTN
)paren
suffix:semicolon
id|xrel
op_assign
id|hpmouse.bytes
(braket
id|PACKET_X
)braket
suffix:semicolon
id|yrel
op_assign
id|hpmouse.bytes
(braket
id|PACKET_Y
)braket
suffix:semicolon
multiline_comment|/* Data sent by mouse are 9-bit signed, the sign bit is in the control packet */
r_if
c_cond
(paren
id|xrel
op_logical_and
(paren
id|hpmouse.bytes
(braket
id|PACKET_CTRL
)braket
op_amp
id|MOUSE_XSIGN
)paren
)paren
id|xrel
op_assign
id|xrel
op_minus
l_int|0x100
suffix:semicolon
r_if
c_cond
(paren
id|yrel
op_logical_and
(paren
id|hpmouse.bytes
(braket
id|PACKET_CTRL
)braket
op_amp
id|MOUSE_YSIGN
)paren
)paren
id|yrel
op_assign
id|yrel
op_minus
l_int|0x100
suffix:semicolon
id|input_report_rel
c_func
(paren
op_amp
id|hpmouse.dev
comma
id|REL_X
comma
id|xrel
)paren
suffix:semicolon
id|input_report_rel
c_func
(paren
op_amp
id|hpmouse.dev
comma
id|REL_Y
comma
op_minus
id|yrel
)paren
suffix:semicolon
multiline_comment|/* Y axis is received upside-down */
id|input_sync
c_func
(paren
op_amp
id|hpmouse.dev
)paren
suffix:semicolon
id|hpmouse.nbread
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * gscps2_interrupt() - Interruption service routine&n; *&n; * This processes the list of scancodes queued and sends appropriate&n; * key value to the system.&n; */
DECL|function|gscps2_interrupt
r_static
r_void
id|gscps2_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|reg
)paren
(brace
multiline_comment|/* process mouse actions */
r_while
c_loop
(paren
id|gscps2_readb_status
c_func
(paren
id|hpmouse.addr
)paren
op_amp
id|GSC_STAT_RBNE
)paren
id|gscps2_mouse_docode
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* process keyboard scancode */
r_while
c_loop
(paren
id|gscps2_readb_status
c_func
(paren
id|hpkeyb.addr
)paren
op_amp
id|GSC_STAT_RBNE
)paren
id|gscps2_kbd_docode
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * gscps2_hpkeyb_event() - Event handler&n; * @return: success/error report&n; *&n; * Currently only updates leds on keyboard&n; */
DECL|function|gscps2_hpkeyb_event
r_int
id|gscps2_hpkeyb_event
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_int
r_int
id|code
comma
r_int
id|value
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;Calling %s, type=%d, code=%d, value=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|type
comma
id|code
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpkeyb.initialized
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|EV_LED
)paren
(brace
id|u8
id|leds
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|gscps2_writeb_safe_output
c_func
(paren
id|KBD_CMD_SET_LEDS
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gsckbd_leds: timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;KBD_CMD_SET_LEDS&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|leds
op_assign
(paren
id|test_bit
c_func
(paren
id|LED_SCROLLL
comma
id|dev-&gt;led
)paren
ques
c_cond
id|LED_SCR
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_NUML
comma
id|dev-&gt;led
)paren
ques
c_cond
id|LED_NUM
suffix:colon
l_int|0
)paren
op_or
(paren
id|test_bit
c_func
(paren
id|LED_CAPSL
comma
id|dev-&gt;led
)paren
ques
c_cond
id|LED_CAP
suffix:colon
l_int|0
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;Sending leds=%x&bslash;n&quot;
comma
op_star
id|leds
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gscps2_writeb_safe_output
c_func
(paren
op_star
id|leds
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gsckbd_leds: timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;leds sent&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gscps2_writeb_safe_output
c_func
(paren
id|KBD_CMD_ENABLE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;gsckbd_leds: timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;End&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * gscps2_kbd_probe() - Probes keyboard device and init input_dev structure&n; * @return: number of device initialized (1, 0 on error)&n; */
DECL|function|gscps2_kbd_probe
r_static
r_int
id|__init
id|gscps2_kbd_probe
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|res
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|hpkeyb.initialized
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;GSC PS/2 keyboard driver already registered&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|gscps2_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gscps2_writeb_safe_output
c_func
(paren
id|KBD_CMD_SET_LEDS
)paren
op_logical_and
op_logical_neg
id|gscps2_writeb_safe_output
c_func
(paren
l_int|0
)paren
op_logical_and
op_logical_neg
id|gscps2_writeb_safe_output
c_func
(paren
id|KBD_CMD_ENABLE
)paren
)paren
id|res
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|gscps2_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Keyboard initialization sequence failled&bslash;n&quot;
)paren
suffix:semicolon
id|init_input_dev
c_func
(paren
op_amp
id|hpkeyb.dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|KBD_TBLSIZE
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|hpkeyb_keycode
(braket
id|i
)braket
op_ne
id|KBD_UNKNOWN
)paren
id|set_bit
c_func
(paren
id|hpkeyb_keycode
(braket
id|i
)braket
comma
id|hpkeyb.dev.keybit
)paren
suffix:semicolon
id|hpkeyb.dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_LED
)paren
op_or
id|BIT
c_func
(paren
id|EV_REP
)paren
suffix:semicolon
id|hpkeyb.dev.ledbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|LED_NUML
)paren
op_or
id|BIT
c_func
(paren
id|LED_CAPSL
)paren
op_or
id|BIT
c_func
(paren
id|LED_SCROLLL
)paren
suffix:semicolon
id|hpkeyb.dev.keycode
op_assign
id|hpkeyb_keycode
suffix:semicolon
id|hpkeyb.dev.keycodesize
op_assign
r_sizeof
(paren
r_int
r_char
)paren
suffix:semicolon
id|hpkeyb.dev.keycodemax
op_assign
id|KBD_TBLSIZE
suffix:semicolon
id|hpkeyb.dev.name
op_assign
l_string|&quot;GSC Keyboard&quot;
suffix:semicolon
id|hpkeyb.dev.phys
op_assign
l_string|&quot;hpkbd/input0&quot;
suffix:semicolon
id|hpkeyb.dev.event
op_assign
id|gscps2_hpkeyb_event
suffix:semicolon
multiline_comment|/* TODO These need some adjustement, are they really useful ? */
id|hpkeyb.dev.id.bustype
op_assign
id|BUS_GSC
suffix:semicolon
id|hpkeyb.dev.id.vendor
op_assign
l_int|0x0001
suffix:semicolon
id|hpkeyb.dev.id.product
op_assign
l_int|0x0001
suffix:semicolon
id|hpkeyb.dev.id.version
op_assign
l_int|0x0010
suffix:semicolon
id|hpkeyb.initialized
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; * gscps2_mouse_probe() - Probes mouse device and init input_dev structure&n; * @return: number of device initialized (1, 0 on error)&n; *&n; * Currently no check on initialization is performed&n; */
DECL|function|gscps2_mouse_probe
r_static
r_int
id|__init
id|gscps2_mouse_probe
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|hpmouse.initialized
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;GSC PS/2 Mouse driver already registered&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|init_input_dev
c_func
(paren
op_amp
id|hpmouse.dev
)paren
suffix:semicolon
id|hpmouse.dev.name
op_assign
l_string|&quot;GSC Mouse&quot;
suffix:semicolon
id|hpmouse.dev.phys
op_assign
l_string|&quot;hpmouse/input0&quot;
suffix:semicolon
id|hpmouse.dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REL
)paren
suffix:semicolon
id|hpmouse.dev.keybit
(braket
id|LONG
c_func
(paren
id|BTN_MOUSE
)paren
)braket
op_assign
id|BIT
c_func
(paren
id|BTN_LEFT
)paren
op_or
id|BIT
c_func
(paren
id|BTN_MIDDLE
)paren
op_or
id|BIT
c_func
(paren
id|BTN_RIGHT
)paren
suffix:semicolon
id|hpmouse.dev.relbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|REL_X
)paren
op_or
id|BIT
c_func
(paren
id|REL_Y
)paren
suffix:semicolon
id|hpmouse.last
op_assign
l_int|0
suffix:semicolon
id|gscps2_writeb_output
c_func
(paren
id|AUX_ENABLE_DEV
comma
id|hpmouse.addr
)paren
suffix:semicolon
multiline_comment|/* Try it a second time, this will give status if the device is available */
id|gscps2_writeb_output
c_func
(paren
id|AUX_ENABLE_DEV
comma
id|hpmouse.addr
)paren
suffix:semicolon
multiline_comment|/* TODO These need some adjustement, are they really useful ? */
id|hpmouse.dev.id.bustype
op_assign
id|BUS_GSC
suffix:semicolon
id|hpmouse.dev.id.vendor
op_assign
l_int|0x0001
suffix:semicolon
id|hpmouse.dev.id.product
op_assign
l_int|0x0001
suffix:semicolon
id|hpmouse.dev.id.version
op_assign
l_int|0x0010
suffix:semicolon
id|hpmouse.initialized
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* XXX: we don&squot;t check if initialization failed */
)brace
multiline_comment|/**&n; * gscps2_probe() - Probes PS2 devices&n; * @return: success/error report&n; */
DECL|function|gscps2_probe
r_static
r_int
id|__init
id|gscps2_probe
c_func
(paren
r_struct
id|parisc_device
op_star
id|dev
)paren
(brace
id|u8
id|id
suffix:semicolon
r_char
op_star
id|addr
comma
op_star
id|name
suffix:semicolon
r_int
id|ret
comma
id|device_found
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|hpa
op_assign
id|dev-&gt;hpa
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;irq
)paren
r_goto
id|fail_pitifully
suffix:semicolon
multiline_comment|/* Offset for DINO PS/2. Works with LASI even */
r_if
c_cond
(paren
id|dev-&gt;id.sversion
op_eq
l_int|0x96
)paren
id|hpa
op_add_assign
id|GSC_DINO_OFFSET
suffix:semicolon
id|addr
op_assign
id|ioremap
c_func
(paren
id|hpa
comma
l_int|256
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpmouse.initialized
op_logical_or
op_logical_neg
id|hpkeyb.initialized
)paren
id|gscps2_reset
c_func
(paren
id|addr
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|id
op_assign
id|readb
c_func
(paren
id|addr
op_plus
id|GSC_ID
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* keyboard */
id|hpkeyb.addr
op_assign
id|addr
suffix:semicolon
id|name
op_assign
l_string|&quot;keyboard&quot;
suffix:semicolon
id|device_found
op_assign
id|gscps2_kbd_probe
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* mouse */
id|hpmouse.addr
op_assign
id|addr
suffix:semicolon
id|name
op_assign
l_string|&quot;mouse&quot;
suffix:semicolon
id|device_found
op_assign
id|gscps2_mouse_probe
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: Unsupported PS/2 port (id=%d) ignored&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|id
)paren
suffix:semicolon
r_goto
id|fail_miserably
suffix:semicolon
)brace
multiline_comment|/* No valid device found */
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|device_found
)paren
r_goto
id|fail_miserably
suffix:semicolon
multiline_comment|/* Here we claim only if we have a device attached */
multiline_comment|/* Allocate the irq and memory region for that device */
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|gscps2_interrupt
comma
l_int|0
comma
id|name
comma
l_int|NULL
)paren
)paren
r_goto
id|fail_miserably
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|hpa
comma
id|GSC_STATUS
op_plus
l_int|4
comma
id|name
)paren
)paren
r_goto
id|fail_request_mem
suffix:semicolon
multiline_comment|/* Finalize input struct and register it */
r_switch
c_cond
(paren
id|id
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* keyboard */
id|hpkeyb.irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|hpkeyb.dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* mouse */
id|hpmouse.irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|hpmouse.dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input: PS/2 %s port at 0x%08lx (irq %d) found and attached&bslash;n&quot;
comma
id|name
comma
id|hpa
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail_request_mem
suffix:colon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
l_int|NULL
)paren
suffix:semicolon
id|fail_miserably
suffix:colon
id|iounmap
c_func
(paren
id|addr
)paren
suffix:semicolon
id|fail_pitifully
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|gscps2_device_tbl
r_static
r_struct
id|parisc_device_id
id|gscps2_device_tbl
(braket
)braket
op_assign
(brace
(brace
id|HPHW_FIO
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x00084
)brace
comma
multiline_comment|/* LASI PS/2 */
multiline_comment|/*&t;{ HPHW_FIO, HVERSION_REV_ANY_ID, HVERSION_ANY_ID, 0x00096 },  DINO PS/2 (XXX Not yet tested) */
(brace
l_int|0
comma
)brace
multiline_comment|/* 0 terminated list */
)brace
suffix:semicolon
DECL|variable|gscps2_driver
r_static
r_struct
id|parisc_driver
id|gscps2_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;GSC PS2&quot;
comma
dot
id|id_table
op_assign
id|gscps2_device_tbl
comma
dot
id|probe
op_assign
id|gscps2_probe
comma
)brace
suffix:semicolon
DECL|function|gscps2_init
r_static
r_int
id|__init
id|gscps2_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|register_parisc_driver
c_func
(paren
op_amp
id|gscps2_driver
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gscps2_exit
r_static
r_void
id|__exit
id|gscps2_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* TODO this is probably not very good and needs to be checked */
r_if
c_cond
(paren
id|hpkeyb.initialized
)paren
(brace
id|free_irq
c_func
(paren
id|hpkeyb.irq
comma
id|gscps2_interrupt
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|hpkeyb.addr
)paren
suffix:semicolon
id|hpkeyb.initialized
op_assign
l_int|0
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|hpkeyb.dev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hpmouse.initialized
)paren
(brace
id|free_irq
c_func
(paren
id|hpmouse.irq
comma
id|gscps2_interrupt
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|hpmouse.addr
)paren
suffix:semicolon
id|hpmouse.initialized
op_assign
l_int|0
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|hpmouse.dev
)paren
suffix:semicolon
)brace
id|unregister_parisc_driver
c_func
(paren
op_amp
id|gscps2_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Laurent Canet &lt;canetl@esiee.fr&gt;, Thibaut Varene &lt;varenet@esiee.fr&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;GSC PS/2 keyboard/mouse driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|parisc
comma
id|gscps2_device_tbl
)paren
suffix:semicolon
DECL|variable|gscps2_init
id|module_init
c_func
(paren
id|gscps2_init
)paren
suffix:semicolon
DECL|variable|gscps2_exit
id|module_exit
c_func
(paren
id|gscps2_exit
)paren
suffix:semicolon
eof
