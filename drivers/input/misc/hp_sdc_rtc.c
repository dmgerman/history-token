multiline_comment|/*&n; * HP i8042 SDC + MSM-58321 BBRTC driver.&n; *&n; * Copyright (c) 2001 Brian S. Julin&n; * All rights reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification.&n; * 2. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * Alternatively, this software may be distributed under the terms of the&n; * GNU General Public License (&quot;GPL&quot;).&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; *&n; * References:&n; * System Device Controller Microprocessor Firmware Theory of Operation&n; *      for Part Number 1820-4784 Revision B.  Dwg No. A-1820-4784-2&n; * efirtc.c by Stephane Eranian/Hewlett Packard&n; *&n; */
macro_line|#include &lt;linux/hp_sdc.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/rtc.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Brian S. Julin &lt;bri@calyx.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;HP i8042 SDC + MSM-58321 RTC Driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
DECL|macro|RTC_VERSION
mdefine_line|#define RTC_VERSION &quot;1.10d&quot;
DECL|variable|epoch
r_static
r_int
r_int
id|epoch
op_assign
l_int|2000
suffix:semicolon
DECL|variable|i8042tregs
r_static
r_struct
id|semaphore
id|i8042tregs
suffix:semicolon
DECL|variable|hp_sdc_rtc_isr
r_static
id|hp_sdc_irqhook
id|hp_sdc_rtc_isr
suffix:semicolon
DECL|variable|hp_sdc_rtc_async_queue
r_static
r_struct
id|fasync_struct
op_star
id|hp_sdc_rtc_async_queue
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|hp_sdc_rtc_wait
)paren
suffix:semicolon
r_static
id|loff_t
id|hp_sdc_rtc_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
suffix:semicolon
r_static
id|ssize_t
id|hp_sdc_rtc_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
r_static
r_int
id|hp_sdc_rtc_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
r_int
id|hp_sdc_rtc_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
suffix:semicolon
r_static
r_int
id|hp_sdc_rtc_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|hp_sdc_rtc_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|hp_sdc_rtc_fasync
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|on
)paren
suffix:semicolon
r_static
r_int
id|hp_sdc_rtc_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|function|hp_sdc_rtc_isr
r_static
r_void
id|hp_sdc_rtc_isr
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_uint8
id|status
comma
r_uint8
id|data
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_do_read_bbrtc
r_static
r_int
id|hp_sdc_rtc_do_read_bbrtc
(paren
r_struct
id|rtc_time
op_star
id|rtctm
)paren
(brace
r_struct
id|semaphore
id|tsem
suffix:semicolon
id|hp_sdc_transaction
id|t
suffix:semicolon
r_uint8
id|tseq
(braket
l_int|91
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
l_int|91
)paren
(brace
id|tseq
(braket
id|i
op_increment
)braket
op_assign
id|HP_SDC_ACT_DATAREG
op_or
id|HP_SDC_ACT_POSTCMD
op_or
id|HP_SDC_ACT_DATAIN
suffix:semicolon
id|tseq
(braket
id|i
op_increment
)braket
op_assign
l_int|0x01
suffix:semicolon
multiline_comment|/* write i8042[0x70] */
id|tseq
(braket
id|i
)braket
op_assign
id|i
op_div
l_int|7
suffix:semicolon
multiline_comment|/* BBRTC reg address */
id|i
op_increment
suffix:semicolon
id|tseq
(braket
id|i
op_increment
)braket
op_assign
id|HP_SDC_CMD_DO_RTCR
suffix:semicolon
multiline_comment|/* Trigger command   */
id|tseq
(braket
id|i
op_increment
)braket
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* expect 1 stat/dat pair back.   */
id|i
op_increment
suffix:semicolon
id|i
op_increment
suffix:semicolon
multiline_comment|/* buffer for stat/dat pair       */
)brace
id|tseq
(braket
l_int|84
)braket
op_or_assign
id|HP_SDC_ACT_SEMAPHORE
suffix:semicolon
id|t.endidx
op_assign
l_int|91
suffix:semicolon
id|t.seq
op_assign
id|tseq
suffix:semicolon
id|t.act.semaphore
op_assign
op_amp
id|tsem
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|tsem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|t
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|down_interruptible
c_func
(paren
op_amp
id|tsem
)paren
suffix:semicolon
multiline_comment|/* Put ourselves to sleep for results. */
multiline_comment|/* Check for nonpresence of BBRTC */
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|tseq
(braket
l_int|83
)braket
op_or
id|tseq
(braket
l_int|90
)braket
op_or
id|tseq
(braket
l_int|69
)braket
op_or
id|tseq
(braket
l_int|76
)braket
op_or
id|tseq
(braket
l_int|55
)braket
op_or
id|tseq
(braket
l_int|62
)braket
op_or
id|tseq
(braket
l_int|34
)braket
op_or
id|tseq
(braket
l_int|41
)braket
op_or
id|tseq
(braket
l_int|20
)braket
op_or
id|tseq
(braket
l_int|27
)braket
op_or
id|tseq
(braket
l_int|6
)braket
op_or
id|tseq
(braket
l_int|13
)braket
)paren
op_amp
l_int|0x0f
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|rtctm
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
suffix:semicolon
id|rtctm-&gt;tm_year
op_assign
(paren
id|tseq
(braket
l_int|83
)braket
op_amp
l_int|0x0f
)paren
op_plus
(paren
id|tseq
(braket
l_int|90
)braket
op_amp
l_int|0x0f
)paren
op_star
l_int|10
suffix:semicolon
id|rtctm-&gt;tm_mon
op_assign
(paren
id|tseq
(braket
l_int|69
)braket
op_amp
l_int|0x0f
)paren
op_plus
(paren
id|tseq
(braket
l_int|76
)braket
op_amp
l_int|0x0f
)paren
op_star
l_int|10
suffix:semicolon
id|rtctm-&gt;tm_mday
op_assign
(paren
id|tseq
(braket
l_int|55
)braket
op_amp
l_int|0x0f
)paren
op_plus
(paren
id|tseq
(braket
l_int|62
)braket
op_amp
l_int|0x0f
)paren
op_star
l_int|10
suffix:semicolon
id|rtctm-&gt;tm_wday
op_assign
(paren
id|tseq
(braket
l_int|48
)braket
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|rtctm-&gt;tm_hour
op_assign
(paren
id|tseq
(braket
l_int|34
)braket
op_amp
l_int|0x0f
)paren
op_plus
(paren
id|tseq
(braket
l_int|41
)braket
op_amp
l_int|0x0f
)paren
op_star
l_int|10
suffix:semicolon
id|rtctm-&gt;tm_min
op_assign
(paren
id|tseq
(braket
l_int|20
)braket
op_amp
l_int|0x0f
)paren
op_plus
(paren
id|tseq
(braket
l_int|27
)braket
op_amp
l_int|0x0f
)paren
op_star
l_int|10
suffix:semicolon
id|rtctm-&gt;tm_sec
op_assign
(paren
id|tseq
(braket
l_int|6
)braket
op_amp
l_int|0x0f
)paren
op_plus
(paren
id|tseq
(braket
l_int|13
)braket
op_amp
l_int|0x0f
)paren
op_star
l_int|10
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_read_bbrtc
r_static
r_int
id|hp_sdc_rtc_read_bbrtc
(paren
r_struct
id|rtc_time
op_star
id|rtctm
)paren
(brace
r_struct
id|rtc_time
id|tm
comma
id|tm_last
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* MSM-58321 has no read latch, so must read twice and compare. */
r_if
c_cond
(paren
id|hp_sdc_rtc_do_read_bbrtc
c_func
(paren
op_amp
id|tm_last
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_rtc_do_read_bbrtc
c_func
(paren
op_amp
id|tm
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|memcmp
c_func
(paren
op_amp
id|tm
comma
op_amp
id|tm_last
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
op_increment
OG
l_int|4
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tm_last
comma
op_amp
id|tm
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_rtc_do_read_bbrtc
c_func
(paren
op_amp
id|tm
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|rtctm
comma
op_amp
id|tm
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_read_i8042timer
r_static
r_int64
id|hp_sdc_rtc_read_i8042timer
(paren
r_uint8
id|loadcmd
comma
r_int
id|numreg
)paren
(brace
id|hp_sdc_transaction
id|t
suffix:semicolon
r_uint8
id|tseq
(braket
l_int|26
)braket
op_assign
(brace
id|HP_SDC_ACT_PRECMD
op_or
id|HP_SDC_ACT_POSTCMD
op_or
id|HP_SDC_ACT_DATAIN
comma
l_int|0
comma
id|HP_SDC_CMD_READ_T1
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
id|HP_SDC_ACT_POSTCMD
op_or
id|HP_SDC_ACT_DATAIN
comma
id|HP_SDC_CMD_READ_T2
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
id|HP_SDC_ACT_POSTCMD
op_or
id|HP_SDC_ACT_DATAIN
comma
id|HP_SDC_CMD_READ_T3
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
id|HP_SDC_ACT_POSTCMD
op_or
id|HP_SDC_ACT_DATAIN
comma
id|HP_SDC_CMD_READ_T4
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
id|HP_SDC_ACT_POSTCMD
op_or
id|HP_SDC_ACT_DATAIN
comma
id|HP_SDC_CMD_READ_T5
comma
l_int|2
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|t.endidx
op_assign
id|numreg
op_star
l_int|5
suffix:semicolon
id|tseq
(braket
l_int|1
)braket
op_assign
id|loadcmd
suffix:semicolon
id|tseq
(braket
id|t.endidx
op_minus
l_int|4
)braket
op_or_assign
id|HP_SDC_ACT_SEMAPHORE
suffix:semicolon
multiline_comment|/* numreg assumed &gt; 1 */
id|t.seq
op_assign
id|tseq
suffix:semicolon
id|t.act.semaphore
op_assign
op_amp
id|i8042tregs
suffix:semicolon
id|down_interruptible
c_func
(paren
op_amp
id|i8042tregs
)paren
suffix:semicolon
multiline_comment|/* Sleep if output regs in use. */
r_if
c_cond
(paren
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|t
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|down_interruptible
c_func
(paren
op_amp
id|i8042tregs
)paren
suffix:semicolon
multiline_comment|/* Sleep until results come back. */
id|up
c_func
(paren
op_amp
id|i8042tregs
)paren
suffix:semicolon
r_return
(paren
id|tseq
(braket
l_int|5
)braket
op_or
(paren
(paren
r_uint64
)paren
(paren
id|tseq
(braket
l_int|10
)braket
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
r_uint64
)paren
(paren
id|tseq
(braket
l_int|15
)braket
)paren
op_lshift
l_int|16
)paren
op_or
(paren
(paren
r_uint64
)paren
(paren
id|tseq
(braket
l_int|20
)braket
)paren
op_lshift
l_int|24
)paren
op_or
(paren
(paren
r_uint64
)paren
(paren
id|tseq
(braket
l_int|25
)braket
)paren
op_lshift
l_int|32
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Read the i8042 real-time clock */
DECL|function|hp_sdc_rtc_read_rt
r_static
r_inline
r_int
id|hp_sdc_rtc_read_rt
c_func
(paren
r_struct
id|timeval
op_star
id|res
)paren
(brace
r_int64
id|raw
suffix:semicolon
r_uint32
id|tenms
suffix:semicolon
r_int
r_int
id|days
suffix:semicolon
id|raw
op_assign
id|hp_sdc_rtc_read_i8042timer
c_func
(paren
id|HP_SDC_CMD_LOAD_RT
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_assign
(paren
r_uint32
)paren
id|raw
op_amp
l_int|0xffffff
suffix:semicolon
id|days
op_assign
(paren
r_int
r_int
)paren
(paren
id|raw
op_rshift
l_int|24
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|res-&gt;tv_usec
op_assign
(paren
id|suseconds_t
)paren
(paren
id|tenms
op_mod
l_int|100
)paren
op_star
l_int|10000
suffix:semicolon
id|res-&gt;tv_sec
op_assign
(paren
id|time_t
)paren
(paren
id|tenms
op_div
l_int|100
)paren
op_plus
id|days
op_star
l_int|86400
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read the i8042 fast handshake timer */
DECL|function|hp_sdc_rtc_read_fhs
r_static
r_inline
r_int
id|hp_sdc_rtc_read_fhs
c_func
(paren
r_struct
id|timeval
op_star
id|res
)paren
(brace
r_uint64
id|raw
suffix:semicolon
r_int
r_int
id|tenms
suffix:semicolon
id|raw
op_assign
id|hp_sdc_rtc_read_i8042timer
c_func
(paren
id|HP_SDC_CMD_LOAD_FHS
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_assign
(paren
r_int
r_int
)paren
id|raw
op_amp
l_int|0xffff
suffix:semicolon
id|res-&gt;tv_usec
op_assign
(paren
id|suseconds_t
)paren
(paren
id|tenms
op_mod
l_int|100
)paren
op_star
l_int|10000
suffix:semicolon
id|res-&gt;tv_sec
op_assign
(paren
id|time_t
)paren
(paren
id|tenms
op_div
l_int|100
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read the i8042 match timer (a.k.a. alarm) */
DECL|function|hp_sdc_rtc_read_mt
r_static
r_inline
r_int
id|hp_sdc_rtc_read_mt
c_func
(paren
r_struct
id|timeval
op_star
id|res
)paren
(brace
r_int64
id|raw
suffix:semicolon
r_uint32
id|tenms
suffix:semicolon
id|raw
op_assign
id|hp_sdc_rtc_read_i8042timer
c_func
(paren
id|HP_SDC_CMD_LOAD_MT
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_assign
(paren
r_uint32
)paren
id|raw
op_amp
l_int|0xffffff
suffix:semicolon
id|res-&gt;tv_usec
op_assign
(paren
id|suseconds_t
)paren
(paren
id|tenms
op_mod
l_int|100
)paren
op_star
l_int|10000
suffix:semicolon
id|res-&gt;tv_sec
op_assign
(paren
id|time_t
)paren
(paren
id|tenms
op_div
l_int|100
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read the i8042 delay timer */
DECL|function|hp_sdc_rtc_read_dt
r_static
r_inline
r_int
id|hp_sdc_rtc_read_dt
c_func
(paren
r_struct
id|timeval
op_star
id|res
)paren
(brace
r_int64
id|raw
suffix:semicolon
r_uint32
id|tenms
suffix:semicolon
id|raw
op_assign
id|hp_sdc_rtc_read_i8042timer
c_func
(paren
id|HP_SDC_CMD_LOAD_DT
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_assign
(paren
r_uint32
)paren
id|raw
op_amp
l_int|0xffffff
suffix:semicolon
id|res-&gt;tv_usec
op_assign
(paren
id|suseconds_t
)paren
(paren
id|tenms
op_mod
l_int|100
)paren
op_star
l_int|10000
suffix:semicolon
id|res-&gt;tv_sec
op_assign
(paren
id|time_t
)paren
(paren
id|tenms
op_div
l_int|100
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Read the i8042 cycle timer (a.k.a. periodic) */
DECL|function|hp_sdc_rtc_read_ct
r_static
r_inline
r_int
id|hp_sdc_rtc_read_ct
c_func
(paren
r_struct
id|timeval
op_star
id|res
)paren
(brace
r_int64
id|raw
suffix:semicolon
r_uint32
id|tenms
suffix:semicolon
id|raw
op_assign
id|hp_sdc_rtc_read_i8042timer
c_func
(paren
id|HP_SDC_CMD_LOAD_CT
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|raw
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_assign
(paren
r_uint32
)paren
id|raw
op_amp
l_int|0xffffff
suffix:semicolon
id|res-&gt;tv_usec
op_assign
(paren
id|suseconds_t
)paren
(paren
id|tenms
op_mod
l_int|100
)paren
op_star
l_int|10000
suffix:semicolon
id|res-&gt;tv_sec
op_assign
(paren
id|time_t
)paren
(paren
id|tenms
op_div
l_int|100
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the i8042 real-time clock */
DECL|function|hp_sdc_rtc_set_rt
r_static
r_int
id|hp_sdc_rtc_set_rt
(paren
r_struct
id|timeval
op_star
id|setto
)paren
(brace
r_uint32
id|tenms
suffix:semicolon
r_int
r_int
id|days
suffix:semicolon
id|hp_sdc_transaction
id|t
suffix:semicolon
r_uint8
id|tseq
(braket
l_int|11
)braket
op_assign
(brace
id|HP_SDC_ACT_PRECMD
op_or
id|HP_SDC_ACT_DATAOUT
comma
id|HP_SDC_CMD_SET_RTMS
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|HP_SDC_ACT_PRECMD
op_or
id|HP_SDC_ACT_DATAOUT
comma
id|HP_SDC_CMD_SET_RTD
comma
l_int|2
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|t.endidx
op_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
l_int|0xffff
OL
id|setto-&gt;tv_sec
op_div
l_int|86400
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|days
op_assign
id|setto-&gt;tv_sec
op_div
l_int|86400
suffix:semicolon
r_if
c_cond
(paren
l_int|0xffff
OL
id|setto-&gt;tv_usec
op_div
l_int|1000000
op_div
l_int|86400
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|days
op_add_assign
(paren
(paren
id|setto-&gt;tv_sec
op_mod
l_int|86400
)paren
op_plus
id|setto-&gt;tv_usec
op_div
l_int|1000000
)paren
op_div
l_int|86400
suffix:semicolon
r_if
c_cond
(paren
id|days
OG
l_int|0xffff
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
l_int|0xffffff
OL
id|setto-&gt;tv_sec
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_assign
id|setto-&gt;tv_sec
op_star
l_int|100
suffix:semicolon
r_if
c_cond
(paren
l_int|0xffffff
OL
id|setto-&gt;tv_usec
op_div
l_int|10000
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_add_assign
id|setto-&gt;tv_usec
op_div
l_int|10000
suffix:semicolon
r_if
c_cond
(paren
id|tenms
OG
l_int|0xffffff
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tseq
(braket
l_int|3
)braket
op_assign
(paren
r_uint8
)paren
(paren
id|tenms
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tseq
(braket
l_int|4
)braket
op_assign
(paren
r_uint8
)paren
(paren
(paren
id|tenms
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tseq
(braket
l_int|5
)braket
op_assign
(paren
r_uint8
)paren
(paren
(paren
id|tenms
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tseq
(braket
l_int|9
)braket
op_assign
(paren
r_uint8
)paren
(paren
id|days
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tseq
(braket
l_int|10
)braket
op_assign
(paren
r_uint8
)paren
(paren
(paren
id|days
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|t.seq
op_assign
id|tseq
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|t
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the i8042 fast handshake timer */
DECL|function|hp_sdc_rtc_set_fhs
r_static
r_int
id|hp_sdc_rtc_set_fhs
(paren
r_struct
id|timeval
op_star
id|setto
)paren
(brace
r_uint32
id|tenms
suffix:semicolon
id|hp_sdc_transaction
id|t
suffix:semicolon
r_uint8
id|tseq
(braket
l_int|5
)braket
op_assign
(brace
id|HP_SDC_ACT_PRECMD
op_or
id|HP_SDC_ACT_DATAOUT
comma
id|HP_SDC_CMD_SET_FHS
comma
l_int|2
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|t.endidx
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
l_int|0xffff
OL
id|setto-&gt;tv_sec
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_assign
id|setto-&gt;tv_sec
op_star
l_int|100
suffix:semicolon
r_if
c_cond
(paren
l_int|0xffff
OL
id|setto-&gt;tv_usec
op_div
l_int|10000
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_add_assign
id|setto-&gt;tv_usec
op_div
l_int|10000
suffix:semicolon
r_if
c_cond
(paren
id|tenms
OG
l_int|0xffff
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tseq
(braket
l_int|3
)braket
op_assign
(paren
r_uint8
)paren
(paren
id|tenms
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tseq
(braket
l_int|4
)braket
op_assign
(paren
r_uint8
)paren
(paren
(paren
id|tenms
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|t.seq
op_assign
id|tseq
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|t
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the i8042 match timer (a.k.a. alarm) */
DECL|macro|hp_sdc_rtc_set_mt
mdefine_line|#define hp_sdc_rtc_set_mt (setto) &bslash;&n;&t;hp_sdc_rtc_set_i8042timer(setto, HP_SDC_CMD_SET_MT)
multiline_comment|/* Set the i8042 delay timer */
DECL|macro|hp_sdc_rtc_set_dt
mdefine_line|#define hp_sdc_rtc_set_dt (setto) &bslash;&n;&t;hp_sdc_rtc_set_i8042timer(setto, HP_SDC_CMD_SET_DT)
multiline_comment|/* Set the i8042 cycle timer (a.k.a. periodic) */
DECL|macro|hp_sdc_rtc_set_ct
mdefine_line|#define hp_sdc_rtc_set_ct (setto) &bslash;&n;&t;hp_sdc_rtc_set_i8042timer(setto, HP_SDC_CMD_SET_CT)
multiline_comment|/* Set one of the i8042 3-byte wide timers */
DECL|function|hp_sdc_rtc_set_i8042timer
r_static
r_int
id|hp_sdc_rtc_set_i8042timer
(paren
r_struct
id|timeval
op_star
id|setto
comma
r_uint8
id|setcmd
)paren
(brace
r_uint32
id|tenms
suffix:semicolon
id|hp_sdc_transaction
id|t
suffix:semicolon
r_uint8
id|tseq
(braket
l_int|6
)braket
op_assign
(brace
id|HP_SDC_ACT_PRECMD
op_or
id|HP_SDC_ACT_DATAOUT
comma
l_int|0
comma
l_int|3
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|t.endidx
op_assign
l_int|6
suffix:semicolon
r_if
c_cond
(paren
l_int|0xffffff
OL
id|setto-&gt;tv_sec
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_assign
id|setto-&gt;tv_sec
op_star
l_int|100
suffix:semicolon
r_if
c_cond
(paren
l_int|0xffffff
OL
id|setto-&gt;tv_usec
op_div
l_int|10000
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tenms
op_add_assign
id|setto-&gt;tv_usec
op_div
l_int|10000
suffix:semicolon
r_if
c_cond
(paren
id|tenms
OG
l_int|0xffffff
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|tseq
(braket
l_int|1
)braket
op_assign
id|setcmd
suffix:semicolon
id|tseq
(braket
l_int|3
)braket
op_assign
(paren
r_uint8
)paren
(paren
id|tenms
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tseq
(braket
l_int|4
)braket
op_assign
(paren
r_uint8
)paren
(paren
(paren
id|tenms
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|tseq
(braket
l_int|5
)braket
op_assign
(paren
r_uint8
)paren
(paren
(paren
id|tenms
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|t.seq
op_assign
id|tseq
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_enqueue_transaction
c_func
(paren
op_amp
id|t
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_llseek
r_static
id|loff_t
id|hp_sdc_rtc_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offset
comma
r_int
id|origin
)paren
(brace
r_return
op_minus
id|ESPIPE
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_read
r_static
id|ssize_t
id|hp_sdc_rtc_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|ssize_t
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
r_sizeof
(paren
r_int
r_int
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|retval
op_assign
id|put_user
c_func
(paren
l_int|68
comma
(paren
r_int
r_int
op_star
)paren
id|buf
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_poll
r_static
r_int
r_int
id|hp_sdc_rtc_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_int
r_int
id|l
suffix:semicolon
id|l
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|l
op_ne
l_int|0
)paren
r_return
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_open
r_static
r_int
id|hp_sdc_rtc_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_release
r_static
r_int
id|hp_sdc_rtc_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/* Turn off interrupts? */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|FASYNC
)paren
(brace
id|hp_sdc_rtc_fasync
(paren
op_minus
l_int|1
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_fasync
r_static
r_int
id|hp_sdc_rtc_fasync
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|on
)paren
(brace
r_return
id|fasync_helper
(paren
id|fd
comma
id|filp
comma
id|on
comma
op_amp
id|hp_sdc_rtc_async_queue
)paren
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_proc_output
r_static
r_int
id|hp_sdc_rtc_proc_output
(paren
r_char
op_star
id|buf
)paren
(brace
DECL|macro|YN
mdefine_line|#define YN(bit) (&quot;no&quot;)
DECL|macro|NY
mdefine_line|#define NY(bit) (&quot;yes&quot;)
r_char
op_star
id|p
suffix:semicolon
r_struct
id|rtc_time
id|tm
suffix:semicolon
r_struct
id|timeval
id|tv
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tm
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
suffix:semicolon
id|p
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_rtc_read_bbrtc
c_func
(paren
op_amp
id|tm
)paren
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;BBRTC&bslash;t&bslash;t: READ FAILED!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;rtc_time&bslash;t: %02d:%02d:%02d&bslash;n&quot;
l_string|&quot;rtc_date&bslash;t: %04d-%02d-%02d&bslash;n&quot;
l_string|&quot;rtc_epoch&bslash;t: %04lu&bslash;n&quot;
comma
id|tm.tm_hour
comma
id|tm.tm_min
comma
id|tm.tm_sec
comma
id|tm.tm_year
op_plus
l_int|1900
comma
id|tm.tm_mon
op_plus
l_int|1
comma
id|tm.tm_mday
comma
id|epoch
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp_sdc_rtc_read_rt
c_func
(paren
op_amp
id|tv
)paren
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;i8042 rtc&bslash;t: READ FAILED!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;i8042 rtc&bslash;t: %ld.%02d seconds&bslash;n&quot;
comma
id|tv.tv_sec
comma
id|tv.tv_usec
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp_sdc_rtc_read_fhs
c_func
(paren
op_amp
id|tv
)paren
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;handshake&bslash;t: READ FAILED!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;handshake&bslash;t: %ld.%02d seconds&bslash;n&quot;
comma
id|tv.tv_sec
comma
id|tv.tv_usec
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp_sdc_rtc_read_mt
c_func
(paren
op_amp
id|tv
)paren
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;alarm&bslash;t&bslash;t: READ FAILED!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;alarm&bslash;t&bslash;t: %ld.%02d seconds&bslash;n&quot;
comma
id|tv.tv_sec
comma
id|tv.tv_usec
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp_sdc_rtc_read_dt
c_func
(paren
op_amp
id|tv
)paren
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;delay&bslash;t&bslash;t: READ FAILED!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;delay&bslash;t&bslash;t: %ld.%02d seconds&bslash;n&quot;
comma
id|tv.tv_sec
comma
id|tv.tv_usec
op_div
l_int|1000
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp_sdc_rtc_read_ct
c_func
(paren
op_amp
id|tv
)paren
)paren
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;periodic&bslash;t: READ FAILED!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;periodic&bslash;t: %ld.%02d seconds&bslash;n&quot;
comma
id|tv.tv_sec
comma
id|tv.tv_usec
op_div
l_int|1000
)paren
suffix:semicolon
)brace
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;DST_enable&bslash;t: %s&bslash;n&quot;
l_string|&quot;BCD&bslash;t&bslash;t: %s&bslash;n&quot;
l_string|&quot;24hr&bslash;t&bslash;t: %s&bslash;n&quot;
l_string|&quot;square_wave&bslash;t: %s&bslash;n&quot;
l_string|&quot;alarm_IRQ&bslash;t: %s&bslash;n&quot;
l_string|&quot;update_IRQ&bslash;t: %s&bslash;n&quot;
l_string|&quot;periodic_IRQ&bslash;t: %s&bslash;n&quot;
l_string|&quot;periodic_freq&bslash;t: %ld&bslash;n&quot;
l_string|&quot;batt_status&bslash;t: %s&bslash;n&quot;
comma
id|YN
c_func
(paren
id|RTC_DST_EN
)paren
comma
id|NY
c_func
(paren
id|RTC_DM_BINARY
)paren
comma
id|YN
c_func
(paren
id|RTC_24H
)paren
comma
id|YN
c_func
(paren
id|RTC_SQWE
)paren
comma
id|YN
c_func
(paren
id|RTC_AIE
)paren
comma
id|YN
c_func
(paren
id|RTC_UIE
)paren
comma
id|YN
c_func
(paren
id|RTC_PIE
)paren
comma
l_int|1UL
comma
l_int|1
ques
c_cond
l_string|&quot;okay&quot;
suffix:colon
l_string|&quot;dead&quot;
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buf
suffix:semicolon
DECL|macro|YN
macro_line|#undef YN
DECL|macro|NY
macro_line|#undef NY
)brace
DECL|function|hp_sdc_rtc_read_proc
r_static
r_int
id|hp_sdc_rtc_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
id|hp_sdc_rtc_proc_output
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
id|off
op_plus
id|count
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
id|off
suffix:semicolon
id|len
op_sub_assign
id|off
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|count
)paren
id|len
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_ioctl
r_static
r_int
id|hp_sdc_rtc_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
macro_line|#if 1
r_return
op_minus
id|EINVAL
suffix:semicolon
macro_line|#else
r_struct
id|rtc_time
id|wtime
suffix:semicolon
r_struct
id|timeval
id|ttime
suffix:semicolon
r_int
id|use_wtime
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This needs major work. */
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RTC_AIE_OFF
suffix:colon
multiline_comment|/* Mask alarm int. enab. bit    */
r_case
id|RTC_AIE_ON
suffix:colon
multiline_comment|/* Allow alarm interrupts.      */
r_case
id|RTC_PIE_OFF
suffix:colon
multiline_comment|/* Mask periodic int. enab. bit */
r_case
id|RTC_PIE_ON
suffix:colon
multiline_comment|/* Allow periodic ints          */
r_case
id|RTC_UIE_ON
suffix:colon
multiline_comment|/* Allow ints for RTC updates.  */
r_case
id|RTC_UIE_OFF
suffix:colon
multiline_comment|/* Allow ints for RTC updates.  */
(brace
multiline_comment|/* We cannot mask individual user timers and we&n;&t;&t;   cannot tell them apart when they occur, so it &n;&t;&t;   would be disingenuous to succeed these IOCTLs */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_case
id|RTC_ALM_READ
suffix:colon
multiline_comment|/* Read the present alarm time */
(brace
r_if
c_cond
(paren
id|hp_sdc_rtc_read_mt
c_func
(paren
op_amp
id|ttime
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_rtc_read_bbrtc
c_func
(paren
op_amp
id|wtime
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|wtime.tm_hour
op_assign
id|ttime.tv_sec
op_div
l_int|3600
suffix:semicolon
id|ttime.tv_sec
op_mod_assign
l_int|3600
suffix:semicolon
id|wtime.tm_min
op_assign
id|ttime.tv_sec
op_div
l_int|60
suffix:semicolon
id|ttime.tv_sec
op_mod_assign
l_int|60
suffix:semicolon
id|wtime.tm_sec
op_assign
id|ttime.tv_sec
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|RTC_IRQP_READ
suffix:colon
multiline_comment|/* Read the periodic IRQ rate.  */
(brace
r_return
id|put_user
c_func
(paren
id|hp_sdc_rtc_freq
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_case
id|RTC_IRQP_SET
suffix:colon
multiline_comment|/* Set periodic IRQ rate.       */
(brace
multiline_comment|/* &n;                 * The max we can do is 100Hz.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|arg
OL
l_int|1
)paren
op_logical_or
(paren
id|arg
OG
l_int|100
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ttime.tv_sec
op_assign
l_int|0
suffix:semicolon
id|ttime.tv_usec
op_assign
l_int|1000000
op_div
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_rtc_set_ct
c_func
(paren
op_amp
id|ttime
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|hp_sdc_rtc_freq
op_assign
id|arg
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_ALM_SET
suffix:colon
multiline_comment|/* Store a time into the alarm */
(brace
multiline_comment|/*&n;                 * This expects a struct hp_sdc_rtc_time. Writing 0xff means&n;                 * &quot;don&squot;t care&quot; or &quot;match all&quot; for PC timers.  The HP SDC&n;&t;&t; * does not support that perk, but it could be emulated fairly&n;&t;&t; * easily.  Only the tm_hour, tm_min and tm_sec are used.&n;&t;&t; * We could do it with 10ms accuracy with the HP SDC, if the &n;&t;&t; * rtc interface left us a way to do that.&n;                 */
r_struct
id|hp_sdc_rtc_time
id|alm_tm
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|alm_tm
comma
(paren
r_struct
id|hp_sdc_rtc_time
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|hp_sdc_rtc_time
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|alm_tm.tm_hour
OG
l_int|23
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|alm_tm.tm_min
OG
l_int|59
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|alm_tm.tm_sec
OG
l_int|59
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ttime.sec
op_assign
id|alm_tm.tm_hour
op_star
l_int|3600
op_plus
id|alm_tm.tm_min
op_star
l_int|60
op_plus
id|alm_tm.tm_sec
suffix:semicolon
id|ttime.usec
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hp_sdc_rtc_set_mt
c_func
(paren
op_amp
id|ttime
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_RD_TIME
suffix:colon
multiline_comment|/* Read the time/date from RTC  */
(brace
r_if
c_cond
(paren
id|hp_sdc_rtc_read_bbrtc
c_func
(paren
op_amp
id|wtime
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|RTC_SET_TIME
suffix:colon
multiline_comment|/* Set the RTC */
(brace
r_struct
id|rtc_time
id|hp_sdc_rtc_tm
suffix:semicolon
r_int
r_char
id|mon
comma
id|day
comma
id|hrs
comma
id|min
comma
id|sec
comma
id|leap_yr
suffix:semicolon
r_int
r_int
id|yrs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|hp_sdc_rtc_tm
comma
(paren
r_struct
id|rtc_time
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|yrs
op_assign
id|hp_sdc_rtc_tm.tm_year
op_plus
l_int|1900
suffix:semicolon
id|mon
op_assign
id|hp_sdc_rtc_tm.tm_mon
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* tm_mon starts at zero */
id|day
op_assign
id|hp_sdc_rtc_tm.tm_mday
suffix:semicolon
id|hrs
op_assign
id|hp_sdc_rtc_tm.tm_hour
suffix:semicolon
id|min
op_assign
id|hp_sdc_rtc_tm.tm_min
suffix:semicolon
id|sec
op_assign
id|hp_sdc_rtc_tm.tm_sec
suffix:semicolon
r_if
c_cond
(paren
id|yrs
OL
l_int|1970
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|leap_yr
op_assign
(paren
(paren
op_logical_neg
(paren
id|yrs
op_mod
l_int|4
)paren
op_logical_and
(paren
id|yrs
op_mod
l_int|100
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|yrs
op_mod
l_int|400
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mon
OG
l_int|12
)paren
op_logical_or
(paren
id|day
op_eq
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|day
OG
(paren
id|days_in_mo
(braket
id|mon
)braket
op_plus
(paren
(paren
id|mon
op_eq
l_int|2
)paren
op_logical_and
id|leap_yr
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hrs
op_ge
l_int|24
)paren
op_logical_or
(paren
id|min
op_ge
l_int|60
)paren
op_logical_or
(paren
id|sec
op_ge
l_int|60
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|yrs
op_sub_assign
id|eH
)paren
OG
l_int|255
)paren
multiline_comment|/* They are unsigned */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_EPOCH_READ
suffix:colon
multiline_comment|/* Read the epoch.      */
(brace
r_return
id|put_user
(paren
id|epoch
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_case
id|RTC_EPOCH_SET
suffix:colon
multiline_comment|/* Set the epoch.       */
(brace
multiline_comment|/* &n;                 * There were no RTC clocks before 1900.&n;                 */
r_if
c_cond
(paren
id|arg
OL
l_int|1900
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|epoch
op_assign
id|arg
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|wtime
comma
r_sizeof
id|wtime
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|hp_sdc_rtc_fops
r_static
r_struct
id|file_operations
id|hp_sdc_rtc_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|hp_sdc_rtc_llseek
comma
dot
id|read
op_assign
id|hp_sdc_rtc_read
comma
dot
id|poll
op_assign
id|hp_sdc_rtc_poll
comma
dot
id|ioctl
op_assign
id|hp_sdc_rtc_ioctl
comma
dot
id|open
op_assign
id|hp_sdc_rtc_open
comma
dot
id|release
op_assign
id|hp_sdc_rtc_release
comma
dot
id|fasync
op_assign
id|hp_sdc_rtc_fasync
comma
)brace
suffix:semicolon
DECL|variable|hp_sdc_rtc_dev
r_static
r_struct
id|miscdevice
id|hp_sdc_rtc_dev
op_assign
(brace
dot
id|minor
op_assign
id|RTC_MINOR
comma
dot
id|name
op_assign
l_string|&quot;rtc_HIL&quot;
comma
dot
id|fops
op_assign
op_amp
id|hp_sdc_rtc_fops
)brace
suffix:semicolon
DECL|function|hp_sdc_rtc_init
r_static
r_int
id|__init
id|hp_sdc_rtc_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|i8042tregs
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|hp_sdc_request_timer_irq
c_func
(paren
op_amp
id|hp_sdc_rtc_isr
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
id|misc_register
c_func
(paren
op_amp
id|hp_sdc_rtc_dev
)paren
suffix:semicolon
id|create_proc_read_entry
(paren
l_string|&quot;driver/rtc&quot;
comma
l_int|0
comma
l_int|0
comma
id|hp_sdc_rtc_read_proc
comma
l_int|NULL
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HP i8042 SDC + MSM-58321 RTC support loaded &quot;
l_string|&quot;(RTC v &quot;
id|RTC_VERSION
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp_sdc_rtc_exit
r_static
r_void
id|__exit
id|hp_sdc_rtc_exit
c_func
(paren
r_void
)paren
(brace
id|remove_proc_entry
(paren
l_string|&quot;driver/rtc&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|hp_sdc_rtc_dev
)paren
suffix:semicolon
id|hp_sdc_release_timer_irq
c_func
(paren
id|hp_sdc_rtc_isr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HP i8042 SDC + MSM-58321 RTC support unloaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|hp_sdc_rtc_init
id|module_init
c_func
(paren
id|hp_sdc_rtc_init
)paren
suffix:semicolon
DECL|variable|hp_sdc_rtc_exit
id|module_exit
c_func
(paren
id|hp_sdc_rtc_exit
)paren
suffix:semicolon
eof
