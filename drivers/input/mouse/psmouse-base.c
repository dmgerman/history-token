multiline_comment|/*&n; * PS/2 mouse driver&n; *&n; * Copyright (c) 1999-2002 Vojtech Pavlik&n; * Copyright (c) 2003-2004 Dmitry Torokhov&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License version 2 as published by&n; * the Free Software Foundation.&n; */
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/serio.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/libps2.h&gt;
macro_line|#include &quot;psmouse.h&quot;
macro_line|#include &quot;synaptics.h&quot;
macro_line|#include &quot;logips2pp.h&quot;
macro_line|#include &quot;alps.h&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC&t;&quot;PS/2 mouse driver&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Vojtech Pavlik &lt;vojtech@suse.cz&gt;&quot;
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|psmouse_proto
r_static
r_char
op_star
id|psmouse_proto
suffix:semicolon
DECL|variable|psmouse_max_proto
r_static
r_int
r_int
id|psmouse_max_proto
op_assign
op_minus
l_int|1U
suffix:semicolon
id|module_param_named
c_func
(paren
id|proto
comma
id|psmouse_proto
comma
id|charp
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|proto
comma
l_string|&quot;Highest protocol extension to probe (bare, imps, exps). Useful for KVM switches.&quot;
)paren
suffix:semicolon
DECL|variable|psmouse_resolution
r_static
r_int
r_int
id|psmouse_resolution
op_assign
l_int|200
suffix:semicolon
id|module_param_named
c_func
(paren
id|resolution
comma
id|psmouse_resolution
comma
id|uint
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|resolution
comma
l_string|&quot;Resolution, in dpi.&quot;
)paren
suffix:semicolon
DECL|variable|psmouse_rate
r_static
r_int
r_int
id|psmouse_rate
op_assign
l_int|100
suffix:semicolon
id|module_param_named
c_func
(paren
id|rate
comma
id|psmouse_rate
comma
id|uint
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|rate
comma
l_string|&quot;Report rate, in reports per second.&quot;
)paren
suffix:semicolon
DECL|variable|psmouse_smartscroll
r_static
r_int
r_int
id|psmouse_smartscroll
op_assign
l_int|1
suffix:semicolon
id|module_param_named
c_func
(paren
id|smartscroll
comma
id|psmouse_smartscroll
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|smartscroll
comma
l_string|&quot;Logitech Smartscroll autorepeat, 1 = enabled (default), 0 = disabled.&quot;
)paren
suffix:semicolon
DECL|variable|psmouse_resetafter
r_static
r_int
r_int
id|psmouse_resetafter
suffix:semicolon
id|module_param_named
c_func
(paren
id|resetafter
comma
id|psmouse_resetafter
comma
id|uint
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|resetafter
comma
l_string|&quot;Reset device after so many bad packets (0 = never).&quot;
)paren
suffix:semicolon
DECL|variable|rate
id|PSMOUSE_DEFINE_ATTR
c_func
(paren
id|rate
)paren
suffix:semicolon
DECL|variable|resolution
id|PSMOUSE_DEFINE_ATTR
c_func
(paren
id|resolution
)paren
suffix:semicolon
DECL|variable|resetafter
id|PSMOUSE_DEFINE_ATTR
c_func
(paren
id|resetafter
)paren
suffix:semicolon
id|__obsolete_setup
c_func
(paren
l_string|&quot;psmouse_noext&quot;
)paren
suffix:semicolon
id|__obsolete_setup
c_func
(paren
l_string|&quot;psmouse_resolution=&quot;
)paren
suffix:semicolon
id|__obsolete_setup
c_func
(paren
l_string|&quot;psmouse_smartscroll=&quot;
)paren
suffix:semicolon
id|__obsolete_setup
c_func
(paren
l_string|&quot;psmouse_resetafter=&quot;
)paren
suffix:semicolon
id|__obsolete_setup
c_func
(paren
l_string|&quot;psmouse_rate=&quot;
)paren
suffix:semicolon
DECL|variable|psmouse_protocols
r_static
r_char
op_star
id|psmouse_protocols
(braket
)braket
op_assign
(brace
l_string|&quot;None&quot;
comma
l_string|&quot;PS/2&quot;
comma
l_string|&quot;PS2++&quot;
comma
l_string|&quot;ThinkPS/2&quot;
comma
l_string|&quot;GenPS/2&quot;
comma
l_string|&quot;ImPS/2&quot;
comma
l_string|&quot;ImExPS/2&quot;
comma
l_string|&quot;SynPS/2&quot;
comma
l_string|&quot;AlpsPS/2&quot;
)brace
suffix:semicolon
multiline_comment|/*&n; * psmouse_process_byte() analyzes the PS/2 data stream and reports&n; * relevant events to the input module once full packet has arrived.&n; */
DECL|function|psmouse_process_byte
r_static
id|psmouse_ret_t
id|psmouse_process_byte
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|input_dev
op_star
id|dev
op_assign
op_amp
id|psmouse-&gt;dev
suffix:semicolon
r_int
r_char
op_star
id|packet
op_assign
id|psmouse-&gt;packet
suffix:semicolon
r_if
c_cond
(paren
id|psmouse-&gt;pktcnt
OL
id|psmouse-&gt;pktsize
)paren
r_return
id|PSMOUSE_GOOD_DATA
suffix:semicolon
multiline_comment|/*&n; * Full packet accumulated, process it&n; */
id|input_regs
c_func
(paren
id|dev
comma
id|regs
)paren
suffix:semicolon
multiline_comment|/*&n; * Scroll wheel on IntelliMice, scroll buttons on NetMice&n; */
r_if
c_cond
(paren
id|psmouse-&gt;type
op_eq
id|PSMOUSE_IMPS
op_logical_or
id|psmouse-&gt;type
op_eq
id|PSMOUSE_GENPS
)paren
id|input_report_rel
c_func
(paren
id|dev
comma
id|REL_WHEEL
comma
op_minus
(paren
r_int
r_char
)paren
id|packet
(braket
l_int|3
)braket
)paren
suffix:semicolon
multiline_comment|/*&n; * Scroll wheel and buttons on IntelliMouse Explorer&n; */
r_if
c_cond
(paren
id|psmouse-&gt;type
op_eq
id|PSMOUSE_IMEX
)paren
(brace
id|input_report_rel
c_func
(paren
id|dev
comma
id|REL_WHEEL
comma
(paren
r_int
)paren
(paren
id|packet
(braket
l_int|3
)braket
op_amp
l_int|8
)paren
op_minus
(paren
r_int
)paren
(paren
id|packet
(braket
l_int|3
)braket
op_amp
l_int|7
)paren
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_SIDE
comma
(paren
id|packet
(braket
l_int|3
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_EXTRA
comma
(paren
id|packet
(braket
l_int|3
)braket
op_rshift
l_int|5
)paren
op_amp
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Extra buttons on Genius NewNet 3D&n; */
r_if
c_cond
(paren
id|psmouse-&gt;type
op_eq
id|PSMOUSE_GENPS
)paren
(brace
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_SIDE
comma
(paren
id|packet
(braket
l_int|0
)braket
op_rshift
l_int|6
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_EXTRA
comma
(paren
id|packet
(braket
l_int|0
)braket
op_rshift
l_int|7
)paren
op_amp
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Extra button on ThinkingMouse&n; */
r_if
c_cond
(paren
id|psmouse-&gt;type
op_eq
id|PSMOUSE_THINKPS
)paren
(brace
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_EXTRA
comma
(paren
id|packet
(braket
l_int|0
)braket
op_rshift
l_int|3
)paren
op_amp
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Without this bit of weirdness moving up gives wildly high Y changes. */
id|packet
(braket
l_int|1
)braket
op_or_assign
(paren
id|packet
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
op_lshift
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Generic PS/2 Mouse&n; */
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_LEFT
comma
id|packet
(braket
l_int|0
)braket
op_amp
l_int|1
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_MIDDLE
comma
(paren
id|packet
(braket
l_int|0
)braket
op_rshift
l_int|2
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_RIGHT
comma
(paren
id|packet
(braket
l_int|0
)braket
op_rshift
l_int|1
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|input_report_rel
c_func
(paren
id|dev
comma
id|REL_X
comma
id|packet
(braket
l_int|1
)braket
ques
c_cond
(paren
r_int
)paren
id|packet
(braket
l_int|1
)braket
op_minus
(paren
r_int
)paren
(paren
(paren
id|packet
(braket
l_int|0
)braket
op_lshift
l_int|4
)paren
op_amp
l_int|0x100
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|input_report_rel
c_func
(paren
id|dev
comma
id|REL_Y
comma
id|packet
(braket
l_int|2
)braket
ques
c_cond
(paren
r_int
)paren
(paren
(paren
id|packet
(braket
l_int|0
)braket
op_lshift
l_int|3
)paren
op_amp
l_int|0x100
)paren
op_minus
(paren
r_int
)paren
id|packet
(braket
l_int|2
)braket
suffix:colon
l_int|0
)paren
suffix:semicolon
id|input_sync
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|PSMOUSE_FULL_PACKET
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_interrupt() handles incoming characters, either gathering them into&n; * packets or passing them to the command routine as command output.&n; */
DECL|function|psmouse_interrupt
r_static
id|irqreturn_t
id|psmouse_interrupt
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_int
r_char
id|data
comma
r_int
r_int
id|flags
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|psmouse
op_star
id|psmouse
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
id|psmouse_ret_t
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|psmouse-&gt;state
op_eq
id|PSMOUSE_IGNORE
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|SERIO_PARITY
op_or
id|SERIO_TIMEOUT
)paren
)paren
(brace
r_if
c_cond
(paren
id|psmouse-&gt;state
op_eq
id|PSMOUSE_ACTIVATED
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;psmouse.c: bad data from KBC -%s%s&bslash;n&quot;
comma
id|flags
op_amp
id|SERIO_TIMEOUT
ques
c_cond
l_string|&quot; timeout&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|flags
op_amp
id|SERIO_PARITY
ques
c_cond
l_string|&quot; bad parity&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|ps2_cmd_aborted
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|psmouse-&gt;ps2dev.flags
op_amp
id|PS2_FLAG_ACK
)paren
)paren
r_if
c_cond
(paren
id|ps2_handle_ack
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
id|data
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|psmouse-&gt;ps2dev.flags
op_amp
id|PS2_FLAG_CMD
)paren
)paren
r_if
c_cond
(paren
id|ps2_handle_response
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
id|data
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|psmouse-&gt;state
op_eq
id|PSMOUSE_INITIALIZING
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|psmouse-&gt;state
op_eq
id|PSMOUSE_ACTIVATED
op_logical_and
id|psmouse-&gt;pktcnt
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|psmouse-&gt;last
op_plus
id|HZ
op_div
l_int|2
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;psmouse.c: %s at %s lost synchronization, throwing %d bytes away.&bslash;n&quot;
comma
id|psmouse-&gt;name
comma
id|psmouse-&gt;phys
comma
id|psmouse-&gt;pktcnt
)paren
suffix:semicolon
id|psmouse-&gt;pktcnt
op_assign
l_int|0
suffix:semicolon
)brace
id|psmouse-&gt;last
op_assign
id|jiffies
suffix:semicolon
id|psmouse-&gt;packet
(braket
id|psmouse-&gt;pktcnt
op_increment
)braket
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|psmouse-&gt;packet
(braket
l_int|0
)braket
op_eq
id|PSMOUSE_RET_BAT
)paren
(brace
r_if
c_cond
(paren
id|psmouse-&gt;pktcnt
op_eq
l_int|1
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|psmouse-&gt;pktcnt
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|psmouse-&gt;packet
(braket
l_int|1
)braket
op_eq
id|PSMOUSE_RET_ID
)paren
(brace
id|psmouse-&gt;state
op_assign
id|PSMOUSE_IGNORE
suffix:semicolon
id|serio_reconnect
c_func
(paren
id|serio
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|psmouse-&gt;type
op_eq
id|PSMOUSE_SYNAPTICS
)paren
(brace
multiline_comment|/* neither 0xAA nor 0x00 are valid first bytes&n;&t;&t;&t;&t; * for a packet in absolute mode&n;&t;&t;&t;&t; */
id|psmouse-&gt;pktcnt
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
id|rc
op_assign
id|psmouse
op_member_access_from_pointer
id|protocol_handler
c_func
(paren
id|psmouse
comma
id|regs
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|rc
)paren
(brace
r_case
id|PSMOUSE_BAD_DATA
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;psmouse.c: %s at %s lost sync at byte %d&bslash;n&quot;
comma
id|psmouse-&gt;name
comma
id|psmouse-&gt;phys
comma
id|psmouse-&gt;pktcnt
)paren
suffix:semicolon
id|psmouse-&gt;pktcnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|psmouse-&gt;out_of_sync
op_eq
id|psmouse-&gt;resetafter
)paren
(brace
id|psmouse-&gt;state
op_assign
id|PSMOUSE_IGNORE
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;psmouse.c: issuing reconnect request&bslash;n&quot;
)paren
suffix:semicolon
id|serio_reconnect
c_func
(paren
id|psmouse-&gt;ps2dev.serio
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PSMOUSE_FULL_PACKET
suffix:colon
id|psmouse-&gt;pktcnt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|psmouse-&gt;out_of_sync
)paren
(brace
id|psmouse-&gt;out_of_sync
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;psmouse.c: %s at %s - driver resynched.&bslash;n&quot;
comma
id|psmouse-&gt;name
comma
id|psmouse-&gt;phys
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|PSMOUSE_GOOD_DATA
suffix:colon
r_break
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_sliced_command() sends an extended PS/2 command to the mouse&n; * using sliced syntax, understood by advanced devices, such as Logitech&n; * or Synaptics touchpads. The command is encoded as:&n; * 0xE6 0xE8 rr 0xE8 ss 0xE8 tt 0xE8 uu where (rr*64)+(ss*16)+(tt*4)+uu&n; * is the command.&n; */
DECL|function|psmouse_sliced_command
r_int
id|psmouse_sliced_command
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
r_char
id|command
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_SETSCALE11
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|6
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_sub_assign
l_int|2
)paren
(brace
r_int
r_char
id|d
op_assign
(paren
id|command
op_rshift
id|i
)paren
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
op_amp
id|d
comma
id|PSMOUSE_CMD_SETRES
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_reset() resets the mouse into power-on state.&n; */
DECL|function|psmouse_reset
r_int
id|psmouse_reset
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
)paren
(brace
r_int
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_RESET_BAT
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
id|PSMOUSE_RET_BAT
op_logical_and
id|param
(braket
l_int|1
)braket
op_ne
id|PSMOUSE_RET_ID
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Genius NetMouse magic init.&n; */
DECL|function|genius_detect
r_static
r_int
id|genius_detect
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
id|set_properties
)paren
(brace
r_struct
id|ps2dev
op_star
id|ps2dev
op_assign
op_amp
id|psmouse-&gt;ps2dev
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|4
)braket
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|3
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRES
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_SETSCALE11
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_SETSCALE11
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_SETSCALE11
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_GETINFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
l_int|0x00
op_logical_or
id|param
(braket
l_int|1
)braket
op_ne
l_int|0x33
op_logical_or
id|param
(braket
l_int|2
)braket
op_ne
l_int|0x55
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|set_properties
)paren
(brace
id|set_bit
c_func
(paren
id|BTN_EXTRA
comma
id|psmouse-&gt;dev.keybit
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|BTN_SIDE
comma
id|psmouse-&gt;dev.keybit
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|REL_WHEEL
comma
id|psmouse-&gt;dev.relbit
)paren
suffix:semicolon
id|psmouse-&gt;vendor
op_assign
l_string|&quot;Genius&quot;
suffix:semicolon
id|psmouse-&gt;name
op_assign
l_string|&quot;Wheel Mouse&quot;
suffix:semicolon
id|psmouse-&gt;pktsize
op_assign
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * IntelliMouse magic init.&n; */
DECL|function|intellimouse_detect
r_static
r_int
id|intellimouse_detect
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
id|set_properties
)paren
(brace
r_struct
id|ps2dev
op_star
id|ps2dev
op_assign
op_amp
id|psmouse-&gt;ps2dev
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|200
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|100
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|80
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_GETID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
l_int|3
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|set_properties
)paren
(brace
id|set_bit
c_func
(paren
id|REL_WHEEL
comma
id|psmouse-&gt;dev.relbit
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psmouse-&gt;vendor
)paren
id|psmouse-&gt;vendor
op_assign
l_string|&quot;Generic&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psmouse-&gt;name
)paren
id|psmouse-&gt;name
op_assign
l_string|&quot;Wheel Mouse&quot;
suffix:semicolon
id|psmouse-&gt;pktsize
op_assign
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Try IntelliMouse/Explorer magic init.&n; */
DECL|function|im_explorer_detect
r_static
r_int
id|im_explorer_detect
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
id|set_properties
)paren
(brace
r_struct
id|ps2dev
op_star
id|ps2dev
op_assign
op_amp
id|psmouse-&gt;ps2dev
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
id|intellimouse_detect
c_func
(paren
id|psmouse
comma
l_int|0
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|200
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|200
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|80
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_GETID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
l_int|4
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|set_properties
)paren
(brace
id|set_bit
c_func
(paren
id|REL_WHEEL
comma
id|psmouse-&gt;dev.relbit
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|BTN_SIDE
comma
id|psmouse-&gt;dev.keybit
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|BTN_EXTRA
comma
id|psmouse-&gt;dev.keybit
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psmouse-&gt;vendor
)paren
id|psmouse-&gt;vendor
op_assign
l_string|&quot;Generic&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psmouse-&gt;name
)paren
id|psmouse-&gt;name
op_assign
l_string|&quot;Explorer Mouse&quot;
suffix:semicolon
id|psmouse-&gt;pktsize
op_assign
l_int|4
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Kensington ThinkingMouse / ExpertMouse magic init.&n; */
DECL|function|thinking_detect
r_static
r_int
id|thinking_detect
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
id|set_properties
)paren
(brace
r_struct
id|ps2dev
op_star
id|ps2dev
op_assign
op_amp
id|psmouse-&gt;ps2dev
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
r_int
r_char
id|seq
(braket
)braket
op_assign
(brace
l_int|20
comma
l_int|60
comma
l_int|40
comma
l_int|20
comma
l_int|20
comma
l_int|60
comma
l_int|40
comma
l_int|20
comma
l_int|20
comma
l_int|0
)brace
suffix:semicolon
r_int
id|i
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|10
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_SETRES
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|seq
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|seq
op_plus
id|i
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_GETID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
l_int|2
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|set_properties
)paren
(brace
id|set_bit
c_func
(paren
id|BTN_EXTRA
comma
id|psmouse-&gt;dev.keybit
)paren
suffix:semicolon
id|psmouse-&gt;vendor
op_assign
l_string|&quot;Kensington&quot;
suffix:semicolon
id|psmouse-&gt;name
op_assign
l_string|&quot;ThinkingMouse&quot;
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Bare PS/2 protocol &quot;detection&quot;. Always succeeds.&n; */
DECL|function|ps2bare_detect
r_static
r_int
id|ps2bare_detect
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
id|set_properties
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|psmouse-&gt;vendor
)paren
id|psmouse-&gt;vendor
op_assign
l_string|&quot;Generic&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|psmouse-&gt;name
)paren
id|psmouse-&gt;name
op_assign
l_string|&quot;Mouse&quot;
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_extensions() probes for any extensions to the basic PS/2 protocol&n; * the mouse may have.&n; */
DECL|function|psmouse_extensions
r_static
r_int
id|psmouse_extensions
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
r_int
id|max_proto
comma
r_int
id|set_properties
)paren
(brace
r_int
id|synaptics_hardware
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Try Kensington ThinkingMouse (we try first, because synaptics probe&n; * upsets the thinkingmouse).&n; */
r_if
c_cond
(paren
id|max_proto
OG
id|PSMOUSE_PS2
op_logical_and
id|thinking_detect
c_func
(paren
id|psmouse
comma
id|set_properties
)paren
op_eq
l_int|0
)paren
r_return
id|PSMOUSE_THINKPS
suffix:semicolon
multiline_comment|/*&n; * Try Synaptics TouchPad&n; */
r_if
c_cond
(paren
id|max_proto
OG
id|PSMOUSE_PS2
op_logical_and
id|synaptics_detect
c_func
(paren
id|psmouse
comma
id|set_properties
)paren
op_eq
l_int|0
)paren
(brace
id|synaptics_hardware
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|max_proto
OG
id|PSMOUSE_IMEX
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|set_properties
op_logical_or
id|synaptics_init
c_func
(paren
id|psmouse
)paren
op_eq
l_int|0
)paren
r_return
id|PSMOUSE_SYNAPTICS
suffix:semicolon
multiline_comment|/*&n; * Some Synaptics touchpads can emulate extended protocols (like IMPS/2).&n; * Unfortunately Logitech/Genius probes confuse some firmware versions so&n; * we&squot;ll have to skip them.&n; */
id|max_proto
op_assign
id|PSMOUSE_IMEX
suffix:semicolon
)brace
multiline_comment|/*&n; * Make sure that touchpad is in relative mode, gestures (taps) are enabled&n; */
id|synaptics_reset
c_func
(paren
id|psmouse
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Try ALPS TouchPad&n; */
r_if
c_cond
(paren
id|max_proto
OG
id|PSMOUSE_IMEX
)paren
(brace
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_RESET_DIS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alps_detect
c_func
(paren
id|psmouse
comma
id|set_properties
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|set_properties
op_logical_or
id|alps_init
c_func
(paren
id|psmouse
)paren
op_eq
l_int|0
)paren
r_return
id|PSMOUSE_ALPS
suffix:semicolon
multiline_comment|/*&n; * Init failed, try basic relative protocols&n; */
id|max_proto
op_assign
id|PSMOUSE_IMEX
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|max_proto
OG
id|PSMOUSE_IMEX
op_logical_and
id|genius_detect
c_func
(paren
id|psmouse
comma
id|set_properties
)paren
op_eq
l_int|0
)paren
r_return
id|PSMOUSE_GENPS
suffix:semicolon
r_if
c_cond
(paren
id|max_proto
OG
id|PSMOUSE_IMEX
op_logical_and
id|ps2pp_init
c_func
(paren
id|psmouse
comma
id|set_properties
)paren
op_eq
l_int|0
)paren
r_return
id|PSMOUSE_PS2PP
suffix:semicolon
multiline_comment|/*&n; * Reset to defaults in case the device got confused by extended&n; * protocol probes.&n; */
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_RESET_DIS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_proto
op_ge
id|PSMOUSE_IMEX
op_logical_and
id|im_explorer_detect
c_func
(paren
id|psmouse
comma
id|set_properties
)paren
op_eq
l_int|0
)paren
r_return
id|PSMOUSE_IMEX
suffix:semicolon
r_if
c_cond
(paren
id|max_proto
op_ge
id|PSMOUSE_IMPS
op_logical_and
id|intellimouse_detect
c_func
(paren
id|psmouse
comma
id|set_properties
)paren
op_eq
l_int|0
)paren
r_return
id|PSMOUSE_IMPS
suffix:semicolon
multiline_comment|/*&n; * Okay, all failed, we have a standard mouse here. The number of the buttons&n; * is still a question, though. We assume 3.&n; */
id|ps2bare_detect
c_func
(paren
id|psmouse
comma
id|set_properties
)paren
suffix:semicolon
r_if
c_cond
(paren
id|synaptics_hardware
)paren
(brace
multiline_comment|/*&n; * We detected Synaptics hardware but it did not respond to IMPS/2 probes.&n; * We need to reset the touchpad because if there is a track point on the&n; * pass through port it could get disabled while probing for protocol&n; * extensions.&n; */
id|psmouse_reset
c_func
(paren
id|psmouse
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_RESET_DIS
)paren
suffix:semicolon
)brace
r_return
id|PSMOUSE_PS2
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_probe() probes for a PS/2 mouse.&n; */
DECL|function|psmouse_probe
r_static
r_int
id|psmouse_probe
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
)paren
(brace
r_struct
id|ps2dev
op_star
id|ps2dev
op_assign
op_amp
id|psmouse-&gt;ps2dev
suffix:semicolon
r_int
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*&n; * First, we check if it&squot;s a mouse. It should send 0x00 or 0x03&n; * in case of an IntelliMouse in 4-byte mode or 0x04 for IM Explorer.&n; */
id|param
(braket
l_int|0
)braket
op_assign
l_int|0xa5
suffix:semicolon
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
id|param
comma
id|PSMOUSE_CMD_GETID
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|param
(braket
l_int|0
)braket
op_ne
l_int|0x00
op_logical_and
id|param
(braket
l_int|0
)braket
op_ne
l_int|0x03
op_logical_and
id|param
(braket
l_int|0
)braket
op_ne
l_int|0x04
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n; * Then we reset and disable the mouse so that it doesn&squot;t generate events.&n; */
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
id|ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_RESET_DIS
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;psmouse.c: Failed to reset mouse on %s&bslash;n&quot;
comma
id|ps2dev-&gt;serio-&gt;phys
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Here we set the mouse resolution.&n; */
DECL|function|psmouse_set_resolution
r_void
id|psmouse_set_resolution
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
r_int
id|resolution
)paren
(brace
r_int
r_char
id|params
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|3
)brace
suffix:semicolon
r_if
c_cond
(paren
id|resolution
op_eq
l_int|0
op_logical_or
id|resolution
OG
l_int|200
)paren
id|resolution
op_assign
l_int|200
suffix:semicolon
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
op_amp
id|params
(braket
id|resolution
op_div
l_int|50
)braket
comma
id|PSMOUSE_CMD_SETRES
)paren
suffix:semicolon
id|psmouse-&gt;resolution
op_assign
l_int|25
op_lshift
id|params
(braket
id|resolution
op_div
l_int|50
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; * Here we set the mouse report rate.&n; */
DECL|function|psmouse_set_rate
r_static
r_void
id|psmouse_set_rate
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_int
r_int
id|rate
)paren
(brace
r_int
r_char
id|rates
(braket
)braket
op_assign
(brace
l_int|200
comma
l_int|100
comma
l_int|80
comma
l_int|60
comma
l_int|40
comma
l_int|20
comma
l_int|10
comma
l_int|0
)brace
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|rates
(braket
id|i
)braket
OG
id|rate
)paren
id|i
op_increment
suffix:semicolon
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
op_amp
id|rates
(braket
id|i
)braket
comma
id|PSMOUSE_CMD_SETRATE
)paren
suffix:semicolon
id|psmouse-&gt;rate
op_assign
id|rates
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_initialize() initializes the mouse to a sane state.&n; */
DECL|function|psmouse_initialize
r_static
r_void
id|psmouse_initialize
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
)paren
(brace
multiline_comment|/*&n; * We set the mouse into streaming mode.&n; */
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_SETSTREAM
)paren
suffix:semicolon
multiline_comment|/*&n; * We set the mouse report rate, resolution and scaling.&n; */
r_if
c_cond
(paren
id|psmouse_max_proto
op_ne
id|PSMOUSE_PS2
)paren
(brace
id|psmouse
op_member_access_from_pointer
id|set_rate
c_func
(paren
id|psmouse
comma
id|psmouse-&gt;rate
)paren
suffix:semicolon
id|psmouse
op_member_access_from_pointer
id|set_resolution
c_func
(paren
id|psmouse
comma
id|psmouse-&gt;resolution
)paren
suffix:semicolon
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_SETSCALE11
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * psmouse_set_state() sets new psmouse state and resets all flags and&n; * counters while holding serio lock so fighting with interrupt handler&n; * is not a concern.&n; */
DECL|function|psmouse_set_state
r_static
r_void
id|psmouse_set_state
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_enum
id|psmouse_state
id|new_state
)paren
(brace
id|serio_pause_rx
c_func
(paren
id|psmouse-&gt;ps2dev.serio
)paren
suffix:semicolon
id|psmouse-&gt;state
op_assign
id|new_state
suffix:semicolon
id|psmouse-&gt;pktcnt
op_assign
id|psmouse-&gt;out_of_sync
op_assign
l_int|0
suffix:semicolon
id|psmouse-&gt;ps2dev.flags
op_assign
l_int|0
suffix:semicolon
id|serio_continue_rx
c_func
(paren
id|psmouse-&gt;ps2dev.serio
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_activate() enables the mouse so that we get motion reports from it.&n; */
DECL|function|psmouse_activate
r_static
r_void
id|psmouse_activate
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
)paren
(brace
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_ENABLE
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;psmouse.c: Failed to enable mouse on %s&bslash;n&quot;
comma
id|psmouse-&gt;ps2dev.serio-&gt;phys
)paren
suffix:semicolon
id|psmouse_set_state
c_func
(paren
id|psmouse
comma
id|PSMOUSE_ACTIVATED
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_deactivate() puts the mouse into poll mode so that we don&squot;t get motion&n; * reports from it unless we explicitely request it.&n; */
DECL|function|psmouse_deactivate
r_static
r_void
id|psmouse_deactivate
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
)paren
(brace
r_if
c_cond
(paren
id|ps2_command
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
l_int|NULL
comma
id|PSMOUSE_CMD_DISABLE
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;psmouse.c: Failed to deactivate mouse on %s&bslash;n&quot;
comma
id|psmouse-&gt;ps2dev.serio-&gt;phys
)paren
suffix:semicolon
id|psmouse_set_state
c_func
(paren
id|psmouse
comma
id|PSMOUSE_CMD_MODE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_cleanup() resets the mouse into power-on state.&n; */
DECL|function|psmouse_cleanup
r_static
r_void
id|psmouse_cleanup
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|psmouse
op_star
id|psmouse
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
id|psmouse_reset
c_func
(paren
id|psmouse
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_disconnect() closes and frees.&n; */
DECL|function|psmouse_disconnect
r_static
r_void
id|psmouse_disconnect
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|psmouse
op_star
id|psmouse
comma
op_star
id|parent
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|psmouse_attr_rate
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|psmouse_attr_resolution
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|psmouse_attr_resetafter
)paren
suffix:semicolon
id|psmouse
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
id|psmouse_set_state
c_func
(paren
id|psmouse
comma
id|PSMOUSE_CMD_MODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;parent
op_logical_and
(paren
id|serio-&gt;type
op_amp
id|SERIO_TYPE
)paren
op_eq
id|SERIO_PS_PSTHRU
)paren
(brace
id|parent
op_assign
id|serio-&gt;parent
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|parent-&gt;pt_deactivate
)paren
id|parent
op_member_access_from_pointer
id|pt_deactivate
c_func
(paren
id|parent
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|psmouse-&gt;disconnect
)paren
id|psmouse
op_member_access_from_pointer
id|disconnect
c_func
(paren
id|psmouse
)paren
suffix:semicolon
id|psmouse_set_state
c_func
(paren
id|psmouse
comma
id|PSMOUSE_IGNORE
)paren
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|psmouse-&gt;dev
)paren
suffix:semicolon
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|psmouse
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * psmouse_connect() is a callback from the serio module when&n; * an unhandled serio port is found.&n; */
DECL|function|psmouse_connect
r_static
r_void
id|psmouse_connect
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_struct
id|serio_driver
op_star
id|drv
)paren
(brace
r_struct
id|psmouse
op_star
id|psmouse
comma
op_star
id|parent
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|serio-&gt;type
op_amp
id|SERIO_TYPE
)paren
op_ne
id|SERIO_8042
op_logical_and
(paren
id|serio-&gt;type
op_amp
id|SERIO_TYPE
)paren
op_ne
id|SERIO_PS_PSTHRU
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * If this is a pass-through port deactivate parent so the device&n;&t; * connected to this port can be successfully identified&n;&t; */
r_if
c_cond
(paren
id|serio-&gt;parent
op_logical_and
(paren
id|serio-&gt;type
op_amp
id|SERIO_TYPE
)paren
op_eq
id|SERIO_PS_PSTHRU
)paren
(brace
id|parent
op_assign
id|serio-&gt;parent
op_member_access_from_pointer
r_private
suffix:semicolon
id|psmouse_deactivate
c_func
(paren
id|parent
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|psmouse
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|psmouse
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|psmouse
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|psmouse
)paren
)paren
suffix:semicolon
id|ps2_init
c_func
(paren
op_amp
id|psmouse-&gt;ps2dev
comma
id|serio
)paren
suffix:semicolon
id|psmouse-&gt;dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REL
)paren
suffix:semicolon
id|psmouse-&gt;dev.keybit
(braket
id|LONG
c_func
(paren
id|BTN_MOUSE
)paren
)braket
op_assign
id|BIT
c_func
(paren
id|BTN_LEFT
)paren
op_or
id|BIT
c_func
(paren
id|BTN_MIDDLE
)paren
op_or
id|BIT
c_func
(paren
id|BTN_RIGHT
)paren
suffix:semicolon
id|psmouse-&gt;dev.relbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|REL_X
)paren
op_or
id|BIT
c_func
(paren
id|REL_Y
)paren
suffix:semicolon
id|psmouse-&gt;dev
dot
r_private
op_assign
id|psmouse
suffix:semicolon
id|psmouse-&gt;dev.dev
op_assign
op_amp
id|serio-&gt;dev
suffix:semicolon
id|psmouse_set_state
c_func
(paren
id|psmouse
comma
id|PSMOUSE_INITIALIZING
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
r_private
op_assign
id|psmouse
suffix:semicolon
r_if
c_cond
(paren
id|serio_open
c_func
(paren
id|serio
comma
id|drv
)paren
)paren
(brace
id|kfree
c_func
(paren
id|psmouse
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|psmouse_probe
c_func
(paren
id|psmouse
)paren
OL
l_int|0
)paren
(brace
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|psmouse
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
r_private
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|psmouse-&gt;rate
op_assign
id|psmouse_rate
suffix:semicolon
id|psmouse-&gt;resolution
op_assign
id|psmouse_resolution
suffix:semicolon
id|psmouse-&gt;resetafter
op_assign
id|psmouse_resetafter
suffix:semicolon
id|psmouse-&gt;smartscroll
op_assign
id|psmouse_smartscroll
suffix:semicolon
id|psmouse-&gt;set_rate
op_assign
id|psmouse_set_rate
suffix:semicolon
id|psmouse-&gt;set_resolution
op_assign
id|psmouse_set_resolution
suffix:semicolon
id|psmouse-&gt;protocol_handler
op_assign
id|psmouse_process_byte
suffix:semicolon
id|psmouse-&gt;pktsize
op_assign
l_int|3
suffix:semicolon
id|psmouse-&gt;type
op_assign
id|psmouse_extensions
c_func
(paren
id|psmouse
comma
id|psmouse_max_proto
comma
l_int|1
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|psmouse-&gt;devname
comma
l_string|&quot;%s %s %s&quot;
comma
id|psmouse_protocols
(braket
id|psmouse-&gt;type
)braket
comma
id|psmouse-&gt;vendor
comma
id|psmouse-&gt;name
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|psmouse-&gt;phys
comma
l_string|&quot;%s/input0&quot;
comma
id|serio-&gt;phys
)paren
suffix:semicolon
id|psmouse-&gt;dev.name
op_assign
id|psmouse-&gt;devname
suffix:semicolon
id|psmouse-&gt;dev.phys
op_assign
id|psmouse-&gt;phys
suffix:semicolon
id|psmouse-&gt;dev.id.bustype
op_assign
id|BUS_I8042
suffix:semicolon
id|psmouse-&gt;dev.id.vendor
op_assign
l_int|0x0002
suffix:semicolon
id|psmouse-&gt;dev.id.product
op_assign
id|psmouse-&gt;type
suffix:semicolon
id|psmouse-&gt;dev.id.version
op_assign
id|psmouse-&gt;model
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|psmouse-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input: %s on %s&bslash;n&quot;
comma
id|psmouse-&gt;devname
comma
id|serio-&gt;phys
)paren
suffix:semicolon
id|psmouse_set_state
c_func
(paren
id|psmouse
comma
id|PSMOUSE_CMD_MODE
)paren
suffix:semicolon
id|psmouse_initialize
c_func
(paren
id|psmouse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parent
op_logical_and
id|parent-&gt;pt_activate
)paren
id|parent
op_member_access_from_pointer
id|pt_activate
c_func
(paren
id|parent
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|psmouse_attr_rate
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|psmouse_attr_resolution
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|serio-&gt;dev
comma
op_amp
id|psmouse_attr_resetafter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;child
)paren
(brace
multiline_comment|/*&n;&t;&t; * Nothing to be done here, serio core will detect that&n;&t;&t; * the driver set serio-&gt;child and will register it for us.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;serio: %s port at %s&bslash;n&quot;
comma
id|serio-&gt;child-&gt;name
comma
id|psmouse-&gt;phys
)paren
suffix:semicolon
)brace
id|psmouse_activate
c_func
(paren
id|psmouse
)paren
suffix:semicolon
id|out
suffix:colon
multiline_comment|/* If this is a pass-through port the parent awaits to be activated */
r_if
c_cond
(paren
id|parent
)paren
id|psmouse_activate
c_func
(paren
id|parent
)paren
suffix:semicolon
)brace
DECL|function|psmouse_reconnect
r_static
r_int
id|psmouse_reconnect
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|psmouse
op_star
id|psmouse
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|psmouse
op_star
id|parent
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|serio_driver
op_star
id|drv
op_assign
id|serio-&gt;drv
suffix:semicolon
r_int
id|rc
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drv
op_logical_or
op_logical_neg
id|psmouse
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;psmouse: reconnect request, but serio is disconnected, ignoring...&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|serio-&gt;parent
op_logical_and
(paren
id|serio-&gt;type
op_amp
id|SERIO_TYPE
)paren
op_eq
id|SERIO_PS_PSTHRU
)paren
(brace
id|parent
op_assign
id|serio-&gt;parent
op_member_access_from_pointer
r_private
suffix:semicolon
id|psmouse_deactivate
c_func
(paren
id|parent
)paren
suffix:semicolon
)brace
id|psmouse_set_state
c_func
(paren
id|psmouse
comma
id|PSMOUSE_INITIALIZING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|psmouse-&gt;reconnect
)paren
(brace
r_if
c_cond
(paren
id|psmouse
op_member_access_from_pointer
id|reconnect
c_func
(paren
id|psmouse
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|psmouse_probe
c_func
(paren
id|psmouse
)paren
OL
l_int|0
op_logical_or
id|psmouse-&gt;type
op_ne
id|psmouse_extensions
c_func
(paren
id|psmouse
comma
id|psmouse_max_proto
comma
l_int|0
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* ok, the device type (and capabilities) match the old one,&n;&t; * we can continue using it, complete intialization&n;&t; */
id|psmouse_set_state
c_func
(paren
id|psmouse
comma
id|PSMOUSE_CMD_MODE
)paren
suffix:semicolon
id|psmouse_initialize
c_func
(paren
id|psmouse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parent
op_logical_and
id|parent-&gt;pt_activate
)paren
id|parent
op_member_access_from_pointer
id|pt_activate
c_func
(paren
id|parent
)paren
suffix:semicolon
id|psmouse_activate
c_func
(paren
id|psmouse
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
multiline_comment|/* If this is a pass-through port the parent waits to be activated */
r_if
c_cond
(paren
id|parent
)paren
id|psmouse_activate
c_func
(paren
id|parent
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|psmouse_drv
r_static
r_struct
id|serio_driver
id|psmouse_drv
op_assign
(brace
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;psmouse&quot;
comma
)brace
comma
dot
id|description
op_assign
id|DRIVER_DESC
comma
dot
id|interrupt
op_assign
id|psmouse_interrupt
comma
dot
id|connect
op_assign
id|psmouse_connect
comma
dot
id|reconnect
op_assign
id|psmouse_reconnect
comma
dot
id|disconnect
op_assign
id|psmouse_disconnect
comma
dot
id|cleanup
op_assign
id|psmouse_cleanup
comma
)brace
suffix:semicolon
DECL|function|psmouse_attr_show_helper
id|ssize_t
id|psmouse_attr_show_helper
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
id|ssize_t
(paren
op_star
id|handler
)paren
(paren
r_struct
id|psmouse
op_star
comma
r_char
op_star
)paren
)paren
(brace
r_struct
id|serio
op_star
id|serio
op_assign
id|to_serio_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|serio_pin_driver
c_func
(paren
id|serio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;drv
op_ne
op_amp
id|psmouse_drv
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|handler
c_func
(paren
id|serio
op_member_access_from_pointer
r_private
comma
id|buf
)paren
suffix:semicolon
id|out
suffix:colon
id|serio_unpin_driver
c_func
(paren
id|serio
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|psmouse_attr_set_helper
id|ssize_t
id|psmouse_attr_set_helper
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|ssize_t
(paren
op_star
id|handler
)paren
(paren
r_struct
id|psmouse
op_star
comma
r_const
r_char
op_star
comma
r_int
)paren
)paren
(brace
r_struct
id|serio
op_star
id|serio
op_assign
id|to_serio_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|psmouse
op_star
id|psmouse
op_assign
id|serio
op_member_access_from_pointer
r_private
comma
op_star
id|parent
op_assign
l_int|NULL
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|serio_pin_driver
c_func
(paren
id|serio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;drv
op_ne
op_amp
id|psmouse_drv
)paren
(brace
id|retval
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|serio-&gt;parent
op_logical_and
(paren
id|serio-&gt;type
op_amp
id|SERIO_TYPE
)paren
op_eq
id|SERIO_PS_PSTHRU
)paren
(brace
id|parent
op_assign
id|serio-&gt;parent
op_member_access_from_pointer
r_private
suffix:semicolon
id|psmouse_deactivate
c_func
(paren
id|parent
)paren
suffix:semicolon
)brace
id|psmouse_deactivate
c_func
(paren
id|psmouse
)paren
suffix:semicolon
id|retval
op_assign
id|handler
c_func
(paren
id|psmouse
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|psmouse_activate
c_func
(paren
id|psmouse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parent
)paren
id|psmouse_activate
c_func
(paren
id|parent
)paren
suffix:semicolon
id|out
suffix:colon
id|serio_unpin_driver
c_func
(paren
id|serio
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|psmouse_attr_show_rate
r_static
id|ssize_t
id|psmouse_attr_show_rate
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|psmouse-&gt;rate
)paren
suffix:semicolon
)brace
DECL|function|psmouse_attr_set_rate
r_static
id|ssize_t
id|psmouse_attr_set_rate
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_char
op_star
id|rest
suffix:semicolon
id|value
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|rest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rest
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|psmouse
op_member_access_from_pointer
id|set_rate
c_func
(paren
id|psmouse
comma
id|value
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|psmouse_attr_show_resolution
r_static
id|ssize_t
id|psmouse_attr_show_resolution
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|psmouse-&gt;resolution
)paren
suffix:semicolon
)brace
DECL|function|psmouse_attr_set_resolution
r_static
id|ssize_t
id|psmouse_attr_set_resolution
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_char
op_star
id|rest
suffix:semicolon
id|value
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|rest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rest
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|psmouse
op_member_access_from_pointer
id|set_resolution
c_func
(paren
id|psmouse
comma
id|value
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|psmouse_attr_show_resetafter
r_static
id|ssize_t
id|psmouse_attr_show_resetafter
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|psmouse-&gt;resetafter
)paren
suffix:semicolon
)brace
DECL|function|psmouse_attr_set_resetafter
r_static
id|ssize_t
id|psmouse_attr_set_resetafter
c_func
(paren
r_struct
id|psmouse
op_star
id|psmouse
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|value
suffix:semicolon
r_char
op_star
id|rest
suffix:semicolon
id|value
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|rest
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rest
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|psmouse-&gt;resetafter
op_assign
id|value
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|psmouse_parse_proto
r_static
r_inline
r_void
id|psmouse_parse_proto
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|psmouse_proto
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|psmouse_proto
comma
l_string|&quot;bare&quot;
)paren
)paren
id|psmouse_max_proto
op_assign
id|PSMOUSE_PS2
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|psmouse_proto
comma
l_string|&quot;imps&quot;
)paren
)paren
id|psmouse_max_proto
op_assign
id|PSMOUSE_IMPS
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|psmouse_proto
comma
l_string|&quot;exps&quot;
)paren
)paren
id|psmouse_max_proto
op_assign
id|PSMOUSE_IMEX
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;psmouse: unknown protocol type &squot;%s&squot;&bslash;n&quot;
comma
id|psmouse_proto
)paren
suffix:semicolon
)brace
)brace
DECL|function|psmouse_init
r_int
id|__init
id|psmouse_init
c_func
(paren
r_void
)paren
(brace
id|psmouse_parse_proto
c_func
(paren
)paren
suffix:semicolon
id|serio_register_driver
c_func
(paren
op_amp
id|psmouse_drv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|psmouse_exit
r_void
id|__exit
id|psmouse_exit
c_func
(paren
r_void
)paren
(brace
id|serio_unregister_driver
c_func
(paren
op_amp
id|psmouse_drv
)paren
suffix:semicolon
)brace
DECL|variable|psmouse_init
id|module_init
c_func
(paren
id|psmouse_init
)paren
suffix:semicolon
DECL|variable|psmouse_exit
id|module_exit
c_func
(paren
id|psmouse_exit
)paren
suffix:semicolon
eof
