multiline_comment|/*&n; * Generic linux-input device driver for axis-bearing devices&n; *&n; * Copyright (c) 2001 Brian S. Julin&n; * All rights reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification.&n; * 2. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * Alternatively, this software may be distributed under the terms of the&n; * GNU General Public License (&quot;GPL&quot;).&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; *&n; * References:&n; * HP-HIL Technical Reference Manual.  Hewlett Packard Product No. 45918A&n; *&n; */
macro_line|#include &lt;linux/hil.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/serio.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci_ids.h&gt;
DECL|macro|PREFIX
mdefine_line|#define PREFIX &quot;HIL PTR: &quot;
DECL|macro|HIL_GENERIC_NAME
mdefine_line|#define HIL_GENERIC_NAME &quot;HIL pointer device&quot;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Brian S. Julin &lt;bri@calyx.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
id|HIL_GENERIC_NAME
l_string|&quot; driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual BSD/GPL&quot;
)paren
suffix:semicolon
DECL|macro|TABLET_SIMULATES_MOUSE
mdefine_line|#define TABLET_SIMULATES_MOUSE&t;/* allow tablet to be used as mouse */
DECL|macro|TABLET_AUTOADJUST
macro_line|#undef  TABLET_AUTOADJUST&t;/* auto-adjust valid tablet ranges */
DECL|macro|HIL_PTR_MAX_LENGTH
mdefine_line|#define HIL_PTR_MAX_LENGTH 16
DECL|struct|hil_ptr
r_struct
id|hil_ptr
(brace
DECL|member|dev
r_struct
id|input_dev
id|dev
suffix:semicolon
DECL|member|serio
r_struct
id|serio
op_star
id|serio
suffix:semicolon
multiline_comment|/* Input buffer and index for packets from HIL bus. */
DECL|member|data
id|hil_packet
id|data
(braket
id|HIL_PTR_MAX_LENGTH
)braket
suffix:semicolon
DECL|member|idx4
r_int
id|idx4
suffix:semicolon
multiline_comment|/* four counts per packet */
multiline_comment|/* Raw device info records from HIL bus, see hil.h for fields. */
DECL|member|idd
r_char
id|idd
(braket
id|HIL_PTR_MAX_LENGTH
)braket
suffix:semicolon
multiline_comment|/* DID byte and IDD record */
DECL|member|rsc
r_char
id|rsc
(braket
id|HIL_PTR_MAX_LENGTH
)braket
suffix:semicolon
multiline_comment|/* RSC record */
DECL|member|exd
r_char
id|exd
(braket
id|HIL_PTR_MAX_LENGTH
)braket
suffix:semicolon
multiline_comment|/* EXD record */
DECL|member|rnm
r_char
id|rnm
(braket
id|HIL_PTR_MAX_LENGTH
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* RNM record + NULL term. */
multiline_comment|/* Extra device details not contained in struct input_dev. */
DECL|member|nbtn
DECL|member|naxes
r_int
r_int
id|nbtn
comma
id|naxes
suffix:semicolon
DECL|member|btnmap
r_int
r_int
id|btnmap
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* Something to sleep around with. */
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Process a complete packet after transfer from the HIL */
DECL|function|hil_ptr_process_record
r_static
r_void
id|hil_ptr_process_record
c_func
(paren
r_struct
id|hil_ptr
op_star
id|ptr
)paren
(brace
r_struct
id|input_dev
op_star
id|dev
op_assign
op_amp
id|ptr-&gt;dev
suffix:semicolon
id|hil_packet
op_star
id|data
op_assign
id|ptr-&gt;data
suffix:semicolon
id|hil_packet
id|p
suffix:semicolon
r_int
id|idx
comma
id|i
comma
id|cnt
comma
id|laxis
suffix:semicolon
r_int
id|ax16
comma
id|absdev
suffix:semicolon
id|idx
op_assign
id|ptr-&gt;idx4
op_div
l_int|4
suffix:semicolon
id|p
op_assign
id|data
(braket
id|idx
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_amp
op_complement
id|HIL_CMDCT_POL
)paren
op_eq
(paren
id|HIL_ERR_INT
op_or
id|HIL_PKT_CMD
op_or
id|HIL_CMD_POL
)paren
)paren
r_goto
id|report
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_amp
op_complement
id|HIL_CMDCT_RPL
)paren
op_eq
(paren
id|HIL_ERR_INT
op_or
id|HIL_PKT_CMD
op_or
id|HIL_CMD_RPL
)paren
)paren
r_goto
id|report
suffix:semicolon
multiline_comment|/* Not a poll response.  See if we are loading config records. */
r_switch
c_cond
(paren
id|p
op_amp
id|HIL_PKT_DATA_MASK
)paren
(brace
r_case
id|HIL_CMD_IDD
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|idx
suffix:semicolon
id|i
op_increment
)paren
id|ptr-&gt;idd
(braket
id|i
)braket
op_assign
id|ptr-&gt;data
(braket
id|i
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|HIL_PTR_MAX_LENGTH
suffix:semicolon
id|i
op_increment
)paren
id|ptr-&gt;idd
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIL_CMD_RSC
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|idx
suffix:semicolon
id|i
op_increment
)paren
id|ptr-&gt;rsc
(braket
id|i
)braket
op_assign
id|ptr-&gt;data
(braket
id|i
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|HIL_PTR_MAX_LENGTH
suffix:semicolon
id|i
op_increment
)paren
id|ptr-&gt;rsc
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIL_CMD_EXD
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|idx
suffix:semicolon
id|i
op_increment
)paren
id|ptr-&gt;exd
(braket
id|i
)braket
op_assign
id|ptr-&gt;data
(braket
id|i
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|HIL_PTR_MAX_LENGTH
suffix:semicolon
id|i
op_increment
)paren
id|ptr-&gt;exd
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HIL_CMD_RNM
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|idx
suffix:semicolon
id|i
op_increment
)paren
id|ptr-&gt;rnm
(braket
id|i
)braket
op_assign
id|ptr-&gt;data
(braket
id|i
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|HIL_PTR_MAX_LENGTH
op_plus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
id|ptr-&gt;rnm
(braket
id|i
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* These occur when device isn&squot;t present */
r_if
c_cond
(paren
id|p
op_eq
(paren
id|HIL_ERR_INT
op_or
id|HIL_PKT_CMD
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* Anything else we&squot;d like to know about. */
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Device sent unknown record %x&bslash;n&quot;
comma
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
id|report
suffix:colon
r_if
c_cond
(paren
(paren
id|p
op_amp
id|HIL_CMDCT_POL
)paren
op_ne
id|idx
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;Malformed poll packet %x (idx = %i)&bslash;n&quot;
comma
id|p
comma
id|idx
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|i
op_assign
(paren
id|ptr-&gt;data
(braket
l_int|0
)braket
op_amp
id|HIL_POL_AXIS_ALT
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|0
suffix:semicolon
id|laxis
op_assign
id|ptr-&gt;data
(braket
l_int|0
)braket
op_amp
id|HIL_POL_NUM_AXES_MASK
suffix:semicolon
id|laxis
op_add_assign
id|i
suffix:semicolon
id|ax16
op_assign
id|ptr-&gt;idd
(braket
l_int|1
)braket
op_amp
id|HIL_IDD_HEADER_16BIT
suffix:semicolon
multiline_comment|/* 8 or 16bit resolution */
id|absdev
op_assign
id|ptr-&gt;idd
(braket
l_int|1
)braket
op_amp
id|HIL_IDD_HEADER_ABS
suffix:semicolon
r_for
c_loop
(paren
id|cnt
op_assign
l_int|1
suffix:semicolon
id|i
OL
id|laxis
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|lo
comma
id|hi
comma
id|val
suffix:semicolon
id|lo
op_assign
id|ptr-&gt;data
(braket
id|cnt
op_increment
)braket
op_amp
id|HIL_PKT_DATA_MASK
suffix:semicolon
id|hi
op_assign
id|ax16
ques
c_cond
(paren
id|ptr-&gt;data
(braket
id|cnt
op_increment
)braket
op_amp
id|HIL_PKT_DATA_MASK
)paren
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|absdev
)paren
(brace
id|val
op_assign
id|lo
op_plus
(paren
id|hi
op_lshift
l_int|8
)paren
suffix:semicolon
macro_line|#ifdef TABLET_AUTOADJUST
r_if
c_cond
(paren
id|val
OL
id|ptr-&gt;dev.absmin
(braket
id|ABS_X
op_plus
id|i
)braket
)paren
id|ptr-&gt;dev.absmin
(braket
id|ABS_X
op_plus
id|i
)braket
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
id|ptr-&gt;dev.absmax
(braket
id|ABS_X
op_plus
id|i
)braket
)paren
id|ptr-&gt;dev.absmax
(braket
id|ABS_X
op_plus
id|i
)braket
op_assign
id|val
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|i
op_mod
l_int|3
)paren
id|val
op_assign
id|ptr-&gt;dev.absmax
(braket
id|ABS_X
op_plus
id|i
)braket
op_minus
id|val
suffix:semicolon
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_X
op_plus
id|i
comma
id|val
)paren
suffix:semicolon
)brace
r_else
(brace
id|val
op_assign
(paren
r_int
)paren
(paren
(paren
(paren
r_int8
)paren
id|lo
)paren
op_or
(paren
(paren
r_int8
)paren
id|hi
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_mod
l_int|3
)paren
id|val
op_mul_assign
op_minus
l_int|1
suffix:semicolon
id|input_report_rel
c_func
(paren
id|dev
comma
id|REL_X
op_plus
id|i
comma
id|val
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|cnt
OL
id|idx
op_minus
l_int|1
)paren
(brace
r_int
r_int
id|btn
suffix:semicolon
r_int
id|up
suffix:semicolon
id|btn
op_assign
id|ptr-&gt;data
(braket
id|cnt
op_increment
)braket
suffix:semicolon
id|up
op_assign
id|btn
op_amp
l_int|1
suffix:semicolon
id|btn
op_and_assign
l_int|0xfe
suffix:semicolon
r_if
c_cond
(paren
id|btn
op_eq
l_int|0x8e
)paren
(brace
r_continue
suffix:semicolon
multiline_comment|/* TODO: proximity == touch? */
)brace
r_else
r_if
c_cond
(paren
(paren
id|btn
OG
l_int|0x8c
)paren
op_logical_or
(paren
id|btn
OL
l_int|0x80
)paren
)paren
r_continue
suffix:semicolon
id|btn
op_assign
(paren
id|btn
op_minus
l_int|0x80
)paren
op_rshift
l_int|1
suffix:semicolon
id|btn
op_assign
id|ptr-&gt;btnmap
(braket
id|btn
)braket
suffix:semicolon
id|input_report_key
c_func
(paren
id|dev
comma
id|btn
comma
op_logical_neg
id|up
)paren
suffix:semicolon
)brace
id|input_sync
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
id|ptr-&gt;idx4
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ptr-&gt;sem
)paren
suffix:semicolon
)brace
DECL|function|hil_ptr_process_err
r_static
r_void
id|hil_ptr_process_err
c_func
(paren
r_struct
id|hil_ptr
op_star
id|ptr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PREFIX
l_string|&quot;errored HIL packet&bslash;n&quot;
)paren
suffix:semicolon
id|ptr-&gt;idx4
op_assign
l_int|0
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ptr-&gt;sem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|hil_ptr_interrupt
r_static
id|irqreturn_t
id|hil_ptr_interrupt
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_int
r_char
id|data
comma
r_int
r_int
id|flags
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|hil_ptr
op_star
id|ptr
suffix:semicolon
id|hil_packet
id|packet
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|ptr
op_assign
(paren
r_struct
id|hil_ptr
op_star
)paren
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
l_int|NULL
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr-&gt;idx4
op_ge
(paren
id|HIL_PTR_MAX_LENGTH
op_star
r_sizeof
(paren
id|hil_packet
)paren
)paren
)paren
(brace
id|hil_ptr_process_err
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|idx
op_assign
id|ptr-&gt;idx4
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ptr-&gt;idx4
op_mod
l_int|4
)paren
)paren
id|ptr-&gt;data
(braket
id|idx
)braket
op_assign
l_int|0
suffix:semicolon
id|packet
op_assign
id|ptr-&gt;data
(braket
id|idx
)braket
suffix:semicolon
id|packet
op_or_assign
(paren
(paren
id|hil_packet
)paren
id|data
)paren
op_lshift
(paren
(paren
l_int|3
op_minus
(paren
id|ptr-&gt;idx4
op_mod
l_int|4
)paren
)paren
op_star
l_int|8
)paren
suffix:semicolon
id|ptr-&gt;data
(braket
id|idx
)braket
op_assign
id|packet
suffix:semicolon
multiline_comment|/* Records of N 4-byte hil_packets must terminate with a command. */
r_if
c_cond
(paren
(paren
op_increment
(paren
id|ptr-&gt;idx4
)paren
)paren
op_mod
l_int|4
)paren
r_return
id|IRQ_HANDLED
suffix:semicolon
r_if
c_cond
(paren
(paren
id|packet
op_amp
l_int|0xffff0000
)paren
op_ne
id|HIL_ERR_INT
)paren
(brace
id|hil_ptr_process_err
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|packet
op_amp
id|HIL_PKT_CMD
)paren
id|hil_ptr_process_record
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|hil_ptr_disconnect
r_static
r_void
id|hil_ptr_disconnect
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|hil_ptr
op_star
id|ptr
suffix:semicolon
id|ptr
op_assign
(paren
r_struct
id|hil_ptr
op_star
)paren
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|ptr
op_eq
l_int|NULL
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|input_unregister_device
c_func
(paren
op_amp
id|ptr-&gt;dev
)paren
suffix:semicolon
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
DECL|function|hil_ptr_connect
r_static
r_void
id|hil_ptr_connect
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_struct
id|serio_driver
op_star
id|driver
)paren
(brace
r_struct
id|hil_ptr
op_star
id|ptr
suffix:semicolon
r_char
op_star
id|txt
suffix:semicolon
r_int
r_int
id|i
comma
id|naxsets
comma
id|btntype
suffix:semicolon
r_uint8
id|did
comma
op_star
id|idd
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;type
op_ne
(paren
id|SERIO_HIL_MLC
op_or
id|SERIO_HIL
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ptr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hil_ptr
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|ptr
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hil_ptr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serio_open
c_func
(paren
id|serio
comma
id|driver
)paren
)paren
r_goto
id|bail0
suffix:semicolon
id|serio
op_member_access_from_pointer
r_private
op_assign
id|ptr
suffix:semicolon
id|ptr-&gt;serio
op_assign
id|serio
suffix:semicolon
id|ptr-&gt;dev
dot
r_private
op_assign
id|ptr
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
(paren
id|ptr-&gt;sem
)paren
)paren
suffix:semicolon
multiline_comment|/* Get device info.  MLC driver supplies devid/status/etc. */
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_IDD
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|ptr-&gt;sem
)paren
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_RSC
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|ptr-&gt;sem
)paren
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_RNM
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|ptr-&gt;sem
)paren
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
l_int|0
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_PKT_CMD
op_rshift
l_int|8
)paren
suffix:semicolon
id|serio
op_member_access_from_pointer
id|write
c_func
(paren
id|serio
comma
id|HIL_CMD_EXD
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|ptr-&gt;sem
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
(paren
id|ptr-&gt;sem
)paren
)paren
suffix:semicolon
id|init_input_dev
c_func
(paren
op_amp
id|ptr-&gt;dev
)paren
suffix:semicolon
id|did
op_assign
id|ptr-&gt;idd
(braket
l_int|0
)braket
suffix:semicolon
id|idd
op_assign
id|ptr-&gt;idd
op_plus
l_int|1
suffix:semicolon
id|txt
op_assign
l_string|&quot;unknown&quot;
suffix:semicolon
r_if
c_cond
(paren
(paren
id|did
op_amp
id|HIL_IDD_DID_TYPE_MASK
)paren
op_eq
id|HIL_IDD_DID_TYPE_REL
)paren
(brace
id|ptr-&gt;dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_REL
)paren
suffix:semicolon
id|txt
op_assign
l_string|&quot;relative&quot;
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|did
op_amp
id|HIL_IDD_DID_TYPE_MASK
)paren
op_eq
id|HIL_IDD_DID_TYPE_ABS
)paren
(brace
id|ptr-&gt;dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_ABS
)paren
suffix:semicolon
id|txt
op_assign
l_string|&quot;absolute&quot;
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ptr-&gt;dev.evbit
(braket
l_int|0
)braket
)paren
(brace
r_goto
id|bail1
suffix:semicolon
)brace
id|ptr-&gt;nbtn
op_assign
id|HIL_IDD_NUM_BUTTONS
c_func
(paren
id|idd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptr-&gt;nbtn
)paren
id|ptr-&gt;dev.evbit
(braket
l_int|0
)braket
op_or_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
suffix:semicolon
id|naxsets
op_assign
id|HIL_IDD_NUM_AXSETS
c_func
(paren
op_star
id|idd
)paren
suffix:semicolon
id|ptr-&gt;naxes
op_assign
id|HIL_IDD_NUM_AXES_PER_SET
c_func
(paren
op_star
id|idd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;HIL pointer device found (did: 0x%02x, axis: %s)&bslash;n&quot;
comma
id|did
comma
id|txt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PREFIX
l_string|&quot;HIL pointer has %i buttons and %i sets of %i axes&bslash;n&quot;
comma
id|ptr-&gt;nbtn
comma
id|naxsets
comma
id|ptr-&gt;naxes
)paren
suffix:semicolon
id|btntype
op_assign
id|BTN_MISC
suffix:semicolon
r_if
c_cond
(paren
(paren
id|did
op_amp
id|HIL_IDD_DID_ABS_TABLET_MASK
)paren
op_eq
id|HIL_IDD_DID_ABS_TABLET
)paren
macro_line|#ifdef TABLET_SIMULATES_MOUSE
id|btntype
op_assign
id|BTN_TOUCH
suffix:semicolon
macro_line|#else
id|btntype
op_assign
id|BTN_DIGI
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|did
op_amp
id|HIL_IDD_DID_ABS_TSCREEN_MASK
)paren
op_eq
id|HIL_IDD_DID_ABS_TSCREEN
)paren
id|btntype
op_assign
id|BTN_TOUCH
suffix:semicolon
r_if
c_cond
(paren
(paren
id|did
op_amp
id|HIL_IDD_DID_REL_MOUSE_MASK
)paren
op_eq
id|HIL_IDD_DID_REL_MOUSE
)paren
id|btntype
op_assign
id|BTN_MOUSE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ptr-&gt;nbtn
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_bit
c_func
(paren
id|btntype
op_or
id|i
comma
id|ptr-&gt;dev.keybit
)paren
suffix:semicolon
id|ptr-&gt;btnmap
(braket
id|i
)braket
op_assign
id|btntype
op_or
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|btntype
op_eq
id|BTN_MOUSE
)paren
(brace
multiline_comment|/* Swap buttons 2 and 3 */
id|ptr-&gt;btnmap
(braket
l_int|1
)braket
op_assign
id|BTN_MIDDLE
suffix:semicolon
id|ptr-&gt;btnmap
(braket
l_int|2
)braket
op_assign
id|BTN_RIGHT
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|did
op_amp
id|HIL_IDD_DID_TYPE_MASK
)paren
op_eq
id|HIL_IDD_DID_TYPE_REL
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ptr-&gt;naxes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_bit
c_func
(paren
id|REL_X
op_plus
id|i
comma
id|ptr-&gt;dev.relbit
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|3
suffix:semicolon
(paren
id|i
OL
id|ptr-&gt;naxes
op_plus
l_int|3
)paren
op_logical_and
(paren
id|naxsets
OG
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_bit
c_func
(paren
id|REL_X
op_plus
id|i
comma
id|ptr-&gt;dev.relbit
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ptr-&gt;naxes
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_bit
c_func
(paren
id|ABS_X
op_plus
id|i
comma
id|ptr-&gt;dev.absbit
)paren
suffix:semicolon
id|ptr-&gt;dev.absmin
(braket
id|ABS_X
op_plus
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr-&gt;dev.absmax
(braket
id|ABS_X
op_plus
id|i
)braket
op_assign
id|HIL_IDD_AXIS_MAX
c_func
(paren
(paren
id|ptr-&gt;idd
op_plus
l_int|1
)paren
comma
id|i
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|3
suffix:semicolon
(paren
id|i
OL
id|ptr-&gt;naxes
op_plus
l_int|3
)paren
op_logical_and
(paren
id|naxsets
OG
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|set_bit
c_func
(paren
id|ABS_X
op_plus
id|i
comma
id|ptr-&gt;dev.absbit
)paren
suffix:semicolon
id|ptr-&gt;dev.absmin
(braket
id|ABS_X
op_plus
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|ptr-&gt;dev.absmax
(braket
id|ABS_X
op_plus
id|i
)braket
op_assign
id|HIL_IDD_AXIS_MAX
c_func
(paren
(paren
id|ptr-&gt;idd
op_plus
l_int|1
)paren
comma
(paren
id|i
op_minus
l_int|3
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef TABLET_AUTOADJUST
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ABS_MAX
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|diff
op_assign
id|ptr-&gt;dev.absmax
(braket
id|ABS_X
op_plus
id|i
)braket
op_div
l_int|10
suffix:semicolon
id|ptr-&gt;dev.absmin
(braket
id|ABS_X
op_plus
id|i
)braket
op_add_assign
id|diff
suffix:semicolon
id|ptr-&gt;dev.absmax
(braket
id|ABS_X
op_plus
id|i
)braket
op_sub_assign
id|diff
suffix:semicolon
)brace
macro_line|#endif
)brace
id|ptr-&gt;dev.name
op_assign
id|strlen
c_func
(paren
id|ptr-&gt;rnm
)paren
ques
c_cond
id|ptr-&gt;rnm
suffix:colon
id|HIL_GENERIC_NAME
suffix:semicolon
id|ptr-&gt;dev.id.bustype
op_assign
id|BUS_HIL
suffix:semicolon
id|ptr-&gt;dev.id.vendor
op_assign
id|PCI_VENDOR_ID_HP
suffix:semicolon
id|ptr-&gt;dev.id.product
op_assign
l_int|0x0001
suffix:semicolon
multiline_comment|/* TODO: get from ptr-&gt;rsc */
id|ptr-&gt;dev.id.version
op_assign
l_int|0x0100
suffix:semicolon
multiline_comment|/* TODO: get from ptr-&gt;rsc */
id|ptr-&gt;dev.dev
op_assign
op_amp
id|serio-&gt;dev
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|ptr-&gt;dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input: %s (%s), ID: %d&bslash;n&quot;
comma
id|ptr-&gt;dev.name
comma
(paren
id|btntype
op_eq
id|BTN_MOUSE
)paren
ques
c_cond
l_string|&quot;HIL mouse&quot;
suffix:colon
l_string|&quot;HIL tablet or touchpad&quot;
comma
id|did
)paren
suffix:semicolon
r_return
suffix:semicolon
id|bail1
suffix:colon
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|bail0
suffix:colon
id|kfree
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|hil_ptr_serio_driver
r_static
r_struct
id|serio_driver
id|hil_ptr_serio_driver
op_assign
(brace
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;hil_ptr&quot;
comma
)brace
comma
dot
id|description
op_assign
l_string|&quot;HP HIL mouse/tablet driver&quot;
comma
dot
id|connect
op_assign
id|hil_ptr_connect
comma
dot
id|disconnect
op_assign
id|hil_ptr_disconnect
comma
dot
id|interrupt
op_assign
id|hil_ptr_interrupt
)brace
suffix:semicolon
DECL|function|hil_ptr_init
r_static
r_int
id|__init
id|hil_ptr_init
c_func
(paren
r_void
)paren
(brace
id|serio_register_driver
c_func
(paren
op_amp
id|hil_ptr_serio_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hil_ptr_exit
r_static
r_void
id|__exit
id|hil_ptr_exit
c_func
(paren
r_void
)paren
(brace
id|serio_unregister_driver
c_func
(paren
op_amp
id|hil_ptr_serio_driver
)paren
suffix:semicolon
)brace
DECL|variable|hil_ptr_init
id|module_init
c_func
(paren
id|hil_ptr_init
)paren
suffix:semicolon
DECL|variable|hil_ptr_exit
id|module_exit
c_func
(paren
id|hil_ptr_exit
)paren
suffix:semicolon
eof
