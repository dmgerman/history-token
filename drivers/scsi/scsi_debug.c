multiline_comment|/* $Id: scsi_debug.c,v 1.1 1992/07/24 06:27:38 root Exp root $&n; *  linux/kernel/scsi_debug.c&n; *&n; *  Copyright (C) 1992  Eric Youngdale&n; *  Simulate a host adapter with 2 disks attached.  Do a lot of checking&n; *  to make sure that we are not getting blocks mixed up, and PANIC if&n; *  anything out of the ordinary is seen.&n; *&n; *  This version is more generic, simulating a variable number of disk &n; *  (or disk like devices) sharing a common amount of RAM (default 8 MB&n; *  but can be set at driver/module load time).&n; *&n; *  For documentation see http://www.torque.net/sg/sdebug.html&n; *&n; *   D. Gilbert (dpg) work for MOD device test [20010421]&n; *   dpg, work for devfs large number of disks [20010809]&n; *   dpg, forked for lk 2.5 series [20011216, 20020101]&n; *   dpg, use vmalloc() more inquiry+mode_sense [20020302]&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &quot;scsi.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include&lt;linux/stat.h&gt;
macro_line|#ifndef LINUX_VERSION_CODE
macro_line|#include &lt;linux/version.h&gt;
macro_line|#endif
DECL|variable|scsi_debug_version_str
r_static
r_char
id|scsi_debug_version_str
(braket
)braket
op_assign
l_string|&quot;Version: 1.59 (20020302)&quot;
suffix:semicolon
macro_line|#ifndef SCSI_CMD_READ_16
DECL|macro|SCSI_CMD_READ_16
mdefine_line|#define SCSI_CMD_READ_16 0x88
macro_line|#endif
macro_line|#ifndef SCSI_CMD_WRITE_16
DECL|macro|SCSI_CMD_WRITE_16
mdefine_line|#define SCSI_CMD_WRITE_16 0x8a
macro_line|#endif
multiline_comment|/* A few options that we want selected */
DECL|macro|DEF_NR_FAKE_DEVS
mdefine_line|#define DEF_NR_FAKE_DEVS   1
DECL|macro|DEF_DEV_SIZE_MB
mdefine_line|#define DEF_DEV_SIZE_MB   8
DECL|macro|DEF_FAKE_BLK0
mdefine_line|#define DEF_FAKE_BLK0   0
DECL|macro|DEF_OPTS
mdefine_line|#define DEF_OPTS   0
DECL|macro|SCSI_DEBUG_OPT_NOISE
mdefine_line|#define SCSI_DEBUG_OPT_NOISE   1
DECL|macro|SCSI_DEBUG_OPT_MEDIUM_ERR
mdefine_line|#define SCSI_DEBUG_OPT_MEDIUM_ERR   2
DECL|macro|OPT_MEDIUM_ERR_ADDR
mdefine_line|#define OPT_MEDIUM_ERR_ADDR   0x1234
DECL|variable|scsi_debug_num_devs
r_static
r_int
id|scsi_debug_num_devs
op_assign
id|DEF_NR_FAKE_DEVS
suffix:semicolon
DECL|variable|scsi_debug_opts
r_static
r_int
id|scsi_debug_opts
op_assign
id|DEF_OPTS
suffix:semicolon
DECL|macro|NR_HOSTS_PRESENT
mdefine_line|#define NR_HOSTS_PRESENT (((scsi_debug_num_devs - 1) / 7) + 1)
DECL|macro|N_HEAD
mdefine_line|#define N_HEAD          8
DECL|macro|N_SECTOR
mdefine_line|#define N_SECTOR        32
DECL|macro|DEV_READONLY
mdefine_line|#define DEV_READONLY(TGT)      (0)
DECL|macro|DEV_REMOVEABLE
mdefine_line|#define DEV_REMOVEABLE(TGT)    (0)
DECL|macro|DEVICE_TYPE
mdefine_line|#define DEVICE_TYPE(TGT) (TYPE_DISK);
DECL|macro|SCSI_DEBUG_MAILBOXES
mdefine_line|#define SCSI_DEBUG_MAILBOXES (scsi_debug_num_devs + 1)
DECL|variable|scsi_debug_dev_size_mb
r_static
r_int
id|scsi_debug_dev_size_mb
op_assign
id|DEF_DEV_SIZE_MB
suffix:semicolon
DECL|macro|STORE_SIZE
mdefine_line|#define STORE_SIZE (scsi_debug_dev_size_mb * 1024 * 1024)
multiline_comment|/* default sector size is 512 bytes, 2**9 bytes */
DECL|macro|POW2_SECT_SIZE
mdefine_line|#define POW2_SECT_SIZE 9
DECL|macro|SECT_SIZE
mdefine_line|#define SECT_SIZE (1 &lt;&lt; POW2_SECT_SIZE)
DECL|macro|N_CYLINDER
mdefine_line|#define N_CYLINDER (STORE_SIZE / (SECT_SIZE * N_SECTOR * N_HEAD))
multiline_comment|/* Do not attempt to use a timer to simulate a real disk with latency */
multiline_comment|/* Only use this in the actual kernel, not in the simulator. */
DECL|macro|IMMEDIATE
mdefine_line|#define IMMEDIATE
DECL|macro|START_PARTITION
mdefine_line|#define START_PARTITION 4
multiline_comment|/* Time to wait before completing a command */
DECL|macro|DISK_SPEED
mdefine_line|#define DISK_SPEED     (HZ/10)&t;/* 100ms */
DECL|macro|CAPACITY
mdefine_line|#define CAPACITY (N_HEAD * N_SECTOR * N_CYLINDER)
DECL|macro|SECT_SIZE_PER
mdefine_line|#define SECT_SIZE_PER(TGT) SECT_SIZE
DECL|variable|starts
r_static
r_int
id|starts
(braket
)braket
op_assign
(brace
id|N_SECTOR
comma
id|N_HEAD
op_star
id|N_SECTOR
comma
multiline_comment|/* Single cylinder */
id|N_HEAD
op_star
id|N_SECTOR
op_star
l_int|4
comma
l_int|0
multiline_comment|/* CAPACITY */
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|fake_storep
r_static
r_int
r_char
op_star
id|fake_storep
suffix:semicolon
DECL|struct|sdebug_dev_info
r_typedef
r_struct
id|sdebug_dev_info
(brace
DECL|member|sdp
id|Scsi_Device
op_star
id|sdp
suffix:semicolon
DECL|member|host_no
r_int
r_int
id|host_no
suffix:semicolon
DECL|member|id
r_int
r_int
id|id
suffix:semicolon
DECL|member|reset
r_char
id|reset
suffix:semicolon
DECL|member|sb_index
r_char
id|sb_index
suffix:semicolon
DECL|typedef|Sdebug_dev_info
)brace
id|Sdebug_dev_info
suffix:semicolon
DECL|variable|devInfop
r_static
id|Sdebug_dev_info
op_star
id|devInfop
suffix:semicolon
DECL|variable|num_aborts
r_static
r_int
id|num_aborts
op_assign
l_int|0
suffix:semicolon
DECL|variable|num_dev_resets
r_static
r_int
id|num_dev_resets
op_assign
l_int|0
suffix:semicolon
DECL|variable|num_bus_resets
r_static
r_int
id|num_bus_resets
op_assign
l_int|0
suffix:semicolon
DECL|variable|num_host_resets
r_static
r_int
id|num_host_resets
op_assign
l_int|0
suffix:semicolon
DECL|variable|mailbox_lock
r_static
id|spinlock_t
id|mailbox_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|sdebug_atomic_rw
r_static
id|rwlock_t
id|sdebug_atomic_rw
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
macro_line|#include &quot;scsi_debug.h&quot;
DECL|typedef|done_fct_t
r_typedef
r_void
(paren
op_star
id|done_fct_t
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
DECL|variable|do_done
r_static
r_volatile
id|done_fct_t
op_star
id|do_done
op_assign
l_int|0
suffix:semicolon
DECL|variable|SHpnt
r_static
r_struct
id|Scsi_Host
op_star
id|SHpnt
op_assign
l_int|NULL
suffix:semicolon
r_static
r_int
id|scsi_debug_inquiry
c_func
(paren
r_int
r_char
op_star
id|cmd
comma
r_int
id|target
comma
r_int
r_char
op_star
id|buff
comma
r_int
id|bufflen
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
suffix:semicolon
r_static
r_int
id|scsi_debug_mode_sense
c_func
(paren
r_int
r_char
op_star
id|cmd
comma
r_int
id|target
comma
r_int
r_char
op_star
id|buff
comma
r_int
id|bufflen
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
suffix:semicolon
r_static
r_int
id|scsi_debug_read
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|upper_blk
comma
r_int
id|block
comma
r_int
id|num
comma
r_int
op_star
id|errstsp
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
suffix:semicolon
r_static
r_int
id|scsi_debug_write
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|upper_blk
comma
r_int
id|block
comma
r_int
id|num
comma
r_int
op_star
id|errstsp
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
suffix:semicolon
r_static
r_void
id|scsi_debug_intr_handle
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_static
id|Sdebug_dev_info
op_star
id|devInfoReg
c_func
(paren
id|Scsi_Device
op_star
id|sdp
)paren
suffix:semicolon
r_static
r_void
id|mk_sense_buffer
c_func
(paren
id|Sdebug_dev_info
op_star
id|devip
comma
r_int
id|index
comma
r_int
id|key
comma
r_int
id|asc
comma
r_int
id|asq
comma
r_int
id|inbandLen
)paren
suffix:semicolon
r_static
r_int
id|check_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
suffix:semicolon
DECL|variable|timeout
r_static
r_struct
id|timer_list
op_star
id|timeout
op_assign
l_int|0
suffix:semicolon
DECL|variable|SCint
r_static
id|Scsi_Cmnd
op_star
op_star
id|SCint
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Semaphore used to simulate bus lockups.&n; */
DECL|variable|scsi_debug_lockup
r_static
r_int
id|scsi_debug_lockup
op_assign
l_int|0
suffix:semicolon
DECL|macro|NUM_SENSE_BUFFS
mdefine_line|#define NUM_SENSE_BUFFS 4
DECL|macro|SENSE_BUFF_LEN
mdefine_line|#define SENSE_BUFF_LEN 32
DECL|variable|sense_buffers
r_static
r_char
id|sense_buffers
(braket
id|NUM_SENSE_BUFFS
)braket
(braket
id|SENSE_BUFF_LEN
)braket
suffix:semicolon
r_static
r_inline
DECL|function|sdebug_scatg2virt
r_int
r_char
op_star
id|sdebug_scatg2virt
c_func
(paren
r_const
r_struct
id|scatterlist
op_star
id|sclp
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sclp
)paren
r_return
l_int|NULL
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sclp-&gt;page
)paren
r_return
(paren
r_int
r_char
op_star
)paren
id|page_address
c_func
(paren
id|sclp-&gt;page
)paren
op_plus
id|sclp-&gt;offset
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
DECL|function|scsi_debug_queuecommand
r_int
id|scsi_debug_queuecommand
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_char
op_star
id|cmd
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
r_int
id|block
suffix:semicolon
r_int
id|upper_blk
suffix:semicolon
r_int
r_char
op_star
id|buff
suffix:semicolon
r_int
id|scsi_debug_errsts
suffix:semicolon
r_int
id|target
op_assign
id|SCpnt-&gt;target
suffix:semicolon
r_int
id|bufflen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_int
id|i
comma
id|num
comma
id|capac
suffix:semicolon
id|Sdebug_dev_info
op_star
id|devip
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|sbuff
suffix:semicolon
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: queue_command: cmd &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|num
op_assign
id|SCpnt-&gt;cmd_len
suffix:semicolon
id|i
OL
id|num
suffix:semicolon
op_increment
id|i
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|cmd
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   use_sg=%d&bslash;n&quot;
comma
id|SCpnt-&gt;use_sg
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If we are being notified of the mid-level reposessing a command&n;&t; * due to timeout, just return.&n;&t; */
r_if
c_cond
(paren
id|done
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
multiline_comment|/* just use first element */
r_struct
id|scatterlist
op_star
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|buff
op_assign
id|sdebug_scatg2virt
c_func
(paren
op_amp
id|sgpnt
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|bufflen
op_assign
id|sgpnt
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
multiline_comment|/* READ and WRITE process scatterlist themselves */
)brace
r_else
id|buff
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
multiline_comment|/*&n;         * If a command comes for the ID of the host itself, just print&n;         * a silly message and return.&n;         */
r_if
c_cond
(paren
id|target
op_eq
l_int|7
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;How do you do!&bslash;n&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|target
OG
l_int|7
)paren
op_logical_or
(paren
id|SCpnt-&gt;lun
op_ne
l_int|0
)paren
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sdebug:qc: host_no=%d, id=%d, sdp=%p, cmd=0x%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|SCpnt-&gt;device-&gt;host-&gt;host_no
comma
(paren
r_int
)paren
id|SCpnt-&gt;device-&gt;id
comma
id|SCpnt-&gt;device
comma
(paren
r_int
)paren
op_star
id|cmd
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
l_int|NULL
op_eq
id|SCpnt-&gt;device-&gt;hostdata
)paren
(brace
id|devip
op_assign
id|devInfoReg
c_func
(paren
id|SCpnt-&gt;device
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|devip
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SCpnt-&gt;device-&gt;hostdata
op_assign
id|devip
suffix:semicolon
)brace
id|devip
op_assign
id|SCpnt-&gt;device-&gt;hostdata
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|cmd
)paren
(brace
r_case
id|INQUIRY
suffix:colon
multiline_comment|/* mandatory */
id|scsi_debug_errsts
op_assign
id|scsi_debug_inquiry
c_func
(paren
id|cmd
comma
id|target
comma
id|buff
comma
id|bufflen
comma
id|devip
)paren
suffix:semicolon
multiline_comment|/* assume INQUIRY called first so setup max_cmd_len */
r_if
c_cond
(paren
id|SCpnt-&gt;host-&gt;max_cmd_len
op_ne
id|SCSI_DEBUG_MAX_CMD_LEN
)paren
id|SCpnt-&gt;host-&gt;max_cmd_len
op_assign
id|SCSI_DEBUG_MAX_CMD_LEN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|REQUEST_SENSE
suffix:colon
multiline_comment|/* mandatory */
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;Request sense...&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devip
)paren
(brace
id|sbuff
op_assign
op_amp
id|sense_buffers
(braket
(paren
r_int
)paren
id|devip-&gt;sb_index
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|devip-&gt;sb_index
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|sbuff
op_assign
op_amp
id|sense_buffers
(braket
l_int|0
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
comma
id|sbuff
comma
(paren
id|bufflen
OL
id|SENSE_BUFF_LEN
)paren
ques
c_cond
id|bufflen
suffix:colon
id|SENSE_BUFF_LEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|sbuff
comma
l_int|0
comma
id|SENSE_BUFF_LEN
)paren
suffix:semicolon
id|sbuff
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|START_STOP
suffix:colon
r_if
c_cond
(paren
id|check_reset
c_func
(paren
id|SCpnt
comma
id|devip
)paren
)paren
(brace
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;START_STOP&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ALLOW_MEDIUM_REMOVAL
suffix:colon
r_if
c_cond
(paren
id|check_reset
c_func
(paren
id|SCpnt
comma
id|devip
)paren
)paren
(brace
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
(braket
l_int|4
)braket
)paren
(brace
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|2
comma
id|printk
c_func
(paren
l_string|&quot;Medium removal inhibited...&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|2
comma
id|printk
c_func
(paren
l_string|&quot;Medium removal enabled...&quot;
)paren
)paren
suffix:semicolon
)brace
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SEND_DIAGNOSTIC
suffix:colon
multiline_comment|/* mandatory */
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;Send Diagnostic&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
)paren
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TEST_UNIT_READY
suffix:colon
multiline_comment|/* mandatory */
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;Test unit ready(%p %d)&bslash;n&quot;
comma
id|buff
comma
id|bufflen
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
)paren
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|READ_CAPACITY
suffix:colon
r_if
c_cond
(paren
id|check_reset
c_func
(paren
id|SCpnt
comma
id|devip
)paren
)paren
(brace
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;Read Capacity&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|SHpnt
op_assign
id|SCpnt-&gt;host
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|capac
op_assign
id|CAPACITY
op_minus
l_int|1
suffix:semicolon
id|buff
(braket
l_int|0
)braket
op_assign
(paren
id|capac
op_rshift
l_int|24
)paren
suffix:semicolon
id|buff
(braket
l_int|1
)braket
op_assign
(paren
id|capac
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|2
)braket
op_assign
(paren
id|capac
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|3
)braket
op_assign
id|capac
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|4
)braket
op_assign
l_int|0
suffix:semicolon
id|buff
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
id|buff
(braket
l_int|6
)braket
op_assign
(paren
id|SECT_SIZE_PER
c_func
(paren
id|target
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|buff
(braket
l_int|7
)braket
op_assign
id|SECT_SIZE_PER
c_func
(paren
id|target
)paren
op_amp
l_int|0xff
suffix:semicolon
id|scsi_debug_errsts
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_CMD_READ_16
suffix:colon
multiline_comment|/* SBC-2 */
r_case
id|READ_12
suffix:colon
r_case
id|READ_10
suffix:colon
r_case
id|READ_6
suffix:colon
r_if
c_cond
(paren
id|check_reset
c_func
(paren
id|SCpnt
comma
id|devip
)paren
)paren
(brace
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|upper_blk
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|cmd
)paren
op_eq
id|SCSI_CMD_READ_16
)paren
(brace
id|upper_blk
op_assign
id|cmd
(braket
l_int|5
)braket
op_plus
(paren
id|cmd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
id|block
op_assign
id|cmd
(braket
l_int|9
)braket
op_plus
(paren
id|cmd
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|7
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|6
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
id|num
op_assign
id|cmd
(braket
l_int|13
)braket
op_plus
(paren
id|cmd
(braket
l_int|12
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|11
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|10
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
id|cmd
)paren
op_eq
id|READ_12
)paren
(brace
id|block
op_assign
id|cmd
(braket
l_int|5
)braket
op_plus
(paren
id|cmd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
id|num
op_assign
id|cmd
(braket
l_int|9
)braket
op_plus
(paren
id|cmd
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|7
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|6
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
id|cmd
)paren
op_eq
id|READ_10
)paren
(brace
id|block
op_assign
id|cmd
(braket
l_int|5
)braket
op_plus
(paren
id|cmd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
id|num
op_assign
id|cmd
(braket
l_int|8
)braket
op_plus
(paren
id|cmd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|block
op_assign
id|cmd
(braket
l_int|3
)braket
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
(paren
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|num
op_assign
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_debug_read
c_func
(paren
id|SCpnt
comma
id|upper_blk
comma
id|block
comma
id|num
comma
op_amp
id|scsi_debug_errsts
comma
id|devip
)paren
)paren
r_break
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* calls bottom half in upper layers before return from scsi_do_...() */
(paren
id|done
)paren
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SCSI_CMD_WRITE_16
suffix:colon
multiline_comment|/* SBC-2 */
r_case
id|WRITE_12
suffix:colon
r_case
id|WRITE_10
suffix:colon
r_case
id|WRITE_6
suffix:colon
r_if
c_cond
(paren
id|check_reset
c_func
(paren
id|SCpnt
comma
id|devip
)paren
)paren
(brace
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|upper_blk
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|cmd
)paren
op_eq
id|SCSI_CMD_WRITE_16
)paren
(brace
id|upper_blk
op_assign
id|cmd
(braket
l_int|5
)braket
op_plus
(paren
id|cmd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
id|block
op_assign
id|cmd
(braket
l_int|9
)braket
op_plus
(paren
id|cmd
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|7
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|6
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
id|num
op_assign
id|cmd
(braket
l_int|13
)braket
op_plus
(paren
id|cmd
(braket
l_int|12
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|11
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|10
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
id|cmd
)paren
op_eq
id|WRITE_12
)paren
(brace
id|block
op_assign
id|cmd
(braket
l_int|5
)braket
op_plus
(paren
id|cmd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
id|num
op_assign
id|cmd
(braket
l_int|9
)braket
op_plus
(paren
id|cmd
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|7
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|6
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_star
id|cmd
)paren
op_eq
id|WRITE_10
)paren
(brace
id|block
op_assign
id|cmd
(braket
l_int|5
)braket
op_plus
(paren
id|cmd
(braket
l_int|4
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
id|cmd
(braket
l_int|3
)braket
op_lshift
l_int|16
)paren
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|24
)paren
suffix:semicolon
id|num
op_assign
id|cmd
(braket
l_int|8
)braket
op_plus
(paren
id|cmd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|block
op_assign
id|cmd
(braket
l_int|3
)braket
op_plus
(paren
id|cmd
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
(paren
(paren
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|num
op_assign
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_debug_write
c_func
(paren
id|SCpnt
comma
id|upper_blk
comma
id|block
comma
id|num
comma
op_amp
id|scsi_debug_errsts
comma
id|devip
)paren
)paren
r_break
suffix:semicolon
id|SCpnt-&gt;result
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* calls bottom half in upper layers before return from scsi_do_...() */
(paren
id|done
)paren
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
r_case
id|MODE_SENSE_10
suffix:colon
id|scsi_debug_errsts
op_assign
id|scsi_debug_mode_sense
c_func
(paren
id|cmd
comma
id|target
comma
id|buff
comma
id|bufflen
comma
id|devip
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: Unsupported command, &quot;
l_string|&quot;opcode=0x%x&bslash;n&quot;
comma
(paren
r_int
)paren
id|cmd
(braket
l_int|0
)braket
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|check_reset
c_func
(paren
id|SCpnt
comma
id|devip
)paren
)paren
(brace
id|done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|scsi_debug_errsts
op_assign
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|2
comma
id|ILLEGAL_REQUEST
comma
l_int|0x20
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mailbox_lock
comma
id|iflags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|timeout
(braket
id|i
)braket
dot
id|function
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If all of the slots are full, just return 1.  The new error &n;&t; * handling scheme allows this, and the mid-level should queue things.&n;&t; */
r_if
c_cond
(paren
id|i
op_ge
id|SCSI_DEBUG_MAILBOXES
op_logical_or
id|timeout
(braket
id|i
)braket
dot
id|function
op_ne
l_int|0
)paren
(brace
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;Command rejected - host busy&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mailbox_lock
comma
id|iflags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|1
comma
id|printk
c_func
(paren
l_string|&quot;Command accepted - slot %d&bslash;n&quot;
comma
id|i
)paren
)paren
suffix:semicolon
macro_line|#ifdef IMMEDIATE
r_if
c_cond
(paren
op_logical_neg
id|scsi_debug_lockup
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|scsi_debug_errsts
suffix:semicolon
id|SCint
(braket
id|i
)braket
op_assign
id|SCpnt
suffix:semicolon
id|do_done
(braket
id|i
)braket
op_assign
id|done
suffix:semicolon
id|scsi_debug_intr_handle
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/* No timer - do this one right away */
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mailbox_lock
comma
id|iflags
)paren
suffix:semicolon
macro_line|#else
id|SCpnt-&gt;result
op_assign
id|scsi_debug_errsts
suffix:semicolon
id|timeout
(braket
id|i
)braket
dot
id|function
op_assign
id|scsi_debug_intr_handle
suffix:semicolon
id|timeout
(braket
id|i
)braket
dot
id|data
op_assign
id|i
suffix:semicolon
id|timeout
(braket
id|i
)braket
dot
id|expires
op_assign
id|jiffies
op_plus
id|DISK_SPEED
suffix:semicolon
id|SCint
(braket
id|i
)braket
op_assign
id|SCpnt
suffix:semicolon
id|do_done
(braket
id|i
)braket
op_assign
id|done
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mailbox_lock
comma
id|iflags
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|timeout
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi_debug_queuecommand: &quot;
l_string|&quot;done can&squot;t be NULL&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Sending command (%d %x %d %d)...&quot;
comma
id|i
comma
id|done
comma
id|timeout
(braket
id|i
)braket
dot
id|expires
comma
id|jiffies
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_debug_ioctl
r_static
r_int
id|scsi_debug_ioctl
c_func
(paren
id|Scsi_Device
op_star
id|dev
comma
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: ioctl: cmd=0x%x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
DECL|function|check_reset
r_static
r_int
id|check_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
(brace
r_if
c_cond
(paren
id|devip-&gt;reset
)paren
(brace
id|devip-&gt;reset
op_assign
l_int|0
suffix:semicolon
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|3
comma
id|UNIT_ATTENTION
comma
l_int|0x29
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|SDEBUG_MAX_INQ_SZ
mdefine_line|#define SDEBUG_MAX_INQ_SZ 58
DECL|function|scsi_debug_inquiry
r_static
r_int
id|scsi_debug_inquiry
c_func
(paren
r_int
r_char
op_star
id|cmd
comma
r_int
id|target
comma
r_int
r_char
op_star
id|buff
comma
r_int
id|bufflen
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
(brace
r_int
r_char
id|pq_pdt
suffix:semicolon
r_int
r_char
id|arr
(braket
id|SDEBUG_MAX_INQ_SZ
)braket
suffix:semicolon
r_int
id|min_len
op_assign
id|bufflen
OG
id|SDEBUG_MAX_INQ_SZ
ques
c_cond
id|SDEBUG_MAX_INQ_SZ
suffix:colon
id|bufflen
suffix:semicolon
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;Inquiry...(%p %d)&bslash;n&quot;
comma
id|buff
comma
id|bufflen
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufflen
OL
id|cmd
(braket
l_int|4
)braket
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: inquiry: bufflen=%d &quot;
l_string|&quot;&lt; alloc_length=%d&bslash;n&quot;
comma
id|bufflen
comma
(paren
r_int
)paren
id|cmd
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|memset
c_func
(paren
id|arr
comma
l_int|0
comma
id|SDEBUG_MAX_INQ_SZ
)paren
suffix:semicolon
id|pq_pdt
op_assign
id|DEVICE_TYPE
c_func
(paren
id|target
)paren
suffix:semicolon
id|arr
(braket
l_int|0
)braket
op_assign
id|pq_pdt
suffix:semicolon
r_if
c_cond
(paren
l_int|0x2
op_amp
id|cmd
(braket
l_int|1
)braket
)paren
(brace
multiline_comment|/* CMDDT bit set */
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|1
comma
id|ILLEGAL_REQUEST
comma
l_int|0x24
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
r_return
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
l_int|0x1
op_amp
id|cmd
(braket
l_int|1
)braket
)paren
(brace
multiline_comment|/* EVPD bit set */
r_if
c_cond
(paren
l_int|0
op_eq
id|cmd
(braket
l_int|2
)braket
)paren
(brace
multiline_comment|/* supported vital product data pages */
id|arr
(braket
l_int|3
)braket
op_assign
l_int|1
suffix:semicolon
id|arr
(braket
l_int|4
)braket
op_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* ... only unit serial number */
)brace
r_else
r_if
c_cond
(paren
l_int|0x80
op_eq
id|cmd
(braket
l_int|2
)braket
)paren
(brace
multiline_comment|/* unit serial number */
id|arr
(braket
l_int|1
)braket
op_assign
l_int|0x80
suffix:semicolon
id|arr
(braket
l_int|3
)braket
op_assign
l_int|4
suffix:semicolon
id|arr
(braket
l_int|4
)braket
op_assign
l_char|&squot;1&squot;
suffix:semicolon
id|arr
(braket
l_int|5
)braket
op_assign
l_char|&squot;2&squot;
suffix:semicolon
id|arr
(braket
l_int|6
)braket
op_assign
l_char|&squot;3&squot;
suffix:semicolon
id|arr
(braket
l_int|7
)braket
op_assign
l_char|&squot;4&squot;
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Illegal request, invalid field in cdb */
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|1
comma
id|ILLEGAL_REQUEST
comma
l_int|0x24
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
r_return
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buff
comma
id|arr
comma
id|min_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* drops through here for a standard inquiry */
id|arr
(braket
l_int|1
)braket
op_assign
id|DEV_REMOVEABLE
c_func
(paren
id|target
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* Removable disk */
id|arr
(braket
l_int|2
)braket
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* claim SCSI 3 */
id|arr
(braket
l_int|4
)braket
op_assign
id|SDEBUG_MAX_INQ_SZ
op_minus
l_int|5
suffix:semicolon
id|arr
(braket
l_int|7
)braket
op_assign
l_int|0x3a
suffix:semicolon
multiline_comment|/* claim: WBUS16, SYNC, LINKED + CMDQUE */
id|memcpy
c_func
(paren
op_amp
id|arr
(braket
l_int|8
)braket
comma
l_string|&quot;Linux   &quot;
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|arr
(braket
l_int|16
)braket
comma
l_string|&quot;scsi_debug      &quot;
comma
l_int|16
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|arr
(braket
l_int|32
)braket
comma
l_string|&quot;0003&quot;
comma
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buff
comma
id|arr
comma
id|min_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &lt;&lt;Following mode page info copied from ST318451LW&gt;&gt; */
DECL|function|sdebug_err_recov_pg
r_static
r_int
id|sdebug_err_recov_pg
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|pcontrol
comma
r_int
id|target
)paren
(brace
multiline_comment|/* Read-Write Error Recovery page for mode_sense */
r_int
r_char
id|err_recov_pg
(braket
)braket
op_assign
(brace
l_int|0x1
comma
l_int|0xa
comma
l_int|0xc0
comma
l_int|11
comma
l_int|240
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|5
comma
l_int|0
comma
l_int|0xff
comma
l_int|0xff
)brace
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|err_recov_pg
comma
r_sizeof
(paren
id|err_recov_pg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_eq
id|pcontrol
)paren
id|memset
c_func
(paren
id|p
op_plus
l_int|2
comma
l_int|0
comma
r_sizeof
(paren
id|err_recov_pg
)paren
op_minus
l_int|2
)paren
suffix:semicolon
r_return
r_sizeof
(paren
id|err_recov_pg
)paren
suffix:semicolon
)brace
DECL|function|sdebug_disconnect_pg
r_static
r_int
id|sdebug_disconnect_pg
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|pcontrol
comma
r_int
id|target
)paren
(brace
multiline_comment|/* Disconnect-Reconnect page for mode_sense */
r_int
r_char
id|disconnect_pg
(braket
)braket
op_assign
(brace
l_int|0x2
comma
l_int|0xe
comma
l_int|128
comma
l_int|128
comma
l_int|0
comma
l_int|10
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|disconnect_pg
comma
r_sizeof
(paren
id|disconnect_pg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_eq
id|pcontrol
)paren
id|memset
c_func
(paren
id|p
op_plus
l_int|2
comma
l_int|0
comma
r_sizeof
(paren
id|disconnect_pg
)paren
op_minus
l_int|2
)paren
suffix:semicolon
r_return
r_sizeof
(paren
id|disconnect_pg
)paren
suffix:semicolon
)brace
DECL|function|sdebug_caching_pg
r_static
r_int
id|sdebug_caching_pg
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|pcontrol
comma
r_int
id|target
)paren
(brace
multiline_comment|/* Caching page for mode_sense */
r_int
r_char
id|caching_pg
(braket
)braket
op_assign
(brace
l_int|0x8
comma
l_int|18
comma
l_int|0x14
comma
l_int|0
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0
comma
l_int|0
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0x80
comma
l_int|0x14
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|caching_pg
comma
r_sizeof
(paren
id|caching_pg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_eq
id|pcontrol
)paren
id|memset
c_func
(paren
id|p
op_plus
l_int|2
comma
l_int|0
comma
r_sizeof
(paren
id|caching_pg
)paren
op_minus
l_int|2
)paren
suffix:semicolon
r_return
r_sizeof
(paren
id|caching_pg
)paren
suffix:semicolon
)brace
DECL|function|sdebug_ctrl_m_pg
r_static
r_int
id|sdebug_ctrl_m_pg
c_func
(paren
r_int
r_char
op_star
id|p
comma
r_int
id|pcontrol
comma
r_int
id|target
)paren
(brace
multiline_comment|/* Control mode page for mode_sense */
r_int
r_char
id|ctrl_m_pg
(braket
)braket
op_assign
(brace
l_int|0xa
comma
l_int|10
comma
l_int|2
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0x2
comma
l_int|0x4b
)brace
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|ctrl_m_pg
comma
r_sizeof
(paren
id|ctrl_m_pg
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_eq
id|pcontrol
)paren
id|memset
c_func
(paren
id|p
op_plus
l_int|2
comma
l_int|0
comma
r_sizeof
(paren
id|ctrl_m_pg
)paren
op_minus
l_int|2
)paren
suffix:semicolon
r_return
r_sizeof
(paren
id|ctrl_m_pg
)paren
suffix:semicolon
)brace
DECL|macro|SDEBUG_MAX_MSENSE_SZ
mdefine_line|#define SDEBUG_MAX_MSENSE_SZ 256
DECL|function|scsi_debug_mode_sense
r_static
r_int
id|scsi_debug_mode_sense
c_func
(paren
r_int
r_char
op_star
id|cmd
comma
r_int
id|target
comma
r_int
r_char
op_star
id|buff
comma
r_int
id|bufflen
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
(brace
r_int
r_char
id|dbd
suffix:semicolon
r_int
id|pcontrol
comma
id|pcode
suffix:semicolon
r_int
r_char
id|dev_spec
suffix:semicolon
r_int
id|alloc_len
comma
id|msense_6
comma
id|offset
comma
id|len
suffix:semicolon
r_int
r_char
op_star
id|ap
suffix:semicolon
r_int
r_char
id|arr
(braket
id|SDEBUG_MAX_MSENSE_SZ
)braket
suffix:semicolon
r_int
id|min_len
op_assign
id|bufflen
OG
id|SDEBUG_MAX_MSENSE_SZ
ques
c_cond
id|SDEBUG_MAX_MSENSE_SZ
suffix:colon
id|bufflen
suffix:semicolon
id|SCSI_LOG_LLQUEUE
c_func
(paren
l_int|3
comma
id|printk
c_func
(paren
l_string|&quot;Mode sense ...(%p %d)&bslash;n&quot;
comma
id|buff
comma
id|bufflen
)paren
)paren
suffix:semicolon
id|dbd
op_assign
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0x8
suffix:semicolon
id|pcontrol
op_assign
(paren
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0xc0
)paren
op_rshift
l_int|6
suffix:semicolon
id|pcode
op_assign
id|cmd
(braket
l_int|2
)braket
op_amp
l_int|0x3f
suffix:semicolon
id|msense_6
op_assign
(paren
id|MODE_SENSE
op_eq
id|cmd
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|alloc_len
op_assign
id|msense_6
ques
c_cond
id|cmd
(braket
l_int|4
)braket
suffix:colon
(paren
(paren
id|cmd
(braket
l_int|7
)braket
op_lshift
l_int|8
)paren
op_or
id|cmd
(braket
l_int|6
)braket
)paren
suffix:semicolon
multiline_comment|/* printk(KERN_INFO &quot;msense: dbd=%d pcontrol=%d pcode=%d &quot;&n;&t;&t;&quot;msense_6=%d alloc_len=%d&bslash;n&quot;, dbd, pcontrol, pcode, &quot;&n;&t;&t;&quot;msense_6, alloc_len); */
r_if
c_cond
(paren
id|bufflen
OL
id|alloc_len
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: mode_sense: bufflen=%d &quot;
l_string|&quot;&lt; alloc_length=%d&bslash;n&quot;
comma
id|bufflen
comma
id|alloc_len
)paren
suffix:semicolon
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|bufflen
)paren
suffix:semicolon
id|memset
c_func
(paren
id|arr
comma
l_int|0
comma
id|SDEBUG_MAX_MSENSE_SZ
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0x3
op_eq
id|pcontrol
)paren
(brace
multiline_comment|/* Saving values not supported */
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|1
comma
id|ILLEGAL_REQUEST
comma
l_int|0x39
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
r_return
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
id|dev_spec
op_assign
id|DEV_READONLY
c_func
(paren
id|target
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0x0
suffix:semicolon
r_if
c_cond
(paren
id|msense_6
)paren
(brace
id|arr
(braket
l_int|2
)braket
op_assign
id|dev_spec
suffix:semicolon
id|offset
op_assign
l_int|4
suffix:semicolon
)brace
r_else
(brace
id|arr
(braket
l_int|3
)braket
op_assign
id|dev_spec
suffix:semicolon
id|offset
op_assign
l_int|8
suffix:semicolon
)brace
id|ap
op_assign
id|arr
op_plus
id|offset
suffix:semicolon
r_switch
c_cond
(paren
id|pcode
)paren
(brace
r_case
l_int|0x1
suffix:colon
multiline_comment|/* Read-Write error recovery page, direct access */
id|len
op_assign
id|sdebug_err_recov_pg
c_func
(paren
id|ap
comma
id|pcontrol
comma
id|target
)paren
suffix:semicolon
id|offset
op_add_assign
id|len
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x2
suffix:colon
multiline_comment|/* Disconnect-Reconnect page, all devices */
id|len
op_assign
id|sdebug_disconnect_pg
c_func
(paren
id|ap
comma
id|pcontrol
comma
id|target
)paren
suffix:semicolon
id|offset
op_add_assign
id|len
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x8
suffix:colon
multiline_comment|/* Caching page, direct access */
id|len
op_assign
id|sdebug_caching_pg
c_func
(paren
id|ap
comma
id|pcontrol
comma
id|target
)paren
suffix:semicolon
id|offset
op_add_assign
id|len
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xa
suffix:colon
multiline_comment|/* Control Mode page, all devices */
id|len
op_assign
id|sdebug_ctrl_m_pg
c_func
(paren
id|ap
comma
id|pcontrol
comma
id|target
)paren
suffix:semicolon
id|offset
op_add_assign
id|len
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x3f
suffix:colon
multiline_comment|/* Read all Mode pages */
id|len
op_assign
id|sdebug_err_recov_pg
c_func
(paren
id|ap
comma
id|pcontrol
comma
id|target
)paren
suffix:semicolon
id|len
op_add_assign
id|sdebug_disconnect_pg
c_func
(paren
id|ap
op_plus
id|len
comma
id|pcontrol
comma
id|target
)paren
suffix:semicolon
id|len
op_add_assign
id|sdebug_caching_pg
c_func
(paren
id|ap
op_plus
id|len
comma
id|pcontrol
comma
id|target
)paren
suffix:semicolon
id|len
op_add_assign
id|sdebug_ctrl_m_pg
c_func
(paren
id|ap
op_plus
id|len
comma
id|pcontrol
comma
id|target
)paren
suffix:semicolon
id|offset
op_add_assign
id|len
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|1
comma
id|ILLEGAL_REQUEST
comma
l_int|0x24
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
r_return
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msense_6
)paren
id|arr
(braket
l_int|0
)braket
op_assign
id|offset
op_minus
l_int|1
suffix:semicolon
r_else
(brace
id|offset
op_sub_assign
l_int|2
suffix:semicolon
id|arr
(braket
l_int|0
)braket
op_assign
(paren
id|offset
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|arr
(braket
l_int|1
)braket
op_assign
id|offset
op_amp
l_int|0xff
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|buff
comma
id|arr
comma
id|min_len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_debug_read
r_static
r_int
id|scsi_debug_read
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|upper_blk
comma
r_int
id|block
comma
r_int
id|num
comma
r_int
op_star
id|errstsp
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
(brace
r_int
r_char
op_star
id|buff
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_int
id|nbytes
comma
id|sgcount
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bufflen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
id|upper_blk
op_logical_or
(paren
id|block
op_plus
id|num
OG
id|CAPACITY
)paren
)paren
(brace
op_star
id|errstsp
op_assign
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|1
comma
id|ILLEGAL_REQUEST
comma
l_int|0x21
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#if defined(SCSI_SETUP_LATENCY) || defined(SCSI_DATARATE)
(brace
r_int
id|delay
op_assign
id|SCSI_SETUP_LATENCY
suffix:semicolon
id|delay
op_add_assign
id|SCpnt-&gt;request.nr_sectors
op_star
id|SCSI_DATARATE
suffix:semicolon
r_if
c_cond
(paren
id|delay
)paren
id|usleep
c_func
(paren
id|delay
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|SCSI_DEBUG_OPT_MEDIUM_ERR
op_amp
id|scsi_debug_opts
)paren
op_logical_and
(paren
id|block
op_ge
id|OPT_MEDIUM_ERR_ADDR
)paren
op_logical_and
(paren
id|block
OL
(paren
id|OPT_MEDIUM_ERR_ADDR
op_plus
id|num
)paren
)paren
)paren
(brace
op_star
id|errstsp
op_assign
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|1
comma
id|MEDIUM_ERROR
comma
l_int|0x11
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
multiline_comment|/* claim unrecoverable read error */
r_return
l_int|1
suffix:semicolon
)brace
id|read_lock_irqsave
c_func
(paren
op_amp
id|sdebug_atomic_rw
comma
id|iflags
)paren
suffix:semicolon
id|sgcount
op_assign
l_int|0
suffix:semicolon
id|nbytes
op_assign
id|bufflen
suffix:semicolon
multiline_comment|/* printk(KERN_INFO &quot;scsi_debug_read: block=%d, tot_bufflen=%d&bslash;n&quot;, &n;&t;       block, bufflen); */
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|sgcount
op_assign
l_int|0
suffix:semicolon
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|buff
suffix:semicolon
id|buff
op_assign
id|sdebug_scatg2virt
c_func
(paren
op_amp
id|sgpnt
(braket
id|sgcount
)braket
)paren
suffix:semicolon
id|bufflen
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|length
suffix:semicolon
)brace
op_star
id|errstsp
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|memcpy
c_func
(paren
id|buff
comma
id|fake_storep
op_plus
(paren
id|block
op_star
id|SECT_SIZE
)paren
comma
id|bufflen
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Simulate a disk change */
r_if
c_cond
(paren
id|block
op_eq
l_int|0xfff0
)paren
(brace
id|sense_buffer
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|sense_buffer
(braket
l_int|2
)braket
op_assign
id|UNIT_ATTENTION
suffix:semicolon
id|starts
(braket
l_int|0
)braket
op_add_assign
l_int|10
suffix:semicolon
id|starts
(braket
l_int|1
)braket
op_add_assign
l_int|10
suffix:semicolon
id|starts
(braket
l_int|2
)braket
op_add_assign
l_int|10
suffix:semicolon
op_star
id|errstsp
op_assign
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sdebug_atomic_rw
comma
id|iflags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* End phony disk change code */
macro_line|#endif
id|nbytes
op_sub_assign
id|bufflen
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|block
op_add_assign
id|bufflen
op_rshift
id|POW2_SECT_SIZE
suffix:semicolon
id|sgcount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nbytes
)paren
(brace
id|buff
op_assign
id|sdebug_scatg2virt
c_func
(paren
op_amp
id|sgpnt
(braket
id|sgcount
)braket
)paren
suffix:semicolon
id|bufflen
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|length
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|nbytes
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sdebug_read: unexpected &quot;
l_string|&quot;nbytes=%d&bslash;n&quot;
comma
id|nbytes
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nbytes
)paren
suffix:semicolon
id|read_unlock_irqrestore
c_func
(paren
op_amp
id|sdebug_atomic_rw
comma
id|iflags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_debug_write
r_static
r_int
id|scsi_debug_write
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_int
id|upper_blk
comma
r_int
id|block
comma
r_int
id|num
comma
r_int
op_star
id|errstsp
comma
id|Sdebug_dev_info
op_star
id|devip
)paren
(brace
r_int
r_char
op_star
id|buff
op_assign
(paren
r_int
r_char
op_star
)paren
id|SCpnt-&gt;request_buffer
suffix:semicolon
r_int
id|nbytes
comma
id|sgcount
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgpnt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bufflen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
r_if
c_cond
(paren
id|upper_blk
op_logical_or
(paren
id|block
op_plus
id|num
OG
id|CAPACITY
)paren
)paren
(brace
op_star
id|errstsp
op_assign
(paren
id|COMMAND_COMPLETE
op_lshift
l_int|8
)paren
op_or
(paren
id|CHECK_CONDITION
op_lshift
l_int|1
)paren
suffix:semicolon
id|mk_sense_buffer
c_func
(paren
id|devip
comma
l_int|1
comma
id|ILLEGAL_REQUEST
comma
l_int|0x21
comma
l_int|0
comma
l_int|14
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|write_lock_irqsave
c_func
(paren
op_amp
id|sdebug_atomic_rw
comma
id|iflags
)paren
suffix:semicolon
id|sgcount
op_assign
l_int|0
suffix:semicolon
id|nbytes
op_assign
id|bufflen
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|sgcount
op_assign
l_int|0
suffix:semicolon
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|buff
suffix:semicolon
id|buff
op_assign
id|sdebug_scatg2virt
c_func
(paren
op_amp
id|sgpnt
(braket
id|sgcount
)braket
)paren
suffix:semicolon
id|bufflen
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|length
suffix:semicolon
)brace
op_star
id|errstsp
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|memcpy
c_func
(paren
id|fake_storep
op_plus
(paren
id|block
op_star
id|SECT_SIZE
)paren
comma
id|buff
comma
id|bufflen
)paren
suffix:semicolon
id|nbytes
op_sub_assign
id|bufflen
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt-&gt;use_sg
)paren
(brace
id|block
op_add_assign
id|bufflen
op_rshift
id|POW2_SECT_SIZE
suffix:semicolon
id|sgcount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|nbytes
)paren
(brace
id|buff
op_assign
id|sdebug_scatg2virt
c_func
(paren
op_amp
id|sgpnt
(braket
id|sgcount
)braket
)paren
suffix:semicolon
id|bufflen
op_assign
id|sgpnt
(braket
id|sgcount
)braket
dot
id|length
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|nbytes
OG
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sdebug_write: &quot;
l_string|&quot;unexpected nbytes=%d&bslash;n&quot;
comma
id|nbytes
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nbytes
)paren
suffix:semicolon
id|write_unlock_irqrestore
c_func
(paren
op_amp
id|sdebug_atomic_rw
comma
id|iflags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* A &quot;high&quot; level interrupt handler.  This should be called once per jiffy&n; * to simulate a regular scsi disk.  We use a timer to do this. */
DECL|function|scsi_debug_intr_handle
r_static
r_void
id|scsi_debug_intr_handle
c_func
(paren
r_int
r_int
id|indx
)paren
(brace
id|Scsi_Cmnd
op_star
id|SCtmp
suffix:semicolon
r_void
(paren
op_star
id|my_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
macro_line|#if 0
id|del_timer
c_func
(paren
op_amp
id|timeout
(braket
id|indx
)braket
)paren
suffix:semicolon
macro_line|#endif
id|SCtmp
op_assign
(paren
id|Scsi_Cmnd
op_star
)paren
id|SCint
(braket
id|indx
)braket
suffix:semicolon
id|my_done
op_assign
id|do_done
(braket
id|indx
)braket
suffix:semicolon
id|do_done
(braket
id|indx
)braket
op_assign
l_int|NULL
suffix:semicolon
id|timeout
(braket
id|indx
)braket
dot
id|function
op_assign
l_int|NULL
suffix:semicolon
id|SCint
(braket
id|indx
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|my_done
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi_debug_intr_handle: Unexpected &quot;
l_string|&quot;interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;In intr_handle...&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;...done %d %x %d %d&bslash;n&quot;
comma
id|i
comma
id|my_done
comma
id|to
comma
id|jiffies
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;In intr_handle: %d %x %x&bslash;n&quot;
comma
id|i
comma
id|SCtmp
comma
id|my_done
)paren
suffix:semicolon
macro_line|#endif
id|my_done
c_func
(paren
id|SCtmp
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Called done.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|initialized
r_static
r_int
id|initialized
op_assign
l_int|0
suffix:semicolon
DECL|function|do_init
r_static
r_int
id|do_init
c_func
(paren
r_void
)paren
(brace
r_int
id|sz
op_assign
id|STORE_SIZE
suffix:semicolon
id|starts
(braket
l_int|3
)braket
op_assign
id|CAPACITY
suffix:semicolon
id|fake_storep
op_assign
id|vmalloc
c_func
(paren
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|fake_storep
)paren
r_return
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|fake_storep
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|sz
op_assign
r_sizeof
(paren
id|done_fct_t
)paren
op_star
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|do_done
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|do_done
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|do_done
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|sz
op_assign
r_sizeof
(paren
r_struct
id|timer_list
)paren
op_star
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|timeout
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|timeout
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|timeout
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
id|sz
op_assign
r_sizeof
(paren
id|Scsi_Cmnd
op_star
)paren
op_star
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|SCint
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|SCint
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|SCint
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|fake_storep
)paren
id|vfree
c_func
(paren
id|fake_storep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_done
)paren
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|do_done
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
id|kfree
c_func
(paren
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCint
)paren
id|kfree
c_func
(paren
id|SCint
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|do_end
r_static
r_void
id|do_end
c_func
(paren
r_void
)paren
(brace
id|kfree
c_func
(paren
id|SCint
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
r_void
op_star
)paren
id|do_done
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|fake_storep
)paren
suffix:semicolon
)brace
DECL|function|scsi_debug_detect
r_static
r_int
id|scsi_debug_detect
c_func
(paren
id|Scsi_Host_Template
op_star
id|tpnt
)paren
(brace
r_int
id|k
comma
id|sz
suffix:semicolon
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: detect&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|initialized
)paren
(brace
op_increment
id|initialized
suffix:semicolon
id|sz
op_assign
r_sizeof
(paren
id|Sdebug_dev_info
)paren
op_star
id|scsi_debug_num_devs
suffix:semicolon
id|devInfop
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|devInfop
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi_debug_detect: out of &quot;
l_string|&quot;memory, 0.5&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memset
c_func
(paren
id|devInfop
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_init
c_func
(paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;scsi_debug_detect: out of memory&quot;
l_string|&quot;, 0&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|NUM_SENSE_BUFFS
suffix:semicolon
op_increment
id|k
)paren
id|sense_buffers
(braket
id|k
)braket
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|NR_HOSTS_PRESENT
suffix:semicolon
id|k
op_increment
)paren
(brace
id|tpnt-&gt;proc_name
op_assign
l_string|&quot;scsi_debug&quot;
suffix:semicolon
multiline_comment|/* In the loop??? */
id|scsi_register
c_func
(paren
id|tpnt
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|NR_HOSTS_PRESENT
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;scsi_debug_detect: called again&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|variable|num_releases
r_static
r_int
id|num_releases
op_assign
l_int|0
suffix:semicolon
DECL|function|scsi_debug_release
r_static
r_int
id|scsi_debug_release
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|hpnt
)paren
(brace
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: release&bslash;n&quot;
)paren
suffix:semicolon
id|scsi_unregister
c_func
(paren
id|hpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|num_releases
op_ne
id|NR_HOSTS_PRESENT
)paren
r_return
l_int|0
suffix:semicolon
id|do_end
c_func
(paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|devInfop
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|devInfoReg
r_static
id|Sdebug_dev_info
op_star
id|devInfoReg
c_func
(paren
id|Scsi_Device
op_star
id|sdp
)paren
(brace
r_int
id|k
suffix:semicolon
r_int
r_int
id|host_no
comma
id|id
suffix:semicolon
id|Sdebug_dev_info
op_star
id|devip
suffix:semicolon
id|host_no
op_assign
id|sdp-&gt;host-&gt;host_no
suffix:semicolon
id|id
op_assign
(paren
r_int
r_int
)paren
id|sdp-&gt;id
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|scsi_debug_num_devs
suffix:semicolon
op_increment
id|k
)paren
(brace
id|devip
op_assign
op_amp
id|devInfop
(braket
id|k
)braket
suffix:semicolon
r_if
c_cond
(paren
id|devip-&gt;sdp
op_logical_and
(paren
id|host_no
op_eq
id|devip-&gt;host_no
)paren
op_logical_and
(paren
id|id
op_eq
id|devip-&gt;id
)paren
)paren
(brace
id|devip-&gt;sdp
op_assign
id|sdp
suffix:semicolon
multiline_comment|/* overwrite previous sdp */
r_return
id|devip
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|devip-&gt;sdp
)paren
(brace
id|devip-&gt;sdp
op_assign
id|sdp
suffix:semicolon
id|devip-&gt;host_no
op_assign
id|host_no
suffix:semicolon
id|devip-&gt;id
op_assign
id|id
suffix:semicolon
id|devip-&gt;reset
op_assign
l_int|1
suffix:semicolon
id|devip-&gt;sb_index
op_assign
l_int|0
suffix:semicolon
r_return
id|devip
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|mk_sense_buffer
r_static
r_void
id|mk_sense_buffer
c_func
(paren
id|Sdebug_dev_info
op_star
id|devip
comma
r_int
id|index
comma
r_int
id|key
comma
r_int
id|asc
comma
r_int
id|asq
comma
r_int
id|inbandLen
)paren
(brace
r_char
op_star
id|sbuff
suffix:semicolon
r_if
c_cond
(paren
(paren
id|index
OL
l_int|0
)paren
op_logical_or
(paren
id|index
op_ge
id|NUM_SENSE_BUFFS
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|devip
)paren
id|devip-&gt;sb_index
op_assign
id|index
suffix:semicolon
id|sbuff
op_assign
op_amp
id|sense_buffers
(braket
id|index
)braket
(braket
l_int|0
)braket
suffix:semicolon
id|memset
c_func
(paren
id|sbuff
comma
l_int|0
comma
id|SENSE_BUFF_LEN
)paren
suffix:semicolon
id|sbuff
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|sbuff
(braket
l_int|2
)braket
op_assign
id|key
suffix:semicolon
id|sbuff
(braket
l_int|7
)braket
op_assign
(paren
id|inbandLen
OG
l_int|7
)paren
ques
c_cond
(paren
id|inbandLen
op_minus
l_int|8
)paren
suffix:colon
l_int|0
suffix:semicolon
id|sbuff
(braket
l_int|12
)braket
op_assign
id|asc
suffix:semicolon
id|sbuff
(braket
l_int|13
)braket
op_assign
id|asq
suffix:semicolon
)brace
DECL|function|scsi_debug_abort
r_static
r_int
id|scsi_debug_abort
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: abort&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 1
op_increment
id|num_aborts
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
macro_line|#else
r_int
id|j
suffix:semicolon
r_void
(paren
op_star
id|my_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
suffix:semicolon
r_int
r_int
id|iflags
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|SCpnt-&gt;abort_reason
op_lshift
l_int|16
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|SCSI_DEBUG_MAILBOXES
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|SCpnt
op_eq
id|SCint
(braket
id|j
)braket
)paren
(brace
id|my_done
op_assign
id|do_done
(braket
id|j
)braket
suffix:semicolon
id|my_done
c_func
(paren
id|SCpnt
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|mailbox_lock
comma
id|iflags
)paren
suffix:semicolon
id|timeout
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|SCint
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
id|do_done
(braket
id|j
)braket
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|mailbox_lock
comma
id|iflags
)paren
suffix:semicolon
)brace
)brace
r_return
id|SCSI_ABORT_SNOOZE
suffix:semicolon
macro_line|#endif
)brace
DECL|function|scsi_debug_biosparam
r_static
r_int
id|scsi_debug_biosparam
c_func
(paren
id|Disk
op_star
id|disk
comma
id|kdev_t
id|dev
comma
r_int
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: biosparam&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* int size = disk-&gt;capacity; */
id|info
(braket
l_int|0
)braket
op_assign
id|N_HEAD
suffix:semicolon
id|info
(braket
l_int|1
)braket
op_assign
id|N_SECTOR
suffix:semicolon
id|info
(braket
l_int|2
)braket
op_assign
id|N_CYLINDER
suffix:semicolon
r_if
c_cond
(paren
id|info
(braket
l_int|2
)braket
op_ge
l_int|1024
)paren
id|info
(braket
l_int|2
)braket
op_assign
l_int|1024
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|scsi_debug_device_reset
r_static
r_int
id|scsi_debug_device_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|Scsi_Device
op_star
id|sdp
suffix:semicolon
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: device_reset&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|num_dev_resets
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_logical_and
(paren
(paren
id|sdp
op_assign
id|SCpnt-&gt;device
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|scsi_debug_num_devs
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
id|sdp-&gt;hostdata
op_eq
(paren
id|devInfop
op_plus
id|k
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|k
OL
id|scsi_debug_num_devs
)paren
id|devInfop
(braket
id|k
)braket
dot
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|function|scsi_debug_bus_reset
r_static
r_int
id|scsi_debug_bus_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|Scsi_Device
op_star
id|sdp
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|hp
suffix:semicolon
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: bus_reset&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|num_bus_resets
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
op_logical_and
(paren
(paren
id|sdp
op_assign
id|SCpnt-&gt;device
)paren
)paren
op_logical_and
(paren
(paren
id|hp
op_assign
id|sdp-&gt;host
)paren
)paren
)paren
(brace
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|scsi_debug_num_devs
suffix:semicolon
op_increment
id|k
)paren
(brace
r_if
c_cond
(paren
id|hp
op_eq
id|devInfop
(braket
id|k
)braket
dot
id|sdp-&gt;host
)paren
id|devInfop
(braket
id|k
)braket
dot
id|reset
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|function|scsi_debug_host_reset
r_static
r_int
id|scsi_debug_host_reset
c_func
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_int
id|k
suffix:semicolon
r_if
c_cond
(paren
id|SCSI_DEBUG_OPT_NOISE
op_amp
id|scsi_debug_opts
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug: host_reset&bslash;n&quot;
)paren
suffix:semicolon
op_increment
id|num_host_resets
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|scsi_debug_num_devs
suffix:semicolon
op_increment
id|k
)paren
id|devInfop
(braket
id|k
)braket
dot
id|reset
op_assign
l_int|1
suffix:semicolon
r_return
id|SUCCESS
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|scsi_debug_num_devs_setup
r_static
r_int
id|__init
id|scsi_debug_num_devs_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|tmp
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|tmp
OG
l_int|0
)paren
id|scsi_debug_num_devs
op_assign
id|tmp
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug_num_devs: usage scsi_debug_num_devs=&lt;n&gt; &quot;
l_string|&quot;(&lt;n&gt; can be from 1 to around 2000)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|__setup
c_func
(paren
l_string|&quot;scsi_debug_num_devs=&quot;
comma
id|scsi_debug_num_devs_setup
)paren
suffix:semicolon
DECL|function|scsi_debug_dev_size_mb_setup
r_static
r_int
id|__init
id|scsi_debug_dev_size_mb_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|tmp
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|tmp
OG
l_int|0
)paren
id|scsi_debug_dev_size_mb
op_assign
id|tmp
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug_dev_size_mb: usage &quot;
l_string|&quot;scsi_debug_dev_size_mb=&lt;n&gt;&bslash;n&quot;
l_string|&quot;    (&lt;n&gt; is number of MB ram shared by all devs&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|__setup
c_func
(paren
l_string|&quot;scsi_debug_dev_size_mb=&quot;
comma
id|scsi_debug_dev_size_mb_setup
)paren
suffix:semicolon
DECL|function|scsi_debug_opts_setup
r_static
r_int
id|__init
id|scsi_debug_opts_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|get_option
c_func
(paren
op_amp
id|str
comma
op_amp
id|tmp
)paren
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|tmp
OG
l_int|0
)paren
id|scsi_debug_opts
op_assign
id|tmp
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;scsi_debug_opts: usage &quot;
l_string|&quot;scsi_debug_opts=&lt;n&gt;&bslash;n&quot;
l_string|&quot;    (1-&gt;noise, 2-&gt;medium_error, 4-&gt;... (can be or-ed)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|__setup
c_func
(paren
l_string|&quot;scsi_debug_opts=&quot;
comma
id|scsi_debug_opts_setup
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Eric Youngdale + Douglas Gilbert&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SCSI debug adapter driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|scsi_debug_num_devs
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|scsi_debug_num_devs
comma
l_string|&quot;number of SCSI devices to simulate&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|scsi_debug_dev_size_mb
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|scsi_debug_dev_size_mb
comma
l_string|&quot;size in MB of ram shared by devs&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|scsi_debug_opts
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|scsi_debug_opts
comma
l_string|&quot;1-&gt;noise, 2-&gt;medium_error, 4-&gt;...&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE_LICENSE
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|sdebug_info
r_static
r_char
id|sdebug_info
(braket
l_int|256
)braket
suffix:semicolon
DECL|function|scsi_debug_info
r_static
r_const
r_char
op_star
id|scsi_debug_info
c_func
(paren
r_struct
id|Scsi_Host
op_star
id|shp
)paren
(brace
id|sprintf
c_func
(paren
id|sdebug_info
comma
l_string|&quot;scsi_debug, %s, num_devs=%d, &quot;
l_string|&quot;dev_size_mb=%d, opts=0x%x&quot;
comma
id|scsi_debug_version_str
comma
id|scsi_debug_num_devs
comma
id|scsi_debug_dev_size_mb
comma
id|scsi_debug_opts
)paren
suffix:semicolon
r_return
id|sdebug_info
suffix:semicolon
)brace
multiline_comment|/* scsi_debug_proc_info&n; * Used if the driver currently has no own support for /proc/scsi&n; */
DECL|function|scsi_debug_proc_info
r_static
r_int
id|scsi_debug_proc_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
id|inode
comma
r_int
id|inout
)paren
(brace
r_int
id|len
comma
id|pos
comma
id|begin
suffix:semicolon
r_int
id|orig_length
suffix:semicolon
id|orig_length
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|inout
op_eq
l_int|1
)paren
(brace
r_char
id|arr
(braket
l_int|16
)braket
suffix:semicolon
r_int
id|minLen
op_assign
id|length
OG
l_int|15
ques
c_cond
l_int|15
suffix:colon
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_or
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
id|memcpy
c_func
(paren
id|arr
comma
id|buffer
comma
id|minLen
)paren
suffix:semicolon
id|arr
(braket
id|minLen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
l_int|1
op_ne
id|sscanf
c_func
(paren
id|arr
comma
l_string|&quot;%d&quot;
comma
op_amp
id|pos
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|scsi_debug_opts
op_assign
id|pos
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
id|begin
op_assign
l_int|0
suffix:semicolon
id|pos
op_assign
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;scsi_debug adapter driver, %s&bslash;n&quot;
l_string|&quot;num_devs=%d, shared (ram) size=%d MB, opts=0x%x&bslash;n&quot;
l_string|&quot;sector_size=%d bytes, cylinders=%d, heads=%d, sectors=%d&bslash;n&quot;
l_string|&quot;number of aborts=%d, device_reset=%d, bus_resets=%d, &quot;
l_string|&quot;host_resets=%d&bslash;n&quot;
comma
id|scsi_debug_version_str
comma
id|scsi_debug_num_devs
comma
id|scsi_debug_dev_size_mb
comma
id|scsi_debug_opts
comma
id|SECT_SIZE
comma
id|N_CYLINDER
comma
id|N_HEAD
comma
id|N_SECTOR
comma
id|num_aborts
comma
id|num_dev_resets
comma
id|num_bus_resets
comma
id|num_host_resets
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
multiline_comment|/* Start of wanted data */
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* Eventually this will go into an include file, but this will be later */
DECL|variable|driver_template
r_static
id|Scsi_Host_Template
id|driver_template
op_assign
id|SCSI_DEBUG_TEMPLATE
suffix:semicolon
macro_line|#include &quot;scsi_module.c&quot;
eof
